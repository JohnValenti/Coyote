<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueAttributeSelectionPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute</a> &gt; <span class="el_source">QueueAttributeSelectionPM.java</span></div><h1>QueueAttributeSelectionPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.workload.model.QueueSelection;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.workload.WorkloadModelHandler;
import com.bluepumpkin.web.bbm.workload.queue.selection.QueueFilterUtil;
import com.bluepumpkin.web.bbm.workload.queue.selection.QueueSelectionPC;
import com.witness.web.uif.pagecomponent.tree.MultiColInputTreePC;
import com.witness.web.uif.pagecomponent.tree.util.TreeModelBuilder;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.SelectionpaneTreePM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.config.Screen;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;

import java.rmi.RemoteException;
import java.util.*;

import static com.bluepumpkin.web.bbm.workload.queue.selection.QueueFilterUtil.retrieveUseSavedDatesForOneTimeUse;

/**
 * Title:
 * Description:
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 *
 * @author Sankar Nair
 * @version 1.0
 */
public class QueueAttributeSelectionPM extends SelectionpaneTreePM {

	private static final String QUEUE_SELECTION_IDS_KEY = &quot;QUEUE_SELECTION_IDS_KEY&quot;;
	private static final String IS_CAMPAIGN_MODE_FN = &quot;isCampaignMode&quot;;
	private static final String LAST_CAMPAIGN_ID_FN = &quot;lastCampaignID&quot;;
	private static final String IS_INFO_SUBMITTED_FROM_SELF_FN = &quot;isInfoSubmittedFromSelf&quot;;

<span class="nc" id="L44">	ID campaignID = null;</span>
<span class="nc" id="L45">	private ID lastCampaignID = null;</span>
<span class="nc" id="L46">	private boolean isCampaignMode = false;</span>
<span class="nc" id="L47">	boolean isNewCampaignSelected = false;</span>
<span class="nc" id="L48">	private boolean isInfoSubmittedFromSelf = false;</span>
	private QueueAttributeFilterBoxPC queueFilterBoxPC;

	/**
	 * Constructor
	 *
	 * @param context @{@link RequestContext}
	 */
	public QueueAttributeSelectionPM(RequestContext context) {
<span class="nc" id="L57">		super(context, new QueueSelectionPC(context));</span>

<span class="nc" id="L59">		queueFilterBoxPC = new QueueAttributeFilterBoxPC(m_context);</span>
<span class="nc" id="L60">		addChildComponent(queueFilterBoxPC);</span>
<span class="nc" id="L61">		m_filterBoxPC = queueFilterBoxPC;</span>
<span class="nc" id="L62">		m_filterBoxPC.setUseWrapper(true);</span>

<span class="nc" id="L64">		initIDFromCache();</span>
<span class="nc" id="L65">	}</span>

	/**
	 * Return an instance of the model that is ready for rendering
	 *
	 * @param context @{@link RequestContext}
	 * @return @{@link PageModel}
	 */
	public static PageModel getInstance(RequestContext context) {
<span class="nc" id="L74">		return getInstance(context, QueueAttributeSelectionPM.class);</span>
	}

	protected void preLoadData() throws Exception {
<span class="nc bnc" id="L78" title="All 2 branches missed.">		if (isCampaignMode) {</span>
			//Needs to be synchronized because the work frame (PulseAppletPC) and the queue
			//selection frame (this class) both load at the same time.
<span class="nc" id="L81">			synchronized (m_context.getRequest().getSession()) {</span>
<span class="nc" id="L82">				queueFilterBoxPC.init();</span>
<span class="nc" id="L83">				campaignID = queueFilterBoxPC.getCampaignID();</span>
<span class="nc" id="L84">				setCampaignModeData();</span>
<span class="nc" id="L85">			}//synchronized</span>
		} else {
			// do not use Filter box if not in campaign mode
<span class="nc" id="L88">			removeChildComponent(queueFilterBoxPC);</span>
<span class="nc" id="L89">			m_filterBoxPC = null;</span>
		}
<span class="nc" id="L91">	}</span>

	void setCampaignModeData() throws RemoteException, BbmException {
<span class="nc" id="L94">		isNewCampaignSelected = isNewCampaignSelected(lastCampaignID, campaignID, isInfoSubmittedFromSelf);</span>
<span class="nc" id="L95">		Date startDate = null;</span>
<span class="nc" id="L96">		Date endDate = null;</span>
<span class="nc bnc" id="L97" title="All 6 branches missed.">		if (campaignID != null &amp;&amp; (!retrieveUseSavedDatesForOneTimeUse(m_context) || isNewCampaignSelected)) { </span>
<span class="nc" id="L98">			SchedulingPeriod schedulingPeriod = getDefaultSchedulingPeriod();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">			if (schedulingPeriod != null) {</span>
<span class="nc" id="L100">				startDate = schedulingPeriod.getStartTime();</span>
<span class="nc" id="L101">				endDate = schedulingPeriod.getEndTime();</span>
<span class="nc" id="L102">				QueueFilterUtil.storeTimePeriodStart(m_context, startDate);</span>
<span class="nc" id="L103">				QueueFilterUtil.storeTimePeriodEnd(m_context, endDate);</span>
<span class="nc" id="L104">				campaignID = schedulingPeriod.getCampaignID();</span>
			}
<span class="nc" id="L106">		} else {</span>
<span class="nc" id="L107">			startDate = QueueFilterUtil.retrieveTimePeriodStart(m_context);</span>
<span class="nc" id="L108">			endDate = QueueFilterUtil.retrieveTimePeriodEnd(m_context);</span>
		}
<span class="nc" id="L110">		QueueSelectionPC queuePC = (QueueSelectionPC) m_treePC;</span>
<span class="nc" id="L111">		Map mediaMap = WorkloadModelHandler.getMediaMap(m_context);</span>
<span class="nc" id="L112">		ID queueAttributeID = queueFilterBoxPC.getQueueAttributeFilterID();</span>
<span class="nc" id="L113">		queuePC.setCampaignModeData(campaignID, startDate, endDate, mediaMap, queueAttributeID, true, true, true);</span>
<span class="nc" id="L114">	}</span>

	SchedulingPeriod getDefaultSchedulingPeriod() throws RemoteException, BbmException {
		SchedulingPeriod schedulingPeriod;
<span class="nc bnc" id="L118" title="All 4 branches missed.">		if (isNewCampaignSelected &amp;&amp; isInfoSubmittedFromSelf) {</span>
<span class="nc" id="L119">			schedulingPeriod = CampaignModelHandler.getMostCurrentSP(m_context, campaignID);</span>
		} else {
<span class="nc" id="L121">			schedulingPeriod = CampaignModelHandler.getSchedPeriod(m_context, QueueFilterUtil.retrieveSchedulingPeriodID(m_context));</span>
		}
<span class="nc" id="L123">		return schedulingPeriod;</span>
	}


	private static boolean isNewCampaignSelected(ID lastCampaignID, ID currentCampaignID, boolean isInfoSubmittedFromSelf) {
<span class="nc bnc" id="L128" title="All 2 branches missed.">		boolean result = currentCampaignID != null;</span>

		// if Page Refreshed then need to make sure that last and current selected campaign is not the same
<span class="nc bnc" id="L131" title="All 4 branches missed.">		if (isInfoSubmittedFromSelf &amp;&amp; currentCampaignID != null) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">			result = !currentCampaignID.equals(lastCampaignID);</span>
		}

<span class="nc" id="L135">		return result;</span>
	}

	private void initScreenParam() {
<span class="nc" id="L139">		Screen screen = m_context.getScreen();</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">		if (screen == null) {</span>
<span class="nc" id="L141">			return;</span>
		}
<span class="nc" id="L143">		setIsCampaignMode(Boolean.valueOf(screen.getParameterValue(IS_CAMPAIGN_MODE_FN)));</span>
<span class="nc" id="L144">	}</span>

	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc bnc" id="L150" title="All 2 branches missed.">		return isCampaignMode ? &quot;queue_campaign_selection&quot; : &quot;queue_selection&quot;;</span>
	}

	public void setIsCampaignMode(boolean bValue) {
<span class="nc" id="L154">		isCampaignMode = bValue;</span>
<span class="nc" id="L155">	}</span>

	public void setLastCampaignID(ID campaignID) {
<span class="nc" id="L158">		lastCampaignID = campaignID;</span>
<span class="nc" id="L159">	}</span>

	/**
	 * Return Required HTML
	 */
	public String getRequiredHTML() {
<span class="nc" id="L165">		return super.getRequiredHTML() + HtmlUtil.makeHiddenInput(IS_CAMPAIGN_MODE_FN, isCampaignMode) + HtmlUtil.makeHiddenInput</span>
<span class="nc" id="L166">				(LAST_CAMPAIGN_ID_FN, campaignID) + HtmlUtil.makeHiddenInput(IS_INFO_SUBMITTED_FROM_SELF_FN, true);</span>

	}

	////////////////////////////////////////////////////////////////////////////////
	// Code to handle ID Selection Caching
	////////////////////////////////////////////////////////////////////////////////
	protected String[] getPreSelectedRows() {
<span class="nc" id="L174">		String[] result = null;</span>

		// Reset Selected ID if switching from Campaign to All Queues so that we dont preselect same combined queues
<span class="nc bnc" id="L177" title="All 4 branches missed.">		boolean isSwitchedToAllQueuesFromCamp = campaignID == null &amp;&amp; lastCampaignID != null;</span>
<span class="nc bnc" id="L178" title="All 4 branches missed.">		if (isCampaignMode &amp;&amp; isSwitchedToAllQueuesFromCamp) {</span>
<span class="nc" id="L179">			m_selectedID = null;</span>
		}

		// Convert selected IDs to queue IDS. m_selectedID is of the form: &quot;46_-1_94,46_-1_95&quot;
<span class="nc bnc" id="L183" title="All 2 branches missed.">		if (!StringUtil.isEmpty(m_selectedID)) {</span>
<span class="nc" id="L184">			Collection&lt;String&gt; queueIDs = StringUtil.parseStringToCollection(m_selectedID, QueueSelection.ITEM_DELIM);</span>
<span class="nc" id="L185">			Set&lt;String&gt; uIDSet = new HashSet&lt;&gt;(queueIDs);</span>
<span class="nc" id="L186">			result = TreeModelBuilder.getSelectedRowIndex(m_treePC, uIDSet);</span>
		}

		// By Default Select Root Node and refresh Workpane if New Campaign is selected
<span class="nc bnc" id="L190" title="All 4 branches missed.">		boolean hasSelectedNode = result != null &amp;&amp; result.length &gt; 0;</span>
<span class="nc" id="L191">		boolean isAutoRefreshWorkpane = false;</span>

		//In campaign mode, always select root node if no node is selected
<span class="nc bnc" id="L194" title="All 8 branches missed.">		if (isCampaignMode &amp;&amp; (campaignID != null) &amp;&amp; !hasSelectedNode &amp;&amp; !m_treePC.isTreeEmpty()) {</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">			if (!isPulseSelectionNoDefault()) {</span>
<span class="nc" id="L196">				result = MultiColInputTreePC.PRE_SELECT_ROOT;</span>
			}
<span class="nc bnc" id="L198" title="All 2 branches missed.">			if (isNewCampaignSelected) {</span>
<span class="nc" id="L199">				isAutoRefreshWorkpane = true;</span>
			}
		}

		// Refresh Workpane if there is something selected or if new campaign does not have any queues associated.
<span class="nc bnc" id="L204" title="All 6 branches missed.">		boolean isNewCampaignWithoutQueues = isCampaignMode &amp;&amp; isNewCampaignSelected &amp;&amp; m_treePC.isTreeEmpty();</span>

<span class="nc bnc" id="L206" title="All 6 branches missed.">		if (isAutoRefreshWorkpane || isNewCampaignWithoutQueues || !hasSelectedNode) {</span>
<span class="nc" id="L207">			setRefreshWorkpane(true);</span>
		}
<span class="nc" id="L209">		return result;</span>
	}

	/**
	 * Medco has hundreds of queues, and each time Pulse loads, or user changes campaigns, Pulse
	 * automatically selects the combined queue, which takes a long time to get from the backend
	 * because it combines all of the queues together dynamically. To improve performance, we
	 * added a BPCONFIG setting which allows Medco to configure Pulse so that it does not select
	 * any queue by default when switching campaigns, (or when switching SP/date range when no
	 * queue had been previously selected). Once the user selects a queue, if he then changes the
	 * SP/date range and the new SP/date range includes the selected queue, then that queue
	 * continues to be selected. However, when switching campaigns, we always de-select any
	 * queues selection.
	 * This method tells us whether Pulse is configured to show no queue by default.
	 *
	 * @return whether Pulse is configured to show no queue by default.
	 */
	private synchronized boolean isPulseSelectionNoDefault() {
<span class="nc" id="L227">		boolean isEnabled = false;</span>
		try {
<span class="nc" id="L229">			isEnabled = BbmManagerFactory.getDBConfigManager().getBooleanValue(ConfigKey.PULSE_DEFAULT_SELECT_NO_QUEUE);</span>
<span class="nc" id="L230">		} catch (Exception ex) {</span>
<span class="nc" id="L231">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L232">		}</span>
<span class="nc" id="L233">		return isEnabled;</span>
	}

	private void initIDFromCache() {
		try {
<span class="nc" id="L238">			initScreenParam();</span>
<span class="nc" id="L239">		} catch (Exception ex) {</span>
<span class="nc" id="L240">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L241">		}</span>
<span class="nc" id="L242">	}</span>

	/**
	 * Return Key that is used for caching Selected ID
	 */
	public String getCacheSelectedIDKey() {
<span class="nc" id="L248">		return QUEUE_SELECTION_IDS_KEY;</span>
	}


	/**
	 * Specify whether the information is submitted from itself
	 */
	public void setIsInfoSubmittedFromSelf(boolean bValue) {
<span class="nc" id="L256">		isInfoSubmittedFromSelf = bValue;</span>
<span class="nc" id="L257">	}</span>

	/**
	 * Return the JavaScript init code required by Page model.
	 * Default behavior is to retrieve sub-component JavaScript Init code
	 * Override parent class in order to set the selectedID form
	 * element with the currently selected row in the tree. This is needed
	 * because Pulse pre-selects a row in the table when the user changes the
	 * campaign selection and the selection pane reloads. Ideally, we would just
	 * set m_selectedID ourselves in this page model, but we don't know which ID
	 * will be selected by our QueueSelectionPC. So calling
	 * SelectionMediator.updateSelectedIDsWithTreeSelection() will take care of
	 * setting the element with the tree selection when the page finishes loading.
	 */
	public String getJavaScriptInitCode() {
<span class="nc" id="L272">		StringBuilder jsInitCode = new StringBuilder();</span>

		// Add sub-component JavaScript code first
<span class="nc" id="L275">		jsInitCode.append(super.getJavaScriptInitCode()).append(&quot;\n&quot;);</span>

		// Need to have selectionMediator Mediator Ref
<span class="nc" id="L278">		String mediatorRef = getPageMediatorRef();</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">		if (!JSUtil.SELECTION_MEDIATOR_REF.equals(mediatorRef)) {</span>
<span class="nc" id="L280">			jsInitCode.append(JSUtil.SELECTION_MEDIATOR_REF).append(&quot; = &quot;).append(mediatorRef).append(&quot;; \n&quot;);</span>
		}

		// Associate Mediator Mediator\n&quot;
<span class="nc" id="L284">		jsInitCode.append(associateAppMediatorParent());</span>

		// Determine if Workpane should be refreshed
<span class="nc bnc" id="L287" title="All 2 branches missed.">		if (isRefreshWorkpane()) {</span>
<span class="nc" id="L288">			jsInitCode.append(JSUtil.SELECTION_MEDIATOR_REF).append(&quot;.updateSelectedIDsWithTreeSelection();\n&quot;);</span>
<span class="nc" id="L289">			jsInitCode.append(JSUtil.SELECTION_MEDIATOR_REF).append(&quot;.raiseBroadcastID();\n\n&quot;);</span>
		}

<span class="nc" id="L292">		appendJSToJSMain(JSUtil.RAISE_ON_LOAD_EVENTS);</span>
<span class="nc" id="L293">		return jsInitCode.toString();</span>
	}

	void setQueueSelectionPageComponent(QueueSelectionPC queueSelectionPC) {
<span class="nc" id="L297">		m_treePC = queueSelectionPC;</span>
<span class="nc" id="L298">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>