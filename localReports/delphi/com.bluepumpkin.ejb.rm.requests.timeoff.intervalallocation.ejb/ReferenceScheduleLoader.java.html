<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ReferenceScheduleLoader.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.ejb</a> &gt; <span class="el_source">ReferenceScheduleLoader.java</span></div><h1>ReferenceScheduleLoader.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.ejb;

import java.rmi.RemoteException;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.holiday.ejb.HolidayManager;
import com.bluepumpkin.ejb.bbm.holiday.model.Holiday;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.rm.base.RmRuntimeException;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.TimeOffIntervalAllocationUtil;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.util.DateUtil;

<span class="nc" id="L30">public class ReferenceScheduleLoader {</span>

	//(employeeID,start date) to Reference schedule ID and time zone for the scheduling period
	Map&lt;EmployeeDate, EmployeeSPTimeZone&gt; employeeDateToSP;
	//(employeeID,SchedulePeriodID) to shift assignments
	Map&lt;EmployeeSpID, List&lt;ShiftAssignment&gt;&gt; referenceSchedules;

	public void initialize(Collection&lt;EmployeeDate&gt; employeeDates) throws BbmFinderException {
<span class="nc" id="L38">		initialize(employeeDates, TimeOffIntervalAllocationUtil.getMgr());</span>
<span class="nc" id="L39">	}</span>

	public void initialize(Collection&lt;EmployeeDate&gt; employeeDates, TimeOffIntervalAllocationManager manager) throws BbmFinderException {
		try {

<span class="nc bnc" id="L44" title="All 2 branches missed.">			if (manager == null) {</span>
<span class="nc" id="L45">				return;</span>
			}

<span class="nc" id="L48">			List&lt;EmployeeSPTimeZone&gt; employeeSPTimeZones = manager.getReferenceScheduleTimeZones(employeeDates);</span>
<span class="nc" id="L49">			employeeDateToSP = buildMap(employeeSPTimeZones);</span>
<span class="nc" id="L50">			Collection&lt;EmployeeSpID&gt; employeeSpIDs = getEmployeeSPIds(employeeSPTimeZones);</span>
<span class="nc" id="L51">			referenceSchedules = manager.getReferenceScheduleAssignments(employeeSpIDs);</span>

<span class="nc" id="L53">		} catch (RemoteException e) {</span>
<span class="nc" id="L54">			throw new BbmFinderException(e);</span>
<span class="nc" id="L55">		}</span>
<span class="nc" id="L56">	}</span>

	private Map&lt;EmployeeDate, EmployeeSPTimeZone&gt; buildMap(Collection&lt;EmployeeSPTimeZone&gt; spTimeZones) {
<span class="nc" id="L59">		Map&lt;EmployeeDate, EmployeeSPTimeZone&gt; result = new HashMap&lt;EmployeeDate, EmployeeSPTimeZone&gt;();</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">		for (EmployeeSPTimeZone spTimeZone : spTimeZones) {</span>
<span class="nc" id="L61">			EmployeeDate key = new EmployeeDate(spTimeZone.employeeID, spTimeZone.startDate);</span>
<span class="nc" id="L62">			result.put(key, spTimeZone);</span>
<span class="nc" id="L63">		}</span>
<span class="nc" id="L64">		return result;</span>
	}

	private Set&lt;EmployeeSpID&gt; getEmployeeSPIds(List&lt;EmployeeSPTimeZone&gt; spTimeZones) {
<span class="nc" id="L68">		Set&lt;EmployeeSpID&gt; result = new HashSet&lt;EmployeeSpID&gt;();</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">		for (EmployeeSPTimeZone spTimeZone : spTimeZones) {</span>
<span class="nc" id="L70">			EmployeeSpID employeeSpID = new EmployeeSpID(spTimeZone.employeeID, spTimeZone.schedulingPeriodID);</span>
<span class="nc" id="L71">			result.add(employeeSpID);</span>
<span class="nc" id="L72">		}</span>
<span class="nc" id="L73">		return result;</span>
	}

	public ID getRefrenceScheduleID(ID employeeID, Date start) {
<span class="nc" id="L77">		EmployeeSPTimeZone spTimeZone = getEmployeeSpID(employeeID, start);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">		if (spTimeZone == null) {</span>
<span class="nc" id="L79">			return null;</span>
		}
<span class="nc" id="L81">		return ID.fromInt(spTimeZone.schedulingPeriodID);</span>
	}

	public Collection&lt;ShiftAssignment&gt; getReferenceSchedulesRemoveHolidays(ID employeeID, Date start, Date end, TimeZone employeeTimeZone) {
		try {
<span class="nc" id="L86">			HolidayManager hm = BbmManagerFactory.getHolidayManager();</span>
<span class="nc" id="L87">			return getReferenceSchedulesRemoveHolidays(employeeID, start, end, employeeTimeZone, hm);</span>
<span class="nc" id="L88">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L89">			throw new RmRuntimeException(e);</span>
		}
	}

	public Collection&lt;ShiftAssignment&gt; getReferenceSchedulesRemoveHolidays(ID employeeID, Date start, Date end, TimeZone employeeTimeZone,
			HolidayManager hm) {

<span class="nc" id="L96">		EmployeeSPTimeZone spTimeZone = getEmployeeSpID(employeeID, start);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">		if (spTimeZone == null) {</span>
<span class="nc" id="L98">			return Collections.emptyList();</span>
		}

<span class="nc" id="L101">		Collection&lt;ShiftAssignment&gt; shifts = getReferenceSchedules(employeeID, start, end, employeeTimeZone);</span>
<span class="nc" id="L102">		LocalDate localStart = new LocalDate(start, employeeTimeZone);</span>
<span class="nc" id="L103">		LocalDate localEnd = new LocalDate(end, employeeTimeZone);</span>
<span class="nc" id="L104">		ID orgID = ID.fromInt(spTimeZone.organizationID);</span>

		try {
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L108">			Map&lt;ID, Collection&lt;Holiday&gt;&gt; holidaysByOrg = hm.getHolidays(Collections.singleton(orgID), localStart, localEnd);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">			if (holidaysByOrg.isEmpty()) {</span>
<span class="nc" id="L110">				return shifts;</span>
			}
<span class="nc" id="L112">			Collection&lt;Holiday&gt; holidays = holidaysByOrg.get(orgID);</span>
<span class="nc" id="L113">			return RemoveHolidays.removeHolidays(shifts, holidays, employeeTimeZone);</span>
<span class="nc" id="L114">		} catch (Exception e) {</span>
<span class="nc" id="L115">			throw new RmRuntimeException(e);</span>
		}
	}

	public Collection&lt;ShiftAssignment&gt; getReferenceSchedules(ID employeeID, Date start, Date end, TimeZone employeeTimeZone) {

<span class="nc" id="L121">		EmployeeSPTimeZone spTimeZone = getEmployeeSpID(employeeID, start);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">		if (spTimeZone == null) {</span>
<span class="nc" id="L123">			return Collections.emptyList();</span>
		}

<span class="nc" id="L126">		EmployeeSpID key = new EmployeeSpID(spTimeZone.employeeID, spTimeZone.schedulingPeriodID);</span>

<span class="nc" id="L128">		Collection&lt;ShiftAssignment&gt; referenceShifts = referenceSchedules.get(key);</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">		if (referenceShifts == null || referenceShifts.isEmpty()) {</span>
<span class="nc" id="L130">			return Collections.emptyList();</span>
		}

<span class="nc" id="L133">		ReferenceScheduleTransform transform = new ReferenceScheduleTransform(referenceShifts, spTimeZone.getSpTimeZone());</span>
<span class="nc" id="L134">		return transform.transform(start, end, employeeTimeZone);</span>
	}

	private EmployeeSPTimeZone getEmployeeSpID(ID employeeID, Date start) {
<span class="nc" id="L138">		EmployeeDate key = new EmployeeDate(employeeID, start);</span>
<span class="nc" id="L139">		return employeeDateToSP.get(key);</span>
	}

	/**
	 * @return
	 * A map whose key is the day of week as defined by the Calendar integer constants, the value is the pair containing start time of the shift in
	 * minutes from start of day and duration of the shift (also in minutes)
	 */
	public static Map&lt;Integer, Pair&lt;Integer, Integer&gt;&gt; getRefrenceSchedulesByDayOfWeek(TOChoice choice) throws BbmFinderException {

<span class="nc" id="L149">		ReferenceScheduleAssignmentsDAO dao = null;</span>
		try {
<span class="nc" id="L151">			dao = new ReferenceScheduleAssignmentsDAO();</span>
<span class="nc" id="L152">			ReferenceScheduleAssignments refScheduleForChoice = dao.getReferenceScheduleAssignmentForChoice(choice.getID());</span>
<span class="nc" id="L153">			return getRefrenceSchedulesByDayOfWeek(choice, refScheduleForChoice);</span>

<span class="nc" id="L155">		} catch (Exception e) {</span>
<span class="nc" id="L156">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc bnc" id="L158" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L159">				dao.cleanUp();</span>
			}
		}
	}

	static Map&lt;Integer, Pair&lt;Integer, Integer&gt;&gt; getRefrenceSchedulesByDayOfWeek(TOChoice choice, ReferenceScheduleAssignments refSchedule) {

<span class="nc bnc" id="L166" title="All 2 branches missed.">		if (refSchedule.shifts.isEmpty()) {</span>
<span class="nc" id="L167">			return Collections.emptyMap();</span>
		}


<span class="nc" id="L171">		ReferenceScheduleTransform transform = new ReferenceScheduleTransform(refSchedule.shifts, refSchedule.referenceSPTZ);</span>
<span class="nc" id="L172">		Calendar cal = Calendar.getInstance(refSchedule.employeeTZ);</span>
<span class="nc" id="L173">		Calendar rcal = Calendar.getInstance(refSchedule.referenceSPTZ);</span>

<span class="nc" id="L175">		Date end = choice.getEndDate();</span>
<span class="nc" id="L176">		Date dayStart = DateUtil.getDayStart(choice.getStartDate(), cal);</span>
<span class="nc" id="L177">		int i = 0;</span>

		//A LinkedHashMap defines iteration ordering in the same order in which keys are inserted into the map. 
		//This means that front end can call iterate through the map and have the days returned in the order that they were inserted
<span class="nc" id="L181">		Map&lt;Integer, Pair&lt;Integer, Integer&gt;&gt; result = new LinkedHashMap&lt;Integer, Pair&lt;Integer, Integer&gt;&gt;();</span>

<span class="nc bnc" id="L183" title="All 4 branches missed.">		while (dayStart.getTime() &lt; end.getTime() &amp;&amp; i &lt; 7) {</span>


<span class="nc" id="L186">			ShiftAssignment shift = transform.getShiftAssignmentForDayOfWeek(cal);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">			if (shift != null) {</span>
<span class="nc" id="L188">				int shiftStart = DateUtil.getTimeInMinutesFromStartOfDay(shift.getStartTime(), rcal);</span>
<span class="nc" id="L189">				int duration = shift.getDuration();</span>
<span class="nc" id="L190">				int dow = rcal.get(Calendar.DAY_OF_WEEK);</span>
<span class="nc" id="L191">				result.put(dow, new Pair&lt;Integer, Integer&gt;(shiftStart, duration));</span>
			}

<span class="nc" id="L194">			cal.add(Calendar.DATE, 1);</span>
<span class="nc" id="L195">			dayStart = cal.getTime();</span>
<span class="nc" id="L196">			i++;</span>
<span class="nc" id="L197">		}</span>

<span class="nc" id="L199">		return result;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>