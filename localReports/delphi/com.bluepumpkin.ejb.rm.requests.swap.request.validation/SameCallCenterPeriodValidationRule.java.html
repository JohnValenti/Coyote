<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SameCallCenterPeriodValidationRule.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.swap.request.validation</a> &gt; <span class="el_source">SameCallCenterPeriodValidationRule.java</span></div><h1>SameCallCenterPeriodValidationRule.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.swap.request.validation;

import java.util.Calendar;
import java.util.Date;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.util.RmUtil;


/**
 * &lt;li&gt; Rule from UI: Swapped shifts start on the same call center week.
 *
 * &lt;li&gt; This rule ensures that the swapped shifts fall 
 *   within the same organization week.
 *
 * &lt;p&gt;
 * For a 2 way swap, ensure that both shifts are within the same org week. &lt;br&gt;
 * For a 1 way swap, given that both agents are in the same org during the
 * shift given up, the org week rule need not be checked. &lt;br&gt;
 * 
  * 
 * &lt;p&gt;
 * Changing the above functionality to not to check for organization and just consider
 * the org week start   
 * &lt;p&gt;
 */
<span class="nc" id="L40">public class SameCallCenterPeriodValidationRule implements Validator {</span>

<span class="nc" id="L42">	private static final String m_className = SameCallCenterPeriodValidationRule.class.getName();</span>
    
<span class="nc" id="L44">    private static Category m_cat = Log.initCategory(m_className);</span>

    public ValidationResult validate(Validatable validatable)
        throws Exception 
    {
<span class="nc" id="L49">        ShiftSwapRequest ssr = (ShiftSwapRequest) validatable;</span>
<span class="nc" id="L50">        String methodName = &quot;validate&quot;;</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) m_cat.debug(RmUtil.dumpEnterMethod(methodName, ssr));</span>
        
        // todo: refactor common code
<span class="nc" id="L54">        ValidationResult result = null;</span>

<span class="nc" id="L56">        ShiftSwapValidationCache vc = (ShiftSwapValidationCache) ssr.getValidationCache();</span>

        // ssItems is an ordered list item(0) ... item(N-1)
        // item(A) gives its shift to item((A+1)modN)
        // item(A) receives its new shift from item((A+N-1)modN)
<span class="nc" id="L61">        List ssItems = ssr.getShiftSwapItems();</span>

<span class="nc" id="L63">        int ssItemsSize = ssItems.size();</span>

        // get the Organization ID and org week start date for first item
        // each subsequent item must be same as first item
<span class="nc" id="L67">        ShiftSwapItem firstItem = (ShiftSwapItem) ssItems.get(0);</span>
<span class="nc" id="L68">        String type=firstItem.getShiftType();//port for QA 76149</span>

<span class="nc" id="L70">        Date startDateForFirstItem = firstItem.getStartDate();</span>
<span class="nc" id="L71">        ID orgIDForFirstItem = vc.getOrgIDForEmployeeDuringPeriod(firstItem.getEmployeeID(), startDateForFirstItem,</span>
<span class="nc" id="L72">                firstItem.getEndDate());</span>
<span class="nc" id="L73">        Organization orgForFirstItem = vc.getOrganizationByID(orgIDForFirstItem);</span>
//        Pair firstItemOrgWeekRange = ValidationUtil.findOrgWeekStartAndEndDates(orgForFirstItem, startDateForFirstItem);
//      port change for QA 76149
<span class="nc bnc" id="L76" title="All 2 branches missed.">        Date firstItemStartAdjToOrgWeekStart = type.equals(&quot;time-off&quot;)?</span>
<span class="nc" id="L77">			TOCalcUtil.getDateForOrgWeekStart(orgForFirstItem, </span>
<span class="nc" id="L78">					adjustDateWithOrgDayBoundaryOffset(startDateForFirstItem,orgForFirstItem)):</span>
<span class="nc" id="L79">			TOCalcUtil.getDateForOrgWeekStart(orgForFirstItem, startDateForFirstItem);</span>
		
			//Need to convert the first item's week start date to a local date in GMT, so that we can correctly compare it to the second item's date
<span class="nc" id="L82">			LocalDate firstDateLocal = new LocalDate(firstItemStartAdjToOrgWeekStart, orgForFirstItem.getTimeZone());</span>
<span class="nc" id="L83">			Date firstDate = firstDateLocal.getCal().getTime();</span>
			
        // for each item, compare the Organization IDs
<span class="nc" id="L86">        ID orgIDForCurrItem = null;</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        for (int i = 1; i &lt; ssItemsSize; i++) { //todo: ensure that List has index '1'.</span>

<span class="nc" id="L89">            ShiftSwapItem ssItemCurr = (ShiftSwapItem) ssItems.get(i);</span>
<span class="nc" id="L90">            type=ssItemCurr.getShiftType();//port for QA 76149</span>
            
            // validation error if org IDs are not the same.
<span class="nc" id="L93">            Date ssItemCurrStart = ssItemCurr.getStartDate();</span>
<span class="nc" id="L94">            orgIDForCurrItem = vc.getOrgIDForEmployeeDuringPeriod(ssItemCurr.getEmployeeID(), ssItemCurrStart,</span>
<span class="nc" id="L95">                    ssItemCurr.getEndDate());</span>

            // now compare that the weeks are the same
            // todo: if Org IDs are equal, won't the org week start dates be the same?
<span class="nc" id="L99">            Organization orgCurr = vc.getOrganizationByID(orgIDForCurrItem);</span>
//            Pair currItemOrgWeekRange = ValidationUtil.findOrgWeekStartAndEndDates(orgCurr, ssItemCurrStart);
//          port change for QA 76149
<span class="nc bnc" id="L102" title="All 2 branches missed.">            Date currItemStartAdjToOrgWeekStart = type.equals(&quot;time-off&quot;)?</span>
<span class="nc" id="L103">				TOCalcUtil.getDateForOrgWeekStart(orgCurr, </span>
<span class="nc" id="L104">						adjustDateWithOrgDayBoundaryOffset(ssItemCurrStart,orgCurr)):</span>
<span class="nc" id="L105">				TOCalcUtil.getDateForOrgWeekStart(orgCurr, ssItemCurrStart);</span>

			//Need to convert the current item's week start date to a local date in GMT, so that we can correctly compare it to the first item's date
<span class="nc" id="L108">			LocalDate curDateLocal = new LocalDate(currItemStartAdjToOrgWeekStart, orgCurr.getTimeZone());</span>
<span class="nc" id="L109">			Date curDate = curDateLocal.getCal().getTime();</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">			if (!firstDate.equals(curDate)) {</span>

<span class="nc" id="L113">                result = ValidationUtil.setSoftValidationResult(validatable,</span>
                	RmEjbBundleKey.SS_SAME_CALLCENTER_PERIOD,
<span class="nc" id="L115">					firstItem.getEmployeeID(), firstItemStartAdjToOrgWeekStart,</span>
<span class="nc" id="L116">                    ssItemCurr.getEmployeeID(), currItemStartAdjToOrgWeekStart, m_className);</span>

<span class="nc" id="L118">                continue;</span>
            }
        }

<span class="nc" id="L122">        return result;</span>
    }
    //port for QA 76149:START
    private Date adjustDateWithOrgDayBoundaryOffset(Date date, Organization org){
<span class="nc" id="L126">    	long number=date.getTime();</span>
<span class="nc" id="L127">    	return new Date(number+org.getDayBoundaryOffset()*60*1000);</span>
    }
    //port for QA 76149:END
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>