<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SameCampaignValidationRule.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.swap.request.validation</a> &gt; <span class="el_source">SameCampaignValidationRule.java</span></div><h1>SameCampaignValidationRule.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.swap.request.validation;

/**
 * Title:        rm
 * Description:
 * Copyright:    Copyright (c) 2002
 * Company:
 * @author
 * @version 1.0
 */


import java.io.Serializable;
import java.util.Collection;
import java.util.Iterator;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignWorkResource;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationCache;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.verint.ejb.wfm.WfmManagerFactory;

/**
 * &lt;li&gt; Rule from UI: Both agents are from the same campaign.
 *
 * &lt;li&gt; Rule to ensure that for a 2 way swap, before and after the swap,
 *      the agents belong to the same campaign.  Very similar to the same
 *      {@link SameCallCenterValidationRule CallCenter} validation rule:
 * &lt;ul&gt;
 *    &lt;li&gt; before the swap, employees belong to the same campaign during the
 *         duration of their respective shifts.
 *    &lt;li&gt; &lt;b&gt;and&lt;/b&gt; after the swap, employees belong to the same campaign during
 *         the duration of their respective shifts assigned to them after the swap.
 *    &lt;li&gt; The campaign that the employees belong before and after the swap
 *         must be the same.
 * &lt;/ul&gt;
 * &lt;code&gt;
 *         emp1 in camp1                             emp1 in camp1
 *       --------------                           ---------------
 *          shift1                                    shift2
 *       --------------                           ---------------
 *            |                                        / \
 *            |                                         |
 *            \/                                        |
 *       --------------                           ----------------
 *          shift1                                    shift2
 *       --------------                           ----------------
 *          emp2 in camp1                            emp2 in camp1
 * &lt;/code&gt;
 *
 * &lt;p&gt;
 * In other words, for a 2 way swap: If E1 has shift S1 and E2 has shift S2, then during S1 both
 * E1 and E2 must belong to the same campaign. During S2 both E1 and E2 must
 * belong to the same campaign as well as this campaign must match the
 * campaign during S1. &lt;br&gt;
 *
 * In other words, for a one way swap: if E1 has shift S1 being given up to E2, then during S1
 * both E1 and E2 must be in the same campaign. &lt;br&gt;
 *
 * &lt;p&gt;
 * Applies equally for tentative and non-tentative requests as the implementation is concerned
 * only about campaigns and not schedules.
 *
 */
//TODO: partial implementation (only verifies campaigns before swap).  Enhance to verify after swap as well.
public class SameCampaignValidationRule implements Validator{
    //private String bundleName = RmEjbBundleKey.BUNDLE;
<span class="nc" id="L79">	private static final String m_className = SameCampaignValidationRule.class.getName();</span>

<span class="nc" id="L81">    private static Category m_cat = Log.initCategory( SameCampaignValidationRule.class.getName());</span>

<span class="nc" id="L83">    public SameCampaignValidationRule(){</span>
<span class="nc" id="L84">    };</span>

    public ValidationResult validate(Validatable validatable) throws Exception    {
<span class="nc" id="L87">        ShiftSwapRequest ssr = (ShiftSwapRequest)validatable;</span>
<span class="nc" id="L88">        String methodName = &quot;validate&quot;;</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (m_cat.isDebugEnabled()) m_cat.debug(RmUtil.dumpEnterMethod(methodName, ssr));</span>

        //todo: refactor common code
<span class="nc" id="L92">        ValidationResult result = null;</span>

        // items is an ordered list item(0) ... item(N-1)
        // item(A) gives its shift to item((A+1)modN)
        // item(A) receives its new shift from item((A+N-1)modN)
<span class="nc" id="L97">        List items = ssr.getShiftSwapItems();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (items == null) {</span>
<span class="nc" id="L99">            return ValidationUtil.setHardValidationResult(validatable, RmEjbBundleKey.SS_ITEMS_NULL, m_className);</span>
        }

        // get the campaign ID for first item
        // each subsequent item must be same as first item
<span class="nc" id="L104">        ShiftSwapItem firstSSItem = (ShiftSwapItem)items.get(0);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (firstSSItem == null) {</span>
<span class="nc" id="L106">            return ValidationUtil.setHardValidationResult(validatable, RmEjbBundleKey.SS_SHIFT_ITEM_NULL, m_className);</span>
        }

<span class="nc" id="L109">        ShiftSwapValidationCache ssrCache = ssr.getCache();</span>
<span class="nc" id="L110">        Collection campWorkResAssnsForFirstSSItem = ssrCache.getCampWorkResAssnsForSSItem(firstSSItem);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if ( campWorkResAssnsForFirstSSItem.isEmpty() ) {</span>
<span class="nc" id="L112">            return ValidationUtil.setSoftValidationResult(validatable, RmEjbBundleKey.SS_NO_CAMPAIGN,</span>
<span class="nc" id="L113">                new Serializable[] {ssrCache.getEmployeeNameByID(firstSSItem.getEmployeeID())}, m_className );</span>
        }

        //todo: do we only look at the first campaign ID in collection
<span class="nc" id="L117">        ID campIDForFirstSSItem = </span>
<span class="nc" id="L118">        	((CampaignWorkResource)campWorkResAssnsForFirstSSItem.iterator().next()).getCampaignID();</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">        for (int i = 1; i &lt; items.size(); i++) {</span>
<span class="nc" id="L121">            ShiftSwapItem itemCurr = (ShiftSwapItem)items.get(i);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (itemCurr == null) {</span>
<span class="nc" id="L123">                result = ValidationUtil.setHardValidationResult(validatable, RmEjbBundleKey.SS_SHIFT_ITEM_NULL, m_className);</span>
<span class="nc" id="L124">                continue;</span>
            }

            //todo: refactor common code
            //todo: optimize with list if possible
<span class="nc" id="L129">            Iterator iter = ssrCache.getCampWorkResAssnsForSSItem(itemCurr).iterator();</span>
            //todo: do we only look at the first campaign ID in collection
<span class="nc" id="L131">            ID campIDForCurrSSItem = ((CampaignWorkResource)iter.next()).getCampaignID();</span>

            // If campaign IDs not equal
<span class="nc bnc" id="L134" title="All 2 branches missed.">            if (!campIDForFirstSSItem.equals(campIDForCurrSSItem)) {</span>
<span class="nc" id="L135">                ValidationCache vc = validatable.getValidationCache();</span>

<span class="nc" id="L137">				CampaignManager cm = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L138">                result = ValidationUtil.setSoftValidationResult(validatable, RmEjbBundleKey.SS_SAME_CAMPAIGN,</span>
                    new Serializable[] {
<span class="nc" id="L140">                        vc.getEmployeeNameByID(firstSSItem.getEmployeeID()),</span>
<span class="nc" id="L141">                        cm.getCampaignByID(campIDForFirstSSItem).getName(),</span>
<span class="nc" id="L142">                        vc.getEmployeeNameByID(itemCurr.getEmployeeID()),</span>
<span class="nc" id="L143">                        cm.getCampaignByID(campIDForCurrSSItem).getName()},</span>
                    m_className);
            }
        }

<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (m_cat.isDebugEnabled()) m_cat.debug(RmUtil.dumpExitMethod(methodName));</span>
<span class="nc" id="L149">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>