<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TOAccrual.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.timeoff.model</a> &gt; <span class="el_source">TOAccrual.java</span></div><h1>TOAccrual.java</h1><pre class="source lang-java linenums">/*
	 * TOAccrual.java
	 * This class holds all information required to calculate the TO Accrual for given period

	 * Copyright (c) 2008, Verint, Inc.
	 * Sameet Joshi
	 * All rights reserved.
	 */
package com.bluepumpkin.ejb.rm.requests.timeoff.model;

import java.io.Serializable;
import java.text.DateFormatSymbols;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;
import java.util.Map;
import java.util.Set;
import java.util.SortedSet;
import java.util.TreeSet;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategory;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityTimeOffBalance;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.localization.DefaultLocalizationManager;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffAccrued;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffYearly;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationCache;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDay;
import com.bluepumpkin.ejb.rm.util.DateUtil;

//import java.math.MathContext;
//import java.math.RoundingMode;

public class TOAccrual implements Serializable, Validatable {
<span class="nc" id="L53">	private static final String m_className = TOAccrual.class.getName();</span>
<span class="nc" id="L54">	private static Category m_cat = Log.initCategory(m_className);</span>
	public static final String scheduleOfAccrualStr = &quot;NA&quot;;
<span class="nc" id="L56">	public static int NUMBER_NA = 999999999; //equiv to null</span>

<span class="nc" id="L58">	private Activity activity = null;</span>
<span class="nc" id="L59">	private ActivityCategory activityCategory = null;</span>
<span class="nc" id="L60">	private Set activityIDs = null;</span>
<span class="nc" id="L61">	private Date lastAccruedDate = null;</span>
	private EmployeeTimeOffAccrued accruedTO;
	private ID empID;
<span class="nc" id="L64">	private SortedSet toAccrualDetailSet = new TreeSet();</span>
<span class="nc" id="L65">	private final SortedSet&lt;TOAccrualDetailRow&gt; toAccrualDetailViolatedSet = new TreeSet&lt;TOAccrualDetailRow&gt;();</span>
	private double estiAccrHrs;
	private int toAccrualSchedule;
	private int toAccrualPolicy;
<span class="nc" id="L69">	public ActivityTimeOffBalance actTOBal = null;</span>
	public Date endDate;
	public Date startDate;
	public Organization org;
<span class="nc" id="L73">	public int[] empTOYrStArr = null;</span>
<span class="nc" id="L74">	private boolean accrualPolicyAdjusted = false;</span>
	private Employee employee;
<span class="nc" id="L76">	private Set&lt;TOHoursPerDay&gt; hrsPerDaySet = null;</span>
	private Map&lt;String, EmployeeTimeOffYearly&gt; yearlyAllotMapForActOrActCat;
	//This variable is added to make a copy of the Start date when there is an overlapping TO event at the start of the TO Year.
	private Date startYrStartingBalance;

	

	public void setEmployeeTimeOffYearlyMap(Map&lt;String, EmployeeTimeOffYearly&gt; yearlyAllotMapForActOrActCat) {
<span class="nc" id="L84">		this.yearlyAllotMapForActOrActCat = yearlyAllotMapForActOrActCat;</span>
<span class="nc" id="L85">	}</span>

	public Map&lt;String, EmployeeTimeOffYearly&gt; getEmployeeTimeOffYearlyMap() {
<span class="nc" id="L88">		return yearlyAllotMapForActOrActCat;</span>
	}

	public int getEmployeeTimeOffYear(Date date) {
<span class="nc" id="L92">		return RequestUtil.getEmployeeTimeOffYearStart(date,org, empTOYrStArr).get(Calendar.YEAR);</span>
	}

	public EmployeeTimeOffYearly getEmployeeTimeOffYearly(Date d) throws Exception {
<span class="nc" id="L96">		int year = getEmployeeTimeOffYear(d);</span>
<span class="nc" id="L97">		return getEmployeeTimeOffYearly(year);</span>
	}

	public EmployeeTimeOffYearly getEmployeeTimeOffYearly(int year) {
<span class="nc bnc" id="L101" title="All 2 branches missed.">		if (yearlyAllotMapForActOrActCat != null) {</span>
<span class="nc" id="L102">			return yearlyAllotMapForActOrActCat.get(&quot;&quot; + year);</span>
		}
<span class="nc" id="L104">		return null;</span>
	}

	public Set&lt;TOHoursPerDay&gt; getHrsPerDaySet() {
<span class="nc" id="L108">		return hrsPerDaySet;</span>
	}

	public void setHrsPerDaySet(Set&lt;TOHoursPerDay&gt; hrsPerDaySet) {
<span class="nc" id="L112">		this.hrsPerDaySet = hrsPerDaySet;</span>
<span class="nc" id="L113">	}</span>


	public String getActivityOrActCatName() {
<span class="nc" id="L117">		String name = null;</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (getActivity() != null) {</span>
<span class="nc" id="L119">			name = getActivity().getName();</span>
		} else {
<span class="nc" id="L121">			name = getActivityCategory().getName();</span>
		}
<span class="nc" id="L123">		return name;</span>
	}

	public Employee getEmployee() throws Exception {
<span class="nc bnc" id="L127" title="All 2 branches missed.">		if (employee == null) {</span>
<span class="nc" id="L128">			employee = BbmManagerFactory.getWorkResourceManager().getEmployeeByID(empID, null, 0);</span>
		}
<span class="nc" id="L130">		return employee;</span>
	}

	public void setEmployee(Employee employee) {
<span class="nc" id="L134">		this.employee = employee;</span>
<span class="nc" id="L135">	}</span>

	public int getToAccrualPolicy() {
<span class="nc" id="L138">		return toAccrualPolicy;</span>
	}

	public void setToAccrualPolicy(int toAccrualPolicy) {
<span class="nc" id="L142">		this.toAccrualPolicy = toAccrualPolicy;</span>
<span class="nc" id="L143">	}</span>

	public boolean isAccrualPolicyAdjusted() {
<span class="nc" id="L146">		return accrualPolicyAdjusted;</span>
	}

	public void setAccrualPolicyAdjusted(boolean accrualPolicyAdjusted) {
<span class="nc" id="L150">		this.accrualPolicyAdjusted = accrualPolicyAdjusted;</span>
<span class="nc" id="L151">	}</span>

<span class="nc" id="L153">	public TOAccrual() {</span>
<span class="nc" id="L154">	}</span>

	public ActivityCategory getActivityCategory() {
<span class="nc" id="L157">		return activityCategory;</span>
	}

	public ID getActivityCategoryID() {
<span class="nc bnc" id="L161" title="All 2 branches missed.">		return activityCategory == null ? null : activityCategory.getID();</span>
	}

	public Activity getActivity() {
<span class="nc" id="L165">		return activity;</span>
	}


	public void setActivity(Activity activity) {
<span class="nc" id="L170">		this.activity = activity;</span>
<span class="nc" id="L171">	}</span>

	public void setActivityCategory(ActivityCategory activityCategory) {
<span class="nc" id="L174">		this.activityCategory = activityCategory;</span>
<span class="nc" id="L175">	}</span>

	public ID getEmployeeID() {
<span class="nc" id="L178">		return empID;</span>
	}

	public void setEmployeeID(ID empID) {
<span class="nc" id="L182">		this.empID = empID;</span>
<span class="nc" id="L183">	}</span>

	public EmployeeTimeOffAccrued getAccruedTO() {
<span class="nc" id="L186">		return accruedTO;</span>
	}

	public void setAccruedTO(EmployeeTimeOffAccrued accruedTO) {
<span class="nc" id="L190">		this.accruedTO = accruedTO;</span>
<span class="nc" id="L191">	}</span>

	public SortedSet getToAccrualDetailSet() {
<span class="nc" id="L194">		return toAccrualDetailSet;</span>
	}

	public void addViolation(TOAccrualDetailRow accrlRow) {
<span class="nc" id="L198">		toAccrualDetailViolatedSet.add(accrlRow);</span>
<span class="nc" id="L199">	}</span>

	public Set&lt;TOAccrualDetailRow&gt; getViolations() {
<span class="nc" id="L202">		return toAccrualDetailViolatedSet;</span>
	}


	public TOAccrualDetailRow getFirstViolation() {
<span class="nc bnc" id="L207" title="All 4 branches missed.">		return toAccrualDetailViolatedSet != null &amp;&amp; !toAccrualDetailViolatedSet.isEmpty() ? toAccrualDetailViolatedSet.first() : null;</span>
	}

	public void setToAccrualDetailSet(SortedSet toAccrualDetailSet) {
<span class="nc" id="L211">		this.toAccrualDetailSet = toAccrualDetailSet;</span>
<span class="nc" id="L212">	}</span>

	public static TOAccrual getTOAccrualRow(Employee emp, Activity act, ActivityCategory actCat, ActivityTimeOffBalance actTOBal,
			EmployeeTimeOffAccrued accruedTO, int[] empTOYrStArr, ID empID, Organization org, Date startDate, Date endDate)
			throws Exception {

<span class="nc" id="L218">		TOAccrual row = null;</span>
<span class="nc bnc" id="L219" title="All 8 branches missed.">		if ((act != null &amp;&amp; actCat != null) || (act == null &amp;&amp; actCat == null)) {</span>
<span class="nc" id="L220">			m_cat.info(&quot;Invalid values EMPID=&quot; + empID + &quot; for  activityID=&quot; + act + &quot;: activity Cat Id =&quot; + actCat);</span>
<span class="nc" id="L221">			throw RequestUtil.createRmException(RmEjbBundleKey.TO_ACCRUAL_INVALID_DATA, m_cat);</span>
		}
<span class="nc bnc" id="L223" title="All 2 branches missed.">		int accrSched = act != null ? act.getTOAccrualSchedule() : actCat.getTOAccrualSchedule();</span>
<span class="nc bnc" id="L224" title="All 6 branches missed.">		switch (accrSched) {</span>
			case Activity.TO_ACCRUAL_SCHEDULE_DAILY:
<span class="nc" id="L226">				row = new TOAccrualDaily();</span>
<span class="nc" id="L227">				break;</span>
			case Activity.TO_ACCRUAL_SCHEDULE_SEMI_MONTHLY:
<span class="nc" id="L229">				row = new TOAccrualSemiMonthly();</span>
<span class="nc" id="L230">				break;</span>
			case Activity.TO_ACCRUAL_SCHEDULE_MONTHLY:
<span class="nc" id="L232">				row = new TOAccrualMonthly();</span>
<span class="nc" id="L233">				break;</span>
			case Activity.TO_ACCRUAL_SCHEDULE_YEARLY:
<span class="nc" id="L235">				row = new TOAccrualYearly();</span>
<span class="nc" id="L236">				break;</span>
			case Activity.TO_ACCRUAL_SCHEDULE_WEEKLY:
<span class="nc" id="L238">				row = new TOAccrualWeekly();</span>
<span class="nc" id="L239">				break;</span>
			default:
<span class="nc" id="L241">				row = new TOAccrual();</span>
		}
<span class="nc" id="L243">		row.init(emp, act, actCat, actTOBal, accruedTO, empTOYrStArr, empID, org, startDate, endDate);</span>
<span class="nc" id="L244">		return row;</span>
	}


	protected void init(Employee emp, Activity act, ActivityCategory actCat, ActivityTimeOffBalance actTOBal,
			EmployeeTimeOffAccrued accruedTO, int[] empTOYrStArr, ID empID, Organization org, Date startDate, Date endDate)
			throws Exception {
<span class="nc" id="L251">		this.empID = empID;</span>
<span class="nc" id="L252">		this.employee = emp;</span>
<span class="nc" id="L253">		this.org = org;</span>
<span class="nc" id="L254">		SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;MM/dd/yyyy HH:mm:ss&quot;);</span>
<span class="nc" id="L255">		this.endDate = endDate;</span>

<span class="nc" id="L257">		dateFormat.setTimeZone(org.getTimeZone());</span>
<span class="nc" id="L258">		this.actTOBal = actTOBal;</span>
<span class="nc" id="L259">		this.activity = act;</span>
<span class="nc" id="L260">		this.activityCategory = actCat;</span>
<span class="nc" id="L261">		this.empTOYrStArr = empTOYrStArr;</span>

<span class="nc bnc" id="L263" title="All 2 branches missed.">		if (act != null) {</span>
<span class="nc" id="L264">			this.toAccrualSchedule = act.getTOAccrualSchedule();</span>
<span class="nc" id="L265">			this.toAccrualPolicy = act.getTOAccrualPolicy();</span>
		} else {
<span class="nc" id="L267">			this.toAccrualSchedule = actCat.getTOAccrualSchedule();</span>
<span class="nc" id="L268">			this.toAccrualPolicy = actCat.getTOAccrualPolicy();</span>
		}

<span class="nc" id="L271">		this.accruedTO = accruedTO;</span>

<span class="nc bnc" id="L273" title="All 2 branches missed.">		this.estiAccrHrs = accruedTO != null ? accruedTO.getAccruedHours() : 0;</span>


<span class="nc" id="L276">		this.startDate = getStartDate(accruedTO, empTOYrStArr, org, startDate, endDate);</span>

<span class="nc bnc" id="L278" title="All 2 branches missed.">		if (this.startDate == null) {</span>
<span class="nc" id="L279">			m_cat.error(&quot;Cannot continue further  start date can never be null&quot;);</span>
<span class="nc" id="L280">			throw new BbmException(&quot;&quot;);</span>
		}

<span class="nc" id="L283">	}</span>

	private Date getStartDate(EmployeeTimeOffAccrued accruedTO, int[] empTOYrStArr, Organization org, Date startDate, Date endDate)
			throws Exception {

<span class="nc bnc" id="L288" title="All 2 branches missed.">		if (accruedTO != null) {</span>
			//This date will never be before emp start date so use that directly.
<span class="nc" id="L290">			return accruedTO.getAccruedAtDate();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">		} else if (startDate != null) {</span>
			//This is mostly for the dates in past. this date is always start of the TO year for date in past.
			//No adjustment is required.
			//Caller should take care that start date is never before the employee start date.
<span class="nc" id="L295">			return startDate;</span>
		} else {
			//Accrued TO is null &amp; start date is null so it is for current year and no balance available.
			//Either  balance import is not supported/not available or/and emp has joined in current year.
			//We need to adjust start date based on emp start date or emp start year whichever is later.
<span class="nc" id="L300">			return getTimeOffYearStart(org, empTOYrStArr, endDate);</span>
		}
	}

	//The earlier version of this function was being passed in accruedTO which was always null and startDate which was always null. 
	//Refactored to remove code that would never be hit because of this and changed name. Remove this comment after this has been baked in long enough
	private Date getTimeOffYearStart(Organization org, int[] empTOYrStArr, Date endDate) throws Exception {
<span class="nc" id="L307">		Calendar timeOffYearStartForEndDate = RequestUtil.getEmployeeTimeOffYearStart(endDate, org, empTOYrStArr);</span>
<span class="nc" id="L308">		Date timeOffYearStart = timeOffYearStartForEndDate.getTime();</span>
<span class="nc" id="L309">		Employee emp = getEmployee();</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">		return emp.getStartTime().after(timeOffYearStart) ? emp.getStartTime() : timeOffYearStart;</span>
	}

<span class="nc" id="L313">	private Boolean isAccrualPolicyAdjustmentReqd = null;</span>

	public void setAccrualPolicyAdjustmentReqd(boolean result) {
<span class="nc" id="L316">		isAccrualPolicyAdjustmentReqd = new Boolean(result);</span>
<span class="nc" id="L317">	}</span>

	public boolean isAccrualPolicyAdjustmentReqd(Date start, Date end) throws Exception {
<span class="nc bnc" id="L320" title="All 2 branches missed.">		if (isAccrualPolicyAdjustmentReqd == null) {</span>
<span class="nc" id="L321">			boolean result = true;</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">			if (toAccrualPolicy == Activity.ACCRUAL_POLICY_ALL_HOURS_ON_NEXT) {</span>
				//No need to anything here by default all hours are allocated on next accrual.
<span class="nc" id="L324">				result = false;</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">			} else if (this.accruedTO != null) {</span>
<span class="nc" id="L326">				result = false;</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">			} else if (isAccrualPolicyAdjusted()) {</span>
<span class="nc" id="L328">				result = false;</span>
			} else {

<span class="nc" id="L331">				Employee emp = getEmployee();</span>
<span class="nc" id="L332">				Calendar firstTOYearEnd = RequestUtil.getEmployeeTimeOffYearEnd(emp.getStartTime(), org, empTOYrStArr);</span>


<span class="nc bnc" id="L335" title="All 4 branches missed.">				if (toAccrualSchedule == Activity.TO_ACCRUAL_SCHEDULE_YEARLY &amp;&amp; toAccrualPolicy == Activity.ACCRUAL_POLICY_PRORATED_ON_NEXT) {</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">					if (start.before(firstTOYearEnd.getTime())) {</span>
						//why return here? The requested range starts before the end of the employee's first time off year
						//Are we returning because there can be nothing accrued? 
<span class="nc" id="L339">						return false;</span>
					}
<span class="nc" id="L341">					firstTOYearEnd.set(Calendar.YEAR, firstTOYearEnd.get(Calendar.YEAR) + 1);</span>
				}

				//adjustment required if the requested range ends before the end of the employee's first time off year? 
<span class="nc bnc" id="L345" title="All 2 branches missed.">				result = !end.after(firstTOYearEnd.getTime());</span>
			}
<span class="nc" id="L347">			setAccrualPolicyAdjustmentReqd(result);</span>
		}
<span class="nc" id="L349">		return isAccrualPolicyAdjustmentReqd.booleanValue();</span>
	}

	public EmployeeTimeOffAccrued adjustAccruedTOByAccrualPolicy(Date start, Date end) throws Exception {
		//We have come here only because last updated balance is not available  (accruedTO is null)
		//Check if the end date falls in 1st time off year
		// Accrual policy will apply only in first TO year
<span class="nc" id="L356">		EmployeeTimeOffAccrued accrdTO = null;</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">		if (isAccrualPolicyAdjustmentReqd(start, end)) {</span>
<span class="nc" id="L358">			Calendar cal = Calendar.getInstance(org.getTimeZone());</span>
<span class="nc" id="L359">			Employee emp = getEmployee();</span>
			// need to adjust as per accrual policy only if Start date is equal to or after emp start date
<span class="nc bnc" id="L361" title="All 2 branches missed.">			if (emp.getStartTime().after(start)) {</span>
<span class="nc" id="L362">				m_cat.info(&quot;No need to adjust accrual policy since  Start date before emp start date; start=&quot; + start + &quot; : emp start date=&quot; + emp.getStartTime());</span>
<span class="nc" id="L363">				return null;</span>
			}
<span class="nc" id="L365">			cal.setTime(emp.getStartTime());</span>
<span class="nc" id="L366">			EmployeeTimeOffYearly toYearly = getEmployeeTimeOffYearly(getEmployeeTimeOffYear(emp.getStartTime()));</span>
<span class="nc bnc" id="L367" title="All 4 branches missed.">			if (toYearly == null || toYearly.getAccrualRateForYear() &lt;= 0) {</span>
<span class="nc" id="L368">				return null;//No point in going ahead if accrual rate is not available</span>
			}

<span class="nc" id="L371">			double fullHrs = toYearly.getAccrualRateForYear();</span>
<span class="nc" id="L372">			accrdTO = new EmployeeTimeOffAccrued();</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">			accrdTO.setActivityID(activity != null ? activity.getID() : null);</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">			accrdTO.setActivityCategoryId(activityCategory != null ? activityCategory.getID() : null);</span>
<span class="nc" id="L375">			accrdTO.setEmployeeID(empID);</span>
<span class="nc" id="L376">			accrdTO.setAccruedAtDate(emp.getStartTime());</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">			if (toAccrualPolicy == Activity.ACCRUAL_POLICY_ALL_HOURS_ON_START) {</span>
				//Apply this only on start date of employee if end date occurs before end of first TO year
<span class="nc" id="L379">				accrdTO.setAccruedHours(fullHrs);</span>
			} else {
				//Apply this only on start date of employee if end date occurs before end of first TO year
<span class="nc" id="L382">				initCalendarToStartOfPeriod(cal);</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">				if (!cal.getTime().after(emp.getStartTime())) {</span>
					//Increment for all dates &lt;= startdate of employee
<span class="nc" id="L385">					incrementPeriod(cal);</span>
				}
<span class="nc" id="L387">				int dayCountTillNextAccrSched = DateUtil.getDayCountInBetween(org.getTimeZone(), emp.getStartTime(), cal.getTime());</span>
<span class="nc" id="L388">				Date nextAccrSched = cal.getTime();</span>
<span class="nc" id="L389">				decrementPeriod(cal);</span>
<span class="nc" id="L390">				int dayCountBetAccrSched = DateUtil.getDayCountInBetween(org.getTimeZone(), cal.getTime(), nextAccrSched);</span>
<span class="nc" id="L391">				double proratedHrs = fullHrs * dayCountTillNextAccrSched / dayCountBetAccrSched;</span>
<span class="nc" id="L392">				accrdTO.setAccruedHours(proratedHrs);</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">				if (toAccrualPolicy == Activity.ACCRUAL_POLICY_PRORATED_ON_START) {</span>
<span class="nc" id="L394">					accrdTO.setAccruedAtDate(emp.getStartTime());</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">				} else if (toAccrualPolicy == Activity.ACCRUAL_POLICY_PRORATED_ON_NEXT) {</span>
					//Apply this only in the second TO Year applicable on first day of the TO year
<span class="nc bnc" id="L397" title="All 2 branches missed.">					if(nextAccrSched.after(end)){</span>
						//No point calculating accrued hours till next accrual schedule for EARN Prorated on next
						//if the end date falls after the next Accr Schedule
<span class="nc" id="L400">						return null;</span>
					}
<span class="nc" id="L402">					accrdTO.setAccruedAtDate(nextAccrSched);</span>
				}
<span class="nc bnc" id="L404" title="All 2 branches missed.">				if (RequestUtil.isRMDebugEnabled())</span>
<span class="nc" id="L405">					m_cat.info(&quot;Accrual Policy: EMPID =&quot; + empID + &quot; : toAccrualPolicy=&quot; + toAccrualPolicy + &quot; : proratedHrs=&quot; + proratedHrs</span>
<span class="nc" id="L406">					        + &quot; : fullHours=&quot; + fullHrs + &quot; : emp.getStartTime=&quot; + emp.getStartTime() + &quot; : nextAccrSched=&quot; + nextAccrSched</span>
					        + &quot; : dayCountTillNextAccrSched=&quot; + dayCountTillNextAccrSched + &quot; : dayCountBetAccrSched=&quot; + dayCountBetAccrSched);
			}

<span class="nc" id="L410">			setAccrualPolicyAdjustmentReqd(false);</span>
<span class="nc" id="L411">			setAccrualPolicyAdjusted(true);</span>
		}

<span class="nc bnc" id="L414" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc" id="L415">			m_cat.info(&quot;adjustAccruedTOByAccrualPolicy for EMPID =&quot; + empID + accrdTO);</span>
		}
<span class="nc" id="L417">		return accrdTO;</span>
	}

	public Date getStartDate() {
<span class="nc" id="L421">		return startDate;</span>
	}

	public void setStartDate(Date startDate) {
<span class="nc" id="L425">		this.startDate = startDate;</span>
<span class="nc" id="L426">	}</span>
	
	public Date getStDateForStartingBalance() {
<span class="nc" id="L429">		return startYrStartingBalance;</span>
	}

	public void setStDateForStartingBalance(Date startYrStartingBalance) {
<span class="nc" id="L433">		this.startYrStartingBalance = startYrStartingBalance;</span>
<span class="nc" id="L434">	}</span>

	public Date getEndDate() {
<span class="nc" id="L437">		return endDate;</span>
	}

	public void setEndDate(Date endDate) {
<span class="nc" id="L441">		this.endDate = endDate;</span>
<span class="nc" id="L442">	}</span>

	public double getEstimatedAccrHrs() {
<span class="nc" id="L445">		return estiAccrHrs;</span>
	}

	public void setEstimatedAccrHrs(double estiAccrHrs) {
<span class="nc" id="L449">		this.estiAccrHrs = estiAccrHrs;</span>
<span class="nc" id="L450">	}</span>

	public int getToAccrualSchedule() {
<span class="nc" id="L453">		return toAccrualSchedule;</span>
	}

	public Set getActivityIDs() {
<span class="nc" id="L457">		return activityIDs;</span>
	}

	public void setActivityIDs(Set set) {
<span class="nc" id="L461">		this.activityIDs = set;</span>
<span class="nc" id="L462">	}</span>

	public ID getActivityID() {
<span class="nc" id="L465">		ID id = null;</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">		if (activity != null) {</span>
<span class="nc" id="L467">			id = activity.getID();</span>
		}
<span class="nc" id="L469">		return id;</span>
	}

	public ID getActivityCatID() {
<span class="nc" id="L473">		ID id = null;</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">		if (activityCategory != null) {</span>
<span class="nc" id="L475">			id = activityCategory.getID();</span>
		}
<span class="nc" id="L477">		return id;</span>
	}

	public void addTOAccrlDetailRow(int year,
	                                double accrualRate,
	                                TOHoursPerDay hrsPerDay,
	                                Date prevStart,
	                                Date start,
	                                Date end,
	                                boolean chkAccrualForEachTO,
	                                double acctHrsForPeriod,
	                                double accrdHrsForPeriod,
	                                double acctHrsTillDate,
	                                double accrdHrsTillDate, int accrualCount) {

<span class="nc" id="L492">		TOAccrualDetailRow row = new TOAccrualDetailRow(year,</span>
		        accrualRate,
		        hrsPerDay,
		        prevStart,
		        start,
		        end,
		        chkAccrualForEachTO,
		        acctHrsForPeriod,
		        accrdHrsForPeriod,
		        acctHrsTillDate,
		        accrdHrsTillDate, lastAccruedDate, accrualCount);

<span class="nc" id="L504">		toAccrualDetailSet.add(row);</span>
		//compare with -0.00005 instead of zero to eliminate noise in double and avoid using BIGDECIMAL
		//BUG#43437 ; [10SP4_TO Accrual]Auto denied TO request when agent has enough available hours
<span class="nc bnc" id="L507" title="All 4 branches missed.">		if (accrdHrsTillDate &lt; -0.00005 &amp;&amp; hrsPerDay != null) {</span>
<span class="nc" id="L508">			addViolation(row);</span>
		}
<span class="nc" id="L510">	}</span>

	@Override
	public Collection&lt;ValidationResult&gt; getValidationResults(boolean entireBranch) {
<span class="nc bnc" id="L514" title="All 2 branches missed.">		if (m_validationResults == null)</span>
<span class="nc" id="L515">			m_validationResults = new ArrayList&lt;ValidationResult&gt;();</span>
<span class="nc" id="L516">		return m_validationResults;</span>
	}

	@Override
	public void addValidationResult(ValidationResult pValidationResult) {
<span class="nc" id="L521">		getValidationResults(true).add(pValidationResult);</span>
<span class="nc" id="L522">	}</span>

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.rm.requests.common.validation.Validatable#getValidationCache()
	 */
	@Override
	public ValidationCache getValidationCache() {
<span class="nc" id="L529">		throw new UnsupportedOperationException();</span>
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.rm.requests.common.validation.Validatable#getValidationTimeRanges()
	 */
	@Override
	public Collection getValidationTimeRanges() {
<span class="nc" id="L537">		return Collections.singleton(new TimeRange(getStartDate(), getEndDate()));</span>
	}

<span class="nc" id="L540">	private Collection&lt;ValidationResult&gt; m_validationResults = null;</span>

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.rm.requests.common.validation.Validatable#clearValidationResults()
	 */
	@Override
	public void clearValidationResults(boolean entireBranch) {
<span class="nc bnc" id="L547" title="All 2 branches missed.">		if (m_validationResults != null)</span>
<span class="nc" id="L548">			m_validationResults.clear();</span>
<span class="nc" id="L549">	}</span>

	@Override
	public ID getID() {
<span class="nc" id="L553">		return null;  //To change body of implemented methods use File | Settings | File Templates.</span>
	}

	public int getCountInBetween(Date start, Date end) throws Exception {
<span class="nc" id="L557">		SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;MM/dd/yyyy HH:mm:ss&quot;);</span>
<span class="nc" id="L558">		Calendar cal = Calendar.getInstance(org.getTimeZone());</span>
<span class="nc" id="L559">		cal.setTime(start);</span>
<span class="nc" id="L560">		Calendar calEnd = Calendar.getInstance(org.getTimeZone());</span>
<span class="nc" id="L561">		calEnd.setTime(end);</span>
<span class="nc" id="L562">		initCalendarToStartOfPeriod(cal);</span>
		//Do not increment count when cal.getTime() equals emp start time because its already taken care in Accrual Policy.
<span class="nc" id="L564">		Date empStartTime = getEmployee().getStartTime();</span>
<span class="nc" id="L565">		int count = 0;</span>
		while (true) {
<span class="nc bnc" id="L567" title="All 10 branches missed.">			if (empStartTime.before(cal.getTime()) &amp;&amp; !cal.getTime().before(start) &amp;&amp; !cal.getTime().after(calEnd.getTime()) &amp;&amp; (lastAccruedDate == null || lastAccruedDate.before(cal.getTime()))) {</span>
<span class="nc" id="L568">				count++;</span>
<span class="nc" id="L569">				lastAccruedDate = cal.getTime();</span>
			}
<span class="nc" id="L571">			Date before = cal.getTime();</span>
<span class="nc" id="L572">			incrementPeriod(cal);</span>
			//if (RequestUtil.isRMDebugEnabled()) m_cat.info(&quot;\t count= &quot; + count + &quot;;before=&quot; + dateFormat.format(before) + &quot;; after=&quot; + dateFormat.format(cal.getTime()) + &quot;; END DATE=&quot; + dateFormat.format(calEnd.getTime()));
<span class="nc bnc" id="L574" title="All 2 branches missed.">			if (cal.getTime().after(calEnd.getTime())) {</span>
<span class="nc" id="L575">				break;</span>
			}
<span class="nc" id="L577">		}</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.info(&quot;FROM: &quot; + dateFormat.format(start) + &quot; - &quot; + dateFormat.format(calEnd.getTime()) + &quot; ; count=&quot; + count);</span>
<span class="nc" id="L579">		return count;</span>
	}
	/* blank method to be overriden by child classes
	TO Default will not increment
	TO daily  will  increment to the next day
	TO SemiMonth  will  increment on 1st and 15th of every month.
	TO Monthly will increment by month
	TO Yearly will increment by year
	*/

	public void incrementPeriod(Calendar calStart) {

<span class="nc" id="L591">	}</span>

	public void decrementPeriod(Calendar calStart) {

<span class="nc" id="L595">	}</span>
	/* blank method to be overriden by child classes
	TO Default will not increment
	TO daily  will  increment to the next day
	TO SemiMonth  will  increment on 1st and 15th of every month.
	TO Monthly will increment by month
	TO Yearly will increment by year
	*/

	/*to be overriden by child classes
	 TO Default will  init to start of the day
	 TO daily  will  init to start of the day
	 TO SemiMonth  will  init to start of the day
	 TO Monthly will  init to start of the month of the  1ts day 00:00 hrs
	 TO Yearly will init to start of the year based on anniversary date of the employee*/

	protected void initCalendarToStartOfPeriod(Calendar calStart) {
		/* ESR#4347474: DST issue due to Java quirk. We must use cal.add instead of cal.set.
		   See bug JDK-6615045:
		   Masayoshi Okutsu added a comment - 2013-05-23 01:29
			During the &quot;fall-back&quot; period, Calendar doesn't support disambiguation and the given local time is interpreted as standard time.
			To avoid the unexpected DST to standard time change, call add() to reset the value. In the test program, change:
		        test2.set(Calendar.SECOND, 0);
        		test2.set(Calendar.MILLISECOND, 0);
			to
        		test2.add(Calendar.SECOND, -test2.get(Calendar.SECOND));
        		test2.add(Calendar.MILLISECOND, -test2.get(Calendar.MILLISECOND));
			This way DST is preserved.
		*/

<span class="nc" id="L625">		calStart.add(Calendar.HOUR_OF_DAY, -calStart.get(Calendar.HOUR_OF_DAY));</span>
<span class="nc" id="L626">		calStart.add(Calendar.MINUTE, -calStart.get(Calendar.MINUTE));</span>
<span class="nc" id="L627">		calStart.add(Calendar.SECOND, -calStart.get(Calendar.SECOND));</span>
<span class="nc" id="L628">		calStart.add(Calendar.MILLISECOND, -calStart.get(Calendar.MILLISECOND));</span>

<span class="nc bnc" id="L630" title="All 2 branches missed.">		if(org.getDayBoundaryOffset()!=0)</span>
		{
<span class="nc" id="L632">			TOCalcUtil.setCalMinsOffsetFromMidnight(calStart, org.getDayBoundaryOffset());</span>
		}
<span class="nc" id="L634">	}</span>

<span class="nc" id="L636">	DateFormatSymbols dfs = new DateFormatSymbols();</span>
<span class="nc" id="L637">	String[] months = dfs.getMonths();</span>

	@Override
	public String toString() {
<span class="nc" id="L641">		return getClass().getName() + &quot;[ EMPID=&quot; + empID + &quot; , activityID=&quot; + getActivityID() + &quot;;actCatID=&quot; + getActivityCatID() + &quot; ;Date=&quot; + endDate + &quot; ;Esti Accr Hrs=&quot; + estiAccrHrs + &quot;]&quot;;</span>
	}

<span class="nc" id="L644">	static String tdCellClause = &quot;&lt;td class=\&quot;tableItemNormal\&quot; style=\&quot;text-align:left\&quot; iscell=\&quot;true\&quot; id=\&quot;r3c1\&quot; nowrap&gt;&quot;;</span>
<span class="nc" id="L645">	static String thHeaderCl = &quot;&lt;th scope=\&quot;col\&quot; class=\&quot;tbl2ndHdrLeft\&quot; &gt;&quot;;</span>
	//TODO: move this to webbundle
<span class="nc" id="L647">	static String[] accrPolicyArray = new String[]{&quot;Allot all hours on start date&quot;,</span>
	                                               &quot;Allot prorated hours on start date&quot;,
	                                               &quot;Earn all hours on next accrual schedule&quot;,
	                                               &quot;Earn prorated hours on next accrual schedule&quot;};

	public String toHtml() {
<span class="nc" id="L653">		SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;MM/dd/yyyy HH:mm:ss&quot;);</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">		if (org != null) dateFormat.setTimeZone(org.getTimeZone());</span>
<span class="nc" id="L655">		Localizer m_localizer = DefaultLocalizationManager.getDefaultInstance().getLocalizer();</span>
<span class="nc" id="L656">		StringBuffer strBuf = new StringBuffer();</span>

		try {
<span class="nc" id="L659">			strBuf.append(&quot;&lt;TABLE  BORDER=1 &gt;&quot;);</span>
<span class="nc" id="L660">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;TOAccrual&lt;/TH&gt;&quot; + tdCellClause).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc" id="L661">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;EMP ID&lt;/TH&gt;&quot; + tdCellClause).append(empID).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc" id="L662">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Org ID&lt;/TH&gt;&quot; + tdCellClause).append(org.getID()).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc" id="L663">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Org Name&lt;/TH&gt;&quot; + tdCellClause).append(org.getName()).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc" id="L664">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Org TZ&lt;/TH&gt;&quot; + tdCellClause).append(org.getTimeZone().getID() + &quot; :&quot; + org.getTimeZone().getRawOffset()).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">			if (activity != null) {</span>
<span class="nc" id="L666">				strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Activity ID&lt;/TH&gt;&quot; + tdCellClause).append(activity.getID() + &quot;:&quot; + activity.getName()).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
			} else {
<span class="nc" id="L668">				strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Activity Category&lt;/TH&gt;&quot; + tdCellClause).append(activityCategory.getID() + &quot;:&quot; + activityCategory.getName()).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
			}
<span class="nc" id="L670">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Start Date&lt;/TH&gt;&quot; + tdCellClause).append(dateFormat.format(startDate)).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc" id="L671">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;End Date&lt;/TH&gt;&quot; + tdCellClause).append(dateFormat.format(endDate)).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Annivery Date MM/DD&lt;/TH&gt;&quot; + tdCellClause).append((empTOYrStArr != null ? months[empTOYrStArr[0]] + &quot;/&quot; + empTOYrStArr[1] : &quot;N/A&quot;)).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Last updated date&lt;/TH&gt;&quot; + tdCellClause).append((accruedTO != null ? dateFormat.format(accruedTO.getAccruedAtDate()) : &quot;N/A&quot;)).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Last updated balance&lt;/TH&gt;&quot; + tdCellClause).append((accruedTO != null ? &quot;&quot; + accruedTO.getAccruedHours() + &quot; Hours&quot; : &quot;N/A&quot;)).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc bnc" id="L675" title="All 4 branches missed.">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Max Balance &lt;/TH&gt;&quot; + tdCellClause).append((actTOBal != null &amp;&amp; actTOBal.getMaxBalance() != ActivityTimeOffBalance.MAX_BALANCE_NA ? &quot;&quot; + actTOBal.getMaxBalance() + &quot; Hours&quot; : &quot;N/A&quot;)).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc bnc" id="L676" title="All 4 branches missed.">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Max Allowed Carryover&lt;/TH&gt;&quot; + tdCellClause).append((actTOBal != null &amp;&amp; actTOBal.getMaxCarryOver() != ActivityTimeOffBalance.MAX_BALANCE_NA ? &quot;&quot; + actTOBal.getMaxCarryOver() + &quot; Hours&quot; : &quot;N/A&quot;)).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc" id="L677">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Accrual Schedule&lt;/TH&gt;&quot; + tdCellClause).append(Activity.getAccrualScheduleStr(toAccrualSchedule)).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">			if (toAccrualSchedule == Activity.TO_ACCRUAL_SCHEDULE_MONTHLY) {</span>
<span class="nc" id="L679">				strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Accrual day of Month&lt;/TH&gt;&quot; + tdCellClause).append(((TOAccrualMonthly) this).getAccrualDayOfMonth()).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">			} else if (toAccrualSchedule == Activity.TO_ACCRUAL_SCHEDULE_WEEKLY) {</span>
<span class="nc" id="L681">				strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Accrual day of Week&lt;/TH&gt;&quot; + tdCellClause).append(((TOAccrualWeekly) this).getAccrualDayOfWeek()).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
			}
<span class="nc" id="L683">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Accrual Policy&lt;/TH&gt;&quot; + tdCellClause).append(accrPolicyArray[toAccrualPolicy]).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc" id="L684">			strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;Accrued Hrs Till Date&lt;/TH&gt;&quot; + tdCellClause).append(m_localizer.formatNumber(getEstimatedAccrHrs(), 2) + &quot; Hours&quot;).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
<span class="nc" id="L685">			TOAccrualDetailRow row = getFirstViolation();</span>
<span class="nc bnc" id="L686" title="All 4 branches missed.">			if (row != null &amp;&amp; row.hrsPerDay != null) {</span>
<span class="nc" id="L687">				strBuf.append(&quot;&lt;TR&gt;&quot; + thHeaderCl + &quot;First Violation found&lt;/TH&gt;&quot; + tdCellClause).append(row.hrsPerDay).append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot;);</span>
			}
<span class="nc" id="L689">			strBuf.append(&quot;&lt;/TABLE&gt;&quot;);</span>
<span class="nc" id="L690">			strBuf.append(&quot;&lt;BR&gt;TO Range&lt;BR&gt;&quot;);</span>
<span class="nc" id="L691">			strBuf.append(&quot;&lt;TABLE  BORDER=1 &gt;&quot;);</span>
<span class="nc" id="L692">			strBuf.append(&quot;&lt;TR&gt;&quot;);</span>
<span class="nc" id="L693">			strBuf.append(thHeaderCl + &quot;Year     &lt;/TH&gt;&quot;);</span>
<span class="nc" id="L694">			strBuf.append(thHeaderCl + &quot;Accr Rate&lt;/TH&gt;&quot;);</span>
<span class="nc" id="L695">			strBuf.append(thHeaderCl + &quot;TOEventID&lt;/TH&gt;&quot;);</span>
<span class="nc" id="L696">			strBuf.append(thHeaderCl + &quot;ActivityID&lt;/TH&gt;&quot;);</span>
<span class="nc" id="L697">			strBuf.append(thHeaderCl + &quot;Last Accrual Date&lt;/TH&gt;&quot;);</span>
<span class="nc" id="L698">			strBuf.append(thHeaderCl + &quot;Start     &lt;/TH&gt;&quot;);</span>
<span class="nc" id="L699">			strBuf.append(thHeaderCl + &quot;End&lt;/TH&gt;&quot;);</span>
<span class="nc" id="L700">			strBuf.append(thHeaderCl + &quot;Gap from prev start&lt;/TH&gt;&quot;);</span>
<span class="nc" id="L701">			strBuf.append(thHeaderCl + &quot;Count&lt;/TH&gt;&quot;);</span>
			//strBuf.append(&quot;&lt;TD align=right class=\&quot;formRowLight60\&quot; &gt;&lt;b&gt;Count   &lt;/TH&gt;&quot;);
			//strBuf.append(&quot;&quot; + thHeaderCl+&quot;Check Accrual for each TO&lt;/TH&gt;&quot;);
<span class="nc" id="L704">			strBuf.append(thHeaderCl + &quot;Acct Hrs For Period &lt;/TH&gt;&quot;);</span>
<span class="nc" id="L705">			strBuf.append(thHeaderCl + &quot;Acct Hrs Till Date  &lt;/TH&gt;&quot;);</span>
<span class="nc" id="L706">			strBuf.append(thHeaderCl + &quot;Accrued Hrs For Period  &lt;/TH&gt;&quot;);</span>
<span class="nc" id="L707">			strBuf.append(thHeaderCl + &quot;Accrued Hrs Till Date   &lt;/TH&gt;&quot;);</span>
<span class="nc" id="L708">			strBuf.append(&quot;&lt;/TR&gt;&quot;);</span>
//For Loop starts Here
<span class="nc" id="L710">		} catch (Exception e) {</span>
<span class="nc" id="L711">			e.printStackTrace();</span>
<span class="nc" id="L712">		}</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">		for (Iterator iterator = toAccrualDetailSet.iterator(); iterator.hasNext();) {</span>

<span class="nc" id="L715">			TOAccrualDetailRow row = null;</span>
			try {
<span class="nc" id="L717">				row = (TOAccrualDetailRow) iterator.next();</span>
<span class="nc" id="L718">				strBuf.append(&quot;&lt;TR&gt;&quot;);</span>
<span class="nc" id="L719">				strBuf.append(tdCellClause).append(row.year).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc" id="L720">				strBuf.append(tdCellClause).append(row.accrualRate).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">				strBuf.append(tdCellClause).append(row.hrsPerDay != null ? &quot;&quot; + row.hrsPerDay.getTOEventID() : &quot;--&quot;).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">				strBuf.append(tdCellClause).append(row.hrsPerDay != null ? row.hrsPerDay.getActivityID().toString() : &quot;--&quot;).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">				strBuf.append(tdCellClause).append(row.lastAccrualDate != null ? dateFormat.format(row.lastAccrualDate) : &quot;--&quot;).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">				strBuf.append(tdCellClause).append(dateFormat.format(row.hrsPerDay != null ? row.start : row.prevStart)).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc" id="L725">				strBuf.append(tdCellClause).append(dateFormat.format(row.end)).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc" id="L726">				strBuf.append(tdCellClause).append(DateUtil.getDayCountInBetween(org.getTimeZone(), row.prevStart, row.start) + &quot; days&quot;).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc" id="L727">				strBuf.append(tdCellClause).append(row.getAccrualCount()).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">				strBuf.append(tdCellClause).append(row.hrsPerDay != null ? m_localizer.formatNumber(row.getAcctHrsForPeriod(), 2) : &quot;&amp;nbsp;&quot;).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">				strBuf.append(tdCellClause).append(row.hrsPerDay != null ? m_localizer.formatNumber(row.getAcctHrsTillDate(), 2) : &quot;&amp;nbsp;&quot;).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc bnc" id="L730" title="All 4 branches missed.">				strBuf.append(tdCellClause).append(row.chkAccrualForEachTO || row.hrsPerDay == null ? m_localizer.formatNumber(row.getAccrdHrsForPeriod(), 2) : &quot;--&quot;).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">				strBuf.append(tdCellClause).append((TOAccrual.NUMBER_NA == row.getAccrdHrsTillDate()) ? &quot;&amp;nbsp;&quot; : &quot;&quot; + m_localizer.formatNumber(row.getAccrdHrsTillDate(), 2)).append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc" id="L732">				strBuf.append(&quot;&lt;/TR&gt;&quot;);</span>
<span class="nc" id="L733">			} catch (Exception e) {</span>
<span class="nc" id="L734">				e.printStackTrace();</span>
<span class="nc" id="L735">			}</span>
<span class="nc" id="L736">		}</span>
<span class="nc" id="L737">		strBuf.append(&quot;&lt;/TABLE&gt;&quot;);</span>
<span class="nc" id="L738">		return strBuf.toString();</span>
	}
}


</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>