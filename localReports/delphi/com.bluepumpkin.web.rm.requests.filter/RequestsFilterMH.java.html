<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestsFilterMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.filter</a> &gt; <span class="el_source">RequestsFilterMH.java</span></div><h1>RequestsFilterMH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.filter;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.IDStringPair;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestFilter;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.ejb.CalendarTimeOffDayFacade;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.skill.SkillModelHandler;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.system.RequestContext;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftOTExtension;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.bluepumpkin.web.rm.timeoffbid.TimeOffBidModelHandler;

/**
 * Title: RequestsFilterMH Description: Requests Filter Model Handler Copyright: Copyright (c) 2002 Company: Blue Pumpkin Software,
 * Inc
 * 
 * @author David Su, dsu
 * @version 1.0
 * 
 *          Created on October 18, 2002, 10:42 AM
 */
<span class="nc" id="L51">public class RequestsFilterMH extends RequestsMH {</span>
	public static final String ORGANIZATION_KEY = &quot;ORGANIZATION_KEY&quot;;
	public static final String FILTER_NAME_KEY = &quot;FILTER_NAME_KEY&quot;;
	public static final String SUPERVISOR_KEY = &quot;SUPERVISOR_KEY&quot;;
	public static final String REQUEST_STATUS_KEY = &quot;REQUEST_STATUS_KEY&quot;;
	public static final String SKILL_KEY = &quot;SKILL_KEY&quot;;
	public static final String POOL_KEY = &quot;POOL_KEY&quot;;
	public static final String CAMPAIGN_KEY = &quot;CAMPAIGN_KEY&quot;;
	public static final String ACTIVITY_KEY = &quot;ACTIVITY_KEY&quot;;
	public static final String SHIFT_KEY = &quot;SHIFT_KEY&quot;;
	public static final String EXTENSION_KEY = &quot;EXTENSIONS_KEY&quot;;
	public static final String BID_KEY = &quot;BID_KEY&quot;;

	/**
	 * Return Request Filter
	 */
	public static RequestFilter getRequestFilter(ID filterID) throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L68">		return getRequestManager().getRequestFilterById(filterID);</span>
	}

	/**
	 * Create Request Filter
	 */
	public static ID createRequestFilter(RequestFilter filter) throws RemoteException, BbmCreateException {
<span class="nc" id="L75">		return getRequestManager().createRequestFilter(filter);</span>
	}

	/**
	 * Create Request Filter
	 */
	public static void updateRequestFilter(RequestFilter filter) throws BbmUpdateException, BbmCreateException, RemoteException {
<span class="nc" id="L82">		getRequestManager().updateRequestFilter(filter);</span>
<span class="nc" id="L83">	}</span>

	/**
	 * Delete Request Filter
	 */
	public static void deleteRequestFilter(ID filterID) throws BbmRemoveException, BbmCreateException, RemoteException {
<span class="nc" id="L89">		getRequestManager().deleteRequestFilterByID(filterID);</span>
<span class="nc" id="L90">	}</span>

	/**
	 * Return Request Filter Data
	 */
	public static Map getRequestFilterData(RequestContext context, User user, String reqType) throws RemoteException, BbmException {
<span class="nc" id="L96">		HashMap map = new HashMap(4);</span>

<span class="nc" id="L98">		ID userID = user.getID();</span>
<span class="nc" id="L99">		IDStringPair[] filterNames = RequestsMH.getRequestFilterNamesByUserID(userID);</span>
<span class="nc" id="L100">		Collection orgList = OrganizationModelHandler.getAllOrgsInUserScopePlusAncestors(context, context.getUser());</span>
<span class="nc" id="L101">		List reqStatusList = getRequestManager().getPossibleStatesForRequestType(reqType);</span>

		// Retrieve List of Supervisors
<span class="nc" id="L104">		Collection orgIDs = getViewableRequestOrgIDs(user);</span>
<span class="nc" id="L105">		Collection supervisorList = EmployeeModelHandler.getSupervisorsForOrganizations(context, orgIDs, null);</span>

		// Retrieve List of Skills
<span class="nc" id="L108">		Collection skillList = Collections.EMPTY_LIST;</span>
<span class="nc bnc" id="L109" title="All 6 branches missed.">		if (Request.REQUESTTYPE_SHIFTSWAP.equals(reqType) &amp;&amp; orgList != null &amp;&amp; orgList.size() &gt; 0) {</span>
<span class="nc" id="L110">			skillList = SkillModelHandler.getAvailableSkillsInOrg(context, orgIDs);</span>
		}

		// Retrieve List of Time Off Pools
<span class="nc" id="L114">		Collection poolList = Collections.emptyList();</span>
<span class="nc" id="L115">		Collection bidList = Collections.emptyList();</span>
<span class="nc bnc" id="L116" title="All 4 branches missed.">		if (Request.REQUESTTYPE_TIMEOFF.equals(reqType) || Request.REQUESTTYPE_FLEXTIME.equals(reqType)) {</span>
<span class="nc" id="L117">			CalendarTimeOffDayFacade toCalFacade = RmManagerFactory.getInstance().getTimeOffDayFacade();</span>
<span class="nc" id="L118">			poolList = toCalFacade.getTOPoolsForOrgIDs(orgIDs);</span>
<span class="nc" id="L119">			bidList = TimeOffBidModelHandler.getTimeOffBidsForOrgIDs(orgIDs);</span>
		}

		// Retrieve Campaigns/Shifts/Activities/Extensions for the Custom Shift Request Filter
<span class="nc bnc" id="L123" title="All 4 branches missed.">		if (Request.REQUESTTYPE_CUSTSHIFT.equals(reqType) || Request.REQUESTTYPE_FLEXTIME.equals(reqType)) {</span>
			// Get all the user's Campaigns that contains his scoped orgs. Should this list be filtered by his scoped
			// campaigns?
<span class="nc" id="L126">			Collection campaignList = Collections.EMPTY_LIST;</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">			if (Request.REQUESTTYPE_CUSTSHIFT.equals(reqType)) {</span>
<span class="nc" id="L128">				Collection campIDs = CampaignModelHandler.getAllCampaignIDsLinkedToOrgs(context, orgIDs);</span>
<span class="nc" id="L129">				campaignList = CampaignModelHandler.getCampaignsByIDs(context, campIDs);</span>
			}

			// Get all Shifts and Extensions defined in the list of orgs (TBD: or in the user's scoped Campaigns?)
<span class="nc" id="L133">			HashMap&lt;ID, String&gt; shiftIDNamesMap = new HashMap();</span>
<span class="nc" id="L134">			HashMap&lt;ID, String&gt; extIDNamesMap = new HashMap();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">			for (Iterator it = orgIDs.iterator(); it.hasNext();) {</span>
<span class="nc" id="L136">				ID orgID = (ID) it.next();</span>
<span class="nc" id="L137">				shiftIDNamesMap.putAll(WorkRulesModelHandler.getShiftNamesByOrg(context, orgID));</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">				if (Request.REQUESTTYPE_CUSTSHIFT.equals(reqType)) {</span>
<span class="nc" id="L139">					extIDNamesMap.putAll(WorkRulesModelHandler.getOTExtensionNamesByOrg(context, orgID));</span>
				}
<span class="nc" id="L141">			}</span>

			// Get all Activities defined in the list of orgs
<span class="nc" id="L144">			ActivityFilter activityFilter = new ActivityFilter();</span>
<span class="nc" id="L145">			activityFilter.setUsedInShift(true); // we want to see primary activities</span>
<span class="nc" id="L146">			activityFilter.setActivityId(Activity.ACTIVITY_NONE.toString(), ActivityFilter.OP_NOT_IN_LIST);</span>
<span class="nc" id="L147">			Collection activityList = ActivityModelHandler.getActivities(context, orgIDs, activityFilter, true);</span>

<span class="nc" id="L149">			map.put(CAMPAIGN_KEY, campaignList);</span>
<span class="nc" id="L150">			map.put(SHIFT_KEY, shiftIDNamesMap);</span>
<span class="nc" id="L151">			map.put(EXTENSION_KEY, extIDNamesMap);</span>
<span class="nc" id="L152">			map.put(ACTIVITY_KEY, activityList);</span>
		}

<span class="nc" id="L155">		map.put(FILTER_NAME_KEY, filterNames);</span>
<span class="nc" id="L156">		map.put(ORGANIZATION_KEY, orgList);</span>
<span class="nc" id="L157">		map.put(SUPERVISOR_KEY, supervisorList);</span>
<span class="nc" id="L158">		map.put(REQUEST_STATUS_KEY, reqStatusList);</span>
<span class="nc" id="L159">		map.put(SKILL_KEY, skillList);</span>
<span class="nc" id="L160">		map.put(POOL_KEY, poolList);</span>
<span class="nc" id="L161">		map.put(BID_KEY, bidList);</span>

<span class="nc" id="L163">		return map;</span>
	}

	/**
	 * Return list of viewable requests Org IDs
	 */
	private static Collection getViewableRequestOrgIDs(User user) {
<span class="nc" id="L170">		Collection ssOrgIDs = user.getAuthorizedScopes(PrivilegeKeys.SS_VIEWREQUESTSFOREMPLOYEE, Organization.SCOPE_TYPE);</span>
<span class="nc" id="L171">		Collection toOrgIDs = user.getAuthorizedScopes(PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE, Organization.SCOPE_TYPE);</span>
<span class="nc" id="L172">		Collection ftOrgIDs = user.getAuthorizedScopes(PrivilegeKeys.FT_VIEWREQUESTSFOREMPLOYEE, Organization.SCOPE_TYPE);</span>
<span class="nc" id="L173">		Collection csOrgIDs = user.getAuthorizedScopes(PrivilegeKeys.CS_VIEWREQUESTSFOREMPLOYEE, Organization.SCOPE_TYPE);</span>

<span class="nc" id="L175">		ArrayList orgIDs = new ArrayList(ssOrgIDs.size() + toOrgIDs.size() + csOrgIDs.size());</span>
<span class="nc" id="L176">		orgIDs.addAll(ssOrgIDs);</span>
<span class="nc" id="L177">		orgIDs.addAll(toOrgIDs);</span>
<span class="nc" id="L178">		orgIDs.addAll(csOrgIDs);</span>
<span class="nc" id="L179">		return orgIDs;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>