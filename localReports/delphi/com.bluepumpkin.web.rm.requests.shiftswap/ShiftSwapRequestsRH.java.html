<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftSwapRequestsRH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.shiftswap</a> &gt; <span class="el_source">ShiftSwapRequestsRH.java</span></div><h1>ShiftSwapRequestsRH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.shiftswap;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.DateTimeUtil;
import com.bluepumpkin.common.util.JMSNotifyUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.core.base.CoreException;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.notification.model.RequestNotificationDetail;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.ShiftSwapPosting;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.ShiftSwapRequestUtil;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.bluepumpkin.web.rm.requests.AgentsRequestsPM;
import com.bluepumpkin.web.rm.requests.RequestUtil;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.bluepumpkin.web.rm.requests.RequestsRH;
import com.bluepumpkin.web.rm.requests.SwapUtil;
import com.bluepumpkin.web.rm.requests.swapboard.RequestsSwapBoardMH;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        ShiftSwapRequestsRH
 * Description:  Handle Shift Swap Requests Actions
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 *
 * @author David Su, dsu
 * @version 1.0
 *          &lt;p/&gt;
 *          Created on November 5, 2002, 5:04 PM
 */
<span class="nc" id="L58">public class ShiftSwapRequestsRH extends RequestsRH {</span>
<span class="nc" id="L59">	private static final Category m_log = Log.initCategory(ShiftSwapRequestsRH.class.getName());</span>

	/**
	 * Process Request
	 *
	 * @param context The Request Context
	 */
	@Override
	public void processRequest(RequestContext context) throws Exception {
		// Process requested action
<span class="nc bnc" id="L69" title="All 2 branches missed.">		if (isAction(context, PageAction.SAVE)) {</span>
<span class="nc" id="L70">			processSave(context);</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">		} else if (isAction(context, PageAction.SUBMIT_TO_MGR)) {</span>
<span class="nc" id="L72">			context.setAttribute(RequestContext.REQUEST_SCOPE, RmKeys.SHIFT_SWAP_FORM_SHOW_SUBMIT_ONLY, &quot;true&quot;);</span>
<span class="nc" id="L73">			super.processRequest(context);</span>
		} else {
<span class="nc" id="L75">			super.processRequest(context);</span>
		}
<span class="nc" id="L77">	}</span>

	/**
	 * Process Save Action
	 */
	public void processSave(RequestContext context) {
<span class="nc" id="L83">		ShiftSwapRequestFormPopupPM model = new ShiftSwapRequestFormPopupPM(context);</span>
<span class="nc" id="L84">		model.extractParameters(context.getRequest());</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">		if (model.validate()) {</span>
			try {
<span class="nc bnc" id="L88" title="All 2 branches missed.">				if (model.isNew()) {</span>
<span class="nc" id="L89">					createRequest(context, model);</span>
				} else {
<span class="nc" id="L91">					updateRequest(context, model);</span>
<span class="nc" id="L92">					model.setOpenerValue(AgentsRequestsPM.IS_ON_SAME_PAGE_FN, &quot;true&quot;);</span>
				}
<span class="nc" id="L94">			} catch (MultiUserException ex) {</span>
<span class="nc" id="L95">				model.addPageMessage(Message.WARNING_TYPE,</span>
				        RmWebBundleKey.UNABLE_TO_UPDATE_REQUEST_DUE_TO_MULTIUSER_EXCEPTION,
				        RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L98">			} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L99">				m_log.l7dDebug(RmWebLogBundleKey.UNABLE_TO_SAVE_REQUEST, ex);</span>
<span class="nc" id="L100">				Message msg = new Message(Message.ERROR_TYPE, RmWebBundleKey.UNABLE_TO_SAVE_REQUEST, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L101">				msg.setAssociatedMessage(getLocMsgFromException(context, ex));</span>
<span class="nc" id="L102">				model.addPageMessage(msg);</span>
<span class="nc" id="L103">			} catch (Exception ex) {</span>
<span class="nc" id="L104">				m_log.l7dError(RmWebLogBundleKey.UNABLE_TO_SAVE_REQUEST, ex);</span>
<span class="nc" id="L105">				model.addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.UNABLE_TO_SAVE_REQUEST, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L106">			}</span>
		}

<span class="nc" id="L109">		context.setPageModel(model);</span>
<span class="nc" id="L110">	}</span>

	/**
	 * Create Request
	 */
	private void createRequest(RequestContext context, ShiftSwapRequestFormPopupPM model)
			throws Exception, RemoteException, BbmException, RmHardValidationException {
		// Security check
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (!isAuthorized(context, PrivilegeKeys.SS_MODIFYPERSONALREQUESTS)) {</span>
<span class="nc" id="L119">			model.setHasError(true);</span>
<span class="nc" id="L120">			return;</span>
		}

		// ShiftSwapRequestParameters is used so the createRequest logic can be shared between the web page and REST service
<span class="nc" id="L124">		ShiftSwapRequestParameters requestParams = createRequestParameters(model);</span>
<span class="nc" id="L125">		createRequest(context, requestParams);</span>

		// add page messages
<span class="nc bnc" id="L128" title="All 2 branches missed.">		for (Message message : requestParams.getMessages()) {</span>
<span class="nc" id="L129">			model.addPageMessage(message);</span>
<span class="nc" id="L130">		}</span>

<span class="nc" id="L132">		model.setSavedRequestID(requestParams.getSavedRequestID());</span>
<span class="nc" id="L133">	}</span>

	private ShiftSwapRequestParameters createRequestParameters(ShiftSwapRequestFormPopupPM model) {
<span class="nc" id="L136">		ShiftSwapRequestParameters requestParams = new ShiftSwapRequestParameters(model);</span>
<span class="nc" id="L137">		requestParams.setAgentID(model.getAgentID());</span>
<span class="nc" id="L138">		requestParams.setExpirationDate(model.getExpiration());</span>
<span class="nc" id="L139">		requestParams.setIsPickupPartial(model.getIsPickupPartial());</span>
<span class="nc" id="L140">		requestParams.setIsSwapPartial(model.getIsSwapPartial());</span>
<span class="nc" id="L141">		requestParams.setNegotiable(model.isNegotiable());</span>
<span class="nc" id="L142">		requestParams.setNegotiationComment(model.getNegotiationComment());</span>
<span class="nc" id="L143">		requestParams.setPickupEndDate(model.getPickupDateRangePicker().getEndDatePickerPC().getDate());</span>
<span class="nc" id="L144">		requestParams.setPickupStartDate(model.getPickupDateRangePicker().getStartDatePickerPC().getDate());</span>
<span class="nc" id="L145">		requestParams.setPostingID(model.getPostingID());</span>
<span class="nc" id="L146">		requestParams.setRequestDate1(model.getRequestDate1());</span>
<span class="nc" id="L147">		requestParams.setRequestDate2(model.getRequestDate2());</span>
<span class="nc" id="L148">		requestParams.setShiftType(model.getShiftType());</span>
<span class="nc" id="L149">		requestParams.setSubmitToMgr(model.isSubmitToMgr());</span>
<span class="nc" id="L150">		requestParams.setSwapEndDate(model.getSwapDateRangePicker().getEndDatePickerPC().getDate());</span>
<span class="nc" id="L151">		requestParams.setSwapStartDate(model.getSwapDateRangePicker().getStartDatePickerPC().getDate());</span>
<span class="nc" id="L152">		requestParams.setSwapType(model.getSwapType());</span>
<span class="nc" id="L153">		return requestParams;</span>
	}

	/**
	 * Create Request
	 */
	public static ShiftSwapRequest createRequest(RequestContext context, ShiftSwapRequestParameters model)
	        throws Exception, RemoteException, BbmException, RmHardValidationException {

<span class="nc" id="L162">		ID agentID1 = context.getUser().getEmployeeID();</span>
<span class="nc" id="L163">		ID agentID2 = model.getAgentID();</span>
<span class="nc" id="L164">		Date expirationDate = model.getExpirationDate();</span>
<span class="nc" id="L165">		boolean isNegotiable = model.isNegotiable();</span>

		// Create Shift Swap Item 1
<span class="nc" id="L168">		ShiftSwapItem ssItem1 = new ShiftSwapItem();</span>
<span class="nc" id="L169">		ssItem1.setEmployeeID(agentID1);</span>
<span class="nc" id="L170">		ssItem1.setExpirationDate(expirationDate);</span>
<span class="nc" id="L171">		ssItem1.setNegotiation(isNegotiable);</span>
<span class="nc" id="L172">		ssItem1.setIsPartial(model.getIsSwapPartial());</span>

		// Create Shift Swap Item 2
<span class="nc" id="L175">		ShiftSwapItem ssItem2 = new ShiftSwapItem();</span>
<span class="nc" id="L176">		ssItem2.setEmployeeID(agentID2);</span>
<span class="nc" id="L177">		ssItem2.setExpirationDate(expirationDate);</span>
<span class="nc" id="L178">		ssItem2.setNegotiation(true);</span>
<span class="nc" id="L179">		ssItem2.setIsPartial(model.getIsPickupPartial());</span>

<span class="nc" id="L181">		assertCanSwapWithEmployee(context, agentID2);</span>

//		if from posting
<span class="nc" id="L184">		ShiftSwapPosting posting = null;</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">		if (model.getPostingID() != null) {</span>
			//get posting
<span class="nc" id="L187">			posting = RequestsSwapBoardMH.getPostingByID(model.getPostingID());</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">			if (posting.getIsPartial()) {</span>
<span class="nc" id="L189">				ssItem1.setIsPartial(true);</span>
			}
<span class="nc bnc" id="L191" title="All 2 branches missed.">			if (posting.getAllowPartial()) {</span>
<span class="nc" id="L192">				ssItem2.setIsPartial(true);</span>
			}
		}

		// Adjust New Shift Swap Items only for non-partial shifts
		//partial shifts will be validated thru hard validator
<span class="nc" id="L198">		boolean success = true;</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">		if (!ssItem1.getIsPartial() &amp;&amp; !ssItem2.getIsPartial()) {</span>
<span class="nc" id="L200">			success = adjustNewShiftSwapItems(context, model, ssItem1, ssItem2, posting);</span>
		} else {
			//set shift types
<span class="nc" id="L203">			ssItem1.setShiftType(ShiftSwapItem.SWAPITEMTYPE_SHIFT);</span>
<span class="nc" id="L204">			ssItem2.setShiftType(ShiftSwapItem.SWAPITEMTYPE_SHIFT);</span>
			//set item dates
<span class="nc bnc" id="L206" title="All 2 branches missed.">			if (model.getIsSwapPartial()) {//set item start and end dates</span>
<span class="nc" id="L207">				ssItem1.setIsPartial(true);</span>
<span class="nc" id="L208">				ssItem1.setStartDate(model.getSwapStartDate());</span>
<span class="nc" id="L209">				ssItem1.setEndDate(model.getSwapEndDate());</span>
			} else {//set start nad end dates to selected date
<span class="nc" id="L211">				ssItem1.setIsPartial(false);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">				if (model.getRequestDate1() != null) {</span>
					//get exact shift times
<span class="nc" id="L214">					success = SwapUtil.adjustShiftSwapItemDates(ssItem1, model.getRequestDate1(),</span>
<span class="nc" id="L215">					        context.getLocalizer(), context.getViewingTimeZone(), model);</span>
				} else {//its a one way swap
//						get exact shift times
<span class="nc" id="L218">					ssItem1.setStartDate(posting.getStartDate());</span>
<span class="nc" id="L219">					ssItem1.setEndDate(posting.getEndDate());</span>
				}
			}
<span class="nc bnc" id="L222" title="All 2 branches missed.">			if (model.getIsPickupPartial()) {</span>
<span class="nc" id="L223">				ssItem2.setIsPartial(true);</span>
<span class="nc" id="L224">				ssItem2.setStartDate(model.getPickupStartDate());</span>
<span class="nc" id="L225">				ssItem2.setEndDate(model.getPickupEndDate());</span>
			} else {//need to set start and end times
<span class="nc bnc" id="L227" title="All 2 branches missed.">				if (model.getSwapType().equals(ShiftSwapRequest.SHIFTSWAP_TYPE_TWOWAY)) {</span>
					//if from postinmg, use posting start and end
<span class="nc bnc" id="L229" title="All 2 branches missed.">					if (posting != null) {</span>
<span class="nc" id="L230">						ssItem2.setIsPartial(posting.getIsPartial());</span>
<span class="nc" id="L231">						ssItem2.setStartDate(posting.getDisplayStartDate());</span>
<span class="nc" id="L232">						ssItem2.setEndDate(posting.getEndDate());</span>
					} else {
						//get exact shift times
<span class="nc" id="L235">						SwapUtil.adjustShiftSwapItemDates(ssItem2, model.getRequestDate2(),</span>
<span class="nc" id="L236">						        context.getLocalizer(), context.getViewingTimeZone(), model);</span>
					}
				} else {//it is time off: set date to start and end of swap date
<span class="nc" id="L239">					ssItem2.setShiftType(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF);</span>
<span class="nc" id="L240">					ssItem2.setStartDate(ssItem1.getStartDate());</span>
<span class="nc" id="L241">					ssItem2.setEndDate(ssItem1.getEndDate());</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">					if (DateTimeUtil.getDayStart(ssItem1.getStartDate(), context.getViewingTimeZone()).before(new Date())) {</span>
<span class="nc" id="L243">						ssItem2.setStartDate(ssItem1.getStartDate());</span>
					}
				}
			}

			//if posting is one way shift, swap item employee ids
<span class="nc bnc" id="L249" title="All 2 branches missed.">			if (posting != null</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">			        &amp;&amp; posting.getSwapType().equals(ShiftSwapRequest.SHIFTSWAP_TYPE_ONEWAY)</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">			        &amp;&amp; posting.getShiftSwapItem().getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT)) {</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">				if (posting.getIsPartial()) {</span>
<span class="nc" id="L253">					ssItem1.setIsPartial(true);</span>
				}
<span class="nc bnc" id="L255" title="All 2 branches missed.">				if (model.getIsPickupPartial()) {</span>
					//qc66550 pick up partial one-way posting fails ShiftExistValidationRule
<span class="nc" id="L257">					ssItem1.setIsPartial(true);</span>
					//end qc66550
<span class="nc" id="L259">					ssItem1.setAllowPartial(true);</span>
<span class="nc" id="L260">					ssItem1.setStartDate(model.getPickupStartDate());</span>
<span class="nc" id="L261">					ssItem1.setEndDate(model.getPickupEndDate());</span>
<span class="nc" id="L262">					ssItem2.setStartDate(ssItem1.getStartDate());</span>
<span class="nc" id="L263">					ssItem2.setEndDate(ssItem1.getEndDate());</span>

				}
<span class="nc" id="L266">				ssItem2.setShiftType(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF);</span>
				/* 	     */
<span class="nc" id="L268">				boolean tmpSwapItem = ssItem1.getNegotiation();</span>
<span class="nc" id="L269">				ssItem1.setNegotiation(ssItem2.getNegotiation());</span>
<span class="nc" id="L270">				ssItem2.setNegotiation(tmpSwapItem);</span>

<span class="nc" id="L272">				ssItem1.setShiftID(posting.getShiftSwapItem().getShiftID());</span>
				//agentID2 is the employee who created the posting
<span class="nc" id="L274">				ssItem1.setEmployeeID(agentID2);</span>
<span class="nc" id="L275">				ssItem2.setEmployeeID(agentID1);</span>

<span class="nc bnc" id="L277" title="All 2 branches missed.">			} else if (posting != null</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">					   &amp;&amp; posting.getSwapType().equals(ShiftSwapRequest.SHIFTSWAP_TYPE_TWOWAY)</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">					   &amp;&amp; posting.getShiftSwapItem().getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT)) {</span>
<span class="nc" id="L280">				ssItem2.setShiftID(posting.getShiftSwapItem().getShiftID());</span>
			}
		}

<span class="nc" id="L284">		ShiftSwapRequest ssRequest = null;</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">		if (success) {</span>
			// Create New Shift Swap Request
<span class="nc" id="L287">			String swapType = model.getSwapType();</span>
<span class="nc" id="L288">			ShiftSwapRequest request = createNewShiftSwapRequest(context, swapType, expirationDate, ssItem1, ssItem2);</span>
			// Update Request Status
<span class="nc" id="L290">			String rStatus = RequestAuditTrail.STATUS_NEGOTIATION;</span>
<span class="nc bnc" id="L291" title="All 6 branches missed.">			if (model.isSubmitToMgr() &amp;&amp; posting != null &amp;&amp; model.getPostingID() != null) {</span>
<span class="nc" id="L292">				rStatus = RequestAuditTrail.STATUS_PENDING;</span>
			}
<span class="nc" id="L294">			request.setRequestStatus(rStatus);</span>

			// set Negotiation Comment
<span class="nc" id="L297">			String negotiationCmnt = model.getNegotiationComment();</span>
<span class="nc" id="L298">			request.setNegotiationComment(negotiationCmnt);</span>
<span class="nc" id="L299">			ID requestID = ShiftSwapRequestsMH.createRequest(request, &quot;&quot;);</span>
<span class="nc" id="L300">			model.setSavedRequestID(requestID);</span>

			//add message if request is two way partial shift swap and base activities are not the same
<span class="nc bnc" id="L303" title="All 4 branches missed.">            if ((ssItem1.getIsPartial() || ssItem2.getIsPartial()) &amp;&amp;</span>
<span class="nc bnc" id="L304" title="All 4 branches missed.">                    ssItem1.isSwapTypeShift() &amp;&amp; ssItem2.isSwapTypeShift()) {</span>
<span class="nc" id="L305">				ShiftAssignment[] saArray = ShiftSwapRequestUtil.performPartialSwap(request, false,</span>
<span class="nc" id="L306">						WfmManagerFactory.getScheduleAccessManager(), false, false);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">				if (saArray != null) {</span>
<span class="nc" id="L308">					boolean isDifferentActivity = false;</span>
<span class="nc bnc" id="L309" title="All 4 branches missed.">					if (!(saArray[0]).getActivityID().equals((saArray[1]).getActivityID())</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">					        || (saArray.length &gt; 2 &amp;&amp; !(saArray[2]).getActivityID().equals((saArray[3]).getActivityID()))) {</span>
<span class="nc" id="L311">						isDifferentActivity = true;</span>
					}
<span class="nc bnc" id="L313" title="All 2 branches missed.">					if (isDifferentActivity) {</span>
<span class="nc" id="L314">						model.addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.PSS_DIFF_SHIFT_ACTIVITIES, RmWebBundleKey.BUNDLE_NAME);</span>
					}
				}
			}
<span class="nc" id="L318">            ssRequest = ShiftSwapRequestsMH.getRequestByID(requestID);</span>
<span class="nc" id="L319">            JMSNotifyUtil.notifyOnUserAction(new RequestNotificationDetail(ssRequest, ssRequest.getRequestStatus(), context.getUser().getEmployeeID()));</span>
		}
<span class="nc" id="L321">		return ssRequest;</span>
	}

	/**
	 * Update Request
	 */
	private void updateRequest(RequestContext context, ShiftSwapRequestFormPopupPM model)
			throws RemoteException, BbmException, RmHardValidationException, CoreException {
<span class="nc" id="L329">		EditShiftSwapRequestParameters requestParams = new EditShiftSwapRequestParameters();</span>
<span class="nc" id="L330">		requestParams.setComment(model.getComment()); // comes from model (probably the new comment)</span>
<span class="nc" id="L331">		requestParams.setExpirationDate(model.getExpiration());</span>
<span class="nc" id="L332">		requestParams.setNegotiable(model.isNegotiable());</span>
<span class="nc" id="L333">		requestParams.setNegotiationComment(model.getNegotiationComment()); // comes from request</span>
<span class="nc" id="L334">		requestParams.setRequestID(model.getRequestID());</span>
<span class="nc" id="L335">		requestParams.setSubmitToMgr(model.isSubmitToMgr());</span>

<span class="nc" id="L337">		ShiftSwapRequest request = updateRequest(context, requestParams);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">		if (request != null) {</span>
<span class="nc" id="L339">			model.setSavedRequestID(request.getID());</span>
		}
<span class="nc" id="L341">	}</span>

	/**
	 * Update Request
	 */
	public static ShiftSwapRequest updateRequest(RequestContext context, EditShiftSwapRequestParameters model)
			throws RemoteException, BbmException, RmHardValidationException, CoreException {
<span class="nc" id="L348">		ID requestID = model.getRequestID();</span>
<span class="nc" id="L349">		Date expirationDate = model.getExpirationDate();</span>

<span class="nc" id="L351">		ShiftSwapRequest ssRequest = ShiftSwapRequestsMH.getRequestByID(requestID);</span>

		// Security check
<span class="nc bnc" id="L354" title="All 2 branches missed.">		if (!RequestUtil.isAuthToUpdate(context, ssRequest)) {</span>
<span class="nc" id="L355">			model.setHasError(true);</span>
<span class="nc" id="L356">			return null;</span>
		}

<span class="nc" id="L359">		ID empID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L360">		Pair&lt;ShiftSwapItem, ShiftSwapItem&gt; items = SwapUtil.getEmployeeItems(ssRequest, empID);</span>
		// if the other person requires negotiation, do not submit.
<span class="nc bnc" id="L362" title="All 2 branches missed.">		if (items.getSecond().getNegotiation()) {</span>
<span class="nc" id="L363">			model.setSubmitToMgr(false);</span>
		}

<span class="nc" id="L366">		boolean jmsNotify = false;</span>
		// Update Item information only if it is under Negotiation
<span class="nc bnc" id="L368" title="All 2 branches missed.">		if (RequestAuditTrail.STATUS_NEGOTIATION.equals(ssRequest.getRequestStatus())) {</span>
<span class="nc" id="L369">			ShiftSwapItem item = items.getFirst();</span>
<span class="nc" id="L370">			boolean isNegotiatble = model.isNegotiable();</span>
<span class="nc" id="L371">			String negotiationCmnt = model.getNegotiationComment();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">			if (!model.isSubmitToMgr()) {</span>
<span class="nc bnc" id="L373" title="All 4 branches missed.">				boolean isExpirationDateChanged = expirationDate != null &amp;&amp; item != null</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">						&amp;&amp; !expirationDate.equals(item.getExpirationDate());</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">				boolean isNegotiationChanged = (item.getNegotiation() != isNegotiatble);</span>
<span class="nc bnc" id="L376" title="All 4 branches missed.">				boolean isNegotiationCmntUpdated = negotiationCmnt != null &amp;&amp; !negotiationCmnt.equals(ssRequest.getNegotiationComment());</span>
<span class="nc bnc" id="L377" title="All 6 branches missed.">				jmsNotify = (isNegotiationCmntUpdated || isNegotiationChanged || isExpirationDateChanged);</span>

<span class="nc bnc" id="L379" title="All 2 branches missed.">				if (isNegotiationCmntUpdated) {</span>
					// The UI locks the comment field but still lets the user edit the request, therefore we will not throw an exception
					// if the negotiation comment hasn't changed
<span class="nc" id="L382">					assertMaxNegotiationCountForEdit(context, ssRequest, model);</span>
				}
			}
<span class="nc" id="L385">			item.setExpirationDate(expirationDate);</span>
<span class="nc" id="L386">			item.setNegotiation(isNegotiatble);</span>
<span class="nc" id="L387">			ssRequest.setNegotiationComment(negotiationCmnt);</span>
		}

<span class="nc bnc" id="L390" title="All 2 branches missed.">		if (model.isSubmitToMgr()) {</span>
<span class="nc" id="L391">			ssRequest.setRequestStatus(RequestAuditTrail.STATUS_PENDING);</span>
			// Only validate filing rules once the ssr is submitted. - ESR4697404
<span class="nc" id="L393">			ssRequest.setSubmittedOn(new Date());</span>
		}

<span class="nc" id="L396">		ssRequest.setExpirationDate(expirationDate);</span>
<span class="nc" id="L397">		String comment = model.getComment();</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">		if (ssRequest.getWithdrawInfo() != null</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">				&amp;&amp; ssRequest.getWithdrawInfo().getRequestStatus().equals(RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION)) {</span>
<span class="nc" id="L400">			model.setWithdrawConfirmed(true);</span>
<span class="nc" id="L401">			ShiftSwapRequestsMH.confirmWithdrawOfApprovedRequest(ssRequest, comment);</span>
		} else {
<span class="nc" id="L403">			ShiftSwapRequestsMH.updateRequest(ssRequest, comment);</span>
		}

<span class="nc bnc" id="L406" title="All 4 branches missed.">		if (!model.isSubmitToMgr() &amp;&amp; jmsNotify) {</span>
			// Call the Notify Util
<span class="nc" id="L408">			JMSNotifyUtil.notifyOnUserAction(new RequestNotificationDetail(ssRequest, ssRequest.getRequestStatus(), context.getUser()</span>
<span class="nc" id="L409">					.getEmployeeID()));</span>
		}
<span class="nc" id="L411">		return ssRequest;</span>
	}

	// ////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	// ////////////////////////////////////////////////////////////////////////////

	/**
	 * Asserts that the current employee can swap with the other employee in the request.
	 */
	private static void assertCanSwapWithEmployee(RequestContext context, ID employee2ID)
			throws Exception {
<span class="nc" id="L423">		ID employeeID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L424">		Collection&lt;EmployeeName&gt; names = ShiftSwapRequestsMH.getEmpNamesOneCanSwapShiftWith(context, employeeID);</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">		for (EmployeeName name : names) {</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">			if (name.getID().equals(employee2ID)) {</span>
<span class="nc" id="L427">				return;</span>
			}
<span class="nc" id="L429">		}</span>
<span class="nc" id="L430">		throw new BbmException(RmEjbBundleKey.BUNDLE_NAME, RmEjbBundleKey.CANNOT_SWAP_WITH_EMPLOYEE);</span>
	}

	private static void assertMaxNegotiationCountForEdit(RequestContext context, ShiftSwapRequest request,
			EditShiftSwapRequestParameters model)
			throws BbmException, RemoteException, CoreException {
<span class="nc bnc" id="L436" title="All 2 branches missed.">		if (model.isSubmitToMgr()) {</span>
<span class="nc" id="L437">			return;</span>
		}
<span class="nc" id="L439">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L440">		ID employeeID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L441">		ID employeeOrgID = OrganizationModelHandler.getEmployeeOrgID(context, employeeID);</span>
<span class="nc" id="L442">		OrganizationSetting orgSettings = RequestsMH.getOrgSetting(employeeOrgID);</span>

<span class="nc" id="L444">		Pair&lt;Integer, Integer&gt; counts = SwapUtil.getNegotiationCounts(localizer, request);</span>
<span class="nc" id="L445">		int count = counts.getFirst();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">		if (!request.getFirstEmployeeID().equals(employeeID)) {</span>
<span class="nc" id="L447">			count = counts.getSecond();</span>
		}
<span class="nc bnc" id="L449" title="All 2 branches missed.">		if (count &gt;= orgSettings.getShiftSwapMaxNegotiationUpdates()) {</span>
<span class="nc" id="L450">			throw new BbmException(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT_NONEDITABLE_WARNING);</span>
		}
<span class="nc" id="L452">	}</span>

	/**
	 * Create New instance of Shift Swap Request
	 */
	private static ShiftSwapRequest createNewShiftSwapRequest(RequestContext context, String swapType,
			Date expirationDate, ShiftSwapItem ssItem1, ShiftSwapItem ssItem2)
			throws BbmException {

<span class="nc" id="L461">		ShiftSwapRequest ssRequest = new ShiftSwapRequest(ShiftSwapRequest.DL_BASIC);</span>
<span class="nc" id="L462">		ssRequest.setSwapType(swapType);</span>
<span class="nc" id="L463">		ssRequest.setExpirationDate(expirationDate);</span>

<span class="nc" id="L465">		List&lt;ShiftSwapItem&gt; ssItems = new ArrayList&lt;ShiftSwapItem&gt;();</span>
<span class="nc" id="L466">		ssItems.add(ssItem1);</span>
<span class="nc" id="L467">		ssItems.add(ssItem2);</span>
<span class="nc" id="L468">		ssRequest.setShiftSwapItems(ssItems);</span>
<span class="nc" id="L469">		validateDateRange(context, ssRequest);</span>
<span class="nc" id="L470">		return ssRequest;</span>
	}

	private static void validateDateRange(RequestContext context, ShiftSwapRequest request)
			throws BbmException {
<span class="nc" id="L475">		List&lt;ShiftSwapItem&gt; items = request.getShiftSwapItems();</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">		if (items == null) {</span>
<span class="nc" id="L477">			return;</span>
		}
<span class="nc bnc" id="L479" title="All 2 branches missed.">		for (ShiftSwapItem item : items) {</span>
<span class="nc bnc" id="L480" title="All 4 branches missed.">			if (item.getEndDate() != null &amp;&amp; !item.getStartDate().before(item.getEndDate())) {</span>
<span class="nc" id="L481">				Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L482">				TimeZone timeZone = context.getViewingTimeZone();</span>
<span class="nc" id="L483">				String startDate = localizer.formatDateTime(item.getStartDate(), timeZone);</span>
<span class="nc" id="L484">				String endDate = localizer.formatDateTime(item.getStartDate(), timeZone);</span>
<span class="nc" id="L485">				throw new BbmException(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.INVALID_TIME_RANGE,</span>
						new Object[] { startDate, endDate });
			}
<span class="nc" id="L488">		}</span>
<span class="nc" id="L489">	}</span>

	/**
	 * Adjust New Shift Swap Items information:
	 * - Shift Type
	 * - Start Date
	 * - End Date
	 */
	private static boolean adjustNewShiftSwapItems(RequestContext context,
			ShiftSwapRequestParameters model,
			ShiftSwapItem ssItem1, ShiftSwapItem ssItem2, ShiftSwapPosting posting) {
<span class="nc" id="L500">		boolean success = true;</span>

<span class="nc" id="L502">		String shiftType = model.getShiftType();</span>
<span class="nc" id="L503">		boolean isTimeOffShift = SwapUtil.isTimeOffShift(shiftType);</span>
<span class="nc" id="L504">		Date requestDate1 = model.getRequestDate1();</span>
<span class="nc" id="L505">		Date requestDate2 = model.getRequestDate2();</span>

<span class="nc bnc" id="L507" title="All 2 branches missed.">		if (model.isTwoWaySwap()) {</span>
<span class="nc" id="L508">			ssItem1.setShiftType(ShiftSwapItem.SWAPITEMTYPE_SHIFT);</span>
<span class="nc" id="L509">			ssItem2.setShiftType(ShiftSwapItem.SWAPITEMTYPE_SHIFT);</span>

			// Convert Shift Type to Shift by switching Dates
<span class="nc bnc" id="L512" title="All 2 branches missed.">			if (isTimeOffShift) {</span>
<span class="nc" id="L513">				Date tmpDate = requestDate1;</span>
<span class="nc" id="L514">				requestDate1 = requestDate2;</span>
<span class="nc" id="L515">				requestDate2 = tmpDate;</span>
<span class="nc" id="L516">			}</span>
		} else {
<span class="nc bnc" id="L518" title="All 2 branches missed.">			String shiftType2 = isTimeOffShift ? ShiftSwapItem.SWAPITEMTYPE_SHIFT</span>
					: ShiftSwapItem.SWAPITEMTYPE_TIMEOFF;
<span class="nc" id="L520">			ssItem1.setShiftType(shiftType);</span>
<span class="nc" id="L521">			ssItem2.setShiftType(shiftType2);</span>

<span class="nc bnc" id="L523" title="All 2 branches missed.">			if (shiftType.equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT)) {</span>
<span class="nc" id="L524">				requestDate2 = requestDate1;</span>
			} else {
<span class="nc bnc" id="L526" title="All 2 branches missed.">				if (requestDate2 != null) {</span>
<span class="nc" id="L527">					requestDate1 = requestDate2;</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">				} else if (posting != null) {</span>
<span class="nc" id="L529">					requestDate1 = posting.getDisplayStartDate();</span>
				}
			}
		}

<span class="nc" id="L534">		boolean adjustItem2 = true;</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">		if (requestDate2 == null) {</span>
<span class="nc" id="L536">			adjustItem2 = false;</span>
			// probably the pickup is non- changeable
<span class="nc" id="L538">			requestDate2 = requestDate1;</span>

<span class="nc bnc" id="L540" title="All 2 branches missed.">			if (posting != null) {</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">				if (ssItem1.getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF) ||</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">						ssItem2.getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF)) {</span>
<span class="nc" id="L543">					adjustItem2 = true;</span>
				}
				else {
<span class="nc" id="L546">					ssItem2.setStartDate(posting.getDisplayStartDate());</span>
<span class="nc" id="L547">					ssItem2.setEndDate(posting.getEndDate());</span>
				}
			}
		}

<span class="nc" id="L552">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L553">		TimeZone tz = context.getViewingTimeZone();</span>
<span class="nc bnc" id="L554" title="All 4 branches missed.">		success = SwapUtil.adjustShiftSwapItemDates(ssItem1, requestDate1,</span>
				localizer, tz, model) &amp;&amp; success;
<span class="nc bnc" id="L556" title="All 4 branches missed.">		if (adjustItem2 &amp;&amp; success) { // added success to if condition as part of qc58109</span>
<span class="nc bnc" id="L557" title="All 4 branches missed.">			success = SwapUtil.adjustShiftSwapItemDates(ssItem2, requestDate2,</span>
					localizer, tz, model) &amp;&amp; success;
<span class="nc bnc" id="L559" title="All 2 branches missed.">			if (success) {</span>
				// QC55137/QA97872 pickup one way swap on same day as shift date
<span class="nc bnc" id="L561" title="All 2 branches missed.">				if (ssItem2.getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF)) {</span>
<span class="nc" id="L562">					yetAnotherDateAdjustment(ssItem1, ssItem2);</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">				} else if (ssItem1.getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF)) {</span>
<span class="nc" id="L564">					yetAnotherDateAdjustment(ssItem2, ssItem1);</span>
				}
			}
		}
<span class="nc" id="L568">		return success;</span>
	}

	// QC55137/QA97872 pickup one way swap on same day as shift date - need to prevent
	// setting startDate to beginning of the day, which will make the request expired
	// as soon as it is created.
	private static void yetAnotherDateAdjustment(ShiftSwapItem ssItemA, ShiftSwapItem ssItemB) {
<span class="nc bnc" id="L575" title="All 6 branches missed.">		if (ssItemA.getStartDate() != null &amp;&amp; (ssItemB.getStartDate() == null || ssItemB.getStartDate().before(ssItemA.getStartDate()))) {</span>
<span class="nc" id="L576">			ssItemB.setStartDate(new Date(ssItemA.getStartDate().getTime()));</span>
		}
<span class="nc bnc" id="L578" title="All 6 branches missed.">		if (ssItemA.getEndDate() != null &amp;&amp; (ssItemB.getEndDate() == null || ssItemB.getEndDate().after(ssItemA.getEndDate()))) {</span>
<span class="nc" id="L579">			ssItemB.setEndDate(new Date(ssItemA.getEndDate().getTime()));</span>
		}
<span class="nc" id="L581">	}</span>

	/**
	 * Debug method for outputting various model settings created when trying to figure out how to correctly populate the params.
	 */
	private static void debugModel(ShiftSwapRequestFormPopupPM model) { // NOSONAR
<span class="nc" id="L587">		StringBuilder sb = new StringBuilder(&quot;\n\nPM&quot;);</span>
<span class="nc" id="L588">		sb.append(&quot;\nAgentID: &quot;).append(model.getAgentID());</span>
<span class="nc" id="L589">		sb.append(&quot;\nExpirationDate: &quot;).append(model.getExpiration());</span>
<span class="nc" id="L590">		sb.append(&quot;\nIsPickupPartial: &quot;).append(model.getIsPickupPartial());</span>
<span class="nc" id="L591">		sb.append(&quot;\nIsSwapPartial: &quot;).append(model.getIsSwapPartial());</span>
<span class="nc" id="L592">		sb.append(&quot;\nNegotiable: &quot;).append(model.isNegotiable());</span>
<span class="nc" id="L593">		sb.append(&quot;\nNegotiationComment: &quot;).append(model.getNegotiationComment());</span>
<span class="nc" id="L594">		sb.append(&quot;\nPickupEndDate: &quot;).append(model.getPickupDateRangePicker().getEndDatePickerPC().getDate());</span>
<span class="nc" id="L595">		sb.append(&quot;\nPickupStartDate: &quot;).append(model.getPickupDateRangePicker().getStartDatePickerPC().getDate());</span>
<span class="nc" id="L596">		sb.append(&quot;\nPostingID: &quot;).append(model.getPostingID());</span>
<span class="nc" id="L597">		sb.append(&quot;\nRequestDate1: &quot;).append(model.getRequestDate1());</span>
<span class="nc" id="L598">		sb.append(&quot;\nRequestDate2: &quot;).append(model.getRequestDate2());</span>
<span class="nc" id="L599">		sb.append(&quot;\nShiftType: &quot;).append(model.getShiftType());</span>
<span class="nc" id="L600">		sb.append(&quot;\nSubmitToMgr: &quot;).append(model.isSubmitToMgr());</span>
<span class="nc" id="L601">		sb.append(&quot;\nSwapEndDate: &quot;).append(model.getSwapDateRangePicker().getEndDatePickerPC().getDate());</span>
<span class="nc" id="L602">		sb.append(&quot;\nSwapStartDate: &quot;).append(model.getSwapDateRangePicker().getStartDatePickerPC().getDate());</span>
<span class="nc" id="L603">		sb.append(&quot;\nSwapType: &quot;).append(model.getSwapType());</span>
<span class="nc" id="L604">		System.out.println(sb.toString());</span>
<span class="nc" id="L605">	}</span>

	/**
	 * Debug method for outputting various model settings created when trying to figure out how to correctly populate the params.
	 */
	private static void debugModel(ShiftSwapRequestParameters model) { // NOSONAR
<span class="nc" id="L611">		StringBuilder sb = new StringBuilder(&quot;\n\nParams&quot;);</span>
<span class="nc" id="L612">		sb.append(&quot;\nAgentID: &quot;).append(model.getAgentID());</span>
<span class="nc" id="L613">		sb.append(&quot;\nExpirationDate: &quot;).append(model.getExpirationDate());</span>
<span class="nc" id="L614">		sb.append(&quot;\nIsPickupPartial: &quot;).append(model.getIsPickupPartial());</span>
<span class="nc" id="L615">		sb.append(&quot;\nIsSwapPartial: &quot;).append(model.getIsSwapPartial());</span>
<span class="nc" id="L616">		sb.append(&quot;\nNegotiable: &quot;).append(model.isNegotiable());</span>
<span class="nc" id="L617">		sb.append(&quot;\nNegotiationComment: &quot;).append(model.getNegotiationComment());</span>
<span class="nc" id="L618">		sb.append(&quot;\nPickupEndDate: &quot;).append(model.getPickupEndDate());</span>
<span class="nc" id="L619">		sb.append(&quot;\nPickupStartDate: &quot;).append(model.getPickupStartDate());</span>
<span class="nc" id="L620">		sb.append(&quot;\nPostingID: &quot;).append(model.getPostingID());</span>
<span class="nc" id="L621">		sb.append(&quot;\nRequestDate1: &quot;).append(model.getRequestDate1());</span>
<span class="nc" id="L622">		sb.append(&quot;\nRequestDate2: &quot;).append(model.getRequestDate2());</span>
<span class="nc" id="L623">		sb.append(&quot;\nShiftType: &quot;).append(model.getShiftType());</span>
<span class="nc" id="L624">		sb.append(&quot;\nSubmitToMgr: &quot;).append(model.isSubmitToMgr());</span>
<span class="nc" id="L625">		sb.append(&quot;\nSwapEndDate: &quot;).append(model.getSwapEndDate());</span>
<span class="nc" id="L626">		sb.append(&quot;\nSwapStartDate: &quot;).append(model.getSwapStartDate());</span>
<span class="nc" id="L627">		sb.append(&quot;\nSwapType: &quot;).append(model.getSwapType());</span>
<span class="nc" id="L628">		System.out.println(sb.toString());</span>
<span class="nc" id="L629">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>