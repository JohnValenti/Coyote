<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffCalendarPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.timeoff</a> &gt; <span class="el_source">TimeOffCalendarPC.java</span></div><h1>TimeOffCalendarPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.timeoff;

import java.text.DecimalFormat;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.bbm.workresource.OrganizationScopeManagerProxy;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOCalendarDayData;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOIntervalCalendar;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.DateUtil;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.keys.RmJavaScriptFileID;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.calendar.CalendarPC;
import com.witness.web.uif.pagecomponent.calendar.GenericCalendarDayRenderer;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.TimeZoneHelper;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlLinkUtil;

/**
 * Title:        TimeOffCalendarPC
 * Description:  Display Time Off Calendars
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       dsu (David Su)
 * @version 1.0
 *
 * Created on September 03, 2002, 4:00 PM
 */
public class TimeOffCalendarPC extends CollapsibleContainerPC {
	private static final String TIMEOFF_CAL_CACHE_KEY = &quot;TIMEOFF_CAL_CACHE_KEY&quot;;
	private static final String MGR_HOUR_PENDING_VIEW_REQUEST = RmKeys.RH_AG_REQUEST_TIMEOFF_LIST;
	private static final String VIEW_AGENTS_NAMES = &quot;POPUP_AGENTS_NAMES&quot;;
	public static final int DAILY_ALLOCATION = 0;
	public static final int INTERVAL_ALLOCATION = 1;
<span class="nc" id="L58">	public static final String DAILY_ALLOCATION_DROPDOWN_VALUE = Integer.toString(DAILY_ALLOCATION);</span>
<span class="nc" id="L59">	public static final String INTERVAL_ALLOCATION_DROPDOWN_VALUE = Integer.toString(INTERVAL_ALLOCATION);</span>

<span class="nc" id="L61">	private static int MAX_CELL_FOR_COLUMN = 6;</span>

	private final ResourceBundle m_bundle;
	private String m_sOrgID;
	private int m_numOfCals;
<span class="nc" id="L66">	private int m_dayCounter = 0;</span>
<span class="nc" id="L67">	private int m_firstDayOfWeek = Calendar.SUNDAY;</span>
<span class="nc" id="L68">	private boolean m_isDataForManager = false;</span>
<span class="nc" id="L69">	private boolean m_isLinkToRequestEnabled = false;</span>
<span class="nc" id="L70">	private boolean m_isLinkToSchedTOEnabled = false;</span>
<span class="nc" id="L71">	private boolean m_isDetailEnabled = false;</span>
<span class="nc" id="L72">	private boolean m_isLegendVisible = true;</span>
<span class="nc" id="L73">	private boolean m_isLegenBtnEnabled = false;</span>
<span class="nc" id="L74">	private boolean m_isEncapsulated = true;</span>
<span class="nc" id="L75">	private boolean m_showAvailableHours = false;</span>

	private Calendar m_navCalendar;
<span class="nc" id="L78">	private List m_calDataList = Collections.emptyList();</span>
<span class="nc" id="L79">	private TimeZone m_tz = null;</span>
	private OrganizationSetting m_orgSetting;
	private final DecimalFormat m_decimalFormat;

	private final CalendarPC m_calPC;
	private final TimeOffIntervalCalendarPC intervalCalendarPC;

	private final TimeOffCalendarLegendPC m_legendPC;
	private final ToolbarPC m_toolbar;

	//private String m_viewMode;

	//private String m_orgViewMode;

	//private String m_parentOrgID;

<span class="nc" id="L95">	private ID m_poolID = null;</span>

	//private boolean m_isAllocShared = false;

<span class="nc" id="L99">	private boolean m_isAgentCal = false; //is the agent viewing his Time Off Calendar? (true=yes, agent. false=no, manager).</span>
<span class="nc" id="L100">	private boolean m_isAgentTOPoolView = false; //is the agent viewing his TO Pool? (true=yes, his pool. false=no, viewing only his personal data)</span>
<span class="nc" id="L101">	private String timeOffAllocationType = &quot;0&quot;;</span>
	private TOIntervalCalendar timeOffIntervalCalendar;

	/**
	 * Constructor
	 *
	 * @param context The RequestContext
	 */
	public TimeOffCalendarPC(RequestContext context, ToolbarPC toolbar) {
<span class="nc" id="L110">		this(context, 1, false, toolbar);</span>
<span class="nc" id="L111">	}</span>

	/**
	 * Constructor
	 *
	 * @param context The RequestContext
	 * @param numOfCals The number of Calendar to display
	 * @param isEncapsulated Specify whether component is encapsulated
	 */
	public TimeOffCalendarPC(RequestContext context, int numOfCals, boolean isEncapsulated, ToolbarPC toolbar) {
<span class="nc" id="L121">		super(context);</span>
<span class="nc" id="L122">		m_toolbar = toolbar;</span>

<span class="nc" id="L124">		m_decimalFormat = (DecimalFormat) DecimalFormat.getInstance(m_locale);</span>
<span class="nc" id="L125">		m_decimalFormat.setMaximumFractionDigits(2);</span>

<span class="nc" id="L127">		m_numOfCals = numOfCals;</span>
<span class="nc" id="L128">		m_tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L129">		m_bundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L131">		setName(&quot;timeOffCalendarPC&quot;);</span>
<span class="nc" id="L132">		setJSMediator(RmJavaScriptFileID.TIMEOFF_CAL_CONTAINER);</span>

<span class="nc" id="L134">		m_calPC = new CalendarPC(m_context, &quot;timeOffCal&quot;, CalendarPC.CALENDAR_TYPE_GENERIC);</span>
<span class="nc" id="L135">		m_calPC.setIsSubmitOnNavChange(true);</span>
<span class="nc" id="L136">		m_calPC.setIsIgnoreChangeConfirmation(true);</span>
<span class="nc" id="L137">		m_calPC.getCalendarHeader().setEnabled(false);</span>
<span class="nc" id="L138">		m_calPC.getCalendarDayRenderer().setEnableDayLink(true); //508: We need day links so that tooltips can be assigned</span>
<span class="nc" id="L139">		m_calPC.setDisplayOnlyRequiredWeeks(false);</span>
<span class="nc" id="L140">		addChildComponent(m_calPC);</span>
<span class="nc" id="L141">		m_legendPC = new TimeOffCalendarLegendPC(m_context, m_toolbar);</span>
<span class="nc" id="L142">		addChildComponent(m_legendPC);</span>

<span class="nc" id="L144">		intervalCalendarPC = new TimeOffIntervalCalendarPC(m_context);</span>
<span class="nc" id="L145">		addChildComponent(intervalCalendarPC);</span>

<span class="nc" id="L147">		m_navCalendar = newCalendar();</span>
<span class="nc" id="L148">		setIsEncapsulated(isEncapsulated);</span>
<span class="nc" id="L149">	}</span>

	private Calendar newCalendar() {
<span class="nc" id="L152">		Calendar cal = (Calendar) m_context.getAttribute(RequestContext.SESSION_SCOPE, TIMEOFF_CAL_CACHE_KEY);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">		if (cal == null) {</span>
<span class="nc" id="L154">			return newCalendar(m_tz, m_locale);</span>
		} else {
<span class="nc" id="L156">			cal = (Calendar) cal.clone();</span>
		}
<span class="nc" id="L158">		return cal;</span>
	}

	/**
	 * Gets a new Calendar for the first of the month in the specified time zone and locale.
	 */
	public static Calendar newCalendar(TimeZone timeZone, Locale locale) {
<span class="nc" id="L165">		Calendar cal = Calendar.getInstance(timeZone, locale);</span>
<span class="nc" id="L166">		adjustCalToFirstDayOfMonth(cal, cal);</span>
<span class="nc" id="L167">		return cal;</span>
	}

	private Calendar newCalFromNavCal() {
<span class="nc" id="L171">		Calendar cal = Calendar.getInstance(m_tz, m_locale);</span>
<span class="nc" id="L172">		adjustCalToFirstDayOfMonth(m_navCalendar, cal);</span>
<span class="nc" id="L173">		return cal;</span>
	}

	private static void adjustCalToFirstDayOfMonth(Calendar sourceCal, Calendar targetCal) {
<span class="nc" id="L177">		int year = sourceCal.get(Calendar.YEAR);</span>
<span class="nc" id="L178">		int month = sourceCal.get(Calendar.MONTH);</span>
<span class="nc" id="L179">		targetCal.set(year, month, 1, 0, 0, 0);</span>
<span class="nc" id="L180">		targetCal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L181">	}</span>

	/**
	 * Initialize For Display
	 */
	@Override
	public void initForDisplay() {
<span class="nc bnc" id="L188" title="All 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L189">			return;</span>
		} else {
<span class="nc" id="L191">			super.initForDisplay();</span>

			// Popup Scheduled TimeOff Agents Window
<span class="nc" id="L194">			addPopupArgs(VIEW_AGENTS_NAMES, RmKeys.RH_TIMEOFF_AGENTS_INFO, null, &quot;orgID,poolID,date,hourType,parentView,agentCal&quot;, &quot;400,300,ctr,ctr&quot;, true, 1);</span>

<span class="nc" id="L196">			initHeader();</span>
		}
<span class="nc" id="L198">	}</span>

	/**
	 * Specify whether it is encapsulated
	 */
	public void setIsEncapsulated(boolean bSwitch) {
<span class="nc" id="L204">		m_isEncapsulated = bSwitch;</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">		if (m_isEncapsulated) {</span>
<span class="nc" id="L207">			setStyleClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="nc" id="L208">			setToggleable(true);</span>
<span class="nc" id="L209">			setIsLegendVisible(false);</span>
		} else {
<span class="nc" id="L211">			setStyleClass(null);</span>
<span class="nc" id="L212">			setToggleable(false);</span>
<span class="nc" id="L213">			setIsLegendVisible(true);</span>
		}
<span class="nc" id="L215">	}</span>

	/**
	 * Return true if it is encapsulated
	 */
	public boolean isEncapsulated() {
<span class="nc" id="L221">		return m_isEncapsulated;</span>
	}

	/**
	 * Return true if we are showing Available hours (rather than allocated hours).
	 */
	public boolean isShowAvailableHours() {
<span class="nc" id="L228">		return m_showAvailableHours;</span>
	}

	/**
	 * Set whether we are showing Available hours (rather than allocated hours).
	 */
	public void setShowAvailableHours(boolean showAvailableHours) {
<span class="nc" id="L235">		m_showAvailableHours = showAvailableHours;</span>
<span class="nc" id="L236">	}</span>

	/**
	 * Fetch Data to render Calendar Content for the &quot;My Time Off Calendar&quot; page. Any other pages as well??
	 * @param empID - the ID of the logged-in user
	 * @param isTOPoolView - true means we will view time off for the agent's pool. False means for the agent only (&quot;Personal&quot;).
	 * @param pTOPoolID - the ID of the Time Off Pool for the agent (only for when isTOPoolView == true).
	 */
	public void fetchData(ID empID, boolean isTOPoolView, ID pTOPoolID, int allocationType) throws Exception {
<span class="nc" id="L245">		m_sOrgID = OrganizationModelHandler.getEmployeeOrgID(m_context, empID).toString();</span>
<span class="nc" id="L246">		m_isAgentTOPoolView = isTOPoolView;</span>
<span class="nc" id="L247">		m_poolID = pTOPoolID;</span>

<span class="nc bnc" id="L249" title="All 4 branches missed.">		m_isLinkToRequestEnabled = isTOPoolView &amp;&amp; m_context.getUser().isAuthorized(PrivilegeKeys.TOM_VIEWCALENDARLINKS_ID);</span>
<span class="nc" id="L250">		m_isLinkToSchedTOEnabled = m_isLinkToRequestEnabled;</span>

<span class="nc" id="L252">		fetchData(empID, new ID(m_sOrgID), m_poolID, false, isTOPoolView, allocationType);</span>
<span class="nc" id="L253">	}</span>

	public void fetchData(ID empID, boolean isTOPoolView, ID pTOPoolID) throws Exception {
<span class="nc" id="L256">		fetchData(empID, isTOPoolView, pTOPoolID, 0);</span>
<span class="nc" id="L257">	}</span>

	/**
	 * Fetch Data to render Calendar Content for the manager's &quot;Requests \ Time Off Calendar&quot; page
	 * @param empID - the ID of the logged-in user
	 * @param orgID - the ID of the organization selected in the selection pane
	 * @param pTOPoolID - the ID of the Time Off Pool which was selected from the pool list A value
	 *                    of null indicates that the user wishes to see all time off for the org.
	 */
	public void fetchDataForManager(ID empID, ID orgID, ID pTOPoolID, int allocationType) throws Exception {
<span class="nc" id="L267">		m_isLinkToRequestEnabled = m_context.getUser().isAuthorized(PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE_ID, OrganizationScopeManagerProxy.getScopeID(orgID));</span>
<span class="nc" id="L268">		m_isLinkToSchedTOEnabled = true;</span>
<span class="nc" id="L269">		m_sOrgID = orgID.toString();</span>
<span class="nc" id="L270">		m_poolID = pTOPoolID;</span>
<span class="nc" id="L271">		fetchData(empID, orgID, pTOPoolID, true, false, allocationType);</span>
<span class="nc" id="L272">	}</span>

	public void fetchDataForManager(ID empID, ID orgID, ID pTOPoolID) throws Exception {
<span class="nc" id="L275">		fetchDataForManager(empID, orgID, pTOPoolID, 0);</span>
<span class="nc" id="L276">	}</span>

	/**
	 * Actual Implementation of fetch Data
	 * @param empID - the ID of the logged-in user
	 * @param orgID - the ID of the organization.
	 * @param pTOPoolID - the ID of the Time Off Pool which was selected from the pool list for the manager's
	 *                    page. A value of null indicates that the user wishes to see all time off for the org.
	 * @param isDataForManager - is this time off calendar for the manager's page? true=yes, false=no (agent's page).
	 * @param isTOPoolView - When viewing the agent's page, this tells us whether to view time off for his pool (true), or only himself (false).
	 * @param allocationType - 0: daily Allocation, 1: intervalAllocation
	 */
	@SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
	private void fetchData(ID empID, ID orgID, ID pTOPoolID, boolean isDataForManager, boolean isTOPoolView, int allocationType) throws Exception {
<span class="nc" id="L290">		m_isDataForManager = isDataForManager;</span>

		// Retrieve Organization to use its time zone, etc
<span class="nc" id="L293">		Organization org = OrganizationModelHandler.getOrganization(m_context, orgID);</span>
<span class="nc" id="L294">		m_tz = org.getTimeZone();</span>
<span class="nc" id="L295">		m_firstDayOfWeek = org.getWeekStartDate();</span>

<span class="nc bnc" id="L297" title="All 2 branches missed.">		intervalCalendarPC.setMode(!m_isDataForManager, isTOPoolView);</span>
<span class="nc" id="L298">		intervalCalendarPC.setSelectedOrganization(orgID);</span>
<span class="nc" id="L299">		intervalCalendarPC.setSelectedPool(pTOPoolID);</span>

		// Calculate Start and End Date
<span class="nc" id="L302">		Calendar startCal = newCalFromNavCal();</span>
<span class="nc" id="L303">		Calendar endCal = newCalFromNavCal();</span>
		
<span class="nc" id="L305">		int dayBoundaryOffset = org.getDayBoundaryOffset();</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">		if (dayBoundaryOffset &gt; 0) {</span>
			// QC 41795 / QA 95083 DST issue: standardize setting of dayBoundaryOffset
<span class="nc" id="L308">			TOCalcUtil.setCalMinsOffsetFromMidnight(startCal, dayBoundaryOffset);</span>
<span class="nc" id="L309">			TOCalcUtil.setCalMinsOffsetFromMidnight(endCal, dayBoundaryOffset);</span>
		}
		// FOR INTERVAL_ALLOCATION
<span class="nc bnc" id="L312" title="All 2 branches missed.">		if(allocationType == INTERVAL_ALLOCATION) {</span>
<span class="nc" id="L313">			endCal.add(Calendar.MONTH, 1);</span>
<span class="nc" id="L314">			adjustCalendarsForTOIC(startCal, endCal);</span>
<span class="nc" id="L315">			Date startDate = startCal.getTime();</span>
<span class="nc" id="L316">			Date endDate = endCal.getTime();</span>
				// Fetch Time Off Data
<span class="nc bnc" id="L318" title="All 2 branches missed.">				if (isDataForManager) {</span>
					// manager needs poolID since the whole calendar data is from the selected pool's perspective.
<span class="nc" id="L320">					this.timeOffIntervalCalendar = TimeOffRequestsMH.getTOIntervalCalendarForManager(orgID, pTOPoolID, startDate, endDate);</span>
<span class="nc" id="L321">					splitTimeOffIntervalCalendarForUser(startCal, endCal);</span>
				} else {
					// cannot pass poolID for agent since his pool can change throughout the calendar date range.
<span class="nc" id="L324">					this.timeOffIntervalCalendar = TimeOffRequestsMH.getTOIntervalCalendarForEmp(empID, startDate, endDate, m_tz, isTOPoolView);</span>
<span class="nc" id="L325">					splitTimeOffIntervalCalendarForUser(startCal, endCal);</span>
				}
<span class="nc" id="L327">		} else { </span>
		//FOR DAILY_ALLOCATION
<span class="nc" id="L329">			endCal.add(Calendar.MONTH, m_numOfCals);</span>
<span class="nc" id="L330">			Date startDateRange = startCal.getTime();</span>
<span class="nc" id="L331">			Date endDateRange = endCal.getTime();</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">			if (isDataForManager) {</span>
				// manager needs poolID since the whole calendar data is from the selected pool's perspective.
<span class="nc" id="L334">				m_calDataList = TimeOffRequestsMH.getTOCalendarDataForManager(empID, orgID, pTOPoolID, startDateRange, endDateRange); </span>
			} else {
				// cannot pass poolID for agent since his pool can change throughout the calendar date range.
<span class="nc" id="L337">				m_calDataList = TimeOffRequestsMH.getTOCalendarDataForEmployee(empID, startDateRange, endDateRange, isTOPoolView,org);</span>
			} 
				
		}
		
<span class="nc" id="L342">	}</span>
	
	/**
	 * Determine whether to display Legend Button
	 */
	private void initHeader() {
<span class="nc bnc" id="L348" title="All 2 branches missed.">		if (m_isEncapsulated) {</span>
<span class="nc" id="L349">			String calNavControl = getNavigationControl();</span>

<span class="nc bnc" id="L351" title="All 2 branches missed.">			if (m_isLegenBtnEnabled) {</span>
<span class="nc" id="L352">				String legendButton = m_legendPC.getLegendButton().toString();</span>
<span class="nc" id="L353">				StringBuffer sb = new StringBuffer(512);</span>
<span class="nc" id="L354">				sb.append(&quot;\n&lt;table&gt;&lt;tr&gt;&lt;td&gt;&quot;).append(calNavControl).append(&quot;&lt;/td&gt;&lt;td&gt;&quot;).append(legendButton).append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;);</span>
<span class="nc" id="L355">				addHeaderControl(sb.toString());</span>
<span class="nc" id="L356">			} else {</span>
<span class="nc" id="L357">				addHeaderControl(calNavControl);</span>
			}
		}
<span class="nc" id="L360">	}</span>

	/**
	 * Set number of Calendars to display
	 */
	public void setNumOfCals(int numOfCals) {
<span class="nc" id="L366">		m_numOfCals = numOfCals;</span>
<span class="nc" id="L367">	}</span>

	/**
	 * Return the number of Calendars to display
	 */
	public int getNumOfCals() {
<span class="nc" id="L373">		return m_numOfCals;</span>
	}

	/**
	 * Set view mode
	 *
	public void setViewMode(String viewMode) {
		m_viewMode = viewMode;
	}

	/**
	 * Return the view mode
	 *
	public String getViewMode() {
		return m_viewMode;
	}
	*/

	/**
	 * Set org view mode
	 *
	public void setOrgViewMode(String orgViewMode) {
		m_orgViewMode = orgViewMode;
	}
	*/

	/**
	 * Return the org view mode
	 *
	public String getOrgViewMode() {
		return m_orgViewMode;
	}
	*/

	/**
	 * Set is allocations shared
	 *
	public void setIsAllocShared(boolean isAllocShared) {
		m_isAllocShared = isAllocShared;
	}
	*/

	/**
	 * Return allocations shared flag
	 *
	public boolean getIsAllocShared() {
		return m_isAllocShared;
	}
	*/

	/**
	 * Set is agents calendar
	 * this is needed to decide the org list that should be used when drilling into the pending requests list
	 */
	public void setIsAgentCal(boolean isAgentCal) {
<span class="nc" id="L428">		m_isAgentCal = isAgentCal;</span>
<span class="nc" id="L429">	}</span>

	/**
	 * Return is agents calendar
	 */
	public boolean getIsAgentCal() {
<span class="nc" id="L435">		return m_isAgentCal;</span>
	}

	/**
	 * Set Organization Setting
	 */
	public void setOrgSetting(OrganizationSetting orgSetting) {
<span class="nc" id="L442">		m_orgSetting = orgSetting;</span>
<span class="nc" id="L443">	}</span>

	/**
	 * Return Organization Setting
	 */
	public OrganizationSetting getOrgSetting() {
<span class="nc" id="L449">		return m_orgSetting;</span>
	}

	/**
	 * Append Localize Image for Day Data if detail information is requested
	 */
	private void appendDayDataImgCell(StringBuilder sb, int rowSpan) {
<span class="nc" id="L456">		String img = i18n(m_bundle, RmWebBundleKey.TIMEOFF_DAY_DATA_IMG);</span>
<span class="nc" id="L457">		String alt = i18n(m_bundle, RmWebBundleKey.TIMEOFF_DAY_DATA_IMG_DESC);</span>

<span class="nc bnc" id="L459" title="All 2 branches missed.">		if (m_showAvailableHours) {</span>
<span class="nc" id="L460">			img = i18n(m_bundle, RmWebBundleKey.TIMEOFF_DAY_DATA2_IMG);</span>
<span class="nc" id="L461">			alt = i18n(m_bundle, RmWebBundleKey.TIMEOFF_DAY_DATA2_IMG_DESC);</span>
		}
<span class="nc" id="L463">		img = m_context.getStaticFileUrl(img);</span>
<span class="nc" id="L464">		img = HtmlUtil.imageTag(img, alt); //508</span>

<span class="nc" id="L466">		sb.append(&quot;&lt;td rowspan=\&quot;&quot;).append(rowSpan).append(&quot;\&quot; style=\&quot;padding-right:10px;\&quot;&gt;&quot;).append(img).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L467">	}</span>

	/**
	 * Append the HTML for all Calendars to the string buffer.
	 */
	private void appendCalendars(StringBuilder sb) {
<span class="nc" id="L473">		Calendar cal = newCalFromNavCal();</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">		boolean isSmallCal = !m_isDetailEnabled;</span>
<span class="nc" id="L475">		m_calPC.setIsSmallType(isSmallCal);</span>
<span class="nc" id="L476">		m_calPC.setFirstDayOfWeek(m_firstDayOfWeek);</span>

<span class="nc bnc" id="L478" title="All 2 branches missed.">		String cssClass = m_calPC.isSmallType() ? &quot;calDayLblNormalSmall&quot; : &quot;calDayLblNormal&quot;;</span>
<span class="nc" id="L479">		m_calPC.setDayLabelCSS(cssClass);</span>
		; //508

<span class="nc" id="L482">		int numOfRows = getNumOfRows();</span>
<span class="nc" id="L483">		int numOfCells = getNumOfCellsForRow();</span>

<span class="nc" id="L485">		sb.append(&quot;\n&lt;center&gt;\n&lt;table align=\&quot;center\&quot; id=\&quot;dailyCalendarGrid\&quot;&gt;\n&quot;);</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">		for (int i = 0; i &lt; numOfRows; i++) {</span>
<span class="nc" id="L487">			sb.append(&quot;&lt;tr&gt;&quot;);</span>

			// Add Day Data Image if necessary
<span class="nc bnc" id="L490" title="All 4 branches missed.">			if (i == 0 &amp;&amp; m_isDetailEnabled) {</span>
<span class="nc" id="L491">				appendDayDataImgCell(sb, numOfRows);</span>
			}

<span class="nc bnc" id="L494" title="All 2 branches missed.">			for (int j = 0; j &lt; numOfCells; j++) {</span>
<span class="nc" id="L495">				int index = i * numOfCells + j;</span>
<span class="nc" id="L496">				String calDisplay = getCalendarDisplay(m_calPC, cal, index);</span>
<span class="nc" id="L497">				sb.append(&quot;&lt;td&gt;&quot;).append(calDisplay).append(&quot;&lt;/td&gt;&quot;);</span>

				// Increament Calendar for Next Month
<span class="nc" id="L500">				cal.add(Calendar.MONTH, 1);</span>
			}
<span class="nc" id="L502">			sb.append(&quot;&lt;/tr&gt;&quot;);</span>
		}
<span class="nc" id="L504">		sb.append(&quot;\n&lt;/table&gt;\n&lt;/center&gt;\n&quot;);</span>
<span class="nc" id="L505">	}</span>

	/**
	 * Append the Calendars' legend to the string buffer.
	 */
	private void appendLegend(StringBuilder sb) {
<span class="nc bnc" id="L511" title="All 2 branches missed.">		if (m_orgSetting == null) {</span>
<span class="nc" id="L512">			return;</span>
		}

<span class="nc bnc" id="L515" title="All 2 branches missed.">		m_legendPC.setIsForEmployee(!m_isDataForManager);</span>
<span class="nc" id="L516">		m_legendPC.setOrgSetting(m_orgSetting);</span>
<span class="nc" id="L517">		m_legendPC.setIsUsedAsNormalPC(m_isLegendVisible);</span>

<span class="nc bnc" id="L519" title="All 2 branches missed.">		m_legendPC.setIsFooterEnabled(!m_isLegendVisible);</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">		m_legendPC.setIsHtmlAutoAdded(!m_isLegendVisible);</span>

<span class="nc bnc" id="L522" title="All 2 branches missed.">		if (m_isLegendVisible) {</span>
<span class="nc" id="L523">			sb.append(&quot;\n&lt;br&gt;&lt;center&gt;&quot;).append(m_legendPC).append(&quot;&lt;/center&gt;&lt;br&gt;\n&quot;);</span>
		}
<span class="nc" id="L525">	}</span>

	/**
	 * Return number of Cells per Row
	 */
	private int getNumOfCellsForRow() {
<span class="nc bnc" id="L531" title="All 2 branches missed.">		if (m_numOfCals &gt; MAX_CELL_FOR_COLUMN) {</span>
<span class="nc" id="L532">			return MAX_CELL_FOR_COLUMN;</span>
		} else {
<span class="nc" id="L534">			return m_numOfCals;</span>
		}
	}

	/**
	 * Determine the number of Rows required to display all Calendars
	 */
	private int getNumOfRows() {
<span class="nc bnc" id="L542" title="All 2 branches missed.">		if (m_numOfCals &lt; MAX_CELL_FOR_COLUMN) {</span>
<span class="nc" id="L543">			return 1;</span>
		}

<span class="nc" id="L546">		int numOfRow = (m_numOfCals / MAX_CELL_FOR_COLUMN);</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">		if (m_numOfCals % MAX_CELL_FOR_COLUMN != 0) {</span>
<span class="nc" id="L548">			numOfRow++;</span>
		}

<span class="nc" id="L551">		return numOfRow;</span>
	}

	/**
	 * Return Calendar Data and increment data counter
	 */
	private List getCalendarData(int dataSize) {
<span class="nc bnc" id="L558" title="All 2 branches missed.">		if (m_calDataList.isEmpty()) {</span>
<span class="nc" id="L559">			return Collections.EMPTY_LIST;</span>
		}

<span class="nc" id="L562">		int start = m_dayCounter;</span>
<span class="nc" id="L563">		int end = m_dayCounter + dataSize;</span>
<span class="nc" id="L564">		m_dayCounter = end;</span>

<span class="nc bnc" id="L566" title="All 2 branches missed.">		if (end &gt; m_calDataList.size()) {</span>
<span class="nc" id="L567">			return Collections.EMPTY_LIST;</span>
		}

<span class="nc" id="L570">		return m_calDataList.subList(start, end);</span>
	}

	/**
	 * Get Time to be passed around in HTML
	 *
	private long getTime(Calendar cal, int date) {
		cal.set(Calendar.DAY_OF_MONTH, date+1);
		return cal.getTime().getTime();
	}
	*/

	/**
	 * Return the &quot;Pending Time Off Requests&quot; link for Manager or agent, which takes the user to a reduced-functionality Employee Requests page, pre-filtered by Pending Time Off Requests.
	 * @param hPending - the pending hours to show for this day.
	 * @param date - the day to be shown in the the calendar.
	 * @param poolID - The time off pool ID for this day. Needed for agent's time off pool view, since he could change pools throughout the month.
	 * @param orgID  - The organization ID for this day. Needed for agent's time off pool view, since he could change orgs throughout the month.
	 * @return
	 */
	private String getHourPendingDisplayForMgr(String hPending, Date date, ID poolID, ID orgID) {

<span class="nc bnc" id="L592" title="All 2 branches missed.">		poolID = m_isAgentTOPoolView ? poolID : m_poolID;</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">		String sOrgID = m_isAgentTOPoolView ? orgID.toString() : m_sOrgID;</span>

		//set the flag for viewing message about access rights
		//set whether we are viewing the org's time off (true), or the pool's time off (false)
<span class="nc bnc" id="L597" title="All 4 branches missed.">		boolean isParentView = (!m_isAgentCal &amp;&amp; m_poolID == null);</span>

<span class="nc bnc" id="L599" title="All 4 branches missed.">		String requestURL = (m_isAgentCal ? RmKeys.RH_AG_VIEW_TIMEOFF_LIST : MGR_HOUR_PENDING_VIEW_REQUEST) + &quot;?pageAction=&quot; + RmPageAction.AGENTS_TIMEOFF_PENDING_ACTION + (poolID != null ? &quot;&amp;TOPOOLID=&quot; + poolID : &quot;&amp;orgID=&quot; + sOrgID)</span>
		//+ &quot;&amp;viewMode=&quot;+m_viewMode
<span class="nc" id="L601">				+ &quot;&amp;date=&quot; + date.getTime() + &quot;&amp;isParentView=&quot; + String.valueOf(isParentView) + &quot;&amp;isAgentCal=&quot; + String.valueOf(m_isAgentCal) + &quot;&amp;isPendingTOView=true&quot;;</span>

<span class="nc" id="L603">		return HtmlLinkUtil.createURLLink(hPending, requestURL, HtmlLinkUtil.PAGE_LINK, true);</span>
	}

	/**
	 * Return the &quot;Scheduled Time Off Agent Names&quot; link, which pops-up a dialog that lists all agents who have a scheduled time off on that day.
	 * @param poolID - The time off pool ID for this day. Needed for agent's time off pool view, since he could change pools throughout the month.
	 * @param orgID  - The organization ID for this day. Needed for agent's time off pool view, since he could change orgs throughout the month.
	 */
	private String createAgentsNameLink(String display, Calendar cal, Date date, String hourType, ID poolID, ID orgID) {

<span class="nc bnc" id="L613" title="All 2 branches missed.">		poolID = m_isAgentTOPoolView ? poolID : m_poolID;</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">		String sOrgID = m_isAgentTOPoolView ? orgID.toString() : m_sOrgID;</span>

		//set the flag for viewing message about access rights
		//set whether we are viewing the org's time off (true), or the pool's time off (false)
<span class="nc bnc" id="L618" title="All 4 branches missed.">		boolean isParentView = (!m_isAgentCal &amp;&amp; m_poolID == null);</span>

		//&quot;orgID,poolID,date,hourType,parentView,agentCal&quot;
<span class="nc bnc" id="L621" title="All 4 branches missed.">		String popupJS = getName() + &quot;.handleAgentsPopup(&quot; + ((sOrgID == null) ? (&quot;null&quot;) : (&quot;'&quot; + sOrgID.toString() + &quot;'&quot;)) + &quot;, &quot; + ((poolID == null) ? (&quot;null&quot;) : (&quot;'&quot; + poolID.toString() + &quot;'&quot;)) + &quot;, &quot; + date.getTime() + &quot;, '&quot; + hourType + &quot;' ,'&quot; + String.valueOf(isParentView) + &quot;', '&quot; + String.valueOf(m_isAgentCal) + &quot;');&quot;;</span>
<span class="nc" id="L622">		return HtmlLinkUtil.createActiveLink(display, null, null, popupJS);</span>
	}

	/**
	 * Return Time Off Hours Text for a particular day's data.
	 */
	private String getTimeOffHoursText(TOCalendarDayData dayData, Calendar cal, int date) {
<span class="nc" id="L629">		float hourAlloc = dayData.getHourAvail(); //The backend uses the word &quot;available&quot; to mean &quot;allocated&quot;</span>
<span class="nc" id="L630">		float hourPending = dayData.getHourPending();</span>
<span class="nc" id="L631">		float hourScTO = dayData.getScheduledTO();</span>
<span class="nc" id="L632">		float hourAvail = dayData.getHourRemaining(); //The backend uses the word &quot;remaining&quot; to mean &quot;available&quot;</span>

<span class="nc" id="L634">		StringBuffer sb = new StringBuffer(100);</span>

		//set whether we are viewing the org's time off (true), or the pool's time off (false)
<span class="nc bnc" id="L637" title="All 4 branches missed.">		boolean isParentView = (!m_isAgentCal &amp;&amp; m_poolID == null);</span>

		// Available/Allocated Hours Info
<span class="nc" id="L640">		String hFirstVal = i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_NOT_APPLICABLE); //&quot;n/a&quot;;</span>

<span class="nc bnc" id="L642" title="All 4 branches missed.">		if (!isParentView &amp;&amp; dayData.getTOPoolID() != null) //(!m_isAllocShared || m_orgViewMode.equals(AgentsTimeOffCalendarPM.PARENT_ORG_VIEW)))</span>
		{
<span class="nc" id="L644">			hFirstVal = m_decimalFormat.format(hourAlloc);</span>

<span class="nc bnc" id="L646" title="All 2 branches missed.">			if (m_showAvailableHours) {</span>
<span class="nc" id="L647">				hFirstVal = m_decimalFormat.format(hourAvail);</span>
			}
		}
<span class="nc" id="L650">		sb.append(&quot;&lt;span class=\&quot;calDayTxt\&quot;&gt;&quot;).append(hFirstVal).append(&quot;, &quot;);</span>

		//QA45178: Silk 80391
<span class="nc" id="L653">		Date dt = dayData.getDate();</span>
		// Pending Hour Info
<span class="nc" id="L655">		String hPending = m_decimalFormat.format(hourPending);</span>
<span class="nc bnc" id="L656" title="All 4 branches missed.">		if (hourPending &gt; 0 &amp;&amp; m_isLinkToRequestEnabled) {</span>
<span class="nc" id="L657">			hPending = getHourPendingDisplayForMgr(hPending, dt, dayData.getTOPoolID(), dayData.getOrgId());</span>
		}

		// Scheduled Time Off Info
<span class="nc" id="L661">		String schTimeOff = m_decimalFormat.format(hourScTO);</span>
<span class="nc bnc" id="L662" title="All 4 branches missed.">		if (hourScTO &gt; 0 &amp;&amp; m_isLinkToSchedTOEnabled) {</span>
<span class="nc" id="L663">			schTimeOff = createAgentsNameLink(schTimeOff, cal, dt, RmKeys.SCHEDULED_TO_TYPE, dayData.getTOPoolID(), dayData.getOrgId());</span>
		}

<span class="nc" id="L666">		sb.append(hPending).append(&quot;, &quot;).append(schTimeOff).append(&quot;&lt;/span&gt;&quot;);</span>
<span class="nc" id="L667">		return sb.toString();</span>
	}

	/**
	 * Return Calendar Display for a single calendar.
	 */
	private String getCalendarDisplay(CalendarPC calPC, Calendar cal, int index) {
<span class="nc bnc" id="L674" title="All 2 branches missed.">		if (index &gt;= m_numOfCals) {</span>
<span class="nc" id="L675">			return &quot;&amp;nbsp;&quot;;</span>
		}

		// Adjust CalendarPC Date with Date and TimeZone information so that First of the Month
		// does not get shifted to previous month due to TimeZone convertion
<span class="nc" id="L680">		Date date = cal.getTime();</span>
<span class="nc" id="L681">		calPC.setDate(date);</span>
<span class="nc" id="L682">		calPC.setCalendarTimeZone(cal.getTimeZone());</span>

<span class="nc" id="L684">		Calendar timeoffCal = newCalendar();</span>
<span class="nc" id="L685">		timeoffCal.setTime(date);</span>

<span class="nc" id="L687">		int size = cal.getActualMaximum(Calendar.DAY_OF_MONTH);</span>
<span class="nc" id="L688">		List calDataList = getCalendarData(size);</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">		boolean hasCalData = !calDataList.isEmpty();</span>
<span class="nc bnc" id="L690" title="All 4 branches missed.">		for (int i = 0; (i &lt; size &amp;&amp; hasCalData); i++) {</span>
<span class="nc" id="L691">			TOCalendarDayData dayData = (TOCalendarDayData) calDataList.get(i);</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">			if (m_isDetailEnabled) {</span>
<span class="nc" id="L693">				String text = getTimeOffHoursText(dayData, timeoffCal, i);</span>
<span class="nc" id="L694">				HashMap prop = new HashMap(1);</span>
<span class="nc" id="L695">				prop.put(GenericCalendarDayRenderer.DAY_PROP_DATA, text);</span>
<span class="nc" id="L696">				calPC.setCalendarDayProp(i + 1, prop);</span>
			}

			// Set Color Key
<span class="nc bnc" id="L700" title="All 2 branches missed.">			if (m_orgSetting != null) {</span>
<span class="nc" id="L701">				int dType = dayData.getDayType();</span>
<span class="nc" id="L702">				String colorKey = TOCalendarDayData.DAY_TYPE_TO_SETTINGS_KEY[dType];</span>
<span class="nc" id="L703">				String color = m_orgSetting.getValue(colorKey);</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">				color = color.startsWith(&quot;#&quot;) ? color : &quot;#&quot; + color;</span>
<span class="nc" id="L705">				calPC.setDayColor(i + 1, color);</span>

				//508: Add the formatted date to the accessible label
<span class="nc" id="L708">				String label = m_context.getLocalizer().formatDate(dayData.getDate(), cal.getTimeZone(), RegionalFormatBundleKey.FULL_DATE_FORMAT) + &quot;, &quot; + getDayTypeString(dType);</span>

				//Set the day number link properties for 508 Accessibility compliance
<span class="nc" id="L711">				calPC.setDayLinkProperties(i + 1, &quot;&quot;, label, &quot;text-decoration:none; cursor:default;&quot;);</span>
			}
		}

<span class="nc" id="L715">		return calPC.getHtmlDisplay();</span>
	}

	/**
	 * Return the TO Calendar Day Type string, such as (&quot;Blackout&quot;, &quot;Pending&quot;, etc).
	 * @param dType The day type integer.
	 * @return the TO Calendar Day Type string, such as (&quot;Blackout&quot;, &quot;Pending&quot;, etc).
	 */
	private String getDayTypeString(int dType) {
<span class="nc bnc" id="L724" title="All 9 branches missed.">		switch (dType) {</span>
		case TOCalendarDayData.NO_TO_HOURS_AVAILABLE_DAY_TYPE:
<span class="nc" id="L726">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_NO_AVAILABLE_LABEL);</span>
		case TOCalendarDayData.TO_HOURS_AVAILABLE_DAY_TYPE:
<span class="nc" id="L728">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_AVAILABLE_LABEL);</span>
		case TOCalendarDayData.UNPAID_HOLIDAY_DAY_TYPE:
<span class="nc" id="L730">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_WORKING_LABEL);</span>
		case TOCalendarDayData.NON_OPERATION_DAY_TYPE:
<span class="nc" id="L732">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_NON_OPERATION_LABEL);</span>
		case TOCalendarDayData.PAID_HOLIDAY_DAY_TYPE:
<span class="nc" id="L734">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_NON_WORKING_LABEL);</span>
		case TOCalendarDayData.BLACKOUT_DAY_TYPE:
<span class="nc" id="L736">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_BLACKOUT_LABEL);</span>
		case TOCalendarDayData.PENDING_DAY_TYPE:
<span class="nc" id="L738">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_PENDING_LABEL);</span>
		case TOCalendarDayData.SCHEDULED_DAY_TYPE:
<span class="nc" id="L740">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_SCHEDULED_LABEL);</span>
		default:
<span class="nc" id="L742">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_NO_AVAILABLE_LABEL);</span>
		}
	}

	/**
	 * Specify whether Legend is visible
	 */
	public void setIsLegendVisible(boolean bSwitch) {
<span class="nc" id="L750">		m_isLegendVisible = bSwitch;</span>
<span class="nc" id="L751">	}</span>

	/**
	 * Return True if Legend is visible
	 */
	public boolean isLegendVisible() {
<span class="nc" id="L757">		return m_isLegendVisible;</span>
	}

	/**
	 * Enabled Legend Button
	 */
	public void setIsLegendButtonEnabled(boolean bSwitch) {
<span class="nc" id="L764">		m_isLegenBtnEnabled = bSwitch;</span>
<span class="nc" id="L765">	}</span>

	/**
	 * Return True if Legend Button is Enabled
	 */
	public boolean isLegendButtonEnabled() {
<span class="nc" id="L771">		return m_isLegenBtnEnabled;</span>
	}

	/**
	 * Specify whether Detail Calendar is enabled
	 */
	public void setIsDetailEnabled(boolean bSwitch) {
<span class="nc" id="L778">		m_isDetailEnabled = bSwitch;</span>
<span class="nc" id="L779">	}</span>

	/**
	 * Return True if Detail Calendar is enabled
	 */
	public boolean isDetailEnabled() {
<span class="nc" id="L785">		return m_isDetailEnabled;</span>
	}

	/**
	 * Return Calendar Navigation Control
	 */
	public String getNavigationControl() {
<span class="nc" id="L792">		return m_calPC.getNavigationControl(m_navCalendar);</span>
	}

	/**
	 * Return JavaScript Init Code
	 */
	@Override
	public String getJavaScriptInitCode() {
<span class="nc" id="L800">		String superJS = super.getJavaScriptInitCode();</span>

<span class="nc bnc" id="L802" title="All 2 branches missed.">		if (StringUtil.isEmpty(m_sOrgID)) {</span>
<span class="nc" id="L803">			return superJS;</span>
		} else {
			//return superJS + &quot;\n&quot; + getName() + &quot;.setOrgID('&quot; + (m_orgViewMode!=null &amp;&amp; m_orgViewMode.equals(AgentsTimeOffCalendarPM.PARENT_ORG_VIEW)?m_parentOrgID:m_sOrgID) + &quot;');\n&quot;;
<span class="nc bnc" id="L806" title="All 2 branches missed.">			return superJS + &quot;\n&quot; + getName() + &quot;.setOrgID('&quot; + m_sOrgID + &quot;');\n&quot; + ((m_poolID == null) ? &quot;&quot; : (&quot;\n&quot; + getName() + &quot;.setPoolID('&quot; + m_poolID + &quot;');\n&quot;));</span>
		}
	}

	/**
	 * Extract Parameters
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L815">		boolean success = super.extractParameters(request);</span>

<span class="nc" id="L817">		Calendar cal = m_calPC.extractNavigationControlDate();</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">		if (cal != null) {</span>
<span class="nc" id="L819">			m_navCalendar = cal;</span>
<span class="nc" id="L820">			m_context.setAttribute(RequestContext.SESSION_SCOPE, TIMEOFF_CAL_CACHE_KEY, cal.clone());</span>
		}
<span class="nc" id="L822">		return success;</span>
	}

	public String getIntervalCalendarHtml() {
<span class="nc" id="L826">		intervalCalendarPC.setOrganizationSetting(m_orgSetting);</span>
<span class="nc" id="L827">		intervalCalendarPC.setTimeOffIntervalCalendar(timeOffIntervalCalendar);</span>

<span class="nc" id="L829">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L830">		appendLegend(sb);</span>
<span class="nc" id="L831">		intervalCalendarPC.setLegendHtml(sb.toString());</span>

<span class="nc" id="L833">		return intervalCalendarPC.getHtmlDisplay();</span>
	}

	/**
	 * Adjusts the calendars to fetch more data if a time zone conversion is required.
	 * This always adjusts if we are displaying the employee's TOC because we don't know their TOP assignments at this point.
	 */
	private void adjustCalendarsForTOIC(Calendar startCal, Calendar endCal) {
<span class="nc bnc" id="L841" title="All 4 branches missed.">		if (this.m_isAgentCal || !m_tz.equals(m_context.getViewingTimeZone())) {</span>
<span class="nc" id="L842">			startCal.add(Calendar.DATE, -1);</span>
<span class="nc" id="L843">			endCal.add(Calendar.DATE, 1);</span>
		}
<span class="nc" id="L845">	}</span>

	/**
	 * Reverses the calendar adjustments if necessary.
	 */
	private void unAdjustCalendarsForTOIC(Calendar startCal, Calendar endCal) {
<span class="nc bnc" id="L851" title="All 4 branches missed.">		if (this.m_isAgentCal || !m_tz.equals(m_context.getViewingTimeZone())) {</span>
<span class="nc" id="L852">			startCal.add(Calendar.DATE, 1);</span>
<span class="nc" id="L853">			endCal.add(Calendar.DATE, -1);</span>
		}
<span class="nc" id="L855">	}</span>

	/**
	 * Splits the Time Off Interval Calendar into days for the user's time zone.
	 */
	private void splitTimeOffIntervalCalendarForUser(Calendar startCal, Calendar endCal) {
<span class="nc" id="L861">		unAdjustCalendarsForTOIC(startCal, endCal);</span>
<span class="nc" id="L862">		TimeZone userTz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L863">		Date userStartDate = DateUtil.convertClockTimeToTimeZone(startCal.getTime(), m_tz, userTz);</span>
<span class="nc" id="L864">		Date userEndDate = DateUtil.convertClockTimeToTimeZone(endCal.getTime(), m_tz, userTz);</span>
<span class="nc" id="L865">		this.timeOffIntervalCalendar.splitIntoDays(userTz, userStartDate, userEndDate);</span>
<span class="nc" id="L866">	}</span>

	public String getTimeOffAllocationType() {
<span class="nc" id="L869">		return timeOffAllocationType;</span>
	}

	public void setTimeOffAllocationType(String timeOffAllocationType) {
<span class="nc" id="L873">		this.timeOffAllocationType = timeOffAllocationType;</span>
<span class="nc" id="L874">	}</span>

	/**
	 * Return HTML Display
	 */
	@Override
	public String getHtmlDisplay() {
		// initialize Title
<span class="nc" id="L882">		String title = i18n(m_common_bundle, UIFWebBundleKey.TIMEZONE_ORGANIZATION) + &quot;:&quot; + TimeZoneHelper.getDisplayTimeZone(m_tz.getID(), m_localizer);</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">		if (m_isEncapsulated) {</span>
<span class="nc" id="L884">			title = i18n(m_bundle, RmWebBundleKey.RM_TIMEOFFCAL) + &quot; - &quot; + title;</span>
		}
<span class="nc" id="L886">		setTitle(title);</span>

		// Set up Display
<span class="nc" id="L889">		setTemplate(&quot;{0}&quot;);</span>
<span class="nc" id="L890">		StringBuilder sb = new StringBuilder(512);</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">		if (getTimeOffAllocationType().equals(INTERVAL_ALLOCATION_DROPDOWN_VALUE)) {</span>
<span class="nc" id="L892">			sb.append(getIntervalCalendarHtml());</span>
		} else {
<span class="nc" id="L894">			appendCalendars(sb);</span>
<span class="nc" id="L895">			appendLegend(sb);</span>
		}

<span class="nc" id="L898">		addComponent(sb);</span>
<span class="nc" id="L899">		return super.getHtmlDisplay();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>