<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AgentsTimeOffRequestsRH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.timeoff</a> &gt; <span class="el_source">AgentsTimeOffRequestsRH.java</span></div><h1>AgentsTimeOffRequestsRH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.timeoff;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestCollection;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestFilter;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.AgentsRequestsRH;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.pagecomponent.toolbar.Pagination;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:		     AgentsRequestsRH
 * Description:  Manager View Request List page Request Handler
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 *
 * @author David Su
 * @version 1.0
 */
<span class="nc" id="L50">public class AgentsTimeOffRequestsRH extends AgentsRequestsRH {</span>
<span class="nc" id="L51">	private static final Category m_log = Log.initCategory(AgentsTimeOffRequestsRH.class.getName());</span>
	private static final String TABLE_SORT_ACTION = &quot;TABLE_SORT&quot;;

	/**
	 * Process Request for the User page
	 *
	 * @param context The Request Context
	 */
	public void processRequest(RequestContext context) throws Exception {

<span class="nc" id="L61">        String strPendingTOView = context.getParameter(&quot;isPendingTOView&quot;);</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        boolean bIsPendingTOView = strPendingTOView==null ? false : strPendingTOView.equals(&quot;true&quot;);</span>


<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (isAction(context, RmPageAction.AGENTS_TIMEOFF_PENDING_ACTION)  ||</span>
<span class="nc bnc" id="L66" title="All 4 branches missed.">                isAction(context, TABLE_SORT_ACTION) ||</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">                (bIsPendingTOView &amp;&amp; isAction(context, PageAction.REFRESH))) {</span>
<span class="nc" id="L68">			processAgentsTimeOffPending(context);</span>
		} else {
<span class="nc" id="L70">			super.processRequest(context);</span>
		}
<span class="nc" id="L72">	}                                                                             </span>

	/**
	 * Process Agents Time Off Pending
	 * &lt;p/&gt;
	 * Handle navigation from TimeOff Calendar to TimeOff Request Screen by
	 * showing Time Off Requests that are Pending
	 */
	protected void processAgentsTimeOffPending(RequestContext context) throws Exception {
<span class="nc bnc" id="L81" title="All 2 branches missed.">		boolean isAgentCal = context.getRequest().getParameter(&quot;isAgentCal&quot;) != null &amp;&amp;</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">		        context.getRequest().getParameter(&quot;isAgentCal&quot;).equals(&quot;true&quot;);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">		AgentsTimeOffRequestsPM model = new AgentsTimeOffRequestsPM(context, !isAgentCal);</span>
		
		//Thanh Hua: QA 89307 START
<span class="nc" id="L86">		model.extractParameters(context.getRequest());</span>
		
		//Thanh Hua: QA 89307 END
<span class="nc bnc" id="L89" title="All 4 branches missed.">		if (model.getIsPendingTOView() != null &amp;&amp; !model.getIsPendingTOView().equals(&quot;true&quot;)) {</span>
<span class="nc" id="L90">			super.processRequest(context);</span>
<span class="nc" id="L91">			return;</span>
		}

<span class="nc" id="L94">		model.setIsBlankFilterSelected(true);</span>
<span class="nc" id="L95">		model.addPageMessage(Message.INFO_TYPE, RmWebBundleKey.TIMEOFF_PENDING_HOUR_VIEW,</span>
		        RmWebBundleKey.BUNDLE_NAME);
		
		//String orgViewMode = (String)context.getAttribute(RequestContext.REQUEST_SCOPE,
		//		AgentsTimeOffCalendarPM.ORG_VIEW_MODE_KEY);

<span class="nc bnc" id="L101" title="All 2 branches missed.">		boolean isParentView = context.getRequest().getParameter(&quot;isParentView&quot;) != null &amp;&amp;</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">		        context.getRequest().getParameter(&quot;isParentView&quot;).equals(&quot;true&quot;);</span>
<span class="nc bnc" id="L103" title="All 4 branches missed.">		if (isParentView || isAgentCal)</span>
<span class="nc" id="L104">			model.addPageMessage(Message.INFO_TYPE, RmWebBundleKey.AGENTS_PENDING_VIEW,</span>
			        RmWebBundleKey.BUNDLE_NAME);

<span class="nc" id="L107">		boolean isAllocShared = false;</span>
<span class="nc" id="L108">		RequestFilter filter = createAdHocFilter(context, model, isAllocShared);</span>

<span class="nc" id="L110">		ID empID = context.getUser().getEmployeeID();</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">		if (empID != null) {</span>
			// Show all Requests without pagination
<span class="nc" id="L114">			model.setPageIDSize(Pagination.PAGE_ID_SIZE_ALL);</span>

			try {
				// @todo: Need to be refactored when Request Filter support multiple statuses
<span class="nc" id="L118">				List reqIDs = new ArrayList();</span>
<span class="nc" id="L119">				List requests = new ArrayList();</span>
<span class="nc" id="L120">				Map nameMap = new HashMap();        </span>

<span class="nc" id="L122">				ActivityFilter actFilter = new ActivityFilter();</span>
<span class="nc" id="L123">				actFilter.setTimeoffWithAllotment(true);</span>
				//get all time off activities
<span class="nc" id="L125">				ArrayList allotmentList = (ArrayList) WfmManagerFactory.getActivityManager().findActivitiesIds(actFilter);</span>
<span class="nc" id="L126">				filter.setKey(RequestFilter.STATUS_KEY, RequestAuditTrail.STATUS_ALL_PENDING_STATES);</span>
<span class="nc" id="L127">				RequestCollection tmpReqCollection = RequestsMH.getRequestsForManager(empID,</span>
				        filter,
<span class="nc" id="L129">				        model.getFindName(),</span>
<span class="nc" id="L130">				        model.getSortColumn(),</span>
<span class="nc" id="L131">				        model.isSortAscending(),</span>
<span class="nc" id="L132">				        model.getPageIDSize(),</span>
				        true,
				        true);
<span class="nc bnc" id="L135" title="All 4 branches missed.">				if (tmpReqCollection != null &amp;&amp; !tmpReqCollection.isEmpty()) {</span>
					//check whether not using allotment actvitivties
<span class="nc" id="L137">					boolean onlyUseAllotmentAct = &quot;true&quot;.equals(BbmManagerFactory.getDBConfigManager().getValue(ConfigKey.TIMEOFF_ONLY_COUNT_ACTIVITIES_WITH_ALLOTMENT));</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">					if (onlyUseAllotmentAct) {//if not showing all timeoff, filter out requests with activities without allotment</span>
						//iterate through requests to get only thise for allocation activities
<span class="nc bnc" id="L140" title="All 2 branches missed.">						for (int j = 0; j &lt; tmpReqCollection.getRequests().size(); j++) {</span>
<span class="nc" id="L141">							TORequest req = (TORequest) tmpReqCollection.getRequests().get(j);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">							if (allotmentList.contains(req.getTimeOffType())) {</span>
<span class="nc" id="L143">								reqIDs.add(req.getID());</span>
<span class="nc" id="L144">								requests.add(req);</span>
<span class="nc" id="L145">								nameMap.put(req.getEmployeeID(), tmpReqCollection.getNameMap().get(req.getEmployeeID()));</span>
							}
						}
					} else {
<span class="nc" id="L149">						reqIDs.addAll(tmpReqCollection.getIds());</span>
<span class="nc" id="L150">						requests.addAll(tmpReqCollection.getRequests());</span>
<span class="nc" id="L151">						nameMap.putAll(tmpReqCollection.getNameMap());</span>
					}
				}
<span class="nc" id="L154">				RequestCollection reqCollection = new RequestCollection(reqIDs, requests, nameMap);</span>
<span class="nc" id="L155">				model.init(reqCollection);</span>
<span class="nc" id="L156">			} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L157">				Message msg = model.handleUnableToLoadDataError(m_log, ex);</span>
<span class="nc" id="L158">				msg.setAssociatedMessage(ex.getLocalizedMessage(context.getLocalizer(), context.getViewingTimeZone()));</span>
<span class="nc" id="L159">			} catch (Exception ex) {</span>
<span class="nc" id="L160">				model.handleUnableToLoadDataError(m_log, ex);</span>
<span class="nc" id="L161">			}</span>
		}

<span class="nc" id="L164">		context.setPageModel(model);</span>
<span class="nc" id="L165">	}</span>


	/**
	 * Create Adhoc Filter from extracted parameters
	 */
	protected RequestFilter createAdHocFilter(RequestContext context, AgentsTimeOffRequestsPM model, boolean isAllocShared) throws Exception {
<span class="nc" id="L172">		RequestFilter filter = new RequestFilter(context.getUser().getID(), &quot;ADHOC&quot;);</span>
<span class="nc" id="L173">		filter.setKey(RequestFilter.REQUEST_TYPE_KEY, Request.REQUESTTYPE_TIMEOFF);</span>
<span class="nc" id="L174">		filter.setKey(RequestFilter.TO_NUMBER_OF_CHOICES_KEY, RequestFilter.FIRST_ONLY_TO_CHOICE);</span>
<span class="nc" id="L175">		ID orgID = addExtractedOrgID(context, filter);</span>
<span class="nc" id="L176">		ID pTOPoolID = addExtractedTOPoolID(context, filter);</span>
<span class="nc" id="L177">		addExtractedDate(context, filter, model, orgID, pTOPoolID);</span>
<span class="nc" id="L178">		return filter;</span>
	}

	protected ID addExtractedTOPoolID(RequestContext context, RequestFilter filter) throws Exception {
<span class="nc" id="L182">		ID pTOPoolID = null;</span>
		try {
<span class="nc" id="L184">			String val = context.getRequest().getParameter(&quot;TOPOOLID&quot;);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">			if (!StringUtil.isEmptyOrWhiteSpace(val)) {</span>
<span class="nc" id="L186">				pTOPoolID = new ID(Integer.parseInt(val));</span>
			}
<span class="nc" id="L188">		} catch (Exception e) {}</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">		if (pTOPoolID != null) {</span>
<span class="nc" id="L190">			filter.setKey(RequestFilter.TOPOOL_KEY, pTOPoolID);</span>
		}
<span class="nc" id="L192">		return pTOPoolID;</span>
	}

	/**
	 * Add Extracted Org ID to filter
	 */
	protected ID addExtractedOrgID(RequestContext context, RequestFilter filter) throws Exception {
<span class="nc" id="L199">		ID orgID = null;</span>
		try {
<span class="nc" id="L201">			String val = context.getRequest().getParameter(&quot;orgID&quot;);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">			if (!StringUtil.isEmptyOrWhiteSpace(val)) {</span>
<span class="nc" id="L203">				orgID = new ID(Integer.parseInt(val));</span>
			}
<span class="nc" id="L205">		} catch (Exception e) {}</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">		if (orgID != null) {</span>
<span class="nc" id="L207">			Set orgIDList = new HashSet();</span>
<span class="nc" id="L208">			orgIDList.add(orgID);</span>
			//get the entire org tree because hours are shown for entire branch
<span class="nc" id="L210">			orgIDList.addAll(OrganizationModelHandler.getSelfAndChildOrganizationIDs(context, orgID));</span>
<span class="nc" id="L211">			filter.setKey(RequestFilter.ORGANIZATION_KEY, (Serializable) orgIDList);</span>
		}
<span class="nc" id="L213">		return orgID;</span>
	}

	/**
	 * Add Extracted Date to filter
	 */
	protected void addExtractedDate(RequestContext context, RequestFilter filter, AgentsTimeOffRequestsPM model, ID orgID, ID pTOPoolID) throws Exception {
<span class="nc" id="L220">		String dateStr = context.getRequest().getParameter(&quot;date&quot;);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">		if (StringUtil.isEmpty(dateStr)) return;</span>

<span class="nc" id="L223">		Date sDate = new Date(Long.parseLong(dateStr));</span>
		/*
		Calendar eCal = Calendar.getInstance();
		QA47429 Org time zone to ge used to find the time period for which the request
		should be fetched. Without time zone, it considers 11.59 PM GMT. So the request created after
		(11.59 PM GMT - Time zone difference) are not displayed when the pending hours link is clicked
		Bug: 90291 Ported from rel 4.5.8, Jan 2006, Sameet  */
<span class="nc bnc" id="L230" title="All 2 branches missed.">		if (orgID == null) {</span>
<span class="nc" id="L231">			TOPool pTOPool = RmManagerFactory.getInstance().getTimeOffDayFacade().getTOPool(pTOPoolID);</span>
<span class="nc" id="L232">			orgID = pTOPool.getOrganizationId();</span>
		}
<span class="nc" id="L234">		Organization org = OrganizationModelHandler.getOrganization(context, orgID);</span>
<span class="nc" id="L235">		TimeZone tz = org.getTimeZone();</span>
		//End of fix for Bug: 90291
		/* always use the foll API to get the start and end days. */
<span class="nc" id="L238">		Date startDate = TOCalcUtil.getDateForOrgDayStart(tz, org.getDayBoundaryOffset(), sDate);</span>
<span class="nc" id="L239">		Date endDate = TOCalcUtil.getDateForOrgDayEnd(tz, org.getDayBoundaryOffset(), sDate);</span>

<span class="nc" id="L241">		List dates = new ArrayList(2);</span>
<span class="nc" id="L242">		dates.add(startDate);</span>
<span class="nc" id="L243">		dates.add(endDate);</span>
<span class="nc" id="L244">		filter.setKey(RequestFilter.REQUEST_DATE_RANGE_KEY, (Serializable) dates);</span>
<span class="nc" id="L245">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>