<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffHoursManagerBridgeImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb</a> &gt; <span class="el_source">TimeOffHoursManagerBridgeImpl.java</span></div><h1>TimeOffHoursManagerBridgeImpl.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb;

import java.rmi.RemoteException;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.schedule.model.ScheduleChangeDetails;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.TimeOffEvent;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.DailyHoursBuckets;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TONotifyMessage;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TimeOffHoursManagerBridge;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TORequestManager;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDay;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.TimeOffIntervalAllocationUtil;
import com.bluepumpkin.ejb.rm.setup.settings.ejb.OrganizationConfigManager;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.verint.ejb.wfm.WfmManagerFactory;


<span class="nc" id="L37">public class TimeOffHoursManagerBridgeImpl implements TimeOffHoursManagerBridge {</span>

	public DailyHoursBuckets getDailyHoursBucketsForDateRange(ID employeeID,
			TimeOffEvent timeOffEvent, Organization org, Date toPeriodStart,
			Date toPeriodEnd) throws BbmCreateException, BbmFinderException, RemoteException {
<span class="nc" id="L42">		TOHoursPerDayManager toHoursManager = RmManagerFactory.getInstance().getTOHoursPerDayManager();</span>
<span class="nc" id="L43">		TOHoursPerDay hoursPerDay = toHoursManager.getTOHoursPerDaysForTOEvent(employeeID, timeOffEvent);</span>
<span class="nc" id="L44">		return TOHoursPerDayUtil.getDailyHoursBucketsForDateRange(org, hoursPerDay, toPeriodStart, toPeriodEnd);</span>
	}

	public void updateTOHoursPerDay(TONotifyMessage msg) throws BbmUpdateException, BbmFinderException, RemoteException, BbmCreateException {
<span class="nc" id="L48">		TOHoursPerDayManager toHoursManager = RmManagerFactory.getInstance().getTOHoursPerDayManager();</span>
<span class="nc" id="L49">		toHoursManager.updateTOHoursPerDay(msg);</span>
<span class="nc" id="L50">	}</span>

	public void updateHoursPerDay(ScheduleChangeDetails changeDetails) throws BbmUpdateException, RemoteException, BbmCreateException {
<span class="nc" id="L53">		TOHoursPerDayManager toHoursManager = RmManagerFactory.getInstance().getTOHoursPerDayManager();</span>
<span class="nc" id="L54">		toHoursManager.updateHoursPerDay(changeDetails);</span>
<span class="nc" id="L55">	}</span>

	public Collection dumpTOReportDataWithResult(Collection colEmployeeIDs, int threadID, int lookBack, int lookForward, Date start, Date end) throws BbmUpdateException, RemoteException {
<span class="nc" id="L58">		Collection failed = null;</span>
		try {
<span class="nc" id="L60">			TORequestManager m_torManager = RmManagerFactory.getInstance(true).getTimeOffRequestManager();</span>
<span class="nc" id="L61">			failed = m_torManager.dumpTOReportDataWithResult(colEmployeeIDs, threadID, lookBack, lookForward, start, end);</span>
<span class="nc" id="L62">		} catch (Exception e) {</span>
<span class="nc" id="L63">			e.printStackTrace();</span>
<span class="nc" id="L64">		}</span>
<span class="nc" id="L65">		return failed;</span>
	}
	
	// max duration and max tolerance override start
	/*
	 Fully-Overridable (the entire activity can be overridden):
		Vacation (may not be needed afterall. This is an open issue)
		
	Partially-Overridable (only two attributes can be overridden per activity):
		No Activity
		Unknown Activity
		Shift/Overtime Gap
		Voluntary Time Off
		Learning
		Coaching
		
		note: Unknown: Tolerance=n/a
		note: No Activity: MaxTime=n/a
	 */
<span class="nc" id="L84">	private static int DEFAULT_OVERRIDE_NOTFOUND = -2; //-1 MEANS UNLIMITED HERE </span>
<span class="nc" id="L85">	public static ID[] specialActivityIDs = new ID[6];</span>
    static {
<span class="nc" id="L87">          specialActivityIDs[0] = Activity.ACTIVITY_NONE;</span>
<span class="nc" id="L88">          specialActivityIDs[1] = Activity.ACTIVITY_UNKNOWN;</span>
<span class="nc" id="L89">          specialActivityIDs[2] = Activity.ACTIVITY_SHIFT_OVERTIME_GAP;          </span>
<span class="nc" id="L90">          specialActivityIDs[3] = Activity.ACTIVITY_VOLUNTARY_TIMEOFF;</span>
<span class="nc" id="L91">          specialActivityIDs[4] = Activity.ACTIVITY_LEARNING_BREAK;</span>
<span class="nc" id="L92">          specialActivityIDs[5] = Activity.ACTIVITY_COACHING;</span>
<span class="nc" id="L93">    }     </span>
	
	public int getMaxDurationOverride(ID orgID, ID activityID) throws BbmFinderException, RemoteException {
<span class="nc" id="L96">		int maxDuration = 0;</span>
		try {
<span class="nc" id="L98">			maxDuration = getActivityByID(activityID).getMaxDurationThreshold(); //default value</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">			if (activityID.equals(Activity.ACTIVITY_NONE))</span>
<span class="nc" id="L100">				return maxDuration; //No Activity: MaxTime=n/a, no override supported</span>
<span class="nc" id="L101">			int override = getActivityOverride(orgID, activityID, Activity.getMaxDurationOverrideKey(activityID));</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">			if (override != DEFAULT_OVERRIDE_NOTFOUND)</span>
<span class="nc" id="L103">				maxDuration = override;</span>
<span class="nc" id="L104">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L105">			throw e;</span>
<span class="nc" id="L106">		} catch (Exception e) {</span>
<span class="nc" id="L107">			throw new BbmFinderException(e);</span>
<span class="nc" id="L108">		}</span>
<span class="nc" id="L109">		return maxDuration;</span>
	}
	
	public void setMaxDurationOverride(ID orgID, ID activityID, int value) throws BbmUpdateException, RemoteException {
		try {
<span class="nc" id="L114">			setActivityOverride(orgID, activityID, Activity.getMaxDurationOverrideKey(activityID), value);</span>
<span class="nc" id="L115">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L116">			throw e;</span>
<span class="nc" id="L117">		} catch (Exception e) {</span>
<span class="nc" id="L118">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L119">		}</span>
<span class="nc" id="L120">	}</span>
	
	public int getAdherenceToleranceOverride(ID orgID, ID activityID) throws BbmFinderException, RemoteException {
<span class="nc" id="L123">		int adherenceTolerance = 0;</span>
		try {
<span class="nc" id="L125">			adherenceTolerance = getActivityByID(activityID).getAdherenceTolerance(); //default value</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">			if (activityID.equals(Activity.ACTIVITY_UNKNOWN))</span>
<span class="nc" id="L127">				return adherenceTolerance; //Unknown: Tolerance=n/a, no override supported</span>
<span class="nc" id="L128">			int override = getActivityOverride(orgID, activityID, Activity.getAdherenceToleranceOverrideKey(activityID));</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">			if (override != DEFAULT_OVERRIDE_NOTFOUND)</span>
<span class="nc" id="L130">				adherenceTolerance = override;</span>
<span class="nc" id="L131">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L132">			throw e;</span>
<span class="nc" id="L133">		} catch (Exception e) {</span>
<span class="nc" id="L134">			throw new BbmFinderException(e);</span>
<span class="nc" id="L135">		}</span>
<span class="nc" id="L136">		return adherenceTolerance;</span>
	}
	
	public void setAdherenceToleranceOverride(ID orgID, ID activityID, int value) throws BbmUpdateException, RemoteException {
		try {
<span class="nc" id="L141">			setActivityOverride(orgID, activityID, Activity.getAdherenceToleranceOverrideKey(activityID), value);</span>
<span class="nc" id="L142">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L143">			throw e;</span>
<span class="nc" id="L144">		} catch (Exception e) {</span>
<span class="nc" id="L145">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L146">		}</span>
<span class="nc" id="L147">	}</span>
	
	public Activity getVacationOverride(ID orgID) throws BbmFinderException, RemoteException {
<span class="nc" id="L150">		Activity vacation = null;</span>
		try {
<span class="nc" id="L152">			vacation = getActivityByID(Activity.ACTIVITY_VACATION);</span>
<span class="nc" id="L153">			int vacationID = getActivityOverride(orgID, Activity.ACTIVITY_VACATION, Activity.ACTIVITY_VACATION.toString());</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">			if (vacationID != DEFAULT_OVERRIDE_NOTFOUND) //found one</span>
			{
				try
				{
<span class="nc" id="L158">					vacation = getActivityByID(new ID(vacationID));</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">					if (vacation.isDeleted())</span>
					{
<span class="nc" id="L161">						ID parentOrgID = handleDeletedVacationOverride(orgID);</span>
<span class="nc" id="L162">						return getVacationOverride(parentOrgID);</span>
					}
				}
<span class="nc" id="L165">				catch (BbmObjectNotFoundException deletedException)</span>
				{
<span class="nc" id="L167">					ID parentOrgID = handleDeletedVacationOverride(orgID);</span>
<span class="nc" id="L168">					return getVacationOverride(parentOrgID);</span>
<span class="nc" id="L169">				}</span>
			}
<span class="nc" id="L171">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L172">			throw e;</span>
<span class="nc" id="L173">		} catch (Exception e) {</span>
<span class="nc" id="L174">			throw new BbmFinderException(e);</span>
<span class="nc" id="L175">		}</span>
<span class="nc" id="L176">		return vacation;</span>
	}
	
	private ID handleDeletedVacationOverride(ID orgID) throws BbmEJBCreateException, BbmCreateException, BbmFinderException, RemoteException
	{
		//delete mapping from organizationconfig table for this org (clear cache will happen automatically)
<span class="nc" id="L182">		OrganizationConfigManager manager = RmManagerFactory.getInstance().getOrganizationConfigManager();</span>
<span class="nc" id="L183">		HashSet set = new HashSet(1);</span>
<span class="nc" id="L184">		set.add(Activity.ACTIVITY_VACATION.toString());</span>
<span class="nc" id="L185">		manager.deletePropertyList(orgID, set);</span>
		
		//return the parent orgID
<span class="nc" id="L188">		Organization org = BbmManagerFactory.getWorkResourceManager().getOrganizationByID(orgID);</span>
<span class="nc" id="L189">		return org.getParentID();</span>
	}
	
	public void setVacationOverride(ID orgID, ID vacationActivityID) throws BbmUpdateException, RemoteException {
		try {
<span class="nc" id="L194">			setActivityOverride(orgID, Activity.ACTIVITY_VACATION, Activity.ACTIVITY_VACATION, vacationActivityID.toInt()); </span>
<span class="nc" id="L195">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L196">			throw e;</span>
<span class="nc" id="L197">		} catch (Exception e) {</span>
<span class="nc" id="L198">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L199">		}</span>
<span class="nc" id="L200">	}</span>
	
	private Activity getActivityByID(ID activityID) throws Exception {
<span class="nc" id="L203">		ActivityManager aManager = WfmManagerFactory.getActivityManager();</span>
<span class="nc" id="L204">		Activity activity = aManager.findActivityById(activityID);</span>
<span class="nc" id="L205">		return activity;</span>
	}
	
	private int getActivityOverride(ID orgID, ID activityID, Object key) throws Exception {
<span class="nc" id="L209">		int override = DEFAULT_OVERRIDE_NOTFOUND;		</span>
<span class="nc" id="L210">		boolean isOverridable = false;</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">		for (int ix = 0; ix &lt; specialActivityIDs.length; ix++) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">			if (specialActivityIDs[ix].equals(activityID)) {</span>
<span class="nc" id="L213">				isOverridable = true;</span>
<span class="nc" id="L214">				break;</span>
			}
		}
<span class="nc bnc" id="L217" title="All 4 branches missed.">		if (isOverridable || activityID.equals(Activity.ACTIVITY_VACATION)) {</span>
<span class="nc" id="L218">			OrganizationConfigManager manager = RmManagerFactory.getInstance().getOrganizationConfigManager();</span>
<span class="nc" id="L219">			Object value =  manager.getConfiguration(orgID).getValue((String)key);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">			if (value != null)</span>
<span class="nc" id="L221">				override = Integer.parseInt((String)value);</span>
		}
<span class="nc" id="L223">		return override;</span>
	}
	
	private void setActivityOverride(ID orgID, ID activityID, Object key, int value) throws Exception {
<span class="nc" id="L227">		int override = 0;		</span>
<span class="nc" id="L228">		boolean isOverridable = false;</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">		for (int ix = 0; ix &lt; specialActivityIDs.length; ix++) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">			if (specialActivityIDs[ix].equals(activityID)) {</span>
<span class="nc" id="L231">				isOverridable = true;</span>
<span class="nc" id="L232">				break;</span>
			}
		}
<span class="nc bnc" id="L235" title="All 4 branches missed.">		if (isOverridable || activityID.equals(Activity.ACTIVITY_VACATION)) {</span>
<span class="nc" id="L236">			OrganizationConfigManager manager = RmManagerFactory.getInstance().getOrganizationConfigManager();</span>
<span class="nc" id="L237">			Map propMap = new HashMap();</span>
<span class="nc" id="L238">			propMap.put(key.toString(), &quot;&quot;+value);</span>
<span class="nc" id="L239">			manager.setConfiguration(orgID, new OrganizationSetting(propMap,orgID.toString()), false ); //TBD: We need to base this on whether user clicked &quot;Save&quot; or &quot;Save and apply to sub-orgs&quot;</span>
		}
<span class="nc" id="L241">	}</span>
	// max duration and max tolerance override end

	
	public List&lt;ShiftAssignment&gt; getReferenceSchedules(Organization organization , ID employeeID, Date start, Date end) throws BbmFinderException{
		
<span class="nc" id="L247">		return TimeOffIntervalAllocationUtil.getReferenceSchedules(organization, employeeID, start, end );</span>

	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>