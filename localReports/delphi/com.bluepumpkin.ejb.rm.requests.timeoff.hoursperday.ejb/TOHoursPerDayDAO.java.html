<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TOHoursPerDayDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb</a> &gt; <span class="el_source">TOHoursPerDayDAO.java</span></div><h1>TOHoursPerDayDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.IDPair;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoPCommand;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.base.RmException;
import com.bluepumpkin.ejb.rm.l10n.RmEjbLogBundleKey;
import com.bluepumpkin.ejb.rm.l10n.RmSettingKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDay;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDayFieldInfo;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TimeOffActivitySummary;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.ejb.rm.util.DAOUtil;
import com.bluepumpkin.ejb.rm.util.JdmoPreparedStatementBuilder;
import com.bluepumpkin.ejb.rm.util.RmDAOBase;


/**
 * DAO class for TOHoursPerDay
 */
public class TOHoursPerDayDAO extends RmDAOBase&lt;TOHoursPerDay&gt; {
	// TOChoiceFieldInfo for the DAO class.
<span class="nc" id="L53">	private static FieldInfo m_fieldInfo = new TOHoursPerDayFieldInfo();</span>
<span class="nc" id="L54">	private static Category m_cat = Log.initCategory(TOHoursPerDayDAO.class.getName());</span>

	/**
	 * Constructor
	 */
	public TOHoursPerDayDAO() {
<span class="nc" id="L60">		super();</span>
<span class="nc" id="L61">	}</span>

	/**
	 * Constructor
	 *
	 * @param - Jdmo - Jdmo object instance
	 * @see
	 */
	public TOHoursPerDayDAO(Jdmo dmo) {
<span class="nc" id="L70">		super(dmo);</span>
<span class="nc" id="L71">	}</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="nc" id="L75">		return TOHoursPerDayDAO.m_fieldInfo;</span>
	}

	protected Category getCategory() {
<span class="nc" id="L79">		return TOHoursPerDayDAO.m_cat;</span>
	}

	/**
	 * Creates the value object.
	 *
	 * @return - returns new Value object
	 * @see com.bluepumpkin.ejb.bbm.vo.ValueObjectBase
	 * @see com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDay
	 */
	@Override
	protected TOHoursPerDay createValueObject() {
<span class="nc" id="L91">		return (new TOHoursPerDay());</span>
	}

	/**
	 * Finds TOHoursPerDay for the TOHoursPerDay id object passed as argument.
	 *
	 * @param - ID -  ID object for Time off Choice.
	 * @return - TOHoursPerDay Object.
	 * @throw BbmFinderException
	 */
	public TOHoursPerDay getTOHoursPerDayRequestById(ID pTOHoursPerDayId) throws BbmFinderException {
<span class="nc" id="L102">		return getObjectByID(pTOHoursPerDayId);</span>
	}

	/**
	 * Create new TimeOff HoursPerDay for the TimeOff HoursPerDay object passed as argument.
	 *
	 * @param - pTOHoursPerDay -  TOHoursPerDay object for Time off Choice / To event.
	 * @return - ID object for created TOHoursPerDay.
	 * @throw BbmCreateException
	 */
	public ID createTOHoursPerDayRequest(TOHoursPerDay pTOHoursPerDay) throws RmException, BbmCreateException {
<span class="nc bnc" id="L113" title="All 4 branches missed.">		if (pTOHoursPerDay.getTOChoiceID() == null &amp;&amp; pTOHoursPerDay.getTOEventID() == null) {</span>
<span class="nc" id="L114">			throw RequestUtil.createRmException(RmEjbLogBundleKey.REQUEST_ID_NULL, TOHoursPerDayDAO.m_cat);</span>
		}
		/*
	    if (pTOHoursPerDay.getTOHoursPerDayCreationDate() == null) {
	        throw RequestUtil.createRmException(RmEjbLogBundleKey.t, TOHoursPerDayDAO.m_cat);
	    }
	    if (pTOHoursPerDay.getTOHoursPerDayExpiryDate() == null) {
	        throw RequestUtil.createRmException(RmEjbLogBundleKey.TOHoursPerDay_EXPIRY_DATE_NULL, TOHoursPerDayDAO.m_cat);
	    }  */
<span class="nc" id="L123">		ID l_TOHoursPerDayId = createObject(pTOHoursPerDay);</span>
<span class="nc" id="L124">		return l_TOHoursPerDayId;</span>

	}

	/**
	 * Update TO HoursPerDay database for the TO HoursPerDay object passed as argument.
	 *
	 * @param - pTOHoursPerDay -  TOHoursPerDay object for Time off Choice.
	 * @throw BbmUpdateException
	 */
	public void updateTOHoursPerDay(TOHoursPerDay pTOHoursPerDay) throws BbmUpdateException, MultiUserException {
<span class="nc" id="L135">		updateObject(pTOHoursPerDay);</span>
<span class="nc" id="L136">	}</span>

	/**
	 * Delete TO HoursPerDay database for the TO HoursPerDay id object passed as argument.
	 *
	 * @param - pTOHoursPerDayID -  ID object for Time off Choice.
	 * @throw BbmRemoveException
	 * @see
	 */
	public void deleteTOHoursPerDayRequest(ID pTOHoursPerDayID) throws BbmRemoveException {
<span class="nc" id="L146">		deleteObject(pTOHoursPerDayID);</span>
<span class="nc" id="L147">	}</span>

	//on HOO change or Holiday change
	public Collection findEligibleTOHoursPerDay(ID orgID, TimeRange dateRange) throws Exception {
<span class="nc" id="L151">		return new ArrayList();</span>
	}

	// on HOO or Holiday change
	public Collection findEligibleTOHoursPerDay(ID empID, ID TOActivityID) throws Exception {
<span class="nc" id="L156">		return new ArrayList();</span>
	}

	// on  unavailability
	public Collection findEligibleTOHoursPerDayForEmp(ID empID, TimeRange dateRange) throws Exception {
<span class="nc" id="L161">		StringBuffer query = new StringBuffer(256);</span>
<span class="nc" id="L162">		query.append(&quot;SELECT A.ID FROM &quot;);</span>
<span class="nc" id="L163">		query.append(getFieldInfo().getTableName()).append(&quot; A &quot;);</span>
<span class="nc" id="L164">		query.append(&quot;WHERE A.EMPLOYEEID=? and startdate &gt;= ? and endDate&lt;= ? &quot;);</span>
<span class="nc" id="L165">		List toReqIDs = DAOUtil.getIDsUsingSQLQuery(getDMO(),</span>
<span class="nc" id="L166">		        query.toString(),</span>
		        new Object[]{new Date()},
		        new DAOUtil.ColumnMetaData[]
<span class="nc" id="L169">		        {DAOUtil.ColumnMetaData.getColMetaDataForDate()</span>
		        });
<span class="nc" id="L171">		return toReqIDs;</span>
	}

	// on HOO or Holiday change
	public Collection getAllDirtyTOHoursPerDay() throws Exception {
<span class="nc" id="L176">		StringBuffer query = new StringBuffer(256);</span>
<span class="nc" id="L177">		query.append(&quot;SELECT A.ID FROM &quot;);</span>
<span class="nc" id="L178">		query.append(getFieldInfo().getTableName()).append(&quot; A &quot;);</span>
<span class="nc" id="L179">		query.append(&quot;WHERE A.ISDIRTY = 1&quot;);</span>
<span class="nc" id="L180">		List toReqIDs = DAOUtil.getIDsUsingSQLQuery(getDMO(),</span>
<span class="nc" id="L181">		        query.toString(),</span>
		        new Object[]{new Date()},
		        new DAOUtil.ColumnMetaData[]
<span class="nc" id="L184">		        {DAOUtil.ColumnMetaData.getColMetaDataForDate()</span>
		        });
<span class="nc" id="L186">		return toReqIDs;</span>
	}

	public void updateTOEventsForEmp(Collection delTOEventIDs, HashMap newTOEvents) throws Exception {
<span class="nc bnc" id="L190" title="All 4 branches missed.">		if (delTOEventIDs != null &amp;&amp; !delTOEventIDs.isEmpty()) {</span>
<span class="nc" id="L191">			deleteTOHoursPerDay(delTOEventIDs, TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID, null);</span>
		}
<span class="nc" id="L193">		Collection existingObjects = getObjects(newTOEvents.keySet(), TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID, null);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">		for (Iterator iterator = existingObjects.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L195">			TOHoursPerDay toHoursPerDayToBeUpdated = (TOHoursPerDay) iterator.next();</span>
<span class="nc" id="L196">			TOHoursPerDay toHoursPerDayNew = (TOHoursPerDay) newTOEvents.remove(toHoursPerDayToBeUpdated.getTOEventID());</span>
			//toHoursPerDayToBeUpdated will be updated with all the refreshed contents of  toHoursPerDayNew Object
<span class="nc" id="L198">			TOHoursPerDayUtil.updateTOEventToHoursPerDay(toHoursPerDayToBeUpdated, toHoursPerDayNew);</span>
<span class="nc" id="L199">		}</span>
<span class="nc bnc" id="L200" title="All 4 branches missed.">		if (existingObjects != null &amp;&amp; !existingObjects.isEmpty()) {</span>
<span class="nc" id="L201">			updateObjects(existingObjects);</span>
		}
<span class="nc bnc" id="L203" title="All 4 branches missed.">		if (newTOEvents != null &amp;&amp; !newTOEvents.isEmpty()) {</span>
<span class="nc" id="L204">			createObjects(newTOEvents.values());</span>
		}
<span class="nc" id="L206">	}</span>

	public void updateTOChoicesForEmp(Collection delTOChoiceIDs, HashMap newTOChoices) throws Exception {
<span class="nc bnc" id="L209" title="All 4 branches missed.">		if (delTOChoiceIDs != null &amp;&amp; !delTOChoiceIDs.isEmpty()) {</span>
<span class="nc" id="L210">			deleteTOHoursPerDay(delTOChoiceIDs, TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID, null);</span>
		}
<span class="nc" id="L212">		Collection existingObjects = getObjects(newTOChoices.keySet(), TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID, null);</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">		for (Iterator iterator = existingObjects.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L214">			TOHoursPerDay toHoursPerDayToBeUpdated = (TOHoursPerDay) iterator.next();</span>
<span class="nc" id="L215">			TOHoursPerDay toHoursPerDayNew = (TOHoursPerDay) newTOChoices.remove(toHoursPerDayToBeUpdated.getTOChoiceID());</span>
			//toHoursPerDayToBeUpdated will be updated with all the refreshed contents of  toHoursPerDayNew Object
<span class="nc bnc" id="L217" title="All 2 branches missed.">			if (toHoursPerDayNew == null) {</span>
<span class="nc" id="L218">				throw new BbmUpdateException(toHoursPerDayToBeUpdated + &quot; not found in new Objects&quot;);</span>
			}
<span class="nc" id="L220">			TOHoursPerDayUtil.updateTOEventToHoursPerDay(toHoursPerDayToBeUpdated, toHoursPerDayNew);</span>
<span class="nc" id="L221">		}</span>
<span class="nc bnc" id="L222" title="All 4 branches missed.">		if (existingObjects != null &amp;&amp; !existingObjects.isEmpty()) {</span>
<span class="nc" id="L223">			updateObjects(existingObjects);</span>
		}
<span class="nc bnc" id="L225" title="All 4 branches missed.">		if (newTOChoices != null &amp;&amp; !newTOChoices.isEmpty()) {</span>
<span class="nc" id="L226">			createObjects(newTOChoices.values());</span>
		}
<span class="nc" id="L228">	}</span>

	public void deleteTOHoursPerDay(Collection col, int columnId, TimeRange dateRange) throws Exception {
<span class="nc" id="L231">		StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L232">		buf.append(&quot;SELECT ID FROM &quot;);</span>
<span class="nc" id="L233">		buf.append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L234">		buf.append(&quot; WHERE &quot;);</span>
<span class="nc" id="L235">		buf.append(TOHoursPerDayFieldInfo.getColumnName(columnId)).append(&quot; in &quot;).append(m_dmo.createInClause(col));</span>
<span class="nc" id="L236">		appendDateRangeClause(buf, dateRange, &quot; AND &quot;);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;deleteTOHoursPerDay QRY=&quot; + buf.toString());</span>
<span class="nc" id="L238">		deleteObjects(buf.toString());</span>
<span class="nc" id="L239">	}</span>

	public void deleteTOHoursPerDayForTOEventEmpPairs(Collection toEventEmpPairs) throws BbmUpdateException {
<span class="nc" id="L242">		Jdmo jdmo = null;</span>
		try {
<span class="nc" id="L244">			jdmo = getDMO();</span>
<span class="nc bnc" id="L245" title="All 4 branches missed.">			if (toEventEmpPairs == null || toEventEmpPairs.isEmpty()) {</span>
<span class="nc" id="L246">				return;</span>
			}
<span class="nc" id="L248">			StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L249">			buf.append(&quot;DELETE &quot;).append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L250">			buf.append(&quot; WHERE &quot;).append(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID).append(&quot; = ? AND &quot;);</span>
<span class="nc" id="L251">			buf.append(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_EMPLOYEEID).append(&quot; = ? &quot;);</span>
<span class="nc" id="L252">			JdmoPCommand pc = jdmo.createPCommand(buf.toString());</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">			for (Iterator iterator = toEventEmpPairs.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L254">				IDPair pair = (IDPair) iterator.next();</span>
<span class="nc" id="L255">				jdmo.addBatchPCommand(pc, new Object[]{pair.getFirst(), pair.getSecond()});</span>
<span class="nc" id="L256">			}</span>
<span class="nc" id="L257">			jdmo.executeBatchPCommand(pc);</span>
<span class="nc" id="L258">		} catch (Exception e) {</span>
<span class="nc" id="L259">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L260">		}</span>
<span class="nc" id="L261">	}</span>

	public void markTOHoursPerDayAsDirty(Collection col, int columnId, TimeRange dateRange) throws Exception {
<span class="nc" id="L264">		Jdmo dmo = getDMO();</span>
<span class="nc" id="L265">		StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L266">		buf.append(&quot; UPDATE &quot;);</span>
<span class="nc" id="L267">		buf.append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L268">		buf.append(&quot; SET &quot;);</span>
<span class="nc" id="L269">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_B_ISDIRTY));</span>
<span class="nc" id="L270">		buf.append(&quot;= 1 , &quot;);</span>
<span class="nc" id="L271">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_D_DIRTYTIME));</span>
<span class="nc" id="L272">		buf.append(&quot;= '&quot;).append(JdmoUtil.formatDBString(new Date())).append(&quot;' &quot;);</span>
<span class="nc" id="L273">		buf.append(&quot; WHERE &quot;);</span>
<span class="nc" id="L274">		buf.append(TOHoursPerDayFieldInfo.getColumnName(columnId)).append(&quot; in &quot;).append(m_dmo.createInClause(col));</span>
<span class="nc" id="L275">		appendDateRangeClause(buf, dateRange, &quot; AND &quot;);</span>
<span class="nc" id="L276">		dmo.executeCommand(buf.toString());</span>
<span class="nc" id="L277">	}</span>

	public Collection getObjectsWithExactMatch(TOHoursPerDay hoursPerDay) throws Exception {
<span class="nc" id="L280">		StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L281">		buf.append(&quot; TIMEOFFEVENTID is not null AND EMPLOYEEID= &quot;).append(hoursPerDay.getEmployeeID().toInt());</span>
<span class="nc" id="L282">		buf.append(&quot; AND STARTTIME ='&quot;).append(JdmoUtil.formatDBString(hoursPerDay.getStartTime())).append(&quot;' &quot;);</span>
<span class="nc" id="L283">		buf.append(&quot; AND ENDTIME ='&quot;).append(JdmoUtil.formatDBString(hoursPerDay.getEndTime())).append(&quot;' &quot;);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getObjects QRY= &quot; + buf.toString());</span>
<span class="nc" id="L285">		return getObjects(buf.toString());</span>
	}

	public Collection getObjects(Collection col, int columnId, TimeRange dateRange) throws Exception {

<span class="nc" id="L290">		JdmoPreparedStatementBuilder where = new JdmoPreparedStatementBuilder();</span>
<span class="nc" id="L291">		where.add(TOHoursPerDayFieldInfo.getColumnName(columnId));</span>
<span class="nc" id="L292">		where.add(&quot; in ? &quot;, col);</span>

<span class="nc" id="L294">		appendDateRangeClausePrepared(where, dateRange, &quot; AND &quot;);</span>

<span class="nc bnc" id="L296" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc" id="L297">			m_cat.debug(&quot;getObjects QRY= &quot; + where.toString());</span>
		}

<span class="nc" id="L300">		return getObjectsWhere(where);</span>
	}


	public Collection getTOHoursPerDayForTORequests(Collection empIDs, TimeRange dateRange) throws Exception {
<span class="nc" id="L305">		StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L306">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID)).append(&quot; IS NOT NULL &quot;);</span>
<span class="nc" id="L307">		appendDateRangeClause(buf, dateRange, &quot; AND &quot;);</span>
<span class="nc" id="L308">		appendEmpIdsClause(buf, empIDs, &quot; AND &quot;);</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getTOHoursPerDayForTORequests QRY= &quot; + buf.toString());</span>
<span class="nc" id="L310">		return getObjects(buf.toString());</span>
	}

	public Collection getHoursPerDayForTOevents(Collection empIDs, Collection activityIDs, TimeRange dateRange) throws Exception {
<span class="nc" id="L314">		JdmoPreparedStatementBuilder where = new JdmoPreparedStatementBuilder();</span>

<span class="nc" id="L316">		where.add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID)).add(&quot; IS NOT NULL &quot;);</span>

<span class="nc" id="L318">		return getObjectsUsingPrepared(empIDs, activityIDs, dateRange, where);</span>
	}

	private Collection&lt;TOHoursPerDay&gt; getObjectsUsingPrepared(Collection empIDs, Collection activityIDs, TimeRange dateRange,
			JdmoPreparedStatementBuilder where)
			throws BbmFinderException {
		
<span class="nc" id="L325">		appendDateRangeClausePrepared(where, dateRange, &quot; AND &quot;);</span>
<span class="nc" id="L326">		appendActivityIdsClausePrepared(where, activityIDs, &quot; AND &quot;);</span>
<span class="nc" id="L327">		appendEmpIdsClausePrepared(where, empIDs, &quot; AND &quot;);</span>
<span class="nc" id="L328">		return getObjectsWhere(where);</span>
	}



	public HashMap getHoursPerDayForCalendar(Collection empIDs, Collection activityIDs, TimeRange dateRange, boolean schedOrPending) throws Exception {
<span class="nc" id="L334">		JdmoPreparedStatementBuilder where = new JdmoPreparedStatementBuilder(&quot;(&quot;);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">		if (schedOrPending) {  //if true ; then get scheduled or used TOEvents only</span>
<span class="nc" id="L336">			where.add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID))</span>
<span class="nc" id="L337">					.add(&quot; IS NOT NULL &quot;);</span>
		} else {         // if false then get Pending TO Choices only
<span class="nc" id="L339">			where.add(&quot;(&quot;).add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID))</span>
<span class="nc" id="L340">					.add(&quot; is not NULL AND &quot;);</span>
<span class="nc" id="L341">			where.add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_TIMEOFFCHOICERANK)).add(&quot;=1 AND &quot;);</span>
<span class="nc" id="L342">			where.add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_STATUS)).add(&quot; in &quot;);</span>
<span class="nc" id="L343">			where.add(getInClauseTOPendingStatuses()).add(&quot;) AND &quot;);</span>
<span class="nc" id="L344">			where.add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_D_EXPIRYDATE)).add(&quot;&gt;'&quot;);</span>
<span class="nc" id="L345">			where.add(JdmoUtil.formatDBString(new Date())).add(&quot;' &quot;);</span>

		}
<span class="nc" id="L348">		where.add(&quot;) &quot;);</span>

<span class="nc" id="L350">		Collection&lt;TOHoursPerDay&gt; toHoursPerDays = getObjectsUsingPrepared(empIDs, activityIDs, dateRange, where);</span>
<span class="nc" id="L351">		return TOHoursPerDayUtil.groupByField(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_B_ISDIRTY, toHoursPerDays);</span>
	}

<span class="nc" id="L354">	private static String pendingStatusInClause = null;</span>

	private String getInClauseTOPendingStatuses() {
<span class="nc bnc" id="L357" title="All 2 branches missed.">		if (pendingStatusInClause == null) {</span>
<span class="nc" id="L358">			StringBuffer sbPendingClause = new StringBuffer();</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">			for (int i = 0; i &lt; TORequest.PENDING_HOUR_STATUSES.length; i++) {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">				sbPendingClause.append((i == 0 ? &quot;(&quot; : &quot;,&quot;));</span>
<span class="nc" id="L361">				sbPendingClause.append(TOHoursPerDay.convertStatusToIntVal(TORequest.PENDING_HOUR_STATUSES[i]));</span>
			}
<span class="nc" id="L363">			sbPendingClause.append(&quot;)&quot;);</span>
<span class="nc" id="L364">			pendingStatusInClause = sbPendingClause.toString();</span>
		}
<span class="nc" id="L366">		return pendingStatusInClause;</span>
	}

	private void appendDateRangeClausePrepared(JdmoPreparedStatementBuilder where, TimeRange dateRange, String appendStr) {
<span class="nc" id="L370">		appendDateRangeClausePrepared(where, dateRange, appendStr, true);</span>
<span class="nc" id="L371">	}</span>

	// if overlap==true, then the ENDTIME clause uses &gt;=, otherwise strictly =
	private void appendDateRangeClausePrepared(JdmoPreparedStatementBuilder where, TimeRange dateRange, String appendStr, boolean overlap) {
<span class="nc bnc" id="L375" title="All 2 branches missed.">		if (dateRange == null) {</span>
<span class="nc" id="L376">			return;</span>
		}
<span class="nc bnc" id="L378" title="All 2 branches missed.">		if (appendStr != null) {</span>
<span class="nc" id="L379">			where.add(appendStr);</span>
		}
<span class="nc" id="L381">		where.add(&quot; STARTTIME &lt;= ?  AND &quot;, dateRange.getEndDate());</span>
<span class="nc" id="L382">		where.add(&quot; ENDTIME &gt;&quot;);</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">		if (overlap) {</span>
<span class="nc" id="L384">			where.add(&quot;=&quot;);</span>
		}
<span class="nc" id="L386">		where.add(&quot; ?&quot;, dateRange.getStartDate());</span>
<span class="nc" id="L387">	}</span>

	// return the requests spanning by date range
	//if StartDate !=null then  will return all requests that end after this date
	//if endDate !=null then will return all requests that start before this date.
	private void appendDateRangeClause(StringBuffer buf, TimeRange dateRange, String appendStr) {
<span class="nc" id="L393">		appendDateRangeClause(buf,dateRange,appendStr,true);</span>
<span class="nc" id="L394">	}</span>

	// if overlap==true, then the ENDTIME clause uses &gt;=, otherwise strictly =
	private void appendDateRangeClause(StringBuffer buf, TimeRange dateRange, String appendStr, boolean overlap) {
<span class="nc bnc" id="L398" title="All 2 branches missed.">		if (dateRange != null) {</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">			if (appendStr != null) {</span>
<span class="nc" id="L400">				buf.append(appendStr);</span>
			}
<span class="nc" id="L402">			buf.append(&quot; STARTTIME &lt;= '&quot;).append(JdmoUtil.formatDBString(dateRange.getEndDate())).append(&quot;' AND &quot;);</span>
<span class="nc" id="L403">			buf.append(&quot; ENDTIME &gt;&quot;);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">			if (overlap) {</span>
<span class="nc" id="L405">				buf.append(&quot;=&quot;);</span>
			}
<span class="nc" id="L407">			buf.append(&quot; '&quot;).append(JdmoUtil.formatDBString(dateRange.getStartDate())).append(&quot;' &quot;);</span>
		}
<span class="nc" id="L409">	}</span>

	private static boolean validIds(Collection&lt;?&gt; ids) {
<span class="nc bnc" id="L412" title="All 4 branches missed.">		if (ids != null &amp;&amp; !ids.isEmpty()) {</span>
<span class="nc bnc" id="L413" title="All 4 branches missed.">			if (ids.size() == 1 &amp;&amp; ids.iterator().next() == null) {</span>
<span class="nc" id="L414">				return false;</span>
			}
<span class="nc" id="L416">			return true;</span>
		}
<span class="nc" id="L418">		return false;</span>
	}

	private void appendActivityIdsClause(StringBuffer buf, Collection activityIDs, String appendStr) throws Exception {
<span class="nc bnc" id="L422" title="All 2 branches missed.">		if (validIds(activityIDs)) {</span>

<span class="nc bnc" id="L424" title="All 2 branches missed.">			if (appendStr != null) {</span>
<span class="nc" id="L425">				buf.append(appendStr);</span>
			}
<span class="nc" id="L427">			buf.append(&quot; A.&quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_ACTIVITYID));</span>
<span class="nc" id="L428">			buf.append(&quot; in &quot;).append(m_dmo.createInClause(activityIDs));</span>
		}
<span class="nc" id="L430">	}</span>

	private void appendEmpIdsClause(StringBuffer buf, Collection empIDs, String appendStr) throws Exception {
<span class="nc bnc" id="L433" title="All 2 branches missed.">		if (validIds(empIDs)) {</span>

<span class="nc bnc" id="L435" title="All 2 branches missed.">			if (appendStr != null) {</span>
<span class="nc" id="L436">				buf.append(appendStr);</span>
			}
<span class="nc" id="L438">			buf.append(&quot; A.&quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_EMPLOYEEID));</span>
<span class="nc" id="L439">			buf.append(&quot; in &quot;).append(m_dmo.createInClause(empIDs));</span>
		}
<span class="nc" id="L441">	}</span>

	private void appendActivityIdsClausePrepared(JdmoPreparedStatementBuilder where, Collection activityIDs, String appendStr) {
<span class="nc bnc" id="L444" title="All 2 branches missed.">		if (validIds(activityIDs)) {</span>

<span class="nc bnc" id="L446" title="All 2 branches missed.">			if (appendStr != null) {</span>
<span class="nc" id="L447">				where.add(appendStr);</span>
			}
<span class="nc" id="L449">			where.add(&quot; A.&quot;).add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_ACTIVITYID));</span>
<span class="nc" id="L450">			where.add(&quot; in ? &quot;, activityIDs);</span>
		}
<span class="nc" id="L452">	}</span>

	private void appendEmpIdsClausePrepared(JdmoPreparedStatementBuilder where, Collection empIDs, String appendStr) {
<span class="nc bnc" id="L455" title="All 2 branches missed.">		if (validIds(empIDs)) {</span>

<span class="nc bnc" id="L457" title="All 2 branches missed.">			if (appendStr != null) {</span>
<span class="nc" id="L458">				where.add(appendStr);</span>
			}
<span class="nc" id="L460">			where.add(&quot; A.&quot;).add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_EMPLOYEEID));</span>
<span class="nc" id="L461">			where.add(&quot; in ? &quot;, empIDs);</span>
		}
<span class="nc" id="L463">	}</span>

	public Collection getValidHoursPerDayForEmpIds(Collection empIDs, Collection activityIDs, TimeRange dateRange) throws Exception {
<span class="nc" id="L466">		JdmoPreparedStatementBuilder where = new JdmoPreparedStatementBuilder();</span>
<span class="nc" id="L467">		where.add(getValidHoursPerDayClause(false));</span>

<span class="nc bnc" id="L469" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled())</span>
<span class="nc" id="L470">			m_cat.debug(&quot;getHoursPerDayForEmpIds QRY= &quot; + where.toString());</span>
<span class="nc" id="L471">		return getObjectsUsingPrepared(empIDs, activityIDs, dateRange, where);</span>
	}




	private String getValidHoursPerDayClause(boolean addAnd) {
<span class="nc" id="L478">		StringBuilder validStatusClause = new StringBuilder();</span>

<span class="nc bnc" id="L480" title="All 2 branches missed.">		if (addAnd) {</span>
<span class="nc" id="L481">			validStatusClause.append(&quot; AND &quot;);</span>
		}

<span class="nc" id="L484">		validStatusClause.append(&quot; A.&quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_STATUS));</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">		for (int i = 0; i &lt; TORequest.PENDING_HOUR_STATUSES.length; i++) {</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">			validStatusClause.append((i == 0 ? &quot; IN (&quot; : &quot;,&quot;));</span>
<span class="nc" id="L487">			validStatusClause.append(TOHoursPerDay.convertStatusToIntVal(TORequest.PENDING_HOUR_STATUSES[i]));</span>
		}
<span class="nc" id="L489">		validStatusClause.append(&quot;,&quot;).append(TOHoursPerDay.convertStatusToIntVal(RequestAuditTrail.STATUS_APPROVED));</span>
<span class="nc" id="L490">		validStatusClause.append(&quot;,&quot;).append(TOHoursPerDay.convertStatusToIntVal(RequestAuditTrail.STATUS_DENIED));</span>
<span class="nc" id="L491">		validStatusClause.append(&quot;) &quot;);</span>
<span class="nc" id="L492">		return validStatusClause.toString();</span>
	}

	public Collection getHoursPerDayForEmpAfterGivenDate(ID empID, Collection activityIDs, Date pubDate, boolean activeOnly) throws Exception {
<span class="nc" id="L496">		StringBuffer buf = new StringBuffer(&quot; &quot;);</span>

<span class="nc" id="L498">		buf.append(&quot; ENDTIME &gt;= '&quot;).append(JdmoUtil.formatDBString(pubDate)).append(&quot;' &quot;);</span>
<span class="nc" id="L499">		appendActivityIdsClause(buf, activityIDs, &quot; AND &quot;);</span>
<span class="nc" id="L500">		appendEmpIdsClause(buf, Collections.singleton(empID), &quot; AND &quot;);</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getHoursPerDayForEmpAfterGivenDate QRY= &quot; + buf.toString());</span>
<span class="nc" id="L502">		return getObjects(buf.toString());</span>
	}

	public void refershTOEventsHavingFixedMinutes(HashMap toEventIDHrsPerDayMap) throws Exception {
		/*
		StringBuffer strSQL = new StringBuffer(&quot; SELECT ID, COUNTSMINSTOWARDSRULES from CALENDAREVENTASSIGNMENTPUB where ID in &quot;);
		strSQL.append(&quot; in &quot;).append(m_dmo.createInClause(toChoiceHrsPerDayMap.keySet()));
		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;refreshStatusForTOChoices QRY= &quot; + strSQL.toString());
		JdmoRowset rs = m_dmo.createRowset(strSQL.toString());
		while (rs.next()) {
			ID eventID = rs.getID(1);
			TOHoursPerDay hrsPerDay = (TOHoursPerDay) toChoiceHrsPerDayMap.get(eventID);
			hrsPerDay.setTotalMinutes(rs.getInt(2));
		}    */
<span class="nc" id="L516">	}</span>

	public Collection getAllDirtyTOHoursPerDay(Collection empIDs) throws Exception {
<span class="nc" id="L519">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L520">		buf.append(&quot; A.ISDIRTY = 1 &quot;);</span>
<span class="nc" id="L521">		appendEmpIdsClause(buf, empIDs, &quot; AND &quot;);</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getAllDirtyTOHoursPerDay QRY= &quot; + buf.toString());</span>
<span class="nc" id="L523">		return getObjects(buf.toString());</span>
	}

	public int getCountOfAllDirtyTOHoursPerDay() throws Exception {
<span class="nc" id="L527">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L528">		buf.append(&quot;Select Count(1)  &quot;);</span>
<span class="nc" id="L529">		appendFromWhereStatement(buf);</span>
<span class="nc" id="L530">		buf.append(&quot; WHERE A.ISDIRTY = 1 &quot;);</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getCountOfAllDirtyTOHoursPerDay QRY= &quot; + buf.toString());</span>
<span class="nc" id="L532">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc" id="L533">		int count = -1;</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L535">			count = rs.getInt(1);</span>
		}
<span class="nc" id="L537">		return count;</span>
	}


	public void insertLastPublishedDate(Collection empIDs, Jdmo jdmo) throws JdmoException {
<span class="nc bnc" id="L542" title="All 2 branches missed.">		if (jdmo == null) {</span>
<span class="nc" id="L543">			jdmo = m_dmo;</span>
		}
<span class="nc bnc" id="L545" title="All 4 branches missed.">		if (empIDs == null || empIDs.isEmpty()) {</span>
<span class="nc" id="L546">			return;</span>
		}
<span class="nc" id="L548">		Date date = new Date();</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">		for (Iterator iterator = empIDs.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L550">			ID empID = (ID) iterator.next();</span>
<span class="nc" id="L551">			jdmo.addBatch(&quot; INSERT INTO EMPLOYEELASTPUBDATE (ID,LASTPUBLISHEDDATE) VALUES (&quot; + empID.toInt() + &quot;,'&quot; + JdmoUtil.formatDBString(date) + &quot;')&quot;);</span>
<span class="nc" id="L552">		}</span>
<span class="nc" id="L553">		jdmo.executeBatch();</span>
<span class="nc" id="L554">	}</span>

	public void refreshLastPublishedDate(Collection empIDs) throws JdmoException {
<span class="nc" id="L557">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L558">		buf.append(&quot; UPDATE EMPLOYEELASTPUBDATE SET LASTPUBLISHEDDATE =  &quot;);</span>
<span class="nc" id="L559">		buf.append(&quot; (SELECT MAX(STARTTIME) LASTPUBLISHEDDATE FROM SHIFTASSIGNMENTPUB WHERE WORKRESOURCEID= EMPLOYEELASTPUBDATE.ID) &quot;);</span>
<span class="nc" id="L560">		buf.append(&quot; WHERE EMPLOYEELASTPUBDATE.ID IN (SELECT WORKRESOURCEID FROM SHIFTASSIGNMENTPUB WHERE &quot;);</span>
<span class="nc" id="L561">		buf.append(&quot; WORKRESOURCEID IN &quot;).append(m_dmo.createInClause(empIDs)).append(&quot;)&quot;);</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;refreshLastPublishedDate QRY= &quot; + buf.toString());</span>
<span class="nc" id="L563">		m_dmo.executeCommand(buf.toString());</span>
<span class="nc" id="L564">	}</span>

	public void lockEmployees(Collection empIDs) throws JdmoException {
<span class="nc" id="L567">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L568">		buf.append(&quot;UPDATE EMPLOYEELASTPUBDATE SET ID=ID WHERE ID IN &quot;).append(m_dmo.createInClause(empIDs));</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;lockEmployees QRY= &quot; + buf.toString());</span>
<span class="nc" id="L570">		m_dmo.executeCommand(buf.toString());</span>
<span class="nc" id="L571">	}</span>

	public Collection getHoursPerDayForEmpsBetweenLastPubDateAndGivenDate(Collection empIDs, Collection activityIDs, Date endDate) throws Exception {
<span class="nc" id="L574">		StringBuffer buf = new StringBuffer(256);</span>
		//insertLastPublishedDate(empIDs);
<span class="nc" id="L576">		buf.append(getSelectStatement());</span>
<span class="nc" id="L577">		appendFromWhereStatement(buf);</span>
<span class="nc" id="L578">		buf.append(&quot; , EMPLOYEELASTPUBDATE B &quot;);</span>
<span class="nc" id="L579">		buf.append(&quot;  WHERE ENDTIME &gt;=  B.LASTPUBLISHEDDATE  AND B.ID = A.&quot;);</span>
<span class="nc" id="L580">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_EMPLOYEEID));</span>
<span class="nc" id="L581">		appendActivityIdsClause(buf, activityIDs, &quot; AND &quot;);</span>
<span class="nc" id="L582">		appendEmpIdsClause(buf, empIDs, &quot; AND &quot;);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">		if (endDate != null) {</span>
<span class="nc" id="L584">			buf.append(&quot; AND &quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_D_STARTTIME));</span>
<span class="nc" id="L585">			buf.append(&quot;&lt;= '&quot;).append(JdmoUtil.formatDBString(endDate)).append(&quot;' &quot;);</span>
		}
<span class="nc" id="L587">		buf.append(getValidHoursPerDayClause(true));</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getHoursPerDayForEmpsBetweenLastPubDateAndGivenDate QRY= &quot; + buf.toString());</span>
<span class="nc" id="L589">		return getObjectsFromFullSqlQuery(buf.toString());</span>
	}

	public Collection getValidHoursPerDayForDateRangeOnlyAfterLastPubDate(Collection empIDs, Collection activityIDs, TimeRange dateRange) throws Exception {
<span class="nc" id="L593">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L594">		buf.append(getSelectStatement());</span>
<span class="nc" id="L595">		appendFromWhereStatement(buf);</span>
<span class="nc" id="L596">		buf.append(&quot; , EMPLOYEELASTPUBDATE B &quot;);</span>
<span class="nc" id="L597">		buf.append(&quot;  WHERE ENDTIME &gt;=  B.LASTPUBLISHEDDATE  AND B.ID = A.&quot;);</span>
<span class="nc" id="L598">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_EMPLOYEEID));</span>
<span class="nc" id="L599">		appendActivityIdsClause(buf, activityIDs, &quot; AND &quot;);</span>
<span class="nc" id="L600">		appendEmpIdsClause(buf, empIDs, &quot; AND &quot;);</span>
<span class="nc" id="L601">		buf.append(getValidHoursPerDayClause(true));</span>
<span class="nc" id="L602">		appendDateRangeClause(buf, dateRange, &quot; AND &quot;);</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getValidHoursPerDayForDateRangeOnlyAfterLastPubDate QRY= &quot; + buf.toString());</span>
<span class="nc" id="L604">		return getObjectsFromFullSqlQuery(buf.toString());</span>
	}

	private Collection getObjectsFromFullSqlQuery(String strSql) throws BbmFinderException {
<span class="nc" id="L608">		ArrayList arrItems = new ArrayList();</span>
		try {
<span class="nc" id="L610">			JdmoRowset rs = m_dmo.createRowset(strSql);</span>
<span class="nc" id="L611">			long lCount = m_lRecords;</span>
<span class="nc bnc" id="L612" title="All 4 branches missed.">			while (rs.next() &amp;&amp; (lCount != 0)) {</span>
<span class="nc" id="L613">				ValueObjectBase item = readObjectFromDB(rs);</span>
<span class="nc" id="L614">				arrItems.add(item);</span>
<span class="nc" id="L615">				lCount--;</span>
<span class="nc" id="L616">			}</span>
<span class="nc" id="L617">		} catch (Exception e) {</span>
<span class="nc" id="L618">			throw new BbmFinderException(e);</span>
<span class="nc" id="L619">		}</span>
<span class="nc" id="L620">		return arrItems;</span>
	}

	public void deleteTOHoursPerDayOnUnPublish(Collection empIDs, Date startDate, Date endDate) throws JdmoException {
<span class="nc" id="L624">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L625">		buf.append(&quot; DELETE FROM TIMEOFFHOURSPERDAY WHERE TIMEOFFEVENTID IS NOT NULL AND &quot;);</span>
<span class="nc" id="L626">		buf.append(&quot; STARTTIME &lt; '&quot;).append(JdmoUtil.formatDBString(endDate)).append(&quot;' AND &quot;);</span>
<span class="nc" id="L627">		buf.append(&quot; ENDTIME &gt; '&quot;).append(JdmoUtil.formatDBString(startDate)).append(&quot;' AND &quot;);</span>
<span class="nc" id="L628">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_EMPLOYEEID));</span>
<span class="nc" id="L629">		buf.append(&quot; in &quot;).append(m_dmo.createInClause(empIDs));</span>
<span class="nc" id="L630">		buf.append(&quot; AND NOT EXISTS (SELECT ID FROM CALENDAREVENTATTENDEEPUB &quot;);</span>
<span class="nc" id="L631">		buf.append(&quot; WHERE WORKRESOURCEID=EMPLOYEEID AND	CALENDAREVENTASSIGNMENTID= TIMEOFFEVENTID) &quot;);</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;deleteTOHoursPerDayOnUnPublish QRY= &quot; + buf.toString());</span>
<span class="nc" id="L633">		m_dmo.executeCommand(buf.toString());</span>
<span class="nc" id="L634">	}</span>

	public boolean checkHealth() throws JdmoException {
<span class="nc" id="L637">		boolean retVal = true;</span>
<span class="nc" id="L638">		StringBuffer buf = new StringBuffer(1024);</span>
<span class="nc" id="L639">		buf.append(&quot; SELECT 'ORPHANED TO-EVENTS, Need to be DELETED' REASON,COUNT(*) COUNT    FROM TIMEOFFHOURSPERDAY  &quot;);</span>
<span class="nc" id="L640">		buf.append(&quot; WHERE TIMEOFFEVENTID IS NOT NULL AND &quot;);</span>
<span class="nc" id="L641">		buf.append(&quot; NOT EXISTS (SELECT ID FROM CALENDAREVENTATTENDEEPUB  &quot;);</span>
<span class="nc" id="L642">		buf.append(&quot; WHERE WORKRESOURCEID=EMPLOYEEID AND CALENDAREVENTASSIGNMENTID= TIMEOFFEVENTID) &quot;);</span>
<span class="nc" id="L643">		buf.append(&quot; UNION &quot;);</span>
<span class="nc" id="L644">		buf.append(&quot; SELECT  'ORPHANED TO-CHOICES, Need to be DELETED' REASON,  COUNT(*) COUNT FROM TIMEOFFHOURSPERDAY  &quot;);</span>
<span class="nc" id="L645">		buf.append(&quot; WHERE TIMEOFFCHOICEID IS NOT NULL AND &quot;);</span>
<span class="nc" id="L646">		buf.append(&quot; NOT EXISTS (SELECT ID from TIMEOFFREQUESTCHOICE C where C.id= TIMEOFFCHOICEID) &quot;);</span>
<span class="nc" id="L647">		buf.append(&quot; UNION &quot;);</span>
<span class="nc" id="L648">		buf.append(&quot; SELECT  'INVALID ROWS, Need to be DELETED' REASON,  COUNT(*) COUNT FROM TIMEOFFHOURSPERDAY  &quot;);</span>
<span class="nc" id="L649">		buf.append(&quot; WHERE (TIMEOFFCHOICEID IS  NULL and TIMEOFFEVENTID is null) OR ( TIMEOFFCHOICEID IS  NOT NULL and TIMEOFFEVENTID is NOT null) &quot;);</span>
<span class="nc" id="L650">		buf.append(&quot; UNION &quot;);</span>
<span class="nc" id="L651">		buf.append(&quot; SELECT  'MISSING TO-EVENTS, Need to be ADDED' REASON,  COUNT(*) COUNT FROM CALENDAREVENTATTENDEEPUB A,CALENDAREVENTASSIGNMENTPUB P  &quot;);</span>
<span class="nc" id="L652">		buf.append(&quot; WHERE P.EVENTTYPE=512 AND P.ID= A.CALENDAREVENTASSIGNMENTID AND &quot;);</span>
<span class="nc" id="L653">		buf.append(&quot; NOT EXISTS (SELECT ID FROM TIMEOFFHOURSPERDAY WHERE EMPLOYEEID=WORKRESOURCEID AND	CALENDAREVENTASSIGNMENTID= TIMEOFFEVENTID) &quot;);</span>
<span class="nc" id="L654">		buf.append(&quot; UNION &quot;);</span>
<span class="nc" id="L655">		buf.append(&quot; select  'MISSING TO-CHOICES, Need to be ADDED' REASON,  COUNT(*) COUNT from TIMEOFFREQUESTCHOICE c &quot;);</span>
<span class="nc" id="L656">		buf.append(&quot; where NOT EXISTS (SELECT ID FROM TIMEOFFHOURSPERDAY WHERE TIMEOFFCHOICEID = c.id)  &quot;);</span>
<span class="nc" id="L657">		buf.append(&quot; UNION SELECT 'MISSING Entries in last pub date, Need to be ADDED' REASON,  COUNT(*) COUNT FROM EMPLOYEEAM &quot;);</span>
<span class="nc" id="L658">		buf.append(&quot; WHERE not EXISTS (SELECT ID FROM EMPLOYEELASTPUBDATE WHERE EMPLOYEELASTPUBDATE.ID=EMPLOYEEAM.ID) &quot;);</span>
<span class="nc" id="L659">		buf.append(&quot; UNION &quot;);</span>
<span class="nc" id="L660">		buf.append(&quot; SELECT 'DUPLICATE TOEVENTS  , Need to be Deleted', COUNT(*) COUNT FROM TIMEOFFHOURSPERDAY WHERE TIMEOFFEVENTID IN  &quot;);</span>
<span class="nc" id="L661">		buf.append(&quot; (SELECT TIMEOFFEVENTID 	FROM TIMEOFFHOURSPERDAY WHERE TIMEOFFEVENTID IS NOT NULL  &quot;);</span>
<span class="nc" id="L662">		buf.append(&quot; GROUP BY TIMEOFFEVENTID ,EMPLOYEEID HAVING COUNT(*) &gt;1 	) &quot;);</span>
<span class="nc" id="L663">		buf.append(&quot; UNION  &quot;);</span>
<span class="nc" id="L664">		buf.append(&quot; SELECT 'DUPLICATE TOCHOICES, Need to be Deleted', COUNT(*) COUNT FROM TIMEOFFHOURSPERDAY WHERE TIMEOFFCHOICEID IN  &quot;);</span>
<span class="nc" id="L665">		buf.append(&quot; (SELECT TIMEOFFCHOICEID 	FROM TIMEOFFHOURSPERDAY WHERE TIMEOFFCHOICEID IS NOT NULL  &quot;);</span>
<span class="nc" id="L666">		buf.append(&quot; GROUP BY TIMEOFFCHOICEID ,EMPLOYEEID HAVING COUNT(*) &gt;1 	) &quot;);</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;checkHealth QRY= &quot; + buf.toString());</span>
<span class="nc" id="L668">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc" id="L669">		StringBuffer sb = new StringBuffer();</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L671">			int intVal = rs.getInt(2);</span>
<span class="nc" id="L672">			sb.append(&quot;\n&quot; + rs.getString(1) + &quot;\t = &quot; + intVal);</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">			if (intVal &gt; 0) {</span>
<span class="nc" id="L674">				retVal = false;</span>
			}
<span class="nc" id="L676">		}</span>
<span class="nc" id="L677">		m_cat.info(&quot;Check Health Status=&quot; + retVal + &quot; : TOHoursPerDay=&quot; + sb.toString());</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;Check Health Status=&quot; + retVal + &quot; : TOHoursPerDay=&quot; + sb.toString());</span>
<span class="nc" id="L679">		return retVal;</span>
	}

	public Collection refreshStatusForTOChoices(Collection toHrsPerDayCol) throws JdmoException {
<span class="nc" id="L683">		HashMap toChoiceHrsPerDayMap = ValueObjectUtil.getFieldObjectMap(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID, toHrsPerDayCol);</span>
<span class="nc bnc" id="L684" title="All 4 branches missed.">		if (toChoiceHrsPerDayMap == null || toChoiceHrsPerDayMap.isEmpty()) {</span>
<span class="nc" id="L685">			return toHrsPerDayCol;// nothing to update here return back</span>
		}
<span class="nc" id="L687">		StringBuffer strSQL = new StringBuffer();</span>
<span class="nc" id="L688">		strSQL.append(&quot;SELECT C.ID,R.REQUESTSTATUS FROM REQUEST R, TIMEOFFREQUESTCHOICE C WHERE R.ID=C.TIMEOFFREQUESTID and C.ID  in  &quot;);</span>
<span class="nc" id="L689">		strSQL.append(m_dmo.createInClause(toChoiceHrsPerDayMap.keySet()));</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;refreshStatusForTOChoices QRY= &quot; + strSQL.toString());</span>
<span class="nc" id="L691">		JdmoRowset rs = m_dmo.createRowset(strSQL.toString());</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L693">			ID choiceID = rs.getID(1);</span>
<span class="nc" id="L694">			TOHoursPerDay hrsPerDay = (TOHoursPerDay) toChoiceHrsPerDayMap.get(choiceID);</span>
<span class="nc" id="L695">			String status = rs.getString(2);</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">			if (!hrsPerDay.getStatus().equals(status)) {</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">				if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;chaning status for choiceid= &quot; + choiceID + &quot; : hrsPerDay Status=&quot; + hrsPerDay.getStatus() + &quot;: orig status=&quot; + status);</span>
<span class="nc" id="L698">				hrsPerDay.setStatus(status);</span>
			}
<span class="nc" id="L700">		}</span>
<span class="nc" id="L701">		return toHrsPerDayCol;</span>
	}

	//Pass True for Schedule &amp; false for Pending
	public void getHoursPerDayContainedInDateRange(HashMap activitySummaryMap, ID empID, Date startDate, Date endDate, boolean schedOrPending) throws Exception {
<span class="nc" id="L706">		StringBuffer buf = new StringBuffer(&quot;SELECT ACTIVITYID , SUM(TOTALMINUTES) TOTAL_MINUTES FROM &quot;).append(m_fieldInfo.getTableName()).append(&quot; (&quot;);</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">		if (schedOrPending) {  //if true ; then get scheduled or used TOEvents only</span>
<span class="nc" id="L708">			buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID)).append(&quot; IS NOT NULL &quot;);</span>
		} else {         // if false then get Pending TO Choices only
<span class="nc" id="L710">			buf.append(&quot;(&quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID)).append(&quot; is not NULL AND &quot;);</span>
<span class="nc" id="L711">			buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_TIMEOFFCHOICERANK)).append(&quot;=1 AND &quot;);</span>
<span class="nc" id="L712">			buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_STATUS)).append(&quot; in &quot;);</span>
<span class="nc" id="L713">			buf.append(getInClauseTOPendingStatuses()).append(&quot;) AND &quot;);</span>
<span class="nc" id="L714">			buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_D_EXPIRYDATE)).append(&quot;&gt;'&quot;);</span>
<span class="nc" id="L715">			buf.append(JdmoUtil.formatDBString(new Date())).append(&quot;' &quot;);</span>
		}
<span class="nc" id="L717">		buf.append(&quot;) AND&quot;);</span>
<span class="nc" id="L718">		buf.append(&quot; STARTTIME &gt;= '&quot;).append(JdmoUtil.formatDBString(startDate)).append(&quot;' AND &quot;);</span>
<span class="nc" id="L719">		buf.append(&quot; ENDTIME &lt;= '&quot;).append(JdmoUtil.formatDBString(endDate)).append(&quot;' &quot;);</span>
<span class="nc" id="L720">		appendActivityIdsClause(buf, activitySummaryMap.values(), &quot; AND &quot;);</span>
<span class="nc" id="L721">		appendEmpIdsClause(buf, Collections.singleton(empID), &quot; AND &quot;);</span>
<span class="nc" id="L722">		buf.append(&quot;GROUP BY &quot;).append(&quot; A.&quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_ACTIVITYID));</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getHoursPerDayForCalendar QRY= &quot; + buf.toString());</span>
<span class="nc" id="L724">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L726">			ID activityID = rs.getID(1);</span>
<span class="nc" id="L727">			TimeOffActivitySummary activitySummary = (TimeOffActivitySummary) activitySummaryMap.get(activityID);</span>
<span class="nc" id="L728">			float hours = (float) (rs.getDouble(2) / 60f);</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">			if (schedOrPending) {</span>
<span class="nc" id="L730">				activitySummary.setScheduled(hours);</span>
			} else {
<span class="nc" id="L732">				activitySummary.setPending(hours);</span>
			}
<span class="nc" id="L734">		}</span>
<span class="nc" id="L735">	}</span>

	public void updateStatusAndRankForTOChoices(Collection toHrsPerDayList) {

<span class="nc" id="L739">	}</span>

	public boolean isLastPublishedDateChanged(Collection empIDs) throws Exception {
<span class="nc" id="L742">		StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L743">		buf.append(&quot;  SELECT count(1) FROM EMPLOYEELASTPUBDATE P,  &quot;);</span>
<span class="nc" id="L744">		buf.append(&quot;  (SELECT MAX(STARTTIME) LASTPUBDATE,WORKRESOURCEID WORKRESOURCEID &quot;);</span>
<span class="nc" id="L745">		buf.append(&quot;  FROM SHIFTASSIGNMENTPUB WHERE WORKRESOURCEID IN &quot;).append(m_dmo.createInClause(empIDs));</span>
<span class="nc" id="L746">		buf.append(&quot; group by WORKRESOURCEID)A  &quot;);</span>
<span class="nc" id="L747">		buf.append(&quot;  WHERE P.ID = A.WORKRESOURCEID AND P.LASTPUBLISHEDDATE != A.LASTPUBDATE &quot;);</span>
<span class="nc" id="L748">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc" id="L749">		int count = -1;</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L751">			count = rs.getInt(1);</span>
		}
<span class="nc bnc" id="L753" title="All 2 branches missed.">		boolean result = count &gt; 0;</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;isLastPublishedDateChanged result=&quot; + result + &quot; :QRY= &quot; + buf.toString());</span>
<span class="nc" id="L755">		return result;  //return true if rows changed is more than 0;</span>
	}

	public TimeRange findMinMaxTimeRangeOfApprovedTOEvents(ID empID, Collection activityIDs, TimeRange dateRange) throws Exception {
<span class="nc" id="L759">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L760">		buf.append(&quot; SELECT MIN(STARTTIME), MAX(ENDTIME) FROM &quot;);</span>
<span class="nc" id="L761">		buf.append(getFieldInfo().getTableName()).append(&quot; A WHERE &quot;);</span>
<span class="nc" id="L762">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID)).append(&quot; IS NOT NULL &quot;);</span>
<span class="nc" id="L763">		appendDateRangeClause(buf, dateRange, &quot; AND &quot;);</span>
<span class="nc" id="L764">		appendActivityIdsClause(buf, activityIDs, &quot; AND &quot;);</span>
<span class="nc" id="L765">		appendEmpIdsClause(buf, Collections.singleton(empID), &quot; AND &quot;);</span>
<span class="nc" id="L766">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc" id="L767">		TimeRange range = null;</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L769">			Date startDate = rs.getTimestamp(1);</span>
<span class="nc" id="L770">			Date endDate = rs.getTimestamp(2);</span>
<span class="nc bnc" id="L771" title="All 4 branches missed.">			if (startDate != null &amp;&amp; endDate != null) {</span>
<span class="nc" id="L772">				range = new TimeRange(startDate, endDate);</span>
			}
		}
<span class="nc" id="L775">		return range;</span>
	}

	public boolean checkIfNewTOEventsAreCommited(Collection eventIDs) throws Exception {
<span class="nc" id="L779">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L780">		buf.append(&quot; select count(ID) from CALENDAREVENTASSIGNMENTPUB where ID &quot;).append(&quot; in &quot;).append(m_dmo.createInClause(eventIDs));</span>
<span class="nc" id="L781">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc" id="L782">		int eventsInDB = -1;</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L784">			eventsInDB = rs.getInt(1);</span>
		}
<span class="nc bnc" id="L786" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;checkIfNewTOEventsAreCommited eventsInDB=&quot; + eventsInDB + &quot; :eventIDs= &quot; + eventIDs.size() + &quot; QRY=&quot; + buf.toString());</span>
<span class="nc bnc" id="L787" title="All 6 branches missed.">		return (eventIDs != null &amp;&amp; !eventIDs.isEmpty() &amp;&amp; eventsInDB == eventIDs.size());</span>
	}

	public Collection getMissingTOEventsToBeSynced() throws Exception {
<span class="nc" id="L791">		ArrayList arrItems = new ArrayList();</span>
<span class="nc" id="L792">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L793">		buf.append(&quot; SELECT CALENDAREVENTASSIGNMENTID,WORKRESOURCEID &quot;);//, ACTIVITYID, STARTTIME, ENDTIME, TIMEOFFRULE, COUNTSMINSTOWARDSRULES&quot;);</span>
<span class="nc" id="L794">		buf.append(&quot; FROM CALENDAREVENTATTENDEEPUB A,CALENDAREVENTASSIGNMENTPUB P &quot;);</span>
<span class="nc" id="L795">		buf.append(&quot; WHERE P.EVENTTYPE=512 AND P.ID= A.CALENDAREVENTASSIGNMENTID AND &quot;);</span>
<span class="nc" id="L796">		buf.append(&quot; NOT EXISTS (SELECT ID FROM TIMEOFFHOURSPERDAY &quot;);</span>
<span class="nc" id="L797">		buf.append(&quot; WHERE EMPLOYEEID=WORKRESOURCEID AND CALENDAREVENTASSIGNMENTID= TIMEOFFEVENTID)&quot;);</span>
<span class="nc" id="L798">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L800">			arrItems.add(new IDPair(rs.getID(&quot;CALENDAREVENTASSIGNMENTID&quot;), rs.getID(&quot;WORKRESOURCEID&quot;)));</span>
		}
<span class="nc" id="L802">		return arrItems;</span>
	}

	public Collection getMissingEntriesInLastPubDate() throws Exception {
<span class="nc" id="L806">		ArrayList arrItems = new ArrayList();</span>
<span class="nc" id="L807">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L808">		buf.append(&quot; SELECT ID FROM EMPLOYEEAM WHERE NOT EXISTS ( SELECT ID &quot;);</span>
<span class="nc" id="L809">		buf.append(&quot; FROM EMPLOYEELASTPUBDATE WHERE EMPLOYEELASTPUBDATE.ID=EMPLOYEEAM.ID) &quot;);</span>
<span class="nc" id="L810">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L812">			arrItems.add(rs.getID(&quot;ID&quot;));</span>
		}
<span class="nc" id="L814">		return arrItems;</span>
	}

	private String createTempTableToQueryTOHrPerDayForRange(Jdmo dmo, HashMap empIDStDateMap, HashMap empIDEnDateMap)
	        throws JdmoException, Exception {
		//create temp table to hold workresource, start and end, later it will join with event tables to get the events
<span class="nc" id="L820">		StringBuffer strSQL = new StringBuffer();</span>
<span class="nc" id="L821">		String strTableName = &quot;EMPTOHOURSPERDAYDATERANGE&quot;;</span>
<span class="nc" id="L822">		String strNativeTempName = dmo.getNativeTemptableName(strTableName);</span>

		// drop temp table just in case
		try {
<span class="nc" id="L826">			dmo.dropTempTable(strTableName);</span>
<span class="nc" id="L827">		} catch (Exception e) {</span>
			// do nothing
<span class="nc" id="L829">		}</span>
<span class="nc" id="L830">		strSQL.append(strNativeTempName);</span>
<span class="nc" id="L831">		strSQL.append(&quot; (EMPLOYEEID int, STARTTIME DATETIME , ENDTIME DATETIME )&quot;);</span>
<span class="nc" id="L832">		dmo.createTempTable(strSQL.toString());</span>

<span class="nc" id="L834">		JdmoPCommand pc = dmo.createPCommand(&quot;insert into &quot; + strNativeTempName + &quot; values (?,?,?)&quot;);</span>
<span class="nc" id="L835">		HashMap param = new HashMap();</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">		for (Iterator iter = empIDStDateMap.keySet().iterator(); iter.hasNext();) {</span>
<span class="nc" id="L837">			ID empId = (ID) iter.next();</span>
<span class="nc" id="L838">			param.clear();</span>
<span class="nc" id="L839">			param.put(new Integer(1), new Integer(empId.toInt()));</span>
<span class="nc" id="L840">			param.put(new Integer(2), ((Calendar) empIDStDateMap.get(empId)).getTime());</span>
<span class="nc" id="L841">			param.put(new Integer(3), ((Calendar) empIDEnDateMap.get(empId)).getTime());</span>
<span class="nc" id="L842">			pc.setParams(param);</span>
<span class="nc" id="L843">			pc.addBatch();</span>
<span class="nc" id="L844">		}</span>
<span class="nc" id="L845">		dmo.executeBatchPCommand(pc);</span>
<span class="nc" id="L846">		return strNativeTempName;</span>
	}

	public HashMap getHoursPerDayForRange(HashMap empStDateMap, HashMap empEnDateMap, Collection activityIDs) throws Exception {
<span class="nc bnc" id="L850" title="All 8 branches missed.">		if (empStDateMap == null || empStDateMap.isEmpty() || empEnDateMap == null || empEnDateMap.isEmpty()) {</span>
<span class="nc" id="L851">			m_cat.debug(&quot;one of  the Maps is empty&quot;);</span>
<span class="nc" id="L852">			return new HashMap();</span>
		}
<span class="nc" id="L854">		StringBuffer buf = getSelectStatement();</span>
<span class="nc" id="L855">		appendFromWhereStatement(buf);</span>
<span class="nc bnc" id="L856" title="All 4 branches missed.">		if (empStDateMap != null &amp;&amp; empStDateMap.size() &gt; 1) {</span>
<span class="nc" id="L857">			String tmpTable = createTempTableToQueryTOHrPerDayForRange(getDMO(), empStDateMap, empEnDateMap);</span>
<span class="nc" id="L858">			buf.append(&quot;, &quot;).append(tmpTable).append(&quot; C WHERE &quot;);</span>
<span class="nc" id="L859">			buf.append(&quot;  A.STARTTIME &lt;= C.ENDTIME AND A.ENDTIME &gt; C.STARTTIME AND A.EMPLOYEEID = C.EMPLOYEEID &quot;);</span>
<span class="nc" id="L860">		} else {</span>
<span class="nc" id="L861">			TimeRange dateRange = new TimeRange(((Calendar) empStDateMap.values().iterator().next()).getTime(),</span>
<span class="nc" id="L862">			        ((Calendar) empEnDateMap.values().iterator().next()).getTime());</span>
<span class="nc" id="L863">			appendDateRangeClause(buf, dateRange, &quot; WHERE &quot;, false);</span>
<span class="nc" id="L864">			appendEmpIdsClause(buf, empStDateMap.keySet(), &quot; AND &quot;);</span>
		}
<span class="nc" id="L866">		buf.append(&quot;AND ( &quot;);</span>
<span class="nc" id="L867">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID)).append(&quot; IS NOT NULL &quot;);</span>
		// pending clause
<span class="nc" id="L869">		buf.append(&quot;OR (&quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID)).append(&quot; is not NULL AND &quot;);</span>
<span class="nc" id="L870">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_TIMEOFFCHOICERANK)).append(&quot;=1 AND &quot;);</span>
<span class="nc" id="L871">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_STATUS)).append(&quot; in &quot;);</span>
<span class="nc" id="L872">		buf.append(getInClauseTOPendingStatuses()).append(&quot; AND &quot;);</span>
<span class="nc" id="L873">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_D_EXPIRYDATE)).append(&quot;&gt;'&quot;);</span>
<span class="nc" id="L874">		buf.append(JdmoUtil.formatDBString(new Date())).append(&quot;')) &quot;);</span>
<span class="nc" id="L875">		appendActivityIdsClause(buf, activityIDs, &quot; AND &quot;);</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getHoursPerDayForCalendar QRY= &quot; + buf.toString());</span>
<span class="nc" id="L877">		return TOHoursPerDayUtil.groupByField(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_B_ISDIRTY, getObjectsFromFullSqlQuery(buf.toString()));</span>
	}

	public void insertOrUpdateObjects(Collection toHoursPerDayToIns) throws Exception {
<span class="nc" id="L881">		Collection toHoursPerDayToUpdate = new ArrayList();</span>
<span class="nc" id="L882">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L883">		HashMap hrsPerDayMap = new HashMap();</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">		for (Iterator iterator = toHoursPerDayToIns.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L885">			TOHoursPerDay hoursPerDay = (TOHoursPerDay) iterator.next();</span>
<span class="nc" id="L886">			hrsPerDayMap.put(hoursPerDay.getUniqueKey(), hoursPerDay);</span>
<span class="nc" id="L887">		}</span>
<span class="nc" id="L888">		buf.append(&quot; SELECT H.ID, CAST(ISNULL( H.EMPLOYEEID,0) AS VARCHAR(15))+'_' + &quot;);</span>
<span class="nc" id="L889">		buf.append(&quot; CAST (ISNULL(H.TIMEOFFEVENTID,0)AS VARCHAR(15))+'_'+&quot;);</span>
<span class="nc" id="L890">		buf.append(&quot; CAST ( ISNULL(H.TIMEOFFCHOICEID,0)AS VARCHAR(15)) UNIQ_KEY FROM &quot;);</span>
<span class="nc" id="L891">		buf.append(createTempTableTOCheckForUniqueKey(toHoursPerDayToIns));</span>
<span class="nc" id="L892">		buf.append(&quot; T, TIMEOFFHOURSPERDAY H WHERE T.EMPLOYEEID= H.EMPLOYEEID &quot;);</span>
<span class="nc" id="L893">		buf.append(&quot; AND ISNULL(T.TIMEOFFEVENTID,0)= ISNULL(H.TIMEOFFEVENTID,0) &quot;);</span>
<span class="nc" id="L894">		buf.append(&quot; AND ISNULL(T.TIMEOFFCHOICEID,0)=ISNULL(H.TIMEOFFCHOICEID,0)&quot;);</span>
<span class="nc" id="L895">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L897">			TOHoursPerDay hoursPerDay = (TOHoursPerDay) hrsPerDayMap.remove(rs.getString(&quot;UNIQ_KEY&quot;));</span>
<span class="nc" id="L898">			hoursPerDay.setID(rs.getID(&quot;ID&quot;));</span>
<span class="nc" id="L899">			toHoursPerDayToUpdate.add(hoursPerDay);</span>
<span class="nc" id="L900">		}</span>
<span class="nc bnc" id="L901" title="All 4 branches missed.">		if (toHoursPerDayToUpdate != null &amp;&amp; !toHoursPerDayToUpdate.isEmpty()) {</span>
<span class="nc" id="L902">			updateObjects(toHoursPerDayToUpdate);</span>
		}
<span class="nc bnc" id="L904" title="All 4 branches missed.">		if (hrsPerDayMap != null &amp;&amp; !hrsPerDayMap.values().isEmpty()) {</span>
<span class="nc" id="L905">			createObjects(hrsPerDayMap.values());</span>
		}
<span class="nc" id="L907">	}</span>

	private String createTempTableTOCheckForUniqueKey(Collection toHoursPerDayToIns) throws JdmoException, Exception {
		//create temp table to hold workresource, start and end, later it will join with event tables to get the events
<span class="nc" id="L911">		StringBuffer strSQL = new StringBuffer();</span>
<span class="nc" id="L912">		String strTableName = &quot;NEWTOHOURSPERDAY&quot;;</span>
<span class="nc" id="L913">		Jdmo dmo = getDMO();</span>
<span class="nc" id="L914">		String strNativeTempName = dmo.getNativeTemptableName(strTableName);</span>
		// drop temp table just in case
		try {
<span class="nc" id="L917">			dmo.dropTempTable(strTableName);</span>
<span class="nc" id="L918">		} catch (Exception e) {}</span>
<span class="nc" id="L919">		strSQL.append(strNativeTempName);</span>
<span class="nc" id="L920">		strSQL.append(&quot; (EMPLOYEEID int, TIMEOFFEVENTID INT , TIMEOFFCHOICEID INT )&quot;);</span>
<span class="nc" id="L921">		dmo.createTempTable(strSQL.toString());</span>

<span class="nc" id="L923">		JdmoPCommand pc = dmo.createPCommand(&quot;insert into &quot; + strNativeTempName + &quot; values (?,?,?)&quot;);</span>
<span class="nc" id="L924">		HashMap param = new HashMap();</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">		for (Iterator iterator = toHoursPerDayToIns.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L926">			TOHoursPerDay hoursPerDay = (TOHoursPerDay) iterator.next();</span>
<span class="nc" id="L927">			param.clear();</span>
<span class="nc" id="L928">			param.put(new Integer(1), new Integer(hoursPerDay.getEmployeeID().toInt()));</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">			param.put(new Integer(2), new Integer(hoursPerDay.getTOEventID() != null ? hoursPerDay.getTOEventID().toInt() : 0));</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">			param.put(new Integer(3), new Integer(hoursPerDay.getTOChoiceID() != null ? hoursPerDay.getTOChoiceID().toInt() : 0));</span>
<span class="nc" id="L931">			pc.setParams(param);</span>
<span class="nc" id="L932">			pc.addBatch();</span>
<span class="nc" id="L933">		}</span>
<span class="nc" id="L934">		dmo.executeBatchPCommand(pc);</span>
<span class="nc" id="L935">		return strNativeTempName;</span>
	}

	public String getOrderedTOWaitlistsQry(TOPool pool, Collection empIds, Date stDate, Date enDate) throws Exception {

<span class="nc" id="L940">		Date now = new Date();</span>
<span class="nc" id="L941">		String nowStr = &quot; '&quot; + JdmoUtil.formatDBString(now) + &quot;' &quot;;</span>
<span class="nc" id="L942">		StringBuffer selectClause = new StringBuffer();</span>
<span class="nc" id="L943">		selectClause.append(&quot; SELECT DISTINCT A.*,C.TIMEOFFREQUESTID &quot;);</span>
		//Add Select columns for sort

		//Add additonal tables
<span class="nc" id="L947">		StringBuffer fromClause = new StringBuffer();</span>
<span class="nc" id="L948">		fromClause.append(&quot; FROM WORKRESOURCETOPOOL WRO , TIMEOFFREQUESTCHOICE C, TIMEOFFHOURSPERDAY A ,REQUEST REQ &quot;);</span>

<span class="nc" id="L950">		StringBuffer whereClause = new StringBuffer();</span>
		//WHERE Clause
<span class="nc" id="L952">		whereClause.append(&quot; WHERE REQ.EMPLOYEEID = WRO.WORKRESOURCEID AND C.TIMEOFFREQUESTID=REQ.ID &quot;);</span>
<span class="nc" id="L953">		whereClause.append(&quot; AND A.TIMEOFFCHOICEID=C.ID AND A.TIMEOFFCHOICERANK=1 AND A.STATUS=8 &quot;);</span>
<span class="nc" id="L954">		whereClause.append(&quot; AND (A.STARTTIME&lt;WRO.ENDTIME OR WRO.ENDTIME IS NULL) AND A.STARTTIME&gt;=WRO.STARTTIME &quot;);</span>
<span class="nc" id="L955">		whereClause.append(&quot; AND A.STARTTIME &lt; '&quot;).append(JdmoUtil.formatDBString(enDate)).append(&quot;'&quot;);</span>
<span class="nc" id="L956">		whereClause.append(&quot; AND A.ENDTIME &gt; '&quot;).append(JdmoUtil.formatDBString(stDate)).append(&quot;' &quot;);</span>
<span class="nc" id="L957">		whereClause.append(&quot; AND WRO.TOPOOLID  = &quot;).append(pool.getID().toInt());</span>
<span class="nc" id="L958">		appendEmpIdsClause(whereClause, empIds, &quot; AND &quot;);</span>

<span class="nc" id="L960">		whereClause.append(&quot; AND A.EXPIRYDATE &gt;&quot;).append(nowStr);</span>
<span class="nc" id="L961">		StringBuffer sortClause = new StringBuffer();</span>
		//Add Sort Clause

<span class="nc" id="L964">		Pair[] wlPriorityorder = pool.getTOWaitlistPriortyOrderSettings();</span>
<span class="nc" id="L965">		boolean addWltable = false, addRanktable = false, addEMPAMtable = false;</span>
		//String priorityClause = &quot;&quot;;
<span class="nc bnc" id="L967" title="All 2 branches missed.">		for (int i = 0; i &lt; wlPriorityorder.length; i++) {</span>
<span class="nc" id="L968">			int sortCol = -1;</span>
<span class="nc" id="L969">			String sorDirStr = null;</span>
			try {
<span class="nc" id="L971">				Pair pair = wlPriorityorder[i];</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">				if (pair == null) {</span>
<span class="nc" id="L973">					break;</span>
				}
<span class="nc" id="L975">				String sortColStr = (String) pair.getFirst();</span>
<span class="nc" id="L976">				sorDirStr = (String) pair.getSecond();</span>
<span class="nc bnc" id="L977" title="All 4 branches missed.">				if (StringUtil.isEmptyOrWhiteSpace(sortColStr) || StringUtil.isEmptyOrWhiteSpace(sorDirStr)</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">				        || sortColStr.equals(RmSettingKey.ORG_RM_SETTINGS_TO_WAITLIST_ORDER_COLUMN_NO_VALUE)) {</span>
<span class="nc" id="L979">					break;</span>
				}
				//priorityClause += &quot; &quot; + sortColStr + &quot; &quot; + sorDirStr;
<span class="nc" id="L982">				sortCol = Integer.parseInt(sortColStr);</span>
<span class="nc" id="L983">			} catch (Exception e) {</span>
<span class="nc" id="L984">				break;</span>
<span class="nc" id="L985">			}</span>
<span class="nc" id="L986">			String str = null;</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">			if (sortCol == Request.SORT_CREATED) {</span>
<span class="nc" id="L988">				str = &quot;REQ.SUBMITTEDON&quot;;</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">			} else if (sortCol == Request.SORT_EMP_RANK) {</span>
<span class="nc" id="L990">				addRanktable = true;</span>
<span class="nc" id="L991">				str = &quot;EMPRANK.RANK&quot;;</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">			} else if (sortCol == Request.SORT_TO_SENIORITY) {</span>
<span class="nc" id="L993">				addEMPAMtable = true;</span>
<span class="nc" id="L994">				str = RequestUtil.TABLE_EMPLOYEEAM_ALIAS + &quot;.STARTTIME &quot;;</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">			} else if (sortCol == Request.SORT_TO_WAITLIST_PENDING_DATE_TIME) {</span>
<span class="nc" id="L996">				addWltable = true;</span>
<span class="nc" id="L997">				str = RequestUtil.TABLE_TOWAITLIST_ALIAS + &quot;.CREATEDON &quot;;</span>
<span class="nc bnc" id="L998" title="All 4 branches missed.">				sorDirStr = sorDirStr != null &amp;&amp; RequestUtil.SORTDIR_DESC.trim().equalsIgnoreCase(sorDirStr.trim()) ?</span>
				        RequestUtil.SORTDIR_ASC : RequestUtil.SORTDIR_DESC;
<span class="nc bnc" id="L1000" title="All 2 branches missed.">			} else if (sortCol == Request.SORT_TO_WAITLIST_PENDING_DAYS) {</span>
<span class="nc" id="L1001">				addWltable = true;</span>
<span class="nc" id="L1002">				str = &quot;DATEDIFF(D,&quot; + RequestUtil.TABLE_TOWAITLIST_ALIAS + &quot;.CREATEDON,&quot; + nowStr + &quot;)&quot;;</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">			} else if (sortCol == Request.SORT_TO_WAITLIST_TOCHOICE_ALLOCATION_HOURS) {</span>
<span class="nc" id="L1004">				str = &quot;A.TOTALMINUTES&quot;;</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">			} else if (sortCol == Request.SORT_TO_WAITLIST_TOCHOICE_REQ_LENGTH) {</span>
<span class="nc" id="L1006">				str = &quot;DATEDIFF(ss,A.STARTTIME,A.ENDTIME)&quot;;</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">			} else if (sortCol == Request.SORT_TO_WAITLIST_TOCHOICE_START) {</span>
<span class="nc" id="L1008">				str = &quot;A.STARTTIME&quot;;</span>
			}
<span class="nc bnc" id="L1010" title="All 2 branches missed.">			if (str == null) {</span>
<span class="nc" id="L1011">				break;</span>
			}
<span class="nc" id="L1013">			selectClause.append(&quot; , &quot; + str);</span>
<span class="nc bnc" id="L1014" title="All 2 branches missed.">			sortClause.append((i &gt; 0 ? &quot; ,&quot; : &quot; ORDER BY &quot;)).append(str).append(&quot; &quot;).append(sorDirStr);</span>
		}
<span class="nc bnc" id="L1016" title="All 2 branches missed.">		sortClause.append((sortClause.length() &gt; 5 ? &quot; ,&quot; : &quot; ORDER BY &quot;)).append(&quot; C.TIMEOFFREQUESTID ASC &quot;);</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">		if (addRanktable) {</span>
<span class="nc" id="L1018">			fromClause.append(&quot; LEFT JOIN (SELECT EMPLOYEEID, RANK FROM EMPLOYEERANK WHERE STARTTIME&lt; &quot;).append(nowStr);</span>
<span class="nc" id="L1019">			fromClause.append(&quot; AND (ENDTIME&gt;&quot;).append(nowStr).append(&quot; OR ENDTIME IS NULL)&quot;);</span>
<span class="nc" id="L1020">			fromClause.append(&quot;)EMPRANK ON EMPRANK.EMPLOYEEID=REQ.EMPLOYEEID &quot;);</span>
		}
<span class="nc bnc" id="L1022" title="All 2 branches missed.">		if (addWltable) {</span>
<span class="nc" id="L1023">			fromClause.append(&quot;, TIMEOFFWAITLIST &quot; + RequestUtil.TABLE_TOWAITLIST_ALIAS);</span>
<span class="nc" id="L1024">			whereClause.append(&quot; AND &quot; + RequestUtil.TABLE_TOWAITLIST_ALIAS + &quot;.TIMEOFFREQUESTID=REQ.ID &quot;);</span>
		}
<span class="nc bnc" id="L1026" title="All 2 branches missed.">		if (addEMPAMtable) {</span>
<span class="nc" id="L1027">			fromClause.append(&quot;, EMPLOYEEAM &quot; + RequestUtil.TABLE_EMPLOYEEAM_ALIAS);</span>
<span class="nc" id="L1028">			whereClause.append(&quot; AND &quot; + RequestUtil.TABLE_EMPLOYEEAM_ALIAS + &quot;.ID= A.EMPLOYEEID &quot;);</span>
		}
<span class="nc" id="L1030">		selectClause.append(fromClause.toString()).append(whereClause.toString()).append(sortClause.toString());</span>
<span class="nc bnc" id="L1031" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.info(selectClause.toString());</span>
<span class="nc" id="L1032">		return selectClause.toString();</span>
	}
	
	/**
	 * @return 
	 * The collection of TIMEOFFHOURSPERDAY that use scheduling periods that are affected when the date range [start,end) is published/unpublished.
	 * 
	 * A TIMEOFFHOURSPERDAY record is affected if the time off request choice associated with the hours per day 
	 * is using the reference scheduling period with range [start,end)  and the request is pending and is in the future.
	 */
	public Collection&lt;TOHoursPerDay&gt; getHoursPerDayGeneratedByReferenceSchedule(Collection&lt;ID&gt; empIDs, Date start, Date end)
			throws BbmFinderException {

<span class="nc bnc" id="L1045" title="All 4 branches missed.">		if (empIDs == null || empIDs.isEmpty()) {</span>
<span class="nc" id="L1046">			return Collections.emptyList();</span>
		}

		//@formatter:off
<span class="nc" id="L1050">		String sql =</span>
				&quot;select THD.*  &quot; 
				+ &quot;from TIMEOFFHOURSPERDAY THD &quot;
				+ &quot;inner join TIMEOFFREQUESTCHOICE TRC on TRC.ID = THD.TIMEOFFCHOICEID &quot;
				+ &quot;inner join REQUEST R on TRC.TIMEOFFREQUESTID = R.ID &quot; 
				+ &quot;inner join SP on SP.SID = TRC.REFERENCESPID &quot;
				+ &quot;where R.EMPLOYEEID in %s and R.REQUESTSTATUS in ( 'pending' , 'waitlist' ) &quot;
				+&quot;and SP.FROMDATE = '%s' and SP.TODATE = '%s'   and TRC.ENDTIME &gt; '%s' &quot;;
		//@formatter:on

<span class="nc" id="L1060">		Date now = new Date();</span>

		try {
<span class="nc" id="L1063">			sql = String.format(sql, m_dmo.createInClause(empIDs), JdmoUtil.formatDBString(start), JdmoUtil.formatDBString(end),</span>
<span class="nc" id="L1064">					JdmoUtil.formatDBString(now));</span>
<span class="nc" id="L1065">		} catch (JdmoException e) {</span>
<span class="nc" id="L1066">			throw new BbmFinderException(e);</span>
<span class="nc" id="L1067">		}</span>

<span class="nc" id="L1069">		return getObjectsGivenFullSqlQueryStr(sql);</span>
	}
	
	/**
	 * @return 
	 * The collection of TIMEOFFHOURSPERDAY from a list of TOChoices
	 * 
	 */
	public Collection&lt;TOHoursPerDay&gt; getHoursPerDayFromTOChoiceList(Collection&lt;ID&gt; toChoiceList)
			throws BbmFinderException {

<span class="nc bnc" id="L1080" title="All 4 branches missed.">		if (toChoiceList == null || toChoiceList.isEmpty()) {</span>
<span class="nc" id="L1081">			return Collections.emptyList();</span>
		}

		try {
<span class="nc" id="L1085">			String sql = &quot; A.TIMEOFFCHOICEID in &quot; + m_dmo.createInClause(toChoiceList);</span>
<span class="nc" id="L1086">			return getObjects(sql);</span>
<span class="nc" id="L1087">		} catch (JdmoException e) {</span>
<span class="nc" id="L1088">			throw new BbmFinderException(e);</span>
		}
		
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>