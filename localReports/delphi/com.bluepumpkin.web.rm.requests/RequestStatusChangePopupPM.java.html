<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestStatusChangePopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests</a> &gt; <span class="el_source">RequestStatusChangePopupPM.java</span></div><h1>RequestStatusChangePopupPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests;

import java.util.Collection;
import java.util.Date;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.timeoff.TimeOffRequestUtil;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;

/**
 * Title:		     TimeOffRequestDetailsPopupPM
 * Description:  Time Off Request Details
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, inc
 * @author       David Su
 * @version      1.0
 */
public class RequestStatusChangePopupPM extends RequestFormPopupPM
		implements ContainersInRowsPM {
	private static final String REQUEST_ACTION_FN = &quot;requestAction&quot;;
	private static final String REQUEST_WL_EXPIRYDATE_FN = &quot;wlExpiryDate&quot;;
	private Collection m_containerList;
	private FormTwoColumnPC m_mainContainerPC;
	private MultiColListPC m_choiceListPC;

	private String m_requestAction;
	private ID m_toChoiceID;
	private DatePickerPC m_wlExpiryDatePickerPC;

<span class="nc" id="L50">	private boolean m_canContinue = true; //can the user submit the action?</span>

	/**
	 * Constructor
	 */
	public RequestStatusChangePopupPM(RequestContext context) {
<span class="nc" id="L56">		super(context, RmKeys.RH_REQUEST_CHANGE_STATUS_FORM);</span>

<span class="nc" id="L58">		m_containerList = new ContainerList(this, 2);</span>

<span class="nc" id="L60">		initDatePickerPC();</span>
<span class="nc" id="L61">	}</span>

	/**
	 * Init waitlist date picker
	 */
	private void initDatePickerPC() {
<span class="nc" id="L67">		m_wlExpiryDatePickerPC = new DatePickerPC(m_context, REQUEST_WL_EXPIRYDATE_FN);</span>
<span class="nc" id="L68">		m_wlExpiryDatePickerPC.setLowerLimit(new Date());</span>
<span class="nc" id="L69">		m_wlExpiryDatePickerPC.setIsDateValueOptional(true);</span>

<span class="nc" id="L71">		m_wlExpiryDatePickerPC.setIsTimeEnabled(true);</span>
<span class="nc" id="L72">		addChildComponent(m_wlExpiryDatePickerPC);</span>
<span class="nc" id="L73">	}</span>

	/**
	 * Return an instance of the model that is ready for rendering
	 */
	public static RequestStatusChangePopupPM getInstance(RequestContext context) {
<span class="nc" id="L79">		RequestStatusChangePopupPM model = null;</span>

<span class="nc" id="L81">		PageModel cachedModel = context.getPageModel();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">		if (cachedModel instanceof RequestStatusChangePopupPM) {</span>
<span class="nc" id="L83">			model = (RequestStatusChangePopupPM)cachedModel;</span>
		} else {
<span class="nc" id="L85">			model = new RequestStatusChangePopupPM(context);</span>
<span class="nc" id="L86">			model.extractParameters(context.getRequest());</span>
<span class="nc" id="L87">			context.setPageModel(model);</span>
		}

		// Make sure model is populated
<span class="nc" id="L91">		model.populateModel();</span>

<span class="nc" id="L93">		return model;</span>
	}//getInstance

	/**
	 * Ensure the model is populated
	 */
	private void populateModel() {
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (m_isInitialized) return; else m_isInitialized = true;</span>
        try {
<span class="nc" id="L102">            m_request = RequestsMH.getRequest(getRequestID(), getRequestType());</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (m_request == null)</span>
<span class="nc" id="L104">                this.addPageMessage(Message.ERROR_TYPE, i18n(m_bundle, RmWebBundleKey.REQUEST_NOT_FOUND_ERROR));</span>

            /* Sameet Nov 2006 RM Waitlist Rel: 7.8
            No maximum date range needs to be set since any TO Choice can be waitlisted.
            the Waitlist Expiry date is optional and defaults to the Request Expiration Date if user doesnot set it.
            Check updateExpiration() method from TORequestManagerEJB

			//set date picker maximum if m_requestAction = ADD_TO_WAITLIST_ACTION
			if (m_requestAction.equals(RmPageAction.ADD_TO_WAITLIST_ACTION)){
				//it is a time off request
				TOChoice firstChoice = (TOChoice)((TORequest)m_request).getRequestChoiceList().get(0);
				m_wlExpiryDatePickerPC.setUpperLimit(firstChoice.getStartDate());
			}
            */
<span class="nc" id="L118">        } catch (RmHardValidationException ex) {</span>
<span class="nc" id="L119">            Message msg = handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L120">            msg.setAssociatedMessage(ex.getLocalizedMessage(m_localizer, m_context.getViewingTimeZone()));</span>
<span class="nc" id="L121">        } catch (Exception ex) {</span>
<span class="nc" id="L122">            handleUnableToLoadDataError(log, ex);</span>
        } finally {
<span class="nc" id="L124">            initContentTitle();</span>
<span class="nc bnc" id="L125" title="All 8 branches missed.">            if (m_request != null) {</span>
<span class="nc" id="L126">                initContent();</span>
<span class="nc" id="L127">                initToolbar();</span>
            } else {
<span class="nc" id="L129">                initToolbar(false);</span>
            }
<span class="nc" id="L131">        }</span>
<span class="nc" id="L132">    }</span>

	/**
	 * Prepare content title for rendering
	 */
	protected void initContentTitle() {
<span class="nc" id="L138">		String pageTitle = i18n(m_bundle, RmWebBundleKey.REQUEST_STATUS_CHANGE_ACTION);</span>
<span class="nc" id="L139">		String itemName = RequestUtil.getLocalizedAction(m_localizer, m_common_bundle, m_requestAction);</span>
<span class="nc" id="L140">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="nc" id="L141">		m_contentTitlePC.setItemName(itemName);</span>
<span class="nc" id="L142">	}</span>

	/**
	 * Initialize Content
	 */
	private void initContent()
	{
		//If manager tries to waitlist a request that was Denied and is not eligible to be waitlisted,
		//then a warning message will be displayed.
		try{
<span class="nc bnc" id="L152" title="All 4 branches missed.">			if ((m_request instanceof TORequest) &amp;&amp; isAddToManWaitlistAction() &amp;&amp;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">					RequestAuditTrail.STATUS_DENIED.equals(m_request.getRequestStatus()) )</span>
			{
<span class="nc" id="L155">				SimpleTextPC warningTextPC = new SimpleTextPC(m_context, i18n(m_bundle, RmWebBundleKey.TIMEOFF_MANUAL_ADD_DENIED_REQUEST_TO_WL));</span>
<span class="nc" id="L156">		        warningTextPC.setTitle(i18n(m_bundle, RmWebBundleKey.TIMEOFF_WAITLIST_WARNING));</span>
<span class="nc" id="L157">				m_containerList.add(warningTextPC);</span>
			}
	
			//If agent tries to waitlist a request that was Pending/Denied and is not eligible to be waitlisted,
			//then a message will be displayed: &quot;Request is not eligible to be waitlisted at this time. Please try again later.&quot;
<span class="nc bnc" id="L162" title="All 4 branches missed.">			if ((m_request instanceof TORequest) &amp;&amp; isAddToWaitlistAction() &amp;&amp;</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">					!((TORequest)m_request).isEligibleForWaitlist() )</span>
			{
<span class="nc" id="L165">				SimpleTextPC warningTextPC = new SimpleTextPC(m_context, i18n(m_bundle, RmWebBundleKey.TIMEOFF_REQUEST_CANNOT_ADD_TO_WL));</span>
<span class="nc" id="L166">		        warningTextPC.setTitle(i18n(m_bundle, RmWebBundleKey.TIMEOFF_WAITLIST_NOTE));</span>
<span class="nc" id="L167">				m_containerList.add(warningTextPC);</span>
<span class="nc" id="L168">				m_canContinue = false;</span>
<span class="nc" id="L169">			}</span>
			else
			{
<span class="nc" id="L172">				initMainList();</span>
				
<span class="nc bnc" id="L174" title="All 6 branches missed.">				if (!hasError() &amp;&amp; (m_request instanceof ShiftSwapRequest) &amp;&amp; isWithdrawNegotiationAction()){</span>
					//If this is a withdraw of an approved swap request and not a manager (that is not required to confirm the withdrawal request),
					// show line with message about confirmation of swap employee 
<span class="nc" id="L177">					ShiftSwapRequest ssRequest = (ShiftSwapRequest)m_request;</span>
<span class="nc" id="L178">					String swapEmployee = RequestUtil.getSwapEmployeeName(m_request, m_context);</span>
<span class="nc" id="L179">					SimpleTextPC confirmationText = new SimpleTextPC(m_context, m_localizer.i18n(m_bundle, RmWebBundleKey.SHIFTSWAP_REQUIRE_CONFIRMATION,swapEmployee));</span>
<span class="nc" id="L180">					confirmationText.setTitle(i18n(m_bundle, RmWebBundleKey.SHIFTSWAP_CONFIRMATION_NOTICE));</span>
<span class="nc" id="L181">					m_containerList.add(confirmationText);</span>
				}
	
<span class="nc bnc" id="L184" title="All 4 branches missed.">				if (m_request instanceof TORequest &amp;&amp;  !m_request.isFlexTimeRequest())</span>
<span class="nc" id="L185">					initChoiceList((TORequest)m_request);</span>
			}
		}
<span class="nc" id="L188">		catch (Exception ex) {</span>
<span class="nc" id="L189">            handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L190">        }</span>
<span class="nc" id="L191">	}</span>

	/**
	 * Prepare toolbar for rendering
	 */
	@Override
	protected void initToolbar()
	{
<span class="nc bnc" id="L199" title="All 2 branches missed.">		if (m_canContinue)</span>
		{
<span class="nc" id="L201">			m_toolbar.addValidateSubmitTextButton(</span>
					m_requestAction,
<span class="nc" id="L203">					i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_CONTINUE),</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">					!hasError());</span>
		}

<span class="nc" id="L207">		m_toolbar.addCloseWindowTextButton(</span>
				PageAction.CANCEL,
<span class="nc" id="L209">				i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_CANCEL),</span>
				true);
<span class="nc" id="L211">	}</span>

	/**
	 * Initialize Main List
	 */
	private void initMainList() {
<span class="nc bnc" id="L217" title="All 2 branches missed.">		if (hasError()) return;</span>

<span class="nc" id="L219">		m_mainContainerPC = new FormTwoColumnPC(m_context);</span>
<span class="nc" id="L220">		m_mainContainerPC.setWrapperCSSClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="nc" id="L221">		m_mainContainerPC.setLastRowType(FormTwoColumnPC.LAST_ROW_NONE);</span>

		//add row for date picker if action is adding to waitlist
<span class="nc bnc" id="L224" title="All 6 branches missed.">		if (m_requestAction != null &amp;&amp; (isAddToWaitlistAction() || isAddToManWaitlistAction()) )</span>
		{
<span class="nc" id="L226">			m_mainContainerPC.addRow(i18n(m_bundle, RmWebBundleKey.TIMEOFF_WL_EXPIRY_DATE), m_wlExpiryDatePickerPC.getHtmlDisplay());</span>
		}
<span class="nc" id="L228">		String commentUI = RequestUtil.createCommentUI(COMMENT_FN, getComment(), 100, 5, this, i18n(m_common_bundle, UIFWebBundleKey.ADD_COMMENT));</span>
<span class="nc" id="L229">		m_mainContainerPC.addRow(i18n(m_common_bundle, UIFWebBundleKey.ADD_COMMENT), commentUI);</span>

<span class="nc" id="L231">		m_containerList.add(m_mainContainerPC);</span>
<span class="nc" id="L232">	}</span>


	/**
	 * Create New List PC
	 */
	private MultiColListPC createNewRequestChoiceList() {
<span class="nc" id="L239">		MultiColListPC listPC = new MultiColListPC(m_context);</span>
<span class="nc" id="L240">		listPC.setEnabled(false);</span>
<span class="nc" id="L241">		listPC.setIsBorderEnabled(true);</span>
<span class="nc" id="L242">		m_containerList.add(listPC);</span>
<span class="nc" id="L243">		return listPC;</span>
	}

	/**
	 * Initialize Choise List
	 */
	public void initChoiceList(TORequest toRequest) {
<span class="nc" id="L250">		m_choiceListPC = createNewRequestChoiceList();</span>

		// Do not allow Change of Selected Choice when already tentatively approved
<span class="nc bnc" id="L253" title="All 2 branches missed.">		boolean isSelectable = isApproveAction() &amp;&amp;</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">			!RequestAuditTrail.STATUS_TENTATIVE.equals(toRequest.getRequestStatus());</span>

<span class="nc bnc" id="L256" title="All 2 branches missed.">		if (m_toChoiceID==null) {</span>
<span class="nc" id="L257">			m_toChoiceID = toRequest.getApprovedChoiceID();</span>
		}
<span class="nc" id="L259">		TimeOffRequestUtil.TimeOffChoiceListPCConfig config = new TimeOffRequestUtil.TimeOffChoiceListPCConfig()</span>
<span class="nc" id="L260">																.setIsSelectable(isSelectable)</span>
<span class="nc" id="L261">																.setIsShowSelectedInfo(true)</span>
<span class="nc" id="L262">																.setIsShowAlert(true);</span>

<span class="nc" id="L264">		TimeOffRequestUtil.initTimeOffChoiceListPC(m_context, m_choiceListPC,</span>
				toRequest, m_toChoiceID, m_common_bundle, m_bundle, config);
<span class="nc" id="L266">	}</span>

	/** Return List of Containers
	 *
	 * NOTE: Items in the Collection will be treated either as Page Components or
	 *       just a basic Object.
	 */
	public Collection getContainers() {
<span class="nc" id="L274">		return m_containerList;</span>
	}

	/**
	 * Set Request Action
	 */
	public void setRequestAction(String action) {
<span class="nc" id="L281">		m_requestAction = action;</span>
<span class="nc" id="L282">	}</span>

	/**
	 * Return Request Action
	 */
	public String getRequestAction() {
<span class="nc" id="L288">		return m_requestAction;</span>
	}

	/**
	 * Set TimeOff Choice ID
	 */
	public void setTOChoiceID(ID id) {
<span class="nc" id="L295">		m_toChoiceID = id;</span>
<span class="nc" id="L296">	}</span>

	/**
	 * Return Time Off Choice ID
	 */
	public ID getTOChoiceID() {
<span class="nc" id="L302">		return m_toChoiceID;</span>
	}

	/**
	 * Return Expiry date
	 */
	public Date getExpiryDate() {
<span class="nc" id="L309">		return m_wlExpiryDatePickerPC.getDate();</span>
	}

	/**
	 * Return true if Action is Approve or Tentatively Approve
	 */
	private boolean isApproveAction() {
<span class="nc bnc" id="L316" title="All 2 branches missed.">		return PageAction.APPROVE.equals(m_requestAction) ||</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">				PageAction.TENTATIVELY_APPROVE.equals(m_requestAction);</span>
	}

	/**
	 * Return true if Action is Manually Add To Waitlist
	 */
	private boolean isAddToWaitlistAction() {
<span class="nc" id="L324">		return RmPageAction.ADD_TO_WAITLIST_ACTION.equals(m_requestAction);</span>
	}
	
	/**
	 * Return true if Action is Manually Add To Waitlist
	 */
	private boolean isWithdrawNegotiationAction() {
<span class="nc" id="L331">		return PageAction.WITHDRAW_NEGOTIATION.equals(m_requestAction);</span>
	}

	/**
	 * Return true if Action is Manually Add To Waitlist
	 */
	private boolean isAddToManWaitlistAction() {
<span class="nc" id="L338">		return RmPageAction.ADD_TO_MAN_WAITLIST_ACTION.equals(m_requestAction);</span>
	}

	/**
	 * Return Required HTML
	 */
	@Override
	public String getRequiredHTML() {
<span class="nc" id="L346">		return super.getRequiredHTML() +</span>
<span class="nc" id="L347">				HtmlUtil.makeHiddenInput(REQUEST_ACTION_FN, m_requestAction);</span>
	}


	private class SimpleTextPC extends CollapsibleContainerPC
	{
<span class="nc" id="L353">		private String m_text = &quot;&quot;;</span>

		public SimpleTextPC(RequestContext context, String text)
<span class="nc" id="L356">		{</span>
<span class="nc" id="L357">			super(context);</span>
<span class="nc" id="L358">			m_text = text;</span>
<span class="nc" id="L359">		}</span>

	    /**
	     * Initialize Component For Display
	     */
	    @Override
		public void initForDisplay()
	    {
<span class="nc" id="L367">	        setTemplate(&quot;{0}&quot;);</span>
<span class="nc" id="L368">	        setIsBorderEnabled(true);</span>
<span class="nc" id="L369">	        StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L370">	        sb.append(&quot;&lt;table&gt;&lt;tr&gt;&lt;td class=\&quot;formRowLightNoBorderBottom\&quot;&gt;&quot;).append(m_text).append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>
<span class="nc" id="L371">	        super.addComponent(sb.toString());</span>
<span class="nc" id="L372">	    }</span>

		public void setText(String text)
		{
<span class="nc" id="L376">			m_text = text;</span>
<span class="nc" id="L377">		}</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>