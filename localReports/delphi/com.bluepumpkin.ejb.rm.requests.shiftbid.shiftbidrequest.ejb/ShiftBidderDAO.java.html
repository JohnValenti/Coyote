<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftBidderDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb</a> &gt; <span class="el_source">ShiftBidderDAO.java</span></div><h1>ShiftBidderDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb;


import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.NumberFactory;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.bbm.workresource.ejb.EmployeeDAO;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeRankFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.PersonFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourceAssignmentFieldInfo;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbLogBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RmDAONode;
import com.bluepumpkin.ejb.rm.requests.common.model.FilterExpr;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionDAO;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableSchedule;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidder;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidderFieldInfo;
import com.bluepumpkin.ejb.rm.util.DAOUtil;

/**
 * see {@link com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionManager ShiftBidAuctionManager}
 * for a description of the shift bidding process. 
 * 
 * Title:        ShiftBidderDAO
 * Description:  DAO class for ShiftBidder
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc.
 * @author       Jagdish Seelam
 * @version 1.0
 */

<span class="nc bnc" id="L52" title="All 2 branches missed.">public class ShiftBidderDAO extends RmDAONode {</span>

<span class="nc" id="L54">    private static final Category m_cat = Log.initCategory(ShiftBidderDAO.class.getName());</span>
     
<span class="nc" id="L56">    private static final ShiftBidderFieldInfo m_fieldInfo = new ShiftBidderFieldInfo();</span>

    //Used to obtain the workResourceOrg tablename
<span class="nc" id="L59">    private static final WorkResourceAssignmentFieldInfo m_workResourceOrgFieldInfo = </span>
        new WorkResourceAssignmentFieldInfo();

<span class="nc" id="L62">    private static final EmployeeFieldInfo m_empFieldInfo = new EmployeeFieldInfo();</span>
<span class="nc" id="L63">    private static final PersonFieldInfo m_personFieldInfo = new PersonFieldInfo();</span>
<span class="nc" id="L64">    private static final EmployeeRankFieldInfo m_employeeRankFieldInfo = new EmployeeRankFieldInfo();</span>
        
	private static final String TABLE_PREFIX = &quot; A&quot;;  //table prefix for shiftBidder
    private static final String TABLE_PREFIX_EMP = &quot; B&quot;;  //table prefix for shiftBidder
    private static final String TABLE_PREFIX_PERSON = &quot; C&quot;; //table prefix for PERSON table.
    private static final String TABLE_PREFIX_RANK = &quot; D&quot;; //table prefix for PERSON table.

<span class="nc" id="L71">    private static final String COLNAME_EMPID = TABLE_PREFIX + '.' + ShiftBidderFieldInfo.COLNAME_EMPID;         </span>
<span class="nc" id="L72">    private static final String COLNAME_AUCTIONID = TABLE_PREFIX + '.' + ShiftBidderFieldInfo.COLNAME_AUCTIONID;</span>
<span class="nc" id="L73">    private static final String COLNAME_ID = TABLE_PREFIX + '.' + ShiftBidderFieldInfo.COLNAME_ID;</span>
<span class="nc" id="L74">    private static final String COLNAME_DEADLINETIME = TABLE_PREFIX + '.' + ShiftBidderFieldInfo.COLNAME_DEADLINE;</span>
<span class="nc" id="L75">    private static final String COLNAME_BONUSTHISAUCTION = TABLE_PREFIX + '.' + ShiftBidderFieldInfo.COLNAME_BONUSTHISAUCTION;</span>
<span class="nc" id="L76">    private static final String COLNAME_STATUS = TABLE_PREFIX + '.' + ShiftBidderFieldInfo.COLNAME_STATUS;</span>

<span class="nc" id="L78">    private static final String COLNAME_EMP_ASSIGNEDPOINTS = TABLE_PREFIX_EMP + '.' + m_empFieldInfo.getFieldName(EmployeeFieldInfo.EMPLOYEE_ASSIGNEDPOINTS);</span>
<span class="nc" id="L79">    private static final String COLNAME_EMP_RANK = TABLE_PREFIX_RANK + '.' + m_employeeRankFieldInfo.getFieldName(EmployeeRankFieldInfo.EMPRANK_RANK);</span>
<span class="nc" id="L80">    private static final String COLNAME_EMP_STARTTIME = TABLE_PREFIX_EMP + '.' + m_empFieldInfo.getFieldName(EmployeeFieldInfo.EMPLOYEE_STARTTIME);</span>
<span class="nc" id="L81">    private static final String COLNAME_EMP_ID = TABLE_PREFIX_EMP + '.' + m_empFieldInfo.getFieldName(EmployeeFieldInfo.EMPLOYEE_ID);</span>
<span class="nc" id="L82">    private static final String COLNAME_EMP_PERSONID = TABLE_PREFIX_EMP + '.' + m_empFieldInfo.getFieldName(EmployeeFieldInfo.EMPLOYEE_PERSONID);;</span>
<span class="nc" id="L83">    private static final String COLNAME_EMP_RANK_ID = TABLE_PREFIX_RANK + '.' + m_employeeRankFieldInfo.getFieldName(EmployeeRankFieldInfo.EMPRANK_EMPLOYEEID);</span>
<span class="nc" id="L84">	private static final String COLNAME_EMP_RANK_STARTTIME = TABLE_PREFIX_RANK + '.' + m_employeeRankFieldInfo.getFieldName(EmployeeRankFieldInfo.EMPRANK_STARTTIME);</span>
<span class="nc" id="L85">	private static final String COLNAME_EMP_RANK_ENDTIME = TABLE_PREFIX_RANK + '.' + m_employeeRankFieldInfo.getFieldName(EmployeeRankFieldInfo.EMPRANK_ENDTIME);</span>


    private static final String COLNAME_PERSON_ID = TABLE_PREFIX_PERSON + '.' + &quot;ID&quot;; //Note: m_personFieldInfo.getFieldName(PersonFieldInfo.PERSON_ID) is defined as PERSONID and not ID
<span class="nc" id="L89">    private static final String COLNAME_PERSON_LASTNAME = TABLE_PREFIX_PERSON + '.' + m_personFieldInfo.getFieldName(PersonFieldInfo.PERSON_LASTNAME);</span>
<span class="nc" id="L90">    private static final String COLNAME_PERSON_FIRSTNAME = TABLE_PREFIX_PERSON + '.' + m_personFieldInfo.getFieldName(PersonFieldInfo.PERSON_FIRSTNAME);</span>
    
    private static final String TABLENAME = ShiftBidderFieldInfo.m_strTableName;

<span class="nc" id="L94">    private static final DAOUtil.ColumnMetaData COLMETADATA_INT_ONE = </span>
        new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_INTEGER, 1);

<span class="nc" id="L97">    private static Map m_sortByToSQLColNameMap = new HashMap();</span>
    static {
<span class="nc" id="L99">        m_sortByToSQLColNameMap.put(NumberFactory.newInteger(ShiftBidder.SORTBY_STATUS), </span>
            new String[] {COLNAME_STATUS});
<span class="nc" id="L101">        m_sortByToSQLColNameMap.put(NumberFactory.newInteger(ShiftBidder.SORTBY_SENIORITY), </span>
            new String[] {COLNAME_EMP_STARTTIME});
<span class="nc" id="L103">        m_sortByToSQLColNameMap.put(NumberFactory.newInteger(ShiftBidder.SORTBY_RANK), </span>
            new String[] {COLNAME_EMP_RANK});
<span class="nc" id="L105">        m_sortByToSQLColNameMap.put(NumberFactory.newInteger(ShiftBidder.SORTBY_POINTS), </span>
            new String[] {COLNAME_EMP_ASSIGNEDPOINTS});
<span class="nc" id="L107">        m_sortByToSQLColNameMap.put(NumberFactory.newInteger(ShiftBidder.SORTBY_BONUS), </span>
            new String[] {COLNAME_BONUSTHISAUCTION});
<span class="nc" id="L109">        m_sortByToSQLColNameMap.put(NumberFactory.newInteger(ShiftBidder.SORTBY_DEADLINE), </span>
            new String[] {COLNAME_DEADLINETIME});
<span class="nc" id="L111">        m_sortByToSQLColNameMap.put(NumberFactory.newInteger(ShiftBidder.SORTBY_NAME), </span>
            new String[] {COLNAME_PERSON_LASTNAME, COLNAME_PERSON_FIRSTNAME});
    }

    //can't be made static because of reference to 'dmo'        
<span class="nc" id="L116">    private static String m_inClauseForPEDTI = DAOUtil.createInClause(</span>
        new String[] {
            RequestAuditTrail.STATUS_PENDING,
            RequestAuditTrail.STATUS_ESCALATED,
            RequestAuditTrail.STATUS_DENIED,
            RequestAuditTrail.STATUS_TENTATIVE,
            RequestAuditTrail.STATUS_INVALID 
        });
    
    // List of bidderIDs who have:
    // - submitted one or more bids.
    // - and none of them were approved.        
    private static String a1, a2, a3;
    {
<span class="nc" id="L130">        a1= &quot;SELECT DISTINCT SBR.SHIFTBIDDERID &quot; +</span>
            &quot;FROM SHIFTBIDREQUEST SBR, REQUEST REQ &quot; +
            &quot;WHERE SBR.ID = REQ.ID AND REQ.REQUESTSTATUS IN &quot; + m_inClauseForPEDTI + &quot; AND &quot; +
<span class="nc" id="L133">            &quot;   SBR.SHIFTBIDAUCTIONID = &quot;; a2 = &quot; AND SBR.SHIFTBIDDERID NOT IN (&quot; + </span>
            &quot;      SELECT SBR2.SHIFTBIDDERID &quot; +
            &quot;      FROM SHIFTBIDREQUEST SBR2, REQUEST REQ2  &quot; +
            &quot;      WHERE SBR2.ID = REQ2.ID AND REQ2.REQUESTSTATUS = '&quot; + RequestAuditTrail.STATUS_APPROVED + &quot;' AND &quot; + 
            &quot;         SBR2.SHIFTBIDAUCTIONID = &quot;; 
<span class="nc" id="L138">        a3= &quot;   )&quot;;</span>
    }    
<span class="nc" id="L140">    private String m_queryBidderIDsWithNoApprBidsChunk1 = a1;</span>
<span class="nc" id="L141">    private String m_queryBidderIDsWithNoApprBidsChunk2 = a2;</span>
<span class="nc" id="L142">    private String m_queryBidderIDsWithNoApprBidsChunk3 = a3;</span>

<span class="nc" id="L144">	private static String m_sqlForBidderIDsFromEmpIDsPrefix = &quot;SELECT &quot; + COLNAME_ID + &quot; FROM &quot; + TABLENAME + &quot; A WHERE &quot; + </span>
		COLNAME_EMPID + &quot; IN &quot;;

<span class="nc" id="L147">    private static String m_sqlForEmpIDForAuctionID = &quot;SELECT &quot; + COLNAME_EMPID + &quot; FROM &quot; + TABLENAME + TABLE_PREFIX +  </span>
        &quot; WHERE &quot; + COLNAME_AUCTIONID + &quot; = ?&quot;;
        

    protected void initClass(/*Class parentDAO, */long detailLevel) {
        //m_parentDAO = parentDAO;
<span class="nc" id="L153">        saveAndSetDetailLevel(detailLevel);</span>
<span class="nc" id="L154">    }</span>

    public ShiftBidderDAO(/*Class parentDAO, */long detailLevel) {
<span class="nc" id="L157">        super();</span>
<span class="nc" id="L158">        initClass(detailLevel);</span>
<span class="nc" id="L159">	}</span>

	public ShiftBidderDAO(Jdmo dmo, /*Class parentDAO, */long detailLevel) {
<span class="nc" id="L162">		 super(dmo);</span>
<span class="nc" id="L163">         initClass(detailLevel);</span>
<span class="nc" id="L164">	}</span>

    protected FieldInfo getFieldInfo() { 
<span class="nc" id="L167">        return m_fieldInfo; </span>
    }

	protected ValueObjectBase createValueObject()
	{
<span class="nc" id="L172">		 return (new ShiftBidder(getDetailLevel()));</span>
	}

    /**
     * Add information to the FROM and WHERE clause to join the ShiftBidder table with the Employee table 
     *  
     * @see com.bluepumpkin.ejb.bbm.dao.DAOBase#appendFromWhereStatement(java.lang.StringBuffer)
     */
    protected boolean appendFromWhereStatement(StringBuffer strSQL) {
    	try {
<span class="nc" id="L182">	        boolean whereClauseAdded = super.appendFromWhereStatement(strSQL);</span>
<span class="nc bnc" id="L183" title="All 4 branches missed.">            assert whereClauseAdded == false:&quot;whereClauseAdded = &quot; + whereClauseAdded;</span>
            
            // Is a join of the EMPLOYEE table needed?
<span class="nc" id="L186">            boolean needEmpTableJoin = false;</span>
            // Is a join of the PERSON table needed?
<span class="nc" id="L188">            boolean needPersonTableJoin = false;</span>
            
<span class="nc" id="L190">            boolean needEmployeeRankTableJoin = false;</span>
            
            // if a sort criteria was set
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (isSetSortCriteria()) {</span>
                // get the sort criteria
<span class="nc" id="L195">                int sortBy = getSortCriteria();</span>
                
<span class="nc bnc" id="L197" title="All 2 branches missed.">                boolean sortByShiftBidderName = ( sortBy == ShiftBidder.SORTBY_NAME );</span>
                
<span class="nc bnc" id="L199" title="All 6 branches missed.">                needEmpTableJoin = ( sortBy == ShiftBidder.SORTBY_POINTS ) || </span>
                    ( sortBy == ShiftBidder.SORTBY_SENIORITY ) || 
                    sortByShiftBidderName;
                    
<span class="nc bnc" id="L203" title="All 2 branches missed.">                if ( sortBy == ShiftBidder.SORTBY_RANK )</span>
<span class="nc" id="L204">                	needEmployeeRankTableJoin = true;</span>
                	
<span class="nc" id="L206">                needPersonTableJoin = sortByShiftBidderName;</span>
            } 
            
            // first add tables to the FROM clause using the 'sort' and 'filter' criteria.
<span class="nc bnc" id="L210" title="All 2 branches missed.">            if (needEmpTableJoin) {</span>
<span class="nc" id="L211">                strSQL.append(',' + m_empFieldInfo.getTableName() + ' ' + TABLE_PREFIX_EMP);</span>
            }
<span class="nc bnc" id="L213" title="All 2 branches missed.">            if (needPersonTableJoin) {</span>
<span class="nc" id="L214">                strSQL.append(',' + m_personFieldInfo.getTableName() + ' ' + TABLE_PREFIX_PERSON);</span>
            }
<span class="nc bnc" id="L216" title="All 2 branches missed.">            if (needEmployeeRankTableJoin) {</span>
<span class="nc" id="L217">                strSQL.append(',' + m_employeeRankFieldInfo.getTableName() + ' ' + TABLE_PREFIX_RANK);</span>
            }

            // make a WHERE clause using the 'sort' and 'filter' criteria.
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if (needEmpTableJoin) {</span>
<span class="nc" id="L222">                whereClauseAdded = DAOUtil.appendToWhereClause(strSQL, COLNAME_EMPID + '=' + COLNAME_EMP_ID, whereClauseAdded );</span>
            }
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if (needPersonTableJoin) {</span>
<span class="nc" id="L225">                whereClauseAdded = DAOUtil.appendToWhereClause(strSQL, COLNAME_EMP_PERSONID + '=' + COLNAME_PERSON_ID, whereClauseAdded );</span>
            }
             
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (needEmployeeRankTableJoin) {</span>
<span class="nc" id="L229">	            String nowDateString= &quot; '&quot;+JdmoUtil.formatDBString(new Date())+&quot;' &quot;;</span>
<span class="nc" id="L230">                whereClauseAdded = DAOUtil.appendToWhereClause(strSQL, COLNAME_EMP_RANK_ID + '=' + COLNAME_EMPID, whereClauseAdded );</span>
<span class="nc" id="L231">	            whereClauseAdded = DAOUtil.appendToWhereClause(strSQL, COLNAME_EMP_RANK_STARTTIME + &quot;&lt;=&quot; + nowDateString, whereClauseAdded );</span>
<span class="nc" id="L232">	            whereClauseAdded = DAOUtil.appendToWhereClause(strSQL, '('+COLNAME_EMP_RANK_ENDTIME + &quot; IS NULL OR &quot; + COLNAME_EMP_RANK_ENDTIME +&quot; &gt;=&quot;+nowDateString+')' , whereClauseAdded );</span>
            }                                     
            
	        // join WorkResourceOrganization table if necessary to filter ShiftBidders by ORG.
<span class="nc" id="L236">	        Map filterExprsMap = getFilterExprsMap(); </span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">	        if ( filterExprsMap.containsKey(FilterExpr.LHS_ORGID))  {</span>
<span class="nc" id="L238">	            FilterExpr orgIDsFilterExpr = (FilterExpr) filterExprsMap.get(FilterExpr.LHS_ORGID);</span>
<span class="nc" id="L239">				Collection orgIDs = (Collection) orgIDsFilterExpr.getRHS();</span>
				
	
	            // add join for where clause.  Note: a subquery is used instead of a table join to
                // prevent multiple rows for the same shift bidder in the result set.
                //
	            // DIRECT_DB_ACCESS
<span class="nc" id="L246">	            StringBuffer whereSubClause = new StringBuffer(64);</span>
<span class="nc" id="L247">	            whereSubClause</span>
<span class="nc" id="L248">	                .append(&quot; A.EMPLOYEEID IN &quot;)</span>
<span class="nc" id="L249">	                .append(&quot;     (SELECT DISTINCT WORKRESOURCEID FROM &quot;).append(m_workResourceOrgFieldInfo.getTableName())</span>
<span class="nc" id="L250">	                .append(&quot;      WHERE ORGANIZATIONID IN &quot;).append(getDMO().createInClause(orgIDs)).append(&quot; AND &quot;)</span>
<span class="nc" id="L251">	                .append(&quot;         ((ENDTIME IS NULL) OR ('&quot;).append(JdmoUtil.formatDBString(new Date())).append(&quot;' BETWEEN STARTTIME AND ENDTIME)) ) &quot;);</span>
	                
<span class="nc" id="L253">	            whereClauseAdded = DAOUtil.appendToWhereClause(strSQL, whereSubClause.toString(), whereClauseAdded);</span>
	        }
	        
<span class="nc" id="L256">	        return whereClauseAdded;</span>
<span class="nc" id="L257">    	} catch (JdmoException e) {</span>
<span class="nc" id="L258">    		throw RequestUtil.createRunTimeException(e.getMessage(), e, m_cat);</span>
    	}
    }

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.bbm.dao.DAONode#needToLoadChildObjects()
     */
    protected boolean needToLoadChildObjects() {
<span class="nc" id="L266">        long detailLevelsToCheck = ShiftBidder.DL_EMPLOYEE | </span>
            ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
            BiddableSchedule.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
            ShiftBidRequest.DL_SCORECOMPUTED_FOR_SHIFTBID_REQUEST;
            
<span class="nc bnc" id="L271" title="All 2 branches missed.">        return (getDetailLevel() &amp; detailLevelsToCheck) != 0;</span>
    }

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.bbm.dao.DAONode#needToLoadChildObjects(int)
     */
    protected boolean needToLoadChildObjects(int childType) {
<span class="nc bnc" id="L278" title="All 2 branches missed.">        switch (childType)  {</span>
            case ShiftBidderFieldInfo.EMPLOYEE_CHILDTYPE:
<span class="nc" id="L280">                long detailLevelsToCheck = ShiftBidder.DL_EMPLOYEE | </span>
                    ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
                    BiddableSchedule.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
                    ShiftBidRequest.DL_SCORECOMPUTED_FOR_SHIFTBID_REQUEST;
                    
<span class="nc bnc" id="L285" title="All 2 branches missed.">                return ((getDetailLevel() &amp; detailLevelsToCheck) != 0); </span>
        }
                
<span class="nc" id="L288">        throw new IllegalArgumentException(&quot;childType = &quot; + childType);         </span>
    }

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.bbm.dao.DAONode#createChildDAO(int)
     */
    protected DAOBase createChildDAO(int childType) {
<span class="nc bnc" id="L295" title="All 2 branches missed.">        switch (childType)  {</span>
            case ShiftBidderFieldInfo.EMPLOYEE_CHILDTYPE:
<span class="nc" id="L297">                return new EmployeeDAO(m_dmo);</span>
            default:
<span class="nc" id="L299">                throw new IllegalArgumentException(&quot;childType = &quot; + childType);</span>
        }
    }

    /** 
     * Read the EMPLOYEE table column values from the recordset into an employee value object.
     * 
     * @see com.bluepumpkin.ejb.bbm.dao.DAOBase#readObjectFromDB(com.bluepumpkin.common.jdmo.JdmoRowset)
     */
//    public ValueObjectBase readObjectFromDB(JdmoRowset rs) throws Exception {
//        ShiftBidder shiftBidder = (ShiftBidder) super.readObjectFromDB(rs);
//        
//        if ((getDetailLevel() &amp; ShiftBidder.DL_EMPLOYEE) != 0)  {
//            Employee emp = (Employee) m_employeeDAO.readObjectFromDB(rs);
//            
//            shiftBidder.getSetters().setEmployee(emp);
//        }
//        
//        return shiftBidder;
//    }

    /**
     * @param bidders
     */
    public void createShiftBidders(Collection bidders) throws Exception {
<span class="nc" id="L324">        createObjects(bidders);</span>
<span class="nc" id="L325">    }</span>

    public ShiftBidder getShiftBidderByID(ID shiftBidderID, long detailLevel)  throws Exception {
<span class="nc" id="L328">        saveAndSetDetailLevel(detailLevel);</span>
            
        try   {       
<span class="nc" id="L331">            return (ShiftBidder) getObjectByID(shiftBidderID);</span>
        } finally   {
<span class="nc" id="L333">            resetDetailLevel(); </span>
        }   
    }

    public Collection getShiftBiddersByIDs(Collection shiftBidderIDs, boolean orderByIDs, long detailLevel) 
        throws Exception {
        
<span class="nc" id="L340">        saveAndSetDetailLevel(detailLevel);</span>
            
        try   {       
<span class="nc bnc" id="L343" title="All 2 branches missed.">            if (shiftBidderIDs.isEmpty()) return Collections.EMPTY_LIST;</span>
            
<span class="nc" id="L345">            Collection coll = getObjectsByIDs(shiftBidderIDs);</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">            coll = (coll != null)?coll:Collections.EMPTY_LIST;</span>
            
<span class="nc bnc" id="L348" title="All 4 branches missed.">            if (orderByIDs &amp;&amp; !coll.isEmpty()) {</span>
<span class="nc" id="L349">                coll = RequestUtil.orderVOsByGivenIDs(shiftBidderIDs, (List) coll);</span>
            }
            
<span class="nc" id="L352">            return coll;</span>
        } finally   {
<span class="nc" id="L354">            resetDetailLevel();</span>
        }   
    }
    
    /**
     * if bidderStatus is less than (&amp;lt;) 0, all shift bidders in the auction are returned.
     * otherwise only bidders with the specified status are returned
     * 
     * @param auctionID
     * @param orgID
     * @param detailLevel
     * @return
     */
    public Collection getShiftBiddersForAuction(ID auctionID, Collection orgIDs, 
        int bidderStatus, int sortBy, int sortDir, long detailLevel) throws Exception {
            
<span class="nc" id="L370">        saveAndSetDetailLevel(detailLevel);</span>
<span class="nc" id="L371">        setSortCriteria(sortBy);</span>
<span class="nc" id="L372">        setSortDirection(sortDir);</span>
            
        try  {
<span class="nc bnc" id="L375" title="All 2 branches missed.">            if ( !orgIDs.isEmpty() )  {</span>
<span class="nc" id="L376">                setFilterExpr(new FilterExpr(FilterExpr.LHS_ORGID, FilterExpr.OP_IN, orgIDs), true);</span>
            }

<span class="nc" id="L379">            String orderByClause = getOrderByClause(sortBy, sortDir);</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">            String whereSubClause = &quot; A.SHIFTBIDAUCTIONID = &quot; + auctionID + </span>
                ((bidderStatus &lt; 0)?&quot;&quot;:&quot; AND A.STATUS = &quot; + bidderStatus);

<span class="nc" id="L383">            Collection bidders = null;</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">            if ( StringUtil.isEmpty(orderByClause) ) {                        </span>
<span class="nc" id="L385">                bidders = getObjects(whereSubClause);</span>
            } else {
<span class="nc" id="L387">                bidders = getObjects(whereSubClause, orderByClause);</span>
            } 
            
<span class="nc" id="L390">            return bidders;</span>
        } finally   {
            // prevent direct calls to getObjects() from reusing the last set detailLevel.
<span class="nc" id="L393">            resetDetailLevel();</span>
<span class="nc" id="L394">            resetSortCriteria();</span>
<span class="nc" id="L395">            resetSortDirection();</span>
<span class="nc" id="L396">            clearFilterExprsMap(); </span>
        }   
    }

    public Collection getShiftBidderIDsForAuction(ID auctionID, Collection orgIDs, 
        int bidderStatus, int sortBy, int sortDirection) throws Exception {
            
<span class="nc" id="L403">        setSortCriteria(sortBy);</span>
<span class="nc" id="L404">        setSortDirection(sortDirection);</span>

        try  {
<span class="nc bnc" id="L407" title="All 2 branches missed.">            if ( !orgIDs.isEmpty() )  {</span>
<span class="nc" id="L408">                setFilterExpr(new FilterExpr(FilterExpr.LHS_ORGID, FilterExpr.OP_IN, orgIDs), true);</span>
            }
            
            // The SELECT clause to be used. 
<span class="nc" id="L412">            StringBuffer strSQL = new StringBuffer(&quot; SELECT A.ID &quot;);</span>
            
            // add the FROM and WHERE clause 
<span class="nc" id="L415">            boolean whereClauseAdded = appendFromWhereStatement(strSQL);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">            String whereSubClause = &quot; A.SHIFTBIDAUCTIONID = &quot; + auctionID + </span>
                ((bidderStatus &lt; 0)?&quot;&quot;:&quot; AND A.STATUS = &quot; + bidderStatus);
<span class="nc" id="L418">            whereClauseAdded = DAOUtil.appendToWhereClause(strSQL, whereSubClause, whereClauseAdded);</span>
            
            // add ORDER BY clause
<span class="nc" id="L421">            String orderByClause = getOrderByClause(sortBy, sortDirection);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">            if ( !StringUtil.isEmpty(orderByClause) ) {</span>
<span class="nc" id="L423">                strSQL.append(&quot; &quot;).append(orderByClause);</span>
            }                        

            // execute SQL and return results.
<span class="nc" id="L427">            Collection bidderIDs = DAOUtil.getIDsUsingSQLQuery(getDMO(), strSQL.toString());</span>
<span class="nc" id="L428">            return bidderIDs;             </span>
        } finally   {
<span class="nc" id="L430">            resetSortCriteria();</span>
<span class="nc" id="L431">            resetSortDirection();</span>
<span class="nc" id="L432">            clearFilterExprsMap(); </span>
        }   
    }

    /**
     * Get the &quot;ORDER BY&quot; SQL clause for the given shift bidder sort criteria.
     * 
     * @param sortBy
     * @param sortDirection
     * @return
     */
    private String getOrderByClause(int sortBy, int sortDirection) {
<span class="nc" id="L444">        StringBuffer orderByClause = null;</span>
        
        // get SQL column names to which the 'sortBy' criteria maps to.
<span class="nc" id="L447">        String[] sqlColNameArr = (String[]) m_sortByToSQLColNameMap.get(NumberFactory.newInteger(sortBy));        </span>
        // if SQL column names found (ie. sortBy criteria maps to SQL column names)
<span class="nc bnc" id="L449" title="All 2 branches missed.">        if (sqlColNameArr != null) {</span>
<span class="nc" id="L450">            orderByClause = new StringBuffer(64);</span>
            
            // this will be prepended in the first iteration of the loop.
<span class="nc" id="L453">            String separator = &quot; ORDER BY &quot;;</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">            for (int i = 0; i &lt; sqlColNameArr.length; i++) {</span>
<span class="nc" id="L455">                String sqlColName = sqlColNameArr[i];</span>

<span class="nc" id="L457">                orderByClause.append(separator).append(sqlColName).append(' ')</span>
<span class="nc" id="L458">                    .append(DAOUtil.getSortDirection(sortDirection));</span>
                
<span class="nc" id="L460">                separator = &quot;, &quot;;                </span>
            }
        }
        
<span class="nc bnc" id="L464" title="All 2 branches missed.">        return (orderByClause == null)?&quot;&quot;:orderByClause.toString();</span>
    }

    /**
     * Retrieve shift bidders with status == unadded and flag 'isSerializedAuctionBidder' == true. 
     * This is the set of shift bidders eligible to be added to the serialized auction. 
     * 
     * @param auctionID
     * @param detailLevel
     * @return
     * @throws Exception
     */
    public Collection getSerializedAuctionBiddersForAuction(ID auctionID, long detailLevel) throws Exception {
<span class="nc" id="L477">        saveAndSetDetailLevel(detailLevel);</span>
            
        try  {
<span class="nc" id="L480">            return getObjects(&quot; A.SHIFTBIDAUCTIONID = &quot; + auctionID + </span>
                &quot; AND A.STATUS = &quot; + ShiftBidder.STATUS_NOT_ADDED + 
                &quot; AND A.&quot; + ShiftBidderFieldInfo.COLNAME_ISSERIALIZEDAUCTIONBIDDER + &quot; = &quot; + 
<span class="nc" id="L483">                JdmoUtil.formatBool(true)); </span>
        } finally   {
            // prevent direct calls to getObjects() from reusing the last set detailLevel.
<span class="nc" id="L486">            resetDetailLevel();</span>
<span class="nc" id="L487">            clearFilterExprsMap(); </span>
        }   
    }

    /**
     * get the shift bidder which corresponds to the given empID and auctionID.
     * 
     * @param empID
     * @param auctionID
     * @param detailLevel
     * @return
     */
    public ShiftBidder getShiftBidderForEmpAndAuctionID(ID empID, ID auctionID, long detailLevel) throws Exception {
<span class="nc" id="L500">        saveAndSetDetailLevel(detailLevel);</span>
            
        try   {       
<span class="nc" id="L503">            Collection shiftBidders = getObjects(COLNAME_EMPID + '=' + empID + &quot; AND &quot; + COLNAME_AUCTIONID + '=' + auctionID);</span>
    
<span class="nc bnc" id="L505" title="All 4 branches missed.">            assert shiftBidders.size() == 1:&quot;shiftBidders.size() == 1: &quot; + shiftBidders.size();</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">            if (shiftBidders.size() &gt; 1)</span>
<span class="nc" id="L507">                throw RequestUtil.createRmException(RmEjbLogBundleKey.INVALID_VALUE2, empID, auctionID, m_cat);</span>
    
            
<span class="nc bnc" id="L510" title="All 2 branches missed.">            return (ShiftBidder) ((shiftBidders.size() == 1)?shiftBidders.iterator().next():null);</span>
        } finally   {
<span class="nc" id="L512">            resetDetailLevel(); </span>
        }   
    }

	@SuppressWarnings(&quot;unchecked&quot;)
	public Collection&lt;ShiftBidder&gt; getShiftBidderForEmpAndAuctions(ID employeeID, Collection&lt;ID&gt; auctionIDs, long detailLevel)
			throws BbmFinderException, JdmoException {
<span class="nc" id="L519">		saveAndSetDetailLevel(detailLevel);</span>

		try {
<span class="nc" id="L522">			return getObjects(COLNAME_EMPID + '=' + employeeID + &quot; AND &quot; + COLNAME_AUCTIONID + &quot; IN &quot;</span>
<span class="nc" id="L523">					+ getDMO().createInClause(auctionIDs));</span>
		} finally {
<span class="nc" id="L525">			resetDetailLevel();</span>
		}
	}

    /**
     * Returns a map of empID to # of shifts (in the unpub schedule) for this employee during 
     * the specified interval.
     * 
     * @param campWorkResources
     * @return
     */
    public Map getNumOfShiftsDuringAuctionForEmps(Collection empIDs, Date startTime, Date endTime) throws Exception {
        //TODO: use SQL positional parameters.  This will allow the query to be cached by the DB server
        // DIRECT_DB_ACCESS
<span class="nc" id="L539">        String query = &quot;SELECT workResourceID, count(*) FROM shiftAssignment WHERE workResourceID IN &quot; + m_dmo.createInClause(empIDs) +</span>
<span class="nc" id="L540">         &quot; AND startTime &gt;= '&quot; + JdmoUtil.formatDBString(startTime) + &quot;' AND startTime &lt; '&quot; + JdmoUtil.formatDBString(endTime) + '\'' +</span>
         &quot; GROUP BY workResourceID &quot;;
         
<span class="nc" id="L543">         Map empIDToNumOfShiftsMap = DAOUtil.getFromSQLQueryColMap(getDMO(), query, new DAOUtil.ColumnMetaData[] {</span>
             new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_ID, 1),
<span class="nc" id="L545">             new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_INTEGER, 2)}, empIDs.size());</span>
             
<span class="nc" id="L547">         return empIDToNumOfShiftsMap; </span>
    }

    /**
     * 
     */
    public List getShiftBidderIDsWithNoApprovedBids(ID auctionID) throws Exception {
<span class="nc" id="L554">        String query = m_queryBidderIDsWithNoApprBidsChunk1 + auctionID + </span>
            m_queryBidderIDsWithNoApprBidsChunk2 + auctionID + m_queryBidderIDsWithNoApprBidsChunk3;

<span class="nc" id="L557">        List bidderIDs = DAOUtil.getIDsUsingSQLQuery(getDMO(), query);</span>
        
<span class="nc" id="L559">        return bidderIDs;                </span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public Collection&lt;ID&gt; getEmployeeIDsByAuctionAndRequestStatus(Collection&lt;ID&gt; auctionIDs, String[] requestStatuses) throws Exception {
        Collection&lt;ID&gt; result;
<span class="nc bnc" id="L565" title="All 4 branches missed.">        if (auctionIDs.isEmpty() || requestStatuses.length == 0) {</span>
<span class="nc" id="L566">            result = Collections.emptyList();</span>
        } else {
<span class="nc" id="L568">            result = DAOUtil.getIDsUsingSQLQuery(getDMO(),</span>
                &quot;SELECT DISTINCT SHIFTBIDDER.EMPLOYEEID FROM SHIFTBIDDER, SHIFTBIDREQUEST, REQUEST &quot;
                + &quot;WHERE SHIFTBIDDER.ID = SHIFTBIDREQUEST.SHIFTBIDDERID AND SHIFTBIDREQUEST.ID = REQUEST.ID &quot;
<span class="nc" id="L571">                + &quot;AND REQUEST.REQUESTSTATUS IN &quot; + DAOUtil.createInClause(requestStatuses) + &quot; AND SHIFTBIDREQUEST.SHIFTBIDAUCTIONID IN &quot;</span>
<span class="nc" id="L572">                + getDMO().createInClause(auctionIDs));</span>
        }
<span class="nc" id="L574">        return result;</span>
    }

	/**
	 * Get all employeeIDs associated with the specified auction.
	 * 
	 * @param aucID
	 * @return
	 */
	public Collection getEmpIDsForAuctionID(ID aucID) throws JdmoException {
<span class="nc" id="L584">		List empIDs = DAOUtil.getIDsUsingSQLQuery(getDMO(), m_sqlForEmpIDForAuctionID, new Object[] {aucID}, </span>
<span class="nc" id="L585">			new DAOUtil.ColumnMetaData[] {DAOUtil.ColumnMetaData.getColMetaDataForID()});</span>
			
<span class="nc" id="L587">		return empIDs;</span>
	}

	/**
	 * Get the shift bidders for the given employee ID collection.
	 * @param aucID
	 * @param empIDs
	 * @param detailLevel
	 * @return
	 * @throws BbmFinderException
	 * @throws JdmoException
	 */
	public Collection getShiftBiddersForEmpIDs(ID aucID, Collection empIDs, long detailLevel) throws BbmFinderException, JdmoException {
<span class="nc" id="L600">		saveAndSetDetailLevel(detailLevel);</span>
		
		try {
<span class="nc" id="L603">			return getObjects(&quot; WHERE &quot; + COLNAME_EMPID + &quot; IN &quot; + getDMO().createInClause(empIDs));</span>
		} finally {
<span class="nc" id="L605">			resetDetailLevel();</span>
		}
	}        
    /**
     * Do not call this method directly.  Instead use 
     * {@link com.bluepumpkin.ejb.rm.util.ShiftBidAuctionUtil#validateShiftBiddersForUpdateActionAndUpdate(ID, Collection, ShiftBidAuctionDAO, ShiftBidderDAO) validateShiftBiddersForUpdateActionAndUpdate}
     * or {@link com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionManagerEJB#validateShiftBidderForFetchActionAndUpdate(ShiftBidder, ShiftBidderDAO, Collection, Map) validateShiftBidderForFetchActionAndUpdate}
     * 
     * @param auctionID
     * @param shiftBidders
     */
    public void updateShiftBidders(Collection shiftBidders) throws Exception {
<span class="nc" id="L617">        updateObjects(shiftBidders);</span>
<span class="nc" id="L618">    }</span>

    /**
     * Do not call this method directly.  Instead use 
     * {@link com.bluepumpkin.ejb.rm.util.ShiftBidAuctionUtil#validateShiftBiddersForUpdateActionAndUpdate(ID, Collection, ShiftBidAuctionDAO, ShiftBidderDAO) validateShiftBiddersForUpdateActionAndUpdate}
     * or {@link com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionManagerEJB#validateShiftBidderForFetchActionAndUpdate(ShiftBidder, ShiftBidderDAO, Collection, Map) validateShiftBidderForFetchActionAndUpdate}
     * 
     * &lt;p&gt; If parameter bidderIDs != null then only specified bidders are flagged.  If not, all bidders
     * in the auction are flagged.
     * 
     * &lt;p&gt; For the set of bidders from above: 
     * &lt;li&gt; if parameter isSeializedAuctionBidder == true, set flag 'isSerializedAuctionBidder' to true
     * for only the **unadded** bidders.  The 'added' bidders are ignored.  
     * &lt;li&gt; if parameter isSerializedAuctionBidder == false, reset flag 'isSerializedAuctionBidder' 
     * irrespective of thier status being added or unadded.
     *  
     * @param auctionID
     * @param bidderIDs
     * @param isSerializedAuctionBidder
     */
    public void updateIsSerializedAuctionForBidderIDs(ID auctionID, Collection bidderIDs, 
        boolean isSerializedAuctionBidder) throws Exception {
<span class="nc" id="L640">        Jdmo dmo = getDMO();</span>

        // mixing a string buffer and string is not recommeneded.  But this is done below for readability.
        // update shift bidders in this auction
<span class="nc" id="L644">        String updateStmtPrefix = &quot;UPDATE &quot; + m_fieldInfo.getTableName() + &quot; SET &quot; + </span>
            ShiftBidderFieldInfo.COLNAME_ISSERIALIZEDAUCTIONBIDDER + &quot; = &quot; +  
<span class="nc" id="L646">            JdmoUtil.formatBool(isSerializedAuctionBidder) + &quot; WHERE &quot; +</span>
            ShiftBidderFieldInfo.COLNAME_AUCTIONID + &quot; = &quot; + auctionID; 
            
        
<span class="nc" id="L650">        StringBuffer updateStmtBuf = new StringBuffer(updateStmtPrefix.length() * 2);</span>
<span class="nc" id="L651">        updateStmtBuf.append(updateStmtPrefix);</span>
        
        // if flag is being set to true, update only unadded bidders.  If flag is being reset,
        // then reset all bidders 
<span class="nc bnc" id="L655" title="All 2 branches missed.">        if (isSerializedAuctionBidder) {</span>
<span class="nc" id="L656">            updateStmtBuf.append(&quot; AND &quot; + ShiftBidderFieldInfo.COLNAME_STATUS + &quot; = &quot; + ShiftBidder.STATUS_NOT_ADDED);</span>
        }
        
        // if bidderID set provided, use it.  Otherwise applies to all bidders in the auction.
<span class="nc bnc" id="L660" title="All 4 branches missed.">        if (bidderIDs != null &amp;&amp; !bidderIDs.isEmpty()) {</span>
<span class="nc" id="L661">            updateStmtBuf.append(&quot; AND ID IN &quot;).append(dmo.createInClause(bidderIDs));</span>
        }
        
<span class="nc" id="L664">        dmo.executeCommand(updateStmtBuf.toString());   </span>
<span class="nc" id="L665">    }</span>

    /**
     * gets the max rank for all employees in the system. 
     * 
     * @return
     */
    public int getMaxRankNumberForEmps() throws Exception {
<span class="nc" id="L673">        Integer maxRank = (Integer) DAOUtil.getFromSQLQuerySingleValue(getDMO(), </span>
            &quot;SELECT MAX(RANK) FROM EMPLOYEERANK&quot;, COLMETADATA_INT_ONE);
        
<span class="nc" id="L676">        return maxRank.intValue();</span>
    }

	/**
	 * @param aucID
	 * @param empIDsToBeRemovedFromAuc
	 */
	public void deleteShiftBiddersByEmpIDs(ID aucID, Collection empIDs) throws JdmoException  {
<span class="nc" id="L684">		String sql = m_sqlForBidderIDsFromEmpIDsPrefix + getDMO().createInClause(empIDs);</span>
		
<span class="nc" id="L686">		com.bluepumpkin.ejb.bbm.dao.DAOUtil.deleteObjects(getDMO(), ShiftBidderFieldInfo.m_strTableName, sql);</span>
<span class="nc" id="L687">	}</span>

	//===================================================================
	//  main - for test only
	//===================================================================
	/*public static void main(String[] args) throws Exception {

		System.out.println(&quot;*** ShiftBidderDAO.main ***&quot;);

		long oneDay = 24*60*60*1000;
		long oneHour = 60*60*1000;
		long oneMinute = 60*1000;
		long oneSecond = 1000;

		long currentTimeMillis = System.currentTimeMillis();

		ShiftBidderDAO shiftBidderDao = new ShiftBidderDAO();

		if( false ) {

			System.out.println(&quot;*** ShiftBidderDAO.findById ***&quot;);
			ShiftBidder shiftBidder = (ShiftBidder)shiftBidderDao.getObjectByID(new ID(1));
			System.out.println(&quot;***getObjectByID shiftBidder:&quot;+shiftBidder);
		}

		if( true ) {

			System.out.println(&quot;*** ShiftBidderDAO.create ***&quot;);
			ShiftBidder shiftBidder = new ShiftBidder();
			shiftBidder.setEmployeeId(new ID(53));
			shiftBidder.setShiftBidAuctionId(new ID(501));
			shiftBidder.setDeadlineDate(new Date(currentTimeMillis));

			System.out.println(&quot;*** shiftBidder:&quot;+shiftBidder);

			ID id = shiftBidderDao.createObject(shiftBidder);
			System.out.println(&quot;***createObject id:&quot;+id);
		}
	}*/
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>