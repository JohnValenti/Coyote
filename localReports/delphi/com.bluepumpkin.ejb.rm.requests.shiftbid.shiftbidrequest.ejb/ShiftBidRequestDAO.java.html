<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftBidRequestDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb</a> &gt; <span class="el_source">ShiftBidRequestDAO.java</span></div><h1>ShiftBidRequestDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb;

import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoPCommand;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestAggregateDAO;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.FilterExpr;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestFieldInfo;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionDAO;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableSchedule;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequestFieldInfo;
import com.bluepumpkin.ejb.rm.util.DAOUtil;

/**
 * 
 * see {@link com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionManager ShiftBidAuctionManager}
 * for a description of the shift bidding process. 
 * 
 * Title:        ShiftBidRequestDAO
 * Description:  DAO class for ShiftBidRequest
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc.
 * @author       Robert Granat
 * @version 1.0
 */

public class ShiftBidRequestDAO extends RequestAggregateDAO {
<span class="nc" id="L47">    private static Category m_cat = Log.initCategory( ShiftBidRequestDAO.class.getName());</span>

    /**
     * This is a member field (and not a static field) as each DAO instance can be assigned
     * one among a set of FieldInfo objects.  The assigned
     * FieldInfo reflects the chosen parentID field (of the VO) to use when this DAO
     * serves as a childDAO. (childDAO is created by the parentDAO).
     * 
     * For instance, a shiftBidRequest can be either a ShiftBidder or ShiftBidAuction's child.
     */
<span class="nc" id="L57">	private static ShiftBidRequestFieldInfo m_fieldInfo = new ShiftBidRequestFieldInfo();</span>
    
    //private Class m_parentDAO = null;

    // not initialized here since m_fieldInfo necessary for obtaining the column name is null.
<span class="nc" id="L62">    private static String COLNAME_SHIFTBIDDERID = </span>
<span class="nc" id="L63">        m_fieldInfo.getFieldName(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_I_SHIFTBIDDERID); </span>
        
<span class="nc" id="L65">    private static final DAOUtil.ColumnMetaData COLMETADATA_INT_ONE = </span>
        new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_INTEGER, 1);

<span class="nc" id="L68">    private static final DAOUtil.ColumnMetaData[] COLMETADATAARR_ID_ONE_INT_TWO = { </span>
        new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_ID, 1),
        new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_INTEGER, 2),       
    };

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.rm.requests.common.ejb.RequestAggregateDAO#getRequestType()
     */
    protected String getRequestType() {
<span class="nc" id="L77">        return Request.REQUESTTYPE_SHIFTBID;</span>
    }

	protected FieldInfo getFieldInfo() {
<span class="nc" id="L81">			return m_fieldInfo;</span>
	}

    public ShiftBidRequestDAO(long detailLevel) {
        //TODO: use super() in other requestAgg DAOs
<span class="nc" id="L86">        super(detailLevel);        </span>
<span class="nc" id="L87">    }</span>

    public ShiftBidRequestDAO(Jdmo dmo, /*Class parentDAO, */long detailLevel) {
        //TODO: use super() in other requestAgg DAOs
<span class="nc" id="L91">        super(dmo, /*parentDAO, */detailLevel);        </span>
<span class="nc" id="L92">    }</span>

	protected ValueObjectBase createValueObject()
	{
        // adjust detail level to include DL_EMPLOYEE and DL_AUCTION if any of the following detailLevel
        // is used to retrieve requests.  This adjustment applies to all 
        // shift bid requests fetched by DAOBase.getObjectsGivenFullSqlQuery() method.
<span class="nc" id="L99">        long detailLevelToCheck = ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |</span>
            ShiftBidRequest.DL_SCORECOMPUTED_FOR_SHIFTBID_REQUEST;        
        // the detail levels added below are necessary to compute the score for a shift bid request.
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if ( (getDetailLevel() &amp; detailLevelToCheck) != 0 ) </span>
<span class="nc" id="L103">            addDetailLevel(ShiftBidRequest.DL_EMPLOYEE | ShiftBidRequest.DL_SHIFTBID_AUCTION);</span>
        
<span class="nc" id="L105">	    return (new ShiftBidRequest(getDetailLevel()));</span>
	}


    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.bbm.dao.DAONode#needToLoadChildObjects()
     */
    protected boolean needToLoadChildObjects() {
<span class="nc" id="L113">        long detailLevelsToCheck = </span>
            ShiftBidRequest.DL_SHIFTBID_AUCTION |
            ShiftBidRequest.DL_SHIFTBIDDER | 
            ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL |
            ShiftBidRequest.DL_EMPLOYEE |
            ShiftBidRequest.DL_BIDDABLESCHEDULE_IDS |
            ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |            
            ShiftBidRequest.DL_SCORECOMPUTED_FOR_SHIFTBID_REQUEST |
            ShiftBidRequest.DL_BONUSTOBEAWARDED_FOR_SHIFTBID_REQUEST;
            
<span class="nc bnc" id="L123" title="All 2 branches missed.">        return (getDetailLevel() &amp;  detailLevelsToCheck) != 0; </span>
    }

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.bbm.dao.DAONode#needToLoadChildObjects(int)
     */
    protected boolean needToLoadChildObjects(int childType) {
<span class="nc bnc" id="L130" title="All 4 branches missed.">        switch (childType)  {</span>
            case ShiftBidRequestFieldInfo.SHIFTBIDAUCTION_CHILDTYPE: {
<span class="nc" id="L132">                long detailLevelToCheck = ShiftBidRequest.DL_SHIFTBID_AUCTION |</span>
                    ShiftBidRequest.DL_SCORECOMPUTED_FOR_SHIFTBID_REQUEST | //need auction startTime and endTime for finding employee ORGID
                    BiddableSchedule.DL_BIDRANK_FOR_SHIFTBIDREQUEST;
                                     
<span class="nc bnc" id="L136" title="All 2 branches missed.">                return (getDetailLevel() &amp; detailLevelToCheck) != 0;</span>
            }
            case ShiftBidRequestFieldInfo.SHIFTBIDDER_CHILDTYPE: {
                //TODO: must DL_EMPLOYEE load the employee child object from Request.getEmpID() instead of ShiftBidder.getEmpID()?
<span class="nc" id="L140">                long detailLevelsToCheck = ShiftBidRequest.DL_SHIFTBIDDER | ShiftBidRequest.DL_EMPLOYEE | </span>
                    ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
                    BiddableSchedule.DL_BIDRANK_FOR_SHIFTBIDREQUEST | 
                    ShiftBidRequest.DL_SCORECOMPUTED_FOR_SHIFTBID_REQUEST;
                    
<span class="nc bnc" id="L145" title="All 2 branches missed.">                return (getDetailLevel() &amp; detailLevelsToCheck) != 0;</span>
            }
            case ShiftBidRequestFieldInfo.SHIFTBIDREQUESTBIDDABLESCHEDULE_CHILDTYPE: {
<span class="nc" id="L148">                long detailLevelsToCheck = ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL | </span>
                    ShiftBidRequest.DL_BIDDABLESCHEDULE_IDS | 
                    ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
                    ShiftBidRequest.DL_BONUSTOBEAWARDED_FOR_SHIFTBID_REQUEST;
                    
<span class="nc bnc" id="L153" title="All 2 branches missed.">                return (getDetailLevel() &amp; detailLevelsToCheck) != 0;</span>
            }
            default:
<span class="nc" id="L156">                throw new IllegalArgumentException(&quot;childType = &quot; + childType);    </span>
        }
    }

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.bbm.dao.DAONode#createChildDAO(int)
     */
    protected DAOBase createChildDAO(int iType) {
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (iType == ShiftBidRequestFieldInfo.SHIFTBIDREQUESTBIDDABLESCHEDULE_CHILDTYPE)</span>
<span class="nc" id="L165">            return new ShiftBidRequestBiddableScheduleDAO(m_dmo, getClass(), getDetailLevel());</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">         else if (iType == ShiftBidRequestFieldInfo.SHIFTBIDAUCTION_CHILDTYPE) {</span>
//            long detLevel = getDetailLevel();
//            // if expired requests are being loaded, load assoc expired auction as well.
//            detLevel = ((detLevel &amp; RequestDetailLevel.DL_INCLUDE_EXPIRED) != 0)?
//                (detLevel | ShiftBidAuction.DL_INCLUDE_EXPIRED_AUCTION):detLevel;
            
<span class="nc" id="L172">            return new ShiftBidAuctionDAO(m_dmo, getDetailLevel());</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">         } else if (iType == ShiftBidRequestFieldInfo.SHIFTBIDDER_CHILDTYPE)</span>
<span class="nc" id="L174">            return new ShiftBidderDAO(m_dmo, /*getClass(), */ getDetailLevel());</span>
            
<span class="nc" id="L176">        return null;</span>
    }

    /**
     * @see com.bluepumpkin.ejb.rm.requests.common.ejb.RequestAggregateDAO#deleteRequestsByOrgSQLFilter(com.bluepumpkin.common.datatypes.ID, boolean, com.bluepumpkin.common.datatypes.ID, java.util.Date, java.util.Date)
     */
//    protected String getSQLFilterForRequestDeletion(ID orgID, boolean isForBranch, ID subType, Date startDate, Date endDate)
//        throws Exception {
//        Collection orgEmpIDs = RequestUtil.getEmployeeIDsInOrganization(orgID, isForBranch);
//    
//        StringBuffer sqlBuf = new StringBuffer(&quot;SELECT req.id FROM request req, shiftbidrequest sbr, shiftbidauction sba &quot; + 
//            &quot;WHERE req.id = sbr.id and sbr.shiftbidauctionid = sba.id and req.employeeid IN &quot; +
//            m_dmo.createInClause(orgEmpIDs));
//          
//        // startDate != null and endDate == null: delete requests for the dates more than &lt;n&gt; days in the past.
//        // startDate == null and endDate == null: delete all requests
//        // startDate != null and endDate != null: delete requests created between the dates.
//        if (startDate != null &amp;&amp; endDate == null) {
//            sqlBuf.append(&quot; AND sba.endTime &lt; '&quot; + m_dmo.formatDBString(startDate) + '\'');  
//        } else if (startDate == null &amp;&amp; endDate == null) {
//            // 
//        } else if (startDate != null &amp;&amp; endDate != null) {
//            // and req.submittedon between startDate and endDate
//            sqlBuf.append(&quot; AND req.submittedon BETWEEN '&quot; + m_dmo.formatDBString(startDate) + &quot;' AND '&quot; + m_dmo.formatDBString(endDate) + '\'');
//        }
//        
//        return sqlBuf.toString();
//    }

    /**
     * @param id
     * @param l
     * @return
     */
    public Collection getRequestsByShiftBidderID(ID shiftBidderID, long detailLevel) throws Exception {
<span class="nc" id="L211">        saveAndSetDetailLevel(detailLevel);</span>
        
        try  {
<span class="nc" id="L214">            return getObjects(COLNAME_SHIFTBIDDERID + &quot; = &quot; + shiftBidderID);</span>
        } finally  {
<span class="nc" id="L216">            resetDetailLevel();</span>
        }
    }
    
    /**
     * @param id
     * @param l
     * @return
     */
    public ID getApprovedRequestIDByShiftBidderAndAuctionID(ID shiftBidderID, ID auctionID) throws Exception {
<span class="nc" id="L226">    	String query = &quot;SELECT SBR.ID FROM SHIFTBIDREQUEST SBR, REQUEST REQ WHERE &quot; +</span>
        &quot; SBR.ID = REQ.ID &quot; +
        &quot; AND SBR.&quot; + ShiftBidRequestFieldInfo.COLNAME_SHIFTBIDDERID + &quot; = &quot; + shiftBidderID +
        &quot; AND SBR.&quot; + ShiftBidRequestFieldInfo.COLNAME_AUCTIONID + &quot; = &quot; + auctionID +  
        &quot; AND REQ.&quot; + RequestFieldInfo.COLNAME_REQUESTSTATUS + &quot; = '&quot; + RequestAuditTrail.STATUS_APPROVED + &quot;'&quot;;
     
<span class="nc" id="L232">	    ID approvedID = (ID) DAOUtil.getFromSQLQuerySingleValue(getDMO(), query, </span>
	            new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_ID, 1));
	            
<span class="nc" id="L235">	    return approvedID;</span>
    }

    /**
     * @param strings
     */
    public Collection getRequestsUsingFilter(FilterExpr[] filters, long detailLevel) throws Exception {
<span class="nc" id="L242">        saveAndSetDetailLevel(detailLevel);</span>
        
        try  {
<span class="nc" id="L245">            StringBuffer whereSubClause = new StringBuffer(128);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            for (int i = 0; i &lt; filters.length; i++) {</span>
                // obtain the filter.
<span class="nc" id="L248">                FilterExpr filter = filters[i];</span>

<span class="nc bnc" id="L250" title="All 2 branches missed.">                whereSubClause = (whereSubClause.length() != 0)?whereSubClause.append(&quot; AND &quot;):whereSubClause; </span>
                
                // if filter by request status
<span class="nc bnc" id="L253" title="All 2 branches missed.">                if (filter.getLHS() == FilterExpr.LHS_REQUESTSTATUS) {</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                    if (filter.getOperator() == FilterExpr.OP_IN) {</span>
<span class="nc" id="L255">                        String[] statusArr = (String[]) filter.getRHS();</span>
<span class="nc" id="L256">                        whereSubClause.append(&quot; A.REQUESTSTATUS IN &quot; + DAOUtil.createInClause(statusArr));</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                    } else if (filter.getOperator() == FilterExpr.OP_EQUALTO) {</span>
<span class="nc" id="L258">                        whereSubClause.append(&quot; A.REQUESTSTATUS = '&quot; + filter.getRHS() + '\'');</span>
                    }
                }
            
                // if filter by shiftBidderID
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if (filter.getLHS() == FilterExpr.LHS_BIDDERIDS) {</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                    if (filter.getOperator() == FilterExpr.OP_IN) {</span>
<span class="nc" id="L265">                        Collection bidderIDs = (Collection) filter.getRHS(); </span>
<span class="nc" id="L266">                        whereSubClause.append(&quot; B.SHIFTBIDDERID IN &quot; + m_dmo.createInClause(bidderIDs));</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">                    } else if (filter.getOperator() == FilterExpr.OP_EQUALTO) {</span>
<span class="nc" id="L268">                        whereSubClause.append(&quot; B.SHIFTBIDDERID = &quot; + filter.getRHS());                    </span>
                    }
                }
            }
            
<span class="nc" id="L273">            return getObjects(whereSubClause.toString());    </span>
        } finally {
<span class="nc" id="L275">            resetDetailLevel();</span>
        }
    }

    /**
     * Returns a map of shiftBidderID to # of shiftBidRequests for the bidder.
     * 
     * @param bidderIDs
     * @return
     * @throws Exception
     */
    public Map getNumOfShiftBidRequestsForBidders(Collection bidderIDs) throws Exception {
        // query for # of shift bid requests for each shift bidder.
<span class="nc" id="L288">        String query =  &quot;SELECT SHIFTBIDDERID, COUNT(*) AS NUMOFREQUESTS &quot; +</span>
        	&quot;FROM SHIFTBIDREQUEST A,REQUEST B WHERE SHIFTBIDDERID IN &quot; +
<span class="nc" id="L290">            m_dmo.createInClause(bidderIDs) +</span>
            &quot; AND B.ID=A.ID AND REQUESTSTATUS NOT IN ('&quot; + RequestAuditTrail.STATUS_WITHDRAWN + &quot;','&quot; + RequestAuditTrail.STATUS_INVALID +&quot;') &quot; +
            &quot;GROUP BY SHIFTBIDDERID&quot;;
                
        // columns to be fetched from the query. 
    
        // execute query and construct map of bidderID to # of ShiftBidRequests            
<span class="nc" id="L297">        Map bidderIDToNumOfBidReqsMap = DAOUtil.getFromSQLQueryColMap(m_dmo, query, </span>
<span class="nc" id="L298">            COLMETADATAARR_ID_ONE_INT_TWO, 3*bidderIDs.size());</span>
            
<span class="nc" id="L300">       return bidderIDToNumOfBidReqsMap;</span>
    }
        
    /**
     * check if a request with the given name exists for the given shiftBidder.  Returns the number of
     * requests with the given name.
     * 
     * @param shiftBidderID
     * @param reqName
     * @return
     */
    public List checkIfRequestWithNameExists(ID shiftBidderID, String reqName) throws Exception {
    	//check for single quotes in the name string, to prevent sql exception
<span class="nc" id="L313">    	reqName = StringUtil.replace(reqName, &quot;'&quot;, &quot;''&quot;);</span>
        //TODO: use SQL positional parameters.  This will allow the query to be cached by the DB server
<span class="nc" id="L315">        String query = &quot;SELECT ID FROM ShiftBidRequest WHERE &quot; + </span>
            ShiftBidRequestFieldInfo.COLNAME_SHIFTBIDDERID + &quot; = &quot; + shiftBidderID + 
            &quot; AND &quot; + ShiftBidRequestFieldInfo.COLNAME_NAME + &quot; = '&quot; + reqName + '\'';
         
<span class="nc" id="L319">         List reqIDs = DAOUtil.getIDsUsingSQLQuery(m_dmo, query);</span>
             
<span class="nc" id="L321">         return reqIDs; </span>
    }

    /**
     * @param empID
     * @param auctionID
     * @param statuses
     * @return
     */
    public int getNumOfBidsSubmittedForBidderID(ID bidderID, ID auctionID, String[] statuses) throws Exception {
<span class="nc" id="L331">        String query = &quot;SELECT COUNT(*) FROM SHIFTBIDREQUEST SBR, REQUEST REQ WHERE &quot; +</span>
            &quot; SBR.ID = REQ.ID &quot; +
            &quot; AND SBR.&quot; + ShiftBidRequestFieldInfo.COLNAME_SHIFTBIDDERID + &quot; = &quot; + bidderID +
            &quot; AND SBR.&quot; + ShiftBidRequestFieldInfo.COLNAME_AUCTIONID + &quot; = &quot; + auctionID +  
<span class="nc" id="L335">            &quot; AND REQ.&quot; + RequestFieldInfo.COLNAME_REQUESTSTATUS + &quot; IN &quot; + DAOUtil.createInClause(statuses);</span>
            
<span class="nc" id="L337">        Integer numOfBids = (Integer) DAOUtil.getFromSQLQuerySingleValue(getDMO(), query, </span>
                new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_INTEGER, 1));
                
<span class="nc bnc" id="L340" title="All 2 branches missed.">        return (numOfBids != null)?numOfBids.intValue():0;</span>
    }
    
    /**
     * Delete all Shift Bid requests for employees in the given organization
     * with biddable schedules starting during the given range.
     */
    public void deleteRequestsByStartDateRange(ID organizationID, boolean isForBranch, TimeRange range,
        ID subType) throws Exception {
<span class="nc" id="L349">    	Collection orgEmpIDs = RequestUtil.getEmployeeIDsInOrganization(organizationID, isForBranch,</span>
<span class="nc" id="L350">    			                                            range.getStartDate(), range.getEndDate());</span>
                        
<span class="nc" id="L352">    	StringBuffer sb = new StringBuffer(128);</span>
<span class="nc" id="L353">    	sb.append(&quot;SELECT DISTINCT REQ.ID &quot;)</span>
<span class="nc" id="L354">	    	.append(&quot;FROM REQUEST REQ, &quot;)</span>
<span class="nc" id="L355">	    	.append(&quot;SHIFTBIDREQUEST SBREQ, &quot;)</span>
<span class="nc" id="L356">	    	.append(&quot;SHIFTBIDREQSTBIDDABLESCHEDULE SBRBIDSCHED, &quot;)	</span>
<span class="nc" id="L357">	    	.append(&quot;BIDDABLESCHEDULE BIDSCHED, &quot;)</span>
<span class="nc" id="L358">	    	.append(&quot;BIDDABLESCHEDULEINSTANCE BIDSCHEDINST, &quot;)</span>
<span class="nc" id="L359">	    	.append(&quot;BIDDABLESHIFT BIDSHIFT, &quot;)</span>
<span class="nc" id="L360">	    	.append(&quot;SHIFTBIDDER SBDR, &quot;)</span>
<span class="nc" id="L361">	    	.append(&quot;SHIFTASSIGNMENT SA &quot;)</span>
<span class="nc" id="L362">	    	.append(&quot;WHERE  SBDR.EMPLOYEEID IN&quot;).append(m_dmo.createInClause(orgEmpIDs))</span>
<span class="nc" id="L363">	    	.append(&quot;AND REQ.ID = SBREQ.ID &quot;)</span>
<span class="nc" id="L364">	    	.append(&quot;AND SBREQ.SHIFTBIDDERID = SBDR.ID &quot;)</span>
<span class="nc" id="L365">	    	.append(&quot;AND SBRBIDSCHED.SHIFTBIDREQUESTID = SBREQ.ID &quot;)</span>
<span class="nc" id="L366">	    	.append(&quot;AND BIDSCHED.ID = SBRBIDSCHED.BIDDABLESCHEDULEID &quot;)</span>
<span class="nc" id="L367">	    	.append(&quot;AND BIDSCHEDINST.BIDDABLESCHEDULEID = BIDSCHED.ID &quot;)</span>
<span class="nc" id="L368">	    	.append(&quot;AND BIDSCHEDINST.ID = BIDSHIFT.BIDDABLESCHEDULEINSTANCEID &quot;)</span>
<span class="nc" id="L369">	    	.append(&quot;AND BIDSHIFT.SHIFTASSIGNMENTID = SA.ID &quot;)</span>
<span class="nc" id="L370">	    	.append(&quot; AND SA.STARTTIME BETWEEN '&quot;).append(JdmoUtil.formatDBString(range.getStartDate()))</span>
<span class="nc" id="L371">	        .append(&quot;' AND '&quot;).append(JdmoUtil.formatDBString(range.getEndDate())).append('\'');</span>
    	
<span class="nc bnc" id="L373" title="All 2 branches missed.">        if (!StringUtil.isEmpty(sb.toString())) deleteObjects(sb.toString());</span>
<span class="nc" id="L374">    }</span>

	/**
	 * &lt;p&gt;
	 * Gets the number of requests by the employee for the specified list of auctions.
	 * &lt;/p&gt;
	 * &lt;p&gt;
	 * The map's key is the auction ID and the value is the count.
	 * &lt;/p&gt;
	 */
	public Map&lt;ID, Integer&gt; getRequestCountsForEmployeeAuctions(ID employeeID, Collection&lt;ID&gt; auctionIDs)
			throws JdmoException {
<span class="nc" id="L386">		Map&lt;ID, Integer&gt; results = new HashMap&lt;ID, Integer&gt;();</span>

<span class="nc" id="L388">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L389">		sb.append(&quot;select sbr.SHIFTBIDAUCTIONID, count(r.ID) as COUNT from REQUEST r inner join SHIFTBIDREQUEST sbr on sbr.ID = r.ID&quot;);</span>
<span class="nc" id="L390">		sb.append(&quot; where r.EMPLOYEEID = &quot;).append(employeeID.toInt()).append(&quot; AND sbr.SHIFTBIDAUCTIONID in &quot;);</span>
<span class="nc" id="L391">		sb.append(m_dmo.createInClause(auctionIDs));</span>
<span class="nc" id="L392">		sb.append(&quot; group by sbr.SHIFTBIDAUCTIONID&quot;);</span>

<span class="nc" id="L394">		JdmoRowset rows = m_dmo.createRowset(sb.toString());</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">		while (rows.next()) {</span>
<span class="nc" id="L396">			ID auctionID = rows.getID(&quot;SHIFTBIDAUCTIONID&quot;);</span>
<span class="nc" id="L397">			int count = rows.getInt(&quot;COUNT&quot;);</span>
<span class="nc" id="L398">			results.put(auctionID, count);</span>
<span class="nc" id="L399">		}</span>

<span class="nc" id="L401">		return results;</span>
	}

	/**
	 * Updates the preferences for the specified requests.
	 */
	public void updatePreferences(Collection&lt;ShiftBidRequest&gt; requests) throws JdmoException {
<span class="nc" id="L408">		JdmoPCommand command = m_dmo.createPCommand(&quot;update SHIFTBIDREQUEST set PREFERENCE = ? where id = ?&quot;);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">		for (ShiftBidRequest request : requests) {</span>
<span class="nc" id="L410">			Object[] params = new Object[] { request.getPreference(), request.getID().toInt() };</span>
<span class="nc" id="L411">			m_dmo.executePCommand(command, params);</span>
<span class="nc" id="L412">		}</span>
<span class="nc" id="L413">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>