<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>NotificationUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.notification.util</a> &gt; <span class="el_source">NotificationUtil.java</span></div><h1>NotificationUtil.java</h1><pre class="source lang-java linenums">/*
 * Created on Apr 17, 2004
 *
 * To change the template for this generated file go to
 * Window&amp;gt;Preferences&amp;gt;Java&amp;gt;Code Generation&amp;gt;Code and Comments
 */
package com.bluepumpkin.ejb.rm.notification.util;

import java.io.IOException;
import java.io.StringReader;
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.xml.parsers.DocumentBuilder;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;

import weblogic.apache.xerces.parsers.DOMParser;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.localization.DefaultLocalizationManager;
import com.bluepumpkin.ejb.bbm.notifydelivery.model.NotifyDeliveryMedia;
import com.bluepumpkin.ejb.bbm.notifydelivery.model.NotifyMessageTarget;
import com.bluepumpkin.ejb.bbm.notifydelivery.model.NotifyRuleDelivery;
import com.bluepumpkin.ejb.bbm.notifyrules.model.ActionDetail;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftOTExtension;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestFieldInfo;
import com.bluepumpkin.ejb.rm.requests.custshift.model.CustShiftReq;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.FlexRequestMakeup;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.util.CustomShiftEJBUtil;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.bbm.util.NetworkUtil;
import com.witness.ejb.core.base.CoreFinderException;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.UserManager;
import com.witness.ejb.core.security.model.User;

/**
 * @author rrajendran
 *
 * To change the template for this generated type comment go to
 * Window&amp;gt;Preferences&amp;gt;Java&amp;gt;Code Generation&amp;gt;Code and Comments
 */
<span class="nc" id="L80">public class NotificationUtil {</span>

	public static final String m_xmlAttrDescription = &quot;description&quot;;
	public static final String m_xmlElemSwapType = &quot;swaptype&quot;;
	public static final String m_xmlAttrValue = &quot;value&quot;;
	public static final String m_xmlElemEmployeeName = &quot;employeename&quot;;
	public static final String m_xmlElemActivity = &quot;activity&quot;;
	public static final String m_xmlElemStartTime = &quot;starttime&quot;;
	public static final String m_xmlElemEndTime = &quot;endtime&quot;;
	public static final String m_xmlElemRequestAggregate = &quot;requestaggregate&quot;;
	public static final String m_xmlElemRequest = &quot;request&quot;;
	public static final String m_xmlElemSubmittedOn = &quot;submittedon&quot;;
	public static final String m_xmlElemStatus = &quot;status&quot;;
	public static final String m_xmlElemSwapItemType = &quot;swapitemtype&quot;;
	public static final String m_xmlElemRequestName = &quot;requestname&quot;;
	public static final String m_xmlElemAuctionStartTime = &quot;auctionstarttime&quot;;
	public static final String m_xmlElemAuctionEndTime = &quot;auctionendtime&quot;;
	public static final String m_xmlElemShiftAssignment = &quot;shiftassignment&quot;;
	public static final String m_xmlElemTOChoice = &quot;tochoice&quot;;
	public static final String m_xmlElemCSType = &quot;CSTYPE&quot;;
	public static final String m_xmlElemDuration = &quot;duration&quot;;
	public static final String m_xmlElemShift = &quot;shift&quot;;
	public static final String m_xmlElemOvertime = &quot;overtime&quot;;
	public static final String m_xmlElemOvertimeBefore = &quot;overtimebefore&quot;;
	public static final String m_xmlElemOvertimeAfter = &quot;overtimeafter&quot;;
	public static final String m_xmlElemExtension = &quot;extension&quot;;
	public static final String m_xmlElemType = &quot;type&quot;;
	public static final String xmlElemGap = &quot;gap&quot;;
	public static final String xmlElemMakeUps = &quot;makeups&quot;;
	public static final String xmlElemMakeUp = &quot;makeup&quot;;


<span class="nc" id="L112">	private static ResourceBundle m_rmEjbResBundleInAppDefLocale = null;</span>
	static {
<span class="nc" id="L114">		m_rmEjbResBundleInAppDefLocale = DefaultLocalizationManager.getDefaultInstance().getLocalizer().</span>
<span class="nc" id="L115">			getBundle(RmEjbBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L116">	}</span>

	/**
	 * Used to retrieve an XML representation of the request for &quot;request notification&quot;
	 *
	 * @param parser
	 * @param localizer
	 * @param empIDToTZMap
	 * @return
	 */
	public static Element getXMLLocalizedFrag(Element element, RequestAggregate reqAgg, Document doc,
		Localizer localizer, Map empIDToTZMap,  String requestStatus) throws Exception {

		/*
		&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
		&lt;requeststatuschange description=&quot;Shift Swap Request Notification&quot;&gt;
			&lt;request&gt;
				&lt;submittedon description=&quot;Submitted On&quot; value=&quot;1/1/2001&quot; /&gt;
				&lt;status description=&quot;Request Status&quot; value=&quot;pending&quot; /&gt;
			&lt;/request&gt;

			&lt;swaptype description=&quot;Swap Type&quot; value=&quot;two-way&quot; /&gt;

			&lt;shiftswapitem&gt;
				&lt;employeename description=&quot;Employee Name&quot; value=&quot;employee1&quot; /&gt;
				&lt;starttime description=&quot;Start Time&quot; value=&quot;1/1/2001&quot; /&gt;
				&lt;endtime description=&quot;End Time&quot; value=&quot;1/2/2001&quot; /&gt;
				&lt;swapitemtype description=&quot;Swap Item Type&quot; value=&quot;shift&quot; /&gt;
			&lt;/shiftswapitem&gt;

		&lt;/requeststatuschange&gt;
		*/

		/*
		&lt;requeststatuschange&gt;
			&lt;requestaggregate description=&quot;Timeoff Request&quot;&gt;

				&lt;request&gt;
					&lt;submittedon description=&quot;Submitted On&quot; value=&quot;1/1/2001&quot; /&gt;
					&lt;status description=&quot;Request Status&quot; value=&quot;pending&quot; /&gt;
				&lt;/request&gt;

				&lt;activity description=&quot;&quot; name=&quot;&quot;&gt;
				&lt;employeename description=&quot;Employee Name&quot; value=&quot;employee1&quot; /&gt;

				&lt;tochoice description=&quot;Approved TOChoice | TOChoice #xx&quot; value=&quot;&quot;&gt;
					&lt;starttime description=&quot;Start Time&quot; value=&quot;1/1/2001&quot; /&gt;
					&lt;endtime description=&quot;End Time&quot; value=&quot;1/2/2001&quot; /&gt;
				&lt;/tochoice&gt;
			&lt;/requestaggregate&gt;
		&lt;/requeststatuschange&gt;
		 */

		/*
		&lt;requeststatuschange&gt;
			&lt;requestaggregate description=&quot;Timeoff Request&quot;&gt;
				&lt;request&gt;
					&lt;submittedon description=&quot;Submitted On&quot; value=&quot;1/1/2001&quot; /&gt;
					&lt;status description=&quot;Request Status&quot; value=&quot;pending&quot; /&gt;
				&lt;/request&gt;

				&lt;requestname description=&quot;&quot; value=&quot;&quot;/&gt;
				&lt;employeename description=&quot;Employee Name&quot; value=&quot;employee1&quot; /&gt;
				&lt;auctionstarttime description=&quot;&quot; value=&quot;&quot;/&gt;
				&lt;auctionendtime description=&quot;&quot; value=&quot;&quot;/&gt;

				&lt;shiftassignment&gt;
					&lt;starttime description=&quot;Start Time&quot; value=&quot;1/1/2001&quot; /&gt;
					&lt;endtime description=&quot;End Time&quot; value=&quot;1/2/2001&quot; /&gt;
				&lt;/shiftassignment&gt;

			&lt;/requestaggregate&gt;
		&lt;/requeststatuschange&gt;
		 */
		/* verify if the request type is TO or Flex and update the request type to call the right template
		 * as both TO and Flex are stored as TO in DB.
		 * adding the conversion here in notification part instead of at call level is to avoid
		 * the rest of the calls to reqAgg object (if any) being impacted
		 */

<span class="nc bnc" id="L196" title="All 2 branches missed.">		if(reqAgg.isFlexTimeRequest()) {</span>
<span class="nc" id="L197">			reqAgg.getAggregatedRequest().setFieldValue(RequestFieldInfo.REQUEST_S_REQUESTTYPE, Request.REQUESTTYPE_FLEXTIME);</span>
		}

		//create &lt;requestaggregate&gt;
<span class="nc bnc" id="L201" title="All 2 branches missed.">        Element rootElem = RequestUtil.createElemAndAppendAsChild(element, element==null?doc:null, m_xmlElemRequestAggregate, null,</span>
                m_xmlAttrDescription,
<span class="nc" id="L203">                m_rmEjbResBundleInAppDefLocale.getString(getBundleKey(reqAgg.getRequestType())));</span>

        //getString(RmEjbBundleKey.EMPLOYEE)


		//doc.appendChild(rootElem);

		//create &lt;request&gt;
<span class="nc" id="L211">		createAndAppendXMLLocalizedFragForRequest(reqAgg.getAggregatedRequest(), rootElem,</span>
			localizer, empIDToTZMap, requestStatus);

<span class="nc bnc" id="L214" title="All 2 branches missed.">		if (reqAgg.isShiftSwapRequest()) {</span>
<span class="nc" id="L215">			createAndAppendXMLLocalizedFromForSSReq((ShiftSwapRequest) reqAgg, rootElem, localizer, empIDToTZMap);</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">		} else if (reqAgg.isTimeOffRequest()) {</span>
<span class="nc" id="L217">			createAndAppendXMLLocalizedFromForTOReq((TORequest) reqAgg, rootElem, localizer, empIDToTZMap);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">		} else if (reqAgg.isShiftBidRequest()) {</span>
<span class="nc" id="L219">			createAndAppendXMLLocalizedFromForSBReq((ShiftBidRequest) reqAgg, rootElem, localizer, empIDToTZMap);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">		} else if (reqAgg.isCustShiftRequest()) {</span>
<span class="nc" id="L221">			createAndAppendXMLLocalizedFromForCSReq((CustShiftReq) reqAgg, rootElem, localizer, empIDToTZMap);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">		} else if (reqAgg.isFlexTimeRequest()) {</span>
<span class="nc" id="L223">			createAndAppendXMLLocalizedFromForFlexReq((TORequest) reqAgg, rootElem, localizer, empIDToTZMap);</span>
		}

<span class="nc" id="L226">		return rootElem;</span>
	}

    /**
     * Given a request type or request status string, return the corresponding RmEjbBundleKey string.
     * @param source The string that needs to be translated.
     * @return the RmEjbBundleKey string corresponding to the source parameter.
     */
    public static String getBundleKey(String source)
    {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (source.equals(Request.REQUESTTYPE_TIMEOFF)) {</span>
<span class="nc" id="L237">            return RmEjbBundleKey.TIME_OFF;</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">        } else if (source.equals(Request.REQUESTTYPE_FLEXTIME)) {</span>
<span class="nc" id="L239">        	 return RmEjbBundleKey.FLEX_TIME;</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">        } else if (source.equals(Request.REQUESTTYPE_SHIFTSWAP)) {</span>
<span class="nc" id="L241">            return RmEjbBundleKey.SHIFT_SWAP;</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">        } else if (source.equals(Request.REQUESTTYPE_SHIFTBID)) {</span>
<span class="nc" id="L243">            return RmEjbBundleKey.SHIFT_BID;</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">        } else if (source.equals(Request.REQUESTTYPE_CUSTSHIFT)) {</span>
<span class="nc" id="L245">            return RmEjbBundleKey.CUSTOM_SHIFT;</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_PENDING)) {</span>
<span class="nc" id="L247">            return RmEjbBundleKey.STATUS_PENDING;</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L249">            return RmEjbBundleKey.STATUS_APPROVED;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_DENIED)) {</span>
<span class="nc" id="L251">            return RmEjbBundleKey.STATUS_DENIED;</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_ESCALATED)) {</span>
<span class="nc" id="L253">            return RmEjbBundleKey.STATUS_ESCALATED;</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_NEGOTIATION)) {</span>
<span class="nc" id="L255">            return RmEjbBundleKey.STATUS_NEGOTIATION;</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_TENTATIVE)) {</span>
<span class="nc" id="L257">            return RmEjbBundleKey.STATUS_TENTATIVE;</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WITHDRAWN)) {</span>
<span class="nc" id="L259">            return RmEjbBundleKey.STATUS_WITHDRAWN;</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_INVALID)) {</span>
<span class="nc" id="L261">            return RmEjbBundleKey.STATUS_INVALID;</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WAITLIST)) {</span>
<span class="nc" id="L263">            return RmEjbBundleKey.STATUS_WAITLIST;</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WITHDRAW_REQUEST)) {</span>
<span class="nc" id="L265">            return RmEjbBundleKey.STATUS_WITHDRAW_REQUEST;</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WITHDRAW_REJECT)) {</span>
<span class="nc" id="L267">            return RmEjbBundleKey.STATUS_WITHDRAW_REJECT;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WITHDRAW_ACCEPT)) {</span>
<span class="nc" id="L269">            return RmEjbBundleKey.STATUS_WITHDRAW_ACCEPT;</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WITHDRAW_CANCEL)) {</span>
<span class="nc" id="L271">            return RmEjbBundleKey.STATUS_WITHDRAW_CANCEL;</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION)) {</span>
<span class="nc" id="L273">        	return RmEjbBundleKey.STATUS_WITHDRAW_NEGOTIATION;</span>
        }
<span class="nc" id="L275">        return source;</span>
    }

	/**
	 * @param request
	 * @param rootElem
	 * @param localizer
	 * @param empIDToTZMap
	 */
	private static void createAndAppendXMLLocalizedFromForSBReq(ShiftBidRequest sbReq, Element parentElem,
		Localizer localizer, Map empIDToTZMap) throws Exception {

<span class="nc" id="L287">		ID sbReqEmpID = sbReq.getEmployeeID();</span>
<span class="nc" id="L288">		TimeZone empTZ = (TimeZone) empIDToTZMap.get(sbReqEmpID);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">		empTZ = (empTZ == null)?TimeZone.getDefault():empTZ;</span>

<span class="nc" id="L291">		String empName = RequestUtil.getLocalizedEmpNameByID(sbReqEmpID, localizer);</span>

		//create &lt;employeename&gt;
<span class="nc" id="L294">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemEmployeeName, null, m_xmlAttrDescription,</span>
<span class="nc" id="L295">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.EMPLOYEE), m_xmlAttrValue, empName);</span>

		//create &lt;requestname&gt;
<span class="nc" id="L298">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemRequestName, null, m_xmlAttrDescription,</span>
<span class="nc" id="L299">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.REQUEST_NAME), m_xmlAttrValue, sbReq.getName());</span>
		//create &lt;auctionstarttime&gt;
<span class="nc" id="L301">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemAuctionStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L302">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.AUCTION_START), m_xmlAttrValue,</span>
<span class="nc" id="L303">				localizer.formatDateTime(sbReq.getOptMethods().getShiftBidAuction().getStartTime(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;auctionendtime&gt;
<span class="nc" id="L305">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemAuctionEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L306">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.AUCTION_END), m_xmlAttrValue,</span>
<span class="nc" id="L307">				localizer.formatDateTime(sbReq.getOptMethods().getShiftBidAuction().getEndTime(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>

		//create &lt;shiftassignment&gt; elements
<span class="nc" id="L310">		Collection shiftAssns = sbReq.getOptMethods().getShiftAssignments();</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">		for (Iterator iter = shiftAssns.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L312">			ShiftAssignment shiftAssn = (ShiftAssignment) iter.next();</span>

			// create a &lt;shiftassignment&gt; element
<span class="nc" id="L315">			createAndAppendXMLLocalizedFromForShiftAssn(shiftAssn, sbReqEmpID, parentElem, localizer, empIDToTZMap);</span>
<span class="nc" id="L316">		}</span>
<span class="nc" id="L317">	}</span>

	/**
	 * @param shiftAssn
	 * @param parentElem
	 * @param localizer
	 * @param empIDToTZMap
	 */
	private static Element createAndAppendXMLLocalizedFromForShiftAssn(ShiftAssignment shiftAssn, ID empID,
		Element parentElem, Localizer localizer, Map empIDToTZMap) {

		//create &lt;shiftassignment&gt;
<span class="nc" id="L329">		Element shiftAssnElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemShiftAssignment, null);</span>

<span class="nc" id="L331">		TimeZone empTZ = (TimeZone) empIDToTZMap.get(empID);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">		empTZ = (empTZ == null)?TimeZone.getDefault():empTZ;</span>

		//create &lt;shiftassignment&gt;&lt;starttime&gt;
<span class="nc" id="L335">		RequestUtil.createElemAndAppendAsChild(shiftAssnElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L336">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_START_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L337">			localizer.formatDateTime(shiftAssn.getStartTime(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;shiftassignment&gt;&lt;endtime&gt;
<span class="nc" id="L339">		RequestUtil.createElemAndAppendAsChild(shiftAssnElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L340">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_END_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L341">			localizer.formatDateTime(shiftAssn.getEndTime(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>

<span class="nc" id="L343">		return shiftAssnElem;</span>
	}

	/**
	 * @param request
	 * @param rootElem
	 * @param localizer
	 * @param empIDToTZMap
	 */
	private static void createAndAppendXMLLocalizedFromForTOReq(TORequest toReq, Element parentElem,
		Localizer localizer, Map empIDToTZMap) throws Exception {

		//create &lt;employeename&gt;
<span class="nc" id="L356">		ID toReqEmpID = toReq.getEmployeeID();</span>
<span class="nc" id="L357">		String empName = RequestUtil.getLocalizedEmpNameByID(toReqEmpID, localizer);</span>

<span class="nc" id="L359">		String actName = RequestUtil.getActivityNameByID(toReq.getTimeOffType());</span>

<span class="nc" id="L361">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemEmployeeName, null, m_xmlAttrDescription,</span>
<span class="nc" id="L362">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.EMPLOYEE), m_xmlAttrValue, empName);</span>
		//create &lt;activity&gt;
<span class="nc" id="L364">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemActivity, null, m_xmlAttrDescription,</span>
<span class="nc" id="L365">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.TIME_OFF_TYPE), m_xmlAttrValue, actName);</span>

<span class="nc" id="L367">		Collection toChoices = toReq.getRequestChoiceList();</span>
		//create &lt;tochoice&gt; elements
<span class="nc bnc" id="L369" title="All 2 branches missed.">		for (Iterator iter = toChoices.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L370">			TOChoice toChoice = (TOChoice) iter.next();</span>

			// is this an approved request.
<span class="nc bnc" id="L373" title="All 4 branches missed.">			boolean isApproved = toReq.isApproved() &amp;&amp; (toReq.getApprovedChoiceID().equals(toChoice.getID()));</span>
			// create a &lt;tochoice&gt; element
<span class="nc" id="L375">			createAndAppendXMLLocalizedFromForTOChoice(toChoice, toReqEmpID, isApproved, parentElem,</span>
				localizer, empIDToTZMap);
<span class="nc" id="L377">		}</span>
<span class="nc" id="L378">	}</span>
	/**
	 * @param request
	 * @param rootElem
	 * @param localizer
	 * @param empIDToTZMap
	 */
	private static void createAndAppendXMLLocalizedFromForFlexReq(TORequest toReq, Element parentElem,
		Localizer localizer, Map empIDToTZMap) throws Exception {

<span class="nc" id="L388">		createAndAppendXMLLocalizedFromForTOReq(toReq, parentElem, localizer, empIDToTZMap);</span>

		//create &lt;makeups&gt; element
<span class="nc" id="L391">		Element makeUpsElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, xmlElemMakeUps, null);</span>

<span class="nc" id="L393">		TimeZone empTZ = (TimeZone) empIDToTZMap.get(toReq.getEmployeeID());</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">		empTZ = (empTZ == null) ? TimeZone.getDefault() : empTZ;</span>
<span class="nc" id="L395">		Calendar cal = Calendar.getInstance(empTZ);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">		for (FlexRequestMakeup makeup : toReq.getFlexRequestMakeupList()) {</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">			if (makeup.getExtBeforeActivityID() != null) {</span>
<span class="nc" id="L398">				cal.setTime(makeup.getShiftStartTime());</span>
<span class="nc" id="L399">				cal.add(Calendar.MINUTE, - (makeup.getExtBeforeGap() + makeup.getExtBeforeDuration()));</span>
<span class="nc" id="L400">				Date start = cal.getTime();</span>
<span class="nc" id="L401">				cal.add(Calendar.MINUTE, makeup.getExtBeforeDuration());</span>
<span class="nc" id="L402">				Date end = cal.getTime();</span>
<span class="nc" id="L403">				createAndAppendXMLLocalizedFromForMakeUp(makeup.getExtBeforeActivityID(), start, end, makeUpsElem, localizer, empTZ);</span>
			}
<span class="nc bnc" id="L405" title="All 2 branches missed.">			if (makeup.getExtAfterActivityID() != null) {</span>
<span class="nc" id="L406">				cal.setTime(makeup.getShiftEndTime());</span>
<span class="nc" id="L407">				cal.add(Calendar.MINUTE, makeup.getExtAfterGap());</span>
<span class="nc" id="L408">				Date start = cal.getTime();</span>
<span class="nc" id="L409">				cal.add(Calendar.MINUTE, makeup.getExtAfterDuration());</span>
<span class="nc" id="L410">				Date end = cal.getTime();</span>
<span class="nc" id="L411">				createAndAppendXMLLocalizedFromForMakeUp(makeup.getExtAfterActivityID(), start, end, makeUpsElem, localizer, empTZ);</span>
			}
<span class="nc" id="L413">		}</span>
<span class="nc" id="L414">	}</span>

	private static void createAndAppendXMLLocalizedFromForMakeUp(ID activityId, Date start, Date end,
		Element parentElem, Localizer localizer, TimeZone empTZ) throws BbmObjectNotFoundException, BbmEJBCreateException, BbmFinderException, RemoteException {
<span class="nc" id="L418">		String actName = RequestUtil.getActivityNameByID(activityId);</span>

		//create &lt;makeup&gt; element
<span class="nc" id="L421">		Element makeUpElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, xmlElemMakeUp, null,</span>
<span class="nc" id="L422">				m_xmlAttrDescription, m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.FLEX_MAKEUP));</span>
		//create &lt;makeup start time&gt;
<span class="nc" id="L424">		RequestUtil.createElemAndAppendAsChild(makeUpElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L425">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.FLEX_MAKEUP_START_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L426">			localizer.formatDateTime(start, empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;makeup end time&gt;
<span class="nc" id="L428">		RequestUtil.createElemAndAppendAsChild(makeUpElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L429">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.FLEX_MAKEUP_END_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L430">			localizer.formatDateTime(end, empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;makeup activity&gt;
<span class="nc" id="L432">		RequestUtil.createElemAndAppendAsChild(makeUpElem, null, m_xmlElemActivity, null, m_xmlAttrDescription,</span>
<span class="nc" id="L433">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.FLEX_MAKEUP_ACTIVITY), m_xmlAttrValue, actName);</span>
<span class="nc" id="L434">	}</span>

	/**
	 * @param request
	 * @param rootElem
	 * @param localizer
	 * @param empIDToTZMap
	 */
	private static void createAndAppendXMLLocalizedFromForCSReq(CustShiftReq csr, Element parentElem, Localizer localizer, Map empIDToTZMap) throws Exception {

		//create &lt;employeename&gt;
<span class="nc" id="L445">		ID empID = csr.getEmployeeID();</span>
<span class="nc" id="L446">		String empName = RequestUtil.getLocalizedEmpNameByID(empID, localizer);</span>
<span class="nc" id="L447">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemEmployeeName, null, m_xmlAttrDescription,</span>
<span class="nc" id="L448">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.EMPLOYEE), m_xmlAttrValue, empName);</span>
<span class="nc" id="L449">		String reqSubType =m_rmEjbResBundleInAppDefLocale.getString(CustomShiftEJBUtil.getRequestSubTypeStringKey(csr));</span>
<span class="nc" id="L450">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemEmployeeName, null, m_xmlAttrDescription,</span>
<span class="nc" id="L451">				        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.REQUEST_TYPE_LABEL), m_xmlAttrValue, reqSubType);</span>

<span class="nc" id="L453">		TimeZone empTZ = (TimeZone) empIDToTZMap.get(empID);</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">		empTZ = (empTZ == null) ? TimeZone.getDefault() : empTZ;</span>
<span class="nc" id="L455">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L456">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.REQUEST_START_DATE), m_xmlAttrValue,</span>
<span class="nc" id="L457">		        localizer.formatDateTime(csr.getStartTime(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;shift&gt;&lt;endTime&gt; element
<span class="nc" id="L459">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L460">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.REQUEST_END_DATE), m_xmlAttrValue,</span>
<span class="nc" id="L461">		        localizer.formatDateTime(csr.getEndTime(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>

		// create &lt;shift&gt; element
<span class="nc" id="L464">		ID shiftID = csr.getShiftID();</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">		if (shiftID != null) {</span>
<span class="nc" id="L466">			createAndAppendXMLLocalizedShiftElementForCSReq(csr, parentElem, localizer, empTZ);</span>
		}
		// create &lt;overtimebefore&gt; element
<span class="nc bnc" id="L469" title="All 2 branches missed.">		if (hasExtBefore(csr)) {</span>
<span class="nc" id="L470">			createAndAppendXMLLocalizedOvertimeElementForCSReq(csr, parentElem, localizer, empTZ, true);</span>
		}
		// create &lt;overtimeafter&gt; element
<span class="nc bnc" id="L473" title="All 2 branches missed.">		if (hasExtAfter(csr)) {</span>
<span class="nc" id="L474">			createAndAppendXMLLocalizedOvertimeElementForCSReq(csr, parentElem, localizer, empTZ, false);</span>
		}
<span class="nc" id="L476">	}</span>

	/**
	 * @param rootElem
	 * @param request
	 * @boolean isSupervisor
	 */
	public static void createAndAppendXMLLocalizedFragForRequestURL(Element parentElem, RequestAggregate reqAgg, boolean isSupervisor) throws Exception {
<span class="nc bnc" id="L484" title="All 2 branches missed.">		String screen = isSupervisor?&quot;screen=AGENTS_REQUESTS&quot;:&quot;screen=MYSCHEDULE_REQUESTS&quot;;</span>
<span class="nc" id="L485">		String url = NetworkUtil.createURLToWebServerWithRequestHandler(&quot;signin&quot;, screen</span>
<span class="nc" id="L486">				+ &quot;&amp;reqID=&quot;+reqAgg.getID().toString() + &quot;&amp;requestType=&quot; + reqAgg.getRequestType());</span>

		//create &lt;url&gt; element
<span class="nc" id="L489">		RequestUtil.createElemAndAppendAsChild(parentElem, null, &quot;url&quot;, null, m_xmlAttrDescription,</span>
<span class="nc" id="L490">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.VIEW_REQUEST), m_xmlAttrValue, url);</span>
<span class="nc" id="L491">	}</span>

	/**
	 * @param toChoice
	 * @param parentElem
	 * @param localizer
	 * @param empIDToTZMap
	 */
	private static void createAndAppendXMLLocalizedFromForTOChoice(TOChoice toChoice, ID empID, boolean isApproved,
		Element parentElem, Localizer localizer, Map empIDToTZMap) {

<span class="nc" id="L502">		TimeZone empTZ = (TimeZone) empIDToTZMap.get(empID);</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">		empTZ = (empTZ == null)?TimeZone.getDefault():empTZ;</span>
<span class="nc" id="L504">        String choiceDescription =null;</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">        if (isApproved) {</span>
<span class="nc" id="L506">            choiceDescription = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.APPROVED_CHOICE);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">        } else if (toChoice.isWaitlist()) {</span>
<span class="nc" id="L508">            choiceDescription = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.WAITLISTED_CHOICE);</span>
        }else{
<span class="nc" id="L510">           choiceDescription = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.CHOICE);</span>
        }
		//create &lt;tochoice&gt; element
		//
		//Mark it as either &quot;Approved choice&quot; or &quot;choice&quot;
<span class="nc" id="L515">		Element toChoiceElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemTOChoice, null,</span>
<span class="nc" id="L516">			m_xmlAttrDescription,choiceDescription , m_xmlAttrValue, String.valueOf(toChoice.getUserRank()));</span>

		//create &lt;tochoice&gt;&lt;starttime&gt;
<span class="nc" id="L519">		RequestUtil.createElemAndAppendAsChild(toChoiceElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L520">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.START_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L521">			localizer.formatDateTime(toChoice.getStartDate(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;tochoice&gt;&lt;endtime&gt;
<span class="nc" id="L523">		RequestUtil.createElemAndAppendAsChild(toChoiceElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L524">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.END_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L525">			localizer.formatDateTime(toChoice.getEndDate(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>
<span class="nc" id="L526">	}</span>

	private static void createAndAppendXMLLocalizedFromForSSReq(ShiftSwapRequest ssReq, Element parentElem,
		Localizer localizer, Map empIDToTZMap) throws Exception {

		// create &lt;swaptype&gt; element
<span class="nc" id="L532">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemSwapType, null, m_xmlAttrDescription,</span>
<span class="nc" id="L533">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SWAP_TYPE),</span>
<span class="nc" id="L534">			m_xmlAttrValue, getLocalizationSwapType(ssReq.getSwapType()));</span>

		// create &lt;swapitem&gt; elements
<span class="nc" id="L537">		List ssItems = ssReq.getShiftSwapItems();</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">		for (Iterator iter = ssItems.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L539">			ShiftSwapItem ssItem = (ShiftSwapItem) iter.next();</span>

<span class="nc" id="L541">			createAndAppendXMLLocalizedFragForSSItem(parentElem, ssItem, localizer, empIDToTZMap);</span>
<span class="nc" id="L542">		}</span>
<span class="nc" id="L543">	}</span>

	/**
	 * @param rootElement
	 * @param localizer
	 * @param empIDToTZMap
	 * @return
	 */
	private static void createAndAppendXMLLocalizedFragForRequest(Request req, Element parentElem, Localizer localizer,
		Map empIDToTZMap, String requestStatus) {
<span class="nc" id="L553">		TimeZone empTZ = (TimeZone) empIDToTZMap.get(req.getEmployeeID());</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">		empTZ = (empTZ == null)?TimeZone.getDefault():empTZ;</span>

		//create &lt;request&gt; element
<span class="nc" id="L557">		Element reqElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemRequest, null);</span>
		//create &lt;submittedon&gt; element
<span class="nc" id="L559">		Element submittedonElem = RequestUtil.createElemAndAppendAsChild(reqElem, null, m_xmlElemSubmittedOn, null,</span>
<span class="nc" id="L560">			m_xmlAttrDescription, m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SUBMITTED_ON), m_xmlAttrValue,</span>
<span class="nc" id="L561">				localizer.formatDateTime(req.getSubmittedOn(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;status&gt; element
<span class="nc" id="L563">		Element statusElem = RequestUtil.createElemAndAppendAsChild(reqElem, null, m_xmlElemStatus, null,</span>
<span class="nc" id="L564">			m_xmlAttrDescription, m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.STATUS), m_xmlAttrValue,</span>
<span class="nc" id="L565">            m_rmEjbResBundleInAppDefLocale.getString(getBundleKey(requestStatus)));</span>
<span class="nc" id="L566">	}</span>

	/**
	 * @param ssItem
	 * @return
	 */
	private static Element createAndAppendXMLLocalizedFragForSSItem(Element parentElem, ShiftSwapItem ssItem,
		Localizer localizer, Map empIDToTZMap) throws Exception {

		//get tz for employee;
<span class="nc" id="L576">		ID ssItemEmpID = ssItem.getEmployeeID();</span>
<span class="nc" id="L577">		TimeZone empTZ = (TimeZone) empIDToTZMap.get(ssItemEmpID);</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">		empTZ = (empTZ == null)?TimeZone.getDefault():empTZ;</span>

<span class="nc" id="L580">		String empName = RequestUtil.getLocalizedEmpNameByID(ssItemEmpID, localizer);</span>

		//create &lt;shiftswapitem&gt; element.
<span class="nc" id="L583">		Element ssitemElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, &quot;shiftswapitem&quot;, null);</span>
		//create &lt;shiftswapitem&gt;&lt;employeename&gt; element
<span class="nc" id="L585">		RequestUtil.createElemAndAppendAsChild(ssitemElem, null, m_xmlElemEmployeeName, null,</span>
<span class="nc" id="L586">			m_xmlAttrDescription, m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.EMPLOYEE), m_xmlAttrValue, empName);</span>
		//create &lt;shiftswapitem&gt;&lt;starttime&gt; element
<span class="nc" id="L588">		RequestUtil.createElemAndAppendAsChild(ssitemElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L589">		m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_START), m_xmlAttrValue,</span>
<span class="nc" id="L590">			localizer.formatDateTime(ssItem.getStartDate(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;shiftswapitem&gt;&lt;endTime&gt; element
<span class="nc" id="L592">		RequestUtil.createElemAndAppendAsChild(ssitemElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L593">		m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_END), m_xmlAttrValue,</span>
<span class="nc" id="L594">			localizer.formatDateTime(ssItem.getEndDate(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;shiftswapitem&gt;&lt;swaptype&gt; element
<span class="nc" id="L596">		RequestUtil.createElemAndAppendAsChild(ssitemElem, null, m_xmlElemSwapItemType, null, m_xmlAttrDescription,</span>
			//m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SWAP_ITEM_TYPE), m_xmlAttrValue, ssItem.getShiftType());
<span class="nc" id="L598">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SWAP_ITEM_TYPE), m_xmlAttrValue, getLocalizationShiftSwapType(ssItem.getShiftType()));</span>

<span class="nc" id="L600">		return ssitemElem;</span>
	}

	/* private methods used for customized messages */


	/**
	 * this function is duplicate with one in NotifiyDeliveryManager. It is put here for customized messages.
	 * The NotifiyDeliveryManager.java or Notification Framework should be changed for customized messages
	 * instead of coding here
    */
	public static HashMap getCustomizedMessagesMap(NotifyRule rule, ActionDetail actionDetail,
			WorkResourceManager wrm, RequestAggregate reqAgg, Element rootElem, DocumentBuilder parser, HashMap messageMap,
			Localizer localizer, Map empIDToTZMap,  String requestStatus, boolean isEmailDelivery)
	throws BbmFinderException, RemoteException, IOException, SAXException, CoreFinderException, Exception {

<span class="nc bnc" id="L616" title="All 4 branches missed.">		if (actionDetail == null || actionDetail.getObjects().isEmpty())</span>
<span class="nc" id="L617">			return messageMap; //messageMap is used to collection messages, at any point, it can not be set to null.</span>

<span class="nc" id="L619">		HashMap mapCustomizedMsg = messageMap;</span>

<span class="nc" id="L621">		Collection deliveries = rule.getDeliveryConfiguration();</span>
<span class="nc" id="L622">		NotifyRuleDelivery delivery = null;</span>
<span class="nc" id="L623">		NotifyMessageTarget target = null;</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">		for (Iterator i = deliveries.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L625">			delivery = (NotifyRuleDelivery)i.next();</span>
<span class="nc bnc" id="L626" title="All 4 branches missed.">			if (delivery.getDeliveryMediaID().equals(NotifyDeliveryMedia.NOTIFY_DELIVERY_MEDIA_EMAIL_ID) &amp;&amp; isEmailDelivery) {</span>
<span class="nc" id="L627">				target = delivery.getNotifyMessageTarget();</span>
<span class="nc" id="L628">				break;</span>
			}
<span class="nc bnc" id="L630" title="All 4 branches missed.">			if (delivery.getDeliveryMediaID().equals(NotifyDeliveryMedia.NOTIFY_DELIVERY_MEDIA_POPUP_ID) &amp;&amp; !isEmailDelivery) {</span>
<span class="nc" id="L631">				target = delivery.getNotifyMessageTarget();</span>
<span class="nc" id="L632">				break;</span>
			}
		}

<span class="nc bnc" id="L636" title="All 2 branches missed.">		if (target != null) {</span>
<span class="nc" id="L637">			UserManager userManager = CoreManagerFactory.getUserManager(false);</span>
			/* let's find all the employee names, we'll need them later */
<span class="nc" id="L639">			HashMap mapNames = wrm.getEmployeeNamesByIDs(actionDetail.getObjects());</span>

<span class="nc bnc" id="L641" title="All 2 branches missed.">			if (target.isEmployeeNotified()){</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">				for (Iterator it = actionDetail.getObjects().iterator(); it.hasNext();) {</span>
<span class="nc" id="L643">					ID workResourceID = (ID)it.next();</span>

<span class="nc" id="L645">					Element existingActionDetailForEmployee = (Element)mapCustomizedMsg.get(workResourceID);</span>

<span class="nc bnc" id="L647" title="All 2 branches missed.">					if (existingActionDetailForEmployee == null){</span>
						//create header and add to that
<span class="nc" id="L649">						Document doc = parser.newDocument();</span>
<span class="nc" id="L650">						existingActionDetailForEmployee = doc.createElement(&quot;requeststatuschange&quot;);</span>
<span class="nc" id="L651">						doc.appendChild(existingActionDetailForEmployee);</span>
					}

<span class="nc" id="L654">					Element thisDetail = getXMLLocalizedFrag(existingActionDetailForEmployee, reqAgg, null, localizer,</span>
			            	empIDToTZMap, requestStatus);
<span class="nc" id="L656">					NotificationUtil.createAndAppendXMLLocalizedFragForRequestURL(thisDetail, reqAgg, false);</span>

<span class="nc" id="L658">					mapCustomizedMsg.put(workResourceID, existingActionDetailForEmployee);</span>
<span class="nc" id="L659">				}</span>
			}
			// Direct supervisors
<span class="nc bnc" id="L662" title="All 2 branches missed.">			if (target.isManagerNotified()) {</span>
<span class="nc" id="L663">				HashMap mapEmployees = wrm.getEmployeesReportingSupervisors(actionDetail.getObjects(), null);</span>

<span class="nc" id="L665">				boolean isNotified = false;</span>
<span class="nc" id="L666">				ID oldSupervisorID = null;</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">				for (Iterator it = actionDetail.getObjects().iterator(); it.hasNext();) {</span>
<span class="nc" id="L668">					ID workResourceID = (ID) it.next();</span>
<span class="nc" id="L669">					ID supervisorID = (ID) mapEmployees.get(workResourceID);</span>

<span class="nc bnc" id="L671" title="All 2 branches missed.">					if (isNotified)</span>
<span class="nc bnc" id="L672" title="All 4 branches missed.">						if (oldSupervisorID != null &amp;&amp; supervisorID.equals(oldSupervisorID))//no need to send another notification</span>
<span class="nc" id="L673">							continue;</span>

<span class="nc" id="L675">					oldSupervisorID = supervisorID;</span>
<span class="nc" id="L676">					isNotified = true;</span>

<span class="nc bnc" id="L678" title="All 2 branches missed.">					if (supervisorID != null) {</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">						if (!workResourceID.equals(supervisorID)) {</span>

<span class="nc" id="L681">							Element existingActionDetailForSupervisor = (Element)mapCustomizedMsg.get(supervisorID);</span>

<span class="nc bnc" id="L683" title="All 2 branches missed.">							if (existingActionDetailForSupervisor == null){</span>
								//create header and add to that
<span class="nc" id="L685">								Document doc = parser.newDocument();</span>
<span class="nc" id="L686">								existingActionDetailForSupervisor = doc.createElement(&quot;requeststatuschange&quot;);</span>
<span class="nc" id="L687">								doc.appendChild(existingActionDetailForSupervisor);</span>
							}

<span class="nc" id="L690">							Element thisDetail = getXMLLocalizedFrag(existingActionDetailForSupervisor, reqAgg, null, localizer,</span>
					            	empIDToTZMap, requestStatus);

<span class="nc" id="L693">							User supervisor = userManager.getUserByEmployeeID(supervisorID);</span>
<span class="nc bnc" id="L694" title="All 4 branches missed.">	        				if (supervisor != null &amp;&amp; isAuthorized(supervisor, reqAgg)) {</span>
	        					   // append employee's action detail to supervisor's (with supervisor's privileges)
<span class="nc" id="L696">		        				   NotificationUtil.createAndAppendXMLLocalizedFragForRequestURL(thisDetail, reqAgg, true);</span>
	        				   }

<span class="nc" id="L699">							mapCustomizedMsg.put(supervisorID, existingActionDetailForSupervisor);</span>
    				   }
    			   }
<span class="nc" id="L702">    		   }</span>
    	   }

    	   // additional users by role
<span class="nc" id="L706">    	   HashSet setEmployeeIDs = new HashSet();</span>
<span class="nc" id="L707">    	   ID roleID = target.getRoleID();</span>
<span class="nc" id="L708">    	   Collection listUsers = null;</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">		   if (roleID != null) {</span>
<span class="nc" id="L710">			   	ArrayList scopes = new ArrayList(1);</span>
<span class="nc" id="L711">       			scopes.add(rule.getScopeID());</span>
<span class="nc" id="L712">				listUsers = userManager.getUsersHavingRoleDirectlyOnScope(roleID, scopes, Organization.SCOPE_TYPE);</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">				for (Iterator it = listUsers.iterator(); it.hasNext();) {</span>
<span class="nc" id="L714">					User user = (User) it.next();</span>
			        /*
				     * check that the user is associated with an employee,
				     * otherwise
				     */
<span class="nc" id="L719">			            ID employeeID = user.getEmployeeID();</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">			            if (employeeID == null)</span>
<span class="nc" id="L721">			                continue;</span>
<span class="nc" id="L722">			            setEmployeeIDs.add(employeeID);</span>
<span class="nc" id="L723">				}</span>
		   }

		   // additional users by login names
<span class="nc" id="L727">		   Collection listUserIDs = target.getUserIDs();</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">		   if (!listUserIDs.isEmpty()) {</span>
<span class="nc" id="L729">		       HashMap mapUsers = userManager.getUsersByIDs(listUserIDs);</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">		       for (Iterator it = mapUsers.values().iterator(); it.hasNext();) {</span>
<span class="nc" id="L731">		           User user = (User) it.next();</span>
		           /*
			        * check that the user is associated with an employee,
			        * otherwise
			        */
<span class="nc" id="L736">		           ID employeeID = user.getEmployeeID();</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">		           if (employeeID == null)</span>
<span class="nc" id="L738">		               continue;</span>
<span class="nc" id="L739">		           setEmployeeIDs.add(employeeID);</span>
<span class="nc" id="L740">		       }</span>
		   }

<span class="nc bnc" id="L743" title="All 2 branches missed.">		   if (!setEmployeeIDs.isEmpty()) {</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">			   for (Iterator it = setEmployeeIDs.iterator(); it.hasNext();) {</span>
<span class="nc" id="L745">	                ID workResourceID = (ID) it.next();</span>
	                //if (!mapCustomizedMsg.containsKey(workResourceID)) {
<span class="nc" id="L747">	                	Element existingActionDetailForAddtionalUser = (Element)mapCustomizedMsg.get(workResourceID);</span>

<span class="nc bnc" id="L749" title="All 2 branches missed.">						if (existingActionDetailForAddtionalUser == null){</span>
							//create header and add to that
<span class="nc" id="L751">							Document doc = parser.newDocument();</span>
<span class="nc" id="L752">							existingActionDetailForAddtionalUser = doc.createElement(&quot;requeststatuschange&quot;);</span>
<span class="nc" id="L753">							doc.appendChild(existingActionDetailForAddtionalUser);</span>
						}

<span class="nc" id="L756">						Element thisDetail = getXMLLocalizedFrag(existingActionDetailForAddtionalUser, reqAgg, null, localizer,</span>
				            	empIDToTZMap, requestStatus);

<span class="nc" id="L759">						User additionalUser = userManager.getUserByEmployeeID(workResourceID);</span>

<span class="nc bnc" id="L761" title="All 4 branches missed.">	     				   if (additionalUser != null &amp;&amp; isAuthorized(additionalUser, reqAgg)) {</span>
	        				   // append employee's action detail to supervisor's (with supervisor's privileges)
<span class="nc" id="L763">	        				   NotificationUtil.createAndAppendXMLLocalizedFragForRequestURL(thisDetail, reqAgg, true);</span>
	    				   }
<span class="nc" id="L765">	                		mapCustomizedMsg.put(workResourceID, existingActionDetailForAddtionalUser);</span>
	               // }
<span class="nc" id="L767">			   }</span>

	    	}

		   	// Additional E-Mail targets (special target)
		   	// combine messages for all employees into one, no url in this case
<span class="nc" id="L773">		   	String specialTarget = target.getSpecialTargets();</span>
<span class="nc bnc" id="L774" title="All 4 branches missed.">	        if (specialTarget != null &amp;&amp; specialTarget.length() &gt; 0) {</span>

<span class="nc" id="L776">	        	Element existingActionDetailForSpecialTarget = (Element)mapCustomizedMsg.get(specialTarget);</span>

<span class="nc bnc" id="L778" title="All 2 branches missed.">				if (existingActionDetailForSpecialTarget == null){</span>
					//create header and add to that
<span class="nc" id="L780">					Document doc = parser.newDocument();</span>
<span class="nc" id="L781">					existingActionDetailForSpecialTarget = doc.createElement(&quot;requeststatuschange&quot;);</span>
<span class="nc" id="L782">					doc.appendChild(existingActionDetailForSpecialTarget);</span>
				}

<span class="nc" id="L785">				Element thisDetail = getXMLLocalizedFrag(existingActionDetailForSpecialTarget, reqAgg, null, localizer,</span>
		            	empIDToTZMap, requestStatus);

<span class="nc" id="L788">            		mapCustomizedMsg.put(specialTarget, existingActionDetailForSpecialTarget);</span>
	        }
		}
<span class="nc" id="L791">		return mapCustomizedMsg;</span>
	}

	public static Element xmlToElement (String stringXml) throws IOException, SAXException {
<span class="nc" id="L795">		DOMParser parser = new DOMParser();</span>
<span class="nc" id="L796">	    InputSource source = new InputSource(new StringReader(stringXml));</span>
<span class="nc" id="L797">	    parser.parse(source);</span>
<span class="nc" id="L798">	    Document doc = parser.getDocument();</span>
<span class="nc" id="L799">	    return doc.getDocumentElement();</span>
	}

	private static void appendCustomizedMessageNode(Element header, Document doc) throws BbmFinderException, RemoteException {
<span class="nc" id="L803">		NodeList nodeList = header.getElementsByTagName(NotifyRule.CUSTOMIZE_MESSAGE);</span>
<span class="nc bnc" id="L804" title="All 4 branches missed.">		if (nodeList == null || nodeList.getLength() == 0){ // no CUSTOMIZE_MESSAGE string in action detail</span>
<span class="nc" id="L805">			Node childNode = doc.createElement(NotifyRule.CUSTOMIZE_MESSAGE);</span>
<span class="nc" id="L806">			childNode.appendChild(doc.createTextNode(&quot;yes&quot;));</span>
<span class="nc" id="L807">			header.appendChild(childNode);</span>
		}
<span class="nc" id="L809">	}</span>


	public static boolean isAuthorized(User user, RequestAggregate reqAgg){
<span class="nc bnc" id="L813" title="All 2 branches missed.">		return (reqAgg.getRequestType().equals(Request.REQUESTTYPE_TIMEOFF) &amp;&amp;</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">						user.isAuthorized(PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE_ID)) ||</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">				(reqAgg.getRequestType().equals(Request.REQUESTTYPE_FLEXTIME) &amp;&amp;</span>
<span class="nc bnc" id="L816" title="All 2 branches missed.">						user.isAuthorized(PrivilegeKeys.FT_VIEWREQUESTSFOREMPLOYEE_ID)) ||</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">				(reqAgg.getRequestType().equals(Request.REQUESTTYPE_SHIFTSWAP) &amp;&amp;</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">						user.isAuthorized(PrivilegeKeys.SS_VIEWREQUESTSFOREMPLOYEE_ID)) ||</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">				(reqAgg.getRequestType().equals(Request.REQUESTTYPE_SHIFTBID) &amp;&amp;</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">						user.isAuthorized(PrivilegeKeys.SB_VIEWSHIFTBIDSFOREMP_ID));</span>
	}

	/**
	 * @param shift
	 * @return
	 */
	private static Element createAndAppendXMLLocalizedFragForCSItem(Element parentElem, ShiftAssignment shift,
	                                                                Localizer localizer, Map empIDToTZMap, ID empID, String shiftType) throws Exception {
		//create &lt;shift&gt; element.
<span class="nc" id="L830">		TimeZone empTZ = (TimeZone) empIDToTZMap.get(empID);</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">		empTZ = (empTZ == null) ? TimeZone.getDefault() : empTZ;</span>
<span class="nc" id="L832">		Element shiftElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, &quot;shift&quot;, null);</span>
		//create &lt;shift&gt;&lt;CSType&gt; element
<span class="nc" id="L834">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemCSType, null, m_xmlAttrDescription,</span>
<span class="nc" id="L835">		        m_rmEjbResBundleInAppDefLocale.getString(shiftType), m_xmlAttrValue,&quot; &quot;);</span>

		//create &lt;shift&gt;&lt;starttime&gt; element
<span class="nc" id="L838">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L839">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_START), m_xmlAttrValue,</span>
<span class="nc" id="L840">		        localizer.formatDateTime(shift.getStartTime(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;shift&gt;&lt;endTime&gt; element
<span class="nc" id="L842">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L843">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_END), m_xmlAttrValue,</span>
<span class="nc" id="L844">		        localizer.formatDateTime(shift.getEndTime(), empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()));</span>

<span class="nc" id="L846">		return shiftElem;</span>
	}

	private static Element createAndAppendXMLLocalizedShiftElementForCSReq(CustShiftReq csr, Element parentElem,
		Localizer localizer, TimeZone empTZ) throws Exception {
<span class="nc" id="L851">		Element shiftElem = null;</span>
<span class="nc" id="L852">		shiftElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, &quot;shift&quot;, null);</span>
		//&lt;shift&gt; element
<span class="nc" id="L854">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemCSType, null, m_xmlAttrDescription,</span>
<span class="nc" id="L855">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT), m_xmlAttrValue,&quot; &quot;);</span>

		//&lt;shift&gt;&lt;starttime&gt; element
<span class="nc" id="L858">		Date startTime = csr.getShiftStartTime();</span>
<span class="nc" id="L859">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_START_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L861">		        startTime != null ? localizer.formatDateTime(startTime, empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()) : &quot;&quot;);</span>
		//&lt;shift&gt;&lt;endTime&gt; element
<span class="nc" id="L863">		Date endTime = csr.getShiftEndTime();</span>
<span class="nc" id="L864">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_END_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L866">		        endTime != null ? localizer.formatDateTime(endTime, empTZ) + &quot; &quot; + localizer.formatTimeZone(empTZ.getID()) : &quot;&quot;);</span>
		//&lt;duration&gt; element
<span class="nc" id="L868">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemDuration, null, m_xmlAttrDescription,</span>
<span class="nc" id="L869">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.DURATION), m_xmlAttrValue,</span>
<span class="nc" id="L870">		        localizer.formatDurationInMins(csr.getShiftDurationinMinutes()));</span>
		//&lt;shift&gt; element
<span class="nc" id="L872">		WorkRuleManager wrm = WfmManagerFactory.getWorkRuleManager();</span>
<span class="nc" id="L873">		ID shiftID = csr.getShiftID();</span>
<span class="nc" id="L874">		Shift shift = null;</span>
<span class="nc bnc" id="L875" title="All 2 branches missed.">		if (shiftID != null)</span>
<span class="nc" id="L876">			shift = wrm.getShift(shiftID);</span>
<span class="nc" id="L877">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemShift, null, m_xmlAttrDescription,</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT), m_xmlAttrValue,</span>
<span class="nc" id="L879">		        shift != null ? shift.getName(): &quot;&quot;);</span>
		//&lt;activity&gt; element
<span class="nc" id="L881">		ID activityID = csr.getActivityID();</span>
<span class="nc" id="L882">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemActivity, null, m_xmlAttrDescription,</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.ACTIVITY), m_xmlAttrValue,</span>
<span class="nc" id="L884">		        activityID != null ? RequestUtil.getActivityNameByID(activityID) : &quot;&quot;);</span>
		//&lt;overtime&gt; element
<span class="nc" id="L886">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemOvertime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L887">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.OVERTIME), m_xmlAttrValue,</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">		        csr.isOT() ? localizer.i18n(m_rmEjbResBundleInAppDefLocale, RmEjbBundleKey.YES) :</span>
<span class="nc" id="L889">		        	localizer.i18n(m_rmEjbResBundleInAppDefLocale,RmEjbBundleKey.NO));</span>

<span class="nc" id="L891">		return shiftElem;</span>
	}

	private static Element createAndAppendXMLLocalizedOvertimeElementForCSReq(CustShiftReq csr, Element parentElem,
			Localizer localizer, TimeZone empTZ, boolean isBefore) throws Exception {
<span class="nc bnc" id="L896" title="All 2 branches missed.">		boolean hasExtension = isBefore ? hasExtBefore(csr) : hasExtAfter(csr);</span>

		// &lt;extension&gt; element
<span class="nc" id="L899">		Element extensionElem = null;</span>
<span class="nc" id="L900">		extensionElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemExtension, null);</span>
		// &lt;extensionbefore&gt; or &lt;extensionafter&gt; element
<span class="nc bnc" id="L902" title="All 2 branches missed.">		String extBeforeOrAfter = isBefore ? m_xmlElemOvertimeBefore : m_xmlElemOvertimeAfter;</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">		String bundleKey = isBefore ? RmEjbBundleKey.EXTENSION_BEFORE : RmEjbBundleKey.EXTENSION_AFTER;</span>
<span class="nc" id="L904">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, extBeforeOrAfter, null, m_xmlAttrDescription,</span>
<span class="nc" id="L905">		        m_rmEjbResBundleInAppDefLocale.getString(bundleKey), m_xmlAttrValue,&quot; &quot;);</span>

		// &lt;type&gt; element
<span class="nc" id="L908">		String extName = &quot;&quot;;</span>
<span class="nc bnc" id="L909" title="All 2 branches missed.">		if (hasExtension) {</span>
<span class="nc" id="L910">			ID otExtensionID = null;</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">			otExtensionID =	isBefore ? csr.getExtBeforeID() : csr.getExtAfterID();</span>
<span class="nc" id="L912">			WorkRuleManager wrm = WfmManagerFactory.getWorkRuleManager();</span>
<span class="nc" id="L913">			ShiftOTExtension sotExt = null;</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">			if (otExtensionID != null) {</span>
<span class="nc" id="L915">				sotExt = wrm.getShiftOTExtensionByID(otExtensionID);</span>
			}
<span class="nc bnc" id="L917" title="All 2 branches missed.">			if (sotExt != null) {</span>
<span class="nc" id="L918">				extName = sotExt.getName();</span>
			}
		}
<span class="nc" id="L921">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemType, null, m_xmlAttrDescription,</span>
<span class="nc" id="L922">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.TYPE), m_xmlAttrValue, extName);</span>
		// &lt;activity&gt; element
<span class="nc" id="L924">		String activityName = &quot;&quot;;</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">		if (hasExtension) {</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">			ID extActivityID = isBefore ? csr.getExtBeforeActivityID() : csr.getExtAfterActivityID();</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">			if (extActivityID != null) {</span>
<span class="nc" id="L928">				activityName = RequestUtil.getActivityNameByID(extActivityID);</span>
			}
		}
<span class="nc" id="L931">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemActivity, null, m_xmlAttrDescription,</span>
<span class="nc" id="L932">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.ACTIVITY), m_xmlAttrValue, activityName);</span>
		// &lt;duration&gt; element
<span class="nc" id="L934">		String strDuration = &quot;&quot;;</span>
<span class="nc bnc" id="L935" title="All 2 branches missed.">		if (hasExtension) {</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">			int extDuration = isBefore ? csr.getExtBeforeDuration() : csr.getExtAfterDuration();</span>
<span class="nc" id="L937">			strDuration = localizer.formatDurationInMins(extDuration);</span>
		}
<span class="nc" id="L939">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemDuration, null, m_xmlAttrDescription,</span>
<span class="nc" id="L940">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.DURATION), m_xmlAttrValue, strDuration);</span>
		// &lt;gap&gt; element
<span class="nc" id="L942">		String strGap = &quot;&quot;;</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">		if (hasExtension) {</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">			int extGap = isBefore ? csr.getExtBeforeGap() : csr.getExtAfterGap();</span>
<span class="nc" id="L945">			strGap = localizer.formatDurationInMins(extGap);</span>
		}
<span class="nc" id="L947">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, xmlElemGap, null, m_xmlAttrDescription,</span>
<span class="nc" id="L948">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.GAP), m_xmlAttrValue, strGap);</span>
		// &lt;overtime&gt; element
<span class="nc" id="L950">		String strIsOT = &quot;&quot;;</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">		if (hasExtension) {</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">			boolean isOT = isBefore ? csr.getExtBeforeIsOT() : csr.getExtAfterIsOT();</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">			strIsOT = isOT ? localizer.i18n(m_rmEjbResBundleInAppDefLocale, RmEjbBundleKey.YES) :</span>
<span class="nc" id="L954">	        	localizer.i18n(m_rmEjbResBundleInAppDefLocale,RmEjbBundleKey.NO);</span>
		}
<span class="nc" id="L956">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemOvertime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L957">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.OVERTIME), m_xmlAttrValue, strIsOT);</span>


<span class="nc" id="L960">		return extensionElem;</span>
	}

	/**
	 * Returns true if the CustShiftReq has a non-zero length extension before the shift,
	 * and a non-null Activity.
	 */
	private static boolean hasExtBefore(CustShiftReq csr)
	{
<span class="nc bnc" id="L969" title="All 2 branches missed.">		if (csr.getExtBeforeDuration()==0 ||</span>
<span class="nc bnc" id="L970" title="All 2 branches missed.">				csr.getExtBeforeActivityID()==null)</span>
<span class="nc" id="L971">			return false;</span>

<span class="nc" id="L973">		return true;</span>
	}

	/**
	 * Returns true if the CustShiftReq has a non-zero length extension after the shift,
	 * and a non-null Activity.
	 */
	public static boolean hasExtAfter(CustShiftReq csr)
	{
<span class="nc bnc" id="L982" title="All 2 branches missed.">		if (csr.getExtAfterDuration()==0 ||</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">				csr.getExtAfterActivityID()==null)</span>
<span class="nc" id="L984">			return false;</span>

<span class="nc" id="L986">		return true;</span>
	}

	public static String getLocalizationSwapType(String swapType){
<span class="nc" id="L990">		String i18NSwapType = &quot;&quot;;</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">		if (swapType.equals(ShiftSwapRequest.SHIFTSWAP_TYPE_ONEWAY)){</span>
<span class="nc" id="L992">			i18NSwapType = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SWAPTYPE_ONEWAY);</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">		} else if (swapType.equals(ShiftSwapRequest.SHIFTSWAP_TYPE_TWOWAY)){</span>
<span class="nc" id="L994">			i18NSwapType = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SWAPTYPE_TWOWAY);</span>
		}
<span class="nc" id="L996">		return i18NSwapType;</span>
	}

	public static String getLocalizationShiftSwapType(String shiftSwapType)
	{
<span class="nc" id="L1001">		String i18NShiftSwapType = &quot;&quot;;</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">		if (shiftSwapType.equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT))</span>
		{
<span class="nc" id="L1004">			i18NShiftSwapType = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFTTYPE_SHIFT);</span>
		}
<span class="nc bnc" id="L1006" title="All 2 branches missed.">		else if (shiftSwapType.equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF))</span>
		{
<span class="nc" id="L1008">			i18NShiftSwapType = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFTTYPE_DAYOFF);</span>
		}

<span class="nc" id="L1011">		return i18NShiftSwapType;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>