<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MaxConsecutiveDaysForSBReqHV.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.validation</a> &gt; <span class="el_source">MaxConsecutiveDaysForSBReqHV.java</span></div><h1>MaxConsecutiveDaysForSBReqHV.java</h1><pre class="source lang-java linenums">/*
 * Created on Sep 22, 2003
 *
 * To change this generated comment go to
 * Window&gt;Preferences&gt;Java&gt;Code Generation&gt;Code and Comments
 */
package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.validation;

import java.text.DateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;

import org.apache.log4j.Priority;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.shifts.model.ShiftsConflict;
import com.bluepumpkin.ejb.bbm.shifts.model.ShiftsUtil;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.util.ShiftBidAuctionUtil;


<span class="nc" id="L43">public class MaxConsecutiveDaysForSBReqHV implements Validator {</span>
<span class="nc" id="L44">    private static final Priority m_tracePriority = RequestUtil.m_defaultTracePriority;</span>

<span class="nc" id="L46">    private final static String m_className = MaxConsecutiveDaysForSBReqHV.class.getName();</span>
<span class="nc" id="L47">    private static final Category m_cat = Log.initCategory(m_className);</span>

    public TimeRange getDateRange(ShiftBidRequest sbReq) throws Exception {
<span class="nc" id="L50">		return sbReq.getValidationCache().getDateRange();</span>
	}

    private static Date getZeroTimeDate(Calendar calendar, Date datewithTime) {
<span class="nc" id="L54">        calendar.setTime( datewithTime );</span>
<span class="nc" id="L55">        calendar.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L56">        calendar.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L57">        calendar.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L58">        calendar.set(Calendar.MILLISECOND, 0);</span>

<span class="nc" id="L60">        return calendar.getTime();</span>
    }

    public ValidationResult validate(Validatable validatable) throws Exception {
<span class="nc" id="L64">        m_cat.log(m_tracePriority, &quot;Validation Rule: &quot; + m_className + &quot; started&quot;);</span>

        try {
<span class="nc" id="L67">        	ValidationResult valResult = null;</span>
<span class="nc" id="L68">        	ShiftBidRequest sbReq = (ShiftBidRequest) validatable;</span>
<span class="nc" id="L69">            ShiftBidRequestValidationCache sbReqValCache = sbReq.getValidationCacheSBR();</span>
<span class="nc" id="L70">            ShiftBidAuction shiftBidAuction = sbReq.getOptMethods().getShiftBidAuction();</span>
<span class="nc" id="L71">            int maxConsecDays = shiftBidAuction.getMaxConsecDaysPerBid();</span>
            Date tempStartDate;
            Date tempEndDate;

            // rule doesn't apply to the Full Scheduling Period Auction
<span class="nc bnc" id="L76" title="All 2 branches missed.">            if (shiftBidAuction.getIsFullPeriodSchedule()) {</span>
<span class="nc" id="L77">            	return null;</span>
            }

<span class="nc bnc" id="L80" title="All 2 branches missed.">            if(maxConsecDays == 0) {</span>
<span class="nc" id="L81">            	return null;</span>
            }

            //get the SP start and end date
<span class="nc" id="L85">            TimeRange range = getDateRange(sbReq);</span>
            // pull the org details to use the timezone and day boundary details while comparing shifts
<span class="nc" id="L87">            Organization org = sbReqValCache.getOrg();</span>
            // TimeZone and day boundary details
<span class="nc" id="L89">            TimeZone empOrgTZ = sbReqValCache.getTimeZoneForOrg();</span>
<span class="nc" id="L90">            Calendar c = Calendar.getInstance(empOrgTZ);</span>
<span class="nc" id="L91">            c.add(Calendar.MINUTE, sbReqValCache.getOrg().getDayBoundaryOffset());</span>

            // assignments within bid request - assumption is there is at least one shift selected by user to be able to submit a bid request
<span class="nc" id="L94">			List&lt;ShiftAssignment&gt; allBids = new ArrayList&lt;ShiftAssignment&gt;(sbReq.getOptMethods().getShiftAssignments());</span>
            //existing shift for employees during SP
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L97">			List&lt;ShiftAssignment&gt; empShiftAssns = (List&lt;ShiftAssignment&gt;) sbReqValCache.getShiftsPubDuringPeriod();</span>

            // Combine both the lists to get final shift assignments for this user - check if user has existing assignments
<span class="nc" id="L100">           	allBids.addAll(empShiftAssns);</span>

            // sort the lists to make sure we get the first day and last day details appropriately
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (allBids.size() &gt; 1){</span>
<span class="nc" id="L104">            	Collections.sort(allBids, new ShiftBidAuctionUtil.ShiftAssignmentComparator());</span>
            }

            //Get start of day for first shift - assumption there is at least one shift selected in bid request
<span class="nc" id="L108">            tempStartDate = allBids.get(0).getStartTime();</span>
            //Get end of day for last shift
<span class="nc" id="L110">            tempEndDate = allBids.get((allBids.size() - 1)).getEndTime();</span>
            
<span class="nc" id="L112">            boolean isOnSPRange = false;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            if (getZeroTimeDate(c, tempStartDate).compareTo(getZeroTimeDate(c, range.getStartDate())) == 0) {</span>
            	//this logic is to cover days outside of SP as well (if the first assignment is first day of SP)
<span class="nc bnc" id="L115" title="All 2 branches missed.">            	for (int i=1; i &lt;= maxConsecDays; i++){</span>
<span class="nc" id="L116">            		tempStartDate = TOCalcUtil.getDateBackwardOneDay(getZeroTimeDate(c,tempStartDate), empOrgTZ);</span>
            	}
<span class="nc" id="L118">            	isOnSPRange = true;</span>
            }
            /*
             * Because all SP are stored in GMT and they end at midnight, so date is changed to next day
             * For instance, if SP is from 09/19 to 09/25 - it's stored as  2016-09-19 07:00:00 to 2016-09-26 07:00:00
             * So, reducing a day from SP end date for actual comparison
            */
<span class="nc bnc" id="L125" title="All 2 branches missed.">            if(getZeroTimeDate(c, tempEndDate).compareTo(getZeroTimeDate(c, TOCalcUtil.getDateBackwardOneDay(range.getEndDate(), empOrgTZ))) == 0) {</span>
            	//this logic is to cover days outside of SP as well (if the last assignment is on last day of SP)
<span class="nc" id="L127">            	tempEndDate = TOCalcUtil.getDateForwardOneDay(getZeroTimeDate(c,tempEndDate), empOrgTZ); //Add one day to get last time of day</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            	for (int i=1; i &lt;= maxConsecDays; i++){</span>
<span class="nc" id="L129">            		tempEndDate = TOCalcUtil.getDateForwardOneDay(getZeroTimeDate(c,tempEndDate), empOrgTZ);</span>
            	}
<span class="nc" id="L131">            	isOnSPRange = true;</span>
            }
            
            List&lt;ShiftAssignment&gt; finalEmpAssignListToVal;
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (isOnSPRange){</span>
	            // To pull published shift assignments for given date range
<span class="nc" id="L137">            	finalEmpAssignListToVal = getPublishedEventsForWorkResourceByType(Event.EVENT_TYPE_SHIFT_ASSIGNMENT, sbReq.getOptMethods().getEmployee().getID(),</span>
	            		tempStartDate, tempEndDate);
	
	            // Combine both bid request and employee existing shift assignments to one list
<span class="nc" id="L141">	            finalEmpAssignListToVal.addAll(sbReq.getOptMethods().getShiftAssignments());</span>
            } else {
            	//allBids list contains all shifts to check
<span class="nc" id="L144">            	finalEmpAssignListToVal = allBids;</span>
            }
            // now check the Max consecutive days rule for all shifts in the collection.
<span class="nc" id="L147">            Collection&lt;ShiftsConflict&gt; results =</span>
<span class="nc" id="L148">            		getMaxConsecutiveDaysConflicts(finalEmpAssignListToVal, maxConsecDays, tempStartDate, tempEndDate, org );</span>

<span class="nc bnc" id="L150" title="All 4 branches missed.">            if (results != null &amp;&amp; !results.isEmpty()) {</span>
<span class="nc" id="L151">            	valResult = ValidationUtil.setHardValidationResult(sbReq, RmEjbBundleKey.SBR_MAX_CONSEC_DAYS,</span>
<span class="nc" id="L152">            			maxConsecDays, m_className);</span>
            }
<span class="nc" id="L154">            return valResult;</span>
        }finally {
<span class="nc" id="L156">           m_cat.debug(&quot;Validation Rule: &quot; + m_className + &quot; done&quot;);</span>
        }
    }
    
    @SuppressWarnings(&quot;unchecked&quot;)
	public List&lt;ShiftAssignment&gt; getPublishedEventsForWorkResourceByType(int eventType, ID idWorkResource,
            Date dtStart, Date dtEnd) throws Exception{
<span class="nc" id="L163">    	return (List&lt;ShiftAssignment&gt;) ValidationUtil.getPublishedEventsForWorkResourceByType(eventType, idWorkResource,</span>
    			dtStart, dtEnd);
    }
    
    public Collection&lt;ShiftsConflict&gt; getMaxConsecutiveDaysConflicts(List&lt;ShiftAssignment&gt; cEvents,
			int maxAllowedDays, Date dtStart, Date dtEnd, Organization pOrg){
<span class="nc" id="L169">    	return ShiftsUtil.getMaxConsecutiveDaysConflicts(cEvents, maxAllowedDays, dtStart, dtEnd, pOrg);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>