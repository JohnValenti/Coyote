<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffPoolAssignmentPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.people.timeoff</a> &gt; <span class="el_source">TimeOffPoolAssignmentPC.java</span></div><h1>TimeOffPoolAssignmentPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.people.timeoff;

import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.EmpTOPoolAssignment;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.EmpTOPoolAssignmentFieldInfo;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPoolFieldInfo;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.people.PeopleMH;
import com.bluepumpkin.web.bbm.people.profile.ProfileAdminPC;
import com.bluepumpkin.web.bbm.people.profile.ProfilePageModel;
import com.bluepumpkin.web.fs.Log;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.date.DateRangePickerPC;
import com.witness.web.uif.pagemodel.WorkpaneFieldNames;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;

/**
 * Title:        TimeOffPoolAssignmentPC
 * Description:  Display Time Off Pool Assignment. To be used in the TimeOffPM.
 * Copyright:    Copyright (c) 2009
 * Company:      Verint Systems, Inc
 * @author       Gonzalo Quintanar
 */

public class TimeOffPoolAssignmentPC extends CollapsibleContainerPC
{
<span class="fc" id="L46">    private static Category m_log = Log.initCategory(TimeOffPoolAssignmentPC.class.getName());</span>

    private static final int DEFAULT_FIELD_WIDTH = 30;
    public static final String TO_POOL_EFFECTIVE_DATE_FIELD = &quot;TO_POOL_EFFECTIVE_DATE_FIELD&quot;;
    
    public static final String POOL_ID_FN = &quot;poolId&quot;; //time off pool ID
    public static final String POOL_NAME_FN = &quot;poolId_RO&quot;; //time off pool name
    private static final String EFF_DATES_SUFFIX = &quot;_EffDate&quot;;
    private static final String POOL_EFF_FN = &quot;pool&quot; + EFF_DATES_SUFFIX;
    
    public static final String EDITABLE_FN = &quot;Editable&quot;;
    public static final String VIEWABLE_FN = &quot;Viewable&quot;;
    public static final String POOL_EDITABLE_FN = POOL_ID_FN + EDITABLE_FN;
    public static final String POOL_VIEWABLE_FN = POOL_ID_FN + VIEWABLE_FN;
    public static final String VIEW_DATE_FN = &quot;viewDate&quot;;
    public static final String IS_EFFECTIVITY = &quot;isEffectivity&quot;; // indicates effectivity, typically used as a flag to trigger POST request in PopupManager.js
    public static final String EFFECTIVITY_PARAM = &quot;effectivityParam&quot;; // indicates param to use for effectivity, to get the data for the POST request in PopupManager.js

<span class="fc" id="L64">    private boolean m_isEditable = true;</span>
<span class="fc" id="L65">    private boolean m_isMultiEdit = false;</span>
    
<span class="fc" id="L67">    private Employee m_employee = null;  //the employee who the user wants to assign a pool to. May contain multiple empIDs in the multi-value field.</span>
<span class="fc" id="L68">    private Collection m_empIDs = Collections.EMPTY_LIST;</span>
<span class="fc" id="L69">    private TOPool m_pool = null; //the selected employee's time off pool on the AsOfDate (viewDate)</span>
<span class="fc" id="L70">    private EmpTOPoolAssignment m_empTOPoolAssignment = null;</span>
<span class="fc" id="L71">    boolean m_noPoolAssignmentsFound = false; //true if none of the selected employees have a pool assignment on the viewDate</span>
    private LocalDate m_viewDateLocal; //the local AsOfDate (viewDate)
    private final DateRangePickerPC m_dateRangePickerPC;
    //private ID m_commonOrgID;

    private final ResourceBundle m_bundle;
    private final ID m_loggedInUserEmpID;
    
    public static final String MODE_VIEW_POOL = &quot;MODE_VIEW_POOL&quot;; //this is the default mode which tells us that pool effectivity has changed
    public static final String MODE_SAVE_POOL = &quot;MODE_SAVE_POOL&quot;; //tells us that the user has clicked &quot;Set&quot; from the effective dates popup
<span class="fc" id="L81">    private String m_mode = MODE_VIEW_POOL;</span>
    
    //Popup parameter constants
    
	private static final String POPUP_POOL_EFF_DATE = &quot;POPUP_POOL_EFF_DATE&quot;;
	
	//&quot;Dynamic&quot; popup parameter values are in HTML form elements. See form fields and hidden fields. The parameter names are the field names. 
	private static final String POPUP_POOL_EFF_DATE_DYN_PARAMS = 
			POOL_ID_FN
			+ &quot;,&quot; + POOL_NAME_FN
			+ &quot;,&quot; + ProfilePageModel.SHOW_AS_DATE_FN
			+ &quot;,&quot; + VIEW_DATE_FN
			+ &quot;,&quot; + WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN; //the selected employee IDs
	
	//&quot;Static&quot; popup parameter values appear in the attribute of the popup button's HTML element. See makePopupEffDateBtn() for the values. 
	private static final String POPUP_POOL_EFF_DATE_STAT_PARAMS =
		ProfileAdminPC.MODE_FN
		+ &quot;,&quot; + ProfileAdminPC.IS_NEW_FN
		+ &quot;,&quot; + ProfileAdminPC.EFF_START_DATE_FN
		+ &quot;,&quot; + ProfileAdminPC.EFF_END_DATE_FN;
		
		//+ &quot;,&quot; + &quot;IS_POOL_MULTI_VALUE&quot;;
	    
    
    /**
     * Creates a new instance of TimeOffPoolAssignmentPC
     * @param context
     */
    public TimeOffPoolAssignmentPC(RequestContext context) 
    {
<span class="fc" id="L111">        super(context);</span>
<span class="fc" id="L112">        m_bundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L113">        m_loggedInUserEmpID = context.getUser().getEmployeeID();</span>
<span class="fc" id="L114">        setName(&quot;TimeOffPoolAssignmentPC&quot;);</span>
        
<span class="fc" id="L116">        m_dateRangePickerPC = new DateRangePickerPC(context, POOL_EFF_FN);</span>
<span class="fc" id="L117">        m_dateRangePickerPC.setIsMultiValueSupported(true);</span>
<span class="fc" id="L118">        addChildComponent(m_dateRangePickerPC);</span>
        
        //pool effective dates		
<span class="fc" id="L121">		addPopupArgs(POPUP_POOL_EFF_DATE, TOPoolEffectivityPopupPM.FORM_ACTION, POPUP_POOL_EFF_DATE_DYN_PARAMS, </span>
				POPUP_POOL_EFF_DATE_STAT_PARAMS, &quot;650,500,ctr,ctr&quot;, true, 1);
<span class="fc" id="L123">    }</span>

	/**
	 * Initialize Component For Display
	 */
	@Override
	public void initForDisplay()
	{
<span class="fc bfc" id="L131" title="All 2 branches covered.">		if (m_isInitializedForDisplay) {</span>
<span class="fc" id="L132">			return;</span>
		} else {
<span class="fc" id="L134">			super.initForDisplay();</span>
<span class="fc" id="L135">			initContent();</span>
		}
<span class="fc" id="L137">	}</span>

    /**
     * Initialize PC with Data to be displayed
     * @param noPoolAssignmentsFound - true if none of the selected employees have a pool assignment on the viewDate
     */
    public void init(Employee emp, Collection empIDs, TOPool pool, EmpTOPoolAssignment empTOPoolAssignment, boolean isEditable, 
			boolean isMultiEdit, Date viewDate, boolean noPoolAssignmentsFound) throws Exception {
<span class="fc" id="L145">    	m_employee = emp;</span>
<span class="fc" id="L146">        m_empIDs = empIDs;</span>
<span class="fc" id="L147">        m_isEditable = isEditable;</span>
<span class="fc" id="L148">        m_isMultiEdit = isMultiEdit;        </span>
        
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">		if (viewDate != null) {</span>
        	//viewDate is already in GMT since the DatePickerPC already converts from getViewingTimeZone to GMT 
<span class="fc" id="L152">            m_viewDateLocal = new LocalDate(viewDate, TimeZone.getTimeZone(&quot;GMT&quot;) );</span>
        }

<span class="fc" id="L155">        m_pool = pool;</span>
<span class="fc" id="L156">        m_empTOPoolAssignment = empTOPoolAssignment;</span>
<span class="fc" id="L157">        m_noPoolAssignmentsFound = noPoolAssignmentsFound;</span>
<span class="fc" id="L158">    }</span>
 
    /**
     * Initialize Content
     */
    private void initContent() 
    {
<span class="fc" id="L165">        String title = i18n(m_bundle, BbmWebBundleKey.PEOPLE_TIMEOFF_POOL_HEADER);</span>
<span class="fc" id="L166">        setTitle(title);</span>
<span class="fc" id="L167">        setTemplate(&quot;{0}&quot;);</span>

<span class="pc bpc" id="L169" title="3 of 6 branches missed.">        super.addComponent( makeTextAndDateInput(m_isEditable &amp;&amp; m_empIDs!=null &amp;&amp; m_empIDs.size()&gt;0) );</span>
<span class="fc" id="L170">    }</span>

    
    /**
     * make html string and add it as the component for the text and date value also provide an edit
     * button, which pops up an Edit Values window.
     */
    private String makeTextAndDateInput(boolean isEditable) 
    {        
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        if (m_pool != null) // &amp;&amp; (m_pool.getID()!=null || m_pool.isFieldMultiValue(TOPoolFieldInfo.TOPOOL_ID)))</span>
        {
<span class="fc" id="L181">        	String poolName = m_pool.getName();</span>
<span class="fc" id="L182">            Object poolID = m_pool.getID(); //m_pool.getFieldValue(TOPoolFieldInfo.TOPOOL_ID);</span>
<span class="fc" id="L183">            String empIDString = &quot;&quot;;</span>
            
<span class="pc bpc" id="L185" title="1 of 4 branches missed.">            if (m_employee!=null &amp;&amp; m_employee.getID()!=null)</span>
            {
<span class="fc" id="L187">            	empIDString = m_employee.getID().toString();</span>
            }
<span class="pc bpc" id="L189" title="2 of 4 branches missed.">            else if (m_empIDs != null &amp;&amp; m_empIDs.size() &gt; 0)</span>
            {
                //get all empID's in a comma-delimitted string
            	//empIDString = m_employee.getMultiEditIDsInString(); //This returns a weird format of ID's: unusable to me!

<span class="fc bfc" id="L194" title="All 2 branches covered.">            	for (Iterator it=m_empIDs.iterator(); it.hasNext();)</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">            		empIDString += ((ID)it.next()).toString() + (it.hasNext() ? &quot;,&quot; : &quot;&quot;);</span>
            }
            
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">            if (m_pool.isFieldMultiValue(TOPoolFieldInfo.TOPOOL_ID)) </span>
            {
<span class="nc" id="L200">            	poolID = MULTI_VALUE_DATA;</span>
            }
            
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">            if (m_pool.isFieldMultiValue(TOPoolFieldInfo.TOPOOL_NAME)) </span>
<span class="nc" id="L204">                poolName = MULTI_VALUE_DATA;</span>
            
            // --- make controls and add to the container
            
            //Get the pool name input field
<span class="fc" id="L209">			StringBuilder sb = new StringBuilder();</span>
			// wrap the pool name's input so it aligns with the date picker
<span class="fc" id="L211">			sb.append(&quot;&lt;span style=\&quot;vertical-align: middle;\&quot;&gt;&quot;);</span>
<span class="fc" id="L212">			sb.append(HtmlUtil.makeTextReadOnlyInput(POOL_NAME_FN, DEFAULT_FIELD_WIDTH, poolName));</span>
<span class="fc" id="L213">			sb.append(&quot;&lt;/span&gt;&quot;);</span>
<span class="fc" id="L214">            sb.append(HtmlUtil.makeHiddenInput(POOL_ID_FN, poolID));</span>
<span class="fc" id="L215">            sb.append(HtmlUtil.makeHiddenInput(POOL_EDITABLE_FN, isEditable));</span>
<span class="fc" id="L216">            sb.append(HtmlUtil.makeHiddenInput(POOL_VIEWABLE_FN, true));</span>
<span class="fc" id="L217">            sb.append(HtmlUtil.makeHiddenInput(ProfileAdminPC.MODE_FN, m_mode)); //this will be set to POOL_MODE_SAVE by JavaScript if popup value is set</span>
<span class="fc" id="L218">            sb.append(HtmlUtil.makeHiddenInput(WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN, empIDString));</span>
<span class="fc" id="L219">            sb.append(HtmlUtil.makeHiddenInput(IS_EFFECTIVITY, true));</span>
<span class="fc" id="L220">            sb.append(HtmlUtil.makeHiddenInput(EFFECTIVITY_PARAM, WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN));</span>
<span class="fc" id="L221">            sb.append(HtmlUtil.makeHiddenInput(VIEW_DATE_FN, m_viewDateLocal.getTime(TimeZone.getTimeZone(&quot;GMT&quot;)).getTime()));</span>
                        
            //convert the GMT dates to local dates for the agent's timezone.
            //If startTime is multi-value, and endTime is not, then we cannot call m_empTOPoolAssignment.convertTimePeriodToLocal() since startTime will be null.
<span class="fc" id="L225">            LocalDate startDate = convertTimeToLocal(m_empTOPoolAssignment.getStartTime(), m_context.getViewingTimeZone()); </span>
<span class="fc" id="L226">            LocalDate endDate = convertTimeToLocal(m_empTOPoolAssignment.getEndTime(), m_context.getViewingTimeZone()); </span>
            
            //GQ: What's this for???
            //if (startDate == null &amp;&amp; m_empIDs!=null &amp;&amp; m_empIDs.size()&gt;0 &amp;&amp; !poolName.isEmpty()) 
            //    startDate = m_viewDate;
            
<span class="fc" id="L232">            adjustEndDateForDisplay(endDate);</span>
    
            //Add the popup button
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">			if (isEditable)</span>
<span class="fc" id="L236">                sb.append(makePopupEffDateBtn(POPUP_POOL_EFF_DATE, startDate, endDate));</span>
			else
<span class="nc" id="L238">				sb.append(&quot; &quot;);</span>
            
            //Add the date range picker
<span class="fc" id="L241">            sb.append( getEffectivityDateRangePicker(POOL_EFF_FN, startDate, endDate) );</span>

<span class="fc" id="L243">            return sb.toString();</span>
        }
<span class="nc" id="L245">        return &quot;&quot;;</span>
    }
    
	public LocalDate convertTimeToLocal(Date date, TimeZone tz) 
	{
<span class="fc bfc" id="L250" title="All 2 branches covered.">		return date==null ? null : new LocalDate(date, tz);</span>
	}
	
    /**
     * This is just to adjust for the way the effectivity end date is stored in DB and how 
     * it needs to be displayed to the user. 
     * Ex: Say an effectivity period set from 03/20/2007 to 03/22/2007. End date is stored as
     * 03/23/2007 00:00:00. To display it to user need to subtract one day to make it 03/22/2007. 
     * @param endDate
     */
    private static void adjustEndDateForDisplay(LocalDate endDate) {
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">        if (endDate!=null) {</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">            if (endDate.get(Calendar.MINUTE)==59) {</span>
                // Need to compensate for last effetive assignment end date 
                // which is stored at the last minute of the date
<span class="nc" id="L265">                endDate.add(Calendar.MINUTE, 1);</span>
            }
            
            // Need to subtract a day on end date to show to the user correctly
<span class="nc" id="L269">            endDate.add(Calendar.DATE, -1);</span>
        }       
<span class="fc" id="L271">    }    </span>
    
    /**
     * Make sure we are storing effective dates to mid night.
     * For example if user set effectivity end as 15th May 2007 set it as May 16th 2007 12:00:00 AM. 
     * @param drPickerPC
     * @param endLocalDateFieldIndex
     * @param pool
     */    
    private static Date getEffectiveEndDate(DateRangePickerPC drPickerPC) 
    {
    	/*
        LocalDate localDate = drPickerPC.getEndDatePickerPC().getLocalDate();
        
        if (localDate == null)
        	return null;
        
        if (localDate.getCal().get(Calendar.MINUTE)==59) 
        {
            Calendar aCal = localDate.getCal();
            aCal.add(Calendar.MINUTE, 1);
            aCal.set(Calendar.SECOND, 0);
            aCal.set(Calendar.MILLISECOND, 0);
            
        } 
        
        return localDate.getTime();
        */

<span class="fc" id="L300">    	Date date = drPickerPC.getEndDatePickerPC().getDate();</span>
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">        if (date == null)</span>
<span class="fc" id="L302">        	return null;</span>
    	
<span class="nc" id="L304">    	Calendar aCal = drPickerPC.getEndDatePickerPC().getCalendar();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (aCal.get(Calendar.MINUTE)==59) </span>
        {
<span class="nc" id="L307">            aCal.add(Calendar.MINUTE, 1);</span>
<span class="nc" id="L308">            aCal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L309">            aCal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L310">            date = aCal.getTime();</span>
        } 
        
<span class="nc" id="L313">        return date;</span>
    }
    
    /**
     * Create and return the HTML for the date range picker. It will be read-only.
     * because we expect the user to use the effective dates popup to set the values.
     * @param fieldName - the field name to give to the date range picker.
     * @param startDate - the start date. If m_empTOPoolAssignment uses multi-value start date, we will show &quot;*&quot; instead.
     * @param startDate - the end date. If m_empTOPoolAssignment uses multi-value end date, we will show &quot;*&quot; instead.
     * @return  the HTML for the date range picker. It will be read-only.
     */
    private String getEffectivityDateRangePicker(String fieldName, LocalDate startDate, LocalDate endDate) 
    {
<span class="fc" id="L326">        m_dateRangePickerPC.setDateInputFieldName(fieldName);</span>
<span class="fc" id="L327">        m_dateRangePickerPC.setIsControlEnabled(false);</span>
        
<span class="fc" id="L329">        DatePickerPC sDatePC = m_dateRangePickerPC.getStartDatePickerPC();</span>
<span class="fc" id="L330">        DatePickerPC eDatePC = m_dateRangePickerPC.getEndDatePickerPC();</span>
        
<span class="fc" id="L332">        sDatePC.setIsDateValueOptional(true);</span>
<span class="fc" id="L333">        eDatePC.setIsDateValueOptional(true);</span>
        
<span class="fc" id="L335">        sDatePC.setDate(startDate);</span>
<span class="fc" id="L336">        eDatePC.setDate(endDate);</span>
        
<span class="pc bpc" id="L338" title="2 of 4 branches missed.">        boolean isMultiSDate = m_empTOPoolAssignment!=null &amp;&amp; m_empTOPoolAssignment.isFieldMultiValue(EmpTOPoolAssignmentFieldInfo.EMPTOPOOL_STARTTIME);</span>
<span class="pc bpc" id="L339" title="2 of 4 branches missed.">        boolean isMultiEDate = m_empTOPoolAssignment!=null &amp;&amp; m_empTOPoolAssignment.isFieldMultiValue(EmpTOPoolAssignmentFieldInfo.EMPTOPOOL_ENDTIME);</span>
<span class="fc" id="L340">        sDatePC.setIsMultiValue(isMultiSDate);</span>
<span class="fc" id="L341">        eDatePC.setIsMultiValue(isMultiEDate);</span>

<span class="fc" id="L343">        return m_dateRangePickerPC.toString();</span>
    }
    

    private String makePopupEffDateBtn(String actionType, LocalDate sDate, LocalDate eDate) 
    {
<span class="fc" id="L349">        StringBuffer sb = new StringBuffer();</span>
<span class="fc" id="L350">        long startDateInMillis = -1;</span>
<span class="fc" id="L351">        long endDateInMillis = -1;</span>
        
<span class="fc bfc" id="L353" title="All 2 branches covered.">        if (sDate!=null) </span>
<span class="fc" id="L354">        	startDateInMillis = sDate.getCal().getTimeInMillis();</span>
        
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">        if (eDate!=null) </span>
<span class="nc" id="L357">        	endDateInMillis = eDate.getCal().getTimeInMillis();</span>
        
<span class="fc" id="L359">        boolean isMultiSDate = m_empTOPoolAssignment.isFieldMultiValue(EmpTOPoolAssignmentFieldInfo.EMPTOPOOL_STARTTIME);</span>
<span class="fc" id="L360">        boolean isMultiEDate = m_empTOPoolAssignment.isFieldMultiValue(EmpTOPoolAssignmentFieldInfo.EMPTOPOOL_ENDTIME);</span>
        
        //create the EDIT button and its attributes
<span class="fc" id="L363">		sb.append(HtmlUtil.imageTag(ImageFileID.EDIT, ImageFileID.EDIT_WIDTH,</span>
<span class="fc" id="L364">						ImageFileID.EDIT_HEIGHT, i18n(m_bundle,	BbmWebBundleKey.EDIT), false));		</span>
<span class="fc" id="L365">		sb.append(&quot; onClick=\&quot;workpaneMediator_popupToolbar.onSelect('&quot;); 		</span>
<span class="fc" id="L366">		sb.append(actionType).append(&quot;',this)\&quot; &quot;).append(&quot;actionType=\&quot;&quot;).append(actionType).append(&quot;\&quot; &quot;);		</span>
<span class="fc" id="L367">		sb.append(ProfileAdminPC.MODE_FN).append(&quot;=\&quot;&quot;).append(m_mode).append(&quot;\&quot; &quot;);		</span>
<span class="fc" id="L368">		sb.append(ProfileAdminPC.IS_NEW_FN).append(&quot;=\&quot;&quot;).append(false).append(&quot;\&quot; &quot;);</span>

		try
		{
			//Get the common start and end dates for all employees for the new pool assignment to be created in the empty space
<span class="pc bpc" id="L373" title="1 of 4 branches missed.">			if ((m_employee != null) &amp;&amp; m_noPoolAssignmentsFound)</span>
			{
<span class="fc" id="L375">		        Collection empIDs = m_empIDs;</span>
		        
<span class="pc bpc" id="L377" title="2 of 4 branches missed.">		        if (empIDs != null &amp;&amp; empIDs.size()&gt;0)</span>
		        {
<span class="fc" id="L379">		            LocalDate commonStartLocal = null;</span>
<span class="fc" id="L380">		            LocalDate commonEndLocal = null;	        </span>
<span class="fc" id="L381">		        	boolean bFirst = true;</span>
<span class="fc bfc" id="L382" title="All 2 branches covered.">		        	for (Iterator it=empIDs.iterator(); it.hasNext(); bFirst=false)</span>
		        	{
<span class="fc" id="L384">		        		ID empID = (ID)it.next();</span>
		        		
<span class="fc" id="L386">		        		Date curStart = PeopleMH.getPreviousPoolAssignmentEnd(empID, m_viewDateLocal.getTime(TimeZone.getTimeZone(&quot;GMT&quot;)));</span>
<span class="fc" id="L387">		        		Date curEnd = PeopleMH.getNextPoolAssignmentStart(empID, m_viewDateLocal.getTime(TimeZone.getTimeZone(&quot;GMT&quot;)));</span>
		        		
<span class="pc bpc" id="L389" title="3 of 4 branches missed.">		        		if (curStart==null || curEnd==null)</span>
		        		{
<span class="fc" id="L391">			        		Employee emp = ValidationUtil.getEmployeeByID(empID, null, Employee.DETAIL_LEVEL_EMPLOYEE_BASIC);</span>
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">			        		if (curStart==null)</span>
<span class="fc" id="L393">			        			curStart = emp.getStartTime();</span>
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">			        		if (curEnd==null)</span>
<span class="fc" id="L395">			        			curEnd = emp.getEndTime();</span>
		        		}
		        		
<span class="fc" id="L398">		        		LocalDate curStartLocal = convertTimeToLocal(curStart, m_context.getViewingTimeZone());</span>
<span class="fc" id="L399">		        		LocalDate curEndLocal = convertTimeToLocal(curEnd, m_context.getViewingTimeZone());</span>
	
<span class="fc bfc" id="L401" title="All 2 branches covered.">		        		if (bFirst)</span>
		        		{
<span class="fc" id="L403">		        			commonStartLocal = curStartLocal;</span>
<span class="fc" id="L404">		        			commonEndLocal = curEndLocal;	        			</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">		        			startDateInMillis = (commonStartLocal==null) ? -1 : commonStartLocal.getCal().getTimeInMillis();</span>
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">		        			endDateInMillis = (commonEndLocal==null) ? -1 : commonEndLocal.getCal().getTimeInMillis();</span>
		        		}
		        		else
		        		{
<span class="pc bpc" id="L410" title="1 of 2 branches missed.">		        			if (!isSameValue(commonStartLocal, curStartLocal))</span>
<span class="nc" id="L411">		        				isMultiSDate = true;</span>
		        			
<span class="pc bpc" id="L413" title="1 of 2 branches missed.">		        			if (!isSameValue(commonEndLocal, curEndLocal))</span>
<span class="nc" id="L414">		        				isMultiEDate = true;</span>
		        		}
		        		
<span class="pc bpc" id="L417" title="2 of 4 branches missed.">		        		if (isMultiSDate || isMultiEDate)</span>
<span class="nc" id="L418">		        			break;</span>
		        	}
		        }
			}			
			
<span class="pc bpc" id="L423" title="2 of 4 branches missed.">			if (isMultiSDate || (startDateInMillis != -1))</span>
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">				sb.append(ProfileAdminPC.EFF_START_DATE_FN).append(&quot;=\&quot;&quot;).append(isMultiSDate?MULTI_VALUE_DATA:startDateInMillis).append(&quot;\&quot; &quot;);</span>
	
<span class="pc bpc" id="L426" title="2 of 4 branches missed.">			if (isMultiEDate || (endDateInMillis != -1))</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">				sb.append(ProfileAdminPC.EFF_END_DATE_FN).append(&quot;=\&quot;&quot;).append(isMultiEDate?MULTI_VALUE_DATA:endDateInMillis).append(&quot;\&quot; &quot;);</span>
	
<span class="fc" id="L429">			sb.append(&quot; border=\&quot;0\&quot; align=\&quot;absmiddle\&quot; style=\&quot;&quot;).append(CSSUtil.STYLE_CLICKABLE).append(&quot;\&quot;&gt;&quot;);</span>
		}
<span class="nc" id="L431">		catch (Exception ex) </span>
		{
<span class="nc" id="L433">			handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L434">		} </span>
<span class="fc" id="L435">		return sb.toString();        </span>
    }

    /**
     * Determines if two Object are equal. 
     * @param val1 The first Object.
     * @param val2 The second Object.
     * @return true if the two Object should be considered equal, false otherwise.
     */
    private boolean isSameValue(Object val1, Object val2)
    {
<span class="fc" id="L446">        boolean areSame = false;</span>
<span class="pc bpc" id="L447" title="1 of 4 branches missed.">        if (val1==null &amp;&amp; val2==null)</span>
        {
<span class="fc" id="L449">            areSame = true;</span>
        }
<span class="pc bpc" id="L451" title="2 of 4 branches missed.">        else if (val1==null || val2==null)</span>
        {
<span class="nc" id="L453">            areSame = false;</span>
        }
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">        else if (val1.equals(val2))</span>
        {
<span class="fc" id="L457">            areSame = true;</span>
        }
<span class="fc" id="L459">        return areSame;</span>
    }
    
	
    @Override
	public boolean extractParameters(HttpServletRequest request) 
    {
<span class="fc" id="L466">        m_dateRangePickerPC.extractParameters(request);</span>
        
<span class="fc" id="L468">        return super.extractParameters(request);</span>
    }
    
    //Setters which are called automatically from super.extractParameters()
    
    /**
     * Set the Time Off Pool ID
     * @param vVal - The pool ID, or &quot;*&quot; to indicate multi-value.
     */
    public void setPoolId(String aVal)
    {
<span class="pc bpc" id="L479" title="2 of 4 branches missed.">        if (aVal != null &amp;&amp; aVal.length() &gt; 0)            </span>
        {
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">        	if (m_pool == null)</span>
<span class="nc" id="L482">        		m_pool = new TOPool();</span>
        	
<span class="pc bpc" id="L484" title="1 of 2 branches missed.">	        if (!aVal.equals(MULTI_VALUE_DATA)) </span>
	        {
	            // Non-multi value
<span class="fc" id="L487">	            m_pool.setID(getIDFromString(aVal));</span>
	        } 
	        else 
	        { 
	            // Multi-value
<span class="nc" id="L492">	            m_pool.setFieldMultiValue(TOPoolFieldInfo.TOPOOL_ID);</span>
	        }
        }
<span class="fc" id="L495">    }</span>
    
    /**
     * Set the Time Off Pool Name
     */
    public void setPoolId_RO(String aVal)
    {
<span class="pc bpc" id="L502" title="2 of 4 branches missed.">        if (aVal != null &amp;&amp; aVal.length() &gt; 0)            </span>
        {
<span class="fc bfc" id="L504" title="All 2 branches covered.">        	if (m_pool == null)</span>
<span class="fc" id="L505">        		m_pool = new TOPool();</span>
        	
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">	        if (!aVal.equals(MULTI_VALUE_DATA)) </span>
	        {
	            // Non-multi value
<span class="fc" id="L510">	            m_pool.setName(aVal); //getProcessedString(aVal));</span>
	        } 
	        else 
	        { 
	            // Multi-value
<span class="nc" id="L515">	            m_pool.setFieldMultiValue(TOPoolFieldInfo.TOPOOL_NAME);</span>
	        }
        }
<span class="fc" id="L518">    }</span>
    
    /**
     * Set the pool effectivity mode telling us whether or not we should save the effective dates.
     * @param mode - one of MODE_VIEW_POOL, MODE_SAVE_POOL
     */
    public void setMode(String mode)
    {
<span class="fc" id="L526">    	m_mode = mode;</span>
<span class="fc" id="L527">    }</span>
    
    //Getters
    
    /**
     * Get the pool effectivity mode telling us whether or not we should save the effective dates.
     * @return - one of MODE_VIEW_POOL, MODE_SAVE_POOL
     */
    public String getMode()
    {
<span class="fc" id="L537">    	return m_mode;</span>
    }
    
    
    private ID getIDFromString(String aVal) {
<span class="pc bpc" id="L542" title="2 of 4 branches missed.">        if (aVal == null || aVal.length() &lt; 1)</span>
<span class="nc" id="L543">            return null;</span>
        else
<span class="fc" id="L545">            return new ID(aVal);</span>
    }
    
	public Date getTOPoolEffStartDate()
	{
<span class="fc" id="L550">		return m_dateRangePickerPC.getStartDatePickerPC().getDate();</span>
	}
	
	public Date getTOPoolEffEndDate()
	{
<span class="fc" id="L555">		return getEffectiveEndDate(m_dateRangePickerPC);</span>
	}
	
	
	/**
	 * Return the time off pool ID currently set in the page model.
	 */
	public ID getPoolId() 
	{
<span class="pc bpc" id="L564" title="1 of 2 branches missed.">		return m_pool==null?null:m_pool.getId();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>