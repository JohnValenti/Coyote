<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PulseAppletRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.pulse</a> &gt; <span class="el_source">PulseAppletRequestHandler.java</span></div><h1>PulseAppletRequestHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.pulse;

import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Set;
import java.util.StringTokenizer;
import java.util.TimeZone;

import com.bluepumpkin.common.base.BPException;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.JdmoDuplicateKeyException;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingRequest;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingState;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.pulse.model.ExportTraceDescriptor;
import com.bluepumpkin.ejb.bbm.pulse.model.TrackingView;
import com.bluepumpkin.ejb.bbm.pulse.model.TrendingConfig;
import com.bluepumpkin.ejb.bbm.timeseries.model.ActualTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.AggrForecastedTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.AggrRequiredTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.PredictTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.RequireTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ServiceGoalTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceChunk;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceUtil;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.core.CoreEJBCreateException;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.profile.UserProfileKeys;
import com.bluepumpkin.ejb.facade.FacadeEJBCreateException;
import com.bluepumpkin.ejb.facade.FacadeManagerFactory;
import com.bluepumpkin.ejb.facade.corbafacade.ejb.FacadeCorbaFacadeManager;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.campaign.selection.CampaignSchedulingPeriodSelectionUtil;
import com.bluepumpkin.web.bbm.workload.queue.selection.QueueFilterUtil;
import com.bluepumpkin.web.core.applet.AppletIO;
import com.bluepumpkin.web.core.applet.AppletRH;
import com.bluepumpkin.web.core.applet.TextAppletIO;
import com.bluepumpkin.web.core.cache.SelectionCacheUtil;
import com.bluepumpkin.web.core.keys.PageKeys;
import com.bluepumpkin.web.fs.Log;
import com.bluepumpkin.web.fs.keys.FsKeys;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
//import com.bluepumpkin.web.fs.l10n.PulseBundleKey;
import com.bluepumpkin.web.fs.pulse.keys.PulseKeys;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.UserManager;
import com.witness.web.core.keys.Caching;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.l10n.VerticalizationWebBundleKey;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.cache.UserCacheManager;
import com.witness.web.uif.system.manager.VerticalizationManager;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.CacheUtil;
import com.witness.web.uif.util.KeyDisplayPair;
import com.witness.web.uif.util.RangeValuePair;

/**
 * Title: PulseAppletRequestHandler Description: Handle applet requests from the
 * pulse tab. Copyright: Copyright (c) 2004 Company: Blue Pumpkin Software, Inc
 * 
 * @author Swati Tewari
 * @version 1.0
 */

<span class="nc" id="L92">public class PulseAppletRequestHandler extends AppletRH {</span>

<span class="fc" id="L94">	private static final Category cat = Log.initCategory(PulseAppletRequestHandler.class.getName());</span>

	// Pulse view types
	private static final int PULSE_VIEW = 0;
	private static final int HISTORY_VIEW = 1;

<span class="nc" id="L100">	private CampaignManager m_campaignManager = null;</span>
<span class="nc" id="L101">	protected FacadeCorbaFacadeManager m_facadeCorbaFacadeManager = null;</span>
<span class="nc" id="L102">	private UserManager m_userManager = null;</span>

	/**
	 * Overrides the base class to fetch the initial user preferences variables
	 * that the Pulse applet needs.
	 */
	protected Map getInitUserProperties(RequestContext context) {
		// System.out.println(&quot;\n\nPulseAppletRequestHandler.getInitUserProperties()...\n&quot;);
<span class="nc" id="L110">		ArrayList properties = new ArrayList(7);</span>

<span class="nc" id="L112">		properties.add(QueueFilterUtil.QUEUE_FILTER_CAMP_START_DATE);</span>
<span class="nc" id="L113">		properties.add(QueueFilterUtil.QUEUE_FILTER_CAMP_END_DATE);</span>
<span class="nc" id="L114">		properties.add(UserProfileKeys.PULSE_SHOW_SUMMARY_TABLE);</span>
<span class="nc" id="L115">		properties.add(UserProfileKeys.PULSE_SHOW_DATA_TABLE);</span>
<span class="nc" id="L116">		properties.add(UserProfileKeys.PULSE_SHOW_COMBINED_QUEUE);</span>
<span class="nc" id="L117">		properties.add(UserProfileKeys.PULSE_SHOW_CAMPAIGN_TIMEZONE);</span>
<span class="nc" id="L118">		properties.add(UserProfileKeys.PULSE_VIEW_ID);</span>
<span class="nc" id="L119">		properties.add(UserProfileKeys.PULSE_ZOOM_LEVEL);</span>
<span class="nc" id="L120">		properties.add(UserPreferenceKeys.USER_PULSE_AUTO_REFRESH);</span>
<span class="nc" id="L121">		properties.add(UserProfileKeys.PULSE_DATA_TABLE_DIVIDER_LOCATION);</span>
<span class="nc" id="L122">		properties.add(UserProfileKeys.PULSE_SHOW_DATE_RANGE_PICKER);</span>
<span class="nc" id="L123">		properties.add(UserProfileKeys.USER_ACCESSIBILITY_COMPLIANCE_MODE);// Added</span>
																			// for
																			// QA98797
		// properties.add(UserProfileKeys.PULSE_SELECTED_DATE_PICKER_RANGE);

<span class="nc" id="L128">		Map map = new HashMap(2);</span>
<span class="nc" id="L129">		map.put(PageKeys.PROPERTY_KEYS_COLLECTION, properties);</span>
<span class="nc" id="L130">		Map resultMap = getUserProperties(context, map);</span>

		// The following parameters are used when cross-navigating from DE (F&amp;S)
		// to Pulse

<span class="nc" id="L135">		Boolean isFromDE = (Boolean) context.getAttribute(RequestContext.ONE_TIME_USE_SESSION_SCOPE,</span>
				QueueFilterUtil.PULSE_IS_FROM_DE);
<span class="nc bnc" id="L137" title="All 4 branches missed.">		if (isFromDE != null &amp;&amp; isFromDE.booleanValue()) {</span>
<span class="nc" id="L138">			resultMap.put(QueueFilterUtil.PULSE_IS_FROM_DE, &quot;true&quot;);</span>
		} else {
			// When not coming from F&amp;S Client, we get the spID from the
			// USERPROFILE table, which is shared among all F&amp;S On The Web
			// modules.
			try {
<span class="nc" id="L144">				ID spID = QueueFilterUtil.retrieveSchedulingPeriodID(context);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">				if (spID != null) {</span>
<span class="nc" id="L146">					SchedulingPeriod sp = CampaignModelHandler.getSchedPeriod(context, spID);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">					if (sp != null) {</span>
<span class="nc" id="L148">						QueueFilterUtil.storeTimePeriodStart(context, sp.getStartTime());</span>
<span class="nc" id="L149">						QueueFilterUtil.storeTimePeriodEnd(context, sp.getEndTime());</span>
<span class="nc" id="L150">						resultMap.put(QueueFilterUtil.QUEUE_FILTER_CAMP_START_DATE, &quot;&quot; + sp.getStartTime().getTime());</span>
<span class="nc" id="L151">						resultMap.put(QueueFilterUtil.QUEUE_FILTER_CAMP_END_DATE, &quot;&quot; + sp.getEndTime().getTime());</span>
					}
				}
<span class="nc" id="L154">			} catch (Exception ex) {</span>
				// do nothing
<span class="nc" id="L156">			}</span>
		}

<span class="nc" id="L159">		ID campID = QueueFilterUtil.retrieveCampaignID(context);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">		resultMap.put(&quot;FS_CAMPAIGN_ID&quot;, campID == null ? null : campID.toString());</span>

		// override stored zoom level, dayOffset, and weekOffset if coming from
		// DE
<span class="nc" id="L164">		String deZoom = (String) context.getAttribute(RequestContext.ONE_TIME_USE_SESSION_SCOPE,</span>
				QueueFilterUtil.PULSE_ZOOM);
<span class="nc bnc" id="L166" title="All 2 branches missed.">		if (deZoom != null) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">			if (deZoom.equals(&quot;day&quot;))</span>
<span class="nc" id="L168">				resultMap.put(UserProfileKeys.PULSE_ZOOM_LEVEL, &quot;0&quot;);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">			else if (deZoom.equals(&quot;week&quot;))</span>
<span class="nc" id="L170">				resultMap.put(UserProfileKeys.PULSE_ZOOM_LEVEL, &quot;1&quot;);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">			else if (deZoom.equals(&quot;period&quot;))</span>
<span class="nc" id="L172">				resultMap.put(UserProfileKeys.PULSE_ZOOM_LEVEL, &quot;2&quot;);</span>

			// Special case: in Org mode, DE has week zoom but pulse has period
			// zoom.
<span class="nc bnc" id="L176" title="All 4 branches missed.">			if (campID == null &amp;&amp; deZoom.equals(&quot;week&quot;))</span>
<span class="nc" id="L177">				resultMap.put(UserProfileKeys.PULSE_ZOOM_LEVEL, &quot;2&quot;);</span>
		}

<span class="nc" id="L180">		Integer dayOffset = (Integer) context.getAttribute(RequestContext.ONE_TIME_USE_SESSION_SCOPE,</span>
				QueueFilterUtil.PULSE_DAY_OFFSET);
<span class="nc bnc" id="L182" title="All 2 branches missed.">		if (dayOffset != null)</span>
<span class="nc" id="L183">			resultMap.put(QueueFilterUtil.PULSE_DAY_OFFSET, dayOffset.toString());</span>

<span class="nc" id="L185">		Integer weekOffset = (Integer) context.getAttribute(RequestContext.ONE_TIME_USE_SESSION_SCOPE,</span>
				QueueFilterUtil.PULSE_WEEK_OFFSET);
<span class="nc bnc" id="L187" title="All 2 branches missed.">		if (weekOffset != null)</span>
<span class="nc" id="L188">			resultMap.put(QueueFilterUtil.PULSE_WEEK_OFFSET, weekOffset.toString());</span>

<span class="nc" id="L190">		return resultMap;</span>
	}

	/**
	 * Process Applet Request - to be overrided by derived classes
	 * 
	 * @param context
	 *            - The Request Context
	 * @param appletRequest
	 *            - Map containing Applet Request Information
	 * @param appletResponse
	 *            - Map containing Response to be send to Applet
	 */
	protected void processAppletRequest(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc bnc" id="L204" title="All 2 branches missed.">		if (!pushRequest(context, appletRequest)) {</span>
<span class="nc" id="L205">			appletResponse.put(PageKeys.APPLET_ERROR, ERROR_RESPONSE_CODE);</span>
<span class="nc" id="L206">			return;</span>
		}

<span class="nc" id="L209">		Locale locale = context.getLocaleContext().getLanguageLocale();</span>

		try {
<span class="nc bnc" id="L212" title="All 2 branches missed.">			if (isAppletAction(appletRequest, PageAction.APPLET_INIT)) {</span>
<span class="nc" id="L213">				Collection commands = (Collection) appletRequest.get(PageKeys.APPLET_COMMANDS);</span>
<span class="nc" id="L214">				HashMap mapProperties = new HashMap(commands.size() * 2);</span>
<span class="nc" id="L215">				HashMap views = null;</span>
<span class="nc" id="L216">				Map userProps = null;</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">				for (Iterator iter = commands.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L219">					String command = (String) iter.next();</span>

<span class="nc" id="L221">					Object obj = null;</span>

					// Common applet init info
<span class="nc bnc" id="L224" title="All 2 branches missed.">					if (command.equals(GET_LOCALE_CONTEXT)) {</span>
<span class="nc" id="L225">						obj = context.getLocaleContext();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">					} else if (command.equals(PageAction.GET_USER_PRIVELEGES)) {</span>
<span class="nc" id="L227">						obj = getUser(context);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">					} else if (command.equals(PageAction.GET_USER_PROPERTIES)) {</span>
<span class="nc" id="L229">						obj = userProps = getInitUserProperties(context);</span>
					} 

					// Pulse-specific applet init info
<span class="nc bnc" id="L233" title="All 2 branches missed.">					else if (command.equals(PulseKeys.CHECK_OUTBOUND_LICENSE)) {</span>
<span class="nc" id="L234">						obj = checkOutboundLicense(context, appletRequest, appletResponse, false);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">					} else if (command.equals(PulseKeys.CHECK_PULSE_NOTES_EXCLUDE_IN_FORECAST_LICENSE)) {</span>
<span class="nc" id="L236">						obj = checkPulseNotesExcludeInForecastLicense(context, appletRequest, appletResponse, false);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">					} else if (command.equals(PulseKeys.CHECK_CAN_LAUNCH_FS)) {</span>
<span class="nc" id="L238">						obj = checkCanLaunchFS(context, appletRequest, appletResponse, false);</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">					} else if (command.equals(PulseKeys.GET_USER_VIEWS)) {</span>
<span class="nc" id="L240">						obj = views = getUserViews(context, appletRequest, appletResponse, false);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">					} else if (command.equals(PulseKeys.GET_VERTICALIZED_STRINGS)) {</span>
<span class="nc" id="L242">						obj = getVerticalizedStrings(context, appletRequest, appletResponse, false);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">					} else if (command.equals(PulseKeys.CHECK_PULSE_DEFAULT_SELECT_NO_QUEUE)) {</span>
<span class="nc" id="L244">						obj = isPulseSelectionNoDefault(context, appletRequest, appletResponse, false);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">					} else if (command.equals(PulseKeys.CHECK_ENABLE_ADJUSTED_STAFFING_FROM_PULSE)) {</span>
<span class="nc" id="L246">						obj = isEnableAdjustedStaffingFromPulse(context, appletRequest, appletResponse, false);</span>
					}

<span class="nc bnc" id="L249" title="All 2 branches missed.">					if (obj != null)</span>
<span class="nc" id="L250">						mapProperties.put(command + PageKeys.APPLET_RESPONSE, obj);</span>
<span class="nc" id="L251">				}</span>

				// Separate loop required to process GET_VIEW after
				// GET_USER_VIEWS, GET_USER_PROPERTIES
<span class="nc bnc" id="L255" title="All 2 branches missed.">				for (Iterator iter = commands.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L256">					String command = (String) iter.next();</span>
<span class="nc" id="L257">					Object obj = null;</span>

<span class="nc bnc" id="L259" title="All 2 branches missed.">					if (command.equals(PulseKeys.GET_VIEW)) {</span>
<span class="nc" id="L260">						int pulseViewType = ((Integer) appletRequest.get(PulseKeys.TRACKING_VIEW)).intValue();</span>
<span class="nc" id="L261">						ID viewID = getViewID(userProps, views, pulseViewType);</span>
<span class="nc" id="L262">						obj = getView(context, appletRequest, appletResponse, viewID, false);</span>
					}

<span class="nc bnc" id="L265" title="All 2 branches missed.">					if (obj != null)</span>
<span class="nc" id="L266">						mapProperties.put(command + PageKeys.APPLET_RESPONSE, obj);</span>
<span class="nc" id="L267">				}</span>

<span class="nc" id="L269">				addResponseData(mapProperties, appletResponse);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_TRACE_DATA)) {</span>
<span class="nc" id="L271">				getTraceData(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_USER_VIEWS)) {</span>
<span class="nc" id="L273">				getUserViews(context, appletRequest, appletResponse, true);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_INVISIBLE_VIEWS)) {</span>
<span class="nc" id="L275">				getInvisibleViewNames(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_VIEW)) {</span>
<span class="nc" id="L277">				getView(context, appletRequest, appletResponse, null, true);</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.CREATE_VIEW)) {</span>
<span class="nc" id="L279">				createView(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.EDIT_VIEW)) {</span>
<span class="nc" id="L281">				editView(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.DELETE_VIEW)) {</span>
<span class="nc" id="L283">				deleteView(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_TREND_CONFIG)) {</span>
<span class="nc" id="L285">				getTrendConfig(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_TREND_CONFIG)) {</span>
<span class="nc" id="L287">				saveTrendConfig(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.REFORECAST)) {</span>
<span class="nc" id="L289">				reForecast(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.CACHE_IDS_FOR_REFORECAST)) {</span>
<span class="nc" id="L291">				cacheIdsForReForecast(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_HISTORY)) {</span>
<span class="nc" id="L293">				saveHistory(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_CAMPAIGN_SPS)) {</span>
<span class="nc" id="L295">				getSchedulingPeriods(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_ALL_QUEUES)) {</span>
<span class="nc" id="L297">				getAllQueues(context, appletResponse, true);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_SCOPED_QUEUES)) {</span>
<span class="nc" id="L299">				getScopedQueues(context, appletResponse, true);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_EDITABLE_QUEUES)) {// QA100924</span>
<span class="nc" id="L301">				getEditableQueues(context, appletResponse, true);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_QUEUES_BY_CAMPAIGN_MEDIA)) {</span>
<span class="nc" id="L303">				getQueuesAttachedToCampaignMedia(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_AVAILABLE_QUEUES)) {</span>
<span class="nc" id="L305">				getAvailableQueues(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_CHUNKY_HISTORY)) {</span>
<span class="nc" id="L307">				saveChunkyHistory(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_CUBE_MAPS)) {</span>
<span class="nc" id="L309">				getCubeMaps(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.CHECK_PULSE_NOTES_EXCLUDE_IN_FORECAST_LICENSE)) {</span>
<span class="nc" id="L311">				checkPulseNotesExcludeInForecastLicense(context, appletRequest, appletResponse, true);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_PULSE_NOTES)) {</span>
<span class="nc" id="L313">				getPulseNotes(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_PULSE_NOTES)) {</span>
<span class="nc" id="L315">				savePulseNotes(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.ADD_PULSE_NOTES)) {</span>
<span class="nc" id="L317">				addPulseNotes(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.UPDATE_PULSE_NOTES)) {</span>
<span class="nc" id="L319">				updatePulseNotes(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.DELETE_PULSE_NOTES)) {</span>
<span class="nc" id="L321">				deletePulseNotes(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.CHECK_OUTBOUND_LICENSE)) {</span>
<span class="nc" id="L323">				checkOutboundLicense(context, appletRequest, appletResponse, true);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, FsKeys.CLEAR_SCHEDULE_STATE)) {</span>
				// msgID =
				// FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;
<span class="nc" id="L327">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L328">				String modeChar = (String) appletRequest.get(FsKeys.MODE_CHAR);</span>
<span class="nc" id="L329">				getCampaignManager(context, appletResponse, locale).clearSchedulingState(spID, modeChar);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_START_RECALC)) {</span>
				// msgID =
				// FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REQUESTING_RECALC;
<span class="nc" id="L333">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L334">				Boolean isEnableLQF = (Boolean) appletRequest.get(FsKeys.IS_ENABLE_LQF);</span>
<span class="nc" id="L335">				Boolean isRecalcSubCampaign = (Boolean) appletRequest.get(FsKeys.IS_RECALC_SUB_CAMPAIGNS);</span>

				// recalcscheduling error code : 1 - success, 2 - adapter error
				// , 4 - no adapter configured
<span class="nc" id="L339">				int errorCode = getFacadeCorbaFacadeManager(appletResponse, locale).recalcScheduling(</span>
<span class="nc" id="L340">						UserCacheManager.getInstance().getCachedUserName(context),</span>
<span class="nc" id="L341">						getUserManager(context, appletResponse, locale).generateToken(</span>
<span class="nc" id="L342">								UserCacheManager.getInstance().getCachedUserSeal(context)), context.isInWhatIfMode(),</span>
<span class="nc" id="L343">						1, spID, isEnableLQF, isRecalcSubCampaign, null);</span>
<span class="nc" id="L344">				appletResponse.put(PageKeys.CALENDAR_APPLET_GET_RECALC_SCHEDULING_ERROR_CODE, new Integer(errorCode));</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.APPLET_GET_DATA)) {</span>
<span class="nc" id="L346">				String typeData = (String) appletRequest.get(PageKeys.GET_TYPE);</span>

<span class="nc bnc" id="L348" title="All 2 branches missed.">				if (PageKeys.GET_SCHEDULING_STATE.equals(typeData)) {</span>
					// msgID =
					// FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;
<span class="nc" id="L351">					ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L352">					String modeChar = (String) appletRequest.get(FsKeys.MODE_CHAR);</span>
<span class="nc" id="L353">					SchedulingState state = getCampaignManager(context, appletResponse, locale).getSchedulingState(</span>
							spID, modeChar);
<span class="nc" id="L355">					addResponseData(state, appletResponse);</span>
				}
<span class="nc bnc" id="L357" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_SEND_SCHEDULE_REQUEST)) {</span>
				// msgID =
				// FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REQUESTING_SCHEDULE;
<span class="nc" id="L360">				SchedulingRequest request = (SchedulingRequest) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULING_REQUEST);</span>
<span class="nc" id="L361">				getCampaignManager(context, appletResponse, locale).makeSchedulingRequest(request);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PageKeys.DELETE_SCHEDULE_WARNINGS)) {</span>
				// msgID =
				// FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;
<span class="nc" id="L365">				Collection warningIDs = (Collection) appletRequest.get(PageKeys.SCHEDULEWARNING_IDS);</span>
<span class="nc" id="L366">				getCampaignManager(context, appletResponse, locale).clearSchedulingStateWarnings(warningIDs);</span>
<span class="nc" id="L367">			} else {</span>
<span class="nc" id="L368">				super.processAppletRequest(context, appletRequest, appletResponse);</span>
			}
<span class="nc" id="L370">		} catch (Exception ex) {</span>
<span class="nc" id="L371">			notifyError(context, appletResponse, ex);</span>
		} finally {
<span class="nc" id="L373">			super.popRequest(context, appletRequest);</span>
<span class="nc" id="L374">		}</span>

<span class="nc" id="L376">	}</span>

	/**
	 * Get the ID of the Pulse tracking view to be displayed.
	 * 
	 * @param userProps
	 *            Contains the last viewID selected (if any.
	 * @param userViews
	 *            A Collection of all view ID's available for the user.
	 * @param pulseViewType
	 *            One of: PULSE_VIEW, HISTORY_VIEW.
	 * @return the ID of the Pulse tracking view to be displayed.
	 */
	private ID getViewID(Map userProps, HashMap userViews, int pulseViewType) {
<span class="nc" id="L390">		ID viewID = TrackingView.INVALID_VIEW_ID;</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">		String viewIDStr = (userProps == null) ? null : (String) userProps.get(UserProfileKeys.PULSE_VIEW_ID);</span>

<span class="nc bnc" id="L393" title="All 2 branches missed.">		if (pulseViewType == PULSE_VIEW) {</span>
<span class="nc bnc" id="L394" title="All 4 branches missed.">			if ((viewIDStr == null) &amp;&amp; (userViews != null)) {</span>
<span class="nc" id="L395">				Collection pubViewPairs = (Collection) userViews.get(PulseKeys.VIEWS_PUBLIC);</span>
<span class="nc" id="L396">				Collection pubROViewPairs = (Collection) userViews.get(PulseKeys.VIEWS_PUBLIC_RO);</span>
<span class="nc" id="L397">				Collection privateViewPairs = (Collection) userViews.get(PulseKeys.VIEWS_PRIVATE);</span>

<span class="nc bnc" id="L399" title="All 4 branches missed.">				if ((pubViewPairs != null) &amp;&amp; (pubViewPairs.size() &gt; 0)) {</span>
<span class="nc" id="L400">					viewID = (ID) ((KeyDisplayPair) ((ArrayList) pubViewPairs).get(0)).getKey();</span>
<span class="nc bnc" id="L401" title="All 4 branches missed.">				} else if ((pubROViewPairs != null) &amp;&amp; (pubROViewPairs.size() &gt; 0)) {</span>
<span class="nc" id="L402">					viewID = (ID) ((KeyDisplayPair) ((ArrayList) pubROViewPairs).get(0)).getKey();</span>
<span class="nc bnc" id="L403" title="All 4 branches missed.">				} else if ((privateViewPairs != null) &amp;&amp; (privateViewPairs.size() &gt; 0)) {</span>
<span class="nc" id="L404">					viewID = (ID) ((KeyDisplayPair) ((ArrayList) privateViewPairs).get(0)).getKey();</span>
				}
<span class="nc" id="L406">			} else {</span>
<span class="nc" id="L407">				viewID = new ID(viewIDStr);</span>
			}
		}
<span class="nc" id="L410">		return viewID;</span>
	}

	/** Convert Methods **/

	/**
	 * Because this request handler also handles client requests sent as clear
	 * text. We need to convert text parameters into JAVA objects.
	 */
	protected void convertToDefaultIO(Map appletRequest, AppletIO io) {
<span class="nc bnc" id="L420" title="All 2 branches missed.">		if (io.equals(TextAppletIO.getInstance())) {</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">			if (isAppletAction(appletRequest, PulseKeys.GET_TRACE_DATA)) {</span>
				// get text from request
<span class="nc" id="L423">				String campId = (String) appletRequest.get(PulseKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L424">				String mediaId = (String) appletRequest.get(PulseKeys.MEDIA_ID);</span>
<span class="nc" id="L425">				String queueIds = (String) appletRequest.get(PulseKeys.QUEUE_IDS);</span>
<span class="nc" id="L426">				String viewId = (String) appletRequest.get(PulseKeys.VIEW_ID);</span>
<span class="nc" id="L427">				String startDate = (String) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L428">				String endDate = (String) appletRequest.get(PulseKeys.END_DATE);</span>
<span class="nc" id="L429">				String dataShouldBeEmpty = (String) appletRequest.get(PulseKeys.EMPTY_DATA);</span>
<span class="nc" id="L430">				String autoRefresh = (String) appletRequest.get(&quot;AUTO_REFRSH_REQ&quot;);</span>
				// put obj back in request
<span class="nc" id="L432">				appletRequest.put(PulseKeys.CAMPAIGN_ID, convertToID(campId));</span>
<span class="nc" id="L433">				appletRequest.put(PulseKeys.MEDIA_ID, convertToID(mediaId));</span>
<span class="nc" id="L434">				appletRequest.put(PulseKeys.QUEUE_IDS, convertToIDs(TextAppletIO.convertToCollection(queueIds)));</span>
<span class="nc" id="L435">				appletRequest.put(PulseKeys.VIEW_ID, convertToID(viewId));</span>
<span class="nc" id="L436">				appletRequest.put(PulseKeys.START_DATE, TextAppletIO.convertToDate(startDate));</span>
<span class="nc" id="L437">				appletRequest.put(PulseKeys.END_DATE, TextAppletIO.convertToDate(endDate));</span>
<span class="nc" id="L438">				appletRequest.put(PulseKeys.EMPTY_DATA, TextAppletIO.convertToBoolean(dataShouldBeEmpty));</span>
<span class="nc" id="L439">				appletRequest.put(&quot;AUTO_REFRSH_REQ&quot;, TextAppletIO.convertToBoolean(autoRefresh));</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_CUBE_MAPS)) {</span>
				// get text from request
<span class="nc" id="L442">				String campId = (String) appletRequest.get(PulseKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L443">				String mediaId = (String) appletRequest.get(PulseKeys.MEDIA_ID);</span>
<span class="nc" id="L444">				String queueIds = (String) appletRequest.get(PulseKeys.QUEUE_IDS);</span>
<span class="nc" id="L445">				String viewId = (String) appletRequest.get(PulseKeys.VIEW_ID);</span>
<span class="nc" id="L446">				String startDate = (String) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L447">				String endDate = (String) appletRequest.get(PulseKeys.END_DATE);</span>

				// put obj back in request
<span class="nc" id="L450">				appletRequest.put(PulseKeys.CAMPAIGN_ID, convertToID(campId));</span>
<span class="nc" id="L451">				appletRequest.put(PulseKeys.MEDIA_ID, convertToID(mediaId));</span>
<span class="nc" id="L452">				appletRequest.put(PulseKeys.QUEUE_IDS, convertToIDs(TextAppletIO.convertToCollection(queueIds)));</span>
<span class="nc" id="L453">				appletRequest.put(PulseKeys.VIEW_ID, convertToID(viewId));</span>
<span class="nc" id="L454">				appletRequest.put(PulseKeys.START_DATE, TextAppletIO.convertToDate(startDate));</span>
<span class="nc" id="L455">				appletRequest.put(PulseKeys.END_DATE, TextAppletIO.convertToDate(endDate));</span>

<span class="nc bnc" id="L457" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_USER_VIEWS)) {</span>
				// no params - do nothing
<span class="nc bnc" id="L459" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_INVISIBLE_VIEWS)) {</span>
				// no params - do nothing
<span class="nc bnc" id="L461" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.CREATE_VIEW)) {</span>
				// get text from request
<span class="nc" id="L463">				String view = (String) appletRequest.get(PulseKeys.TRACKING_VIEW);</span>
				// put obj back in request
<span class="nc" id="L465">				appletRequest.put(PulseKeys.TRACKING_VIEW, convertToTrackingView(TextAppletIO.convertToHashMap(view)));</span>

<span class="nc bnc" id="L467" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.EDIT_VIEW)) {</span>
				// get text from request
<span class="nc" id="L469">				String view = (String) appletRequest.get(PulseKeys.TRACKING_VIEW);</span>
				// put obj back in request
<span class="nc" id="L471">				appletRequest.put(PulseKeys.TRACKING_VIEW, convertToTrackingView(TextAppletIO.convertToHashMap(view)));</span>

<span class="nc bnc" id="L473" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.DELETE_VIEW)) {</span>
				// get text from request
<span class="nc" id="L475">				String id = (String) appletRequest.get(PulseKeys.VIEW_ID);</span>
				// put obj back in request
<span class="nc" id="L477">				appletRequest.put(PulseKeys.VIEW_ID, convertToID(id));</span>

<span class="nc bnc" id="L479" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_TREND_CONFIG)) {</span>
				// get text from request
<span class="nc" id="L481">				String spId = (String) appletRequest.get(PulseKeys.SP_ID);</span>
				// put obj back in request
<span class="nc" id="L483">				appletRequest.put(PulseKeys.SP_ID, convertToID(spId));</span>

<span class="nc bnc" id="L485" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_TREND_CONFIG)) {</span>
				// get text from request
<span class="nc" id="L487">				String trendConfig = (String) appletRequest.get(PulseKeys.TREND_CONFIG);</span>

				// put obj back in request
<span class="nc" id="L490">				appletRequest.put(PulseKeys.TREND_CONFIG,</span>
<span class="nc" id="L491">						convertToTrendingConfig(TextAppletIO.convertToHashMap(trendConfig)));</span>

<span class="nc bnc" id="L493" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.REFORECAST)) {</span>
				// get text from request
				// no need to get desc - already converted
<span class="nc" id="L496">				String cubeMaps = (String) appletRequest.get(PulseKeys.CUBE_MAPS);</span>
<span class="nc" id="L497">				String spId = (String) appletRequest.get(PulseKeys.SP_ID);</span>

				// put obj back in request
<span class="nc" id="L500">				appletRequest.put(PulseKeys.CUBE_MAPS, convertToTraceCubeMap(cubeMaps, true));</span>
<span class="nc" id="L501">				appletRequest.put(PulseKeys.SP_ID, convertToID(spId));</span>

<span class="nc bnc" id="L503" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_HISTORY)) {</span>
				// get text from request
<span class="nc" id="L505">				String cubeMaps = (String) appletRequest.get(PulseKeys.CUBE_MAPS);</span>
				// put obj back in request
<span class="nc" id="L507">				appletRequest.put(PulseKeys.CUBE_MAPS, convertToTraceCubeMap(cubeMaps, false));</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_CAMPAIGN_SPS)) {</span>
				// get text from request
<span class="nc" id="L510">				String campId = (String) appletRequest.get(PulseKeys.CAMPAIGN_ID);</span>
				// put obj back in request
<span class="nc" id="L512">				appletRequest.put(PulseKeys.CAMPAIGN_ID, convertToID(campId));</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_AVAILABLE_QUEUES)) {</span>
				// get text from request
<span class="nc" id="L515">				String campId = (String) appletRequest.get(PulseKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L516">				String startDate = (String) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L517">				String endDate = (String) appletRequest.get(PulseKeys.END_DATE);</span>
				// put obj back in request
<span class="nc" id="L519">				appletRequest.put(PulseKeys.CAMPAIGN_ID, convertToID(campId));</span>
<span class="nc" id="L520">				appletRequest.put(PulseKeys.START_DATE, TextAppletIO.convertToDate(startDate));</span>
<span class="nc" id="L521">				appletRequest.put(PulseKeys.END_DATE, TextAppletIO.convertToDate(endDate));</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_CHUNKY_HISTORY)) {</span>
				// get text from request
<span class="nc" id="L524">				String traceChunks = (String) appletRequest.get(PulseKeys.TRACE_CHUNKS);</span>

				// put obj back in request
				// TextAppletIO.convertToCollection() converts a String into a
				// Collection of strings
				// convertToTraceChunks() converts a Collection of strings into
				// Collection of TraceChunk's
<span class="nc" id="L531">				appletRequest.put(PulseKeys.TRACE_CHUNKS,</span>
<span class="nc" id="L532">						convertToTraceChunks(TextAppletIO.convertToCollection(traceChunks)));</span>
<span class="nc" id="L533">			} else {</span>
<span class="nc" id="L534">				super.convertToDefaultIO(appletRequest, io);</span>
			}
		} else {
<span class="nc" id="L537">			super.convertToDefaultIO(appletRequest, io);</span>
		}
<span class="nc" id="L539">	}</span>

	private ID convertToID(String id) {
<span class="nc bnc" id="L542" title="All 4 branches missed.">		if (id == null || id.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L543">			return null;</span>
		else
<span class="nc" id="L545">			return new ID(id);</span>
	}

	private Collection convertToIDs(Collection c) {
<span class="nc" id="L549">		Collection ret = new ArrayList(c.size());</span>

<span class="nc bnc" id="L551" title="All 2 branches missed.">		for (Iterator iter = c.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L552">			String item = (String) iter.next();</span>
<span class="nc" id="L553">			ret.add(convertToID((item)));</span>
<span class="nc" id="L554">		}</span>
<span class="nc" id="L555">		return ret;</span>
	}

	private TrackingView convertToTrackingView(HashMap view) {
<span class="nc bnc" id="L559" title="All 2 branches missed.">		if (view != null) {</span>
			// id
<span class="nc" id="L561">			String id_txt = (String) view.get(PulseKeys.VIEW_ID);</span>
<span class="nc" id="L562">			ID id = convertToID(id_txt);</span>

			// userId
<span class="nc" id="L565">			String userId_txt = (String) view.get(PulseKeys.VIEW_USERID);</span>
<span class="nc" id="L566">			ID userId = convertToID(userId_txt);</span>

			// empId
<span class="nc" id="L569">			String empId_txt = (String) view.get(PulseKeys.VIEW_EMPID);</span>
<span class="nc" id="L570">			ID empId = convertToID(empId_txt);</span>

			// view name
<span class="nc" id="L573">			String viewName = (String) view.get(PulseKeys.VIEW_NAME);</span>

			// description
<span class="nc" id="L576">			String desc = (String) view.get(PulseKeys.VIEW_DESC);</span>

			// trending
<span class="nc" id="L579">			String trend_txt = (String) view.get(PulseKeys.VIEW_TREND);</span>
<span class="nc" id="L580">			boolean trend = TextAppletIO.convertToBoolean(trend_txt).booleanValue();</span>

			// hoo
<span class="nc" id="L583">			String hoo_txt = (String) view.get(PulseKeys.VIEW_HOO);</span>
<span class="nc" id="L584">			boolean hoo = TextAppletIO.convertToBoolean(hoo_txt).booleanValue();</span>

			// global
<span class="nc" id="L587">			String global_txt = (String) view.get(PulseKeys.VIEW_TREND);</span>
<span class="nc" id="L588">			boolean global = TextAppletIO.convertToBoolean(global_txt).booleanValue();</span>

			// deviation view
<span class="nc" id="L591">			String dview_txt = (String) view.get(PulseKeys.VIEW_DEV);</span>
<span class="nc" id="L592">			boolean dview = TextAppletIO.convertToBoolean(dview_txt).booleanValue();</span>

			// chart def
<span class="nc" id="L595">			String chartDef_txt = (String) view.get(PulseKeys.VIEW_CHARTDEF);</span>
<span class="nc" id="L596">			List chartDef = (List) TextAppletIO.convertToCollection(chartDef_txt);</span>

<span class="nc" id="L598">			TrackingView tview = new TrackingView();</span>
<span class="nc" id="L599">			tview.setID(id);</span>
<span class="nc" id="L600">			tview.setUserID(userId);</span>
<span class="nc" id="L601">			tview.setEmployeeID(empId);</span>
<span class="nc" id="L602">			tview.setViewName(viewName);</span>
<span class="nc" id="L603">			tview.setDescription(desc);</span>
<span class="nc" id="L604">			tview.setTrending(trend);</span>
<span class="nc" id="L605">			tview.setHOO(hoo);</span>
<span class="nc" id="L606">			tview.setGlobalView(global);</span>
<span class="nc" id="L607">			tview.setDeviationView(dview);</span>
<span class="nc" id="L608">			tview.setChartDefinition(chartDef);</span>

		}
<span class="nc" id="L611">		return null;</span>
	}

	private Date[] convertToDateArray(String datearray) {
<span class="nc bnc" id="L615" title="All 2 branches missed.">		if (datearray.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L616">			return new Date[0];</span>
		else {
<span class="nc" id="L618">			StringTokenizer st = new StringTokenizer(datearray, PulseKeys.NEXT_COL);</span>
<span class="nc" id="L619">			ArrayList c = new ArrayList(st.countTokens());</span>

<span class="nc bnc" id="L621" title="All 2 branches missed.">			while (st.hasMoreTokens()) {</span>
<span class="nc" id="L622">				String token = st.nextToken();</span>
<span class="nc" id="L623">				c.add(TextAppletIO.convertToDate(token));</span>
<span class="nc" id="L624">			}</span>

<span class="nc" id="L626">			Date[] ret = new Date[c.size()];</span>
<span class="nc" id="L627">			ret = (Date[]) c.toArray(ret);</span>
<span class="nc" id="L628">			return ret;</span>
		}
	}

	private Date[][] convertToDateDoubleArray(String dateDoubleArray) {
<span class="nc bnc" id="L633" title="All 2 branches missed.">		if (dateDoubleArray.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L634">			return new Date[0][0];</span>
		else {
<span class="nc" id="L636">			StringTokenizer st = new StringTokenizer(dateDoubleArray, PulseKeys.NEXT_ROW);</span>
<span class="nc" id="L637">			ArrayList c = new ArrayList(st.countTokens());</span>

<span class="nc bnc" id="L639" title="All 2 branches missed.">			while (st.hasMoreTokens()) {</span>
<span class="nc" id="L640">				String token = st.nextToken();</span>
<span class="nc" id="L641">				c.add(convertToDateArray(token));</span>
<span class="nc" id="L642">			}</span>

<span class="nc" id="L644">			Date[][] ret = new Date[c.size()][];</span>
<span class="nc" id="L645">			ret = (Date[][]) c.toArray(ret);</span>
<span class="nc" id="L646">			return ret;</span>
		}
	}

	private TrendingConfig convertToTrendingConfig(HashMap config) {
<span class="nc bnc" id="L651" title="All 2 branches missed.">		if (config != null) {</span>
			// id
<span class="nc" id="L653">			String id_txt = (String) config.get(PulseKeys.TREND_CONFIG_ID);</span>
<span class="nc" id="L654">			ID id = convertToID(id_txt);</span>

			// userId
<span class="nc" id="L657">			String userId_txt = (String) config.get(PulseKeys.TREND_CONFIG_USERID);</span>
<span class="nc" id="L658">			ID userId = convertToID(userId_txt);</span>

			// empId
<span class="nc" id="L661">			String spId_txt = (String) config.get(PulseKeys.TREND_CONFIG_SPID);</span>
<span class="nc" id="L662">			ID spId = convertToID(spId_txt);</span>

			// trending rate
<span class="nc" id="L665">			String rate_txt = (String) config.get(PulseKeys.TREND_CONFIG_TRENDING_RATE);</span>
<span class="nc" id="L666">			short rate = ((Integer) TextAppletIO.convertToInteger(rate_txt)).shortValue();</span>

			// window type
<span class="nc" id="L669">			String type_txt = (String) config.get(PulseKeys.TREND_CONFIG_WINDOW_TYPE);</span>
<span class="nc" id="L670">			short type = ((Integer) TextAppletIO.convertToInteger(type_txt)).shortValue();</span>

			// window offset
<span class="nc" id="L673">			String offset_txt = (String) config.get(PulseKeys.TREND_CONFIG_WINDOW_OFFSET);</span>
<span class="nc" id="L674">			int offset = ((Integer) TextAppletIO.convertToInteger(offset_txt)).intValue();</span>

			// exclusion to start
<span class="nc" id="L677">			String exToStart_txt = (String) config.get(PulseKeys.TREND_CONFIG_EXCLUSION_TO_START);</span>
<span class="nc" id="L678">			Date[] exToStart = convertToDateArray(exToStart_txt);</span>

			// exculsion window
<span class="nc" id="L681">			String exWindow_txt = (String) config.get(PulseKeys.TREND_CONFIG_EXCLUSION_WINDOW);</span>
<span class="nc" id="L682">			Date[][] exWindow = convertToDateDoubleArray(exWindow_txt);</span>

<span class="nc" id="L684">			TrendingConfig tc = new TrendingConfig();</span>
<span class="nc" id="L685">			tc.setID(id);</span>
<span class="nc" id="L686">			tc.setUserID(userId);</span>
<span class="nc" id="L687">			tc.setSPID(spId);</span>
<span class="nc" id="L688">			tc.setTrendingRate(rate);</span>
<span class="nc" id="L689">			tc.setApplyWindowType(type);</span>
<span class="nc" id="L690">			tc.setApplyWindowOffset(offset);</span>
<span class="nc" id="L691">			tc.setExclusionToStart(exToStart[0], exToStart[1]);</span>
<span class="nc" id="L692">			tc.setExclusionWindow(exWindow);</span>
<span class="nc" id="L693">			return tc;</span>
		}
<span class="nc" id="L695">		return null;</span>
	}

	private short[] convertToShortArray(String shortarray) {
<span class="nc bnc" id="L699" title="All 2 branches missed.">		if (shortarray.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L700">			return new short[0];</span>
		else {
<span class="nc" id="L702">			StringTokenizer st = new StringTokenizer(shortarray, PulseKeys.NEXT_COL);</span>
<span class="nc" id="L703">			ArrayList c = new ArrayList(st.countTokens());</span>

<span class="nc bnc" id="L705" title="All 2 branches missed.">			while (st.hasMoreTokens()) {</span>
<span class="nc" id="L706">				String token = st.nextToken();</span>
<span class="nc" id="L707">				c.add(TextAppletIO.convertToInteger(token));</span>
<span class="nc" id="L708">			}</span>

<span class="nc" id="L710">			Integer[] tmp = new Integer[c.size()];</span>
<span class="nc" id="L711">			tmp = (Integer[]) c.toArray(tmp);</span>
<span class="nc" id="L712">			short[] ret = new short[tmp.length];</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">			for (int i = 0; i &lt; tmp.length; i++) {</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">				if (tmp[i] != null) {</span>
<span class="nc" id="L715">					ret[i] = tmp[i].shortValue();</span>
				}
			}

<span class="nc" id="L719">			return ret;</span>
		}
	}

	private boolean[] convertToBooleanArray(String booleanarray) {
<span class="nc bnc" id="L724" title="All 2 branches missed.">		if (booleanarray.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L725">			return new boolean[0];</span>
		else {
<span class="nc" id="L727">			StringTokenizer st = new StringTokenizer(booleanarray, PulseKeys.NEXT_COL);</span>
<span class="nc" id="L728">			ArrayList c = new ArrayList(st.countTokens());</span>

<span class="nc bnc" id="L730" title="All 2 branches missed.">			while (st.hasMoreTokens()) {</span>
<span class="nc" id="L731">				String token = st.nextToken();</span>
<span class="nc" id="L732">				c.add(TextAppletIO.convertToBoolean(token));</span>
<span class="nc" id="L733">			}</span>

<span class="nc" id="L735">			Boolean[] tmp = new Boolean[c.size()];</span>
<span class="nc" id="L736">			tmp = (Boolean[]) c.toArray(tmp);</span>
<span class="nc" id="L737">			boolean[] ret = new boolean[tmp.length];</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">			for (int i = 0; i &lt; tmp.length; i++) {</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">				if (tmp[i] != null) {</span>
<span class="nc" id="L740">					ret[i] = tmp[i].booleanValue();</span>
				}
			}

<span class="nc" id="L744">			return ret;</span>
		}
	}

	private int[] convertToIntArray(String intarray) {
<span class="nc bnc" id="L749" title="All 2 branches missed.">		if (intarray.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L750">			return new int[0];</span>
		else {
<span class="nc" id="L752">			StringTokenizer st = new StringTokenizer(intarray, PulseKeys.NEXT_COL);</span>
<span class="nc" id="L753">			ArrayList c = new ArrayList(st.countTokens());</span>

<span class="nc bnc" id="L755" title="All 2 branches missed.">			while (st.hasMoreTokens()) {</span>
<span class="nc" id="L756">				String token = st.nextToken();</span>
<span class="nc" id="L757">				c.add(TextAppletIO.convertToInteger(token));</span>
<span class="nc" id="L758">			}</span>

<span class="nc" id="L760">			Integer[] tmp = new Integer[c.size()];</span>
<span class="nc" id="L761">			tmp = (Integer[]) c.toArray(tmp);</span>
<span class="nc" id="L762">			int[] ret = new int[tmp.length];</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">			for (int i = 0; i &lt; tmp.length; i++) {</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">				if (tmp[i] != null) {</span>
<span class="nc" id="L765">					ret[i] = tmp[i].shortValue();</span>
				}
			}

<span class="nc" id="L769">			return ret;</span>
		}
	}

	private int[][] convertToIntDoubleArray(String intDoubleArray) {
<span class="nc bnc" id="L774" title="All 2 branches missed.">		if (intDoubleArray.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L775">			return new int[0][0];</span>
		else {
<span class="nc" id="L777">			StringTokenizer st = new StringTokenizer(intDoubleArray, PulseKeys.NEXT_ROW);</span>
<span class="nc" id="L778">			ArrayList c = new ArrayList(st.countTokens());</span>

<span class="nc bnc" id="L780" title="All 2 branches missed.">			while (st.hasMoreTokens()) {</span>
<span class="nc" id="L781">				String token = st.nextToken();</span>
<span class="nc" id="L782">				c.add(convertToIntArray(token));</span>
<span class="nc" id="L783">			}</span>

<span class="nc" id="L785">			int[][] ret = new int[c.size()][];</span>
<span class="nc" id="L786">			ret = (int[][]) c.toArray(ret);</span>
<span class="nc" id="L787">			return ret;</span>
		}
	}

	private TraceCube convertToTraceCube(HashMap cube) {
<span class="nc bnc" id="L792" title="All 2 branches missed.">		if (cube != null) {</span>
			// type
<span class="nc" id="L794">			String type = (String) cube.get(PulseKeys.TRACE_CUBE_TYPE);</span>

			// queue id
<span class="nc" id="L797">			String queueId_txt = (String) cube.get(PulseKeys.TRACE_CUBE_QUEUE_ID);</span>
<span class="nc" id="L798">			ID queueId = convertToID(queueId_txt);</span>

			// rawStartDate
<span class="nc" id="L801">			String rawStartDate_txt = (String) cube.get(PulseKeys.TRACE_CUBE_START_DATE);</span>
<span class="nc" id="L802">			Date rawStartDate = TextAppletIO.convertToDate(rawStartDate_txt);</span>

			// rawStartDate
<span class="nc" id="L805">			String rawEndDate_txt = (String) cube.get(PulseKeys.TRACE_CUBE_END_DATE);</span>
<span class="nc" id="L806">			Date rawEndDate = TextAppletIO.convertToDate(rawEndDate_txt);</span>

			// trace types
<span class="nc" id="L809">			String traceTypes_txt = (String) cube.get(PulseKeys.TRACE_CUBE_TRACE_TYPES);</span>
<span class="nc" id="L810">			short[] traceTypes = convertToShortArray(traceTypes_txt);</span>

			// trace values
<span class="nc" id="L813">			String traceValues_txt = (String) cube.get(PulseKeys.TRACE_CUBE_VALUES);</span>
<span class="nc" id="L814">			int[][] traceValues = convertToIntDoubleArray(traceValues_txt);</span>

			// create tc
<span class="nc" id="L817">			TraceCube traceCube = null;</span>
			try {
<span class="nc bnc" id="L819" title="All 2 branches missed.">				if (type.equals(PulseKeys.ACTUAL_TRACECUBE)) {</span>
<span class="nc" id="L820">					traceCube = new ActualTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">				} else if (type.equals(PulseKeys.AGGR_FORECASTED_TRACECUBE)) {</span>
<span class="nc" id="L822">					traceCube = new AggrForecastedTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">				} else if (type.equals(PulseKeys.AGGR_REQUIRED_TRACECUBE)) {</span>
<span class="nc" id="L824">					traceCube = new AggrRequiredTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">				} else if (type.equals(PulseKeys.FORECASTED_TRACECUBE)) {</span>
<span class="nc" id="L826">					traceCube = new ForecastTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">				} else if (type.equals(PulseKeys.PREDICT_TRACECUBE)) {</span>
<span class="nc" id="L828">					traceCube = new PredictTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">				} else if (type.equals(PulseKeys.REQUIRED_TRACECUBE)) {</span>
<span class="nc" id="L830">					traceCube = new RequireTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">				} else if (type.equals(PulseKeys.SERVICEGOAL_TRACECUBE)) {</span>
<span class="nc" id="L832">					traceCube = new ServiceGoalTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
				}
<span class="nc" id="L834">			} catch (BbmTimeSeriesException e) {</span>
<span class="nc" id="L835">				e.printStackTrace();</span>
<span class="nc" id="L836">			}</span>

<span class="nc bnc" id="L838" title="All 2 branches missed.">			if (traceCube != null) {</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">				for (int i = 0; i &lt; traceTypes.length; i++) {</span>
<span class="nc" id="L840">					traceCube.setTraceValue(traceTypes[i], traceValues[i]);</span>
				}
			}
<span class="nc" id="L843">			return traceCube;</span>
		}
<span class="nc" id="L845">		return null;</span>
	}

	private HashMap convertToTraceCubeMap(String map, boolean forecast) {
<span class="nc" id="L849">		StringTokenizer st = new StringTokenizer(map, PulseKeys.NEXT_KEY);</span>
<span class="nc" id="L850">		HashMap ret = new HashMap();</span>

<span class="nc bnc" id="L852" title="All 2 branches missed.">		while (st.hasMoreTokens()) {</span>
<span class="nc" id="L853">			String token = st.nextToken();</span>
			// System.out.println (&quot;Token to convert to trace cube: &quot;+token);
<span class="nc" id="L855">			StringTokenizer element = new StringTokenizer(token, &quot;***&quot;);</span>
<span class="nc" id="L856">			String key = element.nextToken();</span>
<span class="nc" id="L857">			ID queueId = convertToID(key);</span>

<span class="nc" id="L859">			String val = element.nextToken();</span>
			// System.out.println (&quot;Val to convert to trace cube:  &quot;+val);

<span class="nc" id="L862">			TraceCube tc = convertToTraceCube(TextAppletIO.convertToHashMap(val));</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">			if (forecast)</span>
<span class="nc" id="L864">				ret.put(queueId, tc);</span>
			else {
<span class="nc" id="L866">				TraceCube[] tcs = new TraceCube[1];</span>
<span class="nc" id="L867">				tcs[0] = tc;</span>
<span class="nc" id="L868">				ret.put(queueId, tcs);</span>
			}
<span class="nc" id="L870">		}</span>
<span class="nc" id="L871">		return ret;</span>
	}

	private TraceChunk convertToTraceChunk(HashMap cube) {
<span class="nc bnc" id="L875" title="All 2 branches missed.">		if (cube != null) {</span>
			// queue id
<span class="nc" id="L877">			String queueId_txt = (String) cube.get(PulseKeys.TRACE_CUBE_QUEUE_ID);</span>
<span class="nc" id="L878">			ID queueId = convertToID(queueId_txt);</span>

			// rawStartDate
<span class="nc" id="L881">			String rawStartDate_txt = (String) cube.get(PulseKeys.TRACE_CUBE_START_DATE);</span>
<span class="nc" id="L882">			Date rawStartDate = TextAppletIO.convertToDate(rawStartDate_txt);</span>

			// trace types
<span class="nc" id="L885">			String traceTypes_txt = (String) cube.get(PulseKeys.TRACE_CUBE_TRACE_TYPES);</span>
<span class="nc" id="L886">			short[] traceTypes = convertToShortArray(traceTypes_txt);</span>

			// trace values
<span class="nc" id="L889">			String traceValues_txt = (String) cube.get(PulseKeys.TRACE_CUBE_VALUES);</span>
<span class="nc" id="L890">			int[] traceValues = convertToIntArray(traceValues_txt);</span>

			// create TraceChunk
<span class="nc" id="L893">			TraceChunk traceChunk = new TraceChunk(queueId, rawStartDate);</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">			if (traceChunk != null) {</span>
<span class="nc" id="L895">				traceChunk.setTraceValues(traceTypes, traceValues);</span>
			}
<span class="nc" id="L897">			return traceChunk;</span>
		}
<span class="nc" id="L899">		return null;</span>
	}

	/**
	 * Converts a Collection of strings into Collection of
	 * &lt;code&gt;TraceChunk&lt;/code&gt;'s
	 * 
	 * @param c
	 *            A Collection of &lt;code&gt;String&lt;/code&gt;'s, where each represents a
	 *            &lt;code&gt;TraceChunk&lt;/code&gt;.
	 * @return A Collection of &lt;code&gt;TraceChunk&lt;/code&gt;'s
	 */
	private Collection convertToTraceChunks(Collection c) {
<span class="nc" id="L912">		Collection ret = new ArrayList(c.size());</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">		for (Iterator iter = c.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L914">			String item = (String) iter.next();</span>
<span class="nc" id="L915">			ret.add(convertToTraceChunk(TextAppletIO.convertToHashMap(item)));</span>
<span class="nc" id="L916">		}</span>
<span class="nc" id="L917">		return ret;</span>
	}

	/** Request Methods **/

	private void getTraceData(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L923">		String campIDStr = context.getUserProperty(Caching.SELECTED_CAMPAIGN_ID);</span>
<span class="nc bnc" id="L924" title="All 4 branches missed.">		ID campID = (campIDStr == null || &quot;&quot;.equals(campIDStr)) ? null : new ID(campIDStr);</span>
<span class="nc" id="L925">		ID mediaID = (ID) appletRequest.get(PulseKeys.MEDIA_ID);</span>
<span class="nc" id="L926">		Collection queueIDs = (Collection) appletRequest.get(PulseKeys.QUEUE_IDS);</span>
<span class="nc" id="L927">		ID viewID = (ID) appletRequest.get(PulseKeys.VIEW_ID); // (viewID =</span>
																// null) ==&gt;
																// history view
<span class="nc" id="L930">		Date startDate = (Date) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L931">		Date endDate = (Date) appletRequest.get(PulseKeys.END_DATE);</span>
<span class="nc" id="L932">		Boolean emptyData = (Boolean) appletRequest.get(PulseKeys.EMPTY_DATA);</span>
<span class="nc" id="L933">		boolean bEmptyData = false;</span>
<span class="nc bnc" id="L934" title="All 4 branches missed.">		if (emptyData != null &amp;&amp; emptyData.booleanValue())</span>
<span class="nc" id="L935">			bEmptyData = true;</span>

<span class="nc" id="L937">		Boolean forceEmptyDataButUseRequestedDateRange = (Boolean) appletRequest</span>
<span class="nc" id="L938">				.get(&quot;forceEmptyDataButUseRequestedDateRange&quot;);</span>
<span class="nc" id="L939">		boolean bForceEmptyDataButUseRequestedDateRange = false;</span>
<span class="nc bnc" id="L940" title="All 4 branches missed.">		if (forceEmptyDataButUseRequestedDateRange != null &amp;&amp; forceEmptyDataButUseRequestedDateRange.booleanValue()) {</span>
<span class="nc" id="L941">			bForceEmptyDataButUseRequestedDateRange = true;</span>
<span class="nc" id="L942">			bEmptyData = true;</span>
		}

<span class="nc bnc" id="L945" title="All 2 branches missed.">		if (cat.isDebugEnabled()) {</span>
<span class="nc" id="L946">			StringBuffer sb = new StringBuffer(256);</span>

<span class="nc" id="L948">			sb.append(&quot;Pulse::getTraceData() called\n&quot;);</span>
<span class="nc" id="L949">			sb.append(&quot;campID=&quot; + campID + &quot;,&quot;);</span>
<span class="nc" id="L950">			sb.append(&quot;mediaID=&quot; + mediaID + &quot;,&quot;);</span>
<span class="nc" id="L951">			sb.append(&quot;queueIDs=[&quot;);</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">			if (queueIDs != null) {</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">				for (Iterator qIter = queueIDs.iterator(); qIter.hasNext();) {</span>
<span class="nc" id="L954">					sb.append(qIter.next() + &quot;,&quot;);</span>
				}
			}
<span class="nc" id="L957">			sb.append(&quot;],&quot;);</span>
<span class="nc" id="L958">			sb.append(&quot;viewID=&quot; + viewID + &quot;,&quot;);</span>
<span class="nc" id="L959">			sb.append(&quot;start=&quot; + startDate + &quot;,end=&quot; + endDate);</span>
<span class="nc" id="L960">			cat.debug(sb.toString());</span>
			// System.out.println(sb.toString());
		}

		try {
			// Get the last Campaign viewd by the logged-in user
<span class="nc bnc" id="L966" title="All 2 branches missed.">			Campaign campaign = (campID == null) ? null : PulseModelHandler.getCampaign(context, campID);</span>

			// Get View
<span class="nc" id="L969">			TrackingView view = PulseModelHandler.getTrackingView(context, viewID);</span>

			// bEmptyData means no queue is selected, such as when we're
			// switching to &quot;All Queues&quot; mode, or
			// when the chosen campaign has no queues, or when Pulse is
			// configured not to select a queue by default.
<span class="nc" id="L975">			boolean bPulseSelectionNoDefault = isPulseSelectionNoDefault(context, appletRequest, appletResponse, false)</span>
<span class="nc" id="L976">					.booleanValue();</span>
<span class="nc bnc" id="L977" title="All 8 branches missed.">			if (bEmptyData &amp;&amp; campID != null &amp;&amp; bPulseSelectionNoDefault &amp;&amp; !bForceEmptyDataButUseRequestedDateRange) {</span>
				// Since campID!=null, we are not in All Queues mode. In this
				// case, Pulse received no selectedID (which contains the
				// campaignID,
				// mediaID,and queueIDs information), and without the
				// campaignID, Pulse didn't know which SP to set its dates too,
				// hence Pulse
				// sends us the old date range (from the previously selected
				// campaign). We need to get our date range in synch with the
				// selection
				// pane, which automatically sets it to the most current SP
				// every time the user changes the campaign (see
				// QueueSelectionPM.preLoadData()).
				// Fortunately, it stores the dates in the RequestContext, so we
				// can get them here.
<span class="nc" id="L992">				startDate = QueueFilterUtil.retrieveTimePeriodStart(context);</span>
<span class="nc" id="L993">				endDate = QueueFilterUtil.retrieveTimePeriodEnd(context);</span>
			}

			// Get SP
<span class="nc" id="L997">			ID spID = null;</span>
<span class="nc bnc" id="L998" title="All 2 branches missed.">			if (campID != null) {</span>
<span class="nc" id="L999">				spID = PulseModelHandler.getSPID(context, campID, startDate, endDate);</span>
			}

<span class="nc bnc" id="L1002" title="All 2 branches missed.">			SchedulingPeriod sp = (spID == null) ? null : PulseModelHandler.getSP(context, spID);</span>

			// Get TrendingConfig
<span class="nc" id="L1005">			TrendingConfig trendConfig = null;</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">			if (!bEmptyData)</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">				trendConfig = (spID == null) ? null : PulseModelHandler.getTrendingConfig(context, spID);</span>

			// Get Dates
<span class="nc bnc" id="L1010" title="All 6 branches missed.">			if (spID != null &amp;&amp; startDate == null &amp;&amp; endDate == null) {</span>
<span class="nc" id="L1011">				RangeValuePair pair = PulseModelHandler.getSPDates(context, spID);</span>
<span class="nc" id="L1012">				startDate = (Date) pair.getLowValue();</span>
<span class="nc" id="L1013">				endDate = (Date) pair.getHighValue();</span>
			}

			// We need to update the date range properties here rather
			// than in the applet in order to have correct queue selection pane
			// synchronization.
<span class="nc" id="L1019">			updateDateProperties(context, startDate, endDate, spID, campID);</span>

			// Get Available Queue ID's
<span class="nc" id="L1022">			Collection availableQueueIDs = null;</span>
<span class="nc bnc" id="L1023" title="All 4 branches missed.">			if (!bEmptyData || bPulseSelectionNoDefault)</span>
<span class="nc" id="L1024">				availableQueueIDs = PulseModelHandler.getAvailableQueueIDs(context, campID, startDate, endDate);</span>

			// If user chose a date in Campaign mode where there is no SP, then
			// data should be empty
<span class="nc bnc" id="L1028" title="All 6 branches missed.">			if ((campaign != null) &amp;&amp; ((availableQueueIDs == null) || availableQueueIDs.isEmpty())) {</span>
<span class="nc" id="L1029">				bEmptyData = true;</span>
			}

			// Get Queues
<span class="nc" id="L1033">			Collection originalQueues = null; // The queues selected by the user</span>
												// (null for the combined queue)
<span class="nc" id="L1035">			Collection resultQueues = null; // The queues to be displayed</span>
<span class="nc" id="L1036">			Boolean isCombined = Boolean.FALSE;</span>
<span class="nc" id="L1037">			Queue fatherQueue = null;</span>

<span class="nc bnc" id="L1039" title="All 2 branches missed.">			if (!bEmptyData) {</span>
<span class="nc bnc" id="L1040" title="All 4 branches missed.">				if (queueIDs == null || queueIDs.size() == 0) {</span>
					// If campaign only has 1 queue, we need to request that
					// queue rather than combined.
					// Even though the selection pane already has the single
					// queue selected by default, if the
					// page has first loaded, then the queue selection will
					// return null. This is due to a race
					// condition between the two frames.
<span class="nc bnc" id="L1048" title="All 6 branches missed.">					if ((campaign != null) &amp;&amp; (availableQueueIDs != null) &amp;&amp; (availableQueueIDs.size() == 1)) {</span>
<span class="nc" id="L1049">						queueIDs = availableQueueIDs;</span>
					} else {
<span class="nc" id="L1051">						isCombined = Boolean.TRUE;</span>
					}
<span class="nc bnc" id="L1053" title="All 4 branches missed.">				} else if ((campaign != null) &amp;&amp; (availableQueueIDs != null)</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">						&amp;&amp; (!availableQueueIDs.containsAll(queueIDs))) {</span>
					// We have requested queues which are not available for the
					// campaign under the specified dates.
					// This happens when user changes SP and the new SP has a
					// different set of queues than the old
					// SP. Pulse immediately requests trace data for the old
					// queue and the new dates. It also notifies
					// the queue selector that the SP has changed, so the queue
					// selector gets the new set of queues,
					// and refreshes the pulse pane, which then calls
					// getTraceData again, this time for the new queue.
					// We can prevent the reloading of the pulse pane by setting
					// queueIDs to the queues which we know
					// will be selected in the queue selection pane for this
					// date range (a subset of availableQueueIDs).
					/*
					 * queueIDs.retainAll(availableQueueIDs); if
					 * (queueIDs.size() == 0) { //If campaign only has 1 queue,
					 * we need to request that queue rather than combined. if
					 * (availableQueueIDs.size() == 1) { queueIDs =
					 * availableQueueIDs; } else { isCombined = Boolean.TRUE; }
					 * }
					 * 
					 * //Also, since our queues have changed from what was
					 * requested, we'll need to recalculate mediaID mediaID =
					 * null;
					 */

					// Bug: If page is dirty and user changes campaign, the
					// queue selector first loads the new campaign
					// queues rather than pop-up the confirmation alert first.
					// So if user clicks cancel in pop-up dialog,
					// the left pane is still on the new campaign/queues. This
					// causes an inconsistency with the workpane,
					// which remains on the original selection. If we were to
					// perform the above code, user would see the
					// the wrong data on the right pane when going back to the
					// original campaign. It's better if we just
					// return empty data here. At least the user will realize
					// that something is wrong.
<span class="nc" id="L1094">					bEmptyData = true;</span>
				}

				// Set originalQueues, resultQueues, isCombined, and
				// fatherQueue.
<span class="nc bnc" id="L1099" title="All 4 branches missed.">				if (queueIDs != null &amp;&amp; queueIDs.size() &gt; 0) {</span>
<span class="nc" id="L1100">					originalQueues = PulseModelHandler.getQueuesByIDs(context, queueIDs);</span>
<span class="nc" id="L1101">					resultQueues = originalQueues;</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">					if (queueIDs.size() == 1) {</span>
<span class="nc bnc" id="L1103" title="All 2 branches missed.">						for (Iterator i = originalQueues.iterator(); i.hasNext();) {</span>
<span class="nc" id="L1104">							Queue q = (Queue) i.next();</span>
							// If queue is distributed and trending is enabled.
<span class="nc bnc" id="L1106" title="All 4 branches missed.">							if (q.getQueueType() == Queue.QUEUE_TYPE_DISTRIBUTED &amp;&amp; view.useTrending()) {</span>
<span class="nc" id="L1107">								isCombined = Boolean.TRUE;</span>
<span class="nc" id="L1108">								fatherQueue = q;</span>
<span class="nc" id="L1109">								break;</span>
							}
<span class="nc" id="L1111">						}</span>
					}
				}
			}

			// Get Media
<span class="nc" id="L1117">			Media media = null;</span>
<span class="nc bnc" id="L1118" title="All 4 branches missed.">			if (campID != null &amp;&amp; !bEmptyData) {</span>
<span class="nc" id="L1119">				media = getMedia(context, campID, mediaID, startDate, endDate, originalQueues);</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">				mediaID = (media == null) ? null : media.getID();</span>
			}

			// Get Cube Maps, which contain the QID's and TraceCube's
			HashMap cube_maps;
<span class="nc bnc" id="L1125" title="All 2 branches missed.">			if (bEmptyData)</span>
<span class="nc" id="L1126">				cube_maps = new HashMap();</span>
			else
<span class="nc" id="L1128">				cube_maps = PulseModelHandler.getCubeMaps(context, campID, mediaID, queueIDs, viewID, startDate,</span>
						endDate);

			// If there's HOO in the tracking view, get a collection of
			// TimePeriodImpl
			// which consists of a pair of start and end date of when the center
			// is CLOSED!
<span class="nc" id="L1135">			Collection campHoo = null;</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">			if (!bEmptyData) {</span>
<span class="nc bnc" id="L1137" title="All 4 branches missed.">				if (view.useHOO() &amp;&amp; campID != null)</span>
<span class="nc" id="L1138">					campHoo = PulseModelHandler.getCampaignHOO(campID, startDate, endDate);</span>
				else
<span class="nc" id="L1140">					campHoo = Collections.EMPTY_LIST;</span>

				// Make sure resultQueues only contains those queues which
				// actually map to some data
<span class="nc bnc" id="L1144" title="All 2 branches missed.">				if (isCombined.booleanValue()) {</span>
<span class="nc" id="L1145">					Set queueIdsInCubeSet = cube_maps.keySet();</span>
<span class="nc" id="L1146">					ArrayList queueIdsInCubeList = new ArrayList();</span>
<span class="nc" id="L1147">					Iterator it = queueIdsInCubeSet.iterator();</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">					while (it.hasNext()) {</span>
<span class="nc" id="L1149">						ID queueId = (ID) it.next();</span>
<span class="nc" id="L1150">						queueIdsInCubeList.add(queueId);</span>
<span class="nc" id="L1151">					}</span>
<span class="nc" id="L1152">					resultQueues = PulseModelHandler.getQueuesByIDs(context, queueIdsInCubeList);</span>
				}
			}

			// Store the results
<span class="nc" id="L1157">			HashMap resultMap = new HashMap(16);</span>
<span class="nc" id="L1158">			resultMap.put(PulseKeys.CAMPAIGN, campaign);</span>
<span class="nc" id="L1159">			resultMap.put(PulseKeys.MEDIA, media);</span>
<span class="nc" id="L1160">			resultMap.put(PulseKeys.QUEUES, resultQueues);</span>
<span class="nc" id="L1161">			resultMap.put(PulseKeys.TRACKING_VIEW, view);</span>
<span class="nc" id="L1162">			resultMap.put(PulseKeys.CUBE_MAPS, cube_maps);</span>
<span class="nc" id="L1163">			resultMap.put(PulseKeys.SP_ID, spID);</span>
<span class="nc" id="L1164">			resultMap.put(PulseKeys.SP, sp);</span>
<span class="nc" id="L1165">			resultMap.put(PulseKeys.TREND_CONFIG, trendConfig);</span>
<span class="nc" id="L1166">			resultMap.put(PulseKeys.AVAILABLE_QUEUE_IDS, availableQueueIDs);</span>
<span class="nc" id="L1167">			resultMap.put(PulseKeys.START_DATE, startDate);</span>
<span class="nc" id="L1168">			resultMap.put(PulseKeys.END_DATE, endDate);</span>
<span class="nc" id="L1169">			resultMap.put(PulseKeys.CURRENT_TIME, TraceUtil.snapDate(new Date()));</span>
<span class="nc" id="L1170">			resultMap.put(PulseKeys.COMBINED, isCombined);</span>
<span class="nc" id="L1171">			resultMap.put(PulseKeys.HOO, campHoo);</span>
<span class="nc" id="L1172">			resultMap.put(PulseKeys.FATHERQ, fatherQueue);</span>
			// resultMap.put(PulseKeys.ORIGINAL_QUEUES, originalQueues); //not
			// needed by the front end
<span class="nc" id="L1175">			resultMap.put(PulseKeys.IS_CAMPAIGN_DISTRIBUTED, isCampaignDistributed(campaign));</span>
<span class="nc" id="L1176">			resultMap.put(PulseKeys.HAS_CHILD_OF_VIRTUAL, hasChildOfVirtual(context, resultQueues));</span>
<span class="nc" id="L1177">			appletResponse.put(PulseKeys.DATA_MAP, resultMap);</span>

			// Error Handling
<span class="nc" id="L1180">			Queue badQueue = verifyQueueCampaignAssignments(context, resultQueues, startDate, endDate);</span>
<span class="nc bnc" id="L1181" title="All 2 branches missed.">			if (badQueue != null) {</span>
<span class="nc" id="L1182">				notifyInvlalidQueue(context, resultMap, badQueue.getName());</span>
			}

<span class="nc bnc" id="L1185" title="All 2 branches missed.">			if (isDebugMode(view))</span>
<span class="nc" id="L1186">				updateTimeZones();</span>

<span class="nc" id="L1188">		} catch (Exception ex) {</span>
<span class="nc" id="L1189">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1190">		}</span>
<span class="nc" id="L1191">	}</span>

	/**
	 * Medco has hundreds of queues, and each time Pulse loads, or user changes
	 * campaigns, Pulse automatically selects the combined queue, which takes a
	 * long time to get from the backend because it combines all of the queues
	 * together dynamically. To improve performance, we added a BPCONFIG setting
	 * which allows Medco to configure Pulse so that it does not select any
	 * queue by default when switching campaigns, (or when switching SP/date
	 * range when no queue had been previously selected). Once the user selects
	 * a queue, if he then changes the SP/date range and the new SP/date range
	 * includes the selected queue, then that queue continues to be selected.
	 * However, when switching campaigns, we always de-select any queues
	 * selection. This method tells us whether Pulse is configured to show no
	 * queue by default.
	 * 
	 * @return true if Pulse is configured to show no queue by default, false if
	 *         not, and null if error..
	 */
	private Boolean isPulseSelectionNoDefault(RequestContext context, Map appletRequest, Map appletResponse,
			boolean storeResult) {
<span class="nc" id="L1212">		Boolean isSetNoDefault = null;</span>
		try {
<span class="nc" id="L1214">			boolean isEnabled = BbmManagerFactory.getDBConfigManager().getBooleanValue(</span>
					ConfigKey.PULSE_DEFAULT_SELECT_NO_QUEUE);
<span class="nc" id="L1216">			isSetNoDefault = new Boolean(isEnabled);</span>
<span class="nc bnc" id="L1217" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L1218">				appletResponse.put(PulseKeys.PULSE_DEFAULT_SELECT_NO_QUEUE, isSetNoDefault);</span>
<span class="nc" id="L1219">		} catch (Exception ex) {</span>
<span class="nc" id="L1220">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1221">		}</span>
<span class="nc" id="L1222">		return isSetNoDefault;</span>
	}

	/**
	 * We will hide Adjusted Staffing by default in Pulse. But we have a
	 * BPCONFIG flag to show Adjusted Staffing (for debugging purposes).
	 * 
	 * @return true if Pulse is configured to show the Adjusted Staffing
	 *         statistic, false if not, and null if error..
	 */
	private Boolean isEnableAdjustedStaffingFromPulse(RequestContext context, Map appletRequest, Map appletResponse,
			boolean storeResult) {
<span class="nc" id="L1234">		Boolean isSetNoDefault = null;</span>
		try {
<span class="nc" id="L1236">			boolean isEnabled = BbmManagerFactory.getDBConfigManager().getBooleanValue(</span>
					ConfigKey.ENABLE_ADJUSTED_STAFFING_FROM_PULSE);
<span class="nc" id="L1238">			isSetNoDefault = new Boolean(isEnabled);</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L1240">				appletResponse.put(PulseKeys.ENABLE_ADJUSTED_STAFFING_FROM_PULSE, isSetNoDefault);</span>
<span class="nc" id="L1241">		} catch (Exception ex) {</span>
<span class="nc" id="L1242">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1243">		}</span>
<span class="nc" id="L1244">		return isSetNoDefault;</span>
	}

	/**
	 * If the user request has a view, and the view's name is &quot;GQ4DEBUG&quot;, then
	 * that means we should output debug information to the console window.
	 * 
	 * @param view
	 *            The TrackingView.
	 * @return true if we should output debug informatio to the appserver
	 *         console window, false otherwise.
	 */
	private boolean isDebugMode(TrackingView view) {
<span class="nc bnc" id="L1257" title="All 6 branches missed.">		return ((view != null) &amp;&amp; (view.getViewName() != null &amp;&amp; (view.getViewName().equals(&quot;GQ4DEBUG&quot;))));</span>
	}

	/**
	 * GQ TEST METHOD ONLY: This method was copied from
	 * com.bluepumpkin.ejb.am.rtaamanager.ejb.RTAAManagerEJB in order to debug
	 * the TIMEZONEAM table entries.
	 */
	public void updateTimeZones() {
<span class="nc" id="L1266">		String straTimeZoneIDs[] = { &quot;PST&quot; }; // TimeZone.getAvailableIDs();</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed.">		for (int n = 0; n &lt; straTimeZoneIDs.length; n++) {</span>
<span class="nc" id="L1268">			String strTimeZoneID = straTimeZoneIDs[n];</span>
<span class="nc" id="L1269">			TimeZone timeZone = TimeZone.getTimeZone(strTimeZoneID);</span>
<span class="nc" id="L1270">			Calendar calStart = Calendar.getInstance(timeZone);</span>
			// calStart.clear();
			// calStart.set(2007, 2, 11);
<span class="nc" id="L1273">			calStart.add(Calendar.YEAR, -4);</span>
<span class="nc" id="L1274">			calStart.set(calStart.get(Calendar.YEAR), calStart.get(Calendar.MONTH), calStart.get(Calendar.DATE), 0, 0,</span>
					0);
<span class="nc" id="L1276">			calStart.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L1277">			Calendar calEnd = (Calendar) calStart.clone();</span>
<span class="nc" id="L1278">			calEnd.add(Calendar.YEAR, 4 * 2); // 40 * 2</span>
<span class="nc" id="L1279">			int nBias = Integer.MAX_VALUE;</span>
<span class="nc" id="L1280">			Date dateLastBiasChange = null;</span>
<span class="nc" id="L1281">			Calendar cal = calStart;</span>
<span class="nc bnc" id="L1282" title="All 2 branches missed.">			for (; cal.before(calEnd); cal.add(Calendar.HOUR_OF_DAY, 1)) {</span>
<span class="nc" id="L1283">				Date date = cal.getTime();</span>
				int nCurrentBias;
<span class="nc bnc" id="L1285" title="All 2 branches missed.">				if (timeZone.inDaylightTime(date))</span>
<span class="nc" id="L1286">					nCurrentBias = cal.get(Calendar.ZONE_OFFSET) + cal.get(Calendar.DST_OFFSET);</span>
				else
<span class="nc" id="L1288">					nCurrentBias = cal.get(Calendar.ZONE_OFFSET);</span>
<span class="nc bnc" id="L1289" title="All 2 branches missed.">				if (nCurrentBias != nBias) {</span>
<span class="nc bnc" id="L1290" title="All 2 branches missed.">					if (dateLastBiasChange != null) {</span>
<span class="nc" id="L1291">						HashMap hm = new HashMap();</span>
<span class="nc" id="L1292">						hm.put(&quot;TIMEZONE&quot;, strTimeZoneID);</span>
<span class="nc" id="L1293">						hm.put(&quot;STARTTIME&quot;, formatDBString(new Timestamp(dateLastBiasChange.getTime())));</span>
<span class="nc" id="L1294">						hm.put(&quot;ENDTIME&quot;, formatDBString(new Timestamp(date.getTime())));</span>
<span class="nc" id="L1295">						hm.put(&quot;BIAS&quot;, new Integer(nBias / (1000 * 60)));</span>
<span class="nc" id="L1296">						System.out.println(&quot;STARTTIME=&quot; + hm.get(&quot;STARTTIME&quot;) + &quot;, ENDTIME=&quot; + hm.get(&quot;ENDTIME&quot;)</span>
<span class="nc" id="L1297">								+ &quot;, BIAS=&quot; + hm.get(&quot;BIAS&quot;));</span>
					}
<span class="nc" id="L1299">					nBias = nCurrentBias;</span>
<span class="nc" id="L1300">					dateLastBiasChange = date;</span>
				}
			}
<span class="nc bnc" id="L1303" title="All 2 branches missed.">			if (dateLastBiasChange != null) {</span>
<span class="nc" id="L1304">				Date date = cal.getTime();</span>
<span class="nc" id="L1305">				HashMap hm = new HashMap();</span>
<span class="nc" id="L1306">				hm.put(&quot;TIMEZONE&quot;, strTimeZoneID);</span>
<span class="nc" id="L1307">				hm.put(&quot;STARTTIME&quot;, formatDBString(new Timestamp(dateLastBiasChange.getTime())));</span>
<span class="nc" id="L1308">				hm.put(&quot;ENDTIME&quot;, formatDBString(new Timestamp(date.getTime())));</span>
<span class="nc" id="L1309">				hm.put(&quot;BIAS&quot;, new Integer(nBias / (1000 * 60)));</span>
<span class="nc" id="L1310">				System.out.println(&quot;STARTTIME=&quot; + hm.get(&quot;STARTTIME&quot;) + &quot;, ENDTIME=&quot; + hm.get(&quot;ENDTIME&quot;) + &quot;, BIAS=&quot;</span>
<span class="nc" id="L1311">						+ hm.get(&quot;BIAS&quot;));</span>
			}
		}
<span class="nc" id="L1314">	}</span>

	/**
	 * Format a Timestamp object to a persistable DBString
	 * 
	 * @param stamp
	 * @return
	 */
	public static String formatDBString(Timestamp stamp) {
<span class="nc" id="L1323">		Calendar cal = Calendar.getInstance(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L1324">		cal.setTime(stamp);</span>
<span class="nc" id="L1325">		int i = cal.get(Calendar.YEAR);</span>
<span class="nc" id="L1326">		int j = cal.get(Calendar.MONTH) + 1;</span>
<span class="nc" id="L1327">		int k = cal.get(Calendar.DATE);</span>
<span class="nc" id="L1328">		int l = cal.get(Calendar.HOUR_OF_DAY);</span>
<span class="nc" id="L1329">		int i1 = cal.get(Calendar.MINUTE);</span>
<span class="nc" id="L1330">		int j1 = cal.get(Calendar.SECOND);</span>

		// Usually it outputs 20010824 18:37:24.908 , 23 characters
		// In order to accomodate Oracle, we have to omit nanoseconds
		// StringBuffer s = new StringBuffer(25);
<span class="nc" id="L1335">		StringBuffer s = new StringBuffer(19);</span>
<span class="nc" id="L1336">		s.append(i);</span>

<span class="nc bnc" id="L1338" title="All 2 branches missed.">		if (j &lt; 10)</span>
<span class="nc" id="L1339">			s.append(&quot;0&quot;).append(j);</span>
		else
<span class="nc" id="L1341">			s.append(j);</span>

<span class="nc bnc" id="L1343" title="All 2 branches missed.">		if (k &lt; 10)</span>
<span class="nc" id="L1344">			s.append(&quot;0&quot;).append(k);</span>
		else
<span class="nc" id="L1346">			s.append(k);</span>
<span class="nc" id="L1347">		s.append(&quot; &quot;);</span>
<span class="nc bnc" id="L1348" title="All 2 branches missed.">		if (l &lt; 10)</span>
<span class="nc" id="L1349">			s.append(&quot;0&quot;).append(l);</span>
		else
<span class="nc" id="L1351">			s.append(l);</span>
<span class="nc" id="L1352">		s.append(&quot;:&quot;);</span>
<span class="nc bnc" id="L1353" title="All 2 branches missed.">		if (i1 &lt; 10)</span>
<span class="nc" id="L1354">			s.append(&quot;0&quot;).append(i1);</span>
		else
<span class="nc" id="L1356">			s.append(i1);</span>
<span class="nc" id="L1357">		s.append(&quot;:&quot;);</span>
<span class="nc bnc" id="L1358" title="All 2 branches missed.">		if (j1 &lt; 10)</span>
<span class="nc" id="L1359">			s.append(&quot;0&quot;).append(j1);</span>
		else
<span class="nc" id="L1361">			s.append(j1);</span>

<span class="nc" id="L1363">		return s.toString();</span>
	}

	/**
	 * I don't remember why, but we need to update the date range properties
	 * here rather than in the applet. It may have something to do with queue
	 * selection pane synchronization.
	 */
	private void updateDateProperties(RequestContext context, Date startDate, Date endDate, ID spID, ID campaignID) {
<span class="nc bnc" id="L1372" title="All 4 branches missed.">		if ((startDate != null) &amp;&amp; (endDate != null)) {</span>
<span class="nc" id="L1373">			Date oldStartDate = QueueFilterUtil.retrieveTimePeriodStart(context);</span>
<span class="nc" id="L1374">			Date oldEndDate = QueueFilterUtil.retrieveTimePeriodEnd(context);</span>

<span class="nc" id="L1376">			QueueFilterUtil.storeTimePeriodStart(context, startDate); // context.setUserProperty(QueueFilterUtil.QUEUE_FILTER_CAMP_START_DATE,</span>
																		// String.valueOf(startDate.getTime()));
<span class="nc" id="L1378">			QueueFilterUtil.storeTimePeriodEnd(context, endDate); // context.setUserProperty(QueueFilterUtil.QUEUE_FILTER_CAMP_END_DATE,</span>
																	// String.valueOf(endDate.getTime()));

<span class="nc bnc" id="L1381" title="All 6 branches missed.">			if (spID == null &amp;&amp; !sameDates(oldStartDate, startDate) || !sameDates(oldEndDate, endDate)) {</span>
				// If no SP is selected or no SP matches the date range, then we
				// need to force the selection
				// pane to use this date range rather than let it find the
				// closest SP, or use the last stored SP.
<span class="nc" id="L1386">				QueueFilterUtil.storeUseSavedDatesForOneTimeUse(context, true);</span>
			}
		}

<span class="nc bnc" id="L1390" title="All 2 branches missed.">		if (spID != null) {</span>
<span class="nc" id="L1391">			SelectionCacheUtil.setSchedulingPeriodID(context, spID); // QueueFilterUtil.storeSchedulingPeriodID(context,</span>
																		// spID);
<span class="nc" id="L1393">			CampaignSchedulingPeriodSelectionUtil.setSelectedAutoCachedCampaignSPID(context, campaignID, spID);</span>
			// context.setUserProperty(FsCaching.CALENDAR_VIEW_SCHEDULINGPERIOD_ID,
			// spID.toString(), true);
		}
<span class="nc" id="L1397">	}</span>

	private boolean sameDates(Date date1, Date date2) {
<span class="nc bnc" id="L1400" title="All 4 branches missed.">		if (date1 == null &amp;&amp; date2 != null)</span>
<span class="nc" id="L1401">			return false;</span>

<span class="nc bnc" id="L1403" title="All 4 branches missed.">		if (date2 == null &amp;&amp; date1 != null)</span>
<span class="nc" id="L1404">			return false;</span>

<span class="nc bnc" id="L1406" title="All 4 branches missed.">		if (date1 == null &amp;&amp; date2 == null)</span>
<span class="nc" id="L1407">			return true;</span>

<span class="nc" id="L1409">		return date1.equals(date2);</span>
	}

	/**
	 * Given a CampaignID, MediaID, and date range, return a collection of
	 * Queues.
	 * 
	 * @return A collection of Queues
	 * @throws Exception
	 */
	private void getQueuesAttachedToCampaignMedia(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L1421">			ID campID = (ID) appletRequest.get(PulseKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L1422">			ID mediaID = (ID) appletRequest.get(PulseKeys.MEDIA_ID);</span>
<span class="nc" id="L1423">			Date start = (Date) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L1424">			Date end = (Date) appletRequest.get(PulseKeys.END_DATE);</span>
<span class="nc" id="L1425">			Collection queues = PulseModelHandler</span>
<span class="nc" id="L1426">					.getQueuesAttachedToCampaignMedia(context, campID, mediaID, start, end);</span>
<span class="nc" id="L1427">			appletResponse.put(PulseKeys.QUEUES, queues);</span>
<span class="nc" id="L1428">		} catch (Exception ex) {</span>
<span class="nc" id="L1429">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1430">		}</span>
<span class="nc" id="L1431">	}</span>

	/**
	 * Determine which Media is selected.
	 * 
	 * @param context
	 * @param mediaID
	 *            If null, and there is only 1 media for campaign, we will get
	 *            it.
	 * @return The Media which should be assumed by Pulse.
	 */
	private Media getMedia(RequestContext context, ID campaignID, ID mediaID, Date start, Date end, Collection queues)
			throws Exception {
<span class="nc bnc" id="L1444" title="All 2 branches missed.">		if (mediaID == null) {</span>
<span class="nc bnc" id="L1445" title="All 4 branches missed.">			if ((queues == null) || (queues.isEmpty())) {</span>
				// We have a &quot;Combined&quot; queue, and since mediaID is null, that
				// means the page was just loaded.
				// We need to get all queues in order to determine if we should
				// use &quot;All Media&quot;, or a particular
				// media type.
<span class="nc" id="L1451">				queues = PulseModelHandler.getQueuesAttachedToCampaignMedia(context, campaignID, mediaID, start, end);</span>
			}

			// If the queues list only has a single Media type, then we will use
			// it.
			// If the queues list has more than one Media type, then mediaID
			// should remain null, which means &quot;All Media&quot;.
<span class="nc bnc" id="L1458" title="All 2 branches missed.">			if (queues != null) {</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">				for (Iterator qIt = queues.iterator(); qIt.hasNext();) {</span>
<span class="nc" id="L1460">					Queue q = (Queue) qIt.next();</span>
<span class="nc" id="L1461">					ID mID = q.getMediaID();</span>
<span class="nc bnc" id="L1462" title="All 2 branches missed.">					if (mID != null) {</span>
<span class="nc bnc" id="L1463" title="All 2 branches missed.">						if (mediaID == null) {</span>
<span class="nc" id="L1464">							mediaID = mID; // first one found</span>
						} else {
<span class="nc bnc" id="L1466" title="All 2 branches missed.">							if (!mediaID.equals(mID)) {</span>
								// System.out.println(&quot;\n\nPulseAppletRequestHandler.getMedia() returning: null&quot;);
<span class="nc" id="L1468">								return null; // we have two different mediaID's</span>
							}
						}
					}
<span class="nc" id="L1472">				}</span>
			}
		}
<span class="nc bnc" id="L1475" title="All 2 branches missed.">		if (mediaID != null) // do not use else if</span>
		{
			// System.out.println(&quot;\n\nPulseAppletRequestHandler.getMedia() returning: &quot;
			// + PulseModelHandler.getMedia(context, mediaID));
<span class="nc" id="L1479">			return PulseModelHandler.getMedia(context, mediaID);</span>
		}
		// System.out.println(&quot;\n\nPulseAppletRequestHandler.getMedia() returning: null&quot;);
<span class="nc" id="L1482">		return null;</span>
	}

	/**
	 * Get the cube maps for a set of queues. Usually, you will call
	 * getTraceData() to return everything you need at once, but this method is
	 * intended to be used when you need to get the trace data for queues not
	 * being displayed. For example, when Reforecasting combined queues for a
	 * Distributed campaign, you will need to reforecast each of the Distributed
	 * queues falling under &quot;Combined&quot;, but the trace data for these queues was
	 * not retireved from the initial getTraceData() call.
	 * 
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void getCubeMaps(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1499">		String campIDStr = context.getUserProperty(Caching.SELECTED_CAMPAIGN_ID);</span>
<span class="nc bnc" id="L1500" title="All 4 branches missed.">		ID campID = (campIDStr == null || &quot;&quot;.equals(campIDStr)) ? null : new ID(campIDStr);</span>
<span class="nc" id="L1501">		ID mediaID = (ID) appletRequest.get(PulseKeys.MEDIA_ID);</span>
<span class="nc" id="L1502">		Collection queueIDs = (Collection) appletRequest.get(PulseKeys.QUEUE_IDS);</span>
<span class="nc" id="L1503">		ID viewID = (ID) appletRequest.get(PulseKeys.VIEW_ID); // (viewID =</span>
																// null) ==&gt;
																// history view
<span class="nc" id="L1506">		Date startDate = (Date) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L1507">		Date endDate = (Date) appletRequest.get(PulseKeys.END_DATE);</span>

		try {
<span class="nc bnc" id="L1510" title="All 2 branches missed.">			Campaign campaign = (campID == null) ? null : PulseModelHandler.getCampaign(context, campID);</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">			if (campID != null) {</span>
<span class="nc bnc" id="L1512" title="All 2 branches missed.">				Collection queues = (queueIDs == null) ? null : PulseModelHandler.getQueuesByIDs(context, queueIDs);</span>
<span class="nc" id="L1513">				Media media = getMedia(context, campID, mediaID, startDate, endDate, queues);</span>
<span class="nc bnc" id="L1514" title="All 2 branches missed.">				mediaID = (media == null) ? null : media.getID();</span>
			}

<span class="nc" id="L1517">			TrackingView view = PulseModelHandler.getTrackingView(context, viewID);</span>
<span class="nc bnc" id="L1518" title="All 2 branches missed.">			ID spID = (campID == null) ? null : PulseModelHandler.getSPID(context, campID, startDate, endDate);</span>
<span class="nc bnc" id="L1519" title="All 2 branches missed.">			SchedulingPeriod sp = (spID == null) ? null : PulseModelHandler.getSP(context, spID);</span>
<span class="nc bnc" id="L1520" title="All 2 branches missed.">			TrendingConfig trendConfig = (spID == null) ? null : PulseModelHandler.getTrendingConfig(context, spID);</span>

<span class="nc bnc" id="L1522" title="All 6 branches missed.">			if (spID != null &amp;&amp; startDate == null &amp;&amp; endDate == null) {</span>
<span class="nc" id="L1523">				RangeValuePair pair = PulseModelHandler.getSPDates(context, spID);</span>
<span class="nc" id="L1524">				startDate = (Date) pair.getLowValue();</span>
<span class="nc" id="L1525">				endDate = (Date) pair.getHighValue();</span>
			}

<span class="nc" id="L1528">			HashMap cube_maps = PulseModelHandler.getCubeMaps(context, campID, mediaID, queueIDs, viewID, startDate,</span>
					endDate);

<span class="nc" id="L1531">			HashMap resultMap = new HashMap(16);</span>
<span class="nc" id="L1532">			resultMap.put(PulseKeys.CUBE_MAPS, cube_maps);</span>
<span class="nc" id="L1533">			appletResponse.put(PulseKeys.DATA_MAP, resultMap);</span>
<span class="nc" id="L1534">		} catch (Exception ex) {</span>
<span class="nc" id="L1535">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1536">		}</span>
<span class="nc" id="L1537">	}</span>

	/**
	 * Make sure each Queue is assigned to at most 1 Campaign during each SP in
	 * the date range.
	 * 
	 * @return The invalid Queue if queue is assigned to multiple Campaigns for
	 *         an SP in the date range, else null.
	 */
	private Queue verifyQueueCampaignAssignments(RequestContext context, Collection queues, Date startDate, Date endDate)
			throws Exception {
<span class="nc bnc" id="L1548" title="All 4 branches missed.">		if (queues != null &amp;&amp; queues.size() &gt; 0) {</span>
<span class="nc bnc" id="L1549" title="All 2 branches missed.">			for (Iterator i = queues.iterator(); i.hasNext();) {</span>
<span class="nc" id="L1550">				Queue q = (Queue) i.next();</span>
<span class="nc" id="L1551">				Collection qCamps = PulseModelHandler.getQueueCampaignAssignments(context, q.getID(), startDate,</span>
						endDate);
<span class="nc bnc" id="L1553" title="All 2 branches missed.">				if (qCamps.size() &gt; 1) {</span>
<span class="nc bnc" id="L1554" title="All 2 branches missed.">					for (Iterator qit1 = qCamps.iterator(); qit1.hasNext();) {</span>
<span class="nc" id="L1555">						CampaignQueue campQueue1 = (CampaignQueue) qit1.next();</span>

<span class="nc bnc" id="L1557" title="All 2 branches missed.">						for (Iterator qit2 = qCamps.iterator(); qit2.hasNext();) {</span>
<span class="nc" id="L1558">							CampaignQueue campQueue2 = (CampaignQueue) qit2.next();</span>
							// if different campaigns, and times overlap, we
							// have an invalid queue.
<span class="nc bnc" id="L1561" title="All 2 branches missed.">							if (!campQueue1.getCampaignID().equals(campQueue2.getCampaignID())) {</span>
								// if one SP starts exactly when another one
								// ends, that's ok. We only care about overlap.
<span class="nc bnc" id="L1564" title="All 2 branches missed.">								if (campQueue1.getEndTime().after(campQueue2.getStartTime())</span>
<span class="nc bnc" id="L1565" title="All 2 branches missed.">										&amp;&amp; campQueue2.getEndTime().after(campQueue1.getStartTime())) {</span>
<span class="nc" id="L1566">									return q;</span>
								}
							}
<span class="nc" id="L1569">						}</span>
<span class="nc" id="L1570">					}</span>
				}
<span class="nc" id="L1572">			}</span>
		}
<span class="nc" id="L1574">		return null;</span>
	}

	/**
	 * Determines if a campaign is a distributed campaign. We assume that if the
	 * given campaign has any sub-campaigns, then it is distributed. We will
	 * return false if the campaign is distributed, but no children have been
	 * added yet.
	 * 
	 * @param campaign
	 *            The campaign to check.
	 * @return true if the campaign is distributed, false otherwise.
	 */
	private Boolean isCampaignDistributed(Campaign campaign) {
<span class="nc bnc" id="L1588" title="All 2 branches missed.">		if (campaign == null)</span>
<span class="nc" id="L1589">			return Boolean.FALSE;</span>

<span class="nc" id="L1591">		return new Boolean(PulseModelHandler.isCampaignDistributed(campaign.getID()));</span>
	}

	/**
	 * Determines if a collection contains a queue which is the child of a
	 * virtual queue.
	 * 
	 * @param queues
	 *            A collection of &lt;code&gt;Queue&lt;/code&gt; objects.
	 * @return true if the collection contains a queue which is the child of a
	 *         virtual queue.
	 */
	private Boolean hasChildOfVirtual(RequestContext context, Collection queues) throws Exception {
<span class="nc bnc" id="L1604" title="All 4 branches missed.">		if ((queues == null) || (queues.size() == 0))</span>
<span class="nc" id="L1605">			return Boolean.FALSE;</span>

<span class="nc bnc" id="L1607" title="All 2 branches missed.">		for (Iterator it = queues.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1608">			Queue queue = (Queue) it.next();</span>
<span class="nc" id="L1609">			ID parentID = queue.getParentID();</span>
<span class="nc bnc" id="L1610" title="All 2 branches missed.">			if (parentID != null) {</span>
<span class="nc" id="L1611">				Queue parent = PulseModelHandler.getQueueByID(context, parentID);</span>
<span class="nc bnc" id="L1612" title="All 4 branches missed.">				if ((parent != null) &amp;&amp; (parent.getQueueType() == Queue.QUEUE_TYPE_VIRTUAL))</span>
<span class="nc" id="L1613">					return Boolean.TRUE;</span>
			}
<span class="nc" id="L1615">		}</span>
<span class="nc" id="L1616">		return Boolean.FALSE;</span>
	}

	/**
	 * Retrieves the list of user views
	 *
	 * PulseKeys.VIEWS_PUBLIC -- A Collection of KeyDisplayPair objects of (id,
	 * display strings) PulseKeys.VIEWS_PUBLIC_RO -- A Collection of
	 * KeyDisplayPair objects of (id, display strings) PulseKeys.VIEWS_PRIVATE
	 * -- A Collection of KeyDisplayPair objects of (id, display strings)
	 * 
	 * @param storeResult
	 *            Do you want to store the result in the response?
	 * @return A HashMap containing the 3 collections of views for the user.
	 */
	private HashMap getUserViews(RequestContext context, Map appletRequest, Map appletResponse, boolean storeResult) {
<span class="nc" id="L1632">		HashMap resultMap = new HashMap(4);</span>
		try {
<span class="nc" id="L1634">			Collection[] views = PulseModelHandler.getUserViews(context);</span>
<span class="nc" id="L1635">			resultMap.put(PulseKeys.VIEWS_PUBLIC, views[PulseModelHandler.VIEW_PUBLIC]);</span>
<span class="nc" id="L1636">			resultMap.put(PulseKeys.VIEWS_PUBLIC_RO, views[PulseModelHandler.VIEW_PUBLIC_RO]);</span>
<span class="nc" id="L1637">			resultMap.put(PulseKeys.VIEWS_PRIVATE, views[PulseModelHandler.VIEW_PRIVATE]);</span>

<span class="nc bnc" id="L1639" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L1640">				appletResponse.put(PulseKeys.DATA_MAP, resultMap);</span>
<span class="nc" id="L1641">		} catch (Exception ex) {</span>
<span class="nc" id="L1642">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1643">		}</span>
<span class="nc" id="L1644">		return resultMap;</span>
	}

	/**
	 * Get the list of all tracking view names which are not visible to the
	 * user.
	 * 
	 * @return A collection of other users' private view names, or null if
	 *         error.
	 */
	private void getInvisibleViewNames(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L1656">			Collection views = PulseModelHandler.getInvisibleViewNames(context);</span>
<span class="nc" id="L1657">			appletResponse.put(PulseKeys.VIEWS_INVISIBLE, views);</span>
<span class="nc" id="L1658">		} catch (Exception ex) {</span>
<span class="nc" id="L1659">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1660">		}</span>
<span class="nc" id="L1661">	}</span>

	/**
	 * Return the TrackingView requested.
	 * 
	 * @param context
	 * @param appletRequest
	 *            May contain the VIEW_ID.
	 * @param appletResponse
	 * @param viewID
	 *            If not null, will override the VIEW_ID from the appletRequest.
	 * @param storeResult
	 *            Do you want to store the result in the response?
	 * @return the view requested.
	 */
	private TrackingView getView(RequestContext context, Map appletRequest, Map appletResponse, ID viewID,
			boolean storeResult) {
<span class="nc bnc" id="L1678" title="All 2 branches missed.">		if (viewID == null)</span>
<span class="nc" id="L1679">			viewID = (ID) appletRequest.get(PulseKeys.VIEW_ID);</span>
<span class="nc" id="L1680">		TrackingView view = null;</span>
		try {
<span class="nc" id="L1682">			view = PulseModelHandler.getTrackingView(context, viewID);</span>
<span class="nc" id="L1683">			appletResponse.put(PulseKeys.TRACKING_VIEW, view);</span>
<span class="nc" id="L1684">		} catch (Exception ex) {</span>
<span class="nc" id="L1685">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1686">		}</span>
<span class="nc" id="L1687">		return view;</span>
	}

	// /**
	// * Retrieves a tracking view object, based on its ID.
	// */
	// private void getView(RequestContext context, Map appletRequest, Map
	// appletResponse){
	// boolean history =
	// ((Boolean)appletRequest.get(PulseKeys.HISTORY_VIEW)).booleanValue();
	// ID viewID = (ID)appletRequest.get(PulseKeys.VIEW_ID);

	// try {
	// TrackingView view = null;
	// if (history) {
	// view = PulseModelHandler.getHistoryView(context);
	// } else {
	// view = PulseModelHandler.getTrackingView(context, viewID);
	// }
	// appletResponse.put(PulseKeys.TRACKING_VIEW, view);
	// } catch (Exception ex) {
	// notifyError(context, appletResponse, ex);
	// }
	// }

	/**
	 * Creates a tracking view object.
	 */
	private void createView(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1716">		TrackingView view = (TrackingView) appletRequest.get(PulseKeys.TRACKING_VIEW);</span>

		try {
<span class="nc" id="L1719">			view.setUserID(context.getUser().getID());</span>
<span class="nc" id="L1720">			view = PulseModelHandler.createView(context, view);</span>
<span class="nc" id="L1721">			appletResponse.put(PulseKeys.TRACKING_VIEW, view);</span>
<span class="nc" id="L1722">		} catch (Exception ex) {</span>
<span class="nc" id="L1723">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1724">		}</span>
<span class="nc" id="L1725">	}</span>

	/**
	 * Creates a tracking view object.
	 */
	private void editView(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1731">		TrackingView view = (TrackingView) appletRequest.get(PulseKeys.TRACKING_VIEW);</span>

		try {
<span class="nc" id="L1734">			PulseModelHandler.editView(context, view);</span>
<span class="nc" id="L1735">		} catch (Exception ex) {</span>
<span class="nc" id="L1736">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1737">		}</span>
<span class="nc" id="L1738">	}</span>

	private void deleteView(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1741">		ID viewID = (ID) appletRequest.get(PulseKeys.VIEW_ID);</span>

		try {
<span class="nc" id="L1744">			PulseModelHandler.deleteView(context, viewID);</span>

<span class="nc" id="L1746">			TrackingView view = PulseModelHandler.getTrackingView(context, TrackingView.INVALID_VIEW_ID);</span>
<span class="nc" id="L1747">			appletResponse.put(PulseKeys.TRACKING_VIEW, view);</span>
<span class="nc" id="L1748">		} catch (Exception ex) {</span>
<span class="nc" id="L1749">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1750">		}</span>
<span class="nc" id="L1751">	}</span>

	private void getTrendConfig(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1754">		ID spID = (ID) appletRequest.get(PulseKeys.SP_ID);</span>

		try {
<span class="nc" id="L1757">			TrendingConfig config = PulseModelHandler.getTrendingConfig(context, spID);</span>
<span class="nc" id="L1758">			appletResponse.put(PulseKeys.TREND_CONFIG, config);</span>
<span class="nc" id="L1759">		} catch (Exception ex) {</span>
<span class="nc" id="L1760">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1761">		}</span>
<span class="nc" id="L1762">	}</span>

	/**
	 * Saves a trend config for a particular sp
	 */
	private void saveTrendConfig(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1768">		TrendingConfig config = (TrendingConfig) appletRequest.get(PulseKeys.TREND_CONFIG);</span>

		try {
<span class="nc" id="L1771">			config.setUserID(context.getUser().getID());</span>
<span class="nc" id="L1772">			config = PulseModelHandler.saveTrendConfig(context, config);</span>
<span class="nc" id="L1773">			appletResponse.put(PulseKeys.TREND_CONFIG, config);</span>
<span class="nc" id="L1774">		} catch (Exception ex) {</span>
<span class="nc" id="L1775">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1776">		}</span>

<span class="nc" id="L1778">	}</span>

	private void reForecast(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1781">		ID spID = (ID) appletRequest.get(PulseKeys.SP_ID);</span>
<span class="nc" id="L1782">		HashMap cubeMaps = (HashMap) appletRequest.get(PulseKeys.CUBE_MAPS);</span>
<span class="nc" id="L1783">		String desc = (String) appletRequest.get(PulseKeys.DESCRIPTION);</span>

		try {
<span class="nc" id="L1786">			ID forecastID = PulseModelHandler.reForecast(context, spID, cubeMaps, desc);</span>
<span class="nc" id="L1787">			appletResponse.put(PulseKeys.FORECAST_ID, forecastID);</span>
<span class="nc" id="L1788">		} catch (BbmCreateException ex) {</span>

<span class="nc bnc" id="L1790" title="All 2 branches missed.">			if (isDuplicateKeyException(ex)) {</span>
<span class="nc" id="L1791">				Message errorMessage = new Message(Message.WARNING_TYPE, FsWebBundleKey.FS_FORECAST_DUPLICATE_NAME,</span>
						FsWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1793">				context.addPageMessage(errorMessage);</span>
<span class="nc" id="L1794">				appletResponse.put(PulseKeys.FORECAST_ID, errorMessage.getLocalizedMessage(context.getLocalizer()));</span>
<span class="nc" id="L1795">			} else {</span>
<span class="nc" id="L1796">				notifyError(context, appletResponse, ex);</span>
			}

			// appletResponse.put(PulseKeys.FORECAST_ID, ex);
<span class="nc" id="L1800">		} catch (Exception ex) {</span>
<span class="nc" id="L1801">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1802">		}</span>
<span class="nc" id="L1803">	}</span>

	/**
	 * Cache the queue selection and the forecastID so that the Forecast
	 * Instances applet will be pre-selected with the appropriate queue(s) and
	 * forecast.
	 *
	 * @param selectedID
	 *            The selected ID's for the workpane. Format:
	 *            &quot;campaignSID;SPSID;MediaSID;QueueSID;true;2&quot; Example:
	 *            &quot;33;242;-1;97;true;2&quot;
	 * @param forecastID
	 *            The forecast instance ID.
	 *
	 * @return The forecastID if no error, or null if an error occurred.
	 */
	private void cacheIdsForReForecast(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1820">		String selectedID = (String) appletRequest.get(PulseKeys.SELECTED_ID);</span>
<span class="nc" id="L1821">		String forecastID = (String) appletRequest.get(PulseKeys.FORECAST_ID);</span>

		try {
<span class="nc bnc" id="L1824" title="All 4 branches missed.">			if (selectedID != null &amp;&amp; !selectedID.isEmpty()) {</span>
<span class="nc" id="L1825">				CacheUtil.setCachedValue(context, CacheUtil.CACHE_MODE_PROFILE, &quot;QUEUE_CAMPAIGN_SP_SELECTION_ID_KEY&quot;,</span>
						selectedID); // tbd
										// PageKeys.QUEUE_CAMPAIGN_SP_SELECTION_ID_KEY
			}

<span class="nc bnc" id="L1830" title="All 4 branches missed.">			if (forecastID != null &amp;&amp; !forecastID.isEmpty()) {</span>
<span class="nc" id="L1831">				context.setAttribute(RequestContext.ONE_TIME_USE_SESSION_SCOPE, &quot;FORECAST_PROFILE_ID_KEY&quot;, forecastID); // tbd</span>
																														// PageKeys.FORECAST_PROFILE_ID_KEY
			}
<span class="nc" id="L1834">		} catch (Exception ex) {</span>

<span class="nc" id="L1836">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1837">		}</span>
<span class="nc" id="L1838">	}</span>

	/**
	 * We return true if the BPException contains an exception of type
	 * JdmoDuplicateKeyException.
	 * 
	 * @param ex
	 *            A BPException, which can contain other exceptions.
	 * @return true if the exception contains an exception of type
	 *         JdmoDuplicateKeyException.
	 */
	private boolean isDuplicateKeyException(BPException ex) {
<span class="nc bnc" id="L1850" title="All 2 branches missed.">		if (ex.getNextException() != null) {</span>
<span class="nc" id="L1851">			BPException next = ex.getNextException();</span>
			do {
<span class="nc bnc" id="L1853" title="All 2 branches missed.">				if (ex.getNextException() instanceof JdmoDuplicateKeyException) {</span>
<span class="nc" id="L1854">					return true;</span>
				}
<span class="nc" id="L1856">				next = next.getNextException();</span>
<span class="nc bnc" id="L1857" title="All 2 branches missed.">			} while (next != null);</span>
		}
<span class="nc bnc" id="L1859" title="All 4 branches missed.">		if ((ex.getCoreException() != null) &amp;&amp; (ex.getCoreException() instanceof JdmoDuplicateKeyException)) {</span>
<span class="nc" id="L1860">			return true;</span>
		}
<span class="nc" id="L1862">		return false;</span>
	}

	private void saveHistory(RequestContext context, Map appletRequest, Map appletResponse) {
		// System.out.println(&quot;\nPulseAppletRequestHandler.saveHistory()&quot;);
<span class="nc" id="L1867">		HashMap cubeMap = (HashMap) appletRequest.get(PulseKeys.CUBE_MAPS);</span>

		try {
<span class="nc" id="L1870">			PulseModelHandler.saveHistory(context, cubeMap);</span>
<span class="nc" id="L1871">		} catch (Exception ex) {</span>
<span class="nc" id="L1872">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1873">		}</span>
<span class="nc" id="L1874">	}</span>

	private void saveChunkyHistory(RequestContext context, Map appletRequest, Map appletResponse) {
		// System.out.println(&quot;\nPulseAppletRequestHandler.saveChunkyHistory()&quot;);
<span class="nc" id="L1878">		Collection traceChunks = (Collection) appletRequest.get(PulseKeys.TRACE_CHUNKS);</span>
<span class="nc bnc" id="L1879" title="All 4 branches missed.">		if (traceChunks != null &amp;&amp; !traceChunks.isEmpty()) {</span>
			try {
<span class="nc" id="L1881">				PulseModelHandler.saveHistory(context, traceChunks);</span>
<span class="nc" id="L1882">			} catch (Exception ex) {</span>
<span class="nc" id="L1883">				notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1884">			}</span>
		}
<span class="nc" id="L1886">	}</span>

	private void exportPulse(RequestContext context, Map appletRequest, Map appletResponse) {
		// System.out.println(&quot;===exporting pulse====&quot;);
		try {
<span class="nc" id="L1891">			ExportTraceDescriptor desc = (ExportTraceDescriptor) appletRequest.get(PulseKeys.EXPORT_DESC);</span>
<span class="nc bnc" id="L1892" title="All 2 branches missed.">			if (desc != null) {</span>
				// TrackingUtil util = new TrackingUtil();
				// String export =
				// util.exportTraceToString((ExportTraceDescriptor)key);
				// TEMP!!! use backend utility to get converted cube from the
				// desc
<span class="nc" id="L1898">				appletResponse.put(PulseKeys.GET_EXPORT_PULSE, &quot;this is a test for export&quot;);</span>
			}
<span class="nc" id="L1900">		} catch (Exception ex) {</span>
<span class="nc" id="L1901">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1902">		}</span>
<span class="nc" id="L1903">	}</span>

	private void getSchedulingPeriods(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1906">		String campIDStr = context.getUserProperty(Caching.SELECTED_CAMPAIGN_ID);</span>
<span class="nc bnc" id="L1907" title="All 4 branches missed.">		ID campID = (campIDStr == null || &quot;&quot;.equals(campIDStr)) ? null : new ID(campIDStr);</span>
		try {
<span class="nc" id="L1909">			Collection spCol = PulseModelHandler.getSchedulingPeriods(context, campID);</span>
<span class="nc" id="L1910">			appletResponse.put(PulseKeys.CAMPAIGN_SPS, spCol);</span>
<span class="nc" id="L1911">		} catch (Exception ex) {</span>
<span class="nc" id="L1912">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1913">		}</span>
<span class="nc" id="L1914">	}</span>

	/**
	 * Returns a collection of available &lt;code&gt;Queue&lt;/code&gt;'s in a campaign Puts
	 * in the response: A collection of available &lt;code&gt;Queue&lt;/code&gt;'s in a
	 * campaign for the date range specified.
	 * 
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void getAvailableQueues(RequestContext context, Map appletRequest, Map appletResponse) {
		// System.out.println(&quot;in PulseAppletRequestHandler.getAvailableQueues...&quot;);

		// we can't get campID from context when importing various data from
		// text file
<span class="nc" id="L1930">		ID campID = (ID) appletRequest.get(PulseKeys.CAMPAIGN_ID);</span>

<span class="nc" id="L1932">		Date startDate = (Date) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L1933">		Date endDate = (Date) appletRequest.get(PulseKeys.END_DATE);</span>
		try {
<span class="nc" id="L1935">			Collection qCol = PulseModelHandler.getAvailableQueues(context, campID, startDate, endDate);</span>
<span class="nc" id="L1936">			appletResponse.put(PulseKeys.AVAILABLE_QUEUES, qCol);</span>
<span class="nc" id="L1937">		} catch (Exception ex) {</span>
<span class="nc" id="L1938">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1939">		}</span>
<span class="nc" id="L1940">	}</span>

	/**
	 * Returns a collection of all &lt;code&gt;Queue&lt;/code&gt;'s in the system.
	 * 
	 * @param storeResult
	 *            Do you want to store the result in the response?
	 * @return A collection of all &lt;code&gt;Queue&lt;/code&gt;'s in the system.
	 */
	private Collection getAllQueues(RequestContext context, Map appletResponse, boolean storeResult) {
<span class="nc" id="L1950">		Collection qCol = null;</span>
		try {
<span class="nc" id="L1952">			qCol = PulseModelHandler.getAllQueues(context);</span>
<span class="nc bnc" id="L1953" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L1954">				appletResponse.put(PulseKeys.ALL_QUEUES, qCol);</span>
<span class="nc" id="L1955">		} catch (Exception ex) {</span>
<span class="nc" id="L1956">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1957">		}</span>
<span class="nc" id="L1958">		return qCol;</span>
	}

	/**
	 * Returns a collection of all &lt;code&gt;Queue&lt;/code&gt;'s assigned to all
	 * campaigns that the user is scoped for.
	 * 
	 * @return a collection of all &lt;code&gt;Queue&lt;/code&gt;'s assigned to all
	 *         campaigns that the user is scoped for.
	 */
	private Collection getScopedQueues(RequestContext context, Map appletResponse, boolean storeResult) {
<span class="nc" id="L1969">		Collection qCol = null;</span>
		try {
<span class="nc" id="L1971">			qCol = PulseModelHandler.getScopedQueues(context);</span>
<span class="nc bnc" id="L1972" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L1973">				appletResponse.put(PulseKeys.SCOPED_QUEUES, qCol);</span>
<span class="nc" id="L1974">		} catch (Exception ex) {</span>
<span class="nc" id="L1975">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1976">		}</span>
<span class="nc" id="L1977">		return qCol;</span>
	}

	/**
	 * QA100924
	 * 
	 * @return a collection of all editable &lt;code&gt;Queue&lt;/code&gt;'s assigned to all
	 *         campaigns that the user is scoped for.
	 */
	private Collection getEditableQueues(RequestContext context, Map appletResponse, boolean storeResult) {
<span class="nc" id="L1987">		Collection qCol = null;</span>
		try {
<span class="nc" id="L1989">			qCol = PulseModelHandler.getEditableQueues(context, false);</span>
<span class="nc bnc" id="L1990" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L1991">				appletResponse.put(PulseKeys.SCOPED_QUEUES, qCol);</span>
<span class="nc" id="L1992">		} catch (Exception ex) {</span>
<span class="nc" id="L1993">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1994">		}</span>
<span class="nc" id="L1995">		return qCol;</span>
	}

	private void notifyInvlalidQueue(RequestContext context, HashMap resultMap, String queueName) {
<span class="nc" id="L1999">		Message m = new Message(Message.INFO_TYPE, FsWebBundleKey.FS_INVALID_TARGET_QUEUE_CAMPAIGNS,</span>
				FsWebBundleKey.BUNDLE_NAME, new String[] { queueName });

<span class="nc" id="L2002">		cat.l7dInfo(FsWebBundleKey.UNABLE_TO_LOAD_DATA, new Exception(m.getLocalizedMessage(context.getLocalizer())));</span>
<span class="nc" id="L2003">		context.addPageMessage(m);</span>

<span class="nc" id="L2005">		resultMap.put(PageKeys.APPLET_ERROR, m.getLocalizedMessage(context.getLocalizer()));</span>
<span class="nc" id="L2006">	}</span>

	private void notifyError(RequestContext context, Map appletResponse, Exception ex) {
<span class="nc" id="L2009">		cat.l7dError(FsWebBundleKey.UNABLE_TO_LOAD_DATA, ex);</span>
<span class="nc" id="L2010">		context.addPageMessage(new Message(Message.ERROR_TYPE, FsWebBundleKey.UNABLE_TO_LOAD_DATA,</span>
				FsWebBundleKey.BUNDLE_NAME));
<span class="nc" id="L2012">		notifyClientOfError(appletResponse);</span>
<span class="nc" id="L2013">	}</span>

	// //////////////////////////////BEGIN PULSE NOTES CODE ///////////////

	/**
	 * Get the notes for a set of queues in a given time period
	 * 
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void getPulseNotes(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L2025">		Collection queueIDs = (Collection) appletRequest.get(PulseKeys.QUEUE_IDS);</span>
<span class="nc" id="L2026">		Date startDate = (Date) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L2027">		Date endDate = (Date) appletRequest.get(PulseKeys.END_DATE);</span>

		try {
<span class="nc" id="L2030">			Collection notes = PulseModelHandler.getPulseNotes(context, queueIDs, startDate, endDate);</span>
			// HashMap resultMap = new HashMap(16);
			// resultMap.put(PulseKeys.PULSE_NOTES, notes);
<span class="nc" id="L2033">			appletResponse.put(PulseKeys.PULSE_NOTES, notes);</span>
<span class="nc" id="L2034">		} catch (Exception ex) {</span>
<span class="nc" id="L2035">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2036">		}</span>
<span class="nc" id="L2037">	}</span>

	/**
	 * save of noes: this will be later seperated into add, update and deleted
	 * notes
	 * 
	 * @param context
	 * @param notes
	 * @throws Exception
	 */
	private void savePulseNotes(RequestContext context, Map appletRequest, Map appletResponse) {
		// save the notes
<span class="nc" id="L2049">		Collection notes = (Collection) appletRequest.get(PulseKeys.PULSE_NOTES);</span>

		try {
<span class="nc" id="L2052">			PulseModelHandler.savePulseNotes(context, notes);</span>
<span class="nc" id="L2053">		} catch (Exception ex) {</span>
<span class="nc" id="L2054">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2055">		}</span>
<span class="nc" id="L2056">	}</span>

	/**
	 * add pulse notes
	 * 
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void addPulseNotes(RequestContext context, Map appletRequest, Map appletResponse) {
		// get the notes to add
<span class="nc" id="L2067">		Collection notes = (Collection) appletRequest.get(PulseKeys.PULSE_NOTES);</span>

		try {
<span class="nc" id="L2070">			PulseModelHandler.addPulseNotes(context, notes);</span>
<span class="nc" id="L2071">		} catch (Exception ex) {</span>
<span class="nc" id="L2072">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2073">		}</span>
<span class="nc" id="L2074">	}</span>

	/**
	 * update pulse notes
	 * 
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void updatePulseNotes(RequestContext context, Map appletRequest, Map appletResponse) {
		// get the notes to update
<span class="nc" id="L2085">		Collection notes = (Collection) appletRequest.get(PulseKeys.PULSE_NOTES);</span>

		try {
<span class="nc" id="L2088">			PulseModelHandler.updatePulseNotes(context, notes);</span>
<span class="nc" id="L2089">		} catch (Exception ex) {</span>
<span class="nc" id="L2090">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2091">		}</span>
<span class="nc" id="L2092">	}</span>

	/**
	 * delete pulse notes
	 * 
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void deletePulseNotes(RequestContext context, Map appletRequest, Map appletResponse) {
		// get the notes to delete
<span class="nc" id="L2103">		Collection notes = (Collection) appletRequest.get(PulseKeys.PULSE_NOTES);</span>

		try {
<span class="nc" id="L2106">			PulseModelHandler.deletePulseNotes(context, notes);</span>
<span class="nc" id="L2107">		} catch (Exception ex) {</span>
<span class="nc" id="L2108">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2109">		}</span>
<span class="nc" id="L2110">	}</span>

	/**
	 * Tells us whether or not the application is licensed to view Pulse Notes
	 * Exclude In Forecast
	 * 
	 * @param storeResult
	 *            Do you want to store the result in the response?
	 * @return true if PulseNotesExcludeInForecast license is present, false if
	 *         not, and null if error.
	 */
	private Boolean checkPulseNotesExcludeInForecastLicense(RequestContext context, Map appletRequest,
			Map appletResponse, boolean storeResult) {
<span class="nc" id="L2123">		Boolean hasLicense = null;</span>
		try {
			// String licenseKey =
			// LicenseKeys.APP_PULSE_NOTES_EXCLUDE_IN_FORECAST;
			// hasLicense = new
			// Boolean(CoreManagerFactory.getLicenseManager().isLicensed(licenseKey));
<span class="nc" id="L2129">			hasLicense = Boolean.TRUE;</span>
<span class="nc bnc" id="L2130" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L2131">				appletResponse.put(PulseKeys.HAS_PULSE_NOTES_EXCLUDE_IN_FORECAST_LICENSE, hasLicense);</span>
<span class="nc" id="L2132">		} catch (Exception ex) {</span>
<span class="nc" id="L2133">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2134">		}</span>
<span class="nc" id="L2135">		return hasLicense;</span>
	}

	// ////////////////////////////END PULSE NOTES CODE ///////////////////

	protected CampaignManager getCampaignManager(RequestContext context, Map appletResponse, Locale locale) {
<span class="nc bnc" id="L2141" title="All 2 branches missed.">		if (m_campaignManager == null) {</span>
			try {
<span class="nc" id="L2143">				m_campaignManager = WfmManagerFactory.getCampaignManager(context.isInWhatIfMode());</span>
<span class="nc" id="L2144">			} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L2145">				appletResponse.put(</span>
						PageKeys.APPLET_ERROR,
						&quot;BbmEJBCreateException caught trying to create CampaignManager.  &quot;
<span class="nc" id="L2148">								+ e.getLocalizedMessage(locale));</span>
<span class="nc" id="L2149">			}</span>
		}
<span class="nc" id="L2151">		return m_campaignManager;</span>
	}

	protected FacadeCorbaFacadeManager getFacadeCorbaFacadeManager(Map appletResponse, Locale locale) {
<span class="nc bnc" id="L2155" title="All 2 branches missed.">		if (m_facadeCorbaFacadeManager == null) {</span>
			try {
<span class="nc" id="L2157">				m_facadeCorbaFacadeManager = FacadeManagerFactory.getFacadeCorbaFacadeManager();</span>
<span class="nc" id="L2158">			} catch (FacadeEJBCreateException e) {</span>
<span class="nc" id="L2159">				appletResponse.put(PageKeys.APPLET_ERROR,</span>
						&quot;BbmManagerFactory caught trying to create FacadeCorbaFacadeManager.  &quot; /*
																								 * +
																								 * e
																								 * .
																								 * getLocalizedMessage
																								 * (
																								 * locale
																								 * )
																								 */);
<span class="nc" id="L2169">			}</span>
		}
<span class="nc" id="L2171">		return m_facadeCorbaFacadeManager;</span>
	}

	protected UserManager getUserManager(RequestContext context, Map appletResponse, Locale locale) {
<span class="nc bnc" id="L2175" title="All 2 branches missed.">		if (m_userManager == null) {</span>
			try {
<span class="nc" id="L2177">				m_userManager = CoreManagerFactory.getUserManager(context.isInWhatIfMode());</span>
<span class="nc" id="L2178">			} catch (CoreEJBCreateException e) {</span>
<span class="nc" id="L2179">				appletResponse.put(</span>
						PageKeys.APPLET_ERROR,
						&quot;BbmEJBCreateException caught trying to create ActivityManager.  &quot;
<span class="nc" id="L2182">								+ e.getLocalizedMessage(locale));</span>
<span class="nc" id="L2183">			}</span>
		}
<span class="nc" id="L2185">		return m_userManager;</span>
	}

	/**
	 * Tells us whether or not the application is licensed to view Outbound
	 * media types (Connects, CRRate, Dials, etc).
	 * 
	 * @param storeResult
	 *            Do you want to store the result in the response?
	 * @return true if outbound license is present, false if not, and null if
	 *         error.
	 */
	private Boolean checkOutboundLicense(RequestContext context, Map appletRequest, Map appletResponse,
			boolean storeResult) {
<span class="nc" id="L2199">		Boolean hasLicense = null;</span>
		try {
<span class="nc" id="L2201">			String licenseKey = LicenseKeys.APP_MEDIA_OUTBOUND;</span>
<span class="nc" id="L2202">			hasLicense = new Boolean(CoreManagerFactory.getLicenseManager().isLicensed(licenseKey));</span>
<span class="nc bnc" id="L2203" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L2204">				appletResponse.put(PulseKeys.HAS_OUTBOUND_LICENSE, hasLicense);</span>
<span class="nc" id="L2205">		} catch (Exception ex) {</span>
<span class="nc" id="L2206">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2207">		}</span>
<span class="nc" id="L2208">		return hasLicense;</span>
	}

	/**
	 * Tells us whether or not the application is enabled to launch F&amp;S Client
	 * from the Pulase applet (in its Reforecast dialog). This depends on
	 * whether the BPCONFIG table's 'EnableFSLaunchFromPulse' value is 'true' or
	 * not.
	 * 
	 * @return true if the &quot;Save and Launch F&amp;S&quot; button in Pulse's Reforecast
	 *         dialog can be enabled, false if not, and null if error.
	 */
	private Boolean checkCanLaunchFS(RequestContext context, Map appletRequest, Map appletResponse, boolean storeResult) {
<span class="nc" id="L2221">		Boolean result = null;</span>
		try {
<span class="nc" id="L2223">			boolean bCanLaunchFSBoolean = true;</span>
<span class="nc" id="L2224">			String sCanLaunchFS = BbmManagerFactory.getDBConfigManager()</span>
<span class="nc" id="L2225">					.getValue(ConfigKey.ENABLE_FS_LAUNCH_FROM_PULSE);</span>
<span class="nc bnc" id="L2226" title="All 4 branches missed.">			if (sCanLaunchFS != null &amp;&amp; sCanLaunchFS.equals(&quot;false&quot;))</span>
<span class="nc" id="L2227">				bCanLaunchFSBoolean = false;</span>

<span class="nc" id="L2229">			result = new Boolean(bCanLaunchFSBoolean);</span>
<span class="nc bnc" id="L2230" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L2231">				appletResponse.put(PulseKeys.CHECK_CAN_LAUNCH_FS, result);</span>
<span class="nc" id="L2232">		} catch (Exception ex) {</span>
<span class="nc" id="L2233">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2234">		}</span>
<span class="nc" id="L2235">		return result;</span>
	}

	/**
	 * Gets all of the verticalized strings needed by Pulse.
	 * 
	 * @param storeResult
	 *            Do you want to store the result in the response?
	 * @return A HashMap of PulseKey -&gt; VerticalizedString. The PulseKey keys
	 *         identify keys in the PulseKeys class, while the
	 *         VerticalizedString values are the verticalized/localized strings.
	 */
	private HashMap getVerticalizedStrings(RequestContext context, Map appletRequest, Map appletResponse,
			boolean storeResult) {
<span class="nc" id="L2249">		HashMap resultMap = new HashMap(10);</span>
		try {
<span class="nc" id="L2251">			VerticalizationManager vm = context.getSystemManagerFactory().getVerticalizationManager();</span>

<span class="nc" id="L2253">			resultMap.put(PulseKeys.QUEUE, vm.getVerticalizedString(context, VerticalizationWebBundleKey.BUNDLE_NAME,</span>
					DefaultVerticalizationManager.QUEUE));
<span class="nc" id="L2255">			resultMap.put(PulseKeys.QUEUES, vm.getVerticalizedString(context, VerticalizationWebBundleKey.BUNDLE_NAME,</span>
					DefaultVerticalizationManager.QUEUES));
<span class="nc" id="L2257">			resultMap.put(PulseKeys.QUEUESMALL, vm.getVerticalizedString(context,</span>
					VerticalizationWebBundleKey.BUNDLE_NAME, DefaultVerticalizationManager.QUEUESMALL));
<span class="nc" id="L2259">			resultMap.put(PulseKeys.QUEUESSMALL, vm.getVerticalizedString(context,</span>
					VerticalizationWebBundleKey.BUNDLE_NAME, DefaultVerticalizationManager.QUEUESSMALL));
<span class="nc" id="L2261">			resultMap.put(PulseKeys.CONTACTVOLUME, vm.getVerticalizedString(context,</span>
					VerticalizationWebBundleKey.BUNDLE_NAME, DefaultVerticalizationManager.CONTACTVOLUME));
<span class="nc" id="L2263">			resultMap.put(PulseKeys.AVERAGEHANDLETIME, vm.getVerticalizedString(context,</span>
					VerticalizationWebBundleKey.BUNDLE_NAME, DefaultVerticalizationManager.AVERAGEHANDLETIME));

<span class="nc" id="L2266">			resultMap.put(PulseKeys.CAMPAIGN, vm.getVerticalizedString(context,</span>
					VerticalizationWebBundleKey.BUNDLE_NAME, VerticalizationWebBundleKey.CAMPAIGN));

<span class="nc" id="L2269">			resultMap.put(PulseKeys.FULL_TIME_EQUIVALENTS, vm.getVerticalizedString(context,</span>
					VerticalizationWebBundleKey.BUNDLE_NAME, VerticalizationWebBundleKey.FULL_TIME_EQUIVALENTS));

<span class="nc" id="L2272">			resultMap.put(PulseKeys.AFTE, vm.getVerticalizedString(context, VerticalizationWebBundleKey.BUNDLE_NAME,</span>
					VerticalizationWebBundleKey.AFTE));

<span class="nc bnc" id="L2275" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L2276">				appletResponse.put(PulseKeys.GET_VERTICALIZED_STRINGS, resultMap);</span>
<span class="nc" id="L2277">		} catch (Exception ex) {</span>
<span class="nc" id="L2278">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2279">		}</span>
<span class="nc" id="L2280">		return resultMap;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>