<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GroupSchedulePM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.schedule.group</a> &gt; <span class="el_source">GroupSchedulePM.java</span></div><h1>GroupSchedulePM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.schedule.group;

import java.util.ArrayList;
import java.util.Calendar;
import com.bluepumpkin.common.datatypes.LocalDate;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.TimeZone;
import java.util.HashSet;
import com.bluepumpkin.common.datatypes.CalendarRange;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.IDStringPair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.DateTimeUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.people.filter.PeopleFilterBoxPC;
import com.bluepumpkin.web.bbm.people.groupselector.GroupSelectorPC;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.schedule.ScheduleViewMH;
import com.bluepumpkin.web.fs.schedule.ScheduleViewPM;
import com.bluepumpkin.web.fs.schedule.ScheduleViewUtil;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.contenttitle.ContentTitlePC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.js.JSUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import java.rmi.RemoteException;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;

/**
 * Title: GroupSchedulePM Description: Base class for Group Schedule viewing
 * pages. Copyright: Copyright (c) 2002 Company: Blue Pumpkin Software, inc
 * 
 * @author Chris King, Pavel Bosin
 * @version 1.0
 * 
 *          METHOD FLOW:
 * 
 *          Constructor() extractParameters() setSortBy() is called when
 *          changing sort selection or when Paginating, but not when refreshing
 *          suite initializeModel() loadData() loadAndInitData getWorkpaneData()
 *          initContentTitle() makeSortSelector()
 */

public abstract class GroupSchedulePM extends ScheduleViewPM {
	private static final String SORT_BY_FN = &quot;sortBy&quot;;
	private static final String IS_SORT_RECORD_FN = &quot;isSortRecord&quot;;

	protected static final String JS_REFRESH_WITH_SORT = &quot;DOM2.getElementById('&quot; + IS_SORT_RECORD_FN
			+ &quot;').value = true;&quot; + JSUtil.REFRESH_IGNORE_CHANGES;

	public static final String SORT_BY_FNAME = &quot;fname&quot;;
	public static final String SORT_BY_LNAME = &quot;lname&quot;;
	public static final String SORT_BY_START = &quot;start&quot;;
	public static final String SORT_BY_END = &quot;end&quot;;
	public static final String SORT_BY_LENGTH = &quot;length&quot;;

<span class="fc" id="L76">	protected String m_sortBy = SORT_BY_LNAME;</span>

	/**
	 * Do the employee ID's need to be sorted? (This will be true when user
	 * changes sort selection).
	 */
<span class="fc" id="L82">	protected boolean m_isSortRecord = false;</span>

<span class="fc" id="L84">	protected GroupSelectorPC m_groupSelectorPC = null;</span>

	/**
	 * Constructor
	 */
	public GroupSchedulePM(RequestContext context, String formAction, String viewType, boolean isDualListUsed) {
<span class="fc" id="L90">		super(context, formAction, viewType, isDualListUsed);</span>

<span class="fc" id="L92">		m_groupSelectorPC = new GroupSelectorPC(context, m_toolbar);</span>
<span class="fc" id="L93">		addChildComponent(m_groupSelectorPC);</span>

<span class="fc" id="L95">		setDefaultPageIDSize(20);</span>

<span class="fc" id="L97">		m_isFullPageMode = true; // default</span>
<span class="fc" id="L98">	}// constructor</span>

	/**
	 * Initialize Model with Data
	 */
	protected void initializeModel() {
<span class="fc bfc" id="L104" title="All 2 branches covered.">		if (m_isInitialized) {</span>
<span class="fc" id="L105">			return;</span>
		}

<span class="fc" id="L108">		adjustModelTypeFromScreenDef();</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">		m_isFullPageMode = (BASIC_MODEL == getPageModelType());</span>

		// adjust form Action based on Page Mode
<span class="fc" id="L112">		m_formAction = adjustFormActionForMode(m_formAction);</span>

<span class="fc" id="L114">		addGenericHTML(HtmlUtil.makeHiddenInput(IS_SORT_RECORD_FN, &quot;false&quot;));</span>
<span class="fc" id="L115">		super.initializeModel();</span>
<span class="fc" id="L116">	}</span>

	protected String adjustFormActionForMode(String formAction) {
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">		return (m_isFullPageMode ? &quot;mygroup&quot; : &quot;people&quot;) + formAction;</span>
	}

	protected void loadAndInitData() {
		try {
<span class="fc" id="L124">			initDayRange();</span>

<span class="pc bpc" id="L126" title="1 of 2 branches missed.">			HashMap theData = m_isFullPageMode ? getFullPageData() : getWorkpaneData();</span>

<span class="pc bpc" id="L128" title="1 of 2 branches missed.">			if (theData == null) {</span>
<span class="nc" id="L129">				this.addPageMessage(Message.ERROR_TYPE, FsWebBundleKey.EMP_NO_ORG, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L130">				return;</span>
			}

			// Make sure Time Range is not null - Use Value specified from MH
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">			if (m_timeRange == null) {</span>
<span class="nc" id="L135">				refreshTimeRangeFromSession();</span>
			}

<span class="pc bpc" id="L138" title="1 of 2 branches missed.">			if (isAuthToViewGroupSchedule(theData)) {</span>
				// create the list of schedules
<span class="fc" id="L140">				populateList(theData);</span>
			}

<span class="fc" id="L143">			initLegend(theData);</span>
<span class="fc" id="L144">			initPagination(theData);</span>
<span class="fc" id="L145">			initGroup(theData);</span>
<span class="nc" id="L146">		} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L147">			Message msg = handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L148">			msg.setAssociatedMessage(ex.getLocalizedMessage(m_localizer, m_context.getViewingTimeZone()));</span>
<span class="nc" id="L149">			ex.printStackTrace();</span>
<span class="nc" id="L150">		} catch (Exception ex) {</span>
<span class="nc" id="L151">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L152">			ex.printStackTrace();</span>
<span class="pc" id="L153">		}</span>
<span class="fc" id="L154">	}// loadAndInitData</span>

	/**
	 * Determine whether to Fetch Data from Employee IDs. If the ID's need
	 * sorting, then we return false.
	 */
	private boolean isFetchDataFromEmpIDs(Collection ids) {
<span class="pc bpc" id="L161" title="1 of 4 branches missed.">		return !ids.isEmpty() &amp;&amp; !m_isSortRecord;</span>
	}

	/**
	 * return JavaScript for Drop Down Refresh
	 */
	protected String getDropDownRefreshJS() {
<span class="fc" id="L168">		return JS_REFRESH_WITH_SORT;</span>
	}

	/**
	 * Get Data for Full Page (agent screen)
	 */
	protected HashMap getFullPageData() throws Exception {
		HashMap theData;
<span class="nc" id="L176">		ID orgID = m_groupSelectorPC.getOrgID();</span>
<span class="nc" id="L177">		ID campaignID = m_groupSelectorPC.getCampaignID();</span>
<span class="nc" id="L178">		Collection employeeIDs = getPageIDs();</span>
<span class="nc" id="L179">		TimeRange oDayRange = null; // QC79134</span>
<span class="nc" id="L180">		Date fromDate = new Date();</span>
<span class="nc" id="L181">		Date toDate = new Date();</span>
		// QA100526 Adding -1 and +1 day range to cover the crossing events
<span class="nc bnc" id="L183" title="All 2 branches missed.">		if (this instanceof GroupTextSchedulePM) {</span>
<span class="nc" id="L184">			oDayRange = (TimeRange) m_dayRange.clone();// QC79134</span>
<span class="nc" id="L185">			fromDate = m_dayRange.getStartDate();</span>
<span class="nc" id="L186">			toDate = m_dayRange.getEndDate();</span>
<span class="nc" id="L187">			LocalDate fromLDate = new LocalDate(getFromDate());</span>
<span class="nc" id="L188">			fromLDate.add(Calendar.DATE, -1);</span>
<span class="nc" id="L189">			LocalDate toLDate = new LocalDate(getToDate());</span>
<span class="nc" id="L190">			toLDate.add(Calendar.DATE, 1);</span>
<span class="nc" id="L191">			m_dayRange.setStartDate(fromLDate.getTime());</span>
<span class="nc" id="L192">			m_dayRange.setEndDate(toLDate.getTime());</span>

		}

<span class="nc bnc" id="L196" title="All 2 branches missed.">		if (isFetchDataFromEmpIDs(employeeIDs)) {</span>
			// Use pagination data from the previous page passed in the hidden
			// field.
			// These IDs are already sorted.
<span class="nc" id="L200">			theData = ScheduleViewMH.getGroupData(m_context, m_viewType, m_timeRange, m_dayRange, orgID, campaignID,</span>
					employeeIDs, true);
		} else {
			// Get ID's for the group (they will be sorted) and initialize
			// pagination.
			// Tample changed for QA 86309:
<span class="nc" id="L206">			theData = ScheduleViewMH.getGroupData(m_context, m_viewType, m_timeRange, m_dayRange, orgID, campaignID,</span>
<span class="nc" id="L207">					null, getPageIDSizeWithoutNormalizing(), m_sortBy, true, oDayRange);// QC79134</span>

<span class="nc bnc" id="L209" title="All 2 branches missed.">			if (theData != null) {</span>
<span class="nc" id="L210">				setPageMessageFromData(theData);</span>
<span class="nc" id="L211">				reInitSelectedIDs(theData);</span>
			}
		}
		// QA100526 removing -1 and +1 day range
<span class="nc bnc" id="L215" title="All 2 branches missed.">		if (this instanceof GroupTextSchedulePM) {</span>
<span class="nc" id="L216">			m_dayRange.setStartDate(fromDate);</span>
<span class="nc" id="L217">			m_dayRange.setEndDate(toDate);</span>
		}

<span class="nc" id="L220">		return theData;</span>
	}

	/**
	 * Get Data for Workpane (manager screen)
	 */
	protected HashMap getWorkpaneData() throws Exception {
		// Prepare to fetch Data
<span class="fc" id="L228">		HashMap theData = new HashMap();</span>
<span class="fc" id="L229">		Collection&lt;ID&gt; employeeIDs = getPageIDs();</span>
<span class="fc" id="L230">		TimeRange oDayRange = null; // QC79134</span>
<span class="fc" id="L231">		ID orgID = m_groupSelectorPC.getOrgID();</span>
<span class="fc" id="L232">		ID campaignID = m_groupSelectorPC.getCampaignID();</span>

<span class="fc" id="L234">		Date fromDate = new Date();</span>
<span class="fc" id="L235">		Date toDate = new Date();</span>
		// QA100526 Adding -1 and +1 day range to cover the crossing events
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">		if (this instanceof GroupTextSchedulePM) {</span>
<span class="nc" id="L238">			oDayRange = (TimeRange) m_dayRange.clone();// QC79134</span>
<span class="nc" id="L239">			fromDate = m_dayRange.getStartDate();</span>
<span class="nc" id="L240">			toDate = m_dayRange.getEndDate();</span>
<span class="nc" id="L241">			LocalDate fromLDate = new LocalDate(getFromDate());</span>
<span class="nc" id="L242">			fromLDate.add(Calendar.DATE, -1);</span>
<span class="nc" id="L243">			LocalDate toLDate = new LocalDate(getToDate());</span>
<span class="nc" id="L244">			toLDate.add(Calendar.DATE, 1);</span>
<span class="nc" id="L245">			m_dayRange.setStartDate(fromLDate.getTime());</span>
<span class="nc" id="L246">			m_dayRange.setEndDate(toLDate.getTime());</span>
		}

<span class="fc bfc" id="L249" title="All 2 branches covered.">		if (isFetchDataFromEmpIDs(employeeIDs)) {</span>
<span class="fc" id="L250">			employeeIDs = filterOutNonPrivEmpIDsForPeopleModule(employeeIDs);</span>

<span class="fc" id="L252">			theData = ScheduleViewMH.getGroupData(m_context, m_viewType, m_timeRange, m_dayRange, null, null,</span>
					employeeIDs, false);
		} else {
<span class="fc" id="L255">			Collection&lt;ID&gt; allEmpIDs = getSelectedIDsAsCollection();</span>
<span class="fc" id="L256">			allEmpIDs = filterOutNonPrivEmpIDsForPeopleModule(allEmpIDs);</span>

			// Handle Sorting
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">			if (!allEmpIDs.isEmpty()) {</span>
<span class="fc" id="L260">				theData = ScheduleViewMH.getGroupData(m_context, m_viewType, m_timeRange, m_dayRange, orgID, campaignID,</span>
<span class="fc" id="L261">						allEmpIDs, getPageIDSize(), m_sortBy, false, oDayRange);// QC79134</span>

<span class="fc" id="L263">				reInitSelectedIDs(theData);</span>
			}
		}
		// QA100526 removing -1 and +1 day range
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">		if (this instanceof GroupTextSchedulePM) {</span>
<span class="nc" id="L268">			m_dayRange.setStartDate(fromDate);</span>
<span class="nc" id="L269">			m_dayRange.setEndDate(toDate);</span>
		}

		// initialize Filter
<span class="fc" id="L273">		m_filterBoxPC = new PeopleFilterBoxPC(m_context);</span>
<span class="fc" id="L274">		addChildComponent(m_filterBoxPC);</span>
<span class="fc" id="L275">		m_filterBoxPC.setIsBottomRowEnabled(true);</span>
<span class="fc" id="L276">		((PeopleFilterBoxPC) m_filterBoxPC).initFilter();</span>

<span class="fc" id="L278">		return theData;</span>
	}

	/**
	 * Remove Employee IDs that user does not have Privilege To View Schedule
	 * for People Module
	 */
	private Collection&lt;ID&gt; filterOutNonPrivEmpIDsForPeopleModule(Collection&lt;ID&gt; selectedEmpIDs) throws Exception {
<span class="fc" id="L286">		Collection&lt;ID&gt; filteredEmpIDs = ScheduleViewMH.getEmpIDsForSchedViewing(m_context,</span>
				PrivilegeKeys.FS_VIEWPEOPLESCHEDULES_ID, selectedEmpIDs);

		// User does not have Priv to view Schedule for some Selected Employee
		// IDs
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">		if (filteredEmpIDs.size() &lt; selectedEmpIDs.size()) {</span>
			// Add Warning Messages
<span class="nc bnc" id="L293" title="All 2 branches missed.">			String rbKey = filteredEmpIDs.isEmpty() ? FsWebBundleKey.PEOPLE_SCHEDULE_NO_PRIV_TO_EMPS</span>
					: FsWebBundleKey.PEOPLE_SCHEDULE_NO_PRIV_TO_SOME_EMPS;
<span class="nc" id="L295">			addPageMessage(Message.WARNING_TYPE, rbKey, FsWebBundleKey.BUNDLE_NAME);</span>
		}

<span class="fc" id="L298">		return filteredEmpIDs;</span>
	}

	protected void reInitSelectedIDs(Map dataMap) {
<span class="fc" id="L302">		Collection emplDs = (Collection) dataMap.get(ScheduleViewMH.EMPLOYEE_ALLIDS_KEY);</span>
<span class="fc" id="L303">		initSelectedIDs(emplDs);</span>
<span class="fc" id="L304">	}</span>

	/**
	 * setSortBy() is called automatically by extractParameters() when changing
	 * sort selection or when Paginating, but not when refreshing suite.
	 * 
	 * @param bValue
	 */
	public void setSortBy(String val) {
<span class="fc" id="L313">		m_sortBy = val;</span>
<span class="fc" id="L314">	}</span>

	public void setIsSortRecord(boolean bValue) {
<span class="fc" id="L317">		m_isSortRecord = bValue;</span>
<span class="fc" id="L318">	}</span>

	/**
	 * Return Collection of View Selector Options
	 */
	protected Collection getViewSelectorOptions() {
<span class="fc" id="L324">		ArrayList options = new ArrayList(3);</span>
<span class="fc" id="L325">		options.add(new StringsPair(adjustFormActionForMode(GroupMultidaySchedulePM.FORM_ACTION),</span>
<span class="fc" id="L326">				i18n(m_bundle, FsWebBundleKey.SV_TYPE_MULTIDAY)));</span>
<span class="fc" id="L327">		options.add(new StringsPair(adjustFormActionForMode(GroupTextSchedulePM.FORM_ACTION),</span>
<span class="fc" id="L328">				i18n(m_bundle, FsWebBundleKey.SV_TYPE_TEXT)));</span>

<span class="fc" id="L330">		String graphPM = GroupGraphSchedulePM.FORM_ACTION;</span>
<span class="pc bpc" id="L331" title="2 of 4 branches missed.">		if (!m_isFullPageMode &amp;&amp; (getPageIDs().size() == 1))</span>
<span class="fc" id="L332">			graphPM = GroupMultidayGraphSchedulePM.FORM_ACTION;</span>
<span class="fc" id="L333">		options.add(new StringsPair(adjustFormActionForMode(graphPM), i18n(m_bundle, FsWebBundleKey.SV_TYPE_GRAPH)));</span>
<span class="fc" id="L334">		return options;</span>
	}

	/**
	 * Initialize Content Title
	 */
	protected void initContentTitle() {
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">		String pageTitleRBKey = m_isFullPageMode ? FsWebBundleKey.MYSCHEDULE_GROUP_PAGETITLE</span>
				: FsWebBundleKey.PEOPLE_SCHEDULE;
<span class="fc" id="L343">		String pageTitle = i18n(m_bundle, pageTitleRBKey);</span>
<span class="fc" id="L344">		m_contentTitlePC.setPageTitle(pageTitle);</span>

<span class="pc bpc" id="L346" title="1 of 2 branches missed.">		if (m_isPageEnabled) {</span>
<span class="fc" id="L347">			String itemName = &quot;&quot;;</span>
<span class="pc bpc" id="L348" title="1 of 2 branches missed.">			if (m_isFullPageMode) {</span>
<span class="nc" id="L349">				m_groupSelectorPC.setLeftMargin(5);</span>
<span class="nc" id="L350">				itemName = m_groupSelectorPC.getHtmlDisplay();</span>
			}

<span class="fc" id="L353">			m_contentTitlePC.setItemName(itemName);</span>

			// add view selector as active component
<span class="fc" id="L356">			m_contentTitlePC.addActiveComponent(makeDatesSelector() + &quot;&amp;nbsp;&amp;nbsp;&quot;);</span>
<span class="fc" id="L357">			m_contentTitlePC.addActiveComponent(&quot;&amp;nbsp;&amp;nbsp;&quot; + makeSortSelector());</span>
<span class="fc" id="L358">			m_contentTitlePC.addActiveComponent(&quot;&amp;nbsp;&amp;nbsp;&quot; + makeViewSelector());</span>

<span class="fc" id="L360">			m_contentTitlePC.setAutoExtractParamEnabled(true);</span>
		}
<span class="fc" id="L362">	}// initContentTitle</span>

	/**
	 * Make the Time Interval selection html string
	 */
	private String makeDatesSelector() {
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">		if (m_timeRange == null)</span>
<span class="nc" id="L369">			return &quot;&quot;;</span>

<span class="fc" id="L371">		StringBuffer sb = new StringBuffer();</span>
<span class="fc" id="L372">		String label = i18n(m_bundle, FsWebBundleKey.SV_DATES_SELECTOR);</span>
<span class="fc" id="L373">		sb.append(ContentTitlePC.formatLabel(label));</span>
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">		if (m_bDateSelector) {</span>
			// dateRangePicker: show only the icon
			// m_dateRangePicker.getStartDatePickerPC().setInputType(DatePickerPC.INPUT_TYPE_HIDDEN);
			// //508
			// m_dateRangePicker.getEndDatePickerPC().setInputType(DatePickerPC.INPUT_TYPE_HIDDEN);
			// //508
		} else {
			// hidden date to be used by the daily links
<span class="fc" id="L382">			sb.append(HtmlUtil.makeHiddenInput(VIEW_DATE_FN, &quot;&quot;));</span>
<span class="fc" id="L383">			m_dateRangePicker.getStartDatePickerPC().setInputType(DatePickerPC.INPUT_TYPE_NORMAL);</span>
<span class="fc" id="L384">			m_dateRangePicker.getEndDatePickerPC().setInputType(DatePickerPC.INPUT_TYPE_NORMAL);</span>
		}

<span class="fc" id="L387">		m_dateRangePicker.getStartDatePickerPC().setDate(m_timeRange.getStartDate());</span>
<span class="fc" id="L388">		m_dateRangePicker.getEndDatePickerPC().setDate(m_timeRange.getEndDate());</span>
<span class="fc" id="L389">		m_dateRangePicker.setOnChangeJS(JS_REFRESH_WITH_SORT);</span>
<span class="fc" id="L390">		limitDateRangePicker(); // make selectable +/- 30years</span>
<span class="fc" id="L391">		m_dateRangePicker.initForDisplay();</span>

<span class="fc" id="L393">		m_dateRangePicker.setInputTitles(i18n(m_bundle, FsWebBundleKey.FS_EVENT_STARTDATE),</span>
<span class="fc" id="L394">				i18n(m_bundle, FsWebBundleKey.FS_EVENT_ENDDATE)); // 508</span>

<span class="fc" id="L396">		sb.append(m_dateRangePicker.toString());</span>

<span class="pc bpc" id="L398" title="1 of 2 branches missed.">		if (m_bDateSelector) {</span>
			// add dates dropdown
<span class="nc" id="L400">			label = i18n(m_bundle, FsWebBundleKey.SV_DAY_SELECTOR);</span>
<span class="nc" id="L401">			label = HtmlUtil.createLabel(label, VIEW_DATE_FN); // 508</span>
<span class="nc" id="L402">			sb.append(ContentTitlePC.formatLabel(label));</span>
<span class="nc" id="L403">			sb.append(makeDateDropDown());</span>
		}

<span class="fc" id="L406">		return sb.toString();</span>
	}// makeDatesSelector

	/**
	 * generate html string for a dropdown with the dates in the member range
	 */
	private String makeDateDropDown() {
<span class="nc" id="L413">		String[] selectedValue = { String.valueOf(m_dayRange.getStartDate().getTime()) };</span>
<span class="nc" id="L414">		ArrayList options = new ArrayList(5);</span>

<span class="nc" id="L416">		TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L417">		CalendarRange aDay = DateTimeUtil.makeDayRange(m_timeRange.getStartDate(), tz);</span>

		// for each date in the viewing range create the row
<span class="nc" id="L420">		boolean dstAdjustment = false;</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">		while (!m_timeRange.isBefore(aDay)) {</span>
<span class="nc" id="L422">			options.add(new StringsPair(Long.toString(aDay.getStartDate().getTime()), m_localizer</span>
<span class="nc" id="L423">					.formatDate(aDay.getStartCalendar().getTime(), tz, RegionalFormatBundleKey.DATE_FORMAT)));</span>
			// QC46598 java bug for Brazil DST transition 10/18/09
			// aDay.nextDay();
<span class="nc" id="L426">			dstAdjustment = ScheduleViewUtil.nextDay(aDay, dstAdjustment);</span>
		} // endwhile

<span class="nc" id="L429">		return HtmlUtil.makeSelectInput(VIEW_DATE_FN, &quot;0&quot;, selectedValue, JS_REFRESH_WITH_SORT, options, null, false,</span>
				false);
	}

	/**
	 * make sort selector html string
	 */
	protected String makeSortSelector() {
<span class="fc" id="L437">		ArrayList options = new ArrayList(5);</span>
<span class="fc" id="L438">		options.add(new StringsPair(SORT_BY_LNAME, i18n(m_bundle, FsWebBundleKey.SV_SORT_BY_LNAME)));</span>
<span class="fc" id="L439">		options.add(new StringsPair(SORT_BY_FNAME, i18n(m_bundle, FsWebBundleKey.SV_SORT_BY_FNAME)));</span>
<span class="fc" id="L440">		options.add(new StringsPair(SORT_BY_START, i18n(m_bundle, FsWebBundleKey.SV_SORT_BY_START)));</span>
<span class="fc" id="L441">		options.add(new StringsPair(SORT_BY_END, i18n(m_bundle, FsWebBundleKey.SV_SORT_BY_END)));</span>
<span class="fc" id="L442">		options.add(new StringsPair(SORT_BY_LENGTH, i18n(m_bundle, FsWebBundleKey.SV_SORT_BY_LENGTH)));</span>
<span class="fc" id="L443">		String label = i18n(m_common_bundle, UIFWebBundleKey.SORT_BY);</span>

<span class="fc" id="L445">		return makeSelector(SORT_BY_FN, label, m_sortBy, JS_REFRESH_WITH_SORT, options);</span>
	}// makeSortSelector

	/**
	 * Initialize date for viewing
	 */
	protected void initDayRange() {
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">		if (!super.m_viewType.equals(VIEW_TYPE_GROUP_MULTI)) {</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">			if (m_dayRange == null) {</span>
				// not extracted - get from session
<span class="nc" id="L455">				m_dayRange = (TimeRange) m_context.getAttribute(RequestContext.SESSION_SCOPE,</span>
						UserPreferenceKeys.USER_SCHEDULE_VIEW_DAY);

			}
<span class="nc bnc" id="L459" title="All 2 branches missed.">			if (m_dayRange == null) {</span>
				// not in session - try Today
<span class="nc" id="L461">				m_dayRange = DateTimeUtil.makeDayRange(new Date(), m_context.getViewingTimeZone());</span>
			}
<span class="nc" id="L463">			m_dayRange = ScheduleViewUtil.makeSureDayIsInRange(m_dayRange, m_timeRange, m_context.getViewingTimeZone());</span>
			// save in session
<span class="nc" id="L465">			m_context.setAttribute(RequestContext.SESSION_SCOPE, UserPreferenceKeys.USER_SCHEDULE_VIEW_DAY, m_dayRange);</span>
		}
<span class="fc" id="L467">	}// initDayRange</span>

	/**
	 * Return true if Authorized to view Group Schedule
	 */
	protected boolean isAuthToViewGroupSchedule(Map theData) {
<span class="fc" id="L473">		boolean isAuth = true;</span>

<span class="fc" id="L475">		String sLimitKey = (String) theData.get(ScheduleViewMH.GROUPVIEW_LIMIT_KEY);</span>
<span class="pc bpc" id="L476" title="1 of 2 branches missed.">		if (ScheduleViewMH.GROUPVIEW_LIMIT_NOPRIV_1.equals(sLimitKey)</span>
<span class="pc bpc" id="L477" title="1 of 2 branches missed.">				|| ScheduleViewMH.GROUPVIEW_LIMIT_NOORG_1.equals(sLimitKey)</span>
<span class="pc bpc" id="L478" title="1 of 2 branches missed.">				|| ScheduleViewMH.GROUPVIEW_LIMIT_NOLINK_1.equals(sLimitKey)</span>
<span class="pc bpc" id="L479" title="1 of 2 branches missed.">				|| ScheduleViewMH.GROUPVIEW_LIMIT_NOLINK_2.equals(sLimitKey)</span>
<span class="pc bpc" id="L480" title="1 of 2 branches missed.">				|| ScheduleViewMH.GROUPVIEW_LIMIT_NOPRIV_2.equals(sLimitKey)</span>
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">				|| ScheduleViewMH.GROUPVIEW_LIMIT_NOORG_2.equals(sLimitKey)) {</span>
<span class="nc" id="L482">			isAuth = false;</span>
		}

<span class="fc" id="L485">		return isAuth;</span>
	}

	/**
	 * get warnings result from the HashMap returned by Model Handler and
	 * generate the page messages
	 */
	protected void setPageMessageFromData(HashMap theData) {
<span class="nc" id="L493">		String aGroupViewLimit = (String) theData.get(ScheduleViewMH.GROUPVIEW_LIMIT_KEY);</span>
<span class="nc" id="L494">		String aMsg = null;</span>

<span class="nc bnc" id="L496" title="All 2 branches missed.">		if (aGroupViewLimit.equals(ScheduleViewMH.GROUPVIEW_LIMIT_NOPRIV_1)) {</span>
			// &quot;You do not have a privilege to see schedules from the selected
			// organization.&quot;
<span class="nc" id="L499">			aMsg = i18n(m_bundle, FsWebBundleKey.MSG_SV_NOPRIV_1);</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">		} else if (aGroupViewLimit.equals(ScheduleViewMH.GROUPVIEW_LIMIT_NOORG_1)) {</span>
			// &quot;Your organization is not configured to see schedules from the
			// selected organization.&quot;
<span class="nc" id="L503">			aMsg = i18n(m_bundle, FsWebBundleKey.MSG_SV_NOORG_1);</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">		} else if (aGroupViewLimit.equals(ScheduleViewMH.GROUPVIEW_LIMIT_NOLINK_1)) {</span>
			// &quot;The selected organization is not linked to the selected campaign
			// for that date range.&quot;
<span class="nc" id="L507">			aMsg = i18n(m_bundle, FsWebBundleKey.MSG_SV_NOLINK_1);</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">		} else if (aGroupViewLimit.equals(ScheduleViewMH.GROUPVIEW_LIMIT_NOLINK_2)) {</span>
			// &quot;The selected campaign has no organizations linked to it for that
			// date range.&quot;
<span class="nc" id="L511">			aMsg = i18n(m_bundle, FsWebBundleKey.MSG_SV_NOLINK_2);</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">		} else if (aGroupViewLimit.equals(ScheduleViewMH.GROUPVIEW_LIMIT_NOPRIV_2)) {</span>
			// &quot;You do not have a privilege to see schedules from any of the
			// organizations in the selected campaign for that date range.&quot;
<span class="nc" id="L515">			aMsg = i18n(m_bundle, FsWebBundleKey.MSG_SV_NOPRIV_2);</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">		} else if (aGroupViewLimit.equals(ScheduleViewMH.GROUPVIEW_LIMIT_NOPRIV_3)) {</span>
			// &quot;You do not have a privilege to see schedules from some of the
			// organizations in the selected campaign for that date range.&quot;
<span class="nc" id="L519">			aMsg = i18n(m_bundle, FsWebBundleKey.MSG_SV_NOPRIV_3);</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">		} else if (aGroupViewLimit.equals(ScheduleViewMH.GROUPVIEW_LIMIT_NOORG_2)) {</span>
			// &quot;Your organization is not configured to see schedules from any of
			// the organizations linked to the selected campaign for that date
			// range.&quot;
<span class="nc" id="L524">			aMsg = i18n(m_bundle, FsWebBundleKey.MSG_SV_NOORG_2);</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">		} else if (aGroupViewLimit.equals(ScheduleViewMH.GROUPVIEW_LIMIT_SOMEORG)) {</span>
			// &quot;Your organization is not configured to see schedules from some
			// of the organizations linked to the selected campaign for that
			// date range.&quot;
<span class="nc" id="L529">			aMsg = i18n(m_bundle, FsWebBundleKey.MSG_SV_SOMEORG);</span>
		}

<span class="nc bnc" id="L532" title="All 2 branches missed.">		if (!StringUtil.isEmpty(aMsg)) {</span>
<span class="nc" id="L533">			this.addPageMessage(Message.WARNING_TYPE, aMsg);</span>
		}
<span class="nc" id="L535">	}</span>

	/**
	 * Inititalize pagination in the toolbar
	 */
	protected void initPagination(HashMap theData) {
<span class="fc" id="L541">		setPageIDResizeEnabled(true);</span>
<span class="fc" id="L542">		String itemTypeName = i18n(m_bundle, FsWebBundleKey.SV_PERSON);</span>
<span class="fc" id="L543">		m_toolbar.setPagination(itemTypeName, this, true, JSUtil.REFRESH_IGNORE_CHANGES);</span>
<span class="fc" id="L544">	}// initPagination</span>

	/**
	 * Initialize Selected IDs with Employee IDs
	 */
	protected void initSelectedIDs(Collection employeeIDs) {
<span class="fc" id="L550">		setSelectedID(&quot;&quot;);</span>
<span class="fc" id="L551">		setEditIndex(0);</span>

<span class="pc bpc" id="L553" title="2 of 4 branches missed.">		if (employeeIDs != null &amp;&amp; !employeeIDs.isEmpty()) {</span>
<span class="fc" id="L554">			ID[] ids = new ID[employeeIDs.size()];</span>
<span class="fc" id="L555">			int index = 0;</span>
<span class="fc bfc" id="L556" title="All 2 branches covered.">			for (Iterator it = employeeIDs.iterator(); it.hasNext();) {</span>
<span class="fc" id="L557">				ids[index++] = (ID) it.next();</span>
			}
<span class="fc" id="L559">			setSelectedIDs(ids);</span>
		}
<span class="fc" id="L561">	}// initSelectedIDs</span>

	/**
	 * initialize group selector
	 */
	private void initGroup(HashMap theData) throws BbmException, RemoteException {
<span class="fc" id="L567">		IDStringPair orgData = (IDStringPair) theData.get(ScheduleViewMH.ORGS_KEY);</span>
<span class="fc" id="L568">		IDStringPair campaignData = (IDStringPair) theData.get(ScheduleViewMH.CAMPAIGN_KEY);</span>

<span class="fc" id="L570">		getOrgsAndCampsForGroupScheduleView(m_context);</span>

<span class="fc" id="L572">		m_groupSelectorPC.initGroup(orgData, campaignData);</span>
<span class="fc" id="L573">	}// initGroup</span>

	/**
	 * Get the organizations and campaigns that the user should see in the group
	 * schedule org/camp selector popup. We will also store these collections in
	 * the session for easy access by the group selector popup page model.
	 * 
	 * @param context
	 * @return an array with 2 values: Index0=collection of orgs,
	 *         index1=collection of campaigns
	 */
	public static Object[] getOrgsAndCampsForGroupScheduleView(RequestContext context)
			throws BbmException, RemoteException {
<span class="fc" id="L586">		Collection orgSet = (Collection) context.getAttribute(RequestContext.SESSION_SCOPE, &quot;MyVisibleOrganizations&quot;);</span>
<span class="fc" id="L587">		Collection campaigns = (Collection) context.getAttribute(RequestContext.SESSION_SCOPE, &quot;MyVisibleCampaigns&quot;);</span>

<span class="pc bpc" id="L589" title="1 of 4 branches missed.">		if (orgSet == null &amp;&amp; campaigns == null) {</span>
			// get the org collection
<span class="fc" id="L591">			Collection orgs = OrganizationModelHandler.getAllOrgsInUserScope(context, context.getUser());</span>

			// add the orgs from above, plus all of the RM Settings orgs to a
			// set
<span class="fc" id="L595">			orgSet = new HashSet(orgs.size());</span>
<span class="fc" id="L596">			orgSet.addAll(orgs);</span>

			// get the logged-in user's organization
<span class="fc" id="L599">			User user = context.getUser();</span>
<span class="fc" id="L600">			ID empID = user.getEmployeeID();</span>
<span class="fc" id="L601">			Collection rmOrgIDs = null;</span>
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">			if (empID != null) {</span>
<span class="fc" id="L603">				ID userOrgID = OrganizationModelHandler.getEmployeeOrgID(context, empID);</span>

				// get the RM Settings orgs
<span class="fc" id="L606">				rmOrgIDs = ScheduleViewMH.getGroupViewOrgIDs(userOrgID);</span>
			}

			// extract the org IDs only
<span class="fc" id="L610">			HashSet orgIDSet = new HashSet(orgSet.size());</span>
<span class="fc bfc" id="L611" title="All 2 branches covered.">			for (Iterator it = orgSet.iterator(); it.hasNext();) {</span>
<span class="fc" id="L612">				Organization org = (Organization) it.next();</span>
<span class="fc" id="L613">				orgIDSet.add(org.getID());</span>
<span class="fc" id="L614">			}</span>

			// add the RM Settings orgs to the orgIDSet and orgSet
<span class="pc bpc" id="L617" title="2 of 4 branches missed.">			if (rmOrgIDs != null &amp;&amp; rmOrgIDs.size() &gt; 0) {</span>
<span class="fc" id="L618">				orgIDSet.addAll(rmOrgIDs);</span>
<span class="fc" id="L619">				Collection rmOrgs = OrganizationModelHandler.getOrganizationsByIDs(context, rmOrgIDs);</span>
<span class="fc" id="L620">				orgSet.addAll(rmOrgs);</span>
			}

			// now get the campaigns linked to those orgIDs
<span class="fc" id="L624">			campaigns = CampaignModelHandler.getAllCampaignIDsLinkedToOrgs(context, orgIDSet);</span>

			// campaigns is really the collection of IDs. Need to get the
			// Campaign objects.
<span class="fc" id="L628">			campaigns = CampaignModelHandler.getCampaignsByIDs(context, campaigns);</span>

			// add ancestor orgs to the orgSet if not already there (used for
			// presentation of org hierarchy only)
<span class="fc" id="L632">			orgs = OrganizationModelHandler.getOrganizationsParentsByIDsExceptSystem(context, orgIDSet);</span>
<span class="fc" id="L633">			orgSet.addAll(orgs);</span>

<span class="fc" id="L635">			context.setAttribute(RequestContext.SESSION_SCOPE, &quot;MyVisibleOrganizations&quot;, orgSet);</span>
<span class="fc" id="L636">			context.setAttribute(RequestContext.SESSION_SCOPE, &quot;MyVisibleCampaigns&quot;, campaigns);</span>
		}
<span class="fc" id="L638">		return new Object[] { orgSet, campaigns };</span>
	}

	protected void addLeftRow(DefaultMultiColumnNodeData rowData, String empName) {
<span class="nc bnc" id="L642" title="All 2 branches missed.">		if (!StringUtil.isEmpty(empName)) {</span>
			// 508 STYLE_NOWRAP
<span class="nc" id="L644">			rowData.add(empName, CSSUtil.STYLE_NOWRAP_NORMAL_LEFT);</span>
		} else {
<span class="nc" id="L646">			rowData.add(&quot;&quot;);</span>
		}
<span class="nc" id="L648">	}</span>

	/**
	 * make a row for the list display of the date
	 */
	protected DefaultMultiColumnNodeData makeLeftRow(EmployeeName employeeName, boolean isMyRow) {
<span class="fc" id="L654">		DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData();</span>
<span class="fc" id="L655">		String empName = &quot;&quot;;</span>
<span class="pc bpc" id="L656" title="1 of 2 branches missed.">		if (employeeName != null) {</span>
<span class="fc" id="L657">			empName = m_localizer.formatFullName(employeeName);</span>
<span class="pc bpc" id="L658" title="1 of 2 branches missed.">			if (isMyRow) {</span>
<span class="nc" id="L659">				empName = highlightName(empName);</span>
			}
		}

<span class="fc" id="L663">		addLeftRow(rowData, empName);</span>
<span class="fc" id="L664">		rowData.setSelectable(false);</span>
<span class="fc" id="L665">		return rowData;</span>
	}

	protected String highlightName(String name) {
<span class="nc" id="L669">		return &quot;&lt;b&gt;&quot; + name + &quot;&lt;/b&gt;&quot;;</span>
	}

	// Changed for QA59182 -Out Of Memory Error thrown when Selecting All or
	// More Records in the request management and in Adherence
	// overriding the method for WorkpanePageModel as hack to restrict the
	// number of records selected in a page
	public void setPageIDSize(int PageIDSize) {
		try {

<span class="nc bnc" id="L679" title="All 2 branches missed.">			String configKey = (BASIC_MODEL == getPageModelType()) ? &quot;bluepumpkin/Schedule/MyGroup/pageIDSizeLimit&quot;</span>
					: &quot;bluepumpkin/Schedule/People/pageIDSizeLimit&quot;;

<span class="nc" id="L682">			String pageIDSizeFetched = BbmManagerFactory.getDBConfigManager().getValue(configKey);</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">			if (pageIDSizeFetched != null) {</span>
<span class="nc" id="L684">				int iPageIDSizeFetched = Integer.parseInt(pageIDSizeFetched);</span>
<span class="nc bnc" id="L685" title="All 6 branches missed.">				if ((PageIDSize &gt; iPageIDSizeFetched) || (PageIDSize &lt; 0 &amp;&amp; iPageIDSizeFetched &gt;= 0)) {</span>
<span class="nc" id="L686">					PageIDSize = iPageIDSizeFetched;</span>
				}
			}
<span class="nc" id="L689">		} catch (Exception ex) {</span>
			// ignoring any exception caught.
<span class="nc" id="L691">		}</span>
<span class="nc" id="L692">		super.setPageIDSize(PageIDSize);</span>
<span class="nc" id="L693">	}</span>

	// ================ abstract ======================
	/** prepare the m_list should be implemented by inheriting classes */
	protected abstract void populateList(HashMap theData) throws Exception;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>