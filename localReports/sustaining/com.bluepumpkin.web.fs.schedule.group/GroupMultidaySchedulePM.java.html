<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GroupMultidaySchedulePM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.schedule.group</a> &gt; <span class="el_source">GroupMultidaySchedulePM.java</span></div><h1>GroupMultidaySchedulePM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.schedule.group;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.CalendarRange;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.DateTimeUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.ShiftSwapPosting;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.schedule.ScheduleViewMH;
import com.bluepumpkin.web.fs.schedule.ScheduleViewPM;
import com.bluepumpkin.web.fs.schedule.ScheduleViewShiftDisplayInfo;
import com.bluepumpkin.web.fs.schedule.ScheduleViewUtil;
import com.bluepumpkin.web.fs.schedule.summary.DailyScheduleSummary;
import com.bluepumpkin.web.fs.schedule.summary.ScheduleSummaryMH;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlLinkUtil;

/**
 * Title: GroupMultidaySchedulePM Description: Personal Schedule printable
 * display. Copyright: Copyright (c) 2002 Company: Blue Pumpkin Software, inc
 * 
 * @author Chris King, Pavel Bosin
 * @version 1.0
 */
@SuppressWarnings(&quot;serial&quot;)
public class GroupMultidaySchedulePM extends GroupSchedulePM {
	public static final String FORM_ACTION = &quot;schedule&quot;;
	protected static final String ROW_STYLE = CSSUtil.STYLE_NOWRAP_NORMAL_LEFT + &quot;height:17px;&quot;;

	/**
	 * Constructor
	 */
	public GroupMultidaySchedulePM(RequestContext context) {
<span class="fc" id="L49">		super(context, FORM_ACTION, ScheduleViewPM.VIEW_TYPE_GROUP_MULTI, true);</span>
		// 508: The row headers are hidden in the right list.
<span class="fc" id="L51">		m_dualList.getRightListPC().setHasRowHeaders(true);</span>
<span class="fc" id="L52">	}// constructor</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="fc" id="L58">		return getInstance(context, GroupMultidaySchedulePM.class);</span>
	}

	/**
	 * abstract method to prepare the m_list should be implemented by specific
	 * classes
	 *
	 */
	protected void populateList(HashMap theData) throws Exception {
<span class="pc bpc" id="L67" title="2 of 4 branches missed.">		if (theData == null || theData.isEmpty()) {</span>
<span class="nc" id="L68">			return;</span>
		}

<span class="fc" id="L71">		messageIfNotPublished(theData);</span>

<span class="fc" id="L73">		Collection&lt;Collection&lt;DailyScheduleSummary&gt;&gt; daySummaries = (Collection&lt;Collection&lt;DailyScheduleSummary&gt;&gt;) theData</span>
<span class="fc" id="L74">				.get(ScheduleViewMH.DAY_SUMMARIES_KEY);</span>
<span class="fc" id="L75">		HashMap employeeNames = (HashMap) theData.get(ScheduleViewMH.EMPLOYEE_NAMES_KEY);</span>
<span class="fc" id="L76">		Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) theData.get(ScheduleViewMH.EMPLOYEE_IDS_KEY);</span>
<span class="fc" id="L77">		Collection&lt;ShiftSwapPosting&gt; postings = (Collection&lt;ShiftSwapPosting&gt;) theData</span>
<span class="fc" id="L78">				.get(ScheduleViewMH.SWAP_BOARD_KEY);</span>
<span class="fc" id="L79">		Map&lt;ID, String&gt; campaignNamesBySPID = (Map&lt;ID, String&gt;) theData.get(ScheduleViewMH.CAMPAIGN_NAMES_BY_SP_ID_KEY);</span>
<span class="fc" id="L80">		boolean bSwapEnabled = isSwapEnabled(theData);</span>

		// --- set headers -------------------
<span class="fc" id="L83">		setListHeaders();</span>

<span class="fc" id="L85">		ArrayList leftListModel = new ArrayList();</span>
<span class="fc" id="L86">		ArrayList rightListModel = new ArrayList();</span>
<span class="pc bpc" id="L87" title="2 of 4 branches missed.">		if (employeeIDs != null &amp;&amp; daySummaries != null) {</span>
			// --- for each employee create a row
<span class="fc bfc" id="L89" title="All 2 branches covered.">			for (Iterator iEID = employeeIDs.iterator(), iSchedule = daySummaries.iterator(); iEID.hasNext();) {</span>
<span class="fc" id="L90">				ID eID = (ID) iEID.next();</span>
<span class="fc" id="L91">				boolean isMyRow = isMyID(eID); // eID.equals(userEID);</span>
<span class="fc" id="L92">				Collection&lt;DailyScheduleSummary&gt; personalSchedule = (Collection&lt;DailyScheduleSummary&gt;) iSchedule.next();</span>
<span class="fc" id="L93">				EmployeeName employeeName = (EmployeeName) employeeNames.get(eID);</span>
<span class="fc" id="L94">				DefaultMultiColumnNodeData leftRowData = makeLeftRow(employeeName, isMyRow);</span>
<span class="fc" id="L95">				leftListModel.add(leftRowData);</span>
<span class="fc" id="L96">				DefaultMultiColumnNodeData rightRowData = makeRightRow(employeeName, personalSchedule, postings,</span>
<span class="fc" id="L97">						bSwapEnabled, isMyRow, showTimeoff(theData), campaignNamesBySPID);</span>
<span class="fc" id="L98">				rightListModel.add(rightRowData);</span>
<span class="fc" id="L99">			} // for</span>
		}

<span class="fc" id="L102">		setDualListModels(leftListModel, rightListModel);</span>
<span class="fc" id="L103">	}// populateList</span>

	protected void initRightListProperties() {
		// do nothing just overwrite parent
<span class="fc" id="L107">	}</span>

	/**
	 * set list headers for the multi-column list using parent class methods
	 */
	private void setListHeaders() {
<span class="fc" id="L113">		String name = i18n(m_common_bundle, UIFWebBundleKey.NAME);</span>
<span class="fc" id="L114">		makeLeftDualLIstHeader(name);</span>
<span class="fc" id="L115">		makeRightDualListHeader(name);</span>
<span class="fc" id="L116">	}// setListHeaders</span>

	/**
	 * make right list headers with dates in m_timeRange
	 */
	private void makeRightDualListHeader(String sName) {
<span class="fc" id="L122">		TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="fc" id="L123">		TableHeaderPC header = m_dualList.getRightListPC().getHeader();</span>

		// 508 First column is a hidden name column
<span class="fc" id="L126">		header.addColumnHeaderData(null, HtmlUtil.makeHiddenReadableText(sName)); </span>
		
<span class="fc" id="L128">		CalendarRange aDay = DateTimeUtil.makeDayRange(m_timeRange.getStartDate(), tz);</span>
		// put one string with fixed width spans for each day
<span class="fc" id="L130">		boolean dstAdjustment = false;</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">		while (!m_timeRange.isBefore(aDay)) {</span>
<span class="fc" id="L132">			header.addColumnHeaderData(null, getDateLabelForRowHeader(aDay, tz));</span>
			// QC46598 java bug for Brazil DST transition 10/18/09
<span class="fc" id="L134">			dstAdjustment = ScheduleViewUtil.nextDay(aDay, dstAdjustment);</span>
		}
<span class="fc" id="L136">	}</span>

	/**
	 * Returns a hyper link, the text of which is a localized date (e.g. Thu
	 * 08/22). The link is a drill down to a text group schedule for that
	 * particular day.
	 */
	protected String getDateLabelForRowHeader(CalendarRange day, TimeZone tz) {
<span class="fc" id="L144">		String label = m_localizer.formatDate(day.getStartCalendar().getTime(), tz,</span>
				RegionalFormatBundleKey.DATE_NOYEAR_DAYINWEEKFULL_FORMAT);
		// make the link to go to text view for that day.
<span class="fc" id="L147">		String onClickJS = &quot;goToDay('&quot; + day.getStartDate().getTime() + &quot;');&quot;;</span>

<span class="fc" id="L149">		String link = HtmlLinkUtil.createActiveLink(label, null, null, onClickJS);</span>
<span class="fc" id="L150">		return link;</span>
	}

	protected void addLeftRow(DefaultMultiColumnNodeData rowData, String empName) {
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(empName)) {</span>
			// 508 STYLE_NOWRAP
<span class="fc" id="L156">			rowData.add(empName, ROW_STYLE); </span>
		} else {
<span class="nc" id="L158">			rowData.add(&quot;&quot;, &quot;height:17px;&quot;);</span>
		}
<span class="fc" id="L160">	}</span>

	/**
	 * make right row with schedule start-end for each day in the m_timeRange
	 * 
	 * @param campaignIdNames
	 *            - Map of campaignID-&gt;campaignName.
	 */
	private DefaultMultiColumnNodeData makeRightRow(EmployeeName employeeName,
			Collection&lt;DailyScheduleSummary&gt; daySchedules, Collection&lt;ShiftSwapPosting&gt; postings, boolean bSwapEnabled,
			boolean isMyRow, boolean bShowTimeoff, Map&lt;ID, String&gt; campaignNamesBySPID) {
<span class="fc" id="L171">		DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData();</span>
<span class="fc" id="L172">		TimeZone tz = m_context.getViewingTimeZone();</span>

<span class="pc bpc" id="L174" title="1 of 2 branches missed.">		if (daySchedules != null) {</span>
<span class="fc" id="L175">			ID eID = employeeName.getID();</span>
			
<span class="fc" id="L177">			String empName = m_localizer.formatFullName(employeeName);</span>
			//508 first column is hidden
<span class="fc" id="L179">			rowData.add(HtmlUtil.makeHiddenReadableText(empName)); </span>

<span class="fc bfc" id="L181" title="All 2 branches covered.">			for (Iterator&lt;DailyScheduleSummary&gt; it = daySchedules.iterator(); it.hasNext();) {</span>
				// entries &quot;unpublished&quot; or &quot;no shift&quot; or &quot;hh:mm am - hh:mm pm&quot;
<span class="fc" id="L183">				DailyScheduleSummary oneDaySchedule = it.next();</span>

<span class="fc" id="L185">				String tooltip = i18n(m_bundle, FsWebBundleKey.FS_CAL_TITLEBAR_CAMPAIGN)</span>
<span class="fc" id="L186">						+ ScheduleViewUtil.getCampaignName(campaignNamesBySPID, oneDaySchedule);</span>

<span class="fc" id="L188">				CalendarRange aDay = oneDaySchedule.getDayRange();</span>

<span class="fc bfc" id="L190" title="All 2 branches covered.">				if (!oneDaySchedule.isPublished()) {</span>
					// 508 _NORMAL_LEFT
<span class="fc" id="L192">					rowData.add(i18n(m_bundle, FsWebBundleKey.SCHED_SUMMARY_UNPUBLISHED), ROW_STYLE); </span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">				} else if (oneDaySchedule.isClosed()) {</span>
					// 508
<span class="nc" id="L195">					rowData.add(i18n(m_bundle, FsWebBundleKey.SCHED_SUMMARY_CLOSED), ROW_STYLE); </span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">				} else if (oneDaySchedule.isDayOff()) {</span>
<span class="fc" id="L197">					String eventLabel = null;</span>
<span class="pc bpc" id="L198" title="2 of 4 branches missed.">					if (bShowTimeoff || isMyRow) {</span>
<span class="nc" id="L199">						String defaultAbsentString = i18n(m_bundle, FsWebBundleKey.SCHED_SUMMARY_DAY_OFF);</span>
<span class="nc" id="L200">						String absentStringOverride = ScheduleSummaryMH.getAbsentStringOverride();</span>
						// The value is specific for France Telecom, Story 34043
<span class="nc bnc" id="L202" title="All 2 branches missed.">						if (absentStringOverride != null</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">								&amp;&amp; absentStringOverride.equals(FsWebBundleKey.FS_CUSTOM_TIME_OFF)) {</span>
<span class="nc" id="L204">							absentStringOverride = i18n(m_bundle, FsWebBundleKey.FS_CUSTOM_TIME_OFF);</span>
						}
<span class="nc bnc" id="L206" title="All 2 branches missed.">						eventLabel = absentStringOverride == null ? defaultAbsentString : absentStringOverride;</span>
<span class="nc" id="L207">					} else {</span>
<span class="fc" id="L208">						eventLabel = i18n(m_bundle, FsWebBundleKey.SV_NO_SHIFT);</span>
					}
<span class="fc" id="L210">					ScheduleViewShiftDisplayInfo eventLabels = new ScheduleViewShiftDisplayInfo(&quot;&quot;, eventLabel, &quot;&quot;);</span>
					// 508
<span class="fc" id="L212">					rowData.add(this.makeSwappableLink(bSwapEnabled, isMyRow, true, aDay, postings, eventLabels, eID),</span>
							ROW_STYLE); 
<span class="fc" id="L214">				} else {</span>
					// 508
					ScheduleViewShiftDisplayInfo eventLabels;
<span class="nc bnc" id="L217" title="All 2 branches missed.">					boolean isDayOff = !oneDaySchedule.hasShift();</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">					if (oneDaySchedule.hasShift()) {</span>
<span class="nc" id="L219">						eventLabels = getShiftDisplayInfo(oneDaySchedule, m_localizer, tz);</span>
					} else {
<span class="nc" id="L221">						eventLabels = new ScheduleViewShiftDisplayInfo(&quot;&quot;, i18n(m_bundle, FsWebBundleKey.SV_NO_SHIFT),</span>
								&quot;&quot;);
					}
<span class="nc" id="L224">					rowData.add(</span>
<span class="nc" id="L225">							this.makeSwappableLink(bSwapEnabled, isMyRow, isDayOff, aDay, postings, eventLabels, eID),</span>
							ROW_STYLE);
				}
<span class="fc" id="L228">			}</span>
		}
<span class="fc" id="L230">		rowData.setSelectable(false);</span>
<span class="fc" id="L231">		return rowData;</span>
	}

	/**
	 * add JavaScript function to jump to the day view
	 */
	public String getCustomJavaScript() {
<span class="fc" id="L238">		StringBuffer sb = new StringBuffer(super.getCustomJavaScript());</span>
<span class="fc" id="L239">		sb.append(&quot;\n function goToDay(dayValue){&quot;).append(&quot;\n   var dayElement = DOM2.getElementsByName(\&quot;&quot;)</span>
<span class="fc" id="L240">				.append(VIEW_DATE_FN).append(&quot;\&quot;)[0];&quot;).append(&quot;\n   dayElement.value = dayValue;&quot;)</span>
<span class="fc" id="L241">				.append(&quot;\n   document.oFormMain.action = \&quot;&quot;)</span>
<span class="fc" id="L242">				.append(adjustFormActionForMode(GroupTextSchedulePM.FORM_ACTION)).append(&quot;\&quot;;&quot;).append(&quot;\n   &quot;)</span>
<span class="fc" id="L243">				.append(JS_REFRESH_WITH_SORT).append(&quot;\n } \n&quot;);</span>
<span class="fc" id="L244">		return sb.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>