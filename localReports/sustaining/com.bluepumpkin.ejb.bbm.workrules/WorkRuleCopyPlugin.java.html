<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WorkRuleCopyPlugin.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.workrules</a> &gt; <span class="el_source">WorkRuleCopyPlugin.java</span></div><h1>WorkRuleCopyPlugin.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.workrules;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.activity.ActivityCopyUtil;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.WorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.WorkRuleException;
import com.bluepumpkin.ejb.bbm.workrules.model.WorkRuleParameter;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.bbm.LinkedObject;
import com.witness.ejb.bbm.ObjectInfo;
import com.witness.ejb.bbm.copy.CopyableObjectPlugin;
import com.witness.ejb.bbm.copy.ejb.CopyDAO;
import com.witness.ejb.bbm.copy.model.CopyResult;
import com.witness.ejb.core.security.PrivilegeKeys;

<span class="nc" id="L33">public class WorkRuleCopyPlugin extends CopyableObjectPlugin {</span>

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;

	public CopyResult copy(ID idWorkRule, ID idOrg, boolean bForce,
			CopyDAO pDAO, String sCopyPrefix) throws BbmException,
			BbmFinderException, BbmCreateException {

		try {
<span class="nc" id="L45">			WorkRuleManager pWRManager = WfmManagerFactory.getWorkRuleManager();</span>
<span class="nc" id="L46">			ActivityManager pActivityManager = WfmManagerFactory.getActivityManager();</span>

			//get the workrule to be copied
<span class="nc" id="L49">			WorkRule pWorkRule =</span>
<span class="nc" id="L50">			        pWRManager.getWorkRuleByID( idWorkRule );</span>

			//get the linked objects (activities)
<span class="nc" id="L53">			ArrayList aidActivities = new ArrayList();</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">			for ( Iterator i = pWorkRule.getWorkRuleParameters().iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L55">				WorkRuleParameter pParam = (WorkRuleParameter) i.next();</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">				if ( pParam.getType() == WorkRuleParameter.ACTIVITY ) {</span>
<span class="nc" id="L57">					ID idActivity = pParam.getActivityIDValue();</span>
<span class="nc" id="L58">					aidActivities.add( idActivity );</span>
				}
<span class="nc" id="L60">			}</span>

<span class="nc" id="L62">			Collection cActivities =</span>
<span class="nc" id="L63">			        pActivityManager.findActivities( aidActivities );</span>

			//see if the activities exists at the new org
<span class="nc" id="L66">			Collection cOrgActivities =</span>
<span class="nc" id="L67">			        pActivityManager.findOrganizationActivities( idOrg, new ActivityFilter() );</span>

<span class="nc" id="L69">			HashMap hFoundActivitiyMappings = new HashMap();</span>
<span class="nc" id="L70">			ArrayList aUnFoundActivies = new ArrayList();</span>

<span class="nc bnc" id="L72" title="All 2 branches missed.">			for ( Iterator j = cActivities.iterator(); j.hasNext(); ) {</span>
<span class="nc" id="L73">				Activity pActivity = (Activity) j.next();</span>
<span class="nc" id="L74">				boolean bFoundMatchedID = false;</span>

<span class="nc bnc" id="L76" title="All 2 branches missed.">				for ( Iterator i = cOrgActivities.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L77">					Activity pActivity2 = (Activity) i.next();</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">					if ( pActivity.getID().equals( pActivity2.getID() ) ) {</span>
<span class="nc" id="L79">						hFoundActivitiyMappings.put( pActivity.getID(), pActivity2.getID() );</span>
<span class="nc" id="L80">						bFoundMatchedID = true;</span>
<span class="nc" id="L81">						break;</span>
					}
<span class="nc" id="L83">				}</span>

				//if not check see if an activity cat with a similar name exists at the new org
<span class="nc bnc" id="L86" title="All 2 branches missed.">				if ( !bFoundMatchedID ) {</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">					for ( Iterator i = cOrgActivities.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L88">						Activity pActivity2 = (Activity) i.next();</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">						if ( isSubString( pActivity.getName(), pActivity2.getName() ) ) {</span>
<span class="nc" id="L90">							hFoundActivitiyMappings.put( pActivity.getID(), pActivity2.getID() );</span>
<span class="nc" id="L91">							bFoundMatchedID = true;</span>
<span class="nc" id="L92">							break;</span>
						}
<span class="nc" id="L94">					}</span>
				}

<span class="nc bnc" id="L97" title="All 2 branches missed.">				if ( !bFoundMatchedID )</span>
<span class="nc" id="L98">					aUnFoundActivies.add( pActivity );</span>
<span class="nc" id="L99">			}</span>

			//if found rename and copy the shift, return COPIED
<span class="nc bnc" id="L102" title="All 2 branches missed.">			if ( aUnFoundActivies.size() == 0 ) {</span>
<span class="nc" id="L103">				ID idWorkRule2 = createCopyWorkRule( pWRManager, pWorkRule, hFoundActivitiyMappings, idOrg, pDAO, sCopyPrefix );</span>
<span class="nc" id="L104">				return new CopyResult();</span>
			}

			//else if bForce, perform a deep copy, return COPIED
<span class="nc bnc" id="L108" title="All 2 branches missed.">			if ( bForce ) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">				for ( Iterator i = aUnFoundActivies.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L110">					ID idActivity = ( (Activity) i.next() ).getID();</span>
<span class="nc" id="L111">					Pair pIDPair = new Pair();</span>
<span class="nc" id="L112">					ActivityCopyUtil.copyActivity( idActivity, idOrg, true, pDAO, pIDPair, sCopyPrefix );</span>
<span class="nc" id="L113">					hFoundActivitiyMappings.put( pIDPair.getFirst(), pIDPair.getSecond() );</span>
<span class="nc" id="L114">				}</span>

<span class="nc" id="L116">				ID idWorkRule2 = createCopyWorkRule( pWRManager, pWorkRule, hFoundActivitiyMappings, idOrg, pDAO, sCopyPrefix );</span>
<span class="nc" id="L117">				return new CopyResult();</span>
			}

			//else return CONFIRM_DEEP_COPY
<span class="nc" id="L121">			Collection cLinkedObjects = new ArrayList();</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">			for ( Iterator i = aUnFoundActivies.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L124">				Activity pActivity = ( (Activity) i.next() );</span>
<span class="nc" id="L125">				cLinkedObjects.add(</span>
<span class="nc" id="L126">				        new LinkedObject( pActivity.getID(), pActivity.getName(), ObjectInfo.BPOBJECT_ACTIVITY,</span>
				        		BbmEjbBundleKey.BUNDLE_NAME, BbmEjbBundleKey.OBJECT_ACTIVITY) );
<span class="nc" id="L128">			}</span>

<span class="nc" id="L130">			return new CopyResult( CopyResult.CONFIRM_DEEP_COPY, cLinkedObjects );</span>
<span class="nc" id="L131">		} catch ( WorkRuleException e ) {</span>
<span class="nc" id="L132">			throw new BbmCreateException( e, &quot;could not get Work Rules&quot; );</span>
<span class="nc" id="L133">		} catch ( BbmEJBCreateException e ) {</span>
<span class="nc" id="L134">			throw new BbmCreateException( e, &quot;could not get Activities&quot; );</span>
<span class="nc" id="L135">		} catch ( RemoteException e ) {</span>
<span class="nc" id="L136">			throw new BbmCreateException( e, &quot;could not get Activities&quot; );</span>
		}
	}

	public boolean isMultiTargetCopyAllowed() {
<span class="nc" id="L141">		return false;</span>
	}

	public String convertType(Localizer localizer, boolean isPlural) {
<span class="nc bnc" id="L145" title="All 2 branches missed.">		String rbKey = isPlural ? BbmEjbBundleKey.OBJECT_WORK_RULE_PLURAL : BbmEjbBundleKey.OBJECT_WORK_RULE; </span>
<span class="nc" id="L146">		return localizer.i18n(BbmEjbBundleKey.BUNDLE_NAME, rbKey);</span>
	}

	public ID getModificationPrivilegeID() {
<span class="nc" id="L150">		return PrivilegeKeys.CORE_VIEWACTIVITIES_ID;</span>
	}

	private ID createCopyWorkRule(WorkRuleManager pWRManager,
			WorkRule pWorkRule, HashMap hActivityMapping, ID idOrg,
			CopyDAO pDAO, String sCopyPrefix) throws RemoteException,
			BbmCreateException, BbmFinderException, WorkRuleException {

		//set the linked objects (activities)
<span class="nc" id="L159">		for (Iterator i = pWorkRule.getWorkRuleParameters().iterator(); i</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">				.hasNext();) {</span>
<span class="nc" id="L161">			WorkRuleParameter pParam = (WorkRuleParameter) i.next();</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">			if (pParam.getType() == WorkRuleParameter.ACTIVITY) {</span>
<span class="nc" id="L163">				ID idActivity = pParam.getActivityIDValue();</span>
<span class="nc" id="L164">				pParam</span>
<span class="nc" id="L165">						.setActivityIDValue((ID) hActivityMapping</span>
<span class="nc" id="L166">								.get(idActivity));</span>
			}
<span class="nc" id="L168">		}</span>

<span class="nc" id="L170">		String sNewName = sCopyPrefix + pWorkRule.getName();</span>
<span class="nc" id="L171">		int nName = 0;</span>

		while (true) {
<span class="nc" id="L174">			boolean bNameIsUnique = pDAO.isNameUnique(sNewName, &quot;WORKRULE&quot;);</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">			if (bNameIsUnique)</span>
<span class="nc" id="L177">				break;</span>
<span class="nc" id="L178">			nName++;</span>
<span class="nc" id="L179">			sNewName = sCopyPrefix + pWorkRule.getName() + &quot; &quot; + nName;</span>
<span class="nc" id="L180">		}</span>

<span class="nc" id="L182">		pWorkRule.setName(sNewName);</span>
<span class="nc" id="L183">		pWorkRule.setOrganization(idOrg);</span>

<span class="nc" id="L185">		return pWRManager.createWorkRule(pWorkRule);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>