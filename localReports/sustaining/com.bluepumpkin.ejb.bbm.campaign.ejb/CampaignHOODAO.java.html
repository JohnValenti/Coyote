<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignHOODAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.campaign.ejb</a> &gt; <span class="el_source">CampaignHOODAO.java</span></div><h1>CampaignHOODAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.campaign.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  dao object to serialize CampaignHOO object
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       lixin zhang
 * @version      1.0
 */

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.NumberFactory;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOO;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOOFieldInfo;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOOPeriod;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignQueue;
import com.bluepumpkin.ejb.bbm.dao.DAOEffectivity;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriodUtil;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.HOOPeriod;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.OrganizationHOO;

public class CampaignHOODAO extends DAOEffectivity&lt;CampaignHOO&gt; {

<span class="fc" id="L47">	private static FieldInfo m_fieldInfo = new CampaignHOOFieldInfo();</span>

	protected FieldInfo getFieldInfo() {
<span class="fc" id="L50">		return m_fieldInfo;</span>
	}

	public CampaignHOODAO() {
<span class="fc" id="L54">		super();</span>
<span class="fc" id="L55">	}</span>

	public CampaignHOODAO(Jdmo dmo) {
<span class="nc" id="L58">		super(dmo);</span>
<span class="nc" id="L59">	}</span>

	protected CampaignHOO createValueObject() {
<span class="nc" id="L62">		return new CampaignHOO();</span>
	}

	/**
	 * get a given campaign's hour's of operations (used in v11)
	 *
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of CampaignHOO objects which hold the assignment
	 *         information
	 * 
	 *         NOTE: If the given campaign is a distributed campaign, this
	 *         method also returns CampaignHOO objects for its sub campaigns as
	 *         well. The CampaignHOO objects that are returned are set with the
	 *         campaign ID of the parent distributed campaign, even if the HOO
	 *         belongs to the sub campaign. This seems like a bug but at the
	 *         time of this comment it wasn't clear if changing that behavior
	 *         was safe or could potentially introduce new bugs.
	 */
	public Collection&lt;CampaignHOO&gt; getCampaignHOOAssignments(ID idCampaign,
			Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L84">		return getCampaignHOOAssignments(idCampaign, dtStart, dtEnd, true);</span>
	}

	/**
	 * get a given campaign's hour's of operations (used in v11)
	 *
	 * @param idCampaign
	 *            : campaign id
	 * @param dtStart
	 *            :
	 * @param dtEnd
	 *            : the time period, null date means a open period
	 * @param includeSubCamps
	 *            : true if you want to include SPHOO's from sub-campaigns as
	 *            well.
	 *
	 * @return a collection of CampaignHOO objects which hold the assignment
	 *         information
	 * 
	 *         NOTE: If the given campaign is a distributed campaign and
	 *         includeSubCamps is true, then this method also returns
	 *         CampaignHOO objects for its sub campaigns as well. The
	 *         CampaignHOO objects that are returned are set with the campaign
	 *         ID of the parent distributed campaign, even if the HOO belongs to
	 *         the sub campaign. This seems like a bug but at the time of this
	 *         comment it wasn't clear if changing that behavior was safe or
	 *         could potentially introduce new bugs.
	 */
	public Collection&lt;CampaignHOO&gt; getCampaignHOOAssignments(ID idCampaign,
			Date dtStart, Date dtEnd, boolean includeSubCamps)
			throws BbmFinderException {
		try {
			// load all campaigns
<span class="fc" id="L117">			ArrayList&lt;CampaignHOO&gt; aAssignments = new ArrayList&lt;CampaignHOO&gt;();</span>

<span class="fc bfc" id="L119" title="All 2 branches covered.">			String query = includeSubCamps ? &quot;SELECT SPHOO.ID, DAY1STARTTIME,DAY1ENDTIME,DAY2STARTTIME,DAY2ENDTIME,DAY3STARTTIME,DAY3ENDTIME,DAY4STARTTIME,DAY4ENDTIME,DAY5STARTTIME,DAY5ENDTIME,DAY6STARTTIME,DAY6ENDTIME,DAY7STARTTIME,DAY7ENDTIME,&quot;</span>
					+ &quot;SPHOO.STARTDATE,SPHOO.ENDDATE,CAMPAIGN.WEEKSTART, B.SID SPID FROM SPHOO,SP A,SP B,CAMPAIGN&quot;
					+ &quot; WHERE CAMPAIGN.SID = &quot;
<span class="fc" id="L122">					+ JdmoUtil.asSqlLiteral(idCampaign)</span>
					+ &quot; AND A.CAMPAIGNID = CAMPAIGN.ID AND &quot;
					+ &quot; ( B.PARENTSPID = A.ID or B.ID = A.ID )&quot;
					+ &quot; AND SPHOO.SPID = B.ID AND B.FROMDATE &lt; '&quot;
<span class="fc" id="L126">					+ JdmoUtil.formatDBString(dtEnd)</span>
					+ &quot;' AND B.TODATE &gt; '&quot;
<span class="fc" id="L128">					+ JdmoUtil.formatDBString(dtStart)</span>
					+ &quot;' ORDER BY SPHOO.STARTDATE ASC&quot;
					: &quot;SELECT SPHOO.ID, DAY1STARTTIME,DAY1ENDTIME,DAY2STARTTIME,DAY2ENDTIME,DAY3STARTTIME,DAY3ENDTIME,DAY4STARTTIME,DAY4ENDTIME,DAY5STARTTIME,DAY5ENDTIME,DAY6STARTTIME,DAY6ENDTIME,DAY7STARTTIME,DAY7ENDTIME,&quot;
							+ &quot;SPHOO.STARTDATE,SPHOO.ENDDATE,CAMPAIGN.WEEKSTART, A.SID SPID FROM SPHOO,SP A,CAMPAIGN&quot;
							+ &quot; WHERE CAMPAIGN.SID = &quot;
<span class="fc" id="L133">							+ JdmoUtil.asSqlLiteral(idCampaign)</span>
							+ &quot; AND A.CAMPAIGNID = CAMPAIGN.ID &quot;
							+ &quot; AND SPHOO.SPID = A.ID AND A.FROMDATE &lt; '&quot;
<span class="fc" id="L136">							+ JdmoUtil.formatDBString(dtEnd)</span>
							+ &quot;' AND A.TODATE &gt; '&quot;
<span class="fc" id="L138">							+ JdmoUtil.formatDBString(dtStart)</span>
							+ &quot;' ORDER BY SPHOO.STARTDATE ASC&quot;;

<span class="fc" id="L141">			JdmoRowset r = m_dmo.createRowset(query);</span>

			// -------------------------------------------------
			// get data and create campaigns
			// -------------------------------------------------

<span class="fc bfc" id="L147" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L148">				int[] nDayOpen = new int[8];</span>
<span class="fc" id="L149">				int[] nDayClose = new int[8];</span>

<span class="fc bfc" id="L151" title="All 2 branches covered.">				for (short n = 1; n &lt;= 7; n++) {</span>
<span class="fc" id="L152">					nDayOpen[n] = r.getInt(&quot;DAY&quot; + n + &quot;STARTTIME&quot;);</span>
<span class="fc" id="L153">					nDayClose[n] = r.getInt(&quot;DAY&quot; + n + &quot;ENDTIME&quot;);</span>
				}

<span class="fc" id="L156">				Date dtStart1 = r.getTimestamp(&quot;STARTDATE&quot;);</span>
<span class="fc" id="L157">				Date dtEnd1 = r.getTimestamp(&quot;ENDDATE&quot;);</span>
<span class="fc" id="L158">				ID idSP = r.getID(&quot;SPID&quot;);</span>
<span class="fc" id="L159">				ID id = r.getID(&quot;ID&quot;);</span>
<span class="fc" id="L160">				int nWeekBoundary = r.getInt(&quot;WEEKSTART&quot;);</span>

<span class="fc" id="L162">				CampaignHOO pAssignment = new CampaignHOO();</span>
<span class="fc" id="L163">				pAssignment.setID(id);</span>
				
				// WARNING: The SQL query above returns sub campaigns as well,
				// but we are setting the campaign ID as the parent campaign
				// ID. Could potentially cause bugs.
<span class="fc" id="L168">				pAssignment.setCampaignID(idCampaign);</span>

<span class="fc" id="L170">				pAssignment.setSPID(idSP);</span>
<span class="fc" id="L171">				pAssignment.setStartTime(dtStart1);</span>
<span class="fc" id="L172">				pAssignment.setEndTime(dtEnd1);</span>
<span class="fc" id="L173">				TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(idCampaign);</span>
<span class="fc" id="L174">				pAssignment.setStartTimeLocal(new LocalDate(dtStart1, tz));</span>
<span class="fc" id="L175">				pAssignment.setEndTimeLocal(new LocalDate(dtEnd1, tz));</span>

<span class="fc" id="L177">				DAOUtil.HOODBtoHOOAssignment(nWeekBoundary, nDayOpen,</span>
						nDayClose, pAssignment);

<span class="fc" id="L180">				aAssignments.add(pAssignment);</span>
<span class="fc" id="L181">			}</span>

<span class="fc" id="L183">			r.close();</span>
<span class="fc" id="L184">			return aAssignments;</span>

<span class="nc" id="L186">		} catch (JdmoException e) {</span>
<span class="nc" id="L187">			e.printStackTrace();</span>
<span class="nc" id="L188">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L190">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * get a campaignHOO object by id
	 */
	public CampaignHOO getCampaignHOOAssignmentByID(ID idAssignment)
			throws BbmFinderException {
		try {
<span class="nc" id="L200">			String strWhere = &quot; SPHOO.ID = '&quot; + idAssignment + &quot;' &quot;;</span>
<span class="nc" id="L201">			Collection&lt;CampaignHOO&gt; col = getCampaignHOOAssignments(strWhere);</span>
			// expecting only one.
<span class="nc bnc" id="L203" title="All 2 branches missed.">			for (CampaignHOO ch : col) {</span>
<span class="nc" id="L204">				return ch;</span>
			}
<span class="nc" id="L206">			return (new CampaignHOO());</span>
<span class="nc" id="L207">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L208">			throw e;</span>
		}
	}

	public Collection&lt;CampaignHOO&gt; getCampaignHOOsByCampaignIDs(
			Collection&lt;ID&gt; campaignIDs, Date minDate, Date maxDate)
			throws BbmFinderException {

<span class="nc" id="L216">		List&lt;CampaignHOO&gt; result = new ArrayList&lt;CampaignHOO&gt;();</span>
<span class="nc bnc" id="L217" title="All 4 branches missed.">		if (campaignIDs == null || campaignIDs.isEmpty()) {</span>
<span class="nc" id="L218">			return result;</span>
		}

<span class="nc bnc" id="L221" title="All 2 branches missed.">		String minDateClause = (minDate != null) ? &quot; AND SPHOO.STARTDATE &lt;= '&quot;</span>
<span class="nc" id="L222">				+ JdmoUtil.formatDBString(maxDate) + &quot;'&quot; : &quot;&quot;;</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">		String maxDateClause = (maxDate != null) ? &quot; AND SPHOO.ENDDATE &gt;= '&quot;</span>
<span class="nc" id="L224">				+ JdmoUtil.formatDBString(minDate) + &quot;'&quot; : &quot;&quot;;</span>

		// build and run the query, and return the results
		try {
<span class="nc" id="L228">			String strWhere = &quot; CAMPAIGN.SID in &quot;</span>
<span class="nc" id="L229">					+ m_dmo.createInClause(campaignIDs) + minDateClause</span>
					+ maxDateClause + &quot; &quot;;
<span class="nc" id="L231">			return (getCampaignHOOAssignments(strWhere));</span>
<span class="nc" id="L232">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L233">			throw e;</span>
<span class="nc" id="L234">		} catch (JdmoException e) {</span>
<span class="nc" id="L235">			e.printStackTrace();</span>
<span class="nc" id="L236">			throw new BbmFinderException(e);</span>
		}
	}

	//ID can be either a string ID or an int ID
	public List&lt;CampaignHOO&gt; getCampaignHOOAssignmentsBySP(ID spId)
			throws BbmFinderException {
		try {
<span class="fc" id="L244">			return getCampaignHOOAssignments(getWhereClauseForSpId(spId));</span>
<span class="nc" id="L245">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L246">			throw e;</span>
		}
	}

	/**
	 * get a given Scheduling Period's hour's of operations (used in v11)
	 *
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of Scheduling Period HOO objects which hold the
	 *         assignment information
	 */
	private List&lt;CampaignHOO&gt; getCampaignHOOAssignments(String strWhere)
			throws BbmFinderException {
		try {
			// load all campaigns
<span class="fc" id="L263">			ArrayList&lt;CampaignHOO&gt; aAssignments = new ArrayList&lt;CampaignHOO&gt;();</span>

<span class="fc" id="L265">			String query = &quot;SELECT SPHOO.ID, DAY1STARTTIME,DAY1ENDTIME,DAY2STARTTIME,DAY2ENDTIME,DAY3STARTTIME,DAY3ENDTIME,DAY4STARTTIME,DAY4ENDTIME,DAY5STARTTIME,DAY5ENDTIME,DAY6STARTTIME,DAY6ENDTIME,DAY7STARTTIME,DAY7ENDTIME,&quot;</span>
					+ &quot;SPHOO.STARTDATE,SPHOO.ENDDATE,CAMPAIGN.SID CSID, CAMPAIGN.WEEKSTART, SP.SID SPID FROM SPHOO,SP,CAMPAIGN&quot;
					+ &quot; WHERE &quot;
					+ strWhere
					+ &quot; AND SP.CAMPAIGNID = CAMPAIGN.ID &quot;
					+ &quot; AND SPHOO.SPID = SP.ID ORDER BY SPHOO.STARTDATE ASC&quot;;

<span class="fc" id="L272">			JdmoRowset r = m_dmo.createRowset(query);</span>

			// -------------------------------------------------
			// Convert rowsets to HOOs
			// -------------------------------------------------

<span class="fc bfc" id="L278" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L279">				int[] nDayOpen = new int[8];</span>
<span class="fc" id="L280">				int[] nDayClose = new int[8];</span>

<span class="fc bfc" id="L282" title="All 2 branches covered.">				for (short n = 1; n &lt;= 7; n++) {</span>
<span class="fc" id="L283">					nDayOpen[n] = r.getInt(&quot;DAY&quot; + n + &quot;STARTTIME&quot;);</span>
<span class="fc" id="L284">					nDayClose[n] = r.getInt(&quot;DAY&quot; + n + &quot;ENDTIME&quot;);</span>
				}

<span class="fc" id="L287">				Date dtStart1 = r.getTimestamp(&quot;STARTDATE&quot;);</span>
<span class="fc" id="L288">				Date dtEnd1 = r.getTimestamp(&quot;ENDDATE&quot;);</span>
<span class="fc" id="L289">				ID id = r.getID(&quot;ID&quot;);</span>
<span class="fc" id="L290">				ID idSP = r.getID(&quot;SPID&quot;);</span>
<span class="fc" id="L291">				ID idCampaign = r.getID(&quot;CSID&quot;);</span>
<span class="fc" id="L292">				int nWeekBoundary = r.getInt(&quot;WEEKSTART&quot;);</span>

<span class="fc" id="L294">				CampaignHOO pAssignment = new CampaignHOO();</span>
<span class="fc" id="L295">				pAssignment.setID(id);</span>
<span class="fc" id="L296">				pAssignment.setCampaignID(idCampaign);</span>
<span class="fc" id="L297">				pAssignment.setSPID(idSP);</span>
<span class="fc" id="L298">				pAssignment.setStartTime(dtStart1);</span>
<span class="fc" id="L299">				pAssignment.setEndTime(dtEnd1);</span>
<span class="fc" id="L300">				TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(idCampaign);</span>
<span class="fc" id="L301">				pAssignment.setStartTimeLocal(new LocalDate(dtStart1, tz));</span>
<span class="fc" id="L302">				pAssignment.setEndTimeLocal(new LocalDate(dtEnd1, tz));</span>

<span class="fc" id="L304">				int dayIndex /* 1-Sun... */= nWeekBoundary / 1440 + 1;</span>
<span class="fc" id="L305">				int dayOffset = nWeekBoundary % 1440;</span>
				// int firstDayIndex /*1-Sun...*/ = dayIndex;
<span class="fc bfc" id="L307" title="All 2 branches covered.">				for (short n = 1; n &lt;= 7; n++) {</span>

<span class="fc bfc" id="L309" title="All 2 branches covered.">					if (dayIndex &gt; 7)</span>
<span class="fc" id="L310">						dayIndex = 1;</span>
<span class="fc bfc" id="L311" title="All 2 branches covered.">					if (nDayOpen[n] == -1)</span>
<span class="fc" id="L312">						pAssignment.setActive((short) dayIndex, false);</span>
					else {
<span class="fc bfc" id="L314" title="All 2 branches covered.">						short open = (short) (((nDayOpen[n] == 0) ? 0</span>
								: nDayOpen[n] % 1440) + dayOffset);
<span class="fc bfc" id="L316" title="All 2 branches covered.">						short close = (short) (((nDayClose[n] % 1440 == 0) ? 1440</span>
								: nDayClose[n] % 1440) + dayOffset);

<span class="fc" id="L319">						pAssignment.setDayOpen((short) dayIndex, open);</span>
<span class="fc" id="L320">						pAssignment.setDayClose((short) dayIndex, close);</span>
					}
<span class="fc" id="L322">					++dayIndex;</span>
				}
<span class="fc" id="L324">				aAssignments.add(pAssignment);</span>
<span class="fc" id="L325">			}</span>

<span class="fc" id="L327">			r.close();</span>
<span class="fc" id="L328">			return aAssignments;</span>

<span class="nc" id="L330">		} catch (JdmoException e) {</span>
<span class="nc" id="L331">			e.printStackTrace();</span>
<span class="nc" id="L332">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L334">			m_dmo.cleanUp();</span>
		}
	}

	public ID createCampaignHOOAssignment(CampaignHOO campaignHOO)
			throws BbmCreateException {
		// convert CampaignHOO to SPHOO - campaign hoo are
<span class="fc" id="L341">		short spDayOpen[] = new short[8];</span>
<span class="fc" id="L342">		short spDayClose[] = new short[8];</span>
		short sspDayOpen, sspDayClose;
		int spWeekDay, spWeekDayMinsOffset;
<span class="fc" id="L345">		int weekStart = 0;</span>
<span class="fc" id="L346">		int dayBoundaryOffset = 0;</span>
		try {
<span class="fc" id="L348">			CampaignDAO campDAO = new CampaignDAO(m_dmo);</span>
<span class="fc" id="L349">			Campaign camp = campDAO.getCampaignByID(</span>
<span class="fc" id="L350">					campaignHOO.getCampaignID(), false);</span>
<span class="fc" id="L351">			TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(campaignHOO</span>
<span class="fc" id="L352">					.getCampaignID());</span>

<span class="fc" id="L354">			Date startGMTDt = TimePeriodUtil</span>
<span class="fc" id="L355">					.convertToGMTFromLocalDateTimeInTimeZone(</span>
<span class="fc" id="L356">							campaignHOO.getStartTimeLocal(), tz);</span>
<span class="fc" id="L357">			Date endGMTDt = TimePeriodUtil</span>
<span class="fc" id="L358">					.convertToGMTFromLocalDateTimeInTimeZone(</span>
<span class="fc" id="L359">							campaignHOO.getEndTimeLocal(), tz);</span>

<span class="fc" id="L361">			weekStart = (camp.getWeekStart() / 1440) + 1;</span>
<span class="fc" id="L362">			dayBoundaryOffset = camp.getWeekStart() % 1440;</span>
<span class="fc bfc" id="L363" title="All 2 branches covered.">			for (short i = 1; i &lt; 8; i++) {</span>
<span class="fc" id="L364">				sspDayOpen = campaignHOO.getDayOpen(i);</span>
<span class="fc" id="L365">				sspDayClose = campaignHOO.getDayClose(i);</span>

<span class="fc" id="L367">				spWeekDay = (i + 8 - weekStart) % 7;</span>
<span class="fc bfc" id="L368" title="All 2 branches covered.">				if (spWeekDay == 0)</span>
<span class="fc" id="L369">					spWeekDay = 7;</span>
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">				if (sspDayOpen == -1) {</span>
<span class="fc" id="L371">					spDayOpen[spWeekDay] = -1;</span>
<span class="fc" id="L372">					spDayClose[spWeekDay] = -1;</span>
				} else {
<span class="nc" id="L374">					spWeekDayMinsOffset = (spWeekDay - 1) * 1440</span>
							- dayBoundaryOffset;
<span class="nc" id="L376">					spDayOpen[spWeekDay] = (short) (spWeekDayMinsOffset + sspDayOpen);</span>
<span class="nc" id="L377">					spDayClose[spWeekDay] = (short) (spWeekDayMinsOffset + sspDayClose);</span>
				}
			} // end of for loop for setting days start and end values.

			// get ID from DE
<span class="fc" id="L382">			String idStr = DAOUtil.getDEID(m_dmo);</span>

<span class="fc" id="L384">			String pStmt1 = &quot;insert into SPHOO &quot;</span>
					+ &quot;(ID,SPID,STARTDATE,ENDDATE,&quot;
					+ &quot;DAY1STARTTIME,DAY1ENDTIME,&quot;
					+ &quot;DAY2STARTTIME,DAY2ENDTIME,&quot;
					+ &quot;DAY3STARTTIME,DAY3ENDTIME,&quot;
					+ &quot;DAY4STARTTIME,DAY4ENDTIME,&quot;
					+ &quot;DAY5STARTTIME,DAY5ENDTIME,&quot;
					+ &quot;DAY6STARTTIME,DAY6ENDTIME,&quot;
					+ &quot;DAY7STARTTIME,DAY7ENDTIME) &quot;
					+ &quot;values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;

<span class="fc" id="L395">			Object[] param = new Object[18];</span>
<span class="fc" id="L396">			param[0] = idStr;</span>
<span class="fc" id="L397">			param[1] = getDEIDFromSID(&quot;SP&quot;, campaignHOO.getSPID());</span>
<span class="fc" id="L398">			param[2] = JdmoUtil.formatDBString(startGMTDt);</span>
<span class="fc" id="L399">			param[3] = JdmoUtil.formatDBString(endGMTDt);</span>
<span class="fc bfc" id="L400" title="All 2 branches covered.">			for (int j = 1; j &lt; 8; j++) {</span>
<span class="fc" id="L401">				param[(j * 2) + 2] = NumberFactory.newInteger(spDayOpen[j]);</span>
<span class="fc" id="L402">				param[(j * 2) + 3] = NumberFactory.newInteger(spDayClose[j]);</span>
			}

<span class="fc" id="L405">			m_dmo.executePCommand(pStmt1, param);</span>

<span class="fc" id="L407">			ID DESubSPID = null;</span>
<span class="fc" id="L408">			ID parentID = getDEIDFromSID(&quot;SP&quot;, campaignHOO.getSPID());</span>
<span class="fc" id="L409">			String stmtSubCamps = &quot;SELECT SP.ID, CAMPAIGN.SID FROM SP, CAMPAIGN WHERE campaign.id = sp.campaignid AND PARENTSPID = '&quot;</span>
					+ parentID + &quot;'&quot;;
<span class="fc" id="L411">			JdmoRowset rsSubSPs = m_dmo.createRowset(stmtSubCamps);</span>
<span class="fc bfc" id="L412" title="All 2 branches covered.">			while (rsSubSPs.next()) {</span>
<span class="fc" id="L413">				DESubSPID = rsSubSPs.getID(1);</span>
<span class="fc" id="L414">				ID subCampID = rsSubSPs.getID(2);</span>
<span class="fc" id="L415">				tz = CampaignDAO.getTimeZoneByCampaignID(subCampID);</span>
<span class="fc" id="L416">				startGMTDt = TimePeriodUtil</span>
<span class="fc" id="L417">						.convertToGMTFromLocalDateTimeInTimeZone(</span>
<span class="fc" id="L418">								campaignHOO.getStartTimeLocal(), tz);</span>
<span class="fc" id="L419">				endGMTDt = TimePeriodUtil</span>
<span class="fc" id="L420">						.convertToGMTFromLocalDateTimeInTimeZone(</span>
<span class="fc" id="L421">								campaignHOO.getEndTimeLocal(), tz);</span>

<span class="fc" id="L423">				String hooIDStr = DAOUtil.getDEID(m_dmo);</span>

<span class="fc" id="L425">				String pStmt2 = &quot;insert into SPHOO &quot;</span>
						+ &quot;(ID,SPID,STARTDATE,ENDDATE,&quot;
						+ &quot;DAY1STARTTIME,DAY1ENDTIME,&quot;
						+ &quot;DAY2STARTTIME,DAY2ENDTIME,&quot;
						+ &quot;DAY3STARTTIME,DAY3ENDTIME,&quot;
						+ &quot;DAY4STARTTIME,DAY4ENDTIME,&quot;
						+ &quot;DAY5STARTTIME,DAY5ENDTIME,&quot;
						+ &quot;DAY6STARTTIME,DAY6ENDTIME,&quot;
						+ &quot;DAY7STARTTIME,DAY7ENDTIME) &quot;
						+ &quot;values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;

<span class="fc" id="L436">				Object[] param2 = new Object[18];</span>
<span class="fc" id="L437">				param2[0] = hooIDStr;</span>
<span class="fc" id="L438">				param2[1] = DESubSPID;</span>
<span class="fc" id="L439">				param2[2] = JdmoUtil.formatDBString(startGMTDt);</span>
<span class="fc" id="L440">				param2[3] = JdmoUtil.formatDBString(endGMTDt);</span>
<span class="fc bfc" id="L441" title="All 2 branches covered.">				for (int j = 1; j &lt; 8; j++) {</span>
<span class="fc" id="L442">					param2[(j * 2) + 2] = NumberFactory</span>
<span class="fc" id="L443">							.newInteger(spDayOpen[j]);</span>
<span class="fc" id="L444">					param2[(j * 2) + 3] = NumberFactory</span>
<span class="fc" id="L445">							.newInteger(spDayClose[j]);</span>
				}
<span class="fc" id="L447">				int test = 3;</span>
<span class="fc" id="L448">				test++;</span>
<span class="fc" id="L449">				System.out.print(test);</span>
<span class="fc" id="L450">				m_dmo.executePCommand(pStmt2, param2);</span>
<span class="fc" id="L451">			}</span>

<span class="fc" id="L453">			return new ID(idStr);</span>

<span class="nc" id="L455">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L456">			throw new BbmCreateException(e);</span>
<span class="nc" id="L457">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L458">			throw new BbmCreateException(e);</span>
<span class="nc" id="L459">		} catch (JdmoException e) {</span>
<span class="nc" id="L460">			throw new BbmCreateException(e);</span>
		} finally {
<span class="pc" id="L462">			m_dmo.cleanUp();</span>
		}
	}

	private ID getDEIDFromSID(String TableName, ID sidValue)
			throws JdmoException {

<span class="fc" id="L469">		ID DEID = null;</span>
<span class="fc" id="L470">		String stmt = &quot;SELECT ID FROM &quot; + TableName + &quot; WHERE SID='&quot; + sidValue</span>
				+ &quot;'&quot;;
<span class="fc" id="L472">		JdmoRowset rs = m_dmo.createRowset(stmt);</span>
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">		if (rs.next()) {</span>
<span class="fc" id="L474">			DEID = rs.getID(1);</span>
		}
<span class="fc" id="L476">		return DEID;</span>
	}

	/** update a campaign's HOO assignment */
	public void updateCampaignHOOAssignment(CampaignHOO campaignHOO)
			throws BbmUpdateException {
<span class="fc" id="L482">		short spDayOpen[] = new short[8];</span>
<span class="fc" id="L483">		short spDayClose[] = new short[8];</span>
		short sspDayOpen, sspDayClose;
		int spWeekDay, spWeekDayMinsOffset;
<span class="fc" id="L486">		int weekStart = 0;</span>
<span class="fc" id="L487">		int dayBoundaryOffset = 0;</span>
		try {
<span class="fc" id="L489">			CampaignDAO campDAO = new CampaignDAO(m_dmo);</span>
<span class="fc" id="L490">			Campaign camp = campDAO.getCampaignByID(</span>
<span class="fc" id="L491">					campaignHOO.getCampaignID(), false);</span>

<span class="fc" id="L493">			weekStart = (camp.getWeekStart() / 1440) + 1;</span>
<span class="fc" id="L494">			dayBoundaryOffset = camp.getWeekStart() % 1440;</span>
<span class="fc bfc" id="L495" title="All 2 branches covered.">			for (short i = 1; i &lt; 8; i++) {</span>
<span class="fc" id="L496">				sspDayOpen = campaignHOO.getDayOpen(i);</span>
<span class="fc" id="L497">				sspDayClose = campaignHOO.getDayClose(i);</span>

<span class="fc" id="L499">				spWeekDay = (i + 8 - weekStart) % 7;</span>
<span class="fc bfc" id="L500" title="All 2 branches covered.">				if (spWeekDay == 0)</span>
<span class="fc" id="L501">					spWeekDay = 7;</span>
<span class="fc bfc" id="L502" title="All 2 branches covered.">				if (sspDayOpen == -1) {</span>
<span class="fc" id="L503">					spDayOpen[spWeekDay] = -1;</span>
<span class="fc" id="L504">					spDayClose[spWeekDay] = -1;</span>
				} else {
<span class="fc" id="L506">					spWeekDayMinsOffset = (spWeekDay - 1) * 1440</span>
							- dayBoundaryOffset;
<span class="fc" id="L508">					spDayOpen[spWeekDay] = (short) (spWeekDayMinsOffset + sspDayOpen);</span>
<span class="fc" id="L509">					spDayClose[spWeekDay] = (short) (spWeekDayMinsOffset + sspDayClose);</span>
				}
			} // end of for loop for setting days start and end values.
			String strUpdate;
<span class="fc" id="L513">			strUpdate = &quot;update SPHOO set  &quot; + &quot; DAY1STARTTIME= &quot;</span>
					+ spDayOpen[1] + &quot;, DAY1ENDTIME= &quot; + spDayClose[1]
					+ &quot;, DAY2STARTTIME= &quot; + spDayOpen[2] + &quot;, DAY2ENDTIME= &quot;
					+ spDayClose[2] + &quot;, DAY3STARTTIME= &quot; + spDayOpen[3]
					+ &quot;, DAY3ENDTIME= &quot; + spDayClose[3] + &quot;, DAY4STARTTIME= &quot;
					+ spDayOpen[4] + &quot;, DAY4ENDTIME= &quot; + spDayClose[4]
					+ &quot;, DAY5STARTTIME= &quot; + spDayOpen[5] + &quot;, DAY5ENDTIME= &quot;
					+ spDayClose[5] + &quot;, DAY6STARTTIME= &quot; + spDayOpen[6]
					+ &quot;, DAY6ENDTIME= &quot; + spDayClose[6] + &quot;, DAY7STARTTIME= &quot;
					+ spDayOpen[7] + &quot;, DAY7ENDTIME= &quot; + spDayClose[7]
<span class="fc" id="L523">					+ &quot; WHERE ID = '&quot; + campaignHOO.getID().toString() + &quot;'&quot;;</span>
<span class="fc" id="L524">			m_dmo.executeCommand(strUpdate.toString());</span>
<span class="nc" id="L525">		} catch (Exception e) {</span>
<span class="nc" id="L526">			throw new BbmUpdateException(e);</span>
<span class="fc" id="L527">		}</span>
<span class="fc" id="L528">	}</span>

	/** delete a campaign's HOO assignment given the assignment ids */
	public void deleteCampaignHOOAssignments(Collection&lt;ID&gt; colIDAssignments)
			throws BbmRemoveException {
<span class="nc" id="L533">		deleteObjects(colIDAssignments);</span>
<span class="nc" id="L534">	}</span>

	/**
	 * create campaign HOO based on its linked organization HOO.
	 *
	 * 1. do not create any campaignHOO if the campaign already has an hours of
	 * operation. 2. set campaign HOO to be the same as the organization HOO if
	 * they have the same time zone.
	 *
	 * @return the campaignHOO ID if created successfully
	 */
	public ID createCampaignHOOFromOrg(ID idCampaign, ID idOrg)
			throws Exception {
		// 1. do not create any campaignHOO if the campaign already has
		// an hours of operation.
<span class="nc" id="L549">		Collection col = getCampaignHOOAssignments(idCampaign, null, null);</span>
<span class="nc bnc" id="L550" title="All 4 branches missed.">		if (col != null &amp;&amp; (!col.isEmpty()))</span>
<span class="nc" id="L551">			return null;</span>

		// 2. check if the time zone are the same
<span class="nc" id="L554">		CampaignDAO daoCampaign = new CampaignDAO(m_dmo);</span>
<span class="nc" id="L555">		Campaign cp = daoCampaign.getCampaignByID(idCampaign, false);</span>

<span class="nc" id="L557">		WorkResourceManager wrMgr = BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L558">		Organization org = wrMgr.getOrganizationByID(idOrg);</span>

<span class="nc bnc" id="L560" title="All 2 branches missed.">		if (!cp.getTimeZone().equals(org.getTimeZone()))</span>
<span class="nc" id="L561">			return null;</span>

		// 3. get Organization HOO
<span class="nc" id="L564">		Date dtValue = cp.getStartTime();</span>
<span class="nc" id="L565">		col = wrMgr</span>
<span class="nc" id="L566">				.getOrganizationHOOAssignments(org.getID(), dtValue, dtValue);</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">		if (col.isEmpty())</span>
<span class="nc" id="L568">			return null;</span>

<span class="nc" id="L570">		OrganizationHOO orgHOO = (OrganizationHOO) col.iterator().next();</span>
<span class="nc" id="L571">		CampaignHOO cpHOO = new CampaignHOO();</span>

<span class="nc" id="L573">		cpHOO.setCampaignID(idCampaign);</span>
<span class="nc" id="L574">		cpHOO.setStartTime(dtValue);</span>

<span class="nc bnc" id="L576" title="All 2 branches missed.">		for (short iDay = 1; iDay &lt;= 7; iDay++) {</span>
<span class="nc" id="L577">			cpHOO.setDayOpen(iDay, orgHOO.getDayOpen(iDay));</span>
<span class="nc" id="L578">			cpHOO.setDayClose(iDay, orgHOO.getDayClose(iDay));</span>
		}

<span class="nc" id="L581">		return createObject(cpHOO);</span>
	}

	/**
	 * fetch a collection of HOO for the given campaign and using campaign TZ to
	 * prepare the HOOPeriod object. HOOPeriod differ from HOO since it is not a
	 * template but a daily definition of HOO in the given period.
	 */
	public HOOPeriod getHOOPeriod(ID idCampaign, Date dtStart, Date dtEnd)
			throws BbmFinderException {
		// get campaign, need the campaign time zone
<span class="fc" id="L592">		CampaignDAO cpDAO = new CampaignDAO(m_dmo);</span>
<span class="fc" id="L593">		Campaign cp = cpDAO.getCampaignByID(idCampaign, false);</span>

<span class="fc" id="L595">		Collection&lt;CampaignHOO&gt; colAssignments = this.getCampaignHOOAssignments(idCampaign,</span>
				dtStart, dtEnd);
<span class="fc" id="L597">		return new CampaignHOOPeriod(dtStart, dtEnd, cp.getTimeZone(),</span>
				colAssignments);
	}

	
	static String getWhereClauseForSpId(ID spId) {
<span class="fc" id="L603">		String strWhere = &quot;&quot;;</span>
<span class="pc bpc" id="L604" title="1 of 2 branches missed.">		if (spId.isInt()) {</span>
<span class="fc" id="L605">			strWhere = &quot; SP.SID = &quot; + JdmoUtil.asSqlLiteral(spId) + &quot; &quot;;</span>
		} else {
<span class="nc" id="L607">			strWhere = &quot; SP.ID = &quot; + JdmoUtil.asSqlLiteral(spId) + &quot; &quot;;</span>
		}
<span class="fc" id="L609">		return strWhere;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>