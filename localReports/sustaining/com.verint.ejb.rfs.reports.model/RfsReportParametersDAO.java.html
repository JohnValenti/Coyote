<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RfsReportParametersDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.ejb.rfs.reports.model</a> &gt; <span class="el_source">RfsReportParametersDAO.java</span></div><h1>RfsReportParametersDAO.java</h1><pre class="source lang-java linenums">package com.verint.ejb.rfs.reports.model;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;

import com.bluepumpkin.common.base.Log;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.verint.ejb.rfs.dbconfig.RfsDBConnection;

public class RfsReportParametersDAO {
<span class="nc" id="L19">	public static Category m_cat = Log.initCategory(RfsReportParametersDAO.class.getName());</span>
<span class="nc" id="L20">	private Jdmo m_dmo = null;</span>
	
<span class="nc" id="L22">	public RfsReportParametersDAO() {</span>
		try {
<span class="nc" id="L24">			m_dmo = new RfsDBConnection().getJdmoInstance();</span>
<span class="nc" id="L25">		} catch(Exception e) {</span>
<span class="nc" id="L26">			m_cat.error(&quot;Error in RfsReportParametersDAO() : &quot;, e);</span>
<span class="nc" id="L27">		}</span>
<span class="nc" id="L28">	}</span>
	
	/**
	 * Scenario Picker
	 * @return
	 */
	public ArrayList&lt;StringsPair&gt; getScenarios() {
<span class="nc" id="L35">		ArrayList&lt;StringsPair&gt; scenarios = new ArrayList&lt;StringsPair&gt;();</span>
		JdmoRowset rs;
	       try {			
<span class="nc" id="L38">	    	   String query = &quot;SELECT Id, Name FROM dbo.Scenarios order by Name&quot;;</span>
<span class="nc" id="L39">				m_cat.debug(&quot;getValue: query = &quot;+query);</span>
				
<span class="nc" id="L41">				rs = m_dmo.createRowset(query);</span>
				
<span class="nc bnc" id="L43" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L44">					StringsPair scnr = new StringsPair();</span>
<span class="nc" id="L45">					scnr.setKey(rs.getString(&quot;Id&quot;));</span>
<span class="nc" id="L46">					scnr.setValue(rs.getString(&quot;Name&quot;));</span>
<span class="nc" id="L47">					scenarios.add(scnr);</span>
<span class="nc" id="L48">				}</span>
<span class="nc" id="L49">			} catch (Exception se) {</span>
<span class="nc" id="L50">				m_cat.error(&quot;Error in RfsReportParametersDAO.getScenarios() : &quot;,se);</span>
			} finally {
<span class="nc" id="L52">				cleanUp();</span>
<span class="nc" id="L53">			}</span>
<span class="nc" id="L54">			return scenarios;</span>
	}
    
	/**
	 * Year picker
	 * @return
	 */
	
	public ArrayList&lt;StringsPair&gt; getYearsList() {
<span class="nc" id="L63">	  ArrayList&lt;StringsPair&gt; lYears = new ArrayList&lt;StringsPair&gt;();</span>
	   
     try {
			
			JdmoRowset rs;
							
<span class="nc" id="L69">			String query = &quot;with yearlist as &quot;</span>
					+ &quot;(SELECT YEAR(GETDATE())-5 as year&quot;
					+ &quot; UNION ALL &quot;
					+ &quot; SELECT yl.year + 1 as year&quot;
					+ &quot;   FROM yearlist yl&quot;
					+ &quot;  WHERE yl.year + 1 &lt;= YEAR(GetDate())+5 &quot;
					+ &quot;)&quot;
					+ &quot; SELECT year as Id, year as Name FROM yearlist order by year&quot;;
			
			//m_cat.debug(&quot;getValue: query = &quot;+query);
			
<span class="nc" id="L80">			rs = m_dmo.createRowset(query);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">			while(rs.next()) {</span>
<span class="nc" id="L82">				StringsPair year = new StringsPair();</span>
<span class="nc" id="L83">				year.setKey(new ID(rs.getString(&quot;Id&quot;)).toString());</span>
<span class="nc" id="L84">				year.setValue(rs.getString(&quot;Name&quot;));</span>
<span class="nc" id="L85">				lYears.add(year);</span>
<span class="nc" id="L86">			}</span>
<span class="nc" id="L87">		} catch (Exception se) {</span>
<span class="nc" id="L88">			m_cat.error(&quot;Error in RfsReportParametersDAO.getYearsList() : &quot;,se);</span>
		} finally {
<span class="nc" id="L90">			cleanUp();</span>
<span class="nc" id="L91">		}</span>
<span class="nc" id="L92">		return lYears;</span>
	}
	
	public ArrayList&lt;StringsPair&gt; getBusinessUnits(String scenario) {
<span class="nc" id="L96">		  ArrayList&lt;StringsPair&gt; lBu = new ArrayList&lt;StringsPair&gt;();</span>
		   
	     try {
				JdmoRowset rs;
								
<span class="nc" id="L101">				StringBuilder pStmt = new StringBuilder();</span>
				
<span class="nc" id="L103">				pStmt.append(&quot;SELECT  Branch, Label &quot;);</span>
<span class="nc" id="L104">				pStmt.append(&quot; FROM dbo.BranchViewNodes &quot;);</span>
<span class="nc" id="L105">				pStmt.append(&quot; WHERE BranchView IN (SELECT Id FROM dbo.BranchViews where Scenario = ?) AND Branch is NOT NULL &quot;);</span>
				
<span class="nc" id="L107">				JdmoQuery query = m_dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L108">				query.setParInt(1, Integer.parseInt(scenario));</span>

<span class="nc" id="L110">				rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L112">					StringsPair bu = new StringsPair();</span>
<span class="nc" id="L113">					bu.setKey(rs.getString(&quot;Branch&quot;));</span>
<span class="nc" id="L114">					bu.setValue(rs.getString(&quot;Label&quot;));</span>
<span class="nc" id="L115">					lBu.add(bu);</span>
<span class="nc" id="L116">				}</span>
<span class="nc" id="L117">			} catch (Exception se) {</span>
<span class="nc" id="L118">				m_cat.error(&quot;Error in RfsReportParametersDAO.getBusinessUnits() : &quot;,se);</span>
			} finally {
<span class="nc" id="L120">				cleanUp();</span>
<span class="nc" id="L121">			}</span>
<span class="nc" id="L122">			return lBu;		</span>
	}
	
	/**
	 * Position picker
	 * @param scenario
	 * @param businessUnits
	 * @return
	 */
	public ArrayList&lt;StringsPair&gt; getResourceClasses(String scenario, String businessUnits,boolean includeAllOption) {
<span class="nc" id="L132">		  ArrayList&lt;StringsPair&gt; lResourceClasses = new ArrayList&lt;StringsPair&gt;();</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">		  if(!businessUnits.equals(&quot;&quot;)) {</span>
			  try {
				JdmoRowset rs;
								
<span class="nc" id="L137">				StringBuilder pStmt = new StringBuilder();</span>
				
<span class="nc" id="L139">				pStmt.append(&quot;SELECT  Id, Name &quot;)</span>
<span class="nc" id="L140">						.append(&quot; FROM dbo.ResourceClasses WHERE Id IN (&quot;)</span>
<span class="nc" id="L141">						.append(&quot;SELECT DISTINCT ResourceClass &quot;)</span>
<span class="nc" id="L142">						.append(&quot;  FROM dbo.EffectiveResourceTypes()&quot;)</span>
<span class="nc" id="L143">						.append(&quot; WHERE Branch IN (SELECT value FROM dbo.TokensBy(?,',')) AND Reportable = 1) &quot;)</span>
<span class="nc" id="L144">						.append(&quot; ORDER BY DisplayOrder &quot;);</span>
				//m_cat.debug(&quot;getValue: query = &quot;+query);
<span class="nc" id="L146">				JdmoQuery query = m_dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L147">				query.setParString(1,businessUnits);</span>
<span class="nc" id="L148">				int i = 0;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">				if(includeAllOption)</span>
<span class="nc" id="L150">					lResourceClasses.add(0,new StringsPair());</span>
				else
<span class="nc" id="L152">					i = -1;</span>
<span class="nc" id="L153">				rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L155">					StringsPair resourceClass = new StringsPair();					</span>
<span class="nc" id="L156">					resourceClass.setKey(new ID(rs.getInt(&quot;Id&quot;)).toString());</span>
<span class="nc" id="L157">					resourceClass.setValue(rs.getString(&quot;Name&quot;));</span>
<span class="nc" id="L158">					lResourceClasses.add(++i, resourceClass);</span>
<span class="nc" id="L159">				}</span>
<span class="nc" id="L160">			} catch (Exception se) {</span>
<span class="nc" id="L161">				m_cat.error(&quot;Error in RfsReportParametersDAO.getResourceClasses() : &quot;,se);</span>
			} finally {
<span class="nc" id="L163">				cleanUp();</span>
<span class="nc" id="L164">			}</span>
		  }
<span class="nc" id="L166">		return lResourceClasses;		</span>
	}
	
	/**
	 * Resources picker (Forecast resources, history resources, transaction forecasts or duration forecast)
	 * @param scenario
	 * @param resourceType
	 * @return
	 */
	public ArrayList&lt;StringsPair&gt; getResources(String scenario, String resourceType, boolean useProdForecasts) {
<span class="nc" id="L176">		  ArrayList&lt;StringsPair&gt; lForecasts = new ArrayList&lt;StringsPair&gt;();</span>
		   
	     try {
				JdmoRowset rs;
								
<span class="nc" id="L181">				StringBuilder pStmt = new StringBuilder();</span>
				
<span class="nc" id="L183">				pStmt.append(&quot;SELECT Id, Name &quot;);</span>
<span class="nc" id="L184">				pStmt.append(&quot;  FROM dbo.Results &quot;);</span>
<span class="nc" id="L185">				pStmt.append(&quot; WHERE Scenario = ? AND Type = ?&quot;);</span>
				
<span class="nc bnc" id="L187" title="All 2 branches missed.">				if(useProdForecasts) {</span>
<span class="nc" id="L188">					pStmt.append(&quot; AND UsageType = 'Prod.'&quot;);</span>
				}
<span class="nc" id="L190">				pStmt.append(&quot; ORDER BY Changed DESC &quot;);</span>
				//m_cat.debug(&quot;getValue: query = &quot;+query);
<span class="nc" id="L192">				JdmoQuery query = m_dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L193">				query.setParInt(1, Integer.parseInt(scenario));</span>
<span class="nc" id="L194">				query.setParString(2, resourceType);</span>
<span class="nc" id="L195">				rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L197">					StringsPair forecast = new StringsPair();</span>
<span class="nc" id="L198">					forecast.setKey(new ID(rs.getString(&quot;Id&quot;)).toString());</span>
<span class="nc" id="L199">					forecast.setValue(rs.getString(&quot;Name&quot;));</span>
<span class="nc" id="L200">					lForecasts.add(forecast);</span>
<span class="nc" id="L201">				}</span>
<span class="nc" id="L202">			} catch (Exception se) {</span>
<span class="nc" id="L203">				m_cat.error(&quot;Error in RfsReportParametersDAO.getResources() : &quot;,se);</span>
			} finally {
<span class="nc" id="L205">				cleanUp();</span>
<span class="nc" id="L206">			}</span>
<span class="nc" id="L207">			return lForecasts;		</span>
	}
	
	/**
	 * Staff mixes picker (Planned, budget, actual )
	 * @param scenario
	 * @param businessUnits
	 * @param staffMixType
	 * @return
	 */
	public ArrayList&lt;StringsPair&gt; getStaffMixes(String scenario, String businessUnits, int staffMixType) {
		
<span class="nc" id="L219">		ArrayList&lt;StringsPair&gt; staffMixResults = new ArrayList&lt;StringsPair&gt;();		 </span>
	     try {
				JdmoRowset rs;
<span class="nc" id="L222">				JdmoQuery query = m_dmo.createQuery(&quot;dbo.PickStaffMixResult&quot;, Jdmo.STORPROC_QUERY);</span>
<span class="nc" id="L223">				query.setParInt(1, Integer.parseInt(scenario));</span>
<span class="nc" id="L224">				query.setParString(2, &quot;&quot;);</span>
<span class="nc" id="L225">				query.setParString(3, &quot;,&quot;);</span>
<span class="nc" id="L226">				query.setParInt(4, staffMixType);</span>
<span class="nc" id="L227">				query.setParString(5, &quot;&quot;);</span>
<span class="nc" id="L228">				query.setParInt(6, 0);</span>
<span class="nc" id="L229">				query.setParInt(7, 0);</span>
				
<span class="nc" id="L231">				rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
				
<span class="nc bnc" id="L233" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L234">					StringsPair staffMix = new StringsPair();</span>
<span class="nc" id="L235">					staffMix.setKey(new ID(rs.getInt(&quot;Id&quot;)).toString());</span>
<span class="nc" id="L236">					staffMix.setValue(rs.getString(&quot;Name&quot;));</span>
<span class="nc" id="L237">					staffMixResults.add(staffMix);</span>
<span class="nc" id="L238">				}</span>
<span class="nc" id="L239">			} catch (Exception se) {</span>
<span class="nc" id="L240">				m_cat.error(&quot;Error in RfsReportParametersDAO.getStaffMixes() : &quot;,se);</span>
			} finally {
<span class="nc" id="L242">				cleanUp();</span>
<span class="nc" id="L243">			}</span>
<span class="nc" id="L244">			return staffMixResults;</span>
	}

	/** 
	 * Work groups for the staff mix picker
	 * @param staffMixResult
	 * @return
	 */
	public ArrayList&lt;StringsPair&gt; getWorkgroups(String staffMixResult) {
<span class="nc" id="L253">		ArrayList&lt;StringsPair&gt; workgroups = new ArrayList&lt;StringsPair&gt;();</span>
	     try {
<span class="nc bnc" id="L255" title="All 2 branches missed.">	    	 	if (staffMixResult != null) {</span>
					JdmoRowset rs;
<span class="nc" id="L257">					JdmoQuery query = m_dmo.createQuery(&quot;dbo.GetStaffMixResultResourceGroupClasses&quot;, Jdmo.STORPROC_QUERY);</span>
<span class="nc" id="L258">					query.setParInt(1, Integer.parseInt(staffMixResult));</span>
					
<span class="nc" id="L260">					rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
					
<span class="nc bnc" id="L262" title="All 2 branches missed.">					while(rs.next()) {</span>
<span class="nc" id="L263">						StringsPair wrkGrp = new StringsPair();</span>
<span class="nc" id="L264">						wrkGrp.setKey(new ID(rs.getInt(&quot;Id&quot;)).toString());</span>
<span class="nc" id="L265">						wrkGrp.setValue(rs.getString(&quot;Name&quot;));</span>
<span class="nc" id="L266">						workgroups.add(wrkGrp);</span>
<span class="nc" id="L267">					}</span>
	    	 	}
<span class="nc" id="L269">			} catch (Exception se) {</span>
<span class="nc" id="L270">				m_cat.error(&quot;Error in RfsReportParametersDAO.getWorkgroups() : &quot;,se);</span>
			} finally {
<span class="nc" id="L272">				cleanUp();</span>
<span class="nc" id="L273">			}</span>
<span class="nc" id="L274">		return workgroups;</span>
	}
	
	/**
	 * Get employee categories in a staff mix
	 * @param staffMixResult
	 * @return
	 */
	public ArrayList&lt;StringsPair&gt; getEmployeeCategories(int staffMixResult) {
<span class="nc" id="L283">		ArrayList&lt;StringsPair&gt; colEmpCategories = new ArrayList&lt;StringsPair&gt;();</span>
	     try {
				JdmoRowset rs;
<span class="nc" id="L286">				JdmoQuery query = m_dmo.createQuery(&quot;dbo.GetStaffMixResultEmployeeCategories&quot;, Jdmo.STORPROC_QUERY);</span>
<span class="nc" id="L287">				query.setParInt(1, staffMixResult);</span>
				
<span class="nc" id="L289">				rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
				
<span class="nc bnc" id="L291" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L292">					StringsPair empCat = new StringsPair();</span>
<span class="nc" id="L293">					empCat.setKey(new ID(rs.getInt(&quot;Id&quot;)).toString());</span>
<span class="nc" id="L294">					empCat.setValue(rs.getString(&quot;Name&quot;));</span>
<span class="nc" id="L295">					colEmpCategories.add(empCat);</span>
<span class="nc" id="L296">				}</span>
<span class="nc" id="L297">			} catch (Exception se) {</span>
<span class="nc" id="L298">				m_cat.error(&quot;Error in RfsReportParametersDAO.getEmployeeCategories() : &quot;,se);</span>
			} finally {
<span class="nc" id="L300">				cleanUp();</span>
<span class="nc" id="L301">			}</span>
<span class="nc" id="L302">		return colEmpCategories;</span>
	}
	
	public ArrayList&lt;StringsPair&gt; getResourceCategories(String scenario) {
<span class="nc" id="L306">		 ArrayList&lt;StringsPair&gt; lBu = new ArrayList&lt;StringsPair&gt;();		   </span>
	     try {
				JdmoRowset rs;
<span class="nc" id="L309">				StringBuilder pStmt = new StringBuilder();</span>
<span class="nc" id="L310">				JdmoQuery query = m_dmo.createQuery(&quot;dbo.GetActivityViews&quot;, Jdmo.STORPROC_QUERY);</span>
<span class="nc" id="L311">				query.setParInt(1, Integer.parseInt(scenario));</span>
<span class="nc" id="L312">				query.setParString(2, &quot;HistoricalVolumes_QuarterlyTrendsByResourceCategory&quot;);				</span>
<span class="nc" id="L313">				rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
				
<span class="nc bnc" id="L315" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L316">					StringsPair resourceCategory = new StringsPair();</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">					if(rs.getString(&quot;Id&quot;) != null) {</span>
<span class="nc" id="L318">						resourceCategory.setKey(new ID(rs.getInt(&quot;Id&quot;)).toString());</span>
<span class="nc" id="L319">						resourceCategory.setValue(rs.getString(&quot;ExportName&quot;));</span>
<span class="nc" id="L320">						lBu.add(resourceCategory);</span>
					}
<span class="nc" id="L322">				}								</span>
				
<span class="nc bnc" id="L324" title="All 2 branches missed.">				if(lBu.isEmpty()) {</span>
<span class="nc" id="L325">					pStmt.append(&quot;SELECT  Id, ExportName &quot;)</span>
<span class="nc" id="L326">							.append(&quot; FROM dbo.ResourceCategories &quot;)</span>
<span class="nc" id="L327">							.append(&quot; WHERE Scenario = ? AND Reportable = 1  ORDER BY DisplayOrder &quot;);</span>
					
<span class="nc" id="L329">					query = m_dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L330">					query.setParInt(1, Integer.parseInt(scenario));</span>
	
<span class="nc" id="L332">					rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">					while(rs.next()) {</span>
<span class="nc" id="L334">						StringsPair bu = new StringsPair();</span>
<span class="nc" id="L335">						bu.setKey(rs.getString(&quot;Id&quot;));</span>
<span class="nc" id="L336">						bu.setValue(rs.getString(&quot;ExportName&quot;));</span>
<span class="nc" id="L337">						lBu.add(bu);</span>
<span class="nc" id="L338">					}</span>
				}
<span class="nc" id="L340">			} catch (Exception se) {</span>
<span class="nc" id="L341">				m_cat.error(&quot;Error in RfsReportParametersDAO.getResourceCategories() : &quot;,se);</span>
			} finally {
<span class="nc" id="L343">				cleanUp();</span>
<span class="nc" id="L344">			}</span>
<span class="nc" id="L345">			return lBu;		</span>
	} 
	
	public ArrayList&lt;StringsPair&gt; getTransactionCategories(String scenario) {
<span class="nc" id="L349">		  ArrayList&lt;StringsPair&gt; lBu = new ArrayList&lt;StringsPair&gt;();</span>
		   
	     try {
<span class="nc" id="L352">				StringBuilder pStmt = new StringBuilder();</span>
				JdmoRowset rs;
<span class="nc" id="L354">				JdmoQuery query = m_dmo.createQuery(&quot;dbo.GetActivityViews&quot;, Jdmo.STORPROC_QUERY);</span>
<span class="nc" id="L355">				query.setParInt(1, Integer.parseInt(scenario));</span>
<span class="nc" id="L356">				query.setParString(2, &quot;HistoricalVolumes_QuarterlyTrendsByTransactionCategory&quot;);				</span>
<span class="nc" id="L357">				rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
				
<span class="nc bnc" id="L359" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L360">					StringsPair transactionCategory = new StringsPair();</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">					if(rs.getString(&quot;Id&quot;) != null) {</span>
<span class="nc" id="L362">						transactionCategory.setKey(new ID(rs.getInt(&quot;Id&quot;)).toString());</span>
<span class="nc" id="L363">						transactionCategory.setValue(rs.getString(&quot;ExportName&quot;));</span>
<span class="nc" id="L364">						lBu.add(transactionCategory);</span>
					}
<span class="nc" id="L366">				}								</span>
				
<span class="nc bnc" id="L368" title="All 2 branches missed.">				if(lBu.isEmpty()) {</span>
<span class="nc" id="L369">					pStmt.append(&quot;SELECT  Id, ExportName &quot;)</span>
<span class="nc" id="L370">							.append(&quot; FROM dbo.ActivityCategories &quot;)</span>
<span class="nc" id="L371">							.append(&quot; WHERE  Id IN ( SELECT DISTINCT Category &quot;) </span>
<span class="nc" id="L372">							.append(&quot;  FROM dbo.HistoricalActivityClasses &quot;)</span>
<span class="nc" id="L373">							.append(&quot; WHERE Scenario = ?)  AND Reportable = 1  ORDER BY DisplayOrder&quot;);</span>
					
<span class="nc" id="L375">					query = m_dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L376">					query.setParInt(1, Integer.parseInt(scenario));</span>
	
<span class="nc" id="L378">					rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">					while(rs.next()) {</span>
<span class="nc" id="L380">						StringsPair bu = new StringsPair();</span>
<span class="nc" id="L381">						bu.setKey(rs.getString(&quot;Id&quot;));</span>
<span class="nc" id="L382">						bu.setValue(rs.getString(&quot;ExportName&quot;));</span>
<span class="nc" id="L383">						lBu.add(bu);</span>
<span class="nc" id="L384">					}</span>
				}
<span class="nc" id="L386">			} catch (Exception se) {</span>
<span class="nc" id="L387">				m_cat.error(&quot;Error in RfsReportParametersDAO.getTransactionCategories() : &quot;,se);</span>
			} finally {
<span class="nc" id="L389">				cleanUp();</span>
<span class="nc" id="L390">			}</span>
<span class="nc" id="L391">			return lBu;		</span>
	}

	public ArrayList&lt;StringsPair&gt; getHierarchyGroupByList(String scenario) {
<span class="nc" id="L395">		  ArrayList&lt;StringsPair&gt; lBu = new ArrayList&lt;StringsPair&gt;();</span>
		   
	     try {
				JdmoRowset rs;
<span class="nc" id="L399">				JdmoQuery query = m_dmo.createQuery(&quot;dbo.GetHierarchyGroupByList&quot;, Jdmo.STORPROC_QUERY);</span>
<span class="nc" id="L400">				query.setParInt(1,-1);</span>
<span class="nc" id="L401">				query.setParInt(2, Integer.parseInt(scenario));</span>
<span class="nc" id="L402">				rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
				
<span class="nc bnc" id="L404" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L405">					StringsPair hierarchyGroup = new StringsPair();</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">					if(rs.getObject(&quot;Id&quot;) != null) {</span>
<span class="nc" id="L407">						hierarchyGroup.setKey(new ID(rs.getInt(&quot;Id&quot;)).toString());</span>
<span class="nc" id="L408">						hierarchyGroup.setValue(rs.getString(&quot;Name&quot;));</span>
<span class="nc" id="L409">						lBu.add(hierarchyGroup);</span>
					}
<span class="nc" id="L411">				}</span>
<span class="nc" id="L412">			} catch (Exception se) {</span>
<span class="nc" id="L413">				m_cat.error(&quot;Error in RfsReportParametersDAO.GetHierarchyGroupByList() : &quot;,se);</span>
			} finally {
<span class="nc" id="L415">				cleanUp();</span>
<span class="nc" id="L416">			}</span>
<span class="nc" id="L417">			return lBu;		</span>
	}

	/**
	 * Get all the views in current scenario to display in branch picker
	 * @param scenario
	 * @return
	 */
	public ArrayList&lt;StringsPair&gt; getBranchViews(String scenario) {
<span class="nc" id="L426">		  ArrayList&lt;StringsPair&gt; lBu = new ArrayList&lt;StringsPair&gt;();</span>
<span class="nc" id="L427">		  lBu.add(new StringsPair(&quot;-1&quot;,&quot;&quot;));</span>
		     try {
					JdmoRowset rs;
									
<span class="nc" id="L431">					StringBuilder pStmt = new StringBuilder();</span>
					
<span class="nc" id="L433">					pStmt.append(&quot;SELECT  Id, Name &quot;)</span>
<span class="nc" id="L434">							.append(&quot; FROM dbo.BranchViews &quot;)</span>
<span class="nc" id="L435">							.append(&quot; WHERE Scenario = ? &quot;);</span>
					
<span class="nc" id="L437">					JdmoQuery query = m_dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L438">					query.setParInt(1, Integer.parseInt(scenario));</span>

<span class="nc" id="L440">					rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">					while(rs.next()) {</span>
<span class="nc" id="L442">						StringsPair bu = new StringsPair();</span>
<span class="nc" id="L443">						bu.setKey(rs.getString(&quot;Id&quot;));</span>
<span class="nc" id="L444">						bu.setValue(rs.getString(&quot;Name&quot;));</span>
<span class="nc" id="L445">						lBu.add(bu);</span>
<span class="nc" id="L446">					}</span>
					
<span class="nc" id="L448">				} catch (Exception se) {</span>
<span class="nc" id="L449">					m_cat.error(&quot;Error in RfsReportParametersDAO.getBranchViews() : &quot;,se);</span>
				} finally {
<span class="nc" id="L451">					cleanUp();</span>
<span class="nc" id="L452">				}</span>
<span class="nc" id="L453">				return lBu;				</span>
	}
	
	/**
	 * Get all branches in current scenario for the branch picker when no view is selected
	 * @param scenario
	 * @return
	 */
	public Collection&lt;RfsBranch&gt; getBranchesInCurrentScenario(String scenario) {

<span class="nc" id="L463">		String QUERY_BRANCHES_IN_SCENARIO = </span>
				&quot;SELECT Id,Branch, Label, Parent, BranchView FROM dbo.BranchViewNodes &quot;
				+ &quot;WHERE Id IN &quot;
				+ &quot;	(SELECT Id &quot;
				+ &quot;		FROM (SELECT Id, Row_Number() over(partition by Branch order by Id) RowNum&quot;
				+ &quot;				FROM dbo.BranchViewNodes&quot;
				+ &quot;				WHERE BranchView IN (SELECT Id FROM dbo.BranchViews where Scenario = ?) &quot;
				+ &quot;				AND Branch IS NOT NULL) branches&quot;
				+ &quot;  WHERE branches.RowNum = 1) &quot;;

<span class="nc" id="L473">		Collection&lt;RfsBranch&gt; branches = new ArrayList&lt;RfsBranch&gt;();</span>
<span class="nc" id="L474">		JdmoRowset rs = null;</span>
	     try {		
<span class="nc" id="L476">				m_cat.debug(&quot;getAllBranchesInCurrentScenario : query = &quot;+QUERY_BRANCHES_IN_SCENARIO);</span>
<span class="nc" id="L477">				JdmoQuery jq = m_dmo.createQuery(QUERY_BRANCHES_IN_SCENARIO, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L478">				jq.setParInt(1, Integer.parseInt(scenario));</span>
<span class="nc" id="L479">				rs = m_dmo.createRowset(jq,Jdmo.FORWARD_ONLY,Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L481">					RfsBranch bu = new RfsBranch();</span>
<span class="nc" id="L482">					bu.setFieldValue(RfsBranchFieldInfo.BRANCH_ID, new ID(rs.getString(1)));</span>
<span class="nc" id="L483">					bu.setFieldValue(RfsBranchFieldInfo.BRANCH_ID_NAME, rs.getString(2));</span>
<span class="nc" id="L484">					bu.setFieldValue(RfsBranchFieldInfo.BRANCH_LABEL, rs.getString(3));</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">					bu.setFieldValue(RfsBranchFieldInfo.BRANCH_PARENTID, rs.getString(4) != null ? new ID(rs.getString(4)) : new ID(&quot;&quot;));</span>
<span class="nc" id="L486">					bu.setFieldValue(RfsBranchFieldInfo.BRANCH_VIEW, rs.getString(5));</span>
<span class="nc" id="L487">					branches.add(bu);</span>
<span class="nc" id="L488">				}</span>
<span class="nc" id="L489">		} catch (Exception se) {</span>
<span class="nc" id="L490">			m_cat.error(&quot;Error in RfsReportParametersDAO.getBranchesInCurrentScenario() : &quot;,se);</span>
		} finally {
<span class="nc" id="L492">			cleanUp();</span>
<span class="nc" id="L493">		}</span>
<span class="nc" id="L494">		return branches;</span>
	}
	
	/**
	 * Get all branches in current branch view for the branch picker
	 * @param scenario
	 * @return
	 */
	public Collection&lt;RfsBranch&gt; getBranchesInCurrentView(String branchView) {
<span class="nc" id="L503">		String QUERY_BRANCHES_IN_VIEW = </span>
				&quot;SELECT Id,Branch, Label, Parent, BranchView FROM dbo.BranchViewNodes WHERE BranchView = ? &quot;;

<span class="nc" id="L506">		Collection&lt;RfsBranch&gt; branches = new ArrayList&lt;RfsBranch&gt;();</span>
<span class="nc" id="L507">		JdmoRowset rs = null;</span>
	     try {		
<span class="nc" id="L509">				m_cat.debug(&quot;getAllBranchesInCurrentScenario : query = &quot;+QUERY_BRANCHES_IN_VIEW);</span>
<span class="nc" id="L510">				JdmoQuery jq = m_dmo.createQuery(QUERY_BRANCHES_IN_VIEW, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L511">				jq.setParInt(1, Integer.parseInt(branchView));</span>
<span class="nc" id="L512">				rs = m_dmo.createRowset(jq,Jdmo.FORWARD_ONLY,Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L514">					RfsBranch bu = new RfsBranch();</span>
<span class="nc" id="L515">					bu.setFieldValue(RfsBranchFieldInfo.BRANCH_ID, new ID(rs.getString(1)));</span>
<span class="nc" id="L516">					bu.setFieldValue(RfsBranchFieldInfo.BRANCH_ID_NAME, rs.getString(2));</span>
<span class="nc" id="L517">					bu.setFieldValue(RfsBranchFieldInfo.BRANCH_LABEL, rs.getString(3));</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">					bu.setFieldValue(RfsBranchFieldInfo.BRANCH_PARENTID, rs.getString(4) != null ? new ID(rs.getString(4)) : new ID(&quot;&quot;));</span>
<span class="nc" id="L519">					bu.setFieldValue(RfsBranchFieldInfo.BRANCH_VIEW, rs.getString(5));</span>
<span class="nc" id="L520">					branches.add(bu);</span>
<span class="nc" id="L521">				}</span>
<span class="nc" id="L522">		} catch (Exception se) {</span>
<span class="nc" id="L523">			m_cat.error(&quot;Error in RfsReportParametersDAO.getBranchesInCurrentView() : &quot;,se);</span>
		} finally {
<span class="nc" id="L525">			cleanUp();</span>
<span class="nc" id="L526">		}</span>
<span class="nc" id="L527">		return branches;</span>
	}
	
	/**
	 * 
	 * @param branchIDs
	 * @return
	 */
	public Collection&lt;RfsBranch&gt; getBranchObjectsByIDs(Collection&lt;ID&gt; branchIDs) {
<span class="nc" id="L536">		String QUERY_BRANCHES_BY_IDS = &quot;SELECT  Id,Branch, Label, Parent, BranchView  FROM dbo.BranchViewNodes WHERE &quot;</span>
				+ &quot;	Id IN &quot;;
<span class="nc" id="L538">		 Collection&lt;RfsBranch&gt; branches = new ArrayList&lt;RfsBranch&gt;();</span>
<span class="nc" id="L539">		 JdmoRowset rs = null;</span>
		 try {	 							
<span class="nc" id="L541">			String query = QUERY_BRANCHES_BY_IDS + m_dmo.createInClause(branchIDs) + &quot; ORDER BY Branch&quot;;</span>
<span class="nc" id="L542">			rs = m_dmo.createRowset(query);</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">			while(rs.next()) {</span>
<span class="nc" id="L544">				RfsBranch bu = new RfsBranch();</span>
<span class="nc" id="L545">				bu.setFieldValue(RfsBranchFieldInfo.BRANCH_ID, new ID(rs.getString(1)));</span>
<span class="nc" id="L546">				bu.setFieldValue(RfsBranchFieldInfo.BRANCH_ID_NAME, rs.getString(2));</span>
<span class="nc" id="L547">				bu.setFieldValue(RfsBranchFieldInfo.BRANCH_LABEL, rs.getString(3));</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">				bu.setFieldValue(RfsBranchFieldInfo.BRANCH_PARENTID, rs.getString(4) != null ? new ID(rs.getString(4)) : new ID(&quot;&quot;));</span>
<span class="nc" id="L549">				bu.setFieldValue(RfsBranchFieldInfo.BRANCH_VIEW, rs.getString(5));</span>
<span class="nc" id="L550">				branches.add(bu);</span>
<span class="nc" id="L551">			}</span>
<span class="nc" id="L552">		} catch (Exception se) {</span>
<span class="nc" id="L553">			m_cat.error(&quot;Error in RfsReportParametersDAO.getBranchObjectsByIDs() : &quot;,se);</span>
		} finally {
<span class="nc" id="L555">			cleanUp();</span>
<span class="nc" id="L556">		}</span>
<span class="nc" id="L557">		return branches;</span>
	}
	
	public ArrayList&lt;String&gt; getBranchNames(String scenario, String [] branchIds) {
<span class="nc" id="L561">			ArrayList&lt;String&gt; branchNames = new ArrayList&lt;String&gt;();</span>
		     try {
					JdmoRowset rs;
									
<span class="nc" id="L565">					StringBuilder pStmt = new StringBuilder();</span>
					
<span class="nc" id="L567">					pStmt.append(&quot;SELECT Label &quot;)</span>
<span class="nc" id="L568">							.append(&quot; FROM dbo.BranchViewNodes &quot;)</span>
<span class="nc" id="L569">							.append(&quot; WHERE Branch IN (SELECT Value FROM dbo.Tokens(?))&quot;);</span>
					
<span class="nc" id="L571">					JdmoQuery query = m_dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L572">					query.setParString(1, StringUtil.createDelimitedString(branchIds, &quot;,&quot;));</span>
<span class="nc" id="L573">					rs = m_dmo.createRowset(query,Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">					while(rs.next()) {</span>
<span class="nc" id="L575">						branchNames.add(rs.getString(1));</span>
					}					
<span class="nc" id="L577">				} catch (Exception se) {</span>
<span class="nc" id="L578">					m_cat.error(&quot;Error in RfsReportParametersDAO.getBranchNames() : &quot;,se);</span>
				} finally {
<span class="nc" id="L580">					cleanUp();</span>
<span class="nc" id="L581">				}</span>
<span class="nc" id="L582">				return branchNames;				</span>
	}
	
	/**
	 * Get RFS Branch Ids for selected ID values
	 * @param branchIDs
	 * @return
	 */
	public Collection&lt;String&gt; getBranchesByIDs(Collection&lt;ID&gt; branchIDs) {
<span class="nc" id="L591">		Collection&lt;String&gt; branches = Collections.emptyList();</span>
	     try {
				JdmoRowset rs;
								
<span class="nc" id="L595">				StringBuilder query = new StringBuilder();</span>
				
<span class="nc" id="L597">				query.append(&quot;SELECT Branch &quot;)</span>
<span class="nc" id="L598">						.append(&quot; FROM dbo.BranchViewNodes &quot;)</span>
<span class="nc" id="L599">						.append(&quot; WHERE Branch IS NOT NULL &quot;)</span>
<span class="nc" id="L600">						.append(&quot; AND ID IN (&quot;)</span>
<span class="nc" id="L601">						.append(JdmoUtil.createIDList(branchIDs))</span>
<span class="nc" id="L602">						.append(&quot;) &quot;);</span>
<span class="nc" id="L603">				m_cat.info(&quot; getBranchesByIDs Query &quot; + query.toString() );</span>
<span class="nc" id="L604">				rs = m_dmo.createRowset(query.toString());</span>
<span class="nc" id="L605">				branches = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L607">					branches.add(rs.getString(1));</span>
				}				
<span class="nc" id="L609">			} catch (Exception se) {</span>
<span class="nc" id="L610">				m_cat.error(&quot;Error in RfsReportParametersDAO.getBranchesByIDs() : &quot;,se);</span>
			} finally {
<span class="nc" id="L612">				cleanUp();</span>
<span class="nc" id="L613">			}</span>
<span class="nc" id="L614">			return branches;				</span>
	}
	
	public String getDefaultViewForScenario(String scenario) {
<span class="nc" id="L618">		String defaultValue = null;</span>
		 try {
				JdmoRowset rs;								
<span class="nc" id="L621">				StringBuilder query = new StringBuilder();		</span>
				
<span class="nc" id="L623">				query.append(&quot;SELECT DefaultBranchView &quot;)</span>
<span class="nc" id="L624">						.append(&quot; FROM dbo.Scenarios &quot;)</span>
<span class="nc" id="L625">						.append(&quot; WHERE Id = &quot;)</span>
<span class="nc" id="L626">						.append(scenario);</span>
				
<span class="nc" id="L628">				m_cat.info(&quot; getDefaultViewForScenario Query &quot; + query.toString() );</span>
				
<span class="nc" id="L630">				rs = m_dmo.createRowset(query.toString());</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L632">					defaultValue = rs.getString(1);</span>
				}				
<span class="nc" id="L634">			} catch (Exception se) {</span>
<span class="nc" id="L635">				m_cat.error(&quot;Error in RfsReportParametersDAO.getDefaultViewForScenario() : &quot;,se);</span>
			} finally {
<span class="nc" id="L637">				cleanUp();</span>
<span class="nc" id="L638">			}</span>
<span class="nc" id="L639">			return defaultValue;</span>
	}
	
	public Collection&lt;String&gt; getBranchesByIDString(String branchIDs) {
<span class="nc" id="L643">		Collection&lt;String&gt; branches = Collections.emptyList();</span>
	     try {
				JdmoRowset rs;
								
<span class="nc" id="L647">				StringBuilder query = new StringBuilder();</span>
				
<span class="nc" id="L649">				query.append(&quot;SELECT Branch &quot;)</span>
<span class="nc" id="L650">						.append(&quot; FROM dbo.BranchViewNodes &quot;)</span>
<span class="nc" id="L651">						.append(&quot; WHERE Parent IS NOT NULL AND Branch IS NOT NULL AND ID IN (&quot;)</span>
<span class="nc" id="L652">						.append(JdmoUtil.asSqlLiteral(branchIDs))</span>
<span class="nc" id="L653">						.append(&quot;)&quot;);</span>
<span class="nc" id="L654">				m_cat.info(&quot; getBranchesByIDString Query &quot; + query.toString() );</span>
<span class="nc" id="L655">				rs = m_dmo.createRowset(query.toString());</span>
<span class="nc" id="L656">				branches = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">				while(rs.next()) {</span>
<span class="nc" id="L658">					branches.add(rs.getString(1));</span>
				}				
<span class="nc" id="L660">			} catch (Exception se) {</span>
<span class="nc" id="L661">				m_cat.error(&quot;Error in RfsReportParametersDAO.getBranchesByIDString() : &quot;,se);</span>
			} finally {
<span class="nc" id="L663">				cleanUp();</span>
<span class="nc" id="L664">			}</span>
<span class="nc" id="L665">			return branches;				</span>
	}
	
	/**
	 * Clean up dmo object
	 */
	public void cleanUp() {
<span class="nc bnc" id="L672" title="All 2 branches missed.">		if(m_dmo != null) {</span>
<span class="nc" id="L673">			m_dmo.cleanUp();</span>
<span class="nc" id="L674">			m_dmo = null;</span>
		}
<span class="nc" id="L676">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>