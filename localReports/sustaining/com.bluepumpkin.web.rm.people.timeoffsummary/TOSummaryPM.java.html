<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TOSummaryPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.people.timeoffsummary</a> &gt; <span class="el_source">TOSummaryPM.java</span></div><h1>TOSummaryPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.people.timeoffsummary;

import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.ResourceBundle;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.people.PeoplePM;
import com.bluepumpkin.web.bbm.people.PeopleUtil;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.schedule.summary.FlexTimeSummaryData;
import com.bluepumpkin.web.fs.schedule.summary.FlexTimeSummaryPC;
import com.bluepumpkin.web.fs.schedule.summary.OneWayShiftSwapSummaryData;
import com.bluepumpkin.web.fs.schedule.summary.OneWayShiftSwapSummaryPC;
import com.bluepumpkin.web.fs.schedule.summary.ScheduleSummaryMH;
import com.bluepumpkin.web.fs.schedule.summary.TimeBankSummaryData;
import com.bluepumpkin.web.fs.schedule.summary.TimeBankSummaryPC;
import com.bluepumpkin.web.fs.schedule.summary.TimeOffSummaryPC;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarUtil;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpaneMultiColPM;
import com.witness.web.uif.pagemodel.WorkpanePageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;

/**
 * People Time-off Summary Page
 * To check each employee's Time-off summary
 * @author rsun
 */
public class TOSummaryPM extends WorkpanePageModel implements ContainersInRowsPM, PeoplePM {
	private final ResourceBundle m_bundle;
	private final ContainerList m_containerList;
	private final boolean m_showTimeBank;
	private final boolean m_showTOSummary;
	private final boolean m_showFlexTimeSummary;
	private final boolean m_showOneWayShiftSwapSummary;
	private final DatePickerPC m_inputDatePicker;

	public TOSummaryPM(RequestContext context) {
<span class="nc" id="L57">		super(context, PageModel.FRAMED_MODEL);</span>
<span class="nc" id="L58">		m_bundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L59">		m_containerList = new ContainerList(this, 10);//default initialCapacity of ArrayList</span>
<span class="nc" id="L60">		m_showTimeBank = ScheduleSummaryMH.checkLicense(LicenseKeys.APP_TIME_BANK);</span>
<span class="nc" id="L61">		m_showTOSummary = m_context.getUser().isAuthorized(PrivilegeKeys.TOM_VIEWAVAILABLETIMEOFF);</span>
<span class="nc" id="L62">		m_showFlexTimeSummary = m_context.getUser().isAuthorized(PrivilegeKeys.FT_VIEWREQUESTSFOREMPLOYEE);</span>
<span class="nc" id="L63">		m_showOneWayShiftSwapSummary = m_context.getUser().isAuthorized(PrivilegeKeys.SS_VIEWREQUESTSFOREMPLOYEE);</span>
<span class="nc" id="L64">		m_inputDatePicker = new DatePickerPC(m_context, &quot;inputDate&quot;);</span>
<span class="nc" id="L65">		addChildComponent(m_inputDatePicker);//for extraction</span>
<span class="nc" id="L66">        setDefaultPageIDSize(10);</span>
<span class="nc" id="L67">	}</span>

	/**
	 * Return Page Model Instance
	 */
	public static PageModel getInstance(RequestContext context) {
<span class="nc" id="L73">		return getInstance(context, TOSummaryPM.class);</span>
	}

	@Override
	protected void loadData() throws Exception {
		//loadData() is after PageModel.extractParameters() where it gets SelectedIDs
		
<span class="nc" id="L80">        Collection&lt;ID&gt; empIDs = getPageIDs();</span>
        
<span class="nc bnc" id="L82" title="All 2 branches missed.">		boolean isMultiSelection = empIDs.size() &gt; 1;</span>
		Map empNames;
<span class="nc bnc" id="L84" title="All 2 branches missed.">		if (isMultiSelection) {//Multi-selection, show Names for each selected employee</span>
<span class="nc" id="L85">			empNames = EmployeeModelHandler.getEmployeeNamesByIDs(m_context, empIDs);</span>
		} else {//Single-selection, do not show Name, put it null
<span class="nc" id="L87">			empNames = Collections.EMPTY_MAP;</span>
		}

<span class="nc bnc" id="L90" title="All 2 branches missed.">		if (isMultiSelection) {</span>
			//When multi-selection, the user inputs 1 date picker instead of
			// many toYear drop down list boxes for each employee.
<span class="nc" id="L93">			m_inputDatePicker.setOnChangeJS(JSUtil.REFRESH_PAGE);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">			if (m_inputDatePicker.getDate() == null)</span>
<span class="nc" id="L95">				m_inputDatePicker.setDate(new Date());</span>
			//m_containerList.add(m_inputDatePicker);
<span class="nc" id="L97">			m_contentTitlePC.setActiveComponent(m_inputDatePicker);</span>
		}

<span class="nc" id="L100">		HashMap tbSummaries=null;</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">		if (empIDs.size() &gt; 0) {</span>
<span class="nc" id="L102">			tbSummaries = ScheduleSummaryMH.getTimeBankingSummaries(m_context, empIDs);</span>
		}
<span class="nc" id="L104">		HashMap empTOSummaryMap = null;</span>
<span class="nc bnc" id="L105" title="All 4 branches missed.">		if (m_showTOSummary &amp;&amp; isMultiSelection) {</span>
<span class="nc" id="L106">			empTOSummaryMap = ScheduleSummaryMH.getTimeOffSummary(m_context, empIDs, m_inputDatePicker.getDate(), false);</span>
		}
<span class="nc" id="L108">		Map&lt;ID, OneWayShiftSwapSummaryData&gt; oneWayShiftSwapEmpCountMap = null;</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">		if(m_showOneWayShiftSwapSummary) {</span>
<span class="nc" id="L110">			oneWayShiftSwapEmpCountMap = ScheduleSummaryMH.getOneWayShiftSwapSummary(m_context, new HashSet&lt;ID&gt;(empIDs));</span>
		}
<span class="nc" id="L112">		Map&lt;ID, FlexTimeSummaryData&gt; flexTimeEmpCountMap = null;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">		if(m_showFlexTimeSummary) {</span>
<span class="nc" id="L114">			flexTimeEmpCountMap = ScheduleSummaryMH.getFlexTimeSummary(m_context, new HashSet&lt;ID&gt;(empIDs));</span>
		}

		TimeOffSummaryPC toSummaryPC;
		FlexTimeSummaryPC flexTimeSummaryPC;
		OneWayShiftSwapSummaryPC oneWayShiftSwapSummaryPC;
		TimeBankSummaryPC tbSummaryPC;

<span class="nc bnc" id="L122" title="All 2 branches missed.">		for (ID empID: empIDs) {</span>
<span class="nc" id="L123">			EmployeeName empName = (EmployeeName) empNames.get(empID);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">			String nameStr = empName == null ? null : m_localizer.formatName(empName);</span>

			//Add the Time Off Summary container
<span class="nc" id="L127">			toSummaryPC = null;</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">			if (m_showTOSummary) {</span>
<span class="nc" id="L129">				toSummaryPC = new TimeOffSummaryPC(m_context, empID, nameStr, false);</span>
<span class="nc" id="L130">				toSummaryPC.extractParameters(m_context.getRequest());</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">				if (isMultiSelection) {//When multi-selection, set the input date</span>
<span class="nc" id="L132">					toSummaryPC.setInputDate(m_inputDatePicker.getDate());</span>
<span class="nc" id="L133">					Calendar timeOffYearStart = ScheduleSummaryMH.getEmployeeYearStart(m_context, empID, m_inputDatePicker.getDate(), toSummaryPC.getTimeOffYear());</span>
<span class="nc" id="L134">					toSummaryPC.init((Collection) empTOSummaryMap.get(empID), timeOffYearStart);</span>
<span class="nc" id="L135">				}else{</span>
<span class="nc" id="L136">					toSummaryPC.init();</span>
				}
			}

			//Add the Flex Time Summary container
<span class="nc" id="L141">			flexTimeSummaryPC = null;</span>
<span class="nc bnc" id="L142" title="All 4 branches missed.">			if(flexTimeEmpCountMap != null &amp;&amp; m_showFlexTimeSummary) {</span>
<span class="nc" id="L143">				FlexTimeSummaryData flexTimeSumData = flexTimeEmpCountMap.get(empID);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">				if(flexTimeSumData != null) {</span>
<span class="nc" id="L145">					flexTimeSummaryPC = new FlexTimeSummaryPC(m_context, empID, nameStr, flexTimeSumData);</span>
				}
			}

			//Add the One Way Shift Swap Summary container
<span class="nc" id="L150">			oneWayShiftSwapSummaryPC = null;</span>
<span class="nc bnc" id="L151" title="All 4 branches missed.">			if(oneWayShiftSwapEmpCountMap != null &amp;&amp; m_showOneWayShiftSwapSummary) {</span>
<span class="nc" id="L152">				OneWayShiftSwapSummaryData oneWayShiftSwapSumData = oneWayShiftSwapEmpCountMap.get(empID);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">				if(oneWayShiftSwapSumData != null) {</span>
<span class="nc" id="L154">					oneWayShiftSwapSummaryPC = new OneWayShiftSwapSummaryPC(m_context, empID, nameStr, oneWayShiftSwapSumData);</span>
				}
			}

			//Add the Time Bank Summary container
<span class="nc" id="L159">			TimeBankSummaryData tbSummaryData = (TimeBankSummaryData)tbSummaries.get(empID);</span>
<span class="nc bnc" id="L160" title="All 4 branches missed.">			boolean hasTimeBank = m_showTimeBank &amp;&amp; (tbSummaryData!=null);</span>
<span class="nc" id="L161">			tbSummaryPC = null;</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">			if (hasTimeBank) {</span>
<span class="nc" id="L163">				tbSummaryPC = new TimeBankSummaryPC(m_context, empID, nameStr, false, tbSummaryData);</span>
<span class="nc" id="L164">				tbSummaryPC.extractParameters(m_context.getRequest());</span>
			}

			//multi-selection requires an additional container to wrap the page components
<span class="nc bnc" id="L168" title="All 2 branches missed.">			if (isMultiSelection) {</span>
<span class="nc" id="L169">				IndentedCollapsibleContainerPC container = new IndentedCollapsibleContainerPC(m_context);</span>
<span class="nc" id="L170">				container.setName(&quot;container_&quot; + empID);</span>
<span class="nc" id="L171">				container.setTitle(nameStr);</span>
<span class="nc" id="L172">				container.setIsBorderEnabled(true);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">				if (toSummaryPC != null) {</span>
<span class="nc" id="L174">					toSummaryPC.setToggleable(false);</span>
<span class="nc" id="L175">					container.addComponent(toSummaryPC);</span>
				}
<span class="nc bnc" id="L177" title="All 2 branches missed.">				if(flexTimeSummaryPC != null) {</span>
<span class="nc" id="L178">					flexTimeSummaryPC.setToggleable(false);</span>
<span class="nc" id="L179">					container.addComponent(flexTimeSummaryPC);</span>
				}
<span class="nc bnc" id="L181" title="All 2 branches missed.">				if(oneWayShiftSwapSummaryPC != null) {</span>
<span class="nc" id="L182">					oneWayShiftSwapSummaryPC.setToggleable(false);</span>
<span class="nc" id="L183">					container.addComponent(oneWayShiftSwapSummaryPC);</span>
				}
<span class="nc bnc" id="L185" title="All 2 branches missed.">				if (tbSummaryPC != null) {</span>
<span class="nc" id="L186">					tbSummaryPC.setToggleable(false);</span>
<span class="nc" id="L187">					container.addComponent(tbSummaryPC);</span>
				}
<span class="nc" id="L189">				m_containerList.add(container);</span>
<span class="nc" id="L190">			} else {</span>
				//don't use additional container
<span class="nc bnc" id="L192" title="All 2 branches missed.">				if (toSummaryPC != null) {</span>
<span class="nc" id="L193">					m_containerList.add(toSummaryPC);</span>
				}
<span class="nc bnc" id="L195" title="All 2 branches missed.">				if (flexTimeSummaryPC != null) {</span>
<span class="nc" id="L196">					m_containerList.add(flexTimeSummaryPC);</span>
				}
<span class="nc bnc" id="L198" title="All 2 branches missed.">				if (oneWayShiftSwapSummaryPC != null) {</span>
<span class="nc" id="L199">					m_containerList.add(oneWayShiftSwapSummaryPC);</span>
				}
<span class="nc bnc" id="L201" title="All 2 branches missed.">				if (tbSummaryPC != null) {</span>
<span class="nc" id="L202">					m_containerList.add(tbSummaryPC);</span>
				}
			}
<span class="nc" id="L205">		}</span>

		//init Common Msg &amp; Title ItemName when multi-selection
<span class="nc" id="L208">		PeopleUtil.initForDisplay(this);</span>
		//init Title ItemName when single selection
<span class="nc bnc" id="L210" title="All 2 branches missed.">		if (this.getSelectedIDSize() == 1)</span>
<span class="nc" id="L211">			m_contentTitlePC.setItemName(m_localizer.formatName(</span>
<span class="nc" id="L212">					EmployeeModelHandler.getEmployeeNameByID(m_context, this.getSelectedIDObject())</span>
					));
<span class="nc" id="L214">	}</span>

    /**
	 * Initialize Content Title
	 */
	@Override
	public void initContentTitle() {
<span class="nc" id="L221">		String pageTitle = i18n(m_bundle, RmWebBundleKey.PEOPLE_TIMEOFF_SUMMARY);</span>
<span class="nc" id="L222">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="nc" id="L223">	}</span>

	/**
	 * Initialize Toolbar
	 */
	@Override
	protected void initToolbar()	{
<span class="nc" id="L230">		ToolbarUtil.addRefreshBtn(m_toolbar, true);</span>
<span class="nc" id="L231">        initPagination();</span>
<span class="nc" id="L232">	}</span>
    
    /** 
     * Inititalize pagination in the toolbar
     */
    protected void initPagination(){
<span class="nc" id="L238">        setPageIDResizeEnabled(true);</span>
<span class="nc" id="L239">        String itemTypeName = i18n(m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME), FsWebBundleKey.SV_PERSON);</span>
<span class="nc" id="L240">        m_toolbar.setPagination(itemTypeName, this, true, JSUtil.SUBMIT_FORM); //REFRESH_IGNORE_CHANGES);</span>
<span class="nc" id="L241">    }//initPagination</span>
    
    
    

	public Collection getContainers() {
<span class="nc" id="L247">		return m_containerList;</span>
	}

<span class="nc" id="L250">	public boolean isCommonMsgEnabled() { return true; }</span>

<span class="nc" id="L252">	public boolean isCreateMode() { return false; }</span>

<span class="nc" id="L254">	public boolean isMultiEdit() { return false; }</span>

<span class="nc" id="L256">	public boolean isPeopleSelectable() { return false; }</span>


	public class IndentedCollapsibleContainerPC extends CollapsibleContainerPC
	{
		public IndentedCollapsibleContainerPC( RequestContext context)
<span class="nc" id="L262">		{</span>
<span class="nc" id="L263">			super(context);</span>
<span class="nc" id="L264">		}</span>

		/**
		 * Get the class name to be used for the content div
		 */
		@Override
		public String getCollapsibleContentClass()
		{
<span class="nc bnc" id="L272" title="All 4 branches missed.">			if (getCollapsed() &amp;&amp; isToggleable())</span>
			{
<span class="nc" id="L274">				return &quot;invisibleDivObject&quot;;</span>
			}
			else
			{
<span class="nc" id="L278">				return &quot;visibleDivObjectIndented&quot;; //&quot;visibleDivObject&quot;;</span>
			}
		}
	}

    /**
     * These hidden variables are required for pagination support.
     * Only needed because this is not a list page.
     */
    @Override
	public String getRequiredHTML()
    {
<span class="nc" id="L290">        StringBuffer sb = new StringBuffer(super.getRequiredHTML());</span>
<span class="nc" id="L291">        sb.append(HtmlUtil.makeHiddenInput(WorkpaneMultiColPM.SELECTED_ID_FN, this.getSelectedID()));</span>
<span class="nc" id="L292">        sb.append(HtmlUtil.makeHiddenInput(WorkpaneMultiColPM.PERFORM_ACTION_ON_ID_FN, this.getPerformActionOnID()));</span>
<span class="nc" id="L293">        sb.append(HtmlUtil.makeHiddenInput(WorkpaneMultiColPM.EDIT_INDEX_FN, this.getEditIndex()));</span>
<span class="nc" id="L294">        return sb.toString();</span>
    }

    //Just like in QA59182, we don't want to get Out Of Memory Error when Selecting many agents.
    //Overriding the method for WorkpanePageModel as hack to restrict the number of records selected in a page.
    @Override
	public void setPageIDSize(int PageIDSize) 
    {
        try
        {            
<span class="nc" id="L304">            String configKey = &quot;bluepumpkin/People/TimeSummary/pageIDSizeLimit&quot;;            </span>
<span class="nc" id="L305">            String pageIDSizeFetched = BbmManagerFactory.getDBConfigManager().getValue(configKey);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">            if ( pageIDSizeFetched != null )</span>
            {
<span class="nc" id="L308">                int iPageIDSizeFetched = Integer.parseInt(pageIDSizeFetched);</span>
<span class="nc bnc" id="L309" title="All 6 branches missed.">                if ((PageIDSize &gt; iPageIDSizeFetched) || (PageIDSize&lt;0 &amp;&amp; iPageIDSizeFetched&gt;=0) )</span>
                {
<span class="nc" id="L311">                    PageIDSize = iPageIDSizeFetched;</span>
                }
            }
        }
<span class="nc" id="L315">        catch(Exception ex)</span>
        {
            //ignoring any exception caught.
<span class="nc" id="L318">        }</span>
<span class="nc" id="L319">        super.setPageIDSize(PageIDSize);</span>
<span class="nc" id="L320">    }    </span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>