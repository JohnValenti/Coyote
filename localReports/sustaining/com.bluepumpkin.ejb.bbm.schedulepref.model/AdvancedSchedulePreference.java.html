<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AdvancedSchedulePreference.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.schedulepref.model</a> &gt; <span class="el_source">AdvancedSchedulePreference.java</span></div><h1>AdvancedSchedulePreference.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.schedulepref.model;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  holds data about advanced schedule preference
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       lixin zhang
 * @version      1.0
 */

import java.util.Collection;
import java.util.Date;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriod;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectEffectivityNode;

public class AdvancedSchedulePreference extends ValueObjectEffectivityNode {
	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
<span class="nc" id="L26">	public static short PREFERRED_START_NON = 0;</span>
<span class="nc" id="L27">	public static short PREFERRED_START_EARLY = 1;</span>
<span class="nc" id="L28">	public static short PREFERRED_START_LATE = 2;</span>

<span class="nc" id="L30">	private static FieldInfo m_fieldInfo = new AdvancedSchedulePreferenceFieldInfo();</span>

	protected FieldInfo getFieldInfo() {
<span class="nc" id="L33">		return m_fieldInfo;</span>
	}

	// hold the start, end offset for the time ranges
<span class="nc" id="L37">	public static int PREFERENCE_INTERVAL_COUNT = 96 * 7;</span>
<span class="nc" id="L38">	private short m_startTimePreferences[] = new short[PREFERENCE_INTERVAL_COUNT];</span>

	public AdvancedSchedulePreference() {
<span class="nc" id="L41">		super();</span>

<span class="nc bnc" id="L43" title="All 2 branches missed.">		for (int i = 0; i &lt; PREFERENCE_INTERVAL_COUNT; i++)</span>
<span class="nc" id="L44">			m_startTimePreferences[i] = (short) 100;</span>

<span class="nc bnc" id="L46" title="All 2 branches missed.">		for (int i = 1; i &lt;= 7; i++)</span>
<span class="nc" id="L47">			setFieldValue(AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_SUNPREF - 1 + i, (short) 100);</span>

<span class="nc" id="L49">		setType(true); // advanced preference</span>
<span class="nc" id="L50">	}</span>

	public ID getEmployeeID() {
<span class="nc" id="L53">		return getFieldValueID(AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_EMPLOYEEID);</span>
	}

	public Date getStartTime() {
<span class="nc" id="L57">		return getFieldValueDate(AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_STARTTIME);</span>
	}

	public Date getEndTime() {
<span class="nc" id="L61">		return getFieldValueDate(AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_ENDTIME);</span>
	}

	public void setEmployeeID(ID id) {
<span class="nc" id="L65">		setFieldValue(AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_EMPLOYEEID, id);</span>
<span class="nc" id="L66">	}</span>

	public void setStartTime(Date dt) {
<span class="nc" id="L69">		setFieldValue(AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_STARTTIME, dt);</span>
<span class="nc" id="L70">	}</span>

	public void setEndTime(Date dt) {
<span class="nc" id="L73">		setFieldValue(AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_ENDTIME, dt);</span>
<span class="nc" id="L74">	}</span>

	private void setType(boolean bValue) {
<span class="nc" id="L77">		setFieldValue(AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_ISADVANCEDPREFERENCE, bValue);</span>
<span class="nc" id="L78">	}</span>

	public short getPreferredStart() {
<span class="nc" id="L81">		return getFieldValueShort(AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_PREFERREDSTART);</span>
	}

	public void setPreferredStart(short sValue) {
<span class="nc" id="L85">		setFieldValue(AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_PREFERREDSTART, sValue);</span>
<span class="nc" id="L86">	}</span>

	public boolean getPerferOvertime() {
<span class="nc" id="L89">		return getFieldValueBoolean(AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_PREFEROVERTIME);</span>
	}

	public void setPreferOvertime(boolean bValue) {
<span class="nc" id="L93">		setFieldValue(AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_PREFEROVERTIME, bValue);</span>
<span class="nc" id="L94">	}</span>

	/**
	 * get start time preference value
	 * 
	 * @param iDay
	 *            1..7 means Sun, Mon, ... Sat.
	 * @param iInterval
	 *            0, 1, 95 means 15 minutes interval for each day
	 *
	 * @return preference value, 100 means no preference
	 */
	public short getStartTimePreference(int iDay, int iInterval) {
<span class="nc bnc" id="L107" title="All 2 branches missed.">		if (iDay &lt; 1)</span>
<span class="nc" id="L108">			iDay = 1;</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">		if (iDay &gt; 7)</span>
<span class="nc" id="L110">			iDay = 7;</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">		if (iInterval &lt; 0)</span>
<span class="nc" id="L113">			iInterval = 0;</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">		if (iInterval &gt; 95)</span>
<span class="nc" id="L115">			iInterval = 95;</span>

<span class="nc" id="L117">		return m_startTimePreferences[(iDay - 1) * 96 + iInterval];</span>
	}

	/**
	 * set start time preference value
	 * 
	 * @param iDay
	 *            1..7 means Sun, Mon, ... Sat.
	 * @param iInterval
	 *            0, 1, 95 means 15 minutes interval for each day
	 * @param sPreference
	 *            preference value, 100 means no preference
	 *
	 */
	public void setStartTimePreference(int iDay, int iInterval, short sPreference) {
<span class="nc bnc" id="L132" title="All 2 branches missed.">		if (iDay &lt; 1) {</span>
<span class="nc" id="L133">			iDay = 1;</span>
		}
<span class="nc bnc" id="L135" title="All 2 branches missed.">		if (iDay &gt; 7) {</span>
<span class="nc" id="L136">			iDay = 7;</span>
		}

<span class="nc bnc" id="L139" title="All 2 branches missed.">		if (iInterval &lt; 0) {</span>
<span class="nc" id="L140">			iInterval = 0;</span>
		}
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if (iInterval &gt; 95) {</span>
<span class="nc" id="L143">			iInterval = 95;</span>
		}

<span class="nc" id="L146">		m_startTimePreferences[(iDay - 1) * 96 + iInterval] = sPreference;</span>
<span class="nc" id="L147">	}</span>

	/** get all start time preference values */
	public short[] getStartTimePreferences() {
<span class="nc" id="L151">		return m_startTimePreferences;</span>
	}

	/** set all start time preference values */
	public void setStartTimePreferences(short preferences[]) {
<span class="nc" id="L156">		System.arraycopy(preferences, 0, m_startTimePreferences, 0, PREFERENCE_INTERVAL_COUNT);</span>
<span class="nc" id="L157">	}</span>

	/**
	 * get day off preference value
	 * 
	 * @param iDay
	 *            1..7 means Sun, Mon, ... Sat.
	 *
	 * @return preference value, 100 means no preference
	 */
	public short getDayOffPreference(int iDay) {
<span class="nc bnc" id="L168" title="All 2 branches missed.">		if (iDay &lt; 1) {</span>
<span class="nc" id="L169">			iDay = 1;</span>
		}
<span class="nc bnc" id="L171" title="All 2 branches missed.">		if (iDay &gt; 7) {</span>
<span class="nc" id="L172">			iDay = 7;</span>
		}

<span class="nc" id="L175">		int iField = AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_SUNPREF - 1 + iDay;</span>
<span class="nc" id="L176">		return getFieldValueShort(iField);</span>
	}

	/**
	 * set day off preference value
	 * 
	 * @param iDay
	 *            1..7 means Sun, Mon, ... Sat.
	 *
	 * @param spreference
	 *            value, 100 means no preference
	 */
	public void setDayOffPreference(int iDay, short sPreference) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">		if (iDay &lt; 1) {</span>
<span class="nc" id="L190">			iDay = 1;</span>
		}
<span class="nc bnc" id="L192" title="All 2 branches missed.">		if (iDay &gt; 7) {</span>
<span class="nc" id="L193">			iDay = 7;</span>
		}

<span class="nc" id="L196">		int iField = AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_SUNPREF - 1 + iDay;</span>
<span class="nc" id="L197">		setFieldValue(iField, sPreference);</span>
<span class="nc" id="L198">	}</span>

	// extract preference data and put it in an array
	public void processPreferenceDataAfterLoad() {
<span class="nc" id="L202">		Collection col = getChildObjects(AdvancedSchedulePreferenceFieldInfo.CHILD_STARTTIME_PREF);</span>
<span class="nc bnc" id="L203" title="All 4 branches missed.">		if (col == null || col.isEmpty()) {</span>
<span class="nc" id="L204">			return;</span>
		}

<span class="nc" id="L207">		Iterator it = col.iterator();</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">		while (it.hasNext()) {</span>
<span class="nc" id="L209">			AdvancedStartTimePreference item = (AdvancedStartTimePreference) it.next();</span>
<span class="nc" id="L210">			int iTimeSlot = item.getTimeSlot();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">			if (iTimeSlot &lt; 0) {</span>
<span class="nc" id="L212">				iTimeSlot = 0;</span>
			}
<span class="nc bnc" id="L214" title="All 2 branches missed.">			if (iTimeSlot &gt; PREFERENCE_INTERVAL_COUNT - 1) {</span>
<span class="nc" id="L215">				iTimeSlot = PREFERENCE_INTERVAL_COUNT - 1;</span>
			}
<span class="nc" id="L217">			m_startTimePreferences[iTimeSlot] = item.getPreference();</span>
<span class="nc" id="L218">		}</span>

<span class="nc" id="L220">		clearChildObjectMap(AdvancedSchedulePreferenceFieldInfo.CHILD_STARTTIME_PREF);</span>
<span class="nc" id="L221">	}</span>

	// process preference data before update
	public void processPreferenceDataBeforeUpdate() {
<span class="nc" id="L225">		super.clearCreatedChildObjectMap(AdvancedSchedulePreferenceFieldInfo.CHILD_STARTTIME_PREF);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">		for (int i = 0; i &lt; PREFERENCE_INTERVAL_COUNT; i++) {</span>
<span class="nc" id="L227">			short sPreference = m_startTimePreferences[i];</span>
<span class="nc bnc" id="L228" title="All 4 branches missed.">			if (sPreference &lt; 1 || sPreference &gt;= 100) {</span>
<span class="nc" id="L229">				continue;</span>
			}

<span class="nc" id="L232">			AdvancedStartTimePreference item = new AdvancedStartTimePreference();</span>
<span class="nc" id="L233">			item.setTimeSlot((short) i);</span>
<span class="nc" id="L234">			item.setPreference(sPreference);</span>

<span class="nc" id="L236">			createChildObject(AdvancedSchedulePreferenceFieldInfo.CHILD_STARTTIME_PREF, item);</span>
		}

		// SimpleStartTimePreference object will override the delete method
		// to delete all start time preference data before insert any.
<span class="nc bnc" id="L241" title="All 2 branches missed.">		if (getID() != null)</span>
<span class="nc" id="L242">			deleteChildObject(AdvancedSchedulePreferenceFieldInfo.CHILD_STARTTIME_PREF, getID());</span>
<span class="nc" id="L243">	}</span>

	// clone the assignment object without the ID field
	public TimePeriod cloneTimePeriod() {
<span class="nc" id="L247">		AdvancedSchedulePreference item = new AdvancedSchedulePreference();</span>

<span class="nc" id="L249">		item.setEmployeeID(getEmployeeID());</span>
<span class="nc" id="L250">		item.setStartTime(getStartTime());</span>
<span class="nc" id="L251">		item.setEndTime(getEndTime());</span>
<span class="nc" id="L252">		item.setPreferOvertime(getPerferOvertime());</span>

		// day off preference
<span class="nc bnc" id="L255" title="All 2 branches missed.">		for (int i = 1; i &lt;= 7; i++) {</span>
<span class="nc" id="L256">			item.setDayOffPreference(i, getDayOffPreference(i));</span>
		}

		// start time preference
<span class="nc" id="L260">		item.setStartTimePreferences(getStartTimePreferences());</span>

<span class="nc" id="L262">		return item;</span>
	}

	/**
	 * create an advanced schedule preference from simple one
	 */
	public static AdvancedSchedulePreference getInstance(SimpleSchedulePreference simplePref) {
<span class="nc" id="L269">		AdvancedSchedulePreference item = new AdvancedSchedulePreference();</span>

<span class="nc" id="L271">		item.setEmployeeID(simplePref.getEmployeeID());</span>
<span class="nc" id="L272">		item.setStartTime(simplePref.getStartTime());</span>
<span class="nc" id="L273">		item.setEndTime(simplePref.getEndTime());</span>
<span class="nc" id="L274">		item.setPreferredStart(simplePref.getPreferredStart());</span>

		// calculate the preference value
<span class="nc" id="L277">		int iDayOffPreference = 1;</span>
<span class="nc" id="L278">		int iStartTimePreference = 1;</span>

<span class="nc" id="L280">		int iPreferDayOff = simplePref.getPreferDayOff();</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">		if (iPreferDayOff == SimpleSchedulePreference.PREFER_STARTTIME_OVER_DAYOFF) {</span>
<span class="nc" id="L282">			iDayOffPreference = 10;</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">		} else if (iPreferDayOff == SimpleSchedulePreference.PREFER_DAYOFF_OVER_STARTTIME) {</span>
<span class="nc" id="L284">			iStartTimePreference = 10;</span>
		}

		// convert day off preference
<span class="nc" id="L288">		Collection colDayOff = simplePref.getDayOffPreference();</span>
<span class="nc" id="L289">		Iterator it = colDayOff.iterator();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">		while (it.hasNext()) {</span>
<span class="nc" id="L291">			int iDay = ((Integer) it.next()).intValue();</span>
<span class="nc" id="L292">			item.setDayOffPreference(iDay, (short) iDayOffPreference);</span>
<span class="nc" id="L293">			iDayOffPreference++;</span>
<span class="nc" id="L294">		}</span>

		// convert start time preference
<span class="nc bnc" id="L297" title="All 2 branches missed.">		for (int iLevel = 0; iLevel &lt; 3; iLevel++) {</span>
<span class="nc" id="L298">			short iPreference = (short) (iStartTimePreference + iLevel);</span>

<span class="nc bnc" id="L300" title="All 2 branches missed.">			for (int iDay = 1; iDay &lt;= 7; iDay++) {</span>
<span class="nc" id="L301">				int iStartOffset = simplePref.getStartTimePreferenceStart(iDay, iLevel);</span>
<span class="nc" id="L302">				int iEndOffset = simplePref.getStartTimePreferenceEnd(iDay, iLevel);</span>

<span class="nc bnc" id="L304" title="All 2 branches missed.">				if (iStartOffset == -1) {</span>
<span class="nc" id="L305">					continue; // blank entry</span>
				}
<span class="nc bnc" id="L307" title="All 2 branches missed.">				if (iEndOffset == -1) {</span>
<span class="nc" id="L308">					iEndOffset = iStartOffset;</span>
				}
<span class="nc" id="L310">				iStartOffset = (iStartOffset / 15);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">				iEndOffset = (iEndOffset / 15) + (iEndOffset % 15 &gt; 0 ? 1 : 0);</span>

<span class="nc bnc" id="L313" title="All 2 branches missed.">				for (int iInterval = iStartOffset; iInterval &lt; iEndOffset; iInterval++) {</span>
<span class="nc" id="L314">					item.setStartTimePreference(iDay, iInterval, iPreference);</span>
				}
			}
		}

<span class="nc" id="L319">		return item;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>