<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EmpWorkRuleManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.empworkrule.ejb</a> &gt; <span class="el_source">EmpWorkRuleManagerEJB.java</span></div><h1>EmpWorkRuleManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.empworkrule.ejb;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.TreeSet;

import javax.naming.Context;
import javax.naming.InitialContext;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.PaginationPair;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.empworkrule.model.*;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkUnit.WorkUnitType;
import com.bluepumpkin.ejb.bbm.paypolicy.ejb.PayPolicyManager;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourcePayPolicy;
import com.bluepumpkin.ejb.bbm.workrules.ejb.ComplexWorkRuleDAO;
import com.bluepumpkin.ejb.bbm.workrules.ejb.RotationDAO;
import com.bluepumpkin.ejb.bbm.workrules.ejb.TimeBankDAO;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRuleFieldInfo;
import com.bluepumpkin.ejb.bbm.workrules.model.Rotation;
import com.bluepumpkin.ejb.bbm.workrules.model.TimeBank;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.verint.ejb.wfm.WfmManagerFactory;

@SuppressWarnings(&quot;serial&quot;)
<span class="fc" id="L57">public class EmpWorkRuleManagerEJB extends SessionEJBBase {</span>

<span class="fc" id="L59">	private static Category m_cat = Log.initCategory(EmpWorkRuleManagerEJB.class.getName());</span>
<span class="fc" id="L60">	private boolean m_isWhatIf = false;</span>
	private WorkResourceManager m_workResourceManager;
	private WorkRuleManager m_workRuleManager;

	/** override the base class to provide the appropriate logging category */
	protected Category getCategory() {
<span class="fc" id="L66">		return m_cat;</span>
	}

	{
<span class="fc" id="L70">		super.init(EmpWorkRuleManagerEJB.class.getName());</span>
<span class="fc" id="L71">	}</span>

	/**
	 * Perform one-time initialization of this EJB instance
	 */
	public void onEjbCreate() {
		try {
			// First query environment to get WIF setting from DD
<span class="fc" id="L79">			Context initialContext = new InitialContext();</span>
<span class="fc" id="L80">			Boolean WIF = (Boolean) initialContext.lookup(&quot;java:comp/env/WIF&quot;);</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">			if (WIF != null)</span>
<span class="fc" id="L82">				m_isWhatIf = WIF.booleanValue();</span>

<span class="fc" id="L84">			m_workResourceManager = BbmManagerFactory.getWorkResourceManager(m_isWhatIf);</span>
<span class="fc" id="L85">			m_workRuleManager = WfmManagerFactory.getWorkRuleManager(m_isWhatIf);</span>
<span class="nc" id="L86">		} catch (Exception e) {</span>
<span class="nc" id="L87">			handleException(&quot;onEjbCreate&quot;, e, false);</span>
<span class="fc" id="L88">		}</span>
<span class="fc" id="L89">	}</span>

	/**************************************************************************
	 * functions for work pattern assignments
	 **************************************************************************/
	/**
	 * get a given work resource's work pattern assignments
	 *
	 * @idWorkResource work resource id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of WorkResourceWorkPattern objects which hold the
	 *         assignment information
	 */
	public Collection&lt;WorkResourceWorkPattern&gt; getWorkPatternAssignments(ID idWorkResource, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L105">		methodStart(&quot;getWorkPatternAssignments&quot;, idWorkResource, dtStart, dtEnd);</span>
<span class="nc" id="L106">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L108">			return dao.getWorkPatternAssignments(idWorkResource, dtStart, dtEnd);</span>
<span class="nc" id="L109">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L110">			handleException(e, false);</span>
<span class="nc" id="L111">			throw e;</span>
		} finally {
<span class="nc" id="L113">			dao.cleanUp();</span>
<span class="nc" id="L114">			methodFinish();</span>
		}
	}

	/**
	 * This method is similar to getWorkPatternAssignments(ID idWorkResource,
	 * Date dtStart, Date dtEnd), however that method does not populate the SIDs
	 * of the WorkResourceWorkPattern value objects, whereas this one does. This
	 * method was added rather than refactoring getWorkPatternAssignments since
	 * that method might be used by the FS client.
	 */
	public Collection&lt;WorkResourceWorkPattern&gt; getWorkPatternAssignmentsForEmployee(ID idWorkResource, Date dtStart,
			Date dtEnd) throws BbmFinderException {
<span class="nc" id="L127">		methodStart(&quot;getWorkPatternAssignmentsForEmployee&quot;, idWorkResource, dtStart, dtEnd);</span>
<span class="nc" id="L128">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L130">			HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; assignments = getWorkPatternAssignments(</span>
<span class="nc" id="L131">					Collections.singleton(idWorkResource), dtStart, dtEnd);</span>

<span class="nc" id="L133">			return assignments.get(idWorkResource);</span>
<span class="nc" id="L134">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L135">			handleException(e, false);</span>
<span class="nc" id="L136">			throw e;</span>
		} finally {
<span class="nc" id="L138">			dao.cleanUp();</span>
<span class="nc" id="L139">			methodFinish();</span>
		}
	}

	/**
	 * get a given work resource's work pattern assignments
	 *
	 * @colWorkResourceIDs a collection of work resource ids
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a HashMap of following pairs (idWorkResource, array list of
	 *         workresource's workpattern assignments)
	 */
	public HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; getWorkPatternAssignments(
			Collection&lt;ID&gt; colWorkResourceIDs, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L154">		methodStart(&quot;getWorkPatternAssignments&quot;, colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="fc" id="L155">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="fc" id="L157">			return dao.getWorkPatternAssignments(colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L158">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L159">			handleException(e, false);</span>
<span class="nc" id="L160">			throw e;</span>
		} finally {
<span class="pc" id="L162">			dao.cleanUp();</span>
<span class="pc" id="L163">			methodFinish();</span>
		}
	}

	/**
	 * get a list of work pattern assignment given their IDs
	 */
	public Collection getWorkPatternAssignmentsByIDs(Collection colIDSAs) throws BbmFinderException {
<span class="nc" id="L171">		methodStart(&quot;getWorkPatternAssignmentsByIDs&quot;, colIDSAs);</span>
<span class="nc" id="L172">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L174">			return dao.getWorkPatternAssignmentsByIDs(colIDSAs);</span>
<span class="nc" id="L175">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L176">			handleException(e, false);</span>
<span class="nc" id="L177">			throw e;</span>
		} finally {
<span class="nc" id="L179">			dao.cleanUp();</span>
<span class="nc" id="L180">			methodFinish();</span>
		}
	}

	/** create a work pattern assignment */
	public ID createWorkPatternAssignment(WorkResourceWorkPattern objValue) throws BbmCreateException {
<span class="nc" id="L186">		methodStart(&quot;createWorkPatternAssignment&quot;, objValue);</span>
<span class="nc" id="L187">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L189">			return dao.createWorkPatternAssignment(objValue);</span>
<span class="nc" id="L190">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L191">			handleException(e);</span>
<span class="nc" id="L192">			throw e;</span>
		} finally {
<span class="nc" id="L194">			dao.cleanUp();</span>
<span class="nc" id="L195">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; createWorkPatternAssignments(Collection&lt;WorkResourceWorkPattern&gt; wrwps)
			throws BbmCreateException {
<span class="fc" id="L201">		methodStart(&quot;createWorkPatternAssignments&quot;, wrwps);</span>
<span class="fc" id="L202">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
<span class="fc" id="L203">		Collection&lt;ID&gt; wrwpIDs = new ArrayList&lt;ID&gt;();</span>
		try {
<span class="fc bfc" id="L205" title="All 2 branches covered.">			for (WorkResourceWorkPattern wrwp : wrwps) {</span>
<span class="fc" id="L206">				wrwp.setCreatedBy(m_sessionContext.getCallerPrincipal().getName());</span>
<span class="fc" id="L207">				wrwp.setCreatedDate(new Date(System.currentTimeMillis()));</span>
<span class="fc" id="L208">				wrwpIDs.add(dao.createWorkPatternAssignment(wrwp));</span>
<span class="fc" id="L209">			}</span>
<span class="fc" id="L210">			return wrwpIDs;</span>
<span class="nc" id="L211">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L212">			handleException(e);</span>
<span class="nc" id="L213">			throw e;</span>
		} finally {
<span class="pc" id="L215">			dao.cleanUp();</span>
<span class="pc" id="L216">			methodFinish();</span>
		}
	}

	/** save a work pattern assignment */
	public void updateWorkPatternAssignment(WorkResourceWorkPattern objValue, boolean bSaveAsNew)
			throws MultiUserException, BbmUpdateException {
<span class="nc" id="L223">		methodStart(&quot;updateWorkPatternAssignment&quot;, objValue);</span>
<span class="nc" id="L224">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L226">			objValue.setModifiedBy(m_sessionContext.getCallerPrincipal().getName());</span>
<span class="nc" id="L227">			objValue.setModifiedDate(new Date(System.currentTimeMillis()));</span>
<span class="nc" id="L228">			dao.updateWorkPatternAssignment(objValue, bSaveAsNew);</span>
<span class="nc" id="L229">		} catch (MultiUserException e) {</span>
<span class="nc" id="L230">			handleException(e);</span>
<span class="nc" id="L231">			throw e;</span>
<span class="nc" id="L232">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L233">			handleException(e);</span>
<span class="nc" id="L234">			throw e;</span>
		} finally {
<span class="nc" id="L236">			dao.cleanUp();</span>
<span class="nc" id="L237">			methodFinish();</span>
<span class="nc" id="L238">		}</span>
<span class="nc" id="L239">	}</span>

	/** delete work pattern assignments given their assignment ids */
	public void deleteWorkPatternAssignments(Collection&lt;ID&gt; colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L243">		methodStart(&quot;deleteWorkPatternAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L244">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L246">			dao.deleteWorkPatternAssignments(colIDAssignments);</span>
<span class="nc" id="L247">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L248">			handleException(e);</span>
<span class="nc" id="L249">			throw e;</span>
		} finally {
<span class="nc" id="L251">			dao.cleanUp();</span>
<span class="nc" id="L252">			methodFinish();</span>
<span class="nc" id="L253">		}</span>
<span class="nc" id="L254">	}</span>

	/**
	 * This method will delete the work pattern assignments in
	 * assignmentsToDelete, and will create new assignments for the assignments
	 * in assignmentsToCreate.
	 */
	public void saveWorkPatternAssignments(Collection&lt;WorkResourceWorkPattern&gt; assignmentsToDelete,
			Collection&lt;WorkResourceWorkPattern&gt; assignmentsToCreate) throws BbmCreateException {

<span class="fc" id="L264">		methodStart(&quot;saveWorkPatternAssignments&quot;, assignmentsToDelete, assignmentsToCreate);</span>
<span class="fc" id="L265">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
			// To delete a workresourceworkpattern, set its preference value to
			// 0 and set IsActive to false
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">			for (WorkResourceWorkPattern assignment : assignmentsToDelete) {</span>
<span class="nc" id="L270">				assignment.setIsActive(false);</span>
<span class="nc" id="L271">				assignment.setPreference(0);</span>
<span class="nc" id="L272">			}</span>
			// Deleting assignments can be thought of as &quot;creating&quot; an
			// assignment that is not actually assigned,
			// in other words subtracting from any assignment that may intersect
			// the date range of the assignment
			// we are trying to delete.
<span class="fc" id="L278">			createWorkPatternAssignments(assignmentsToDelete);</span>
<span class="fc" id="L279">			createWorkPatternAssignments(assignmentsToCreate);</span>
<span class="nc" id="L280">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L281">			handleException(e);</span>
<span class="nc" id="L282">			throw e;</span>
		} finally {
<span class="pc" id="L284">			dao.cleanUp();</span>
<span class="pc" id="L285">			methodFinish();</span>
<span class="fc" id="L286">		}</span>
<span class="fc" id="L287">	}</span>

	/**************************************************************************
	 * functions for time bank assignments
	 **************************************************************************/
	/**
	 * get a given employee's time bank assignments
	 *
	 * @idEmployee employee id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of EmpTimeBank objects which hold the assignment
	 *         information
	 */
	public Collection getTimeBankAssignments(ID idEmployee, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L302">		methodStart(&quot;getTimeBankAssignments&quot;, idEmployee, dtStart, dtEnd);</span>
<span class="nc" id="L303">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L305">			return dao.getTimeBankAssignments(idEmployee, dtStart, dtEnd);</span>
<span class="nc" id="L306">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L307">			handleException(e, false);</span>
<span class="nc" id="L308">			throw e;</span>
		} finally {
<span class="nc" id="L310">			dao.cleanUp();</span>
<span class="nc" id="L311">			methodFinish();</span>
		}
	}

	/**
	 * get a collection of employees' time bank assignments
	 *
	 * @colEmployeeIDs a collection of employee ids
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a HashMap of following pairs (idEmployee, array list of
	 *         EmpTimeBank (i.e. the employee's time bank assignments))
	 */
	public HashMap&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; getTimeBankAssignments(Collection&lt;ID&gt; colEmployeeIDs, Date dtStart,
			Date dtEnd) throws BbmFinderException {
<span class="fc" id="L326">		methodStart(&quot;getTimeBankAssignments&quot;, colEmployeeIDs, dtStart, dtEnd);</span>
<span class="fc" id="L327">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="fc" id="L329">			return dao.getTimeBankAssignments(colEmployeeIDs, dtStart, dtEnd);</span>
<span class="nc" id="L330">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L331">			handleException(e, false);</span>
<span class="nc" id="L332">			throw e;</span>
		} finally {
<span class="pc" id="L334">			dao.cleanUp();</span>
<span class="pc" id="L335">			methodFinish();</span>
		}
	}

	/**
	 * get a list of time bank assignment given their IDs
	 */
	public Collection getTimeBankAssignmentsByIDs(Collection colIDSAs) throws BbmFinderException {
<span class="nc" id="L343">		methodStart(&quot;getTimeBankAssignmentsByIDs&quot;, colIDSAs);</span>
<span class="nc" id="L344">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L346">			return dao.getTimeBankAssignmentsByIDs(colIDSAs);</span>
<span class="nc" id="L347">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L348">			handleException(e, false);</span>
<span class="nc" id="L349">			throw e;</span>
		} finally {
<span class="nc" id="L351">			dao.cleanUp();</span>
<span class="nc" id="L352">			methodFinish();</span>
		}
	}

	/** create a time bank assignment */
	public ID createTimeBankAssignment(EmpTimeBank objValue) throws BbmCreateException {
<span class="nc" id="L358">		methodStart(&quot;createTimeBankAssignment&quot;, objValue);</span>
<span class="nc" id="L359">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L361">			return dao.createTimeBankAssignment(objValue);</span>
<span class="nc" id="L362">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L363">			handleException(e);</span>
<span class="nc" id="L364">			throw e;</span>
		} finally {
<span class="nc" id="L366">			dao.cleanUp();</span>
<span class="nc" id="L367">			methodFinish();</span>
		}
	}

	/**
	 * Creates a time bank assignment, but prior to creation will remove any
	 * existing time banks that overlap with the given time bank for the given
	 * employee.
	 */
	public ID createTimeBankAssignmentWithNoOverlap(EmpTimeBank objValue) throws BbmCreateException {
<span class="nc" id="L377">		methodStart(&quot;createTimeBankAssignmentWithNoOverlap&quot;, objValue);</span>
<span class="nc" id="L378">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L380">			return dao.createTimeBankAssignmentWithNoOverlap(objValue);</span>
<span class="nc" id="L381">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L382">			handleException(e);</span>
<span class="nc" id="L383">			throw e;</span>
		} finally {
<span class="nc" id="L385">			dao.cleanUp();</span>
<span class="nc" id="L386">			methodFinish();</span>
		}
	}

	/** save a time bank assignment */
	public void updateTimeBankAssignment(EmpTimeBank objValue, boolean bSaveAsNew) throws MultiUserException,
			BbmUpdateException {
<span class="nc" id="L393">		methodStart(&quot;updateTimeBankAssignment&quot;, objValue);</span>
<span class="nc" id="L394">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L396">			dao.updateTimeBankAssignment(objValue, bSaveAsNew);</span>
<span class="nc" id="L397">		} catch (MultiUserException e) {</span>
<span class="nc" id="L398">			handleException(e);</span>
<span class="nc" id="L399">			throw e;</span>
<span class="nc" id="L400">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L401">			handleException(e);</span>
<span class="nc" id="L402">			throw e;</span>
		} finally {
<span class="nc" id="L404">			dao.cleanUp();</span>
<span class="nc" id="L405">			methodFinish();</span>
<span class="nc" id="L406">		}</span>
<span class="nc" id="L407">	}</span>

	/** delete time bank assignments given their assignment ids */
	public void deleteTimeBankAssignments(Collection colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L411">		methodStart(&quot;deleteTimeBankAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L412">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L414">			dao.deleteTimeBankAssignments(colIDAssignments);</span>
<span class="nc" id="L415">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L416">			handleException(e);</span>
<span class="nc" id="L417">			throw e;</span>
		} finally {
<span class="nc" id="L419">			dao.cleanUp();</span>
<span class="nc" id="L420">			methodFinish();</span>
<span class="nc" id="L421">		}</span>
<span class="nc" id="L422">	}</span>

	/**
	 * Returns a collection of PaginationPair objects with TimeBank data (used
	 * for pagination). The time banks returned will be the time banks that are
	 * available to be assigned to ALL of the given employees (workResourceIDs)
	 * for the date range between startDate and endDate. This is used when
	 * adding new time bank assignments to employees.
	 */
	public PaginationPair&lt;TimeBank&gt; getAvailableTimeBanksForEmployees(Collection&lt;ID&gt; workResourceIDs, Date startDate,
			Date endDate, boolean isAscendingSort, int pageIDSize, int pageIndex,
			LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap, Collection&lt;ID&gt; filteredIDs) throws BbmFinderException {
<span class="nc" id="L434">		methodStart(&quot;getAvailableTimeBanksForEmployees&quot;, workResourceIDs, startDate, endDate);</span>
<span class="nc" id="L435">		TimeBankDAO dao = new TimeBankDAO();</span>
		try {
<span class="nc" id="L437">			Collection&lt;ID&gt; orgIDsAndParents = m_workResourceManager.getOrgIDsThatMayOwnFlowDownObjects(workResourceIDs,</span>
					startDate, endDate);
<span class="nc" id="L439">			return dao.getAvailableTimeBanksForEmployees(orgIDsAndParents, workResourceIDs, startDate, endDate,</span>
					isAscendingSort, pageIDSize, pageIndex, sortFieldMap, filteredIDs);
<span class="nc" id="L441">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L442">			handleException(e, false);</span>
<span class="nc" id="L443">			throw e;</span>
<span class="nc" id="L444">		} catch (Exception e) {</span>
<span class="nc" id="L445">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L447">			dao.cleanUp();</span>
<span class="nc" id="L448">			methodFinish();</span>
		}
	}

	/**************************************************************************
	 * functions for min-max hour assignments
	 **************************************************************************/
	/**
	 * get a given work resource's min-max hour assignments
	 *
	 * @idWorkResource work resource id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of WorkResourceMinMaxHour objects which hold the
	 *         assignment information
	 */
	public Collection&lt;WorkResourceMinMaxHour&gt; getMinMaxHourAssignments(ID idWorkResource, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L466">		methodStart(&quot;getMinMaxHourAssignments&quot;, idWorkResource, dtStart, dtEnd);</span>
<span class="nc" id="L467">		WorkResourceMinMaxHourDAO dao = new WorkResourceMinMaxHourDAO();</span>
		try {
<span class="nc" id="L469">			List&lt;ID&gt; aWorkResources = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L470">			aWorkResources.add(idWorkResource);</span>
<span class="nc" id="L471">			return dao.getMinMaxHourAssignments(aWorkResources, dtStart, dtEnd).get(idWorkResource);</span>
<span class="nc" id="L472">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L473">			handleException(e, false);</span>
<span class="nc" id="L474">			throw e;</span>
		} finally {
<span class="nc" id="L476">			dao.cleanUp();</span>
<span class="nc" id="L477">			methodFinish();</span>
		}
	}

	/**
	 * get a collection of workresources' min-max hour assignments
	 *
	 * @colWorkResourceIDs a collection of work resource ids
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a HashMap of following pairs (idWorkResource, array list of
	 *         WorkResourceMinMaxHour objects)
	 */
	public HashMap&lt;ID, List&lt;WorkResourceMinMaxHour&gt;&gt; getMinMaxHourAssignments(Collection&lt;ID&gt; colWorkResourceIDs,
			Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L492">		methodStart(&quot;getMinMaxHourAssignments&quot;, colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="fc" id="L493">		WorkResourceMinMaxHourDAO dao = new WorkResourceMinMaxHourDAO();</span>
		try {
<span class="fc" id="L495">			return dao.getMinMaxHourAssignments(colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L496">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L497">			handleException(e, false);</span>
<span class="nc" id="L498">			throw e;</span>
		} finally {
<span class="pc" id="L500">			dao.cleanUp();</span>
<span class="pc" id="L501">			methodFinish();</span>
		}
	}

	/**
	 * get a list of min-max hour assignments given their IDs
	 */
	public Collection getMinMaxHourAssignmentsByIDs(Collection colIDSAs) throws BbmFinderException {
<span class="nc" id="L509">		methodStart(&quot;getMinMaxHourAssignmentsByIDs&quot;, colIDSAs);</span>
<span class="nc" id="L510">		WorkResourceMinMaxHourDAO dao = new WorkResourceMinMaxHourDAO();</span>
		try {
<span class="nc" id="L512">			return dao.getMinMaxHourAssignmentsByIDs(colIDSAs);</span>
<span class="nc" id="L513">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L514">			handleException(e, false);</span>
<span class="nc" id="L515">			throw e;</span>
		} finally {
<span class="nc" id="L517">			dao.cleanUp();</span>
<span class="nc" id="L518">			methodFinish();</span>
		}
	}

	/** create a min-max hour assignment */
	public ID createMinMaxHourAssignment(WorkResourceMinMaxHour objValue) throws BbmCreateException {
<span class="fc" id="L524">		methodStart(&quot;createMinMaxHourAssignment&quot;, objValue);</span>
<span class="fc" id="L525">		WorkResourceMinMaxHourDAO dao = new WorkResourceMinMaxHourDAO();</span>
		try {
<span class="fc" id="L527">			return dao.createMinMaxHourAssignment(objValue);</span>
<span class="nc" id="L528">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L529">			handleException(e);</span>
<span class="nc" id="L530">			throw e;</span>
		} finally {
<span class="pc" id="L532">			dao.cleanUp();</span>
<span class="pc" id="L533">			methodFinish();</span>
		}
	}

	/** save a min-max hour assignment */
	public void updateMinMaxHourAssignment(WorkResourceMinMaxHour objValue, boolean bSaveAsNew)
			throws MultiUserException, BbmUpdateException {
<span class="fc" id="L540">		methodStart(&quot;updateMinMaxHourAssignment&quot;, objValue);</span>
<span class="fc" id="L541">		WorkResourceMinMaxHourDAO dao = new WorkResourceMinMaxHourDAO();</span>
		try {
<span class="fc" id="L543">			dao.updateMinMaxHourAssignment(objValue, bSaveAsNew);</span>
<span class="nc" id="L544">		} catch (MultiUserException e) {</span>
<span class="nc" id="L545">			handleException(e);</span>
<span class="nc" id="L546">			throw e;</span>
<span class="nc" id="L547">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L548">			handleException(e);</span>
<span class="nc" id="L549">			throw e;</span>
		} finally {
<span class="pc" id="L551">			dao.cleanUp();</span>
<span class="pc" id="L552">			methodFinish();</span>
<span class="fc" id="L553">		}</span>
<span class="fc" id="L554">	}</span>

	/** delete min-max hour assignments given their assignment ids */
	public void deleteMinMaxHourAssignments(Collection colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L558">		methodStart(&quot;deleteMinMaxHourAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L559">		WorkResourceMinMaxHourDAO dao = new WorkResourceMinMaxHourDAO();</span>
		try {
<span class="nc" id="L561">			dao.deleteMinMaxHourAssignments(colIDAssignments);</span>
<span class="nc" id="L562">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L563">			handleException(e);</span>
<span class="nc" id="L564">			throw e;</span>
		} finally {
<span class="nc" id="L566">			dao.cleanUp();</span>
<span class="nc" id="L567">			methodFinish();</span>
<span class="nc" id="L568">		}</span>
<span class="nc" id="L569">	}</span>

	public Map&lt;ID, List&lt;WorkResourceMonthlyMinMaxHour&gt;&gt; getMonthlyMinMaxHourAssignments(Collection&lt;ID&gt; workResourceIDs,
			int year) throws BbmFinderException, RemoteException {
<span class="fc" id="L573">		methodStart(&quot;getMonthlyMinMaxHourAssignments&quot;, workResourceIDs, year);</span>

<span class="fc" id="L575">		WorkResourceMonthlyMinMaxHourDAO dao = new WorkResourceMonthlyMinMaxHourDAO();</span>
		try {
<span class="fc" id="L577">			return dao.getObjectsByWorkResourceIdAndYear(workResourceIDs, year);</span>
<span class="nc" id="L578">		} catch (JdmoException e) {</span>
<span class="nc" id="L579">			handleException(e);</span>
<span class="nc" id="L580">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L582">			dao.cleanUp();</span>
<span class="pc" id="L583">			methodFinish();</span>
		}
	}

	public void saveMonthlyMinMaxHourAssignments(Map&lt;ID, List&lt;WorkResourceMonthlyMinMaxHour&gt;&gt; hoursAssignments)
			throws BbmUpdateException, BbmCreateException, MultiUserException, RemoteException {
<span class="nc" id="L589">		methodStart(&quot;saveMonthlyMinMaxHourAssignments&quot;, hoursAssignments);</span>
<span class="nc" id="L590">		WorkResourceMonthlyMinMaxHourDAO dao = new WorkResourceMonthlyMinMaxHourDAO();</span>

		try {
<span class="nc" id="L593">			List&lt;WorkResourceMonthlyMinMaxHour&gt; recordsToCreate = new ArrayList&lt;WorkResourceMonthlyMinMaxHour&gt;();</span>
<span class="nc" id="L594">			List&lt;WorkResourceMonthlyMinMaxHour&gt; recordsToUpdate = new ArrayList&lt;WorkResourceMonthlyMinMaxHour&gt;();</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">			for (ID employeeID : hoursAssignments.keySet()) {</span>
<span class="nc" id="L596">				List&lt;WorkResourceMonthlyMinMaxHour&gt; employeeHours = hoursAssignments.get(employeeID);</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">				for (int month = 0; month &lt; 12; month++) {</span>
<span class="nc" id="L598">					WorkResourceMonthlyMinMaxHour monthlyHours = employeeHours.get(month);</span>

<span class="nc bnc" id="L600" title="All 2 branches missed.">					if (monthlyHours.isNewRecord()) {</span>
<span class="nc" id="L601">						recordsToCreate.add(monthlyHours);</span>
					} else {
<span class="nc" id="L603">						recordsToUpdate.add(monthlyHours);</span>
					}
				}
<span class="nc" id="L606">			}</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">			if (recordsToUpdate.size() &gt; 0) {</span>
<span class="nc" id="L608">				dao.updateObjects(recordsToUpdate);</span>
			}
<span class="nc bnc" id="L610" title="All 2 branches missed.">			if (recordsToCreate.size() &gt; 0) {</span>
<span class="nc" id="L611">				dao.createObjects(recordsToCreate);</span>
			}
<span class="nc" id="L613">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L614">			handleException(e);</span>
<span class="nc" id="L615">			throw e;</span>
<span class="nc" id="L616">		} catch (MultiUserException e) {</span>
<span class="nc" id="L617">			handleException(e);</span>
<span class="nc" id="L618">			throw e;</span>
<span class="nc" id="L619">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L620">			handleException(e);</span>
<span class="nc" id="L621">			throw e;</span>
		} finally {
<span class="nc" id="L623">			dao.cleanUp();</span>
<span class="nc" id="L624">			methodFinish();</span>
<span class="nc" id="L625">		}</span>
<span class="nc" id="L626">	}</span>

	// ggong
	/**************************************************************************
	 * functions for min-max hour assignments
	 **************************************************************************/
	/**
	 * get a given work resource's Pooling Rule assignments
	 *
	 * @idWorkResource work resource id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of EmpPoolingRule objects which hold the assignment
	 *         information
	 */
	public Collection&lt;EmpPoolingRule&gt; getPoolingRuleAssignments(ID idWorkResource, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L643">		methodStart(&quot;getPoolingRuleAssignments&quot;, idWorkResource, dtStart, dtEnd);</span>
<span class="nc" id="L644">		EmpPoolingRuleDAO dao = new EmpPoolingRuleDAO();</span>
		try {
<span class="nc" id="L646">			ArrayList aWorkResources = new ArrayList();</span>
<span class="nc" id="L647">			aWorkResources.add(idWorkResource);</span>
<span class="nc" id="L648">			return (Collection) dao.getPoolingRuleAssignments(aWorkResources, dtStart, dtEnd).get(idWorkResource);</span>
<span class="nc" id="L649">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L650">			handleException(e, false);</span>
<span class="nc" id="L651">			throw e;</span>
		} finally {
<span class="nc" id="L653">			dao.cleanUp();</span>
<span class="nc" id="L654">			methodFinish();</span>
		}
	}

	/**
	 * get a collection of workresources' Pooling Rule assignments
	 *
	 * @colWorkResourceIDs a collection of work resource ids
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a HashMap of following pairs (idWorkResource, array list of
	 *         EmpPoolingRule objects)
	 */
	public HashMap getPoolingRuleAssignments(Collection colWorkResourceIDs, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="fc" id="L669">		methodStart(&quot;getPoolingRuleAssignments&quot;, colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="fc" id="L670">		EmpPoolingRuleDAO dao = new EmpPoolingRuleDAO();</span>
		try {
<span class="fc" id="L672">			return dao.getPoolingRuleAssignments(colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L673">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L674">			handleException(e, false);</span>
<span class="nc" id="L675">			throw e;</span>
		} finally {
<span class="pc" id="L677">			dao.cleanUp();</span>
<span class="pc" id="L678">			methodFinish();</span>
		}
	}

	/**
	 * get a list of Pooling Rule assignments given their IDs
	 */
	public Collection getPoolingRuleAssignmentsByIDs(Collection colIDSAs) throws BbmFinderException {
<span class="nc" id="L686">		methodStart(&quot;getPoolingRuleAssignmentsByIDs&quot;, colIDSAs);</span>
<span class="nc" id="L687">		EmpPoolingRuleDAO dao = new EmpPoolingRuleDAO();</span>
		try {
<span class="nc" id="L689">			return dao.getPoolingRuleAssignmentsByIDs(colIDSAs);</span>
<span class="nc" id="L690">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L691">			handleException(e, false);</span>
<span class="nc" id="L692">			throw e;</span>
		} finally {
<span class="nc" id="L694">			dao.cleanUp();</span>
<span class="nc" id="L695">			methodFinish();</span>
		}
	}

	/** create a Pooling Rule assignment */
	public ID createPoolingRuleAssignment(EmpPoolingRule objValue) throws BbmCreateException {
<span class="fc" id="L701">		methodStart(&quot;createMinMaxHourAssignment&quot;, objValue);</span>
<span class="fc" id="L702">		EmpPoolingRuleDAO dao = new EmpPoolingRuleDAO();</span>
		try {
<span class="fc" id="L704">			return dao.createPoolingRuleAssignment(objValue);</span>
<span class="nc" id="L705">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L706">			handleException(e);</span>
<span class="nc" id="L707">			throw e;</span>
		} finally {
<span class="pc" id="L709">			dao.cleanUp();</span>
<span class="pc" id="L710">			methodFinish();</span>
		}
	}

	/** save a Pooling Rule assignment */
	public void updatePoolingRuleAssignment(EmpPoolingRule objValue, boolean bSaveAsNew) throws MultiUserException,
			BbmUpdateException {
<span class="nc" id="L717">		methodStart(&quot;updatePoolingRuleAssignment&quot;, objValue);</span>
<span class="nc" id="L718">		EmpPoolingRuleDAO dao = new EmpPoolingRuleDAO();</span>
		try {
<span class="nc" id="L720">			dao.updatePoolingRuleAssignment(objValue, bSaveAsNew);</span>
<span class="nc" id="L721">		} catch (MultiUserException e) {</span>
<span class="nc" id="L722">			handleException(e);</span>
<span class="nc" id="L723">			throw e;</span>
<span class="nc" id="L724">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L725">			handleException(e);</span>
<span class="nc" id="L726">			throw e;</span>
		} finally {
<span class="nc" id="L728">			dao.cleanUp();</span>
<span class="nc" id="L729">			methodFinish();</span>
<span class="nc" id="L730">		}</span>
<span class="nc" id="L731">	}</span>

	/** delete Pooling Rule hour assignments given their assignment ids */
	public void deletePoolingRuleAssignments(Collection colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L735">		methodStart(&quot;deletePoolingRuleAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L736">		EmpPoolingRuleDAO dao = new EmpPoolingRuleDAO();</span>
		try {
<span class="nc" id="L738">			dao.deletePoolingRuleAssignments(colIDAssignments);</span>
<span class="nc" id="L739">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L740">			handleException(e);</span>
<span class="nc" id="L741">			throw e;</span>
		} finally {
<span class="nc" id="L743">			dao.cleanUp();</span>
<span class="nc" id="L744">			methodFinish();</span>
<span class="nc" id="L745">		}</span>
<span class="nc" id="L746">	}</span>

	// finish ggong

	/**************************************************************************
	 * functions for work rule assignments
	 **************************************************************************/
	/**
	 * get a given work resource's work rule assignments
	 *
	 * @param idWorkResource
	 *            work resource id
	 * @param dtStart
	 *            , @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of work rule ids that assigned to the work resource
	 */
	public Collection getWorkRuleAssignments(ID idWorkResource) throws BbmFinderException {
<span class="nc" id="L764">		methodStart(&quot;getWorkRuleAssignments&quot;, idWorkResource);</span>
<span class="nc" id="L765">		WorkResourceWorkRuleDAO dao = new WorkResourceWorkRuleDAO();</span>
		try {
<span class="nc" id="L767">			return dao.getWorkRuleAssignments(idWorkResource);</span>
<span class="nc" id="L768">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L769">			handleException(e, false);</span>
<span class="nc" id="L770">			throw e;</span>
		} finally {
<span class="nc" id="L772">			dao.cleanUp();</span>
<span class="nc" id="L773">			methodFinish();</span>
		}
	}

	/**
	 * get work rule assignments for a collection of work resource ids
	 *
	 * @param colWorkResourceIDs
	 *            a collection of work resource ids
	 *
	 * @return a HashMap of following pairs (idWorkResource, collection of work
	 *         rule ids)
	 */
	public HashMap getWorkRuleAssignments(Collection colWorkResourceIDs) throws BbmFinderException {
<span class="nc" id="L787">		methodStart(&quot;getWorkRuleAssignments&quot;, colWorkResourceIDs);</span>
<span class="nc" id="L788">		WorkResourceWorkRuleDAO dao = new WorkResourceWorkRuleDAO();</span>
		try {
<span class="nc" id="L790">			return dao.getWorkRuleAssignments(colWorkResourceIDs);</span>
<span class="nc" id="L791">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L792">			handleException(e, false);</span>
<span class="nc" id="L793">			throw e;</span>
		} finally {
<span class="nc" id="L795">			dao.cleanUp();</span>
<span class="nc" id="L796">			methodFinish();</span>
		}
	}

	/** create a work rule assignment */
	public void createWorkRuleAssignments(ID idWorkResource, Collection colWorkRuleIDs) throws BbmCreateException {
<span class="nc" id="L802">		methodStart(&quot;createWorkRuleAssignment&quot;, idWorkResource, colWorkRuleIDs);</span>
<span class="nc" id="L803">		WorkResourceWorkRuleDAO dao = new WorkResourceWorkRuleDAO();</span>
		try {
<span class="nc" id="L805">			dao.createWorkRuleAssignments(idWorkResource, colWorkRuleIDs);</span>
<span class="nc" id="L806">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L807">			handleException(e);</span>
<span class="nc" id="L808">			throw e;</span>
		} finally {
<span class="nc" id="L810">			dao.cleanUp();</span>
<span class="nc" id="L811">			methodFinish();</span>
<span class="nc" id="L812">		}</span>
<span class="nc" id="L813">	}</span>

	/** delete work rules assignments */
	public void deleteWorkRuleAssignments(ID idWorkResource, Collection colWorkRuleIDs) throws BbmRemoveException {
<span class="nc" id="L817">		methodStart(&quot;deleteWorkRuleAssignments&quot;, idWorkResource, colWorkRuleIDs);</span>
<span class="nc" id="L818">		WorkResourceWorkRuleDAO dao = new WorkResourceWorkRuleDAO();</span>
		try {
<span class="nc" id="L820">			dao.deleteWorkRuleAssignments(idWorkResource, colWorkRuleIDs);</span>
<span class="nc" id="L821">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L822">			handleException(e);</span>
<span class="nc" id="L823">			throw e;</span>
		} finally {
<span class="nc" id="L825">			dao.cleanUp();</span>
<span class="nc" id="L826">			methodFinish();</span>
<span class="nc" id="L827">		}</span>
<span class="nc" id="L828">	}</span>

	/**
	 * get WorkPatternAssignments where the WorkPattern's SHIFTWORKPATTERNSETID
	 * = idSet. This method would be useful in scheduling with a Work Pattern
	 * Set filter and for deleting and updated Work Pattern Sets.
	 */
	public HashMap getWorkPatternAssignmentsBySet(Collection colWorkResourceIDs, Date dtStart, Date dtEnd,
			ID idWorkPatternSet) throws BbmFinderException {
<span class="nc" id="L837">		methodStart(&quot;getWorkPatternAssignmentsBySet&quot;, colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L838">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L840">			return dao.getWorkPatternAssignmentsBySet(colWorkResourceIDs, dtStart, dtEnd, idWorkPatternSet);</span>
<span class="nc" id="L841">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L842">			handleException(e, false);</span>
<span class="nc" id="L843">			throw e;</span>
		} finally {
<span class="nc" id="L845">			dao.cleanUp();</span>
<span class="nc" id="L846">			methodFinish();</span>
		}
	}

	public HashMap getWorkRuleAndPayRuleAssignments(Collection colWorkResourceIDs, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L852">		methodStart(&quot;getWorkRuleAndPayRuleAssignments&quot;, colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L853">		HashMap hRules = new HashMap();</span>
		try {
<span class="nc" id="L855">			HashMap hAssignmentRules = getWorkRuleAssignments(colWorkResourceIDs);</span>

<span class="nc" id="L857">			PayPolicyManager mPayPolicy = BbmManagerFactory.getPayPolicyManager();</span>
<span class="nc" id="L858">			WorkResourceManager mResourceManager = BbmManagerFactory.getWorkResourceManager();</span>

<span class="nc" id="L860">			HashMap hPayPolicyAssignments = mResourceManager.getWorkResourcePayPolicies(colWorkResourceIDs, dtStart,</span>
					dtEnd);

<span class="nc" id="L863">			TreeSet tPayPolicies = new TreeSet();</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">			for (Iterator i = hPayPolicyAssignments.values().iterator(); i.hasNext();) {</span>
<span class="nc" id="L865">				Collection cPayPolicyAssignments = (Collection) i.next();</span>
<span class="nc bnc" id="L866" title="All 2 branches missed.">				for (Iterator j = cPayPolicyAssignments.iterator(); j.hasNext();) {</span>
<span class="nc" id="L867">					WorkResourcePayPolicy pAssignment = (WorkResourcePayPolicy) j.next();</span>
<span class="nc" id="L868">					tPayPolicies.add(pAssignment.getPayPolicyID());</span>
<span class="nc" id="L869">				}</span>
<span class="nc" id="L870">			}</span>

<span class="nc" id="L872">			HashMap hPayPolicyWorkRules = new HashMap();</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">			for (Iterator i = tPayPolicies.iterator(); i.hasNext();) {</span>
<span class="nc" id="L874">				ID idPayPolicy = (ID) i.next();</span>
<span class="nc" id="L875">				hPayPolicyWorkRules.put(idPayPolicy, mPayPolicy.getWorkRuleForPayPolicy(idPayPolicy));</span>
<span class="nc" id="L876">			}</span>

<span class="nc bnc" id="L878" title="All 2 branches missed.">			for (Iterator i = colWorkResourceIDs.iterator(); i.hasNext();) {</span>
<span class="nc" id="L879">				ID idEmployee = (ID) i.next();</span>
<span class="nc" id="L880">				LinkedList llRuleAssignments = new LinkedList();</span>
<span class="nc" id="L881">				hRules.put(idEmployee, llRuleAssignments);</span>
<span class="nc" id="L882">				Collection cAssignmentRules = (Collection) hAssignmentRules.get(idEmployee);</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">				if (cAssignmentRules != null) {</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">					for (Iterator j = cAssignmentRules.iterator(); j.hasNext();) {</span>
<span class="nc" id="L885">						ID idAssignmentRule = (ID) j.next();</span>
<span class="nc" id="L886">						llRuleAssignments.add(new RuleAssignment(idAssignmentRule, null, null));</span>
<span class="nc" id="L887">					}</span>
				}
<span class="nc" id="L889">				Collection cPayPolicyAssignments = (Collection) hPayPolicyAssignments.get(idEmployee);</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">				if (cPayPolicyAssignments != null) {</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">					for (Iterator j = cPayPolicyAssignments.iterator(); j.hasNext();) {</span>
<span class="nc" id="L892">						WorkResourcePayPolicy pAssignment = (WorkResourcePayPolicy) j.next();</span>
<span class="nc" id="L893">						Collection cPayRules = (Collection) hPayPolicyWorkRules.get(pAssignment.getPayPolicyID());</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">						for (Iterator k = cPayRules.iterator(); k.hasNext();) {</span>
<span class="nc" id="L895">							ID idPayRule = (ID) k.next();</span>
<span class="nc" id="L896">							llRuleAssignments.add(new RuleAssignment(idPayRule, pAssignment.getStartTime(), pAssignment</span>
<span class="nc" id="L897">									.getEndTime()));</span>
<span class="nc" id="L898">						}</span>
<span class="nc" id="L899">					}</span>
				}
<span class="nc" id="L901">			}</span>
<span class="nc" id="L902">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L903">			handleException(e, false);</span>
<span class="nc" id="L904">			throw e;</span>
<span class="nc" id="L905">		} catch (RemoteException e) {</span>
<span class="nc" id="L906">			handleException(e);</span>
<span class="nc" id="L907">			throw new BbmFinderException(e);</span>
<span class="nc" id="L908">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L909">			handleException(e);</span>
<span class="nc" id="L910">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L912">			methodFinish();</span>
<span class="nc" id="L913">		}</span>
<span class="nc" id="L914">		return hRules;</span>
	}

	public Collection getWorkPatternIDNamePairs(Collection orgIDs) throws BbmFinderException {
<span class="nc" id="L918">		methodStart(&quot;getWorkPatternIDNamePairs&quot;, orgIDs);</span>
<span class="nc" id="L919">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L921">			return dao.getWorkPatternIDNamePairs(orgIDs);</span>
<span class="nc" id="L922">		} catch (BbmFinderException ex) {</span>
<span class="nc" id="L923">			handleException(ex, false);</span>
<span class="nc" id="L924">			throw ex;</span>
		} finally {
<span class="nc" id="L926">			dao.cleanUp();</span>
<span class="nc" id="L927">			methodFinish();</span>
		}
	}

	public Collection getShiftIDNamePairs(Collection orgIDs) throws BbmFinderException {
<span class="nc" id="L932">		methodStart(&quot;getShiftIDNamePairs&quot;, orgIDs);</span>
<span class="nc" id="L933">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L935">			return dao.getShiftIDNamePairs(orgIDs);</span>
<span class="nc" id="L936">		} catch (BbmFinderException ex) {</span>
<span class="nc" id="L937">			handleException(ex, false);</span>
<span class="nc" id="L938">			throw ex;</span>
		} finally {
<span class="nc" id="L940">			dao.cleanUp();</span>
<span class="nc" id="L941">			methodFinish();</span>
		}
	}

	public HashMap getWorkPatternAssignmentsInPeriodAndOnSpotOnly(Collection colWorkResourceIDs, Date dtStart,
			Date dtEnd, Date timeSpot) throws BbmFinderException {
<span class="fc" id="L947">		methodStart(&quot;getWorkPatternAssignmentsInPeriodAndOnSpotOnly&quot;, colWorkResourceIDs, dtStart, dtEnd, timeSpot);</span>
<span class="fc" id="L948">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="fc" id="L950">			return dao.getWorkPatternAssignmentsInPeriodAndOnSpotOnly(colWorkResourceIDs, dtStart, dtEnd, timeSpot);</span>
<span class="nc" id="L951">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L952">			handleException(e, false);</span>
<span class="nc" id="L953">			throw e;</span>
		} finally {
<span class="pc" id="L955">			dao.cleanUp();</span>
<span class="pc" id="L956">			methodFinish();</span>
		}
	}

	// === rotation rule APIs ========
	public HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; getRotationAssignments(Collection&lt;ID&gt; workResourceIDs)
			throws BbmFinderException {
<span class="fc" id="L963">		methodStart(&quot;getRotationAssignments&quot;, workResourceIDs);</span>
<span class="fc" id="L964">		WorkResourceRotationDAO dao = new WorkResourceRotationDAO();</span>
		try {
<span class="fc" id="L966">			StringBuffer where = new StringBuffer();</span>
<span class="fc" id="L967">			where.append(&quot; WORKRESOURCEID in &quot;).append(dao.getDMO().createInClause(workResourceIDs));</span>
<span class="fc" id="L968">			Collection&lt;WorkResourceRotation&gt; rules = dao.getObjects(where.toString());</span>
<span class="fc" id="L969">			return ValueObjectUtil.groupByField(</span>
					WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_WORKRESOURCEID, rules);
<span class="nc" id="L971">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L972">			handleException(e, false);</span>
<span class="nc" id="L973">			throw e;</span>
<span class="nc" id="L974">		} catch (Exception e) {</span>
<span class="nc" id="L975">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L977">			dao.cleanUp();</span>
<span class="pc" id="L978">			methodFinish();</span>
		}
	}

	public Map&lt;ID, ? extends Collection&lt;WorkResourceRotation&gt;&gt; getRotationAssignmentsByRotationIDs(
			Collection&lt;ID&gt; rotationIDs) throws BbmFinderException {
<span class="fc" id="L984">		methodStart(&quot;getRotationAssignmentsByRotationIDs&quot;, rotationIDs);</span>
<span class="fc" id="L985">		WorkResourceRotationDAO dao = new WorkResourceRotationDAO();</span>
		try {
<span class="fc" id="L987">			StringBuffer where = new StringBuffer();</span>
<span class="fc" id="L988">			WorkResourceComplexWorkRuleFieldInfo fi = new WorkResourceComplexWorkRuleFieldInfo();</span>
<span class="fc" id="L989">			String fn = fi</span>
<span class="fc" id="L990">					.getFieldName(WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_COMPLEXWORKRULEID);</span>
<span class="fc" id="L991">			rotationIDs = DAOUtil.mapIDsToDEIDs(rotationIDs, new ComplexWorkRuleFieldInfo()).values();</span>
<span class="fc" id="L992">			where.append(&quot; &quot;).append(fn).append(&quot; in &quot;).append(dao.getDMO().createInClause(rotationIDs));</span>
<span class="fc" id="L993">			Collection&lt;WorkResourceRotation&gt; rules = dao.getObjects(where.toString());</span>

<span class="fc" id="L995">			Map&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; retVal = new HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt;();</span>
<span class="pc bpc" id="L996" title="1 of 2 branches missed.">			for (WorkResourceRotation assignment : rules) {</span>
<span class="nc" id="L997">				ID rotationID = assignment.getRotation().getID();</span>
<span class="nc" id="L998">				Collection&lt;WorkResourceRotation&gt; col = retVal.get(rotationID);</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">				if (col == null) {</span>
<span class="nc" id="L1000">					col = new ArrayList&lt;WorkResourceRotation&gt;();</span>
<span class="nc" id="L1001">					retVal.put(rotationID, col);</span>
				}
<span class="nc" id="L1003">				col.add(assignment);</span>
<span class="nc" id="L1004">			}</span>
<span class="fc" id="L1005">			return retVal;</span>
<span class="nc" id="L1006">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1007">			handleException(e, false);</span>
<span class="nc" id="L1008">			throw e;</span>
<span class="nc" id="L1009">		} catch (Exception e) {</span>
<span class="nc" id="L1010">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L1012">			dao.cleanUp();</span>
<span class="pc" id="L1013">			methodFinish();</span>
		}
	}

	/**
	 * getAvailableRotationsForEmployees without filtering by Name, passed
	 * filterByName =null
	 * */
	public PaginationPair&lt;Rotation&gt; getAvailableRotationsForEmployees(Collection&lt;ID&gt; workResourceIDs, Date startDate,
			Date endDate, boolean isAscendingSort, int pageIDSize, int pageIndex,
			LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap, Collection&lt;ID&gt; filteredIDs) throws BbmFinderException {
<span class="nc" id="L1024">		methodStart(&quot;getAvailableRotationsForEmployees&quot;, workResourceIDs, startDate);</span>
<span class="nc" id="L1025">		RotationDAO dao = new RotationDAO();</span>
		try {
<span class="nc" id="L1027">			return dao.getAvailableWorkRulesForEmployees(workResourceIDs, startDate, endDate, isAscendingSort,</span>
					pageIDSize, pageIndex, sortFieldMap, filteredIDs, null);
<span class="nc" id="L1029">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1030">			handleException(e, false);</span>
<span class="nc" id="L1031">			throw e;</span>
<span class="nc" id="L1032">		} catch (Exception e) {</span>
<span class="nc" id="L1033">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1035">			dao.cleanUp();</span>
<span class="nc" id="L1036">			methodFinish();</span>
		}
	}

	public PaginationPair&lt;Rotation&gt; getAvailableRotationsForEmployees(Collection&lt;ID&gt; workResourceIDs, Date startDate,
			Date endDate, boolean isAscendingSort, int pageIDSize, int pageIndex,
			LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap, Collection&lt;ID&gt; filteredIDs, String filterByName)
			throws BbmFinderException {
<span class="fc" id="L1044">		methodStart(&quot;getAvailableRotationsForEmployees&quot;, workResourceIDs, startDate, endDate, filterByName);</span>
<span class="fc" id="L1045">		RotationDAO dao = new RotationDAO();</span>
		try {
<span class="fc" id="L1047">			return dao.getAvailableWorkRulesForEmployees(workResourceIDs, startDate, endDate, isAscendingSort,</span>
					pageIDSize, pageIndex, sortFieldMap, filteredIDs, filterByName);
<span class="nc" id="L1049">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1050">			handleException(e, false);</span>
<span class="nc" id="L1051">			throw e;</span>
<span class="nc" id="L1052">		} catch (Exception e) {</span>
<span class="nc" id="L1053">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L1055">			dao.cleanUp();</span>
<span class="pc" id="L1056">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; createRotationAssignments(Collection&lt;WorkResourceRotation&gt; rotationAssignments)
			throws BbmCreateException {
<span class="fc" id="L1062">		methodStart(&quot;createRotationAssignments&quot;, rotationAssignments);</span>
<span class="fc" id="L1063">		WorkResourceRotationDAO dao = new WorkResourceRotationDAO();</span>
		try {
<span class="fc" id="L1065">			return dao.createObjects(rotationAssignments);</span>
<span class="nc" id="L1066">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1067">			handleException(e);</span>
<span class="nc" id="L1068">			throw e;</span>
<span class="nc" id="L1069">		} catch (Exception e) {</span>
<span class="nc" id="L1070">			throw new BbmCreateException(e);</span>
		} finally {
<span class="pc" id="L1072">			dao.cleanUp();</span>
<span class="pc" id="L1073">			methodFinish();</span>
		}
	}

	public void updateRotationAssignments(Collection&lt;WorkResourceRotation&gt; rotationAssignments)
			throws MultiUserException, BbmUpdateException {
<span class="nc" id="L1079">		methodStart(&quot;updateRotationAssignments&quot;, rotationAssignments);</span>
<span class="nc" id="L1080">		WorkResourceRotationDAO dao = new WorkResourceRotationDAO();</span>
		try {
<span class="nc" id="L1082">			dao.updateObjects(rotationAssignments);</span>
<span class="nc" id="L1083">		} catch (MultiUserException e) {</span>
<span class="nc" id="L1084">			handleException(e);</span>
<span class="nc" id="L1085">			throw e;</span>
<span class="nc" id="L1086">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1087">			handleException(e);</span>
<span class="nc" id="L1088">			throw e;</span>
		} finally {
<span class="nc" id="L1090">			dao.cleanUp();</span>
<span class="nc" id="L1091">			methodFinish();</span>
<span class="nc" id="L1092">		}</span>
<span class="nc" id="L1093">	}</span>

	public void deleteRotationAssignments(Collection&lt;ID&gt; rotationAssignmentIDs) throws BbmRemoveException {
<span class="nc" id="L1096">		methodStart(&quot;deleteRotationAssignments&quot;, rotationAssignmentIDs);</span>
<span class="nc" id="L1097">		WorkResourceRotationDAO dao = new WorkResourceRotationDAO();</span>
		try {
<span class="nc" id="L1099">			dao.deleteWorkResourceRotations(rotationAssignmentIDs);</span>
<span class="nc" id="L1100">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1101">			handleException(e);</span>
<span class="nc" id="L1102">			throw e;</span>
		} finally {
<span class="nc" id="L1104">			dao.cleanUp();</span>
<span class="nc" id="L1105">			methodFinish();</span>
<span class="nc" id="L1106">		}</span>
<span class="nc" id="L1107">	}</span>

	// === complex rule relate APIs ========
	public HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; getComplexWorkRuleAssignments(
			Collection&lt;ID&gt; workResourceIDs) throws BbmFinderException {
<span class="fc" id="L1112">		methodStart(&quot;getComplexWorkRuleAssignments&quot;, workResourceIDs);</span>
<span class="fc" id="L1113">		WorkResourceComplexWorkRuleDAO dao = new WorkResourceComplexWorkRuleDAO();</span>
		try {
<span class="fc" id="L1115">			StringBuffer where = new StringBuffer();</span>
<span class="fc" id="L1116">			where.append(&quot; WORKRESOURCEID in &quot;).append(dao.getDMO().createInClause(workResourceIDs));</span>
<span class="fc" id="L1117">			Collection&lt;WorkResourceComplexWorkRule&gt; rules = dao.getObjects(where.toString());</span>
<span class="fc" id="L1118">			return ValueObjectUtil.groupByField(</span>
					WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_WORKRESOURCEID, rules);
<span class="nc" id="L1120">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1121">			handleException(e, false);</span>
<span class="nc" id="L1122">			throw e;</span>
<span class="nc" id="L1123">		} catch (Exception e) {</span>
<span class="nc" id="L1124">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L1126">			dao.cleanUp();</span>
<span class="pc" id="L1127">			methodFinish();</span>
		}
	}

	public Map&lt;ID, ? extends Collection&lt;WorkResourceComplexWorkRule&gt;&gt; getComplexWorkRuleAssignmentsByCWRIDs(
			Collection&lt;ID&gt; complexWorkRuleIDs) throws BbmFinderException {
<span class="fc" id="L1133">		methodStart(&quot;getComplexWorkRuleAssignmentsByCWRIDs&quot;, complexWorkRuleIDs);</span>
<span class="fc" id="L1134">		WorkResourceComplexWorkRuleDAO dao = new WorkResourceComplexWorkRuleDAO();</span>
		try {
<span class="fc" id="L1136">			StringBuffer where = new StringBuffer();</span>
<span class="fc" id="L1137">			WorkResourceComplexWorkRuleFieldInfo fi = new WorkResourceComplexWorkRuleFieldInfo();</span>
<span class="fc" id="L1138">			String fn = fi</span>
<span class="fc" id="L1139">					.getFieldName(WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_COMPLEXWORKRULEID);</span>
<span class="fc" id="L1140">			complexWorkRuleIDs = DAOUtil.mapIDsToDEIDs(complexWorkRuleIDs, new ComplexWorkRuleFieldInfo()).values();</span>
<span class="fc" id="L1141">			where.append(&quot; &quot;).append(fn).append(&quot; in &quot;).append(dao.getDMO().createInClause(complexWorkRuleIDs));</span>
<span class="fc" id="L1142">			Collection&lt;WorkResourceComplexWorkRule&gt; rules = dao.getObjects(where.toString());</span>

<span class="fc" id="L1144">			Map&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; retVal = new HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt;();</span>
<span class="pc bpc" id="L1145" title="1 of 2 branches missed.">			for (WorkResourceComplexWorkRule assignment : rules) {</span>
<span class="nc" id="L1146">				ID cwrID = assignment.getComplexWorkRuleID();</span>
<span class="nc" id="L1147">				Collection&lt;WorkResourceComplexWorkRule&gt; col = retVal.get(cwrID);</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">				if (col == null) {</span>
<span class="nc" id="L1149">					col = new ArrayList&lt;WorkResourceComplexWorkRule&gt;();</span>
<span class="nc" id="L1150">					retVal.put(cwrID, col);</span>
				}
<span class="nc" id="L1152">				col.add(assignment);</span>
<span class="nc" id="L1153">			}</span>
<span class="fc" id="L1154">			return retVal;</span>
<span class="nc" id="L1155">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1156">			handleException(e, false);</span>
<span class="nc" id="L1157">			throw e;</span>
<span class="nc" id="L1158">		} catch (Exception e) {</span>
<span class="nc" id="L1159">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L1161">			dao.cleanUp();</span>
<span class="pc" id="L1162">			methodFinish();</span>
		}
	}

	public PaginationPair&lt;ComplexWorkRule&gt; getAvailableComplexWorkRulesForEmployees(Collection&lt;ID&gt; workResourceIDs,
			Date startDate, Date endDate, boolean isAscendingSort, int pageIDSize, int pageIndex,
			LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap, Collection&lt;ID&gt; filteredIDs) throws BbmFinderException {
<span class="fc" id="L1169">		methodStart(&quot;getAvailableComplexWorkRulesForEmployees&quot;, workResourceIDs, startDate);</span>
<span class="fc" id="L1170">		ComplexWorkRuleDAO dao = new ComplexWorkRuleDAO();</span>
		try {

			// Supervisor rules should not be returned for supervisors. To
			// accomplish this, we will add
			// those to the filtered IDs.
<span class="fc" id="L1176">			boolean filterOutSupervisorTeamRules = false;</span>

			// First, check if any of employees are supervisors.
<span class="fc" id="L1179">			WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager(m_isWhatIf);</span>
<span class="fc" id="L1180">			Collection&lt;Employee&gt; emps = wrm.getEmployeesByIDs(workResourceIDs, startDate,</span>
					Employee.DETAIL_LEVEL_EMPLOYEE_BASIC);
<span class="fc bfc" id="L1182" title="All 2 branches covered.">			for (Employee e : emps) {</span>
<span class="pc bpc" id="L1183" title="1 of 2 branches missed.">				if (e.isSupervisor()) {</span>
<span class="nc" id="L1184">					filterOutSupervisorTeamRules = true;</span>
<span class="nc" id="L1185">					break;</span>
				}
<span class="fc" id="L1187">			}</span>

<span class="pc bpc" id="L1189" title="1 of 2 branches missed.">			if (filterOutSupervisorTeamRules) {</span>
<span class="nc" id="L1190">				filteredIDs = new HashSet&lt;ID&gt;(filteredIDs);</span>
<span class="nc" id="L1191">				filteredIDs.addAll(dao.getIDsForWorkUnitType(WorkUnitType.SupervisorTeams));</span>
			}

<span class="fc" id="L1194">			return dao.getAvailableWorkRulesForEmployees(workResourceIDs, startDate, endDate, isAscendingSort,</span>
					pageIDSize, pageIndex, sortFieldMap, filteredIDs, null);
<span class="nc" id="L1196">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1197">			handleException(e, false);</span>
<span class="nc" id="L1198">			throw e;</span>
<span class="nc" id="L1199">		} catch (Exception e) {</span>
<span class="nc" id="L1200">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L1202">			dao.cleanUp();</span>
<span class="pc" id="L1203">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; createComplexWorkRuleAssignments(
			Collection&lt;WorkResourceComplexWorkRule&gt; complexWorkRuleAssignments) throws BbmCreateException {
<span class="fc" id="L1209">		methodStart(&quot;createComplexWorkRuleAssignments&quot;, complexWorkRuleAssignments);</span>
<span class="fc" id="L1210">		WorkResourceComplexWorkRuleDAO dao = new WorkResourceComplexWorkRuleDAO();</span>
		try {
<span class="fc bfc" id="L1212" title="All 2 branches covered.">			for (WorkResourceComplexWorkRule wrcwr : complexWorkRuleAssignments) {</span>
<span class="fc" id="L1213">				wrcwr.setCreatedBy(m_sessionContext.getCallerPrincipal().getName());</span>
<span class="fc" id="L1214">				wrcwr.setCreatedDate(new Date(System.currentTimeMillis()));</span>
<span class="fc" id="L1215">			}</span>
<span class="fc" id="L1216">			return dao.createObjects(complexWorkRuleAssignments);</span>
<span class="nc" id="L1217">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1218">			handleException(e);</span>
<span class="nc" id="L1219">			throw e;</span>
<span class="nc" id="L1220">		} catch (Exception e) {</span>
<span class="nc" id="L1221">			throw new BbmCreateException(e);</span>
		} finally {
<span class="pc" id="L1223">			dao.cleanUp();</span>
<span class="pc" id="L1224">			methodFinish();</span>
		}
	}

	public void updateComplexWorkRuleAssignments(Collection&lt;WorkResourceComplexWorkRule&gt; wrcwrs)
			throws MultiUserException, BbmUpdateException {
<span class="nc" id="L1230">		methodStart(&quot;updateComplexWorkRuleAssignments&quot;, wrcwrs);</span>
<span class="nc" id="L1231">		WorkResourceComplexWorkRuleDAO dao = new WorkResourceComplexWorkRuleDAO();</span>
		try {
<span class="nc bnc" id="L1233" title="All 2 branches missed.">			for (WorkResourceComplexWorkRule wrcwr : wrcwrs) {</span>
<span class="nc" id="L1234">				wrcwr.setModifiedBy(m_sessionContext.getCallerPrincipal().getName());</span>
<span class="nc" id="L1235">				wrcwr.setModifiedDate(new Date(System.currentTimeMillis()));</span>
<span class="nc" id="L1236">			}</span>
<span class="nc" id="L1237">			dao.updateObjects(wrcwrs);</span>
<span class="nc" id="L1238">		} catch (MultiUserException e) {</span>
<span class="nc" id="L1239">			handleException(e);</span>
<span class="nc" id="L1240">			throw e;</span>
<span class="nc" id="L1241">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1242">			handleException(e);</span>
<span class="nc" id="L1243">			throw e;</span>
		} finally {
<span class="nc" id="L1245">			dao.cleanUp();</span>
<span class="nc" id="L1246">			methodFinish();</span>
<span class="nc" id="L1247">		}</span>
<span class="nc" id="L1248">	}</span>

	public void deleteComplexWorkRuleAssignments(Collection&lt;ID&gt; wrcwrIDs) throws BbmRemoveException {
<span class="nc" id="L1251">		methodStart(&quot;deleteComplexWorkRuleAssignments&quot;, wrcwrIDs);</span>
<span class="nc" id="L1252">		WorkResourceComplexWorkRuleDAO dao = new WorkResourceComplexWorkRuleDAO();</span>
		try {
<span class="nc" id="L1254">			dao.deleteWorkResourceComplexWorkRules(wrcwrIDs);</span>
<span class="nc" id="L1255">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1256">			handleException(e);</span>
<span class="nc" id="L1257">			throw e;</span>
		} finally {
<span class="nc" id="L1259">			dao.cleanUp();</span>
<span class="nc" id="L1260">			methodFinish();</span>
<span class="nc" id="L1261">		}</span>
<span class="nc" id="L1262">	}</span>

	// ========= time bank adjust related API ===========
	public Collection getTimeBankAdjustments(Collection empIDs, Date startDate, Date endDate) throws BbmFinderException {
<span class="fc" id="L1266">		methodStart(&quot;getTimeBankAdjustments&quot;, empIDs, startDate, endDate);</span>
<span class="fc" id="L1267">		EmpTimeBankAdjustDAO dao = new EmpTimeBankAdjustDAO();</span>
		try {
<span class="fc" id="L1269">			Jdmo dmo = dao.getDMO();</span>
<span class="fc" id="L1270">			StringBuffer where = new StringBuffer();</span>
<span class="fc" id="L1271">			where.append(&quot; EMPLOYEEID in &quot;).append(dmo.createInClause(empIDs));</span>
<span class="pc bpc" id="L1272" title="1 of 2 branches missed.">			if (startDate != null)</span>
<span class="nc" id="L1273">				where.append(&quot; AND ADJUSTDATE &gt;= &quot;).append(JdmoUtil.asSqlLiteral(startDate));</span>
<span class="pc bpc" id="L1274" title="1 of 2 branches missed.">			if (endDate != null)</span>
<span class="nc" id="L1275">				where.append(&quot; AND ADJUSTDATE &lt; &quot;).append(JdmoUtil.asSqlLiteral(endDate));</span>
<span class="fc" id="L1276">			Collection tbAdjustments = dao.getObjects(where.toString());</span>
<span class="fc" id="L1277">			HashMap empAdjustments = ValueObjectUtil.groupByField(</span>
					EmpTimeBankAdjustFieldInfo.EMPTIMEBANKADJUST_EMPLOYEEID, tbAdjustments);
<span class="fc" id="L1279">			ArrayList list = new ArrayList(empIDs.size());</span>
<span class="fc bfc" id="L1280" title="All 2 branches covered.">			for (Iterator i = empIDs.iterator(); i.hasNext();) {</span>
<span class="fc" id="L1281">				list.add(empAdjustments.get(i.next()));</span>
			}
<span class="fc" id="L1283">			return list;</span>
<span class="nc" id="L1284">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1285">			handleException(e, false);</span>
<span class="nc" id="L1286">			throw e;</span>
<span class="nc" id="L1287">		} catch (Exception e) {</span>
<span class="nc" id="L1288">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L1290">			dao.cleanUp();</span>
<span class="pc" id="L1291">			methodFinish();</span>
		}
	}

	public ID createTimeBankAdjustments(EmpTimeBankAdjust adjust) throws BbmCreateException {
<span class="nc" id="L1296">		methodStart(&quot;createTimeBankAdjustments&quot;, adjust);</span>
<span class="nc" id="L1297">		EmpTimeBankAdjustDAO dao = new EmpTimeBankAdjustDAO();</span>
		try {
<span class="nc" id="L1299">			return dao.createObject(adjust);</span>
<span class="nc" id="L1300">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1301">			handleException(e);</span>
<span class="nc" id="L1302">			throw e;</span>
<span class="nc" id="L1303">		} catch (Exception e) {</span>
<span class="nc" id="L1304">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L1306">			dao.cleanUp();</span>
<span class="nc" id="L1307">			methodFinish();</span>
		}
	}

	public void deleteTimeBankAdjustments(ID empID, Date startDate, Date endDate) throws BbmRemoveException {
<span class="nc" id="L1312">		methodStart(&quot;deleteTimeBankAdjustments&quot;, empID, startDate, endDate);</span>
<span class="nc" id="L1313">		EmpTimeBankAdjustDAO dao = new EmpTimeBankAdjustDAO();</span>
		try {
<span class="nc" id="L1315">			Jdmo dmo = dao.getDMO();</span>
<span class="nc" id="L1316">			StringBuffer where = new StringBuffer();</span>
<span class="nc" id="L1317">			where.append(&quot; SELECT ID FROM TIMEBANKEMPLOYEEADJUST WHERE EMPLOYEEID = &quot;).append(empID);</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">			if (startDate != null)</span>
<span class="nc" id="L1319">				where.append(&quot; AND ADJUSTDATE &gt;= &quot;).append(JdmoUtil.asSqlLiteral(startDate));</span>
<span class="nc bnc" id="L1320" title="All 2 branches missed.">			if (endDate != null)</span>
<span class="nc" id="L1321">				where.append(&quot; AND ADJUSTDATE &lt; &quot;).append(JdmoUtil.asSqlLiteral(endDate));</span>
<span class="nc" id="L1322">			dao.deleteObjects(where.toString());</span>
<span class="nc" id="L1323">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1324">			handleException(e);</span>
<span class="nc" id="L1325">			throw e;</span>
		} finally {
<span class="nc" id="L1327">			dao.cleanUp();</span>
<span class="nc" id="L1328">			methodFinish();</span>
<span class="nc" id="L1329">		}</span>
<span class="nc" id="L1330">	}</span>

	public void fixTimeBankAssignmentsForOrgChange(ID empID, ID newOrgID, Date newOrgStart, Date newOrgEnd)
			throws BbmFinderException, BbmRemoveException {
<span class="nc" id="L1334">		methodStart(&quot;fixTimeBankAssignmentsForOrgChange&quot;, empID, newOrgID, newOrgStart, newOrgEnd);</span>
<span class="nc" id="L1335">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L1337">			Collection timeBankAssignments = dao.getTimeBankAssignments(empID, newOrgStart, newOrgEnd);</span>
<span class="nc bnc" id="L1338" title="All 4 branches missed.">			if (timeBankAssignments == null || timeBankAssignments.isEmpty())</span>
<span class="nc" id="L1339">				return;</span>
<span class="nc" id="L1340">			EmpTimeBank timeBankAssignment = null;</span>
<span class="nc" id="L1341">			ArrayList removeList = new ArrayList(timeBankAssignments.size());</span>
<span class="nc" id="L1342">			ID timeBankID = null;</span>
<span class="nc" id="L1343">			ID timeBankOrgID = null;</span>
<span class="nc" id="L1344">			TimeBank timeBank = null;</span>
<span class="nc" id="L1345">			Organization timeBankOrg = null;</span>
<span class="nc" id="L1346">			Organization empNewOrg = null;</span>
			/*
			 * We must look for any time banks assigned to the employee that
			 * overlap this period, and then save the time bank assignments
			 * whose organization has the same day boundary, time zone and start
			 * day of the week as the new organization. Otherwise, delete it
			 */
<span class="nc bnc" id="L1353" title="All 2 branches missed.">			for (Iterator i = timeBankAssignments.iterator(); i.hasNext();) {</span>
<span class="nc" id="L1354">				timeBankAssignment = (EmpTimeBank) i.next();</span>
<span class="nc" id="L1355">				timeBankID = timeBankAssignment.getTimeBankID();</span>
<span class="nc" id="L1356">				timeBank = m_workRuleManager.getTimeBank(timeBankID);</span>
<span class="nc" id="L1357">				timeBankOrgID = timeBank.getOrganizationID();</span>
<span class="nc bnc" id="L1358" title="All 2 branches missed.">				if (timeBankOrgID.equals(newOrgID))</span>
<span class="nc" id="L1359">					continue; // this time bank assignment is still valid</span>
				else {
<span class="nc" id="L1361">					timeBankOrg = m_workResourceManager.getOrganizationByID(timeBankOrgID);</span>
<span class="nc" id="L1362">					empNewOrg = m_workResourceManager.getOrganizationByID(newOrgID);</span>
<span class="nc bnc" id="L1363" title="All 2 branches missed.">					if (timeBankOrg.getDayBoundaryOffset() != empNewOrg.getDayBoundaryOffset()</span>
<span class="nc bnc" id="L1364" title="All 2 branches missed.">							|| !timeBankOrg.getTimeZone().equals(empNewOrg.getTimeZone())</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">							|| timeBankOrg.getWeekStartDate() != empNewOrg.getWeekStartDate()) {</span>
<span class="nc" id="L1366">						removeList.add(timeBankAssignment.getID());</span>
					}
				}
			}
<span class="nc bnc" id="L1370" title="All 2 branches missed.">			if (!removeList.isEmpty())</span>
<span class="nc" id="L1371">				dao.deleteObjects(removeList);</span>
<span class="nc" id="L1372">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1373">			handleException(e, false);</span>
<span class="nc" id="L1374">			throw e;</span>
<span class="nc" id="L1375">		} catch (Exception e) {</span>
<span class="nc" id="L1376">			handleException(e, false);</span>
<span class="nc" id="L1377">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1379">			dao.cleanUp();</span>
<span class="nc" id="L1380">			methodFinish();</span>
<span class="nc" id="L1381">		}</span>
<span class="nc" id="L1382">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>