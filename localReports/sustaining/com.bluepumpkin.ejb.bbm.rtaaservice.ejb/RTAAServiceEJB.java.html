<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RTAAServiceEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.rtaaservice.ejb</a> &gt; <span class="el_source">RTAAServiceEJB.java</span></div><h1>RTAAServiceEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.rtaaservice.ejb;

import java.rmi.RemoteException;
import java.sql.Timestamp;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.TreeSet;

import com.bluepumpkin.common.cache.Cache;
import com.bluepumpkin.common.cache.CacheFactory;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.JNDINames;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.activity.model.EventUtils;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.config.ConfigCacheUtil;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.config.ejb.DBConfigManager;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.ActivityMapping;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.AdheranceOverride;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.EmployeeDataIn;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.RTAADataIn;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.RTAAException;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourceAssignment;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.licensing.LicenseKeys;


<span class="fc" id="L45">public class RTAAServiceEJB extends SessionEJBBase</span>
{
	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;

	private static final String APPROVEBY_SET_DELIMITER = &quot;;&quot;;

<span class="fc" id="L54">	private RTAAServiceDAO m_RTAAServiceDAO = null;</span>
<span class="fc" id="L55">	private DBConfigManager m_dbConfigManager = null;</span>
<span class="fc" id="L56">	private ActivityManager m_activityManager = null;</span>
<span class="fc" id="L57">	private WorkResourceManager m_workResourceManager = null;</span>
<span class="fc" id="L58">	private HashMap m_hmActivityMappings = new HashMap();</span>
<span class="fc" id="L59">	private HashMap m_hmActivities = new HashMap();</span>
<span class="fc" id="L60">	private HashMap m_hmPayPolicyMaxNonAdheranceRules = new HashMap();</span>
<span class="fc" id="L61">	private Cache m_activityMappingCache = null;</span>
<span class="fc" id="L62">	private static int ADHERANCE_OVERRIDES_CACHE_SIZE = 365;</span>
<span class="fc" id="L63">	private Cache m_adheranceOverrideCache = null;</span>

<span class="fc" id="L65">	private static Category m_cat = Log.initCategory(RTAAServiceEJB.class.getName());</span>

	/** override the base class to provide the appropriate logging category */
	protected Category getCategory()
	{
<span class="fc" id="L70">		return m_cat;</span>
	}

	{
<span class="fc" id="L74">		super.init(RTAAServiceEJB.class.getName());</span>
	}

<span class="fc" id="L77">	static private class AdheranceOverrideCache implements java.io.Serializable</span>
	{
		/**
		 * 
		 */
		private static final long serialVersionUID = 1L;
<span class="nc" id="L83">		private Date m_dateStart = null;</span>
<span class="nc" id="L84">		private Date m_dateEnd = null;</span>
<span class="nc" id="L85">		private Collection m_colAdheranceOverrides = null;</span>
		public AdheranceOverrideCache(Date dateStart, Date dateEnd, Collection colAdheranceOverrides)
<span class="nc" id="L87">		{</span>
<span class="nc" id="L88">			m_dateStart = dateStart;</span>
<span class="nc" id="L89">			m_dateEnd = dateEnd;</span>
<span class="nc" id="L90">			m_colAdheranceOverrides = colAdheranceOverrides;</span>
<span class="nc" id="L91">		}</span>
		Date getStartTime()
		{
<span class="nc" id="L94">			return m_dateStart;</span>
		}
		Date getEndTime()
		{
<span class="nc" id="L98">			return m_dateEnd;</span>
		}
		Collection getAdheranceOverrides()
		{
<span class="nc" id="L102">			return m_colAdheranceOverrides;</span>
		}
	}

	public void ejbCreate()
	{
		try
		{
<span class="fc" id="L110">			m_RTAAServiceDAO = new RTAAServiceDAO();</span>
<span class="fc" id="L111">			m_activityManager = WfmManagerFactory.getActivityManager();</span>
<span class="fc" id="L112">			m_dbConfigManager = BbmManagerFactory.getDBConfigManager();</span>
<span class="fc" id="L113">			m_workResourceManager = BbmManagerFactory.getWorkResourceManager();</span>
			
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">			if (ConfigCacheUtil.isCacheEnabled(m_dbConfigManager, ConfigKey.ADHERENCE_MAPPING_CACHE_USAGE))</span>
			{
<span class="fc" id="L117">				m_activityMappingCache =</span>
<span class="fc" id="L118">					CacheFactory.getCache(</span>
						JNDINames.BBM_RTAASERVICE_EJBHOME + &quot;ActivityMapping&quot;,
<span class="fc" id="L120">						RTAAServiceEJB.class.getClassLoader());</span>
<span class="fc" id="L121">				initCache();</span>
			}
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">			if (ConfigCacheUtil.isCacheEnabled(m_dbConfigManager, ConfigKey.ADHERENCE_EXCEPTION_CACHE_USAGE))</span>
<span class="fc" id="L124">				m_adheranceOverrideCache =</span>
<span class="fc" id="L125">					CacheFactory.getCache(</span>
						JNDINames.BBM_RTAASERVICE_EJBHOME + &quot;AdheranceOverride&quot;,
<span class="fc" id="L127">						RTAAServiceEJB.class.getClassLoader());</span>

		}
<span class="nc" id="L130">		catch (Exception e)</span>
		{
<span class="nc" id="L132">			handleException(e, false);</span>
<span class="fc" id="L133">		}</span>
<span class="fc" id="L134">	}</span>
	private void initCache() throws BbmFinderException, RemoteException, JdmoException
	{
<span class="fc" id="L137">		Boolean bActivityMappingCacheInitialized = (Boolean) m_activityMappingCache.get(&quot;INITIALIZED&quot;);</span>
<span class="pc bpc" id="L138" title="3 of 4 branches missed.">		if (bActivityMappingCacheInitialized == null || !bActivityMappingCacheInitialized.booleanValue())</span>
		{
<span class="fc" id="L140">			Collection colActivityIDs = m_activityManager.findActivitiesIds(new ActivityFilter(ActivityFilter.FILTER_NONE));</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="fc" id="L142">				m_cat.debug(&quot;RTAAServiceEJB.java colActivityIDs &quot; + colActivityIDs);</span>

<span class="fc" id="L144">			Collection colActivityMappings = m_RTAAServiceDAO.getActivityMappingsByID(colActivityIDs);</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">			for (Iterator itActivityMapping = colActivityMappings.iterator(); itActivityMapping.hasNext();)</span>
			{
<span class="fc" id="L147">				ActivityMapping activityMapping = (ActivityMapping) itActivityMapping.next();</span>
<span class="fc" id="L148">				m_activityMappingCache.put(activityMapping.getActivityID(), activityMapping);</span>
<span class="fc" id="L149">			}</span>
		}
<span class="fc" id="L151">	}</span>

	public Collection getActivityMappingsByID(Collection colActivityIDs) throws BbmFinderException
	{
<span class="fc" id="L155">		methodStart(&quot;getActivityMappingsByID&quot;, colActivityIDs);</span>
		try
		{
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">			if (m_activityMappingCache == null)</span>
<span class="nc" id="L159">				return m_RTAAServiceDAO.getActivityMappingsByID(colActivityIDs);</span>
<span class="fc" id="L160">			Collection colActivityMappings = new LinkedList();</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">			for (Iterator itActivityID = colActivityIDs.iterator(); itActivityID.hasNext();)</span>
			{
<span class="fc" id="L163">				ID idActivity = (ID) itActivityID.next();</span>
<span class="fc" id="L164">				ActivityMapping activityMapping = (ActivityMapping) m_activityMappingCache.get(idActivity);</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">				if (activityMapping == null)</span>
<span class="fc" id="L166">					activityMapping = new ActivityMapping(idActivity);</span>
<span class="fc" id="L167">				colActivityMappings.add(activityMapping);</span>
<span class="fc" id="L168">			}</span>
<span class="fc" id="L169">			return colActivityMappings;</span>
		}
<span class="nc" id="L171">		catch (JdmoException e)</span>
		{
<span class="nc" id="L173">			handleException(e);</span>
<span class="nc" id="L174">			throw new BbmFinderException(e);</span>
		}
		finally
		{
<span class="pc" id="L178">			methodFinish();</span>
		}
	}
	private void updateActivityTimeStamp(ID idActivity) throws Exception
	{
<span class="fc" id="L183">		m_activityManager.updateActivity(m_activityManager.findActivityById(idActivity));</span>
<span class="fc" id="L184">	}</span>

	public void updateActivityMapping(ActivityMapping activityMapping) throws BbmUpdateException
	{
<span class="fc" id="L188">		methodStart(&quot;updateActivityMapping&quot;);</span>
		try
		{
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">			if (m_activityMappingCache != null)</span>
<span class="fc" id="L192">				m_activityMappingCache.put(activityMapping.getActivityID(), activityMapping);</span>
<span class="fc" id="L193">			updateActivityTimeStamp(activityMapping.getActivityID());</span>
<span class="fc" id="L194">			m_RTAAServiceDAO.updateActivityMapping(activityMapping);</span>
		}
<span class="nc" id="L196">		catch (Exception e)</span>
		{
<span class="nc" id="L198">			handleException(e);</span>
<span class="nc" id="L199">			throw new BbmUpdateException(e);</span>
		}
		finally
		{
<span class="pc" id="L203">			methodFinish();</span>
<span class="fc" id="L204">		}</span>
<span class="fc" id="L205">	}</span>
	public void deleteActivityMappingsByID(Collection colActivityIDs) throws BbmRemoveException
	{
<span class="nc" id="L208">		methodStart(&quot;deleteActivityMappingsByID&quot;, colActivityIDs);</span>
		try
		{
<span class="nc bnc" id="L211" title="All 2 branches missed.">			if (m_activityMappingCache != null)</span>
			{
<span class="nc bnc" id="L213" title="All 2 branches missed.">				for (Iterator itActivityID = colActivityIDs.iterator(); itActivityID.hasNext();)</span>
				{
<span class="nc" id="L215">					ID idActivity = (ID) itActivityID.next();</span>
<span class="nc" id="L216">					ActivityMapping activityMapping = (ActivityMapping) m_activityMappingCache.get(idActivity);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">					if (activityMapping != null)</span>
					{
<span class="nc" id="L219">						activityMapping.getMappedActivityIDs().clear();</span>
<span class="nc" id="L220">						updateActivityTimeStamp(idActivity);</span>
					}

<span class="nc" id="L223">				}</span>
			}
<span class="nc" id="L225">			m_RTAAServiceDAO.deleteActivityMappingsByID(colActivityIDs);</span>
		}
<span class="nc" id="L227">		catch (Exception e)</span>
		{
<span class="nc" id="L229">			handleException(e);</span>
<span class="nc" id="L230">			throw new BbmRemoveException(e);</span>
		}
		finally
		{
<span class="nc" id="L234">			methodFinish();</span>
<span class="nc" id="L235">		}</span>
<span class="nc" id="L236">	}</span>

	public void createAdheranceOverride(ID idEmployee, Date dateStart, Date dateEnd 
			, String strComment) 
		throws BbmCreateException
	{
<span class="nc" id="L242">		methodStart(&quot;createAdheranceOverride&quot;, idEmployee, dateStart, dateEnd);</span>
		
<span class="nc" id="L244">		Collection colEmployeeIDs = new LinkedList();</span>
<span class="nc" id="L245">		colEmployeeIDs.add(idEmployee);</span>

		try
		{
<span class="nc bnc" id="L249" title="All 2 branches missed.">			if (m_adheranceOverrideCache != null)</span>
<span class="nc" id="L250">				m_adheranceOverrideCache.put(idEmployee, null);</span>
<span class="nc" id="L251">			m_RTAAServiceDAO.createAdheranceOverride(</span>
				colEmployeeIDs,
<span class="nc" id="L253">				new Timestamp(dateStart.getTime()),</span>
<span class="nc" id="L254">				new Timestamp(dateEnd.getTime()),</span>
<span class="nc" id="L255">				m_sessionContext.getCallerPrincipal().getName(),</span>
				strComment);
		}
<span class="nc" id="L258">		catch (JdmoException e)</span>
		{
<span class="nc" id="L260">			handleException(e);</span>
<span class="nc" id="L261">			throw new BbmCreateException(e);</span>
		}
		finally
		{
<span class="nc" id="L265">			methodFinish();</span>
<span class="nc" id="L266">		}</span>
<span class="nc" id="L267">	}</span>
	public void deleteAdheranceOverride(ID idEmployee, Date dateStart, Date dateEnd) throws BbmRemoveException
	{
<span class="nc" id="L270">		methodStart(&quot;deleteAdheranceOverride&quot;, idEmployee, dateStart, dateEnd);</span>
<span class="nc" id="L271">		Collection colEmployeeIDs = new LinkedList();</span>
<span class="nc" id="L272">		colEmployeeIDs.add(idEmployee);</span>
		try
		{
<span class="nc bnc" id="L275" title="All 2 branches missed.">			if (m_adheranceOverrideCache != null)</span>
<span class="nc" id="L276">				m_adheranceOverrideCache.put(idEmployee, null);</span>
<span class="nc" id="L277">			m_RTAAServiceDAO.deleteAdheranceOverride(</span>
				colEmployeeIDs,
<span class="nc" id="L279">				new Timestamp(dateStart.getTime()),</span>
<span class="nc" id="L280">				new Timestamp(dateEnd.getTime()));</span>
		}
<span class="nc" id="L282">		catch (JdmoException e)</span>
		{
<span class="nc" id="L284">			handleException(e);</span>
<span class="nc" id="L285">			throw new BbmRemoveException(e);</span>
		}
		finally
		{
<span class="nc" id="L289">			methodFinish();</span>
<span class="nc" id="L290">		}</span>
<span class="nc" id="L291">	}</span>

	public void createAdheranceOverride(Collection colEmployeeIDs, Date dateStart, Date dateEnd
			, String strComment ) 
		throws BbmCreateException
	{
<span class="nc" id="L297">		methodStart(&quot;createAdheranceOverride&quot;, colEmployeeIDs, dateStart, dateEnd);</span>
		try
		{
<span class="nc bnc" id="L300" title="All 2 branches missed.">			if (m_adheranceOverrideCache != null)</span>
			{
<span class="nc bnc" id="L302" title="All 2 branches missed.">				for (Iterator itEmployeeID = colEmployeeIDs.iterator(); itEmployeeID.hasNext();)</span>
				{
<span class="nc" id="L304">					ID idEmployee = (ID) itEmployeeID.next();</span>
<span class="nc" id="L305">					m_adheranceOverrideCache.put(idEmployee, null);</span>
<span class="nc" id="L306">				}</span>
			}
<span class="nc" id="L308">			m_RTAAServiceDAO.createAdheranceOverride(</span>
				colEmployeeIDs,
<span class="nc" id="L310">				new Timestamp(dateStart.getTime()),</span>
<span class="nc" id="L311">				new Timestamp(dateEnd.getTime()),</span>
<span class="nc" id="L312">				m_sessionContext.getCallerPrincipal().getName(),</span>
				strComment);
		}
<span class="nc" id="L315">		catch (JdmoException e)</span>
		{
<span class="nc" id="L317">			handleException(e);</span>
<span class="nc" id="L318">			throw new BbmCreateException(e);</span>
		}
		finally
		{
<span class="nc" id="L322">			methodFinish();</span>
<span class="nc" id="L323">		}</span>
<span class="nc" id="L324">	}</span>
	public void deleteAdheranceOverride(Collection colEmployeeIDs, Date dateStart, Date dateEnd)
		throws BbmRemoveException
	{
<span class="nc" id="L328">		methodStart(&quot;deleteAdheranceOverride&quot;, colEmployeeIDs, dateStart, dateEnd);</span>
		try
		{
<span class="nc bnc" id="L331" title="All 2 branches missed.">			if (m_adheranceOverrideCache != null)</span>
			{
<span class="nc bnc" id="L333" title="All 2 branches missed.">				for (Iterator itEmployeeID = colEmployeeIDs.iterator(); itEmployeeID.hasNext();)</span>
				{
<span class="nc" id="L335">					ID idEmployee = (ID) itEmployeeID.next();</span>
<span class="nc" id="L336">					m_adheranceOverrideCache.put(idEmployee, null);</span>
<span class="nc" id="L337">				}</span>
			}
<span class="nc" id="L339">			m_RTAAServiceDAO.deleteAdheranceOverride(</span>
				colEmployeeIDs,
<span class="nc" id="L341">				new Timestamp(dateStart.getTime()),</span>
<span class="nc" id="L342">				new Timestamp(dateEnd.getTime()));</span>
		}
<span class="nc" id="L344">		catch (JdmoException e)</span>
		{
<span class="nc" id="L346">			handleException(e);</span>
<span class="nc" id="L347">			throw new BbmRemoveException(e);</span>
		}
		finally
		{
<span class="nc" id="L351">			methodFinish();</span>
<span class="nc" id="L352">		}</span>
<span class="nc" id="L353">	}</span>

	private Collection getAdheranceOverridesFromCache(ID idEmployee, Date dateStart, Date dateEnd)
		throws BbmFinderException
	{
<span class="nc bnc" id="L358" title="All 2 branches missed.">		if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L359">			m_cat.debug(</span>
				&quot;ENTER: getAdheranceOverridesFromCache - for employee: &quot;
					+ idEmployee
					+ &quot; Start: &quot;
					+ dateStart
					+ &quot; End: &quot;
					+ dateEnd);

<span class="nc" id="L367">		AdheranceOverrideCache adheranceOverrideCache = (AdheranceOverrideCache) m_adheranceOverrideCache.get(idEmployee);</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">		if (adheranceOverrideCache == null)</span>
		{
<span class="nc bnc" id="L370" title="All 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L371">				m_cat.debug(&quot;Cache is empty&quot;);</span>
<span class="nc" id="L372">			return null;</span>
		}

<span class="nc" id="L375">		Date dateCacheStart = adheranceOverrideCache.getStartTime();</span>
<span class="nc" id="L376">		Date dateCacheOld =</span>
			new Date(
<span class="nc" id="L378">				Calendar.getInstance().getTime().getTime() - (1000L * 60L * 60L * 24L * (ADHERANCE_OVERRIDES_CACHE_SIZE + 2L)));</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">		if (dateCacheStart.before(dateCacheOld))</span>
		{
<span class="nc bnc" id="L381" title="All 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L382">				m_cat.debug(&quot;Cache is old clear cache&quot;);</span>
<span class="nc" id="L383">			m_adheranceOverrideCache.put(idEmployee, null);</span>
<span class="nc" id="L384">			adheranceOverrideCache = null;</span>
		}

<span class="nc bnc" id="L387" title="All 2 branches missed.">		if (adheranceOverrideCache != null)</span>
		{
<span class="nc" id="L389">			Collection colAdheranceOverrides = new LinkedList();</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L391">				m_cat.debug(</span>
					&quot;cached overrides: for employee: &quot;
						+ idEmployee
						+ &quot; Overrides: &quot;
<span class="nc" id="L395">						+ adheranceOverrideCache.getAdheranceOverrides());</span>
<span class="nc" id="L396">			for (Iterator itAdheranceOverride = adheranceOverrideCache.getAdheranceOverrides().iterator();</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">				itAdheranceOverride.hasNext();</span>
				)
			{
<span class="nc" id="L400">				AdheranceOverride adheranceOverride = (AdheranceOverride) itAdheranceOverride.next();</span>
<span class="nc bnc" id="L401" title="All 4 branches missed.">				if (adheranceOverride.getStartTime().before(dateEnd) &amp;&amp; adheranceOverride.getEndTime().after(dateStart))</span>
				{
<span class="nc" id="L403">					adheranceOverride = new AdheranceOverride(adheranceOverride);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">					if (adheranceOverride.getStartTime().before(dateStart))</span>
<span class="nc" id="L405">						adheranceOverride.setStartTime(dateStart);</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">					if (adheranceOverride.getEndTime().after(dateEnd))</span>
<span class="nc" id="L407">						adheranceOverride.setEndTime(dateEnd);</span>
<span class="nc" id="L408">					colAdheranceOverrides.add(adheranceOverride);</span>
				}
<span class="nc" id="L410">			}</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L412">				m_cat.debug(&quot;return overrides: for employee: &quot; + idEmployee + &quot; Overrides: &quot; + colAdheranceOverrides);</span>
<span class="nc" id="L413">			return colAdheranceOverrides;</span>
		}
<span class="nc" id="L415">		return null;</span>
	}

	public HashMap getAdheranceOverrides(Collection colEmployeeIDs, Date dateStart, Date dateEnd)
		throws BbmFinderException
	{
<span class="nc" id="L421">		methodStart(&quot;getAdheranceOverrides&quot;, colEmployeeIDs, dateStart, dateEnd);</span>
<span class="nc" id="L422">		HashMap hmAdheranceOverrides = new HashMap();</span>
		try
		{
<span class="nc" id="L425">			Collection colEmployeeIDsNotInCache = new LinkedList();</span>
<span class="nc" id="L426">			Date dateCacheStart =</span>
				new Date(
<span class="nc" id="L428">					Calendar.getInstance().getTime().getTime() - (1000L * 60L * 60L * 24L * ADHERANCE_OVERRIDES_CACHE_SIZE));</span>
<span class="nc" id="L429">			Date dateCacheEnd =</span>
				new Date(
<span class="nc" id="L431">					Calendar.getInstance().getTime().getTime() + (1000L * 60L * 60L * 24L * ADHERANCE_OVERRIDES_CACHE_SIZE));</span>
<span class="nc bnc" id="L432" title="All 6 branches missed.">			if (dateStart.before(dateCacheStart) || dateEnd.after(dateCacheEnd) || m_adheranceOverrideCache == null)</span>
			{
<span class="nc" id="L434">				return m_RTAAServiceDAO.getAdheranceOverrides(</span>
					colEmployeeIDs,
<span class="nc" id="L436">					new Timestamp(dateStart.getTime()),</span>
<span class="nc" id="L437">					new Timestamp(dateEnd.getTime()));</span>
			}

<span class="nc bnc" id="L440" title="All 2 branches missed.">			for (Iterator itEmployeeID = colEmployeeIDs.iterator(); itEmployeeID.hasNext();)</span>
			{
<span class="nc" id="L442">				ID idEmployee = (ID) itEmployeeID.next();</span>
<span class="nc" id="L443">				Collection colAdheranceOverrides = getAdheranceOverridesFromCache(idEmployee, dateStart, dateEnd);</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">				if (colAdheranceOverrides != null)</span>
				{
<span class="nc bnc" id="L446" title="All 2 branches missed.">					if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L447">						m_cat.debug(</span>
							&quot;Overrides found in cache for employee: &quot; + idEmployee + &quot; Start: &quot; + dateStart + &quot; End: &quot; + dateEnd);
<span class="nc" id="L449">					hmAdheranceOverrides.put(idEmployee, colAdheranceOverrides);</span>
				}
				else
				{
<span class="nc bnc" id="L453" title="All 2 branches missed.">					if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L454">						m_cat.debug(</span>
							&quot;Overrides not found in cache for employee: &quot; + idEmployee + &quot; Start: &quot; + dateStart + &quot; End: &quot; + dateEnd);
<span class="nc" id="L456">					colEmployeeIDsNotInCache.add(idEmployee);</span>
				}
<span class="nc" id="L458">			}</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">			if (!colEmployeeIDsNotInCache.isEmpty()) {</span>
<span class="nc" id="L460">				Date dateAbsCacheStart =</span>
					new Date(
<span class="nc" id="L462">						Calendar.getInstance().getTime().getTime()</span>
							- (1000L * 60L * 60L * 24L * (ADHERANCE_OVERRIDES_CACHE_SIZE + 1L)));
<span class="nc" id="L464">				Date dateAbsCacheEnd =</span>
					new Date(
<span class="nc" id="L466">						Calendar.getInstance().getTime().getTime()</span>
							+ (1000L * 60L * 60L * 24L * (ADHERANCE_OVERRIDES_CACHE_SIZE + 1L)));
<span class="nc bnc" id="L468" title="All 2 branches missed.">				if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L469">					m_cat.debug(</span>
						&quot;Load cache for employees: &quot;
							+ colEmployeeIDsNotInCache
							+ &quot; Start: &quot;
							+ dateAbsCacheStart
							+ &quot; End: &quot;
							+ dateAbsCacheEnd);
<span class="nc" id="L476">				HashMap hmAdheranceOverridesNotInCache =</span>
<span class="nc" id="L477">					m_RTAAServiceDAO.getAdheranceOverrides(</span>
						colEmployeeIDsNotInCache,
<span class="nc" id="L479">						new Timestamp(dateAbsCacheStart.getTime()),</span>
<span class="nc" id="L480">						new Timestamp(dateAbsCacheEnd.getTime()));</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">				for (Iterator itEmployeeID = colEmployeeIDsNotInCache.iterator(); itEmployeeID.hasNext();)</span>
				{
<span class="nc" id="L483">					ID idEmployee = (ID) itEmployeeID.next();</span>
<span class="nc" id="L484">					Collection colAdheranceOverridesToCache = (Collection) hmAdheranceOverridesNotInCache.get(idEmployee);</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">					if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L486">						m_cat.debug(&quot;Caching Overrides for employee: &quot; + idEmployee + &quot; Overrides: &quot; + colAdheranceOverridesToCache);</span>
<span class="nc" id="L487">					AdheranceOverrideCache adheranceOverrideCache =</span>
						new AdheranceOverrideCache(dateAbsCacheStart, dateAbsCacheEnd, colAdheranceOverridesToCache);
<span class="nc" id="L489">					m_adheranceOverrideCache.put(idEmployee, adheranceOverrideCache);</span>
<span class="nc" id="L490">					Collection colAdheranceOverrides = getAdheranceOverridesFromCache(idEmployee, dateStart, dateEnd);</span>
<span class="nc" id="L491">					hmAdheranceOverrides.put(idEmployee, colAdheranceOverrides);</span>
<span class="nc" id="L492">				}</span>
			}
<span class="nc" id="L494">			return hmAdheranceOverrides;</span>
		}
<span class="nc" id="L496">		catch (JdmoException e)</span>
		{
<span class="nc" id="L498">			handleException(e);</span>
<span class="nc" id="L499">			throw new BbmFinderException(e);</span>
		}
		finally
		{
<span class="nc" id="L503">			methodFinish();</span>
		}
	}

	public Collection&lt;Collection&lt;RTAAException&gt;&gt; getAdheranceExceptionsForEmployees(RTAADataIn rtaaDataIn) throws BbmFinderException
	{
<span class="nc" id="L509">		methodStart(</span>
			&quot;getAdheranceExceptionsForEmployees&quot;,
<span class="nc" id="L511">			rtaaDataIn.getEmployeeIDs(),</span>
<span class="nc" id="L512">			rtaaDataIn.getStartTime(),</span>
<span class="nc" id="L513">			rtaaDataIn.getEndTime());</span>

		try
		{

<span class="nc" id="L518">			Collection&lt;Collection&lt;RTAAException&gt;&gt; colAdheranceExceptionsAllEmployees = new LinkedList&lt;Collection&lt;RTAAException&gt;&gt;();</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">			for (Iterator itEmployeeID = rtaaDataIn.getEmployeeIDs().iterator(); itEmployeeID.hasNext();)</span>
			{
<span class="nc" id="L521">				ID idEmployee = (ID) itEmployeeID.next();</span>
<span class="nc" id="L522">				EmployeeDataIn employeeDataIn = (EmployeeDataIn) rtaaDataIn.getEmployeeDataIn().get(idEmployee);</span>
<span class="nc" id="L523">				employeeDataIn.setPlannedEvents(EventUtils.flattenEvents(employeeDataIn.getPlannedEvents()));</span>
<span class="nc" id="L524">				employeeDataIn.setActualEvents(EventUtils.flattenEvents(employeeDataIn.getActualEvents()));</span>
<span class="nc" id="L525">				m_hmActivityMappings = (HashMap) rtaaDataIn.getActivityMappings();</span>
<span class="nc" id="L526">				m_hmActivities = (HashMap) rtaaDataIn.getActivities();</span>

<span class="nc" id="L528">				colAdheranceExceptionsAllEmployees.add(</span>
<span class="nc" id="L529">					calcAdheranceExceptionsForEmployee(</span>
						employeeDataIn,
<span class="nc" id="L531">						rtaaDataIn.getStartTime(),</span>
<span class="nc" id="L532">						rtaaDataIn.getEndTime(),</span>
						false));
<span class="nc" id="L534">			}</span>
<span class="nc" id="L535">			return colAdheranceExceptionsAllEmployees;</span>
		}
		finally
		{
<span class="nc" id="L539">			methodFinish();</span>
		}
	}

	public boolean isAdheringTo(ID idActualActivity, ID idPlannedActivity)
	{
<span class="nc bnc" id="L545" title="All 2 branches missed.">		if (idPlannedActivity.compareTo(idActualActivity) == 0)</span>
<span class="nc" id="L546">			return true;</span>

<span class="nc" id="L548">        ActivityMapping activityMapping = null;</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">        if (m_activityMappingCache != null)</span>
<span class="nc" id="L550">            activityMapping = (ActivityMapping) m_activityMappingCache.get(idPlannedActivity);</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">        else if (m_hmActivityMappings != null)</span>
<span class="nc" id="L552">            activityMapping = (ActivityMapping) m_hmActivityMappings.get(idPlannedActivity);</span>

<span class="nc bnc" id="L554" title="All 2 branches missed.">		if (activityMapping == null)</span>
		{
<span class="nc bnc" id="L556" title="All 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L557">				m_cat.debug(&quot;isAdheringTo: activityMapping not found for Planned Activity ID: &quot; + idPlannedActivity);</span>
<span class="nc" id="L558">			return false;</span>
		}
<span class="nc" id="L560">		return activityMapping.getMappedActivityIDs().contains(idActualActivity);</span>
	}

/*	private boolean isAdheringTo(ID idActualActivity, ID idPlannedActivity)
	{
		if (idPlannedActivity.compareTo(idActualActivity) == 0)
			return true;
		ActivityMapping activityMapping = (ActivityMapping) m_hmActivityMappings.get(idPlannedActivity);
		if (activityMapping == null)
		{
			if (m_cat.isDebugEnabled())
				m_cat.debug(&quot;isAdheringTo: activityMapping not found for Planned Activity ID: &quot; + idPlannedActivity);
			return false;
		}
		return activityMapping.getMappedActivityIDs().contains(idActualActivity);
	} */

	public HashMap loadActivityMappings(Collection colActivityMappingsToLoadIDs) throws BbmFinderException
	{
<span class="nc" id="L579">		HashMap hmActivityMappings = new HashMap();</span>
<span class="nc" id="L580">		colActivityMappingsToLoadIDs = new LinkedList(colActivityMappingsToLoadIDs);</span>
<span class="nc" id="L581">		colActivityMappingsToLoadIDs.add(Activity.ACTIVITY_NONE);</span>
		// Load the information
<span class="nc" id="L583">		Collection activityMappings = getActivityMappingsByID(colActivityMappingsToLoadIDs);</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">		for (Iterator itActivityMapping = activityMappings.iterator(); itActivityMapping.hasNext();)</span>
		{
<span class="nc" id="L586">			ActivityMapping activityMapping = (ActivityMapping) itActivityMapping.next();</span>
<span class="nc" id="L587">			hmActivityMappings.put(activityMapping.getActivityID(), activityMapping);</span>
<span class="nc" id="L588">		}</span>
<span class="nc" id="L589">		return hmActivityMappings;</span>
	}

	/**
	 * Get the adherence tolerance setting for an activity. If the &quot;SpecialActivityOverrides&quot; license
	 * is present, we check the special activity tolerance from the ORGANIZATIONCONFIG table. These 
	 * settings are specified on the &quot;App Admin \ Activities \ Special Activities&quot; page. 
	 * @param activity
	 * @param empID
	 * @param start
	 * @return
	 */
	private int getAdherenceTolerance(Activity activity, ID empID, Date start) throws BbmFinderException
	{
<span class="nc" id="L603">		int tolerance = activity.getAdherenceTolerance();</span>
		
		try
		{
<span class="nc bnc" id="L607" title="All 2 branches missed.">			if (CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.SPECIAL_ACTIVITY_OVERRIDES))</span>
			{
				//get the employee's organization at the start date
<span class="nc" id="L610">				Collection wrAssignments = m_workResourceManager.getValidWorkResourceAssignments(empID, start, start);</span>
<span class="nc bnc" id="L611" title="All 4 branches missed.">				if ((wrAssignments != null) &amp;&amp; (!wrAssignments.isEmpty()))</span>
				{
<span class="nc bnc" id="L613" title="All 2 branches missed.">					for (Iterator it = wrAssignments.iterator(); it.hasNext();) </span>
					{
<span class="nc" id="L615">						WorkResourceAssignment assignment = (WorkResourceAssignment)it.next();</span>
<span class="nc" id="L616">						tolerance =  m_activityManager.getAdherenceToleranceOverride(assignment.getOrganizationID(), activity.getID());</span>
<span class="nc" id="L617">						break; //there should only be one for this date</span>
					}					
				}
			}
		}
<span class="nc" id="L622">		catch (Exception e)</span>
		{
<span class="nc" id="L624">			handleException(e);</span>
<span class="nc" id="L625">			throw new BbmFinderException(e);</span>
<span class="nc" id="L626">		}</span>

<span class="nc" id="L628">		return tolerance;</span>
	}

	private Collection&lt;RTAAException&gt; calcAdheranceExceptionsForEmployee(
		EmployeeDataIn employeeDataIn,
		Date dateStart,
		Date dateEnd,
		boolean bForceZeroTolerance)
		throws BbmFinderException
	{

<span class="nc" id="L639">		Calendar cCurrentTime = Calendar.getInstance();</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">		if (dateEnd.after(cCurrentTime.getTime()))</span>
<span class="nc" id="L641">			dateEnd = cCurrentTime.getTime();</span>

<span class="nc" id="L643">		ID idEmployee = employeeDataIn.getEmployeeID();</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">		if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L645">			m_cat.debug(</span>
				&quot;ENTER: calcAdheranceExceptionsForEmployee, EmployeeID = &quot;
					+ idEmployee
					+ &quot; Start = &quot;
<span class="nc" id="L649">					+ dateStart.toString()</span>
					+ &quot; End = &quot;
<span class="nc" id="L651">					+ dateEnd.toString());</span>

<span class="nc" id="L653">		Collection&lt;RTAAException&gt; listAdheranceExceptions = new LinkedList&lt;RTAAException&gt;();</span>
<span class="nc" id="L654">		ID idOffActivity = Activity.ACTIVITY_NONE;</span>
		// Translate events to state changes.

<span class="nc" id="L657">		TreeSet tsStateChanges = new TreeSet();</span>
<span class="nc" id="L658">		EventUtils.calcStateChangesFromEvents(employeeDataIn.getPlannedEvents(), tsStateChanges, true, (HashMap) null);</span>
<span class="nc" id="L659">		EventUtils.calcStateChangesFromEvents(employeeDataIn.getActualEvents(), tsStateChanges, false, (HashMap) null);</span>
<span class="nc" id="L660">		calcStateChangesFromAdheranceOverrides(employeeDataIn.getAdheranceOverrides(), tsStateChanges);</span>

		// Calculate adherance exceptions from state change collection
<span class="nc" id="L663">		ID idPlannedActivity = idOffActivity;</span>
<span class="nc" id="L664">		int nTolerance = 0;</span>
<span class="nc bnc" id="L665" title="All 4 branches missed.">		if (m_hmActivities.containsKey(idPlannedActivity) &amp;&amp; !bForceZeroTolerance)</span>
		{
<span class="nc" id="L667">			Activity activity = (Activity) m_hmActivities.get(idPlannedActivity);</span>
<span class="nc" id="L668">			nTolerance = getAdherenceTolerance(activity, idEmployee, dateStart);</span>
		}
<span class="nc" id="L670">		ID idExceptionPlannedActivity = null;</span>
<span class="nc" id="L671">		ID idActualActivity = idOffActivity;</span>
<span class="nc" id="L672">		boolean bWasAdhering = true;</span>
<span class="nc" id="L673">		Date dateExceptionStart = null;</span>
<span class="nc" id="L674">		int nExceptionTolerance = -1;</span>
<span class="nc" id="L675">		boolean bExceptionIsApproved = false;</span>
<span class="nc" id="L676">		boolean bIsApproved = false;</span>
<span class="nc" id="L677">		String exceptionApproveBy = null;</span>
<span class="nc" id="L678">		String approveBy = null;</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">		for (Iterator itStateChange = tsStateChanges.iterator(); itStateChange.hasNext();)</span>
		{
<span class="nc" id="L681">			EventUtils.StateChange stateChange = (EventUtils.StateChange) itStateChange.next();</span>
<span class="nc" id="L682">			int nType = stateChange.getType();</span>
<span class="nc bnc" id="L683" title="All 5 branches missed.">			switch (nType)</span>
			{
				case EventUtils.StateChange.PLANNED_ACTIVITY :
					{
<span class="nc" id="L687">						idPlannedActivity = stateChange.getActivityID();</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">						if (idPlannedActivity.compareTo(Activity.ACTIVITY_DELETED) == 0)</span>
<span class="nc" id="L689">							idPlannedActivity = Activity.ACTIVITY_NONE;</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">						if (m_hmActivities.containsKey(idPlannedActivity))</span>
						{
<span class="nc" id="L692">							Activity activity = (Activity) m_hmActivities.get(idPlannedActivity);</span>
<span class="nc" id="L693">							nTolerance = getAdherenceTolerance(activity, idEmployee, stateChange.getDate());</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">							if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L695">								m_cat.debug(</span>
									&quot;STATECHANGE:  PlannedActivityID = &quot;
										+ idPlannedActivity
										+ &quot;, Time = &quot;
<span class="nc" id="L699">										+ stateChange.getDate().toString()</span>
<span class="nc" id="L700">								+ &quot; Desc=&quot; + stateChange.getDescription());</span>
<span class="nc" id="L701">						}</span>
						else
						{
<span class="nc bnc" id="L704" title="All 2 branches missed.">							if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L705">								m_cat.debug(</span>
									&quot;STATECHANGE:  PlannedActivityID = &quot;
										+ idPlannedActivity
										+ &quot;(not found), Time = &quot;
<span class="nc" id="L709">										+ stateChange.getDate().toString()</span>
<span class="nc" id="L710">									+ &quot; Desc=&quot; + stateChange.getDescription());</span>
<span class="nc" id="L711">							nTolerance = 0;</span>
						}
<span class="nc" id="L713">						break;</span>
					}
				case EventUtils.StateChange.ACTUAL_ACTIVITY :
					{
<span class="nc" id="L717">						idActualActivity = stateChange.getActivityID();</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">						if (idActualActivity.compareTo(Activity.ACTIVITY_DELETED) == 0)</span>
<span class="nc" id="L719">							idActualActivity = Activity.ACTIVITY_NONE;</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">						if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L721">							m_cat.debug(</span>
								&quot;STATECHANGE:  ActualActivityID = &quot;
									+ idActualActivity
									+ &quot;, Time = &quot;
<span class="nc" id="L725">									+ stateChange.getDate().toString() </span>
<span class="nc" id="L726">								+ &quot; Desc=&quot; + stateChange.getDescription());</span>
						break;
					}
				case EventUtils.StateChange.ADHERANCE_OVERRIDE_ON :
					{
<span class="nc bnc" id="L731" title="All 2 branches missed.">						if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L732">							m_cat.debug(&quot;STATECHANGE:  ADHERANCE_OVERRIDE_ON, Time = &quot; + stateChange.getDate().toString()  + &quot; Desc=&quot; + stateChange.getDescription());</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">						if (bIsApproved)</span>
<span class="nc" id="L734">							continue;</span>
<span class="nc" id="L735">						bIsApproved = true;</span>
<span class="nc" id="L736">						approveBy = stateChange.getDescription();</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">						if (bWasAdhering)</span>
<span class="nc" id="L738">							continue;</span>
						break;
					}
				case EventUtils.StateChange.ADHERANCE_OVERRIDE_OFF :
					{
<span class="nc bnc" id="L743" title="All 2 branches missed.">						if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L744">							m_cat.debug(&quot;STATECHANGE:  ADHERANCE_OVERRIDE_OFF, Time = &quot; + stateChange.getDate().toString() + &quot; Desc=&quot; + stateChange.getDescription());</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">						if (!bIsApproved)</span>
<span class="nc" id="L746">							continue;</span>
<span class="nc" id="L747">						bIsApproved = false; // approval status changed may need new exception</span>
<span class="nc" id="L748">						approveBy = null;</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">						if (bWasAdhering)</span>
<span class="nc" id="L750">							continue;</span>
						break;
					}
			}
<span class="nc" id="L754">			boolean bIsAdhering = isAdheringTo(idActualActivity, idPlannedActivity);</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L756">				m_cat.debug(&quot;IsAdhering&quot; + new Boolean(bIsAdhering).toString());</span>
<span class="nc bnc" id="L757" title="All 4 branches missed.">			if (bWasAdhering == bIsAdhering &amp;&amp; nType == EventUtils.StateChange.ACTUAL_ACTIVITY)</span>
<span class="nc" id="L758">				continue; // This is the only state change that doesn't cause an exception state change</span>

<span class="nc bnc" id="L760" title="All 2 branches missed.">			if (dateExceptionStart != null)</span>
			{
<span class="nc" id="L762">				Date dateExceptionEnd = stateChange.getDate();</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">				if (dateExceptionEnd.after(dateEnd))</span>
<span class="nc" id="L764">					dateExceptionEnd = dateEnd;</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">				if (dateExceptionStart.before(dateStart))</span>
<span class="nc" id="L766">					dateExceptionStart = dateStart;</span>

<span class="nc" id="L768">				long lToleranceInMilliSecs = ((long) nExceptionTolerance) * (1000l * 60l);</span>
<span class="nc" id="L769">				long lDurationInMilliSecs = dateExceptionEnd.getTime() - dateExceptionStart.getTime();</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">				if (m_cat.isDebugEnabled())</span>
				{
<span class="nc" id="L772">					m_cat.debug(</span>
						&quot;End Exception:  Start = &quot;
<span class="nc" id="L774">							+ dateExceptionStart.toString()</span>
							+ &quot; End = &quot;
<span class="nc" id="L776">							+ dateExceptionEnd.toString()</span>
							+ &quot;Tolerance (ms) = &quot;
							+ lToleranceInMilliSecs
							+ &quot;Duration (ms) = &quot;
							+ lDurationInMilliSecs);
				}
				
<span class="nc bnc" id="L783" title="All 8 branches missed.">				if (lDurationInMilliSecs &gt; 0 &amp;&amp; ((lDurationInMilliSecs &gt; lToleranceInMilliSecs || bExceptionIsApproved) &amp;&amp; !bWasAdhering))</span>
				{
<span class="nc bnc" id="L785" title="All 4 branches missed.">					if (m_cat.isDebugEnabled() &amp;&amp; lDurationInMilliSecs &gt; lToleranceInMilliSecs)</span>
<span class="nc" id="L786">						m_cat.debug(&quot;Exception duration is greater than tolerance, bWasAdhering: &quot; + bWasAdhering);</span>
					
<span class="nc" id="L788">					String strApprovedBy = null;</span>
<span class="nc" id="L789">					String strComment = null;</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">					if (exceptionApproveBy != null)</span>
					{
<span class="nc" id="L792">						int n = exceptionApproveBy.indexOf(&quot;--&quot;);</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">						if (n == -1)</span>
<span class="nc" id="L794">							strApprovedBy = exceptionApproveBy;</span>
						else
						{
<span class="nc" id="L797">							strApprovedBy = exceptionApproveBy.substring(0, n);</span>
<span class="nc" id="L798">							strComment = exceptionApproveBy.substring(n + 2);</span>
						}
					}
					
<span class="nc" id="L802">					listAdheranceExceptions.add(</span>
						new RTAAException(
							idEmployee,
							dateExceptionStart,
							dateExceptionEnd,
							idExceptionPlannedActivity,
							bExceptionIsApproved,
							false,
							strApprovedBy,
							strComment));
<span class="nc" id="L812">				}</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">				else if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L814">					m_cat.debug(&quot;Exception duration is less than tolerance so ignore it&quot;);</span>
			}

<span class="nc" id="L817">			dateExceptionStart = stateChange.getDate();</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L819">				m_cat.debug(&quot;Begin Exception: Start = &quot; + dateExceptionStart.toString());</span>
<span class="nc" id="L820">			idExceptionPlannedActivity = idPlannedActivity;</span>
<span class="nc" id="L821">			nExceptionTolerance = nTolerance;</span>
<span class="nc" id="L822">			bExceptionIsApproved = bIsApproved;</span>
<span class="nc" id="L823">			exceptionApproveBy = approveBy;</span>

<span class="nc" id="L825">			bWasAdhering = bIsAdhering;</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">			if (stateChange.getDate().after(dateEnd))</span>
<span class="nc" id="L827">				break;</span>
<span class="nc" id="L828">		}</span>
<span class="nc" id="L829">		return listAdheranceExceptions;</span>
	}

 	static private void calcStateChangesFromAdheranceOverrides(Collection colAdheranceOverrides, TreeSet tsStateChanges)
	{
<span class="nc" id="L834">		Date lastEndDate = null;</span>
<span class="nc" id="L835">		String lastApprover = null;</span>
<span class="nc" id="L836">		EventUtils.StateChange lastEndStateChange = null;</span>

<span class="nc bnc" id="L838" title="All 2 branches missed."> 		for (Iterator i = colAdheranceOverrides.iterator(); i.hasNext();) {</span>
<span class="nc" id="L839"> 			AdheranceOverride adheranceOverride = (AdheranceOverride) i.next();</span>
<span class="nc" id="L840"> 			Date dateStart = adheranceOverride.getStartTime();</span>
<span class="nc" id="L841"> 			Date dateEnd = adheranceOverride.getEndTime();</span>
<span class="nc" id="L842"> 			String approveBy = adheranceOverride.getApproveBy() + &quot;--&quot; + adheranceOverride.getComment();</span>

<span class="nc bnc" id="L844" title="All 2 branches missed."> 			if (adheranceOverride.isDeleted())</span>
<span class="nc" id="L845"> 				continue;</span>

<span class="nc bnc" id="L847" title="All 2 branches missed.">			if (approveBy == null)</span>
<span class="nc" id="L848">				approveBy = &quot;&quot;;</span>

<span class="nc bnc" id="L850" title="All 2 branches missed.">			if (lastEndDate != null) {</span>
<span class="nc bnc" id="L851" title="All 4 branches missed.">				if (dateStart.equals(lastEndDate) &amp;&amp; approveBy.equals(lastApprover)) {</span>
<span class="nc" id="L852">					lastEndDate = dateEnd;</span>
<span class="nc" id="L853">					continue;</span>
				} else {
<span class="nc" id="L855">					lastEndStateChange = new EventUtils.StateChange(lastEndDate, Activity.ACTIVITY_UNKNOWN, EventUtils.StateChange.ADHERANCE_OVERRIDE_OFF);</span>
<span class="nc" id="L856">					tsStateChanges.add(lastEndStateChange);</span>
				}
			}

<span class="nc" id="L860">			EventUtils.StateChange stateChange = new EventUtils.StateChange(dateStart, Activity.ACTIVITY_UNKNOWN, EventUtils.StateChange.ADHERANCE_OVERRIDE_ON);</span>
<span class="nc" id="L861">			stateChange.setDescription(approveBy);</span>
<span class="nc" id="L862">			tsStateChanges.add(stateChange);</span>
<span class="nc" id="L863">			lastEndDate = dateEnd;</span>
<span class="nc" id="L864">			lastApprover = approveBy;</span>
<span class="nc" id="L865">		}</span>

<span class="nc bnc" id="L867" title="All 2 branches missed.">		if (lastEndDate != null) {</span>
<span class="nc" id="L868">			lastEndStateChange = new EventUtils.StateChange(lastEndDate, Activity.ACTIVITY_UNKNOWN, EventUtils.StateChange.ADHERANCE_OVERRIDE_OFF);</span>
<span class="nc" id="L869">			tsStateChanges.add(lastEndStateChange);</span>
		}
<span class="nc" id="L871">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>