<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PSSMinRemainingShiftDuration.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.swap.request.validation</a> &gt; <span class="el_source">PSSMinRemainingShiftDuration.java</span></div><h1>PSSMinRemainingShiftDuration.java</h1><pre class="source lang-java linenums">/*
 * Created on Oct 26, 2005
 */
package com.bluepumpkin.ejb.rm.requests.swap.request.validation;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.setup.validation.ejb.ValidationRuleManager;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.bluepumpkin.ejb.rm.util.ShiftSwapRequestUtil;

/**
 *
 * &lt;b&gt;Soft Validation: applies only for partial shift swap requests&lt;/b&gt;
 * &lt;p&gt;
 *    Validates that the remaining shift after the swap is greater than the specified duration
 * &lt;p&gt;
 *    Checks for both the shifts for a two way swap
 */
<span class="nc" id="L38">public class PSSMinRemainingShiftDuration  implements Validator</span>
{
<span class="nc" id="L40">    private static final String CLASS_NAME = PSSMinRemainingShiftDuration.class.getName();</span>
<span class="nc" id="L41">    private static final Category LOGGER = Log.initCategory(CLASS_NAME);</span>
    
    public static final String MIN_SHIFT_DURATION_VALUE = &quot;MIN_SHIFT_DURATION_VALUE&quot;;
    public static final String MIN_SHIFT_DURATION_UNIT = &quot;MIN_SHIFT_DURATION_UNIT&quot;;
    public static final int DURATION_UNIT_PERCENT = 0;
    public static final int DURATION_UNIT_MINUTES = 1;
<span class="nc" id="L47">    public static final ID RULE_ID = new ID(-194033);</span>

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.rm.requests.common.validation.Validator#validate(com.bluepumpkin.ejb.rm.requests.common.validation.Validatable)
     */
    @SuppressWarnings(&quot;rawtypes&quot;)
	@Override
	public ValidationResult validate(Validatable validatable) throws Exception
    {
<span class="nc" id="L56">        String methodName = &quot;validate&quot;;</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L58">			LOGGER.debug(RmUtil.dumpEnterMethod(methodName, validatable));</span>
		}

<span class="nc" id="L61">        ShiftSwapRequest ssr = (ShiftSwapRequest) validatable;</span>
<span class="nc" id="L62">        ShiftSwapValidationCache valCache = getShiftSwapValidationCache(ssr);</span>
<span class="nc" id="L63">        ShiftSwapItem ssItem1 = (ShiftSwapItem) ssr.getShiftSwapItems().get(0);</span>
<span class="nc" id="L64">        ShiftSwapItem ssItem2 = (ShiftSwapItem) ssr.getShiftSwapItems().get(1);</span>
<span class="nc" id="L65">        ValidationResult result = null;</span>
<span class="nc bnc" id="L66" title="All 4 branches missed.">        if (ssItem1.getIsPartial() || ssItem2.getIsPartial()) {</span>
        	// need to get the original shift assignments to compare/validate for percentage
<span class="nc" id="L68">        	ShiftAssignment[] saBeforeSwap = getOriginalShiftAssignments(valCache);</span>
        	// get the resulting shifts after the swap
<span class="nc" id="L70">            ShiftAssignment[] saArray = null;</span>
            // get the sa array after the swap
<span class="nc" id="L72">        	saArray = performPartialSwap(ssr);</span>
        	
        	// make sure the orgIDs are not duplicate
<span class="nc" id="L75">        	ArrayList&lt;ID&gt; orgList = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        	for (Iterator it = valCache.getOrgIDs().iterator(); it.hasNext();){</span>
<span class="nc" id="L77">	        	ID orgID = (ID)it.next();</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">	        	if (!orgList.contains(orgID)) {</span>
<span class="nc" id="L79">					orgList.add(orgID);</span>
				}
<span class="nc" id="L81">        	}</span>
        	
        	//for each org, find out the validator- if beeded to run for both or not
<span class="nc bnc" id="L84" title="All 2 branches missed.">        	for (int i = 0; i &lt; orgList.size(); i++){</span>
<span class="nc" id="L85">	        	ID orgID = (ID)orgList.get(i);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">	        	if (valCache.isValidationRequiredForOrg(orgID, Request.REQUESTTYPE_SHIFTSWAP, CLASS_NAME)){</span>
	        		//get the rule params
<span class="nc" id="L88">		        	ValidationRuleManager valMan = getValidationRuleManager();</span>
<span class="nc" id="L89">					Map&lt;String, Integer&gt; ruleParams = valMan.getValidationRuleParams(orgID, RULE_ID);</span>
<span class="nc" id="L90">		        	int duration = getDuration(ruleParams);</span>
<span class="nc" id="L91">		        	int unit = getUnit(ruleParams);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">		        	for (int j=0; j&lt;ssr.getShiftSwapItems().size(); j++){</span>
<span class="nc" id="L93">			        	result = verifyMinRemainingShiftDuration(saBeforeSwap, saArray, unit, duration, </span>
<span class="nc" id="L94">			        			validatable, (ShiftSwapItem)ssr.getShiftSwapItems().get(j), valCache);</span>
		        	}
	        	}
        	}
        }
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L100">			LOGGER.debug(RmUtil.dumpExitMethod(methodName));</span>
		}
<span class="nc" id="L102">        return result;</span>
    }
    
    private ValidationResult verifyMinRemainingShiftDuration(ShiftAssignment[] saBeforeSwap,ShiftAssignment[] saArrayAfterSwap, int unit, int duration,
    		Validatable validatable, ShiftSwapItem ssItem, ShiftSwapValidationCache valCache) throws Exception {
    	
<span class="nc bnc" id="L108" title="All 2 branches missed.">    	for (int i = 0; i&lt; saArrayAfterSwap.length; i++) {</span>
<span class="nc" id="L109">    		ShiftAssignment saAfter = saArrayAfterSwap[i];</span>
<span class="nc" id="L110">    		ShiftAssignment saBefore = saBeforeSwap[i];</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">    		if (saAfter.getWorkResourceIDs().iterator().next().equals(ssItem.getEmployeeID())) {</span>
<span class="nc bnc" id="L112" title="All 4 branches missed.">    			if (unit == DURATION_UNIT_PERCENT </span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">    					&amp;&amp; (saBefore != null &amp;&amp; saBefore.getWorkResourceIDs().iterator().next().equals(ssItem.getEmployeeID()))) {</span>
    	    		//get the actual duration from the shift
<span class="nc" id="L115">    	    		duration = (saBefore.getDuration()*duration)/100;</span>
    	    	}
    			//validate this shift as it corresponds to the item
<span class="nc bnc" id="L118" title="All 2 branches missed.">    			if (saAfter.getDuration() &lt; duration) {</span>
<span class="nc" id="L119">    	    		return ValidationUtil.setSoftValidationResult(validatable, </span>
    	                    RmEjbBundleKey.PSS_REM_SHIFT_DURATION_LESS_THAN_MIN, 
<span class="nc" id="L121">    	                    ssItem.getStartDate(), </span>
<span class="nc" id="L122">    	                    ssItem.getEndDate(), </span>
<span class="nc" id="L123">    	                    String.valueOf(duration), </span>
<span class="nc" id="L124">    	                    valCache.getEmployeeNameByID(ssItem.getEmployeeID()),</span>
    	                    CLASS_NAME);
    	    	}
    		}
    	}  	
<span class="nc" id="L129">    	return null;</span>
    }
    protected ShiftSwapValidationCache getShiftSwapValidationCache(ShiftSwapRequest ssRequest) {
<span class="nc" id="L132">		return (ShiftSwapValidationCache) ssRequest.getCache();</span>
	}
    protected ValidationRuleManager getValidationRuleManager() throws BbmCreateException {
<span class="nc" id="L135">		return RmManagerFactory.getInstance().getValidationRuleManager();</span>
	}
    protected ShiftAssignment[] getOriginalShiftAssignments( ShiftSwapValidationCache valCache) throws Exception{
<span class="nc" id="L138">    	ScheduleAccessManager sam = RequestUtil.getScheduleAccessManager();</span>
<span class="nc" id="L139">    	return valCache.getShiftAssignsForReqSameOrgDay(true, sam);</span>
    }
    protected ShiftAssignment[] performPartialSwap(ShiftSwapRequest ssReq) throws Exception{
<span class="nc" id="L142">    	ScheduleAccessManager sam = RequestUtil.getScheduleAccessManager();</span>
<span class="nc" id="L143">    	return ShiftSwapRequestUtil.performPartialSwap(ssReq, false, </span>
    			sam, false, false);
    }
    protected int getDuration(Map&lt;String, Integer&gt; ruleParams ){
<span class="nc" id="L147">    	return ruleParams.get(MIN_SHIFT_DURATION_VALUE).intValue();</span>
    }
    protected int getUnit(Map&lt;String, Integer&gt; ruleParams ){
<span class="nc" id="L150">    	return ruleParams.get(MIN_SHIFT_DURATION_UNIT).intValue();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>