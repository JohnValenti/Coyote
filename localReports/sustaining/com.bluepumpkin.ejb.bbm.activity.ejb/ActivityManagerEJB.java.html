<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.activity.ejb</a> &gt; <span class="el_source">ActivityManagerEJB.java</span></div><h1>ActivityManagerEJB.java</h1><pre class="source lang-java linenums">/*
 * Copyright -2011 Verint Systems, Inc.
 */

package com.bluepumpkin.ejb.bbm.activity.ejb;

import java.rmi.RemoteException;
import java.util.*;
import java.util.List;

import javax.naming.Context;
import javax.naming.InitialContext;

import com.bluepumpkin.common.cache.Cache;
import com.bluepumpkin.common.cache.CacheFactory;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.localization.LocaleContext;
import com.bluepumpkin.common.localization.LocalizationManager;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.NumberFactory;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.JNDINames;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategory;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategoryFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityGroup;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityMedia;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityProperties;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityQueue;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityValidationException;
import com.bluepumpkin.ejb.bbm.base.BbmCreateDuplicateKeyException;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.config.ConfigCacheUtil;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.config.ejb.DBConfigManager;
import com.bluepumpkin.ejb.bbm.dao.DAOEJBUtil;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.dao.MapUtil;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.ObjectType;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.SystemType;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TimeOffHoursManagerBridge;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.witness.ejb.bbm.delete.DeleteException;
import com.witness.ejb.bbm.delete.ejb.DeleteManager;
import com.witness.ejb.bbm.delete.model.DeletionResult;
import com.witness.ejb.core.gcr.ejb.GCRManager;
import com.witness.ejb.core.gcr.model.GCREntry;


<span class="fc" id="L62">public class ActivityManagerEJB extends SessionEJBBase {</span>

	/**
	 *
	 */
	private static final long serialVersionUID = 1L;
<span class="fc" id="L68">	private static final Category m_cat = Log.initCategory(ActivityManagerEJB.class.getName());</span>
	private DBConfigManager m_DBConfigManager;
<span class="fc" id="L70">	private boolean lastCheckStatus = true;</span>
<span class="fc" id="L71">	private Cache m_ActivityCache = null;</span>
<span class="fc" id="L72">	private static final String clsName = ActivityManagerEJB.class.getName();</span>

<span class="fc" id="L74">	private boolean WhatIfMode = false;</span>
<span class="fc" id="L75">	private TimeOffHoursManagerBridge m_timeOffHoursManagerBridge = null;</span>

	private DeleteManager deleteManager;

<span class="fc" id="L79">	private transient ActivityQueueDAOFactory activityQueueDAOFactory = new ActivityQueueDAOFactory();</span>

	/**
	 * override the base class to provide the appropriate logging category
	 */
	@Override
	protected Category getCategory() {
<span class="fc" id="L86">		return m_cat;</span>
	}

	{
<span class="fc" id="L90">		super.init(clsName);</span>
<span class="fc" id="L91">	}</span>

	@Override
	public void onEjbCreate() {
		try {
			// First query environment to get WIF setting from DD
<span class="fc" id="L97">			Context initialContext = new InitialContext();</span>
<span class="fc" id="L98">			Boolean WIF = (Boolean) initialContext.lookup(&quot;java:comp/env/WIF&quot;);</span>
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">			if (WIF != null) {</span>
<span class="fc" id="L100">				WhatIfMode = WIF.booleanValue();</span>
			}
			// If not in WhatIfMode, then initialize Cache
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">			if (!WhatIfMode) {</span>
<span class="fc" id="L104">				m_DBConfigManager = BbmManagerFactory.getDBConfigManager();</span>
				// If cache is enabled at first, instantiate cache
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">				if (ConfigCacheUtil.isCacheEnabled(m_DBConfigManager, ConfigKey.ACTIVITY_CACHE_USAGE)) {</span>
<span class="fc" id="L107">					m_ActivityCache = CacheFactory.getCache(JNDINames.BBM_ACTIVITYMANAGER_EJBHOME,</span>
<span class="fc" id="L108">							ActivityManagerEJB.class.getClassLoader());</span>
<span class="fc" id="L109">					initCache();</span>
				} else {
<span class="nc" id="L111">					lastCheckStatus = false;</span>
				}
			}
<span class="fc" id="L114">			deleteManager = BbmManagerFactory.getDeleteManager(WhatIfMode);</span>
<span class="nc" id="L115">		} catch (Exception e) {</span>
<span class="nc" id="L116">			handleException(&quot;onEjbCreate&quot;, e, false);</span>
<span class="fc" id="L117">		}</span>
<span class="fc" id="L118">	}</span>

	private void initCache() throws BbmFinderException {
<span class="fc" id="L121">		Boolean init = (Boolean) m_ActivityCache.get(&quot;INITIALIZED&quot;);</span>
<span class="pc bpc" id="L122" title="1 of 4 branches missed.">		if (init != null &amp;&amp; init.booleanValue()) {</span>
<span class="fc" id="L123">			return;</span>
		}
		// initialize the cache, load all activities
<span class="fc" id="L126">		ActivityFilter filter = new ActivityFilter(ActivityFilter.FILTER_NONE);</span>
<span class="fc" id="L127">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="fc" id="L129">			Collection actCol = activityDao.findActivities(filter);</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">			for (Iterator iter = actCol.iterator(); iter.hasNext();) {</span>
<span class="fc" id="L131">				Activity element = (Activity) iter.next();</span>
<span class="fc" id="L132">				m_ActivityCache.put(element.getID(), element);</span>
<span class="fc" id="L133">			}</span>
<span class="fc" id="L134">			m_ActivityCache.put(&quot;INITIALIZED&quot;, Boolean.TRUE);</span>
		} finally {
<span class="pc" id="L136">			activityDao.cleanUp();</span>
<span class="fc" id="L137">		}</span>
<span class="fc" id="L138">	}</span>

	/**
	 * &lt;B&gt;findActivityById&lt;/B&gt;
	 * &lt;P&gt;
	 * returns an Activity for a given id
	 * &lt;P&gt;
	 *
	 * @param id
	 *            : activity id to search
	 * @return Activity
	 */
	public Activity findActivityById(ID id) throws BbmFinderException, BbmObjectNotFoundException {
<span class="fc" id="L151">		methodStart(&quot;findActivityById&quot;, id);</span>
<span class="fc" id="L152">		ActivityDAO activityDao = null;</span>
		try {
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">			if (cacheUsed()) {</span>
<span class="fc" id="L155">				initCache();</span>
<span class="fc" id="L156">				Activity act = (Activity) m_ActivityCache.get(id);</span>
<span class="pc bpc" id="L157" title="2 of 4 branches missed.">				if (act != null &amp;&amp; act.getID().equals(id)) {</span>
<span class="fc" id="L158">					return (Activity)(act.clone());</span>
				}
<span class="nc" id="L160">				m_cat.info(&quot;Failed to find Activity &quot; + id + &quot; in the cache.&quot;);</span>
			}
<span class="nc" id="L162">			activityDao = new ActivityDAO();</span>
<span class="nc" id="L163">			Activity act = (Activity) activityDao.getObjectByID(id);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">			if (cacheUsed()) {</span>
<span class="nc" id="L165">				m_ActivityCache.put(id, act);</span>
<span class="nc" id="L166">				act = (Activity)(act.clone()); //for cache, always return cloned object.</span>
			}
<span class="nc" id="L168">			return act;</span>
<span class="nc" id="L169">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L170">			handleException(e, false);</span>
<span class="nc" id="L171">			throw e;</span>
<span class="nc" id="L172">		} catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L173">			handleException(e, false);</span>
<span class="nc" id="L174">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc bpc" id="L176" title="5 of 6 branches missed.">			if (activityDao != null) {</span>
<span class="nc" id="L177">				activityDao.cleanUp();</span>
			}
<span class="pc" id="L179">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities that meet given ActivityFilter criteria
	 * &lt;P&gt;
	 *
	 * @param activityFilter
	 *            : search criteria
	 * @return Collection of activities
	 */
	public Collection&lt;Activity&gt; findActivities(ActivityFilter activityFilter) throws BbmFinderException {
<span class="fc" id="L194">		methodStart(&quot;findActivities&quot;, activityFilter);</span>
<span class="fc" id="L195">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="fc" id="L197">			return activityDao.findActivities(activityFilter);</span>
<span class="nc" id="L198">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L199">			handleException(e, false);</span>
<span class="nc" id="L200">			throw e;</span>
		} finally {
<span class="pc" id="L202">			activityDao.cleanUp();</span>
<span class="pc" id="L203">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivitiesIds&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities Ids that meet given ActivityFilter criteria
	 * &lt;P&gt;
	 *
	 * @param activityFilter
	 *            : search criteria
	 * @return Collection of activities Ids
	 */
	public Collection&lt;ID&gt; findActivitiesIds(ActivityFilter activityFilter) throws BbmFinderException {
<span class="fc" id="L218">		methodStart(&quot;findActivitiesIds&quot;, activityFilter);</span>
<span class="fc" id="L219">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="fc" id="L221">			return activityDao.findActivitiesIds(activityFilter);</span>
<span class="nc" id="L222">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L223">			handleException(e, false);</span>
<span class="nc" id="L224">			throw e;</span>
		} finally {
<span class="pc" id="L226">			activityDao.cleanUp();</span>
<span class="pc" id="L227">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;getActivities&lt;/B&gt;
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            int value of id of employee to search
	 *            &lt;P&gt;
	 * @return collection of ActivityGroup objects
	 * @deprecated see getActivities(ID,boolean);
	 */
	@Deprecated
	public ActivityGroup getActivities(Collection&lt;ID&gt; organizationIdCol) throws BbmFinderException {
<span class="nc" id="L243">		methodStart(&quot;getActivities&quot;, organizationIdCol);</span>
		try {
<span class="nc" id="L245">			ActivityFilter activityFilter = new ActivityFilter();</span>
<span class="nc" id="L246">			activityFilter.setDeleted(false);</span>
<span class="nc" id="L247">			ActivityDAO activityDao = new ActivityDAO();</span>
<span class="nc" id="L248">			Collection activities = activityDao.findOrganizationActivities(organizationIdCol, activityFilter);</span>
<span class="nc" id="L249">			activityDao.cleanUp();</span>
<span class="nc" id="L250">			ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
<span class="nc" id="L251">			ActivityCategoryFilter activityCategoryFilter = new ActivityCategoryFilter();</span>
<span class="nc" id="L252">			activityCategoryFilter.setVisibleToToTimeCollection(true);</span>
<span class="nc" id="L253">			activityCategoryFilter.setDeleted(true);</span>
<span class="nc" id="L254">			Collection activityCategories = activityCategoryDao.findOrganizationActivityCategories(organizationIdCol,</span>
					activityCategoryFilter);
<span class="nc" id="L256">			activityCategoryDao.cleanUp();</span>
<span class="nc" id="L257">			return new ActivityGroup(activities, activityCategories);</span>
<span class="nc" id="L258">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L259">			handleException(e, false);</span>
<span class="nc" id="L260">			throw e;</span>
		} finally {
<span class="nc" id="L262">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;getActivities&lt;/B&gt;
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            int value of id of employee to search
	 * @param int Categories to get, use constant in ActivityGroup ActivityGroup.ALL_ACTIVITYCATEGORIES = 0;
	 *        ActivityGroup.MYTIME_ACTIVITYCATEGORIES = 1;
	 *        &lt;P&gt;
	 * @return collection of ActivityGroup objects
	 */
	public ActivityGroup getActivities(Collection&lt;ID&gt; organizationIdCol, int activityCategoriesToGet)
			throws BbmFinderException {
<span class="fc" id="L279">		methodStart(&quot;getActivities&quot;, organizationIdCol, NumberFactory.newInteger(activityCategoriesToGet));</span>
		try {
<span class="fc" id="L281">			ActivityFilter activityFilter = new ActivityFilter();</span>
<span class="fc" id="L282">			activityFilter.setDeleted(false);</span>
<span class="fc" id="L283">			ActivityDAO activityDao = new ActivityDAO();</span>
<span class="fc" id="L284">			Collection activities = activityDao.findOrganizationActivities(organizationIdCol, activityFilter);</span>
<span class="fc" id="L285">			activityDao.cleanUp();</span>
<span class="fc" id="L286">			ActivityCategoryFilter activityCategoryFilter = new ActivityCategoryFilter();</span>
<span class="fc" id="L287">			activityCategoryFilter.setDeleted(false);</span>
<span class="fc bfc" id="L288" title="All 2 branches covered.">			if (activityCategoriesToGet == ActivityGroup.MYTIME_ACTIVITYCATEGORIES) {</span>
				// --------------------------------------------------------
				// just get timecollection activity categories
				// --------------------------------------------------------
<span class="fc" id="L292">				activityCategoryFilter.setVisibleToToTimeCollection(true);</span>
			}
<span class="fc" id="L294">			ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
<span class="fc" id="L295">			Collection activityCategories = activityCategoryDao.findOrganizationActivityCategories(organizationIdCol,</span>
					activityCategoryFilter);
<span class="fc" id="L297">			activityCategoryDao.cleanUp();</span>
<span class="fc" id="L298">			return new ActivityGroup(activities, activityCategories);</span>
<span class="nc" id="L299">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L300">			handleException(e, false);</span>
<span class="nc" id="L301">			throw e;</span>
		} finally {
<span class="pc" id="L303">			methodFinish();</span>
		}
	}

	public ActivityGroup getActivities(Collection&lt;ID&gt; organizationIdCol, ID currentActivityCategoryId)
			throws BbmFinderException {
<span class="nc" id="L309">		methodStart(&quot;getActivities&quot;, organizationIdCol, currentActivityCategoryId);</span>
		try {
<span class="nc" id="L311">			ActivityFilter activityFilter = new ActivityFilter();</span>
<span class="nc" id="L312">			activityFilter.setDeleted(false);</span>
<span class="nc" id="L313">			ActivityDAO activityDao = new ActivityDAO();</span>
<span class="nc" id="L314">			Collection activities = activityDao.findOrganizationActivitiesByCategory(organizationIdCol,</span>
					currentActivityCategoryId, activityFilter);
<span class="nc" id="L316">			activityDao.cleanUp();</span>
<span class="nc" id="L317">			ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
<span class="nc" id="L318">			Collection activityCategories = activityCategoryDao.findActivityCategories(new ActivityCategoryFilter());</span>
<span class="nc" id="L319">			activityCategoryDao.cleanUp();</span>
<span class="nc" id="L320">			return new ActivityGroup(currentActivityCategoryId, activities, activityCategories);</span>

<span class="nc" id="L322">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L323">			handleException(e);</span>
<span class="nc" id="L324">			throw e;</span>
		} finally {
<span class="nc" id="L326">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivitiesIds&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities Ids that meet given ActivityFilter criteria Activities of parent organizations will also be
	 * returned
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            : id of organization to search for
	 * @param activityFilter
	 *            : search criteria
	 * @return Collection of activities Ids
	 */
	public Collection findOrganizationActivitiesIds(ID organizationId, ActivityFilter activityFilter)
			throws BbmFinderException {
<span class="nc" id="L345">		methodStart(&quot;findOrganizationActivitiesIds&quot;, organizationId, activityFilter);</span>
<span class="nc" id="L346">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L348">			return activityDao.findOrganizationActivitiesIds(organizationId, activityFilter);</span>
<span class="nc" id="L349">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L350">			handleException(e, false);</span>
<span class="nc" id="L351">			throw e;</span>
		} finally {
<span class="nc" id="L353">			activityDao.cleanUp();</span>
<span class="nc" id="L354">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given ids
	 * &lt;P&gt;
	 *
	 * @param ids
	 *            : Collection of id's to search for
	 * @return Collection of activities found
	 */
	public Collection&lt;Activity&gt; findActivities(Collection&lt;ID&gt; ids) throws BbmFinderException {
<span class="fc" id="L369">		methodStart(&quot;findActivities&quot;, ids);</span>
<span class="fc" id="L370">		ActivityDAO activityDao = null;</span>
		try {
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">			if (cacheUsed()) {</span>
<span class="fc" id="L373">				initCache();</span>
<span class="fc" id="L374">				ArrayList&lt;Activity&gt; actCol = new ArrayList&lt;Activity&gt;(ids.size());</span>
<span class="fc bfc" id="L375" title="All 2 branches covered.">				for (Iterator&lt;ID&gt; iter = ids.iterator(); iter.hasNext();) {</span>
<span class="fc" id="L376">					ID id = iter.next();</span>
<span class="fc" id="L377">					Activity act = findActivityById(id);</span>
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">					if (act != null) {</span>
<span class="fc" id="L379">						actCol.add(act);</span>
					}
<span class="fc" id="L381">				}</span>
<span class="fc" id="L382">				return actCol;</span>
			}
<span class="nc" id="L384">			activityDao = new ActivityDAO();</span>
<span class="nc" id="L385">			return activityDao.findActivities(ids);</span>
<span class="nc" id="L386">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L387">			handleException(e, false);</span>
<span class="nc" id="L388">			throw e;</span>
		} finally {
<span class="pc bpc" id="L390" title="5 of 6 branches missed.">			if (activityDao != null) {</span>
<span class="nc" id="L391">				activityDao.cleanUp();</span>
			}
<span class="pc" id="L393">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given organization and activityFilter Activities of parent organizations will also be
	 * returned
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            : id of organization to search for
	 * @param activityFilter
	 *            : search criteria
	 * @return Collection of activities found
	 */
	public Collection&lt;Activity&gt; findOrganizationActivities(ID organizationId, ActivityFilter activityFilter)
			throws BbmFinderException {
<span class="fc" id="L412">		methodStart(&quot;findOrganizationActivities&quot;, organizationId, activityFilter);</span>
<span class="fc" id="L413">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="fc" id="L415">			ArrayList&lt;ID&gt; orgCol = new ArrayList&lt;ID&gt;(1);</span>
<span class="fc" id="L416">			orgCol.add(organizationId);</span>
<span class="fc" id="L417">			return activityDao.findOrganizationActivitiesCheckCategory(orgCol, activityFilter,true);</span>
<span class="nc" id="L418">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L419">			handleException(e, false);</span>
<span class="nc" id="L420">			throw e;</span>
		} finally {
<span class="pc" id="L422">			activityDao.cleanUp();</span>
<span class="pc" id="L423">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given organization and activityFilter Activities of parent organizations will also be
	 * returned
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            : id of organization to search for
	 * @param activityFilter
	 *            : search criteria
	 * @param flexType
	 *            : TO or Flex Request
	 * @return Collection of activities found
	 */
	public Collection&lt;Activity&gt; findOrganizationActivities(ID organizationId, ActivityFilter activityFilter, int flexType)
			throws BbmFinderException {
<span class="fc" id="L444">		methodStart(&quot;findOrganizationActivities&quot;, organizationId, activityFilter, flexType);</span>
<span class="fc" id="L445">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="fc" id="L447">			List&lt;ID&gt; orgCol = new ArrayList&lt;ID&gt;(1);</span>
<span class="fc" id="L448">			orgCol.add(organizationId);</span>
<span class="fc" id="L449">			return activityDao.findOrganizationActivitiesCheckCategory(orgCol, activityFilter, true, flexType);</span>
<span class="nc" id="L450">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L451">			handleException(e, false);</span>
<span class="nc" id="L452">			throw e;</span>
		} finally {
<span class="pc" id="L454">			activityDao.cleanUp();</span>
<span class="pc" id="L455">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given organizations ids and activityFilter
	 * &lt;P&gt;
	 *
	 * @param orgIds
	 *            : a collection of organizations ids
	 * @param activityFilter
	 *            : search criteria
	 * @param findParentOrgs
	 *            : indicates if to find activities from parent orgs
	 * @return Collection of activities found
	 */
	public Collection&lt;Activity&gt; findOrganizationActivities(Collection&lt;ID&gt; orgIds, ActivityFilter activityFilter, boolean findParentOrgs)
	throws BbmFinderException
	{
<span class="fc" id="L476">		methodStart(&quot;findOrganizationActivities&quot;, orgIds, activityFilter, new Boolean(findParentOrgs));</span>
<span class="fc" id="L477">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="fc" id="L479">			return activityDao.findOrganizationActivities(orgIds, activityFilter, findParentOrgs);</span>
<span class="nc" id="L480">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L481">			handleException(e, false);</span>
<span class="nc" id="L482">			throw e;</span>
		} finally {
			
<span class="pc" id="L485">			activityDao.cleanUp();</span>
<span class="pc" id="L486">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given organizations ids, activityFilter, and flex type
	 * &lt;P&gt;
	 *
	 * @param orgIds
	 *            : a collection of organizations ids
	 * @param activityFilter
	 *            : search criteria
	 * @param findParentOrgs
	 *            : indicates if to find activities from parent orgs
	 * @return Collection of activities found
	 */
	public Collection&lt;Activity&gt; findOrganizationActivities(Collection&lt;ID&gt; orgIds, ActivityFilter activityFilter, boolean findParentOrgs,
			int flexType) throws BbmFinderException	{
<span class="nc" id="L506">		methodStart(&quot;findOrganizationActivities&quot;, orgIds, activityFilter, new Boolean(findParentOrgs));</span>
<span class="nc" id="L507">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L509">			return activityDao.findOrganizationActivities(orgIds, activityFilter, findParentOrgs, flexType);</span>
<span class="nc" id="L510">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L511">			handleException(e, false);</span>
<span class="nc" id="L512">			throw e;</span>
		} finally {
<span class="nc" id="L514">			activityDao.cleanUp();</span>
<span class="nc" id="L515">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given organizations ids
	 * &lt;P&gt;
	 *
	 * @param orgIds
	 *            : a collection of organizations ids
	 * @param findParentOrgs
	 *            : indicates if to find activities from parent orgs
	 * @return Collection of activities found
	 */
	public Collection&lt;Activity&gt; findOrganizationActivities(Collection&lt;ID&gt; orgIds, boolean findParentOrgs) throws BbmFinderException {
<span class="fc" id="L532">		return findOrganizationActivities(orgIds, (ActivityFilter) null, findParentOrgs);</span>
	}

	/**
	 * &lt;B&gt;findOrganizationActivitiesByCategory&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given organization and activityFilter Activities of parent organizations will also be
	 * returned
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            : id of organization to search for
	 * @param activityFilter
	 *            : search criteria
	 * @return Collection of activities found
	 */
	public Collection findOrganizationActivitiesByCategory(ID organizationId, ID activityCategoryId,
			ActivityFilter activityFilter) throws BbmFinderException {
<span class="nc" id="L550">		methodStart(&quot;findOrganizationActivitiesByCategory&quot;, organizationId, activityCategoryId, activityFilter);</span>
<span class="nc" id="L551">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L553">			ArrayList&lt;ID&gt; orgCol = new ArrayList&lt;ID&gt;(1);</span>
<span class="nc" id="L554">			orgCol.add(organizationId);</span>
<span class="nc" id="L555">			return activityDao.findOrganizationActivitiesByCategory(orgCol, activityCategoryId, activityFilter);</span>
<span class="nc" id="L556">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L557">			handleException(e, false);</span>
<span class="nc" id="L558">			throw e;</span>
		} finally {
<span class="nc" id="L560">			activityDao.cleanUp();</span>
<span class="nc" id="L561">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivityCategoryById&lt;/B&gt;
	 * &lt;P&gt;
	 * returns an ActivityCategory for a given id
	 * &lt;P&gt;
	 *
	 * @param id
	 *            activity id to search
	 * @return Activity
	 */
	public ActivityCategory findActivityCategoryById(ID id) throws BbmFinderException, BbmObjectNotFoundException {
<span class="fc" id="L576">		methodStart(&quot;findActivityById&quot;, id);</span>
<span class="fc" id="L577">		ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
		try {
<span class="fc" id="L579">			return (ActivityCategory) activityCategoryDao.getObjectByID(id);</span>
<span class="nc" id="L580">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L581">			handleException(e, false);</span>
<span class="nc" id="L582">			throw e;</span>
<span class="nc" id="L583">		} catch (Exception e) {</span>
<span class="nc" id="L584">			handleException(e, false);</span>
<span class="nc" id="L585">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L587">			activityCategoryDao.cleanUp();</span>
<span class="pc" id="L588">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivityCategories&lt;/B&gt;
	 * &lt;P&gt;
	 * find activity categories for given ids
	 * &lt;P&gt;
	 *
	 * @param ids
	 *            : Collection of id's to search for
	 * @return Collection of activity categories found
	 */
	public Collection findActivityCategories(Collection ids) throws BbmException, BbmFinderException {
<span class="fc" id="L603">		methodStart(&quot;findActivityCategories&quot;, ids);</span>
<span class="fc" id="L604">		ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
		try {
<span class="fc" id="L606">			return activityCategoryDao.findActivityCategories(ids);</span>
<span class="nc" id="L607">		} catch (BbmException e) {</span>
<span class="nc" id="L608">			handleException(e, false);</span>
<span class="nc" id="L609">			throw e;</span>
		} finally {
<span class="pc" id="L611">			activityCategoryDao.cleanUp();</span>
<span class="pc" id="L612">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivityCategories&lt;/B&gt;
	 * &lt;P&gt;
	 * find activityCatgegories that meet given ActivityFilter criteria
	 * &lt;P&gt;
	 *
	 * @param activityCategoryFilter
	 *            : search criteria
	 * @return Collection of activityCatgegories
	 */
	public Collection findActivityCategories(ActivityCategoryFilter activityCategoryFilter) throws BbmFinderException {
<span class="nc" id="L627">		methodStart(&quot;findActivityCategories&quot;, activityCategoryFilter);</span>
<span class="nc" id="L628">		ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
		try {
<span class="nc" id="L630">			return activityCategoryDao.findActivityCategories(activityCategoryFilter);</span>
<span class="nc" id="L631">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L632">			handleException(e, false);</span>
<span class="nc" id="L633">			throw e;</span>
		} finally {
<span class="nc" id="L635">			activityCategoryDao.cleanUp();</span>
<span class="nc" id="L636">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivityCategories&lt;/B&gt;
	 * &lt;P&gt;
	 * find activityCategories for given organization and activityCategoryFilter Activities of parent organizations will
	 * also be returned
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            : id of organization to search for
	 * @param activityCategoryFilter
	 *            : search criteria
	 * @return Collection of activityCategories found
	 */
	public Collection findOrganizationActivityCategories(ID organizationId,
			ActivityCategoryFilter activityCategoryFilter) throws BbmFinderException {
<span class="fc" id="L655">		methodStart(&quot;findOrganizationActivityCategories&quot;, organizationId, activityCategoryFilter);</span>
<span class="fc" id="L656">		ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
		try {
<span class="fc" id="L658">			ArrayList&lt;ID&gt; orgCol = new ArrayList&lt;ID&gt;(1);</span>
<span class="fc" id="L659">			orgCol.add(organizationId);</span>
<span class="fc" id="L660">			return activityCategoryDao.findOrganizationActivityCategories(orgCol, activityCategoryFilter);</span>
<span class="nc" id="L661">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L662">			handleException(e, false);</span>
<span class="nc" id="L663">			throw e;</span>
		} finally {
<span class="pc" id="L665">			activityCategoryDao.cleanUp();</span>
<span class="pc" id="L666">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivityCategories&lt;/B&gt;
	 * &lt;P&gt;
	 * find activityCategories for given organization and activityCategoryFilter Activities of parent organizations will
	 * also be returned
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            Collection: id of organization to search for
	 * @param activityCategoryFilter
	 *            : search criteria
	 * @return Collection of activityCategories found
	 * @param needParent
	 *            , include parent org or not
	 */
	public Collection findOrganizationActivityCategories(Collection&lt;ID&gt; orgIdCol,
			ActivityCategoryFilter activityCategoryFilter, boolean needParent) throws BbmFinderException {
<span class="pc bpc" id="L687" title="1 of 2 branches missed.">		methodStart(&quot;findOrganizationActivityCategories&quot;, orgIdCol, activityCategoryFilter, needParent ? Boolean.TRUE</span>
				: Boolean.FALSE);
<span class="fc" id="L689">		Jdmo jdmo = new Jdmo();</span>
<span class="fc" id="L690">		ActivityCategoryDAO acDao = new ActivityCategoryDAO(jdmo);</span>
		try {
<span class="pc bpc" id="L692" title="1 of 2 branches missed.">			if (needParent) {</span>
<span class="fc" id="L693">				HashSet&lt;ID&gt; parentOrgs = DAOUtil.getParentOrganizationsCollection(orgIdCol, jdmo);</span>
<span class="fc" id="L694">				orgIdCol.addAll(parentOrgs);</span>
			}
<span class="fc" id="L696">			return acDao.findOrganizationActivityCategories(orgIdCol, activityCategoryFilter);</span>
<span class="nc" id="L697">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L698">			handleException(e, false);</span>
<span class="nc" id="L699">			throw e;</span>
		} finally {
<span class="pc" id="L701">			acDao.cleanUp();</span>
<span class="pc" id="L702">			jdmo.cleanUp();</span>
<span class="pc" id="L703">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findMediaForActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * find activityMedias for a given activity
	 * &lt;P&gt;
	 *
	 * @param activityId
	 *            : id of activity
	 * @return Collection of Media Ids found
	 */
	public Collection findMediaForActivity(ID activityId) throws BbmFinderException {
<span class="fc" id="L718">		methodStart(&quot;findMediaForActivity&quot;, activityId);</span>
<span class="fc" id="L719">		ActivityMediaDAO activityMediaDao = new ActivityMediaDAO();</span>
		try {
<span class="fc" id="L721">			return activityMediaDao.findMediaIdsForActivity(activityId);</span>
<span class="nc" id="L722">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L723">			handleException(e, false);</span>
<span class="nc" id="L724">			throw e;</span>
		} finally {
<span class="pc" id="L726">			activityMediaDao.cleanUp();</span>
<span class="pc" id="L727">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findMediaForActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find Media Ids per activity for a given collection of activities
	 * &lt;P&gt;
	 *
	 * @param activityIds
	 *            : collection of activity Ids
	 * @return Map of activity ID (key) and collection of Media Ids (value)
	 */
	public Map&lt;ID, Collection&lt;ID&gt;&gt; findMediaForActivities(Collection&lt;ID&gt; activityIds) throws BbmFinderException {
<span class="fc" id="L742">		methodStart(&quot;findAMediaForActivities&quot;, activityIds);</span>
<span class="fc" id="L743">		ActivityMediaDAO activityMediaDao = new ActivityMediaDAO();</span>
		try {
<span class="fc" id="L745">			return activityMediaDao.findMediaForActivities(activityIds);</span>
<span class="nc" id="L746">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L747">			handleException(e, false);</span>
<span class="nc" id="L748">			throw e;</span>
		} finally {
<span class="pc" id="L750">			activityMediaDao.cleanUp();</span>
<span class="pc" id="L751">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivitiesForMedia&lt;/B&gt;
	 * &lt;P&gt;
	 * find Activity Ids per Media for a given collection of mediaIds
	 * &lt;P&gt;
	 *
	 * @param mediaIds: collection of Media Ids
	 * @return Map of Media ID (key) and collection of Activity Ids (value)
	 */
	public Map findActivitiesForMedia(Collection mediaIds)
	        throws BbmFinderException {
<span class="nc" id="L766">		methodStart(&quot;findActivitiesForMedia&quot;, mediaIds);</span>
<span class="nc" id="L767">		ActivityMediaDAO activityMediaDao = new ActivityMediaDAO();</span>
		try {
<span class="nc" id="L769">			return activityMediaDao.findActivitiesForMedia(mediaIds);</span>
<span class="nc" id="L770">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L771">			handleException(e, false);</span>
<span class="nc" id="L772">			throw e;</span>
		} finally {
<span class="nc" id="L774">			activityMediaDao.cleanUp();</span>
<span class="nc" id="L775">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivitiesWithMedia&lt;/B&gt;
	 * &lt;P&gt;
	 * find all activities that are linked to at least one media.
	 * &lt;P&gt;
	 *
	 * @return A Collection of all activity ID's that are in the ACTIVITYMEDIA table.
	 */
	public Collection findActivitiesWithMedia() throws BbmFinderException {
<span class="nc" id="L788">		methodStart(&quot;findActivitiesWithMedia&quot;);</span>
<span class="nc" id="L789">		ActivityMediaDAO activityMediaDao = new ActivityMediaDAO();</span>
		try {
<span class="nc" id="L791">			return activityMediaDao.findActivitiesWithMedia();</span>
<span class="nc" id="L792">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L793">			handleException(e, false);</span>
<span class="nc" id="L794">			throw e;</span>
		} finally {
<span class="nc" id="L796">			activityMediaDao.cleanUp();</span>
<span class="nc" id="L797">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findQueueForActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * find activityQueues for a given activity
	 * &lt;P&gt;
	 *
	 * @param activityId
	 *            : id of activity
	 * @return Collection of Queue Ids found
	 */
	public Collection findQueueForActivity(ID activityId) throws BbmFinderException {
<span class="nc" id="L812">		methodStart(&quot;findQueueForActivity&quot;, activityId);</span>
<span class="nc" id="L813">		ActivityQueueDAO activityQueueDao = new ActivityQueueDAO();</span>
		try {
<span class="nc" id="L815">			return activityQueueDao.findQueueIdsForActivity(activityId);</span>
<span class="nc" id="L816">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L817">			handleException(e, false);</span>
<span class="nc" id="L818">			throw e;</span>
		} finally {
<span class="nc" id="L820">			activityQueueDao.cleanUp();</span>
<span class="nc" id="L821">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findQueueForActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find Queue Ids per activity for a given collection of activities
	 * &lt;P&gt;
	 *
	 * @param activityIds
	 *            : collection of activity Ids
	 * @return Map of activity ID (key) and collection of Queue Ids (value)
	 */
	public Map findQueueForActivities(Collection activityIds) throws BbmFinderException {
<span class="fc" id="L836">		methodStart(&quot;findAQueueForActivities&quot;, activityIds);</span>
<span class="fc" id="L837">		ActivityQueueDAO activityQueueDao = new ActivityQueueDAO();</span>
		try {
<span class="fc" id="L839">			return activityQueueDao.findQueueForActivities(activityIds);</span>
<span class="nc" id="L840">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L841">			handleException(e, false);</span>
<span class="nc" id="L842">			throw e;</span>
		} finally {
<span class="pc" id="L844">			activityQueueDao.cleanUp();</span>
<span class="pc" id="L845">			methodFinish();</span>
		}
	}


	/**
	 * &lt;B&gt;findActivitiesDirectlyMappedToQueuesInDB&lt;/B&gt;
	 * &lt;P&gt;
	 * Find Activity Ids that are directly linked to the collection of queue IDs.
	 * This includes only activities that are directly mapped to the Queues in the
	 * &quot;Queue Hopping&quot; scenario.
	 * &lt;P&gt;
	 *
	 * @param queueIds: collection of Queue Ids
	 * @return Map of Queue ID (key) and collection of Activity Ids (value)
	 */
	public Map&lt;ID, ArrayList&lt;ID&gt;&gt; findActivitiesDirectlyMappedToQueuesInDB(Collection&lt;ID&gt; queueIds)
	throws BbmFinderException
	{
<span class="fc" id="L864">		methodStart(&quot;findActivityForQueues&quot;, queueIds);</span>
<span class="fc" id="L865">		ActivityQueueDAO activityQueueDao = new ActivityQueueDAO();</span>
		try {
<span class="fc" id="L867">			return activityQueueDao.findActivityForQueues(queueIds);</span>
<span class="nc" id="L868">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L869">			handleException(e, false);</span>
<span class="nc" id="L870">			throw e;</span>
		} finally {
<span class="pc" id="L872">			activityQueueDao.cleanUp();</span>
<span class="pc" id="L873">			methodFinish();</span>
		}
	}


	/**
	 * &lt;B&gt;findPropertiesForActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * find properties for a given activity
	 * &lt;P&gt;
	 *
	 * @param activityId
	 *            : id of activity
	 * @return ActivityProperties found for ID
	 */
	public ActivityProperties findPropertiesForActivity(ID activityId) throws BbmFinderException {
<span class="fc" id="L889">		methodStart(&quot;findPropertiesForActivity&quot;, activityId);</span>
<span class="fc" id="L890">		ActivityPropertiesDAO activityPropertiesDAO = new ActivityPropertiesDAO();</span>
		try {
<span class="fc" id="L892">			return activityPropertiesDAO.findActivityProperties(activityId);</span>
<span class="nc" id="L893">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L894">			handleException(e, false);</span>
<span class="nc" id="L895">			throw e;</span>
		} finally {
<span class="pc" id="L897">			activityPropertiesDAO.cleanUp();</span>
<span class="pc" id="L898">			methodFinish();</span>
		}
	}

	/**
	 * find properties of a given list of Activity IDs
	 * 
	 * @param activityIds
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;ActivityProperties&gt; findPropertiesForActivities(Collection&lt;ID&gt; activityIds)
			throws BbmFinderException {
<span class="fc" id="L911">		methodStart(&quot;findPropertiesForActivities&quot;, activityIds);</span>
<span class="fc" id="L912">		ActivityPropertiesDAO activityPropertiesDAO = new ActivityPropertiesDAO();</span>
		try {
<span class="fc" id="L914">			return activityPropertiesDAO.findActivitiesProperties(activityIds);</span>
<span class="nc" id="L915">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L916">			handleException(e, false);</span>
<span class="nc" id="L917">			throw e;</span>
		} finally {
<span class="pc" id="L919">			activityPropertiesDAO.cleanUp();</span>
<span class="pc" id="L920">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * creates given Activity in db, and sets it's id
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to create
	 * @return Activity id
	 */
	public ID createActivity(Activity activity) throws BbmCreateException, BbmCreateDuplicateKeyException,
			ActivityValidationException {
<span class="fc" id="L936">		methodStart(&quot;createActivity&quot;, activity);</span>
<span class="fc" id="L937">		ActivityDAO activityDao = null;</span>
		try {
<span class="fc" id="L939">			activity.validate();</span>
<span class="fc" id="L940">			activityDao = new ActivityDAO();</span>
<span class="fc" id="L941">			ID actID = activityDao.createObject(activity);</span>
<span class="fc" id="L942">			activity.setID(actID);</span>
<span class="pc bpc" id="L943" title="1 of 2 branches missed.">			if (cacheUsed()) {</span>
<span class="fc" id="L944">				m_ActivityCache.put(actID, activity);</span>
			}
<span class="fc" id="L946">			return actID;</span>
<span class="nc" id="L947">		} catch (ActivityValidationException e) {</span>
<span class="nc" id="L948">			handleException(e, true);</span>
<span class="nc" id="L949">			throw e;</span>
<span class="nc" id="L950">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L951">			handleException(e, true);</span>
<span class="nc" id="L952">			throw e;</span>
		} finally {
<span class="pc bpc" id="L954" title="3 of 4 branches missed.">			if (activityDao != null) {</span>
<span class="pc" id="L955">				activityDao.cleanUp();</span>
			}
<span class="pc" id="L957">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * creates Activity with media
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to create
	 * @param mediasIds
	 *            : collection of media Ids of type ID to associate to the activity
	 * @return Activity id
	 */
	public ID createActivity(Activity activity, Collection&lt;ID&gt; mediasIds) throws BbmCreateException,
			BbmCreateDuplicateKeyException, ActivityValidationException {
<span class="nc" id="L975">		methodStart(&quot;createActivity&quot;, activity, mediasIds);</span>

<span class="nc" id="L977">		ID activityId = null;</span>
<span class="nc" id="L978">		ActivityMediaDAO activityMediaDao = null;</span>

		try {
<span class="nc" id="L981">			activityId = createActivity(activity);</span>

			try {
<span class="nc bnc" id="L984" title="All 4 branches missed.">				if (mediasIds != null &amp;&amp; !mediasIds.isEmpty()) {</span>
<span class="nc" id="L985">					activity.validateWithAssociatedMedia();</span>
<span class="nc" id="L986">					activityMediaDao = new ActivityMediaDAO();</span>
<span class="nc" id="L987">					ID mediaId = null;</span>
<span class="nc" id="L988">					ActivityMedia activityMedia = new ActivityMedia();</span>
<span class="nc" id="L989">					activityMedia.setActivityId(activityId);</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">					for (Iterator&lt;ID&gt; it = mediasIds.iterator(); it.hasNext();) {</span>
<span class="nc" id="L991">						mediaId = it.next();</span>
<span class="nc" id="L992">						activityMedia.setMediaId(mediaId);</span>
<span class="nc" id="L993">						activityMediaDao.createObject(activityMedia, false);</span>
					}
<span class="nc" id="L995">					activityMediaDao.executeBatch();</span>
				}
<span class="nc" id="L997">				return activityId;</span>
<span class="nc" id="L998">			} catch (ActivityValidationException e) {</span>
<span class="nc" id="L999">				handleException(e, true);</span>
<span class="nc" id="L1000">				throw e;</span>
<span class="nc" id="L1001">			} catch (JdmoException e) {</span>
<span class="nc" id="L1002">				handleException(e, true);</span>
<span class="nc" id="L1003">				throw new BbmCreateException(e);</span>
<span class="nc" id="L1004">			} catch (BbmCreateException e) {</span>
<span class="nc" id="L1005">				handleException(e, true);</span>
<span class="nc" id="L1006">				throw e;</span>
			}
		} finally {
<span class="nc bnc" id="L1009" title="All 4 branches missed.">			if (activityMediaDao != null) {</span>
<span class="nc" id="L1010">				activityMediaDao.cleanUp();</span>
			}
<span class="nc" id="L1012">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * creates Activity with media
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to create
	 * @param mediasIds
	 *            : collection of media Ids of type ID to associate to the activity
	 * @return Activity id
	 */
	public ID createActivity(Activity activity, Collection&lt;ID&gt; mediasIds, ActivityProperties activityProperties) throws BbmCreateException,
			BbmCreateDuplicateKeyException, ActivityValidationException {
<span class="fc" id="L1030">		methodStart(&quot;createActivity&quot;, activity, mediasIds);</span>

<span class="fc" id="L1032">		ID activityId = null;</span>
<span class="fc" id="L1033">		ActivityMediaDAO activityMediaDao = null;</span>
<span class="fc" id="L1034">		ActivityPropertiesDAO activityPropertiesDAO = null;</span>

		try {
<span class="fc" id="L1037">			activityId = createActivity(activity);</span>

			try {
<span class="pc bpc" id="L1040" title="1 of 4 branches missed.">				if (mediasIds != null &amp;&amp; !mediasIds.isEmpty()) {</span>
<span class="fc" id="L1041">					activity.validateWithAssociatedMedia();</span>
<span class="fc" id="L1042">					activityMediaDao = new ActivityMediaDAO();</span>
<span class="fc" id="L1043">					ID mediaId = null;</span>
<span class="fc" id="L1044">					ActivityMedia activityMedia = new ActivityMedia();</span>
<span class="fc" id="L1045">					activityMedia.setActivityId(activityId);</span>
<span class="fc bfc" id="L1046" title="All 2 branches covered.">					for (Iterator&lt;ID&gt; it = mediasIds.iterator(); it.hasNext();) {</span>
<span class="fc" id="L1047">						mediaId = it.next();</span>
<span class="fc" id="L1048">						activityMedia.setMediaId(mediaId);</span>
<span class="fc" id="L1049">						activityMediaDao.createObject(activityMedia, false);</span>
					}
<span class="fc" id="L1051">					activityMediaDao.executeBatch();</span>
				}

<span class="fc" id="L1054">				activityProperties.setActivityId(activityId);</span>
<span class="fc" id="L1055">				activityPropertiesDAO = new ActivityPropertiesDAO();</span>
<span class="fc" id="L1056">				activityPropertiesDAO.insertActivityProperties(activityProperties);</span>
<span class="fc" id="L1057">				return activityId;</span>
<span class="nc" id="L1058">			} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1059">				handleException(e, true);</span>
<span class="nc" id="L1060">				throw e;</span>
<span class="nc" id="L1061">			} catch (JdmoException e) {</span>
<span class="nc" id="L1062">				handleException(e, true);</span>
<span class="nc" id="L1063">				throw new BbmCreateException(e);</span>
<span class="nc" id="L1064">			} catch (BbmCreateException e) {</span>
<span class="nc" id="L1065">				handleException(e, true);</span>
<span class="nc" id="L1066">				throw e;</span>
			}
		} finally {
<span class="pc bpc" id="L1069" title="2 of 4 branches missed.">			if (activityMediaDao != null) {</span>
<span class="pc" id="L1070">				activityMediaDao.cleanUp();</span>
            }
<span class="pc bpc" id="L1072" title="3 of 4 branches missed.">            if (activityPropertiesDAO != null) {</span>
<span class="pc" id="L1073">                activityPropertiesDAO.cleanUp();</span>
            }
<span class="pc" id="L1075">			methodFinish();</span>
		}
	}

	public ID createActivity(Activity activity, Collection&lt;ID&gt; mediaIds, SystemType externalSystemType)
	  throws BbmCreateException, BbmCreateDuplicateKeyException, ActivityValidationException {
<span class="nc" id="L1081">		methodStart(&quot;createActivity&quot;, activity, externalSystemType);</span>

		// validate
<span class="nc bnc" id="L1084" title="All 2 branches missed.">		if (externalSystemType == null) {</span>
<span class="nc" id="L1085">			throw new BbmCreateException(&quot;externalSystemType is null&quot;);</span>
		}
<span class="nc bnc" id="L1087" title="All 2 branches missed.">		if (activity.getExternalID() == null) {</span>
<span class="nc" id="L1088">			throw new BbmCreateException(&quot;external ID is null&quot;);</span>
		}

		// create
		try {
<span class="nc" id="L1093">			ID activityID = createActivity(activity, mediaIds);</span>
<span class="nc" id="L1094">			boolean insert = true;</span>
<span class="nc" id="L1095">			MapUtil.setWfoToExternalID(externalSystemType, ObjectType.Activity, activity.getID(),</span>
<span class="nc" id="L1096">					activity.getExternalID(), new Jdmo(true), insert);</span>
<span class="nc" id="L1097">			return activityID;</span>
<span class="nc" id="L1098">		} catch (JdmoException e) {</span>
<span class="nc" id="L1099">			handleException(e); // log and rollback transaction</span>
<span class="nc" id="L1100">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L1102">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivityCategory&lt;/B&gt;
	 * &lt;P&gt;
	 * creates given ActivityCategory in db, and sets it's id
	 * &lt;P&gt;
	 *
	 * @param activityCategory
	 *            activityCategory to create
	 * @return ActivityCategory id
	 */
	public ID createActivityCategory(ActivityCategory activityCategory) throws BbmCreateException,
			BbmCreateDuplicateKeyException {
<span class="nc" id="L1118">		methodStart(&quot;createActivityCategory&quot;, activityCategory);</span>
<span class="nc" id="L1119">		ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
		try {
<span class="nc" id="L1121">			return activityCategoryDao.createObject(activityCategory);</span>
<span class="nc" id="L1122">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1123">			handleException(e, true);</span>
<span class="nc" id="L1124">			throw e;</span>
		} finally {
<span class="nc" id="L1126">			activityCategoryDao.cleanUp();</span>
<span class="nc" id="L1127">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivityMedia&lt;/B&gt;
	 * &lt;P&gt;
	 * creates given ActivityMedia in db, and sets it's id
	 * &lt;P&gt;
	 *
	 * @param activityMedia
	 *            : activityMedia to create
	 * @return ActivityMedia id
	 */
	public ID createActivityMedia(ActivityMedia activityMedia) throws BbmCreateException,
			BbmCreateDuplicateKeyException, ActivityValidationException {
<span class="nc" id="L1143">		methodStart(&quot;createActivityMedia&quot;, activityMedia);</span>

<span class="nc" id="L1145">		ActivityMediaDAO activityMediaDao = null;</span>
		try {
<span class="nc" id="L1147">			Activity activity = findActivityById(activityMedia.getActivityId());</span>
<span class="nc" id="L1148">			activity.validateWithAssociatedMedia();</span>
<span class="nc" id="L1149">			activityMediaDao = new ActivityMediaDAO();</span>
<span class="nc" id="L1150">			return activityMediaDao.createObject(activityMedia);</span>
<span class="nc" id="L1151">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1152">			handleException(e, true);</span>
<span class="nc" id="L1153">			throw new BbmCreateException(e);</span>
<span class="nc" id="L1154">		} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1155">			handleException(e, true);</span>
<span class="nc" id="L1156">			throw e;</span>
<span class="nc" id="L1157">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1158">			handleException(e, true);</span>
<span class="nc" id="L1159">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1161" title="All 4 branches missed.">			if (activityMediaDao != null) {</span>
<span class="nc" id="L1162">				activityMediaDao.cleanUp();</span>
			}
<span class="nc" id="L1164">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivityMedia&lt;/B&gt;
	 * &lt;P&gt;
	 * creates association of multiple media to an activity
	 * &lt;P&gt;
	 *
	 * @param activityId
	 *            : activity Id
	 * @param activityMedias
	 *            : collection of media ids to associate with the activity
	 * @return collection of newly created ActivityMedia ids
	 */
	public Collection&lt;ID&gt; createActivityMedia(ID activityId, Collection mediaIds) throws BbmCreateException,
			BbmCreateDuplicateKeyException, ActivityValidationException {
<span class="fc" id="L1182">		methodStart(&quot;createActivityMedia&quot;, activityId, mediaIds);</span>

<span class="fc" id="L1184">		ActivityMediaDAO activityMediaDao = null;</span>
		try {
<span class="pc bpc" id="L1186" title="4 of 6 branches missed.">			if (mediaIds == null || mediaIds.isEmpty() || activityId == null) {</span>
<span class="fc" id="L1187">				return Collections.EMPTY_LIST;</span>
			}
<span class="nc" id="L1189">			Activity activity = findActivityById(activityId);</span>
<span class="nc" id="L1190">			activity.validateWithAssociatedMedia();</span>

<span class="nc" id="L1192">			activityMediaDao = new ActivityMediaDAO();</span>
<span class="nc" id="L1193">			ActivityMedia activityMedia = new ActivityMedia();</span>
<span class="nc" id="L1194">			activityMedia.setActivityId(activityId);</span>
<span class="nc" id="L1195">			ArrayList&lt;ID&gt; createdIds = new ArrayList&lt;ID&gt;(mediaIds.size());</span>
<span class="nc" id="L1196">			ID mediaId = null;</span>
<span class="nc" id="L1197">			ID id = null;</span>
<span class="nc bnc" id="L1198" title="All 2 branches missed.">			for (Iterator it = mediaIds.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1199">				mediaId = (ID) it.next();</span>
<span class="nc" id="L1200">				activityMedia.setMediaId(mediaId);</span>
<span class="nc" id="L1201">				id = activityMediaDao.createObject(activityMedia, false);</span>
<span class="nc" id="L1202">				createdIds.add(id);</span>
			}
<span class="nc" id="L1204">			activityMediaDao.executeBatch();</span>
<span class="nc" id="L1205">			return createdIds;</span>
<span class="nc" id="L1206">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1207">			handleException(e, true);</span>
<span class="nc" id="L1208">			throw new BbmCreateException(e);</span>
<span class="nc" id="L1209">		} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1210">			handleException(e, true);</span>
<span class="nc" id="L1211">			throw e;</span>
<span class="nc" id="L1212">		} catch (JdmoException e) {</span>
<span class="nc" id="L1213">			handleException(e, true);</span>
<span class="nc" id="L1214">			throw new BbmCreateException(e);</span>
<span class="nc" id="L1215">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1216">			handleException(e, true);</span>
<span class="nc" id="L1217">			throw e;</span>
		} finally {
<span class="pc bpc" id="L1219" title="5 of 6 branches missed.">			if (activityMediaDao != null) {</span>
<span class="nc" id="L1220">				activityMediaDao.cleanUp();</span>
			}
<span class="pc" id="L1222">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivityMedia&lt;/B&gt;
	 * &lt;P&gt;
	 * creates given ActivityQueue in db, and sets it's id
	 * &lt;P&gt;
	 *
	 * @param activityQueue
	 *            : activityQueue to create
	 * @return ActivityQueue id
	 */
	public ID createActivityQueue(ActivityQueue activityQueue) throws BbmCreateException,
			BbmCreateDuplicateKeyException, ActivityValidationException {
<span class="nc" id="L1238">		methodStart(&quot;createActivityQueue&quot;, activityQueue);</span>

<span class="nc" id="L1240">		ActivityQueueDAO activityQueueDao = null;</span>
		try {
<span class="nc" id="L1242">			Activity activity = findActivityById(activityQueue.getActivityId());</span>
<span class="nc" id="L1243">			activity.validateWithAssociatedQueue();</span>
<span class="nc" id="L1244">			activityQueueDao = new ActivityQueueDAO();</span>
<span class="nc" id="L1245">			return activityQueueDao.createObject(activityQueue);</span>
<span class="nc" id="L1246">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1247">			handleException(e, true);</span>
<span class="nc" id="L1248">			throw new BbmCreateException(e);</span>
<span class="nc" id="L1249">		} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1250">			handleException(e, true);</span>
<span class="nc" id="L1251">			throw e;</span>
<span class="nc" id="L1252">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1253">			handleException(e, true);</span>
<span class="nc" id="L1254">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1256" title="All 4 branches missed.">			if (activityQueueDao != null) {</span>
<span class="nc" id="L1257">				activityQueueDao.cleanUp();</span>
			}
<span class="nc" id="L1259">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivityQueue&lt;/B&gt;
	 * &lt;P&gt;
	 * creates association of multiple queue to an activity
	 * &lt;P&gt;
	 *
	 * @param activityId
	 *            : activity Id
	 * @param activityQueues
	 *            : collection of queue ids to associate with the activity
	 * @return collection of newly created ActivityQueue ids
	 */
	public Collection&lt;ID&gt; createActivityQueue(ID activityId, Collection queueIds) throws BbmCreateException,
			BbmCreateDuplicateKeyException, ActivityValidationException {
<span class="fc" id="L1277">		methodStart(&quot;createActivityQueue&quot;, activityId, queueIds);</span>

<span class="fc" id="L1279">		ActivityQueueDAO activityQueueDao = null;</span>
		try {
<span class="pc bpc" id="L1281" title="2 of 6 branches missed.">			if (queueIds == null || queueIds.isEmpty() || activityId == null) {</span>
<span class="fc" id="L1282">				return Collections.EMPTY_LIST;</span>
			}
<span class="fc" id="L1284">			Activity activity = findActivityById(activityId);</span>
<span class="fc" id="L1285">			activity.validateWithAssociatedQueue();</span>

<span class="fc" id="L1287">			activityQueueDao = new ActivityQueueDAO();</span>
<span class="fc" id="L1288">			ActivityQueue activityQueue = new ActivityQueue();</span>
<span class="fc" id="L1289">			activityQueue.setActivityId(activityId);</span>
<span class="fc" id="L1290">			ArrayList&lt;ID&gt; createdIds = new ArrayList&lt;ID&gt;(queueIds.size());</span>
<span class="fc" id="L1291">			ID queueId = null;</span>
<span class="fc" id="L1292">			ID id = null;</span>
<span class="fc bfc" id="L1293" title="All 2 branches covered.">			for (Iterator it = queueIds.iterator(); it.hasNext();) {</span>
<span class="fc" id="L1294">				queueId = (ID) it.next();</span>
<span class="fc" id="L1295">				activityQueue.setQueueId(queueId);</span>
<span class="fc" id="L1296">				id = activityQueueDao.createObject(activityQueue, false);</span>
<span class="fc" id="L1297">				createdIds.add(id);</span>
			}
<span class="fc" id="L1299">			activityQueueDao.executeBatch();</span>
<span class="fc" id="L1300">			return createdIds;</span>
<span class="nc" id="L1301">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1302">			handleException(e, true);</span>
<span class="nc" id="L1303">			throw new BbmCreateException(e);</span>
<span class="nc" id="L1304">		} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1305">			handleException(e, true);</span>
<span class="nc" id="L1306">			throw e;</span>
<span class="nc" id="L1307">		} catch (JdmoException e) {</span>
<span class="nc" id="L1308">			handleException(e, true);</span>
<span class="nc" id="L1309">			throw new BbmCreateException(e);</span>
<span class="nc" id="L1310">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1311">			handleException(e, true);</span>
<span class="nc" id="L1312">			throw e;</span>
		} finally {
<span class="pc bpc" id="L1314" title="4 of 6 branches missed.">			if (activityQueueDao != null) {</span>
<span class="pc" id="L1315">				activityQueueDao.cleanUp();</span>
			}
<span class="pc" id="L1317">			methodFinish();</span>
		}
	}

	// function is used by RTAAServiceEJB to reset activity last updated date
	// this will force report dump to do full dump
	public void updateActivityLastUpdatedDate(Activity activity) throws BbmUpdateException, MultiUserException,
			ActivityValidationException {
<span class="nc" id="L1325">		methodStart(&quot;updateActivityLastUpdatedDate&quot;, activity);</span>
<span class="nc" id="L1326">		ActivityDAO activityDao = null;</span>
		try {
<span class="nc" id="L1328">			activity.validate();</span>
<span class="nc" id="L1329">			activityDao = new ActivityDAO();</span>
<span class="nc" id="L1330">			activity.setLastModifierName(m_sessionContext.getCallerPrincipal().getName());</span>
<span class="nc" id="L1331">			activity.setLastModifiedDate(new Date());</span>

<span class="nc" id="L1333">			activityDao.updateObject(activity);</span>
<span class="nc bnc" id="L1334" title="All 2 branches missed.">			if (cacheUsed()) {</span>
<span class="nc" id="L1335">				m_ActivityCache.put(activity.getId(), activity);</span>
			}
<span class="nc" id="L1337">		} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1338">			handleException(e, true);</span>
<span class="nc" id="L1339">			throw e;</span>
<span class="nc" id="L1340">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1341">			handleException(e, true);</span>
<span class="nc" id="L1342">			throw e;</span>
<span class="nc" id="L1343">		} catch (MultiUserException e) {</span>
<span class="nc" id="L1344">			handleException(e, true);</span>
<span class="nc" id="L1345">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1347" title="All 4 branches missed.">			if (activityDao != null) {</span>
<span class="nc" id="L1348">				activityDao.cleanUp();</span>
			}
<span class="nc" id="L1350">			methodFinish();</span>
<span class="nc" id="L1351">		}</span>
<span class="nc" id="L1352">	}</span>

	/**
	 * &lt;B&gt;updateActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * update given activity to db
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to update
	 */
	public void updateActivity(Activity activity) throws BbmUpdateException, MultiUserException,
			ActivityValidationException {
<span class="fc" id="L1365">		methodStart(&quot;updateActivity&quot;, activity);</span>
<span class="fc" id="L1366">		ActivityDAO activityDao = null;</span>
		try {
<span class="fc" id="L1368">			activity.validate();</span>
<span class="fc" id="L1369">			activityDao = new ActivityDAO();</span>

			// only update Last Modified Date when the adherence tolerance was changed.
<span class="fc" id="L1372">			Activity oldActivity = findActivityById(activity.getId());</span>

			// fix QC39049 10SP4+v11: throw exception if an activity is changed from &quot;use in shift&quot; to not and the
			// activity is used in any shift or shift event
<span class="pc bpc" id="L1376" title="1 of 4 branches missed.">			if (oldActivity.isUsedInShift() &amp;&amp; !activity.isUsedInShift()) {</span>
				// see if the activity is used in shift currently, if yes, throw exception
<span class="nc" id="L1378">				StringBuffer sb = new StringBuffer(200);</span>
<span class="nc" id="L1379">				sb.append(&quot;select count(*) from shiftassignment where activityid = &quot;).append(activity.getId());</span>
<span class="nc" id="L1380">				JdmoRowset rs = activityDao.getDMO().createRowset(sb.toString());</span>
<span class="nc" id="L1381">				rs.next();</span>
<span class="nc" id="L1382">				int count = rs.getInt(1);</span>
<span class="nc bnc" id="L1383" title="All 2 branches missed.">				if (count &gt; 0) {</span>
					// throw exception
<span class="nc" id="L1385">					throw new ActivityValidationException(</span>
							ActivityValidationException.ACTIVITY_INVALID_UNCHECK_USEDINSHIFT);
				}
			}

<span class="pc bpc" id="L1390" title="1 of 4 branches missed.">			if (oldActivity.isUsedInShiftEvent() &amp;&amp; !activity.isUsedInShiftEvent()) {</span>
				// see if the activity is used in shift currently, if yes, throw exception
<span class="nc" id="L1392">				StringBuffer sb = new StringBuffer(200);</span>
<span class="nc" id="L1393">				sb.append(&quot;select count(*) from shifteventassignment where activityid = &quot;).append(activity.getId());</span>
<span class="nc" id="L1394">				JdmoRowset rs = activityDao.getDMO().createRowset(sb.toString());</span>
<span class="nc" id="L1395">				rs.next();</span>
<span class="nc" id="L1396">				int count = rs.getInt(1);</span>
<span class="nc bnc" id="L1397" title="All 2 branches missed.">				if (count &gt; 0) {</span>
					// throw exception
<span class="nc" id="L1399">					throw new ActivityValidationException(</span>
							ActivityValidationException.ACTIVITY_INVALID_UNCHECK_USEDINSHIFT);
				}
			}
<span class="pc bpc" id="L1403" title="1 of 2 branches missed.">			if (activity.getAdherenceTolerance() != oldActivity.getAdherenceTolerance()) {</span>
<span class="nc" id="L1404">				activity.setLastModifierName(m_sessionContext.getCallerPrincipal().getName());</span>
<span class="nc" id="L1405">				activity.setLastModifiedDate(new Date());</span>
			} else {
<span class="fc" id="L1407">				activity.setLastModifierName(oldActivity.getLastModifierName());</span>
<span class="fc" id="L1408">				activity.setLastModifiedDate(oldActivity.getLastModifiedDate());</span>
			}

<span class="fc" id="L1411">			activityDao.updateObject(activity);</span>
<span class="pc bpc" id="L1412" title="1 of 2 branches missed.">			if (cacheUsed()) {</span>
<span class="fc" id="L1413">				m_ActivityCache.put(activity.getID(), activity);</span>
			}
<span class="nc" id="L1415">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1416">			handleException(e, true);</span>
<span class="nc" id="L1417">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L1418">		} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1419">			handleException(e, true);</span>
<span class="nc" id="L1420">			throw e;</span>
<span class="nc" id="L1421">		} catch (JdmoException e) {</span>
<span class="nc" id="L1422">			handleException(e, true);</span>
<span class="nc" id="L1423">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L1424">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1425">			handleException(e, true);</span>
<span class="nc" id="L1426">			throw e;</span>
<span class="nc" id="L1427">		} catch (MultiUserException e) {</span>
<span class="nc" id="L1428">			handleException(e, true);</span>
<span class="nc" id="L1429">			throw e;</span>
		} finally {
<span class="pc bpc" id="L1431" title="3 of 4 branches missed.">			if (activityDao != null) {</span>
<span class="pc" id="L1432">				activityDao.cleanUp();</span>
			}
<span class="pc" id="L1434">			methodFinish();</span>
<span class="fc" id="L1435">		}</span>
<span class="fc" id="L1436">	}</span>

	/**
	 * &lt;B&gt;updateActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * update activity including media types (unlink current media types)
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to update
	 * @param mediaIds
	 *            : new medias to link to activity
	 */
	/**
	 * @deprecated in 7.7
	 */
	@Deprecated
	public void updateActivity(Activity activity, Collection mediaIds) throws BbmUpdateException, MultiUserException,
			ActivityValidationException {
<span class="nc" id="L1455">		methodStart(&quot;updateActivity&quot;, activity, mediaIds);</span>

<span class="nc" id="L1457">		ActivityMediaDAO activityMediaDao = null;</span>
		try {
<span class="nc" id="L1459">			updateActivity(activity);</span>

			try {
<span class="nc" id="L1462">				activityMediaDao = new ActivityMediaDAO();</span>
				// unlink old media types
<span class="nc" id="L1464">				activityMediaDao.unlinkAllActivityMedias(activity.getID());</span>
				// link new media types
<span class="nc" id="L1466">				createActivityMedia(activity.getID(), mediaIds);</span>
<span class="nc" id="L1467">			} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1468">				handleException(e, true);</span>
<span class="nc" id="L1469">				throw e;</span>
<span class="nc" id="L1470">			} catch (BbmCreateException e) {</span>
<span class="nc" id="L1471">				handleException(e, true);</span>
<span class="nc" id="L1472">				throw new BbmUpdateException(e);</span>
<span class="nc" id="L1473">			} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1474">				handleException(e, true);</span>
<span class="nc" id="L1475">				throw new BbmUpdateException(e);</span>
<span class="nc" id="L1476">			}</span>
		} finally {
<span class="nc bnc" id="L1478" title="All 4 branches missed.">			if (activityMediaDao != null) {</span>
<span class="nc" id="L1479">				activityMediaDao.cleanUp();</span>
			}
<span class="nc" id="L1481">			methodFinish();</span>
<span class="nc" id="L1482">		}</span>
<span class="nc" id="L1483">	}</span>

	public void updateActivity(Activity activity, Collection mediaIds, Collection queueIds) throws BbmUpdateException,
			MultiUserException, ActivityValidationException {
<span class="nc" id="L1487">		methodStart(&quot;updateActivity&quot;, activity, mediaIds, queueIds);</span>

<span class="nc" id="L1489">		ActivityMediaDAO activityMediaDao = null;</span>
<span class="nc" id="L1490">		ActivityQueueDAO activityQueueDao = null;</span>
		try {
<span class="nc" id="L1492">			updateActivity(activity);</span>

			try {
<span class="nc" id="L1495">				activityMediaDao = new ActivityMediaDAO();</span>
				// unlink old media types
<span class="nc" id="L1497">				activityMediaDao.unlinkAllActivityMedias(activity.getID());</span>
				// link new media types
<span class="nc" id="L1499">				createActivityMedia(activity.getID(), mediaIds);</span>

<span class="nc" id="L1501">				activityQueueDao = new ActivityQueueDAO();</span>
				// unlink old queues
<span class="nc" id="L1503">				activityQueueDao.unlinkAllActivityQueues(activity.getID());</span>
				// link new queues
<span class="nc" id="L1505">				createActivityQueue(activity.getID(), queueIds);</span>

<span class="nc" id="L1507">			} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1508">				handleException(e, true);</span>
<span class="nc" id="L1509">				throw e;</span>
<span class="nc" id="L1510">			} catch (BbmCreateException e) {</span>
<span class="nc" id="L1511">				handleException(e, true);</span>
<span class="nc" id="L1512">				throw new BbmUpdateException(e);</span>
<span class="nc" id="L1513">			} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1514">				handleException(e, true);</span>
<span class="nc" id="L1515">				throw new BbmUpdateException(e);</span>
<span class="nc" id="L1516">			}</span>
		} finally {
<span class="nc bnc" id="L1518" title="All 4 branches missed.">			if (activityMediaDao != null) {</span>
<span class="nc" id="L1519">				activityMediaDao.cleanUp();</span>
			}
<span class="nc bnc" id="L1521" title="All 4 branches missed.">			if (activityQueueDao != null) {</span>
<span class="nc" id="L1522">				activityQueueDao.cleanUp();</span>
			}
<span class="nc" id="L1524">			methodFinish();</span>
<span class="nc" id="L1525">		}</span>
<span class="nc" id="L1526">	}</span>

	/**
	 * &lt;B&gt;updateActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * update activity including media types (unlink current media types), queues and activity properties
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to update
	 * @param mediaIds
	 *            : new medias to link to activity
	 * @param queueIds
	 *            : new queues to link to activity
	 * @param activityProperties
	 *            : properties to link to activity
	 */
	public void updateActivity(Activity activity, Collection mediaIds, Collection queueIds, ActivityProperties activityProperties) throws BbmUpdateException,
		MultiUserException, ActivityValidationException {
<span class="fc" id="L1545">		methodStart(&quot;updateActivity&quot;, activity, mediaIds, queueIds, activityProperties);</span>

<span class="fc" id="L1547">		ActivityMediaDAO activityMediaDao = null;</span>
<span class="fc" id="L1548">		ActivityQueueDAO activityQueueDao = null;</span>
<span class="fc" id="L1549">		ActivityPropertiesDAO activityPropertiesDAO = null;</span>
		try {
<span class="fc" id="L1551">			updateActivity(activity);</span>

			try {
<span class="fc" id="L1554">				activityMediaDao = new ActivityMediaDAO();</span>
				// unlink old media types
<span class="fc" id="L1556">				activityMediaDao.unlinkAllActivityMedias(activity.getID());</span>
				// link new media types
<span class="fc" id="L1558">				createActivityMedia(activity.getID(), mediaIds);</span>

<span class="fc" id="L1560">				activityQueueDao = new ActivityQueueDAO();</span>
				// unlink old queues
<span class="fc" id="L1562">				activityQueueDao.unlinkAllActivityQueues(activity.getID());</span>
				// link new queues
<span class="fc" id="L1564">				createActivityQueue(activity.getID(), queueIds);</span>

				//Update Activity Properties
<span class="fc" id="L1567">				updateActivityProperties(activityProperties);</span>

<span class="nc" id="L1569">			} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1570">				handleException(e, true);</span>
<span class="nc" id="L1571">				throw e;</span>
<span class="nc" id="L1572">			} catch (BbmCreateException e) {</span>
<span class="nc" id="L1573">				handleException(e, true);</span>
<span class="nc" id="L1574">				throw new BbmUpdateException(e);</span>
<span class="nc" id="L1575">			} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1576">				handleException(e, true);</span>
<span class="nc" id="L1577">				throw new BbmUpdateException(e);</span>
<span class="fc" id="L1578">			}</span>
		} finally {
<span class="pc bpc" id="L1580" title="3 of 4 branches missed.">			if (activityMediaDao != null) {</span>
<span class="pc" id="L1581">				activityMediaDao.cleanUp();</span>
			}
<span class="pc bpc" id="L1583" title="3 of 4 branches missed.">			if (activityQueueDao != null) {</span>
<span class="pc" id="L1584">				activityQueueDao.cleanUp();</span>
			}
<span class="pc bpc" id="L1586" title="3 of 4 branches missed.">			if (activityPropertiesDAO != null) {</span>
<span class="nc" id="L1587">				activityPropertiesDAO.cleanUp();</span>
			}
<span class="pc" id="L1589">			methodFinish();</span>
<span class="fc" id="L1590">		}</span>
<span class="fc" id="L1591">	}</span>

	/**
	 * &lt;B&gt;updateActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * update activity including activity properties
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to update
	 * @param activityProperties
	 *            : properties to link to activity
	 */
	public void updateActivity(Activity activity, ActivityProperties activityProperties) throws BbmUpdateException, BbmCreateException,
		MultiUserException, ActivityValidationException {
<span class="nc" id="L1606">		methodStart(&quot;updateActivity&quot;, activity, activityProperties);</span>

		try {
<span class="nc" id="L1609">			updateActivity(activity);</span>

			try {
				//Update Activity Properties
<span class="nc" id="L1613">				updateActivityProperties(activityProperties);</span>
<span class="nc" id="L1614">			} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1615">				handleException(e, true);</span>
<span class="nc" id="L1616">				throw e;</span>
<span class="nc" id="L1617">			} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1618">				handleException(e, true);</span>
<span class="nc" id="L1619">				throw e;</span>
<span class="nc" id="L1620">			} catch (BbmCreateException e) {</span>
<span class="nc" id="L1621">				handleException(e, true);</span>
<span class="nc" id="L1622">				throw e;</span>
<span class="nc" id="L1623">			}</span>
		} finally {
<span class="nc" id="L1625">			methodFinish();</span>
<span class="nc" id="L1626">		}</span>
<span class="nc" id="L1627">	}</span>

	/**
	 * &lt;B&gt;updateActivityProperties&lt;/B&gt;
	 * &lt;P&gt;
	 * update activity properties
	 * &lt;P&gt;
	 *
	 * @param activityProperties
	 *            : properties to link to activity
	 */
	public void updateActivityProperties(ActivityProperties activityProperties) throws BbmUpdateException, BbmCreateException,
		MultiUserException, ActivityValidationException {
<span class="fc" id="L1640">		methodStart(&quot;updateActivityProperties&quot;, activityProperties);</span>

<span class="fc" id="L1642">		ActivityPropertiesDAO activityPropertiesDAO = null;</span>
<span class="fc" id="L1643">		ActivityProperties testActivityProperties = null;</span>
		try {
<span class="fc" id="L1645">			Activity activity = findActivityById(activityProperties.getActivityId());</span>
<span class="fc" id="L1646">			activity.validate();</span>
<span class="fc" id="L1647">			activityPropertiesDAO = new ActivityPropertiesDAO();</span>

<span class="fc" id="L1649">			testActivityProperties = activityPropertiesDAO.findActivityProperties(activityProperties.getActivityId());</span>
<span class="pc bpc" id="L1650" title="1 of 2 branches missed.">			if (testActivityProperties.getActivityId().equals(activityPropertiesDAO.getDontExistID())) {</span>
<span class="fc" id="L1651">				activityPropertiesDAO.insertActivityProperties(activityProperties);</span>
			} else {
<span class="nc" id="L1653">				activityPropertiesDAO.updateObject(activityProperties);</span>
			}
<span class="nc" id="L1655">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1656">			handleException(e, true);</span>
<span class="nc" id="L1657">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L1658">		} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1659">			handleException(e, true);</span>
<span class="nc" id="L1660">			throw e;</span>
<span class="nc" id="L1661">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1662">			handleException(e, true);</span>
<span class="nc" id="L1663">			throw e;</span>
<span class="nc" id="L1664">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1665">			handleException(e, true);</span>
<span class="nc" id="L1666">			throw e;</span>
		}finally {
<span class="pc bpc" id="L1668" title="3 of 4 branches missed.">			if (activityPropertiesDAO != null) {</span>
<span class="pc" id="L1669">				activityPropertiesDAO.cleanUp();</span>
			}
<span class="pc" id="L1671">			methodFinish();</span>
<span class="fc" id="L1672">		}</span>
<span class="fc" id="L1673">	}</span>
		/**
	 * &lt;B&gt;matchActivityWithExternalID&lt;/B&gt;
	 * &lt;P&gt;
	 * update activitymap to match existing activity id with external id
	 * &lt;P&gt;
	 *
	 * @param objValue
	 *            : activity to update
	 * @param externalSystemType
	 *            : system from which activity is pushed
	 * @param activityExternalId
	 *            : External ID of the activity that is pushed
	 *
	 */
	public void matchActivityWithExternalID(Activity objValue, SystemType externalSystemType, ID activityExternalId)
	  throws BbmUpdateException, MultiUserException  {

<span class="nc" id="L1691">		methodStart(&quot;matchActivityWithExternalID&quot;, objValue, externalSystemType, activityExternalId);</span>

		// validate
<span class="nc bnc" id="L1694" title="All 2 branches missed.">		if (externalSystemType == null) {</span>
<span class="nc" id="L1695">			throw new BbmUpdateException(&quot;externalSystemType is null&quot;);</span>
		}
<span class="nc bnc" id="L1697" title="All 2 branches missed.">		if (activityExternalId == null) {</span>
<span class="nc" id="L1698">			throw new BbmUpdateException(&quot;externalSourceId is null&quot;);</span>
		}
<span class="nc bnc" id="L1700" title="All 4 branches missed.">		if ((activityExternalId.isInt() &amp;&amp; !externalSystemType.isExtIdAnInt)) {</span>
<span class="nc" id="L1701">			throw new BbmUpdateException(&quot;For this external system, externalSourceId must be a string not an integer&quot;);</span>
		}
<span class="nc bnc" id="L1703" title="All 4 branches missed.">		if ((!activityExternalId.isInt() &amp;&amp; externalSystemType.isExtIdAnInt)) {</span>
<span class="nc" id="L1704">			throw new BbmUpdateException(&quot;For this external system, externalSourceId must be an integer not a string&quot;);</span>
		}

		// match external id for existing activity
		try {
<span class="nc" id="L1709">			boolean insert = true;</span>
<span class="nc" id="L1710">			MapUtil.setWfoToExternalID(externalSystemType, ObjectType.Activity, objValue.getID(), activityExternalId,</span>
					new Jdmo(true), insert);
     }
<span class="nc" id="L1713">      catch (JdmoException e)</span>
      {
<span class="nc" id="L1715">          handleException(e);</span>
<span class="nc" id="L1716">          throw new BbmUpdateException(e);</span>
      }
      finally
      {
<span class="nc" id="L1720">          methodFinish();</span>
<span class="nc" id="L1721">      }</span>

<span class="nc" id="L1723">	}</span>
	/**
	 * &lt;B&gt;updateActivityCategory&lt;/B&gt;
	 * &lt;P&gt;
	 * update given activityCategory to db
	 * &lt;P&gt;
	 *
	 * @param activityCategory
	 *            : activityCategory to update
	 */
	public void updateActivityCategory(ActivityCategory activityCategory) throws BbmUpdateException, MultiUserException {
<span class="nc" id="L1734">		methodStart(&quot;updateActivityCategory&quot;, activityCategory);</span>
<span class="nc" id="L1735">		ActivityCategoryDAO activityCategoryDAO = new ActivityCategoryDAO();</span>
		try {
<span class="nc" id="L1737">			activityCategoryDAO.updateObject(activityCategory);</span>
<span class="nc" id="L1738">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1739">			handleException(e, true);</span>
<span class="nc" id="L1740">			throw e;</span>
<span class="nc" id="L1741">		} catch (MultiUserException e) {</span>
<span class="nc" id="L1742">			handleException(e, true);</span>
<span class="nc" id="L1743">			throw e;</span>
		} finally {
<span class="nc" id="L1745">			activityCategoryDAO.cleanUp();</span>
<span class="nc" id="L1746">			methodFinish();</span>
<span class="nc" id="L1747">		}</span>
<span class="nc" id="L1748">	}</span>

	public DeletionResult deleteActivity(ID activityID) throws DeleteException, RemoteException {
<span class="nc" id="L1751">		methodStart(&quot;deleteActivity&quot;, activityID);</span>
		try {
			//TODO: determine if we can get away with a default locale here
<span class="nc" id="L1754">			DeletionResult result = deleteManager.deleteObject(activityID, Activity.OBJECT_TYPE_ACTIVITY, null,</span>
<span class="nc" id="L1755">					LocalizationManager.getInstance().getLocaleContext(Locale.US, Locale.US, Locale.US));</span>
<span class="nc" id="L1756">			deleteActivityFromCache(activityID, false);</span>
<span class="nc" id="L1757">			return result;</span>
<span class="nc" id="L1758">		} catch (DeleteException e) {</span>
<span class="nc" id="L1759">			handleException(e);</span>
<span class="nc" id="L1760">			throw e;</span>
<span class="nc" id="L1761">		} catch (RemoteException e) {</span>
<span class="nc" id="L1762">			handleException(e);</span>
<span class="nc" id="L1763">			throw e;</span>
		} finally {
<span class="nc" id="L1765">			methodFinish();</span>
		}
	}

	/**
	 * To support deletion from Facade layer, it should refreshed the cache also
	 *
	 * @param ID
	 *            , actvitiyID
	 * @param boolean, markDeletionOnly, remove Activity object or just market it
	 * @throws RemoteException
	 */
	public void deleteActivityFromCache(ID activityID, boolean markDeletionOnly) {
<span class="pc bpc" id="L1778" title="1 of 2 branches missed.">		methodStart(&quot;deleteActivityFromCache&quot;, activityID, markDeletionOnly ? Boolean.TRUE : Boolean.FALSE);</span>
		try {
<span class="pc bpc" id="L1780" title="1 of 2 branches missed.">			if (cacheUsed()) {</span>
<span class="pc bpc" id="L1781" title="1 of 2 branches missed.">				if (markDeletionOnly) {</span>
<span class="nc" id="L1782">					Activity activity = (Activity) m_ActivityCache.get(activityID);</span>
<span class="nc bnc" id="L1783" title="All 2 branches missed.">					if (activity != null) {</span>
<span class="nc" id="L1784">						activity.setDeleted(true);</span>
						// the deleted actvity is renamed so new activty can be created with same name.
<span class="nc" id="L1786">						activity.setName(activity.getName()+&quot;-&quot;+activity.getId());</span>
<span class="nc" id="L1787">						m_ActivityCache.put(activityID, activity);</span>
					}
<span class="nc" id="L1789">				} else {</span>
<span class="fc" id="L1790">					m_ActivityCache.remove(activityID);</span>
				}
			}
		} finally {
<span class="pc" id="L1794">			methodFinish();</span>
<span class="fc" id="L1795">		}</span>
<span class="fc" id="L1796">	}</span>

	/**
	 * &lt;B&gt;deleteActivity&lt;/B&gt; deletes given activity from db
	 * &lt;P&gt;
	 *
	 * @param actgivity
	 *            activity to delete
	 *            &lt;P&gt;
	 * @return boolean if successful
	 */
	public void deleteActivityForTestOnly(Activity activity) throws BbmRemoveException {
<span class="nc" id="L1808">		methodStart(&quot;deleteActivityForTestOnly&quot;, activity);</span>
<span class="nc bnc" id="L1809" title="All 2 branches missed.">		if (activity == null) {</span>
<span class="nc" id="L1810">			return;</span>
		}
		try {
<span class="nc" id="L1813">			ArrayList&lt;Activity&gt; activitiesToDelete = new ArrayList&lt;Activity&gt;(1);</span>
<span class="nc" id="L1814">			activitiesToDelete.add(activity);</span>
<span class="nc" id="L1815">			deleteActivitiesForTestOnly(activitiesToDelete);</span>
		} finally {
<span class="nc" id="L1817">			methodFinish();</span>
<span class="nc" id="L1818">		}</span>
<span class="nc" id="L1819">	}</span>

	public void deleteActivitiesForTestOnly(Collection&lt;Activity&gt; activitiesToDelete) throws BbmRemoveException {
<span class="nc" id="L1822">		methodStart(&quot;deleteActivitiesForTestOnly&quot;, activitiesToDelete);</span>
<span class="nc bnc" id="L1823" title="All 4 branches missed.">		if (activitiesToDelete == null || activitiesToDelete.isEmpty()) {</span>
<span class="nc" id="L1824">			return;</span>
		}
<span class="nc" id="L1826">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;ID&gt;(activitiesToDelete.size());</span>
<span class="nc bnc" id="L1827" title="All 2 branches missed.">		for (Iterator&lt;Activity&gt; iterator = activitiesToDelete.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L1828">			ids.add(iterator.next().getID());</span>
		}
<span class="nc" id="L1830">		ActivityDAO dao = new ActivityDAO();</span>
		try {
<span class="nc" id="L1832">			DAOEJBUtil.deleteObjects(dao, ids, this, &quot;deleteActivitiesForTestOnly&quot;);</span>
		} finally {
<span class="nc" id="L1834">			methodFinish();</span>
<span class="nc" id="L1835">		}</span>
<span class="nc" id="L1836">	}</span>

	public void deleteActivityCategoryForTestOnly(ActivityCategory activityCategory) throws BbmRemoveException {
<span class="nc" id="L1839">		methodStart(&quot;deleteActivityCategoryForTestOnly&quot;, activityCategory);</span>
<span class="nc bnc" id="L1840" title="All 2 branches missed.">		if (activityCategory == null) {</span>
<span class="nc" id="L1841">			return;</span>
		}
		try {
<span class="nc" id="L1844">			ArrayList&lt;ActivityCategory&gt; activityCategoriesToDelete = new ArrayList&lt;ActivityCategory&gt;(1);</span>
<span class="nc" id="L1845">			activityCategoriesToDelete.add(activityCategory);</span>
<span class="nc" id="L1846">			deleteActivityCategoriesForTestOnly(activityCategoriesToDelete);</span>
		} finally {
<span class="nc" id="L1848">			methodFinish();</span>
<span class="nc" id="L1849">		}</span>
<span class="nc" id="L1850">	}</span>

	public void deleteActivityCategoriesForTestOnly(Collection&lt;ActivityCategory&gt; activityCategories) throws BbmRemoveException {
<span class="nc" id="L1853">		methodStart(&quot;deleteActivityCategoriesForTestOnly&quot;, activityCategories);</span>
<span class="nc bnc" id="L1854" title="All 4 branches missed.">		if (activityCategories == null || activityCategories.isEmpty()) {</span>
<span class="nc" id="L1855">			return;</span>
		}
<span class="nc" id="L1857">		ActivityCategoryDAO dao = new ActivityCategoryDAO();</span>
<span class="nc" id="L1858">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;ID&gt;(activityCategories.size());</span>
<span class="nc bnc" id="L1859" title="All 2 branches missed.">		for (Iterator&lt;ActivityCategory&gt; iterator = activityCategories.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L1860">			ids.add(iterator.next().getID());</span>
		}
		try {
<span class="nc" id="L1863">			DAOEJBUtil.deleteObjects(dao, ids, this, &quot;deleteActivityCategoriesForTestOnly&quot;);</span>
		} finally {
<span class="nc" id="L1865">			methodFinish();</span>
<span class="nc" id="L1866">		}</span>
<span class="nc" id="L1867">	}</span>

	public void deleteActivityMediaForTestOnly(ActivityMedia activityMedia) throws BbmRemoveException {
<span class="nc" id="L1870">		methodStart(&quot;deleteActivityMediaForTestOnly&quot;, activityMedia);</span>
<span class="nc bnc" id="L1871" title="All 2 branches missed.">		if (activityMedia == null) {</span>
<span class="nc" id="L1872">			return;</span>
		}
		try {
<span class="nc" id="L1875">			ArrayList&lt;ActivityMedia&gt; toDelete = new ArrayList&lt;ActivityMedia&gt;(1);</span>
<span class="nc" id="L1876">			toDelete.add(activityMedia);</span>
<span class="nc" id="L1877">			deleteActivityMediasForTestOnly(toDelete);</span>
		} finally {
<span class="nc" id="L1879">			methodFinish();</span>
<span class="nc" id="L1880">		}</span>
<span class="nc" id="L1881">	}</span>

	public void deleteActivityMediasForTestOnly(Collection&lt;ActivityMedia&gt; toDelete) throws BbmRemoveException {
<span class="nc" id="L1884">		methodStart(&quot;deleteActivityMediasForTestOnly&quot;, toDelete);</span>
<span class="nc bnc" id="L1885" title="All 4 branches missed.">		if (toDelete == null || toDelete.isEmpty()) {</span>
<span class="nc" id="L1886">			return;</span>
		}
<span class="nc" id="L1888">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;ID&gt;(toDelete.size());</span>
<span class="nc bnc" id="L1889" title="All 2 branches missed.">		for (Iterator&lt;ActivityMedia&gt; iterator = toDelete.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L1890">			ids.add(iterator.next().getID());</span>
		}
<span class="nc" id="L1892">		ActivityMediaDAO dao = new ActivityMediaDAO();</span>
		try {
<span class="nc" id="L1894">			DAOEJBUtil.deleteObjects(dao, ids, this, &quot;deleteActivityMediasForTestOnly&quot;);</span>
		} finally {
<span class="nc" id="L1896">			methodFinish();</span>
<span class="nc" id="L1897">		}</span>
<span class="nc" id="L1898">	}</span>

	private boolean cacheUsed() {
<span class="pc bpc" id="L1901" title="1 of 2 branches missed.">		if (WhatIfMode) {</span>
<span class="nc" id="L1902">			return false;</span>
		}

		// If Cache is null, then cache is not used
<span class="fc" id="L1906">		boolean currentStatus = false;</span>
		try {
			// If cache is never instantiated, give it a chance to get initialized
			// If ConfigManager is cache aware, then always check it dynamically
<span class="pc bpc" id="L1910" title="2 of 4 branches missed.">			if (m_ActivityCache == null || m_DBConfigManager.cacheUsed()) {</span>
				// Access ConfigManager for the cache setting
<span class="pc bpc" id="L1912" title="1 of 2 branches missed.">				if (ConfigCacheUtil.isCacheEnabled(m_DBConfigManager, ConfigKey.ACTIVITY_CACHE_USAGE)) {</span>
					// If Cache is null, initialize it
<span class="pc bpc" id="L1914" title="1 of 2 branches missed.">					if (m_ActivityCache == null) {</span>
<span class="nc" id="L1915">						m_ActivityCache = CacheFactory.getCache(JNDINames.BBM_ACTIVITYMANAGER_EJBHOME,</span>
<span class="nc" id="L1916">								ActivityManagerEJB.class.getClassLoader());</span>
					}
<span class="fc" id="L1918">					currentStatus = true;</span>
				} else {
<span class="nc" id="L1920">					currentStatus = false;</span>
				}
			} else {
				// Or if m_TimeRecordCache is available, we think cache is enabled
<span class="nc bnc" id="L1924" title="All 2 branches missed.">				currentStatus = (m_ActivityCache != null);</span>
			}
<span class="nc" id="L1926">		} catch (Exception e) {</span>
<span class="nc" id="L1927">			currentStatus = false;</span>
<span class="fc" id="L1928">		}</span>
		// If there is state transition, we need flush cache content
<span class="pc bpc" id="L1930" title="1 of 2 branches missed.">		if (lastCheckStatus != currentStatus) {</span>
			// If from Cache turn on to off, or vice versa, we will flush cache content
<span class="nc bnc" id="L1932" title="All 2 branches missed.">			if (m_ActivityCache != null) {</span>
<span class="nc" id="L1933">				m_ActivityCache.clear();</span>
				try {
					// if cache enabled, preload content
<span class="nc bnc" id="L1936" title="All 2 branches missed.">					if (currentStatus) {</span>
<span class="nc" id="L1937">						initCache();</span>
					}
<span class="nc" id="L1939">				} catch (Exception e) {</span>
<span class="nc" id="L1940">					m_cat.error(e.getMessage());</span>
<span class="nc" id="L1941">				}</span>
			}
<span class="nc" id="L1943">			lastCheckStatus = currentStatus;</span>
		}
<span class="fc" id="L1945">		return currentStatus;</span>
	}

	/**
	 * get all activities that are not from seed data
	 *
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection getAllNonSeedActivities() throws BbmFinderException {
<span class="nc" id="L1955">		methodStart(&quot;getAllNonSeedActivities&quot;);</span>
<span class="nc" id="L1956">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L1958">			return activityDao.getAllNonSeedActivities();</span>
<span class="nc" id="L1959">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1960">			handleException(e, false);</span>
<span class="nc" id="L1961">			throw e;</span>
<span class="nc" id="L1962">		} catch (Exception e) {</span>
<span class="nc" id="L1963">			handleException(e, false);</span>
<span class="nc" id="L1964">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1966">			activityDao.cleanUp();</span>
<span class="nc" id="L1967">			methodFinish();</span>
		}
	}

	public Collection&lt;Activity&gt; getAllActivities() throws BbmFinderException {
<span class="fc" id="L1972">		methodStart(&quot;getAllActivities&quot;);</span>
<span class="fc" id="L1973">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="fc" id="L1975">			return activityDao.getAllObjects();</span>
<span class="nc" id="L1976">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1977">			handleException(e, false);</span>
<span class="nc" id="L1978">			throw e;</span>
<span class="nc" id="L1979">		} catch (RuntimeException e) {</span>
<span class="nc" id="L1980">			handleException(e, false);</span>
<span class="nc" id="L1981">			throw e;</span>
		} finally {
<span class="pc" id="L1983">			activityDao.cleanUp();</span>
<span class="pc" id="L1984">			methodFinish();</span>
		}
	}

	public Collection getTOBalanceForActivities(Collection empIDs, Collection activityIDs, Collection actCatIDs)
			throws BbmFinderException {
<span class="fc" id="L1990">		methodStart(&quot;getTOBalanceForActivities&quot;);</span>
<span class="fc" id="L1991">		ActivityTimeOffBalanceDAO dao = new ActivityTimeOffBalanceDAO();</span>
		try {
<span class="fc" id="L1993">			return dao.getTOBalanceForActivities(empIDs, activityIDs, actCatIDs);</span>
<span class="nc" id="L1994">		} catch (Exception e) {</span>
<span class="nc" id="L1995">			handleException(e, false);</span>
<span class="nc" id="L1996">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L1998">			dao.cleanUp();</span>
<span class="pc" id="L1999">			methodFinish();</span>
		}
	}

	public void updateOrInsertActivityTOBalance(Collection activityTOBalCol) throws BbmFinderException {
<span class="nc" id="L2004">		methodStart(&quot;updateOrInsertActivityTOBalance&quot;);</span>
<span class="nc" id="L2005">		ActivityTimeOffBalanceDAO dao = new ActivityTimeOffBalanceDAO();</span>
		try {
<span class="nc" id="L2007">			dao.updateOrInsertActivityTOBalance(activityTOBalCol);</span>
<span class="nc" id="L2008">		} catch (Exception e) {</span>
<span class="nc" id="L2009">			handleException(e, false);</span>
<span class="nc" id="L2010">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L2012">			dao.cleanUp();</span>
<span class="nc" id="L2013">			methodFinish();</span>
<span class="nc" id="L2014">		}</span>
<span class="nc" id="L2015">	}</span>

	public HashMap getActivityTOBalanceMap(Collection empIDs, Collection actIDs, Collection actCatIDs)
			throws BbmFinderException {
<span class="nc" id="L2019">		methodStart(&quot;getActivityTOBalanceMap&quot;);</span>
<span class="nc" id="L2020">		ActivityTimeOffBalanceDAO dao = null;</span>
		try {
<span class="nc" id="L2022">			dao = new ActivityTimeOffBalanceDAO();</span>
<span class="nc" id="L2023">			return dao.getActivityTOBalanceMap(empIDs, actIDs, actCatIDs);</span>
<span class="nc" id="L2024">		} catch (Exception e) {</span>
<span class="nc" id="L2025">			handleException(e, false);</span>
<span class="nc" id="L2026">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc bnc" id="L2028" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L2029">				dao.cleanUp();</span>
			}
<span class="nc" id="L2031">			methodFinish();</span>
		}
	}

	public void deleteActivityTOBalance(Collection ids) throws BbmRemoveException {
<span class="nc" id="L2036">		methodStart(&quot;deleteActivityTOBalance&quot;);</span>
<span class="nc" id="L2037">		ActivityTimeOffBalanceDAO dao = new ActivityTimeOffBalanceDAO();</span>
		try {
<span class="nc" id="L2039">			dao.deleteObjects(ids);</span>
		} finally {
<span class="nc" id="L2041">			dao.cleanUp();</span>
<span class="nc" id="L2042">			methodFinish();</span>
<span class="nc" id="L2043">		}</span>
<span class="nc" id="L2044">	}</span>

	//Special Activities API START
	private TimeOffHoursManagerBridge getTimeOffHoursManagerBridge() throws Exception
	{
<span class="fc bfc" id="L2049" title="All 2 branches covered.">		if (m_timeOffHoursManagerBridge == null)</span>
		{
<span class="fc" id="L2051">		    String gcrType = &quot;TIMEOFFHOURSMANAGER_BRIDGE&quot;;</span>
<span class="fc" id="L2052">		    GCRManager m_gcrManager  = CoreManagerFactory.getGCRManagerRemote(WhatIfMode);</span>
<span class="fc" id="L2053">		    Collection entries = m_gcrManager.getGCREntryOfType(gcrType);</span>
<span class="fc" id="L2054">		    Class clazz = Class.forName(((GCREntry) (entries.iterator().next())).getHook());</span>
<span class="fc" id="L2055">		    m_timeOffHoursManagerBridge = (TimeOffHoursManagerBridge) clazz.newInstance();</span>
		}
<span class="fc" id="L2057">	    return m_timeOffHoursManagerBridge;</span>
	}

	public int getMaxDurationOverride(ID orgID, ID activityID) throws Exception
	{
<span class="fc" id="L2062">		TimeOffHoursManagerBridge bridge = getTimeOffHoursManagerBridge();</span>
<span class="fc" id="L2063">		return bridge.getMaxDurationOverride(orgID, activityID);</span>
    }

	public void setMaxDurationOverride(ID orgID, ID activityID, int value) throws Exception
	{
<span class="nc" id="L2068">		TimeOffHoursManagerBridge bridge = getTimeOffHoursManagerBridge();</span>
<span class="nc" id="L2069">		bridge.setMaxDurationOverride(orgID, activityID, value);</span>
<span class="nc" id="L2070">	}</span>

	public int getAdherenceToleranceOverride(ID orgID, ID activityID) throws Exception
	{
<span class="fc" id="L2074">		TimeOffHoursManagerBridge bridge = getTimeOffHoursManagerBridge();</span>
<span class="fc" id="L2075">		return bridge.getAdherenceToleranceOverride(orgID, activityID);</span>
	}

	public void setAdherenceToleranceOverride(ID orgID, ID activityID, int value) throws Exception
	{
<span class="nc" id="L2080">		TimeOffHoursManagerBridge bridge = getTimeOffHoursManagerBridge();</span>
<span class="nc" id="L2081">		bridge.setAdherenceToleranceOverride(orgID, activityID, value);</span>
<span class="nc" id="L2082">	}</span>

	public Activity getVacationOverride(ID orgID) throws Exception
	{
<span class="fc" id="L2086">		TimeOffHoursManagerBridge bridge = getTimeOffHoursManagerBridge();</span>
<span class="fc" id="L2087">		return bridge.getVacationOverride(orgID);</span>
	}

	public void setVacationOverride(ID orgID, ID vacationActivityID) throws Exception
	{
<span class="nc" id="L2092">		TimeOffHoursManagerBridge bridge = getTimeOffHoursManagerBridge();</span>
<span class="nc" id="L2093">		bridge.setVacationOverride(orgID, vacationActivityID);</span>
<span class="nc" id="L2094">	}</span>
	//Special Activities API END
	
	public Collection&lt;ID&gt; getDailyPoolAllotmentActivityIDs(boolean checkTimeOffWithAllotment) throws BbmFinderException {
<span class="nc" id="L2098">		methodStart(&quot;getDailyPoolAllotmentActivities&quot;);</span>
<span class="nc" id="L2099">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L2101">			return activityDao.getDailyPoolAllotmentActivityIDs(checkTimeOffWithAllotment);</span>
<span class="nc" id="L2102">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2103">			handleException(e, false);</span>
<span class="nc" id="L2104">			throw e;</span>
		} finally {
<span class="nc" id="L2106">			activityDao.cleanUp();</span>
<span class="nc" id="L2107">			methodFinish();</span>
		}
	}
	
	public void unlinkQueueActivities(Collection&lt;ID&gt; queueIds) throws BbmRemoveException {
<span class="nc" id="L2112">		methodStart(&quot;unlinkQueueActivities&quot;, queueIds);</span>

<span class="nc" id="L2114">		ActivityQueueDAO activityQueueDao = activityQueueDAOFactory.createDAO();</span>
		try {
<span class="nc" id="L2116">			activityQueueDao.unlinkQueueActivities(queueIds);</span>
<span class="nc" id="L2117">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L2118">			handleException(e, true);</span>
<span class="nc" id="L2119">			throw e;</span>
		} finally {
<span class="nc" id="L2121">			activityQueueDao.cleanUp();</span>
<span class="nc" id="L2122">			methodFinish();</span>
<span class="nc" id="L2123">		}</span>
<span class="nc" id="L2124">	}</span>

	public void setActivityQueueDAOFactory(ActivityQueueDAOFactory activityQueueDAOFactory) {
<span class="nc" id="L2127">		this.activityQueueDAOFactory = activityQueueDAOFactory;</span>
<span class="nc" id="L2128">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>