<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CalendarEventAssignmentEntityUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.rest.wfm.resource.calendareventassignment</a> &gt; <span class="el_source">CalendarEventAssignmentEntityUtil.java</span></div><h1>CalendarEventAssignmentEntityUtil.java</h1><pre class="source lang-java linenums">package com.verint.web.rest.wfm.resource.calendareventassignment;


import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.*;

import java.rmi.RemoteException;
import java.util.*;
import java.util.function.Function;
import java.util.function.Predicate;
import java.util.stream.Collectors;

class CalendarEventAssignmentEntityUtil {

<span class="nc" id="L17">	private CalendarEventAssignmentEntityUtil(){}</span>

	/**
	 * Removes any recurring floating event instances from the given set of assignments, and returns the filtered
	 * set.
	 */
	private static Set&lt;CalendarEventAssignment&gt; filterRecurringFloatingInstances(ScheduleAccessManager sam,
			Collection&lt;CalendarEventAssignment&gt; assignmentsToFilter) throws BbmFinderException, RemoteException {

		//Retrieve non-null templateIDs from the assignments
<span class="nc" id="L27">		Collection&lt;ID&gt; templateIDs = assignmentsToFilter.stream()</span>
<span class="nc" id="L28">				.map(CalendarEventAssignment::getEventTemplateID)</span>
<span class="nc" id="L29">				.filter(Objects::nonNull)</span>
<span class="nc" id="L30">				.collect(Collectors.toList());</span>
		//Load the templates
<span class="nc" id="L32">		Collection&lt;ValueObjectAggEventTemplate&gt; templates = sam.getCalendarEventTemplatesByIDs(templateIDs);</span>
		//Map template IDs to the templates
<span class="nc" id="L34">		Map&lt;ID, ValueObjectAggEventTemplate&gt; result = templates.stream()</span>
<span class="nc" id="L35">				.collect(Collectors.toMap(ValueObjectAggEventTemplate::getID, Function.identity()));</span>
		//Function that determines if CalendarEventAssignment is linked to a recurring floating template.  It is linked if the template
		//ID is non-null and the template ID belongs to the set of recurring floating templates.
<span class="nc" id="L38">		Predicate&lt;CalendarEventAssignment&gt; isNotLinkedToRecurringFloatingTemplate = (CalendarEventAssignment it) -&gt;</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">				it.getEventTemplateID() == null ||</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">						result.get(it.getEventTemplateID()).getTemplateType() != CalendarEventTemplate.EVENT_TEMPLATE_RECURRING_FLOATING;</span>

		//Filters all assignments
<span class="nc" id="L43">		return assignmentsToFilter.stream()</span>
<span class="nc" id="L44">				.filter(isNotLinkedToRecurringFloatingTemplate)</span>
<span class="nc" id="L45">				.collect(Collectors.toSet());</span>
	}

	/**
	 * The EJB returns assignments as a collection of collections (each collection representing the
	 * CalendarEventAssignments for a specific work resource).  This method collects all of the assignments and
	 * returns them in one collection.  Only unique assignments are returned: duplicate assignments are removed.
	 *
	 * Additionally, this method filters out recurring event template instances.
	 * FIXME:   At the time of writing, this API was only used by the bulk schedule editor and we didn't have time to create
	 * a more sophisticated filtering system, so we filter the records out here.  Ideally we should be able to filter out
	 * certain specific types of calendar events with query parameters.
	 */
	static Set&lt;CalendarEventAssignment&gt; consolidateAndFilterAssignments(ScheduleAccessManager sam,
			List&lt;Collection&lt;CalendarEventAssignment&gt;&gt; assignments) throws BbmFinderException, RemoteException {
<span class="nc" id="L60">		Set&lt;CalendarEventAssignment&gt; consolidatedAssignments = new LinkedHashSet&lt;&gt;();</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">		for (Collection&lt;CalendarEventAssignment&gt; subCollection : assignments) {</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">			if (subCollection == null) {</span>
<span class="nc" id="L63">				continue;</span>
			}
<span class="nc" id="L65">			consolidatedAssignments.addAll(subCollection);</span>
<span class="nc" id="L66">		}</span>

<span class="nc" id="L68">		return filterRecurringFloatingInstances(sam, consolidatedAssignments);</span>
	}

	static &lt;T extends CalendarEventAssignmentEntity&gt; void updateCeaAccordingToEntity(T entity, CalendarEventAssignment ce) {
<span class="nc" id="L72">		Collection&lt;ID&gt; workResourceIDs = ce.getWorkResourceIDs();</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">		for (ID workResourceID : workResourceIDs) {</span>
<span class="nc" id="L74">			ce.removeWorkResourceID(workResourceID);</span>
<span class="nc" id="L75">		}</span>
<span class="nc" id="L76">		Collection&lt;Integer&gt; newWorkResourceIDs = entity.getCalendarEventAttendees();</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">		for (Integer newWorkResourceID : newWorkResourceIDs) {</span>
<span class="nc" id="L78">			ce.addWorkResourceID(ID.fromInt(newWorkResourceID));</span>
<span class="nc" id="L79">		}</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">		if (entity.getShiftAssignmentID() != null) {</span>
<span class="nc" id="L81">			ce.setLinkedShiftAssignmentID(ID.fromInt(entity.getShiftAssignmentID()));</span>
		}
<span class="nc" id="L83">		ce.setDescription(entity.getDescription());</span>
<span class="nc" id="L84">		ce.setLocked(entity.getIsLocked());</span>
<span class="nc" id="L85">		ce.setStartTime(entity.getStartTime());</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">		if (entity.getDuration() != null) {</span>
<span class="nc" id="L87">			ce.setDuration(entity.getDuration());</span>
		}
<span class="nc" id="L89">		ce.setActivityID(ID.fromInt(entity.getActivityID()));</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">		if (entity.getOverlayPrecedence() != null) {</span>
<span class="nc" id="L91">			ce.setOverlayPrecedence(entity.getOverlayPrecedence());</span>
		}
<span class="nc bnc" id="L93" title="All 2 branches missed.">		if (entity.getCalendarEventTemplateID() != null) {</span>
<span class="nc" id="L94">			ce.setFieldValue(CalendarEventAssignmentFields.TEMPLATEID, ID.fromInt(entity.getCalendarEventTemplateID()));</span>
		}

<span class="nc bnc" id="L97" title="All 2 branches missed.">		if (entity.getEventType().equals(CalendarEventType.calendar.name())) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">			if (entity.getOverlapType() != null) {</span>
<span class="nc" id="L99">				((CalendarEvent) ce).setOverlapType(entity.getOverlapType().shortValue());</span>
			}
<span class="nc bnc" id="L101" title="All 2 branches missed.">		} else if (entity.getEventType().equals(CalendarEventType.timeoff.name())) {</span>
<span class="nc" id="L102">			((TimeOffEvent)ce).setCountsMinutesTowardsRules(entity.getCountsMinsTowardsRules());</span>
<span class="nc" id="L103">			((TimeOffEvent)ce).setTimeOffRule(entity.getTimeOffRule().shortValue());</span>
		}
<span class="nc" id="L105">	}</span>

	static &lt;T extends CalendarEventAssignmentEntity&gt; CalendarEventAssignment createCEA(T entity) {
<span class="nc" id="L108">		String entityTypeStr = entity.getEventType();</span>
<span class="nc" id="L109">		CalendarEventAssignment cea = null;</span>
<span class="nc" id="L110">		CalendarEventType entityType = CalendarEventType.valueOf(entityTypeStr);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">		if (entityType.equals(CalendarEventType.calendar)) {</span>
<span class="nc" id="L112">			cea = new CalendarEvent();</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">		} else if (entityType.equals(CalendarEventType.timeoff)) {</span>
<span class="nc" id="L114">			cea = new TimeOffEvent();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">		} else if (entityType.equals(CalendarEventType.unavailability)) {</span>
<span class="nc" id="L116">			cea = new UnavailabilityEvent();</span>
		}
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (cea != null) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">			if (entity.getShiftAssignmentID() != null) {</span>
<span class="nc" id="L120">				cea.setLinkedShiftAssignmentID(ID.fromInt(entity.getShiftAssignmentID()));</span>
			}
<span class="nc" id="L122">			cea.setDescription(entity.getDescription());</span>
<span class="nc" id="L123">			cea.setStartTime(entity.getStartTime());</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">			if (entity.getDuration() != null) {</span>
<span class="nc" id="L125">				cea.setDuration(entity.getDuration());</span>
			}
<span class="nc" id="L127">			cea.setLocked(entity.getIsLocked());</span>
<span class="nc" id="L128">			cea.setActivityID(ID.fromInt(entity.getActivityID()));</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">			if (entity.getOverlayPrecedence() != null) {</span>
<span class="nc" id="L130">				cea.setOverlayPrecedence(entity.getOverlayPrecedence());</span>
			}
<span class="nc bnc" id="L132" title="All 2 branches missed.">			if (!entity.getCalendarEventAttendees().isEmpty()) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">				for (Integer attendee : entity.getCalendarEventAttendees()) {</span>
<span class="nc" id="L134">					cea.addWorkResourceID(ID.fromInt(attendee));</span>
<span class="nc" id="L135">				}</span>
			}
<span class="nc bnc" id="L137" title="All 2 branches missed.">			if (entity.getCalendarEventTemplateID() != null) {</span>
<span class="nc" id="L138">				cea.setFieldValue(CalendarEventAssignmentFields.TEMPLATEID,</span>
<span class="nc" id="L139">						ID.fromInt(entity.getCalendarEventTemplateID()));</span>
			}
<span class="nc bnc" id="L141" title="All 2 branches missed.">			if (cea instanceof CalendarEvent) {</span>
<span class="nc" id="L142">				((CalendarEvent)cea).setOverlapType(entity.getOverlapType().shortValue());</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">			} else if (cea instanceof TimeOffEvent) {</span>
<span class="nc" id="L144">				((TimeOffEvent)cea).setCountsMinutesTowardsRules(entity.getCountsMinsTowardsRules());</span>
<span class="nc" id="L145">				((TimeOffEvent)cea).setTimeOffRule(entity.getTimeOffRule().shortValue());</span>
			}
		}
<span class="nc" id="L148">		return cea;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>