<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignSPQueuesListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.campaign</a> &gt; <span class="el_source">CampaignSPQueuesListPC.java</span></div><h1>CampaignSPQueuesListPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.campaign;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.HtmlEncoder;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueueFieldInfo;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueueSortField;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.skill.ejb.SkillManager;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.skill.model.SkillFieldInfo;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.list.InsertableMultiColListPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;

@SuppressWarnings(&quot;serial&quot;)
public class CampaignSPQueuesListPC extends InsertableMultiColListPC {

	public final static String SELECTION_SPSKILL_FN = &quot;selectionSPSkill&quot;;

<span class="fc" id="L51">	private Collection&lt;SPQueue&gt; m_spQueues = new ArrayList&lt;SPQueue&gt;();</span>
<span class="fc" id="L52">	private SchedulingPeriod m_sp = null;</span>
<span class="fc" id="L53">	private HashMap&lt;SPQueue, Collection&lt;ID&gt;&gt; spQueueToSkillsMap = new HashMap&lt;SPQueue, Collection&lt;ID&gt;&gt;();</span>
<span class="fc" id="L54">	private String strMegaSkill = null;</span>
	private FormInputPC m_formInputPC; //this input field will be reused for all of the rows in the list
<span class="fc" id="L56">	private Collection&lt;ID&gt; m_orgIds = null;</span>
<span class="fc" id="L57">	private Collection&lt;Skill&gt; m_skillsForOrgs = null;</span>
	
	public CampaignSPQueuesListPC(RequestContext context, Collection&lt;SPQueue&gt; queues, SchedulingPeriod sp) {
<span class="fc" id="L60">		super(context);</span>
<span class="fc" id="L61">		m_spQueues = queues;</span>
<span class="fc" id="L62">		m_sp = sp;</span>

<span class="fc" id="L64">		m_formInputPC = new FormInputPC(context);</span>
<span class="fc" id="L65">		addChildComponent(m_formInputPC);</span>

		try {
<span class="fc" id="L68">			strMegaSkill = m_context.getSystemManagerFactory().getConfigManager().getValue(ConfigKey.MEGASKILL);</span>
<span class="fc" id="L69">			initRows();</span>
<span class="fc" id="L70">			initHeader();</span>
<span class="nc" id="L71">		} catch (Exception ex) {</span>
<span class="nc" id="L72">			handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L73">		} </span>
<span class="fc" id="L74">	}</span>
	
	private void initHeader() {
<span class="fc" id="L77">		TableHeaderPC header = getHeader();</span>
<span class="fc" id="L78">		Localizer localizer = m_context.getLocalizer();</span>
<span class="fc" id="L79">		header.setPartialSortable(true);</span>

<span class="fc" id="L81">		String onClickJS = getOnClickJSForSortColumnHeader(header.getName());</span>

<span class="fc" id="L83">		header.addColumnHeaderData(FsWebBundleKey.SCHEDULINGPERIOD_NAME,</span>
<span class="fc" id="L84">			localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_NAME),</span>
<span class="fc" id="L85">			true).setOnClickJS(onClickJS);</span>
<span class="fc" id="L86">		header.addColumnHeaderData(FsWebBundleKey.SCHEDULINGPERIOD_DESC,</span>
<span class="fc" id="L87">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_DESC), true).setOnClickJS(onClickJS);</span>
<span class="fc" id="L88">		header.addColumnHeaderData(FsWebBundleKey.SCHEDULINGPERIOD_ORG,</span>
<span class="fc" id="L89">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_ORG), true).setOnClickJS(onClickJS);</span>
<span class="fc" id="L90">		header.addColumnHeaderData(FsWebBundleKey.SCHEDULINGPERIOD_MEDIA,</span>
<span class="fc" id="L91">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_MEDIA), true).setOnClickJS(onClickJS);</span>
<span class="fc" id="L92">		header.addColumnHeaderData(FsWebBundleKey.SCHEDULINGPERIOD_TYPE,</span>
<span class="fc" id="L93">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_TYPE), true).setOnClickJS(onClickJS);</span>
<span class="fc" id="L94">		header.addColumnHeaderData(FsWebBundleKey.SCHEDULINGPERIOD_SKILL,</span>
<span class="fc" id="L95">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_SKILL), false).setOnClickJS(onClickJS);</span>
<span class="fc" id="L96">		header.addColumnHeaderData(FsWebBundleKey.SCHEDULINGPERIOD_LTI,</span>
<span class="fc" id="L97">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_LTI), false).setOnClickJS(onClickJS);</span>
<span class="fc" id="L98">		header.addColumnHeaderData(FsWebBundleKey.SCHEDULINGPERIOD_THRESHOLD_OVER,</span>
<span class="fc" id="L99">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_THRESHOLD_OVER), false).setOnClickJS(onClickJS);</span>
<span class="fc" id="L100">		header.addColumnHeaderData(FsWebBundleKey.SCHEDULINGPERIOD_THRESHOLD_UNDER,</span>
<span class="fc" id="L101">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_THRESHOLD_UNDER), false).setOnClickJS(onClickJS);</span>
<span class="fc" id="L102">	}</span>

	private void initRows() throws Exception {
		@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L106">		Collection&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>
	
<span class="pc bpc" id="L108" title="1 of 4 branches missed.">		if (rows != null &amp;&amp; m_sp != null) {</span>
<span class="fc" id="L109">			boolean createEnabled = m_context.getUser().isAuthorized(PrivilegeKeys.FS_CREATECAMPAIGN);</span>
<span class="fc" id="L110">			boolean configEnabled = m_context.getUser().isAuthorized(PrivilegeKeys.FS_CONFIGURECAMPAIGN);</span>
<span class="pc bpc" id="L111" title="3 of 4 branches missed.">			boolean editEnabled = createEnabled || configEnabled;</span>
			
<span class="pc bpc" id="L113" title="1 of 4 branches missed.">			if (m_spQueues != null &amp;&amp; m_spQueues.isEmpty() == false) {</span>
<span class="fc" id="L114">				WorkloadManager wm = WfmManagerFactory.getWorkloadManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L115">				CampaignManager camMgr = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L116">				SkillManager skillMgr = WfmManagerFactory.getSkillManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L117">				Campaign campaign = camMgr.getCampaignByID(m_sp.getCampaignID());</span>
<span class="pc bpc" id="L118" title="1 of 4 branches missed.">				boolean isDistributedParentQueue = (campaign.getIsDistributed() &amp;&amp; m_sp.getParentSPID()==null);</span>

				//Load the queues associated to the selected spQueues, store them in a map so they can be referenced as we
				//are building the rows of SPQueues
<span class="fc" id="L122">				Collection&lt;ID&gt; queueIDs = ValueObjectUtil.getFieldObjectCol(SPQueueFieldInfo.SPQUEUE_QUEUEID, m_spQueues);</span>
<span class="fc" id="L123">				Collection&lt;Queue&gt; queues = wm.getQueuesByIDs(queueIDs);</span>
<span class="fc" id="L124">				HashMap&lt;ID, Queue&gt; queueIDMap = ValueObjectUtil.getIDObjectMap(queues);</span>
				
				//Add a row for each queue in the Scheduling Period
<span class="fc bfc" id="L127" title="All 2 branches covered.">				for (SPQueue spQueue : m_spQueues) {</span>
<span class="fc" id="L128">					ID queueID = spQueue.getQueueID();</span>
<span class="fc" id="L129">					Queue queue = queueIDMap.get(queueID);</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">					if (queue != null) {</span>
						// TODO eclingman: Should FACETOFACE have similar treatment as phone here?
<span class="fc bfc" id="L132" title="All 2 branches covered.">						if(!m_sp.getSkillBased()) {</span>
<span class="pc bpc" id="L133" title="1 of 4 branches missed.">							if(!queue.getMediaID().equals(Media.MEDIA_ID_PROJECT) &amp;&amp; !queue.getMediaID().equals(Media.MEDIA_ID_PHONE)) </span>
<span class="fc" id="L134">								continue;</span>
						}
						
<span class="fc" id="L137">						DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData(spQueue.getID());</span>
<span class="fc" id="L138">						rowData.setSelectable(editEnabled);</span>
						
<span class="fc" id="L140">						rowData.add(queue.getName());</span>
<span class="fc" id="L141">						rowData.add(queue.getDescription());</span>
<span class="fc" id="L142">						rowData.add(queue.getOrganizationName());</span>
<span class="fc" id="L143">						rowData.add(queue.getMediaName());</span>
<span class="fc" id="L144">						rowData.add(getQueueTypeString(queue.getQueueType()));</span>
						
<span class="fc bfc" id="L146" title="All 4 branches covered.">						if (m_sp.getSkillBased() &amp;&amp; !isDistributedParentQueue) {</span>
<span class="fc" id="L147">							addSkillCell(campaign, skillMgr, camMgr, spQueue, rowData, queue, queueID);</span>
<span class="fc" id="L148">							CampaignSPQueueUtil.addLeastTimeIntervalCell(spQueue, m_localizer, rowData);</span>
<span class="fc" id="L149">							CampaignSPQueueUtil.addThresholdOverCell(spQueue, m_formInputPC, m_localizer, rowData);</span>
<span class="fc" id="L150">							CampaignSPQueueUtil.addThresholdUnderCell(spQueue, m_formInputPC, m_localizer, rowData);</span>
						} else {//non-skilled or distributed parent queue
<span class="pc bpc" id="L152" title="1 of 4 branches missed.">							if (m_sp.getSkillBased() &amp;&amp; isDistributedParentQueue) {</span>
								//the skill cell for skilled distributed parent queue should list the skills of its child queue(s)
<span class="fc" id="L154">								String skillsString = &quot;&quot;;</span>
<span class="fc" id="L155">								HashSet&lt;ID&gt; skillIDSet = new HashSet&lt;ID&gt;();</span>
								
								//get the child queues for this parent queue
<span class="fc" id="L158">								Collection&lt;SPQueue&gt; childSPQueues = camMgr.getChildSpQueuesOfDistributedSpQueue(spQueue.getID());</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">								for (SPQueue childSPQueue : childSPQueues) {</span>
<span class="fc" id="L160">									childSPQueue = camMgr.getSPQueue(childSPQueue.getID()); //this will load the skill IDs</span>
<span class="fc" id="L161">									Collection&lt;ID&gt; childSkillIDs = childSPQueue.getSkills();</span>
<span class="pc bpc" id="L162" title="2 of 4 branches missed.">									if (childSkillIDs != null &amp;&amp; childSkillIDs.size() &gt; 0) {</span>
<span class="fc" id="L163">										skillIDSet.addAll(childSkillIDs);</span>
									}
<span class="fc" id="L165">								}</span>
								
								//create a comma-separated string of skill names
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">								if (skillIDSet.size() &gt; 0) {</span>
<span class="fc" id="L169">									boolean firstSkill = true;</span>
<span class="fc" id="L170">									Collection&lt;Skill&gt; skills = skillMgr.getSkillsByIDs(skillIDSet);</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">									for (Skill curSkill: skills) {</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">										skillsString = skillsString + (firstSkill ? &quot;&quot; : &quot;, &quot;) + curSkill.getName();</span>
<span class="fc" id="L173">										firstSkill = false;</span>
<span class="fc" id="L174">									}</span>
								}
								
<span class="fc" id="L177">								rowData.add(skillsString);</span>
<span class="fc" id="L178">							} else {</span>
								//skill cell (n/a)
<span class="fc" id="L180">								rowData.add(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_NOT_APPLICABLE));</span>
							}
								
							//Least Time Interval cell (n/a)
<span class="fc" id="L184">							rowData.add(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_NOT_APPLICABLE));</span>
							//Threshold Over cell (n/a)
<span class="fc" id="L186">							rowData.add(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_NOT_APPLICABLE));</span>
							//Threshold Under cell (n/a)
<span class="fc" id="L188">							rowData.add(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SCHEDULINGPERIOD_NOT_APPLICABLE));</span>
						}
										
<span class="fc" id="L191">						setRowAttributes(rowData, spQueue);</span>
<span class="fc" id="L192">						rows.add(rowData);</span>
					}	
<span class="fc" id="L194">				}</span>
			}
		}
<span class="fc" id="L197">	}</span>
	
	protected void addSkillCell(Campaign campaign, SkillManager skillMgr, CampaignManager camMgr, 
			SPQueue spQueue, DefaultMultiColumnNodeData rowData, Queue queue, ID queueID) throws Exception {
<span class="fc" id="L201">		ID newID = new ID(-1);</span>
<span class="fc" id="L202">		String newIDStr = newID.toString();</span>
				
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">		if (!campaign.getIsDistributed()) {</span>
<span class="fc" id="L205">			Collection&lt;ID&gt; ids = spQueue.getSkills();</span>
<span class="fc" id="L206">			List&lt;String&gt; selections =  new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">			if (!ids.isEmpty()) {</span>
				//a separate call for each SPQueue
<span class="fc" id="L209">				Collection&lt;Skill&gt; skills = skillMgr.getSkillsByIDs(ids);</span>
				//for most cases, skills has only one value.
<span class="fc bfc" id="L211" title="All 2 branches covered.">				for (Skill curSkill: skills) {</span>
<span class="fc" id="L212">					ID curSkillID = null;</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">					if (curSkill.getFieldValue(SkillFieldInfo.SKILL_SID) != null) {</span>
<span class="nc" id="L214">						curSkillID  = (ID)curSkill.getFieldValue(SkillFieldInfo.SKILL_SID);</span>
					} else {
<span class="fc" id="L216">						curSkillID = curSkill.getID();</span>
					}
<span class="fc" id="L218">					selections.add(curSkillID.toString());</span>
<span class="fc" id="L219">				}</span>
<span class="fc" id="L220">			} else {</span>
<span class="fc" id="L221">				selections.add(newIDStr);</span>
			}
<span class="fc bfc" id="L223" title="All 2 branches covered.">			if (m_orgIds == null) {</span>
<span class="fc" id="L224">				m_orgIds = camMgr.getLinkedOrgsforSP(m_sp.getID());</span>
<span class="fc" id="L225">				m_skillsForOrgs = skillMgr.getAvailableSkillsInOrg(m_orgIds);</span>
			}
<span class="fc" id="L227">			ArrayList&lt;StringsPair&gt; availableSkills = getSkills(m_skillsForOrgs, queue.getMediaID());</span>

<span class="fc" id="L229">			String[] strArray = new String[selections.size()];</span>
<span class="fc" id="L230">			strArray = selections.toArray(strArray);</span>
			
			//there is at least 1 in the availableSkills.
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">			if (availableSkills.size() &gt;1){ </span>
				
<span class="fc" id="L235">				Collections.sort(availableSkills, new Comparator&lt;StringsPair&gt;() {</span>
					@Override
					public int compare(StringsPair arg0, StringsPair arg1) {
<span class="fc" id="L238">						return arg0.getValue().compareTo(arg1.getValue());</span>
					}
				});
				
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">				rowData.add(HtmlUtil.makeSelectInput(SELECTION_SPSKILL_FN + &quot;_&quot; + spQueue.getID().toString(),</span>
						strArray,
						JSUtil.ON_CHANGE, 
						availableSkills, 
<span class="pc bnc" id="L246" title="All 2 branches missed.">						strMegaSkill!= null &amp;&amp; strMegaSkill.equals(&quot;1&quot;), </span>
						true));
			} else {
<span class="nc" id="L249">				rowData.add(&quot;&quot;);</span>
			}	
<span class="pc bnc" id="L251" title="All 4 branches missed.">		} else if (campaign.getIsDistributed() &amp;&amp; m_sp.getParentSPID()== null) {</span>
<span class="nc" id="L252">			ArrayList names = (ArrayList)camMgr.getSkillNamesMappedToQueue(queueID, spQueue.getSpID());</span>
<span class="nc" id="L253">			StringBuffer sb = new StringBuffer();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">			if(names.size()&gt;0) {</span>
<span class="nc" id="L255">				Collections.sort(names);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">				for (int i =0; i&lt; names.size(); i++) {</span>
<span class="nc" id="L257">					sb.append(names.get(i));</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">					if (i!= names.size()-1)</span>
<span class="nc" id="L259">						sb.append(&quot;, &quot;);</span>
				}
			}
		
<span class="nc" id="L263">			rowData.add(sb.toString());</span>
		}	
<span class="fc" id="L265">	}</span>

<span class="fc" id="L267">	protected void setRowAttributes(DefaultMultiColumnNodeData rowData, SPQueue spQueue) {}</span>
	
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L270">		boolean result = super.extractParameters(request);</span>
<span class="fc" id="L271">		ID newID = new ID(-1);</span>
		
<span class="fc bfc" id="L273" title="All 2 branches covered.">		for(SPQueue spQueue: m_spQueues) {</span>
			//read the skills (if any) for this spqueue
<span class="fc" id="L275">			String paramName = SELECTION_SPSKILL_FN + &quot;_&quot; + spQueue.getID().toString();</span>
<span class="fc" id="L276">			String[] dropdownVals =  request.getParameterValues(paramName);</span>
<span class="fc" id="L277">				Collection&lt;ID&gt; col = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L278" title="All 2 branches covered.">			if (dropdownVals != null) {</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">				for(int i = 0; i &lt; dropdownVals.length;i++){</span>
<span class="fc" id="L280">					ID skillID = new ID(Integer.parseInt(dropdownVals[i]));</span>
					
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">					if (!skillID.equals(newID)) {</span>
<span class="fc" id="L283">						col.add(skillID);</span>
					}
				}
			}

			//read the Least Time Interval (if any) for this spqueue
<span class="fc" id="L289">			paramName = CampaignSPQueueUtil.SELECTION_SPLTI_FN + &quot;_&quot; + spQueue.getID().toString();</span>
<span class="fc" id="L290">			String val =  request.getParameter(paramName);</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">			if (val != null) {</span>
<span class="fc" id="L292">				int iVal = Integer.parseInt(val);</span>
<span class="fc" id="L293">				spQueue.setLeastTimeInterval(iVal);</span>
			}

			//read the Threshold Over (if any) for this spqueue
<span class="fc" id="L297">			paramName = CampaignSPQueueUtil.SELECTION_SPTHRESHOLDOVER_FN + &quot;_&quot; + spQueue.getID().toString();</span>
<span class="fc" id="L298">			val =  request.getParameter(paramName);</span>
<span class="fc bfc" id="L299" title="All 2 branches covered.">			if (val != null) {</span>
<span class="fc" id="L300">				int iVal = Integer.parseInt(val);</span>
<span class="fc" id="L301">				spQueue.setFTEThresholdOver(iVal);</span>
			}

			//read the Threshold Over Type (if any) for this spqueue
<span class="fc" id="L305">			paramName = CampaignSPQueueUtil.SELECTION_SPTHRESHOLDOVERTYPE_FN + &quot;_&quot; + spQueue.getID().toString();</span>
<span class="fc" id="L306">			val =  request.getParameter(paramName);</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">			if (val != null) {</span>
<span class="fc" id="L308">				int iVal = Integer.parseInt(val);</span>
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">				spQueue.setFTEThresholdOverPercentage(iVal==1);</span>
			}

			//read the Threshold Under (if any) for this spqueue
<span class="fc" id="L313">			paramName = CampaignSPQueueUtil.SELECTION_SPTHRESHOLDUNDER_FN + &quot;_&quot; + spQueue.getID().toString();</span>
<span class="fc" id="L314">			val =  request.getParameter(paramName);</span>
<span class="fc bfc" id="L315" title="All 2 branches covered.">			if (val != null) {</span>
<span class="fc" id="L316">				int iVal = Integer.parseInt(val);</span>
<span class="fc" id="L317">				spQueue.setFTEThresholdUnder(iVal);</span>
			}
			
			//read the Threshold Under Type (if any) for this spqueue
<span class="fc" id="L321">			paramName = CampaignSPQueueUtil.SELECTION_SPTHRESHOLDUNDERTYPE_FN + &quot;_&quot; + spQueue.getID().toString();</span>
<span class="fc" id="L322">			val =  request.getParameter(paramName);</span>
<span class="fc bfc" id="L323" title="All 2 branches covered.">			if (val != null) {</span>
<span class="fc" id="L324">				int iVal = Integer.parseInt(val);</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">				spQueue.setFTEThresholdUnderPercentage(iVal==1);</span>
			}
			
			//add all the spqueues to our map, which is needed for saving
<span class="fc" id="L329">			spQueueToSkillsMap.put(spQueue, col);</span>
<span class="fc" id="L330">		}</span>

<span class="fc" id="L332">		return result;</span>
	}
	
	public HashMap&lt;SPQueue, Collection&lt;ID&gt;&gt; getSkillForSPQueues() {
<span class="fc" id="L336">		return spQueueToSkillsMap;</span>
	}

	private ArrayList&lt;StringsPair&gt; getSkills (Collection&lt;Skill&gt; skills, ID mediaID) {
<span class="fc" id="L340">		ArrayList&lt;StringsPair&gt; colls = new ArrayList&lt;StringsPair&gt;();</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">		if (skills != null){</span>
			//create a Media ID that matches the format of MediaID from Skill
<span class="fc" id="L343">			String strID = Skill.convertMediaID2str(mediaID);</span>
<span class="fc" id="L344">			ID mediaID2 = new ID(strID);</span>
<span class="fc bfc" id="L345" title="All 2 branches covered.">			for(Skill skill: skills) {</span>
<span class="fc bfc" id="L346" title="All 2 branches covered.">				if (skill.getMediaID().equals(mediaID2)) {</span>
<span class="fc" id="L347">					ID id  = (ID)skill.getFieldValue(SkillFieldInfo.SKILL_SID);</span>
<span class="fc" id="L348">					colls.add(new StringsPair(id.toString(), skill.getName()));</span>
				}
<span class="fc" id="L350">			}</span>
		}
<span class="fc" id="L352">		ID newID = new ID(-1);</span>
<span class="fc" id="L353">		colls.add(new StringsPair(newID.toString(),&quot;&quot;));</span>
<span class="fc" id="L354">		return colls;</span>
	}

	private String getQueueTypeString(int queueType) {
<span class="fc" id="L358">		StringBuffer sb = new StringBuffer(1024);</span>
<span class="pc bpc" id="L359" title="2 of 5 branches missed.">		switch (queueType) {</span>
			case Queue.QUEUE_TYPE_NORMAL:
<span class="fc" id="L361">			    sb.append(HtmlEncoder.encode(m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_TYPE_NORMAL)));</span>
<span class="fc" id="L362">			    break;</span>
			case Queue.QUEUE_TYPE_VIRTUAL:
<span class="fc" id="L364">			    sb.append(HtmlEncoder.encode(m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_TYPE_VIRTUAL)));</span>
<span class="fc" id="L365">			    break;</span>
			case Queue.QUEUE_TYPE_DISTRIBUTED:
<span class="fc" id="L367">			    sb.append(HtmlEncoder.encode(m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_TYPE_DISTRIBUTED)));</span>
<span class="fc" id="L368">			    break;</span>
			case Queue.QUEUE_TYPE_PROCESS:
<span class="nc" id="L370">				sb.append(HtmlEncoder.encode(m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_TYPE_PROCESS)));</span>
			    break;
		}
<span class="fc" id="L373">		return sb.toString();</span>
	}

	public LinkedHashMap&lt;DBSortField, Comparator&gt; getSortComparators() {
<span class="fc" id="L377">		LinkedHashMap&lt;DBSortField, Comparator&gt; comparators =</span>
			new LinkedHashMap&lt;DBSortField, Comparator&gt;();
<span class="fc bfc" id="L379" title="All 2 branches covered.">		for (SPQueueSortField sortField : getDBSortFieldIndices()) {</span>
<span class="pc bpc" id="L380" title="5 of 7 branches missed.">			switch (sortField) {</span>
				case ID:
<span class="fc" id="L382">					comparators.put(SPQueueSortField.ID, null);</span>
<span class="fc" id="L383">					break;</span>
				case QUEUE_NAME:
<span class="fc" id="L385">					comparators.put(SPQueueSortField.QUEUE_NAME, null);</span>
<span class="fc" id="L386">					break;</span>
				case DESCRIPTION:
<span class="nc" id="L388">					comparators.put(SPQueueSortField.DESCRIPTION, null);</span>
<span class="nc" id="L389">					break;</span>
				case ORGANIZATION:
<span class="nc" id="L391">					comparators.put(SPQueueSortField.ORGANIZATION, null);</span>
<span class="nc" id="L392">					break;</span>
				case MEDIA:
<span class="nc" id="L394">					comparators.put(SPQueueSortField.MEDIA, null);</span>
<span class="nc" id="L395">					break;</span>
				case TYPE:
<span class="nc" id="L397">					comparators.put(SPQueueSortField.TYPE, new QueueTypeComparator(m_localizer));</span>
					break;
			}
<span class="fc" id="L400">		}</span>
		
<span class="fc" id="L402">		return comparators;</span>
	}
	
	public ArrayList&lt;SPQueueSortField&gt; getDBSortFieldIndices() {
<span class="fc" id="L406">		ArrayList&lt;SPQueueSortField&gt; retVal = new ArrayList&lt;SPQueueSortField&gt;();</span>
<span class="fc bfc" id="L407" title="All 2 branches covered.">		if (getHeader().getSortColumnIndexes() == null) {</span>
			//Default sort index is by ID (chronological order in which sp queue was created)
<span class="fc" id="L409">			retVal.add(SPQueueSortField.ID);</span>
		} else {
<span class="fc bfc" id="L411" title="All 2 branches covered.">			for (int sortField : getHeader().getSortColumnIndexes()) {</span>
<span class="pc bpc" id="L412" title="5 of 6 branches missed.">				switch (sortField) {</span>
					case 0: 
<span class="fc" id="L414">						retVal.add(SPQueueSortField.QUEUE_NAME);</span>
<span class="fc" id="L415">						break;</span>
					case 1: 
<span class="nc" id="L417">						retVal.add(SPQueueSortField.DESCRIPTION);</span>
<span class="nc" id="L418">						break;</span>
					case 2: 
<span class="nc" id="L420">						retVal.add(SPQueueSortField.ORGANIZATION);</span>
<span class="nc" id="L421">						break;</span>
					case 3: 
<span class="nc" id="L423">						retVal.add(SPQueueSortField.MEDIA);</span>
<span class="nc" id="L424">						break;</span>
					case 4: 
<span class="nc" id="L426">						retVal.add(SPQueueSortField.TYPE);</span>
						break;
				}
			}
		}		
<span class="fc" id="L431">		return retVal;</span>
	}
	
	/**
	 * We want to warn the user before they change the sort order
	 * that they may lose their changes if the page is dirty.
	 */
	private String getOnClickJSForSortColumnHeader(String headerName) {
<span class="fc" id="L439">		return &quot;if (&quot; + JSUtil.APP_MEDIATOR_REF + &quot;.confirmLoseChanges()) &quot; +</span>
			JSUtil.PAGE_MEDIATOR_REF + &quot;.submitToolbarAction(&quot; + headerName + &quot;, true );&quot;;
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>