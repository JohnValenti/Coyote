<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeSeriesReportFacadeManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.timeseries.ejb</a> &gt; <span class="el_source">TimeSeriesReportFacadeManagerEJB.java</span></div><h1>TimeSeriesReportFacadeManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.timeseries.ejb;

import java.rmi.RemoteException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;

import javax.naming.Context;
import javax.naming.InitialContext;

import com.bluepumpkin.common.config.ConfigManager;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.audit.model.AuditTrailEntry;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignQueue;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.config.ejb.DBConfigManager;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbLogBundleKey;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.verint.ejb.wfm.WfmManagerFactory;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  TimeSeriesReportFacadeManagerEJB EJB implementation
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, inc
 *
 * @author Sheng Song
 * @version 2.0
 */

<span class="nc" id="L50">public class TimeSeriesReportFacadeManagerEJB extends SessionEJBBase {</span>
	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;

<span class="nc" id="L56">	private static Category m_cat = Log.initCategory(TimeSeriesReportFacadeManagerEJB.class.getName());</span>

	private TimeSeriesReportDumpManager m_TimeSeriesReportDumpManager;
	private WorkloadManager m_WorkloadManager;
	private CampaignManager m_CampaignManager;
	private DBConfigManager m_dbConfigManager;

<span class="nc" id="L63">	private static int LOOKBACKMONTH = 2;</span>
<span class="nc" id="L64">	private static int LOOKFORWARDMONTH = 2;</span>


	// override the base class to provide the appropriate logging category
<span class="nc" id="L68">	protected Category getCategory() { return m_cat; }</span>

	{
<span class="nc" id="L71">		super.init(TimeSeriesReportFacadeManagerEJB.class.getName());</span>
	}

<span class="nc" id="L74">	private boolean WhatIfMode = false;</span>

	public void ejbCreate() {
		try {
			// First query environment to get WIF setting from DD
<span class="nc" id="L79">			Context initialContext = new InitialContext();</span>
<span class="nc" id="L80">			Boolean WIF = (Boolean) initialContext.lookup(&quot;java:comp/env/WIF&quot;);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">			if (WIF != null)</span>
<span class="nc" id="L82">				WhatIfMode = WIF.booleanValue();</span>
<span class="nc" id="L83">			m_TimeSeriesReportDumpManager = BbmManagerFactory.getTimeSeriesReportManager(WhatIfMode);</span>
<span class="nc" id="L84">			m_WorkloadManager = WfmManagerFactory.getWorkloadManager(WhatIfMode);</span>
<span class="nc" id="L85">			m_CampaignManager = WfmManagerFactory.getCampaignManager(WhatIfMode);</span>
<span class="nc" id="L86">			m_dbConfigManager = BbmManagerFactory.getDBConfigManager(WhatIfMode);</span>
<span class="nc" id="L87">			String lookBack = BbmManagerFactory.getDBConfigManager(WhatIfMode).getValue(&quot;PERFREPORTLOOKBACK&quot;);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">			if (lookBack != null) {</span>
				try {
<span class="nc" id="L90">					LOOKBACKMONTH = Integer.parseInt(lookBack);</span>
<span class="nc" id="L91">				} catch (Exception e) {</span>
<span class="nc" id="L92">					m_cat.info(&quot;Invalid value set for LookBackMonth, &quot; + lookBack);</span>
<span class="nc" id="L93">				}</span>
			}
<span class="nc" id="L95">		} catch (Exception e) {</span>
<span class="nc" id="L96">			handleException(&quot;ejbCreate&quot;, e);</span>
<span class="nc" id="L97">		}</span>
<span class="nc" id="L98">	}</span>

	private boolean isMultiVQCampaign(ID cpgID, ID mediaID, Date start, Date end) throws BbmFinderException, RemoteException {
<span class="nc" id="L101">		Collection subCpg = m_CampaignManager.getSubCampaignIDs(cpgID);</span>
<span class="nc" id="L102">		ID realMediaID = null;</span>
<span class="nc bnc" id="L103" title="All 4 branches missed.">		if (mediaID != null &amp;&amp; mediaID.equals(new ID(-10)))</span>
<span class="nc" id="L104">			realMediaID = null;</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">		if (subCpg.isEmpty()) {</span>
			// if the Campaign has DQ/VQ, still a multi-site case
<span class="nc" id="L107">			boolean hasDistributedQueue = false;</span>
<span class="nc" id="L108">			Collection queueAssignment = m_CampaignManager.getCampaignQueueAssignments(cpgID, realMediaID, start, end);</span>
<span class="nc" id="L109">			HashSet queueSet = new HashSet();</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">			for (Iterator it = queueAssignment.iterator(); it.hasNext();) {</span>
<span class="nc" id="L111">				CampaignQueue cq = (CampaignQueue) it.next();</span>
<span class="nc" id="L112">				ID qID = cq.getQueueID();</span>
<span class="nc" id="L113">				queueSet.add(qID);</span>
<span class="nc" id="L114">			}</span>
<span class="nc" id="L115">			Collection qs = m_WorkloadManager.getQueuesByIDs(queueSet);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">			for (Iterator it = qs.iterator(); it.hasNext();) {</span>
<span class="nc" id="L117">				Queue q = (Queue) it.next();</span>
<span class="nc bnc" id="L118" title="All 4 branches missed.">				if (q.getQueueType() == Queue.QUEUE_TYPE_DISTRIBUTED || q.getQueueType() == Queue.QUEUE_TYPE_VIRTUAL) {</span>
<span class="nc" id="L119">					hasDistributedQueue = true;</span>
<span class="nc" id="L120">					break;</span>
				}
<span class="nc" id="L122">			}</span>
<span class="nc" id="L123">			return hasDistributedQueue;</span>
		}
<span class="nc" id="L125">		return true;</span>
	}

	/**
	 * Dump a Queue's TimeSeries into different schema for report
	 * It will dump all statistics, each 15 minutes per row
	 */
	public void dumpTimeSeries() throws BbmCreateException {
<span class="nc" id="L133">		methodStart(&quot;dumpTimeSeries&quot;);</span>
		// Determine the dump window as current date's 2 months back, and 2 month into future
		//Changes start for QA100626 starts
<span class="nc" id="L136">		int iLookForwardMonth=ConfigManager.NOVALUE;</span>
		try
		{
<span class="nc" id="L139">			iLookForwardMonth = BbmManagerFactory.getDBConfigManager().getIntValue(ConfigKey.CRYSTAL_REPORTS_TIMSERIES_LOOKFORWARD_MONTH);</span>
<span class="nc" id="L140">		}catch(Exception e)</span>
		{
<span class="nc" id="L142">			m_cat.debug(&quot;Exception while getting value for CRYSTAL_REPORTS_TIMSERIES_LOOKFORWARD_MONTH:&quot;+e);</span>
<span class="nc" id="L143">		}</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">		if (iLookForwardMonth != ConfigManager.NOVALUE)</span>
<span class="nc" id="L145">			LOOKFORWARDMONTH = iLookForwardMonth;</span>
<span class="nc" id="L146">		Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L147">		cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L148">		cal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L149">		cal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L150">		cal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L151">		cal.set(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L152">		cal.add(Calendar.MONTH, LOOKFORWARDMONTH);//QA100626</span>
<span class="nc" id="L153">		cal.add(Calendar.DAY_OF_MONTH, 2);</span>
<span class="nc" id="L154">		Date end = cal.getTime();</span>
<span class="nc" id="L155">		cal.add(Calendar.MONTH, -(LOOKFORWARDMONTH + LOOKBACKMONTH));//QA100626</span>
<span class="nc" id="L156">		cal.add(Calendar.DAY_OF_MONTH, -4);</span>
<span class="nc" id="L157">		Date start = cal.getTime();</span>
<span class="nc" id="L158">		dumpTimeSeries(start, end, true);</span>
<span class="nc" id="L159">	}</span>

	public void dumpTimeSeries(Date start, Date end) throws BbmCreateException {
<span class="nc" id="L162">		dumpTimeSeries(start, end, false);</span>
<span class="nc" id="L163">	}</span>

	private void dumpTimeSeries(Date start, Date end, boolean alwaysUpdateDumpLog) throws BbmCreateException {
<span class="nc" id="L166">		m_cat.info(&quot;start: dumpTimeSeries from &quot; + start + &quot; up to &quot; + end);</span>
<span class="nc" id="L167">		long timeSinceStart = new java.util.Date().getTime();</span>
<span class="nc" id="L168">		long maxDumpRangeInMilliSecs = (long) (TimeZoneUtil.DAY_IN_MILLISECONDS * getMaxRefreshDays());</span>
<span class="nc bnc" id="L169" title="All 4 branches missed.">		if (start == null &amp;&amp; end == null) {</span>
<span class="nc" id="L170">			return;</span>
		}
<span class="nc bnc" id="L172" title="All 2 branches missed.">		if (end == null) {</span>
<span class="nc" id="L173">			end = new Date(start.getTime() + maxDumpRangeInMilliSecs - 1);</span>
		}
<span class="nc bnc" id="L175" title="All 2 branches missed.">		if (start == null) {</span>
<span class="nc" id="L176">			start = new Date(end.getTime() - maxDumpRangeInMilliSecs + 1);</span>
		}
<span class="nc" id="L178">		Date chunkDumpTimeStart = new Date(start.getTime());</span>
<span class="nc" id="L179">		int count = 0;</span>
<span class="nc" id="L180">		HashMap queMediaMap = new HashMap();</span>
<span class="nc" id="L181">		HashMap mediaMap = new HashMap();</span>
<span class="nc" id="L182">		ArrayList exceptions = new ArrayList();</span>
		while (true) {
<span class="nc" id="L184">			Date chunkDumpTimeEnd = new Date(chunkDumpTimeStart.getTime() + maxDumpRangeInMilliSecs - 1);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">			if (chunkDumpTimeEnd.getTime() &gt; end.getTime()) {</span>
<span class="nc" id="L186">				chunkDumpTimeEnd = end;</span>
			}
<span class="nc" id="L188">			m_cat.info(&quot;Dumping  dumpSingleQueueTimeSeries chunk from:&quot; + chunkDumpTimeStart + &quot; up to &quot; + chunkDumpTimeEnd + &quot;;count=&quot; + (++count));</span>
<span class="nc" id="L189">			dumpSingleQueueTimeSeriesInChunk(chunkDumpTimeStart, chunkDumpTimeEnd, alwaysUpdateDumpLog, queMediaMap, mediaMap, exceptions, count);</span>
<span class="nc" id="L190">			chunkDumpTimeStart = new Date(chunkDumpTimeStart.getTime() + maxDumpRangeInMilliSecs);</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">			if (chunkDumpTimeStart.getTime() &gt; end.getTime()) {</span>
<span class="nc" id="L192">				break;</span>
			}
<span class="nc" id="L194">		}</span>
		
		//default value
<span class="nc" id="L197">		long combinedQChunkSize = getCombinedQChunkSize(maxDumpRangeInMilliSecs);</span>
<span class="nc" id="L198">		chunkDumpTimeStart = new Date(start.getTime());</span>
<span class="nc" id="L199">		count = 0;</span>
		while (true) {
<span class="nc" id="L201">			Date chunkDumpTimeEnd = new Date(chunkDumpTimeStart.getTime() + combinedQChunkSize - 1);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">			if (chunkDumpTimeEnd.getTime() &gt; end.getTime()) {</span>
<span class="nc" id="L203">				chunkDumpTimeEnd = end;</span>
			}
<span class="nc" id="L205">			m_cat.info(&quot;Dumping  dumpCombinedQueueTimeSeries chunk from:&quot; + chunkDumpTimeStart + &quot; up to &quot; + chunkDumpTimeEnd + &quot;;count=&quot; + (++count));</span>
<span class="nc" id="L206">			dumpCombinedQueueTimeSeriesInChunk(chunkDumpTimeStart, chunkDumpTimeEnd, alwaysUpdateDumpLog, queMediaMap, mediaMap, exceptions, count);</span>
<span class="nc" id="L207">			chunkDumpTimeStart = new Date(chunkDumpTimeStart.getTime() + combinedQChunkSize);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">			if (chunkDumpTimeStart.getTime() &gt; end.getTime()) {</span>
<span class="nc" id="L209">				break;</span>
			}
<span class="nc" id="L211">		}</span>
		
<span class="nc" id="L213">		m_cat.info(&quot;Exit: dumpTimeSeries from &quot; + start + &quot; up to &quot; + end + &quot; , time reqd=&quot; + (new java.util.Date().getTime() - timeSinceStart) / 60000 + &quot; Mins In &quot; + (count - 1) + &quot;chunk(s)&quot;);</span>
		
<span class="nc bnc" id="L215" title="All 2 branches missed.">		if (!exceptions.isEmpty()) {</span>
<span class="nc" id="L216">			BbmCreateException bce = new BbmCreateException(BbmEjbLogBundleKey.TIMESERIES_DUMP_FAIL);</span>
<span class="nc" id="L217">			bce.setContent(exceptions);</span>
<span class="nc" id="L218">			throw bce;</span>
		}
<span class="nc" id="L220">	}</span>

	private long getMaxRefreshDays() {
<span class="nc" id="L223">		int nReportMaxDataRefreshDays = 130;</span>
		try {
<span class="nc" id="L225">			nReportMaxDataRefreshDays = m_dbConfigManager.getIntValue(ConfigKey.REPORTS_TIMESERIES_MAX_REFRESH_DAYS);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">			if (nReportMaxDataRefreshDays &lt; 0) nReportMaxDataRefreshDays = 130;</span>
<span class="nc" id="L227">		} catch (Exception e) {</span>
<span class="nc" id="L228">			m_cat.debug(e);</span>
<span class="nc" id="L229">		}</span>
<span class="nc" id="L230">		return nReportMaxDataRefreshDays;</span>
	}
	
	private long getCombinedQChunkSize(long defaultValue) {
<span class="nc" id="L234">		long chunkSize = defaultValue;</span>
		try {
<span class="nc" id="L236">			int chunkInDays = m_dbConfigManager.getIntValue(ConfigKey.REPORTS_TIMESERIES_DUMP_COMBINEDQ_CHUNK_IN_DAYS);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">			if (chunkInDays &gt; 0) </span>
<span class="nc" id="L238">				chunkSize = (long) (TimeZoneUtil.DAY_IN_MILLISECONDS * chunkInDays);</span>
<span class="nc" id="L239">		} catch (Exception e) {</span>
<span class="nc" id="L240">			m_cat.debug(e);</span>
<span class="nc" id="L241">		}</span>
<span class="nc" id="L242">		return chunkSize;</span>
	}

	private boolean isForceDump24Hours() throws RemoteException
	{
<span class="nc" id="L247">		return m_dbConfigManager.getBooleanValue(ConfigKey.REPORTS_TIMESERIES_DUMP_24_HOURS); //&quot;bluepumpkin/report/TimeSeriesDump24Hours&quot;</span>
	}

	private void dumpSingleQueueTimeSeriesInChunk(Date start, Date end, boolean alwaysUpdateDumpLog, HashMap queMediaMap, HashMap mediaMap, ArrayList exceptions,int chunkCount) throws BbmCreateException {
<span class="nc" id="L251">		m_cat.info(&quot;ENTER: dumpSingleQueueTimeSeriesInChunk for &quot; + start + &quot; till &quot; + end);</span>
<span class="nc" id="L252">		long timeSinceStart = new java.util.Date().getTime();</span>
<span class="nc" id="L253">		int numberOfQueues = 0;</span>
<span class="nc" id="L254">		Date endTime = new Date();</span>
<span class="nc" id="L255">		String state = &quot;&quot;;</span>
		try {
			// Dump real queue first
<span class="nc" id="L258">			boolean forceDump24Hours = isForceDump24Hours();</span>
<span class="nc" id="L259">			Collection queCol = m_WorkloadManager.getAllQueues();</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">			for (Iterator it = queCol.iterator(); it.hasNext();) {</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">				if(m_dbConfigManager.isTemporarilyStopReportDump()){</span>
				    //stop report dump as is if this flag is set; tuser wants to suspend and start again.
<span class="nc" id="L263">					return;</span>
				}
<span class="nc" id="L265">				long timeAtLastRun = new java.util.Date().getTime();</span>
<span class="nc" id="L266">				Queue queue = (Queue) it.next();</span>
<span class="nc" id="L267">				queMediaMap.put(queue.getID(), queue.getMediaID());</span>
				// check the media of queue, if not email should consider HOO				
<span class="nc" id="L269">				Media media = (Media) mediaMap.get(queue.getMediaID());</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">				if (media == null) {</span>
<span class="nc" id="L271">					media = m_WorkloadManager.getMediaByID(queue.getMediaID());</span>
<span class="nc" id="L272">					mediaMap.put(queue.getMediaID(), media);</span>
				}

<span class="nc" id="L275">				boolean fixHOO = false;</span>
<span class="nc bnc" id="L276" title="All 4 branches missed.">				if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc" id="L277">					m_cat.debug(&quot;Queue &quot; + queue + &quot; is Immediate queue, with media id &quot; + queue.getMediaName());</span>
<span class="nc" id="L278">					fixHOO = true;</span>
				}
<span class="nc" id="L280">				m_cat.debug(&quot;Start: Dumping individual queue: &quot; + queue.getID() + &quot;, fixHOO is &quot; + fixHOO);</span>
				try {
<span class="nc" id="L282">					m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(null, null, queue.getID(), start, end, alwaysUpdateDumpLog, fixHOO);</span>
<span class="nc" id="L283">				} catch (Exception e) {</span>
<span class="nc" id="L284">					Pair pair = new Pair();</span>
<span class="nc" id="L285">					pair.setFirst(queue.getID());</span>
<span class="nc" id="L286">					pair.setSecond(e);</span>
<span class="nc" id="L287">					exceptions.add(pair);</span>
<span class="nc" id="L288">					m_cat.info(&quot;Fail: Dumping individual queue: &quot; + queue.getID() + &quot;, exception is &quot; + e);</span>
<span class="nc" id="L289">					continue;</span>
<span class="nc" id="L290">				}</span>
<span class="nc" id="L291">				m_cat.info(&quot;Complete: Dumping indvl queue: &quot; + queue.getID() + &quot;, fixHOO is &quot; + fixHOO + &quot; , time=&quot; + (new java.util.Date().getTime() - timeAtLastRun));</span>
<span class="nc" id="L292">				numberOfQueues++;</span>
<span class="nc" id="L293">			}</span>
<span class="nc" id="L294">			endTime = new java.util.Date();</span>
<span class="nc" id="L295">			m_cat.info(&quot;Complete: Dumping all queues: , time reqd=&quot; + (endTime.getTime() - timeSinceStart) / 60000 + &quot; Mins&quot;);</span>
<span class="nc" id="L296">			state = &quot;Succeeded&quot;;</span>
<span class="nc" id="L297">		} catch (Exception e) {</span>
<span class="nc" id="L298">			handleException(e);</span>
<span class="nc" id="L299">			state = &quot;Failed&quot;;</span>
<span class="nc" id="L300">			throw new BbmCreateException(e);</span>
		} finally {
			//Jdmo.enablePrintlog(false,false);
<span class="nc" id="L303">			m_cat.info(&quot;Exit: dumpSingleQueueTimeSeriesInChunk for &quot; + start + &quot; till &quot; + end + &quot; , time reqd=&quot; + (endTime.getTime() - timeSinceStart) / 60000 + &quot; Mins&quot;);</span>
<span class="nc" id="L304">			Map&lt;String, Object&gt; statsMap = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L305">			statsMap.put(&quot;jobStart&quot;, new Date(timeSinceStart));</span>
<span class="nc" id="L306">			statsMap.put(&quot;jobEnd&quot;, endTime);</span>
<span class="nc" id="L307">			statsMap.put(&quot;numberOfSomething&quot;, numberOfQueues);</span>
<span class="nc" id="L308">			statsMap.put(&quot;duration&quot;, (endTime.getTime() - timeSinceStart) / 60000);</span>
<span class="nc" id="L309">			statsMap.put(&quot;dumpWindowStart&quot;, start);</span>
<span class="nc" id="L310">			statsMap.put(&quot;dumpWindowEnd&quot;, end);</span>
<span class="nc" id="L311">			statsMap.put(&quot;chunkCount&quot;, chunkCount);</span>
<span class="nc" id="L312">			statsMap.put(&quot;state&quot;, state);</span>
<span class="nc" id="L313">			dumpStatsToAuditTable(AuditTrailEntry.ACTION_TS_QUEUE_DUMP, &quot;Time Series Dump: Queues&quot;, statsMap);</span>
<span class="nc" id="L314">			methodFinish();</span>
<span class="nc" id="L315">		}</span>
<span class="nc" id="L316">	}</span>
	
	protected void dumpStatsToAuditTable(short actionID, String primaryObjectName, Map statsMap)
	{
<span class="nc" id="L320">		Date jobStart = (Date)statsMap.get(&quot;jobStart&quot;);</span>
<span class="nc" id="L321">		Date jobEnd = (Date)statsMap.get(&quot;jobEnd&quot;);</span>
<span class="nc" id="L322">		int numberOfSomething = (Integer)statsMap.get(&quot;numberOfSomething&quot;);</span>
<span class="nc" id="L323">		long duration = (Long)statsMap.get(&quot;duration&quot;);</span>
<span class="nc" id="L324">		Date dumpWindowStart = (Date)statsMap.get(&quot;dumpWindowStart&quot;);</span>
<span class="nc" id="L325">		Date dumpWindowEnd = (Date)statsMap.get(&quot;dumpWindowEnd&quot;);</span>
<span class="nc" id="L326">		int numberOfChunks = (Integer)statsMap.get(&quot;chunkCount&quot;);</span>
<span class="nc" id="L327">		String jobStatus = (String)statsMap.get(&quot;state&quot;);</span>
<span class="nc" id="L328">		AuditTrailEntry entry = new AuditTrailEntry(</span>
				AuditTrailEntry.MODULE_ADAPTER,
				actionID,
				new ID(0),
				primaryObjectName,
				jobStart, jobEnd);
<span class="nc" id="L334">		SimpleDateFormat sdf = new SimpleDateFormat(&quot;MM/dd/yyyy HH:mm:ss&quot;);</span>
<span class="nc" id="L335">		entry.addProperty(&quot;Job Status&quot;, jobStatus, &quot;string&quot;, false);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">		if(actionID == AuditTrailEntry.ACTION_TS_QUEUE_DUMP) {</span>
<span class="nc" id="L337">			entry.addProperty(&quot;Number of Queues Dumped&quot;, &quot;&quot;+numberOfSomething, &quot;int&quot;, false);</span>
		}
<span class="nc bnc" id="L339" title="All 2 branches missed.">		if(actionID == AuditTrailEntry.ACTION_TS_CAMPAIGN_DUMP) {</span>
<span class="nc" id="L340">			entry.addProperty(&quot;Number of Campaigns&quot;, &quot;&quot;+numberOfSomething, &quot;int&quot;, false);</span>
		}
<span class="nc" id="L342">		entry.addProperty(&quot;Duration&quot;, &quot;&quot;+duration, &quot;minutes&quot;, false);</span>
<span class="nc" id="L343">		entry.addProperty(&quot;Timeframe&quot;, sdf.format(dumpWindowStart) + &quot; to &quot; + sdf.format(dumpWindowEnd), &quot;string&quot;, false);</span>
<span class="nc" id="L344">		entry.addProperty(&quot;Number of Chunks&quot;, &quot;&quot;+numberOfChunks, &quot;int&quot;, false);</span>
		try {
<span class="nc" id="L346">			BbmManagerFactory.getEventAuditTrailManager().createAuditEntry(entry);</span>
		}
<span class="nc" id="L348">		catch (Exception e) {</span>
<span class="nc" id="L349">			m_cat.warn(&quot;Exception occurred during Time Series Dump audit.&quot;);</span>
<span class="nc" id="L350">		}</span>
<span class="nc" id="L351">	}</span>
	private void dumpCombinedQueueTimeSeriesInChunk(Date start, Date end, boolean alwaysUpdateDumpLog, HashMap queMediaMap, HashMap mediaMap, ArrayList exceptions, int chunkCount)  throws BbmCreateException {
<span class="nc" id="L353">		m_cat.info(&quot;ENTER: dumpCombinedQueueTimeSeriesInChunk for &quot; + start + &quot; till &quot; + end);</span>
<span class="nc" id="L354">		long timeSinceStart = new java.util.Date().getTime();</span>
<span class="nc" id="L355">		int numberOfCampaigns = 0;</span>
<span class="nc" id="L356">		String state = &quot;&quot;;</span>
		try {
			// Dump Combined Queue
<span class="nc" id="L359">			boolean forceDump24Hours = isForceDump24Hours();</span>
<span class="nc" id="L360">			Collection cpgCol = m_CampaignManager.getCampaigns();</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">			for (Iterator it = cpgCol.iterator(); it.hasNext();) {</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">				if(m_dbConfigManager.isTemporarilyStopReportDump()){</span>
				    //stop report dump as is if this flag is set; tuser wants to suspend and start again.
<span class="nc" id="L364">					return;</span>
				}
<span class="nc" id="L366">				long timeAtLastRun = new java.util.Date().getTime();</span>
<span class="nc" id="L367">				Campaign cpg = (Campaign) it.next();</span>
				try {
<span class="nc" id="L369">					Collection queueAssignment = m_CampaignManager.getCampaignQueueAssignments(cpg.getID(), start, end);</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">					if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L371">						m_cat.debug(queueAssignment);</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">					if (queueAssignment.isEmpty())</span>
<span class="nc" id="L373">						continue;</span>
<span class="nc" id="L374">					HashMap spQMap = new HashMap();</span>
<span class="nc" id="L375">					HashMap spTimeRangeMap = new HashMap();</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">					for (Iterator qaIT = queueAssignment.iterator(); qaIT.hasNext();) {</span>
<span class="nc" id="L377">						CampaignQueue cq = (CampaignQueue) qaIT.next();</span>
<span class="nc" id="L378">						ID qID = cq.getQueueID();</span>
<span class="nc" id="L379">						ID spID = cq.getSPID();</span>
<span class="nc" id="L380">						ArrayList qCol = (ArrayList) spQMap.get(spID);</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">						if (qCol == null)</span>
<span class="nc" id="L382">							qCol = new ArrayList();</span>
<span class="nc" id="L383">						qCol.add(qID);</span>
<span class="nc" id="L384">						spQMap.put(spID, qCol);</span>
<span class="nc" id="L385">						Date[] timeRange = (Date[]) spTimeRangeMap.get(spID);</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">						if (timeRange == null) {</span>
<span class="nc" id="L387">							timeRange = new Date[2];</span>
<span class="nc" id="L388">							timeRange[0] = cq.getStartTime();</span>
<span class="nc" id="L389">							timeRange[1] = cq.getEndTime();</span>
<span class="nc" id="L390">							spTimeRangeMap.put(spID, timeRange);</span>
						}
<span class="nc" id="L392">					}</span>
<span class="nc" id="L393">					HashSet mediaSet = new HashSet();</span>
<span class="nc" id="L394">					HashSet allMediaSet = new HashSet();</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">					if (!spQMap.isEmpty()) {</span>
<span class="nc" id="L396">						Iterator spIT = spQMap.keySet().iterator();</span>
<span class="nc" id="L397">						ID spID = (ID) spIT.next();</span>
<span class="nc" id="L398">						ArrayList qCol = (ArrayList) spQMap.get(spID);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">						for (Iterator qIT = qCol.iterator(); qIT.hasNext();) {</span>
<span class="nc" id="L400">							mediaSet.add(queMediaMap.get(qIT.next()));</span>
						}
<span class="nc" id="L402">						allMediaSet.addAll(mediaSet);</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">						while (spIT.hasNext()) {</span>
<span class="nc" id="L404">							spID = (ID) spIT.next();</span>
<span class="nc" id="L405">							qCol = (ArrayList) spQMap.get(spID);</span>
<span class="nc" id="L406">							HashSet nextMediaSet = new HashSet();</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">							for (Iterator qIT = qCol.iterator(); qIT.hasNext();) {</span>
<span class="nc" id="L408">								nextMediaSet.add(queMediaMap.get(qIT.next()));</span>
							}
	
<span class="nc" id="L411">							allMediaSet.addAll(nextMediaSet);</span>
<span class="nc" id="L412">						}</span>
					}
					// if no media change, dump for whole window, no need to do it per sp
<span class="nc bnc" id="L415" title="All 2 branches missed.">					if (allMediaSet.size() == 1) {</span>
<span class="nc" id="L416">						ID dumpMediaID = (ID) allMediaSet.iterator().next();</span>
<span class="nc" id="L417">						Media media = (Media) mediaMap.get(dumpMediaID);</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">						if (media == null) {</span>
<span class="nc" id="L419">							media = m_WorkloadManager.getMediaByID(dumpMediaID);</span>
<span class="nc" id="L420">							mediaMap.put(dumpMediaID, media);</span>
						}
<span class="nc" id="L422">						boolean fixHOO = false;</span>
<span class="nc bnc" id="L423" title="All 4 branches missed.">						if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc" id="L424">							m_cat.debug(&quot;Campaign &quot; + cpg.getID() + &quot; has only Immediate queue, with media id &quot; + dumpMediaID);</span>
	
<span class="nc" id="L426">							fixHOO = true;</span>
						}
<span class="nc" id="L428">						boolean multiSite = isMultiVQCampaign(cpg.getID(), dumpMediaID, start, end);</span>
<span class="nc" id="L429">						m_cat.info(&quot;Start: Dumping campaign: &quot; + cpg.getID() + &quot;, has SubCampaigns or VQ&quot; + multiSite + &quot;, for media: &quot; + dumpMediaID);</span>
						// if only one media, no need for combined combined queue
<span class="nc bnc" id="L431" title="All 2 branches missed.">						if (multiSite) {</span>
<span class="nc" id="L432">							m_TimeSeriesReportDumpManager.dumpMultiSiteTimeSeriesFromLastDump(cpg.getID(), dumpMediaID, start, end, fixHOO);//QC77534 dumping Subqueue and VQ as well</span>
						} else {
<span class="nc" id="L434">							m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(cpg.getID(), dumpMediaID, null, start, end, alwaysUpdateDumpLog, fixHOO);</span>
						}
<span class="nc" id="L436">					} else {</span>
<span class="nc" id="L437">						boolean fixHOO = false;</span>
						// if different media immediate type found in campaign, won't fixHOO
<span class="nc" id="L439">						boolean immediateQueue = false;</span>
<span class="nc" id="L440">						boolean nonImmQueue = false;</span>
						// if more than one media, dump each media, and combine combine, this may be optimized later by caching each media combine result
<span class="nc bnc" id="L442" title="All 2 branches missed.">						for (Iterator medIT = allMediaSet.iterator(); medIT.hasNext();) {</span>
<span class="nc" id="L443">							ID dumpMediaID = (ID) medIT.next();</span>
<span class="nc" id="L444">							Media media = (Media) mediaMap.get(dumpMediaID);</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">							if (media == null) {</span>
<span class="nc" id="L446">								media = m_WorkloadManager.getMediaByID(dumpMediaID);</span>
<span class="nc" id="L447">								mediaMap.put(dumpMediaID, media);</span>
							}
<span class="nc bnc" id="L449" title="All 4 branches missed.">							if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">								if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L451">									m_cat.debug(&quot;Campaign &quot; + cpg.getID() + &quot; has only Immediate queue, with media id &quot; + dumpMediaID);</span>
								}
<span class="nc" id="L453">								fixHOO = true;</span>
<span class="nc" id="L454">								immediateQueue = true;</span>
							} else {
<span class="nc" id="L456">								nonImmQueue = true;</span>
							}
<span class="nc" id="L458">							boolean multiSite = isMultiVQCampaign(cpg.getID(), dumpMediaID, start, end);</span>
<span class="nc" id="L459">							m_cat.info(&quot;Start: Dumping campaign: &quot; + cpg.getID() + &quot;, has SubCampaigns or VQ&quot; + multiSite + &quot;, for media: &quot; + dumpMediaID);</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">							if (multiSite) {</span>
<span class="nc" id="L461">								m_TimeSeriesReportDumpManager.dumpMultiSiteTimeSeriesFromLastDump(cpg.getID(), dumpMediaID, start, end, fixHOO);//QC77534 dumping Subqueue and VQ as well</span>
							} else {
<span class="nc" id="L463">								m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(cpg.getID(), dumpMediaID, null, start, end, alwaysUpdateDumpLog, fixHOO);</span>
							}
<span class="nc" id="L465">						}</span>
<span class="nc bnc" id="L466" title="All 4 branches missed.">						if (immediateQueue &amp;&amp; nonImmQueue)</span>
<span class="nc" id="L467">							fixHOO = false;</span>
<span class="nc" id="L468">						boolean multiSite = isMultiVQCampaign(cpg.getID(), null, start, end);</span>
<span class="nc" id="L469">						m_cat.info(&quot;Start: Dumping campaign: &quot; + cpg.getID() + &quot;, has SubCampaigns or VQ&quot; + multiSite + &quot;, for Combine All.&quot;);</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">						if (multiSite) {</span>
<span class="nc" id="L471">							m_TimeSeriesReportDumpManager.dumpMultiSiteTimeSeriesFromLastDump(cpg.getID(), null, start, end, fixHOO);//QC77534 dumping Subqueue and VQ as well</span>
						} else {
<span class="nc" id="L473">							m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(cpg.getID(), null, null, start, end, alwaysUpdateDumpLog, fixHOO);</span>
						}
					}
<span class="nc" id="L476">				} catch (Exception e) {</span>
<span class="nc" id="L477">					Pair pair = new Pair();</span>
<span class="nc" id="L478">					pair.setFirst(cpg.getID());</span>
<span class="nc" id="L479">					pair.setSecond(e);</span>
<span class="nc" id="L480">					exceptions.add(pair);</span>
<span class="nc" id="L481">					m_cat.info(&quot;Fail: Dumping campaign queue: &quot; + cpg.getID() + &quot;, with exception &quot; + e);</span>
<span class="nc" id="L482">					continue;</span>
<span class="nc" id="L483">				}</span>
<span class="nc" id="L484">				m_cat.info(&quot;Complete: Dumping campaign queue: &quot; + cpg.getID() + &quot; , time=&quot; + (new java.util.Date().getTime() - timeAtLastRun));</span>
<span class="nc" id="L485">				numberOfCampaigns++;</span>
<span class="nc" id="L486">			}</span>
<span class="nc" id="L487">			state = &quot;Succeeded&quot;;</span>
<span class="nc" id="L488">		} catch (Exception e) {</span>
<span class="nc" id="L489">			state = &quot;Failed&quot;;</span>
<span class="nc" id="L490">			handleException(e);</span>
<span class="nc" id="L491">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L493">			Date endTime = new java.util.Date();</span>
<span class="nc" id="L494">			m_cat.info(&quot;Complete: Dumping all queues: , time reqd=&quot; + (endTime.getTime() - timeSinceStart) / 60000 + &quot; Mins&quot;);</span>
<span class="nc" id="L495">			Map&lt;String, Object&gt; statsMap = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L496">			statsMap.put(&quot;jobStart&quot;, new Date(timeSinceStart));</span>
<span class="nc" id="L497">			statsMap.put(&quot;jobEnd&quot;, endTime);</span>
<span class="nc" id="L498">			statsMap.put(&quot;numberOfSomething&quot;, numberOfCampaigns);</span>
<span class="nc" id="L499">			statsMap.put(&quot;duration&quot;, (endTime.getTime() - timeSinceStart) / 60000);</span>
<span class="nc" id="L500">			statsMap.put(&quot;dumpWindowStart&quot;, start);</span>
<span class="nc" id="L501">			statsMap.put(&quot;dumpWindowEnd&quot;, end);</span>
<span class="nc" id="L502">			statsMap.put(&quot;chunkCount&quot;, chunkCount);</span>
<span class="nc" id="L503">			statsMap.put(&quot;state&quot;, state);</span>
<span class="nc" id="L504">			dumpStatsToAuditTable(AuditTrailEntry.ACTION_TS_CAMPAIGN_DUMP, &quot;Time Series Dump: Campaigns&quot;, statsMap);</span>
			//Jdmo.enablePrintlog(false,false);
<span class="nc" id="L506">			m_cat.info(&quot;Exit: dumpCombinedQueueTimeSeriesInChunk for &quot; + start + &quot; till &quot; + end + &quot; , time reqd=&quot; + (new java.util.Date().getTime() - timeSinceStart) / 60000 + &quot; Mins&quot;);</span>
<span class="nc" id="L507">			methodFinish();</span>
<span class="nc" id="L508">		}</span>
<span class="nc" id="L509">	}</span>

	/**
	 * Dump a Queue's TimeSeries into different schema for report
	 * It will dump all statistics, each 15 minutes per row
	 * for a given queue ID collection, for a given period(can be ambiguous)
	 * Mostly used by Ad-Hoc report dump
	 *
	 * @param ID          campaignID
	 * @param ID          mediaID
	 * @param Collection, ID collection
	 * @param Date,       start
	 * @param Date,       end
	 */
	public void dumpTimeSeries(ID campaignID, ID mediaID, Collection queueIDCol, Date start, Date end) throws BbmCreateException {
<span class="nc" id="L524">		methodStart(&quot;dumpTimeSeries&quot;, campaignID, mediaID, queueIDCol, start, end);</span>
		try {
<span class="nc" id="L526">			boolean forceDump24Hours = isForceDump24Hours();</span>
<span class="nc bnc" id="L527" title="All 4 branches missed.">			if (queueIDCol != null &amp;&amp; !queueIDCol.isEmpty()) {</span>
<span class="nc" id="L528">				HashMap mediaMap = new HashMap();</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">				for (Iterator it = queueIDCol.iterator(); it.hasNext();) {</span>
<span class="nc" id="L530">					ID id = (ID) it.next();</span>
<span class="nc" id="L531">					Queue queue = m_WorkloadManager.getQueueByID(id);</span>
<span class="nc" id="L532">					Media media = (Media) mediaMap.get(queue.getMediaID());</span>
<span class="nc" id="L533">					boolean fixHOO = false;</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">					if (media == null) {</span>
<span class="nc" id="L535">						media = m_WorkloadManager.getMediaByID(queue.getMediaID());</span>
<span class="nc" id="L536">						mediaMap.put(queue.getMediaID(), media);</span>
					}
<span class="nc bnc" id="L538" title="All 4 branches missed.">					if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">						if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L540">							m_cat.debug(&quot;Queue &quot; + id + &quot; is Immediate queue, with media id &quot; + queue.getMediaID());</span>
						}
<span class="nc" id="L542">						fixHOO = true;</span>
					}
<span class="nc" id="L544">					m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(null, null, id, new Date(start.getTime() - TimeZoneUtil.HOUR_IN_MILLISECONDS_LONG), end, false, fixHOO);</span>
<span class="nc" id="L545">				}</span>
<span class="nc" id="L546">			} else {</span>
<span class="nc" id="L547">				boolean fixHOO = false;</span>
<span class="nc" id="L548">				boolean multiSite = isMultiVQCampaign(campaignID, mediaID, start, end);</span>
<span class="nc bnc" id="L549" title="All 4 branches missed.">				if (mediaID != null &amp;&amp; !mediaID.equals(new ID(-10))) {</span>
<span class="nc" id="L550">					Media media = m_WorkloadManager.getMediaByID(mediaID);</span>
<span class="nc bnc" id="L551" title="All 4 branches missed.">					if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">						if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L553">							m_cat.debug(&quot;CampaignID &quot; + campaignID + &quot; has immediate media id &quot; + mediaID);</span>
						}
<span class="nc" id="L555">						fixHOO = true;</span>
					}
<span class="nc" id="L557">				} else {</span>
					// it is for combined combined queue, which implies different medias queues under one campaign
					// need check each media's type
<span class="nc" id="L560">					Collection queueAssignment = m_CampaignManager.getCampaignQueueAssignments(campaignID, start, end);</span>
<span class="nc" id="L561">					HashSet queueSet = new HashSet();</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">					for (Iterator qaIT = queueAssignment.iterator(); qaIT.hasNext();) {</span>
<span class="nc" id="L563">						CampaignQueue cq = (CampaignQueue) qaIT.next();</span>
<span class="nc" id="L564">						ID qID = cq.getQueueID();</span>
<span class="nc" id="L565">						queueSet.add(qID);</span>
<span class="nc" id="L566">					}</span>
<span class="nc" id="L567">					HashMap mediaMap = new HashMap();</span>
<span class="nc" id="L568">					boolean immediateQueue = false;</span>
<span class="nc" id="L569">					boolean nonImmQueue = false;</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">					for (Iterator qIT = queueSet.iterator(); qIT.hasNext();) {</span>
<span class="nc" id="L571">						Queue queue = m_WorkloadManager.getQueueByID((ID) qIT.next());</span>
<span class="nc" id="L572">						Media media = (Media) mediaMap.get(queue.getMediaID());</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">						if (media == null) {</span>
<span class="nc" id="L574">							media = m_WorkloadManager.getMediaByID(queue.getMediaID());</span>
<span class="nc" id="L575">							mediaMap.put(queue.getMediaID(), media);</span>
						}
<span class="nc bnc" id="L577" title="All 4 branches missed.">						if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc" id="L578">							immediateQueue = true;</span>
<span class="nc" id="L579">							fixHOO = true;</span>
						} else {
<span class="nc" id="L581">							nonImmQueue = true;</span>
						}
<span class="nc" id="L583">					}</span>
<span class="nc bnc" id="L584" title="All 4 branches missed.">					if (immediateQueue &amp;&amp; nonImmQueue)</span>
<span class="nc" id="L585">						fixHOO = false;</span>
				}
<span class="nc bnc" id="L587" title="All 2 branches missed.">				if (m_cat.isDebugEnabled()) {</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">					m_cat.debug(&quot;Dump CampaignID &quot; + campaignID + &quot; with Media ID: &quot; + mediaID == null ? &quot;null&quot; : mediaID + &quot;, with has SubCampaigns or VQ: &quot; + multiSite + &quot;, has immediate media id &quot; + mediaID);</span>
				}
<span class="nc bnc" id="L590" title="All 2 branches missed.">				if (multiSite) {</span>
<span class="nc" id="L591">					m_TimeSeriesReportDumpManager.dumpMultiSiteTimeSeriesFromLastDump(campaignID, mediaID, new Date(start.getTime() - TimeZoneUtil.HOUR_IN_MILLISECONDS_LONG), end, fixHOO);</span>
				} else {
<span class="nc" id="L593">					m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(campaignID, mediaID, null, new Date(start.getTime() - TimeZoneUtil.HOUR_IN_MILLISECONDS_LONG), end, false, fixHOO);</span>
				}
			}
<span class="nc" id="L596">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L597">			handleException(e);</span>
<span class="nc" id="L598">			throw new BbmCreateException(e);</span>
<span class="nc" id="L599">		} catch (Exception e) {</span>
<span class="nc" id="L600">			handleException(e);</span>
<span class="nc" id="L601">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L603">			methodFinish();</span>
<span class="nc" id="L604">		}</span>
<span class="nc" id="L605">	}</span>

	/**
	 * Dump a Queue's TimeSeries into different schema for report
	 * It will dump given window, minus one month, and minus one year
	 * for a given queue ID collection, for a given period(can be ambiguous)
	 * Mostly used by Ad-Hoc report dump
	 *
	 * @param ID          campaignID
	 * @param ID          mediaID
	 * @param Collection, ID collection
	 * @param Date,       start
	 * @param Date,       end
	 */
	public void dumpMonthlyTimeSeries(ID campaignID, ID mediaID, Collection queueIDCol, Date start, Date end) throws BbmCreateException {
<span class="nc" id="L620">		methodStart(&quot;dumpMonthlyTimeSeries&quot;, campaignID, mediaID, queueIDCol, start, end);</span>
		try {
<span class="nc" id="L622">			boolean forceDump24Hours = isForceDump24Hours();</span>
<span class="nc" id="L623">			Date[] starts = new Date[]{start, null};</span>
<span class="nc" id="L624">			Date[] ends = new Date[]{end, null};</span>
			// the first dump window is the selected monthly plus previous monthly merged together
<span class="nc" id="L626">			starts[0] = new Date(start.getTime() - 32l * TimeZoneUtil.DAY_IN_MILLISECONDS);</span>
<span class="nc" id="L627">			starts[1] = new Date(start.getTime() - 367l * TimeZoneUtil.DAY_IN_MILLISECONDS);</span>
<span class="nc" id="L628">			ends[1] = new Date(end.getTime() - 363l * TimeZoneUtil.DAY_IN_MILLISECONDS);</span>
<span class="nc" id="L629">			HashMap mediaMap = new HashMap();</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">			for (int i = 0; i &lt; starts.length; i++) {</span>
<span class="nc bnc" id="L631" title="All 4 branches missed.">				if (queueIDCol != null &amp;&amp; !queueIDCol.isEmpty()) {</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">					for (Iterator it = queueIDCol.iterator(); it.hasNext();) {</span>
<span class="nc" id="L633">						ID id = (ID) it.next();</span>
<span class="nc" id="L634">						Queue queue = m_WorkloadManager.getQueueByID(id);</span>
<span class="nc" id="L635">						Media media = (Media) mediaMap.get(queue.getMediaID());</span>
<span class="nc" id="L636">						boolean fixHOO = false;</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">						if (media == null) {</span>
<span class="nc" id="L638">							media = m_WorkloadManager.getMediaByID(queue.getMediaID());</span>
<span class="nc" id="L639">							mediaMap.put(queue.getMediaID(), media);</span>
						}
<span class="nc bnc" id="L641" title="All 4 branches missed.">						if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">							if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L643">								m_cat.debug(&quot;Queue &quot; + id + &quot; is Immediate queue, with media id &quot; + queue.getMediaID());</span>
							}
<span class="nc" id="L645">							fixHOO = true;</span>
						}
<span class="nc" id="L647">						m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(null, null, id, starts[i], ends[i], false, fixHOO);</span>
<span class="nc" id="L648">					}</span>
				} else {
<span class="nc" id="L650">					boolean fixHOO = false;</span>
<span class="nc" id="L651">					boolean multiSite = isMultiVQCampaign(campaignID, mediaID, starts[i], ends[i]);</span>
<span class="nc bnc" id="L652" title="All 4 branches missed.">					if (mediaID != null &amp;&amp; !mediaID.equals(new ID(-10))) {</span>
<span class="nc" id="L653">						Media media = m_WorkloadManager.getMediaByID(mediaID);</span>
<span class="nc bnc" id="L654" title="All 4 branches missed.">						if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">							if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L656">								m_cat.debug(&quot;CampaignID &quot; + campaignID + &quot; has immediate media id &quot; + mediaID);</span>
							}
<span class="nc" id="L658">							fixHOO = true;</span>
						}
<span class="nc" id="L660">					} else {</span>
						// it is for combined combined queue, which implies different medias queues under one campaign
						// need check each media's type
<span class="nc" id="L663">						Collection queueAssignment = m_CampaignManager.getCampaignQueueAssignments(campaignID, starts[i], ends[i]);</span>
<span class="nc" id="L664">						HashSet queueSet = new HashSet();</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">						for (Iterator qaIT = queueAssignment.iterator(); qaIT.hasNext();) {</span>
<span class="nc" id="L666">							CampaignQueue cq = (CampaignQueue) qaIT.next();</span>
<span class="nc" id="L667">							ID qID = cq.getQueueID();</span>
<span class="nc" id="L668">							queueSet.add(qID);</span>
<span class="nc" id="L669">						}</span>
<span class="nc" id="L670">						boolean immediateQueue = false;</span>
<span class="nc" id="L671">						boolean nonImmQueue = false;</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">						for (Iterator qIT = queueSet.iterator(); qIT.hasNext();) {</span>
<span class="nc" id="L673">							Queue queue = m_WorkloadManager.getQueueByID((ID) qIT.next());</span>
<span class="nc" id="L674">							Media media = (Media) mediaMap.get(queue.getMediaID());</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">							if (media == null) {</span>
<span class="nc" id="L676">								media = m_WorkloadManager.getMediaByID(queue.getMediaID());</span>
<span class="nc" id="L677">								mediaMap.put(queue.getMediaID(), media);</span>
							}
<span class="nc bnc" id="L679" title="All 4 branches missed.">							if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc" id="L680">								immediateQueue = true;</span>
<span class="nc" id="L681">								fixHOO = true;</span>
							} else {
<span class="nc" id="L683">								nonImmQueue = true;</span>
							}
<span class="nc" id="L685">						}</span>
<span class="nc bnc" id="L686" title="All 4 branches missed.">						if (immediateQueue &amp;&amp; nonImmQueue)</span>
<span class="nc" id="L687">							fixHOO = false;</span>
					}
<span class="nc bnc" id="L689" title="All 2 branches missed.">					if (m_cat.isDebugEnabled()) {</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">						m_cat.debug(&quot;Dump CampaignID &quot; + campaignID + &quot; with Media ID: &quot; + mediaID == null ? &quot;null&quot; : mediaID + &quot;, with has SubCampaigns or VQ: &quot; + multiSite + &quot;, has immediate media id &quot; + mediaID);</span>
					}
<span class="nc bnc" id="L692" title="All 2 branches missed.">					if (multiSite) {</span>
<span class="nc" id="L693">						m_TimeSeriesReportDumpManager.dumpMultiSiteTimeSeriesFromLastDump(campaignID, mediaID, starts[i], ends[i], fixHOO);</span>
					} else {
<span class="nc" id="L695">						m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(campaignID, mediaID, null, starts[i], ends[i], false, fixHOO);</span>
					}
				}
			}
<span class="nc" id="L699">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L700">			handleException(e);</span>
<span class="nc" id="L701">			throw new BbmCreateException(e);</span>
<span class="nc" id="L702">		} catch (Exception e) {</span>
<span class="nc" id="L703">			handleException(e);</span>
<span class="nc" id="L704">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L706">			methodFinish();</span>
<span class="nc" id="L707">		}</span>
<span class="nc" id="L708">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>