<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ARParamPCUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignmentrules.ui</a> &gt; <span class="el_source">ARParamPCUtil.java</span></div><h1>ARParamPCUtil.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignmentrules.ui;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.base.BPException;
import com.bluepumpkin.common.datatypes.DayOfWeek;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.PaginationPair;
import com.bluepumpkin.common.datatypes.TimeOfDay;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftSortField;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler.ActivitySelectionProperty;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.core.pagecomponent.DropDownSelectionPC;
import com.verint.web.fs.widgets.ActivitySelectorDDPC;
import com.verint.web.fs.widgets.IntegerDropDownSelection;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.verint.web.fs.workrules.assignmentrules.DayOfWeekConstraint;
import com.verint.web.fs.workrules.assignmentrules.IntegerConstraint;
import com.verint.web.fs.workrules.assignmentrules.Response;
import com.verint.web.fs.workrules.assignmentrules.ResponseParam;
import com.verint.web.fs.workrules.assignmentrules.ResponseParamConstraint;
import com.verint.web.fs.workrules.assignmentrules.question.DefaultQuestionDataProvider;
import com.verint.web.fs.workrules.assignmentrules.question.Question;
import com.verint.web.fs.workrules.assignmentrules.question.QuestionFactory;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.TimePickerPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.TimeZoneOverrideUtil;

/**
 * This class helps deal with PageComponents representing parameter values.
 * 
 * It has utility functions for getting a PageComponent representing a parameter
 * and also for getting a submitted parameter value from the request.
 */
<span class="nc" id="L70">public class ARParamPCUtil {</span>
	/**
	 * Retrieves a PageComponent used to provide the value for a response parameter
	 * @param context
	 * @param orgID
	 * @param question
	 * @param response
	 * @param param
	 * @return
	 * @throws BbmException
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static PageComponent getPageComponent(RequestContext context, ID orgID, Question question,
			Response response, ResponseParam param) throws BbmException {
		try {
<span class="pc bpc" id="L85" title="2 of 7 branches missed.">			switch (param.getParameterType()) {</span>
			case Integer:
<span class="fc" id="L87">				Integer min = 0;</span>
<span class="fc" id="L88">				Integer max = 10000;</span>
<span class="fc" id="L89">				Iterator&lt;ResponseParamConstraint&gt; iter = param.getConstraints().iterator();</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">				if (iter.hasNext()) {</span>
<span class="fc" id="L91">					IntegerConstraint constraint = (IntegerConstraint) iter.next();</span>
<span class="fc" id="L92">					min = constraint.getMinVal();</span>
<span class="fc" id="L93">					max = constraint.getMaxVal();</span>
				}
<span class="fc" id="L95">				long spread = ((long) max) - min;</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">				if (spread &lt;= 100) {</span>
<span class="fc" id="L97">					IntegerDropDownSelection pc = new IntegerDropDownSelection(context, getName(response, param), min, max);</span>
<span class="fc" id="L98">					pc.setSelectedID(&quot;&quot; + param.getValue());</span>
<span class="fc" id="L99">					return pc;</span>
				} else {
					@SuppressWarnings(&quot;serial&quot;)
<span class="fc" id="L102">					FormInputPC integerInput = new FormInputPC(context) {</span>
						/**
						 * Overridden to disallow the extract params to overwrite the value with a null.
						 */
						@Override
						public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L108">							String oldVal = getInputValue();</span>
<span class="fc" id="L109">							boolean retVal = super.extractParameters(request);</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">							if (getInputValue() == null) {</span>
<span class="fc" id="L111">								setInputValue(oldVal);</span>
							}
<span class="fc" id="L113">							return retVal;</span>
						}
						
					};
<span class="fc" id="L117">					integerInput.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L118">					integerInput.setName(getName(response, param));</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">					integerInput.reset(getName(response, param) + &quot;__inputVal&quot;, param.getValue() == null ? &quot;1&quot; : param</span>
<span class="fc" id="L120">							.getValue()</span>
<span class="fc" id="L121">							.toString(), FormInputPC.TYPE_INTEGER, true);</span>
<span class="fc" id="L122">					integerInput.setLowerLimit(min);</span>
<span class="fc" id="L123">					integerInput.setUpperLimit(max);</span>
<span class="fc" id="L124">					return integerInput;</span>
				}
			case DayOfWeek:
<span class="fc" id="L127">				DropDownSelectionPC&lt;DayOfWeek&gt; dowPC = new DropDownSelectionPC&lt;DayOfWeek&gt;(context, getName(response, param));</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">				for (DayOfWeek dow : DayOfWeek.values()) {</span>
<span class="fc" id="L129">					addDayOfWeekDDOption(context.getLocalizer(), dowPC, dow);</span>
				}
<span class="fc" id="L131">				dowPC.setSelectedID(&quot;&quot; + param.getValue());</span>
<span class="fc" id="L132">				return dowPC;</span>
			case Shift: {
				@SuppressWarnings(&quot;rawtypes&quot;)
<span class="fc" id="L135">				LinkedHashMap&lt;DBSortField, Comparator&gt; sortComparators = new LinkedHashMap&lt;DBSortField, Comparator&gt;();</span>
<span class="fc" id="L136">				sortComparators.put(ShiftSortField.NAME, null);</span>
<span class="fc" id="L137">				Map&lt;ID, String&gt; shiftData = WorkRulesModelHandler.getShiftIDNameListByOrg(context, orgID);</span>
<span class="fc" id="L138">				shiftData = ValueObjectUtil.sortByValue(shiftData);</span>
<span class="fc" id="L139">				DropDownSelectionPC&lt;Shift&gt; shiftPC = new DropDownSelectionPC&lt;Shift&gt;(context, getName(response, param));</span>
<span class="fc" id="L140">				ID selectedID = null;</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">				if (param.getValue() != null)</span>
<span class="fc" id="L142">					selectedID = ((Shift) param.getValue()).getID();</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">				for (Map.Entry&lt;ID,String&gt; shiftIDName : shiftData.entrySet()) {</span>
<span class="fc" id="L144">					shiftPC.addOption(shiftIDName.getKey().toString(), shiftIDName.getValue(), null, shiftIDName.getKey().equals(selectedID));</span>
<span class="fc" id="L145">				}</span>
<span class="fc" id="L146">				return shiftPC;</span>
			}
			case Activities: {
<span class="fc" id="L149">				Collection&lt;Activity&gt; activities = </span>
<span class="fc" id="L150">					ActivityModelHandler.getActivitiesByActivitySelectionType(context, ActivitySelectionProperty.UsedInShiftEvent,</span>
<span class="fc" id="L151">						Collections.singletonList(orgID)); </span>
<span class="fc" id="L152">				ActivitySelectorDDPC activityPC = new ActivitySelectorDDPC(</span>
						context,
<span class="fc" id="L154">						getName(response, param),</span>
						activities);
<span class="fc" id="L156">				activityPC.setMultiSelect(true);</span>
<span class="fc" id="L157">				HashSet&lt;String&gt; selectedIDs = new HashSet&lt;String&gt;();</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">				if (param.getValue() != null) {</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">					for (Activity activity : (List&lt;Activity&gt;) param.getValue()) {</span>
<span class="fc" id="L160">						selectedIDs.add(activity.getID().toString());</span>
<span class="fc" id="L161">					}</span>
				}
<span class="fc" id="L163">				activityPC.setSelectedIDs(selectedIDs);</span>
<span class="fc" id="L164">				return activityPC;</span>
			}
			case Date: {
<span class="fc" id="L167">				DatePickerPC datePicker = new DatePickerPC(context, getName(response, param) + &quot;__INPUT_FN&quot;) {</span>
						/**
						 * Perform Extract parameter
						 */
						public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L172">							LocalDate initial = super.getLocalDate();</span>
<span class="fc" id="L173">							boolean isSuccess = super.extractParameters(request);</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">							if (getLocalDate() == null) setDate(initial);</span>
<span class="fc" id="L175">							return isSuccess;</span>
						}
				};

				// Normally, we would probably pick the org time zone, but in the case of Assignment Rules start dates, it is stored in the database in a weird way.
				// The &quot;day of the year&quot; is stored as a DATETIME as midnight in the GMT time zone. 
<span class="fc" id="L181">				datePicker.setTimeZone(TimeZoneUtil.GMT_TIMEZONE);</span>
				
<span class="fc" id="L183">				LocalDate val = (LocalDate) param.getValue();</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">				if (val != null) {</span>
<span class="fc" id="L185">					datePicker.setDate(val);</span>
				}
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">				if (param.getConstraints().size() &gt; 0) {</span>
<span class="fc" id="L188">					DayOfWeekConstraint dowC = (DayOfWeekConstraint) param.getConstraints().iterator().next();</span>
<span class="fc" id="L189">					datePicker.setFirstDayOfWeek(dowC.getDayOfWeek().getCalendarConstant());</span>
<span class="fc" id="L190">					List&lt;Integer&gt; disabledDays = new ArrayList&lt;Integer&gt;();</span>
<span class="fc" id="L191">					disabledDays.add(Calendar.SUNDAY);</span>
<span class="fc" id="L192">					disabledDays.add(Calendar.MONDAY);</span>
<span class="fc" id="L193">					disabledDays.add(Calendar.TUESDAY);</span>
<span class="fc" id="L194">					disabledDays.add(Calendar.WEDNESDAY);</span>
<span class="fc" id="L195">					disabledDays.add(Calendar.THURSDAY);</span>
<span class="fc" id="L196">					disabledDays.add(Calendar.FRIDAY);</span>
<span class="fc" id="L197">					disabledDays.add(Calendar.SATURDAY);</span>
<span class="fc" id="L198">					disabledDays.remove(Integer.valueOf(dowC.getDayOfWeek().getCalendarConstant()));</span>
<span class="fc" id="L199">					int[] disabledDaysArr = new int[disabledDays.size()];</span>
<span class="fc" id="L200">					int index = 0;</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">					for (int dayConstant : disabledDays) {</span>
<span class="fc" id="L202">						disabledDaysArr[index++] = dayConstant;</span>
<span class="fc" id="L203">					}</span>
<span class="fc" id="L204">					datePicker.setDisabledDays(disabledDaysArr);</span>
				}
<span class="fc" id="L206">				return datePicker;</span>
			}
			case TimeOfDay: {
<span class="nc" id="L209">				TimePickerPC timePicker = new TimePickerPC(context, getName(response, param) + &quot;__INPUT_FN&quot;, false);</span>
<span class="nc" id="L210">				TimeOfDay val = (TimeOfDay) param.getValue();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">				if (val != null) {</span>
<span class="nc" id="L212">					timePicker.setTime(0, val.getMinutesSinceMindnight(), 0);</span>
				}
<span class="nc" id="L214">				return timePicker;</span>
			}
			default:
<span class="nc" id="L217">				throw new IllegalArgumentException(&quot;Unexpected response param type of &quot; + param.getParameterType());</span>
			}
<span class="nc" id="L219">		} catch (RemoteException e) {</span>
<span class="nc" id="L220">			throw new BbmException(e);</span>
		}
	}

	/**
	 * Retrives the parameter value from the HttpServletRequest contained in the given request context.
	 * @param context
	 * @param orgID
	 * @param question
	 * @param response
	 * @param param
	 * @return Object representing the value of the parameter. The type is specified in the ResponseParamType enum. The ResponseParamType is retrieved through the ResponseParam.getParameterType method  
	 * @throws BbmException
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static Object getParameterValue(RequestContext context, ID orgID, Question question, Response response,
			ResponseParam param) throws BbmException {
<span class="fc" id="L237">		PageComponent pc = getPageComponent(context, orgID, question, response, param);</span>
<span class="fc" id="L238">		pc.extractParameters(context.getRequest());</span>
<span class="pc bpc" id="L239" title="2 of 7 branches missed.">		switch (param.getParameterType()) {</span>
		case Integer:
<span class="fc bfc" id="L241" title="All 2 branches covered.">			if (pc instanceof IntegerDropDownSelection)</span>
<span class="fc" id="L242">				return ((IntegerDropDownSelection) pc).getSelection();</span>
			else {
				// pc instanceof FormInputPC
<span class="fc" id="L245">				String inputVal = ((FormInputPC) pc).getInputValue();</span>
<span class="pc bpc" id="L246" title="2 of 4 branches missed.">				if (!StringUtil.isEmpty(inputVal) &amp;&amp; !&quot;null&quot;.equals(inputVal)) {</span>
<span class="fc" id="L247">					return Integer.parseInt(inputVal);</span>
				} else
<span class="nc" id="L249">					return 0;</span>
			}
		case DayOfWeek:
<span class="fc" id="L252">			return ((DropDownSelectionPC&lt;DayOfWeek&gt;) pc).getSelection();</span>
		case Shift:
<span class="fc" id="L254">			Collection&lt;String&gt; selectedIDs = ((DropDownSelectionPC&lt;Shift&gt;) pc).getSelectedIDs();</span>
<span class="pc bpc" id="L255" title="1 of 4 branches missed.">			if ( selectedIDs == null || selectedIDs.isEmpty()) {</span>
<span class="fc" id="L256">				return null;</span>
			}
<span class="fc" id="L258">			return WorkRulesModelHandler.getShift(context, new ID(Integer.parseInt(selectedIDs.iterator().next())));</span>
		case Activities:
<span class="fc" id="L260">			return ((ActivitySelectorDDPC) pc).getSelections();</span>
		case Date:
<span class="fc" id="L262">			LocalDate date = ((DatePickerPC) pc).getLocalDate();</span>
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">			if (date != null) {</span>
<span class="fc" id="L264">				date.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="fc" id="L265">				date.set(Calendar.MINUTE, 0);</span>
<span class="fc" id="L266">				date.set(Calendar.SECOND, 0);</span>
<span class="fc" id="L267">				date.set(Calendar.MILLISECOND, 0);</span>
			}
<span class="fc" id="L269">			return date;</span>
		case TimeOfDay:
<span class="nc" id="L271">			return new TimeOfDay(((TimePickerPC) pc).getTimeInMinutes());</span>
		default:
<span class="nc" id="L273">			throw new IllegalArgumentException(&quot;Unexpected response param type of &quot; + param.getParameterType());</span>
		}
	}

	private static void addDayOfWeekDDOption(Localizer localizer, DropDownSelectionPC&lt;DayOfWeek&gt; dowPC, DayOfWeek dow) {
<span class="fc bfc" id="L278" title="All 2 branches covered.">		if (dow == DayOfWeek.Sunday)</span>
<span class="fc" id="L279">			dowPC.addOption(</span>
<span class="fc" id="L280">					DayOfWeek.Sunday.name(),</span>
<span class="fc" id="L281">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.SUNDAY),</span>
					DayOfWeek.Sunday,
					false);
<span class="fc bfc" id="L284" title="All 2 branches covered.">		if (dow == DayOfWeek.Monday)</span>
<span class="fc" id="L285">			dowPC.addOption(</span>
<span class="fc" id="L286">					DayOfWeek.Monday.name(),</span>
<span class="fc" id="L287">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.MONDAY),</span>
					DayOfWeek.Monday,
					false);
<span class="fc bfc" id="L290" title="All 2 branches covered.">		if (dow == DayOfWeek.Tuesday)</span>
<span class="fc" id="L291">			dowPC.addOption(</span>
<span class="fc" id="L292">					DayOfWeek.Tuesday.name(),</span>
<span class="fc" id="L293">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.TUESDAY),</span>
					DayOfWeek.Tuesday,
					false);
<span class="fc bfc" id="L296" title="All 2 branches covered.">		if (dow == DayOfWeek.Wednesday)</span>
<span class="fc" id="L297">			dowPC.addOption(</span>
<span class="fc" id="L298">					DayOfWeek.Wednesday.name(),</span>
<span class="fc" id="L299">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.WEDNESDAY),</span>
					DayOfWeek.Wednesday,
					false);
<span class="fc bfc" id="L302" title="All 2 branches covered.">		if (dow == DayOfWeek.Thursday)</span>
<span class="fc" id="L303">			dowPC.addOption(</span>
<span class="fc" id="L304">					DayOfWeek.Thursday.name(),</span>
<span class="fc" id="L305">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.THURSDAY),</span>
					DayOfWeek.Thursday,
					false);
<span class="fc bfc" id="L308" title="All 2 branches covered.">		if (dow == DayOfWeek.Friday)</span>
<span class="fc" id="L309">			dowPC.addOption(</span>
<span class="fc" id="L310">					DayOfWeek.Friday.name(),</span>
<span class="fc" id="L311">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.FRIDAY),</span>
					DayOfWeek.Friday,
					false);
<span class="fc bfc" id="L314" title="All 2 branches covered.">		if (dow == DayOfWeek.Saturday)</span>
<span class="fc" id="L315">			dowPC.addOption(</span>
<span class="fc" id="L316">					DayOfWeek.Saturday.name(),</span>
<span class="fc" id="L317">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.SATURDAY),</span>
					DayOfWeek.Saturday,
					false);
<span class="fc" id="L320">	}</span>

	private static String getName(Response response, ResponseParam param) {
<span class="fc" id="L323">		int count = -1;</span>
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">		for (ResponseParam r : response.getResponseParameters()) {</span>
<span class="fc" id="L325">			count++;</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">			if (r == param)</span>
<span class="fc" id="L327">				break;</span>
<span class="fc" id="L328">		}</span>
<span class="fc" id="L329">		response.getResponseParameters().indexOf(param);</span>
<span class="fc" id="L330">		return response.getQuestionType().name() + &quot;_&quot; + response.getResponseType().toString() + &quot;_&quot;</span>
<span class="fc" id="L331">				+ param.getParameterType().name() + &quot;_&quot; + count;</span>
	}

	/**
	 * Returns the localized value of the response parameter.  In the form page, the response parameters
	 * are generally rendered as page components (input fields, date pickers, etc.) but on the list page
	 * the string representations of these values are concatenated with the responses to build a
	 * sentence-like description of the work rule.
	 */
	public static String getLocalizedParameterValue(Localizer localizer, ResponseParam param) {
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">		if (param.getValue() == null) return &quot;&quot;;</span>
<span class="pc bpc" id="L342" title="3 of 7 branches missed.">		switch (param.getParameterType()) {</span>
		case Integer:
<span class="fc" id="L344">				return localizer.formatNumber((Integer)param.getValue(), 0);</span>
		case DayOfWeek:
<span class="fc" id="L346">			return localizer.getWeekdayName((DayOfWeek)param.getValue(), true);</span>
		case Shift: {
<span class="fc" id="L348">			return ((Shift) param.getValue()).getName();</span>
		}
		case Activities: {
<span class="nc" id="L351">			StringBuffer activityList = new StringBuffer();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">			for (Activity activity : (List&lt;Activity&gt;) param.getValue()) {</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">				if (activityList.length() &gt; 0) {</span>
<span class="nc" id="L354">					activityList.append(&quot;, &quot;);</span>
				}
<span class="nc" id="L356">				activityList.append(activity.getName());</span>
<span class="nc" id="L357">			}</span>
<span class="nc" id="L358">			return activityList.toString();</span>
		}
		case Date: {
<span class="fc" id="L361">			return localizer.formatDate((LocalDate)param.getValue(), RegionalFormatBundleKey.MEDIUM_DATE_FORMAT);</span>
		}
		case TimeOfDay: {
<span class="nc" id="L364">			return localizer.formatTimeInMins(((TimeOfDay)param.getValue()).getMinutesSinceMindnight());</span>
		}
		default:
<span class="nc" id="L367">			throw new IllegalArgumentException(&quot;Unexpected response param type of &quot; + param.getParameterType());</span>
		}
	}
	
	/**
	 * Builds a sentence-like description for each of the given assignment rules and returns these descriptions in a map
	 * (this map is keyed on assignment rule ID).
	 */
	public static Map&lt;ID, String&gt; buildAssignmentRuleDescriptions(RequestContext context, Map&lt;ID, Organization&gt; orgMap,
			Collection&lt;ComplexWorkRule&gt; assignmentRules) throws BPException {

<span class="fc" id="L378">		HashMap&lt;ID, String&gt; retVal = new HashMap&lt;ID, String&gt;();</span>

		//Go through each rule and build the description for it
<span class="fc" id="L381">		Map&lt;ID, Map&lt;ID, String&gt;&gt; shiftIDMap = new HashMap&lt;ID, Map&lt;ID, String&gt;&gt;();</span>
<span class="fc" id="L382">		Map&lt;ID, String&gt; shiftIDMapPerOrg = null;</span>
<span class="fc" id="L383">		ID orgID = null;</span>
<span class="fc bfc" id="L384" title="All 2 branches covered.">		for (ComplexWorkRule cwr : assignmentRules) {</span>
<span class="fc" id="L385">			orgID = cwr.getOrganizationID();</span>
<span class="fc" id="L386">			shiftIDMapPerOrg = shiftIDMap.get(orgID);</span>
<span class="fc bfc" id="L387" title="All 2 branches covered.">			if (shiftIDMapPerOrg == null) {</span>
<span class="fc" id="L388">				shiftIDMapPerOrg = WorkRulesModelHandler.getShiftIDNameListByOrg(context, orgID);</span>
<span class="fc" id="L389">				shiftIDMap.put(orgID, shiftIDMapPerOrg);</span>
			}
<span class="fc" id="L391">			DefaultQuestionDataProvider provider = new DefaultQuestionDataProvider(context, orgMap.get(orgID), cwr, shiftIDMapPerOrg);</span>
<span class="fc" id="L392">			StringBuffer description = new StringBuffer();</span>

			//For each rule, go through each question and build the description from the response/response parameters.
<span class="fc" id="L395">			Question question = QuestionFactory.getNextQuestion(provider);</span>
<span class="fc" id="L396">			int questionCount = 0;</span>
<span class="pc bpc" id="L397" title="1 of 4 branches missed.">			while (question != null &amp;&amp; question.getInitialAnswer() != null) {</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">				if (description.length() &gt; 0) {</span>
<span class="fc" id="L399">					description.append(&quot; &quot;);</span>
				}
<span class="fc" id="L401">				provider.setAnswer(question.getQuestionType(), question.getInitialAnswer());</span>
				
				
<span class="fc" id="L404">				QuestionI18N i18n = QuestionI18NFactory.getI18NInfo(question.getQuestionType());</span>
	
<span class="fc" id="L406">				Response answerToSelect = question.getInitialAnswer(); </span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">				for (Response response : question.getResponses()) {</span>
					// Get the values of the response parameters for the answer
<span class="fc bfc" id="L409" title="All 2 branches covered.">					if (response.equals(answerToSelect)) {</span>
<span class="fc" id="L410">						List&lt;String&gt; paramValues = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L411" title="All 2 branches covered.">						for (ResponseParam param : response.getResponseParameters()) {</span>
<span class="fc" id="L412">							paramValues.add(ARParamPCUtil.getLocalizedParameterValue(context.getLocalizer(), param));</span>
<span class="fc" id="L413">						}</span>
<span class="fc" id="L414">						description.append(i18n.getResponseText(context.getLocalizer(), response, paramValues.toArray()));</span>
<span class="fc" id="L415">						break;</span>
					}
<span class="fc" id="L417">				}</span>
				
<span class="fc" id="L419">				question = QuestionFactory.getNextQuestion(provider);</span>
<span class="pc bpc" id="L420" title="1 of 2 branches missed.">				if (questionCount++ &gt;= 100) {</span>
<span class="nc" id="L421">					throw new IllegalStateException(&quot;Infinite Loop detected determining Assignment Rules questions&quot;);</span>
				}
<span class="fc" id="L423">			}</span>
			
<span class="fc" id="L425">			retVal.put(cwr.getID(), description.toString());</span>
<span class="fc" id="L426">		}</span>
<span class="fc" id="L427">		return retVal;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>