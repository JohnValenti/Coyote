<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AdherenceMappingModelHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.am.adherence.mapping</a> &gt; <span class="el_source">AdherenceMappingModelHandler.java</span></div><h1>AdherenceMappingModelHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.am.adherence.mapping;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.am.base.AmException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFieldInfo;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.ActivityMapping;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.ejb.OrganizationFilter;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.core.base.ModelHandler;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.witness.web.uif.system.RequestContext;



/**
 * Title:        AdherenceMappingModelHandler
 * Description:  Handle interactions with Activity Manager EJB and RTAA Service
 * EJB for adherence mapping area
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       Shimon Kakon
 * @version 1.0
 */
<span class="nc" id="L37">public class AdherenceMappingModelHandler extends ModelHandler {</span>
	/**
	 * Return adherence mapping for a given org.
	 *
	 * @param orgId - The Organization ID
	 * inactive activities or all activities
	 * param ascending - The sort order
	 * @throws RemoteException
	 * @throws BbmException
	 * @throws AmException
	 * @return Array of adherence mapping value objects
	 */
	public static AdherenceMapping[] getAdherenceMappings(RequestContext context, ID orgId)
		throws RemoteException, BbmException, AmException {

		// Load sorted activities under a given org
<span class="fc" id="L53">		Collection orgActivitiesList = ActivityModelHandler.getActivitiesFilterActivities(</span>
				context, orgId, new ActivityFilter(),	null);

		//now filter out all activities that cannot be used in shift OR can be used in shift events OR can be used in calendar event OR unavailability OR timeoff
<span class="fc bfc" id="L57" title="All 2 branches covered.">        for (Iterator it = orgActivitiesList.iterator(); it.hasNext();) {</span>
<span class="fc" id="L58">			Activity activity = (Activity)it.next();</span>
			// remove the activity to be mapped
<span class="fc bfc" id="L60" title="All 2 branches covered.">			if(!activity.getID().equals(Activity.ACTIVITY_NONE) &amp;&amp;</span>
<span class="fc bfc" id="L61" title="All 2 branches covered.">					!activity.getID().equals(Activity.ACTIVITY_SHIFT_OVERTIME_GAP) &amp;&amp;</span>
<span class="fc bfc" id="L62" title="All 6 branches covered.">					!(activity.isUsedInShift() || activity.isUsedInShiftEvent() || activity.isUsedInCalendarEvent()</span>
<span class="fc bfc" id="L63" title="All 4 branches covered.">						|| activity.isUnavailability() || activity.isTimeoff())){</span>
<span class="fc" id="L64">				it.remove();</span>
			}
<span class="fc" id="L66">		}</span>

<span class="fc" id="L68">		return getMapping(context, orgActivitiesList, orgId, false);</span>
	}


	/**
	 * Return adherence mapping for a given collection of activities IDs.
	 *
	 * @param activitiesIds - activities IDs
	 * @throws RemoteException
	 * @throws BbmException
	 * @throws AmException
	 * @return Array of adherence mapping value objects
	 */ 
	public static AdherenceMapping[] getAdherenceMappings(RequestContext context, Collection activitiesIds)
		throws RemoteException, BbmException, AmException {

		// Load activities first
<span class="nc" id="L85">		Collection activities = ActivityModelHandler.getActivitiesByIDs(context, activitiesIds);</span>

		// the activities return may not be in the same order of the ids, we need to 
		// ensure this.
<span class="nc" id="L89">		HashMap actMap = ValueObjectUtil.indexBy(activities, ActivityFieldInfo.ACTIVITY_ID);</span>
<span class="nc" id="L90">		ArrayList list = new ArrayList(activitiesIds.size());</span>

<span class="nc bnc" id="L92" title="All 2 branches missed.">		for (Iterator idIter = activitiesIds.iterator(); idIter.hasNext();) {</span>
<span class="nc" id="L93">			ID actID = (ID)idIter.next();</span>
<span class="nc" id="L94">			Activity act = (Activity)actMap.get(actID);</span>

<span class="nc bnc" id="L96" title="All 2 branches missed.">			if (act != null)</span>
<span class="nc" id="L97">				list.add(act);</span>
<span class="nc" id="L98">		}</span>
<span class="nc" id="L99">		return getMapping(context, list, null, false);</span>
	}





	/**
	 * Return adherence mapping for a activity ID for a given org.
	 * Since there is no EJB facade to provide this service,
	 * this method communicate with multiple EJB services
	 *
	 * @param activityId - The activity ID
	 * @param orgID - The organization ID
	 * @throws RemoteException
	 * @throws BbmException
	 * @throws AmException
	 * @return adherence mapping value object
	 */
	public static AdherenceMapping getAdherenceMappingByID(RequestContext context, ID activityId, ID orgID)
		throws RemoteException, BbmException, AmException {

		// Load activities first
<span class="fc" id="L122">		Activity activity = ActivityModelHandler.getActivityByID(context, activityId);</span>
<span class="fc" id="L123">		Collection activities = Collections.singletonList(activity); //)new ArrayList(1);</span>
		//activities.add(activity);
<span class="fc" id="L125">		AdherenceMapping[] adherenceMappins = getMapping(context, activities, orgID, true);</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">		if(adherenceMappins.length &gt; 0 ) {</span>
<span class="fc" id="L127">			return adherenceMappins[0];</span>
		}
		else {
<span class="nc" id="L130">			return new AdherenceMapping();</span>
		}
	}





	/**
	 * update adherence mapping
	 *
	 * @param activityID - The activity ID
	 * @param mappedActivitiesIds - a Collection of mapped activities Ids
	 * @throws RemoteException
	 * @throws BbmException
	 * @throws AmException
	 *
	 */
	public static void updateActivityMapping(ID activityID,
		Collection mappedActivitiesIds)
		throws RemoteException, BbmException, AmException {

<span class="fc" id="L152">		ActivityMapping activityMapping = new ActivityMapping(activityID);</span>
<span class="fc" id="L153">		activityMapping.addMappedActivityIDs(mappedActivitiesIds);</span>

<span class="fc" id="L155">		BbmManagerFactory.getRTAAService().updateActivityMapping(activityMapping);</span>
<span class="fc" id="L156">	}</span>



	/**
	 * delete adherence mapping
	 *
	 * @param activityID - The activity ID
	 * @throws RemoteException
	 * @throws BbmException
	 * @throws AmException
	 *
	 */
	public static void deleteActivityMapping(ID activityID)
		throws RemoteException, BbmException, AmException {

<span class="nc" id="L172">		Collection activityIds = new ArrayList(1);</span>
<span class="nc" id="L173">		activityIds.add(activityID);</span>

<span class="nc" id="L175">		BbmManagerFactory.getRTAAService().deleteActivityMappingsByID(activityIds);</span>
<span class="nc" id="L176">	}</span>



	public static ArrayList getChildOrganizations(RequestContext context, ID orgID)
		throws RemoteException, BbmException {
<span class="fc" id="L182">		ArrayList allChildOrganizations = new ArrayList(32);</span>
<span class="fc" id="L183">		allChildOrganizations.add(orgID);</span>
<span class="fc" id="L184">		OrganizationFilter orgFilter = new OrganizationFilter();</span>
<span class="fc" id="L185">		orgFilter.setParentID(orgID);</span>
<span class="fc" id="L186">		Collection children = OrganizationModelHandler.getOrganizations(context, orgFilter);</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">		for(Iterator it = children.iterator(); it.hasNext();) {</span>
<span class="fc" id="L188">			Organization child = (Organization)it.next();</span>
<span class="fc" id="L189">			allChildOrganizations.add(child.getID());</span>
<span class="fc" id="L190">		}</span>
<span class="fc" id="L191">		return allChildOrganizations;</span>
	}


	/**
	 * Return adherence mapping for a given collection of activity value objects
	 * Only the mapped activities that can be used in the org id provided will be returned
	 * Since there is no EJB facade to provide this service, this methos
	 * communicates with multiple EJB services
	 *
	 * @param activities - A collection of activity value objects
	 * @param orgID - Organization ID of the mapped activities
	 * @throws RemoteException
	 * @throws BbmException
	 * @throws AmException
	 * @return Array of adherence mapping value objects
	 */
	private static AdherenceMapping[] getMapping(RequestContext context, Collection activities, ID orgID,
		boolean findIfMappingEditable)
		throws RemoteException, BbmException, AmException {

<span class="fc" id="L212">		 AdherenceMapping[] adherenceMappings = null; // The returned object</span>
<span class="fc" id="L213">		 Collection activitiesIds = null;</span>
<span class="fc" id="L214">		 Collection rawAdherenceMapping = null;</span>
<span class="fc" id="L215">		 Collection allChildOrganizations = null;</span>
<span class="fc" id="L216">		 int i = 0;</span>

<span class="pc bpc" id="L218" title="2 of 4 branches missed.">		if(activities != null &amp;&amp; activities.size() &gt; 0) {</span>
<span class="fc" id="L219">			adherenceMappings = new AdherenceMapping[activities.size()];</span>
		}
		else {
<span class="nc" id="L222">			adherenceMappings = new AdherenceMapping[]{};</span>
<span class="nc" id="L223">			return adherenceMappings;</span>
		}

		// Now construct an array of Activity IDs from the list
<span class="fc" id="L227">		activitiesIds = new ArrayList(activities.size());</span>
<span class="fc" id="L228">		i = 0;</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">		for(Iterator it = activities.iterator(); it.hasNext(); i++) {</span>
<span class="fc" id="L230">			activitiesIds.add( ((Activity)it.next()).getID() );</span>
		}

		// Get the adherence mapping
<span class="fc" id="L234">		rawAdherenceMapping = BbmManagerFactory.getRTAAService().</span>
<span class="fc" id="L235">			getActivityMappingsByID(activitiesIds);</span>

		// Since rawAdherenceMapping only include the mapped activity IDs
		// but not the mapped activity names...
		// To do that, I load all the activities from the database
		// (to save multiple db access)
<span class="fc" id="L241">		Collection allActivities = ActivityModelHandler.getAllActivities(context);</span>

		// Create a hash map acticityID (key) activity VO(value)
<span class="fc" id="L244">		HashMap allActivitiesMap = new HashMap(allActivities.size());</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">		for(Iterator it = allActivities.iterator(); it.hasNext();) {</span>
<span class="fc" id="L246">			Activity activity = (Activity)it.next();</span>
<span class="fc" id="L247">			allActivitiesMap.put(activity.getID(), activity);</span>
<span class="fc" id="L248">		}</span>

		// Get all the child organizations of the given org
<span class="fc bfc" id="L251" title="All 2 branches covered.">		if(findIfMappingEditable) {</span>
<span class="fc" id="L252">			allChildOrganizations = getChildOrganizations(context, orgID);</span>
		}


		// Now create the AdherenceMapping value objects
<span class="fc" id="L257">		i = 0;</span>
<span class="fc" id="L258">		Iterator rawMapIt = rawAdherenceMapping.iterator();</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">		for(Iterator actIt = activities.iterator(); actIt.hasNext(); i++) {</span>

<span class="fc" id="L261">			adherenceMappings[i] = new AdherenceMapping();</span>
<span class="fc" id="L262">			adherenceMappings[i].setActivity((Activity)actIt.next());</span>
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">			if(rawMapIt.hasNext()) {</span>
<span class="fc" id="L264">				ActivityMapping mapping = (ActivityMapping)rawMapIt.next();</span>
<span class="pc bpc" id="L265" title="1 of 4 branches missed.">				if( (mapping!=null) &amp;&amp; ((mapping.getMappedActivityIDs()).size() &gt; 0) ) {</span>
<span class="fc" id="L266">					int size = (mapping.getMappedActivityIDs()).size();</span>
<span class="fc" id="L267">					ID[] mappingIDs = (ID[])(mapping.getMappedActivityIDs()).toArray(new ID[0]);</span>
<span class="fc" id="L268">					Activity[] mappedActivities = new Activity[size];</span>
					// set the mapped activity VO
<span class="fc bfc" id="L270" title="All 2 branches covered.">					for(int j = 0; j &lt; size; j++) {</span>
<span class="fc" id="L271">						mappedActivities[j] = (Activity)allActivitiesMap.get(mappingIDs[j]);</span>
					}
<span class="fc" id="L273">					adherenceMappings[i].setMappedActivities(mappedActivities);</span>

					// Set the attribute - is mapped activity editable by the org given as argument
<span class="fc bfc" id="L276" title="All 2 branches covered.">					if(findIfMappingEditable) {</span>
<span class="fc" id="L277">						boolean[] isMappedActivitiesEditable = new boolean[size];</span>
<span class="fc bfc" id="L278" title="All 2 branches covered.">						for(int j = 0; j &lt; size; j++) {</span>
							
<span class="pc bpc" id="L280" title="2 of 6 branches missed.">							if (mappingIDs!=null &amp;&amp; mappingIDs[j]!=null &amp;&amp; allActivitiesMap.get(mappingIDs[j])!=null)</span>
							{							
<span class="fc" id="L282">								ID mappedActivityOrgID = ((Activity)allActivitiesMap.get(mappingIDs[j])).getOrganizationId();</span>
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">								if (mappedActivityOrgID!=null)</span>
<span class="fc" id="L284">									isMappedActivitiesEditable[j] =</span>
<span class="fc bfc" id="L285" title="All 4 branches covered.">										allChildOrganizations.contains(mappedActivityOrgID) || orgID.equals(Organization.YOUR_COMPANY_ID_OBJ);</span>
							}
						}
<span class="fc" id="L288">						adherenceMappings[i].setIsMappedActivitiesEditable(isMappedActivitiesEditable);</span>
					}

<span class="fc" id="L291">				}</span>
				else {  //if( (mapping!=null) &amp;&amp; ((mapping.getMappedActivityIDs()).size() &gt; 0) )
<span class="fc" id="L293">					AdherenceMappingModelHandler.setEmptyMapping(adherenceMappings[i]);</span>
				}

<span class="fc" id="L296">			}</span>
			else { // if(rawMapIt.hasNext())
<span class="nc" id="L298">				AdherenceMappingModelHandler.setEmptyMapping(adherenceMappings[i]);</span>
			}
		} // end for loop

<span class="fc" id="L302">		return adherenceMappings;</span>
	}




	private static void setEmptyMapping(AdherenceMapping adherenceMapping) {
<span class="fc" id="L309">		adherenceMapping.setMappedActivities(new Activity[]{});</span>
<span class="fc" id="L310">		adherenceMapping.setIsMappedActivitiesEditable(new boolean[]{});</span>
<span class="fc" id="L311">	}</span>




}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>