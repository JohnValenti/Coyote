<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StaffingProfilesListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.staffingprofiles</a> &gt; <span class="el_source">StaffingProfilesListPC.java</span></div><h1>StaffingProfilesListPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.staffingprofiles;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.DayOfWeek;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SPEmpTemplate;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.skill.ejb.SkillManager;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTemplate;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeType;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.fs.widgets.MultiColMasterDetailListPC;
import com.verint.web.fs.widgets.ToggleVisiblePC;
import com.witness.web.uif.data.wrapper.NumberWrapper;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.WorkpaneMultiColPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.SortUtil;

public class StaffingProfilesListPC extends MultiColMasterDetailListPC {
	private static final long serialVersionUID = 1L;
	protected static final String MIN_AGENT_RATIO_FN = &quot;minAgentRatioPF&quot;;
	protected static final String MAX_AGENT_RATIO_FN = &quot;maxAgentRatioPF&quot;;
	protected static final String MIN_AGENT_FN = &quot;minAgentPF&quot;;
	protected static final String MAX_AGENT_FN = &quot;maxAgentPF&quot;;

	private static final String DELIMITER_COMMA = &quot;,&quot;;

	ToggleVisiblePC toggleAll;
	protected FormInputPC m_MinAgentRatioPC;
	protected FormInputPC m_MaxAgentRatioPC;
	protected FormInputPC m_MinAgentPC;
	protected FormInputPC m_MaxAgentPC;

<span class="fc" id="L62">	protected Map m_minAgentRatioMap = Collections.EMPTY_MAP;</span>
<span class="fc" id="L63">	protected Map m_maxAgentRatioMap = Collections.EMPTY_MAP;</span>
<span class="fc" id="L64">	protected Map m_minAgentMap = Collections.EMPTY_MAP;</span>
<span class="fc" id="L65">	protected Map m_maxAgentMap = Collections.EMPTY_MAP;</span>

	private boolean isByOrg;
	private Campaign m_camp;
<span class="fc" id="L69">	private Map&lt;ID, Organization&gt; m_orgMap = new HashMap&lt;ID, Organization&gt;();</span>
<span class="fc" id="L70">	private boolean m_hasWeekStartMisAlligned = false;</span>

	public StaffingProfilesListPC(RequestContext context, Collection&lt;SPEmpTemplate&gt; spEmpTemplates,
			Collection&lt;EmployeeTemplate&gt; empTemplates, boolean isByOrg, int minPhantoms, int maxPhantoms,
			Map&lt;ID, Organization&gt; orgMap, Map&lt;ID, Campaign&gt; campaignMap, Map&lt;ID, Activity&gt; activityMap,
			Map&lt;ID, EmployeeType&gt; empTypeMap) {
<span class="fc" id="L76">		super(context);</span>

<span class="pc bpc" id="L78" title="1 of 4 branches missed.">		if (campaignMap != null &amp;&amp; !campaignMap.isEmpty()) {</span>
<span class="fc" id="L79">			m_camp = campaignMap.values().iterator().next();</span>
		}

		// performance enhance, it is slow to call EJB to get org for each
		// staffing profile.
<span class="pc bpc" id="L84" title="1 of 4 branches missed.">		if (orgMap != null &amp;&amp; !orgMap.isEmpty()) {</span>
<span class="fc" id="L85">			m_orgMap = orgMap;</span>
		}

<span class="fc" id="L88">		toggleAll = new ToggleVisiblePC(m_context, &quot;toggleAll&quot;);</span>
<span class="fc" id="L89">		this.addChildComponent(toggleAll);</span>

<span class="fc bfc" id="L91" title="All 2 branches covered.">		if (empTemplates == null) {</span>
<span class="fc" id="L92">			this.isByOrg = false;</span>
		} else {
<span class="fc" id="L94">			this.isByOrg = true;</span>
		}

<span class="fc bfc" id="L97" title="All 2 branches covered.">		if (!isByOrg) {</span>
<span class="fc" id="L98">			m_MinAgentRatioPC = new FormInputPC(context);</span>
<span class="fc" id="L99">			m_MinAgentRatioPC.setInputType(FormInputPC.TYPE_PERCENTAGE);</span>
<span class="fc" id="L100">			m_MinAgentRatioPC.setIsRequired(true);</span>

<span class="fc" id="L102">			m_MaxAgentRatioPC = new FormInputPC(context);</span>
<span class="fc" id="L103">			m_MaxAgentRatioPC.setInputType(FormInputPC.TYPE_PERCENTAGE);</span>
<span class="fc" id="L104">			m_MaxAgentRatioPC.setIsRequired(true);</span>

<span class="fc" id="L106">			m_MinAgentPC = new FormInputPC(context);</span>
<span class="fc" id="L107">			m_MinAgentPC.setIsRequired(true);</span>

<span class="fc" id="L109">			m_MaxAgentPC = new FormInputPC(context);</span>
<span class="fc" id="L110">			m_MaxAgentPC.setIsRequired(true);</span>

<span class="fc" id="L112">			this.addChildComponent(m_MinAgentRatioPC);</span>
<span class="fc" id="L113">			this.addChildComponent(m_MaxAgentRatioPC);</span>
<span class="fc" id="L114">			this.addChildComponent(m_MinAgentPC);</span>
<span class="fc" id="L115">			this.addChildComponent(m_MaxAgentPC);</span>

<span class="fc" id="L117">			initRows(spEmpTemplates, minPhantoms, maxPhantoms);</span>

		} else {
<span class="fc" id="L120">			initRows2(empTemplates);</span>
		}

<span class="fc" id="L123">		initHeader();</span>
<span class="fc" id="L124">	}</span>

	/**
	 * Return Maps
	 */
	public Map getMinAgentRatiosMap() {
<span class="fc" id="L130">		return m_minAgentRatioMap;</span>
	}

	public Map getMaxAgentRatiosMap() {
<span class="fc" id="L134">		return m_maxAgentRatioMap;</span>
	}

	public Map getMinAgentsMap() {
<span class="fc" id="L138">		return m_minAgentMap;</span>
	}

	public Map getMaxAgentsMap() {
<span class="fc" id="L142">		return m_maxAgentMap;</span>
	}

	private void initHeader() {
<span class="fc" id="L146">		TableHeaderPC header = getHeader();</span>
<span class="fc" id="L147">		Localizer localizer = m_context.getLocalizer();</span>
<span class="fc" id="L148">		header.setPartialSortable(true);</span>

<span class="fc" id="L150">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_NAME,</span>
<span class="fc" id="L151">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_NAME), true);</span>
<span class="fc" id="L152">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_WP,</span>
<span class="fc" id="L153">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_WP), true);</span>
<span class="fc" id="L154">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_Org,</span>
<span class="fc" id="L155">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_Org), true);</span>
<span class="fc" id="L156">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_WAGE,</span>
<span class="fc" id="L157">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_WAGE), true);</span>
<span class="fc" id="L158">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_PROFICIENCY,</span>
<span class="fc" id="L159">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_PROFICIENCY), true);</span>
<span class="fc" id="L160">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_CHAT_SESSION,</span>
<span class="fc" id="L161">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_CHAT_SESSION), true);</span>
<span class="fc" id="L162">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_ASSIGNMENT_RULES,</span>
<span class="fc" id="L163">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_ASSIGNMENT_RULES), true);</span>
<span class="fc" id="L164">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_SKILLS,</span>
<span class="fc" id="L165">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_SKILLS), true);</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">		if (!isByOrg) {</span>
<span class="fc" id="L167">			header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_MANIMUM_AGENT_RATIO,</span>
<span class="fc" id="L168">					localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_MANIMUM_AGENT_RATIO),</span>
					true);
<span class="fc" id="L170">			header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_MAXIMUM_AGENT_RATIO,</span>
<span class="fc" id="L171">					localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_MAXIMUM_AGENT_RATIO),</span>
					true);
<span class="fc" id="L173">			header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_MANIMUM_AGENTS,</span>
<span class="fc" id="L174">					localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_MANIMUM_AGENTS), true);</span>
<span class="fc" id="L175">			header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_MAXIMUM_AGENTS,</span>
<span class="fc" id="L176">					localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_MAXIMUM_AGENTS), true);</span>
		}

		// Enable Auto Sorting
<span class="fc" id="L180">		ArrayList&lt;String&gt; sortColumns = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L181">		sortColumns.add(UIFWebBundleKey.LIST_HEADER_NAME);</span>
<span class="fc" id="L182">		header.setDefaultSortColumns(sortColumns);</span>
<span class="fc" id="L183">	}</span>

<span class="fc" id="L185">	DayOfWeek m_campWeekStart = null;</span>

	private DayOfWeek getCampWeekStart() {
		// one calc for each ListPC
<span class="pc bpc" id="L189" title="1 of 4 branches missed.">		if (m_camp != null &amp;&amp; m_campWeekStart == null) {</span>
<span class="fc" id="L190">			Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L191">			cal.set(Calendar.DAY_OF_WEEK, Calendar.SUNDAY);</span>
<span class="fc" id="L192">			cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="fc" id="L193">			cal.set(Calendar.MINUTE, 0);</span>
<span class="fc" id="L194">			cal.add(Calendar.MINUTE, m_camp.getWeekStart());</span>
<span class="fc" id="L195">			m_campWeekStart = DayOfWeek.fromCalendarConstant(cal.get(Calendar.DAY_OF_WEEK));</span>
		}
<span class="fc" id="L197">		return m_campWeekStart;</span>
	}

	private void initRows(Collection&lt;SPEmpTemplate&gt; spEmpTemplates, int minPhantom, int maxPhantom) {
<span class="fc" id="L201">		Collection&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>
		try {
<span class="fc" id="L203">			WorkResourceManager wrMgr = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L204">			ScheduleAccessManager saMgr = WfmManagerFactory.getScheduleAccessManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L205">			WorkRuleManager wrm = WfmManagerFactory.getWorkRuleManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L206">			SkillManager skillMgr = WfmManagerFactory.getSkillManager(m_context.isInWhatIfMode());</span>

<span class="fc" id="L208">			Collection&lt;ID&gt; empTemplateIDs = new ArrayList&lt;ID&gt;(spEmpTemplates.size());</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">			for (SPEmpTemplate spEmpTemplate : spEmpTemplates) {</span>
<span class="fc" id="L210">				empTemplateIDs.add(spEmpTemplate.getEmpTemplateID());</span>
<span class="fc" id="L211">			}</span>
<span class="fc" id="L212">			HashMap&lt;ID, EmployeeTemplate&gt; empTemplateIDObjMap = ValueObjectUtil.getIDObjectMap(saMgr</span>
<span class="fc" id="L213">					.getEmployeeTemplatesByIDs(empTemplateIDs));</span>

<span class="fc" id="L215">			ArrayList&lt;ID&gt; colWP = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L216">			ArrayList&lt;ID&gt; colAR = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L217">			ArrayList&lt;ID&gt; colSkill = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">			for (EmployeeTemplate et : empTemplateIDObjMap.values()) {</span>
<span class="fc" id="L219">				colWP.addAll(et.getShiftPatterns());</span>
<span class="fc" id="L220">				colAR.addAll(et.getAssignmentRuleIDs());</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">				for (SkillAssignment sa : et.getSkillAssignments()) {</span>
<span class="fc" id="L222">					colSkill.add(sa.getSkillID());</span>
<span class="fc" id="L223">				}</span>
<span class="fc" id="L224">			}</span>
<span class="fc" id="L225">			HashMap&lt;ID, ShiftPattern&gt; allShiftPatterns = ValueObjectUtil.getIDObjectMap(wrm.getShiftPatternsByIDs(colWP));</span>
<span class="fc" id="L226">			HashMap&lt;ID, ComplexWorkRule&gt; allWorkRules = ValueObjectUtil.getIDObjectMap(wrm.getComplexWorkRulesByIDs(colAR));</span>
<span class="fc" id="L227">			HashMap&lt;ID, Skill&gt; allSkills = ValueObjectUtil.getIDObjectMap(skillMgr.getSkillsByIDs(colSkill));</span>

<span class="fc bfc" id="L229" title="All 2 branches covered.">			for (SPEmpTemplate spEmpTemplate : spEmpTemplates) {</span>
<span class="fc" id="L230">				ID empTemplateID = spEmpTemplate.getEmpTemplateID();</span>
<span class="fc" id="L231">				EmployeeTemplate et = empTemplateIDObjMap.get(empTemplateID);</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">				if (et != null) {</span>
<span class="fc" id="L233">					DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData(spEmpTemplate.getID());</span>
					// Name
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">					boolean isWeekStartMisAligned = m_camp != null</span>
<span class="pc bnc" id="L236" title="All 2 branches missed.">							&amp;&amp; getOrg(wrMgr, et.getOrganizationID()).getWeekStartDay() != getCampWeekStart();</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">					rowData.add(et.getName() + (isWeekStartMisAligned ? &quot;*&quot; : &quot;&quot;));</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">					if (isWeekStartMisAligned) {</span>
<span class="nc" id="L239">						m_hasWeekStartMisAlligned = true;</span>
					}

					// Work Pattern
<span class="fc" id="L243">					StringBuilder workPatternDisplay = new StringBuilder();</span>
<span class="fc" id="L244">					List&lt;ID&gt; colWPIDs = et.getShiftPatterns();</span>
<span class="fc" id="L245">					int strCnt = 0;</span>
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">					if (colWPIDs.size() &gt; 0) {</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">						for (ID wpID : colWPIDs) {</span>
<span class="pc bpc" id="L248" title="3 of 4 branches missed.">							if (strCnt &gt; 0 &amp;&amp; strCnt != colWPIDs.size()) {</span>
<span class="nc" id="L249">								workPatternDisplay.append(DELIMITER_COMMA);</span>
							}

<span class="fc" id="L252">							ShiftPattern sp = allShiftPatterns.get(wpID);</span>
<span class="fc" id="L253">							workPatternDisplay.append(sp.getName());</span>
<span class="fc" id="L254">							strCnt++;</span>
<span class="fc" id="L255">						}</span>
<span class="fc" id="L256">						rowData.add(workPatternDisplay.toString());</span>
					} else {
<span class="nc" id="L258">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

					// Org
<span class="fc" id="L262">					ID orgID = et.getOrganizationID();</span>
<span class="fc" id="L263">					Organization o = getOrg(wrMgr, orgID);</span>
<span class="fc" id="L264">					rowData.add(o.getName());</span>

					// wage
<span class="fc" id="L267">					rowData.add(et.getWage());</span>

					// Proficiency
<span class="fc" id="L270">					rowData.add(et.getProficiency());</span>

					// Chat Session
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">					if (et.getChatSessions() &gt;= 0) {</span>
<span class="fc" id="L274">						rowData.add(new Integer(et.getChatSessions()).toString());</span>
					} else {
<span class="nc" id="L276">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

					// assignment Rules
<span class="fc" id="L280">					List&lt;ID&gt; colARIDs = et.getAssignmentRuleIDs();</span>
<span class="fc" id="L281">					StringBuilder assignmentRulesColumnDisplay = new StringBuilder();</span>
<span class="fc bfc" id="L282" title="All 2 branches covered.">					if (colARIDs.size() &gt; 0) {</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">						for (ID ruleID : colARIDs) {</span>
<span class="fc" id="L284">							ComplexWorkRule complexWorkRule = allWorkRules.get(ruleID);</span>

<span class="fc bfc" id="L286" title="All 2 branches covered.">							if (assignmentRulesColumnDisplay.length() &gt; 0) {</span>
<span class="fc" id="L287">								assignmentRulesColumnDisplay.append(DELIMITER_COMMA);</span>
							}
<span class="fc" id="L289">							assignmentRulesColumnDisplay.append(complexWorkRule.getName());</span>
<span class="fc" id="L290">						}</span>
<span class="fc" id="L291">						rowData.add(assignmentRulesColumnDisplay.toString());</span>
					} else {
<span class="fc" id="L293">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

					// skills
<span class="fc" id="L297">					Collection&lt;SkillAssignment&gt; skillAssignments = et.getSkillAssignments();</span>
<span class="fc" id="L298">					StringBuilder skillsAssignmentsColumnDisplay = new StringBuilder();</span>
<span class="fc bfc" id="L299" title="All 2 branches covered.">					if (skillAssignments.size() &gt; 0) {</span>
<span class="fc bfc" id="L300" title="All 2 branches covered.">						for (SkillAssignment sa : skillAssignments) {</span>
<span class="fc" id="L301">							Skill skill = allSkills.get(sa.getSkillID());</span>

<span class="fc bfc" id="L303" title="All 2 branches covered.">							if (skillsAssignmentsColumnDisplay.length() &gt; 0) {</span>
<span class="fc" id="L304">								skillsAssignmentsColumnDisplay.append(DELIMITER_COMMA);</span>
							}
<span class="fc" id="L306">							skillsAssignmentsColumnDisplay.append(skill.getName());</span>
<span class="fc" id="L307">						}</span>
<span class="fc" id="L308">						rowData.add(skillsAssignmentsColumnDisplay);</span>
					} else {
<span class="fc" id="L310">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

					// Min percent
<span class="fc" id="L314">					rowData.add(getMinAgentRatioUI(spEmpTemplate.getID().toString(), spEmpTemplate.getMinAllocation(), true));</span>

					// Max percent
<span class="fc" id="L317">					rowData.add(getMaxAgentRatioUI(spEmpTemplate.getID().toString(), spEmpTemplate.getMaxAllocation(), true));</span>

					// Min
<span class="fc" id="L320">					rowData.add(getMinAgentsUI(spEmpTemplate.getID().toString(), spEmpTemplate.getMinNumEmployees(), true));</span>

					// Max
<span class="fc" id="L323">					rowData.add(getMaxAgentsUI(spEmpTemplate.getID().toString(), spEmpTemplate.getMaxNumEmployees(), true));</span>
<span class="fc" id="L324">					rows.add(rowData);</span>
				}

<span class="fc" id="L327">			}</span>
<span class="nc" id="L328">		} catch (Exception e) {</span>
<span class="nc" id="L329">			handleUnableToLoadDataError(log, e);</span>
<span class="fc" id="L330">		}</span>

<span class="fc" id="L332">		DefaultMultiColumnNodeData rowData1 = new DefaultMultiColumnNodeData();</span>
<span class="fc" id="L333">		rowData1.add(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_TOTAL_STAFFING_PROFILES));</span>
<span class="fc" id="L334">		rowData1.add(&quot;&quot;);</span>
<span class="fc" id="L335">		rowData1.add(&quot;&quot;);</span>
<span class="fc" id="L336">		rowData1.add(&quot;&quot;);</span>
<span class="fc" id="L337">		rowData1.add(&quot;&quot;);</span>
<span class="fc" id="L338">		rowData1.add(&quot;&quot;);</span>
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">		if (!isByOrg) {</span>
<span class="fc" id="L340">			rowData1.add(&quot;&quot;);</span>
<span class="fc" id="L341">			rowData1.add(&quot;&quot;);</span>
<span class="fc" id="L342">			rowData1.add(&quot;&quot;);</span>
<span class="fc" id="L343">			rowData1.add(&quot;&quot;);</span>
<span class="fc" id="L344">			rowData1.add(getMinAgentsUI(&quot;test&quot;, minPhantom, true));</span>
<span class="fc" id="L345">			rowData1.add(getMaxAgentsUI(&quot;test&quot;, maxPhantom, true));</span>
		}

<span class="fc" id="L348">		setRowAttributes(rowData1, null);</span>

<span class="fc" id="L350">		rows.add(rowData1);</span>
<span class="fc" id="L351">	}</span>

	private void initRows2(Collection&lt;EmployeeTemplate&gt; empTemplates) {
<span class="fc" id="L354">		Collection&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>

		try {
<span class="fc" id="L357">			WorkResourceManager wrMgr = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L358">			WorkRuleManager wrm = WfmManagerFactory.getWorkRuleManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L359">			SkillManager skillMgr = WfmManagerFactory.getSkillManager(m_context.isInWhatIfMode());</span>

<span class="fc" id="L361">			ArrayList&lt;ID&gt; colWP = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L362">			ArrayList&lt;ID&gt; colAR = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L363">			ArrayList&lt;ID&gt; colSkill = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L364" title="All 2 branches covered.">			for (EmployeeTemplate et : empTemplates) {</span>
<span class="fc" id="L365">				colWP.addAll(et.getShiftPatterns());</span>
<span class="fc" id="L366">				colAR.addAll(et.getAssignmentRuleIDs());</span>
<span class="fc bfc" id="L367" title="All 2 branches covered.">				for (SkillAssignment sa : et.getSkillAssignments()) {</span>
<span class="fc" id="L368">					colSkill.add(sa.getSkillID());</span>
<span class="fc" id="L369">				}</span>
<span class="fc" id="L370">			}</span>
<span class="fc" id="L371">			HashMap&lt;ID, ShiftPattern&gt; allShiftPatterns = ValueObjectUtil.getIDObjectMap(wrm.getShiftPatternsByIDs(colWP));</span>
<span class="fc" id="L372">			HashMap&lt;ID, ComplexWorkRule&gt; allWorkRules = ValueObjectUtil.getIDObjectMap(wrm.getComplexWorkRulesByIDs(colAR));</span>
<span class="fc" id="L373">			HashMap&lt;ID, Skill&gt; allSkills = ValueObjectUtil.getIDObjectMap(skillMgr.getSkillsByIDs(colSkill));</span>

<span class="fc bfc" id="L375" title="All 2 branches covered.">			for (EmployeeTemplate et : empTemplates) {</span>
<span class="pc bpc" id="L376" title="1 of 2 branches missed.">				if (et != null) {</span>
<span class="fc" id="L377">					DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData(et.getID());</span>
					// Name
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">					boolean isWeekStartMisAligned = m_camp != null</span>
<span class="pc bpc" id="L380" title="1 of 2 branches missed.">							&amp;&amp; getOrg(wrMgr, et.getOrganizationID()).getWeekStartDay() != getCampWeekStart();</span>
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">					rowData.add(et.getName() + (isWeekStartMisAligned ? &quot;*&quot; : &quot;&quot;));</span>
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">					if (isWeekStartMisAligned) {</span>
<span class="nc" id="L383">						m_hasWeekStartMisAlligned = true;</span>
					}

					// Work Pattern
<span class="fc" id="L387">					List&lt;ID&gt; colWPIDs = et.getShiftPatterns();</span>
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">					if (colWPIDs.size() &gt; 0) {</span>
<span class="fc" id="L389">						ShiftPattern sp = allShiftPatterns.get(colWPIDs.iterator().next());</span>
<span class="fc" id="L390">						rowData.add(sp.getName());</span>
<span class="fc" id="L391">					} else {</span>
<span class="nc" id="L392">						rowData.add(&quot;&quot;);</span>
					}

					// Org
<span class="fc" id="L396">					ID orgID = et.getOrganizationID();</span>
<span class="fc" id="L397">					Organization o = getOrg(wrMgr, orgID);</span>
<span class="fc" id="L398">					rowData.add(o.getName());</span>

					// wage
<span class="fc" id="L401">					rowData.add(et.getWage());</span>

					// Proficiency
<span class="fc" id="L404">					rowData.add(et.getProficiency());</span>

					// Chat Session
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">					if (et.getChatSessions() &gt;= 0) {</span>
<span class="fc" id="L408">						rowData.add(new Integer(et.getChatSessions()).toString());</span>
					} else {
<span class="nc" id="L410">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

					// assignment Rules
<span class="fc" id="L414">					List&lt;ID&gt; colARIDs = et.getAssignmentRuleIDs();</span>
<span class="fc" id="L415">					StringBuilder assignmentRulesColumnDisplay = new StringBuilder();</span>
<span class="fc bfc" id="L416" title="All 2 branches covered.">					if (colARIDs.size() &gt; 0) {</span>
<span class="fc bfc" id="L417" title="All 2 branches covered.">						for (ID ruleID : colARIDs) {</span>
<span class="fc" id="L418">							ComplexWorkRule complexWorkRule = allWorkRules.get(ruleID);</span>

<span class="fc bfc" id="L420" title="All 2 branches covered.">							if (assignmentRulesColumnDisplay.length() &gt; 0) {</span>
<span class="fc" id="L421">								assignmentRulesColumnDisplay.append(DELIMITER_COMMA);</span>
							}
<span class="fc" id="L423">							assignmentRulesColumnDisplay.append(complexWorkRule.getName());</span>
<span class="fc" id="L424">						}</span>
<span class="fc" id="L425">						rowData.add(assignmentRulesColumnDisplay.toString());</span>
					} else {
<span class="fc" id="L427">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

					// skills
<span class="fc" id="L431">					Collection&lt;SkillAssignment&gt; skillAssignments = et.getSkillAssignments();</span>
<span class="fc" id="L432">					StringBuilder skillsAssignmentsColumnDisplay = new StringBuilder();</span>
<span class="fc bfc" id="L433" title="All 2 branches covered.">					if (skillAssignments.size() &gt; 0) {</span>
<span class="fc bfc" id="L434" title="All 2 branches covered.">						for (SkillAssignment sa : skillAssignments) {</span>
<span class="fc" id="L435">							Skill skill = allSkills.get(sa.getSkillID());</span>

<span class="fc bfc" id="L437" title="All 2 branches covered.">							if (skillsAssignmentsColumnDisplay.length() &gt; 0) {</span>
<span class="fc" id="L438">								skillsAssignmentsColumnDisplay.append(DELIMITER_COMMA);</span>
							}
<span class="fc" id="L440">							skillsAssignmentsColumnDisplay.append(skill.getName());</span>
<span class="fc" id="L441">						}</span>
<span class="fc" id="L442">						rowData.add(skillsAssignmentsColumnDisplay);</span>
					} else {
<span class="fc" id="L444">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

<span class="fc" id="L447">					rows.add(rowData);</span>
				}

<span class="fc" id="L450">			}</span>
<span class="nc" id="L451">		} catch (Exception e) {</span>
<span class="nc" id="L452">			handleUnableToLoadDataError(log, e);</span>
<span class="fc" id="L453">		}</span>

<span class="fc" id="L455">	}</span>

	protected void setRowAttributes(DefaultMultiColumnNodeData rowData, SPEmpTemplate spEmpTemplate) {
<span class="fc" id="L458">		String totalProfileName = m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_TOTAL_STAFFING_PROFILES);</span>
<span class="fc" id="L459">		boolean isDeletable = true;</span>

<span class="pc bpc" id="L461" title="1 of 2 branches missed.">		if (rowData.getColumnData(0) == totalProfileName) {</span>
<span class="nc" id="L462">			isDeletable = false;</span>
		}

<span class="fc" id="L465">		String isDelete = String.valueOf(isDeletable);</span>
<span class="fc" id="L466">		rowData.setNodeAttribute(WorkpaneMultiColPM.IS_DELETEABLE, isDelete);</span>
<span class="fc" id="L467">		rowData.setNodeAttribute(WorkpaneMultiColPM.IS_ADDABLE, isDelete);</span>
<span class="fc" id="L468">	}</span>

	protected NumberWrapper getMaxAgentsUI(String rowID, int agents, boolean isEditable) {
<span class="fc" id="L471">		String sAgents = &quot;&quot;;</span>

<span class="pc bpc" id="L473" title="1 of 2 branches missed.">		if (isEditable) {</span>
<span class="fc" id="L474">			String fn = MAX_AGENT_FN + rowID;</span>
<span class="fc" id="L475">			m_MaxAgentPC.reset();</span>
<span class="fc" id="L476">			m_MaxAgentPC.setSize(5);</span>
<span class="fc" id="L477">			m_MaxAgentPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="fc" id="L478">			m_MaxAgentPC.setInputValue(String.valueOf(agents));</span>
<span class="fc" id="L479">			m_MaxAgentPC.setLowerLimit(0);</span>
<span class="fc" id="L480">			m_MaxAgentPC.setIsRequired(true);</span>
<span class="fc" id="L481">			m_MaxAgentPC.setInputFN(fn);</span>
<span class="fc" id="L482">			m_MaxAgentPC.initForDisplay();</span>
<span class="fc" id="L483">			sAgents = m_MaxAgentPC.getHtmlDisplay();</span>
<span class="fc" id="L484">		} else {</span>
<span class="nc" id="L485">			sAgents = m_localizer.formatNumber(agents);</span>
		}
<span class="fc" id="L487">		return new NumberWrapper(agents, sAgents);</span>
	}

	protected NumberWrapper getMinAgentsUI(String rowID, int agents, boolean isEditable) {
<span class="fc" id="L491">		String sAgents = &quot;&quot;;</span>

<span class="pc bpc" id="L493" title="1 of 2 branches missed.">		if (isEditable) {</span>
<span class="fc" id="L494">			String fn = MIN_AGENT_FN + rowID;</span>
<span class="fc" id="L495">			m_MinAgentPC.reset();</span>
<span class="fc" id="L496">			m_MinAgentPC.setSize(5);</span>
<span class="fc" id="L497">			m_MinAgentPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="fc" id="L498">			m_MinAgentPC.setInputValue(String.valueOf(agents));</span>
<span class="fc" id="L499">			m_MinAgentPC.setLowerLimit(0);</span>
<span class="fc" id="L500">			m_MinAgentPC.setIsRequired(true);</span>
<span class="fc" id="L501">			m_MinAgentPC.setInputFN(fn);</span>
<span class="fc" id="L502">			m_MinAgentPC.initForDisplay();</span>
<span class="fc" id="L503">			sAgents = m_MinAgentPC.getHtmlDisplay();</span>
<span class="fc" id="L504">		} else {</span>
<span class="nc" id="L505">			sAgents = m_localizer.formatNumber(agents);</span>
		}
<span class="fc" id="L507">		return new NumberWrapper(agents, sAgents);</span>
	}

	protected NumberWrapper getMaxAgentRatioUI(String rowID, int agents, boolean isEditable) {
<span class="fc" id="L511">		String sAgents = &quot;&quot;;</span>

<span class="pc bpc" id="L513" title="1 of 2 branches missed.">		if (isEditable) {</span>
<span class="fc" id="L514">			String fn = MAX_AGENT_RATIO_FN + rowID;</span>
<span class="fc" id="L515">			m_MaxAgentRatioPC.reset();</span>
<span class="fc" id="L516">			m_MaxAgentRatioPC.setSize(5);</span>
<span class="fc" id="L517">			m_MaxAgentRatioPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="fc" id="L518">			m_MaxAgentRatioPC.setInputValue(String.valueOf(agents));</span>
<span class="fc" id="L519">			m_MaxAgentRatioPC.setLowerLimit(0);</span>
<span class="fc" id="L520">			m_MaxAgentRatioPC.setIsRequired(true);</span>
<span class="fc" id="L521">			m_MaxAgentRatioPC.setInputFN(fn);</span>
<span class="fc" id="L522">			m_MaxAgentRatioPC.initForDisplay();</span>
<span class="fc" id="L523">			sAgents = m_MaxAgentRatioPC.getHtmlDisplay() + &quot; %&quot;;</span>
<span class="fc" id="L524">		} else {</span>
<span class="nc" id="L525">			sAgents = m_localizer.formatNumber(agents);</span>
		}
<span class="fc" id="L527">		return new NumberWrapper(agents, sAgents);</span>
	}

	protected NumberWrapper getMinAgentRatioUI(String rowID, int agents, boolean isEditable) {
<span class="fc" id="L531">		String sAgents = &quot;&quot;;</span>

<span class="pc bpc" id="L533" title="1 of 2 branches missed.">		if (isEditable) {</span>
<span class="fc" id="L534">			String fn = MIN_AGENT_RATIO_FN + rowID;</span>
<span class="fc" id="L535">			m_MinAgentRatioPC.reset();</span>
<span class="fc" id="L536">			m_MinAgentRatioPC.setSize(5);</span>
<span class="fc" id="L537">			m_MinAgentRatioPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="fc" id="L538">			m_MinAgentRatioPC.setInputValue(String.valueOf(agents));</span>
<span class="fc" id="L539">			m_MinAgentRatioPC.setLowerLimit(0);</span>
<span class="fc" id="L540">			m_MinAgentRatioPC.setIsRequired(true);</span>
<span class="fc" id="L541">			m_MinAgentRatioPC.setInputFN(fn);</span>
<span class="fc" id="L542">			m_MinAgentRatioPC.initForDisplay();</span>
<span class="fc" id="L543">			sAgents = m_MinAgentRatioPC.getHtmlDisplay() + &quot; %&quot;;</span>
<span class="fc" id="L544">		} else {</span>
<span class="nc" id="L545">			sAgents = m_localizer.formatNumber(agents);</span>
		}
<span class="fc" id="L547">		return new NumberWrapper(agents, sAgents);</span>
	}

	/**
	 * Retrieve request parameters from request object to the page model object.
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L555">		boolean success = super.extractParameters(request);</span>

<span class="fc" id="L557">		m_minAgentRatioMap = FormInputPC.extractIDKeyParamMap(request, MIN_AGENT_RATIO_FN);</span>
<span class="fc bfc" id="L558" title="All 2 branches covered.">		for (Object key : m_minAgentMap.keySet()) {</span>
<span class="pc bpc" id="L559" title="1 of 2 branches missed.">			if (m_minAgentMap.get(key) == null) {</span>
<span class="nc" id="L560">				m_minAgentMap.put(key, 0);</span>
			}
<span class="fc" id="L562">		}</span>

<span class="fc" id="L564">		m_maxAgentRatioMap = FormInputPC.extractIDKeyParamMap(request, MAX_AGENT_RATIO_FN);</span>
<span class="fc bfc" id="L565" title="All 2 branches covered.">		for (Object key : m_maxAgentRatioMap.keySet()) {</span>
<span class="pc bpc" id="L566" title="1 of 2 branches missed.">			if (m_maxAgentRatioMap.get(key) == null) {</span>
<span class="nc" id="L567">				m_maxAgentRatioMap.put(key, 100);</span>
			}
<span class="fc" id="L569">		}</span>

<span class="fc" id="L571">		m_minAgentMap = FormInputPC.extractIDKeyParamMap(request, MIN_AGENT_FN);</span>
<span class="fc bfc" id="L572" title="All 2 branches covered.">		for (Object key : m_minAgentMap.keySet()) {</span>
<span class="pc bpc" id="L573" title="1 of 2 branches missed.">			if (m_minAgentMap.get(key) == null) {</span>
<span class="nc" id="L574">				m_minAgentMap.put(key, 0);</span>
			}
<span class="fc" id="L576">		}</span>

<span class="fc" id="L578">		m_maxAgentMap = FormInputPC.extractIDKeyParamMap(request, MAX_AGENT_FN);</span>
<span class="fc bfc" id="L579" title="All 2 branches covered.">		for (Object key : m_maxAgentMap.keySet()) {</span>
<span class="pc bpc" id="L580" title="1 of 2 branches missed.">			if (m_maxAgentMap.get(key) == null) {</span>
<span class="nc" id="L581">				m_maxAgentMap.put(key, 100);</span>
			}
<span class="fc" id="L583">		}</span>

<span class="fc" id="L585">		return success;</span>
	}

	@Override
	protected void autoSortList(List list) {
<span class="pc bpc" id="L590" title="1 of 2 branches missed.">		if (isListSorted()) {</span>
<span class="nc" id="L591">			return;</span>
		}

<span class="fc" id="L594">		MultiColumnNodeData lastRow = (MultiColumnNodeData) list.get(list.size() - 1);</span>
<span class="fc bfc" id="L595" title="All 2 branches covered.">		if (list.size() &gt; 1) {</span>
<span class="fc" id="L596">			list.remove(list.size() - 1);</span>
<span class="fc" id="L597">			int[] sortColumnIndexes = m_headerPC.getSortColumnIndexes();</span>
<span class="pc bpc" id="L598" title="3 of 6 branches missed.">			if (list != null &amp;&amp; !list.isEmpty() &amp;&amp; sortColumnIndexes != null) {</span>
<span class="nc" id="L599">				boolean isAscending = m_headerPC.isAscending();</span>
<span class="nc" id="L600">				SortUtil.sort(list, sortColumnIndexes, isAscending, m_localizer);</span>
			}
<span class="fc" id="L602">			int index = 0;</span>
<span class="fc bfc" id="L603" title="All 2 branches covered.">			for (Iterator it = list.iterator(); it.hasNext(); index++) {</span>
<span class="fc" id="L604">				list.set(index, it.next());</span>
			}
<span class="fc" id="L606">			list.add(lastRow);</span>
		}

		// Indicate List is Sorted
<span class="fc" id="L610">		setIsListSorted(true);</span>
<span class="fc" id="L611">	}</span>

	private Organization getOrg(WorkResourceManager wrMgr, ID id) throws Exception {
<span class="fc" id="L614">		Organization org = m_orgMap.get(id);</span>
<span class="fc bfc" id="L615" title="All 2 branches covered.">		if (org == null) {</span>
<span class="fc" id="L616">			org = wrMgr.getOrganizationByID(id);</span>
<span class="fc" id="L617">			m_orgMap.put(id, org);</span>
		}
<span class="fc" id="L619">		return org;</span>
	}

	public boolean hasWeekStartMisAlligned() {
<span class="fc" id="L623">		return m_hasWeekStartMisAlligned;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>