<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestBiddableSchedulesAreValidHV.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.validation</a> &gt; <span class="el_source">RequestBiddableSchedulesAreValidHV.java</span></div><h1>RequestBiddableSchedulesAreValidHV.java</h1><pre class="source lang-java linenums">/*
 * Created on Aug 19, 2003
 *
 * To change this generated comment go to
 * Window&gt;Preferences&gt;Java&gt;Code Generation&gt;Code and Comments
 */
package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.validation;

import java.io.Serializable;
import java.util.Collection;
import java.util.Iterator;
import java.util.List;

import org.apache.log4j.Priority;

import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.l10n.RmEjbLogBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableSchedule;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.util.ShiftBidAuctionUtil;

/**
 * @author rrajendran
 *
 * To change this generated comment go to
 * Window&gt;Preferences&gt;Java&gt;Code Generation&gt;Code and Comments
 */
<span class="nc bnc" id="L36" title="All 2 branches missed.">public class RequestBiddableSchedulesAreValidHV implements Validator {</span>
<span class="nc" id="L37">    private static final Priority m_tracePriority = RequestUtil.m_defaultTracePriority;</span>

<span class="nc" id="L39">    private static final String m_className = RequestBiddableSchedulesAreValidHV.class.getName();</span>
<span class="nc" id="L40">    private static final Category m_cat = Log.initCategory(m_className);</span>

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.rm.requests.common.validation.Validator#validate(com.bluepumpkin.ejb.rm.requests.common.validation.Validatable)
     */
    public ValidationResult validate(Validatable validatable) throws Exception {
<span class="nc" id="L46">        m_cat.log(m_tracePriority, &quot;Validation Rule: &quot; + m_className + &quot; started&quot;);</span>

<span class="nc" id="L48">        ValidationResult result = null;</span>
<span class="nc" id="L49">        ShiftBidRequest sbr = (ShiftBidRequest) validatable;</span>
        try  {
<span class="nc" id="L51">            ShiftBidRequestValidationCache sbrCache = sbr.getValidationCacheSBR();</span>

<span class="nc bnc" id="L53" title="All 4 branches missed.">            assert (sbr.getDetailLevel() &amp; ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL) != 0:&quot;(sbr.getDetailLevel() &amp; ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL) != 0: &quot; + sbr.getDetailLevel();</span>
<span class="nc bnc" id="L54" title="All 4 branches missed.">            assert (sbr.getDetailLevel() &amp; ShiftBidRequest.DL_SHIFTBID_AUCTION) != 0:&quot;(sbr.getDetailLevel() &amp; ShiftBidRequest.DL_SHIFTBID_AUCTION) != 0: &quot; + sbr.getDetailLevel();</span>

            // get the associated shift bid auction
<span class="nc" id="L57">            ShiftBidAuction sbAuction = sbr.getOptMethods().getShiftBidAuction();</span>
<span class="nc" id="L58">            boolean isWeeklySchedAuction = sbAuction.getIsFullPeriodSchedule();</span>


<span class="nc" id="L61">            List sbrBidScheds = sbr.getOptMethods().getBiddableSchedules();</span>
<span class="nc" id="L62">            result = areAnyBiddableSchedulesNull(result, sbr, sbrBidScheds);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (result != null) {</span>
<span class="nc" id="L64">            	return result;</span>
            }

<span class="nc" id="L67">			int beforeUpdateSize = sbrBidScheds.size();</span>
			
			// validate the biddableSchedule(s)
<span class="nc" id="L70">			Collection updatedBidScheds = ShiftBidAuctionUtil.validateBiddableScheds(null, sbrBidScheds, sbr.getDetailLevel(), </span>
				RequestUtil.ACTION_FETCH, true, false);

			// if no more bidScheds available
<span class="nc" id="L74">			result = isBidSchedsListEmpty(result, sbr, sbrBidScheds);</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">            if (result != null) {</span>
<span class="nc" id="L76">            	return result;</span>
            }
				
			// if the # of bidScheds associated with this request has changed
<span class="nc" id="L80">			int afterUpdateSize = sbrBidScheds.size();</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">			if (beforeUpdateSize != afterUpdateSize) {</span>
<span class="nc" id="L82">				result = ValidationUtil.setHardValidationResult(sbr, RmEjbBundleKey.SBR_ONE_OR_MORE_BIDSCHEDS_BECAME_INVALID,</span>
					m_className);
<span class="nc" id="L84">				return result;</span>
			}
			
<span class="nc" id="L87">			result = postValidationBiddableScheduleNullCheck(result, sbr, sbrBidScheds);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">            if (result != null) {</span>
<span class="nc" id="L89">            	return result;</span>
            }

			// if bidScheds were updated, replace the bidScheds associated with the request with the new ones.
<span class="nc bnc" id="L93" title="All 2 branches missed.">			if ( !updatedBidScheds.isEmpty() ) {</span>
<span class="nc" id="L94">				sbr.getSetters().replaceBidScheds(sbrBidScheds);				</span>
			} 
			
//            for (Iterator updatedBidSchedIter = updatedBidScheds.iterator();updatedBidSchedIter.hasNext();) {
//                BiddableSchedule bidSched = (BiddableSchedule) updatedBidSchedIter.next();
//
//                if (bidSched.getBiddableScheduleCheckSum() == null)  {
//                    ValidationResult result = ValidationUtil.setHardValidationResult(sbr, 
//                    	RmEjbBundleKey.SBR_BIDSCHED_HAS_NULL_MD5, bidSched.getID(), m_className);
//                    return result;
//                }
//            }

            // force the request to be reloaded if any of the assoicated biddable schedules were updated.
//            sbr.setForceRequestReload(updatedBidScheds.size() != 0);

<span class="nc" id="L110">        } catch (Exception e)  {</span>
<span class="nc" id="L111">			result = ValidationUtil.setHardValidationResult(sbr, RmEjbBundleKey.SBR_ONE_OR_MORE_BIDSCHEDS_BECAME_INVALID,</span>
					m_className);	
        } finally {
<span class="nc" id="L114">           m_cat.log(m_tracePriority, &quot;Validation Rule: &quot; + m_className + &quot; done&quot;);</span>
<span class="nc" id="L115">        }</span>
        
<span class="nc" id="L117">        return result;</span>
    }

	private ValidationResult postValidationBiddableScheduleNullCheck(ValidationResult result, ShiftBidRequest sbr,
			List sbrBidScheds) {
		// TODO: don't think this block is necessary since after validation 
		//  there cannot be any bidSched == null or bidSched.getNumOfAvailInstances() == 0
		//
<span class="nc bnc" id="L125" title="All 2 branches missed.">		for (Iterator bidSchedIter = sbrBidScheds.iterator();bidSchedIter.hasNext();) {</span>
<span class="nc" id="L126">		    BiddableSchedule bidSched = (BiddableSchedule) bidSchedIter.next();</span>

		    // bidSched can be null if bidSched.numOfAvailInstances == 0.  
		    // See javadoc for SBReq.getBiddableSchedules().
<span class="nc bnc" id="L130" title="All 4 branches missed.">		    if (bidSched == null || bidSched.getNumOfAvailableInstances() == 0)   { // if bidSched.getNumOfAvailableInstances == 0, bidSched == null.</span>
<span class="nc" id="L131">		        result = ValidationUtil.setAndLogHardValidationResult(sbr,</span>
		        		RmEjbBundleKey.SBR_BIDSCHED_HAS_NOMORE_BIDSCHEDINSTS,
											RmEjbLogBundleKey.SBR_BIDSCHED_HAS_NOMORE_BIDSCHEDINSTS, 
<span class="nc" id="L134">											new Serializable[] {sbr.getName(), sbr.getID()},</span>
											m_className);
<span class="nc" id="L136">		        break;</span>
		   }
<span class="nc" id="L138">		}</span>
<span class="nc" id="L139">		return result;</span>
	}

	private ValidationResult isBidSchedsListEmpty(ValidationResult result, ShiftBidRequest sbr, List sbrBidScheds) {
<span class="nc bnc" id="L143" title="All 2 branches missed.">		if (sbrBidScheds.isEmpty()) {</span>
<span class="nc" id="L144">			result = ValidationUtil.setAndLogHardValidationResult(sbr,</span>
					RmEjbBundleKey.SBR_BIDSCHED_HAS_NOMORE_BIDSCHEDINSTS,
					RmEjbLogBundleKey.SBR_BIDSCHED_HAS_NOMORE_BIDSCHEDINSTS,
<span class="nc" id="L147">					new Serializable[]{sbr.getName(), sbr.getID()},</span>
					m_className);
		}
<span class="nc" id="L150">		return result;</span>
	}

	private ValidationResult areAnyBiddableSchedulesNull(ValidationResult result, ShiftBidRequest sbr,
			List sbrBidScheds) {
<span class="nc bnc" id="L155" title="All 2 branches missed.">		for (Iterator bidSchedIter = sbrBidScheds.iterator(); bidSchedIter.hasNext();) {</span>
<span class="nc" id="L156">			BiddableSchedule bidSched = (BiddableSchedule) bidSchedIter.next();</span>
			// if bidSched == null, it means that bidSched.numOfAvailInstances == 0, ie. no
			// more bidSchedInstances are available (between the time of this validation and last for
			// this request, an event caused the bidSchedInst to be removed from the bidSched.  This
			// could be the approval of another request against the same bidSched, deletion of phantom,
			// modifiction of phantom's shift etc). 
<span class="nc bnc" id="L162" title="All 2 branches missed.">			if (bidSched == null) {</span>
<span class="nc" id="L163">				result = ValidationUtil.setAndLogHardValidationResult(sbr,</span>
						RmEjbBundleKey.SBR_BIDSCHED_HAS_NOMORE_BIDSCHEDINSTS,
						RmEjbLogBundleKey.SBR_BIDSCHED_HAS_NOMORE_BIDSCHEDINSTS,
<span class="nc" id="L166">						new Serializable[]{sbr.getName(), sbr.getID()},</span>
						m_className);
<span class="nc" id="L168">				break;</span>
			}
<span class="nc" id="L170">		}</span>
<span class="nc" id="L171">		return result;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>