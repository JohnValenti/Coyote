<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BiddableScheduleDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb</a> &gt; <span class="el_source">BiddableScheduleDAO.java</span></div><h1>BiddableScheduleDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb;


import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RmDAONode;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestDetailLevel;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.IShiftBidAuctionManager;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableSchedule;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableScheduleFieldInfo;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableScheduleInstance;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.util.DAOUtil;

/**
 * see {@link com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionManager ShiftBidAuctionManager}
 * for a description of the shift bidding process. 
 * 
 * Title:        BiddableScheduleDAO
 * Description:  DAO class for BiddableSchedule
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc.
 * @author       Jagdish Seelam
 * @version 1.0
 */

<span class="nc bnc" id="L40" title="All 2 branches missed.">public class BiddableScheduleDAO extends RmDAONode {</span>

<span class="nc" id="L42">    private  static final FieldInfo m_fieldInfo = new BiddableScheduleFieldInfo();</span>

<span class="nc" id="L44">    private static final String TABLE_NAME = m_fieldInfo.getTableName();</span>
    private static final String TABLE_ALIAS = &quot; A&quot;;
    private static final String TABLE_PREFIX = TABLE_ALIAS + &quot;.&quot;;
    
<span class="nc" id="L48">    private static final String COLNAME_UNPREFIXED_SHIFTBIDAUCTIONID =</span>
        BiddableScheduleFieldInfo.COLNAME_SHIFTBIDAUCTIONID;
<span class="nc" id="L50">    private static final String COLNAME_SHIFTBIDAUCTIONID = </span>
        TABLE_PREFIX + BiddableScheduleFieldInfo.COLNAME_SHIFTBIDAUCTIONID;
<span class="nc" id="L52">	private static final String COLNAME_UNPREFIXED_ORGANIZATIONID = </span>
        BiddableScheduleFieldInfo.COLNAME_ORGANIZATIONID;
<span class="nc" id="L54">    private static final String COLNAME_ORGANIZATIONID = </span>
        TABLE_PREFIX + BiddableScheduleFieldInfo.COLNAME_ORGANIZATIONID;
<span class="nc" id="L56">    private static final String COLNAME_BIDDABLESCHEDCHECKSUM = </span>
        TABLE_PREFIX + BiddableScheduleFieldInfo.COLNAME_BIDDABLESCHEDCHECKSUM; 
<span class="nc" id="L58">    private static final String COLNAME_NUMOFAVAILINSTANCES = </span>
        TABLE_PREFIX + BiddableScheduleFieldInfo.COLNAME_NUMOFAVAILINSTANCES; 
<span class="nc" id="L60">    private static final String COLNAME_BONUSPOINTS = </span>
			TABLE_PREFIX + BiddableScheduleFieldInfo.COLNAME_BONUSPOINTS;

	//if set to true, we ignore exceptions when trying to load an invalid FirstAvailBidderScheduleInstance object. 
	private boolean ignoreInvalidFirstAvailBidderScheduleInstance;

//    private static final String COLNAME_ = 
//        TABLE_PREFIX + BiddableScheduleFieldInfo.COLNAME_; 

    //private Class m_parentDAO;

    protected void initClass(/*Class parentDAO, */long detailLevel) {
        //m_parentDAO = parentDAO;
<span class="nc" id="L73">        saveAndSetDetailLevel(detailLevel);</span>
        
        // if DL_BIDDABLESCHEDULEINSTANCES is set, then also set DL_SHIFTASSIGNMENTS_COLL.  
        // Otherwise getShiftAssignments() method will fail because FIRSTAVAILABLESCHEDBIDINSTANCE_CHILD_TYPE is not fetched.
<span class="nc" id="L77">        long detailLevelToCheck = BiddableSchedule.DL_BIDDABLESCHEDULEINSTANCES;</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if ( (getDetailLevel() &amp; detailLevelToCheck) == detailLevelToCheck ) </span>
<span class="nc" id="L79">            addDetailLevel(BiddableSchedule.DL_SHIFT_ASSIGNMENTS_COLL);  </span>
<span class="nc" id="L80">    }</span>

<span class="nc" id="L82">	public BiddableScheduleDAO(/*Class parentDAO, */long detailLevel) {</span>
<span class="nc" id="L83">        initClass(detailLevel);</span>
<span class="nc" id="L84">	}</span>

	public BiddableScheduleDAO(Jdmo dmo, /*Class parentDAO, */long detailLevel) {
<span class="nc" id="L87">        super(dmo);</span>
<span class="nc" id="L88">        initClass(detailLevel);</span>
<span class="nc" id="L89">    }</span>

    @Override
	protected FieldInfo getFieldInfo() 
    { 
<span class="nc" id="L94">    	return m_fieldInfo; </span>
    }

    @Override
	protected StringBuffer getSelectStatement()
	{
<span class="nc" id="L100">    	StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L101">    	buf.append(&quot;SELECT A.ID, A.BONUSPOINTS, A.SHIFTBIDAUCTIONID, A.NUMOFAVAILINSTANCES, A.FIRSTAVAILBIDSCHEDINSTID, A.BIDDABLESCHEDCHECKSUM, A.ORGANIZATIONID, A.ISFORSINGLESHIFTS, A.DESCRIPTION &quot;);</span>

<span class="nc" id="L103">    	return buf;</span>
	}
    
	@Override
	protected ValueObjectBase createValueObject()
	{
        // Add additional detailLevels necessary to process DL_BIDRANK_FOR_SHIFTBIDREQUEST.  
        // This adjustment will apply to any method that calls DAOBase.getObjectsGivenFullSQLQuery().
        // DL_EMPLOYEE is used to get the shiftBidder's bonus (for this auction) and accumulated bonus.
        // DL_SHIFTBIDAUCTION is used to obtain the campaign's start and end time which in
        //  turn is used to identify the organization that the bidder belongs to.
<span class="nc" id="L114">        long detailToCheck = BiddableSchedule.DL_BIDRANK_FOR_SHIFTBIDREQUEST;</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if ( (getDetailLevel() &amp; detailToCheck) != 0 ) </span>
<span class="nc" id="L116">            addDetailLevel(ShiftBidRequest.DL_EMPLOYEE | RequestDetailLevel.DL_SHIFTBID_AUCTION);</span>
        
<span class="nc" id="L118">        	return (new BiddableSchedule(getDetailLevel()));</span>
	}
    
    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.bbm.dao.DAONode#needToLoadChildObjects()
     */
    @Override
	protected boolean needToLoadChildObjects() {
<span class="nc" id="L126">        long detailLevelsToCheck =</span>
            BiddableSchedule.DL_SHIFT_ASSIGNMENTS_COLL |
            ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL |
            BiddableSchedule.DL_BIDDABLESCHEDULEINSTANCES | 
            BiddableSchedule.DL_NUMBER_OF_SHIFTBIDREQUESTS | 
            BiddableSchedule.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
            BiddableSchedule.DL_SHIFT_BID_REQUEST_FOR_SHIFT_BIDDER |
            BiddableSchedule.DL_EMPLOYEE;
            
<span class="nc bnc" id="L135" title="All 2 branches missed.">        return (getDetailLevel() &amp; detailLevelsToCheck) != 0;</span>
    }

    /**
     * Refer to detail levels defined in {@link BiddableSchedule BiddableSchedule}.
     * 
     * @see com.bluepumpkin.ejb.bbm.dao.DAONode#needToLoadChildObjects(int)
     */
    @Override
	protected boolean needToLoadChildObjects(int iType) {
<span class="nc bnc" id="L145" title="All 4 branches missed.">        switch (iType)  {</span>
            case BiddableScheduleFieldInfo.FIRST_AVAIL_BIDDABLESCHEDULEINSTANCE_CHILD_TYPE:  {
                //BiddableScheduleInstance.DL_EMPLOYEE in this context refers to the phantom employee associated with the biddable schedule instance.
<span class="nc" id="L148">                long detailLevelsToCheck = BiddableSchedule.DL_SHIFT_ASSIGNMENTS_COLL | </span>
                    ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL |  
                    BiddableSchedule.DL_EMPLOYEE;
<span class="nc bnc" id="L151" title="All 2 branches missed.">                return ((getDetailLevel() &amp; detailLevelsToCheck) != 0);</span>
                }
            case BiddableScheduleFieldInfo.BIDDABLESCHEDULEINSTANCE_CHILD_TYPE:
<span class="nc bnc" id="L154" title="All 2 branches missed.">                return ((getDetailLevel() &amp; BiddableSchedule.DL_BIDDABLESCHEDULEINSTANCES) != 0);</span>
            case BiddableScheduleFieldInfo.SHIFTBIDREQUESTBIDDABLESCHEDULE_CHILD_TYPE:  {
                //TODO: DL_SHIFT_BID_REQUEST must not load all shift bid requests.
                //DL_NUMBER_OF_SHIFTBIDREQUESTS can be obtained from # of instances of ShiftBidRequestBiddableSchedule.  
                //Loading the actual ShiftBidRequests  is not necessary. 
<span class="nc" id="L159">                long detailLevelsToCheck = BiddableSchedule.DL_BIDRANK_FOR_SHIFTBIDREQUEST |</span>
                                    BiddableSchedule.DL_SHIFT_BID_REQUEST_FOR_SHIFT_BIDDER |
                                    BiddableSchedule.DL_NUMBER_OF_SHIFTBIDREQUESTS; 

<span class="nc bnc" id="L163" title="All 2 branches missed.">                return ((getDetailLevel() &amp; detailLevelsToCheck) != 0 );</span>
                }
            default:
<span class="nc" id="L166">                throw new IllegalArgumentException(&quot;iType = &quot; + iType);                </span>
        }
    }

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.bbm.dao.DAOBase#appendFromWhereStatement(java.lang.StringBuffer)
     */
    @Override
	protected boolean appendFromWhereStatement(StringBuffer strSQL) {
        
<span class="nc" id="L176">        boolean whereClauseAppeneded = super.appendFromWhereStatement(strSQL);</span>
        
        // if do not include biddable schedules with no associated biddable schedule instances.
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if ( (getDetailLevel() &amp; BiddableSchedule.DL_INCLUDE_ZERO_NUM_OF_AVAIL_INSTANCES) == 0 ) {</span>
<span class="nc" id="L180">            whereClauseAppeneded = DAOUtil.appendToWhereClause(strSQL, &quot; A.NUMOFAVAILINSTANCES &gt; 0 &quot;, whereClauseAppeneded);</span>
        }
        
<span class="nc" id="L183">        return whereClauseAppeneded;</span>
    }

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.bbm.dao.DAONode#createChildDAO(int)
     */
    @Override
	protected DAOBase createChildDAO(int iType) {
<span class="nc bnc" id="L191" title="All 4 branches missed.">        switch (iType)  {</span>
            case BiddableScheduleFieldInfo.FIRST_AVAIL_BIDDABLESCHEDULEINSTANCE_CHILD_TYPE:
<span class="nc" id="L193">                return new BiddableScheduleInstanceDAO(m_dmo, /*getClass(), */getDetailLevel());</span>
            case BiddableScheduleFieldInfo.BIDDABLESCHEDULEINSTANCE_CHILD_TYPE:
<span class="nc" id="L195">                return new BiddableScheduleInstanceDAO(m_dmo, /*getClass(), */getDetailLevel());</span>
            case BiddableScheduleFieldInfo.SHIFTBIDREQUESTBIDDABLESCHEDULE_CHILD_TYPE:
<span class="nc" id="L197">                return new ShiftBidRequestBiddableScheduleDAO(m_dmo, getClass(), getDetailLevel());</span>
        }

<span class="nc" id="L200">        return null;</span>
    }

    
//    /* (non-Javadoc)
//     * @see com.bluepumpkin.ejb.bbm.dao.DAOBase#appendFromWhereStatement(java.lang.StringBuffer)
//     */
//    protected boolean appendFromWhereStatement(StringBuffer strSQL) {
//        // TODO Auto-generated method stub
//        return super.appendFromWhereStatement(strSQL);
//    }
//
//    /* (non-Javadoc)
//     * @see com.bluepumpkin.ejb.bbm.dao.DAOBase#getSelectStatement()
//     */
//    protected StringBuffer getSelectStatement() {
//        // TODO Auto-generated method stub
//        return super.getSelectStatement();
//    }
//
//    /* (non-Javadoc)
//     * @see com.bluepumpkin.ejb.bbm.dao.DAOBase#readObjectFromDB(com.bluepumpkin.common.jdmo.JdmoRowset)
//     */
//    public ValueObjectBase readObjectFromDB(JdmoRowset rs) throws Exception {
//        // TODO Auto-generated method stub
//        return super.readObjectFromDB(rs);
//    }
//
    /**
     * @param biddableScheds
     */
    public Collection createBiddableSchedules(Collection biddableScheds) throws Exception {
<span class="nc" id="L232">        Collection ids = createObjects(biddableScheds);</span>
        
        // move the created children to prevent BiddableSChedInstance children from being re-inserted.
<span class="nc bnc" id="L235" title="All 2 branches missed.">        for (Iterator bidSchedIter = biddableScheds.iterator(); bidSchedIter.hasNext();) {</span>
<span class="nc" id="L236">            BiddableSchedule bidSched = (BiddableSchedule) bidSchedIter.next();       </span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            if (bidSched.getBiddableScheduleCheckSum() != null)</span>
<span class="nc" id="L238">            	bidSched.moveChildrenFromCreatedToPersisted(); //this is recursive.</span>
<span class="nc" id="L239">        }</span>
        
<span class="nc" id="L241">        return ids;</span>
    }

    /**
     * @param auctionID
     * @param biddableScheds
     */
    public void updateBiddableSchedulesForAuction(Collection biddableScheds) throws Exception {
<span class="nc" id="L249">        updateObjects(biddableScheds);</span>
<span class="nc" id="L250">    }</span>

    /**
     * See {@link IShiftBidAuctionManager#getBiddableSchedulesForAuction(ID, ID, ID, long) getBiddableSchedulesForAuction}
     * for usage context. 
     *  
     * @param auctionID
     * @param orgID
     * @param shiftBidderID
     * @param detailLevel
     * @return
     */
    public Collection getBiddableSchedulesForAuction(ID auctionID, ID orgID, ID emplID, boolean byEmplType, 
    		                                         int sortBy, int sortDir, long detailLevel) throws Exception {
<span class="nc" id="L264">    	return this.getBiddableSchedulesForAuction( auctionID, orgID, emplID, byEmplType, new int [] {sortBy}, new int [] {sortDir}, detailLevel );</span>
    }

    /**
     * See {@link IShiftBidAuctionManager#getBiddableSchedulesForAuction(ID, ID, ID, ID, boolean, long) getBiddableSchedulesForAuction}
     * for usage context. 
     *  
     * @param auctionID
     * @param orgID
     * @param emplID
     * @param byEmplType
     * @param shiftBidderID
     * @param detailLevel
     * @return
     */
    public Collection getBiddableSchedulesForAuction(ID auctionID, ID orgID, ID emplID, boolean byEmplType,
    		                                         int []sortByList, int []sortDirList, long detailLevel ) throws Exception 
    {
<span class="nc" id="L282">        saveAndSetDetailLevel(detailLevel);</span>
<span class="nc" id="L283">        setSortCriteriaList(sortByList);</span>
<span class="nc" id="L284">        setSortDirectionList(sortDirList);</span>
                    
        // where clause to filter BiddableSchedules by orgID and auctionID. 
        try  {
<span class="nc" id="L288">            Collection coll = null;</span>
            
            // Build Sort Clause
<span class="nc" id="L291">            String orderByClause = getOrderByClause(sortByList, sortDirList);</span>

<span class="nc bnc" id="L293" title="All 2 branches missed.">            if (byEmplType) {</span>
            	// Build SQL Query
<span class="nc" id="L295">            	String sql = getSQLScheduledByEmployeeType(auctionID, orgID, emplID, orderByClause);</span>

            	// Some BiddableScheduleInstances may get deleted 
	            // when BiddableSchedules get updated. This no-op UPDATE prevents
	            // deadlock between the select that follows and the delete later
<span class="nc" id="L300">	            StringBuilder updateSQL = new StringBuilder(</span>
	            	  &quot;UPDATE BIDDABLESCHEDULE SET BONUSPOINTS=BONUSPOINTS&quot;
	            	+ &quot; WHERE SHIFTBIDAUCTIONID = &quot; + auctionID);
	            
            	// Add Org to narrow schedules by organization
<span class="nc bnc" id="L305" title="All 2 branches missed.">	            if (orgID != null) {</span>
<span class="nc" id="L306">	            	updateSQL.append(&quot; AND ORGANIZATIONID = &quot; + orgID);</span>
	            }
<span class="nc" id="L308">	            m_dmo.executeCommand(updateSQL.toString());</span>

            	// Get Schedules and load Child Objects
<span class="nc" id="L311">            	coll = getObjectsGivenFullSqlQueryStr(sql);</span>
<span class="nc" id="L312">            	loadChildObjects(coll);</span>
<span class="nc" id="L313">            } else {</span>
	            // Using String '+' operator instead of StringBuffer.append() for clarity;
<span class="nc" id="L315">	            StringBuffer whereClause = new StringBuffer(128);</span>
<span class="nc" id="L316">	            whereClause.append(COLNAME_UNPREFIXED_SHIFTBIDAUCTIONID + &quot; = &quot; + auctionID);  </span>
	            
<span class="nc bnc" id="L318" title="All 2 branches missed.">	            if (orgID != null)  {</span>
<span class="nc" id="L319">	                whereClause.append(&quot; AND &quot; + COLNAME_UNPREFIXED_ORGANIZATIONID + &quot; = &quot; + orgID + ' ');</span>
	            }
	            
	            // Some BiddableScheduleInstances may get deleted 
	            // when BiddableSchedules get updated. This no-op UPDATE prevents
	            // deadlock between the select that follows and the delete later
<span class="nc" id="L325">	            StringBuffer strSQL = new StringBuffer(128); </span>
<span class="nc" id="L326">	            strSQL.append(&quot;update BIDDABLESCHEDULE set BONUSPOINTS=BONUSPOINTS &quot;).append(&quot;where &quot;).append(whereClause.toString());</span>
<span class="nc" id="L327">	            m_dmo.executeCommand(strSQL.toString());</span>
	                
<span class="nc" id="L329">	            StringBuffer prefixedWhereClause = new StringBuffer(128);</span>
<span class="nc" id="L330">	            prefixedWhereClause.append(TABLE_PREFIX).append(whereClause); </span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">	            if (StringUtil.isEmpty(orderByClause)) {</span>
<span class="nc" id="L332">	                coll = getObjects(prefixedWhereClause.toString());</span>
	            } else {
<span class="nc" id="L334">	                coll = getObjects(prefixedWhereClause.toString(), orderByClause);</span>
	            }
            }
            
<span class="nc" id="L338">            return coll;            </span>
        } finally  {
            //TODO: do the same for all DAO getXXX() methods
<span class="nc" id="L341">            resetDetailLevel();</span>
<span class="nc" id="L342">            resetSortCriteria();</span>
<span class="nc" id="L343">            resetSortDirection();</span>
        }
    }
    
    public Collection getBiddableScheduleIDsForAuction(ID auctionID, ID orgID, ID emplID, boolean byEmplType, int sortBy, int sortDir) throws Exception {
<span class="nc" id="L348">    	return this.getBiddableScheduleIDsForAuction( auctionID, orgID, emplID, byEmplType, new int[] {sortBy}, new int[] {sortDir} );</span>
    }

    public Collection getBiddableScheduleIDsForAuction(ID auctionID, ID orgID, ID emplID, boolean byEmplType, int []sortByList, int []sortDirList ) throws Exception 
    {
        try {
        	Collection bidSchedIDs;
<span class="nc" id="L355">            setSortCriteriaList(sortByList);</span>
<span class="nc" id="L356">            setSortDirectionList(sortDirList);</span>

            //add the ORDER BY clause.
<span class="nc" id="L359">            String orderByClause = getOrderByClause(sortByList, sortDirList);</span>

<span class="nc bnc" id="L361" title="All 2 branches missed.">            if (byEmplType) {</span>
            	// Get SQL Query
<span class="nc" id="L363">            	String sql = getSQLSchduleIDsByEmployeeType(auctionID, orgID, emplID, orderByClause);</span>
            	
            	// Get Schedule IDs
<span class="nc" id="L366">            	bidSchedIDs = getObjectsGivenFullSqlQueryStr(sql);</span>
<span class="nc" id="L367">            } else {</span>
	            // start with SELECT and partial FROM clause.
<span class="nc" id="L369">	            StringBuffer strSQL = new StringBuffer(); //FROM &quot; + TABLE_NAME + &quot; &quot; + TABLE_ALIAS + &quot; &quot;);</span>
	         
<span class="nc" id="L371">	        	strSQL.append(&quot;SELECT A.ID &quot;);</span>
	        	
	            // add partial FROM clause and WHERE clause
<span class="nc" id="L374">	            boolean whereAppeneded = appendFromWhereStatement(strSQL);</span>
<span class="nc" id="L375">	            whereAppeneded = DAOUtil.appendToWhereClause(strSQL, COLNAME_SHIFTBIDAUCTIONID + &quot; = &quot; + auctionID, whereAppeneded);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">	            if (orgID != null) {</span>
<span class="nc" id="L377">	                whereAppeneded = DAOUtil.appendToWhereClause(strSQL, COLNAME_ORGANIZATIONID + &quot; = &quot; + orgID, whereAppeneded);</span>
	            }
	            
	            // Add Sort Order
<span class="nc bnc" id="L381" title="All 2 branches missed.">	            if (!StringUtil.isEmpty(orderByClause)) {</span>
<span class="nc" id="L382">	                strSQL.append(orderByClause);</span>
	            }
	          
	            //Execute the SQL query and obtain the results.
<span class="nc" id="L386">	            bidSchedIDs = DAOUtil.getIDsUsingSQLQuery(getDMO(), strSQL.toString());</span>
            }
<span class="nc" id="L388">            return bidSchedIDs;</span>
        } finally {
<span class="nc" id="L390">            resetSortCriteria();</span>
<span class="nc" id="L391">            resetSortDirection();</span>
        }
    }

    protected String getSQLScheduledByEmployeeType(ID auctionID, ID orgID, ID emplID, String orderByClause) {
    	// Build query to get Biddable Schedules
<span class="nc" id="L397">    	StringBuilder sql = new StringBuilder(</span>
		  &quot;SELECT A.ID, A.BONUSPOINTS, A.SHIFTBIDAUCTIONID, A.NUMOFAVAILINSTANCES, A.FIRSTAVAILBIDSCHEDINSTID, A.BIDDABLESCHEDCHECKSUM,&quot;
    			+ &quot; A.ORGANIZATIONID, A.ISFORSINGLESHIFTS, A.DESCRIPTION&quot;
    			+ &quot; FROM SHIFTPATTERN I&quot;
    			+ &quot; INNER JOIN EMPLOYEETYPE B on B.ID = I.EMPLOYEETYPEID&quot;
    			+ &quot; INNER JOIN EMPLOYEEAM C on C.EMPLOYEETYPEID = B.SID&quot;
    			+ &quot; INNER JOIN SHIFTPATTERNSHIFT D on D.SHIFTPATTERNID = I.ID&quot;
    			+ &quot; INNER JOIN SHIFT E on E.ID = D.SHIFTID&quot;
    			+ &quot; INNER JOIN SHIFTASSIGNMENT F on F.SHIFTID = E.SID AND (F.SHIFTPATTERNID = I.SID OR F.SHIFTPATTERNID IS NULL)&quot;
    			+ &quot; INNER JOIN BIDDABLESHIFT G on G.SHIFTASSIGNMENTID = F.ID&quot;
    			+ &quot; INNER JOIN BIDDABLESCHEDULEINSTANCE H on H.ID = G.BIDDABLESCHEDULEINSTANCEID&quot;
    			+ &quot; INNER JOIN BIDDABLESCHEDULE A on A.ID = H.BIDDABLESCHEDULEID&quot;
    			+ &quot; INNER JOIN SHIFTBIDAUCTION J on J.ID = A.SHIFTBIDAUCTIONID&quot;);
    
<span class="nc" id="L411">    	sql.append(&quot; WHERE J.ID = &quot; + auctionID);</span>
<span class="nc" id="L412">    	sql.append(&quot; AND C.ID = &quot; + emplID);</span>
	
    	// Add Org to narrow schedules by organization
<span class="nc bnc" id="L415" title="All 2 branches missed.">    	if (orgID != null) {</span>
<span class="nc" id="L416">    		sql.append(&quot; AND A.ORGANIZATIONID = &quot; + orgID);</span>
    	}
	
        // if do not include biddable schedules with no associated biddable schedule instances.
<span class="nc bnc" id="L420" title="All 2 branches missed.">        if ( (getDetailLevel() &amp; BiddableSchedule.DL_INCLUDE_ZERO_NUM_OF_AVAIL_INSTANCES) == 0 ) {</span>
<span class="nc" id="L421">        	sql.append(&quot; AND A.NUMOFAVAILINSTANCES &gt; 0&quot;);</span>
        }

        // Add Group By to get distinct records
<span class="nc" id="L425">    	sql.append(&quot; GROUP BY A.ID, A.BONUSPOINTS, A.SHIFTBIDAUCTIONID, A.NUMOFAVAILINSTANCES, A.FIRSTAVAILBIDSCHEDINSTID, A.BIDDABLESCHEDCHECKSUM,&quot;</span>
			   + &quot; A.ORGANIZATIONID, A.ISFORSINGLESHIFTS, A.DESCRIPTION &quot;);
	
    	// Adds sorting to the SQL
<span class="nc" id="L429">    	sql.append(orderByClause);</span>
    	
    	// Return Query
<span class="nc" id="L432">    	return sql.toString();</span>
    }
    
    protected String getSQLSchduleIDsByEmployeeType(ID auctionID, ID orgID, ID emplID, String orderByClause) {
    	// Build query to get Biddable Schedules
<span class="nc" id="L437">    	StringBuilder sql = new StringBuilder(</span>
    		&quot;SELECT A.ID&quot;
        		+ &quot; FROM SHIFTPATTERN I&quot;
        		+ &quot; INNER JOIN EMPLOYEETYPE B on B.ID = I.EMPLOYEETYPEID&quot;
        		+ &quot; INNER JOIN EMPLOYEEAM C on C.EMPLOYEETYPEID = B.SID&quot;
        		+ &quot; INNER JOIN SHIFTPATTERNSHIFT D on D.SHIFTPATTERNID = I.ID&quot;
        		+ &quot; INNER JOIN SHIFT E on E.ID = D.SHIFTID&quot;
        		+ &quot; INNER JOIN SHIFTASSIGNMENT F on F.SHIFTID = E.SID AND (F.SHIFTPATTERNID = I.SID OR F.SHIFTPATTERNID IS NULL)&quot;
        		+ &quot; INNER JOIN BIDDABLESHIFT G on G.SHIFTASSIGNMENTID = F.ID&quot;
        		+ &quot; INNER JOIN BIDDABLESCHEDULEINSTANCE H on H.ID = G.BIDDABLESCHEDULEINSTANCEID&quot;
        		+ &quot; INNER JOIN BIDDABLESCHEDULE A on A.ID = H.BIDDABLESCHEDULEID&quot;
        		+ &quot; INNER JOIN SHIFTBIDAUCTION J on J.ID = A.SHIFTBIDAUCTIONID&quot;);
<span class="nc" id="L449">    	sql.append(&quot; WHERE C.ID = &quot; + emplID);</span>
<span class="nc" id="L450">    	sql.append(&quot; AND J.ID = &quot; + auctionID);</span>
    	
    	// Add Org to narrow schedules by organization
<span class="nc bnc" id="L453" title="All 2 branches missed.">    	if (orgID != null) {</span>
<span class="nc" id="L454">    		sql.append(&quot; AND A.ORGANIZATIONID = &quot; + orgID);</span>
    	}
    	
    	// Add Group By to get distinct records
<span class="nc" id="L458">    	sql.append(&quot; GROUP BY A.ID, A.NUMOFAVAILINSTANCES, A.BONUSPOINTS &quot;);</span>
    	
        // Add Sort Order
<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (!StringUtil.isEmpty(orderByClause)) {</span>
<span class="nc" id="L462">        	sql.append(orderByClause);</span>
        }
    	
    	// Return Query
<span class="nc" id="L466">    	return sql.toString();</span>
    }
    
    /**
     * Get the 'ORDER BY' clause if applicable.  Otherwise returns an empty string.
     * 
     * @param sortBy
     * @param sortDir
     * @return
     */
    private String getOrderByClause(int []sortBy, int []sortDir) 
    {
<span class="nc" id="L478">    	StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L479">    	HashMap hmColName = new HashMap();</span>
    	
<span class="nc bnc" id="L481" title="All 4 branches missed.">     	for( int i=0; sortBy != null &amp;&amp; i &lt; sortBy.length; ++i )</span>
    	{
<span class="nc" id="L483">	        String sqlColName = null;</span>
	        // only sortBy constants which map to SQL level sorting are SORTBY_NUMBERAVAILABLE and SORTBY_BONUSASSIGNED.
<span class="nc bnc" id="L485" title="All 3 branches missed.">	        switch (sortBy[i]) {</span>
	            case BiddableSchedule.SORTBY_NUMBER_AVAIALBLE:
<span class="nc" id="L487">	                sqlColName = COLNAME_NUMOFAVAILINSTANCES;</span>
<span class="nc" id="L488">	                break;</span>
	            case BiddableSchedule.SORTBY_BONUSASSIGNED:
<span class="nc" id="L490">	                sqlColName = COLNAME_BONUSPOINTS;</span>
	                break;
	        }

<span class="nc bnc" id="L494" title="All 4 branches missed.">	        if( !StringUtil.isEmpty(sqlColName) &amp;&amp; !hmColName.containsKey(sqlColName) ) </span>
	        {
<span class="nc" id="L496">	        	hmColName.put(sqlColName, sqlColName);</span>
	        	
<span class="nc bnc" id="L498" title="All 2 branches missed.">	        	if( buf.length() &gt; 0 )</span>
<span class="nc" id="L499">		        	buf.append(&quot;,&quot;);</span>

<span class="nc" id="L501">	        	buf.append(sqlColName);</span>
<span class="nc" id="L502">	        	buf.append(&quot; &quot;);</span>
<span class="nc" id="L503">	        	buf.append( DAOUtil.getSortDirection(sortDir[i]) );</span>
	        }
    	}

<span class="nc bnc" id="L507" title="All 2 branches missed.">     	if( buf.length() &gt; 0 )</span>
     	{
<span class="nc" id="L509">     		buf.insert(0, &quot; order by &quot;);</span>
     	}
     	
<span class="nc" id="L512">        return buf.toString();        </span>
    }

    
    /**
     * @param id
     * @param l
     * @return
     */
    public BiddableSchedule getBiddableScheduleByID(ID biddableSchedID, long detailLevel) throws Exception {
<span class="nc" id="L522">        saveAndSetDetailLevel(detailLevel);            </span>

        try  {
<span class="nc" id="L525">        	return (BiddableSchedule) getObjectByID(biddableSchedID);</span>
        } finally  {
<span class="nc" id="L527">            resetDetailLevel();</span>
        }
    }

	public BiddableSchedule getBiddableScheduleByIDIgnoreInvalidFirstInstance(ID biddableSchedID, long detailLevel) throws Exception {
		try {
<span class="nc" id="L533">			ignoreInvalidFirstAvailBidderScheduleInstance = true;</span>
<span class="nc" id="L534">			return getBiddableScheduleByID(biddableSchedID, detailLevel);</span>
		} finally {
<span class="nc" id="L536">			ignoreInvalidFirstAvailBidderScheduleInstance = false;</span>
		}
	}

    /**
     * @param biddableSchedIDs
     * @param detailLevel
     * @return
     */
    public Collection getBiddableSchedulesByIDs(Collection biddableSchedIDs, boolean preserveOrder, 
        long detailLevel) throws Exception {
            
<span class="nc" id="L548">        saveAndSetDetailLevel(detailLevel);            </span>

        try  {
<span class="nc" id="L551">            Collection bidScheds = getObjectsByIDs(biddableSchedIDs);</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">            bidScheds = (bidScheds != null)?bidScheds:Collections.EMPTY_LIST;</span>
            
<span class="nc bnc" id="L554" title="All 4 branches missed.">            if (preserveOrder &amp;&amp; !bidScheds.isEmpty()) {</span>
<span class="nc" id="L555">                bidScheds = RequestUtil.orderVOsByGivenIDs(biddableSchedIDs, (List) bidScheds);</span>
            }
            
<span class="nc" id="L558">            return bidScheds;</span>
        } finally  {
            //TODO: do the same for all DAO getXXX() methods
<span class="nc" id="L561">            resetDetailLevel();</span>
        }
    }

    /**
     * @param computedMD5ForThisBidSchedInst
     * @param l
     * @return
     */
    public BiddableSchedule getBiddableScheduleForMD5(String computedMD5ForThisBidSchedInst, ID auctionID, long detailLevel) throws Exception {
<span class="nc" id="L571">        saveAndSetDetailLevel(detailLevel);            </span>

        try  {
<span class="nc" id="L574">            Collection bidScheds = getObjects(COLNAME_BIDDABLESCHEDCHECKSUM + &quot; = '&quot; + computedMD5ForThisBidSchedInst + &quot;' AND &quot; +</span>
                COLNAME_SHIFTBIDAUCTIONID + '=' + auctionID);
<span class="nc bnc" id="L576" title="All 6 branches missed.">            assert (bidScheds == null || bidScheds.size() &lt;= 1):&quot;(bidScheds == null || bidScheds.size() &lt;= 1)&quot;;</span>
            
<span class="nc bnc" id="L578" title="All 4 branches missed.">            return (BiddableSchedule) ((bidScheds == null || bidScheds.size() == 0)?null:bidScheds.iterator().next());</span>
        } finally  {
            //TODO: do the same for all DAO getXXX() methods
<span class="nc" id="L581">            resetDetailLevel();</span>
        }
    }

    /**
     * @param auctionID
     * @param phanIDsAddedOrWithSchedChange
     * @param detailLevel
     * @param bidSchedInstDAO if 'null' a DAO is created internally.  If non-null, then the specified DAO is used.
     * @return
     */
    public Collection getBiddableSchedulesForPhantomIDs(ID auctionID, Collection phanIDs, 
        long detailLevel, BiddableScheduleInstanceDAO bidSchedInstDAO) throws Exception {
        
<span class="nc" id="L595">        saveAndSetDetailLevel(detailLevel);</span>
        
        try {
<span class="nc bnc" id="L598" title="All 2 branches missed.">            bidSchedInstDAO = (bidSchedInstDAO != null)?bidSchedInstDAO: </span>
<span class="nc" id="L599">                new BiddableScheduleInstanceDAO(getDMO(), BiddableScheduleInstance.DL_BASIC);</span>
<span class="nc" id="L600">            Collection bidSchedIDs = bidSchedInstDAO.getBiddableScheduleIDsForPhantoms(auctionID, phanIDs);</span>
            
<span class="nc" id="L602">            Collection bidScheds = Collections.EMPTY_LIST;</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">            if (!bidSchedIDs.isEmpty()) {</span>
                // Some BiddableScheduleInstances may get deleted 
                // when BiddableSchedules get updated. This no-op UPDATE prevents
                // deadlock between the select that follows and the delete later
<span class="nc" id="L607">                StringBuffer strSQL = new StringBuffer(128);</span>
<span class="nc" id="L608">                strSQL.append(&quot;update BIDDABLESCHEDULE set BONUSPOINTS=BONUSPOINTS &quot;) </span>
<span class="nc" id="L609">                      .append(&quot;where ID in &quot;).append(m_dmo.createInClause(bidSchedIDs));</span>
<span class="nc" id="L610">                m_dmo.executeCommand(strSQL.toString());</span>
                
<span class="nc" id="L612">                return getObjectsByIDs(bidSchedIDs);</span>
            }
            
<span class="nc" id="L615">            return bidScheds;</span>
        } finally {
<span class="nc" id="L617">            resetDetailLevel();</span>
        }
            
    }

	@Override
	//when BIDDABLESCHEDULE.FIRSTAVAILBIDSCHEDINSTID is invalid, the call to getBiddableScheduleByID will fail. 
	//This overload prevents that by catching the exception on the child object load.   
	public void loadChildObjectsByType(int iType, ValueObjectBase objParent) throws BbmFinderException {

<span class="nc bnc" id="L627" title="All 4 branches missed.">		if (!ignoreInvalidFirstAvailBidderScheduleInstance</span>
				|| iType != BiddableScheduleFieldInfo.FIRST_AVAIL_BIDDABLESCHEDULEINSTANCE_CHILD_TYPE) {
<span class="nc" id="L629">			super.loadChildObjectsByType(iType, objParent);</span>
<span class="nc" id="L630">			return;</span>
		}

<span class="nc" id="L633">		BiddableSchedule biddableSchedule = (BiddableSchedule) objParent;</span>
<span class="nc" id="L634">		ID firstScheduleInstanceID = biddableSchedule.getFirstAvailBiddableSchedInstanceID();</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">		if (firstScheduleInstanceID == null) {</span>
<span class="nc" id="L636">			return;</span>
		}

<span class="nc" id="L639">		DAOBase dao = createChildDAO(iType);</span>
		try {
<span class="nc" id="L641">			ValueObjectBase item = dao.getObjectByID(firstScheduleInstanceID);</span>
<span class="nc" id="L642">			biddableSchedule.fillChildObject(iType, item);</span>
<span class="nc" id="L643">		} catch (BbmObjectNotFoundException e) { // NOSONAR</span>
			//if we do not find the firstScheduleInstanceID just don't load it.  
<span class="nc" id="L645">			return;</span>
<span class="nc" id="L646">		}</span>

<span class="nc" id="L648">	}</span>

    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>