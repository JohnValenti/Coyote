<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BiddableScheduleInstanceDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb</a> &gt; <span class="el_source">BiddableScheduleInstanceDAO.java</span></div><h1>BiddableScheduleInstanceDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb;


import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectNode;
import com.bluepumpkin.ejb.bbm.workresource.model.Phantom;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RmDAONode;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestDetailLevel;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableScheduleInstance;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableScheduleInstanceFieldInfo;
import com.bluepumpkin.ejb.rm.util.DAOUtil;
import com.verint.ejb.wfm.WfmManagerFactory;

/**
 * see {@link com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionManager ShiftBidAuctionManager}
 * for a description of the shift bidding process. 
 * 
 * Title:        BiddableScheduleInstanceDAO
 * Description:  DAO class for BiddableScheduleInstance
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc.
 * @author       Jagdish Seelam
 * @version 1.0
 */

public class BiddableScheduleInstanceDAO extends RmDAONode {


<span class="nc" id="L48">	private static Category m_cat = Log.initCategory(BiddableScheduleDAO.class.getName());</span>

<span class="nc" id="L50">	private static FieldInfo m_fieldInfo = new BiddableScheduleInstanceFieldInfo();</span>
    
    /**
     * Query template for obtaining bidSchedIDs for a given set of phantom empIDs and an auctionID.
     */
<span class="nc" id="L55">    private static String m_queryForGetBidSchedIDsForPhanIDsTmpl = </span>
        &quot;SELECT &quot; + BiddableScheduleInstanceFieldInfo.COLNAME_BIDDABLESCHEDULEID + &quot; FROM &quot; +
<span class="nc" id="L57">        m_fieldInfo.getTableName() + &quot; WHERE &quot; + BiddableScheduleInstanceFieldInfo.COLNAME_SHIFTBIDAUCTIONID +</span>
        &quot; = {0} AND &quot; + BiddableScheduleInstanceFieldInfo.COLNAME_PHANTOMWORKRESOURCEID + &quot; IN {1}&quot;;

<span class="nc" id="L60">    private String m_queryForGetPhanIDsForAuction = </span>
        &quot;SELECT &quot; + BiddableScheduleInstanceFieldInfo.COLNAME_PHANTOMWORKRESOURCEID + &quot; FROM &quot; +
<span class="nc" id="L62">        m_fieldInfo.getTableName() + &quot; WHERE &quot; + BiddableScheduleInstanceFieldInfo.COLNAME_SHIFTBIDAUCTIONID + &quot; = ?&quot;;</span>

    
    //private Class m_parentDAO;

    private void initClass(/*Class parentDAO, */ long detailLevel)   {
        //m_parentDAO = parentDAO;
<span class="nc" id="L69">        saveAndSetDetailLevel(detailLevel);</span>
<span class="nc" id="L70">    }       </span>

    /**
     * Presently, this is the 1-m child of BiddableSchedule only.  So m_fieldInfo need
     * not be switched to accomodate multiple parent types.  
     * 
     */
    public BiddableScheduleInstanceDAO(long detailLevel) {
<span class="nc" id="L78">        super();</span>
<span class="nc" id="L79">        initClass(detailLevel);        </span>
<span class="nc" id="L80">    }</span>

    /**
     * Presently, this is the 1-m child of BiddableSchedule only.  So m_fieldInfo need
     * not be switched to accomodate multiple parent types.  
     * 
     */
	public BiddableScheduleInstanceDAO(Jdmo dmo, /*Class parentDAO, */ long detailLevel) {
<span class="nc" id="L88">        super(dmo);</span>
<span class="nc" id="L89">        initClass(detailLevel);        </span>
<span class="nc" id="L90">	}</span>

    /* 
     * @see com.bluepumpkin.ejb.bbm.dao.DAOBase#getFieldInfo()
     */
    @Override
	protected FieldInfo getFieldInfo() { 
<span class="nc" id="L97">        return m_fieldInfo; </span>
    }

	@Override
	protected ValueObjectBase createValueObject()	{
<span class="nc" id="L102">		 return (new BiddableScheduleInstance(getDetailLevel()));</span>
	}
    
    
    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.bbm.dao.DAONode#needToLoadChildObjects()
     */
    @Override
	protected boolean needToLoadChildObjects() {
<span class="nc" id="L111">        long detailLevelsToCheck = RequestDetailLevel.DL_BIDDABLESCHEDULEINSTANCES | </span>
            RequestDetailLevel.DL_SHIFT_ASSIGNMENTS_COLL_ROOTED_BIDDABLESCHED |
            RequestDetailLevel.DL_SHIFT_ASSIGNMENTS_COLL_ROOTED_SHIFTBIDREQUEST |
            BiddableScheduleInstance.DL_EMPLOYEE;
        
<span class="nc bnc" id="L116" title="All 2 branches missed.">        return ( (getDetailLevel() &amp; detailLevelsToCheck) != 0);</span>
    }

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.bbm.dao.DAONode#needToLoadChildObjects(int)
     */
    @Override
	protected boolean needToLoadChildObjects(int iType) {
<span class="nc bnc" id="L124" title="All 3 branches missed.">        switch (iType)  {</span>
            case BiddableScheduleInstanceFieldInfo.BIDDABLESHIFT_CHILD_TYPE:
<span class="nc" id="L126">                long detailLevelsToCheck = RequestDetailLevel.DL_BIDDABLESCHEDULEINSTANCES | </span>
                    RequestDetailLevel.DL_SHIFT_ASSIGNMENTS_COLL_ROOTED_BIDDABLESCHED |
                    RequestDetailLevel.DL_SHIFT_ASSIGNMENTS_COLL_ROOTED_SHIFTBIDREQUEST;
                    
<span class="nc bnc" id="L130" title="All 2 branches missed.">                return ( (getDetailLevel() &amp; detailLevelsToCheck) != 0);</span>
            case BiddableScheduleInstanceFieldInfo.EMPLOYEE_CHILD_TYPE:
				//BiddableScheduleInstance.DL_EMPLOYEE in this context refers to the phantom employee.
<span class="nc bnc" id="L133" title="All 2 branches missed.">				return ( (getDetailLevel() &amp; BiddableScheduleInstance.DL_EMPLOYEE) != 0);</span>
            default:
<span class="nc" id="L135">                throw new IllegalArgumentException(&quot;iType = &quot; + iType);</span>
        }
    }

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.bbm.dao.DAONode#createChildDAO(int)
     */
    @Override
	protected DAOBase createChildDAO(int iType) {
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (iType == BiddableScheduleInstanceFieldInfo.BIDDABLESHIFT_CHILD_TYPE)  {</span>
<span class="nc" id="L145">            return new BiddableShiftDAO(m_dmo, getDetailLevel());</span>
        } 
        
<span class="nc" id="L148">        throw new IllegalArgumentException(&quot;iType = &quot; + iType);</span>
    }
    
//	protected void loadChildren(Collection bidSchedInsts, long detailLevel) throws Exception {
//		if (bidSchedInsts.isEmpty()) return;
//		
//		// load the phantoms if necessary
//		if ( (detailLevel &amp; BiddableScheduleInstance.DL_EMPLOYEE) != 0) {
//			// get map of phantomEmpIDs to collection of bidSchedInst
//			Map phanEmpIDToBidSchedInstsMap = new HashMap();
//			for (Iterator bidSchedInstIter = bidSchedInsts.iterator(); bidSchedInstIter.hasNext();) {
//				BiddableScheduleInstance bidSchedInst = (BiddableScheduleInstance) bidSchedInstIter.next();
//				
//				ID phanEmpID = (ID)bidSchedInst.getPhantomEmployeeID();
//				if (phanEmpID == null) continue;
//				
//				List bidSchedInstsList = (List)phanEmpIDToBidSchedInstsMap.get(phanEmpID);
//				if (bidSchedInstsList == null)   {
//					bidSchedInstsList = new ArrayList();
//					phanEmpIDToBidSchedInstsMap.put(phanEmpID, bidSchedInstsList);
//				}
//				bidSchedInstsList.add(bidSchedInst);
//			}
//			
//			// load phantoms
//			WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager();
//			Collection phantoms = wrm.getPhantomsByIDs(phanEmpIDToBidSchedInstsMap.keySet());
//			
//			// associate phantoms with bidschedinsts
//			for (Iterator phanIter = phantoms.iterator(); phanIter.hasNext();) {
//				Employee phantom = (Employee) phanIter.next();
//				
//				// get parents associated with this child
//				Collection parentBidSchedInsts = (Collection) phanEmpIDToBidSchedInstsMap.get(phantom.getID());
//				for (Iterator parentBidSchedInstsIter = parentBidSchedInsts.iterator(); parentBidSchedInstsIter.hasNext(); ) {
//					BiddableScheduleInstance parentBidSchedInst = (BiddableScheduleInstance) parentBidSchedInstsIter.next();
//					
//					// associate phantom with biddable schedule instance.
//					parentBidSchedInst.fillChildObject(BiddableScheduleInstanceFieldInfo.EMPLOYEE_CHILD_TYPE, phantom);
//				}
//			}
//		}
//	}
//
//	protected void loadChildren(BiddableScheduleInstance bidSchedInst, long detailLevel) throws Exception  {
//		// load the phantoms if necessary
//		if ( (detailLevel &amp; BiddableScheduleInstance.DL_EMPLOYEE) != 0) {
//			// load phantom
//			WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager();
//			Collection phantoms = wrm.getPhantomsByIDs(
//				Collections.singleton(bidSchedInst.getPhantomEmployeeID()));
//			
//			// associate phantoms with bidschedinsts
//			Employee phantom = (Employee) phantoms.iterator().next();
//			
//			// associate phantom with biddable schedule instance.
//			bidSchedInst.fillChildObject(BiddableScheduleInstanceFieldInfo.EMPLOYEE_CHILD_TYPE, phantom);
//		}
//	}

//	/* (non-Javadoc)
//	 * @see com.bluepumpkin.ejb.bbm.dao.DAONode#loadChildObjects(java.util.Collection)
//	 */
//	public void loadChildObjects(Collection arrParents) throws BbmFinderException {
//		// TODO Auto-generated method stub
//		super.loadChildObjects(arrParents);
//	}
//		
//	/* (non-Javadoc)
//	 * @see com.bluepumpkin.ejb.bbm.dao.DAONode#loadChildObjects(com.bluepumpkin.ejb.bbm.vo.ValueObjectNode)
//	 */
//	public void loadChildObjects(ValueObjectNode objParent)
//		throws BbmFinderException {
//		// TODO Auto-generated method stub
//		super.loadChildObjects(objParent);
//	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.dao.DAONode#loadChildObjectsByType(int, java.util.HashMap)
	 */
	@Override
	public void loadChildObjectsByType(int iType, Map phanEmpIDToBidSchedInstsMap) 
		throws BbmFinderException {
		try {
<span class="nc bnc" id="L232" title="All 2 branches missed.">			if (iType == BiddableScheduleInstanceFieldInfo.EMPLOYEE_CHILD_TYPE) {</span>
<span class="nc" id="L233">				long detailLevel = getDetailLevel();				</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">				if ((detailLevel &amp; BiddableScheduleInstance.DL_EMPLOYEE) == 0) </span>
<span class="nc" id="L235">					return;</span>
					
				// load phantoms
<span class="nc" id="L238">				ScheduleAccessManager sam = WfmManagerFactory.getScheduleAccessManager();</span>
				// Note: 'Set' returned by phanEmpIDToBidSchedInstsMap.keySet() is not serializable. so 
				// have to construct an arrayList using the keySet.  
<span class="nc" id="L241">				List phanEmpIDs = new ArrayList(phanEmpIDToBidSchedInstsMap.keySet());</span>
<span class="nc" id="L242">				Collection phantoms = sam.getPhantomsByIDs(phanEmpIDs);</span>
			
				// associate phantoms with bidschedinsts
<span class="nc bnc" id="L245" title="All 2 branches missed.">				for (Iterator phanIter = phantoms.iterator(); phanIter.hasNext();) {</span>
<span class="nc" id="L246">					Phantom phantom = (Phantom) phanIter.next();</span>
				
					// get parents associated with this child
<span class="nc" id="L249">					Collection parentBidSchedInsts = (Collection) phanEmpIDToBidSchedInstsMap.get(phantom.getID());</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">					for (Iterator parentBidSchedInstsIter = parentBidSchedInsts.iterator(); parentBidSchedInstsIter.hasNext(); ) {</span>
<span class="nc" id="L251">						BiddableScheduleInstance parentBidSchedInst = (BiddableScheduleInstance) parentBidSchedInstsIter.next();</span>
					
						// associate phantom with biddable schedule instance.
<span class="nc" id="L254">						parentBidSchedInst.fillChildObject(BiddableScheduleInstanceFieldInfo.EMPLOYEE_CHILD_TYPE, phantom);</span>
<span class="nc" id="L255">					}</span>
<span class="nc" id="L256">				}</span>
<span class="nc" id="L257">			} else {</span>
<span class="nc" id="L258">				super.loadChildObjectsByType(iType, phanEmpIDToBidSchedInstsMap);</span>
			}
<span class="nc" id="L260">		} catch (Exception e) {</span>
<span class="nc" id="L261">			RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
<span class="nc" id="L262">		}</span>
<span class="nc" id="L263">	}</span>
	
	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.dao.DAONode#loadChildObjectsByType(int, com.bluepumpkin.ejb.bbm.vo.ValueObjectNode)
	 */
	@Override
	public void loadChildObjectsByType(int iType, ValueObjectBase bidSchedInstBase)
		throws BbmFinderException {

		//This cast is needed because DaoNode is defined as DAONode&lt;T extends ValueObjectBase&gt; instead of DAONode&lt;T extends ValueObjectNode&gt;
		//However fixing this cause compilation errors because of incorrect usage in other places. 
		//Foundation should fix this and force all client to do the right thing, but till then this hack will have to do. 
<span class="nc" id="L275">		ValueObjectNode bidSchedInst = (ValueObjectNode) bidSchedInstBase;</span>

		try {
<span class="nc bnc" id="L278" title="All 2 branches missed.">			if (iType == BiddableScheduleInstanceFieldInfo.EMPLOYEE_CHILD_TYPE) {</span>
<span class="nc" id="L279">				long detailLevel = getDetailLevel();				</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">				if ((detailLevel &amp; BiddableScheduleInstance.DL_EMPLOYEE) == 0) </span>
<span class="nc" id="L281">					return;</span>

				// load phantom
<span class="nc" id="L284">				ScheduleAccessManager sam = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc" id="L285">				Collection phantoms = sam.getPhantomsByIDs(</span>
<span class="nc" id="L286">					Collections.singleton(bidSchedInst.getFieldValue(getFieldInfo().getChildFieldIndex(iType))));</span>
			
				// associate phantoms with bidschedinsts
<span class="nc" id="L289">				Phantom phantom = (Phantom) phantoms.iterator().next();</span>
			
				// associate phantom with biddable schedule instance.
<span class="nc" id="L292">				bidSchedInst.fillChildObject(BiddableScheduleInstanceFieldInfo.EMPLOYEE_CHILD_TYPE, phantom);</span>
<span class="nc" id="L293">			} else {</span>
<span class="nc" id="L294">				super.loadChildObjectsByType(iType, bidSchedInst);</span>
			}
<span class="nc" id="L296">		} catch (Exception e) {</span>
<span class="nc" id="L297">			RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
<span class="nc" id="L298">		}</span>
<span class="nc" id="L299">	}</span>

    /**
     * Get phantom IDs for the specified auction.
     * 
     * @param id
     * @return
     */
    public Collection getPhantomIDsForAuction(ID auctionID) throws JdmoException {
<span class="nc" id="L308">        List phanIDs = DAOUtil.getIDsUsingSQLQuery(getDMO(), m_queryForGetPhanIDsForAuction, </span>
                    new Object[] {auctionID}, 
<span class="nc" id="L310">                    new DAOUtil.ColumnMetaData[] {DAOUtil.ColumnMetaData.getColMetaDataForID()});</span>
        
<span class="nc" id="L312">        return phanIDs;</span>
    }

    /**
     * Get biddable schedule IDs for the specified phantoms.
     * 
     * @param phanIDs
     * @return
     */
    public Collection getBiddableScheduleIDsForPhantoms(ID auctionID, Collection phanIDs) throws Exception {
        // get the IN string for phantom IDs.
<span class="nc" id="L323">        String phanIDsInStr = getDMO().createInClause(phanIDs);</span>
        
        // Substitute values in the template
<span class="nc" id="L326">        String query = MessageFormat.format(m_queryForGetBidSchedIDsForPhanIDsTmpl, </span>
                new Object[] {auctionID, phanIDsInStr});
        
<span class="nc" id="L329">        List bidSchedIDs = DAOUtil.getIDsUsingSQLQuery(getDMO(), query);</span>
        
<span class="nc" id="L331">        return bidSchedIDs;</span>
    }
	
//	/*
//	 * The other getXXXX() methods, besides the ones defined below, are declared final in 
//	 * DAOBase and cannot be overriden.  But all
//	 * these final methods eventually call getObjects() for loading the object.
//	 */
//	/* (non-Javadoc)
//	 * @see com.bluepumpkin.ejb.bbm.dao.DAONode#getObjectByID(com.bluepumpkin.common.datatypes.ID)
//	 */
//	public ValueObjectBase getObjectByID(ID id)
//		throws BbmObjectNotFoundException, BbmFinderException {
//		ValueObjectBase voBase = super.getObjectByID(id);
//		loadChildren((BiddableScheduleInstance)voBase, getDetailLevel());
//		
//		return voBase;
//	}
//
//    /* (non-Javadoc)
//	 * @see com.bluepumpkin.ejb.bbm.dao.DAONode#getObjects(java.lang.String)
//	 */
//	public Collection getObjects(String strWhere) throws BbmFinderException {
//		Collection bidSchedInsts = super.getObjects(strWhere);
//		loadChildren(bidSchedInsts, getDetailLevel());
//	}
//
//	/* (non-Javadoc)
//	 * @see com.bluepumpkin.ejb.bbm.dao.DAOBase#getObjects(java.lang.String, java.lang.String)
//	 */
//	public Collection getObjects(String strWhere, String strAfterWhere)
//		throws BbmFinderException {
//		Collection bidSchedInsts = super.getObjects(strWhere, strAfterWhere);
//		loadChildren(bidSchedInsts, getDetailLevel());
//	}	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>