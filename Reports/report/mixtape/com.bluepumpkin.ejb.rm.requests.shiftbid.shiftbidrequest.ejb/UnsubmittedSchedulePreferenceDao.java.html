<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>UnsubmittedSchedulePreferenceDao.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb</a> &gt; <span class="el_source">UnsubmittedSchedulePreferenceDao.java</span></div><h1>UnsubmittedSchedulePreferenceDao.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb;

import java.util.Collection;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.ejb.rm.base.RmRuntimeException;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.UnsubmittedShiftBidPreference;
import com.bluepumpkin.ejb.rm.util.BasicJdmoDao;
import com.bluepumpkin.ejb.rm.util.JdmoPreparedStatement;
import com.bluepumpkin.ejb.rm.util.orm.JdmoOrm;
import com.bluepumpkin.ejb.rm.util.orm.WriteOptions;

<span class="nc" id="L16">public class UnsubmittedSchedulePreferenceDao extends BasicJdmoDao {</span>

	//unsubmitted preferences for an employee in an auction
	private static final String UN_SUBMITTED_PERFERENCE_FOR_EMPLOYEE_SQL =
			&quot;;with SubmittedRequests as ( &quot;
					+ &quot;	select RqstBSH.BIDDABLESCHEDULEID  &quot;
					+ &quot;	from SHIFTBIDREQSTBIDDABLESCHEDULE RqstBSH &quot;
					+ &quot;	inner join SHIFTBIDREQUEST SBR on RqstBSH.SHIFTBIDREQUESTID = SBR.ID &quot;
					+ &quot;	inner join SHIFTBIDDER SB on SB.ID = SBR.SHIFTBIDDERID &quot;
					+ &quot; inner join REQUEST R on R.ID = SBR.ID &quot;
					+ &quot;	where  &quot;
					+ &quot;		SBR.SHIFTBIDAUCTIONID = ? and SB.EMPLOYEEID = ? and R.REQUESTSTATUS not in ('withdrawn', 'invalid') &quot;
					+ &quot;) &quot;
					+ &quot; select SBP.BIDDABLESCHEDULEID, SBP.Preference   &quot;
					+ &quot; from UNSUBMITTEDSHIFTBIDPREFERENCE SBP   &quot;
					+ &quot; inner join BIDDABLESCHEDULE BSH on SBP.BiddableScheduleID = BSH.ID   &quot;
					+ &quot; inner join SHIFTBIDAUCTION A on BSH.SHIFTBIDAUCTIONID = A.ID    &quot;
					+ &quot; left join SubmittedRequests on SubmittedRequests.BIDDABLESCHEDULEID = SBP.BIDDABLESCHEDULEID &quot;
					+ &quot; where   A.ISFORSINGLESHIFTS = 0 and A.ID = ? and  SBP.EmployeeID = ? and SubmittedRequests.BIDDABLESCHEDULEID is null &quot;;

	//unsubmitted preferences for a bidder in an auction
	private static final String UN_SUBMITTED_PERFERENCE_FOR_BIDDER_SQL =
			&quot;;with SubmittedRequests as ( &quot; +
					&quot;	select RqstBSH.BIDDABLESCHEDULEID  &quot; +
					&quot;	from SHIFTBIDREQSTBIDDABLESCHEDULE RqstBSH &quot; +
					&quot;	inner join SHIFTBIDREQUEST SBR on RqstBSH.SHIFTBIDREQUESTID = SBR.ID &quot; +
					&quot;   inner join REQUEST R on R.ID = SBR.ID &quot; +
					&quot;	where  &quot; +
					&quot;	SBR.SHIFTBIDAUCTIONID = ? and SBR.SHIFTBIDDERID = ? and R.REQUESTSTATUS not in ('withdrawn', 'invalid') &quot; +
					&quot;) &quot; +
					&quot;select SBP.BIDDABLESCHEDULEID, SBP.Preference, SBP.EmployeeID    &quot; +
					&quot; from UNSUBMITTEDSHIFTBIDPREFERENCE SBP    &quot; +
					&quot; inner join BIDDABLESCHEDULE BSH on SBP.BiddableScheduleID = BSH.ID    &quot; +
					&quot; inner join SHIFTBIDAUCTION A on BSH.SHIFTBIDAUCTIONID = A.ID   &quot; +
					&quot; inner join SHIFTBIDDER SB on SB.SHIFTBIDAUCTIONID = BSH.SHIFTBIDAUCTIONID and SB.EMPLOYEEID = SBP.EmployeeID   &quot; +
					&quot; left join SubmittedRequests on SubmittedRequests.BIDDABLESCHEDULEID = SBP.BIDDABLESCHEDULEID &quot; +
					&quot; where   A.ISFORSINGLESHIFTS = 0 and A.ID = ? and  SB.ID = ?  and SubmittedRequests.BIDDABLESCHEDULEID is null  &quot;;

	/**
	 * The preference for requests that have not yet been submitted for the given employee and auction 
	 * The key is the BiddableSchedule ID and the value is the preference.  
	 */
	public Map&lt;ID, Integer&gt; getUnsubmittedSchedulePreference(ID auctionID, ID employeeID) {
<span class="nc" id="L59">		return JdmoPreparedStatement.getIDToIntegerMap(dmo, UN_SUBMITTED_PERFERENCE_FOR_EMPLOYEE_SQL, auctionID, employeeID, auctionID,</span>
				employeeID);
	}

	/**
	 * The preference for requests that have not yet been submitted for the given bidder and auction 
	 * The key is the BiddableSchedule ID and the value is the preference.  
	 */
	public Map&lt;ID, Integer&gt; getUnsubmittedSchedulePreferenceForBidder(ID auctionID, ID bidderID) {
<span class="nc" id="L68">		return JdmoPreparedStatement.getIDToIntegerMap(dmo, UN_SUBMITTED_PERFERENCE_FOR_BIDDER_SQL, auctionID, bidderID, auctionID,</span>
				bidderID);
	}

	public void updateUnsubmittedSchedulePreference(Collection&lt;UnsubmittedShiftBidPreference&gt; preferences) {
		try {
			//write to temp table #MergePerferences
<span class="nc" id="L75">			WriteOptions options = new WriteOptions(&quot;#MergePerferences&quot;);</span>
			//we write the bidder id, not the employee id to the temp table so exclude employeeID
<span class="nc" id="L77">			options.setExcludedProperties(&quot;employeeID&quot;);</span>
<span class="nc" id="L78">			JdmoOrm.insertToTempTable(dmo, UnsubmittedShiftBidPreference.class, preferences, options);</span>

			//and merge the temp table to UNSUBMITTEDSHIFTBIDPREFERENCE
<span class="nc" id="L81">			String mergeSql = &quot;;merge UNSUBMITTEDSHIFTBIDPREFERENCE as dest &quot;</span>
					+ &quot; using ( &quot;
					+ &quot;  select mp.biddableScheduleID, SB.EMPLOYEEID, mp.preference &quot;
					+ &quot;  from #MergePerferences mp &quot;
					+ &quot;  inner join SHIFTBIDDER SB on SB.ID = mp.bidderID &quot;
					+ &quot; ) as src &quot;
					+ &quot; on src.BIDDABLESCHEDULEID = dest.BIDDABLESCHEDULEID and  src.EMPLOYEEID = dest.EMPLOYEEID &quot;
					+ &quot; when matched then update set dest.Preference = src.Preference &quot;
					+ &quot; when not matched by target then &quot;
					+ &quot; insert (BIDDABLESCHEDULEID,EMPLOYEEID,Preference) Values (BIDDABLESCHEDULEID,EMPLOYEEID,Preference); &quot;;

<span class="nc" id="L92">			dmo.execute(mergeSql);</span>

<span class="nc" id="L94">		} catch (JdmoException e) {</span>
<span class="nc" id="L95">			throw new RmRuntimeException(e);</span>
<span class="nc" id="L96">		}</span>
<span class="nc" id="L97">	}</span>

	public static List&lt;UnsubmittedShiftBidPreference&gt; getUnsubmittedSchedulePreferencesForBidder(ID auctionID, ID bidderID) {
<span class="nc" id="L100">		return JdmoOrm.toObjects(UnsubmittedShiftBidPreference.class, UN_SUBMITTED_PERFERENCE_FOR_BIDDER_SQL, auctionID, bidderID,</span>
				auctionID, bidderID);
	}

	public int getTotalSubmittedBids(ID auctionID, ID bidderID) {
<span class="nc" id="L105">		String sql = &quot;select count(*) as NumSubmittedRequests &quot; +</span>
				&quot;from SHIFTBIDREQUEST SBR  &quot; +
				&quot;inner join SHIFTBIDAUCTION A on SBR.SHIFTBIDAUCTIONID = A.ID &quot; +
				&quot;inner join REQUEST R on R.ID = SBR.ID &quot; +
				&quot;where A.ISFORSINGLESHIFTS = 0 and A.ID = ? and SBR.SHIFTBIDDERID = ? and R.REQUESTSTATUS not in ('withdrawn', 'invalid') &quot;;
<span class="nc" id="L110">		return JdmoPreparedStatement.executeScalarInt(dmo, 0, sql, auctionID, bidderID);</span>

	}

	public String getTemplateNameFromBiddableScheduleID(ID biddableScheduleID) {

<span class="nc" id="L116">		String sql = &quot;select ET.NAME +', '+ P.NAME as TemplateName &quot; +</span>
				&quot;from BIDDABLESCHEDULE BSCH &quot; +
				&quot;inner join BIDDABLESCHEDULEINSTANCE BSI on BSCH.FIRSTAVAILBIDSCHEDINSTID = BSI.ID &quot; +
				&quot;inner join PHANTOM P on P.ID = BSI.PHANTOMWORKRESOURCEID &quot; +
				&quot;inner join EMPTEMPLATE ET on ET.SID = P.EMPTEMPLATEID &quot; +
				&quot;where BSCH.ID = ?&quot;;

<span class="nc" id="L123">		return JdmoPreparedStatement.executeScalarString(dmo, &quot;&quot;, sql, biddableScheduleID);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>