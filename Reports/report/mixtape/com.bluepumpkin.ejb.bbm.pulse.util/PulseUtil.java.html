<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PulseUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.pulse.util</a> &gt; <span class="el_source">PulseUtil.java</span></div><h1>PulseUtil.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.pulse.util;

import java.util.Date;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.pulse.model.TraceChart;
import com.bluepumpkin.ejb.bbm.pulse.model.TrackingView;
import com.bluepumpkin.ejb.bbm.timeseries.model.ActualTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.AggrForecastedTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.AggrRequiredTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.PredictTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.RequireTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ServiceGoalTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;

<span class="nc" id="L20">public class PulseUtil {</span>
	
	/**
	 * When trending, make sure forecast was selected or add it. For Net Staffing, make sure Required FTE is in the view.
	 * @param view - The view object to add needed (dependent) stats/line types to.
	 * @param isCurWeek - If true, we will also include Actual data for each Forecast statistic in the view, whether or 
	 * not the view definition requires the Actuals.
	 * @throws Exception
	 */
	public static void addDependentLinesToView(TrackingView view, boolean isCurWeek) {
<span class="nc bnc" id="L30" title="All 2 branches missed.">		if (view != null) {	</span>
<span class="nc" id="L31">			boolean hasNetStaffing = false;</span>
<span class="nc" id="L32">			boolean hasFTE = false;</span>
<span class="nc" id="L33">			boolean hasRequiredFTE = false;</span>
<span class="nc" id="L34">			boolean needsForecastCV = false;</span>
<span class="nc" id="L35">			boolean needsForecastAbandonment = false;</span>
<span class="nc" id="L36">			boolean needsForecastBacklog = false;</span>
<span class="nc" id="L37">			boolean needsForecastVAR = false;</span>
<span class="nc" id="L38">			boolean needsForecastVH = false;</span>
<span class="nc" id="L39">			boolean needsActualAbandonment = false;</span>
<span class="nc" id="L40">			boolean needsActualVH = false;</span>

<span class="nc" id="L42">			List&lt;TraceChart&gt; traceChartList = view.getChartDefinition();</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">			if (traceChartList != null) {</span>
<span class="nc" id="L44">				int listSize = traceChartList.size();</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">				for (int i=0; i&lt;listSize; i++) {</span>
<span class="nc" id="L46">					TraceChart traceChart = traceChartList.get(i);</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">					if (traceChart != null) {</span>
						// only CV and AHT can be reforecasted
<span class="nc bnc" id="L49" title="All 2 branches missed.">						if (traceChart.getTraceType() == Trace.CV ||</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">							traceChart.getTraceType() == Trace.AHT) {</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">							if (view.useTrending()) {</span>
<span class="nc" id="L52">								traceChart.getLineType()[TraceChart.FORECAST_LINE] = true;</span>
							}
<span class="nc bnc" id="L54" title="All 2 branches missed.">						} else if (traceChart.getTraceType() == Trace.NETSTAFFING) {</span>
<span class="nc" id="L55">							hasNetStaffing = true;</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">						} else if (traceChart.getTraceType() == Trace.FTE) {</span>
<span class="nc" id="L57">							hasFTE = true;</span>
<span class="nc" id="L58">							hasRequiredFTE = traceChart.getLineType()[TraceChart.REQUIRE_LINE];</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">						} else if (traceChart.getTraceType() == Trace.VH &amp;&amp;</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">								 traceChart.getLineType()[TraceChart.FORECAST_LINE]) {</span>
<span class="nc" id="L61">							needsForecastCV = true;</span>
<span class="nc" id="L62">							needsForecastAbandonment = true;</span>
<span class="nc" id="L63">							needsForecastBacklog = true;</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">						} else if (traceChart.getTraceType() == Trace.PCA &amp;&amp;</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">									(traceChart.getLineType()[TraceChart.FORECAST_LINE] || </span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">											traceChart.getLineType()[TraceChart.REQUIRE_LINE])) {</span>
<span class="nc" id="L67">							needsForecastVAR = true;</span>
<span class="nc" id="L68">							needsForecastVH = true;</span>
<span class="nc" id="L69">							needsForecastAbandonment = true;</span>
<span class="nc" id="L70">							needsForecastBacklog = true;</span>
<span class="nc" id="L71">							needsForecastCV = true;</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">						} else if (traceChart.getTraceType() == Trace.PCA &amp;&amp;</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">								traceChart.getLineType()[TraceChart.ACTUAL_LINE]) {</span>
<span class="nc" id="L74">							needsActualVH = true;</span>
<span class="nc" id="L75">							needsActualAbandonment = true;</span>
						}

<span class="nc" id="L78">						boolean hasActualLineForCurTraceType = traceChart.getLineType()[TraceChart.ACTUAL_LINE];</span>
<span class="nc" id="L79">						boolean hasForecastLineForCurTraceType = traceChart.getLineType()[TraceChart.FORECAST_LINE]; </span>

						//for the current week, if the view contains a Forecast statistic, we need its Actual as
						//well, so we can compute the forecast-till-now (which only counts the intervals where Actual
						//values exist.
<span class="nc bnc" id="L84" title="All 4 branches missed.">						if (hasForecastLineForCurTraceType &amp;&amp; !hasActualLineForCurTraceType &amp;&amp; </span>
<span class="nc bnc" id="L85" title="All 4 branches missed.">								supportsActuals(traceChart.getTraceType()) &amp;&amp; isCurWeek) {</span>
<span class="nc" id="L86">							addTraceAndLineIfNeeded(traceChartList, traceChart.getTraceType(), </span>
									TraceChart.ACTUAL_LINE, isCurWeek);
						}
					}
				}

<span class="nc bnc" id="L92" title="All 2 branches missed.">				if (needsForecastCV) {</span>
<span class="nc" id="L93">					addTraceAndLineIfNeeded(traceChartList, Trace.CV, TraceChart.FORECAST_LINE, isCurWeek);</span>
				}
<span class="nc bnc" id="L95" title="All 2 branches missed.">				if (needsForecastAbandonment) {</span>
<span class="nc" id="L96">					addTraceAndLineIfNeeded(traceChartList, Trace.ABANDONMENT, TraceChart.FORECAST_LINE, isCurWeek);</span>
				}
<span class="nc bnc" id="L98" title="All 2 branches missed.">				if (needsForecastBacklog) {</span>
<span class="nc" id="L99">					addTraceAndLineIfNeeded(traceChartList, Trace.BACKLOG, TraceChart.FORECAST_LINE, isCurWeek);</span>
				}
<span class="nc bnc" id="L101" title="All 2 branches missed.">				if (needsForecastVAR) {</span>
<span class="nc" id="L102">					addTraceAndLineIfNeeded(traceChartList, Trace.VAR, TraceChart.FORECAST_LINE, isCurWeek);</span>
				}
<span class="nc bnc" id="L104" title="All 2 branches missed.">				if (needsForecastVH) {</span>
<span class="nc" id="L105">					addTraceAndLineIfNeeded(traceChartList, Trace.VH, TraceChart.FORECAST_LINE, isCurWeek);</span>
				}
<span class="nc bnc" id="L107" title="All 2 branches missed.">				if (needsActualVH) {</span>
<span class="nc" id="L108">					addTraceAndLineIfNeeded(traceChartList, Trace.VH, TraceChart.ACTUAL_LINE, isCurWeek);</span>
				}
<span class="nc bnc" id="L110" title="All 2 branches missed.">				if (needsActualAbandonment) {</span>
<span class="nc" id="L111">					addTraceAndLineIfNeeded(traceChartList, Trace.ABANDONMENT, TraceChart.ACTUAL_LINE, isCurWeek);</span>
				}

<span class="nc bnc" id="L114" title="All 2 branches missed.">				if (hasNetStaffing) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">					if (!hasFTE) {</span>
<span class="nc" id="L116">						TraceChart fteTraceChart = new TraceChart(Trace.FTE, TraceChart.ABSOLUTE_CHART, </span>
								new short[] {TraceChart.REQUIRE_LINE}, false);
<span class="nc" id="L118">						traceChartList.add(fteTraceChart);</span>
<span class="nc bnc" id="L119" title="All 4 branches missed.">					} else if (hasFTE &amp;&amp; !hasRequiredFTE) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">						for (int i=0; i&lt;listSize; i++) 	{</span>
<span class="nc" id="L121">							TraceChart traceChart = (TraceChart) traceChartList.get(i);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">							if (traceChart != null) {</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">								if (traceChart.getTraceType() == Trace.FTE) {</span>
<span class="nc" id="L124">									traceChart.getLineType()[TraceChart.REQUIRE_LINE] = true;</span>
<span class="nc" id="L125">									break;</span>
								}
							}
						}
					}
				}
			}
		}
<span class="nc" id="L133">	}</span>
	
	/**
	 * Return true if ActualTraceCube supports the given trace type, false otherwise.
	 */
	private static boolean supportsActuals(short traceType) {
<span class="nc" id="L139">		short[] supported = ActualTraceCube.TYPES;</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">		for (int j = 0; j &lt; supported.length; j++) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">			if (supported[j] == traceType) {</span>
<span class="nc" id="L142">				return true;</span>
			}
		}
<span class="nc" id="L145">		return false;</span>
	}

	/**
	 * Adds the specified trace type and line type to {@code traceChartList} if they are not
	 * already there.
	 * 
	 * @param traceChartList
	 * @param traceType the trace type to be added, from the trace types defined in {@link Trace}
	 * @param lineType the line type to be added, from the line types defined in {@link TraceChart}
	 * @param isCurWeek whether you are viewing the current week in Pulse. If so, we will also add an Actual line if lineType 
	 * 			is Forecast and Actuals are supported for the traceType and Actual line is not already present.
	 */
	private static void addTraceAndLineIfNeeded(List&lt;TraceChart&gt; traceChartList, short traceType, short lineType, boolean isCurWeek) {
<span class="nc" id="L159">		boolean hasTraceType = false;</span>
<span class="nc" id="L160">		boolean hasLineType = false;</span>
<span class="nc" id="L161">		boolean hasActualLine = false;</span>
		
<span class="nc bnc" id="L163" title="All 2 branches missed.">		for (TraceChart traceChart : traceChartList) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">			if (traceChart.getTraceType() == traceType) {</span>
<span class="nc" id="L165">				hasTraceType = true;</span>
<span class="nc" id="L166">				hasLineType = traceChart.getLineType()[lineType];</span>
<span class="nc" id="L167">				hasActualLine = traceChart.getLineType()[TraceChart.ACTUAL_LINE];</span>
<span class="nc" id="L168">				break;</span>
			}
<span class="nc" id="L170">		}</span>
		
<span class="nc bnc" id="L172" title="All 6 branches missed.">		boolean needToAddActualLine = lineType == TraceChart.FORECAST_LINE &amp;&amp; !hasActualLine &amp;&amp; isCurWeek </span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">				&amp;&amp; supportsActuals(traceType);</span>
		
<span class="nc bnc" id="L175" title="All 2 branches missed.">		if ( ! hasLineType ) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">			if ( ! hasTraceType ) {</span>
				short[] linesToAdd;
<span class="nc bnc" id="L178" title="All 2 branches missed.">				if (needToAddActualLine) {</span>
<span class="nc" id="L179">					linesToAdd = new short[] {TraceChart.ACTUAL_LINE, lineType};</span>
				} else {
<span class="nc" id="L181">					linesToAdd = new short[] {lineType};</span>
				}
				
<span class="nc" id="L184">				TraceChart traceChart = new TraceChart(traceType, TraceChart.ABSOLUTE_CHART, linesToAdd, false);</span>
<span class="nc" id="L185">				traceChartList.add(traceChart);</span>
<span class="nc" id="L186">			} else {</span>
<span class="nc" id="L187">				addLineToExistingTrace(traceChartList, traceType, lineType, needToAddActualLine);			</span>
			}
		}
<span class="nc" id="L190">	}</span>
	
	private static void addLineToExistingTrace(List&lt;TraceChart&gt; traceChartList, short traceType, short lineType, 
			boolean needToAddActualLine) {
<span class="nc bnc" id="L194" title="All 2 branches missed.">		for (TraceChart traceChart : traceChartList) {</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">			if (traceChart.getTraceType() == traceType) {</span>
<span class="nc" id="L196">				traceChart.getLineType()[lineType] = true;</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">				if (needToAddActualLine) {</span>
<span class="nc" id="L198">					traceChart.getLineType()[TraceChart.ACTUAL_LINE] = true;</span>
				}
				break;
			}
<span class="nc" id="L202">		}</span>
<span class="nc" id="L203">	}</span>
	

	/**
	 * UI can always use this method to create holding TraceCubes[] for each queue
	 * @param tv
	 * @param qID
	 * @param start
	 * @param end
	 * @return
	 * @throws BbmTimeSeriesException
	 */
	public static TraceCube[] createUICubes(TrackingView tv, ID qID, Date start, Date end) throws BbmTimeSeriesException {
<span class="fc" id="L216">		return createUICubes(tv, qID, start, end, true);</span>
	}
	
	public static TraceCube[] createUICubes(TrackingView tv, ID qID, Date start, Date end, boolean isSPMode) throws BbmTimeSeriesException {
<span class="fc" id="L220">		TraceCube[] uiCubes = new TraceCube[3];</span>
<span class="fc" id="L221">		TraceCube[] metaCubes = tv.getMetaTC(isSPMode);</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">		if (metaCubes[0] != null)</span>
<span class="nc" id="L223">			uiCubes[0] = new ActualTraceCube(qID, start, end, metaCubes[0].getTraceTypes());</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">		if (metaCubes[1] != null)</span>
<span class="fc" id="L225">			uiCubes[1] = new AggrForecastedTraceCube(qID, start, end, metaCubes[1].getTraceTypes());</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">		if (metaCubes[2] != null)</span>
<span class="fc" id="L227">			uiCubes[2] = new AggrRequiredTraceCube(qID, start, end, metaCubes[2].getTraceTypes());			</span>
<span class="fc" id="L228">		return uiCubes;</span>
	}
	
	
	public static void initTraceCube (TraceCube cube) {
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">		if (cube != null) {</span>
<span class="nc" id="L234">			short[] types = cube.getTraceTypes();</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">			for (int j=0; j&lt;types.length; j++) {</span>
<span class="nc" id="L236">				cube.initTraceValue(types[j],Trace.TRACENA);						</span>
			}					
		}
<span class="fc" id="L239">	}</span>
	
	/**
	 * Utility function let UI merge backend returned cubes into aggregated cubes if necessary,
	 * especially in auto refresh mode, backend only return changed cubes, and return lines changed
	 * @param uiCubes
	 * @param backEndCubes
	 * @return
	 * @throws BbmTimeSeriesException
	 */
	public static boolean[] mergeTraceCubes(TraceCube[] uiCubes, TraceCube[] backEndCubes) {
<span class="fc" id="L250">		boolean[] changes = new boolean[3];</span>
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">		if (backEndCubes[0] != null) {</span>
			// Actual is always appending
<span class="nc" id="L253">			short[] types = backEndCubes[0].getTraceTypes();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">			for (int i = 0; i &lt; types.length; i++) {</span>
<span class="nc" id="L255">				uiCubes[0].setTraceValue(types[i], backEndCubes[0].getTraceValueD(types[i]), backEndCubes[0].getRawStartDate()); </span>
			}
<span class="nc" id="L257">			changes[0] = true;</span>
		}
<span class="fc bfc" id="L259" title="All 2 branches covered.">		if (backEndCubes[1] != null) {</span>
<span class="fc" id="L260">			((AggrForecastedTraceCube)uiCubes[1]).setForecastTrace((ForecastTraceCube)backEndCubes[1]);</span>
<span class="fc" id="L261">			changes[1] = true;</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">			if (uiCubes[2] != null) {</span>
				// FCV affects SG 
<span class="fc" id="L264">				((AggrRequiredTraceCube)uiCubes[2]).setForecastTrace(backEndCubes[1]);	</span>
<span class="fc" id="L265">				changes[2] = true;</span>
			}
		}
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">		if (backEndCubes[2] != null) {</span>
<span class="fc" id="L269">			((AggrForecastedTraceCube)uiCubes[1]).setPredictTraceCube((PredictTraceCube)backEndCubes[2]);</span>
<span class="fc" id="L270">			changes[1] = true;</span>
		}
<span class="fc bfc" id="L272" title="All 2 branches covered.">		if (backEndCubes[3] != null) {</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">			if (backEndCubes[3] instanceof ServiceGoalTraceCube) {</span>
<span class="fc" id="L274">				((AggrRequiredTraceCube)uiCubes[2]).setServiceGoalTrace((ServiceGoalTraceCube)backEndCubes[3]);</span>
			} else {
<span class="nc" id="L276">				((AggrRequiredTraceCube)uiCubes[2]).setServiceGoalTrace(((AggrRequiredTraceCube)backEndCubes[3]).getServiceGoalTrace());</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">				if (!changes[2]) {</span>
					// FCV not set
<span class="nc" id="L279">					((AggrRequiredTraceCube)uiCubes[2]).setForecastTrace(((AggrRequiredTraceCube)backEndCubes[3]).getForecastTrace());</span>
				}
			}
<span class="fc" id="L282">			changes[2] = true;</span>
		}
<span class="fc bfc" id="L284" title="All 2 branches covered.">		if (backEndCubes[4] != null) {</span>
<span class="fc" id="L285">			((AggrRequiredTraceCube)uiCubes[2]).setRequireTrace((RequireTraceCube)backEndCubes[4]);</span>
<span class="fc" id="L286">			changes[2] = true;</span>
		}	
<span class="fc" id="L288">		return changes;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>