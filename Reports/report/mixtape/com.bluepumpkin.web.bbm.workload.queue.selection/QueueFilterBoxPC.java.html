<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueFilterBoxPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload.queue.selection</a> &gt; <span class="el_source">QueueFilterBoxPC.java</span></div><h1>QueueFilterBoxPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload.queue.selection;

import java.rmi.RemoteException;
import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.CoreEJBCreateException;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationUtil;
import com.bluepumpkin.web.core.keys.PageKeys;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.jsp.HtmlTable;
import com.witness.web.uif.jsp.HtmlTableCell;
import com.witness.web.uif.jsp.HtmlTableRow;
import com.witness.web.uif.pagecomponent.filterbox.FilterBoxPC;
import com.witness.web.uif.pagecomponent.list.ListBoxPC;
import com.witness.web.uif.pagecomponent.list.OptionData;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.SortUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title:        QueueFilterBoxPC
 * Description:  Filtering for queue
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su
 * @version 1.0
 */
public class QueueFilterBoxPC extends FilterBoxPC {
	private static final String ORGANIZATION_SELECTED = &quot;ORGANIZATION_SELECTED&quot;;
	private static final String CAMPAIGN_SELECTED = &quot;CAMPAIGN_SELECTED&quot;;
<span class="nc" id="L52">	private static final ID BLANK_ID = new ID(0);</span>
	private static final String FILTER_NAME = &quot;queueFilter&quot;;
	private static final String MEDIA_ID_FN = &quot;mediaID&quot;;
	private static final String ORGANIZATION_ID_FN = &quot;organizationID&quot;;
	
<span class="nc" id="L57">	private String m_tempCampaignID = null;</span>

<span class="nc" id="L59">	private Collection m_mediaFilterList = Collections.EMPTY_LIST;</span>
	private ListBoxPC m_mediaListbox;
<span class="nc" id="L61">	private Collection m_organizationFilterList = Collections.EMPTY_LIST;</span>
	private ListBoxPC m_OrganizationListBox;
	
	private ResourceBundle m_bbmBundle;
	private ID m_mediaID;
	private ID m_organizationID;
	private String m_orgCampSelection;
	//To correct the issues while renderign Org picker
<span class="nc" id="L69">	private boolean renderedSpacerRow = false;</span>

	public QueueFilterBoxPC(RequestContext context) {
<span class="nc" id="L72">		super(context);</span>
<span class="nc" id="L73">		setName(FILTER_NAME);</span>

		
<span class="nc" id="L76">		m_bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
		
<span class="nc" id="L78">		m_OrganizationListBox = new ListBoxPC(context);</span>
<span class="nc" id="L79">		addSiblingComponent(m_OrganizationListBox);</span>

<span class="nc" id="L81">		m_mediaListbox = new ListBoxPC(context);</span>
<span class="nc" id="L82">		addSiblingComponent(m_mediaListbox);</span>
		
		

<span class="nc" id="L86">		m_filterWidth = 202;</span>
<span class="nc" id="L87">		setIsActionOptionsEnabled(false);</span>
<span class="nc" id="L88">	}</span>

	/**
	 * Initialize Component For Display
	 */
	public void initForDisplay() {
<span class="nc bnc" id="L94" title="All 2 branches missed.">		if (m_isInitializedForDisplay) return;</span>
		else {   		
<span class="nc" id="L96">			super.initForDisplay();</span>

<span class="nc" id="L98">			String header=i18n(m_bbmBundle, BbmWebBundleKey.FILTERBOX_CAMPAIGN);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">			if(isCampaignPermitted()) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">				if(isOrganizationPermitted()) {</span>
<span class="nc" id="L101">					header = HtmlChoiceInput.makeRadioInput(&quot;orgCampSelection&quot;,</span>
<span class="nc" id="L102">						CAMPAIGN_SELECTED, isCampaignSelected(), JSUtil.REFRESH_PAGE) + header;</span>
				}
			}
			else 
<span class="nc" id="L106">				header = &quot;&quot;;</span>

<span class="nc" id="L108">			setHeader(header);</span>
<span class="nc" id="L109">			initOrganizationListProperties();</span>
<span class="nc" id="L110">			initMediaListProperties();</span>
		}
<span class="nc" id="L112">	}</span>

	
	
	/**
	 * Initialize Media List Properties
	 */
	private void initMediaListProperties() {
<span class="nc" id="L120">		m_mediaListbox.setName(getName() + &quot;_mediaListbox&quot;);</span>
<span class="nc" id="L121">		m_mediaListbox.setMaxDisplayWidth(getListBoxDisplayMaxWidth());</span>
<span class="nc" id="L122">		m_mediaListbox.setHtmlName(MEDIA_ID_FN);</span>
<span class="nc" id="L123">		m_mediaListbox.getSelect().setAttribute(&quot;width&quot;, m_filterWidth + &quot;px&quot;);</span>
<span class="nc" id="L124">		m_mediaListbox.setOptions(m_mediaFilterList);</span>
<span class="nc" id="L125">	}</span>
	
	
	/**
	 * Initialize Organization List Properties
	 */
	private void initOrganizationListProperties() {
<span class="nc" id="L132">		m_OrganizationListBox.setName(getName() + &quot;_organizationListbox&quot;);</span>
<span class="nc" id="L133">		m_OrganizationListBox.setMaxDisplayWidth(getListBoxDisplayMaxWidth());</span>
<span class="nc" id="L134">		m_OrganizationListBox.setHtmlName(ORGANIZATION_ID_FN);</span>
<span class="nc" id="L135">		m_OrganizationListBox.getSelect().setAttribute(&quot;width&quot;, m_filterWidth + &quot;px&quot;);</span>
<span class="nc" id="L136">		Iterator iter = m_organizationFilterList.iterator();</span>
		
		//The below code is added to avoid the growth in width of Org picker
		//when any sub orgs are picked.
		//This is the current indentation used in TreeModelBuilder class to
		//as the indentation between an organization and sub organization.
		//The below logic will replace this two space with a single space thus 
		//saving space - Sankar 
<span class="nc" id="L144">		String indent = HtmlUtil.DD_OPTION_INDENT + HtmlUtil.DD_OPTION_INDENT;</span>
<span class="nc" id="L145">		int indexTemp = -1;</span>
<span class="nc" id="L146">		int index = 0;</span>
<span class="nc" id="L147">		int length = 0;</span>
<span class="nc" id="L148">		StringBuffer newString = null;</span>
		
		
<span class="nc bnc" id="L151" title="All 2 branches missed.">		while(iter.hasNext()) {</span>
<span class="nc" id="L152">			Object value = iter.next();</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">			if( value instanceof OptionData) {</span>
<span class="nc" id="L154">				OptionData data = (OptionData)value;</span>
<span class="nc" id="L155">				String sValue = data.getValue();</span>
<span class="nc" id="L156">				newString = new StringBuffer(&quot;&quot;);</span>
				
<span class="nc" id="L158">				indexTemp = -1;</span>
<span class="nc" id="L159">				index = 0;</span>
<span class="nc" id="L160">				length = 0;</span>
				
<span class="nc bnc" id="L162" title="All 2 branches missed.">				while(index != -1) {</span>
<span class="nc" id="L163">					index = sValue.indexOf(indent, index + length);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">					if(index != -1) {</span>
<span class="nc" id="L165">						newString.append(HtmlUtil.DD_OPTION_INDENT);</span>
					}
					
<span class="nc" id="L168">					length = indent.length();</span>
					//End of string reached
<span class="nc bnc" id="L170" title="All 2 branches missed.">					if(index == -1) {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">						if(indexTemp == -1)</span>
<span class="nc" id="L172">							newString.append(sValue);</span>
						else
<span class="nc" id="L174">							newString.append(sValue.substring(indexTemp + length));</span>
					}
<span class="nc" id="L176">					indexTemp = index;</span>
				}
<span class="nc" id="L178">				data.setValue(newString.toString());</span>
			}			
<span class="nc" id="L180">		}</span>
		
<span class="nc" id="L182">		m_OrganizationListBox.setOptions(m_organizationFilterList);</span>
		
<span class="nc" id="L184">	}</span>

	protected short getListBoxDisplayMaxWidth() {
<span class="nc" id="L187">		return PageKeys.FILTER_MAX_WIDTH;</span>
	}

	/**
	 * Initialize Component
	 *
	 * @param mediaList Media ID used to initialize Component.
	 *   if valud is not null, it will be used as the only media Option
	 */
	public void init(Collection mediaList) throws Exception {
<span class="nc" id="L197">		initFilterDD();</span>
<span class="nc" id="L198">		initFilterDD_Organizations();</span>
<span class="nc" id="L199">		initMediaDD(mediaList);</span>
<span class="nc" id="L200">	}</span>

	public void setMediaID(ID id) {
<span class="nc bnc" id="L203" title="All 2 branches missed.">		if (BLANK_ID.equals(id)) id=null;</span>
<span class="nc" id="L204">		m_mediaID=id;</span>
<span class="nc" id="L205">	}</span>

	public ID getMediaID() {
<span class="nc" id="L208">		return m_mediaID;</span>
	}

	public ID getCampaignID() {
		//isCampaignSelected();
<span class="nc" id="L213">		return QueueFilterUtil.retrieveCampaignID(m_context);</span>
	}
	
	public void setOrganizationID(ID id) {
<span class="nc bnc" id="L217" title="All 4 branches missed.">		if (id == null || BLANK_ID.equals(id)) {</span>
<span class="nc" id="L218">			id=null;</span>
<span class="nc" id="L219">			OrganizationUtil.setSelectedOrganizationID(m_context, &quot;&quot;);</span>
		} else {
<span class="nc" id="L221">			OrganizationUtil.setSelectedOrganizationID(m_context, id.toString());</span>
		}
<span class="nc" id="L223">		m_organizationID = id;</span>
<span class="nc" id="L224">	}</span>

	public ID getOrganizationID() {
<span class="nc" id="L227">		String orgID = OrganizationUtil.getSelectedOrganizationID(m_context);</span>
<span class="nc bnc" id="L228" title="All 4 branches missed.">		if(orgID == null || orgID.trim().length() &lt; 1)</span>
<span class="nc" id="L229">			m_organizationID = null;</span>
		else
<span class="nc" id="L231">			m_organizationID = new ID(orgID);</span>

<span class="nc" id="L233">		return m_organizationID;</span>
	}
	
	public void setOrgCampSelection(String selection) {
<span class="nc bnc" id="L237" title="All 4 branches missed.">		if(selection == null || selection.trim().length() == 0)</span>
<span class="nc" id="L238">			return;</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">		if(selection.equals(CAMPAIGN_SELECTED))</span>
<span class="nc" id="L240">			restoreCampaigID();</span>
		else
<span class="nc" id="L242">			backupCampaignID();</span>
<span class="nc" id="L243">		m_orgCampSelection = selection;</span>
<span class="nc" id="L244">	}</span>

	public String getOrgCampSelection() {
<span class="nc" id="L247">		return m_orgCampSelection;</span>
	}
	
	private void backupCampaignID() {
<span class="nc" id="L251">		m_tempCampaignID = QueueFilterUtil.getSelectedCampaignID(m_context);</span>
<span class="nc bnc" id="L252" title="All 4 branches missed.">		if(m_tempCampaignID != null &amp;&amp; m_tempCampaignID.trim().length() &gt; 0) {</span>
<span class="nc" id="L253">			m_context.setUserProperty(&quot;TEMP_CAMPAIGN_ID&quot;, m_tempCampaignID);</span>
		}
<span class="nc" id="L255">		QueueFilterUtil.setSelectedCampaignID(m_context, &quot;&quot;);</span>

<span class="nc" id="L257">	}</span>
	
	private void restoreCampaigID() {
<span class="nc" id="L260">		m_tempCampaignID = m_context.getUserProperty(&quot;TEMP_CAMPAIGN_ID&quot;);</span>
<span class="nc bnc" id="L261" title="All 4 branches missed.">		if(m_tempCampaignID != null &amp;&amp; m_tempCampaignID.trim().length() &gt; 0){</span>
<span class="nc" id="L262">			QueueFilterUtil.setSelectedCampaignID(m_context, m_tempCampaignID);</span>
<span class="nc" id="L263">			m_context.setUserProperty(&quot;TEMP_CAMPAIGN_ID&quot;, &quot;&quot;);</span>
<span class="nc" id="L264">			m_tempCampaignID = null;</span>
		}
<span class="nc" id="L266">	}</span>
	
	public boolean isOrganizationSelected() {
		//Initial Loading - Set campaign selected by default, if no permission, fall back to Org as default
<span class="nc bnc" id="L270" title="All 4 branches missed.">		if(m_orgCampSelection == null || m_orgCampSelection.trim().length() &lt; 1) {</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">			if(isCampaignPermitted()) {</span>
<span class="nc" id="L272">				setOrgCampSelection(CAMPAIGN_SELECTED);</span>
<span class="nc" id="L273">				return false;</span>
			}
<span class="nc bnc" id="L275" title="All 2 branches missed.">			if(isOrganizationPermitted()) {</span>
<span class="nc" id="L276">				setOrgCampSelection(ORGANIZATION_SELECTED);</span>
<span class="nc" id="L277">				return true;</span>
			}
<span class="nc" id="L279">			return false;</span>
		}
<span class="nc bnc" id="L281" title="All 4 branches missed.">		return m_orgCampSelection.equals(ORGANIZATION_SELECTED) &amp;&amp; isOrganizationPermitted();</span>
	}
	

	public boolean isCampaignSelected() {
		
		//Initial Loading - Set campaign selected by default		
<span class="nc bnc" id="L288" title="All 4 branches missed.">		if(m_orgCampSelection == null || m_orgCampSelection.trim().length() &lt; 1) {</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">			if(isCampaignPermitted()) {</span>
<span class="nc" id="L290">				setOrgCampSelection(CAMPAIGN_SELECTED);</span>
<span class="nc" id="L291">				return true;</span>
			}
<span class="nc" id="L293">			return false;</span>
		}
		
<span class="nc bnc" id="L296" title="All 4 branches missed.">		return  m_orgCampSelection.equals(CAMPAIGN_SELECTED) &amp;&amp; isCampaignPermitted();</span>
	}
	
	/**
	 * Create Media Display with Hidden Field
	 */
	private Object getMediaUI() {
<span class="nc" id="L303">		return m_mediaListbox;</span>
	}

	/**
	 * Create Top Row
	 */
	protected HtmlTableRow createTopRow() {
<span class="nc bnc" id="L310" title="All 2 branches missed.">		if(!isCampaignPermitted()) {</span>
<span class="nc" id="L311">			return createSpacerRow();</span>
		}
		
<span class="nc" id="L314">		ArrayList rowcells = new ArrayList();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">		if (m_isFullDisplayMode) {</span>
<span class="nc" id="L316">			HtmlTableCell cell = createLabelCell(getHeader());</span>
<span class="nc" id="L317">			rowcells.add(cell);</span>
		}
<span class="nc bnc" id="L319" title="All 2 branches missed.">		if(isOrganizationPermitted()) {</span>
<span class="nc" id="L320">			String label = i18n(m_bbmBundle, BbmWebBundleKey.FILTERBOX_ORGANIZATION);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">			if(isCampaignPermitted())</span>
<span class="nc" id="L322">				label = HtmlChoiceInput.makeRadioInput(&quot;orgCampSelection&quot;, ORGANIZATION_SELECTED, isOrganizationSelected(), </span>
						JSUtil.REFRESH_PAGE) + label;
<span class="nc" id="L324">			HtmlTableCell cell = new HtmlTableCell(label + &quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L325">			cell.setHeight(&quot;18&quot;);</span>
<span class="nc" id="L326">			cell.setStyleClass(&quot;headerText&quot;);</span>
<span class="nc" id="L327">			cell.setStyle(&quot;white-space:nowrap;&quot;);</span>
<span class="nc" id="L328">			rowcells.add(cell);</span>
		}
<span class="nc" id="L330">		return new HtmlTableRow(rowcells);</span>
	}
	
	/**
	 * Create Second Row
	 */
	protected HtmlTableRow createSpacerRow() {
<span class="nc" id="L337">		ListBoxPC listBox = null;</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">		if (isCampaignSelected()) {</span>
<span class="nc" id="L339">			listBox = m_listbox;</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">		} else if (isOrganizationSelected()) {</span>
<span class="nc" id="L341">			listBox = m_OrganizationListBox;</span>
		}
<span class="nc" id="L343">		ArrayList rowcells = new ArrayList();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">		if (listBox != null) {</span>
<span class="nc" id="L345">			listBox.getWrapper().setAttribute(&quot;colspan&quot;, &quot;2&quot;);//Wrapper is an HtmlTableCell</span>
<span class="nc" id="L346">			listBox.getSelect().setAttribute(&quot;width&quot;, &quot;241px&quot;);//set a longer width, override the default m_filterWidth</span>
<span class="nc" id="L347">			listBox.setMaxDisplayWidth((short)255);//INPUT width 241px + 14px Button</span>
<span class="nc" id="L348">			rowcells.add(listBox);</span>
		}
<span class="nc" id="L350">		return new HtmlTableRow(rowcells);</span>
	}
	
<span class="nc" id="L353">	private Boolean m_isCampaignPermitted = null;</span>
<span class="nc" id="L354">	private Boolean m_isOrganizationPermitted = null;</span>
	
	private boolean isOrganizationPermitted() {
<span class="nc bnc" id="L357" title="All 2 branches missed.">		if(m_isOrganizationPermitted == null)</span>
<span class="nc" id="L358">			m_isOrganizationPermitted = new Boolean(isLicensed(LicenseKeys.APP_FS));</span>
		//License changes to APP_FS as the org queue mapping is in place currently.
<span class="nc" id="L360">		return m_isOrganizationPermitted.booleanValue();</span>
	}
	
	private boolean isCampaignPermitted() {
<span class="nc bnc" id="L364" title="All 2 branches missed.">		if(m_isCampaignPermitted == null)</span>
<span class="nc" id="L365">			m_isCampaignPermitted = new Boolean(isLicensed(LicenseKeys.APP_FS));</span>
<span class="nc" id="L366">		return m_isCampaignPermitted.booleanValue();</span>
	}

	/**
	 * Return Bottom Row : Media UI
	 */
	public HtmlTableRow createBottomRow() {
<span class="nc" id="L373">		Object rowData = getMediaUI();</span>
<span class="nc" id="L374">		((ListBoxPC)rowData).setGenerateWrapper(false);</span>
<span class="nc" id="L375">		ArrayList rowcells = new ArrayList();</span>
<span class="nc" id="L376">		String label = i18n(m_bbmBundle, BbmWebBundleKey.FILTERBOX_MEDIA);</span>
<span class="nc" id="L377">		HtmlTableCell cell = new HtmlTableCell(label + &quot;&amp;nbsp;&quot; + rowData);</span>
		//cell.setWidth(&quot;35&quot;);
<span class="nc" id="L379">		cell.setHeight(&quot;18&quot;);</span>
<span class="nc" id="L380">		cell.setStyleClass(&quot;headerText&quot;);</span>
<span class="nc" id="L381">		cell.setStyle(&quot;white-space:nowrap;&quot;);</span>
<span class="nc" id="L382">		cell.setAttribute(&quot;colspan&quot;, &quot;2&quot;);</span>
<span class="nc" id="L383">		rowcells.add(cell);</span>
<span class="nc" id="L384">		return new HtmlTableRow(rowcells);</span>
	}

	/**
	 * Extract Parameter
	 */
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L391">		boolean success = super.extractParameters(request);</span>

		// Cache Campaign ID
<span class="nc" id="L394">		String sTmpID = getSelectedFilterName();</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">		if (!StringUtil.isEmpty(sTmpID)) {</span>

			// If One Time Use ID is available then use it instead of extracted value
			// Used by Workpane Refreshing Selection Pane
<span class="nc" id="L399">			ID camID = QueueFilterUtil.retrieveCampaignIDForOneTimeUse(m_context);</span>

<span class="nc bnc" id="L401" title="All 2 branches missed.">			if (camID!=null) sTmpID = camID.toString();</span>

<span class="nc bnc" id="L403" title="All 2 branches missed.">			if (BLANK_ID.toString().equals(sTmpID)) {</span>
				// User Blank Campaign (All Queues Selected)
<span class="nc" id="L405">				QueueFilterUtil.storeCampaignID(m_context, null);</span>
			} else {
<span class="nc" id="L407">				QueueFilterUtil.storeCampaignID(m_context, new ID(sTmpID));</span>
			}
		}

<span class="nc" id="L411">		return success;</span>
	}

	//////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	//////////////////////////////////////////////////////////////////////////////
	private void addBlankOption(List filters, String display, boolean isSelected) {
<span class="nc" id="L418">		OptionData data = new OptionData(display, BLANK_ID.toString(), isSelected);</span>
<span class="nc" id="L419">		filters.add(data);</span>
<span class="nc" id="L420">	}</span>

	/**
	 * init Filter Drown Down of Organizations
	 */
	private void initFilterDD_Organizations() throws Exception {
<span class="nc" id="L426">		ArrayList filters = new ArrayList();</span>
		
		// Create Organization List
<span class="nc" id="L429">		Collection orgList = OrganizationModelHandler.getAllOrgsInUserScopePlusAncestors(m_context, m_context.getUser());//QA100924 getting all parents org as well </span>

		// Retrieve Selected Organization ID
<span class="nc" id="L432">		ID orgID = getOrganizationID();</span>

		
		// Add All Queues Option
<span class="nc bnc" id="L436" title="All 2 branches missed.">		if (m_context.getUser().isAuthorized(PrivilegeKeys.FS_VIEWALLQUEUEHISTORY_ID))</span>
		{
      // verticalise queue
<span class="nc" id="L439">      Object[] args = new Object[1];</span>
<span class="nc" id="L440">      args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="nc" id="L441">      String formattedTitle = MessageFormat.format( m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.ALL_QUEUES), args);</span>

<span class="nc" id="L443">      addBlankOption(filters, formattedTitle, false);</span>
<span class="nc" id="L444">			filters.add( FILTER_OPTION_DIVIDER );</span>
<span class="nc" id="L445">		}</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">		else if (orgID == null)</span>
		{
			//User cannot see the 'All Queues' selection, and there is no cached campaign,
			//so we will just choose the first campaign for him.
<span class="nc bnc" id="L450" title="All 2 branches missed.">			if (orgList != null)</span>
			{
<span class="nc" id="L452">				orgList = SortUtil.sortBasicVO(orgList, m_localizer);</span>
<span class="nc" id="L453">				Organization org = null;</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">				for (Iterator it = orgList.iterator(); it.hasNext();)</span>
				{
<span class="nc" id="L456">					org = (Organization) it.next();</span>
					break;
				}

<span class="nc bnc" id="L460" title="All 2 branches missed.">				if (org != null)</span>
<span class="nc" id="L461">					orgID = org.getID();</span>
			}
		}

<span class="nc bnc" id="L465" title="All 2 branches missed.">		String selectedID = orgID==null?null:orgID.toString();</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">		if(orgList != null) {</span>
<span class="nc" id="L467">			Collection optionList = CampaignModelHandler.createDropDownValueList(orgList, selectedID, m_localizer, false);</span>
<span class="nc" id="L468">			filters.addAll(optionList);</span>
		}
				

		//initFilterWithOptions(filters);
<span class="nc" id="L473">		m_organizationFilterList = filters;</span>
<span class="nc" id="L474">	}</span>

	
	/**
	 * init Filter Drown Down of Campaigns
	 */
	private void initFilterDD() throws Exception {
<span class="nc bnc" id="L481" title="All 2 branches missed.">		if(!isCampaignSelected()) {</span>
<span class="nc" id="L482">			backupCampaignID();</span>
<span class="nc" id="L483">			return;</span>
		}
		
<span class="nc" id="L486">		ArrayList filters = new ArrayList();</span>
		
		// Create Campaign List
<span class="nc" id="L489">		Collection campList = CampaignModelHandler.getCampaignsForUser(m_context, m_context.getUser());</span>

		// Retrieve Selected campaign ID
<span class="nc" id="L492">		ID camID = getCampaignID();</span>
		
		// Add All Queues Option
<span class="nc bnc" id="L495" title="All 2 branches missed.">		if (m_context.getUser().isAuthorized(PrivilegeKeys.FS_VIEWALLQUEUEHISTORY_ID))</span>
		{
      // verticalise queue
<span class="nc" id="L498">      Object[] args = new Object[1];</span>
<span class="nc" id="L499">      args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="nc" id="L500">      String formattedTitle = MessageFormat.format( m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.ALL_QUEUES), args);</span>

<span class="nc" id="L502">      addBlankOption(filters, formattedTitle, false);</span>
<span class="nc" id="L503">			filters.add( FILTER_OPTION_DIVIDER );</span>
<span class="nc" id="L504">		}</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">		else if (camID == null)</span>
		{
			//User cannot see the 'All Queues' selection, and there is no cached campaign,
			//so we will just choose the first campaign for him.
<span class="nc bnc" id="L509" title="All 2 branches missed.">			if (campList != null)</span>
			{
<span class="nc" id="L511">				campList = SortUtil.sortBasicVO(campList, m_localizer);</span>
<span class="nc" id="L512">				Campaign camp = null;</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">				for (Iterator it = campList.iterator(); it.hasNext();)</span>
				{
<span class="nc" id="L515">					camp = (Campaign) it.next();</span>
					break;
				}

<span class="nc bnc" id="L519" title="All 2 branches missed.">				if (camp != null)</span>
<span class="nc" id="L520">					camID = camp.getID();</span>
				
<span class="nc bnc" id="L522" title="All 2 branches missed.">				QueueFilterUtil.setSelectedCampaignID(m_context, camID==null?null:camID.toString());</span>
			}
		}

<span class="nc bnc" id="L526" title="All 2 branches missed.">		String selectedID = camID==null?null:camID.toString();</span>

<span class="nc" id="L528">		Collection optionList = CampaignModelHandler.createDropDownValueList(campList, selectedID, m_localizer, false);</span>
<span class="nc" id="L529">		filters.addAll(optionList);</span>

<span class="nc" id="L531">		initFilterWithOptions(filters);</span>
<span class="nc" id="L532">	}</span>
	/**
	 * Initialize the Media Drop Down
	 */
	private void initMediaDD(Collection mediaList) throws Exception {    
<span class="nc bnc" id="L537" title="All 4 branches missed.">		if (mediaList!=null &amp;&amp; !mediaList.isEmpty()) {</span>
<span class="nc" id="L538">			ID selectedID = getMediaID();</span>
<span class="nc" id="L539">			ArrayList filters = new ArrayList(mediaList.size() + 1);</span>
<span class="nc" id="L540">			addBlankOption(filters, &quot;&quot;, false);</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">			for (Iterator it = mediaList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L542">				Media media = (Media)it.next();</span>
<span class="nc" id="L543">				ID mediaID = media.getID();</span>
<span class="nc" id="L544">				boolean isSelected = mediaID.equals(selectedID);</span>
<span class="nc" id="L545">				OptionData data = new OptionData(media.getName(), mediaID.toString(), isSelected);</span>
<span class="nc" id="L546">				filters.add(data);</span>
<span class="nc" id="L547">			}</span>
<span class="nc" id="L548">			m_mediaFilterList = filters;</span>
		}
<span class="nc" id="L550">	}</span>
	
	/**
	 * Return Html Display
	 * Sankar Nair - Overriding this function to ensure that
	 * the alignment of selector pane is matching to Pulse applet 
	 * when both the Campaign picker and Org picker are shown. 
	 */
	public String getHtmlDisplay() {
		// initialize the filters in the listbox
<span class="nc" id="L560">		m_listbox.setOptions(getFilters());</span>

<span class="nc" id="L562">		HtmlTable outer_table = new HtmlTable(&quot;0&quot;, &quot;0&quot;, &quot;0&quot;);</span>
<span class="nc" id="L563">		outer_table.setWidth(&quot;204&quot;);</span>
<span class="nc" id="L564">		outer_table.add( createTopRow() );</span>
<span class="nc" id="L565">		outer_table.add( createSpacerRow() );</span>

		// Show bottom is it is in Full Display Mode
<span class="nc bnc" id="L568" title="All 2 branches missed.">		if (m_isFullDisplayMode) {</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">			if (m_isBottomRowEnabled)	outer_table.add( createBottomRow() );</span>
<span class="nc" id="L570">			else outer_table.add( createEmptyBottomRow() );</span>
		}

		//Length specified in the FilterBoxPC class
<span class="nc" id="L574">		String height = &quot;12&quot;;</span>
		//Checking whether both the Org picker and Campaign picker are going to be displayed.
<span class="nc bnc" id="L576" title="All 4 branches missed.">		if(isCampaignPermitted() &amp;&amp; isOrganizationPermitted())</span>
<span class="nc" id="L577">			height = &quot;2&quot;;</span>
		
		// Generate HTML output
<span class="nc" id="L580">		StringBuffer buff = new StringBuffer(1024);</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">		if (useWrapper()) {</span>
<span class="nc" id="L582">			buff.append(&quot;\n&lt;div style=\&quot;margin-top:&quot;);</span>
<span class="nc" id="L583">			buff.append(height);</span>
<span class="nc" id="L584">			buff.append(&quot;px; margin-bottom:7px;\&quot;&gt;&quot;);</span>
		}
		
		

<span class="nc" id="L589">		buff.append(outer_table);</span>
<span class="nc" id="L590">		buff.append(HtmlUtil.makeHiddenInput(getName(), &quot;&quot;));</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">		if (useWrapper()) buff.append(&quot;\n&lt;/div&gt;&quot;);</span>

<span class="nc" id="L593">		return buff.toString();</span>
	}
	
	private boolean isLicensed(String license) {
		//LicenseKeys.APP_FS;
		//LicenseKeys.APP_Operations
<span class="nc bnc" id="L599" title="All 4 branches missed.">		if(license == null || license.trim().length() &lt; 1)</span>
<span class="nc" id="L600">			return false;</span>
		try {
<span class="nc" id="L602">			return CoreManagerFactory.getLicenseManager().isLicensed(license);</span>
<span class="nc" id="L603">		} catch (CoreEJBCreateException e) {</span>
<span class="nc" id="L604">		} catch (RemoteException e) {</span>
<span class="nc" id="L605">		}</span>
<span class="nc" id="L606">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>