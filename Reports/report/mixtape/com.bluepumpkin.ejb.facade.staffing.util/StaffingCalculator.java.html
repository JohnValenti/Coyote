<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StaffingCalculator.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.facade.staffing.util</a> &gt; <span class="el_source">StaffingCalculator.java</span></div><h1>StaffingCalculator.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.facade.staffing.util;

import java.rmi.RemoteException;
import java.util.*;

import com.bluepumpkin.bpxCommon.common.Base.StopWatch;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.audit.ejb.EventAuditTrailManager;
import com.bluepumpkin.ejb.bbm.audit.model.AuditTrailEntry;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.FacadeException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignWorkResource;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.datasourcegroup.ejb.GroupManager;
import com.bluepumpkin.ejb.bbm.datasourcegroup.model.Group;
import com.bluepumpkin.ejb.bbm.people.ejb.PeopleFacade;
import com.bluepumpkin.ejb.bbm.queuegroup.ejb.QueueGroupManager;
import com.bluepumpkin.ejb.bbm.skill.ejb.SkillManager;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.timerecord.ejb.TimeRecordManager;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecord;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecordEntry;
import com.bluepumpkin.ejb.bbm.timeseries.ejb.TimeSeriesManager;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.QueueSkill;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.facade.FacadeManagerFactory;
import com.verint.ejb.wfm.WfmManagerFactory;

public class StaffingCalculator
{
  public static final int DEFAULT_INTERVAL = 15; //15min
  public static final long DEFAULT_INTERVAL_MILLIS = 900000L; //15min
<span class="nc" id="L49">  private static String ejbTrace = &quot;_EJB_&quot;;</span>
  
<span class="nc" id="L51">  private static int SP_CALC_MAX_RETRY = 3;</span>

  private Category cat;
  private StopWatch stw;
<span class="nc" id="L55">  private EventAuditTrailManager m_auditmgr = null;</span>
  private StaffingInfo m_info;
  
  public StaffingCalculator( Category category )
<span class="nc" id="L59">  {</span>
<span class="nc" id="L60">    this.cat = category;</span>
<span class="nc" id="L61">    this.stw = new StopWatch(category);</span>
<span class="nc" id="L62">  }</span>

  public void shutdown()
  {
	try
	{
<span class="nc bnc" id="L68" title="All 2 branches missed.">		if(m_auditmgr != null )</span>
<span class="nc" id="L69">			m_auditmgr.remove();</span>
	}
<span class="nc" id="L71">	catch( Exception ex ) {}</span>
	
<span class="nc bnc" id="L73" title="All 2 branches missed.">	if( m_info != null )</span>
<span class="nc" id="L74">		m_info.shutdown();</span>
<span class="nc" id="L75">  }</span>
  
  public void calculateStaffing(Collection dsColl,
                                       Date startDate,
                                       Date endDate,
                                       long lookBackDays,
                                       long empChunkSize,
                                       boolean isIncremental)
             throws FacadeException, RemoteException
  {
<span class="nc" id="L85">    this.calculateStaffing(dsColl,</span>
                           startDate,
                           endDate,
                           startDate,
                           lookBackDays,
                           empChunkSize,
                           isIncremental);
<span class="nc" id="L92">  }</span>

  public void calculateStaffing(Collection dsColl,
                                       Date startDate,
                                       Date endDate,
                                       Date lastQueryDate,
                                       long lookBackDays,
                                       long empChunkSize,boolean isIncremental )
             throws FacadeException, RemoteException
  {
<span class="nc" id="L102">    this.calculateStaffing(dsColl,</span>
                           startDate,
                           endDate,
                           lastQueryDate,
                           lookBackDays,
                           empChunkSize,
                           false,
                           isIncremental);
<span class="nc" id="L110">  }</span>

  public void calculateStaffing(Collection dsColl,
          Date startDate,
          Date endDate,
          Date lastQueryDate,
          long lookBackDays,
          long empChunkSize,
          boolean enableProfiling,boolean isIncremental )
  	throws FacadeException, RemoteException
  	{
<span class="nc" id="L121">	    this.calculateStaffing(dsColl,</span>
                startDate,
                endDate,
                lastQueryDate,
                lookBackDays,
                empChunkSize,
                enableProfiling,
                false,isIncremental);
<span class="nc" id="L129">  	}</span>

  public void calculateStaffing(Collection dsColl,
                                       Date startDate,
                                       Date endDate,
                                       Date lastQueryDate,
                                       long lookBackDays,
                                       long empChunkSize,
                                       boolean enableProfiling,
                                       boolean computeActual,
                                       boolean isIncremental)
      throws FacadeException, RemoteException

  {
<span class="nc" id="L143">    this.stw.setIsEnabled(enableProfiling);</span>
<span class="nc" id="L144">    this.stw.start( &quot;Begin staffing calculator&quot;);</span>
    
<span class="nc" id="L146">    initStaffingInfo(startDate, endDate, lastQueryDate, lookBackDays,</span>
			empChunkSize, computeActual,isIncremental);

    try
    {
      // Get all employee ID's
<span class="nc" id="L152">      Collection empColl = getEmployeeIDs(m_info.endDate);</span>
<span class="nc bnc" id="L153" title="All 4 branches missed.">      if (empColl == null || empColl.size() &lt;= 0)</span>
      {
<span class="nc" id="L155">        this.stw.logDebug(&quot;calculateStaffing(): No employees found&quot;);</span>
<span class="nc" id="L156">        return;</span>
      }

      // Get queues assigned to the datasources
<span class="nc" id="L160">      Collection dsqColl = m_info.getDatasource2Queues(dsColl);</span>
<span class="nc bnc" id="L161" title="All 4 branches missed.">      if (dsqColl == null || dsqColl.size() == 0)</span>
      {
<span class="nc" id="L163">        this.stw.logDebug(&quot;calculateStaffing(): No queues mapped for datasources&quot; );</span>
<span class="nc" id="L164">        return;</span>
      }

<span class="nc" id="L167">      m_info.allEmpColl = empColl;</span>
<span class="nc" id="L168">      m_info.dsColl = dsColl;</span>
<span class="nc" id="L169">      m_info.dsqColl = dsqColl;</span>
      
      try
      {
<span class="nc" id="L173">      	this.getEventAuditTrailManager();</span>
      }
<span class="nc" id="L175">      catch( Exception ex )</span>
      {
<span class="nc" id="L177">      	this.cat.l7dError(&quot;Exception during initializaton of AuditTrail EJB&quot;+ex.getMessage(), ex);</span>
<span class="nc" id="L178">      	return;</span>
<span class="nc" id="L179">      }</span>

      // Collection of changed intervals
<span class="nc" id="L182">      Collection intvlColl = null;</span>
      
<span class="nc bnc" id="L184" title="All 2 branches missed.">      if(!m_info.isIncremental){</span>
<span class="nc" id="L185">    	  intvlColl = getIntervalsToProcess(m_info);</span>
<span class="nc" id="L186">    	  calcStaffingForIntervals(intvlColl);</span>
      }else{    	  
<span class="nc" id="L188">    	  processStaffingBySP(m_info);</span>
      }
       

      
    }
<span class="nc" id="L194">    catch( Exception ex )</span>
    {
<span class="nc" id="L196">      throw new FacadeException(ex);</span>
    }

    finally
    {
<span class="nc" id="L201">      this.stw.stop();</span>
<span class="nc" id="L202">      this.stw.logObjectDuration();</span>
<span class="nc" id="L203">    }</span>
<span class="nc" id="L204">  }</span>

private void calcStaffingForIntervals(Collection intvlColl) throws Exception  {
	
<span class="nc" id="L208">	Iterator iter = intvlColl.iterator();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">      while (iter.hasNext())</span>
      {
<span class="nc" id="L211">        TimeRange tr = (TimeRange) iter.next();</span>
<span class="nc" id="L212">        m_info.startDate = tr.getStartDate();</span>
<span class="nc" id="L213">        m_info.endDate = tr.getEndDate();</span>
        
<span class="nc" id="L215">        calculateStaffing(m_info);</span>
<span class="nc" id="L216">      }</span>
<span class="nc" id="L217">}</span>

private void getEventAuditTrailManager() throws BbmEJBCreateException {
<span class="nc" id="L220">	m_auditmgr = BbmManagerFactory.getEventAuditTrailManager();</span>
<span class="nc" id="L221">}</span>

public void initStaffingInfo(Date startDate, Date endDate, Date lastQueryDate,
		long lookBackDays, long empChunkSize, boolean computeActual,boolean isIncremental) {
<span class="nc" id="L225">	this.m_info = new StaffingInfo(this.cat, this.stw);</span>

    // if we missed intervals the last query will be before the start
    // so we shift the start date, this will cover the missed intervals
<span class="nc bnc" id="L229" title="All 6 branches missed.">    if( lastQueryDate != null &amp;&amp;  lastQueryDate.before(startDate) &amp;&amp;  lookBackDays &gt; 0 )</span>
<span class="nc" id="L230">    	m_info.startDate = lastQueryDate;</span>
    else
<span class="nc" id="L232">    	m_info.startDate = startDate; </span>
<span class="nc" id="L233">    m_info.endDate = endDate;</span>
<span class="nc" id="L234">    m_info.lastQueryDate = lastQueryDate;</span>
<span class="nc" id="L235">    m_info.lookBackDays = lookBackDays;</span>
<span class="nc" id="L236">    m_info.empChunkSize = empChunkSize;</span>
<span class="nc" id="L237">    m_info.computeActual = computeActual;</span>
<span class="nc" id="L238">    m_info.isIncremental = isIncremental;</span>
<span class="nc" id="L239">}</span>

/**]
 * 
 * @param info
 * @throws RemoteException
 * @throws BbmFinderException
 * @throws BbmEJBCreateException
 * @throws Exception
 */
 private void processStaffingBySP(StaffingInfo info) throws RemoteException, BbmFinderException, BbmEJBCreateException,Exception{
	 
	 try {
<span class="nc" id="L252">			Collection&lt;TimeRange&gt; intvlColl = new ArrayList&lt;TimeRange&gt;();</span>
<span class="nc" id="L253">			intvlColl.add(new TimeRange(info.startDate, info.endDate));</span>
<span class="nc" id="L254">			Date newStartDate = this.adjustStartByLookBack(info);</span>
<span class="nc" id="L255">			Date orignialEndDate = info.endDate;</span>
<span class="nc" id="L256"> 			HashMap&lt;ID,Collection&lt;TimeRange&gt;&gt; hmEmpTr = this.getChangedIntervalsFromAuditTrail(info, newStartDate);</span>
<span class="nc" id="L257">			Map &lt;SchedulingPeriod,Collection&lt;TimeRange&gt;&gt; mapSpTR = this.getEffectedTRBySP(info.cmMgr, hmEmpTr);</span>
			Collection&lt;ID&gt; failedSPIds ;
			
			//Process the staffingCaclulationBy SP
<span class="nc bnc" id="L261" title="All 4 branches missed.">			if(mapSpTR != null &amp;&amp; !mapSpTR.isEmpty()){</span>
<span class="nc" id="L262">				SchedulingPeriod loopSp = null;</span>
<span class="nc" id="L263">				failedSPIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">				for(Map.Entry&lt;SchedulingPeriod,Collection&lt;TimeRange&gt;&gt; mapEntry: mapSpTR.entrySet()){</span>
					
<span class="nc" id="L266">					intvlColl = mapEntry.getValue();</span>
<span class="nc" id="L267">					loopSp = mapEntry.getKey();</span>
					
<span class="nc" id="L269">					failedSPIds.addAll(processStaffingBySpNEffectedRange(info, intvlColl,orignialEndDate, loopSp));</span>
					
<span class="nc" id="L271">				}</span>
<span class="nc" id="L272">			}else{</span>
<span class="nc" id="L273">				this.cat.l7dInfo(&quot;The Employees with Changed TimeRecords don't belong to any Scheduling Period&quot;);</span>
			}
<span class="nc" id="L275">		} catch (Exception e) {</span>
			
<span class="nc" id="L277">			this.cat.l7dError(&quot;Exception in processStaffingBySP :&quot;+e.getMessage());</span>
<span class="nc" id="L278">			throw e;</span>
<span class="nc" id="L279">		}</span>
<span class="nc" id="L280"> }</span>
 /**
  * 
  * @param info
  * @param intvlColl
  * @param cutOffDate
  * @param loopSp
  * @return
  * @throws BbmFinderException
  * @throws Exception
  */
 
 //TODO throw only Exception handle valid BBMFinder for retry
private Collection&lt;ID&gt; processStaffingBySpNEffectedRange(StaffingInfo info,
		Collection&lt;TimeRange&gt; intvlColl, Date cutOffDate,SchedulingPeriod loopSp) throws Exception  {
	
<span class="nc" id="L296">	intvlColl = this.getUnionOfChangedIntervals(cutOffDate,intvlColl);</span>
	
<span class="nc" id="L298">	int nMaxRetry = SP_CALC_MAX_RETRY;</span>
<span class="nc" id="L299">	int nRetry = 1;</span>
<span class="nc" id="L300">	Collection&lt;ID&gt; colFailedSPs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L301">	for (; true; nRetry++)</span>
	{
		try
		{	
<span class="nc" id="L305">			this.stw.logDebug( &quot;Calc staffing for SP ID:&quot;+loopSp.getID() + &quot;For Time Ranges :&quot;+intvlColl);</span>
			
<span class="nc" id="L307">			info.modifiedEmpColl = info.cmMgr.getWorkResourceIDsBySchedulingPeriod(loopSp);</span>
<span class="nc" id="L308">			calcStaffingForIntervals(intvlColl);</span>
		
<span class="nc" id="L310">		}catch (BbmFinderException e){</span>
			
<span class="nc bnc" id="L312" title="All 2 branches missed.">			if (nRetry &lt; nMaxRetry)</span>
			{
<span class="nc" id="L314">				this.stw.logDebug(&quot;Exception in processStaffingBySpNEffectedRange: retry count = &quot; + new Integer(nRetry));</span>
<span class="nc" id="L315">				continue;</span>
			}
			
<span class="nc bnc" id="L318" title="All 2 branches missed.">			if(nRetry == nMaxRetry) {</span>
				
<span class="nc" id="L320">				colFailedSPs.add(loopSp.getID());</span>
<span class="nc" id="L321">				this.cat.l7dError(&quot;Exception in calcStaffingForIntervals failed for SP Id: &quot; + loopSp.getID()+&quot; for:&quot;+intvlColl);</span>
				
			}
<span class="nc" id="L324">		}</span>
<span class="nc" id="L325">		break;</span>
	}
<span class="nc" id="L327">	return colFailedSPs;</span>
	
	
}

  private Collection getIntervalsToProcess( StaffingInfo info ) throws RemoteException, BbmFinderException, BbmEJBCreateException
  {
<span class="nc" id="L334">    this.stw.start(&quot;getIntervalsToProcess&quot;);</span>

    try
    {

    // contains a list of timerange objects
<span class="nc" id="L340">    ArrayList retVal = new ArrayList();</span>
    //add the requested start/end dates
<span class="nc" id="L342">    retVal.add( new TimeRange(info.startDate, info.endDate) );</span>
    
    //TODO proceed further only if the lookBack is 0
    //The intervals to process are not at all fetched when the lookBackDays &lt;=0
<span class="nc bnc" id="L346" title="All 4 branches missed.">    if( info.lookBackDays &lt;= 0 || !info.isIncremental )</span>
    {
<span class="nc" id="L348">      return retVal;</span>
    }

    // Now get the list of changed intervals

<span class="nc" id="L353">    Date newStartDate = this.adjustStartByLookBack(info);</span>

<span class="nc" id="L355">    HashMap hmEmpTr = this.getChangedIntervalsFromAuditTrail(info, newStartDate);</span>
    
  

<span class="nc bnc" id="L359" title="All 2 branches missed.">    if( hmEmpTr == null )</span>
    {
<span class="nc" id="L361">      return retVal;</span>
    }

<span class="nc" id="L364">      Iterator iter = hmEmpTr.values().iterator();</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">      while( iter.hasNext() )</span>
      {
<span class="nc" id="L367">        Collection trColl = (Collection)iter.next();</span>
<span class="nc" id="L368">        retVal.addAll(trColl);</span>
<span class="nc" id="L369">      }</span>

<span class="nc" id="L371">      this.cat.info(&quot;getIntervalsToProcess(): Getting union start=&quot; + newStartDate.toString() +</span>
<span class="nc" id="L372">                        &quot; end=&quot; + info.endDate.toString() +</span>
<span class="nc" id="L373">                        &quot; retVal=&quot; + retVal.toString() );</span>

<span class="nc" id="L375">     return this.getUnionOfChangedIntervals(info.endDate, retVal );</span>
     }

     finally
     {
<span class="nc" id="L380">         this.stw.stop();</span>
     }
  }

private HashMap getChangedIntervalsFromAuditTrail(StaffingInfo info,
		Date newStartDate) throws BbmFinderException, RemoteException {
	// Get the new end date Pranith:Ajdusting the end date to the info.startDate as in the previous line the startDate has been pushed by LookbackDays.
<span class="nc" id="L387">    Date newEndDate = info.startDate;</span>

    // Check if the staffing was run at least once
<span class="nc bnc" id="L390" title="All 2 branches missed.">    if( info.lastQueryDate == null )</span>
    {
<span class="nc" id="L392">    	info.lastQueryDate = newStartDate;</span>
    }

<span class="nc" id="L395">    this.cat.info(&quot;getChangedIntervalsFromAuditTrail: ******* newStart=&quot; + newStartDate +</span>
                       &quot; newEndDate=&quot; + newEndDate +
                       &quot; lastQueryDate=&quot; + info.lastQueryDate );

<span class="nc" id="L399">    this.stw.start(&quot;EJB getChangedIntervalsForWorkResource&quot;, this.ejbTrace );</span>

<span class="nc" id="L401">    HashMap hmEmpTr = m_auditmgr.getChangedIntervalsForWorkResource(info.allEmpColl, </span>
    								AuditTrailEntry.MODULE_TIMERECORD, 
    								AuditTrailEntry.ACTION_ALL, 
    								newStartDate, 
    								newEndDate, 
    								info.lastQueryDate,
    								&quot;&lt;anonymous&gt;&quot;);
<span class="nc" id="L408">    this.stw.stop();</span>
    
<span class="nc bnc" id="L410" title="All 4 branches missed.">    if(hmEmpTr != null &amp;&amp; !hmEmpTr.isEmpty()){</span>
<span class="nc" id="L411">    	this.cat.l7dInfo(&quot;There were no Employee's found with changed Time records&quot;);</span>
    }
    
<span class="nc" id="L414">	return hmEmpTr;</span>
}

private Date adjustStartByLookBack(StaffingInfo info) {
	// Get the new start start date
<span class="nc" id="L419">    long millis = info.lookBackDays * 86400000L;  // millis for days</span>
<span class="nc" id="L420">    long startMillis = info.startDate.getTime();</span>
<span class="nc" id="L421">    long newMillis = startMillis - millis;</span>

<span class="nc" id="L423">    Date newStartDate = new Date( newMillis );</span>
<span class="nc" id="L424">	return newStartDate;</span>
}
  
/**
 * Changing the effected TR collection from By Employee to By Scheduling Period
 * @param cmgr
 * @param mapOfEmpIdEffectedTR
 * @return
 * @throws BbmFinderException
 * @throws RemoteException
 */
private Map &lt;SchedulingPeriod,Collection&lt;TimeRange&gt;&gt; getEffectedTRBySP(CampaignManager cmgr,Map&lt;ID, Collection&lt;TimeRange&gt;&gt; mapOfEmpIdEffectedTR)
		throws BbmFinderException, RemoteException {
	
<span class="nc" id="L438">	Collection&lt;CampaignWorkResource&gt; collCampAssignments = null;</span>
	
		
<span class="nc" id="L441">	Map &lt;SchedulingPeriod,Collection&lt;TimeRange&gt;&gt; mapofSPEffectedTR = new HashMap&lt;SchedulingPeriod, Collection&lt;TimeRange&gt;&gt;();</span>
	
<span class="nc bnc" id="L443" title="All 2 branches missed.">	for (Map.Entry&lt;ID, Collection&lt;TimeRange&gt;&gt; entry : mapOfEmpIdEffectedTR.entrySet()) {</span>
		
<span class="nc" id="L445">		Collection&lt;TimeRange&gt; trCollByEmp = entry.getValue();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">		for (TimeRange tr : trCollByEmp) {</span>

<span class="nc" id="L448">			collCampAssignments = cmgr.getWorkResourceCampaignAssignments(entry.getKey(),tr.getStartDate(), tr.getEndDate());</span>
<span class="nc" id="L449">			this.stw.logDebug(&quot;CampaignWorkResource assignments for Effected TR changes for Employee:&quot;+entry.getKey()+&quot; Assignments:&quot;+collCampAssignments);</span>
			
<span class="nc bnc" id="L451" title="All 2 branches missed.">			if(collCampAssignments != null){</span>
				
<span class="nc bnc" id="L453" title="All 2 branches missed.">				for(CampaignWorkResource cw :collCampAssignments){</span>
<span class="nc" id="L454">					SchedulingPeriod loopSp = new SchedulingPeriod();					</span>
<span class="nc" id="L455">					loopSp.setID(cw.getSPID());</span>
<span class="nc" id="L456">					loopSp.setStartTime(cw.getStartTime());</span>
<span class="nc" id="L457">					loopSp.setEndTime(cw.getEndTime());</span>
<span class="nc" id="L458">					Collection&lt;TimeRange&gt; trCollBySP = new ArrayList&lt;TimeRange&gt;();</span>
					
<span class="nc bnc" id="L460" title="All 2 branches missed.">					if(!mapofSPEffectedTR.containsKey(loopSp)) {</span>
<span class="nc" id="L461">						trCollBySP.add(tr);</span>
<span class="nc" id="L462">						mapofSPEffectedTR.put(loopSp, trCollBySP);</span>
					}else{
<span class="nc" id="L464">						mapofSPEffectedTR.get(loopSp).add(tr);</span>
					}
<span class="nc" id="L466">				}</span>
				
			}
<span class="nc" id="L469">		}</span>
<span class="nc" id="L470">	}</span>
<span class="nc" id="L471">	return mapofSPEffectedTR;</span>
}
  


  public Collection getUnionOfChangedIntervals( Date endDate,
                                                 Collection trColl )
  {
<span class="nc" id="L479">    this.stw.start(&quot;getUnionOfChangedIntervals&quot;);</span>

<span class="nc" id="L481">    this.cat.info(&quot;getUnionOfChangedIntervals(): Intervals to unify=&quot; + trColl.toString() );</span>

<span class="nc" id="L483">    ArrayList retVal = new ArrayList();</span>

<span class="nc bnc" id="L485" title="All 2 branches missed.">    if( trColl.size() &gt; 1 ) // processing required only if more than one</span>
    {
<span class="nc" id="L487">      TreeSet tsChg = new TreeSet();</span>

<span class="nc" id="L489">      Iterator trIter = trColl.iterator();</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">      while (trIter.hasNext()) {</span>

<span class="nc" id="L492">        TimeRange tr = (TimeRange) trIter.next();</span>

        // This will reject events that don't start in the requested interval
<span class="nc" id="L495">        Date trStart = tr.getStartDate();</span>

<span class="nc bnc" id="L497" title="All 2 branches missed.">        if (trStart.after(endDate) ||</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">            trStart.equals(endDate) ||</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">            tr.isInstant( ))</span>
        {
<span class="nc" id="L501">          continue;</span>
        }

        // sort and remove duplicates
<span class="nc" id="L505">        tsChg.add(tr);</span>
<span class="nc" id="L506">      }</span>

<span class="nc" id="L508">      TimeRange startCmp = null;</span>


<span class="nc" id="L511">      Iterator chgIter = tsChg.iterator();</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">      while (chgIter.hasNext())</span>
      {
<span class="nc" id="L514">        TimeRange cmp = (TimeRange) chgIter.next();</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">        if (startCmp == null)</span>

        {
<span class="nc" id="L518">          startCmp = cmp;</span>
<span class="nc" id="L519">          continue;</span>
        }

<span class="nc" id="L522">	long start = startCmp.getStartDate().getTime();</span>
<span class="nc" id="L523">	long end = startCmp.getEndDate().getTime();</span>

<span class="nc" id="L525">	long m_start = cmp.getStartDate().getTime();</span>
<span class="nc" id="L526">	long m_end = cmp.getEndDate().getTime();</span>

<span class="nc bnc" id="L528" title="All 4 branches missed.">	if( m_start &gt;= start &amp;&amp; m_start &lt;= end ) //starts after</span>
        {
<span class="nc bnc" id="L530" title="All 2 branches missed.">          if( m_end &lt;= end ) // in between</span>
<span class="nc" id="L531">            continue;</span>
          else  //overlap or adjacent
<span class="nc" id="L533">            startCmp.setEndDate(cmp.getEndDate()); //extend the end date</span>
        }
        else //no overlap
        {
<span class="nc" id="L537">          retVal.add(startCmp);</span>
<span class="nc" id="L538">          startCmp = cmp;</span>

        }
<span class="nc" id="L541">      }</span>

<span class="nc bnc" id="L543" title="All 2 branches missed.">      if( startCmp != null ) //add the last one</span>
      {
<span class="nc" id="L545">        retVal.add(startCmp);</span>

      }
<span class="nc" id="L548">    }</span>
    else //add the only element
<span class="nc" id="L550">      retVal.addAll(trColl);</span>


<span class="nc" id="L553">    this.cat.info(&quot;getUnionOfChangedIntervals(): Unified intervals=&quot; + retVal.toString() );</span>

<span class="nc" id="L555">    this.stw.stop();</span>

<span class="nc" id="L557">   return retVal;</span>
  }

  public void calculateStaffing(StaffingInfo info) throws Exception
  {
<span class="nc" id="L562">    this.stw.start(&quot;calculateStaffing&quot;);</span>

    try
    {

<span class="nc" id="L567">    long intervalMillis = DEFAULT_INTERVAL_MILLIS;</span>

    // Check date/time
<span class="nc bnc" id="L570" title="All 2 branches missed.">    if( info.startDate.after(info.endDate)  )</span>
    {

<span class="nc" id="L573">         this.stw.logDebug(&quot;calculateStaffing(): Invalid start/end dates: start=&quot; +</span>
                           info.startDate + &quot; end=&quot; + info.endDate);
<span class="nc" id="L575">      return;</span>
    }

    // If dates are same shift the start date by 15min
<span class="nc bnc" id="L579" title="All 2 branches missed.">    if( info.startDate.equals(info.endDate) )</span>
    {
<span class="nc" id="L581">      info.startDate = new Date( info.endDate.getTime() - (intervalMillis) );</span>
    }

    // if the diff is less than the interval
<span class="nc bnc" id="L585" title="All 2 branches missed.">    if( info.endDate.getTime() -  info.startDate.getTime() &lt; DEFAULT_INTERVAL_MILLIS )</span>
    {
<span class="nc" id="L587">      info.endDate = new Date( info.endDate.getTime() + DEFAULT_INTERVAL_MILLIS );</span>
    }

    // Align start/end date to INTERVAL
<span class="nc" id="L591">    info.startDate = TraceUtil.snapDate(info.startDate);</span>

    // find remainder and add 15min so that end date covers the
    // the next 15 min interval
<span class="nc" id="L595">    Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L596">    cal.setTime( info.endDate );</span>
<span class="nc" id="L597">    int min = cal.get( cal.MINUTE );</span>
<span class="nc" id="L598">    int rem = min % DEFAULT_INTERVAL;</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">    if( rem != 0 )</span>
    {
<span class="nc" id="L601">      cal.set( cal.MINUTE, min + DEFAULT_INTERVAL );</span>
<span class="nc" id="L602">      info.endDate = cal.getTime();</span>
    }
<span class="nc" id="L604">    info.endDate = TraceUtil.snapDate(info.endDate);</span>

<span class="nc" id="L606">    long count = (info.endDate.getTime() - info.startDate.getTime())/ intervalMillis;</span>

<span class="nc" id="L608">      this.stw.logDebug(&quot;calculateStaffing(): No of intervals to calculate staffing=&quot; +</span>
                                  count +
                                  &quot; start=&quot; + info.startDate +
                                  &quot; end=&quot; + info.endDate );

<span class="nc" id="L613">    long startMillis = info.startDate.getTime();</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">    for( int i=0; i &lt; count; ++i )</span>
    {
<span class="nc" id="L616">      info.startDate = new Date( startMillis );</span>
<span class="nc" id="L617">      info.endDate = new Date( startMillis + intervalMillis );</span>

      // calculate staffing
<span class="nc" id="L620">      info.init();</span>
<span class="nc" id="L621">      calculateStaffingForInterval( info );</span>

<span class="nc" id="L623">      startMillis = info.endDate.getTime();</span>
    }

    }

    finally
    {
<span class="nc" id="L630">        this.stw.stop();</span>
<span class="nc" id="L631">    }</span>
<span class="nc" id="L632">  }</span>


  private void calculateStaffingForInterval(StaffingInfo info )
      throws RemoteException, BbmFinderException, BbmEJBCreateException, FacadeException, BbmCreateException
  {
<span class="nc" id="L638">    this.stw.start(&quot;calculateStaffingForInterval&quot;);</span>

    try
    {
    
<span class="nc" id="L643">    Collection empColl = new ArrayList();</span>
    
<span class="nc bnc" id="L645" title="All 4 branches missed.">    if(info.lookBackDays &gt; 0 &amp;&amp; info.isIncremental){</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">    	empColl = info.modifiedEmpColl != null? info.modifiedEmpColl:Collections.EMPTY_LIST;</span>
    	
    }else{
    	
<span class="nc" id="L650">    	empColl = info.allEmpColl;</span>
    }
    
<span class="nc" id="L653">    this.stw.logDebug( &quot;calculateStaffing():********** STAFFING start=&quot; +</span>
            info.startDate +
            &quot; millis=&quot; +
<span class="nc" id="L656">            info.startDate.getTime() +</span>
            &quot; end=&quot; +
            info.endDate +
            &quot; empCount=&quot; +
<span class="nc" id="L660">            empColl.size() );</span>

    
<span class="nc" id="L663">    Iterator iter = empColl.iterator();</span>
<span class="nc" id="L664">    int fromIndex = 0;</span>
<span class="nc" id="L665">    int toIndex = 0;</span>

<span class="nc bnc" id="L667" title="All 2 branches missed.">    for( fromIndex=0; fromIndex &lt; empColl.size(); fromIndex = toIndex)</span>
    {
<span class="nc" id="L669">      ArrayList empList = new ArrayList();</span>
<span class="nc" id="L670">      toIndex = fromIndex;</span>
<span class="nc" id="L671">      for(  toIndex=fromIndex;</span>
<span class="nc bnc" id="L672" title="All 4 branches missed.">            toIndex &lt; fromIndex+info.empChunkSize &amp;&amp; toIndex &lt; empColl.size();</span>
<span class="nc" id="L673">            ++toIndex )</span>
      {
<span class="nc" id="L675">        empList.add(iter.next());</span>
      }


<span class="nc" id="L679">        this.stw.logDebug( &quot;calculateStaffing():********** Processing  empStart=&quot; +</span>
                         fromIndex +
                         &quot; empEnd=&quot; +
                          toIndex +
                         &quot; ***************&quot;);

<span class="nc" id="L685">      info.empColl = empList;</span>

<span class="nc" id="L687">      info.preFetch();</span>
<span class="nc" id="L688">      calculateStaffingForEmployeeChunk( info );</span>
    }

<span class="nc" id="L691">    updateStaffing(info);</span>
    }

    finally
    {
<span class="nc" id="L696">      this.stw.stop();</span>
<span class="nc" id="L697">    }</span>
<span class="nc" id="L698">  }</span>

  private void calculateStaffingForEmployeeChunk( StaffingInfo info )
      throws RemoteException, BbmFinderException, BbmEJBCreateException
  {
<span class="nc" id="L703">    this.stw.start(&quot;calculateStaffingForEmployeeChunk&quot;);</span>

    try
    {

    // for each employee get the hash map of media 2 duration
<span class="nc" id="L709">    Iterator empIter = info.empColl.iterator();</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">    while( empIter.hasNext() )</span>
    {
<span class="nc" id="L712">      ID empID = (ID)empIter.next();</span>
<span class="nc" id="L713">      Collection trColl = (Collection)info.hmTR.get(empID);</span>
<span class="nc bnc" id="L714" title="All 4 branches missed.">      if( trColl == null || trColl.size() &lt;= 0 )</span>
      {

<span class="nc" id="L717">           this.stw.logDebug(&quot;calculateStaffing():No Time records found for empID=&quot; +</span>
                           empID );

<span class="nc" id="L720">        continue;</span>
      }

      // for each timerecord get the staffing
<span class="nc" id="L724">      Iterator recIter = trColl.iterator();</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">      while( recIter.hasNext() )</span>
      {
<span class="nc" id="L727">        TimeRecord trec = (TimeRecord)recIter.next();</span>

<span class="nc" id="L729">        Collection childColl = trec.getChildren();</span>
<span class="nc bnc" id="L730" title="All 4 branches missed.">        if( childColl == null || childColl.size() &lt;= 0 )</span>
        {

<span class="nc" id="L733">            this.stw.logDebug(&quot;calculateStaffing():No Time entries found for empID=&quot; +</span>
                           empID );
<span class="nc" id="L735">          continue; //no entries found for the timerecord</span>
        }


<span class="nc" id="L739">          this.stw.logDebug(&quot;calculateStaffing():************** EMPID &quot; +</span>
                             empID + &quot; ***************&quot; );

        // Get the activity duration from time record entries
<span class="nc" id="L743">        HashMap media2Duration = getMedia2Agents( childColl, info );</span>

<span class="nc bnc" id="L745" title="All 4 branches missed.">        if( media2Duration == null || media2Duration.size() &lt; 1 )</span>
        {

<span class="nc" id="L748">            this.stw.logDebug(&quot;calculateStaffing():No valid time entries found for empID=&quot; +</span>
                               empID );
<span class="nc" id="L750">          continue;</span>
        }

        // update the global media list with the staffing info
<span class="nc" id="L754">        info.media2Duration.put(empID, media2Duration);</span>
<span class="nc" id="L755">      }</span>
<span class="nc" id="L756">    }</span>

<span class="nc" id="L758">    HashMap hmQueColl = getQueues( info );</span>
<span class="nc bnc" id="L759" title="All 4 branches missed.">    if( hmQueColl != null &amp;&amp; hmQueColl.size() &gt; 0 )</span>
    {
<span class="nc" id="L761">      ArrayList updatedQueueIds = new ArrayList();</span>
<span class="nc" id="L762">      Iterator hmQueIter = hmQueColl.keySet().iterator();</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">      while (hmQueIter.hasNext())</span>
      {
<span class="nc" id="L765">        ID empID = (ID) hmQueIter.next();</span>
<span class="nc" id="L766">        Collection queColl = (Collection) hmQueColl.get(empID);</span>
<span class="nc" id="L767">        Iterator queIter = queColl.iterator();</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">        while (queIter.hasNext())</span>
        {
<span class="nc" id="L770">        	StaffingData data = (StaffingData)queIter.next();</span>
<span class="nc" id="L771">        	ID id = data.queID;</span>
        	//fetch SP ID for a given Queue
<span class="nc" id="L773">          ID spID = (ID)info.hmCombinedQue.get(id);</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">          if( spID != null )</span>
          {//Staffing data against each SP
<span class="nc" id="L776">	          HashSet hmCQ = (HashSet)info.hmCCQStaff.get(spID);</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">	          if( hmCQ == null )</span>
	          {
<span class="nc" id="L779">	            hmCQ = new HashSet();</span>
<span class="nc" id="L780">	            info.hmCCQStaff.put(spID, hmCQ);</span>
	          }
<span class="nc" id="L782">	          hmCQ.add(data);</span>
          }

<span class="nc" id="L785">          this.updateQueCount(id,</span>
                                 info.que2Agents,
                                 data,
                                info );

<span class="nc" id="L790">          ID parQueID = info.getParentQueID(id);</span>
<span class="nc" id="L791">          this.updateQueCount(parQueID,</span>
                                 info.que2Agents,
                                 data,
                                info );


<span class="nc" id="L797">            this.stw.logDebug(&quot;calculateStaffing():Adding count empID=&quot; +</span>
              empID +
              &quot; queID=&quot; + id + &quot; parQue=&quot; + parQueID);
<span class="nc" id="L800">            updatedQueueIds.add(id);</span>
<span class="nc" id="L801">        }</span>
        //fix QC 78473 Staffing Calculator - some intervals are blank (not zero)
<span class="nc" id="L803">        Long duration = new Long(0L);</span>
<span class="nc" id="L804">        Iterator iter = info.hmcamQColl.keySet().iterator();</span>
        
<span class="nc bnc" id="L806" title="All 2 branches missed.">        while( iter.hasNext() )</span>
        {
<span class="nc" id="L808">           Collection queueColl = (Collection)info.hmcamQColl.get(iter.next());</span>
<span class="nc" id="L809">           Iterator iterQueColl = queueColl.iterator();</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">           while( iterQueColl.hasNext() )</span>
           {
<span class="nc" id="L812">             ID queID = (ID)iterQueColl.next();</span>
<span class="nc bnc" id="L813" title="All 4 branches missed.">             if( !info.que2Agents.containsKey(queID) &amp;&amp; !updatedQueueIds.contains(queID))</span>
             {
<span class="nc" id="L815">            	 StaffingData data = new StaffingData();</span>
<span class="nc" id="L816">                 data.empID = null;</span>
<span class="nc" id="L817">                 data.queID = queID;</span>
<span class="nc" id="L818">                 data.duration = duration;</span>
<span class="nc" id="L819">             	this.updateQueCount(queID,</span>
             						info.que2Agents,
             						data,
             						info );

             }
<span class="nc" id="L825">           }</span>
<span class="nc" id="L826">        }</span>
<span class="nc" id="L827">      }</span>
<span class="nc" id="L828">    }</span>
    else // update ques linked to campaign with zero
    {
<span class="nc" id="L831">       Long duration = new Long(0L);</span>

<span class="nc" id="L833">       Iterator iter = info.hmcamQColl.keySet().iterator();</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">       while( iter.hasNext() )</span>
       {
<span class="nc" id="L836">          Collection queColl = (Collection)info.hmcamQColl.get(iter.next());</span>
<span class="nc" id="L837">          Iterator iterQueColl = queColl.iterator();</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">          while( iterQueColl.hasNext() )</span>
          {
<span class="nc" id="L840">            ID queID = (ID)iterQueColl.next();</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">            if( !info.que2Agents.containsKey(queID) )</span>
            {
<span class="nc" id="L843">                StaffingData data = new StaffingData();</span>
<span class="nc" id="L844">                data.empID = null;</span>
<span class="nc" id="L845">                data.queID = queID;</span>
<span class="nc" id="L846">                data.duration = duration;</span>
<span class="nc" id="L847">            	this.updateQueCount(queID,</span>
                                  info.que2Agents,
                                 data,
                                info );
<span class="nc" id="L851">              this.updateQueCount(info.getParentQueID(queID),</span>
                                  info.que2Agents,
                                 data,
                                info );
            }
<span class="nc" id="L856">          }</span>
<span class="nc" id="L857">       }</span>
    }

    }

    finally
    {
<span class="nc" id="L864">      this.stw.stop();</span>
<span class="nc" id="L865">    }</span>
<span class="nc" id="L866">  }</span>

  private void updateQueCount( ID queID,
          HashMap hmQue,
          StaffingData data,
          StaffingInfo info )
{
<span class="nc" id="L873">	  this.stw.start(&quot;updateQueCount&quot;);</span>

	  try
	  {
<span class="nc bnc" id="L877" title="All 2 branches missed.">		  if( queID == null )</span>
<span class="nc" id="L878">			  return;</span>

<span class="nc bnc" id="L880" title="All 2 branches missed.">		  if( data == null )</span>
<span class="nc" id="L881">			  return;</span>

<span class="nc" id="L883">		  Queue que = (Queue)info.hmQueObj.get(queID);</span>
<span class="nc" id="L884">		  HashSet empColl = (HashSet)hmQue.get(queID);</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">		  if( empColl == null )</span>
		  {
<span class="nc" id="L887">			  empColl = new HashSet();</span>
<span class="nc" id="L888">			  hmQue.put(queID, empColl);</span>
		  }

<span class="nc bnc" id="L891" title="All 2 branches missed.">		  if( data.empID != null )</span>
		  {
<span class="nc bnc" id="L893" title="All 2 branches missed.">			  if (empColl.contains(data)){</span>
<span class="nc" id="L894">				  Iterator it = empColl.iterator();</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">				  while (it.hasNext()){</span>
<span class="nc" id="L896">					  StaffingData existingData = (StaffingData) it.next();</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">					  if ( existingData.empID.equals(data.empID) &amp;&amp;</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">							  existingData.queID.equals(data.queID) ){</span>
<span class="nc" id="L899">						  long duration = existingData.duration.longValue();</span>
<span class="nc" id="L900">						  duration += data.duration.longValue();</span>
<span class="nc" id="L901">						  existingData.duration = new Long(duration);</span>
<span class="nc" id="L902">						  this.stw.logDebug( &quot;Summing duration for: que=&quot; + queID + &quot; emp=&quot; + data.empID +</span>
								  &quot; total duration =&quot; + existingData.duration );
<span class="nc" id="L904">						  break;</span>
					  }
<span class="nc" id="L906">				  }</span>

<span class="nc" id="L908">			  } else {</span>
<span class="nc" id="L909">				  empColl.add(data);</span>
			  }
		  }

<span class="nc" id="L913">		  this.stw.logDebug( &quot;updateQueCount(): que=&quot; + queID + &quot; emp=&quot; + data.empID +</span>
<span class="nc" id="L914">				  					&quot; numEmployees=&quot; + empColl.size() );</span>
	  }

	  finally
	  {
<span class="nc" id="L919">		  this.stw.stop();</span>
<span class="nc" id="L920">	  }</span>
<span class="nc" id="L921">	}</span>
  private Long computeStaffingValues( Collection coll, StaffingInfo info )
  {
	  try
	  {
<span class="nc" id="L926">		  this.stw.start( &quot;computeStaffingValues(): ********* computing staffing values&quot; );</span>

<span class="nc bnc" id="L928" title="All 4 branches missed.">		  if( coll == null || coll.size() &lt;= 0 )</span>
<span class="nc" id="L929">			  return new Long(0);</span>

<span class="nc bnc" id="L931" title="All 4 branches missed.">		  if( coll.size() &lt;= 0 || info.computeActual )</span>
<span class="nc" id="L932">			  return new Long( coll.size() );</span>

		  // Duration based computing
<span class="nc" id="L935">		  ID queID = null;</span>
<span class="nc" id="L936">		  double totDuration = 0.0;</span>
<span class="nc" id="L937">		  Iterator iter = coll.iterator();</span>
<span class="nc bnc" id="L938" title="All 2 branches missed.">		  while( iter.hasNext() )</span>
		  {
<span class="nc" id="L940">			  StaffingData data = (StaffingData)iter.next();</span>
<span class="nc" id="L941">			  queID = data.queID;</span>
<span class="nc" id="L942">			  totDuration += data.duration.longValue();</span>
<span class="nc" id="L943">		  }</span>
<span class="nc" id="L944">		  totDuration /= DEFAULT_INTERVAL_MILLIS;</span>
<span class="nc" id="L945">		  long staff = Math.round( totDuration  );</span>

<span class="nc" id="L947">		  this.stw.logDebug( &quot;computeStaffingValues(): ********* que=&quot; + queID + &quot; totalDuration=&quot; +</span>
<span class="nc" id="L948">				  totDuration + &quot; numEmployees=&quot; + coll.size() +  &quot; staff=&quot; + staff );</span>

<span class="nc" id="L950">		  return new Long(staff);</span>
	  }
    finally
    {
<span class="nc" id="L954">      this.stw.stop();</span>
    }
  }

  private void updateStaffing( StaffingInfo info )
        throws RemoteException, BbmFinderException, BbmEJBCreateException, BbmCreateException
  {
<span class="nc" id="L961">    this.stw.start(&quot;updateStaffing&quot;);</span>

    try
    {
<span class="nc" id="L965">      TimeSeriesManager mgr = WfmManagerFactory.getTimeSeriesManager();</span>
<span class="nc" id="L966">      WorkloadManager wlmgr = WfmManagerFactory.getWorkloadManager();</span>

<span class="nc" id="L968">      ArrayList queColl = new ArrayList();</span>
<span class="nc" id="L969">      HashMap hmCQueStaffing = new HashMap();</span>
<span class="nc" id="L970">      HashMap hmQue2SP = new HashMap( info.hmCombinedQue );</span>

<span class="nc" id="L972">      Iterator iter = info.que2Agents.keySet().iterator();</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">      while( iter.hasNext() )</span>
      {
<span class="nc" id="L975">        ID queID = (ID)iter.next();</span>

<span class="nc" id="L977">        Long staff = new Long(0);</span>

<span class="nc" id="L979">        Queue que = (Queue)info.hmQueObj.get(queID);</span>

<span class="nc" id="L981">    	  staff = this.computeStaffingValues( (Collection)info.que2Agents.get(queID), info );</span>

<span class="nc bnc" id="L983" title="All 4 branches missed.">        if( staff.longValue() == 0 &amp;&amp; info.isUnknownActivity )</span>
        {
<span class="nc" id="L985">          staff = new Long(Trace.TRACENA);</span>
        }

<span class="nc" id="L988">        queColl.clear();</span>
<span class="nc" id="L989">        queColl.add(queID);</span>

        // add child virtual ques from datasource
        // since these are not linked in a campaign
<span class="nc bnc" id="L993" title="All 2 branches missed.">        if( que.getQueueType() == Queue.QUEUE_TYPE_VIRTUAL )</span>
        {
<span class="nc" id="L995">	        Iterator dsqIter = info.dsqColl.iterator();</span>
<span class="nc bnc" id="L996" title="All 2 branches missed.">	        while( dsqIter.hasNext() )</span>
	        {
<span class="nc" id="L998">	      	  ID dsQueID = (ID)dsqIter.next();</span>
<span class="nc" id="L999">	      	  Queue dsQue = (Queue)info.hmQueObj.get(dsQueID);</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">	      	  if( dsQue != null )</span>
	      	  {
<span class="nc" id="L1002">	      		  ID parQueID = dsQue.getParentID();</span>
<span class="nc bnc" id="L1003" title="All 4 branches missed.">	      		  if( parQueID != null &amp;&amp; parQueID.equals(queID) )</span>
	      		  {
<span class="nc" id="L1005">	      			  queColl.add(dsQueID);</span>
	      		  }
	      	  }
<span class="nc" id="L1008">	        }</span>
        }

<span class="nc" id="L1011">        Iterator queIter = queColl.iterator();</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">        while( queIter.hasNext() )</span>
        {
<span class="nc" id="L1014">	        this.stw.logDebug(&quot;updateStaffing(): ********* Updating que=&quot; + queIter.next() +</span>
	                                      &quot; staff=&quot; + staff +
	                                      &quot; startDate=&quot; + info.startDate +
	                                      &quot; ************** &quot;);
        }

<span class="nc" id="L1020">        this.stw.start(&quot;EJB createActualTimeSeries&quot;, this.ejbTrace );</span>
<span class="nc" id="L1021">        mgr.createActualTimeSeries( Trace.STAFFING,</span>
                                    queColl,
<span class="nc" id="L1023">                                    staff.intValue(),</span>
                                    info.startDate );


<span class="nc" id="L1027">        ID spID = (ID)hmQue2SP.get(queID);</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">        if( spID != null )</span>
        {
          // calculate for each media
<span class="nc" id="L1031">          this.calculateCombinedQStaffingForSP(hmCQueStaffing,</span>
                                          spID,
                                          staff,
                                          info,
                                          queID);

<span class="nc" id="L1037">          hmQue2SP.remove(queID);</span>
        }

<span class="nc" id="L1040">        this.stw.stop();</span>
<span class="nc" id="L1041">      }</span>

      // update info for remaining combined queues with zero
<span class="nc bnc" id="L1044" title="All 2 branches missed.">      if( hmQue2SP.size() &gt; 0 )</span>
      {
<span class="nc" id="L1046">    	  Long zeoVal = new Long(0L);</span>
<span class="nc" id="L1047">    	  Iterator hmque2SPiter = hmQue2SP.keySet().iterator();</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">    	  while( hmque2SPiter.hasNext() )</span>
    	  {
<span class="nc" id="L1050">    		  ID queID = (ID)hmque2SPiter.next();</span>
<span class="nc" id="L1051">              this.calculateCombinedQStaffingForSP(hmCQueStaffing,</span>
<span class="nc" id="L1052">            		  (ID)hmQue2SP.get(queID),</span>
                      zeoVal,
                      info,
                      queID);

<span class="nc" id="L1057">    	  }</span>
      }


      // update the combined queue staffing values in database
<span class="nc bnc" id="L1062" title="All 2 branches missed.">      if( hmCQueStaffing.size() &gt; 0 )</span>
      {
<span class="nc" id="L1064">        Iterator cqIter = hmCQueStaffing.values().iterator();</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">        while (cqIter.hasNext())</span>
        {
<span class="nc" id="L1067">          Object value[] = (Object[]) cqIter.next();</span>
<span class="nc" id="L1068">          ID spQueID = (ID)value[0];</span>
<span class="nc" id="L1069">          ID mediaID = (ID)value[1];</span>
<span class="nc" id="L1070">          Collection coll = (Collection)value[2];</span>
<span class="nc" id="L1071">          Long cqStaff = this.computeStaffingValues(coll, info);</span>

          try
          {
<span class="nc" id="L1075">            this.stw.logDebug( &quot;updateStaffing(): ********* Updating combined queue spID=&quot; +</span>
                               spQueID +
                               &quot; media=&quot; +
                               mediaID +
                               &quot; staff=&quot; +
<span class="nc" id="L1080">                               cqStaff.longValue() );</span>

<span class="nc" id="L1082">            wlmgr.updateCombinedQueueStaffing(spQueID,</span>
                mediaID,
<span class="nc" id="L1084">                cqStaff.floatValue(),</span>
                info.startDate);
          }
<span class="nc" id="L1087">          catch( Exception ex )</span>
          {
        //    ex.printStackTrace();
<span class="nc" id="L1090">          }</span>
<span class="nc" id="L1091">        }</span>
      }

    }

    finally
    {
<span class="nc" id="L1098">      this.stw.stop();</span>
<span class="nc" id="L1099">    }</span>
<span class="nc" id="L1100">  }</span>

  private void calculateCombinedQStaffingForSP( HashMap hmCQueStaffing,
          ID spQueID,
          Long staff,
		  StaffingInfo info,
		  ID queID)
  {
<span class="nc" id="L1108">      Queue cque = (Queue)info.hmQueObj.get(queID);</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">      if( cque == null )</span>
<span class="nc" id="L1110">    	  return;</span>

<span class="nc" id="L1112">      ID media = new ID(cque.getMediaStrID().trim().hashCode());</span>

      // calculate for each media
<span class="nc" id="L1115">      this.calculateCombinedQStaffing(hmCQueStaffing,</span>
    		  							spQueID,
    		  							media,
    		  							staff,
    		  							queID,
    		  							info);

      // calculate overall
<span class="nc" id="L1123">      this.calculateCombinedQStaffing(hmCQueStaffing,</span>
    		  							spQueID,
    		  							null,
    		  							staff,
    		  							queID,
    		  							info);

<span class="nc" id="L1130">  }</span>

  private void calculateCombinedQStaffing( HashMap hmCQueStaffing,
                                           ID spQueID,
                                           ID mediaID,
                                           Long staff,
                                           ID queID,
										   StaffingInfo info)
  {
<span class="nc" id="L1139">    String key = spQueID.toString();</span>
<span class="nc bnc" id="L1140" title="All 2 branches missed.">    if( mediaID != null )</span>
    {
<span class="nc" id="L1142">      key += mediaID.toString();</span>
    }

<span class="nc" id="L1145">	Collection coll = null;</span>
<span class="nc bnc" id="L1146" title="All 2 branches missed.">	if( mediaID != null )</span>
<span class="nc" id="L1147">		coll = (Collection)info.que2Agents.get(queID);</span>
    else
<span class="nc" id="L1149">		coll = (HashSet)info.hmCCQStaff.get(spQueID);</span>

<span class="nc bnc" id="L1151" title="All 2 branches missed.">	if( staff.longValue() == Trace.TRACENA )</span>
	{
<span class="nc" id="L1153">		coll = null;</span>
	}
<span class="nc bnc" id="L1155" title="All 2 branches missed.">	else if( coll == null )</span>
	{
<span class="nc" id="L1157">		coll = Collections.EMPTY_LIST;</span>
	}

<span class="nc" id="L1160">	Object value[] = (Object[])hmCQueStaffing.get(key);</span>
<span class="nc bnc" id="L1161" title="All 2 branches missed.">    if( value == null )</span>
    {
<span class="nc bnc" id="L1163" title="All 2 branches missed.">    	if( coll != null )</span>
    	{
<span class="nc" id="L1165">    		coll = new TreeSet(coll);</span>
    	}
<span class="nc" id="L1167">        value = new Object[] { spQueID, mediaID, coll };</span>
<span class="nc" id="L1168">        hmCQueStaffing.put(key, value);</span>
    }
<span class="nc bnc" id="L1170" title="All 2 branches missed.">    else if( mediaID != null )</span>
    {
<span class="nc" id="L1172">    	Collection sColl = (Collection)value[2];</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">    	if( coll != null )</span>
    	{
<span class="nc bnc" id="L1175" title="All 2 branches missed.">    		if( sColl == null )</span>
    		{
<span class="nc" id="L1177">    			value[2] = sColl = new TreeSet();</span>
    		}
<span class="nc" id="L1179">    		sColl.addAll(coll);</span>
    	}
	}
<span class="nc" id="L1182">  }</span>

	private HashMap getQueues(StaffingInfo info)
		throws RemoteException, BbmFinderException, BbmEJBCreateException
	{
<span class="nc" id="L1187">		this.stw.start(&quot;getQueues&quot;);</span>

<span class="nc" id="L1189">		HashMap hmQueColl = new HashMap();</span>

<span class="nc" id="L1191">		Iterator empIter = info.media2Duration.keySet().iterator();</span>
<span class="nc bnc" id="L1192" title="All 2 branches missed.">		while (empIter.hasNext()) {</span>
<span class="nc" id="L1193">			ID empID = (ID)empIter.next();</span>
<span class="nc" id="L1194">			HashMap media2Duration = (HashMap)info.media2Duration.get(empID);</span>

			// List of assigned skill ID's for agent
<span class="nc" id="L1197">			ArrayList saIDColl = new ArrayList();</span>

			// Get the list of assigned skills for the agent
<span class="nc" id="L1200">			Collection saColl = (Collection)info.hmsaColl.get(empID);</span>
<span class="nc bnc" id="L1201" title="All 4 branches missed.">			if (saColl != null &amp;&amp; saColl.size() &gt; 0) {</span>
<span class="nc" id="L1202">				Iterator saIter = saColl.iterator();</span>
<span class="nc bnc" id="L1203" title="All 2 branches missed.">				while (saIter.hasNext()) {</span>
<span class="nc" id="L1204">					SkillAssignment sa = (SkillAssignment)saIter.next();</span>

<span class="nc bnc" id="L1206" title="All 2 branches missed.">					if (sa.isReserve()) // skip reserve skills</span>
					{
<span class="nc" id="L1208">						continue;</span>
					}

<span class="nc" id="L1211">					saIDColl.add(sa.getSkillID());</span>
<span class="nc" id="L1212">				}</span>
<span class="nc" id="L1213">			}</span>
			else {
<span class="nc" id="L1215">				this.stw.logDebug(&quot;getQueues(): No skills found for empId=&quot; + empID);</span>
			}

			// List of que ID's to be updated
<span class="nc" id="L1219">			ArrayList queColl = new ArrayList();</span>

			// Get campaigns linked to agent
<span class="nc" id="L1222">			Collection campColl = (Collection)info.hmcampColl.get(empID);</span>
<span class="nc bnc" id="L1223" title="All 4 branches missed.">			if (campColl == null || campColl.size() &lt;= 0) {</span>
<span class="nc" id="L1224">				this.stw.logDebug(&quot;getQueues(): No campaigns found for empID=&quot; + empID);</span>
<span class="nc" id="L1225">				continue;</span>
			}

			// Get queues linked to campaign
<span class="nc" id="L1229">			Iterator campIter = campColl.iterator();</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">			while (campIter.hasNext()) {</span>
<span class="nc" id="L1231">				CampaignWorkResource cw = (CampaignWorkResource)campIter.next();</span>
<span class="nc" id="L1232">				ID campID = cw.getCampaignID();</span>
<span class="nc" id="L1233">				Collection cqColl = (Collection)info.hmcamQColl.get(campID);</span>
<span class="nc bnc" id="L1234" title="All 4 branches missed.">				if (cqColl == null || cqColl.size() &lt;= 0) {</span>
<span class="nc" id="L1235">					this.stw.logDebug(&quot;getQueues(): No queues mapped for campaign=&quot; + campID);</span>
<span class="nc" id="L1236">					continue;</span>
				}

				// get datasource/queue for the employee
<span class="nc" id="L1240">				Collection eqColl = info.dsqColl;</span>

				// For each queue, check for valid skill &amp; media
<span class="nc" id="L1243">				Iterator cqIter = cqColl.iterator();</span>
<span class="nc bnc" id="L1244" title="All 2 branches missed.">				while (cqIter.hasNext()) {</span>
<span class="nc" id="L1245">					ID queID = (ID)cqIter.next();</span>

					// skip queues not mapped to data source
<span class="nc bnc" id="L1248" title="All 6 branches missed.">					if (eqColl == null || eqColl.size() &lt;= 0 || !eqColl.contains(queID)) {</span>
<span class="nc" id="L1249">						this.stw.logDebug(&quot;getQueues(): ******* Employee ID=&quot;</span>
							+ empID
							+ &quot; or Campaign queID=&quot; + queID
							+ &quot; is not mapped to data source &quot;
							+ info.dsColl);
<span class="nc" id="L1254">						continue;</span>
					}

<span class="nc" id="L1257">					Queue que = (Queue)info.hmQueObj.get(queID);</span>

<span class="nc" id="L1259">					boolean addQue = true;</span>

<span class="nc" id="L1261">					Collection qsColl = (Collection)info.hmqsColl.get(queID);</span>

<span class="nc bnc" id="L1263" title="All 2 branches missed.">					if (qsColl != null) {</span>
						// If queue is associated with skill, check if agent
						// has all the skills
<span class="nc" id="L1266">						Iterator qsIter = qsColl.iterator();</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed.">						while (qsIter.hasNext()) {</span>
<span class="nc" id="L1268">							QueueSkill qs = (QueueSkill)qsIter.next();</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">							if (qs == null) {</span>

<span class="nc" id="L1271">								this.stw.logDebug(&quot;getQueues(): Que &quot; + queID</span>
									+ &quot; does not have skill assignment&quot;);
<span class="nc" id="L1273">								continue;</span>
							}

							// check if que id from the assignment is valid i.e.
							// it is associated with the current campaign
<span class="nc" id="L1278">							ID qsID = qs.getQueueID();</span>
<span class="nc bnc" id="L1279" title="All 2 branches missed.">							if (info.hmQueObj.get(qsID) == null) {</span>
<span class="nc" id="L1280">								continue;</span>
							}

<span class="nc bnc" id="L1283" title="All 2 branches missed.">							if (!saIDColl.contains(qs.getSkillID())) {</span>
<span class="nc" id="L1284">								addQue = false; //agent does not have the skill so skip this que</span>

<span class="nc" id="L1286">								this.stw.logDebug(&quot;getQueues(): Agent &quot; + empID</span>
									+ &quot; does not have skill=&quot;
<span class="nc" id="L1288">									+ qs.getSkillID() + &quot; rejected que=&quot; + queID);</span>
<span class="nc" id="L1289">								break;</span>
							}
<span class="nc" id="L1291">						}</span>
					}

					// ok to add que
<span class="nc bnc" id="L1295" title="All 2 branches missed.">					if (addQue) {</span>
<span class="nc" id="L1296">						ID mediaID = que.getMediaID();</span>
<span class="nc" id="L1297">						Iterator iter = media2Duration.keySet().iterator();</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed.">						while (iter.hasNext()) {</span>
<span class="nc" id="L1299">							CompoundKey actMedia = (CompoundKey)iter.next();</span>
<span class="nc bnc" id="L1300" title="All 2 branches missed.">							if (actMedia.getKey1().equals(mediaID)) {</span>
								//get activity queue Hope for this media
<span class="nc" id="L1302">								Collection colQue = info.getActivityQueueHope(actMedia.getKey2());</span>

								//activity is not queue hope to any queue or activity is queue hope for current
								//queue --&gt; OK to add que
<span class="nc bnc" id="L1306" title="All 4 branches missed.">								if ((colQue == null || colQue.size() &lt;= 0)) {</span>
<span class="nc" id="L1307">									Long dur = (Long)media2Duration.get(actMedia);</span>
									// check if media of que is contained in the activity
<span class="nc bnc" id="L1309" title="All 4 branches missed.">									if (dur != null &amp;&amp; dur.longValue() &gt; 0) {</span>
										// all conditions are satisfied
<span class="nc" id="L1311">										StaffingData data = new StaffingData();</span>
<span class="nc" id="L1312">										data.duration = dur;</span>
<span class="nc" id="L1313">										data.queID = queID;</span>
<span class="nc" id="L1314">										data.empID = empID;</span>
<span class="nc" id="L1315">										queColl.add(data);</span>

<span class="nc" id="L1317">										this.stw.logDebug(&quot;getQueues():  OK to add to que=&quot; + queID</span>
											+ &quot;, queue media=&quot; + mediaID
<span class="nc" id="L1319">											+ &quot;, actv=&quot; + actMedia.getKey2()</span>
											+ &quot; is not queue hoping&quot;);
<span class="nc" id="L1321">									}</span>
									else {
<span class="nc" id="L1323">										this.stw.logDebug(&quot;getQueues(): Queue Media=&quot; + que.getMediaID()</span>
											+ &quot; does not match activity media&quot;);
									}


<span class="nc" id="L1328">								}//gets to this loop if Activity has Queue hopping enabled</span>
<span class="nc bnc" id="L1329" title="All 4 branches missed.">								else if (colQue != null &amp;&amp; colQue.contains(queID)) {</span>
<span class="nc" id="L1330">									Long dur = (Long)media2Duration.get(actMedia);</span>
									// check if media of que is contained in the activity
<span class="nc bnc" id="L1332" title="All 4 branches missed.">									if (dur != null &amp;&amp; dur.longValue() &gt; 0) {</span>
										// all conditions are satisfied
<span class="nc" id="L1334">										StaffingData data = new StaffingData();</span>
<span class="nc" id="L1335">										data.duration = dur;</span>
<span class="nc" id="L1336">										data.queID = queID;</span>
<span class="nc" id="L1337">										data.empID = empID;</span>
<span class="nc" id="L1338">										queColl.add(data);</span>
<span class="nc" id="L1339">										this.stw.logDebug(&quot;getQueues(): OK to add to que=&quot; + queID</span>
											+ &quot;, queue media=&quot; + mediaID
<span class="nc" id="L1341">											+ &quot;, actv=&quot; + actMedia.getKey2()</span>
											+ &quot; is queue hoping associate to this queue&quot;);

<span class="nc" id="L1344">									}</span>
									else {
<span class="nc" id="L1346">										this.stw.logDebug(&quot;getQueues(): Queue Media=&quot; + que.getMediaID()</span>
											+ &quot; does not match activity media&quot;);
									}
<span class="nc" id="L1349">								}</span>
								else {
<span class="nc" id="L1351">									this.stw.logDebug(&quot;getQueues(): Not OK to add to que=&quot; + queID</span>
										+ &quot;, queue media=&quot; + mediaID
<span class="nc" id="L1353">										+ &quot;, actv=&quot; + actMedia.getKey2()</span>
										+ &quot; is queue hoping associate to other que&quot;);
								}
							}
<span class="nc" id="L1357">						}</span>
					}
<span class="nc" id="L1359">				}</span>
<span class="nc" id="L1360">			}</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">			if (queColl.size() &gt; 0) {</span>
<span class="nc" id="L1362">				hmQueColl.put(empID, queColl);</span>
<span class="nc" id="L1363">				this.stw.logDebug(&quot;Employee &quot; + empID + &quot; linked to &quot; + hmQueColl + &quot;queues&quot;);</span>

			}
<span class="nc" id="L1366">		}</span>

<span class="nc" id="L1368">		this.stw.stop();</span>

<span class="nc" id="L1370">		return hmQueColl;</span>
	}

  private  HashMap getMedia2Agents( Collection treColl,
                                           StaffingInfo info )
             throws RemoteException, BbmFinderException, BbmEJBCreateException
  {
<span class="nc" id="L1377">    this.stw.start(&quot;getMedia2Agents&quot;);</span>

    try
    {

<span class="nc" id="L1382">    HashMap media2Duration = new HashMap(); // media to duration</span>
<span class="nc" id="L1383">    long interval = info.endDate.getTime() - info.startDate.getTime();</span>

<span class="nc" id="L1385">    HashMap actv2Media = new HashMap(); //activity to media types</span>

<span class="nc" id="L1387">      Iterator childIter = treColl.iterator();</span>
<span class="nc bnc" id="L1388" title="All 2 branches missed.">      while( childIter.hasNext() )</span>
      {
<span class="nc" id="L1390">        TimeRecordEntry tre = (TimeRecordEntry)childIter.next();</span>


<span class="nc" id="L1393">          this.stw.logDebug(&quot;getMedia2Agents(): **** TRE start=&quot; +</span>
<span class="nc" id="L1394">                                  tre.getStartTime() +</span>
<span class="nc" id="L1395">                                  &quot; sec=&quot; + tre.getSeconds() +</span>
<span class="nc" id="L1396">                                  &quot; activity=&quot; + tre.getActivityID());</span>

<span class="nc" id="L1398">        long treStartMillis = tre.getStartTime().getTime();</span>
<span class="nc" id="L1399">        long startMillis = info.startDate.getTime();</span>
<span class="nc" id="L1400">        long endMillis = info.endDate.getTime();</span>

        // past end time, so skip
<span class="nc bnc" id="L1403" title="All 2 branches missed.">        if( treStartMillis &gt;=  endMillis )</span>
        {
<span class="nc" id="L1405">          continue;</span>
        }

        // before start time, so skip
<span class="nc" id="L1409">        long eventDur = treStartMillis + tre.getSeconds()*1000;</span>
<span class="nc bnc" id="L1410" title="All 4 branches missed.">        if( treStartMillis &lt;= startMillis &amp;&amp; eventDur &lt;= startMillis )</span>
        {
<span class="nc" id="L1412">          continue;</span>
        }

        // get the duration
<span class="nc" id="L1416">        long duration = getDuration(tre,</span>
                                          info.startDate,
                                          info.endDate,
                                          interval);

         // check media type
<span class="nc" id="L1422">        Collection mediaColl = (Collection)actv2Media.get(tre.getActivityID());</span>
<span class="nc bnc" id="L1423" title="All 2 branches missed.">        if( mediaColl == null )</span>
        {
<span class="nc" id="L1425">          Activity actv = info.getActivity(tre.getActivityID());</span>
<span class="nc bnc" id="L1426" title="All 2 branches missed.">          if( actv == null )</span>
          {
<span class="nc" id="L1428">            continue;</span>
          }

          // get the media types for this activity, if none then skip
<span class="nc" id="L1432">          mediaColl = info.getMedia(tre.getActivityID());</span>
<span class="nc bnc" id="L1433" title="All 4 branches missed.">          if( mediaColl == null || mediaColl.size() &lt;= 0 )</span>
          {

            {
<span class="nc" id="L1437">              this.stw.logDebug(&quot;getMedia2Agents(): Rejected activity since it does not contain media&quot; );</span>
            }

<span class="nc bnc" id="L1440" title="All 2 branches missed.">            if( tre.getActivityID().equals(Activity.ACTIVITY_UNKNOWN) )</span>
            {
<span class="nc" id="L1442">              info.isUnknownActivity = true;</span>
            }

            continue;
          }
          else
          {
<span class="nc" id="L1449">            actv2Media.put(tre.getActivityID(), mediaColl);</span>
<span class="nc" id="L1450">            info.isUnknownActivity = false;</span>
          }
        }

<span class="nc" id="L1454">        Iterator mediaIter = mediaColl.iterator();</span>
<span class="nc bnc" id="L1455" title="All 2 branches missed.">        while( mediaIter.hasNext() )</span>
        {
<span class="nc" id="L1457">          ID id = (ID)mediaIter.next();</span>
<span class="nc" id="L1458">          CompoundKey mediaKey = new CompoundKey(id, tre.getActivityID());</span>
<span class="nc" id="L1459">          Long dur = (Long)media2Duration.get(mediaKey);</span>
<span class="nc bnc" id="L1460" title="All 2 branches missed.">          if( dur != null )</span>
          {
<span class="nc" id="L1462">            dur = new Long( dur.longValue() + duration );</span>
          }
          else
          {
<span class="nc" id="L1466">            dur = new Long( duration );</span>
          }

<span class="nc" id="L1469">          media2Duration.put(mediaKey, dur);</span>


<span class="nc" id="L1472">            this.stw.logDebug(&quot;getMedia2Agents(): Selected TRE start=&quot; +</span>
<span class="nc" id="L1473">                                        tre.getStartTime() +</span>
<span class="nc" id="L1474">                                        &quot; dur=&quot; + dur.longValue() +</span>
                                        &quot; media=&quot;+ id +
<span class="nc" id="L1476">                                        &quot; activity=&quot; + tre.getActivityID() );</span>
<span class="nc" id="L1477">        }</span>
<span class="nc" id="L1478">      }</span>

<span class="nc" id="L1480">    return media2Duration;</span>
      }

      finally
      {
<span class="nc" id="L1485">        this.stw.stop();</span>
      }

  }

  // Return collection of all employee id's
  private Collection&lt;ID&gt; getEmployeeIDs( Date startDate)
      throws RemoteException, BbmFinderException, BbmEJBCreateException
  {
<span class="nc" id="L1494">    this.stw.start(&quot;getEmployeeIDs&quot;);</span>

    try
    {
<span class="nc" id="L1498">      WorkResourceManager mgr = BbmManagerFactory.getWorkResourceManager();</span>

<span class="nc" id="L1500">      this.stw.start(&quot;EJB getEmployeeIds&quot;, this.ejbTrace);</span>

<span class="nc" id="L1502">      Collection&lt;ID&gt; empColl = mgr.getEmployeeIds(Organization.ROOT_ORG_ID_OBJ,</span>
                                            startDate,
                                            Employee.DETAIL_LEVEL_EMPLOYEE_BASIC);
<span class="nc" id="L1505">      this.stw.stop();</span>

<span class="nc" id="L1507">      return empColl;</span>
    }

    finally
    {
<span class="nc" id="L1512">      this.stw.stop();</span>
    }
  }

  private long getDuration( TimeRecordEntry tre,
                            Date startDate,
                            Date endDate,
                            long interval)
  {
<span class="nc" id="L1521">    long startDateMillis = startDate.getTime();</span>
<span class="nc" id="L1522">    long endDateMillis = endDate.getTime();</span>

<span class="nc" id="L1524">    long treStartMillis = tre.getStartTime().getTime();</span>
<span class="nc" id="L1525">    long treDuration = tre.getSeconds() * 1000;</span>

    //before start time but in the current interval, calculate the duration
<span class="nc bnc" id="L1528" title="All 2 branches missed.">    if( treStartMillis &lt;= startDateMillis )</span>
    {
<span class="nc" id="L1530">      treDuration -= startDateMillis - treStartMillis;</span>
    }
<span class="nc bnc" id="L1532" title="All 2 branches missed.">    else if( (treStartMillis+treDuration) &gt; endDateMillis )  //after start time but greater than end</span>
    {
<span class="nc" id="L1534">      treDuration = endDateMillis - treStartMillis;</span>
    }

    // Normalize the duration
<span class="nc bnc" id="L1538" title="All 2 branches missed.">    if( treDuration &gt; interval )</span>
    {
<span class="nc" id="L1540">      treDuration =  interval;</span>
    }

<span class="nc" id="L1543">    return treDuration;</span>
  }

  public class StaffingInfo
  {
    public Date startDate;
    public Date endDate;
    public Date lastQueryDate;
    public Collection allEmpColl;
    //Collection to store the list of Modified EmployeeID's
    public Collection&lt;ID&gt; modifiedEmpColl;
    //Variable to capture if the incremental behavior of the adapter is needed
    public boolean isIncremental;
    
    public Collection empColl;
    public Collection dsqColl;
    public Collection dsColl;
    long lookBackDays;
    long empChunkSize;
    Category cat;
    public boolean isUnknownActivity;
<span class="nc" id="L1564">    public boolean computeActual = false;</span>

    // Contains staffing info. The key is QueID and the value is the
    // number of agents
<span class="nc" id="L1568">    HashMap que2Agents = null;</span>

    // Get time records for employees. The hashmap key is the empId and
    // the value is a collection of timerecords
<span class="nc" id="L1572">    java.util.Map hmTR = null;</span>

    // Map of agent count for each media
<span class="nc" id="L1575">    HashMap media2Duration = null;</span>

<span class="nc" id="L1577">    HashMap hmActivities = new HashMap();</span>

<span class="nc" id="L1579">    HashMap hmMedia = new HashMap();</span>

<span class="nc" id="L1581">    HashMap hmActivityQueueHope = new HashMap();</span>

<span class="nc" id="L1583">    java.util.Map hmsaColl = null;</span>

<span class="nc" id="L1585">    Map hmcampColl = null;</span>

<span class="nc" id="L1587">    HashMap hmqsColl = new HashMap();</span>

<span class="nc" id="L1589">    HashMap hmcamQColl = new HashMap();</span>

<span class="nc" id="L1591">    HashMap hmQueObj = new HashMap();</span>

<span class="nc" id="L1593">    HashMap hmdsQue = new HashMap();</span>

<span class="nc" id="L1595">    HashMap hmparQColl = new HashMap();</span>

<span class="nc" id="L1597">    HashMap&lt;ID,ID&gt; hmCombinedQue = new HashMap&lt;ID,ID&gt;();</span>

<span class="nc" id="L1599">    HashMap hmCCQStaff = null;</span>

    StopWatch stw;

    WorkloadManager wlMgr;
    SkillManager skillMgr;
    CampaignManager cmMgr;
    TimeRecordManager trMgr;
    PeopleFacade pf;
    GroupManager grpMgr;
    QueueGroupManager qgMgr;
    ActivityManager actvMgr;
    
    public StaffingInfo( Category category,
                        StopWatch swatch )
<span class="nc" id="L1614">    {</span>
<span class="nc" id="L1615">      this.cat = category;</span>
<span class="nc" id="L1616">      this.stw = swatch;</span>

      try
      {
<span class="nc" id="L1620">          this.stw.start(&quot;EJB getManagers&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1621">          skillMgr = WfmManagerFactory.getSkillManager();</span>
<span class="nc" id="L1622">          cmMgr = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L1623">          trMgr = WfmManagerFactory.getTimeRecordManager();</span>
<span class="nc" id="L1624">          pf = FacadeManagerFactory.getPeopleFacade();</span>
<span class="nc" id="L1625">          actvMgr = WfmManagerFactory.getActivityManager();</span>
<span class="nc" id="L1626">	      grpMgr = BbmManagerFactory.getGroupManager();</span>
<span class="nc" id="L1627">	      qgMgr = BbmManagerFactory.getQueueGroupManager();</span>
<span class="nc" id="L1628">	      wlMgr = WfmManagerFactory.getWorkloadManager();</span>
<span class="nc" id="L1629">          this.stw.stop();</span>

      }
<span class="nc" id="L1632">      catch( Exception ex )</span>
      {
<span class="nc" id="L1634">    	  this.cat.l7dError(ex.getMessage(), ex);</span>
<span class="nc" id="L1635">      }</span>
<span class="nc" id="L1636">    }</span>

    public void init()
    {
<span class="nc" id="L1640">      this.media2Duration = new HashMap();</span>
<span class="nc" id="L1641">      this.que2Agents = new HashMap();</span>
<span class="nc" id="L1642">      this.isUnknownActivity = false;</span>
<span class="nc" id="L1643">      this.hmCCQStaff = new HashMap();</span>
<span class="nc" id="L1644">    }</span>

    public void shutdown()
    {
    	try
    	{
<span class="nc bnc" id="L1650" title="All 2 branches missed.">    		if( this.trMgr != null )</span>
<span class="nc" id="L1651">    			this.trMgr.remove();</span>

<span class="nc bnc" id="L1653" title="All 2 branches missed.">    		if( this.cmMgr != null )</span>
<span class="nc" id="L1654">    			this.cmMgr.remove();</span>
    		
<span class="nc bnc" id="L1656" title="All 2 branches missed.">    		if( this.wlMgr != null )</span>
<span class="nc" id="L1657">    			this.wlMgr.remove();</span>
    		
<span class="nc bnc" id="L1659" title="All 2 branches missed.">    		if( this.skillMgr != null )</span>
<span class="nc" id="L1660">    			this.skillMgr.remove();</span>
    		
<span class="nc bnc" id="L1662" title="All 2 branches missed.">    		if( this.pf != null )</span>
<span class="nc" id="L1663">    			this.pf.remove();</span>
    		
<span class="nc bnc" id="L1665" title="All 2 branches missed.">    		if( this.grpMgr != null )</span>
<span class="nc" id="L1666">    			this.grpMgr.remove();</span>
    		
<span class="nc bnc" id="L1668" title="All 2 branches missed.">    		if( this.qgMgr != null )</span>
<span class="nc" id="L1669">    			this.qgMgr.remove();</span>

<span class="nc bnc" id="L1671" title="All 2 branches missed.">    		if( this.actvMgr != null )</span>
<span class="nc" id="L1672">    			this.actvMgr.remove();</span>
    	}
<span class="nc" id="L1674">    	catch( Exception ex )</span>
    	{
<span class="nc" id="L1676">      	  this.cat.l7dError(ex.getMessage(), ex);</span>
<span class="nc" id="L1677">    	}</span>
<span class="nc" id="L1678">    }</span>
      private  void populateSPIDsAndUniqueCampaignIDsFromEmployeeCampaignAssignments(Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; hmCampColl,List&lt;ID&gt; uniqueCampaignIDs, Set&lt;ID&gt; spIDsThatEmployeesBelongToDuringThisPeriod){

<span class="nc bnc" id="L1681" title="All 2 branches missed.">          if(hmCampColl != null){</span>
<span class="nc bnc" id="L1682" title="All 2 branches missed.">              for(Map.Entry&lt;ID, List&lt;CampaignWorkResource&gt;&gt; e :hmCampColl.entrySet()){</span>
<span class="nc bnc" id="L1683" title="All 2 branches missed.">                  if(e.getValue() != null){</span>
<span class="nc bnc" id="L1684" title="All 2 branches missed.">                      for(CampaignWorkResource w: e.getValue()){</span>
<span class="nc" id="L1685">                          spIDsThatEmployeesBelongToDuringThisPeriod.add(w.getSPID());</span>
<span class="nc bnc" id="L1686" title="All 2 branches missed.">                          if(!uniqueCampaignIDs.contains(w.getCampaignID())) {</span>
<span class="nc" id="L1687">                              uniqueCampaignIDs.add(w.getCampaignID());</span>
                          }
<span class="nc" id="L1689">                      }</span>
                  }
<span class="nc" id="L1691">              }</span>
          }
<span class="nc" id="L1693">      }</span>

      private List&lt;ID&gt; getListParentCampaignIDs(Collection&lt;Campaign&gt;  campaignColl){
<span class="nc" id="L1696">          List&lt;ID&gt; parentCampIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L1697" title="All 2 branches missed.">          if(campaignColl != null){</span>
<span class="nc bnc" id="L1698" title="All 2 branches missed.">              for(Campaign c:campaignColl){</span>
<span class="nc bnc" id="L1699" title="All 2 branches missed.">                  if(c.getParentCampaignID() != null){</span>
<span class="nc" id="L1700">                      parentCampIDs.add(c.getParentCampaignID());</span>
                  }
<span class="nc" id="L1702">              }</span>
          }
<span class="nc" id="L1704">          return parentCampIDs;</span>
      }

      public void preFetch()
              throws RemoteException, BbmFinderException, BbmEJBCreateException, FacadeException {
          // Get all managers
<span class="nc" id="L1710">          this.stw.start(&quot;preFetch&quot;);</span>

          try {

<span class="nc" id="L1714">              this.stw.start(&quot;EJB getWorkResourceCampaignAssignments&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1715">              this.hmcampColl = cmMgr.getWorkResourceCampaignAssignments(empColl,</span>
                      startDate,
                      endDate);
<span class="nc" id="L1718">              this.stw.stop();</span>

<span class="nc" id="L1720">              List&lt;ID&gt; empIDCamp = new ArrayList&lt;ID&gt;();</span>

<span class="nc" id="L1722">              Set&lt;ID&gt; spIDsThatEmployeesBelongToDuringThisPeriod = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L1723">              List&lt;ID&gt; uniqueCampaignIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L1724">              Collection&lt;CampaignQueue&gt; cqColl = new HashSet&lt;CampaignQueue&gt;();</span>

<span class="nc" id="L1726">              Iterator empIdCampCollKeySetIter = hmcampColl.keySet().iterator();</span>
              //Iterate thru each of the Employee to check if he has any campaign assignments for the given duration.
<span class="nc" id="L1728">              populateSPIDsAndUniqueCampaignIDsFromEmployeeCampaignAssignments(this.hmcampColl, uniqueCampaignIDs, spIDsThatEmployeesBelongToDuringThisPeriod);</span>
<span class="nc" id="L1729">              Collection&lt;Campaign&gt; campaignCollection = cmMgr.getCampaignsByIDs(uniqueCampaignIDs);</span>
<span class="nc" id="L1730">              Map&lt;ID, Campaign&gt; campaignLookupMap = getCampaignMap(campaignCollection);</span>
<span class="nc" id="L1731">              uniqueCampaignIDs.addAll(getListParentCampaignIDs(campaignCollection));</span>

<span class="nc" id="L1733">              Map&lt;ID, Collection&lt;CampaignQueue&gt;&gt; campaignQAssgmts = null;</span>


              try {
<span class="nc" id="L1737">                  this.stw.start(&quot;EJB getCampaignQueueAssignments&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1738">                  campaignQAssgmts = cmMgr.getQueueAssignmentsForGivenCampaignIDs(uniqueCampaignIDs, startDate, endDate);</span>
<span class="nc" id="L1739">                  this.stw.stop();</span>
<span class="nc" id="L1740">              } catch (BbmFinderException e) {</span>
<span class="nc" id="L1741">                  this.cat.l7dError(&quot;Exception in getQueueAssignmentsForGivenCampaignIDs :&quot; + e.getMessage());</span>
<span class="nc" id="L1742">                  throw e;</span>
<span class="nc" id="L1743">              } catch (RemoteException e) {</span>
<span class="nc" id="L1744">                  this.cat.l7dError(&quot;Exception in getQueueAssignmentsForGivenCampaignIDs :&quot; + e.getMessage());</span>
<span class="nc" id="L1745">                  throw e;</span>
<span class="nc" id="L1746">              }</span>

<span class="nc bnc" id="L1748" title="All 2 branches missed.">              while (empIdCampCollKeySetIter.hasNext()) {</span>
<span class="nc" id="L1749">                  ID empID = (ID) empIdCampCollKeySetIter.next();</span>
<span class="nc" id="L1750">                  Collection campaignsForEachEmployee = (Collection) hmcampColl.get(empID);</span>
<span class="nc" id="L1751">                  Collection&lt;CampaignQueue&gt; cqCollForEachChunk = null;</span>
<span class="nc bnc" id="L1752" title="All 4 branches missed.">                  if (campaignsForEachEmployee == null || campaignsForEachEmployee.size() &lt; 1) {</span>
<span class="nc" id="L1753">                      this.stw.logDebug(&quot;getQueues(): No campaigns found for empID=&quot; + empID);</span>
<span class="nc" id="L1754">                      continue;</span>
                  }

                  //Add him to the collection only if he has Campaigns
<span class="nc" id="L1758">                  cqCollForEachChunk = buildCampaignQueueMappings(campaignQAssgmts, campaignsForEachEmployee, campaignLookupMap);</span>
<span class="nc" id="L1759">                  empIDCamp.add(empID);</span>

<span class="nc bnc" id="L1761" title="All 4 branches missed.">                  if(cqCollForEachChunk != null &amp;&amp; cqCollForEachChunk.size() &gt;=0) {</span>
<span class="nc" id="L1762">                      cqColl.addAll(cqCollForEachChunk);</span>
                  }
<span class="nc" id="L1764">              }</span>
<span class="nc" id="L1765">              Collection queIDs = populateCampaignQueueCollectionToLocalCache(cqColl);</span>


<span class="nc bnc" id="L1768" title="All 2 branches missed.">              if (queIDs.size() &gt; 0) {</span>
<span class="nc" id="L1769">                  this.stw.start(&quot;EJB getLinkedSkillIDsForQueues&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1770">                  Map&lt;ID, List&lt;QueueSkill&gt;&gt; hmqs = wlMgr.getLinkedSkillIDsForQueues(queIDs, spIDsThatEmployeesBelongToDuringThisPeriod);</span>
<span class="nc" id="L1771">                  this.stw.stop();</span>

<span class="nc" id="L1773">                  this.hmqsColl.putAll(hmqs);</span>

<span class="nc" id="L1775">                  this.getQueues(queIDs);</span>
<span class="nc" id="L1776">                  this.getParentQueIds(queIDs);</span>
              }

<span class="nc bnc" id="L1779" title="All 2 branches missed.">              if (empIDCamp.size() &gt; 0) {</span>
<span class="nc" id="L1780">                  this.stw.start(&quot;EJB getEventsForWorkResourceFromCache&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1781">                  this.hmTR = trMgr.getEventsForWorkResourceFromCache(empIDCamp,</span>
                          startDate,
                          endDate,
                          true);
<span class="nc" id="L1785">                  this.stw.stop();</span>

                  // Get the list of assigned skills for the employee
<span class="nc" id="L1788">                  this.stw.start(&quot;EJB getSkillAssignments&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1789">                  this.hmsaColl = skillMgr.getSkillAssignments(empIDCamp,</span>
                          startDate,
                          endDate);
<span class="nc" id="L1792">                  this.stw.stop();</span>
              } else {
<span class="nc" id="L1794">                  this.hmTR = java.util.Collections.EMPTY_MAP;</span>
<span class="nc" id="L1795">                  this.hmsaColl = java.util.Collections.EMPTY_MAP;</span>
              }
          } finally {
<span class="nc" id="L1798">              this.stw.stop();</span>
<span class="nc" id="L1799">          }</span>
<span class="nc" id="L1800">      }</span>

      private Collection populateCampaignQueueCollectionToLocalCache(Collection&lt;CampaignQueue&gt; cqColl) {
          // For each queue, check for valid skill &amp; media
<span class="nc" id="L1804">          Collection queIDs = new HashSet();</span>
<span class="nc" id="L1805">          Iterator cqIter = cqColl.iterator();</span>
<span class="nc bnc" id="L1806" title="All 2 branches missed.">          while (cqIter.hasNext()) {</span>
<span class="nc" id="L1807">              CampaignQueue cq = (CampaignQueue) cqIter.next();</span>
<span class="nc" id="L1808">              ID queID = cq.getQueueID();</span>
<span class="nc" id="L1809">              ID campID = cq.getCampaignID();</span>

              //remove queues that are not mapped to the data source
<span class="nc bnc" id="L1812" title="All 2 branches missed.">              if (!this.dsqColl.contains(queID)) {</span>
<span class="nc" id="L1813">                  this.stw.logDebug(&quot;getQueues(): Queue=&quot; + queID + &quot; not mapped to a datasource &quot;);</span>
<span class="nc" id="L1814">                  continue;</span>
              }

<span class="nc" id="L1817">              Collection queColl = (Collection) this.hmcamQColl.get(campID);</span>
<span class="nc bnc" id="L1818" title="All 2 branches missed.">              if (queColl == null) {</span>
<span class="nc" id="L1819">                  queColl = new HashSet();</span>
<span class="nc" id="L1820">                  this.hmcamQColl.put(campID, queColl);</span>
              }
<span class="nc" id="L1822">              queColl.add(queID);</span>

<span class="nc bnc" id="L1824" title="All 2 branches missed.">              if (!this.hmqsColl.containsKey(queID)) {</span>
<span class="nc" id="L1825">                  queIDs.add(queID);</span>
              }
<span class="nc" id="L1827">          }</span>
<span class="nc" id="L1828">          return queIDs;</span>
      }

      private Map&lt;ID, Campaign&gt; getCampaignMap(Collection&lt;Campaign&gt; campaignList) throws BbmFinderException, RemoteException {

<span class="nc" id="L1833">          Map&lt;ID, Campaign&gt; campaignLookupMap = new HashMap&lt;ID, Campaign&gt;();</span>
<span class="nc bnc" id="L1834" title="All 4 branches missed.">          if (campaignList != null &amp;&amp; !campaignList.isEmpty()) {</span>
<span class="nc bnc" id="L1835" title="All 2 branches missed.">              for (Campaign c : campaignList) {</span>
<span class="nc" id="L1836">                  campaignLookupMap.put(c.getID(), c);</span>
<span class="nc" id="L1837">              }</span>
          }
<span class="nc" id="L1839">          return campaignLookupMap;</span>
      }

      private void addQueueNSPIDMappingToLocalCache(ID queueID, ID SPID) {
<span class="nc bnc" id="L1843" title="All 2 branches missed.">          if (this.hmCombinedQue != null) {</span>
<span class="nc" id="L1844">              this.hmCombinedQue.put(queueID, SPID);</span>
          }
<span class="nc" id="L1846">      }</span>

      private Collection&lt;CampaignQueue&gt; buildCampaignQueueMappings(Map&lt;ID, Collection&lt;CampaignQueue&gt;&gt; campaignQAssgmts, Collection campColl, Map&lt;ID, Campaign&gt; campaignLookupMap) throws BbmFinderException, RemoteException {

          // Get campaign ids

<span class="nc" id="L1852">          Iterator campIter = campColl.iterator();</span>
<span class="nc" id="L1853">          Collection&lt;CampaignQueue&gt; coll = new ArrayList&lt;CampaignQueue&gt;();</span>
          //Iterate thru the list of Campaigns associated with each employee
<span class="nc bnc" id="L1855" title="All 2 branches missed.">          while (campIter.hasNext()) {</span>
<span class="nc" id="L1856">              CampaignWorkResource cw = (CampaignWorkResource) campIter.next();</span>


<span class="nc" id="L1859">              ID campID = cw.getCampaignID();</span>
<span class="nc" id="L1860">              Campaign camp = campaignLookupMap.get(campID);</span>

<span class="nc bnc" id="L1862" title="All 2 branches missed.">              if(campaignQAssgmts != null) {</span>
<span class="nc" id="L1863">                  coll = campaignQAssgmts.get(campID);</span>
              }


<span class="nc bnc" id="L1867" title="All 4 branches missed.">              if (coll == null || coll.size() &lt;= 0) {</span>
<span class="nc" id="L1868">                  this.stw.logDebug(&quot;getQueues(): No queues mapped for campaign=&quot; + campID);</span>
<span class="nc" id="L1869">                  continue;</span>
              }

<span class="nc" id="L1872">              TreeSet parQueColl = new TreeSet();</span>

              // update the que/campaign info which is required for combined queue
              // Iterate thru the list of Queues linked to each campaign
<span class="nc" id="L1876">              Iterator cqIter = coll.iterator();</span>

<span class="nc bnc" id="L1878" title="All 2 branches missed.">              while (cqIter.hasNext()) {</span>
<span class="nc" id="L1879">                  CampaignQueue cq = (CampaignQueue) cqIter.next();</span>
<span class="nc" id="L1880">                  ID queID = cq.getQueueID();</span>

<span class="nc bnc" id="L1882" title="All 2 branches missed.">                  if (cq.getSPID().equals(cw.getSPID())) {</span>
<span class="nc" id="L1883">                      addQueueNSPIDMappingToLocalCache(queID, cq.getSPID());</span>
<span class="nc" id="L1884">                      ID parQueID = this.getParentQueID(queID);</span>
<span class="nc bnc" id="L1885" title="All 2 branches missed.">                      if (parQueID != null)</span>
<span class="nc" id="L1886">                          parQueColl.add(parQueID);</span>
                  }
<span class="nc" id="L1888">              }</span>

              // update the parent campaign map required for combined distributed queue/campaign
<span class="nc" id="L1891">              checkAndAddParentCampaignQueueAssignmentsToLocalQueueSPIDCache(campaignQAssgmts, camp, parQueColl);</span>
<span class="nc" id="L1892">          }</span>
<span class="nc" id="L1893">          return coll;</span>
      }

      private void checkAndAddParentCampaignQueueAssignmentsToLocalQueueSPIDCache(Map&lt;ID, Collection&lt;CampaignQueue&gt;&gt; campaignQueueAssgmts, Campaign camp, TreeSet parQueColl) {
<span class="nc" id="L1897">          ID pCampID = camp.getParentID(); //get parent campaign</span>
<span class="nc bnc" id="L1898" title="All 2 branches missed.">          if (pCampID != null) {</span>
<span class="nc" id="L1899">              Collection pCampQColl = campaignQueueAssgmts.get(pCampID);</span>
<span class="nc bnc" id="L1900" title="All 4 branches missed.">              if (pCampQColl != null &amp;&amp; pCampQColl.size() &gt; 0) {</span>
<span class="nc" id="L1901">                  Iterator pCampQCollIter = pCampQColl.iterator();</span>
<span class="nc bnc" id="L1902" title="All 2 branches missed.">                  while (pCampQCollIter.hasNext()) {</span>
<span class="nc" id="L1903">                      CampaignQueue pcq = (CampaignQueue) pCampQCollIter.next();</span>
<span class="nc" id="L1904">                      ID parQueID = pcq.getQueueID();</span>
<span class="nc" id="L1905">                      ID parSPID = pcq.getSPID();</span>

                      // check if queue exists and info not already added to map
<span class="nc bnc" id="L1908" title="All 2 branches missed.">                      if (parQueColl.contains(parQueID)) {</span>
<span class="nc" id="L1909">                          addQueueNSPIDMappingToLocalCache(parQueID, parSPID);</span>
                      }
<span class="nc" id="L1911">                  }</span>
              }
          }
<span class="nc" id="L1914">      }</span>

  public Collection getParentQueIds( Collection queIDs ) throws RemoteException, BbmFinderException, BbmEJBCreateException
  {
<span class="nc" id="L1918">    ArrayList retVal = new ArrayList();</span>

    // list that holds all parentqueues not found
<span class="nc" id="L1921">    ArrayList pqIds = new ArrayList();</span>

<span class="nc" id="L1923">    Collection queColl = this.getQueues(queIDs);</span>
<span class="nc" id="L1924">    Iterator iter = queColl.iterator();</span>
<span class="nc bnc" id="L1925" title="All 2 branches missed.">    while( iter.hasNext() )</span>
    {
<span class="nc" id="L1927">      Queue que = (Queue)iter.next();</span>
<span class="nc" id="L1928">      ID id = que.getParentID();</span>

<span class="nc bnc" id="L1930" title="All 2 branches missed.">      if( id != null )</span>
      {
<span class="nc" id="L1932">        retVal.add(id);</span>
<span class="nc" id="L1933">        this.hmparQColl.put(que.getID(), id);</span>

        // if this que is not in the global list, fetch it later
<span class="nc bnc" id="L1936" title="All 2 branches missed.">        if( this.hmQueObj.get(id) == null )</span>
        {
<span class="nc" id="L1938">          pqIds.add(id);</span>
        }
      }
<span class="nc" id="L1941">    }</span>

<span class="nc bnc" id="L1943" title="All 2 branches missed.">    if( pqIds.size() &gt; 0 )</span>
    {
      // this will fetch the missing queues and update the global list
<span class="nc" id="L1946">      this.getQueues(pqIds);</span>
    }

<span class="nc" id="L1949">    return retVal;</span>
  }

  public Collection getQueues( Collection queIDs ) throws RemoteException, BbmFinderException, BbmEJBCreateException
  {
<span class="nc" id="L1954">    ArrayList retVal = new ArrayList();</span>
<span class="nc" id="L1955">    HashSet mQueIds = new HashSet();</span>

<span class="nc" id="L1957">    Iterator queIter = queIDs.iterator();</span>
<span class="nc bnc" id="L1958" title="All 2 branches missed.">    while( queIter.hasNext() )</span>
    {
<span class="nc" id="L1960">      ID id = (ID) queIter.next();</span>
<span class="nc" id="L1961">      Queue que = (Queue)this.hmQueObj.get(id);</span>
<span class="nc bnc" id="L1962" title="All 2 branches missed.">      if( que == null )</span>
      {
<span class="nc" id="L1964">        mQueIds.add(id);</span>
      }
      else
      {
<span class="nc" id="L1968">        retVal.add(que);</span>
      }
<span class="nc" id="L1970">    }</span>

<span class="nc bnc" id="L1972" title="All 2 branches missed.">    if( mQueIds.size() &gt; 0 )</span>
    {
<span class="nc" id="L1974">      this.stw.start(&quot;EJB getQueuesByIDs&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1975">      Collection coll = wlMgr.getQueuesByIDs(mQueIds);</span>
<span class="nc" id="L1976">      this.stw.stop();</span>

<span class="nc bnc" id="L1978" title="All 2 branches missed.">      if( coll != null )</span>
      {
<span class="nc" id="L1980">        Iterator collIter = coll.iterator();</span>
<span class="nc bnc" id="L1981" title="All 2 branches missed.">        while( collIter.hasNext() )</span>
        {
<span class="nc" id="L1983">          Queue que = (Queue)collIter.next();</span>
<span class="nc bnc" id="L1984" title="All 2 branches missed.">          if( que != null )</span>
          {
<span class="nc" id="L1986">            this.hmQueObj.put(que.getID(), que);</span>
<span class="nc" id="L1987">            retVal.add(que);</span>
          }
<span class="nc" id="L1989">        }</span>
      }
    }

<span class="nc" id="L1993">    return retVal;</span>
  }

  public ID getParentQueID( ID queID )
  {
<span class="nc" id="L1998">    return (ID)this.hmparQColl.get(queID);</span>
  }

    public Collection getMedia( ID id )
        throws RemoteException, BbmFinderException, BbmEJBCreateException
    {
<span class="nc" id="L2004">      this.stw.start(&quot;getMedia&quot;);</span>

      try
      {
<span class="nc" id="L2008">        Collection obj = (Collection)this.hmMedia.get(id);</span>
<span class="nc bnc" id="L2009" title="All 2 branches missed.">        if (obj == null)</span>
        {
<span class="nc" id="L2011">          this.stw.start(&quot;EJB findMediaForActivity&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L2012">          obj = actvMgr.findMediaForActivity(id);</span>
<span class="nc" id="L2013">          this.stw.stop();</span>

<span class="nc" id="L2015">          this.hmMedia.put(id, obj);</span>
        }
<span class="nc" id="L2017">        return  obj;</span>
      }

      finally
      {
<span class="nc" id="L2022">        this.stw.stop();</span>
      }
    }

    public Collection getActivityQueueHope( ID id )
            throws RemoteException, BbmFinderException, BbmEJBCreateException
        {
<span class="nc" id="L2029">          this.stw.start(&quot;getMedia&quot;);</span>

          try
          {
<span class="nc" id="L2033">            Collection obj = (Collection)this.hmActivityQueueHope.get(id);</span>
<span class="nc bnc" id="L2034" title="All 2 branches missed.">            if (obj == null)</span>
            {
<span class="nc" id="L2036">              this.stw.start(&quot;EJB findQueueForActivity&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L2037">              obj = actvMgr.findQueueForActivity(id);</span>
<span class="nc" id="L2038">              this.stw.stop();</span>

<span class="nc" id="L2040">              this.hmActivityQueueHope.put(id, obj);</span>
            }
<span class="nc" id="L2042">            return  obj;</span>
          }

          finally
          {
<span class="nc" id="L2047">            this.stw.stop();</span>
          }
        }

    public Activity getActivity( ID id )
        throws RemoteException, BbmFinderException, BbmEJBCreateException
    {
<span class="nc" id="L2054">      this.stw.start(&quot;getActivity&quot;);</span>

      try
      {
<span class="nc" id="L2058">        Activity obj = (Activity)this.hmActivities.get(id);</span>
<span class="nc bnc" id="L2059" title="All 2 branches missed.">        if (obj == null)</span>
        {
<span class="nc" id="L2061">          this.stw.start(&quot;EJB findActivityById&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L2062">          obj = actvMgr.findActivityById(id);</span>
<span class="nc" id="L2063">          this.stw.stop();</span>

<span class="nc" id="L2065">          this.hmActivities.put(id, obj);</span>
        }
<span class="nc" id="L2067">        return obj;</span>
      }

      finally
      {
<span class="nc" id="L2072">        this.stw.stop();</span>
      }
    }

  // get the collection of que id's associated to the datasource id's
  public Collection getDatasource2Queues( Collection dsColl ) throws RemoteException, BbmFinderException, BbmEJBCreateException
  {
<span class="nc" id="L2079">    this.stw.start(&quot;getDatasource2Queues&quot;);</span>

    try
    {
<span class="nc" id="L2083">      HashSet retVal = new HashSet(); //use Set to avoid duplicates</span>

<span class="nc bnc" id="L2085" title="All 4 branches missed.">      if (dsColl == null || dsColl.size() == 0)</span>
<span class="nc" id="L2086">        return retVal;</span>

      // For each datasource get groups and for each group
      // get the associated queues
<span class="nc" id="L2090">      Iterator dsIter = dsColl.iterator();</span>
<span class="nc bnc" id="L2091" title="All 2 branches missed.">      while (dsIter.hasNext()) {</span>
<span class="nc" id="L2092">        ID dsID = (ID) dsIter.next();</span>

<span class="nc" id="L2094">        Collection queColl = (Collection)this.hmdsQue.get(dsID);</span>
<span class="nc bnc" id="L2095" title="All 2 branches missed.">        if (queColl != null) {</span>
<span class="nc" id="L2096">          retVal.addAll(queColl);</span>
<span class="nc" id="L2097">          continue;</span>
        }

        // Get groups for the datasource
<span class="nc" id="L2101">        this.stw.start(&quot;EJB getGroupsByDatasource&quot;,</span>
<span class="nc" id="L2102">                       StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L2103">        Collection grpColl = grpMgr.getGroupsByDatasource(dsID);</span>
<span class="nc" id="L2104">        this.stw.stop();</span>

<span class="nc bnc" id="L2106" title="All 4 branches missed.">        if (grpColl != null &amp;&amp; grpColl.size() &gt; 0) {</span>
<span class="nc" id="L2107">          Collection qgList = new HashSet();</span>
<span class="nc" id="L2108">          Iterator grpIter = grpColl.iterator();</span>
<span class="nc bnc" id="L2109" title="All 2 branches missed.">          while (grpIter.hasNext()) {</span>
<span class="nc" id="L2110">            Group grp = (Group) grpIter.next();</span>

            //Get the queues for this group
<span class="nc" id="L2113">            this.stw.start(&quot;EJB getLinkedQueueIDsForGroup&quot;,</span>
<span class="nc" id="L2114">                           StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L2115">            Collection qgColl = qgMgr.getLinkedQueueIDsForGroup(grp.getID());</span>
<span class="nc" id="L2116">            this.stw.stop();</span>

<span class="nc bnc" id="L2118" title="All 4 branches missed.">            if (qgColl != null &amp;&amp; qgColl.size() &gt; 0) {</span>
<span class="nc" id="L2119">              qgList.addAll(qgColl); //add all queues, Set will eliminate duplicates</span>
            }
            else {

<span class="nc" id="L2123">              this.stw.logDebug(</span>
                  &quot;getDatasource2Queues(): Could not find queue mapping for groupId=&quot; +
<span class="nc" id="L2125">                  grp.getID());</span>
            }
<span class="nc" id="L2127">          }</span>

<span class="nc" id="L2129">          Collection parQueColl = this.getParentQueIds(qgList);</span>
<span class="nc" id="L2130">          qgList.addAll(parQueColl);</span>

<span class="nc" id="L2132">          this.hmdsQue.put(dsID, qgList);</span>
<span class="nc" id="L2133">          retVal.addAll(qgList);</span>

<span class="nc" id="L2135">          this.stw.logDebug(</span>
              &quot;getDatasource2Queues(): Found the following queues for dsID=&quot; +
<span class="nc" id="L2137">              dsID.toString() +</span>
<span class="nc" id="L2138">              &quot; queues=&quot; + qgList.toString());</span>

<span class="nc" id="L2140">        }</span>
        else {

<span class="nc" id="L2143">          this.stw.logDebug(</span>
              &quot;getDatasource2Queues(): Could not find groups for dsId=&quot; +
              dsID);
        }
<span class="nc" id="L2147">      }</span>

<span class="nc" id="L2149">      return retVal;</span>
    }

    finally
    {
<span class="nc" id="L2154">      this.stw.stop();</span>
    }

  }
 }
<span class="nc" id="L2159">  private class StaffingData implements Comparable</span>

  {
	  ID queID;
	  ID empID;
	  Long duration;

	  public int hashCode()
	  {
<span class="nc bnc" id="L2168" title="All 2 branches missed.">		  return empID != null ? empID.hashCode() : super.hashCode();</span>
	  }
	  
	  public boolean equals( Object obj )
	  {
<span class="nc" id="L2173">		  StaffingData sd = (StaffingData)obj;</span>

<span class="nc bnc" id="L2175" title="All 2 branches missed.">		  return this.empID == null ? false : this.empID.equals(sd.empID); </span>
	  }

	  public int compareTo( Object obj )
	  {
<span class="nc" id="L2180">		  StaffingData sd = (StaffingData)obj;</span>

<span class="nc bnc" id="L2182" title="All 2 branches missed.">		  if( this.empID == null )</span>
<span class="nc" id="L2183">			  return 1;</span>

<span class="nc bnc" id="L2185" title="All 2 branches missed.">		  if( sd.empID == null )</span>
<span class="nc" id="L2186">			  return -1;</span>

<span class="nc" id="L2188">		  return this.empID.compareTo( sd.empID );</span>
	  }

	  public String toString()
	  {
<span class="nc" id="L2193">		  StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L2194">		  buf.append(&quot;[emp=&quot;);</span>
<span class="nc" id="L2195">		  buf.append( this.empID );</span>
<span class="nc" id="L2196">		  buf.append(&quot; que=&quot;);</span>
<span class="nc" id="L2197">		  buf.append( this.queID );</span>
<span class="nc" id="L2198">		  buf.append(&quot; dur=&quot;);</span>
<span class="nc" id="L2199">		  buf.append( this.duration );</span>
<span class="nc" id="L2200">		  buf.append(&quot;]&quot;);</span>

<span class="nc" id="L2202">		  return buf.toString();</span>
	  }
  }

  private class CompoundKey {
		private ID key1;
		private ID key2;

<span class="nc" id="L2210">		public CompoundKey(ID k1, ID k2) {</span>
<span class="nc" id="L2211">			key1 = k1;</span>
<span class="nc" id="L2212">			key2 = k2;</span>
<span class="nc" id="L2213">}</span>

		public ID getKey1()	{
<span class="nc" id="L2216">			return key1;</span>
		}

		public ID getKey2() {
<span class="nc" id="L2220">			return key2;</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>