<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StartTimePrefPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.schedule.preferences</a> &gt; <span class="el_source">StartTimePrefPC.java</span></div><h1>StartTimePrefPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.schedule.preferences;

import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.picker.time.TimePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.TimeRangePickerPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.TimeZoneHelper;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.ejb.bbm.schedulepref.model.SimpleSchedulePreference;

import javax.servlet.http.HttpServletRequest;
import java.util.*;

/**
 * Title:       StartTimePrefPC
 * Description: Start Time Preference PC
 * Copyright:   Copyright (c) 2004
 * Company:     Blue Pumpkin Software, Inc
 *
 * @author David Su, dsu
 * @version 1.0
 *          Created on Aug 18, 2004, 10:17:49 AM
 */
public class StartTimePrefPC extends CollapsibleContainerPC {
	private static final String START_PREFS_FN = &quot;startPrefs&quot;;
	private static final String EARLY_OR_LATE_FN = &quot;earlyOrLate&quot;;

	private ResourceBundle m_bundle;
	
	//private TimePickerPC m_timePickerPC;
	private TimeRangePickerPC m_timeRangePickerPC;

	private short m_earlyOrLate;
<span class="nc" id="L39">	private int[] m_startPrefs = new int[42]; // 7*3*2 day,pref,from-to (for extraction)</span>

	public StartTimePrefPC(RequestContext context) 
	{
<span class="nc" id="L43">		super(context);</span>
		
<span class="nc" id="L45">		setName(&quot;startTimeContainer&quot;);</span>
<span class="nc" id="L46">		m_bundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L48">		m_timeRangePickerPC = new TimeRangePickerPC(context, &quot;time&quot;);</span>
		
<span class="nc" id="L50">		m_timeRangePickerPC.getStartTimePickerPC().setIsInputValueOptional(true);</span>
<span class="nc" id="L51">		m_timeRangePickerPC.getEndTimePickerPC().setIsInputValueOptional(true);</span>

<span class="nc" id="L53">		m_timeRangePickerPC.setTimeInterval(15);</span>
<span class="nc" id="L54">		addChildComponent(m_timeRangePickerPC);</span>
<span class="nc" id="L55">	}</span>

	/**
	 * populate start time preferences container
	 */
	protected void init(HashMap theData){
<span class="nc" id="L61">		setStyleClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="nc" id="L62">		setTitle(i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS));</span>

<span class="nc" id="L64">		setTemplate(&quot;&lt;table cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot; width=\&quot;100%\&quot;&gt;&quot;</span>
				+&quot;&lt;tr&gt;&lt;td class=\&quot;schedPrefText\&quot;&gt;{0}&lt;/td&gt;&lt;/tr&gt;&quot;
				+&quot;&lt;tr&gt;&lt;td class=\&quot;schedPrefText\&quot;&gt;{1}&lt;/td&gt;&lt;/tr&gt;&quot;
				+&quot;&lt;tr&gt;&lt;td class=\&quot;schedPrefText\&quot;&gt;{2}&lt;/td&gt;&lt;/tr&gt;&quot;
				+&quot;&lt;tr&gt;&lt;td class=\&quot;schedPrefItalic\&quot;&gt;{3}&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);

		// Descriptive message about the start time preferences
<span class="nc" id="L71">		addComponent(i18n(m_bundle,FsWebBundleKey.SP_START_TIME_PREFS_DESC));</span>

		// Start Time Prefs table
<span class="nc" id="L74">		SimpleSchedulePreference simpleSchedPref =</span>
<span class="nc" id="L75">				(SimpleSchedulePreference)theData.get(SchedulePreferenceMH.SIMPLE_PREFS_KEY);</span>
<span class="nc" id="L76">		addComponent(makeStartPreferencesTable(simpleSchedPref));</span>

		// Radio NoPrefs/Early/Late goes here
<span class="nc bnc" id="L79" title="All 2 branches missed.">		short preferredStart = (simpleSchedPref!=null)?simpleSchedPref.getPreferredStart():0;</span>
<span class="nc" id="L80">		addComponent(makeEarlyOrLateRadio(preferredStart));</span>

		// time zone message
<span class="nc" id="L83">		TimeZone orgTz = (TimeZone)theData.get(SchedulePreferenceMH.ORG_TZ_KEY);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">		String orgTzName = (</span>
<span class="nc" id="L85">				orgTz!=null)? TimeZoneHelper.getDisplayTimeZone(orgTz.getID(), m_localizer) </span>
<span class="nc" id="L86">				:i18n(m_bundle,FsWebBundleKey.SP_TZ_NOT_DEFINED);</span>
<span class="nc" id="L87">		addComponent(i18n(m_bundle,FsWebBundleKey.SP_TZ_SHOWN) + &quot; &quot; + orgTzName);</span>
<span class="nc" id="L88">	}</span>

	/** make html table with start preferences */
	private String makeStartPreferencesTable(SimpleSchedulePreference simpleSchedPref){
<span class="nc" id="L92">		MultiColListPC listPC = new MultiColListPC(m_context);</span>
<span class="nc" id="L93">		listPC.setTableClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="nc" id="L94">		listPC.setUseWrapper(false);</span>
<span class="nc" id="L95">		listPC.setEnabled(false);</span>

<span class="nc" id="L97">		TableHeaderPC header = listPC.getHeader();</span>
<span class="nc" id="L98">		header.addColumnHeaderData(&quot;day&quot;,i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_DAY));</span>
<span class="nc" id="L99">		header.addColumnHeaderData(&quot;first&quot;,i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_FIRST));</span>
<span class="nc" id="L100">		header.addColumnHeaderData(&quot;second&quot;,i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_SECOND));</span>
<span class="nc" id="L101">		header.addColumnHeaderData(&quot;third&quot;,i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_THIRD));</span>

<span class="nc" id="L103">		listPC.setListModel(makeListModel(simpleSchedPref));</span>

<span class="nc" id="L105">		return listPC.getHtmlDisplay();</span>
	}

	/** make html string with Radio NoPrefs/Early/Late */
	private String makeEarlyOrLateRadio(short preferredStart){
<span class="nc" id="L110">		StringBuffer sb = new StringBuffer(1000);</span>
<span class="nc" id="L111">		sb.append(&quot;&lt;span&gt;&quot;)</span>
<span class="nc" id="L112">				.append(i18n(m_bundle,FsWebBundleKey.SP_START_TIME_PREFS_GENERAL_Q))</span>
<span class="nc" id="L113">				.append(&quot; &quot;)</span>
<span class="nc" id="L114">				.append(makeRadioEntry(EARLY_OR_LATE_FN,preferredStart,</span>
						SimpleSchedulePreference.PREFERRED_START_NON))
<span class="nc" id="L116">				.append(i18n(m_bundle,FsWebBundleKey.SP_START_TIME_NO_PREF))</span>
<span class="nc" id="L117">				.append(&quot; &quot;)</span>
<span class="nc" id="L118">				.append(makeRadioEntry(EARLY_OR_LATE_FN,preferredStart,</span>
						SimpleSchedulePreference.PREFERRED_START_EARLY))
<span class="nc" id="L120">				.append(i18n(m_bundle,FsWebBundleKey.SP_START_TIME_EARLY_PREF))</span>
<span class="nc" id="L121">				.append(&quot; &quot;)</span>
<span class="nc" id="L122">				.append(makeRadioEntry(EARLY_OR_LATE_FN,preferredStart,</span>
						SimpleSchedulePreference.PREFERRED_START_LATE))
<span class="nc" id="L124">				.append(i18n(m_bundle,FsWebBundleKey.SP_START_TIME_LATE_PREF))</span>
<span class="nc" id="L125">				.append(&quot;&lt;/span&gt;&quot;);</span>
<span class="nc" id="L126">		return sb.toString();</span>
	}

	/** make list model for the table with start time preferences */
	private List makeListModel(SimpleSchedulePreference simpleSchedPref){
<span class="nc" id="L131">		ArrayList listModel = new ArrayList();</span>
<span class="nc" id="L132">		String[] weekdayNames = m_localizer.getWeekdayNames(true);</span>
<span class="nc" id="L133">		int[] weekdayValues = m_localizer.getWeekdayValues();</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">		for(int i=0; i&lt;weekdayValues.length; i++) {</span>
<span class="nc" id="L136">			int iDay = weekdayValues[i];</span>
<span class="nc" id="L137">			String weekday = weekdayNames[iDay];</span>
<span class="nc" id="L138">			DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(weekday);</span>
<span class="nc" id="L139">			nodeData.add(weekday, CSSUtil.STYLE_NORMAL_LEFT); //508</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">			for (int iPref=0; iPref&lt;3; iPref++) {</span>
				// 5.x set limits to time picker with HOO ??
<span class="nc" id="L142">				int startPrefInMin = TimePickerPC.BLANK_TIME;</span>
<span class="nc" id="L143">				int endPrefInMin = TimePickerPC.BLANK_TIME;</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">				if (simpleSchedPref!=null) {</span>
<span class="nc" id="L145">					startPrefInMin = simpleSchedPref.getStartTimePreferenceStart(iDay, iPref);</span>
<span class="nc" id="L146">					endPrefInMin = simpleSchedPref.getStartTimePreferenceEnd(iDay, iPref);</span>
				}
				
				//String startPicker = makeTimePickerHtml(startPrefInMin,iDay,iPref,0);
				//String endPicker = makeTimePickerHtml(endPrefInMin,iDay,iPref,1);
				//nodeData.add(startPicker + &quot; - &quot; + endPicker, CSSUtil.STYLE_NOWRAP);

<span class="nc" id="L153">				String rangePicker = makeTimeRangePickerHtml(startPrefInMin, endPrefInMin, iDay, iPref);</span>
<span class="nc" id="L154">				nodeData.add(rangePicker, CSSUtil.STYLE_NOWRAP);</span>
			}
<span class="nc" id="L156">			listModel.add(nodeData);</span>
		}
<span class="nc" id="L158">		return listModel;</span>
	}

	/** get timePicker string for rendering, checking for empty values
	private String makeTimePickerHtml(int offsetInMin, int iDay, int iPref, int oneForEnd){
		if (offsetInMin != TimePickerPC.BLANK_TIME)
			offsetInMin *= 60;
		//day is in [1,7]
		m_timePickerPC.setInputIndex((iDay-1) * 6 + iPref * 2 + oneForEnd);
		m_timePickerPC.setTime(offsetInMin);
		return m_timePickerPC.getHtmlDisplay();
	}
	*/
	
	/**
	 * Get timeRangePicker string for rendering, checking for empty values.
	 * @param startOffsetInMin Start time
	 * @param endOffsetInMin End time
	 * @param iDay 1=first day, 2=second day, etc.
	 * @param iPref 0=first pref, 1=second pref, 2=third pref
	 * @return The HTML for the desired time range picker.
	 */
	private String makeTimeRangePickerHtml(int startOffsetInMin, int endOffsetInMin, int iDay, int iPref)
	{
<span class="nc bnc" id="L182" title="All 2 branches missed.">		if (startOffsetInMin != TimePickerPC.BLANK_TIME)</span>
<span class="nc" id="L183">			startOffsetInMin *= 60;</span>
		
<span class="nc bnc" id="L185" title="All 2 branches missed.">		if (endOffsetInMin != TimePickerPC.BLANK_TIME)</span>
<span class="nc" id="L186">			endOffsetInMin *= 60;</span>
		
<span class="nc" id="L188">		m_timeRangePickerPC.setTimeInputIndex((iDay-1) * 3 + iPref);</span>
		
<span class="nc" id="L190">		m_timeRangePickerPC.getStartTimePickerPC().setTime(startOffsetInMin);</span>
<span class="nc" id="L191">		m_timeRangePickerPC.getEndTimePickerPC().setTime(endOffsetInMin);</span>
<span class="nc" id="L192">        m_timeRangePickerPC.setTitles(i18n(m_bundle, FsWebBundleKey.SP_FROM_TIME), i18n(m_bundle, FsWebBundleKey.SP_TO_TIME)); //508</span>
		
<span class="nc" id="L194">        return m_timeRangePickerPC.getHtmlDisplay();</span>
	}

	
	public boolean extractParameters(HttpServletRequest request) 
	{
<span class="nc" id="L200">		boolean success=super.extractParameters(request);</span>
<span class="nc" id="L201">		m_startPrefs = null;</span>
		
		//Since the pickers have different names (ex: one has &quot;START&quot; and one has &quot;END&quot;), we have to 
		//call getTimes() for each, then combine the two into the member array by alternating from start 
		//and end array values.
<span class="nc" id="L206">		int[] rangeStartPrefs = m_timeRangePickerPC.getStartTimePickerPC().getTimes();</span>
<span class="nc" id="L207">		int[] rangeEndPrefs = m_timeRangePickerPC.getEndTimePickerPC().getTimes();</span>
		
<span class="nc bnc" id="L209" title="All 2 branches missed.">		if (rangeStartPrefs != null)</span>
		{
<span class="nc" id="L211">			m_startPrefs = new int[rangeStartPrefs.length * 2]; //should be 21*2 = 42</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">			for (int i=0, count=0; i&lt;rangeStartPrefs.length; i++)</span>
			{
<span class="nc" id="L214">				m_startPrefs[count++] = rangeStartPrefs[i];</span>
<span class="nc" id="L215">				m_startPrefs[count++] = rangeEndPrefs[i];</span>
			}
		}
<span class="nc" id="L218">		return success;</span>
	}

	//===== setters for data fields for extraction
	public void setEarlyOrLate(short sVal){
<span class="nc" id="L223">		m_earlyOrLate = sVal;</span>
<span class="nc" id="L224">	}</span>

	/** populate simple prefs obj with extracted start time prefs data */
	public void transferStartTimePrefs(SimpleSchedulePreference simpleSchedPref){
		//flags from radio
<span class="nc" id="L229">		simpleSchedPref.setPreferredStart(m_earlyOrLate);</span>

		//convert into minutes
<span class="nc bnc" id="L232" title="All 2 branches missed.">		for (int i=0; i&lt;m_startPrefs.length;i++){</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">			if (m_startPrefs[i]!=-1) m_startPrefs[i] /=60;</span>
		}

		//set in the object
<span class="nc" id="L237">		int[] weekdayValues = m_localizer.getWeekdayValues();</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">		for(int i=0, iDayIndex=0; iDayIndex&lt;weekdayValues.length; iDayIndex++) {</span>
<span class="nc" id="L239">			int iDay = weekdayValues[iDayIndex];</span>
<span class="nc" id="L240">            int minPrefForDay = 0; </span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">			for (int iPref=0; iPref&lt;3; iPref++) {</span>
				//System.out.println(&quot;\n\t\t -- iDay:&quot; + iDay + &quot;\t iPref:&quot; + iPref + &quot;\t i:&quot; + i + &quot;\t p1:&quot; + m_startPrefs[i] + &quot;\t p2:&quot; + m_startPrefs[i+1] );

                //convert time values from secs into mins
<span class="nc" id="L245">                simpleSchedPref.setStartTimePreference(iDay, minPrefForDay, m_startPrefs[i], m_startPrefs[i+1]);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">                if (m_startPrefs[i] != -1) //to make sure that we always have a first preference (bug #94967)</span>
<span class="nc" id="L247">                    minPrefForDay++;</span>
<span class="nc" id="L248">				i += 2;</span>
			}
		}
<span class="nc" id="L251">	}</span>

	private static String makeRadioEntry(String fieldName, short selectedValue, short entryValue){
<span class="nc bnc" id="L254" title="All 2 branches missed.">		boolean isChecked = (selectedValue == entryValue);</span>
<span class="nc" id="L255">		return HtmlChoiceInput.makeRadioInput(fieldName, String.valueOf(entryValue),	isChecked,&quot;&quot;);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>