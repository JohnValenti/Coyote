<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BiddableScheduleInstance.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model</a> &gt; <span class="el_source">BiddableScheduleInstance.java</span></div><h1>BiddableScheduleInstance.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model;

/**
 * Title:        BiddableScheduleInstance
 * Description:  This class represents an BiddableScheduleInstance
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc.
 * @author       Jagdish Seelam
 * @version 1.0
 */

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectNode;
import com.bluepumpkin.ejb.bbm.workresource.model.Phantom;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestDetailLevel;
import com.bluepumpkin.ejb.rm.util.ShiftBidAuctionUtil;


/**
 * see {@link com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionManager ShiftBidAuctionManager}
 * for a description of the shift bidding process.
 *
 * @author rrajendran
 *
 */
public class BiddableScheduleInstance extends ValueObjectNode {

    /**
     * m_fieldInfo shared by all instances as BiddableScheduleInstance can be the 1-m child of
     * BiddableSchedule only.  1-m child of ShiftBidAuction not needed.
     */
<span class="nc" id="L44">	private static final BiddableScheduleInstanceFieldInfo m_fieldInfo = new BiddableScheduleInstanceFieldInfo();</span>

    public static final int STATUS_UNASSIGNED = 1;
    public static final int STATUS_ASSIGNED = 2;
    public static final int STATUS_INVALID = 3;

    public static final long DL_BASIC = RequestDetailLevel.DL_BASIC;

    /**
     * DL_EMPLOYEE in this context refers to the phantom employee.
     */
    public static final long DL_EMPLOYEE = RequestDetailLevel.DL_EMPLOYEE_BIDSCHEDINST_CHILD;

<span class="nc" id="L57">    private long m_detailLevel = RequestDetailLevel.DL_BASIC;</span>

<span class="nc" id="L59">    private String m_biddableScheduleCheckSum = null;</span>

<span class="nc" id="L61">    private String m_biddableScheduleInstanceCheckSum = null;</span>

<span class="nc" id="L63">    private transient List m_cachedShiftAssnsSorted = null;</span>
<span class="nc" id="L64">    private transient int m_cachedShiftAssnsDuration = 0;</span>
    //  cache doesn't need to be invalidated when certain methods are called since it is read only.
<span class="nc" id="L66">    private transient Phantom m_cachedPhantomEmployee = null;</span>
    //  cache doesn't need to be invalidated when certain methods are called since it is read only.
    private transient BiddableScheduleInstanceOptMethod m_cachedOptMethods;
    private transient BiddableScheduleInstanceSetters m_cachedSetters;


<span class="nc bnc" id="L72" title="All 2 branches missed.">    public class BiddableScheduleInstanceOptMethod {</span>
        /**
         * Returns a sorted list of shift assignments associated with this biddable schedule.
         * @return
         */
        public List getShiftAssignments()  {
<span class="nc bnc" id="L78" title="All 2 branches missed.">			if (m_cachedShiftAssnsSorted != null) {</span>
<span class="nc" id="L79">				return m_cachedShiftAssnsSorted;</span>
			}

<span class="nc" id="L82">            m_cachedShiftAssnsSorted = Collections.EMPTY_LIST;</span>
<span class="nc" id="L83">            long detailLevelsToCheck = RequestDetailLevel.DL_SHIFT_ASSIGNMENTS_COLL_ROOTED_BIDDABLESCHED |</span>
                RequestDetailLevel.DL_SHIFT_ASSIGNMENTS_COLL_ROOTED_SHIFTBIDREQUEST |
                RequestDetailLevel.DL_BIDDABLESCHEDULEINSTANCES;
<span class="nc bnc" id="L86" title="All 4 branches missed.">            assert (getDetailLevel() &amp; detailLevelsToCheck) != 0:</span>
<span class="nc" id="L87">                &quot;getDetailLevel() &amp; detailLevelsToCheck) != 0: &quot; + getDetailLevel();</span>

<span class="nc" id="L89">            m_cachedShiftAssnsSorted = new ArrayList();</span>

<span class="nc" id="L91">            List sortedBiddableShifts = RequestUtil.getListFromCollection(</span>
<span class="nc" id="L92">                getChildObjects(BiddableScheduleInstanceFieldInfo.BIDDABLESHIFT_CHILD_TYPE));</span>

<span class="nc bnc" id="L94" title="All 2 branches missed.">            for (int bidShiftIdx = 0; bidShiftIdx &lt; sortedBiddableShifts.size(); bidShiftIdx++) {</span>
<span class="nc" id="L95">                BiddableShift biddableShift = (BiddableShift) sortedBiddableShifts.get(bidShiftIdx);</span>
<span class="nc" id="L96">                m_cachedShiftAssnsSorted.add(biddableShift.getShiftAssignment());</span>
            }

<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (m_cachedShiftAssnsSorted.size() &gt; 1)</span>
<span class="nc" id="L100">                Collections.sort(m_cachedShiftAssnsSorted, new ShiftBidAuctionUtil.ShiftAssignmentComparator());</span>

<span class="nc" id="L102">            return m_cachedShiftAssnsSorted;</span>
        }

        public Phantom getEmployee()  {
<span class="nc bnc" id="L106" title="All 4 branches missed.">            assert (getDetailLevel() &amp; DL_EMPLOYEE) != 0:&quot;(getDetailLevel() &amp; DL_EMPLOYEE) != 0: &quot; + getDetailLevel();</span>

<span class="nc bnc" id="L108" title="All 2 branches missed.">            if ( m_cachedPhantomEmployee != null ) return m_cachedPhantomEmployee;</span>

<span class="nc" id="L110">            Collection phantoms = getChildObjects(BiddableScheduleInstanceFieldInfo.EMPLOYEE_CHILD_TYPE);</span>
<span class="nc bnc" id="L111" title="All 4 branches missed.">            assert phantoms.size() == 1:&quot;phantoms.size() == 1: &quot; + phantoms.size();</span>
<span class="nc" id="L112">            m_cachedPhantomEmployee = (Phantom) phantoms.iterator().next();</span>

<span class="nc" id="L114">            return m_cachedPhantomEmployee;</span>
        }

        /**
         * ***** Must only be used by the backend code ******
         *
         * Note: This method will not always return the md5Hash for this instance and might return null.
         * It is not persisted in the DB.
         * @return
         */
        public String getBiddableScheduleCheckSum() {
<span class="nc" id="L125">            return m_biddableScheduleCheckSum;</span>
        }

        /**
         * @return duration (in minutes) of all shift assignments associated with this biddable schedule instance.
         * Unpaid shift event assignments are excluded.
         */
        public int getDuration() {
<span class="nc bnc" id="L133" title="All 2 branches missed.">            if (m_cachedShiftAssnsDuration != 0) return m_cachedShiftAssnsDuration;</span>

<span class="nc" id="L135">            List shiftAssns = getShiftAssignments();</span>

<span class="nc" id="L137">            m_cachedShiftAssnsDuration = RequestUtil.computeScheduleLength(getShiftAssignments());</span>
<span class="nc" id="L138">            return m_cachedShiftAssnsDuration;</span>
        }

        /**
         * get the shift assignment which starts on the specified day of week.
         * &lt;p&gt; Note: might return 'null'.
         *
         * @param dayOfWeek ex: Calendar.SUNDAY
         * @param weekRange The date range for the week to look at, or null to find the first week.
         * @param calWithTZ
         * @return
         */
        public ShiftAssignment getShiftAssignmentForDayOfWeek(int dayOfWeek, TimeRange weekRange, Calendar calWithTZ)
        {
<span class="nc" id="L152">            List shiftAssns = getShiftAssignments();</span>
<span class="nc" id="L153">            ShiftAssignment shiftAssn = null;</span>

            // for each shift assignment
<span class="nc bnc" id="L156" title="All 2 branches missed.">            for (Iterator iter = shiftAssns.iterator(); iter.hasNext();)</span>
            {
<span class="nc" id="L158">                shiftAssn = (ShiftAssignment) iter.next();</span>

                //Check if shiftAssn's start day is same as day of week.
<span class="nc" id="L161">                Date shiftStartTime = shiftAssn.getStartTime();</span>
<span class="nc" id="L162">                calWithTZ.setTime(shiftStartTime);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                if (weekRange != null)</span>
                {
<span class="nc bnc" id="L165" title="All 4 branches missed.">                    if ( !shiftStartTime.before(weekRange.getStartDate()) &amp;&amp; !shiftStartTime.after(weekRange.getEndDate()) &amp;&amp;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                            (calWithTZ.get(Calendar.DAY_OF_WEEK) == dayOfWeek))</span>
                    {
<span class="nc" id="L168">                        return shiftAssn;</span>
                    }
                }
                else
                {
                    //weekRange is null, so we'll just find the first shift assignment
                    //which falls on the desired day of week
<span class="nc bnc" id="L175" title="All 2 branches missed.">                    if (calWithTZ.get(Calendar.DAY_OF_WEEK) == dayOfWeek)</span>
                    {
<span class="nc" id="L177">                        return shiftAssn;</span>
                    }
                }
<span class="nc" id="L180">            }</span>
<span class="nc" id="L181">            return null;</span>
        }
    }

<span class="nc" id="L185">    public class BiddableScheduleInstanceSetters {</span>
        /**
         * @param md5Hash
         */
        public void setBiddableScheduleCheckSum(String md5Hash) {
<span class="nc" id="L190">            m_biddableScheduleCheckSum = md5Hash;</span>
<span class="nc" id="L191">        }</span>
    }

	public BiddableScheduleInstance(long detailLevel) {
<span class="nc" id="L195">		super();</span>
<span class="nc" id="L196">        m_detailLevel = detailLevel;</span>
<span class="nc" id="L197">	}</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="nc" id="L201">		return m_fieldInfo;</span>
	}

	public ID getShiftBidAuctionID() {
<span class="nc" id="L205">		return getFieldValueID(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_I_SHIFTBIDAUCTIONID);</span>
	}

	public int getStatus() {
<span class="nc" id="L209">		return getFieldValueInt(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_N_STATUS);</span>
	}

	public ID getEmployeeID() {
<span class="nc" id="L213">		return getFieldValueID(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_I_EMPLOYEEID);</span>
	}

	public int getPointsUsed() {
<span class="nc" id="L217">		return getFieldValueInt(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_N_POINTSUSED);</span>
	}
	public ID getBiddableScheduleID() {
<span class="nc" id="L220">		return getFieldValueID(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_I_BIDDABLESCHEDULEID);</span>
	}

    public ID getPhantomEmployeeID()  {
<span class="nc" id="L224">        return getFieldValueID(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_I_PHANTOMWORKRESOURCEID);</span>
    }

    /**
     * (Used for multishift auction only)
     * @return
     */
    public Date getPhantomStartTime()  {
<span class="nc" id="L232">        return (Date) getFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_D_PHANTOMSTARTTIME);</span>
    }

    /**
     * (Used for multishift auction only)
     * @return
     */
    public Date getPhantomEndTime()  {
<span class="nc" id="L240">        return (Date) getFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_D_PHANTOMENDTIME);</span>
    }

    /**
     * (Used for multishift auction only)
     * @return
     */
    public String getBidSchedInstCheckSum()  {
<span class="nc" id="L248">        return (String) getFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_S_BIDSCHEDINSTCHECKSUM);</span>
    }

    /**
     * (Used for multishift auction only)
     * @return
     */
    public ID getPhantomShiftID()  {
<span class="nc" id="L256">        return (ID) getFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_I_PHANTOMSHIFTID);</span>
    }

    /**
     * (Used for multishift auction only)
     * @return
     */
    public ID getPhantomShiftPatternID()  {
<span class="nc" id="L264">        return (ID) getFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_I_PHANTOMSHIFTPATTERNID);</span>
    }

    /**
     * (Used for multishift auction only)
     * @return
     */
    public String getPhantomDescription()  {
<span class="nc" id="L272">        return (String) getFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_S_PHANTOMDESCRIPTION);</span>
    }

    public long getDetailLevel()  {
<span class="nc" id="L276">        return m_detailLevel;</span>
    }

    public BiddableScheduleInstanceOptMethod getOptMethods()  {
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (m_cachedOptMethods != null) return m_cachedOptMethods;</span>

<span class="nc" id="L282">        return (m_cachedOptMethods = new BiddableScheduleInstanceOptMethod());</span>
    }

    public BiddableScheduleInstanceSetters getSetters()  {
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (m_cachedSetters != null) return m_cachedSetters;</span>

<span class="nc" id="L288">        return (m_cachedSetters = new BiddableScheduleInstanceSetters());</span>
    }

    public void setShiftBidAuctionID(ID id) {
<span class="nc" id="L292">        setFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_I_SHIFTBIDAUCTIONID, id);</span>
<span class="nc" id="L293">    }</span>

	public void setBiddableScheduleID(ID id) {
<span class="nc" id="L296">		setFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_I_BIDDABLESCHEDULEID, id);</span>
<span class="nc" id="L297">	}</span>

    public void setPhantomEmployeeID(ID empID)  {
<span class="nc" id="L300">        setFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_I_PHANTOMWORKRESOURCEID, empID);</span>
<span class="nc" id="L301">    }</span>

    public void setStatus(int status)  {
<span class="nc" id="L304">        setFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_N_STATUS, status);</span>
<span class="nc" id="L305">    }</span>
    public void setEmployeeID(ID employeeID)  {
<span class="nc" id="L307">        setFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_I_EMPLOYEEID, employeeID);</span>
<span class="nc" id="L308">    }</span>
    public void setPointsUsed(int pointsUsed)  {
<span class="nc" id="L310">        setFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_N_POINTSUSED, pointsUsed);</span>
<span class="nc" id="L311">    }</span>

    /**
     * (Used for multishift auction only)
     * @param startTime
     */
    public void setPhantomStartTime(Date startTime)  {
<span class="nc" id="L318">        setFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_D_PHANTOMSTARTTIME, startTime);</span>
<span class="nc" id="L319">    }</span>

    /**
     * (Used for multishift auction only)
     * @param endTime
     */
    public void setPhantomEndTime(Date endTime)  {
<span class="nc" id="L326">        setFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_D_PHANTOMENDTIME, endTime);</span>
<span class="nc" id="L327">    }</span>

    /**
     * (Used for multishift auction only) to keep MD5 checksum of employee's shift assignment after request is approved.
     * If the employee assignment checksum is different to this value, the approved request cannot be withdrawn
     * @param bidSchedInstChecksum
     */
    public void setBidSchedInstChecksum(String bidSchedInstChecksum)  {
<span class="nc" id="L335">        setFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_S_BIDSCHEDINSTCHECKSUM, bidSchedInstChecksum);</span>
<span class="nc" id="L336">    }</span>

    /**
     * (Used for multishift auction only)
     * @param id
     */
    public void setPhantomShiftID(ID id)  {
<span class="nc" id="L343">        setFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_I_PHANTOMSHIFTID, id);</span>
<span class="nc" id="L344">    }</span>

    /**
     * (Used for multishift auction only)
     * @param id
     */
    public void setPhantomShiftPatternID(ID id)  {
<span class="nc" id="L351">        setFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_I_PHANTOMSHIFTPATTERNID, id);</span>
<span class="nc" id="L352">    }</span>

    /**
     * (Used for multishift auction only)
     * @param desc
     */
    public void setPhantomDescription(String desc)  {
<span class="nc" id="L359">        setFieldValue(BiddableScheduleInstanceFieldInfo.BIDDABLESCHEDULEINSTANCE_S_PHANTOMDESCRIPTION, desc);</span>
<span class="nc" id="L360">    }</span>

    public void addBiddableShift(BiddableShift biddableShift)  {
<span class="nc" id="L363">        m_detailLevel |= RequestDetailLevel.DL_BIDDABLESCHEDULEINSTANCES;</span>

<span class="nc" id="L365">        m_cachedShiftAssnsSorted = null; //invalidate cache.</span>
<span class="nc" id="L366">        m_cachedShiftAssnsDuration = 0; //invalidate cache.</span>
<span class="nc" id="L367">        createChildObject(BiddableScheduleInstanceFieldInfo.BIDDABLESHIFT_CHILD_TYPE, biddableShift);</span>
<span class="nc" id="L368">    }</span>

	/*public String toString() {
		StringBuffer sb = new StringBuffer(1024);
		sb.append(&quot;BiddableScheduleInstance@&quot;);
		sb.append(Integer.toHexString(hashCode()));
		sb.append('[');
		FieldInfoEntry fieldEntries[] = m_fieldInfo.getFieldInfo();
		for (int j = 0; j &lt; fieldEntries.length; j++) {
			sb.append(fieldEntries[j].getFieldName());
			sb.append(&quot; = &quot;);-
			sb.append(getFieldValue(j));
			sb.append('\n');
		}
		sb.append(']');
		return sb.toString();
	}*/
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>