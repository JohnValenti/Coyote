<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RotationInlineEditListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">RotationInlineEditListPC.java</span></div><h1>RotationInlineEditListPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRuleFieldInfo;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceRotation;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.Rotation;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.core.pagecomponent.DropDownSelectionPC;
import com.bluepumpkin.web.fs.keys.FsJavaScriptFileID;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.widgets.IntegerDropDownSelection;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.InsertableMultiColListPC;
import com.witness.web.uif.pagecomponent.table.DefaultHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.WorkpaneMultiColPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.SortUtil;
import com.witness.web.uif.util.TimeUtil;
import com.witness.web.uif.util.js.JSUtil;

public class RotationInlineEditListPC extends InsertableMultiColListPC {
	private static final long serialVersionUID = 1L;
	
	private Collection&lt;WorkResourceRotation&gt; assignments;
	//key = workresourcerotation ID, value = associated workresourcerotation
<span class="fc" id="L53">	private HashMap&lt;ID, WorkResourceRotation&gt; modifiedAssignments =</span>
		new HashMap&lt;ID, WorkResourceRotation&gt;();
	private Calendar viewStartDate;
	private Calendar viewEndDate;
<span class="fc" id="L57">	private boolean didTimePeriodChange = false;</span>
<span class="fc" id="L58">	private boolean isReadOnly = false;</span>
<span class="fc" id="L59">	private StringBuffer jsInitCode = new StringBuffer();</span>
<span class="fc" id="L60">	private SchedulingPeriod selectedSP = null;</span>
	
	//Rotations (sometimes) have their start date stored
	//relative to their org's time zone.  We need the associated orgs so we 
	//can translate back to midnight GMT.
<span class="fc" id="L65">	private Map&lt;ID, Organization&gt; orgMap = new HashMap&lt;ID, Organization&gt;();</span>

	public RotationInlineEditListPC(RequestContext context, String name, Collection&lt;WorkResourceRotation&gt; rotations, 
			Date viewStartDate, Date viewEndDate, boolean isReadOnly, boolean didTimePeriodChange,
			Map&lt;ID, Organization&gt; orgMap, SchedulingPeriod selectedSP) {
<span class="fc" id="L70">		super(context);</span>

<span class="fc" id="L72">		setName(name);</span>

<span class="fc" id="L74">		this.assignments = rotations;</span>
<span class="fc" id="L75">		this.viewStartDate = Calendar.getInstance();</span>
<span class="fc" id="L76">		this.viewStartDate.setTime(viewStartDate);</span>
<span class="fc" id="L77">		this.viewEndDate = Calendar.getInstance();</span>
<span class="fc" id="L78">		this.viewEndDate.setTime(viewEndDate);</span>
<span class="fc" id="L79">		this.didTimePeriodChange = didTimePeriodChange;</span>
<span class="fc" id="L80">		this.isReadOnly = isReadOnly;</span>
<span class="fc" id="L81">		this.orgMap = orgMap;</span>
<span class="fc" id="L82">		this.selectedSP = selectedSP;</span>
		
<span class="fc" id="L84">		ToolbarPC toolbar = new ToolbarPC(m_context);</span>
<span class="fc" id="L85">		toolbar.setName(&quot;rotationToolbar&quot;);</span>
<span class="fc" id="L86">		ToolbarTextButton addButton = toolbar.createPopupWindowButton(RotationListPopupPM.POPUP_ID,</span>
<span class="fc" id="L87">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_ADD), true);</span>
<span class="fc" id="L88">		addButton.setAttribute(&quot;viewStartDate&quot;, Long.toString(this.viewStartDate.getTimeInMillis()));</span>
<span class="fc" id="L89">		addButton.setAttribute(&quot;viewEndDate&quot;, Long.toString(this.viewEndDate.getTimeInMillis()));</span>
<span class="fc" id="L90">		addButton.setAttribute(&quot;onClick&quot;,getFilterJSForAddButton(getName(), toolbar.getName(), RotationListPopupPM.POPUP_ID));</span>
<span class="fc" id="L91">		ToolbarTextButton removeButton = new ToolbarTextButton(toolbar, &quot;removeRotation&quot;,</span>
<span class="fc" id="L92">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_REMOVE),</span>
				InsertableMultiColListPC.REMOVE_ROW_BUTTON_ACTION, ToolbarTextButton.BLUE_BUTTON, false);
		
		//Only one rotation may be assigned at any given time
<span class="fc" id="L96">		setOnRowAddJS(getName() + &quot;.itemAdded('&quot; + addButton.getName() + &quot;','&quot; + removeButton.getName() + &quot;');&quot;);</span>
<span class="fc" id="L97">		setOnRowRemoveJS(getName() + &quot;.itemRemoved('&quot; + addButton.getName() + &quot;','&quot; + removeButton.getName() + &quot;');&quot;);</span>

<span class="fc" id="L99">		setIsBorderEnabled(true);</span>
<span class="fc" id="L100">		setToolbar(toolbar);</span>
		
<span class="fc" id="L102">		addPopupArgs(RotationListPopupPM.POPUP_ID, RotationListPopupPM.FORM_ACTION, &quot;&quot;,</span>
				RotationListPopupPM.POPUP_ARGS, &quot;1000,600,ctr,ctr&quot;, true, 1);
		
		//If we don't have any rows for the list on initial load, we still need to get the required
		// js files from the inline components that may be added dynamically
<span class="fc" id="L107">		IntegerDropDownSelection dummyIntegerSelectionPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="fc" id="L108">			getName() + &quot;_dummyIntegerSelectionPC&quot;, 0, 0);</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">		for (String js : dummyIntegerSelectionPC.getRequireJavaScriptFiles()) {</span>
<span class="fc" id="L110">			addRequiredJavaScriptFile(js);</span>
<span class="fc" id="L111">		}</span>
		
<span class="fc" id="L113">		setJSMediator(FsJavaScriptFileID.SINGLETON_INSERTABLE_TABLE);</span>
		
<span class="fc" id="L115">		extractParameters(m_context.getRequest());</span>

		//Remove button should default to false because when the page is first loaded, because a rotation
		//will not be selected when the page first loads.
<span class="fc" id="L119">		removeButton.setEnabled(false);</span>

<span class="pc bpc" id="L121" title="1 of 2 branches missed.">		if (isReadOnly) {</span>
<span class="nc" id="L122">			addButton.setEnabled(false);</span>
<span class="nc" id="L123">			setRowSelectable(false);</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">		} else if (rotations.size() &gt; 0) {</span>
<span class="fc" id="L125">			addButton.setEnabled(false);</span>
		}
<span class="fc" id="L127">		toolbar.addToolbarElement(addButton);</span>
<span class="fc" id="L128">		toolbar.addToolbarElement(removeButton);</span>
		
<span class="fc" id="L130">		setRenderJavaScriptIfDisabled(true);</span>
<span class="fc" id="L131">	}</span>

	public String getJavaScriptInitCode() {
<span class="fc" id="L134">		StringBuffer js = new StringBuffer(super.getJavaScriptInitCode());</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">		if (getToolbar() != null) {</span>
<span class="fc" id="L136">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.setToolbar(&quot;).append(getToolbar().getName()).append(&quot;);&quot;);</span>
<span class="fc" id="L137">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.addButtonEnableAttribute('isDeleteable', 'removeRotation');\n&quot;);</span>
		}
<span class="fc" id="L139">		return js.toString();</span>
	}
	
<span class="fc" id="L142">	private boolean isHeaderInited = false;</span>
	private void initHeader() {
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">		if (isHeaderInited) return;</span>
<span class="fc" id="L145">		isHeaderInited = true;</span>
		
<span class="fc" id="L147">		TableHeaderPC header = getHeader();</span>
<span class="fc" id="L148">		Localizer localizer = m_context.getLocalizer();</span>

<span class="fc" id="L150">		DefaultHeaderData dhd = new DefaultHeaderData(FsWebBundleKey.FS_ROTATION,</span>
<span class="fc" id="L151">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ROTATION));</span>
		/*boolean isInfoButtonEnabled = true; //JavaScript Error when you click on Rotation Information (i) to view rotation detail. - ESR#4166404
		if (assignments == null || assignments.isEmpty())
			isInfoButtonEnabled = false;*/
<span class="fc" id="L155">		dhd.addImageButton(getInfoButtonPopupImage(), getInfoButtonPopupCaption(), getInfoButtonPopupJS()/*, !isInfoButtonEnabled*/);</span>
<span class="fc" id="L156">		dhd.setSortable(false);</span>
<span class="fc" id="L157">		header.addColumnHeaderData(dhd);</span>
<span class="fc" id="L158">		header.addColumnHeaderData(FsWebBundleKey.FS_WORK_PATTERN, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_WORK_PATTERN));</span>
<span class="fc" id="L159">	}</span>
	
	private String getInfoButtonPopupImage() {
<span class="fc" id="L162">		return ImageFileID.TOOLTIP_BUTTON;</span>
	}
	
	private String getInfoButtonPopupCaption() {
<span class="fc" id="L166">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_VIEW_ROTATION_DETAILS);</span>
	}
	
	private String getInfoButtonPopupJS() {
<span class="fc" id="L170">		return &quot;WorkRulesUtil.handleInfoPopup(this, (typeof &quot; + getName() + &quot;==='undefined'?null:&quot; + getName() + &quot;), (typeof &quot; + getHeader().getName() + &quot;==='undefined'?null:&quot; + getHeader().getName() + &quot;),'&quot; +</span>
			RotationListPopupPM.POPUP_ID + &quot;','&quot; + RotationListPopupPM.POPUP_ARG_ROTATION_ID + &quot;','&quot; +
			RotationListPopupPM.POPUP_ARG_SELECTED_IDS + &quot;','&quot; + RotationListPopupPM.POPUP_ARG_IS_INFO_POPUP +
			&quot;','true');&quot;;	
	}

<span class="fc" id="L176">	private boolean isRowsInited = false;</span>
	private void initRows() {
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">		if (isRowsInited) return;</span>
<span class="fc" id="L179">		isRowsInited = true;</span>
		
<span class="fc" id="L181">		List&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>

<span class="fc" id="L183">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">		for (WorkResourceRotation wrr : assignments) {		</span>
<span class="fc" id="L185">			rows.add(getNodeData(wrr, false));</span>
<span class="fc" id="L186">			ids.add(wrr.getRotation().getID());</span>
<span class="fc" id="L187">		}</span>
		
		//Sort the rows by item name
<span class="fc" id="L190">		SortUtil.sort(rows, getHeader().getColumnIndexByName(FsWebBundleKey.FS_ROTATION), true, m_context.getLocalizer());</span>
		
<span class="fc" id="L192">		this.setRowIDs(StringUtil.createDelimitedString(ids.toArray(new ID[ids.size()])));</span>
<span class="fc" id="L193">	}</span>
	
	public String getRowHtml(WorkResourceRotation wrr) {
<span class="nc" id="L196">		StringBuffer html = new StringBuffer();</span>
<span class="nc" id="L197">		super.appendHtmlRowData(html, getNodeData(wrr, true), 0, 0);</span>
		
		//Create the javascript to instantiate the objects for the inline controls
<span class="nc" id="L200">		html.append(HtmlUtil.jsTag(jsInitCode.toString(), false));</span>
<span class="nc" id="L201">		jsInitCode.setLength(0);</span>

<span class="nc" id="L203">		return html.toString();</span>
	}
	
	protected DefaultMultiColumnNodeData getNodeData(WorkResourceRotation wrr, boolean isAjaxRequest) {
<span class="fc" id="L207">		DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(wrr.getRotation().getID());</span>
		
		//Name
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">		if (wrr.isMultiEditCommon()) {</span>
<span class="fc" id="L211">			nodeData.add(wrr.getRotation().getName());</span>
		} else {
<span class="nc" id="L213">			nodeData.add(&quot;*&quot; + wrr.getRotation().getName());</span>
		}
		
		//Work Pattern
<span class="fc" id="L217">		DropDownSelectionPC&lt;Integer&gt; workPatternsDDPC = getWorkPatternDDPC(wrr);</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">		if (isReadOnly) {</span>
<span class="nc" id="L219">			workPatternsDDPC.setEnabled(false);</span>
		}
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">		if (isAjaxRequest) jsInitCode.append(workPatternsDDPC.getJavaScriptInitCode()); </span>
<span class="fc" id="L222">		addChildComponent(workPatternsDDPC);</span>
<span class="fc" id="L223">		nodeData.add(workPatternsDDPC);</span>
		
<span class="fc" id="L225">		setRowAttributes(nodeData, wrr);</span>
<span class="fc" id="L226">		return nodeData;</span>
	}
	
	protected void setRowAttributes(DefaultMultiColumnNodeData mcnd, WorkResourceRotation wrr) {
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">		if (!wrr.isMultiEditCommon()) mcnd.setNodeAttribute(ROW_ATTRIBUTE_MULTI_EDIT_NOT_COMMON, String.valueOf(true));</span>
<span class="fc" id="L231">		mcnd.setNodeAttribute(WorkpaneMultiColPM.IS_DELETEABLE, String.valueOf(true));</span>
<span class="fc" id="L232">		mcnd.setNodeAttribute(RotationListPopupPM.POPUP_ARG_ROTATION_ID, wrr.getRotation().getID().toString());</span>
<span class="fc" id="L233">	}</span>
	
	private DropDownSelectionPC&lt;Integer&gt; getWorkPatternDDPC(WorkResourceRotation wrr) {
<span class="fc" id="L236">		DropDownSelectionPC&lt;Integer&gt; workPatternsDDPC = new DropDownSelectionPC&lt;Integer&gt;(</span>
<span class="fc" id="L237">				getRequestContext(), getName() + &quot;_workPatternsDDPC_&quot; + JSUtil.getJSSuffix(wrr.getRotation().getID().toString()));</span>

<span class="pc bpc" id="L239" title="1 of 2 branches missed.">		if (isStartWeekMultiEdit(wrr)) {</span>
<span class="nc" id="L240">			workPatternsDDPC.setMultiEdit(true);</span>
		}
<span class="fc" id="L242">		boolean isSelected = false;</span>
<span class="fc" id="L243">		int selectedWorkPatternOffset = getSelectedWorkPatternOffsetDisplayIndex(wrr);</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">		for (Integer i = 0; i &lt; wrr.getNumWeeksInRotation(); i++) {</span>
<span class="pc bpc" id="L245" title="1 of 4 branches missed.">			isSelected = !isStartWeekMultiEdit(wrr) &amp;&amp; (selectedWorkPatternOffset == i);</span>
<span class="fc" id="L246">			ShiftPattern shiftPattern = wrr.getRotation().getShiftPatterns().get(i);</span>
			
			//If the shift pattern has already been deleted, then display &quot;This work pattern has been deleted&quot;
			//Otherwise, display the name of the work pattern
<span class="pc bpc" id="L250" title="3 of 4 branches missed.">			if (shiftPattern.getDeletedOnDate() != null &amp;&amp;</span>
				(
<span class="nc bnc" id="L252" title="All 2 branches missed.">					(selectedSP != null &amp;&amp; shiftPattern.getDeletedOnDate().before(selectedSP.getEndTime())) ||</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">					shiftPattern.getDeletedOnDate().before(viewEndDate.getTime())</span>
				)
			) {		//Work pattern was deleted before the view end date or sp end date if in campaign mode
<span class="nc" id="L256">				workPatternsDDPC.addOption(i.toString(), getLocalizer().i18n(</span>
						FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ROTATION_LIST_DISPLAY_DELETED_WP,
<span class="nc" id="L258">						new Object[]{new Integer(i + 1).toString(), shiftPattern.getName()}),</span>
						i, isSelected);
			} else {	
<span class="fc" id="L261">				workPatternsDDPC.addOption(i.toString(), getLocalizer().i18n(</span>
						FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ROTATION_LIST_DISPLAY,
<span class="fc" id="L263">						new Object[]{new Integer(i + 1).toString(), shiftPattern.getName()}),</span>
						i, isSelected);
			}
		}

		
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">		if (!didTimePeriodChange) {</span>
<span class="fc" id="L270">			workPatternsDDPC.extractParameters(m_context.getRequest());</span>
		}
		
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">		if (workPatternsDDPC.isEdited()) {</span>
<span class="nc" id="L274">			workPatternsDDPC.setMultiEdit(false);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">			if (modifiedAssignments.containsKey(wrr.getID())) {</span>
<span class="nc" id="L276">				setWorkPatternOffsetFromDropDownSelection(modifiedAssignments.get(wrr.getID()),</span>
<span class="nc" id="L277">						workPatternsDDPC.getSelections().iterator().next());</span>
			} else {
<span class="nc" id="L279">				setWorkPatternOffsetFromDropDownSelection(wrr,</span>
<span class="nc" id="L280">						workPatternsDDPC.getSelections().iterator().next());</span>
				//Only add to modified assignments if this is not a newly added assignment
<span class="nc bnc" id="L282" title="All 2 branches missed.">				if (wrr.getID() != null) {</span>
<span class="nc" id="L283">					modifiedAssignments.put(wrr.getID(), wrr);</span>
				}
			}	
		}
		
<span class="fc" id="L288">		return workPatternsDDPC;</span>
	}
	
<span class="fc" id="L291">	private boolean isExtracted = false;</span>
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc bfc" id="L294" title="All 2 branches covered.">		if (isExtracted) return true;</span>
<span class="fc" id="L295">		isExtracted = true;</span>
<span class="fc" id="L296">		boolean retVal = true;</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">		if (didTimePeriodChange == false) {</span>
<span class="fc" id="L298">			retVal = super.extractParameters(request);</span>
		}
		
		// removed
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">		for (ID removedID : getRemovedRowIDCollection()) {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">			for (WorkResourceRotation wrr : assignments) {</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">				if (removedID.equals(wrr.getRotation().getID())) {</span>
<span class="nc" id="L305">					assignments.remove(wrr);</span>
<span class="nc" id="L306">					break;</span>
				}
<span class="nc" id="L308">			}</span>
<span class="nc" id="L309">		}</span>

		// added
		try {
<span class="fc" id="L313">			Collection&lt;ID&gt; addedIDs = getAddedRowIDCollection();</span>
<span class="fc bfc" id="L314" title="All 2 branches covered.">			if (addedIDs.size() &gt; 0) {</span>
<span class="fc" id="L315">				HashSet&lt;ID&gt; newOrgIDs = new HashSet&lt;ID&gt;();</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">				for (Rotation rotation : WorkRulesModelHandler.getRotationsByIDs(m_context, addedIDs)) {</span>
<span class="fc" id="L317">					newOrgIDs.add(rotation.getOrganizationID());</span>
<span class="fc" id="L318">					WorkResourceRotation wrr = new WorkResourceRotation();</span>
<span class="fc" id="L319">					wrr.setRotation(rotation);</span>
<span class="fc" id="L320">					wrr.setMultiEditCommon(true);</span>
<span class="fc" id="L321">					wrr.setNumWeeksInRotation(rotation.getShiftPatterns().size());</span>
					//If this rotation is already present in assignments, make sure to remove it before re-adding.
					//This case happens when the user removes a rotation and then re-adds the same one.
<span class="fc" id="L324">					WorkResourceRotation existingAssignment = null;</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">					for (WorkResourceRotation existingWrr : assignments) {</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">						if (existingWrr.getRotation().getID().equals(rotation.getID())) {</span>
<span class="nc" id="L327">							existingAssignment = existingWrr;</span>
<span class="nc" id="L328">							break;</span>
						}
<span class="nc" id="L330">					}</span>
<span class="pc bpc" id="L331" title="1 of 2 branches missed.">					if (existingAssignment != null) {</span>
<span class="nc" id="L332">						assignments.remove(existingAssignment);</span>
					}
<span class="fc" id="L334">					assignments.add(wrr); // This will be updated in the initRows method call below</span>
<span class="fc" id="L335">				}</span>
				//For any new assignments, we need to grab the organization of the work rule and add it to the org map
<span class="fc" id="L337">				Collection&lt;Organization&gt; newOrgs = OrganizationModelHandler.getOrganizationsByIDs(m_context, newOrgIDs);</span>
<span class="fc bfc" id="L338" title="All 2 branches covered.">				for (Organization org : newOrgs) {</span>
<span class="fc" id="L339">					orgMap.put(org.getID(), org);</span>
<span class="fc" id="L340">				}</span>
			}
<span class="nc" id="L342">		} catch (Exception e) {</span>
<span class="nc" id="L343">			retVal = false;</span>
<span class="nc" id="L344">			handleUnableToLoadDataError(log, e);</span>
<span class="fc" id="L345">		}</span>

<span class="fc" id="L347">		initHeader();</span>
<span class="fc" id="L348">		initRows();</span>
		
<span class="fc" id="L350">		return retVal;</span>
	}
	
	private boolean isStartWeekMultiEdit(WorkResourceRotation wrr) {
<span class="fc" id="L354">		return wrr.isFieldMultiValue(</span>
				WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_STARTWEEKOFFSET);
	}
	
	/**
	 * Returns the rotation rule creation date (start date).  Always returns a Calendar with a
	 * time component set to midnight.
	 * NOTE: Older versions of the FS client sometimes store the start date relative
	 * to midnight at the org where the rule was created.  In these rare cases, we need
	 * to shift the time so that the time portion of the date is at midnight.
	 */
	private Calendar getRotationCreateDate(WorkResourceRotation wrr) {
<span class="fc" id="L366">		Calendar wrStartDate = Calendar.getInstance();</span>
<span class="fc" id="L367">		wrStartDate.setTime(wrr.getRotation().getAlignmentDate().getTime(TimeZoneUtil.GMT_TIMEZONE));</span>

		//Check if the rule has a start date of midnight.  If it does, no translation is
		// required.
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">		if ((wrStartDate.get(Calendar.HOUR_OF_DAY) != 0 ||</span>
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">				wrStartDate.get(Calendar.MINUTE) != 0 ||</span>
<span class="pc bpc" id="L373" title="1 of 2 branches missed.">				wrStartDate.get(Calendar.SECOND) != 0 ||</span>
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">				wrStartDate.get(Calendar.MILLISECOND) != 0) &amp;&amp;</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">				orgMap.get(wrr.getRotation().getOrganizationID()) != null) {</span>
<span class="nc" id="L376">			Date orgTimeShiftedDate = wrStartDate.getTime();</span>
<span class="nc" id="L377">			LocalDate orgLocalDate = new LocalDate(orgTimeShiftedDate,</span>
<span class="nc" id="L378">					orgMap.get(wrr.getRotation().getOrganizationID()).getTimeZone());</span>
<span class="nc" id="L379">			wrStartDate.setTime(orgLocalDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
		}
<span class="fc" id="L381">		return wrStartDate;</span>
	}
	
	//Returns the work pattern index to be selected in the drop down based on offset and current selected date range
	private int getSelectedWorkPatternOffsetDisplayIndex(WorkResourceRotation wrr) {
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">		if (wrr.getNumWeeksInRotation() == 0) return 1;</span>
		
<span class="fc" id="L388">		int weeksBetween = TimeUtil.getWeeksCountBetweenDates(getRotationCreateDate(wrr), viewStartDate);</span>
<span class="fc" id="L389">		return (((weeksBetween % wrr.getNumWeeksInRotation()) + wrr.getStartWeekOffSet()) % wrr.getNumWeeksInRotation());</span>
	}

	private void setWorkPatternOffsetFromDropDownSelection(WorkResourceRotation wrr, int dropDownDisplayValue) {
<span class="nc" id="L393">		int weeksBetween = TimeUtil.getWeeksCountBetweenDates(getRotationCreateDate(wrr), viewStartDate);</span>
<span class="nc" id="L394">		int offset = (weeksBetween % wrr.getNumWeeksInRotation()) - (dropDownDisplayValue);</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">		if (offset &gt; 0) wrr.setStartWeekOffSet(wrr.getNumWeeksInRotation() - offset);</span>
<span class="nc" id="L396">		else wrr.setStartWeekOffSet(-offset);</span>
<span class="nc" id="L397">	}</span>
	
	public void save(HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; rotationAssignmentMap) throws BbmException {
<span class="fc" id="L400">		Collection&lt;ID&gt; removedRotationIDs = getRemovedRotationAssignmentIDs(rotationAssignmentMap);</span>
<span class="pc bpc" id="L401" title="2 of 4 branches missed.">		if (removedRotationIDs != null &amp;&amp; removedRotationIDs.size() &gt; 0) {</span>
<span class="nc" id="L402">			WorkRulesModelHandler.deleteRotationAssignments(m_context, removedRotationIDs);</span>
		}
<span class="fc" id="L404">		Collection&lt;WorkResourceRotation&gt; modifiedRotationAssignments = getModifiedRotationAssignments(rotationAssignmentMap);</span>
<span class="pc bpc" id="L405" title="2 of 4 branches missed.">		if (modifiedRotationAssignments != null &amp;&amp; modifiedRotationAssignments.size() &gt; 0) {</span>
<span class="nc" id="L406">			WorkRulesModelHandler.updateRotationAssignments(m_context, modifiedRotationAssignments);</span>
		}
<span class="fc" id="L408">		Collection&lt;WorkResourceRotation&gt; addedRotationAssignments = getAddedRotationAssignments(rotationAssignmentMap);</span>
<span class="pc bpc" id="L409" title="1 of 4 branches missed.">		if (addedRotationAssignments != null &amp;&amp; addedRotationAssignments.size() &gt; 0) {</span>
<span class="fc" id="L410">			WorkRulesModelHandler.createRotationAssignments(m_context, addedRotationAssignments);</span>
		}
		
		//Clear out the removed/added IDs when finished to avoid saving/deleting duplicates
<span class="fc" id="L414">		setAddedRowIDs(&quot;&quot;);</span>
<span class="fc" id="L415">		setRemovedRowIDs(&quot;&quot;);</span>
<span class="fc" id="L416">	}</span>
	
	private HashSet&lt;WorkResourceRotation&gt; getAddedRotations() {
<span class="fc" id="L419">		HashSet&lt;WorkResourceRotation&gt; retVal = new HashSet&lt;WorkResourceRotation&gt;();</span>
<span class="fc bfc" id="L420" title="All 2 branches covered.">		for (ID id : getAddedRowIDCollection()) {</span>
<span class="pc bpc" id="L421" title="1 of 2 branches missed.">			for (WorkResourceRotation wrr : assignments) {</span>
<span class="pc bpc" id="L422" title="1 of 2 branches missed.">				if (id.equals(wrr.getRotation().getID())) {</span>
<span class="fc" id="L423">					retVal.add(wrr);</span>
<span class="fc" id="L424">					break;</span>
				}
<span class="nc" id="L426">			}</span>
<span class="fc" id="L427">		}</span>
<span class="fc" id="L428">		return retVal;</span>
	}
	
	private Collection&lt;WorkResourceRotation&gt; getAddedRotationAssignments(HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; rotationAssignmentMap) {
<span class="fc" id="L432">		Collection&lt;WorkResourceRotation&gt; addedRotations = getAddedRotations();</span>
<span class="fc" id="L433">		ArrayList&lt;WorkResourceRotation&gt; newAddedRotations = new ArrayList&lt;WorkResourceRotation&gt;();</span>
		
<span class="fc bfc" id="L435" title="All 2 branches covered.">		for (ID employeeID : rotationAssignmentMap.keySet()) {</span>
<span class="fc bfc" id="L436" title="All 2 branches covered.">			for (WorkResourceRotation addedRotation : addedRotations) {</span>
<span class="fc" id="L437">				WorkResourceRotation wrr = new WorkResourceRotation();</span>
<span class="fc" id="L438">				wrr.setStartWeekOffSet(addedRotation.getStartWeekOffSet());</span>
<span class="fc" id="L439">				wrr.setNumWeeksInRotation(addedRotation.getNumWeeksInRotation());</span>
<span class="fc" id="L440">				wrr.setRotation(addedRotation.getRotation());</span>
<span class="fc" id="L441">				wrr.setWeekEnabledMask(-1);</span>
<span class="fc" id="L442">				wrr.setWorkResourceID(employeeID);</span>
<span class="fc" id="L443">				newAddedRotations.add(wrr);</span>
<span class="fc" id="L444">			}</span>
<span class="fc" id="L445">		}</span>

<span class="fc" id="L447">		return newAddedRotations;</span>
	}
	
	private Collection&lt;WorkResourceRotation&gt; getModifiedRotations() {
<span class="fc" id="L451">		return new ArrayList&lt;WorkResourceRotation&gt;(modifiedAssignments.values());</span>
	}
	
	private Collection&lt;WorkResourceRotation&gt; getModifiedRotationAssignments(HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; rotationAssignmentMap) {
		//Only one copy of each rotation is stored on the page (even if multiple employees are selected), so
		// we need to modify the other rotations that belong to every employee
<span class="fc" id="L457">		Collection&lt;WorkResourceRotation&gt; modifiedRotations = getModifiedRotations();</span>
<span class="fc" id="L458">		ArrayList&lt;WorkResourceRotation&gt; newModifiedRotations = new ArrayList&lt;WorkResourceRotation&gt;();</span>
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">		for (WorkResourceRotation wrr : modifiedRotations) {</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">			for (ID employeeID : rotationAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">				if (wrr.getWorkResourceID().equals(employeeID) == false) {</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">					for (WorkResourceRotation existingRotationAssignment : rotationAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">						if (wrr.getRotation().getID().equals(existingRotationAssignment.getRotation().getID())) {</span>
<span class="nc" id="L464">							existingRotationAssignment.setStartWeekOffSet(wrr.getStartWeekOffSet());</span>
<span class="nc" id="L465">							newModifiedRotations.add(existingRotationAssignment);</span>
<span class="nc" id="L466">							break;</span>
						}
<span class="nc" id="L468">					}</span>
				}
<span class="nc" id="L470">			}</span>
<span class="nc" id="L471">		}</span>
<span class="fc" id="L472">		modifiedRotations.addAll(newModifiedRotations);</span>
<span class="fc" id="L473">		return modifiedRotations;</span>
	}
	
	private Collection&lt;ID&gt; getRemovedRotationAssignmentIDs(HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; rotationAssignmentMap) {
<span class="fc" id="L477">		Collection&lt;ID&gt; removedRotationIDs = getRemovedRowIDCollection();</span>
<span class="fc" id="L478">		Collection&lt;ID&gt; removedAssignmentIDs = new ArrayList&lt;ID&gt;();</span>
		
<span class="fc bfc" id="L480" title="All 2 branches covered.">		for (ID employeeID : rotationAssignmentMap.keySet()) {</span>
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">			for (WorkResourceRotation wrr : rotationAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">				if (removedRotationIDs.contains(wrr.getRotation().getID())) {</span>
<span class="nc" id="L483">						removedAssignmentIDs.add(wrr.getID());</span>
				}
<span class="nc" id="L485">			}</span>
<span class="fc" id="L486">		}</span>
		
		//In the case where a rule was removed and then the same rule was added back in, we will need to
		// remove the original rule so we will get the ID for that rule here.
<span class="fc" id="L490">		Collection&lt;WorkResourceRotation&gt; addedAssignments = </span>
<span class="fc" id="L491">			getAddedRotationAssignments(rotationAssignmentMap);</span>
<span class="fc bfc" id="L492" title="All 2 branches covered.">		if (addedAssignments.isEmpty() == false) {</span>
<span class="fc bfc" id="L493" title="All 2 branches covered.">			for (ID empID : rotationAssignmentMap.keySet()) {</span>
<span class="pc bpc" id="L494" title="1 of 2 branches missed.">				for (WorkResourceRotation existingAssignment : rotationAssignmentMap.get(empID)) {</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">					for (WorkResourceRotation addedAssignment : addedAssignments) {</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">						if (existingAssignment.getComplexWorkRuleID().equals(addedAssignment.getComplexWorkRuleID())) {</span>
<span class="nc" id="L497">							removedAssignmentIDs.add(existingAssignment.getID());</span>
						}
<span class="nc" id="L499">					}</span>
<span class="nc" id="L500">				}</span>
<span class="fc" id="L501">			}</span>
		}
		
<span class="fc" id="L504">		return removedAssignmentIDs;</span>
	}
	
	/**
	 * Returns the number of rotations that will be displayed by this list.
	 */
	public int getNumberOfDisplayedRotations() {
<span class="pc bpc" id="L511" title="1 of 2 branches missed.">		if (assignments != null) return assignments.size();</span>
<span class="nc" id="L512">		return 0;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>