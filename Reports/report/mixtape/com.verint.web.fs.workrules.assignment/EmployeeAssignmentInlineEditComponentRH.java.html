<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EmployeeAssignmentInlineEditComponentRH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">EmployeeAssignmentInlineEditComponentRH.java</span></div><h1>EmployeeAssignmentInlineEditComponentRH.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.empworkrule.model.*;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignmentFieldInfo;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.Rotation;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.ejb.bbm.workrules.model.TimeBank;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.skill.SkillModelHandler;
import com.bluepumpkin.web.fs.l10n.FsWebLogBundleKey;
import com.verint.web.fs.skills.SkillsAssignmentMH;
import com.verint.web.fs.skills.SkillsEmployeeAssignmentPM;
import com.verint.web.fs.skills.SkillsInlineEditListPC;
import com.verint.web.fs.util.SecureFieldUtil;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.witness.web.uif.base.RequestHandler;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;

import javax.servlet.http.HttpServletResponse;
import java.io.PrintWriter;
import java.util.*;

<span class="fc" id="L39">public class EmployeeAssignmentInlineEditComponentRH extends RequestHandler {</span>
<span class="fc" id="L40">	public static String URL = &quot;employee_assignment_inline_edit_component&quot;;</span>
<span class="fc" id="L41">	public static String PARAM_TYPE = &quot;type&quot;;</span>
<span class="fc" id="L42">	public static String PARAM_IDS = &quot;ids&quot;;</span>
<span class="fc" id="L43">	public static String PARAM_START_DATE = &quot;startDate&quot;;</span>
<span class="fc" id="L44">	public static String PARAM_END_DATE = &quot;endDate&quot;;</span>
<span class="fc" id="L45">	public static String PARAM_VIEW_START_DATE = &quot;viewStartDate&quot;;</span>
<span class="fc" id="L46">	public static String PARAM_VIEW_END_DATE = &quot;viewEndDate&quot;;</span>
<span class="fc" id="L47">	public static String ASSIGNMENT_RULE_TYPE = &quot;assignmentRule&quot;;</span>
<span class="fc" id="L48">	public static String ROTATION_RULE_TYPE = &quot;rotation&quot;;</span>
<span class="fc" id="L49">	public static String WORK_PATTERN_TYPE = &quot;workPattern&quot;;</span>
<span class="fc" id="L50">	public static String TIME_BANK_TYPE = &quot;timeBank&quot;;</span>
<span class="fc" id="L51">	public static String TIME_BANK_ASSIGNMENT_CHECK_TYPE = &quot;timeBankAssignmentCheck&quot;;</span>
<span class="fc" id="L52">	public static String SKILL_TYPE = &quot;skill&quot;;</span>
<span class="fc" id="L53">	public static String PARAM_EMPLOYEE_IDS = &quot;employeeIDs&quot;;</span>
<span class="fc" id="L54">	public static String PARAM_SP_ID = &quot;spID&quot;;</span>

	@Override
	public void processRequest(RequestContext context) throws Exception {
<span class="fc" id="L58">		StringBuffer response = new StringBuffer();</span>
		try {
<span class="fc" id="L60">			String ids = context.getParameter(PARAM_IDS);</span>
<span class="fc" id="L61">			String type = context.getParameter(PARAM_TYPE);</span>
<span class="fc" id="L62">			String startDateStr = context.getParameter(PARAM_START_DATE);</span>
<span class="fc" id="L63">			String endDateStr = context.getParameter(PARAM_END_DATE);</span>
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">			if (ASSIGNMENT_RULE_TYPE.equals(type)) {</span>
<span class="nc" id="L65">				Collection&lt;ComplexWorkRule&gt; assignmentRules =</span>
<span class="nc" id="L66">						WorkRulesModelHandler.getComplexWorkRulesByIDs(context, StringUtil.parseIDStringToCollection(ids));</span>
<span class="nc" id="L67">				HashSet&lt;ID&gt; orgIDs = new HashSet&lt;&gt;();</span>
<span class="nc" id="L68">				HashMap&lt;ID, Organization&gt; orgMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">				for (ComplexWorkRule assignmentRule : assignmentRules) {</span>
<span class="nc" id="L70">					orgIDs.add(assignmentRule.getOrganizationID());</span>
<span class="nc" id="L71">				}</span>
<span class="nc" id="L72">				Collection&lt;Organization&gt; orgs =</span>
<span class="nc" id="L73">						OrganizationModelHandler.getOrganizationsByIDs(context, orgIDs);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">				for (Organization org : orgs) {</span>
<span class="nc" id="L75">					orgMap.put(org.getID(), org);</span>
<span class="nc" id="L76">				}</span>
<span class="nc" id="L77">				AssignmentRuleInlineEditListPC pc_assignmentRule =</span>
						new AssignmentRuleInlineEditListPC(context, &quot;assignmentRuleTable&quot;, null,
<span class="nc" id="L79">								getDateFromStringParam(startDateStr), getDateFromStringParam(endDateStr), orgMap);</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">				for (ComplexWorkRule cwr : assignmentRules) {</span>
<span class="nc" id="L81">					WorkResourceComplexWorkRule wrcwr = new WorkResourceComplexWorkRule();</span>
<span class="nc" id="L82">					wrcwr.setComplexWorkRule(cwr);</span>
<span class="nc" id="L83">					wrcwr.setNumWeeksInRotation(1);</span>
<span class="nc" id="L84">					HashSet&lt;Integer&gt; defaultEnabledWeeks = new HashSet&lt;&gt;();</span>
<span class="nc" id="L85">					defaultEnabledWeeks.add(0);</span>
<span class="nc" id="L86">					wrcwr.setWeeksEnabled(defaultEnabledWeeks);</span>
<span class="nc" id="L87">					response.append(pc_assignmentRule.getRowHtml(wrcwr));</span>
<span class="nc" id="L88">				}</span>
			}
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">			if (ROTATION_RULE_TYPE.equals(type)) {</span>
<span class="nc" id="L91">				Collection&lt;WorkResourceRotation&gt; emptyCol = Collections.emptySet();</span>
<span class="nc" id="L92">				Collection&lt;Rotation&gt; rotations =</span>
<span class="nc" id="L93">						WorkRulesModelHandler.getRotationsByIDs(context, StringUtil.parseIDStringToCollection(ids));</span>
<span class="nc" id="L94">				HashSet&lt;ID&gt; orgIDs = new HashSet&lt;&gt;();</span>
<span class="nc" id="L95">				HashMap&lt;ID, Organization&gt; orgMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">				for (Rotation rotation : rotations) {</span>
<span class="nc" id="L97">					orgIDs.add(rotation.getOrganizationID());</span>
<span class="nc" id="L98">				}</span>
<span class="nc" id="L99">				Collection&lt;Organization&gt; orgs =</span>
<span class="nc" id="L100">						OrganizationModelHandler.getOrganizationsByIDs(context, orgIDs);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">				for (Organization org : orgs) {</span>
<span class="nc" id="L102">					orgMap.put(org.getID(), org);</span>
<span class="nc" id="L103">				}</span>
<span class="nc" id="L104">				RotationInlineEditListPC pc_rotation =</span>
<span class="nc" id="L105">						new RotationInlineEditListPC(context, &quot;rotationTable&quot;, emptyCol, getDateFromStringParam(startDateStr),</span>
<span class="nc" id="L106">								getDateFromStringParam(endDateStr), false, false, orgMap, null);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">				for (Rotation rotation : rotations) {</span>
<span class="nc" id="L108">					WorkResourceRotation wrr = new WorkResourceRotation();</span>
<span class="nc" id="L109">					wrr.setRotation(rotation);</span>
<span class="nc" id="L110">					wrr.setNumWeeksInRotation(wrr.getRotation().getNumWeeks());  //number of weeks in rotation = unit count of the rotation's calendar period</span>
<span class="nc" id="L111">					response.append(pc_rotation.getRowHtml(wrr));</span>
<span class="nc" id="L112">				}</span>
			}
<span class="fc bfc" id="L114" title="All 2 branches covered.">			if (WORK_PATTERN_TYPE.equals(type)) {</span>
<span class="fc" id="L115">				Map&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; emptyMap = Collections.emptyMap();</span>
<span class="fc" id="L116">				String viewStartDateStr = context.getParameter(PARAM_VIEW_START_DATE);</span>
<span class="fc" id="L117">				String viewEndDateStr = context.getParameter(PARAM_VIEW_END_DATE);</span>
<span class="fc" id="L118">				String spIDStr = context.getParameter(PARAM_SP_ID);</span>
				ID spID;
<span class="fc" id="L120">				SchedulingPeriod sp = null;</span>
<span class="fc" id="L121">				Campaign campaign = null;</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">				if (!StringUtil.isEmpty(spIDStr)) {</span>
<span class="nc" id="L123">					spID = new ID(spIDStr);</span>
<span class="nc" id="L124">					sp = CampaignModelHandler.getSchedulingPeriodByID(context, spID);</span>
<span class="nc" id="L125">					campaign = CampaignModelHandler.getCampaign(context, sp.getCampaignID());</span>
				}

<span class="fc" id="L128">				Map&lt;ID, Employee&gt; employeeMap = EmployeeModelHandler.getEmployeeMap(context,</span>
<span class="fc" id="L129">						StringUtil.parseIDStringToCollection(context.getParameter(PARAM_EMPLOYEE_IDS)),</span>
<span class="fc" id="L130">						getDateFromStringParam(viewEndDateStr));</span>
<span class="fc" id="L131">				WorkPatternInlineEditListPC pc_workPattern =</span>
						new WorkPatternInlineEditListPC(context, &quot;workPatternTable&quot;, emptyMap,
<span class="fc" id="L133">								getDateFromStringParam(viewStartDateStr), getDateFromStringParam(viewEndDateStr), sp,</span>
								campaign, false, new ArrayList&lt;&gt;(), null, null);
<span class="fc" id="L135">				Collection&lt;ShiftPattern&gt; shiftPatterns =</span>
<span class="fc" id="L136">						WorkRulesModelHandler.getShiftPatterns(context, StringUtil.parseIDStringToCollection(ids));</span>

				//We need to pull the work pattern assignments for the selected employees to see if any of these
				// newly assigned work patterns were previously assigned (either in a past date or for a future date).
				//If so, we need to adjust the start/end dates of this new assignment appropriately.
<span class="fc" id="L141">				HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; previousWorkPatternAssignments =</span>
<span class="fc" id="L142">						WorkRulesModelHandler.getWorkPatternAssignmentsForEmployees(context,</span>
<span class="fc" id="L143">								StringUtil.parseIDStringToCollection(context.getParameter(PARAM_EMPLOYEE_IDS)), null, null);</span>

<span class="fc bfc" id="L145" title="All 2 branches covered.">				for (ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="fc" id="L146">					WorkResourceWorkPattern wrwp = new WorkResourceWorkPattern();</span>
<span class="fc" id="L147">					wrwp.setWorkPattern(shiftPattern);</span>
<span class="fc" id="L148">					wrwp.setWorkPatternID(shiftPattern.getDEID());</span>
<span class="fc" id="L149">					wrwp.setWorkPatternSID(shiftPattern.getID());</span>
<span class="fc" id="L150">					wrwp.setPreference(1);</span>

					//In campaign mode we force the start/end dates to match the sp view period.
					//If the start/end dates for the user fall within the sp view period, then we will
					//adjust the assignment date before saving (done in the setDatesForWorkPatternAssignment method
					//in WorkPatternInlineEditListPC).
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">					if (sp != null) {</span>
<span class="nc" id="L157">						LocalDate localStart = new LocalDate(getDateFromStringParam(viewStartDateStr), TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L158">						LocalDate localEnd = new LocalDate(getDateFromStringParam(viewEndDateStr), TimeZoneUtil.GMT_TIMEZONE);</span>

<span class="nc" id="L160">						wrwp.setStartTime(localStart.getTime(campaign.getTimeZone()));</span>
<span class="nc" id="L161">						wrwp.setLocalStartTime(localStart);</span>
<span class="nc" id="L162">						wrwp.setEndTime(localEnd.getTime(campaign.getTimeZone()));</span>
<span class="nc" id="L163">						wrwp.setLocalEndTime(localEnd);</span>
<span class="nc" id="L164">					} else {</span>
<span class="fc" id="L165">						setDatesForWorkPatternAssignment(wrwp, previousWorkPatternAssignments, employeeMap,</span>
<span class="fc" id="L166">								getDateFromStringParam(viewStartDateStr), getDateFromStringParam(viewEndDateStr));</span>
					}
<span class="fc" id="L168">					wrwp.setMultiEditIDsInString(context.getParameter(PARAM_EMPLOYEE_IDS));</span>
<span class="fc" id="L169">					response.append(pc_workPattern.getRowHtml(wrwp));</span>
<span class="fc" id="L170">				}</span>
			}
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">			if (TIME_BANK_TYPE.equals(type)) {</span>
<span class="nc" id="L173">				Collection&lt;EmpTimeBank&gt; emptyCol = Collections.emptySet();</span>
<span class="nc" id="L174">				Map&lt;ID, TimeBank&gt; emptyMap = Collections.emptyMap();</span>
<span class="nc" id="L175">				TimeBankAssignmentListPC pc_timeBank =</span>
						new TimeBankAssignmentListPC(context, &quot;timeBankTable&quot;, emptyCol, emptyMap,
<span class="nc" id="L177">								getDateFromStringParam(startDateStr), getDateFromStringParam(endDateStr), false, null);</span>
<span class="nc" id="L178">				Collection&lt;TimeBank&gt; timeBanks =</span>
<span class="nc" id="L179">						WorkRulesModelHandler.getTimeBanksByIDs(context, StringUtil.parseIDStringToCollection(ids));</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">				for (TimeBank tb : timeBanks) {</span>
<span class="nc" id="L181">					EmpTimeBank etb = new EmpTimeBank();</span>
<span class="nc" id="L182">					etb.setStartTime(tb.getStartDate());</span>
<span class="nc" id="L183">					etb.setEndTime(tb.getEndDate());</span>
<span class="nc" id="L184">					etb.setTimeBankID(tb.getID());</span>
<span class="nc" id="L185">					response.append(pc_timeBank.getRowHtml(etb, tb));</span>
<span class="nc" id="L186">				}</span>
			}
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">			if (TIME_BANK_ASSIGNMENT_CHECK_TYPE.equals(type)) {</span>
<span class="nc" id="L189">				HashMap&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; timeBankAssignments =</span>
<span class="nc" id="L190">						WorkRulesModelHandler.getTimeBankAssignments(context, StringUtil.parseIDStringToCollection(ids),</span>
<span class="nc" id="L191">								getDateFromStringParam(startDateStr), getDateFromStringParam(endDateStr));</span>
<span class="nc" id="L192">				boolean hasTimeBankAssignments = false;</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">				for (Collection&lt;EmpTimeBank&gt; etbs : timeBankAssignments.values()) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">					if (etbs.isEmpty() == false) {</span>
<span class="nc" id="L195">						hasTimeBankAssignments = true;</span>
<span class="nc" id="L196">						break;</span>
					}
<span class="nc" id="L198">				}</span>
<span class="nc" id="L199">				response.append(hasTimeBankAssignments);</span>
			}
<span class="fc bfc" id="L201" title="All 2 branches covered.">			if (SKILL_TYPE.equals(type)) {</span>
<span class="fc" id="L202">				Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; emptyMap = Collections.emptyMap();</span>
<span class="fc" id="L203">				boolean chatSkillAdded = false;</span>
<span class="fc" id="L204">				String viewStartDateStr = context.getParameter(PARAM_VIEW_START_DATE);</span>
<span class="fc" id="L205">				String viewEndDateStr = context.getParameter(PARAM_VIEW_END_DATE);</span>
<span class="fc" id="L206">				String spIDStr = context.getParameter(PARAM_SP_ID);</span>
				ID spID;
<span class="fc" id="L208">				SchedulingPeriod sp = null;</span>
<span class="fc" id="L209">				Campaign campaign = null;</span>
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">				if (!StringUtil.isEmpty(spIDStr)) {</span>
<span class="nc" id="L211">					spID = new ID(spIDStr);</span>
<span class="nc" id="L212">					sp = CampaignModelHandler.getSchedulingPeriodByID(context, spID);</span>
<span class="nc" id="L213">					campaign = CampaignModelHandler.getCampaign(context, sp.getCampaignID());</span>
				}

<span class="fc" id="L216">				Collection&lt;ID&gt; employeeIDs = StringUtil.parseIDStringToCollection(context.getParameter(PARAM_EMPLOYEE_IDS));</span>
<span class="fc" id="L217">				Map&lt;ID, Employee&gt; employeeMap = EmployeeModelHandler.getEmployeeMap(context,</span>
<span class="fc" id="L218">						employeeIDs, getDateFromStringParam(viewEndDateStr));</span>

<span class="fc" id="L220">				SkillsInlineEditListPC pc_skills =</span>
						new SkillsInlineEditListPC(context, &quot;skillTable&quot;, emptyMap,
<span class="fc" id="L222">								getDateFromStringParam(viewStartDateStr), getDateFromStringParam(viewEndDateStr),</span>
								sp, campaign, false, new ArrayList&lt;&gt;(), null, null,
<span class="fc" id="L224">								SecureFieldUtil.isFieldEditable(context, employeeMap, SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY),</span>
<span class="fc" id="L225">								SecureFieldUtil.isFieldViewable(context, employeeMap, SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>
				@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L227">				Collection&lt;Skill&gt; skills =</span>
<span class="fc" id="L228">						SkillModelHandler.getSkillsByIDs(StringUtil.parseIDStringToCollection(ids));</span>

				//We need to pull the skill assignments for the selected employees to see if any of these
				// newly assigned skills were previously assigned (either in a past date or for a future date).
				//If so, we need to adjust the start/end dates of this new assignment appropriately.
<span class="fc" id="L233">				HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; previousSkillAssignments =</span>
<span class="fc" id="L234">						SkillsAssignmentMH.getSkillAssignmentsForEmployees(context,</span>
<span class="fc" id="L235">								StringUtil.parseIDStringToCollection(context.getParameter(PARAM_EMPLOYEE_IDS)), null, null);</span>

<span class="fc bfc" id="L237" title="All 2 branches covered.">				for (Skill skill : skills) {</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">					if (Media.MEDIA_ID_CHAT.equals(skill.getMediaID())) {</span>
<span class="nc" id="L239">						chatSkillAdded = true;</span>
					}
<span class="fc" id="L241">					SkillAssignment assignment = new SkillAssignment();</span>
<span class="fc" id="L242">					assignment.setSkill(skill);</span>
<span class="fc" id="L243">					assignment.setSkillID(skill.getID());</span>
<span class="fc" id="L244">					assignment.setProficiency(1.0);</span>
<span class="fc" id="L245">					assignment.setPriority(1);</span>
<span class="fc" id="L246">					assignment.setClassification(0);</span>

					//In campaign mode we force the start/end dates to match the sp view period.
					//If the start/end dates for the user fall within the sp view period, then we will
					//adjust the assignment date before saving (done in the setDatesForSkillAssignment method
					//in SkillInlineEditListPC).
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">					if (sp != null) {</span>
<span class="nc" id="L253">						LocalDate localStart = new LocalDate(getDateFromStringParam(viewStartDateStr), TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L254">						LocalDate localEnd = new LocalDate(getDateFromStringParam(viewEndDateStr), TimeZoneUtil.GMT_TIMEZONE);</span>

<span class="nc" id="L256">						assignment.setStartTime(localStart.getTime(campaign.getTimeZone()));</span>
<span class="nc" id="L257">						assignment.setLocalStartTime(localStart);</span>
<span class="nc" id="L258">						assignment.setEndTime(localEnd.getTime(campaign.getTimeZone()));</span>
<span class="nc" id="L259">						assignment.setLocalEndTime(localEnd);</span>
<span class="nc" id="L260">					} else {</span>
<span class="fc" id="L261">						setDatesForSkillAssignment(assignment, previousSkillAssignments, employeeMap,</span>
<span class="fc" id="L262">								getDateFromStringParam(viewStartDateStr), getDateFromStringParam(viewEndDateStr));</span>
					}

<span class="fc" id="L265">					assignment.setMultiEditIDsInString(context.getParameter(PARAM_EMPLOYEE_IDS));</span>

<span class="fc" id="L267">					response.append(pc_skills.getRowHtml(assignment));</span>
<span class="fc" id="L268">				}</span>

				//We need to enable the Chat Sessions field on the page via javascript if any of the skills we are
				//adding are chat skills.
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">				if (chatSkillAdded) {</span>
<span class="nc" id="L273">					Map&lt;ID, Integer&gt; chatMap = SkillsAssignmentMH.getNumberOfChatSessionsForEmployees(context, employeeIDs, true);</span>
<span class="nc" id="L274">					response.append(HtmlUtil.jsTag(SkillsEmployeeAssignmentPM.getOnChatSkillAddedJS(</span>
<span class="nc" id="L275">							SkillsEmployeeAssignmentPM.getNumberOfChatSessionsForEmployees(chatMap, employeeMap,</span>
<span class="nc" id="L276">									context.getLocalizer())), false));</span>
				}
			}
<span class="nc" id="L279">		} catch (Exception ex) {</span>
<span class="nc" id="L280">			m_log.error(context.getLocalizer().i18n(FsWebLogBundleKey.BUNDLE_NAME, FsWebLogBundleKey.MSG_COULD_NOT_ADD_ROW_TO_TABLE), ex);</span>
<span class="nc" id="L281">			context.getResponse().setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L282">			context.getResponse().getWriter().write(context.getLocalizer().i18n(FsWebLogBundleKey.BUNDLE_NAME, FsWebLogBundleKey.MSG_COULD_NOT_ADD_ROW_TO_TABLE));</span>
		} finally {
<span class="pc" id="L284">			context.getResponse().setContentType(RequestContext.DEFAULT_RESPONSE_CONTENT_TYPE);</span>
<span class="pc" id="L285">			PrintWriter responseWriter = context.getResponse().getWriter();</span>
<span class="pc" id="L286">			responseWriter.write(response.toString());</span>
<span class="pc" id="L287">			responseWriter.close();</span>
<span class="pc" id="L288">		}</span>
<span class="fc" id="L289">	}</span>

	/**
	 * Extracts a date object from the given string-based long value.  Returns null if the string is not a long value.
	 */
	private Date getDateFromStringParam(String dateStr) {
		try {
<span class="fc" id="L296">			return new Date(Long.parseLong(dateStr));</span>
<span class="nc" id="L297">		} catch (NumberFormatException ex) {</span>
<span class="nc" id="L298">			return null;</span>
		}
	}

	/**
	 * This method looks at the past assignments of the work patterns and then sets the appropriate date of the
	 * newly assigned pattern based on this information.
	 */
	private void setDatesForWorkPatternAssignment(WorkResourceWorkPattern newAssignment,
			HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; previousAssignments, Map&lt;ID, Employee&gt; employeeMap,
			Date viewStartDate, Date viewEndDate) {

		//key = employeeID
<span class="fc" id="L311">		HashMap&lt;ID, Date&gt; startDateMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L312">		HashMap&lt;ID, Date&gt; endDateMap = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L314" title="All 2 branches covered.">		for (Employee employee : employeeMap.values()) {</span>
<span class="fc" id="L315">			startDateMap.put(employee.getID(), employee.getStartTime());</span>
<span class="fc" id="L316">			endDateMap.put(employee.getID(), null);</span>
<span class="fc" id="L317">		}</span>

<span class="pc bpc" id="L319" title="1 of 2 branches missed.">		for (Collection&lt;WorkResourceWorkPattern&gt; wrwpAssignments : previousAssignments.values()) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">			for (WorkResourceWorkPattern pastAssignment : wrwpAssignments) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">				if (pastAssignment.getWorkPatternSID().equals(newAssignment.getWorkPattern().getID())) {</span>
<span class="nc" id="L322">					Date prevStartDate = startDateMap.get(pastAssignment.getWorkResourceID());</span>
<span class="nc" id="L323">					Date prevEndDate = endDateMap.get(pastAssignment.getWorkResourceID());</span>
<span class="nc" id="L324">					TimeZone empTimeZone = employeeMap.get(pastAssignment.getWorkResourceID()).getTimeZone(viewStartDate);</span>
<span class="nc" id="L325">					LocalDate viewStartDateLocal = new LocalDate(viewStartDate, TimeZoneUtil.GMT_TIMEZONE);</span>

					//If the previous assignment ended before the view start date, then we set the start date of the new
					//assignment to the end date of the previous assignment.
<span class="nc bnc" id="L329" title="All 2 branches missed.">					if (pastAssignment.getEndTime() != null &amp;&amp;</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">							(pastAssignment.getEndTime().before(viewStartDateLocal.getTime(empTimeZone)) ||</span>
<span class="nc bnc" id="L331" title="All 4 branches missed.">									pastAssignment.getEndTime().equals(viewStartDateLocal.getTime(empTimeZone))) &amp;&amp;</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">							(prevStartDate == null || pastAssignment.getEndTime().after(prevStartDate))) {</span>

<span class="nc" id="L334">						startDateMap.put(pastAssignment.getWorkResourceID(), pastAssignment.getEndTime());</span>
					}

					//If the previous assignment started after the current view period, then the assignment that we are adding
					//will start at the current view period and end at the beginning of the start of the previous assignment.
					//We also need to check that the previous assignment has a start time that does not match with the employee's
					//start time.  The reason we do this is because if they match, then that means that this assignment is being
					//added after just being removed (but not yet saved), and in this case we want to treat the assignment as
					//being removed.
<span class="nc bnc" id="L343" title="All 2 branches missed.">					if (pastAssignment.getStartTime() != null &amp;&amp;</span>
<span class="nc bnc" id="L344" title="All 4 branches missed.">							pastAssignment.getStartTime().after(viewStartDateLocal.getTime(empTimeZone)) &amp;&amp;</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">							(prevEndDate == null || pastAssignment.getStartTime().before(prevEndDate)) &amp;&amp;</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">							pastAssignment.getStartTime().after(</span>
<span class="nc" id="L347">									employeeMap.get(pastAssignment.getWorkResourceID()).getStartTime())) {</span>

<span class="nc" id="L349">						endDateMap.put(pastAssignment.getWorkResourceID(), pastAssignment.getStartTime());</span>
					}
				}
<span class="nc" id="L352">			}</span>
<span class="nc" id="L353">		}</span>

		//Determine if we need to set the multi-edit flag on the start or end dates based on what
		//  the displayed start/end dates should be for each selected employee
<span class="fc" id="L357">		boolean isMultiEditStartDate = false;</span>
<span class="fc" id="L358">		boolean isMultiEditEndDate = false;</span>

<span class="fc" id="L360">		Date newAssignmentStartDate = null;</span>
<span class="fc" id="L361">		ID newAssignmentStartEmpID = null;</span>
<span class="fc bfc" id="L362" title="All 2 branches covered.">		for (ID empID : startDateMap.keySet()) {</span>
<span class="fc" id="L363">			Date date = startDateMap.get(empID);</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">			if (date != null) {</span>
<span class="fc" id="L365">				newAssignmentStartDate = date;</span>
<span class="fc" id="L366">				newAssignmentStartEmpID = empID;</span>
			}
<span class="fc" id="L368">		}</span>
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">		if (newAssignmentStartDate != null) {</span>
<span class="fc bfc" id="L370" title="All 2 branches covered.">			for (Date date : startDateMap.values()) {</span>
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">				if (!newAssignmentStartDate.equals(date)) {</span>
<span class="nc" id="L372">					isMultiEditStartDate = true;</span>
<span class="nc" id="L373">					break;</span>
				}
<span class="fc" id="L375">			}</span>
		}

<span class="fc" id="L378">		Date newAssignmentEndDate = null;</span>
<span class="fc" id="L379">		ID newAssignmentEndEmpID = null;</span>
<span class="fc bfc" id="L380" title="All 2 branches covered.">		for (ID empID : endDateMap.keySet()) {</span>
<span class="fc" id="L381">			Date date = endDateMap.get(empID);</span>
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">			if (date != null) {</span>
<span class="nc" id="L383">				newAssignmentEndDate = date;</span>
<span class="nc" id="L384">				newAssignmentEndEmpID = empID;</span>
			}
<span class="fc" id="L386">		}</span>
<span class="pc bpc" id="L387" title="1 of 2 branches missed.">		if (newAssignmentEndDate != null) {</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">			for (Date date : endDateMap.values()) {</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">				if (!newAssignmentEndDate.equals(date)) {</span>
<span class="nc" id="L390">					isMultiEditEndDate = true;</span>
<span class="nc" id="L391">					break;</span>
				}
<span class="nc" id="L393">			}</span>
		}

<span class="pc bpc" id="L396" title="1 of 2 branches missed.">		if (isMultiEditStartDate) {</span>
<span class="nc" id="L397">			newAssignment.setFieldMultiValue(WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_STARTTIME);</span>
<span class="pc bpc" id="L398" title="1 of 2 branches missed.">		} else if (newAssignmentStartDate != null) {</span>
<span class="fc" id="L399">			newAssignment.setStartTime(newAssignmentStartDate);</span>
<span class="fc" id="L400">			newAssignment.setLocalStartTime(new LocalDate(newAssignmentStartDate,</span>
<span class="fc" id="L401">					employeeMap.get(newAssignmentStartEmpID).getTimeZone(newAssignmentStartDate)));</span>
		}

<span class="pc bpc" id="L404" title="1 of 2 branches missed.">		if (isMultiEditEndDate) {</span>
<span class="nc" id="L405">			newAssignment.setFieldMultiValue(WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_ENDTIME);</span>
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">		} else if (newAssignmentEndDate != null) {</span>
<span class="nc" id="L407">			newAssignment.setEndTime(newAssignmentEndDate);</span>
<span class="nc" id="L408">			newAssignment.setLocalEndTime(new LocalDate(newAssignmentEndDate,</span>
<span class="nc" id="L409">					employeeMap.get(newAssignmentEndEmpID).getTimeZone(newAssignmentEndDate)));</span>
		}
<span class="fc" id="L411">	}</span>

	/**
	 * This method is virtually a copy of the setDatesForWorkPatternAssignment method (unfortunately), but
	 * for skills assignment instead.
	 * TODO: It would be nice to have one method for both but there wasn't enough time for a proper refactoring.
	 */
	private void setDatesForSkillAssignment(SkillAssignment newAssignment,
			HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; previousAssignmentMap, Map&lt;ID, Employee&gt; employeeMap,
			Date viewStartDate, Date viewEndDate) {

		//key = employeeID
<span class="fc" id="L423">		HashMap&lt;ID, Date&gt; startDateMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L424">		HashMap&lt;ID, Date&gt; endDateMap = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L426" title="All 2 branches covered.">		for (Employee employee : employeeMap.values()) {</span>
<span class="fc" id="L427">			startDateMap.put(employee.getID(), employee.getStartTime());</span>
<span class="fc" id="L428">			endDateMap.put(employee.getID(), null);</span>
<span class="fc" id="L429">		}</span>

<span class="pc bpc" id="L431" title="1 of 2 branches missed.">		for (Collection&lt;SkillAssignment&gt; previousAssignments : previousAssignmentMap.values()) {</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">			for (SkillAssignment previousAssignment : previousAssignments) {</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">				if (previousAssignment.getSkillID().equals(newAssignment.getSkillID())) {</span>
<span class="nc" id="L434">					Date prevStartDate = startDateMap.get(previousAssignment.getWorkResourceID());</span>
<span class="nc" id="L435">					Date prevEndDate = endDateMap.get(previousAssignment.getWorkResourceID());</span>
<span class="nc" id="L436">					TimeZone empTimeZone = employeeMap.get(previousAssignment.getWorkResourceID()).getTimeZone(viewStartDate);</span>
<span class="nc" id="L437">					LocalDate viewStartDateLocal = new LocalDate(viewStartDate, TimeZoneUtil.GMT_TIMEZONE);</span>

					//If the previous assignment ended before the view start date, then we set the start date of the new
					//assignment to the end date of the previous assignment.
<span class="nc bnc" id="L441" title="All 2 branches missed.">					if (previousAssignment.getEndTime() != null &amp;&amp;</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">							(previousAssignment.getEndTime().before(viewStartDateLocal.getTime(empTimeZone)) ||</span>
<span class="nc bnc" id="L443" title="All 4 branches missed.">									previousAssignment.getEndTime().equals(viewStartDateLocal.getTime(empTimeZone))) &amp;&amp;</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">							(prevStartDate == null || previousAssignment.getEndTime().after(prevStartDate))) {</span>

<span class="nc" id="L446">						startDateMap.put(previousAssignment.getWorkResourceID(), previousAssignment.getEndTime());</span>
					}

					//If the previous assignment started after the current view period, then the assignment that we are adding
					//will start at the current view period and end at the beginning of the start of the previous assignment.
					//We also need to check that the previous assignment has a start time that does not match with the employee's
					//start time.  The reason we do this is because if they match, then that means that this assignment is being
					//added after just being removed (but not yet saved), and in this case we want to treat the assignment as
					//being removed.
<span class="nc bnc" id="L455" title="All 2 branches missed.">					if (previousAssignment.getStartTime() != null &amp;&amp;</span>
<span class="nc bnc" id="L456" title="All 4 branches missed.">							previousAssignment.getStartTime().after(viewStartDateLocal.getTime(empTimeZone)) &amp;&amp;</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">							(prevEndDate == null || previousAssignment.getStartTime().before(prevEndDate)) &amp;&amp;</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">							previousAssignment.getStartTime().after(</span>
<span class="nc" id="L459">									employeeMap.get(previousAssignment.getWorkResourceID()).getStartTime())) {</span>

<span class="nc" id="L461">						endDateMap.put(previousAssignment.getWorkResourceID(), previousAssignment.getStartTime());</span>
					}
				}
<span class="nc" id="L464">			}</span>
<span class="nc" id="L465">		}</span>

		//Determine if we need to set the multi-edit flag on the start or end dates based on what
		//  the displayed start/end dates should be for each selected employee
<span class="fc" id="L469">		boolean isMultiEditStartDate = false;</span>
<span class="fc" id="L470">		boolean isMultiEditEndDate = false;</span>

<span class="fc" id="L472">		Date newAssignmentStartDate = null;</span>
<span class="fc" id="L473">		ID newAssignmentStartEmpID = null;</span>
<span class="fc bfc" id="L474" title="All 2 branches covered.">		for (ID empID : startDateMap.keySet()) {</span>
<span class="fc" id="L475">			Date date = startDateMap.get(empID);</span>
<span class="pc bpc" id="L476" title="1 of 2 branches missed.">			if (date != null) {</span>
<span class="fc" id="L477">				newAssignmentStartDate = date;</span>
<span class="fc" id="L478">				newAssignmentStartEmpID = empID;</span>
			}
<span class="fc" id="L480">		}</span>
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">		if (newAssignmentStartDate != null) {</span>
<span class="fc bfc" id="L482" title="All 2 branches covered.">			for (Date date : startDateMap.values()) {</span>
<span class="pc bpc" id="L483" title="1 of 2 branches missed.">				if (!newAssignmentStartDate.equals(date)) {</span>
<span class="nc" id="L484">					isMultiEditStartDate = true;</span>
<span class="nc" id="L485">					break;</span>
				}
<span class="fc" id="L487">			}</span>
		}

<span class="fc" id="L490">		Date newAssignmentEndDate = null;</span>
<span class="fc" id="L491">		ID newAssignmentEndEmpID = null;</span>
<span class="fc bfc" id="L492" title="All 2 branches covered.">		for (ID empID : endDateMap.keySet()) {</span>
<span class="fc" id="L493">			Date date = endDateMap.get(empID);</span>
<span class="pc bpc" id="L494" title="1 of 2 branches missed.">			if (date != null) {</span>
<span class="nc" id="L495">				newAssignmentEndDate = date;</span>
<span class="nc" id="L496">				newAssignmentEndEmpID = empID;</span>
			}
<span class="fc" id="L498">		}</span>
<span class="pc bpc" id="L499" title="1 of 2 branches missed.">		if (newAssignmentEndDate != null) {</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">			for (Date date : endDateMap.values()) {</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">				if (!newAssignmentEndDate.equals(date)) {</span>
<span class="nc" id="L502">					isMultiEditEndDate = true;</span>
<span class="nc" id="L503">					break;</span>
				}
<span class="nc" id="L505">			}</span>
		}

<span class="pc bpc" id="L508" title="1 of 2 branches missed.">		if (isMultiEditStartDate) {</span>
<span class="nc" id="L509">			newAssignment.setFieldMultiValue(SkillAssignmentFieldInfo.SKILLASSIGNMENT_STARTTIME);</span>
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">		} else if (newAssignmentStartDate != null) {</span>
<span class="fc" id="L511">			newAssignment.setStartTime(newAssignmentStartDate);</span>
<span class="fc" id="L512">			newAssignment.setLocalStartTime(new LocalDate(newAssignmentStartDate,</span>
<span class="fc" id="L513">					employeeMap.get(newAssignmentStartEmpID).getTimeZone(newAssignmentStartDate)));</span>
		}

<span class="pc bpc" id="L516" title="1 of 2 branches missed.">		if (isMultiEditEndDate) {</span>
<span class="nc" id="L517">			newAssignment.setFieldMultiValue(SkillAssignmentFieldInfo.SKILLASSIGNMENT_ENDTIME);</span>
<span class="pc bpc" id="L518" title="1 of 2 branches missed.">		} else if (newAssignmentEndDate != null) {</span>
<span class="nc" id="L519">			newAssignment.setEndTime(newAssignmentEndDate);</span>
<span class="nc" id="L520">			newAssignment.setLocalEndTime(new LocalDate(newAssignmentEndDate,</span>
<span class="nc" id="L521">					employeeMap.get(newAssignmentEndEmpID).getTimeZone(newAssignmentEndDate)));</span>
		}
<span class="fc" id="L523">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>