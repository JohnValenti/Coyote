<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EmployeeAssignmentInlineEditComponentRH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">EmployeeAssignmentInlineEditComponentRH.java</span></div><h1>EmployeeAssignmentInlineEditComponentRH.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import java.io.PrintWriter;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.TimeZone;

import javax.servlet.http.HttpServletResponse;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpTimeBank;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRule;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceRotation;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceWorkPattern;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceWorkPatternFieldInfo;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignmentFieldInfo;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.Rotation;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.ejb.bbm.workrules.model.TimeBank;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.skill.SkillModelHandler;
import com.bluepumpkin.web.fs.l10n.FsWebLogBundleKey;
import com.verint.web.fs.skills.SkillsAssignmentMH;
import com.verint.web.fs.skills.SkillsEmployeeAssignmentPM;
import com.verint.web.fs.skills.SkillsInlineEditListPC;
import com.verint.web.fs.util.SecureFieldUtil;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.witness.web.uif.base.RequestHandler;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;

<span class="fc" id="L51">public class EmployeeAssignmentInlineEditComponentRH extends RequestHandler {</span>
<span class="fc" id="L52">	public static String URL = &quot;employee_assignment_inline_edit_component&quot;;</span>
<span class="fc" id="L53">	public static String PARAM_TYPE = &quot;type&quot;;</span>
<span class="fc" id="L54">	public static String PARAM_IDS = &quot;ids&quot;;</span>
<span class="fc" id="L55">	public static String PARAM_START_DATE = &quot;startDate&quot;;</span>
<span class="fc" id="L56">	public static String PARAM_END_DATE = &quot;endDate&quot;;</span>
<span class="fc" id="L57">	public static String PARAM_VIEW_START_DATE = &quot;viewStartDate&quot;;</span>
<span class="fc" id="L58">	public static String PARAM_VIEW_END_DATE = &quot;viewEndDate&quot;;</span>
<span class="fc" id="L59">	public static String ASSIGNMENT_RULE_TYPE = &quot;assignmentRule&quot;;</span>
<span class="fc" id="L60">	public static String ROTATION_RULE_TYPE = &quot;rotation&quot;;</span>
<span class="fc" id="L61">	public static String WORK_PATTERN_TYPE = &quot;workPattern&quot;;</span>
<span class="fc" id="L62">	public static String TIME_BANK_TYPE = &quot;timeBank&quot;;</span>
<span class="fc" id="L63">	public static String TIME_BANK_ASSIGNMENT_CHECK_TYPE = &quot;timeBankAssignmentCheck&quot;;</span>
<span class="fc" id="L64">	public static String SKILL_TYPE = &quot;skill&quot;;</span>
<span class="fc" id="L65">	public static String PARAM_EMPLOYEE_IDS = &quot;employeeIDs&quot;;</span>
<span class="fc" id="L66">	public static String PARAM_SP_ID = &quot;spID&quot;;</span>
	
	@Override
	public void processRequest(RequestContext context) throws Exception {	
<span class="fc" id="L70">		StringBuffer response = new StringBuffer();</span>
		try {
<span class="fc" id="L72">			String ids = context.getParameter(PARAM_IDS);</span>
<span class="fc" id="L73">			String type = context.getParameter(PARAM_TYPE);</span>
<span class="fc" id="L74">			String startDateStr = context.getParameter(PARAM_START_DATE);</span>
<span class="fc" id="L75">			String endDateStr = context.getParameter(PARAM_END_DATE);</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">			if (ASSIGNMENT_RULE_TYPE.equals(type)) {</span>
<span class="nc" id="L77">				Collection&lt;ComplexWorkRule&gt; assignmentRules = </span>
<span class="nc" id="L78">					WorkRulesModelHandler.getComplexWorkRulesByIDs(context, StringUtil.parseIDStringToCollection(ids));</span>
<span class="nc" id="L79">				HashSet&lt;ID&gt; orgIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L80">				HashMap&lt;ID, Organization&gt; orgMap = new HashMap&lt;ID, Organization&gt;();</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">				for (ComplexWorkRule assignmentRule : assignmentRules) {</span>
<span class="nc" id="L82">					orgIDs.add(assignmentRule.getOrganizationID());</span>
<span class="nc" id="L83">				}	</span>
<span class="nc" id="L84">				Collection&lt;Organization&gt; orgs = </span>
<span class="nc" id="L85">					OrganizationModelHandler.getOrganizationsByIDs(context, orgIDs);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">				for (Organization org : orgs) {</span>
<span class="nc" id="L87">					orgMap.put(org.getID(), org);</span>
<span class="nc" id="L88">				}</span>
<span class="nc" id="L89">				AssignmentRuleInlineEditListPC pc_assignmentRule =</span>
					new AssignmentRuleInlineEditListPC(context, &quot;assignmentRuleTable&quot;, null,
<span class="nc" id="L91">							getDateFromStringParam(startDateStr), getDateFromStringParam(endDateStr), orgMap);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">				for (ComplexWorkRule cwr : assignmentRules) {</span>
<span class="nc" id="L93">					WorkResourceComplexWorkRule wrcwr = new WorkResourceComplexWorkRule();</span>
<span class="nc" id="L94">					wrcwr.setComplexWorkRule(cwr);</span>
<span class="nc" id="L95">					wrcwr.setNumWeeksInRotation(1);</span>
<span class="nc" id="L96">					HashSet&lt;Integer&gt; defaultEnabledWeeks = new HashSet&lt;Integer&gt;();</span>
<span class="nc" id="L97">					defaultEnabledWeeks.add(0);</span>
<span class="nc" id="L98">					wrcwr.setWeeksEnabled(defaultEnabledWeeks);</span>
<span class="nc" id="L99">					response.append(pc_assignmentRule.getRowHtml(wrcwr));</span>
<span class="nc" id="L100">				}</span>
			}
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">			if (ROTATION_RULE_TYPE.equals(type)) {</span>
<span class="nc" id="L103">				Collection&lt;WorkResourceRotation&gt; emptyCol = Collections.emptySet();</span>
<span class="nc" id="L104">				Collection&lt;Rotation&gt; rotations = </span>
<span class="nc" id="L105">					WorkRulesModelHandler.getRotationsByIDs(context, StringUtil.parseIDStringToCollection(ids));</span>
<span class="nc" id="L106">				HashSet&lt;ID&gt; orgIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L107">				HashMap&lt;ID, Organization&gt; orgMap = new HashMap&lt;ID, Organization&gt;();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">				for (Rotation rotation : rotations) {</span>
<span class="nc" id="L109">					orgIDs.add(rotation.getOrganizationID());</span>
<span class="nc" id="L110">				}	</span>
<span class="nc" id="L111">				Collection&lt;Organization&gt; orgs = </span>
<span class="nc" id="L112">					OrganizationModelHandler.getOrganizationsByIDs(context, orgIDs);</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">				for (Organization org : orgs) {</span>
<span class="nc" id="L114">					orgMap.put(org.getID(), org);</span>
<span class="nc" id="L115">				}</span>
<span class="nc" id="L116">				RotationInlineEditListPC pc_rotation =</span>
<span class="nc" id="L117">					new RotationInlineEditListPC(context, &quot;rotationTable&quot;, emptyCol, getDateFromStringParam(startDateStr),</span>
<span class="nc" id="L118">							getDateFromStringParam(endDateStr), false, false, orgMap, null);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">				for (Rotation rotation : rotations) {</span>
<span class="nc" id="L120">					WorkResourceRotation wrr = new WorkResourceRotation();</span>
<span class="nc" id="L121">					wrr.setRotation(rotation);</span>
<span class="nc" id="L122">					wrr.setNumWeeksInRotation(wrr.getRotation().getNumWeeks());	//number of weeks in rotation = unit count of the rotation's calendar period</span>
<span class="nc" id="L123">					response.append(pc_rotation.getRowHtml(wrr));</span>
<span class="nc" id="L124">				}</span>
			}
<span class="fc bfc" id="L126" title="All 2 branches covered.">			if (WORK_PATTERN_TYPE.equals(type)) {</span>
<span class="fc" id="L127">				Map&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; emptyMap = Collections.emptyMap();</span>
<span class="fc" id="L128">				String viewStartDateStr = context.getParameter(PARAM_VIEW_START_DATE);</span>
<span class="fc" id="L129">				String viewEndDateStr = context.getParameter(PARAM_VIEW_END_DATE);</span>
<span class="fc" id="L130">				String spIDStr = context.getParameter(PARAM_SP_ID);</span>
<span class="fc" id="L131">				ID spID = null;</span>
<span class="fc" id="L132">				SchedulingPeriod sp = null;</span>
<span class="fc" id="L133">				Campaign campaign = null;</span>
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">				if (!StringUtil.isEmpty(spIDStr)) {</span>
<span class="nc" id="L135">					spID = new ID(spIDStr);</span>
<span class="nc" id="L136">					sp = CampaignModelHandler.getSchedulingPeriodByID(context, spID);</span>
<span class="nc" id="L137">					campaign = CampaignModelHandler.getCampaign(context, sp.getCampaignID());</span>
				}
				
<span class="fc" id="L140">				Map&lt;ID, Employee&gt; employeeMap = EmployeeModelHandler.getEmployeeMap(context,</span>
<span class="fc" id="L141">						StringUtil.parseIDStringToCollection(context.getParameter(PARAM_EMPLOYEE_IDS)),</span>
<span class="fc" id="L142">						getDateFromStringParam(viewEndDateStr));</span>
<span class="fc" id="L143">				WorkPatternInlineEditListPC pc_workPattern =</span>
					new WorkPatternInlineEditListPC(context, &quot;workPatternTable&quot;, emptyMap, 
<span class="fc" id="L145">							getDateFromStringParam(viewStartDateStr), getDateFromStringParam(viewEndDateStr), sp,</span>
							campaign, false, new ArrayList&lt;ID&gt;(), null, null);
<span class="fc" id="L147">				Collection&lt;ShiftPattern&gt; shiftPatterns = </span>
<span class="fc" id="L148">					WorkRulesModelHandler.getShiftPatterns(context, StringUtil.parseIDStringToCollection(ids));</span>
				
				//We need to pull the work pattern assignments for the selected employees to see if any of these
				// newly assigned work patterns were previously assigned (either in a past date or for a future date).
				//If so, we need to adjust the start/end dates of this new assignment appropriately.
<span class="fc" id="L153">				HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; previousWorkPatternAssignments = </span>
<span class="fc" id="L154">					WorkRulesModelHandler.getWorkPatternAssignmentsForEmployees(context,</span>
<span class="fc" id="L155">						StringUtil.parseIDStringToCollection(context.getParameter(PARAM_EMPLOYEE_IDS)), null, null);</span>
				
<span class="fc bfc" id="L157" title="All 2 branches covered.">				for (ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="fc" id="L158">					WorkResourceWorkPattern wrwp = new WorkResourceWorkPattern();</span>
<span class="fc" id="L159">					wrwp.setWorkPattern(shiftPattern);</span>
<span class="fc" id="L160">					wrwp.setWorkPatternID(shiftPattern.getDEID());</span>
<span class="fc" id="L161">					wrwp.setWorkPatternSID(shiftPattern.getID());</span>
<span class="fc" id="L162">					wrwp.setPreference(1);</span>

					//In campaign mode we force the start/end dates to match the sp view period.
					//If the start/end dates for the user fall within the sp view period, then we will
					//adjust the assignment date before saving (done in the setDatesForWorkPatternAssignment method
					//in WorkPatternInlineEditListPC).
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">					if (sp!= null) {</span>
<span class="nc" id="L169">						LocalDate localStart = new LocalDate(getDateFromStringParam(viewStartDateStr), TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L170">						LocalDate localEnd = new LocalDate(getDateFromStringParam(viewEndDateStr), TimeZoneUtil.GMT_TIMEZONE);</span>
						
<span class="nc" id="L172">						wrwp.setStartTime(localStart.getTime(campaign.getTimeZone()));</span>
<span class="nc" id="L173">						wrwp.setLocalStartTime(localStart);</span>
<span class="nc" id="L174">						wrwp.setEndTime(localEnd.getTime(campaign.getTimeZone()));</span>
<span class="nc" id="L175">						wrwp.setLocalEndTime(localEnd);</span>
<span class="nc" id="L176">					} else {				</span>
<span class="fc" id="L177">						setDatesForWorkPatternAssignment(wrwp, previousWorkPatternAssignments, employeeMap,</span>
<span class="fc" id="L178">								getDateFromStringParam(viewStartDateStr), getDateFromStringParam(viewEndDateStr));</span>
					}
<span class="fc" id="L180">					wrwp.setMultiEditIDsInString(context.getParameter(PARAM_EMPLOYEE_IDS));</span>
<span class="fc" id="L181">					response.append(pc_workPattern.getRowHtml(wrwp));</span>
<span class="fc" id="L182">				}				</span>
			}
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">			if (TIME_BANK_TYPE.equals(type)) {</span>
<span class="nc" id="L185">				Collection&lt;EmpTimeBank&gt; emptyCol = Collections.emptySet();</span>
<span class="nc" id="L186">				Map&lt;ID, TimeBank&gt; emptyMap = Collections.emptyMap();</span>
<span class="nc" id="L187">				TimeBankAssignmentListPC pc_timeBank =</span>
					new TimeBankAssignmentListPC(context, &quot;timeBankTable&quot;, emptyCol, emptyMap,
<span class="nc" id="L189">							getDateFromStringParam(startDateStr), getDateFromStringParam(endDateStr), false, null);</span>
<span class="nc" id="L190">				Collection&lt;TimeBank&gt; timeBanks = </span>
<span class="nc" id="L191">					WorkRulesModelHandler.getTimeBanksByIDs(context, StringUtil.parseIDStringToCollection(ids));</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">				for (TimeBank tb : timeBanks) {</span>
<span class="nc" id="L193">					EmpTimeBank etb = new EmpTimeBank();</span>
<span class="nc" id="L194">					etb.setStartTime(tb.getStartDate());</span>
<span class="nc" id="L195">					etb.setEndTime(tb.getEndDate());</span>
<span class="nc" id="L196">					etb.setTimeBankID(tb.getID());</span>
<span class="nc" id="L197">					response.append(pc_timeBank.getRowHtml(etb, tb));</span>
<span class="nc" id="L198">				}				</span>
			}
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">			if (TIME_BANK_ASSIGNMENT_CHECK_TYPE.equals(type)) {</span>
<span class="nc" id="L201">				HashMap&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; timeBankAssignments = </span>
<span class="nc" id="L202">					WorkRulesModelHandler.getTimeBankAssignments(context, StringUtil.parseIDStringToCollection(ids),</span>
<span class="nc" id="L203">							getDateFromStringParam(startDateStr), getDateFromStringParam(endDateStr));</span>
<span class="nc" id="L204">				boolean hasTimeBankAssignments = false;</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">				for (Collection&lt;EmpTimeBank&gt; etbs : timeBankAssignments.values()) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">					if (etbs.isEmpty() == false) {</span>
<span class="nc" id="L207">						hasTimeBankAssignments = true;</span>
<span class="nc" id="L208">						break;</span>
					}
<span class="nc" id="L210">				}</span>
<span class="nc" id="L211">				response.append(hasTimeBankAssignments);			</span>
			}
<span class="fc bfc" id="L213" title="All 2 branches covered.">			if (SKILL_TYPE.equals(type)) {</span>
<span class="fc" id="L214">				Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; emptyMap = Collections.emptyMap();</span>
<span class="fc" id="L215">				boolean chatSkillAdded = false;</span>
<span class="fc" id="L216">				String viewStartDateStr = context.getParameter(PARAM_VIEW_START_DATE);</span>
<span class="fc" id="L217">				String viewEndDateStr = context.getParameter(PARAM_VIEW_END_DATE);</span>
<span class="fc" id="L218">				String spIDStr = context.getParameter(PARAM_SP_ID);</span>
<span class="fc" id="L219">				ID spID = null;</span>
<span class="fc" id="L220">				SchedulingPeriod sp = null;</span>
<span class="fc" id="L221">				Campaign campaign = null;</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">				if (!StringUtil.isEmpty(spIDStr)) {</span>
<span class="nc" id="L223">					spID = new ID(spIDStr);</span>
<span class="nc" id="L224">					sp = CampaignModelHandler.getSchedulingPeriodByID(context, spID);</span>
<span class="nc" id="L225">					campaign = CampaignModelHandler.getCampaign(context, sp.getCampaignID());</span>
				}
				
<span class="fc" id="L228">				Collection&lt;ID&gt; employeeIDs = StringUtil.parseIDStringToCollection(context.getParameter(PARAM_EMPLOYEE_IDS));</span>
<span class="fc" id="L229">				Map&lt;ID, Employee&gt; employeeMap = EmployeeModelHandler.getEmployeeMap(context,</span>
<span class="fc" id="L230">						employeeIDs, getDateFromStringParam(viewEndDateStr));</span>
				
<span class="fc" id="L232">				SkillsInlineEditListPC pc_skills =</span>
					new SkillsInlineEditListPC(context, &quot;skillTable&quot;, emptyMap, 
<span class="fc" id="L234">							getDateFromStringParam(viewStartDateStr), getDateFromStringParam(viewEndDateStr),</span>
							sp, campaign, false, new ArrayList&lt;ID&gt;(), null, null, 
<span class="fc" id="L236">							SecureFieldUtil.isFieldEditable(context, employeeMap, SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY), </span>
<span class="fc" id="L237">							SecureFieldUtil.isFieldViewable(context, employeeMap, SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>
				@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L239">				Collection&lt;Skill&gt; skills = </span>
<span class="fc" id="L240">					SkillModelHandler.getSkillsByIDs(StringUtil.parseIDStringToCollection(ids));</span>
				
				//We need to pull the skill assignments for the selected employees to see if any of these
				// newly assigned skills were previously assigned (either in a past date or for a future date).
				//If so, we need to adjust the start/end dates of this new assignment appropriately.
<span class="fc" id="L245">				HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; previousSkillAssignments = </span>
<span class="fc" id="L246">					SkillsAssignmentMH.getSkillAssignmentsForEmployees(context,</span>
<span class="fc" id="L247">						StringUtil.parseIDStringToCollection(context.getParameter(PARAM_EMPLOYEE_IDS)), null, null);</span>
				
<span class="fc bfc" id="L249" title="All 2 branches covered.">				for (Skill skill : skills) {</span>
<span class="fc bfc" id="L250" title="All 2 branches covered.">					if (Media.MEDIA_ID_CHAT.equals(skill.getMediaID())) chatSkillAdded = true;</span>
<span class="fc" id="L251">					SkillAssignment assignment = new SkillAssignment();</span>
<span class="fc" id="L252">					assignment.setSkill(skill);</span>
<span class="fc" id="L253">					assignment.setSkillID(skill.getID());</span>
<span class="fc" id="L254">					assignment.setProficiency(1.0);</span>
<span class="fc" id="L255">					assignment.setPriority(1);</span>
<span class="fc" id="L256">					assignment.setClassification(0);</span>

					//In campaign mode we force the start/end dates to match the sp view period.
					//If the start/end dates for the user fall within the sp view period, then we will
					//adjust the assignment date before saving (done in the setDatesForSkillAssignment method
					//in SkillInlineEditListPC).
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">					if (sp!= null) {</span>
<span class="nc" id="L263">						LocalDate localStart = new LocalDate(getDateFromStringParam(viewStartDateStr), TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L264">						LocalDate localEnd = new LocalDate(getDateFromStringParam(viewEndDateStr), TimeZoneUtil.GMT_TIMEZONE);</span>
						
<span class="nc" id="L266">						assignment.setStartTime(localStart.getTime(campaign.getTimeZone()));</span>
<span class="nc" id="L267">						assignment.setLocalStartTime(localStart);</span>
<span class="nc" id="L268">						assignment.setEndTime(localEnd.getTime(campaign.getTimeZone()));</span>
<span class="nc" id="L269">						assignment.setLocalEndTime(localEnd);</span>
<span class="nc" id="L270">					} else {</span>
<span class="fc" id="L271">						setDatesForSkillAssignment(assignment, previousSkillAssignments, employeeMap,</span>
<span class="fc" id="L272">							getDateFromStringParam(viewStartDateStr), getDateFromStringParam(viewEndDateStr));</span>
					}

<span class="fc" id="L275">					assignment.setMultiEditIDsInString(context.getParameter(PARAM_EMPLOYEE_IDS));</span>
					
<span class="fc" id="L277">					response.append(pc_skills.getRowHtml(assignment));</span>
<span class="fc" id="L278">				}</span>
				
				//We need to enable the Chat Sessions field on the page via javascript if any of the skills we are
				//adding are chat skills.
<span class="fc bfc" id="L282" title="All 2 branches covered.">				if (chatSkillAdded) {</span>
<span class="fc" id="L283">					Map&lt;ID, Integer&gt; chatMap = SkillsAssignmentMH.getNumberOfChatSessionsForEmployees(context, employeeIDs, true);</span>
<span class="fc" id="L284">					response.append(HtmlUtil.jsTag(SkillsEmployeeAssignmentPM.getOnChatSkillAddedJS(</span>
<span class="fc" id="L285">							SkillsEmployeeAssignmentPM.getNumberOfChatSessionsForEmployees(chatMap, employeeMap,</span>
<span class="fc" id="L286">									context.getLocalizer())), false));</span>
				}
			}
<span class="nc" id="L289">		} catch (Exception ex) {</span>
<span class="nc" id="L290">			m_log.error(context.getLocalizer().i18n(FsWebLogBundleKey.BUNDLE_NAME, FsWebLogBundleKey.MSG_COULD_NOT_ADD_ROW_TO_TABLE), ex);</span>
<span class="nc" id="L291">			context.getResponse().setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L292">			context.getResponse().getWriter().write(context.getLocalizer().i18n(FsWebLogBundleKey.BUNDLE_NAME, FsWebLogBundleKey.MSG_COULD_NOT_ADD_ROW_TO_TABLE));</span>
		} finally {
<span class="pc" id="L294">			context.getResponse().setContentType(RequestContext.DEFAULT_RESPONSE_CONTENT_TYPE);</span>
<span class="pc" id="L295">			PrintWriter responseWriter = context.getResponse().getWriter();</span>
<span class="pc" id="L296">			responseWriter.write(response.toString());</span>
<span class="pc" id="L297">			responseWriter.close();</span>
<span class="pc" id="L298">		}</span>
<span class="fc" id="L299">	}</span>
	
	/**
	 * Extracts a date object from the given string-based long value.  Returns null if the string is not a long value.
	 */
	private Date getDateFromStringParam(String dateStr) {
		try {
<span class="fc" id="L306">			return new Date(Long.parseLong(dateStr));</span>
<span class="nc" id="L307">		} catch (NumberFormatException ex) {</span>
<span class="nc" id="L308">			return null;</span>
		}
	}
	
	/**
	 * This method looks at the past assignments of the work patterns and then sets the appropriate date of the
	 * newly assigned pattern based on this information.
	 */
	private void setDatesForWorkPatternAssignment(WorkResourceWorkPattern newAssignment,
			HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; previousAssignments, Map&lt;ID, Employee&gt; employeeMap,
			Date viewStartDate, Date viewEndDate) {
		
		//key = employeeID
<span class="fc" id="L321">		HashMap&lt;ID, Date&gt; startDateMap = new HashMap&lt;ID, Date&gt;();</span>
<span class="fc" id="L322">		HashMap&lt;ID, Date&gt; endDateMap = new HashMap&lt;ID, Date&gt;();</span>
		
<span class="fc bfc" id="L324" title="All 2 branches covered.">		for (Employee employee : employeeMap.values()) {</span>
<span class="fc" id="L325">			startDateMap.put(employee.getID(), employee.getStartTime());</span>
<span class="fc" id="L326">			endDateMap.put(employee.getID(), null);</span>
<span class="fc" id="L327">		}</span>
		
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">		for (Collection&lt;WorkResourceWorkPattern&gt; wrwpAssignments : previousAssignments.values()) {</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">			for (WorkResourceWorkPattern pastAssignment : wrwpAssignments) {</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">				if (pastAssignment.getWorkPatternSID().equals(newAssignment.getWorkPattern().getID())) {</span>
<span class="nc" id="L332">					Date prevStartDate = startDateMap.get(pastAssignment.getWorkResourceID());</span>
<span class="nc" id="L333">					Date prevEndDate = endDateMap.get(pastAssignment.getWorkResourceID());</span>
<span class="nc" id="L334">					TimeZone empTimeZone = employeeMap.get(pastAssignment.getWorkResourceID()).getTimeZone(viewStartDate);</span>
<span class="nc" id="L335">					LocalDate viewStartDateLocal = new LocalDate(viewStartDate, TimeZoneUtil.GMT_TIMEZONE);</span>
					
					//If the previous assignment ended before the view start date, then we set the start date of the new
					//assignment to the end date of the previous assignment.
<span class="nc bnc" id="L339" title="All 2 branches missed.">					if (pastAssignment.getEndTime() != null &amp;&amp;</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">						(pastAssignment.getEndTime().before(viewStartDateLocal.getTime(empTimeZone)) ||</span>
<span class="nc bnc" id="L341" title="All 4 branches missed.">								pastAssignment.getEndTime().equals(viewStartDateLocal.getTime(empTimeZone))) &amp;&amp; </span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">						(prevStartDate == null || pastAssignment.getEndTime().after(prevStartDate))) {</span>

<span class="nc" id="L344">						startDateMap.put(pastAssignment.getWorkResourceID(), pastAssignment.getEndTime());</span>
					}
					
					//If the previous assignment started after the current view period, then the assignment that we are adding
					//will start at the current view period and end at the beginning of the start of the previous assignment.
					//We also need to check that the previous assignment has a start time that does not match with the employee's
					//start time.  The reason we do this is because if they match, then that means that this assignment is being
					//added after just being removed (but not yet saved), and in this case we want to treat the assignment as
					//being removed.
<span class="nc bnc" id="L353" title="All 2 branches missed.">					if (pastAssignment.getStartTime() != null &amp;&amp;</span>
<span class="nc bnc" id="L354" title="All 4 branches missed.">						pastAssignment.getStartTime().after(viewStartDateLocal.getTime(empTimeZone)) &amp;&amp; </span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">						(prevEndDate == null || pastAssignment.getStartTime().before(prevEndDate)) &amp;&amp;</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">						pastAssignment.getStartTime().after(</span>
<span class="nc" id="L357">								employeeMap.get(pastAssignment.getWorkResourceID()).getStartTime())) {</span>
						
<span class="nc" id="L359">						endDateMap.put(pastAssignment.getWorkResourceID(), pastAssignment.getStartTime());</span>
					}
				}
<span class="nc" id="L362">			}</span>
<span class="nc" id="L363">		}</span>
		
		//Determine if we need to set the multi-edit flag on the start or end dates based on what
		//  the displayed start/end dates should be for each selected employee
<span class="fc" id="L367">		boolean isMultiEditStartDate = false;</span>
<span class="fc" id="L368">		boolean isMultiEditEndDate = false;	</span>
		
<span class="fc" id="L370">		Date newAssignmentStartDate = null;</span>
<span class="fc" id="L371">		ID newAssignmentStartEmpID = null;</span>
<span class="fc bfc" id="L372" title="All 2 branches covered.">		for (ID empID : startDateMap.keySet()) {</span>
<span class="fc" id="L373">			Date date = startDateMap.get(empID);</span>
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">			if (date != null) {</span>
<span class="fc" id="L375">				newAssignmentStartDate = date;</span>
<span class="fc" id="L376">				newAssignmentStartEmpID = empID;</span>
			}
<span class="fc" id="L378">		}</span>
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">		if (newAssignmentStartDate != null) {</span>
<span class="fc bfc" id="L380" title="All 2 branches covered.">			for (Date date : startDateMap.values()) {</span>
<span class="fc bfc" id="L381" title="All 2 branches covered.">				if (!newAssignmentStartDate.equals(date)) {</span>
<span class="fc" id="L382">					isMultiEditStartDate = true;</span>
<span class="fc" id="L383">					break;</span>
				}
<span class="fc" id="L385">			}</span>
		}
		
<span class="fc" id="L388">		Date newAssignmentEndDate = null;</span>
<span class="fc" id="L389">		ID newAssignmentEndEmpID = null;</span>
<span class="fc bfc" id="L390" title="All 2 branches covered.">		for (ID empID : endDateMap.keySet()) {</span>
<span class="fc" id="L391">			Date date = endDateMap.get(empID);</span>
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">			if (date != null) {</span>
<span class="nc" id="L393">				newAssignmentEndDate = date;</span>
<span class="nc" id="L394">				newAssignmentEndEmpID = empID;</span>
			}
<span class="fc" id="L396">		}</span>
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">		if (newAssignmentEndDate != null) {</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">			for (Date date : endDateMap.values()) {</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">				if (!newAssignmentEndDate.equals(date)) {</span>
<span class="nc" id="L400">					isMultiEditEndDate = true;</span>
<span class="nc" id="L401">					break;</span>
				}
<span class="nc" id="L403">			}</span>
		}
		
<span class="fc bfc" id="L406" title="All 2 branches covered.">		if (isMultiEditStartDate) newAssignment.setFieldMultiValue(WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_STARTTIME);</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">		else if (newAssignmentStartDate != null) {</span>
<span class="fc" id="L408">			newAssignment.setStartTime(newAssignmentStartDate);</span>
<span class="fc" id="L409">			newAssignment.setLocalStartTime(new LocalDate(newAssignmentStartDate,</span>
<span class="fc" id="L410">					employeeMap.get(newAssignmentStartEmpID).getTimeZone(newAssignmentStartDate)));</span>
		}

<span class="pc bpc" id="L413" title="1 of 2 branches missed.">		if (isMultiEditEndDate) newAssignment.setFieldMultiValue(WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_ENDTIME);</span>
<span class="pc bpc" id="L414" title="1 of 2 branches missed.">		else if (newAssignmentEndDate != null) {</span>
<span class="nc" id="L415">			newAssignment.setEndTime(newAssignmentEndDate);</span>
<span class="nc" id="L416">			newAssignment.setLocalEndTime(new LocalDate(newAssignmentEndDate,</span>
<span class="nc" id="L417">					employeeMap.get(newAssignmentEndEmpID).getTimeZone(newAssignmentEndDate)));</span>
		}
<span class="fc" id="L419">	}</span>
	
	/**
	 * This method is virtually a copy of the setDatesForWorkPatternAssignment method (unfortunately), but 
	 * for skills assignment instead.  
	 * TODO: It would be nice to have one method for both but there wasn't enough time for a proper refactoring.
	 */
	private void setDatesForSkillAssignment(SkillAssignment newAssignment,
			HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; previousAssignmentMap, Map&lt;ID, Employee&gt; employeeMap,
			Date viewStartDate, Date viewEndDate) {
		
		//key = employeeID
<span class="fc" id="L431">		HashMap&lt;ID, Date&gt; startDateMap = new HashMap&lt;ID, Date&gt;();</span>
<span class="fc" id="L432">		HashMap&lt;ID, Date&gt; endDateMap = new HashMap&lt;ID, Date&gt;();</span>
		
<span class="fc bfc" id="L434" title="All 2 branches covered.">		for (Employee employee : employeeMap.values()) {</span>
<span class="fc" id="L435">			startDateMap.put(employee.getID(), employee.getStartTime());</span>
<span class="fc" id="L436">			endDateMap.put(employee.getID(), null);</span>
<span class="fc" id="L437">		}</span>
		
<span class="fc bfc" id="L439" title="All 2 branches covered.">		for (Collection&lt;SkillAssignment&gt; previousAssignments : previousAssignmentMap.values()) {</span>
<span class="fc bfc" id="L440" title="All 2 branches covered.">			for (SkillAssignment previousAssignment : previousAssignments) {</span>
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">				if (previousAssignment.getSkillID().equals(newAssignment.getSkillID())) {</span>
<span class="nc" id="L442">					Date prevStartDate = startDateMap.get(previousAssignment.getWorkResourceID());</span>
<span class="nc" id="L443">					Date prevEndDate = endDateMap.get(previousAssignment.getWorkResourceID());</span>
<span class="nc" id="L444">					TimeZone empTimeZone = employeeMap.get(previousAssignment.getWorkResourceID()).getTimeZone(viewStartDate);</span>
<span class="nc" id="L445">					LocalDate viewStartDateLocal = new LocalDate(viewStartDate, TimeZoneUtil.GMT_TIMEZONE);</span>
					
					//If the previous assignment ended before the view start date, then we set the start date of the new
					//assignment to the end date of the previous assignment.
<span class="nc bnc" id="L449" title="All 2 branches missed.">					if (previousAssignment.getEndTime() != null &amp;&amp;</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">						(previousAssignment.getEndTime().before(viewStartDateLocal.getTime(empTimeZone)) ||</span>
<span class="nc bnc" id="L451" title="All 4 branches missed.">								previousAssignment.getEndTime().equals(viewStartDateLocal.getTime(empTimeZone))) &amp;&amp; </span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">						(prevStartDate == null || previousAssignment.getEndTime().after(prevStartDate))) {</span>

<span class="nc" id="L454">						startDateMap.put(previousAssignment.getWorkResourceID(), previousAssignment.getEndTime());</span>
					}
					
					//If the previous assignment started after the current view period, then the assignment that we are adding
					//will start at the current view period and end at the beginning of the start of the previous assignment.
					//We also need to check that the previous assignment has a start time that does not match with the employee's
					//start time.  The reason we do this is because if they match, then that means that this assignment is being
					//added after just being removed (but not yet saved), and in this case we want to treat the assignment as
					//being removed.
<span class="nc bnc" id="L463" title="All 2 branches missed.">					if (previousAssignment.getStartTime() != null &amp;&amp;</span>
<span class="nc bnc" id="L464" title="All 4 branches missed.">						previousAssignment.getStartTime().after(viewStartDateLocal.getTime(empTimeZone)) &amp;&amp; </span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">						(prevEndDate == null || previousAssignment.getStartTime().before(prevEndDate)) &amp;&amp;</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">						previousAssignment.getStartTime().after(</span>
<span class="nc" id="L467">								employeeMap.get(previousAssignment.getWorkResourceID()).getStartTime())) {</span>
						
<span class="nc" id="L469">						endDateMap.put(previousAssignment.getWorkResourceID(), previousAssignment.getStartTime());</span>
					}
				}
<span class="fc" id="L472">			}</span>
<span class="fc" id="L473">		}</span>
		
		//Determine if we need to set the multi-edit flag on the start or end dates based on what
		//  the displayed start/end dates should be for each selected employee
<span class="fc" id="L477">		boolean isMultiEditStartDate = false;</span>
<span class="fc" id="L478">		boolean isMultiEditEndDate = false;	</span>

<span class="fc" id="L480">		Date newAssignmentStartDate = null;</span>
<span class="fc" id="L481">		ID newAssignmentStartEmpID = null;</span>
<span class="fc bfc" id="L482" title="All 2 branches covered.">		for (ID empID : startDateMap.keySet()) {</span>
<span class="fc" id="L483">			Date date = startDateMap.get(empID);</span>
<span class="pc bpc" id="L484" title="1 of 2 branches missed.">			if (date != null) {</span>
<span class="fc" id="L485">				newAssignmentStartDate = date;</span>
<span class="fc" id="L486">				newAssignmentStartEmpID = empID;</span>
			}
<span class="fc" id="L488">		}</span>
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">		if (newAssignmentStartDate != null) {</span>
<span class="fc bfc" id="L490" title="All 2 branches covered.">			for (Date date : startDateMap.values()) {</span>
<span class="pc bpc" id="L491" title="1 of 2 branches missed.">				if (!newAssignmentStartDate.equals(date)) {</span>
<span class="nc" id="L492">					isMultiEditStartDate = true;</span>
<span class="nc" id="L493">					break;</span>
				}
<span class="fc" id="L495">			}</span>
		}
		
<span class="fc" id="L498">		Date newAssignmentEndDate = null;</span>
<span class="fc" id="L499">		ID newAssignmentEndEmpID = null;</span>
<span class="fc bfc" id="L500" title="All 2 branches covered.">		for (ID empID : endDateMap.keySet()) {</span>
<span class="fc" id="L501">			Date date = endDateMap.get(empID);</span>
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">			if (date != null) {</span>
<span class="nc" id="L503">				newAssignmentEndDate = date;</span>
<span class="nc" id="L504">				newAssignmentEndEmpID = empID;</span>
			}
<span class="fc" id="L506">		}</span>
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">		if (newAssignmentEndDate != null) {</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">			for (Date date : endDateMap.values()) {</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">				if (!newAssignmentEndDate.equals(date)) {</span>
<span class="nc" id="L510">					isMultiEditEndDate = true;</span>
<span class="nc" id="L511">					break;</span>
				}
<span class="nc" id="L513">			}</span>
		}
		
<span class="pc bpc" id="L516" title="1 of 2 branches missed.">		if (isMultiEditStartDate) newAssignment.setFieldMultiValue(SkillAssignmentFieldInfo.SKILLASSIGNMENT_STARTTIME);</span>
<span class="pc bpc" id="L517" title="1 of 2 branches missed.">		else if (newAssignmentStartDate != null) {</span>
<span class="fc" id="L518">			newAssignment.setStartTime(newAssignmentStartDate);</span>
<span class="fc" id="L519">			newAssignment.setLocalStartTime(new LocalDate(newAssignmentStartDate,</span>
<span class="fc" id="L520">					employeeMap.get(newAssignmentStartEmpID).getTimeZone(newAssignmentStartDate)));</span>
		}

<span class="pc bpc" id="L523" title="1 of 2 branches missed.">		if (isMultiEditEndDate) newAssignment.setFieldMultiValue(SkillAssignmentFieldInfo.SKILLASSIGNMENT_ENDTIME);</span>
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">		else if (newAssignmentEndDate != null) {</span>
<span class="nc" id="L525">			newAssignment.setEndTime(newAssignmentEndDate);</span>
<span class="nc" id="L526">			newAssignment.setLocalEndTime(new LocalDate(newAssignmentEndDate,</span>
<span class="nc" id="L527">					employeeMap.get(newAssignmentEndEmpID).getTimeZone(newAssignmentEndDate)));</span>
		}
<span class="fc" id="L529">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>