<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RotationListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">RotationListPC.java</span></div><h1>RotationListPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Comparator;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.Rotation;
import com.bluepumpkin.ejb.bbm.workrules.model.RotationSortField;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.InsertableMultiColListPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.system.RequestContext;

public class RotationListPC extends InsertableMultiColListPC {
	private static final long serialVersionUID = 2L;
	public static final String ROTATION_LIST_SORTCOLUMN = &quot;ROTATION_LIST_SORTCOLUMN&quot;;
	public static final String ROTATION_LIST_SORTORDER = &quot;ROTATION_LIST_SORTORDER&quot;;
	public static final String ROTATION_POPUPLIST_SORTCOLUMN = &quot;ROTATION_POPUPLIST_SORTCOLUMN&quot;;
	public static final String ROTATION_POPUPLIST_SORTORDER = &quot;ROTATION_POPUPLIST_SORTORDER&quot;;
<span class="fc" id="L33">	private boolean m_isUsedInPopup =false;</span>
	private Collection&lt;Rotation&gt; rotations;

<span class="fc" id="L36">	Map&lt;ID, Organization&gt; orgMap = null;</span>
	private TimeZone viewTimeZone;
	
	public TimeZone getViewTimeZone() {
<span class="nc" id="L40">		return viewTimeZone;</span>
	}

	public void setViewTimeZone(TimeZone viewTimeZone) {
<span class="fc" id="L44">		this.viewTimeZone = viewTimeZone;</span>
<span class="fc" id="L45">	}</span>

	public Collection&lt;Rotation&gt; getRotations() {
<span class="nc" id="L48">		return rotations;</span>
	}
	
	public void setRotations(Collection&lt;Rotation&gt; rotations) {
<span class="fc" id="L52">		this.rotations = rotations;</span>
<span class="fc" id="L53">	}</span>
	
	public Map&lt;ID, Organization&gt; getOrgMap() {
<span class="nc" id="L56">		return orgMap;</span>
	}

	public void setOrgMap(Map&lt;ID, Organization&gt; orgMap) {
<span class="fc" id="L60">		this.orgMap = orgMap;</span>
<span class="fc" id="L61">	}</span>

	public RotationListPC(RequestContext context, Collection&lt;Rotation&gt; rotations,
			Map&lt;ID, Organization&gt; orgMap) {
<span class="fc" id="L65">		this(context, rotations,orgMap, false);</span>
<span class="fc" id="L66">	}</span>
	public RotationListPC(RequestContext context, Collection&lt;Rotation&gt; rotations,
			Map&lt;ID, Organization&gt; orgMap, boolean isUsedInPopup) {
<span class="fc" id="L69">		super(context);</span>

<span class="fc" id="L71">		this.rotations = rotations;</span>
<span class="fc" id="L72">		this.orgMap = orgMap;</span>
<span class="fc" id="L73">		this.viewTimeZone = m_context.getViewingTimeZone();</span>
<span class="fc" id="L74">		m_isUsedInPopup = isUsedInPopup; ///Must be assign before initHeader</span>
<span class="fc" id="L75">		initHeader();</span>
<span class="fc" id="L76">	}</span>
	@Override
	public String getHtmlDisplay() {
<span class="fc" id="L79">		initRows();</span>
<span class="fc" id="L80">		return super.getHtmlDisplay();</span>
	}

	private void initHeader() {
<span class="fc" id="L84">		TableHeaderPC header = getHeader();</span>
<span class="fc" id="L85">		Localizer localizer = m_context.getLocalizer();</span>
<span class="fc" id="L86">		header.setPartialSortable(true);</span>
<span class="fc" id="L87">		header.addColumnHeaderData(FsWebBundleKey.FS_NAME,</span>
<span class="fc" id="L88">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_NAME), true);</span>
<span class="fc" id="L89">		header.addColumnHeaderData(FsWebBundleKey.FS_ORGANIZATION,</span>
<span class="fc" id="L90">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ORGANIZATION), true);</span>
<span class="fc" id="L91">		header.addColumnHeaderData(FsWebBundleKey.FS_START_DATE, </span>
<span class="fc" id="L92">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ALIGNMENT_DATE), true);</span>
<span class="fc" id="L93">		header.addColumnHeaderData(FsWebBundleKey.FS_WEEKS_UNIT,</span>
<span class="fc" id="L94">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_WEEKS_UNIT), true);</span>
<span class="fc" id="L95">		header.addColumnHeaderData(FsWebBundleKey.WORK_PATTERNS,</span>
<span class="fc" id="L96">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.WORK_PATTERNS), false);</span>
<span class="fc" id="L97">		setPersitedSortHeader(m_isUsedInPopup, header);</span>
<span class="fc" id="L98">	}</span>
	
	
	private void initRows() {
<span class="fc" id="L102">		Collection&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>
		
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">		if (rotations != null) {</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">			for (Rotation rotation : rotations) {</span>
<span class="fc" id="L106">				DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(</span>
<span class="fc" id="L107">						rotation.getID());</span>
				
				//Name
<span class="fc" id="L110">				nodeData.add(rotation.getName());</span>
				
				//Organization
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">				if (rotation.getOrganizationID() != null) {</span>
<span class="fc" id="L114">					Organization o = orgMap.get(rotation.getOrganizationID());</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">					if (o != null) {</span>
<span class="fc" id="L116">						nodeData.add(o.getName());	</span>
					} else {
<span class="nc" id="L118">						nodeData.add(&quot;&quot;);</span>
					}
<span class="fc" id="L120">				} else {</span>
<span class="nc" id="L121">					nodeData.add(&quot;&quot;);			</span>
				}
				
<span class="fc" id="L124">				LocalDate alignmentDate = rotation.getAlignmentDate();</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">				nodeData.add(alignmentDate == null ? &quot;&quot; : m_localizer.formatDate(alignmentDate, RegionalFormatBundleKey.DATE_FORMAT));</span>
<span class="fc" id="L126">				nodeData.add(rotation.getNumWeeks());</span>
				
				
				//Description
<span class="fc" id="L130">				nodeData.add(getTextRepresentation(rotation));</span>
				
<span class="fc" id="L132">				setRowAttributes(nodeData, rotation);</span>
				
<span class="fc" id="L134">				rows.add(nodeData);</span>
<span class="fc" id="L135">			}</span>
		}
<span class="fc" id="L137">	}</span>
	
<span class="fc" id="L139">	protected void setRowAttributes(DefaultMultiColumnNodeData rowData, Rotation rotation) {}</span>
	
	public LinkedHashMap&lt;RotationSortField, Comparator&gt; getSortFields() {
<span class="fc" id="L142">		LinkedHashMap&lt;RotationSortField, Comparator&gt; comparators =</span>
			new LinkedHashMap&lt;RotationSortField, Comparator&gt;();
<span class="fc bfc" id="L144" title="All 2 branches covered.">		for (RotationSortField sortField : getDBSortFieldIndices()) {</span>
<span class="pc bpc" id="L145" title="5 of 6 branches missed.">			switch (sortField) {</span>
				case ID:
<span class="fc" id="L147">					comparators.put(RotationSortField.ID, null);</span>
<span class="fc" id="L148">					break;</span>
				case Name:
<span class="nc" id="L150">					comparators.put(RotationSortField.Name, null);</span>
<span class="nc" id="L151">					break;</span>
				case Organization:
<span class="nc" id="L153">					comparators.put(RotationSortField.Organization, null);</span>
<span class="nc" id="L154">					break;</span>
				case AlignmentDate:
<span class="nc" id="L156">					comparators.put(RotationSortField.AlignmentDate, null);</span>
<span class="nc" id="L157">					break;</span>
				case Weeks:
<span class="nc" id="L159">					comparators.put(RotationSortField.Weeks, null);</span>
<span class="nc" id="L160">					break;</span>
				default: break;
			}
<span class="fc" id="L163">		}</span>
		
<span class="fc" id="L165">		return comparators;</span>
	}
	
	public ArrayList&lt;RotationSortField&gt; getDBSortFieldIndices() {
<span class="fc" id="L169">		ArrayList&lt;RotationSortField&gt; retVal = new ArrayList&lt;RotationSortField&gt;();</span>
<span class="fc" id="L170">		TableHeaderPC header = getHeader();</span>
<span class="fc" id="L171">		setPersitedSortHeader(m_isUsedInPopup, header);</span>
		
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">		if (header.getSortColumnIndexes() == null) {</span>
			//Default sort index is by ID (chronological order in which object was created)
<span class="fc" id="L175">			retVal.add(RotationSortField.ID);</span>
		} else {
<span class="nc bnc" id="L177" title="All 2 branches missed.">			for (int sortField : header.getSortColumnIndexes()) {</span>
<span class="nc bnc" id="L178" title="All 5 branches missed.">				switch (sortField) {</span>
					case 0: 
<span class="nc" id="L180">						retVal.add(RotationSortField.Name);</span>
<span class="nc" id="L181">						break;</span>
					case 1: 
<span class="nc" id="L183">						retVal.add(RotationSortField.Organization);</span>
<span class="nc" id="L184">						break;</span>
					case 2: 
<span class="nc" id="L186">						retVal.add(RotationSortField.AlignmentDate);</span>
<span class="nc" id="L187">						break;</span>
					case 3: 
<span class="nc" id="L189">						retVal.add(RotationSortField.Weeks);</span>
<span class="nc" id="L190">						break;</span>
					default: break;
				}
			}
		}
<span class="fc" id="L195">		return retVal;</span>
	}
	
	private String getTextRepresentation(Rotation r) {
<span class="fc" id="L199">		List&lt;ShiftPattern&gt; shiftPatterns = r.getShiftPatterns();</span>
<span class="fc" id="L200">		StringBuffer sb = new StringBuffer();</span>
<span class="fc" id="L201">		Iterator&lt;ShiftPattern&gt; iter = shiftPatterns.iterator();</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">		while (iter.hasNext()) {</span>
<span class="fc" id="L203">			ShiftPattern sp = iter.next();</span>
			//If the shift pattern has already been deleted, then display WP name + &quot;(Deleted)&quot;
			//Otherwise, display the name of the work pattern
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">			if (sp.getDeletedOnDate() != null ) {		</span>
				//Work pattern was deleted before the view end date or sp end date if in campaign mode
<span class="nc" id="L208">				sb.append(sp.getName()).append(&quot;(&quot; + getLocalizer().i18n(</span>
						FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_TRAINING_STATUS_DELETED) + &quot;)&quot;);
			} else {
<span class="fc" id="L211">				sb.append(sp.getName());</span>
			}
<span class="fc bfc" id="L213" title="All 2 branches covered.">			if (iter.hasNext()) sb.append(&quot;, &quot;);</span>
<span class="fc" id="L214">		}</span>
<span class="fc" id="L215">		return sb.toString();</span>
	}
	private void setPersitedSortHeader(boolean isUsedInPopup,TableHeaderPC header) {
<span class="fc" id="L218">		String sortColumn = null;</span>
<span class="fc" id="L219">		String sortOrder = null;</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">		if(isUsedInPopup) {</span>
<span class="fc" id="L221">			sortColumn = m_context.getUserProperty(ROTATION_POPUPLIST_SORTCOLUMN);</span>
<span class="fc" id="L222">			sortOrder = m_context.getUserProperty(ROTATION_POPUPLIST_SORTORDER);</span>
		}
		else
		{
<span class="fc" id="L226">			sortColumn = m_context.getUserProperty(ROTATION_LIST_SORTCOLUMN);</span>
<span class="fc" id="L227">			sortOrder = m_context.getUserProperty(ROTATION_LIST_SORTORDER);</span>
		}
		
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">		if (sortColumn != null) {</span>
<span class="nc" id="L231">			header.setSortColumn(sortColumn);</span>
		}
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">		if (sortOrder != null) {</span>
<span class="nc" id="L234">			header.setSortOrder(sortOrder);</span>
		}
<span class="fc" id="L236">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>