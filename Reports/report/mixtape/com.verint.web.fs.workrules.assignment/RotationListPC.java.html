<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RotationListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">RotationListPC.java</span></div><h1>RotationListPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.Rotation;
import com.bluepumpkin.ejb.bbm.workrules.model.RotationSortField;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.InsertableMultiColListPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.system.RequestContext;

import java.util.*;

public class RotationListPC extends InsertableMultiColListPC {
	private static final long serialVersionUID = 2L;
	public static final String ROTATION_LIST_SORTCOLUMN = &quot;ROTATION_LIST_SORTCOLUMN&quot;;
	public static final String ROTATION_LIST_SORTORDER = &quot;ROTATION_LIST_SORTORDER&quot;;
	public static final String ROTATION_POPUPLIST_SORTCOLUMN = &quot;ROTATION_POPUPLIST_SORTCOLUMN&quot;;
	public static final String ROTATION_POPUPLIST_SORTORDER = &quot;ROTATION_POPUPLIST_SORTORDER&quot;;
<span class="nc" id="L26">	private boolean m_isUsedInPopup = false;</span>
	private Collection&lt;Rotation&gt; rotations;

<span class="nc" id="L29">	Map&lt;ID, Organization&gt; orgMap = null;</span>
	private TimeZone viewTimeZone;

	public TimeZone getViewTimeZone() {
<span class="nc" id="L33">		return viewTimeZone;</span>
	}

	public void setViewTimeZone(TimeZone viewTimeZone) {
<span class="nc" id="L37">		this.viewTimeZone = viewTimeZone;</span>
<span class="nc" id="L38">	}</span>

	public Collection&lt;Rotation&gt; getRotations() {
<span class="nc" id="L41">		return rotations;</span>
	}

	public void setRotations(Collection&lt;Rotation&gt; rotations) {
<span class="nc" id="L45">		this.rotations = rotations;</span>
<span class="nc" id="L46">	}</span>

	public Map&lt;ID, Organization&gt; getOrgMap() {
<span class="nc" id="L49">		return orgMap;</span>
	}

	public void setOrgMap(Map&lt;ID, Organization&gt; orgMap) {
<span class="nc" id="L53">		this.orgMap = orgMap;</span>
<span class="nc" id="L54">	}</span>

	public RotationListPC(RequestContext context, Collection&lt;Rotation&gt; rotations,
			Map&lt;ID, Organization&gt; orgMap) {
<span class="nc" id="L58">		this(context, rotations, orgMap, false);</span>
<span class="nc" id="L59">	}</span>

	public RotationListPC(RequestContext context, Collection&lt;Rotation&gt; rotations,
			Map&lt;ID, Organization&gt; orgMap, boolean isUsedInPopup) {
<span class="nc" id="L63">		super(context);</span>

<span class="nc" id="L65">		this.rotations = rotations;</span>
<span class="nc" id="L66">		this.orgMap = orgMap;</span>
<span class="nc" id="L67">		this.viewTimeZone = m_context.getViewingTimeZone();</span>
<span class="nc" id="L68">		m_isUsedInPopup = isUsedInPopup; ///Must be assign before initHeader</span>
<span class="nc" id="L69">		initHeader();</span>
<span class="nc" id="L70">	}</span>

	@Override
	public String getHtmlDisplay() {
<span class="nc" id="L74">		initRows();</span>
<span class="nc" id="L75">		return super.getHtmlDisplay();</span>
	}

	private void initHeader() {
<span class="nc" id="L79">		TableHeaderPC header = getHeader();</span>
<span class="nc" id="L80">		Localizer localizer = m_context.getLocalizer();</span>
<span class="nc" id="L81">		header.setPartialSortable(true);</span>
<span class="nc" id="L82">		header.addColumnHeaderData(FsWebBundleKey.FS_NAME,</span>
<span class="nc" id="L83">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_NAME), true);</span>
<span class="nc" id="L84">		header.addColumnHeaderData(FsWebBundleKey.FS_ORGANIZATION,</span>
<span class="nc" id="L85">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ORGANIZATION), true);</span>
<span class="nc" id="L86">		header.addColumnHeaderData(FsWebBundleKey.FS_START_DATE,</span>
<span class="nc" id="L87">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ALIGNMENT_DATE), true);</span>
<span class="nc" id="L88">		header.addColumnHeaderData(FsWebBundleKey.FS_WEEKS_UNIT,</span>
<span class="nc" id="L89">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_WEEKS_UNIT), true);</span>
<span class="nc" id="L90">		header.addColumnHeaderData(FsWebBundleKey.WORK_PATTERNS,</span>
<span class="nc" id="L91">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.WORK_PATTERNS), false);</span>
<span class="nc" id="L92">		setPersitedSortHeader(m_isUsedInPopup, header);</span>
<span class="nc" id="L93">	}</span>


	private void initRows() {
<span class="nc" id="L97">		Collection&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">		if (rotations != null) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">			for (Rotation rotation : rotations) {</span>
<span class="nc" id="L101">				DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(</span>
<span class="nc" id="L102">						rotation.getID());</span>

				//Name
<span class="nc" id="L105">				nodeData.add(rotation.getName());</span>

				//Organization
<span class="nc bnc" id="L108" title="All 2 branches missed.">				if (rotation.getOrganizationID() != null) {</span>
<span class="nc" id="L109">					Organization o = orgMap.get(rotation.getOrganizationID());</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">					if (o != null) {</span>
<span class="nc" id="L111">						nodeData.add(o.getName());</span>
					} else {
<span class="nc" id="L113">						nodeData.add(&quot;&quot;);</span>
					}
<span class="nc" id="L115">				} else {</span>
<span class="nc" id="L116">					nodeData.add(&quot;&quot;);</span>
				}

<span class="nc" id="L119">				LocalDate alignmentDate = rotation.getAlignmentDate();</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">				nodeData.add(alignmentDate == null ? &quot;&quot; : m_localizer.formatDate(alignmentDate, RegionalFormatBundleKey.DATE_FORMAT));</span>
<span class="nc" id="L121">				nodeData.add(rotation.getNumWeeks());</span>


				//Description
<span class="nc" id="L125">				nodeData.add(getTextRepresentation(rotation));</span>

<span class="nc" id="L127">				setRowAttributes(nodeData, rotation);</span>

<span class="nc" id="L129">				rows.add(nodeData);</span>
<span class="nc" id="L130">			}</span>
		}
<span class="nc" id="L132">	}</span>

	protected void setRowAttributes(DefaultMultiColumnNodeData rowData, Rotation rotation) {
<span class="nc" id="L135">	}</span>

	public LinkedHashMap&lt;RotationSortField, Comparator&gt; getSortFields() {
<span class="nc" id="L138">		LinkedHashMap&lt;RotationSortField, Comparator&gt; comparators =</span>
				new LinkedHashMap&lt;RotationSortField, Comparator&gt;();
<span class="nc bnc" id="L140" title="All 2 branches missed.">		for (RotationSortField sortField : getDBSortFieldIndices()) {</span>
<span class="nc bnc" id="L141" title="All 6 branches missed.">			switch (sortField) {</span>
				case ID:
<span class="nc" id="L143">					comparators.put(RotationSortField.ID, null);</span>
<span class="nc" id="L144">					break;</span>
				case Name:
<span class="nc" id="L146">					comparators.put(RotationSortField.Name, null);</span>
<span class="nc" id="L147">					break;</span>
				case Organization:
<span class="nc" id="L149">					comparators.put(RotationSortField.Organization, null);</span>
<span class="nc" id="L150">					break;</span>
				case AlignmentDate:
<span class="nc" id="L152">					comparators.put(RotationSortField.AlignmentDate, null);</span>
<span class="nc" id="L153">					break;</span>
				case Weeks:
<span class="nc" id="L155">					comparators.put(RotationSortField.Weeks, null);</span>
<span class="nc" id="L156">					break;</span>
				default:
					break;
			}
<span class="nc" id="L160">		}</span>

<span class="nc" id="L162">		return comparators;</span>
	}

	public ArrayList&lt;RotationSortField&gt; getDBSortFieldIndices() {
<span class="nc" id="L166">		ArrayList&lt;RotationSortField&gt; retVal = new ArrayList&lt;RotationSortField&gt;();</span>
<span class="nc" id="L167">		TableHeaderPC header = getHeader();</span>
<span class="nc" id="L168">		setPersitedSortHeader(m_isUsedInPopup, header);</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">		if (header.getSortColumnIndexes() == null) {</span>
			//Default sort index is by ID (chronological order in which object was created)
<span class="nc" id="L172">			retVal.add(RotationSortField.ID);</span>
		} else {
<span class="nc bnc" id="L174" title="All 2 branches missed.">			for (int sortField : header.getSortColumnIndexes()) {</span>
<span class="nc bnc" id="L175" title="All 5 branches missed.">				switch (sortField) {</span>
					case 0:
<span class="nc" id="L177">						retVal.add(RotationSortField.Name);</span>
<span class="nc" id="L178">						break;</span>
					case 1:
<span class="nc" id="L180">						retVal.add(RotationSortField.Organization);</span>
<span class="nc" id="L181">						break;</span>
					case 2:
<span class="nc" id="L183">						retVal.add(RotationSortField.AlignmentDate);</span>
<span class="nc" id="L184">						break;</span>
					case 3:
<span class="nc" id="L186">						retVal.add(RotationSortField.Weeks);</span>
<span class="nc" id="L187">						break;</span>
					default:
						break;
				}
			}
		}
<span class="nc" id="L193">		return retVal;</span>
	}

	private String getTextRepresentation(Rotation r) {
<span class="nc" id="L197">		List&lt;ShiftPattern&gt; shiftPatterns = r.getShiftPatterns();</span>
<span class="nc" id="L198">		StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L199">		Iterator&lt;ShiftPattern&gt; iter = shiftPatterns.iterator();</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L201">			ShiftPattern sp = iter.next();</span>
			//If the shift pattern has already been deleted, then display WP name + &quot;(Deleted)&quot;
			//Otherwise, display the name of the work pattern
<span class="nc bnc" id="L204" title="All 2 branches missed.">			if (sp.getDeletedOnDate() != null) {</span>
				//Work pattern was deleted before the view end date or sp end date if in campaign mode
<span class="nc" id="L206">				sb.append(sp.getName()).append(&quot;(&quot; + getLocalizer().i18n(</span>
						FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_TRAINING_STATUS_DELETED) + &quot;)&quot;);
			} else {
<span class="nc" id="L209">				sb.append(sp.getName());</span>
			}
<span class="nc bnc" id="L211" title="All 2 branches missed.">			if (iter.hasNext()) {</span>
<span class="nc" id="L212">				sb.append(&quot;, &quot;);</span>
			}
<span class="nc" id="L214">		}</span>
<span class="nc" id="L215">		return sb.toString();</span>
	}

	private void setPersitedSortHeader(boolean isUsedInPopup, TableHeaderPC header) {
<span class="nc" id="L219">		String sortColumn = null;</span>
<span class="nc" id="L220">		String sortOrder = null;</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">		if (isUsedInPopup) {</span>
<span class="nc" id="L222">			sortColumn = m_context.getUserProperty(ROTATION_POPUPLIST_SORTCOLUMN);</span>
<span class="nc" id="L223">			sortOrder = m_context.getUserProperty(ROTATION_POPUPLIST_SORTORDER);</span>
		} else {
<span class="nc" id="L225">			sortColumn = m_context.getUserProperty(ROTATION_LIST_SORTCOLUMN);</span>
<span class="nc" id="L226">			sortOrder = m_context.getUserProperty(ROTATION_LIST_SORTORDER);</span>
		}

<span class="nc bnc" id="L229" title="All 2 branches missed.">		if (sortColumn != null) {</span>
<span class="nc" id="L230">			header.setSortColumn(sortColumn);</span>
		}
<span class="nc bnc" id="L232" title="All 2 branches missed.">		if (sortOrder != null) {</span>
<span class="nc" id="L233">			header.setSortOrder(sortOrder);</span>
		}
<span class="nc" id="L235">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>