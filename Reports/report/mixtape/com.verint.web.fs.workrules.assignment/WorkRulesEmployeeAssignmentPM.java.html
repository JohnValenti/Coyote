<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WorkRulesEmployeeAssignmentPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">WorkRulesEmployeeAssignmentPM.java</span></div><h1>WorkRulesEmployeeAssignmentPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Map.Entry;
import java.util.ResourceBundle;
import java.util.Set;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.DayOfWeek;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpTimeBank;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRule;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRuleFieldInfo;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceRotation;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceWorkPattern;
import com.bluepumpkin.ejb.bbm.people.ejb.PeopleFacade;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.Rotation;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.ejb.bbm.workrules.model.TimeBank;
import com.bluepumpkin.ejb.core.CoreEJBCreateException;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.core.pagecomponent.time.TimePeriodSelectorController;
import com.bluepumpkin.web.core.pagecomponent.time.TimePeriodSelectorPC;
import com.bluepumpkin.web.core.pagecomponent.time.TimePeriodSelectorWeekController;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.l10n.FsWebLogBundleKey;
import com.verint.web.fs.employee.assignment.WfmEmployeeAssignmentPM;
import com.verint.web.fs.skills.EmployeeAssignmentPMUtil;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.CacheUtil;

public class WorkRulesEmployeeAssignmentPM extends WfmEmployeeAssignmentPM {
	private static final long serialVersionUID = 1L;

<span class="fc" id="L68">	protected boolean isByOrg = true;</span>
	protected final ResourceBundle m_bundle;
	protected SchedulingPeriod selectedSP;
	protected Campaign selectedCampaign;

	//key = employee ID
<span class="fc" id="L74">	private Map&lt;ID, Employee&gt; employeeMap = new HashMap&lt;ID, Employee&gt;();</span>
	//key = employee ID, value = collection of work pattern assignments
	private HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; workPatternAssignmentMap;
	//key = employee ID, value = collection of assignment rule assignments
	private HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; assignmentRuleAssignmentMap;
	//key = employee ID, value = collection of rotation assignments
	private HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; rotationAssignmentMap;
	//key = employee ID, value = collection of time bank assignments
	private HashMap&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; timeBankAssignmentMap;
	//key = time bank ID, value = time bank
	private HashMap&lt;ID, TimeBank&gt; timeBankMap;
	//key = org ID
<span class="fc" id="L86">	private Map&lt;ID, Organization&gt; orgMap = new HashMap&lt;ID, Organization&gt;();</span>
	private boolean didTimePeriodChange;

	private WorkPatternInlineEditListPC pc_workPattern;
	private HoursPC pc_hours;
	private PoolingRulePC pc_poolingRules;
	private AssignmentRuleInlineEditListPC pc_assignmentRule;
	private RotationInlineEditListPC pc_rotation;
	private TimeBankAssignmentListPC pc_timeBank;
	private TimePeriodSelectorPC pc_timePeriod;
<span class="fc" id="L96">	private boolean isViewPeriodValidForAllEmployees = true;</span>

	// Exposes control for visibility of assignment rules for inheriting classes
<span class="fc" id="L99">	protected boolean isAssignmentRuleVisible = true;</span>

	// Exposes control for visibility of rotation assignment for inheriting classes
<span class="fc" id="L102">	protected boolean isRotationAssignmentVisible = true;</span>
<span class="fc" id="L103">	protected boolean isCampaignMode = false;</span>
	// Exposes control for visibility of rotation assignment for inheriting classes
<span class="fc" id="L105">	protected boolean isTimeBankAssignmentVisible = true;</span>

	public static final String EMPLOYEE_ID_LIST_CONTEXT_KEY = &quot;com.verint.web.fs.workrules.assignment.employeeIDs&quot;;

	public WorkRulesEmployeeAssignmentPM(RequestContext context) {
<span class="fc" id="L110">		super(context, PageModel.FRAMED_MODEL);</span>
<span class="fc" id="L111">		m_bundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

<span class="fc" id="L113">		didTimePeriodChange = WorkRulesEmployeeAssignmentRH.didTimePeriodChange(context);</span>
<span class="fc" id="L114">	}</span>

	public static WorkRulesEmployeeAssignmentPM getInstance(RequestContext context) {
<span class="fc" id="L117">		return (WorkRulesEmployeeAssignmentPM) PageModel.getInstance(context, WorkRulesEmployeeAssignmentPM.class);</span>
	}

	@Override
	protected void initForm() {
<span class="fc" id="L122">		initContextDateFieldNames(START_DATE_FN, END_DATE_FN);</span>
		
		//Setting list of employeeIDs in context for the associated popup window (the list may be too large
		//  to use as a query string param)
<span class="fc" id="L126">		CacheUtil.setCachedValue(m_context, CacheUtil.CACHE_MODE_SESSION,</span>
				WorkRulesEmployeeAssignmentPM.EMPLOYEE_ID_LIST_CONTEXT_KEY,
<span class="fc" id="L128">				StringUtil.createDelimitedString(getSelectedIDs(), StringUtil.DELIM));</span>

		// moved out of the if block so dates are available even if no employees are selected,
		// to avoid null pointed exception
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">		if (pc_timePeriod != null &amp;&amp;</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">				pc_timePeriod.getSelectedDateRange() != null &amp;&amp;</span>
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">				pc_timePeriod.getSelectedDateRange().getFirst() != null &amp;&amp;</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">				pc_timePeriod.getSelectedDateRange().getSecond() != null) {</span>
<span class="fc" id="L136">			viewStartDate = pc_timePeriod.getSelectedDateRange().getFirst();</span>
<span class="fc" id="L137">			viewEndDate = pc_timePeriod.getSelectedDateRange().getSecond();</span>
		}

<span class="pc bpc" id="L140" title="1 of 2 branches missed.">		if (getSelectedIDSize() &gt; 0) {</span>
<span class="fc" id="L141">			Collection&lt;ID&gt; employeeIDs = getSelectedIDsAsCollection();</span>

			try {
				//Loading this data here instead of loadData because we need the date range from the date selector
<span class="fc" id="L145">				employeeMap = EmployeeModelHandler.getEmployeeMap(m_context, employeeIDs, viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>

<span class="pc bpc" id="L147" title="1 of 2 branches missed.">				if (isEditable() == false) {</span>
<span class="nc" id="L148">					addPageMessage(Message.WARNING_TYPE,</span>
							FsWebBundleKey.FS_WORKRULES_NOT_ALL_EMPLOYEES_EDITABLE, FsWebBundleKey.BUNDLE_NAME);
				}

<span class="pc bpc" id="L152" title="1 of 2 branches missed.">				if(employeeMap.size() == 0) {</span>
					// There were no employees for the provided ids, something is wrong, either the id
					// selected don't exist in the database or no ids where provided.  Either way, instruct
					// the user to make a valid selection.
<span class="nc" id="L156">					addPageMessage(Message.INSTRUCTION_TYPE, getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
							BbmWebBundleKey.SELECT_EMPLOYEE));
<span class="nc" id="L158">					return;</span>
				}

				// There were multiple employees selected, instruct the user of the multi-select.
<span class="fc bfc" id="L162" title="All 2 branches covered.">				if (isMultiEdit()) {</span>
<span class="fc" id="L163">					addPageMessage(Message.INFO_TYPE, BbmWebBundleKey.MultipleAlert, BbmWebBundleKey.BUNDLE_NAME);</span>
				}

<span class="fc" id="L166">				ArrayList&lt;String&gt; invalidEmployeeNames = new ArrayList&lt;String&gt;();</span>
				//Check to see if all employees start/end dates overlap with the view period.  If not, display
				// a message to the user and do not render the page.
<span class="fc bfc" id="L169" title="All 2 branches covered.">				for (Employee emp : employeeMap.values()) {</span>
<span class="pc bpc" id="L170" title="2 of 4 branches missed.">					if (emp.getStartTimeLocal().equals(viewEndDate) || emp.getStartTimeLocal().after(viewEndDate) ||</span>
<span class="pc bpc" id="L171" title="1 of 4 branches missed.">							(emp.getEndTimeLocal() != null &amp;&amp; emp.getEndTimeLocal().before(viewStartDate))) {</span>
<span class="nc" id="L172">						isViewPeriodValidForAllEmployees = false;</span>
<span class="nc" id="L173">						invalidEmployeeNames.add(m_localizer.formatName(emp));</span>
					}
<span class="fc" id="L175">				}</span>

<span class="pc bpc" id="L177" title="1 of 2 branches missed.">				if (isViewPeriodValidForAllEmployees) {</span>
<span class="fc" id="L178">					loadWorkPatterns();</span>

<span class="pc bpc" id="L180" title="1 of 2 branches missed.">					if(isAssignmentRuleVisible) {</span>
<span class="fc" id="L181">						assignmentRuleAssignmentMap = WorkRulesModelHandler.getComplexWorkRuleAssignments(m_context, getSelectedIDsAsCollection());</span>
					}

<span class="fc" id="L184">					rotationAssignmentMap = WorkRulesModelHandler.getRotationAssignments(m_context, getSelectedIDsAsCollection());</span>

<span class="pc bpc" id="L186" title="1 of 2 branches missed.">					if (isTimeBankAssignmentVisible) {</span>
<span class="fc" id="L187">						timeBankAssignmentMap = WorkRulesModelHandler.getTimeBankAssignments(m_context, getSelectedIDsAsCollection(),</span>
<span class="fc" id="L188">								viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE), viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
<span class="fc" id="L189">						Collection&lt;ID&gt; timeBankIDs = new ArrayList&lt;ID&gt;();</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">						for (Entry&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; entry : timeBankAssignmentMap.entrySet()) {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">							for (EmpTimeBank etb : entry.getValue()) {</span>
<span class="nc" id="L192">								timeBankIDs.add(etb.getTimeBankID());</span>
<span class="nc" id="L193">							}</span>
<span class="nc" id="L194">						}</span>
<span class="fc" id="L195">						Collection&lt;TimeBank&gt; timeBanks = WorkRulesModelHandler.getTimeBanksByIDs(m_context, timeBankIDs);</span>
<span class="fc" id="L196">						timeBankMap = ValueObjectUtil.getIDObjectMap(timeBanks);</span>
					}

<span class="fc bfc" id="L199" title="All 2 branches covered.">					for (ID employeeID : getSelectedIDsAsCollection()) {</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">						if (workPatternAssignmentMap.keySet().contains(employeeID) == false) {</span>
<span class="fc" id="L201">							Set&lt;WorkResourceWorkPattern&gt; set = Collections.emptySet();</span>
<span class="fc" id="L202">							workPatternAssignmentMap.put(employeeID, set);</span>
						}
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">						if(isAssignmentRuleVisible) {</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">							if (assignmentRuleAssignmentMap.keySet().contains(employeeID) == false) {</span>
<span class="fc" id="L206">								Set&lt;WorkResourceComplexWorkRule&gt; set = Collections.emptySet();</span>
<span class="fc" id="L207">								assignmentRuleAssignmentMap.put(employeeID, set);</span>
							}
						}
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">						if(isRotationAssignmentVisible) {</span>
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">							if (rotationAssignmentMap.keySet().contains(employeeID) == false) {</span>
<span class="fc" id="L212">								Set&lt;WorkResourceRotation&gt; set = Collections.emptySet();</span>
<span class="fc" id="L213">								rotationAssignmentMap.put(employeeID, set);</span>
							}
						}
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">						if(isTimeBankAssignmentVisible) {</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">							if (timeBankAssignmentMap.keySet().contains(employeeID) == false) {</span>
<span class="fc" id="L218">								Set&lt;EmpTimeBank&gt; set = Collections.emptySet();</span>
<span class="fc" id="L219">								timeBankAssignmentMap.put(employeeID, set);</span>
							}
						}
<span class="fc" id="L222">					}</span>
<span class="pc bpc" id="L223" title="2 of 4 branches missed.">					boolean extractParams = !didTimePeriodChange &amp;&amp; null != m_context.getPageModel().getPageAction() &amp;&amp;</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">						! PageAction.EDIT.equals(m_context.getPageModel().getPageAction()) &amp;&amp;</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">						! PageAction.NEW_ID.equals(m_context.getPageModel().getPageAction());</span>
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">					pc_hours = new HoursPC(m_context, employeeIDs, employeeMap, viewStartDate, viewEndDate,</span>
							!isByOrg, extractParams);
<span class="fc" id="L228">					pc_hours.setIsBorderEnabled(true);</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">					if(!isEditable()) {</span>
<span class="nc" id="L230">						pc_hours.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L231">						pc_hours.setEnabled(false);</span>
					}
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">					if (pc_hours.isAnySpinnerVisible()) {</span>
<span class="fc" id="L234">						addChildComponent(pc_hours);</span>
<span class="fc" id="L235">						addForm(pc_hours);</span>
					}

					//Pooling Rules Container
<span class="pc bpc" id="L239" title="2 of 4 branches missed.">					if (isByOrg &amp;&amp; hasPoolingLicense()) {</span>
<span class="fc" id="L240">						CollapsibleContainerPC poolingRuleContainer = new CollapsibleContainerPC(m_context);</span>
<span class="fc" id="L241">						poolingRuleContainer.setRenderJavaScriptIfDisabled(true);</span>
<span class="fc" id="L242">						poolingRuleContainer.setName(&quot;poolingRuleContainer&quot;);</span>
<span class="fc" id="L243">						poolingRuleContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
								FsWebBundleKey.POOLING_RULES));
<span class="fc" id="L245">						poolingRuleContainer.setIsBorderEnabled(true);</span>

<span class="fc" id="L247">						pc_poolingRules = new PoolingRulePC(m_context, employeeIDs, employeeMap, viewStartDate, viewEndDate, extractParams);</span>
<span class="fc" id="L248">						pc_poolingRules.setShowTitle(false);</span>
<span class="fc" id="L249">						pc_poolingRules.setFirstDayOfWeek(getWeekStartForSelectedEmployee().getCalendarConstant());</span>

<span class="pc bpc" id="L251" title="1 of 2 branches missed.">						if(!isEditable()) {</span>
<span class="nc" id="L252">							pc_poolingRules.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L253">							pc_poolingRules.setEnabled(false);</span>
						}
<span class="fc" id="L255">						poolingRuleContainer.addComponent(pc_poolingRules);</span>
<span class="fc" id="L256">						addChildComponent(poolingRuleContainer);</span>
<span class="fc" id="L257">						addForm(poolingRuleContainer);</span>
					}

					//Work Pattern Container
<span class="fc" id="L261">					CollapsibleContainerPC workPatternContainer = new CollapsibleContainerPC(m_context);</span>
<span class="fc" id="L262">					workPatternContainer.setRenderJavaScriptIfDisabled(true);</span>
<span class="fc" id="L263">					workPatternContainer.setName(&quot;workPatternContainer&quot;);</span>
<span class="fc" id="L264">					workPatternContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
							FsWebBundleKey.WORK_PATTERNS));
<span class="fc" id="L266">					workPatternContainer.setIsBorderEnabled(true);</span>
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">					if (selectedSP != null) {</span>
<span class="nc" id="L268">						pc_workPattern = new WorkPatternInlineEditListPC(m_context, &quot;workPatternTable&quot;,</span>
<span class="nc" id="L269">								workPatternAssignmentMap, viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc" id="L270">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), selectedSP, selectedCampaign,</span>
<span class="nc" id="L271">								didTimePeriodChange, getSelectedIDsAsCollection(), null, null);</span>
					} else {
<span class="fc" id="L273">						pc_workPattern = new WorkPatternInlineEditListPC(m_context, &quot;workPatternTable&quot;,</span>
<span class="fc" id="L274">								workPatternAssignmentMap, viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="fc" id="L275">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), null, null, didTimePeriodChange,</span>
<span class="fc" id="L276">								getSelectedIDsAsCollection(), null, null);</span>
					}
<span class="fc" id="L278">					pc_workPattern.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="fc" id="L279">					pc_workPattern.setIsInnerTable(true);</span>
<span class="fc" id="L280">					pc_workPattern.setIsBorderEnabled(false);</span>
<span class="fc" id="L281">					pc_workPattern.setIsCancelSelectEventPropagation(false);</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">					if(!isEditable()) {</span>
<span class="nc" id="L283">						pc_workPattern.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L284">						pc_workPattern.setEnabled(false);</span>
					}
<span class="fc" id="L286">					workPatternContainer.addComponent(pc_workPattern);</span>
<span class="fc" id="L287">					addChildComponent(workPatternContainer);</span>
<span class="fc" id="L288">					addForm(workPatternContainer);</span>

					//Assignment Rule Container
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">					if(isAssignmentRuleVisible) {</span>
<span class="fc" id="L292">						CollapsibleContainerPC assignmentRuleContainer = new CollapsibleContainerPC(m_context);</span>
<span class="fc" id="L293">						assignmentRuleContainer.setName(&quot;assignmentRuleContainer&quot;);</span>
<span class="fc" id="L294">						assignmentRuleContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
								FsWebBundleKey.FS_ASSIGNMENT_RULES));
<span class="fc" id="L296">						assignmentRuleContainer.setIsBorderEnabled(true);</span>
<span class="fc" id="L297">						pc_assignmentRule = new AssignmentRuleInlineEditListPC(m_context, &quot;assignmentRuleTable&quot;,</span>
<span class="fc" id="L298">								getComplexWorkRuleAssignments(), viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE), viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">								getSelectedIDsAsCollection(), !isByOrg, didTimePeriodChange, orgMap);</span>
<span class="fc" id="L300">						pc_assignmentRule.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="fc" id="L301">						pc_assignmentRule.setIsInnerTable(true);</span>
<span class="fc" id="L302">						pc_assignmentRule.setIsBorderEnabled(false);</span>
<span class="fc" id="L303">						pc_assignmentRule.setIsCancelSelectEventPropagation(false);</span>
<span class="pc bpc" id="L304" title="2 of 4 branches missed.">						if(!isEditable() || isCampaignMode) {</span>
<span class="nc" id="L305">							pc_assignmentRule.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L306">							pc_assignmentRule.setEnabled(false);</span>
						}
<span class="fc" id="L308">						assignmentRuleContainer.addComponent(pc_assignmentRule);</span>
<span class="fc" id="L309">						addChildComponent(assignmentRuleContainer);</span>
<span class="fc" id="L310">						addForm(assignmentRuleContainer);</span>
					}

					//Rotation container
<span class="fc" id="L314">					int rotationCount = 0;</span>
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">					if(isRotationAssignmentVisible) {</span>
<span class="fc" id="L316">						CollapsibleContainerPC rotationContainer = new CollapsibleContainerPC(m_context);</span>
<span class="fc" id="L317">						rotationContainer.setName(&quot;rotationContainer&quot;);</span>
<span class="fc" id="L318">						rotationContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
								FsWebBundleKey.FS_ROTATIONS));
<span class="fc" id="L320">						rotationContainer.setIsBorderEnabled(true);</span>
<span class="fc" id="L321">						rotationContainer.setEnabled(isByOrg);</span>
<span class="fc" id="L322">						Collection&lt;WorkResourceRotation&gt; rotations = getRotationAssignments();</span>
<span class="fc" id="L323">						pc_rotation = new RotationInlineEditListPC(m_context, &quot;rotationTable&quot;, rotations,</span>
<span class="fc" id="L324">								viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), !isByOrg, didTimePeriodChange,</span>
								orgMap, selectedSP);
<span class="fc" id="L327">						pc_rotation.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="fc" id="L328">						pc_rotation.setIsInnerTable(true);</span>
<span class="fc" id="L329">						pc_rotation.setIsBorderEnabled(false);</span>

<span class="pc bpc" id="L331" title="1 of 2 branches missed.">						if(!isByOrg) {</span>
<span class="nc" id="L332">							pc_rotation.addOnRowAddJS(&quot;if(rotationTable.totalRowCount &gt; 0) {&quot;+</span>
									&quot;if(!workPatternContainer.getIsCollapsed()) {&quot; +
									&quot;workPatternContainer.defaultToggle();&quot; +
									&quot;}&quot; +
									&quot;workPatternContainer.setToggleable(false);&quot; +
									&quot;}&quot;);
<span class="nc" id="L338">							pc_rotation.addOnRowRemoveJS(&quot;if(rotationTable.totalRowCount == 0) {&quot;+</span>
									&quot;workPatternContainer.setToggleable(true);&quot; +
									&quot;if(workPatternContainer.getIsCollapsed()) {&quot; +
									&quot;workPatternContainer.defaultToggle();&quot; +
									&quot;}&quot; +
									&quot;}&quot;);
						}
<span class="fc" id="L345">						pc_rotation.setIsCancelSelectEventPropagation(false);</span>
<span class="pc bpc" id="L346" title="1 of 2 branches missed.">						if(!isEditable()) {</span>
<span class="nc" id="L347">							pc_rotation.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L348">							pc_rotation.setEnabled(false);</span>
						}
<span class="fc" id="L350">						rotationContainer.addComponent(pc_rotation);</span>
<span class="fc" id="L351">						addChildComponent(rotationContainer);</span>
<span class="fc" id="L352">						addForm(rotationContainer);</span>
<span class="fc" id="L353">						rotationCount = pc_rotation.getNumberOfDisplayedRotations();</span>
<span class="fc" id="L354">						rotationContainer.setRenderJavaScriptIfDisabled(true);</span>
					}

					// If the rotation count &gt; 0, work patterns should be collapsed and disabled.
<span class="fc bfc" id="L358" title="All 2 branches covered.">					if(rotationCount &gt; 0)</span>
					{
<span class="fc" id="L360">						workPatternContainer.setCollapsed(true);</span>
<span class="fc" id="L361">						workPatternContainer.setIsToggleEnabled(false);</span>
<span class="fc" id="L362">						workPatternContainer.setRenderJavaScriptIfDisabled(true);</span>
<span class="fc" id="L363">						addPageMessage(Message.INFO_TYPE, getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
								BbmWebBundleKey.PEOPLE_WORKRULES_WORKPATTERNS_DISABLED));
					}

<span class="pc bpc" id="L367" title="2 of 4 branches missed.">					if (isTimeBankAssignmentVisible &amp;&amp; hasTimeBankLicense()) {</span>
<span class="fc" id="L368">						CollapsibleContainerPC timeBankContainer = new CollapsibleContainerPC(m_context);</span>
<span class="fc" id="L369">						timeBankContainer.setName(&quot;timeBankContainer&quot;);</span>
<span class="fc" id="L370">						timeBankContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
								FsWebBundleKey.FS_TIME_BANKS));
<span class="fc" id="L372">						timeBankContainer.setIsBorderEnabled(true);</span>
<span class="fc" id="L373">						Collection&lt;EmpTimeBank&gt; timeBankAssignments = getTimeBankAssignments();</span>
<span class="fc" id="L374">						pc_timeBank = new TimeBankAssignmentListPC(m_context, &quot;timeBankTable&quot;, timeBankAssignments, timeBankMap,</span>
<span class="fc" id="L375">								viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE), viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), didTimePeriodChange, getSelectedIDsAsCollection());</span>
<span class="fc" id="L376">						pc_timeBank.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="fc" id="L377">						pc_timeBank.setIsInnerTable(true);</span>
<span class="fc" id="L378">						pc_timeBank.setIsBorderEnabled(false);</span>
<span class="fc" id="L379">						pc_timeBank.setIsCancelSelectEventPropagation(false);</span>
<span class="pc bpc" id="L380" title="1 of 2 branches missed.">						if(!isEditable()) {</span>
<span class="nc" id="L381">							pc_timeBank.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L382">							pc_timeBank.setEnabled(false);</span>
						}
<span class="fc" id="L384">						timeBankContainer.addComponent(pc_timeBank);</span>
<span class="fc" id="L385">						addChildComponent(timeBankContainer);</span>
<span class="fc" id="L386">						addForm(timeBankContainer);</span>
					}
<span class="fc" id="L388">				} else {</span>
<span class="nc" id="L389">					StringBuffer namesStr = new StringBuffer();</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">					for (String empName : invalidEmployeeNames) {</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">						if(!StringUtil.isEmpty(namesStr.toString())) {</span>
<span class="nc" id="L392">							namesStr.append(&quot;; &quot;);</span>
						}
<span class="nc" id="L394">						namesStr.append(empName);</span>
<span class="nc" id="L395">					}</span>
<span class="nc" id="L396">					addPageMessage(Message.ERROR_TYPE, FsWebBundleKey.FS_VIEW_DATE_OUT_OF_RANGE_FOR_EMP_WORK_RULE_ASSIGNMENT,</span>
<span class="nc" id="L397">							FsWebBundleKey.BUNDLE_NAME, new String[] {namesStr.toString()});</span>
				}
<span class="nc" id="L399">			} catch (Exception e) {</span>
<span class="nc" id="L400">				handleUnableToLoadDataError(log, e);</span>
<span class="fc" id="L401">			}</span>
<span class="fc" id="L402">		} else {</span>
<span class="nc" id="L403">			addPageMessage(Message.INSTRUCTION_TYPE, getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
					BbmWebBundleKey.SELECT_EMPLOYEE));
		}
<span class="fc" id="L406">	}</span>

	@Override
	protected void initContentTitle() {
<span class="fc" id="L410">		super.initContentTitle();</span>

<span class="fc" id="L412">		m_contentTitlePC.setPageTitle(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_WORK_RULES_ASSIGNMENT));</span>
<span class="pc bpc" id="L413" title="1 of 2 branches missed.">		if (getSelectedIDSize() &gt; 0) {</span>
			try {

<span class="fc bfc" id="L416" title="All 2 branches covered.">				if (isMultiEdit()) {</span>
<span class="fc" id="L417">					m_contentTitlePC.setItemName(m_localizer.i18n(m_bundle, FsWebBundleKey.N_PEOPLE, getSelectedIDSize()));</span>
				}
				else {
<span class="fc" id="L420">					Employee emp = EmployeeModelHandler.getEmployeeByID(getRequestContext(), getSelectedIDObject());</span>
<span class="fc" id="L421">					m_contentTitlePC.setItemName(m_localizer.formatName(emp.getPerson()));</span>
				}
<span class="nc" id="L423">			} catch (BbmFinderException bfe) {</span>
				// Don't do anything, we just couldn't find the user so don't set the title text because the screen
				// is just going to not initialize and a message will be presented to the user to make a selection.
<span class="nc" id="L426">			} catch (Exception ex) {</span>
<span class="nc" id="L427">				handleUnableToLoadDataError(log, ex);</span>
<span class="pc" id="L428">			}</span>
		}
<span class="fc" id="L430">		TimePeriodSelectorController controller = getTimePeriodSelectorController();</span>
<span class="pc bpc" id="L431" title="1 of 2 branches missed.">		if (controller != null) {</span>
<span class="fc" id="L432">			pc_timePeriod = new TimePeriodSelectorPC(m_context, controller);</span>

<span class="fc" id="L434">			EmployeeAssignmentPMUtil.storeSelectedDateRangeInSession(pc_timePeriod, m_context);</span>

<span class="fc" id="L436">			this.addChildComponent(pc_timePeriod);</span>
<span class="fc" id="L437">			m_contentTitlePC.setActiveComponent(pc_timePeriod);</span>
		}
<span class="fc" id="L439">	}</span>

	protected TimePeriodSelectorController getTimePeriodSelectorController() {
<span class="fc" id="L442">		return new TimePeriodSelectorWeekController(getWeekStartForSelectedEmployee(), m_context);</span>
	}

	private DayOfWeek getWeekStartForSelectedEmployee() {
<span class="fc" id="L446">		Integer weekStart = null;</span>
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">		if (getSelectedIDSize() &gt; 0) {</span>
			try {
				//Determine the week start day based on the selected employees.  If all the selected
				// employees' orgs have the same week start day, it will use that day.  Otherwise, it will
				// use the week start day of the root organization.
<span class="fc" id="L452">				PeopleFacade pf = BbmManagerFactory.getPeopleFacade();</span>
<span class="fc" id="L453">				HashMap&lt;ID, Integer&gt; empWeekStarts =</span>
<span class="fc" id="L454">					pf.getEmployeeWeekStarts(getSelectedIDsAsCollection(), new Date());</span>
<span class="fc bfc" id="L455" title="All 2 branches covered.">				for (Integer empWeekStart : empWeekStarts.values()) {</span>
<span class="fc bfc" id="L456" title="All 2 branches covered.">					if (weekStart == null) {</span>
<span class="fc" id="L457">						weekStart = empWeekStart;</span>
<span class="pc bpc" id="L458" title="1 of 2 branches missed.">					} else if (weekStart.equals(empWeekStart) == false) {</span>
<span class="nc" id="L459">						WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L460">						weekStart = (int)wrm.getOrganizationByID(Organization.ROOT_ORG_ID_OBJ).getWeekStartDate();</span>
<span class="nc" id="L461">						break;</span>
					}
<span class="fc" id="L463">				}</span>
<span class="nc" id="L464">			} catch (Exception e) {</span>
<span class="nc" id="L465">				log.warn(m_localizer.i18n(FsWebLogBundleKey.BUNDLE_NAME, FsWebLogBundleKey.COULD_NOT_GET_WEEK_START_FOR_EMP, getSelectedIDObject()), e);</span>
<span class="fc" id="L466">			}</span>
		}
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">		if (weekStart == null)</span>
		 {
<span class="nc" id="L470">			weekStart = 1;		//Default of 1 (sunday), but this shouldn't matter since we only set it here if there are no employees selected</span>
		}
<span class="fc" id="L472">		DayOfWeek dow = DayOfWeek.from0SundayCount(weekStart-1); // Org week start is a 1=sunday based number.</span>
<span class="fc" id="L473">		return dow;</span>
	}

	protected boolean isMultiEdit() {
<span class="fc bfc" id="L477" title="All 2 branches covered.">		return getSelectedIDSize() &gt; 1;</span>
	}

	@Override
	protected void initToolbar() {
<span class="fc" id="L482">		m_toolbar.addValidateSubmitTextButton(PageAction.SAVE,</span>
<span class="pc bpc" id="L483" title="2 of 4 branches missed.">				i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SAVE), !m_initFailure &amp;&amp; isEditable());</span>
<span class="fc" id="L484">		m_toolbar.addResetTextButton(PageAction.RESET,</span>
<span class="fc" id="L485">				i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_RESET), isEditable());</span>
<span class="fc" id="L486">	}</span>

	private Collection&lt;WorkResourceComplexWorkRule&gt; getComplexWorkRuleAssignments() throws BbmException, RemoteException {
		//key = ID of corresponding work rule belonging to the assignment (not the assignment itself)
		//  We only want to display one of each work rule in the assignment rule list
<span class="fc" id="L491">		HashMap&lt;ID, WorkResourceComplexWorkRule&gt; complexWorkRuleAssignments =</span>
			new HashMap&lt;ID, WorkResourceComplexWorkRule&gt;();
<span class="fc" id="L493">		HashMap&lt;ComplexWorkRule, HashSet&lt;ID&gt;&gt; cwrEmployeeMap = new HashMap&lt;ComplexWorkRule, HashSet&lt;ID&gt;&gt;();</span>

<span class="fc bfc" id="L495" title="All 2 branches covered.">		for (ID employeeID : assignmentRuleAssignmentMap.keySet()) {</span>
<span class="pc bpc" id="L496" title="1 of 2 branches missed.">			for (WorkResourceComplexWorkRule wrcwr : assignmentRuleAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">				if (complexWorkRuleAssignments.keySet().contains(wrcwr.getComplexWorkRule().getID())) {</span>
<span class="nc" id="L498">					WorkResourceComplexWorkRule existingWrcwr =</span>
<span class="nc" id="L499">						complexWorkRuleAssignments.get(wrcwr.getComplexWorkRule().getID());</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">					if (existingWrcwr.getNumWeeksInRotation() != wrcwr.getNumWeeksInRotation()) {</span>
<span class="nc" id="L501">						existingWrcwr.setFieldMultiValue(</span>
								WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_NUMWEEKSINROTATION);
					}
<span class="nc bnc" id="L504" title="All 2 branches missed.">					if (existingWrcwr.getStartWeekOffSet() != wrcwr.getStartWeekOffSet()) {</span>
<span class="nc" id="L505">						existingWrcwr.setFieldMultiValue(</span>
								WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_STARTWEEKOFFSET);
					}
<span class="nc bnc" id="L508" title="All 2 branches missed.">					if (existingWrcwr.getWeeksEnabled().equals(wrcwr.getWeeksEnabled())) {</span>
<span class="nc" id="L509">						existingWrcwr.setFieldMultiValue(</span>
								WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_WEEKENABLEDMASK);
					}
<span class="nc" id="L512">				} else {</span>
<span class="nc" id="L513">					complexWorkRuleAssignments.put(wrcwr.getComplexWorkRule().getID(), wrcwr);</span>
				}

<span class="nc" id="L516">				HashSet&lt;ID&gt; associatedEmployeeIDs = cwrEmployeeMap.get(wrcwr.getComplexWorkRule());</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">				if (associatedEmployeeIDs == null) {</span>
<span class="nc" id="L518">					associatedEmployeeIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L519">					cwrEmployeeMap.put(wrcwr.getComplexWorkRule(), associatedEmployeeIDs);</span>
				}
<span class="nc" id="L521">				associatedEmployeeIDs.add(employeeID);</span>
<span class="nc" id="L522">			}</span>
<span class="fc" id="L523">		}</span>
<span class="fc" id="L524">		HashSet&lt;ID&gt; orgIDs = new HashSet&lt;ID&gt;();</span>
<span class="pc bpc" id="L525" title="1 of 2 branches missed.">		for (WorkResourceComplexWorkRule wrcwr : complexWorkRuleAssignments.values()) {</span>
<span class="nc" id="L526">			wrcwr.setMultiEditCommon(</span>
<span class="nc" id="L527">					cwrEmployeeMap.get(wrcwr.getComplexWorkRule()).containsAll(getSelectedIDsAsCollection()));</span>
<span class="nc" id="L528">			orgIDs.add(wrcwr.getComplexWorkRule().getOrganizationID());</span>
<span class="nc" id="L529">		}</span>
<span class="fc" id="L530">		Collection&lt;Organization&gt; orgs = OrganizationModelHandler.getOrganizationsByIDs(m_context, orgIDs);</span>
<span class="pc bpc" id="L531" title="1 of 2 branches missed.">		for (Organization org : orgs) {</span>
<span class="nc" id="L532">			orgMap.put(org.getID(), org);</span>
<span class="nc" id="L533">		}</span>
<span class="fc" id="L534">		return new ArrayList&lt;WorkResourceComplexWorkRule&gt;(complexWorkRuleAssignments.values());</span>
	}

	private Collection&lt;WorkResourceRotation&gt; getRotationAssignments() throws BbmException, RemoteException {
		//key = ID of corresponding rotation belonging to the assignment (not the assignment itself)
		//  We only want to display one of each rotation in the rotation list
<span class="fc" id="L540">		HashMap&lt;ID, WorkResourceRotation&gt; rotationAssignments =</span>
			new HashMap&lt;ID, WorkResourceRotation&gt;();
<span class="fc" id="L542">		HashMap&lt;Rotation, HashSet&lt;ID&gt;&gt; rotationEmployeeMap = new HashMap&lt;Rotation, HashSet&lt;ID&gt;&gt;();</span>

<span class="fc bfc" id="L544" title="All 2 branches covered.">		for (ID employeeID : rotationAssignmentMap.keySet()) {</span>
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">			for (WorkResourceRotation wrr : rotationAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">				if (rotationAssignments.keySet().contains(wrr.getRotation().getID())) {</span>
<span class="nc" id="L547">					WorkResourceRotation existingRotation = rotationAssignments.get(wrr.getRotation().getID());</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">					if (existingRotation.getStartWeekOffSet() != wrr.getStartWeekOffSet()) {</span>
<span class="nc" id="L549">						existingRotation.setFieldMultiValue(</span>
							WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_STARTWEEKOFFSET);
					}
<span class="nc" id="L552">				} else {</span>
<span class="nc" id="L553">					rotationAssignments.put(wrr.getRotation().getID(), wrr);</span>
				}

<span class="nc" id="L556">				HashSet&lt;ID&gt; associatedEmployeeIDs = rotationEmployeeMap.get(wrr.getRotation());</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">				if (associatedEmployeeIDs == null) {</span>
<span class="nc" id="L558">					associatedEmployeeIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L559">					rotationEmployeeMap.put(wrr.getRotation(), associatedEmployeeIDs);</span>
				}
<span class="nc" id="L561">				associatedEmployeeIDs.add(employeeID);</span>
<span class="nc" id="L562">			}</span>
<span class="fc" id="L563">		}</span>
<span class="fc" id="L564">		HashSet&lt;ID&gt; orgIDs = new HashSet&lt;ID&gt;();</span>
<span class="pc bpc" id="L565" title="1 of 2 branches missed.">		for (WorkResourceRotation wrr : rotationAssignments.values()) {</span>
<span class="nc" id="L566">			wrr.setMultiEditCommon(</span>
<span class="nc" id="L567">					rotationEmployeeMap.get(wrr.getRotation()).containsAll(getSelectedIDsAsCollection()));</span>
<span class="nc" id="L568">			orgIDs.add(wrr.getRotation().getOrganizationID());</span>
<span class="nc" id="L569">		}</span>
<span class="fc" id="L570">		Collection&lt;Organization&gt; orgs = OrganizationModelHandler.getOrganizationsByIDs(m_context, orgIDs);</span>
<span class="pc bpc" id="L571" title="1 of 2 branches missed.">		for (Organization org : orgs) {</span>
<span class="nc" id="L572">			orgMap.put(org.getID(), org);</span>
<span class="nc" id="L573">		}</span>
<span class="fc" id="L574">		return new ArrayList&lt;WorkResourceRotation&gt;(rotationAssignments.values());</span>
	}

	private Collection&lt;EmpTimeBank&gt; getTimeBankAssignments() {
		//key = ID of corresponding time bank belonging to the assignment (not the assignment itself)
		//  We only want to display one of each time bank in the time bank list
<span class="fc" id="L580">		HashMap&lt;ID, EmpTimeBank&gt; timeBankAssignments =</span>
			new HashMap&lt;ID, EmpTimeBank&gt;();
<span class="fc" id="L582">		HashMap&lt;TimeBank, HashSet&lt;ID&gt;&gt; timeBankEmployeeMap = new HashMap&lt;TimeBank, HashSet&lt;ID&gt;&gt;();</span>

<span class="fc bfc" id="L584" title="All 2 branches covered.">		for (ID employeeID : timeBankAssignmentMap.keySet()) {</span>
<span class="pc bpc" id="L585" title="1 of 2 branches missed.">			for (EmpTimeBank etb : timeBankAssignmentMap.get(employeeID)) {</span>
<span class="nc" id="L586">				timeBankAssignments.put(etb.getTimeBankID(), etb);</span>

<span class="nc" id="L588">				HashSet&lt;ID&gt; associatedEmployeeIDs = timeBankEmployeeMap.get(timeBankMap.get(etb.getTimeBankID()));</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">				if (associatedEmployeeIDs == null) {</span>
<span class="nc" id="L590">					associatedEmployeeIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L591">					timeBankEmployeeMap.put(timeBankMap.get(etb.getTimeBankID()), associatedEmployeeIDs);</span>
				}
<span class="nc" id="L593">				associatedEmployeeIDs.add(employeeID);</span>
<span class="nc" id="L594">			}</span>
<span class="fc" id="L595">		}</span>
<span class="pc bpc" id="L596" title="1 of 2 branches missed.">		for (EmpTimeBank etb : timeBankAssignments.values()) {</span>
<span class="nc" id="L597">			etb.setMultiEditCommon(</span>
<span class="nc" id="L598">					timeBankEmployeeMap.get(timeBankMap.get(etb.getTimeBankID())).containsAll(getSelectedIDsAsCollection()));</span>
<span class="nc" id="L599">		}</span>
<span class="fc" id="L600">		return new ArrayList&lt;EmpTimeBank&gt;(timeBankAssignments.values());</span>
	}

	private void loadWorkPatterns() throws BbmFinderException {
<span class="pc bpc" id="L604" title="3 of 4 branches missed.">		if (selectedSP != null &amp;&amp; selectedCampaign != null) {</span>
<span class="nc" id="L605">			workPatternAssignmentMap = WorkRulesModelHandler.getWorkPatternAssignmentsForEmployees(m_context,</span>
<span class="nc" id="L606">					getSelectedIDsAsCollection(), viewStartDate.getTime(selectedCampaign.getTimeZone()),</span>
<span class="nc" id="L607">					viewStartDate.getTime(selectedCampaign.getTimeZone()));</span>
		} else {
<span class="fc" id="L609">			workPatternAssignmentMap = WorkRulesModelHandler.getWorkPatternAssignmentsForEmployees(m_context,</span>
<span class="fc" id="L610">					getSelectedIDsAsCollection(), viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="fc" id="L611">					viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
		}
		//We need to retrieve the work patterns in a separate call
		//TODO: This should really be a ValueObjectRich so it can be done in the back end but
		// I was unaware of how this would impact the FS client.
		// (These assignments also already extend DAOEffectivity which makes things more difficult)
<span class="fc" id="L617">		HashSet&lt;WorkResourceWorkPattern&gt; wrwps = new HashSet&lt;WorkResourceWorkPattern&gt;();</span>
<span class="fc bfc" id="L618" title="All 2 branches covered.">		for (ID employeeID : workPatternAssignmentMap.keySet()) {</span>
			//We only want to display the earliest skill assignment within the view period if the employee
			//  has multiple skill assignments for the same skill in the view period
<span class="fc" id="L621">			HashMap&lt;ID, WorkResourceWorkPattern&gt; filteredAssignmentMap = new HashMap&lt;ID, WorkResourceWorkPattern&gt;();</span>
<span class="fc bfc" id="L622" title="All 2 branches covered.">			for (WorkResourceWorkPattern wrwp : workPatternAssignmentMap.get(employeeID)) {</span>
<span class="pc bpc" id="L623" title="1 of 2 branches missed.">				if (isWorkPatternAssignmentCurrent(wrwp)) {</span>
<span class="pc bpc" id="L624" title="1 of 2 branches missed.">					if (wrwp.getStartTime() != null) {</span>
<span class="fc" id="L625">						wrwp.setLocalStartTime(new LocalDate(wrwp.getStartTime(),</span>
<span class="fc" id="L626">							employeeMap.get(employeeID).getTimeZone(wrwp.getStartTime())));</span>
					}
<span class="fc bfc" id="L628" title="All 2 branches covered.">					if (wrwp.getEndTime() != null) {</span>
<span class="fc" id="L629">						wrwp.setLocalEndTime(new LocalDate(wrwp.getEndTime(),</span>
<span class="fc" id="L630">							employeeMap.get(employeeID).getTimeZone(wrwp.getEndTime())));</span>
					}
<span class="pc bpc" id="L632" title="1 of 2 branches missed.">					if (filteredAssignmentMap.get(wrwp.getWorkPatternSID()) == null) {</span>
<span class="fc" id="L633">						filteredAssignmentMap.put(wrwp.getWorkPatternSID(), wrwp);</span>
					} else {
<span class="nc" id="L635">						WorkResourceWorkPattern otherAssignment = filteredAssignmentMap.get(wrwp.getWorkPatternSID());</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">						if (wrwp.getStartTime().before(otherAssignment.getStartTime())) {</span>
<span class="nc" id="L637">							filteredAssignmentMap.put(wrwp.getWorkPatternSID(), wrwp);</span>
						}
					}

				}
<span class="fc" id="L642">			}</span>
<span class="fc" id="L643">			ArrayList&lt;WorkResourceWorkPattern&gt; filteredAssignments = new ArrayList&lt;WorkResourceWorkPattern&gt;(filteredAssignmentMap.values());</span>
<span class="fc" id="L644">			workPatternAssignmentMap.put(employeeID, filteredAssignments);</span>
<span class="fc" id="L645">			wrwps.addAll(filteredAssignments);</span>
<span class="fc" id="L646">		}</span>
<span class="fc" id="L647">		ArrayList&lt;ID&gt; workPatternIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L648" title="All 2 branches covered.">		for (WorkResourceWorkPattern wrwp : wrwps) {</span>
<span class="fc" id="L649">			workPatternIDs.add(wrwp.getWorkPatternSID());</span>
<span class="fc" id="L650">		}</span>
<span class="fc" id="L651">		Collection&lt;ShiftPattern&gt; tempWorkPatterns = WorkRulesModelHandler.getShiftPatterns(m_context, workPatternIDs);</span>
<span class="fc bfc" id="L652" title="All 2 branches covered.">		for (ID employeeID : workPatternAssignmentMap.keySet()) {</span>
<span class="fc bfc" id="L653" title="All 2 branches covered.">			for (WorkResourceWorkPattern wrwp : workPatternAssignmentMap.get(employeeID)) {</span>
<span class="pc bpc" id="L654" title="1 of 2 branches missed.">				for (ShiftPattern sp : tempWorkPatterns) {</span>
<span class="fc bfc" id="L655" title="All 2 branches covered.">					if (sp.getID().equals(wrwp.getWorkPatternSID())) {</span>
<span class="fc" id="L656">						wrwp.setWorkPattern(sp);</span>
<span class="fc" id="L657">						break;</span>
					}
<span class="fc" id="L659">				}</span>
<span class="fc" id="L660">			}</span>
<span class="fc" id="L661">		}</span>
<span class="fc" id="L662">	}</span>

	public void saveMinMaxHours() throws BbmException {
<span class="pc bpc" id="L665" title="1 of 2 branches missed.">		if (pc_hours.isAnySpinnerEnabled()) {</span>
<span class="fc" id="L666">			pc_hours.save();</span>
		}
<span class="fc" id="L668">	}</span>

	public void savePoolingRules() throws BbmException {
<span class="pc bpc" id="L671" title="1 of 2 branches missed.">		if (pc_poolingRules != null) {</span>
<span class="fc" id="L672">			pc_poolingRules.save();</span>
		}
<span class="fc" id="L674">	}</span>

	public void saveWorkPatterns() throws BbmException {
<span class="pc bpc" id="L677" title="1 of 2 branches missed.">		if (pc_workPattern.save(employeeMap)) {</span>
			//On successful save, we need to refresh the work pattern map for the workPatternPC so that
			//merged assignments will be displayed
<span class="fc" id="L680">			loadWorkPatterns();</span>
<span class="fc" id="L681">			pc_workPattern.refreshWorkPatternMap(workPatternAssignmentMap);</span>
		}
<span class="fc" id="L683">	}</span>

	public void saveAssignmentRules() throws BbmException {
<span class="fc" id="L686">		pc_assignmentRule.save(assignmentRuleAssignmentMap);</span>
<span class="fc" id="L687">	}</span>

	public void saveRotations() throws BbmException {
<span class="fc" id="L690">		pc_rotation.save(rotationAssignmentMap);</span>
<span class="fc" id="L691">	}</span>

	public void saveTimeBanks() throws BbmException {
		//We only want to save time banks if we have a time bank license
<span class="pc bpc" id="L695" title="1 of 2 branches missed.">		if (hasTimeBankLicense()) {</span>
<span class="fc" id="L696">			pc_timeBank.save(timeBankAssignmentMap);</span>
		}
<span class="fc" id="L698">	}</span>

	/**
	 * Returns true if customer has a license to view time bank information.  If this is false,
	 * the time bank module on this page will not be available.
	 */
	private boolean hasTimeBankLicense() {
        try {
<span class="fc" id="L706">            return CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_TIME_BANK);</span>
<span class="nc" id="L707">        } catch (CoreEJBCreateException e) {</span>
<span class="nc" id="L708">        } catch (RemoteException e) {</span>
<span class="nc" id="L709">        }</span>
<span class="nc" id="L710">        return false;</span>
	}

	/**
	 * Returns true if customer has a license to pooling.  If this is false,
	 * the pooling module on this page will not be available.
	 */
	private boolean hasPoolingLicense() {
        try {
<span class="fc" id="L719">            return CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_CAMP_POOLING);</span>
<span class="nc" id="L720">        } catch (CoreEJBCreateException e) {</span>
<span class="nc" id="L721">        } catch (RemoteException e) {</span>
<span class="nc" id="L722">        }</span>
<span class="nc" id="L723">        return false;</span>
	}

	/**
	 * Determines if the current work pattern assignment is &quot;current&quot;, in other words it applies to the current
	 * view period.  This is true if the start date of the assignment lies before or at the view period start date
	 * and the assignment end date is either null or lies after the view period start date.  Work pattern assignments are also
	 * current if they lie between the view start and end dates.
	 */
	private boolean isWorkPatternAssignmentCurrent(WorkResourceWorkPattern assignment) {
<span class="pc bpc" id="L733" title="1 of 2 branches missed.">		if (selectedCampaign == null) {</span>
			TimeZone empTimeZone;
<span class="fc" id="L735">			Employee emp = employeeMap.get(assignment.getWorkResourceID());</span>

			//Determine time zone of employee at record start
<span class="pc bpc" id="L738" title="1 of 2 branches missed.">			if (emp.getStartTime().after(assignment.getStartTime())) {</span>
<span class="nc" id="L739">				empTimeZone = emp.getTimeZone(emp.getStartTime());</span>
			} else {
<span class="fc" id="L741">				empTimeZone = emp.getTimeZone(assignment.getStartTime());</span>
			}
<span class="fc" id="L743">			LocalDate localEffectiveStart = new LocalDate(assignment.getStartTime(), empTimeZone);</span>
<span class="fc" id="L744">			LocalDate localEffectiveEnd = null;</span>
			//Determine time zone of employee at record end
<span class="fc bfc" id="L746" title="All 2 branches covered.">			if (assignment.getEndTime() != null) {</span>
<span class="pc bpc" id="L747" title="2 of 4 branches missed.">				if (emp.getEndTime() == null || emp.getEndTime().after(assignment.getEndTime())) {</span>
<span class="nc" id="L748">					empTimeZone = emp.getTimeZone(assignment.getEndTime());</span>
				} else {
<span class="fc" id="L750">					empTimeZone = emp.getTimeZone(emp.getEndTime());</span>
				}
<span class="fc" id="L752">				localEffectiveEnd = new LocalDate(assignment.getEndTime(), empTimeZone);</span>
			}
<span class="pc bpc" id="L754" title="1 of 6 branches missed.">			return ((localEffectiveStart.before(viewStartDate) || localEffectiveStart.equals(viewStartDate))</span>
<span class="pc bpc" id="L755" title="1 of 2 branches missed.">					&amp;&amp; (localEffectiveEnd == null || localEffectiveEnd.after(viewStartDate))) ||</span>
<span class="pc bpc" id="L756" title="2 of 4 branches missed.">					(localEffectiveStart.after(viewStartDate) &amp;&amp; localEffectiveStart.before(viewEndDate));</span>
		} else {
<span class="nc" id="L758">			Date absoluteViewStartDate = viewStartDate.getTime(selectedCampaign.getTimeZone());</span>
<span class="nc" id="L759">			Date absoluteViewEndDate = viewEndDate.getTime(selectedCampaign.getTimeZone());</span>
<span class="nc bnc" id="L760" title="All 4 branches missed.">			return ((assignment.getStartTime().before(absoluteViewStartDate) || assignment.getStartTime().equals(absoluteViewStartDate))</span>
<span class="nc bnc" id="L761" title="All 4 branches missed.">					&amp;&amp; (assignment.getEndTime() == null || assignment.getEndTime().after(absoluteViewStartDate))) ||</span>
<span class="nc bnc" id="L762" title="All 4 branches missed.">					(assignment.getStartTime().after(absoluteViewStartDate) &amp;&amp; assignment.getStartTime().before(absoluteViewEndDate));</span>
		}
	}

	private boolean isEditable() {
<span class="fc bfc" id="L767" title="All 2 branches covered.">		for(Employee emp : employeeMap.values()) {</span>
<span class="fc" id="L768">			ScopeID scopeID = new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE);</span>
<span class="pc bpc" id="L769" title="1 of 2 branches missed.">			if(!m_context.getUser().isAuthorized(PrivilegeKeys.CORE_MODIFYPEOPLE, scopeID)) {</span>
<span class="nc" id="L770">				return false;</span>
			}
<span class="fc" id="L772">		}</span>

<span class="pc bpc" id="L774" title="1 of 2 branches missed.">		if(employeeMap.size() == 0) {</span>
<span class="nc" id="L775">			return false;</span>
		}
<span class="fc" id="L777">		return true;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>