<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AssignmentRuleInlineEditListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">AssignmentRuleInlineEditListPC.java</span></div><h1>AssignmentRuleInlineEditListPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRule;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRuleFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.CalendarPeriod;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.widgets.CheckBoxDropDownSelectionPC;
import com.verint.web.fs.widgets.IntegerDropDownSelection;
import com.verint.web.fs.workrules.WorkRulesJSFileID;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.InsertableMultiColListPC;
import com.witness.web.uif.pagecomponent.table.DefaultHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.WorkpaneMultiColPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.SortUtil;
import com.witness.web.uif.util.TimeUtil;
import com.witness.web.uif.util.js.JSUtil;

public class AssignmentRuleInlineEditListPC extends InsertableMultiColListPC {
	private static final long serialVersionUID = 1L;

	private static final String ACTIVE_DD_TEXT_JS_VAR = &quot;ACTIVE_DD_TEXT_JS_VAR&quot;;
	private static final String INACTIVE_DD_TEXT_JS_VAR = &quot;INACTIVE_DD_TEXT_JS_VAR&quot;;
	
<span class="pc" id="L55">	private Collection&lt;WorkResourceComplexWorkRule&gt; assignments = new ArrayList&lt;WorkResourceComplexWorkRule&gt;();</span>
	//key = workresourcecomplexworkrule ID, value = associated workresourcecomplexworkrule
<span class="pc" id="L57">	private HashMap&lt;ID, WorkResourceComplexWorkRule&gt; modifiedAssignments =</span>
		new HashMap&lt;ID, WorkResourceComplexWorkRule&gt;();
	private Calendar viewStartDate;
	private Calendar viewEndDate;
	private ResourceBundle fsWebBundle;
<span class="pc" id="L62">	private boolean isAjaxRequest = false;</span>
<span class="pc" id="L63">	private boolean didTimePeriodChange = false;</span>
<span class="pc" id="L64">	private boolean isReadOnly = false;</span>
	//Assignment rules (sometimes) have their start date stored
	//relative to their org's time zone.  We need the associated orgs so we 
	//can translate back to midnight GMT.
<span class="pc" id="L68">	private Map&lt;ID, Organization&gt; orgMap = new HashMap&lt;ID, Organization&gt;();</span>
	
	public AssignmentRuleInlineEditListPC(RequestContext context, String name,
			Collection&lt;WorkResourceComplexWorkRule&gt; assignmentRuleAssignments, 
			Date viewStartDate, Date viewEndDate, Collection&lt;ID&gt; employeeIDs,
			boolean isReadOnly, boolean didTimePeriodChange, Map&lt;ID, Organization&gt; orgMap) {
<span class="fc" id="L74">		super(context);		</span>
<span class="fc" id="L75">		setName(name);</span>
<span class="fc" id="L76">		this.assignments = assignmentRuleAssignments;</span>
<span class="fc" id="L77">		this.viewStartDate = Calendar.getInstance();</span>
<span class="fc" id="L78">		this.viewStartDate.setTime(viewStartDate);</span>
<span class="fc" id="L79">		this.viewEndDate = Calendar.getInstance();</span>
<span class="fc" id="L80">		this.viewEndDate.setTime(viewEndDate);</span>
<span class="fc" id="L81">		this.didTimePeriodChange = didTimePeriodChange;</span>
<span class="fc" id="L82">		this.isReadOnly = isReadOnly;</span>
<span class="fc" id="L83">		this.orgMap = orgMap;</span>

<span class="fc" id="L85">		fsWebBundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>
		
<span class="fc" id="L87">		ToolbarPC toolbar = new ToolbarPC(m_context);</span>
<span class="fc" id="L88">		toolbar.setName(&quot;assignmentRuleToolbar&quot;);</span>
<span class="fc" id="L89">		ToolbarTextButton addButton = toolbar.createPopupWindowButton(AssignmentRuleListPopupPM.POPUP_ID,</span>
<span class="fc" id="L90">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_ADD), true);</span>
<span class="fc" id="L91">		addButton.setAttribute(&quot;viewStartDate&quot;, Long.toString(this.viewStartDate.getTimeInMillis()));</span>
<span class="fc" id="L92">		addButton.setAttribute(&quot;viewEndDate&quot;, Long.toString(this.viewEndDate.getTimeInMillis()));</span>
<span class="fc" id="L93">		addButton.setAttribute(&quot;onClick&quot;, getFilterJSForAddButton(getName(), toolbar.getName(), AssignmentRuleListPopupPM.POPUP_ID));</span>

<span class="fc" id="L95">		ToolbarTextButton removeButton = new ToolbarTextButton(toolbar, &quot;removeAssignmentRule&quot;,</span>
<span class="fc" id="L96">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_REMOVE),</span>
				InsertableMultiColListPC.REMOVE_ROW_BUTTON_ACTION, ToolbarTextButton.BLUE_BUTTON, false);
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">		if (isReadOnly) {</span>
<span class="nc" id="L99">			addButton.setEnabled(false);</span>
<span class="nc" id="L100">			removeButton.setEnabled(false);</span>
<span class="nc" id="L101">			setRowSelectable(false);</span>
		}
<span class="fc" id="L103">		toolbar.addToolbarElement(addButton);</span>
<span class="fc" id="L104">		toolbar.addToolbarElement(removeButton);</span>

<span class="fc" id="L106">		setIsBorderEnabled(true);</span>
<span class="fc" id="L107">		setToolbar(toolbar);</span>
		
<span class="fc" id="L109">		addPopupArgs(AssignmentRuleListPopupPM.POPUP_ID, AssignmentRuleListPopupPM.FORM_ACTION, &quot;&quot;,</span>
				AssignmentRuleListPopupPM.POPUP_ARGS, &quot;1000,600,ctr,ctr&quot;, true, 1);
		
		//If we don't have any rows for the list on initial load, we still need to get the required
		// js files from the inline components that may be added dynamically
<span class="fc" id="L114">		IntegerDropDownSelection dummyIntegerSelectionPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="fc" id="L115">			getName() + &quot;_dummyIntegerSelectionPC&quot;, 0, 0);</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">		for (String js : dummyIntegerSelectionPC.getRequireJavaScriptFiles()) {</span>
<span class="fc" id="L117">			addRequiredJavaScriptFile(js);</span>
<span class="fc" id="L118">		}</span>
<span class="fc" id="L119">		CheckBoxDropDownSelectionPC&lt;Integer&gt; dummyCheckBoxSelectionPC = new CheckBoxDropDownSelectionPC&lt;Integer&gt;(getRequestContext(),</span>
<span class="fc" id="L120">				getName() + &quot;_dummyCheckBoxSelectionPC&quot;);</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">		for (String js : dummyCheckBoxSelectionPC.getRequireJavaScriptFiles()) {</span>
<span class="fc" id="L122">			addRequiredJavaScriptFile(js);</span>
<span class="fc" id="L123">		}</span>
		
<span class="fc" id="L125">		extractParameters(m_context.getRequest());</span>

<span class="fc" id="L127">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="fc" id="L128">		setJSMediator(WorkRulesJSFileID.ASSIGNMENT_RULE_INLINE_EDIT_PC);</span>
<span class="fc" id="L129">		addJSVariable(ACTIVE_DD_TEXT_JS_VAR, fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_ACTIVE);</span>
<span class="fc" id="L130">		addJSVariable(INACTIVE_DD_TEXT_JS_VAR, fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_INACTIVE);</span>
<span class="fc" id="L131">	}</span>
	
	//This constructor is used by EmployeeAssignmentInlineEditRH to dynamically generate a row
	public AssignmentRuleInlineEditListPC(RequestContext context, String name,
			Collection&lt;WorkResourceComplexWorkRule&gt; assignmentRuleAssignments, 
			Date viewStartDate, Date viewEndDate, Map&lt;ID, Organization&gt; orgMap) {
<span class="nc" id="L137">		super(context);</span>

<span class="nc" id="L139">		setName(name);</span>
<span class="nc" id="L140">		fsWebBundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L141">		this.assignments = assignmentRuleAssignments;</span>
<span class="nc" id="L142">		this.viewStartDate = Calendar.getInstance();</span>
<span class="nc" id="L143">		this.viewStartDate.setTime(viewStartDate);</span>
<span class="nc" id="L144">		this.viewEndDate = Calendar.getInstance();</span>
<span class="nc" id="L145">		this.viewEndDate.setTime(viewEndDate);</span>
<span class="nc" id="L146">		this.isAjaxRequest = true;</span>
<span class="nc" id="L147">		this.orgMap = orgMap;</span>
<span class="nc" id="L148">	}</span>
	
	public String getJavaScriptInitCode() {
<span class="fc" id="L151">		StringBuffer js = new StringBuffer(super.getJavaScriptInitCode());</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">		if (getToolbar() != null) {</span>
<span class="fc" id="L153">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.setToolbar(&quot;).append(getToolbar().getName()).append(&quot;);&quot;);</span>
<span class="fc" id="L154">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.addButtonEnableAttribute('isDeleteable', 'removeAssignmentRule');\n&quot;);</span>
		}
<span class="fc" id="L156">		return js.toString();</span>
	}

<span class="pc" id="L159">	private boolean isHeaderInited = false;</span>
	private void initHeader() {
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">		if (isHeaderInited) return;</span>
<span class="fc" id="L162">		isHeaderInited = true;</span>
		
<span class="fc" id="L164">		TableHeaderPC header = getHeader();</span>
<span class="fc" id="L165">		Localizer localizer = m_context.getLocalizer();</span>
<span class="fc" id="L166">		DefaultHeaderData dhd = new DefaultHeaderData(FsWebBundleKey.FS_ASSIGNMENT_RULE,</span>
<span class="fc" id="L167">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ASSIGNMENT_RULE));</span>
<span class="fc" id="L168">		dhd.addImageButton(getInfoButtonPopupImage(), getInfoButtonPopupCaption(), getInfoButtonPopupJS());</span>
<span class="fc" id="L169">		dhd.setSortable(false);</span>
<span class="fc" id="L170">		header.addColumnHeaderData(dhd);</span>
<span class="fc" id="L171">		header.addColumnHeaderData(FsWebBundleKey.FS_ASSIGNMENT_RULE_CYCLE, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ASSIGNMENT_RULE_CYCLE));</span>
<span class="fc" id="L172">		header.addColumnHeaderData(FsWebBundleKey.FS_ASSIGNMENT_RULE_PATTERN, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ASSIGNMENT_RULE_PATTERN));</span>
<span class="fc" id="L173">		header.addColumnHeaderData(FsWebBundleKey.FS_ASSIGNMENT_RULE_WEEK, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ASSIGNMENT_RULE_WEEK));</span>
<span class="fc" id="L174">	}</span>
	
	private String getInfoButtonPopupImage() {
<span class="fc" id="L177">		return ImageFileID.TOOLTIP_BUTTON;</span>
	}
	
	private String getInfoButtonPopupCaption() {
<span class="fc" id="L181">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_VIEW_ASSIGNMENT_RULE_DETAILS);</span>
	}
	
	private String getInfoButtonPopupJS() {
<span class="fc" id="L185">		return &quot;WorkRulesUtil.handleInfoPopup(this, &quot; + getName() + &quot;,&quot; + getHeader().getName() + &quot;,'&quot; +</span>
			AssignmentRuleListPopupPM.POPUP_ID + &quot;','&quot; + AssignmentRuleListPopupPM.POPUP_ARG_ASSIGNMENT_RULE_ID + &quot;','&quot; +
			AssignmentRuleListPopupPM.POPUP_ARG_SELECTED_IDS + &quot;','&quot; + AssignmentRuleListPopupPM.POPUP_ARG_IS_INFO_POPUP +
			&quot;','true');&quot;;	
	}

<span class="pc" id="L191">	private boolean isRowsInited = false;</span>
	private void initRows() throws Exception {
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">		if (isRowsInited) return;</span>
<span class="fc" id="L194">		isRowsInited = true;</span>
		
<span class="fc" id="L196">		List&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>

<span class="fc" id="L198">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">		for (WorkResourceComplexWorkRule wrcwr : assignments) {</span>
<span class="fc" id="L200">			rows.add(getNodeData(wrcwr));</span>
<span class="fc" id="L201">			ids.add(wrcwr.getComplexWorkRule().getID());</span>
<span class="fc" id="L202">		}</span>
		
		//Sort the rows by item name
<span class="fc" id="L205">		SortUtil.sort(rows, getHeader().getColumnIndexByName(FsWebBundleKey.FS_ASSIGNMENT_RULE), true, m_context.getLocalizer());</span>
		
<span class="fc" id="L207">		this.setRowIDs(StringUtil.createDelimitedString(ids.toArray(new ID[ids.size()])));</span>
<span class="fc" id="L208">	}</span>
	
	public String getRowHtml(WorkResourceComplexWorkRule wrcwr) {
<span class="nc" id="L211">		StringBuffer html = new StringBuffer();</span>

<span class="nc" id="L213">		super.appendHtmlRowData(html, getNodeData(wrcwr), 0, 0);</span>
		
		//Create the javascript to instantiate the objects for the inline controls
<span class="nc" id="L216">		html.append(HtmlUtil.jsTag(jsInitCode.toString(), false));</span>
<span class="nc" id="L217">		jsInitCode.setLength(0);</span>
		
<span class="nc" id="L219">		return html.toString();</span>
	}
	
<span class="pc" id="L222">	private StringBuffer jsInitCode = new StringBuffer();</span>
	protected DefaultMultiColumnNodeData getNodeData(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L224">		DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(wrcwr.getComplexWorkRule().getID());</span>
		
		//Name
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">		if (wrcwr.isMultiEditCommon()) {</span>
<span class="fc" id="L228">			nodeData.add(wrcwr.getComplexWorkRule().getName());</span>
		} else {
<span class="nc" id="L230">			nodeData.add(&quot;*&quot; + wrcwr.getComplexWorkRule().getName());</span>
		}
		
		//Only add cycle, pattern and week dropdowns if the work rule has a calendar period defined in weeks
<span class="fc bfc" id="L234" title="All 2 branches covered.">		if (wrcwr.getComplexWorkRule().getCalendarPeriod() != null &amp;&amp;</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">				wrcwr.getComplexWorkRule().getCalendarPeriod().getCalendarUnit() == CalendarPeriod.CalendarUnit.Week) {</span>
			//Cycle
<span class="fc" id="L237">			IntegerDropDownSelection cycleDDPC = getCycleDDPC(wrcwr);</span>
<span class="fc" id="L238">			addChildComponent(cycleDDPC);</span>
<span class="fc" id="L239">			nodeData.add(cycleDDPC);</span>
			
			//Pattern
			//Initialize weekddpc here since we need the display value of the week dd for the pattern dd
<span class="fc" id="L243">			IntegerDropDownSelection weekDDPC = getWeekDDPC(wrcwr);</span>
<span class="fc" id="L244">			CheckBoxDropDownSelectionPC&lt;Integer&gt; patternDDPC = getPatternDDPC(wrcwr, weekDDPC);</span>
<span class="fc" id="L245">			addChildComponent(patternDDPC);</span>
<span class="fc" id="L246">			nodeData.add(patternDDPC);</span>
			
			//Week		
<span class="fc" id="L249">			addChildComponent(weekDDPC);</span>
<span class="fc" id="L250">			nodeData.add(weekDDPC);</span>
			
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">			if (isAjaxRequest) {</span>
<span class="nc" id="L253">				jsInitCode.append(cycleDDPC.getJavaScriptInitCode());</span>
<span class="nc" id="L254">				jsInitCode.append(weekDDPC.getJavaScriptInitCode());</span>
<span class="nc" id="L255">				jsInitCode.append(patternDDPC.getJavaScriptInitCode());</span>
<span class="nc" id="L256">				jsInitCode.append(&quot;var &quot; + getWeekOffsetJSVarName(wrcwr) + &quot; = &quot; +</span>
<span class="nc" id="L257">						wrcwr.getStartWeekOffSet() + &quot;;&quot;);</span>
<span class="nc" id="L258">				jsInitCode.append(&quot;var &quot; + getWeeksBetweenJSVarName(wrcwr) + &quot; = &quot; +</span>
<span class="nc" id="L259">						TimeUtil.getWeeksCountBetweenDates(getWorkRuleCreateDate(wrcwr), viewStartDate) + &quot;;&quot;);</span>
			} else {
<span class="fc" id="L261">				addJSVariable(getWeekOffsetJSVarName(wrcwr), wrcwr.getStartWeekOffSet());</span>
<span class="fc" id="L262">				addJSVariable(getWeeksBetweenJSVarName(wrcwr),</span>
<span class="fc" id="L263">						TimeUtil.getWeeksCountBetweenDates(getWorkRuleCreateDate(wrcwr), viewStartDate));</span>
			}
<span class="fc" id="L265">		} else {</span>
<span class="fc" id="L266">			nodeData.add(&quot;&quot;);</span>
<span class="fc" id="L267">			nodeData.add(&quot;&quot;);</span>
<span class="fc" id="L268">			nodeData.add(&quot;&quot;);</span>
		}
		
<span class="fc" id="L271">		setRowAttributes(nodeData, wrcwr);</span>
<span class="fc" id="L272">		return nodeData;</span>
	}
	
	protected void setRowAttributes(DefaultMultiColumnNodeData mcnd, WorkResourceComplexWorkRule wrcwr) {
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">		if (!wrcwr.isMultiEditCommon()) mcnd.setNodeAttribute(ROW_ATTRIBUTE_MULTI_EDIT_NOT_COMMON, String.valueOf(true));</span>
<span class="fc" id="L277">		mcnd.setNodeAttribute(WorkpaneMultiColPM.IS_DELETEABLE, String.valueOf(true));</span>
<span class="fc" id="L278">		mcnd.setNodeAttribute(AssignmentRuleListPopupPM.POPUP_ARG_ASSIGNMENT_RULE_ID, wrcwr.getComplexWorkRule().getID().toString());</span>
<span class="fc" id="L279">	}</span>
	
<span class="pc" id="L281">	private boolean isExtracted = false;</span>
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc bfc" id="L284" title="All 2 branches covered.">		if (isExtracted) return true;</span>
<span class="fc" id="L285">		isExtracted = true;</span>
<span class="fc" id="L286">		boolean retVal = true;</span>
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">		if (didTimePeriodChange == false) {</span>
<span class="fc" id="L288">			retVal = super.extractParameters(request);</span>
		}
		
		// removed
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">		for (ID removedID : getRemovedRowIDCollection()) {</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">			for (WorkResourceComplexWorkRule wrcwr : assignments) {</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">				if (removedID.equals(wrcwr.getComplexWorkRule().getID())) {</span>
<span class="nc" id="L295">					assignments.remove(wrcwr);</span>
<span class="nc" id="L296">					break;</span>
				}
<span class="nc" id="L298">			}</span>
<span class="nc" id="L299">		}</span>

		try {
			// added
<span class="fc" id="L303">			Collection&lt;ID&gt; addedIDs = getAddedRowIDCollection();</span>
<span class="fc bfc" id="L304" title="All 2 branches covered.">			if (addedIDs.size() &gt; 0) {</span>
<span class="fc" id="L305">				HashSet&lt;Integer&gt; defaultEnabledWeeks = new HashSet&lt;Integer&gt;();</span>
<span class="fc" id="L306">				defaultEnabledWeeks.add(0);</span>
<span class="fc" id="L307">				HashSet&lt;ID&gt; newOrgIDs = new HashSet&lt;ID&gt;();</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">				for (ComplexWorkRule cwr : WorkRulesModelHandler.getComplexWorkRulesByIDs(m_context, addedIDs)) {</span>
<span class="fc" id="L309">					newOrgIDs.add(cwr.getOrganizationID());</span>
<span class="fc" id="L310">					WorkResourceComplexWorkRule wrcwr = new WorkResourceComplexWorkRule();</span>
<span class="fc" id="L311">					wrcwr.setComplexWorkRule(cwr);</span>
<span class="fc" id="L312">					wrcwr.setMultiEditCommon(true);</span>
<span class="fc" id="L313">					wrcwr.setWeeksEnabled(defaultEnabledWeeks);</span>
					//If this work rule is already present in assignments, make sure to remove it before re-adding.
					//This case happens when the user removes a work rule and then re-adds the same rule.
<span class="fc" id="L316">					WorkResourceComplexWorkRule existingAssignment = null;</span>
<span class="fc bfc" id="L317" title="All 2 branches covered.">					for (WorkResourceComplexWorkRule existingWrcwr : assignments) {</span>
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">						if (existingWrcwr.getComplexWorkRule().getID().equals(cwr.getID())) {</span>
<span class="nc" id="L319">							existingAssignment = existingWrcwr;</span>
<span class="nc" id="L320">							break;</span>
						}
<span class="fc" id="L322">					}</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">					if (existingAssignment != null) {</span>
<span class="nc" id="L324">						assignments.remove(existingAssignment);</span>
					}
<span class="fc" id="L326">					assignments.add(wrcwr); // This will be updated in the initRows method call below</span>
<span class="fc" id="L327">				}</span>
				//For any new assignments, we need to grab the organization of the work rule and add it to the org map
<span class="fc" id="L329">				Collection&lt;Organization&gt; newOrgs = OrganizationModelHandler.getOrganizationsByIDs(m_context, newOrgIDs);</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">				for (Organization org : newOrgs) {</span>
<span class="fc" id="L331">					orgMap.put(org.getID(), org);</span>
<span class="fc" id="L332">				}</span>
			}
<span class="fc" id="L334">			initHeader();</span>
<span class="fc" id="L335">			initRows();</span>
<span class="nc" id="L336">		} catch (Exception e) {</span>
<span class="nc" id="L337">			retVal = false;</span>
<span class="nc" id="L338">			handleUnableToLoadDataError(log, e);</span>
<span class="fc" id="L339">		}</span>

<span class="fc" id="L341">		return retVal;</span>
	}
	
	private String getCycleDDPCName(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L345">		return getName() + &quot;_cycleDDPC_&quot; + JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString());</span>
	}
	
	private String getPatternDDPCName(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L349">		return getName() + &quot;_patternDDPC_&quot; + JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString());</span>
	}
	
	private String getWeekDDPCName(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L353">		return getName() + &quot;_weekDDPC_&quot; + JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString());</span>
	}
	
	private String getWeekOffsetJSVarName(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L357">		return getName() + &quot;_weekOffset_&quot; + JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString());</span>
	}
	
	private String getWeeksBetweenJSVarName(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L361">		return getName() + &quot;_weeksBetween_&quot; + JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString());</span>
	}
	
	private IntegerDropDownSelection getCycleDDPC(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L365">		IntegerDropDownSelection cycleDDPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="fc" id="L366">				getCycleDDPCName(wrcwr), 1, 26);</span>
<span class="pc bpc" id="L367" title="1 of 2 branches missed.">		if (isCycleMultiEdit(wrcwr)) {</span>
<span class="nc" id="L368">			cycleDDPC.setMultiEdit(true);</span>
		} else {
<span class="fc" id="L370">			cycleDDPC.setSelectedIDs(Collections.singleton(Integer.toString(wrcwr.getNumWeeksInRotation())));</span>
		}

		//When this dropdown is changed, the pattern and week dropdowns need to be repopulated
<span class="fc" id="L374">		cycleDDPC.setOnChangeJS(getName() + &quot;.cycleDDPCChanged('&quot; +</span>
<span class="fc" id="L375">				JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString()) + &quot;');&quot;);</span>
		
<span class="fc" id="L377">		cycleDDPC.extractParameters(m_context.getRequest());</span>
<span class="pc bpc" id="L378" title="2 of 4 branches missed.">		if (assignments != null &amp;&amp; assignments.contains(wrcwr)) {</span>
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">			if (cycleDDPC.isEdited()) {</span>
<span class="nc" id="L380">				cycleDDPC.setMultiEdit(false);</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">				if (modifiedAssignments.containsKey(wrcwr.getID())) {</span>
<span class="nc" id="L382">					modifiedAssignments.get(wrcwr.getID()).setNumWeeksInRotation(cycleDDPC.getSelections().iterator().next());</span>
<span class="nc" id="L383">					modifiedAssignments.get(wrcwr.getID()).setNumWeeksInRotationModified(true);</span>
				} else {
<span class="nc" id="L385">					wrcwr.setNumWeeksInRotation(cycleDDPC.getSelections().iterator().next());</span>
<span class="nc" id="L386">					wrcwr.setNumWeeksInRotationModified(true);</span>
					//Only add to modified assignments if this is not a newly added assignment
<span class="nc bnc" id="L388" title="All 2 branches missed.">					if (wrcwr.getID() != null) {</span>
<span class="nc" id="L389">						modifiedAssignments.put(wrcwr.getID(), wrcwr);</span>
					}
				}	
			}
<span class="pc bpc" id="L393" title="4 of 6 branches missed.">			if ((wrcwr.isMultiEditCommon() || cycleDDPC.isEdited()) &amp;&amp; cycleDDPC.getSelections().size() &gt; 0) {</span>
<span class="fc" id="L394">				wrcwr.setNumWeeksInRotation(cycleDDPC.getSelections().iterator().next());</span>
			}
		}
		
<span class="pc bpc" id="L398" title="1 of 2 branches missed.">		if (isReadOnly) {</span>
<span class="nc" id="L399">			cycleDDPC.setEnabled(false);</span>
		}

<span class="fc" id="L402">		return cycleDDPC;</span>
	}
	
	private CheckBoxDropDownSelectionPC&lt;Integer&gt; getPatternDDPC(WorkResourceComplexWorkRule wrcwr, IntegerDropDownSelection weekDDPC) {
<span class="fc" id="L406">		CheckBoxDropDownSelectionPC&lt;Integer&gt; ddpc =</span>
<span class="fc" id="L407">			new CheckBoxDropDownSelectionPC&lt;Integer&gt;(getRequestContext(), getPatternDDPCName(wrcwr));</span>
		
<span class="fc" id="L409">		ddpc.setDisableAutoUpdateOfInputText(true);</span>
<span class="fc" id="L410">		ddpc.setOnChangeJS(getName() + &quot;.patternDDPCChanged('&quot; +</span>
<span class="fc" id="L411">				JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString()) + &quot;');&quot;);</span>
<span class="fc" id="L412">		int maxWidth = i18n(fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_INACTIVE).length() * 7 + 25;</span>
		
<span class="pc bpc" id="L414" title="1 of 2 branches missed.">		if (isReadOnly) {</span>
<span class="nc" id="L415">			ddpc.setEnabled(false);</span>
		}
		
<span class="pc bpc" id="L418" title="3 of 6 branches missed.">		if (isCycleMultiEdit(wrcwr) || isWeekMultiEdit(wrcwr) || isWeekMultiEdit(wrcwr)) {</span>
<span class="nc" id="L419">			ddpc.setMultiEdit(true);</span>
<span class="nc" id="L420">			ddpc.setEnabled(false);</span>
		} else {
<span class="fc" id="L422">			populatePatternDDOptions(ddpc, weekDDPC, wrcwr);</span>
		}
		
<span class="fc" id="L425">		StringBuffer initJS = new StringBuffer();</span>
		//TODO: can we fix this hack to determine max width, preferably dynamically using javascript?
<span class="fc" id="L427">		initJS.append(getPatternDDPCName(wrcwr) + &quot;.setWidth(&quot; + Integer.toString(maxWidth) + &quot;);&quot;);</span>
<span class="fc" id="L428">		ddpc.setInitJS(initJS.toString());</span>
		
<span class="fc" id="L430">		ddpc.extractParameters(m_context.getRequest());</span>
		
<span class="pc bpc" id="L432" title="1 of 2 branches missed.">		if (ddpc.isEdited()) {</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">			if (modifiedAssignments.containsKey(wrcwr.getID())) {</span>
<span class="nc" id="L434">				modifiedAssignments.get(wrcwr.getID()).setWeeksEnabled(getPatternDDSelections(ddpc));</span>
<span class="nc" id="L435">				modifiedAssignments.get(wrcwr.getID()).setWeeksEnabledModified(true);</span>
			} else {
<span class="nc" id="L437">				wrcwr.setWeeksEnabled(getPatternDDSelections(ddpc));</span>
<span class="nc" id="L438">				wrcwr.setWeeksEnabledModified(true);</span>
				//Only add to modified assignments if this is not a newly added assignment
<span class="nc bnc" id="L440" title="All 2 branches missed.">				if (wrcwr.getID() != null) {</span>
<span class="nc" id="L441">					modifiedAssignments.put(wrcwr.getID(), wrcwr);</span>
				}
			}
			
			//We need to repopulate the DD with the updated selections if it has been edited
<span class="nc" id="L446">			ddpc.clearOptions();</span>
<span class="nc" id="L447">			populatePatternDDOptions(ddpc, weekDDPC, wrcwr);</span>
		}
		
<span class="fc" id="L450">		return ddpc;</span>
	}
	
	private IntegerDropDownSelection getWeekDDPC(WorkResourceComplexWorkRule wrcwr) {
		IntegerDropDownSelection weekDDPC;
		
		//The value that is displayed in this dropdown depends on the current selected date and the work rule create date
<span class="fc" id="L457">		Calendar wrStartDate = getWorkRuleCreateDate(wrcwr);</span>

<span class="pc bpc" id="L459" title="1 of 2 branches missed.">		if (isCycleMultiEdit(wrcwr)) {</span>
<span class="nc" id="L460">			weekDDPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="nc" id="L461">					getWeekDDPCName(wrcwr), 1, 1);</span>
<span class="nc" id="L462">			weekDDPC.setMultiEdit(true);</span>
		} else {
<span class="fc" id="L464">			weekDDPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="fc" id="L465">					getWeekDDPCName(wrcwr), 1, wrcwr.getNumWeeksInRotation());</span>
<span class="fc" id="L466">			weekDDPC.setSelectedIDs(Collections.singleton(Integer.toString(getWeekOffsetDisplayValue(</span>
<span class="fc" id="L467">					wrStartDate, viewStartDate, wrcwr.getStartWeekOffSet(), wrcwr.getNumWeeksInRotation()))));</span>
		}
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">		if (isWeekMultiEdit(wrcwr)) {</span>
<span class="nc" id="L470">			weekDDPC.setMultiEdit(true);</span>
		}
		
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">		if (isCycleMultiEdit(wrcwr)) {</span>
<span class="nc" id="L474">			weekDDPC.setInitJS(getWeekDDPCName(wrcwr) + &quot;.setEnabled(false);&quot;);</span>
		}

		//When this dropdown is changed, the pattern dropdown needs to have its main selection changed
<span class="fc" id="L478">		weekDDPC.setOnChangeJS(getName() + &quot;.weekDDPCChanged('&quot; +</span>
<span class="fc" id="L479">				JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString()) + &quot;');&quot;);</span>
		
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">		if (!didTimePeriodChange) {</span>
<span class="fc" id="L482">			weekDDPC.extractParameters(m_context.getRequest());</span>
		}
<span class="pc bpc" id="L484" title="1 of 2 branches missed.">		if (weekDDPC.isEdited()) {</span>
<span class="nc" id="L485">			weekDDPC.setMultiEdit(false);</span>
			
			//We are re-instantiating this here because the drop down may have had options added to it.
			//When getting the selected values from the dropdown, it will not return a selected value if
			//the drop down does not have the actual object value that gets handed in during instantiation.
			//If values were added via javascript, these objects will not be present in the drop down.
			//See DropDownSelectionPC.getSelections()
<span class="nc" id="L492">			weekDDPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="nc" id="L493">					getWeekDDPCName(wrcwr), 1, wrcwr.getNumWeeksInRotation());</span>
<span class="nc" id="L494">			weekDDPC.extractParameters(m_context.getRequest());</span>
			
<span class="nc bnc" id="L496" title="All 2 branches missed.">			if (modifiedAssignments.containsKey(wrcwr.getID())) {</span>
<span class="nc" id="L497">				modifiedAssignments.get(wrcwr.getID()).setStartWeekOffSet(getWeekOffsetFromDisplayValue(wrStartDate,</span>
<span class="nc" id="L498">						viewStartDate, weekDDPC.getSelections().iterator().next(), wrcwr.getNumWeeksInRotation()));</span>
<span class="nc" id="L499">				modifiedAssignments.get(wrcwr.getID()).setStartWeekOffsetModified(true);</span>
			} else {
<span class="nc" id="L501">				wrcwr.setStartWeekOffSet(getWeekOffsetFromDisplayValue(wrStartDate, viewStartDate,</span>
<span class="nc" id="L502">						weekDDPC.getSelections().iterator().next(), wrcwr.getNumWeeksInRotation()));</span>
<span class="nc" id="L503">				wrcwr.setStartWeekOffsetModified(true);</span>
				//Only add to modified assignments if this is not a newly added assignment
<span class="nc bnc" id="L505" title="All 2 branches missed.">				if (wrcwr.getID() != null) {</span>
<span class="nc" id="L506">					modifiedAssignments.put(wrcwr.getID(), wrcwr);</span>
				}
			}	
		}
		
<span class="pc bpc" id="L511" title="1 of 2 branches missed.">		if (isReadOnly) {</span>
<span class="nc" id="L512">			weekDDPC.setEnabled(false);</span>
		}
		
<span class="fc" id="L515">		return weekDDPC;</span>
	}
	
	//Takes the offset value in the DB and converts it to the appropriate display value
	//  based on the currently selected date
	private int getWeekOffsetDisplayValue(Calendar ruleCreateDate, Calendar viewWeekDate,
			int startWeekOffset, int numWeeksInRotation) {
<span class="pc bpc" id="L522" title="1 of 2 branches missed.">		if (numWeeksInRotation == 0) return 1;</span>
<span class="fc" id="L523">		int weeksBetween = TimeUtil.getWeeksCountBetweenDates(ruleCreateDate, viewWeekDate);</span>
<span class="fc" id="L524">		return (((weeksBetween % numWeeksInRotation) + startWeekOffset) % numWeeksInRotation) + 1;</span>
	}
	
	//Converts the display value from the dropdown into the offset that will be stored into the DB
	private int getWeekOffsetFromDisplayValue(Calendar ruleCreateDate, Calendar viewWeekDate, int weekOffsetDisplayValue, 
			int numWeeksInRotation) {
<span class="nc" id="L530">		int weeksBetween = TimeUtil.getWeeksCountBetweenDates(ruleCreateDate, viewWeekDate);</span>
<span class="nc" id="L531">		int retVal = (weeksBetween % numWeeksInRotation) - (weekOffsetDisplayValue - 1);</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">		if (retVal &gt; 0) return numWeeksInRotation - retVal;</span>
<span class="nc" id="L533">		return -retVal;</span>
	}
	
	//The selections for the pattern DD have a 1-based index while the backend API needs a 0-based
	private HashSet&lt;Integer&gt; getPatternDDSelections(CheckBoxDropDownSelectionPC&lt;Integer&gt; ddpc) {
<span class="nc" id="L538">		HashSet&lt;Integer&gt; retVal = new HashSet&lt;Integer&gt;();</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">		for (Integer week : ddpc.getSelections()) {</span>
<span class="nc" id="L540">			retVal.add(week - 1);</span>
<span class="nc" id="L541">		}</span>
<span class="nc" id="L542">		return retVal;</span>
	}
	
	private void populatePatternDDOptions(CheckBoxDropDownSelectionPC&lt;Integer&gt; patternDDPC,
			IntegerDropDownSelection weekDDPC, WorkResourceComplexWorkRule wrcwr) {
<span class="fc bfc" id="L547" title="All 2 branches covered.">		for (int i = 0; i &lt; wrcwr.getNumWeeksInRotation(); i++) {</span>
<span class="pc bpc" id="L548" title="1 of 2 branches missed.">			if (wrcwr.getWeeksEnabled().contains(i)) {</span>
<span class="fc" id="L549">				patternDDPC.addOption(Integer.toString(i + 1),</span>
<span class="fc" id="L550">						i18n(fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_ACTIVE).replaceFirst(</span>
<span class="fc" id="L551">								&quot;%&quot;, Integer.toString(i + 1)), i + 1, true);</span>
			} else {
<span class="nc" id="L553">				patternDDPC.addOption(Integer.toString(i + 1),</span>
<span class="nc" id="L554">						i18n(fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_INACTIVE).replaceFirst(</span>
<span class="nc" id="L555">								&quot;%&quot;, Integer.toString(i + 1)), i + 1, false);</span>
			}
		}

<span class="pc bpc" id="L559" title="1 of 2 branches missed.">		if (weekDDPC.getSelections().size() &gt; 0) {</span>
<span class="pc bpc" id="L560" title="1 of 2 branches missed.">			if (wrcwr.getWeeksEnabled().contains(weekDDPC.getSelections().iterator().next().intValue() - 1)) {</span>
<span class="fc" id="L561">				patternDDPC.setInitialText(i18n(fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_ACTIVE).replaceFirst(</span>
<span class="fc" id="L562">						&quot;%&quot;, Integer.toString(weekDDPC.getSelections().iterator().next().intValue())));</span>
			} else {
<span class="nc" id="L564">				patternDDPC.setInitialText(i18n(fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_INACTIVE).replaceFirst(</span>
<span class="nc" id="L565">						&quot;%&quot;, Integer.toString(weekDDPC.getSelections().iterator().next().intValue())));</span>
			}
		}
<span class="fc" id="L568">	}</span>
	
	private boolean isCycleMultiEdit(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L571">		return wrcwr.isFieldMultiValue(</span>
				WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_NUMWEEKSINROTATION);
	}
	
	private boolean isWeekMultiEdit(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L576">		return wrcwr.isFieldMultiValue(</span>
				WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_STARTWEEKOFFSET);
	}
	
	private boolean isPatternMultiEdit(WorkResourceComplexWorkRule wrcwr) {
<span class="nc" id="L581">		return wrcwr.isFieldMultiValue(</span>
				WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_WEEKENABLEDMASK);
	}
	
	/**
	 * Returns the work rule creation date (start date).  Always returns a Calendar with a
	 * time component set to midnight and a time zone set to GMT.
	 */
	private Calendar getWorkRuleCreateDate(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L590">		Calendar wrStartDate = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="fc" id="L591">		wrStartDate.setTime(wrcwr.getComplexWorkRule().getCalendarPeriod().getAlignmentDate().getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
<span class="fc" id="L592">		return wrStartDate;</span>
	}
	
	public void save(HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; assignmentRuleAssignmentMap)
	throws BbmException
	{
		//Assignment rules
<span class="fc" id="L599">		Collection&lt;ID&gt; removedWorkRuleIDs = getRemovedWorkRuleAssignmentIDs(assignmentRuleAssignmentMap);</span>
<span class="pc bpc" id="L600" title="2 of 4 branches missed.">		if (removedWorkRuleIDs != null &amp;&amp; removedWorkRuleIDs.size() &gt; 0) {</span>
<span class="nc" id="L601">			WorkRulesModelHandler.deleteComplexWorkRuleAssignments(m_context, removedWorkRuleIDs);</span>
		}
<span class="fc" id="L603">		Collection&lt;WorkResourceComplexWorkRule&gt; modifiedWorkRuleAssignments =</span>
<span class="fc" id="L604">			getModifiedWorkRuleAssignments(assignmentRuleAssignmentMap);</span>
<span class="pc bpc" id="L605" title="2 of 4 branches missed.">		if (modifiedWorkRuleAssignments != null &amp;&amp; modifiedWorkRuleAssignments.size() &gt; 0) {</span>
<span class="nc" id="L606">			WorkRulesModelHandler.updateComplexWorkRuleAssignments(m_context, modifiedWorkRuleAssignments);</span>
		}
<span class="fc" id="L608">		Collection&lt;WorkResourceComplexWorkRule&gt; addedWorkRuleAssignments =</span>
<span class="fc" id="L609">			getAddedWorkRuleAssignments(assignmentRuleAssignmentMap);</span>
<span class="pc bpc" id="L610" title="1 of 4 branches missed.">		if (addedWorkRuleAssignments != null &amp;&amp; addedWorkRuleAssignments.size() &gt; 0) {</span>
<span class="fc" id="L611">			WorkRulesModelHandler.createComplexWorkRuleAssignments(m_context, addedWorkRuleAssignments);</span>
		}
		
		//Clear out the removed/added IDs when finished to avoid saving/deleting duplicates
<span class="fc" id="L615">		setAddedRowIDs(&quot;&quot;);</span>
<span class="fc" id="L616">		setRemovedRowIDs(&quot;&quot;);</span>
<span class="fc" id="L617">	}</span>
	
	private Collection&lt;WorkResourceComplexWorkRule&gt; getAddedWorkRuleAssignments(HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; assignmentRuleAssignmentMap) {
		//Only one copy of each assignment is stored on the page (even if multiple employees are selected), so
		// we need to add the other assignments that will belong to every selected employee
<span class="fc" id="L622">		Collection&lt;WorkResourceComplexWorkRule&gt; addedAssignments = getAddedAssignmentRuleAssignments();</span>
<span class="fc" id="L623">		ArrayList&lt;WorkResourceComplexWorkRule&gt; newAddedAssignments = new ArrayList&lt;WorkResourceComplexWorkRule&gt;();</span>
		
<span class="fc bfc" id="L625" title="All 2 branches covered.">		for (ID employeeID : assignmentRuleAssignmentMap.keySet()) {</span>
<span class="fc bfc" id="L626" title="All 2 branches covered.">			for (WorkResourceComplexWorkRule addedAssignment : addedAssignments) {</span>
<span class="fc" id="L627">				WorkResourceComplexWorkRule wrcwr = new WorkResourceComplexWorkRule();</span>
<span class="fc" id="L628">				wrcwr.setStartWeekOffSet(addedAssignment.getStartWeekOffSet());</span>
<span class="fc" id="L629">				wrcwr.setNumWeeksInRotation(addedAssignment.getNumWeeksInRotation());</span>
<span class="fc" id="L630">				wrcwr.setComplexWorkRule(addedAssignment.getComplexWorkRule());</span>
<span class="fc" id="L631">				wrcwr.setWeeksEnabled(addedAssignment.getWeeksEnabled());</span>
<span class="fc" id="L632">				wrcwr.setWorkResourceID(employeeID);</span>
<span class="fc" id="L633">				newAddedAssignments.add(wrcwr);</span>
<span class="fc" id="L634">			}</span>
<span class="fc" id="L635">		}</span>

<span class="fc" id="L637">		return newAddedAssignments;</span>
	}
	
	private ArrayList&lt;WorkResourceComplexWorkRule&gt; getAddedAssignmentRuleAssignments() {
<span class="fc" id="L641">		ArrayList&lt;WorkResourceComplexWorkRule&gt; retVal = new ArrayList&lt;WorkResourceComplexWorkRule&gt;();</span>
<span class="fc bfc" id="L642" title="All 2 branches covered.">		for (ID id : getAddedRowIDCollection()) {</span>
<span class="pc bpc" id="L643" title="1 of 2 branches missed.">			for (WorkResourceComplexWorkRule wrcwr : assignments) {</span>
<span class="fc bfc" id="L644" title="All 2 branches covered.">				if (id.equals(wrcwr.getComplexWorkRule().getID())) {</span>
<span class="fc" id="L645">					retVal.add(wrcwr);</span>
<span class="fc" id="L646">					break;</span>
				}
<span class="fc" id="L648">			}</span>
<span class="fc" id="L649">		}</span>
<span class="fc" id="L650">		return retVal;</span>
	}
	
	private Collection&lt;WorkResourceComplexWorkRule&gt; getModifiedWorkRuleAssignments(HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; assignmentRuleAssignmentMap) {
		//Only one copy of each assignment is stored on the page (even if multiple employees are selected), so
		// we need to modify the other assignments that belong to every selected employee
<span class="fc" id="L656">		Collection&lt;WorkResourceComplexWorkRule&gt; modifiedAssignments = getModifiedAssignmentRuleAssignments();</span>
<span class="fc" id="L657">		ArrayList&lt;WorkResourceComplexWorkRule&gt; newModifiedAssignments = new ArrayList&lt;WorkResourceComplexWorkRule&gt;();</span>
<span class="pc bpc" id="L658" title="1 of 2 branches missed.">		for (WorkResourceComplexWorkRule wrcwr : modifiedAssignments) {</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">			for (ID employeeID : assignmentRuleAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L660" title="All 4 branches missed.">				if (wrcwr.getWorkResourceID() != null &amp;&amp; employeeID.equals(wrcwr.getWorkResourceID()) == false) {</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">					for (WorkResourceComplexWorkRule existingAssignment : assignmentRuleAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">						if (wrcwr.getComplexWorkRule().getID().equals(existingAssignment.getComplexWorkRule().getID())) {</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">							if (wrcwr.isStartWeekOffsetModified()) {</span>
<span class="nc" id="L664">								existingAssignment.setStartWeekOffSet(wrcwr.getStartWeekOffSet());</span>
							}
<span class="nc bnc" id="L666" title="All 2 branches missed.">							if (wrcwr.isNumWeeksInRotationModified()) {</span>
<span class="nc" id="L667">								existingAssignment.setNumWeeksInRotation(wrcwr.getNumWeeksInRotation());</span>
							}
<span class="nc bnc" id="L669" title="All 2 branches missed.">							if (wrcwr.isWeeksEnabledModified()) {</span>
<span class="nc" id="L670">								existingAssignment.setWeeksEnabled(wrcwr.getWeeksEnabled());</span>
							}
<span class="nc" id="L672">							newModifiedAssignments.add(existingAssignment);</span>
<span class="nc" id="L673">							break;</span>
						}
<span class="nc" id="L675">					}</span>
				}
<span class="nc" id="L677">			}</span>
<span class="nc" id="L678">		}</span>
<span class="fc" id="L679">		modifiedAssignments.addAll(newModifiedAssignments);</span>
<span class="fc" id="L680">		return modifiedAssignments;</span>
	}
	
	private Collection&lt;WorkResourceComplexWorkRule&gt; getModifiedAssignmentRuleAssignments() {
<span class="fc" id="L684">		return new ArrayList&lt;WorkResourceComplexWorkRule&gt;(modifiedAssignments.values());</span>
	}
	
	private Collection&lt;ID&gt; getRemovedWorkRuleAssignmentIDs(HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; assignmentRuleAssignmentMap) {
<span class="fc" id="L688">		Collection&lt;ID&gt; removedAssignmentRuleIDs = getRemovedRowIDCollection();</span>
<span class="fc" id="L689">		Collection&lt;ID&gt; removedAssignmentIDs = new ArrayList&lt;ID&gt;();</span>
		
<span class="fc bfc" id="L691" title="All 2 branches covered.">		for (ID employeeID : assignmentRuleAssignmentMap.keySet()) {</span>
<span class="pc bpc" id="L692" title="1 of 2 branches missed.">			for (WorkResourceComplexWorkRule wrcwr : assignmentRuleAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">				if (removedAssignmentRuleIDs.contains(wrcwr.getComplexWorkRule().getID())) {</span>
<span class="nc" id="L694">					removedAssignmentIDs.add(wrcwr.getID());</span>
				}
<span class="nc" id="L696">			}</span>
<span class="fc" id="L697">		}</span>
		
		//In the case where a rule was removed and then the same rule was added back in, we will need to
		// remove the original rule so we will get the ID for that rule here.
<span class="fc" id="L701">		Collection&lt;WorkResourceComplexWorkRule&gt; addedAssignments = </span>
<span class="fc" id="L702">			getAddedWorkRuleAssignments(assignmentRuleAssignmentMap);</span>
<span class="fc bfc" id="L703" title="All 2 branches covered.">		if (addedAssignments.isEmpty() == false) {</span>
<span class="fc bfc" id="L704" title="All 2 branches covered.">			for (ID empID : assignmentRuleAssignmentMap.keySet()) {</span>
<span class="pc bpc" id="L705" title="1 of 2 branches missed.">				for (WorkResourceComplexWorkRule existingAssignment : assignmentRuleAssignmentMap.get(empID)) {</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">					for (WorkResourceComplexWorkRule addedAssignment : addedAssignments) {</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">						if (existingAssignment.getComplexWorkRuleID().equals(addedAssignment.getComplexWorkRuleID())) {</span>
<span class="nc" id="L708">							removedAssignmentIDs.add(existingAssignment.getID());</span>
						}
<span class="nc" id="L710">					}</span>
<span class="nc" id="L711">				}</span>
<span class="fc" id="L712">			}</span>
		}
		
<span class="fc" id="L715">		return removedAssignmentIDs;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>