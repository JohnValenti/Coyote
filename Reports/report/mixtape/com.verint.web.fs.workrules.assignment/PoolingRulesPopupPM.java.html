<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PoolingRulesPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">PoolingRulesPopupPM.java</span></div><h1>PoolingRulesPopupPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.EmpWorkRuleManager;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpPoolingRule;
import com.bluepumpkin.ejb.bbm.people.model.EmployeeLocal;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.web.bbm.keys.BbmJavaScriptFileID;
import com.bluepumpkin.web.bbm.organization.selection.OrganizationSelectorPC;
import com.bluepumpkin.web.bbm.people.profile.ProfileModelHandler;
import com.bluepumpkin.web.bbm.people.profile.effectivedate.BasePageModel;
import com.bluepumpkin.web.bbm.people.profile.effectivedate.DataContainerPC;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.picker.time.DurationSpinnerPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;

public class PoolingRulesPopupPM extends BasePageModel {
	private static final long serialVersionUID = 1L;
	
	// Param names
	public static final String PARAM_MIN_PAID_NAME = &quot;minName&quot;;
/*	public static final String PARAM_MAX_PAID_NAME = &quot;maxName&quot;;
	public static final String PARAM_OT_PER_DAY_NAME = &quot;otDayName&quot;;
	public static final String PARAM_OT_PER_WEEK_NAME = &quot;otWeekName&quot;;
	public static final String PARAM_VTO_PER_DAY_NAME = &quot;vtoDayName&quot;;
	public static final String PARAM_VTO_PER_WEEK_NAME = &quot;vtoWeekName&quot;; */
	public static final String PARAM_UPDATE_MODE_NAME = &quot;updateModeName&quot;;
	public static final String PARAM_DATES_MODIFIED_NAME = &quot;datesModifiedName&quot;;
	public static final String PARAM_START_NAME = &quot;startName&quot;;
	public static final String PARAM_END_NAME = &quot;endName&quot;;
	public static final String PARAM_SECOND_ORGIDs = &quot;secondaryOrgsName&quot;;
	public static final String PARAM_ORGIDs = &quot;orgIds&quot;;
	
	// RP prefix is for request parameters 
	private String rp_minName, /*rp_maxName, rp_otDayName, rp_otWeekName, rp_vtoDayName, rp_vtoWeekName, */rp_secondaryOrgsName, rp_updateModeName, rp_startName, rp_endName;
	private String rp_updateMode, rp_datesModifiedName;
	private String orgIds;
	
<span class="fc" id="L63">	public static String POOLINGRULES_POPUP_ID = &quot;POOLINGRULES_POPUP_ID&quot;;</span>
<span class="fc" id="L64">	public static String PARAM_PERIOD_ONLY = &quot;periodOnly&quot;;</span>
<span class="fc" id="L65">	public static String PARAM_START = &quot;start&quot;;</span>
<span class="fc" id="L66">	public static String PARAM_END = &quot;end&quot;;</span>
	
	//key = employee ID
<span class="nc" id="L69">	private HashMap&lt;ID, Employee&gt; employeeMap = new HashMap&lt;ID, Employee&gt;();</span>
<span class="nc" id="L70">	private ID[] selectedIDs = new ID[0];</span>
<span class="nc" id="L71">	private boolean periodOnly = false;</span>
<span class="nc" id="L72">	private Date start=new Date(), end = new Date(start.getTime() + (24 * 60 * 60 * 1000));	</span>

	// Page Components
	private DurationSpinnerPC pc_minPaid;
//	private DurationSpinnerPC pc_maxPaid;
//	private DurationSpinnerPC pc_otDay;
//	private DurationSpinnerPC pc_otWeek;
//	private DurationSpinnerPC pc_vtoDay;
//	private DurationSpinnerPC pc_vtoWeek;
	
	private OrganizationSelectorPC pc_orgSelPC; 

	private MyDataContainer pc_dataContainer;
	
<span class="nc" id="L86">	private HashMap&lt;ID, Collection&lt;EmpPoolingRule&gt;&gt; hoursAssignments = new HashMap&lt;ID, Collection&lt;EmpPoolingRule&gt;&gt;();</span>

	public PoolingRulesPopupPM(RequestContext context) {
<span class="nc" id="L89">		super(context, &quot;poolingRulesPopupPM_updateParent();&quot;);</span>
<span class="nc" id="L90">		extractParameters(context.getRequest());</span>
<span class="nc" id="L91">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="nc" id="L92">		addRequiredJavaScriptFile(BbmJavaScriptFileID.EFFECTIVE_DATES_UTIL);</span>
<span class="nc" id="L93">	}</span>
	
	@Override
	public boolean extractParameters(HttpServletRequest request) {
		// The popup manager names dynamic parameters to be the same name as the 
		// form input name in the parent page, so extract the name first to get the value
<span class="nc" id="L99">		String updateModeName = request.getParameter(PARAM_UPDATE_MODE_NAME);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">		if (!StringUtil.isEmpty(updateModeName)) {</span>
<span class="nc" id="L101">			String updateMode = request.getParameter(updateModeName);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">			if (!StringUtil.isEmpty(updateMode)) setUpdateMode(updateMode);</span>
		}
		
<span class="nc" id="L105">		boolean retVal = super.extractParameters(request);</span>

<span class="nc bnc" id="L107" title="All 2 branches missed.">		if (!StringUtil.isEmpty(selectedID)) {</span>
<span class="nc" id="L108">			selectedIDs = StringUtil.parseIDString(selectedID);</span>
		}
		
<span class="nc bnc" id="L111" title="All 2 branches missed.">		if (selectedIDs.length &gt; 1) {</span>
<span class="nc" id="L112">			m_isMultiEdit = true;</span>
<span class="nc" id="L113">			pc_dataContainer.setIsMultiEdit(true);				</span>
		}

<span class="nc" id="L116">		return retVal;</span>
	}

	@Override
	protected void initializeModel() {
<span class="nc" id="L121">		super.initializeModel();</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">		if (m_isInitialized) return; else m_isInitialized = true;</span>

//		setIsNewPerson(false);
<span class="nc" id="L125">		TableHeaderPC header = m_historyPC.getHeader();</span>
<span class="nc" id="L126">		header.addColumnHeaderData(&quot;startDate&quot;,	m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_START_DATE));</span>
<span class="nc" id="L127">		header.addColumnHeaderData(&quot;endDate&quot;,	m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_END_DATE));</span>
<span class="nc" id="L128">		header.addColumnHeaderData(&quot;secondorgs&quot;,m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.POOLING_RULES_MIN_HOURS));</span>
<span class="nc" id="L129">		header.addColumnHeaderData(&quot;minhours&quot;,	m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.POOLING_RULES_SECOND_ORGS ));</span>
		
		try {
<span class="nc bnc" id="L132" title="All 2 branches missed.">			if (selectedIDs.length &gt; 0) {</span>
<span class="nc" id="L133">				setIsNewPerson(false);</span>
<span class="nc" id="L134">				Date viewDate = pc_dataContainer.getShowAsDate();</span>
<span class="nc" id="L135">				m_employee = new ProfileModelHandler().getEmpWithHistoryData(m_empID, viewDate, m_context.isInWhatIfMode());</span>
<span class="nc" id="L136">				WorkResourceManager wrMgr = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L137">				Collection&lt;Employee&gt; employees = wrMgr.getEmployeesByIDs(Arrays.asList(selectedIDs),</span>
						viewDate, 
						Employee.DETAIL_LEVEL_EMPLOYEE_BASIC |
		                Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY_HISTORY);
<span class="nc bnc" id="L141" title="All 4 branches missed.">				if (employees != null &amp;&amp; employees.size() &gt; 0) m_employee = employees.iterator().next();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">				for (Employee emp : employees) {</span>
<span class="nc" id="L143">					EmployeeLocal.convertEffectivitiesToLocalDate(emp);		//This will populate the local start/termination dates for the employee</span>
<span class="nc" id="L144">					employeeMap.put(emp.getID(), emp);</span>
<span class="nc" id="L145">				}</span>
				
<span class="nc" id="L147">				EmpWorkRuleManager ewrm = WfmManagerFactory.getEmpWorkRuleManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L148">				Date historyStart=new Date(new Date().getTime() - (100L * 365 * 24 * 60 * 60 * 1000)), historyEnd = new Date(new Date().getTime() + (100L * 365 * 24 * 60 * 60 * 1000));</span>
<span class="nc" id="L149">				hoursAssignments = ewrm.getPoolingRuleAssignments(Arrays.asList(selectedIDs), historyStart, historyEnd);</span>
			
<span class="nc bnc" id="L151" title="All 2 branches missed.">				if (hoursAssignments.size() == 0) {</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">					if (periodOnly) {</span>
<span class="nc" id="L153">						pc_dataContainer.setShowAsDate(new LocalDate(start, TimeZoneUtil.GMT_TIMEZONE));</span>
					} else {
<span class="nc" id="L155">						EmployeeLocal.convertEffectivitiesToLocalDate(m_employee);		//This will populate the local start/termination dates for the employee</span>
<span class="nc" id="L156">						pc_dataContainer.setShowAsDate(m_employee.getStartTimeLocal());</span>
					}
				} else {
<span class="nc" id="L159">					LocalDate earliestEffectiveStartDate = getEffectiveStartDateForViewPeriod();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">					if (earliestEffectiveStartDate != null) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">						if (periodOnly) {</span>
<span class="nc" id="L162">							pc_dataContainer.setShowAsDate(new LocalDate(start, TimeZoneUtil.GMT_TIMEZONE));</span>
						} else {		
<span class="nc" id="L164">							pc_dataContainer.setShowAsDate(earliestEffectiveStartDate);</span>
						}					
					}
				}
<span class="nc bnc" id="L168" title="All 2 branches missed.">				if (periodOnly) {</span>
<span class="nc" id="L169">					pc_dataContainer.setViewPeriodEndDate(new LocalDate(end, TimeZoneUtil.GMT_TIMEZONE));</span>
				}
<span class="nc bnc" id="L171" title="All 2 branches missed.">				if (hoursAssignments.size() != 1) {</span>
<span class="nc" id="L172">					getContainers().remove(m_historyPC);</span>
				}
				else {
<span class="nc" id="L175">					List&lt;MultiColumnNodeData&gt; historyList = m_historyPC.getListModel();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">					for (EmpPoolingRule wrmmh : hoursAssignments.values().iterator().next()) {</span>
<span class="nc" id="L177">						DefaultMultiColumnNodeData mcnd = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L178">						mcnd.add(m_localizer.formatDate(wrmmh.getStartTime(), m_employee.getTimeZone(wrmmh.getStartTime()), RegionalFormatBundleKey.DATE_FORMAT));</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">						if (wrmmh.getEndTime() == null) mcnd.add(&quot;&quot;);</span>
						else {
<span class="nc" id="L181">							LocalDate recordEndDateDisplay = new LocalDate(wrmmh.getEndTime(), m_employee.getTimeZone(wrmmh.getEndTime()));</span>
<span class="nc" id="L182">							recordEndDateDisplay.add(Calendar.DATE, -1);</span>
<span class="nc" id="L183">							mcnd.add(m_localizer.formatDate(recordEndDateDisplay, RegionalFormatBundleKey.DATE_FORMAT));						</span>
						}
<span class="nc" id="L185">						mcnd.add(m_localizer.formatDurationInMins(wrmmh.getMinMinutes()));</span>
<span class="nc" id="L186">						Collection orgIDs = wrmmh.getSecondaryOgs();</span>
<span class="nc" id="L187">						Collection orgs = wrMgr.getOrganizationsByIDs(orgIDs);</span>
						
<span class="nc" id="L189">						String strArray = &quot;&quot;;;</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">						for(Object objorg: orgs){</span>
<span class="nc" id="L191">							Organization org = (Organization)objorg;</span>
<span class="nc" id="L192">							String name = org.getName();</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">							if (!strArray.isEmpty())</span>
<span class="nc" id="L194">								strArray += &quot;, &quot; +name;</span>
							else 
<span class="nc" id="L196">								strArray = name;				</span>
<span class="nc" id="L197">						}</span>
						
<span class="nc" id="L199">						mcnd.add(strArray);</span>
//						mcnd.add(m_localizer.formatDurationInMins(wrmmh.getMaxMinutes()));
//						mcnd.add(m_localizer.formatDurationInMins(wrmmh.getMaxOTMinutesPerDay()));
//						mcnd.add(m_localizer.formatDurationInMins(wrmmh.getMaxOTMinutesPerWeek()));
//						mcnd.add(m_localizer.formatDurationInMins(wrmmh.getMaxVTOHoursPerDay()));
//						mcnd.add(m_localizer.formatDurationInMins(wrmmh.getMaxVTOHoursPerWeek()));

<span class="nc" id="L206">						historyList.add(mcnd);</span>
<span class="nc" id="L207">					}</span>
				} 
				
<span class="nc" id="L210">				pc_dataContainer.setRows(initializePoolingRows());</span>
<span class="nc" id="L211">				pc_dataContainer.setOnlyViewPeriodEditable(periodOnly);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">				if (!StringUtil.isEmpty(rp_updateMode)) pc_dataContainer.setUpdateMode(rp_updateMode);</span>

			}		
<span class="nc" id="L215">		} catch (Exception ex) {</span>
<span class="nc" id="L216">			handleUnableToLoadDataError(log, ex);</span>
		} finally {
<span class="nc" id="L218">			initContentTitle();</span>
<span class="nc" id="L219">			initToolbar();</span>
<span class="nc" id="L220">		} </span>
<span class="nc" id="L221">	}</span>
	

	@Override
	public String getJavaScriptInitCode() {
<span class="nc" id="L226">		StringBuffer jsInit = new StringBuffer(super.getJavaScriptInitCode());		</span>
<span class="nc" id="L227">		jsInit.append(pc_minPaid.getName()).append(&quot;.setTime(&quot;).append(&quot;opener.window.&quot;).append(rp_minName).append(&quot;.getTime()); \n&quot;);</span>
<span class="nc" id="L228">		jsInit.append(pc_minPaid.getName()).append(&quot;.setEdited(false); \n&quot;);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">		if (pc_minPaid.isMultiEdit()) jsInit.append(&quot;jQuery('#&quot; + pc_minPaid.getMultiEditIndicatorID() +&quot;').show(); \n&quot;);</span>
		
<span class="nc" id="L231">		jsInit.append(&quot;document.getElementById('&quot;).append(pc_orgSelPC.getName()).append(&quot;HiddenValue')&quot;).append(&quot;.value=&quot;).append(&quot;opener.window.document.getElementById('&quot;).append(rp_secondaryOrgsName).append(&quot;HiddenValue')&quot;).append(&quot;.value; \n&quot;);</span>
<span class="nc" id="L232">		jsInit.append(&quot;document.getElementById('&quot;).append(pc_orgSelPC.getName()).append(&quot;DisplayValue')&quot;).append(&quot;.value=&quot;).append(&quot;opener.window.document.getElementById('&quot;).append(rp_secondaryOrgsName).append(&quot;DisplayValue')&quot;).append(&quot;.value; \n&quot;);</span>
		
/*		jsInit.append(pc_maxPaid.getName()).append(&quot;.setTime(&quot;).append(&quot;opener.window.&quot;).append(rp_maxName).append(&quot;.getTime()); \n&quot;);
		jsInit.append(pc_maxPaid.getName()).append(&quot;.setEdited(false); \n&quot;);
		if (pc_maxPaid.isMultiEdit()) jsInit.append(&quot;jQuery('#&quot; + pc_maxPaid.getMultiEditIndicatorID() +&quot;').show(); \n&quot;);
		
		jsInit.append(pc_otDay.getName()).append(&quot;.setTime(&quot;).append(&quot;opener.window.&quot;).append(rp_otDayName).append(&quot;.getTime()); \n&quot;);
		jsInit.append(pc_otDay.getName()).append(&quot;.setEdited(false); \n&quot;);
		if (pc_otDay.isMultiEdit()) jsInit.append(&quot;jQuery('#&quot; + pc_otDay.getMultiEditIndicatorID() +&quot;').show(); \n&quot;);
		
		jsInit.append(pc_otWeek.getName()).append(&quot;.setTime(&quot;).append(&quot;opener.window.&quot;).append(rp_otWeekName).append(&quot;.getTime()); \n&quot;);
		jsInit.append(pc_otWeek.getName()).append(&quot;.setEdited(false); \n&quot;);
		if (pc_otWeek.isMultiEdit()) jsInit.append(&quot;jQuery('#&quot; + pc_otWeek.getMultiEditIndicatorID() +&quot;').show(); \n&quot;);
		
		jsInit.append(pc_vtoDay.getName()).append(&quot;.setTime(&quot;).append(&quot;opener.window.&quot;).append(rp_vtoDayName).append(&quot;.getTime()); \n&quot;);
		jsInit.append(pc_vtoDay.getName()).append(&quot;.setEdited(false); \n&quot;);
		if (pc_vtoDay.isMultiEdit()) jsInit.append(&quot;jQuery('#&quot; + pc_vtoDay.getMultiEditIndicatorID() +&quot;').show(); \n&quot;);
		
		jsInit.append(pc_vtoWeek.getName()).append(&quot;.setTime(&quot;).append(&quot;opener.window.&quot;).append(rp_vtoWeekName).append(&quot;.getTime()); \n&quot;);
		jsInit.append(pc_vtoWeek.getName()).append(&quot;.setEdited(false); \n&quot;);
		if (pc_vtoWeek.isMultiEdit()) jsInit.append(&quot;jQuery('#&quot; + pc_vtoWeek.getMultiEditIndicatorID() +&quot;').show(); \n&quot;); */
		
<span class="nc" id="L254">		jsInit.append(&quot;\npoolingRulesPopupPM_updateParent = function () { \n&quot;)</span>
		
<span class="nc" id="L256">		.append(&quot;opener.window.&quot;).append(rp_minName).append(&quot;.setTime(&quot;).append(pc_minPaid.getName()).append(&quot;.getTime()); \n&quot;)</span>
		
<span class="nc" id="L258">		.append(&quot;opener.window.document.getElementById('&quot;).append(rp_secondaryOrgsName).append(&quot;HiddenValue')&quot;).append(&quot;.value=&quot;).append(&quot;document.getElementById('&quot;).append(pc_orgSelPC.getName()).append(&quot;HiddenValue')&quot;).append(&quot;.value; \n&quot;)</span>
<span class="nc" id="L259">		.append(&quot;opener.window.document.getElementById('&quot;).append(rp_secondaryOrgsName).append(&quot;DisplayValue')&quot;).append(&quot;.value=&quot;).append(&quot;document.getElementById('&quot;).append(pc_orgSelPC.getName()).append(&quot;DisplayValue')&quot;).append(&quot;.value; \n&quot;)</span>
		
<span class="nc" id="L261">		.append(&quot;var updateMode = jQuery('[name=&quot;).append(DataContainerPC.UPDATE_MODE_FN).append(&quot;][checked]').val(); \n&quot;)</span>
//		.append(&quot;alert(updateMode);&quot;)
<span class="nc" id="L263">		.append(&quot;setParentElement('&quot;).append(rp_updateModeName).append(&quot;', updateMode); \n&quot;)</span>
<span class="nc" id="L264">		.append(&quot;setParentElement('&quot;).append(rp_datesModifiedName).append(&quot;', 'true'); \n&quot;)</span>
<span class="nc" id="L265">		.append(&quot;updateEffectiveDates(null, '&quot;).append(rp_startName).append(&quot;', '&quot;).append(rp_endName).append(&quot;'); \n&quot;)</span>
		
<span class="nc" id="L267">		.append(&quot;window.close();\n&quot;)</span>
<span class="nc" id="L268">		.append(&quot;};\n&quot;); </span>
<span class="nc" id="L269">		return jsInit.toString();</span>
	}

	private void initContentTitle() {
<span class="nc" id="L273">		m_contentTitlePC.setPageTitle(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_POOLINGRULES_TITLE));</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">		if (selectedIDs.length &gt; 1) {</span>
<span class="nc" id="L275">			m_contentTitlePC.setItemName(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.N_PEOPLE, selectedIDs.length));</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">		} else if (m_employee != null) {</span>
<span class="nc" id="L277">			m_contentTitlePC.setItemName(m_localizer.formatName(m_employee));</span>
		}
<span class="nc" id="L279">	}</span>
	
	@Override
	protected DataContainerPC createDataContainerPC() {
<span class="nc" id="L283">		pc_dataContainer = new MyDataContainer(m_context);</span>
<span class="nc" id="L284">		return pc_dataContainer;</span>
	}

	public static PoolingRulesPopupPM getInstance(RequestContext context) {
<span class="nc" id="L288">		return (PoolingRulesPopupPM) PageModel.getInstance(context, PoolingRulesPopupPM.class);</span>
	}
	
	private Collection&lt;MultiColumnNodeData&gt; initializePoolingRows() {
<span class="nc" id="L292">		Duration biggestMinPaid = Duration.fromMinutes(0);</span>
<span class="nc" id="L293">		Duration smallestMaxPaid = Duration.fromMinutes(Integer.MAX_VALUE);</span>
<span class="nc" id="L294">		Duration biggestOTPerDay = Duration.fromMinutes(0);</span>
<span class="nc" id="L295">		Duration smallestOTPerWeek = Duration.fromMinutes(Integer.MAX_VALUE);</span>
<span class="nc" id="L296">		Duration biggestVTOPerDay = Duration.fromMinutes(0);</span>
<span class="nc" id="L297">		Duration smallestVTOPerWeek = Duration.fromMinutes(Integer.MAX_VALUE);</span>

<span class="nc" id="L299">		ArrayList&lt;MultiColumnNodeData&gt; retVal = new ArrayList&lt;MultiColumnNodeData&gt;();</span>
<span class="nc" id="L300">		Integer minPaid = null, maxPaid = null, otDay = null, otWeek = null, vtoDay = null, vtoWeek = null;</span>
/*		boolean minPaidME = false, maxPaidME = false, otDayME = false, otWeekME = false, vtoDayME = false, vtoWeekME = false;
		for (Collection&lt;WorkResourceMinMaxHour&gt; settingsForOnePerson : hoursAssignments.values()) {
			for (WorkResourceMinMaxHour setting : settingsForOnePerson) {
				
				if (setting.getMinMinutes() &gt; biggestMinPaid.getDurationInMinutes()) biggestMinPaid = Duration.fromMinutes(setting.getMinMinutes());
				if (setting.getMaxMinutes() &lt; smallestMaxPaid.getDurationInMinutes()) smallestMaxPaid = Duration.fromMinutes(setting.getMaxMinutes());
				if (setting.getMaxOTMinutesPerDay() &gt; biggestOTPerDay.getDurationInMinutes()) biggestOTPerDay = Duration.fromMinutes(setting.getMaxOTMinutesPerDay());
				if (setting.getMaxOTMinutesPerWeek() &lt; smallestOTPerWeek.getDurationInMinutes()) smallestOTPerWeek = Duration.fromMinutes(setting.getMaxOTMinutesPerWeek());
				if (setting.getMaxVTOHoursPerDay() &gt; biggestVTOPerDay.getDurationInMinutes()) biggestVTOPerDay = Duration.fromMinutes(setting.getMaxVTOHoursPerDay());
				if (setting.getMaxVTOHoursPerWeek() &lt; smallestVTOPerWeek.getDurationInMinutes()) smallestVTOPerWeek = Duration.fromMinutes(setting.getMaxVTOHoursPerWeek());
				
				if ((setting.getStartTime().before(start) || setting.getStartTime().equals(start)) &amp;&amp; (setting.getEndTime() == null || setting.getEndTime().after(start))) {
					if (minPaid == null) minPaid = setting.getMinMinutes();
					else if (setting.getMinMinutes() != minPaid.intValue()) minPaidME = true;
					if (maxPaid == null) maxPaid = setting.getMaxMinutes();
					else if (setting.getMaxMinutes() != maxPaid.intValue()) maxPaidME = true;
					if (otDay == null) otDay = setting.getMaxOTMinutesPerDay();
					else if (setting.getMaxOTMinutesPerDay()  != otDay.intValue()) otDayME = true;
					if (otWeek == null) otWeek = setting.getMaxOTMinutesPerWeek();
					else if (setting.getMaxOTMinutesPerWeek() != otWeek.intValue()) otWeekME = true;
					if (vtoDay == null) vtoDay = setting.getMaxVTOHoursPerDay();
					else if (setting.getMaxVTOHoursPerDay() != vtoDay.intValue()) vtoDayME = true;
					if (vtoWeek == null) vtoWeek = setting.getMaxVTOHoursPerWeek();
					else if (setting.getMaxVTOHoursPerWeek() != vtoWeek.intValue()) vtoWeekME = true;
					break;
				}
			}
		} */
		
<span class="nc" id="L330">		pc_minPaid = new DurationSpinnerPC(m_context, &quot;minPaid&quot;);</span>
<span class="nc" id="L331">		pc_minPaid.setMaxTime(99, 45, 0);</span>
<span class="nc" id="L332">		pc_minPaid.setMinutesIncrement(15);</span>
<span class="nc" id="L333">		pc_minPaid.setValue(Duration.fromMinutes(45));</span>
//		if (minPaid != null) pc_minPaid.setValue(Duration.fromMinutes(minPaid));
//		pc_minPaid.setMultiEdit(minPaidME);
<span class="nc" id="L336">		addChildComponent(pc_minPaid);</span>
<span class="nc" id="L337">		DefaultMultiColumnNodeData row = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L338">		row.add(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.POOLING_RULES_MIN_HOURS));</span>
<span class="nc" id="L339">		row.add(pc_minPaid);</span>
<span class="nc" id="L340">		retVal.add(row);</span>
		
<span class="nc" id="L342">		pc_orgSelPC = new OrganizationSelectorPC(m_context, m_toolbar);</span>
		
/*		Collection&lt;ID&gt; idList = new ArrayList&lt;ID&gt;();
		if(orgIds != null &amp;&amp; orgIds){
			String[] tokens = orgIds.split(&quot;,&quot;);
			
			for (int i = 0; i &lt; tokens.length; i++) {
				
				ID id = new ID(Integer.parseInt(tokens[i]));
				idList.add(id);				
			}
		}
		pc_orgSelPC.initIDs(idList);	*/
<span class="nc" id="L355">		addChildComponent(pc_orgSelPC);</span>
<span class="nc" id="L356">		row = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L357">		row.add(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.POOLING_RULES_SECOND_ORGS));</span>
<span class="nc" id="L358">		row.add(pc_orgSelPC);</span>
<span class="nc" id="L359">		retVal.add(row);</span>
		
/*		pc_minPaid.setAsMinimumValueSpinner(pc_maxPaid.getName(), smallestMaxPaid);
		pc_maxPaid.setAsMaximumValueSpinner(pc_minPaid.getName(), biggestMinPaid);
		pc_otDay.setAsMinimumValueSpinner(pc_otWeek.getName(), smallestOTPerWeek);
		pc_otWeek.setAsMaximumValueSpinner(pc_otDay.getName(), biggestOTPerDay);
		pc_vtoDay.setAsMinimumValueSpinner(pc_vtoWeek.getName(), smallestVTOPerWeek);
		pc_vtoWeek.setAsMaximumValueSpinner(pc_vtoDay.getName(), biggestVTOPerDay); */
		
<span class="nc" id="L368">		return retVal;</span>
	}
	
	/**
	 * Returns the effective start date to be displayed in the start date picker for the given
	 * date range.  This date is the view period start date, unless the employee has start date
	 * after that in which case the employee's start date will be used.
	 */
	private LocalDate getEffectiveStartDateForViewPeriod() {
<span class="nc bnc" id="L377" title="All 2 branches missed.">		if (m_isMultiEdit) return new LocalDate(start, TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc bnc" id="L378" title="All 4 branches missed.">		else if (employeeMap.get(m_empID).getStartTime() != null &amp;&amp; employeeMap.get(m_empID).getStartTime().after(start)) {</span>
<span class="nc" id="L379">			return new LocalDate(employeeMap.get(m_empID).getStartTime(),</span>
<span class="nc" id="L380">					employeeMap.get(m_empID).getTimeZone(employeeMap.get(m_empID).getStartTime()));</span>
		}
<span class="nc" id="L382">		return new LocalDate(start, TimeZoneUtil.GMT_TIMEZONE);</span>
	}
	
	private class MyDataContainer extends DataContainerPC {
<span class="nc" id="L386">		public MyDataContainer(RequestContext context) {</span>
<span class="nc" id="L387">			super(context);</span>
<span class="nc" id="L388">		}</span>

		private Collection&lt;MultiColumnNodeData&gt; rows;
		public void setRows(Collection&lt;MultiColumnNodeData&gt; rows) {
<span class="nc" id="L392">			this.rows = rows;</span>
<span class="nc" id="L393">		}</span>
		private static final long serialVersionUID = 1L;

		@Override
		protected void addCustomDataRow() {
<span class="nc bnc" id="L398" title="All 2 branches missed.">			if (rows != null){</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">				for (MultiColumnNodeData mcnd : rows) {</span>
<span class="nc" id="L400">					this.addRowData(mcnd);</span>
<span class="nc" id="L401">				}</span>
			}
<span class="nc" id="L403">		}</span>
		
//		//This is the start date that is shown for the &quot;update value for current period&quot; section
//		public void setStartDate(LocalDate startDate) {
//			this.startDate = startDate;
//		}
		
		//This is only used in campaign mode.  We need to force the end date to match the end date
		// of the scheduling period.
		public void setViewPeriodEndDate(LocalDate endDate) {
<span class="nc" id="L413">			this.endDate = endDate;</span>
<span class="nc" id="L414">		}</span>
		
		//This is the start date that is shown for the &quot;Insert value&quot; sections
		public void setShowAsDate(LocalDate showAsDate) {
<span class="nc" id="L418">			this.showAsDate = showAsDate;</span>
<span class="nc" id="L419">		}</span>
	}

	public void setPeriodOnly(boolean periodOnly) {
<span class="nc" id="L423">		this.periodOnly = periodOnly;</span>
<span class="nc" id="L424">	}</span>

	public void setStart(long start) {
<span class="nc" id="L427">		this.start = new Date(start);</span>
<span class="nc" id="L428">	}</span>

	public void setEnd(long end) {
<span class="nc" id="L431">		this.end = new Date(end);</span>
<span class="nc" id="L432">	}</span>

	public void setMinName(String minName) {
<span class="nc" id="L435">		this.rp_minName = minName;</span>
<span class="nc" id="L436">	}</span>

/*	public void setMaxName(String maxName) {
		this.rp_maxName = maxName;
	}

	public void setOtDayName(String otDayName) {
		this.rp_otDayName = otDayName;
	}

	public void setOtWeekName(String otWeekName) {
		this.rp_otWeekName = otWeekName;
	}

	public void setVtoDayName(String vtoDayName) {
		this.rp_vtoDayName = vtoDayName;
	}

	public void setVtoWeekName(String vtoWeekName) {
		this.rp_vtoWeekName = vtoWeekName;
	} */

	public void setUpdateModeName(String updateModeName) {
<span class="nc" id="L459">		this.rp_updateModeName = updateModeName;</span>
<span class="nc" id="L460">	};</span>

	public void setUpdateMode(String updateMode) {
<span class="nc" id="L463">		this.rp_updateMode = updateMode;</span>
<span class="nc" id="L464">	}</span>

	public void setStartName(String startName) {
<span class="nc" id="L467">		this.rp_startName = startName;</span>
<span class="nc" id="L468">	}</span>
	
	public void setEndName(String endName) {
<span class="nc" id="L471">		this.rp_endName = endName;</span>
<span class="nc" id="L472">	}</span>

	public void setDatesModifiedName(String datesModifiedName) {
<span class="nc" id="L475">		this.rp_datesModifiedName = datesModifiedName;</span>
<span class="nc" id="L476">	}</span>
	
	public void setSecondaryOrgsName(String secondaryOrgsName) {
<span class="nc" id="L479">		this.rp_secondaryOrgsName = secondaryOrgsName;</span>
<span class="nc" id="L480">	}</span>
	
	public void setOrgIds(String orgIds) {
<span class="nc" id="L483">		this.orgIds = orgIds;</span>
<span class="nc" id="L484">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>