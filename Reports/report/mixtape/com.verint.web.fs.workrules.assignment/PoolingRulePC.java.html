<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PoolingRulePC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">PoolingRulePC.java</span></div><h1>PoolingRulePC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.EmpWorkRuleManager;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpPoolingRule;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.selection.OrganizationSelectorPC;
import com.bluepumpkin.web.bbm.people.profile.ProfilePageModel;
import com.bluepumpkin.web.bbm.people.profile.effectivedate.DataContainerPC;
import com.bluepumpkin.web.core.pagecomponent.CheckBoxPC;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.jsp.HtmlInput;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.form.FormFourColumnPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.DurationSpinnerPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;

import javax.servlet.http.HttpServletRequest;
import java.text.SimpleDateFormat;
import java.util.*;

@SuppressWarnings(&quot;serial&quot;)
public class PoolingRulePC extends FormFourColumnPC {

	private ToolbarPC pc_toolbar;
	private CheckBoxPC pc_canPool;
	private DatePickerPC pc_startDate, pc_endDate;
	private OrganizationSelectorPC pc_orgSelPC;
	private DurationSpinnerPC pc_minPaid;
	private HtmlInput html_updateMode, html_datesModified;

	// Data
<span class="pc" id="L48">	private Collection&lt;ID&gt; employeeIDs = Collections.emptyList();</span>
	private Map&lt;ID, Employee&gt; employeeMap;
<span class="pc" id="L50">	private Map&lt;ID, List&lt;EmpPoolingRule&gt;&gt; poolingRulesAssignments = Collections.emptyMap();</span>
<span class="pc" id="L51">	private Map&lt;ID, EmpPoolingRule&gt; currentHoursAssignments = new HashMap&lt;ID, EmpPoolingRule&gt;();</span>

<span class="pc" id="L53">	private LocalDate effectiveDateStart = null;</span>
<span class="pc" id="L54">	private LocalDate effectiveDateEnd = null;</span>
<span class="pc" id="L55">	private LocalDate empStartDate = null;</span>

	private LocalDate viewPeriodStart, viewPeriodEnd;

	private String strOrgIDs;

<span class="pc" id="L61">	private boolean extractParams = true;</span>

	public PoolingRulePC(RequestContext context) {
<span class="nc" id="L64">		super(context);</span>
<span class="nc" id="L65">	}</span>

	public PoolingRulePC(RequestContext context, Collection&lt;ID&gt; employeeIDs, Map&lt;ID, Employee&gt; employeeMap,
			LocalDate viewPeriodStart, LocalDate viewPeriodEnd, boolean extractParams) throws BbmFinderException {
<span class="fc" id="L69">		super(context);</span>

<span class="fc" id="L71">		setName(&quot;poolingRulesPC&quot;);</span>
<span class="fc" id="L72">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="fc" id="L73">		this.pc_toolbar = new ToolbarPC(m_context);</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">		if (employeeIDs != null) {</span>
<span class="fc" id="L75">			this.employeeIDs = employeeIDs;</span>
		}
<span class="fc" id="L77">		this.viewPeriodStart = viewPeriodStart;</span>
<span class="fc" id="L78">		this.viewPeriodEnd = viewPeriodEnd;</span>
<span class="fc" id="L79">		this.extractParams = extractParams;</span>
<span class="fc" id="L80">		this.employeeMap = employeeMap;</span>

<span class="fc" id="L82">		pc_orgSelPC = new OrganizationSelectorPC(m_context, pc_toolbar);</span>
<span class="fc" id="L83">		pc_orgSelPC.setName(&quot;poolingRule__orgs_input&quot;);</span>
<span class="fc" id="L84">		pc_orgSelPC.setOnChange(&quot;jQuery('#&quot; + pc_orgSelPC.getEditedInputID() + &quot;').val('true')&quot;);</span>
<span class="fc" id="L85">		addChildComponent(pc_orgSelPC);</span>

<span class="fc" id="L87">		pc_minPaid = new DurationSpinnerPC(m_context, &quot;poolingRule__minPaid&quot;);</span>
<span class="fc" id="L88">		pc_minPaid.setMaxTime(99, 45, 0);</span>
<span class="fc" id="L89">		pc_minPaid.setMinutesIncrement(15);</span>
<span class="fc" id="L90">		pc_minPaid.setMinTime(0, 0, 0);</span>

<span class="fc" id="L92">		addChildComponent(pc_minPaid);</span>

<span class="fc" id="L94">		pc_startDate = new DatePickerPC(m_context, &quot;poolingRule__startDate_input&quot;);</span>
<span class="fc" id="L95">		pc_startDate.setName(&quot;hoursPC__startDate&quot;);</span>
<span class="fc" id="L96">		pc_startDate.setEnabled(false);</span>
<span class="fc" id="L97">		pc_startDate.setIsPickerEnabled(false);</span>
<span class="fc" id="L98">		pc_startDate.setIsControlEnabled(false);</span>
<span class="fc" id="L99">		pc_startDate.setIsMultiValueSupported(true);</span>
<span class="fc" id="L100">		addChildComponent(pc_startDate);</span>

<span class="fc" id="L102">		pc_endDate = new DatePickerPC(m_context, &quot;poolingRule__endDate_input&quot;);</span>
<span class="fc" id="L103">		pc_endDate.setName(&quot;hoursPC__endDate&quot;);</span>
<span class="fc" id="L104">		pc_endDate.setEnabled(false);</span>
<span class="fc" id="L105">		pc_endDate.setIsPickerEnabled(false);</span>
<span class="fc" id="L106">		pc_endDate.setIsControlEnabled(false);</span>
<span class="fc" id="L107">		pc_endDate.setIsDateValueOptional(true);</span>
<span class="fc" id="L108">		pc_endDate.setIsMultiValueSupported(true);</span>
<span class="fc" id="L109">		pc_endDate.setDate((LocalDate) null);</span>
<span class="fc" id="L110">		addChildComponent(pc_endDate);</span>

<span class="fc" id="L112">		html_datesModified = new HtmlInput(&quot;poolingrulesPC__datesModified&quot;, &quot;false&quot;, &quot;hidden&quot;);</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">		html_updateMode = new HtmlInput(&quot;poolingrulesPC__updateMode&quot;, employeeIDs.size() &gt; 1 ? DataContainerPC.UPDATE_MODE_2 : DataContainerPC.UPDATE_MODE_1, &quot;hidden&quot;);</span>

<span class="fc" id="L115">		StringBuffer jsCan = new StringBuffer();</span>
<span class="fc" id="L116">		jsCan.append(pc_minPaid.getName()).append(&quot;.setEnabled(true);\n&quot;);</span>
<span class="fc" id="L117">		jsCan.append(&quot;jQuery('#toolbar_poolingRule__orgs_input_ID').show();\n&quot;);</span>
<span class="fc" id="L118">		jsCan.append(&quot;document.getElementById('poolingRule__startDate_editimage').style.visibility='visible';\n&quot;);</span>

<span class="fc" id="L120">		StringBuffer jsCanNot = new StringBuffer();</span>
<span class="fc" id="L121">		jsCanNot.append(pc_minPaid.getName()).append(&quot;.setEnabled(false);\n&quot;);</span>
<span class="fc" id="L122">		jsCanNot.append(&quot;jQuery('#toolbar_poolingRule__orgs_input_ID').hide();\n&quot;);</span>
<span class="fc" id="L123">		jsCanNot.append(&quot;document.getElementById('poolingRule__startDate_editimage').style.visibility='hidden';\n&quot;);</span>

<span class="fc" id="L125">		String onCanJS = jsCan.toString();</span>
<span class="fc" id="L126">		String onCanNotJS = jsCanNot.toString();</span>
<span class="fc" id="L127">		pc_canPool = new CheckBoxPC(context, &quot;poolingRule__canPool&quot;, false, onCanJS, onCanNotJS);</span>
<span class="fc" id="L128">		addChildComponent(pc_canPool);</span>

<span class="fc" id="L130">		loadData();</span>
<span class="fc" id="L131">	}</span>

	/**
	 * Initialize Component For Display
	 * &lt;p&gt;
	 * NOTE: To be overwrittend but should invoke super.initForDisplay();
	 */
	public void initForDisplay() {
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L140">			return;</span>
		} else {
<span class="fc" id="L142">			super.initForDisplay();</span>

<span class="fc" id="L144">			initializeRows();</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">			for (Iterator it = getAllComponentList().iterator(); it.hasNext(); ) {</span>
<span class="fc" id="L146">				PageComponent subComp = (PageComponent) it.next();</span>
<span class="fc" id="L147">				subComp.initForDisplay();</span>
<span class="fc" id="L148">			}</span>
		}
<span class="fc" id="L150">	}</span>

	private void loadData() throws BbmFinderException {
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">		if (employeeIDs.size() == 0) {</span>
<span class="nc" id="L154">			return;</span>
		}
		EmpWorkRuleManager ewrm;
		try {
<span class="fc" id="L158">			ewrm = getEmpWorkRuleManager();</span>
<span class="fc" id="L159">			poolingRulesAssignments = ewrm.getPoolingRuleAssignments(employeeIDs, null, null);</span>
<span class="nc" id="L160">		} catch (Exception e) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">			if (e instanceof BbmFinderException) {</span>
<span class="nc" id="L162">				throw (BbmFinderException) e;</span>
			}
<span class="nc" id="L164">			throw new BbmFinderException(e);</span>
<span class="fc" id="L165">		}</span>

<span class="fc" id="L167">		boolean first = true;</span>
		// Find all current assignment objects
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">		for (ID id : employeeIDs) {</span>
<span class="fc" id="L170">			List&lt;EmpPoolingRule&gt; poolingRulesList = poolingRulesAssignments.get(id);</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">			if (poolingRulesList == null) {</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">				if (employeeIDs.size() &gt; 1) {</span>
<span class="nc" id="L173">					setAllFieldsMultiEdit();</span>
				} else {
					try {
<span class="fc" id="L176">						empStartDate = employeeMap.values().iterator().next().getStartTimeLocal();</span>
<span class="nc" id="L177">					} catch (Exception ex) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">						if (ex instanceof BbmFinderException) {</span>
<span class="nc" id="L179">							throw (BbmFinderException) ex;</span>
						}
<span class="nc" id="L181">						throw new BbmFinderException(ex);</span>
<span class="fc" id="L182">					}</span>
				}
				break;
			}

<span class="nc bnc" id="L187" title="All 2 branches missed.">			for (EmpPoolingRule poolingrule : poolingRulesList) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">				if (isHoursRecordCurrent(poolingrule)) {</span>
<span class="nc" id="L189">					currentHoursAssignments.put(id, poolingrule);</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">					if (first) {</span>
<span class="nc" id="L191">						first = false;</span>
<span class="nc" id="L192">						pc_minPaid.setValue(Duration.fromMinutes(poolingrule.getMinMinutes()));</span>
<span class="nc" id="L193">						effectiveDateStart = new LocalDate(poolingrule.getStartTime(),</span>
<span class="nc" id="L194">								employeeMap.get(poolingrule.getEmployeeID()).getTimeZone(poolingrule.getStartTime()));</span>

<span class="nc bnc" id="L196" title="All 2 branches missed.">						if (poolingrule.getEndTime() != null) {</span>
<span class="nc" id="L197">							effectiveDateEnd = new LocalDate(poolingrule.getEndTime(),</span>
<span class="nc" id="L198">									employeeMap.get(poolingrule.getEmployeeID()).getTimeZone(poolingrule.getEndTime()));</span>
						}

<span class="nc" id="L201">						Collection orgIDs = poolingrule.getSecondaryOgs();</span>
<span class="nc" id="L202">						pc_orgSelPC.initIDs(orgIDs);</span>
<span class="nc" id="L203">						String strArray = &quot;&quot;;</span>
						;
<span class="nc bnc" id="L205" title="All 2 branches missed.">						for (Object orgID : orgIDs) {</span>
<span class="nc" id="L206">							ID tempID = (ID) orgID;</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">							if (!strArray.isEmpty()) {</span>
<span class="nc" id="L208">								strArray += &quot;,&quot; + tempID.toString();</span>
							} else {
<span class="nc" id="L210">								strArray = tempID.toString();</span>
							}
<span class="nc" id="L212">						}</span>
<span class="nc" id="L213">						strOrgIDs = strArray;</span>
<span class="nc" id="L214">					} else {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">						if (poolingrule.getMinMinutes() != pc_minPaid.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L216">							pc_minPaid.setMultiEdit(true);</span>
						}
<span class="nc" id="L218">						LocalDate hoursStartLocal = new LocalDate(poolingrule.getStartTime(), employeeMap.get(poolingrule.getEmployeeID()).getTimeZone(poolingrule.getStartTime()));</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">						if (!hoursStartLocal.equals(effectiveDateStart)) {</span>
<span class="nc" id="L220">							pc_startDate.setIsMultiValue(true);</span>
						}
<span class="nc" id="L222">						LocalDate hoursEndLocal = null;</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">						if (poolingrule.getEndTime() != null) {</span>
<span class="nc" id="L224">							hoursEndLocal = new LocalDate(poolingrule.getEndTime(),</span>
<span class="nc" id="L225">									employeeMap.get(poolingrule.getEmployeeID()).getTimeZone(poolingrule.getEndTime()));</span>
						}
<span class="nc bnc" id="L227" title="All 10 branches missed.">						if ((hoursEndLocal == null &amp;&amp; effectiveDateEnd != null)</span>
								|| (hoursEndLocal != null &amp;&amp; effectiveDateEnd == null)
<span class="nc bnc" id="L229" title="All 2 branches missed.">								|| (hoursEndLocal != null &amp;&amp; !hoursEndLocal.equals(effectiveDateEnd))) {</span>
<span class="nc" id="L230">							pc_endDate.setIsMultiValue(true);</span>
						}
					}

<span class="nc" id="L234">					break;</span>
				}
<span class="nc" id="L236">			}</span>
<span class="nc" id="L237">			resetDisplayOfOrgSelPC(pc_orgSelPC, employeeIDs);</span>
<span class="nc" id="L238">		}</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">		pc_canPool.setIsChecked(!currentHoursAssignments.isEmpty());</span>

<span class="pc bpc" id="L241" title="1 of 2 branches missed.">		if (pc_startDate.isMultiValue() == false) {</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">			if (empStartDate != null) {</span>
<span class="fc" id="L243">				pc_startDate.setDate(empStartDate);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">			} else if (effectiveDateStart != null) {</span>
<span class="nc" id="L245">				pc_startDate.setDate(effectiveDateStart);</span>
			} else {  //This is a wierd case.  It only happens when employees have effective history but none of it covers the current view period.
<span class="nc" id="L247">				pc_startDate.setDate(viewPeriodStart);</span>
<span class="nc" id="L248">				effectiveDateStart = viewPeriodStart;</span>
			}
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">			if (effectiveDateEnd != null) {</span>
<span class="nc" id="L251">				LocalDate effectiveDateEndDisplay = new LocalDate(effectiveDateEnd);</span>
<span class="nc" id="L252">				pc_endDate.setDate(effectiveDateEndDisplay);</span>
			}
		}

<span class="pc bpc" id="L256" title="1 of 2 branches missed.">		if (currentHoursAssignments.isEmpty()) {</span>
<span class="fc" id="L257">			html_updateMode.setAttribute(&quot;value&quot;, DataContainerPC.UPDATE_MODE_2);</span>
		}
<span class="fc" id="L259">	}</span>

	/**
	 * If multiple employees are selected, the secondary orgs cannot show the orgs of the first
	 * employee in selection per the initialization of {@link #loadData()}; reset to show a * instead.
	 */
	protected void resetDisplayOfOrgSelPC(OrganizationSelectorPC pc_orgSelPC, Collection&lt;ID&gt; employeeIDs) {
<span class="nc bnc" id="L266" title="All 2 branches missed.">		if (employeeIDs.size() &gt; 1) {</span>
<span class="nc" id="L267">			pc_orgSelPC.setDisplayValue(&quot;*&quot;);</span>
		}
<span class="nc" id="L269">	}</span>

	/**
	 * Determines if the current hours record is &quot;current&quot;, in other words it applies to the current
	 * view period.  This is true if the start date of the hours lies before or at the view period start date
	 * and the hours end date is either null or lies after the view period start date.  Hours records are also
	 * current if they lie between the view start and end dates.
	 */
	private boolean isHoursRecordCurrent(EmpPoolingRule hours) {
		TimeZone empTimeZone;
<span class="nc" id="L279">		Employee emp = employeeMap.get(hours.getEmployeeID());</span>
		//Determine time zone of employee at record start
<span class="nc bnc" id="L281" title="All 2 branches missed.">		if (emp.getStartTime().after(hours.getStartTime())) {</span>
<span class="nc" id="L282">			empTimeZone = emp.getTimeZone(emp.getStartTime());</span>
		} else {
<span class="nc" id="L284">			empTimeZone = emp.getTimeZone(hours.getStartTime());</span>
		}
<span class="nc" id="L286">		LocalDate localEffectiveStart = new LocalDate(hours.getStartTime(), empTimeZone);</span>
<span class="nc" id="L287">		LocalDate localEffectiveEnd = null;</span>
		//Determine time zone of employee at record end
<span class="nc bnc" id="L289" title="All 2 branches missed.">		if (hours.getEndTime() != null) {</span>
<span class="nc bnc" id="L290" title="All 4 branches missed.">			if (emp.getEndTime() == null || emp.getEndTime().after(hours.getEndTime())) {</span>
<span class="nc" id="L291">				empTimeZone = emp.getTimeZone(hours.getEndTime());</span>
			} else {
<span class="nc" id="L293">				empTimeZone = emp.getTimeZone(emp.getEndTime());</span>
			}
<span class="nc" id="L295">			localEffectiveEnd = new LocalDate(hours.getEndTime(), empTimeZone);</span>
		}
<span class="nc bnc" id="L297" title="All 6 branches missed.">		return ((localEffectiveStart.before(viewPeriodStart) || localEffectiveStart.equals(viewPeriodStart))</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">				&amp;&amp; (localEffectiveEnd == null || localEffectiveEnd.after(viewPeriodStart))) ||</span>
<span class="nc bnc" id="L299" title="All 4 branches missed.">				(localEffectiveStart.after(viewPeriodStart) &amp;&amp; localEffectiveStart.before(viewPeriodEnd));</span>
	}

	private void setAllFieldsMultiEdit() {
<span class="nc" id="L303">		pc_canPool.setMultiEdit(true);</span>
<span class="nc" id="L304">		pc_minPaid.setMultiEdit(true);</span>
<span class="nc" id="L305">		pc_startDate.setIsMultiValue(true);</span>
<span class="nc" id="L306">		pc_endDate.setIsMultiValue(true);</span>
		//need to add more fields here.
<span class="nc" id="L308">	}</span>

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">		if (!extractParams) {</span>
<span class="nc" id="L313">			return true;</span>
		}
<span class="fc" id="L315">		String updateMode = request.getParameter(html_updateMode.getAttribute(&quot;name&quot;));</span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(updateMode)) {</span>
<span class="fc" id="L317">			html_updateMode.setAttribute(&quot;value&quot;, updateMode);</span>
		}
<span class="fc" id="L319">		String datesModified = request.getParameter(html_datesModified.getAttribute(&quot;name&quot;));</span>
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(datesModified)) {</span>
<span class="fc" id="L321">			html_datesModified.setAttribute(&quot;value&quot;, datesModified);</span>
		}
<span class="fc" id="L323">		return super.extractParameters(request);</span>
	}

	private EmpWorkRuleManager getEmpWorkRuleManager() throws BbmException {
<span class="fc" id="L327">		return WfmManagerFactory.getEmpWorkRuleManager(m_context.isInWhatIfMode());</span>
	}

	public void save() throws BbmException {
<span class="fc" id="L331">		boolean bCanPool = pc_canPool.isChecked();</span>
<span class="fc" id="L332">		EmpWorkRuleManager ewrm = getEmpWorkRuleManager();</span>

<span class="pc bpc" id="L334" title="1 of 2 branches missed.">		if (bCanPool) {</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">			boolean edited = pc_minPaid.isEdited()</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">					|| pc_orgSelPC.isEdited()</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">					|| &quot;true&quot;.equals(html_datesModified.getAttribute(&quot;value&quot;));</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">			if (edited) {</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">				for (Employee employee : employeeMap.values()) {</span>
<span class="nc" id="L340">					EmpPoolingRule wrmmh = currentHoursAssignments.get(employee.getID());</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">					if (wrmmh == null) {</span>
<span class="nc" id="L342">						wrmmh = new EmpPoolingRule();</span>
<span class="nc" id="L343">						wrmmh.setMinMinutes(0);</span>
					}
<span class="nc" id="L345">					wrmmh.setWorkResourceID(employee.getID());</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">					if (pc_minPaid.isEdited()) {</span>
<span class="nc" id="L347">						wrmmh.setMinMinutes(pc_minPaid.getDuration().getDurationInMinutes());</span>
					}

<span class="nc bnc" id="L350" title="All 2 branches missed.">					if (pc_orgSelPC.isEdited()) {</span>
<span class="nc" id="L351">						Collection&lt;ID&gt; ids = new ArrayList&lt;ID&gt;();</span>
						try {
<span class="nc" id="L353">							ids = pc_orgSelPC.getIDs();</span>
<span class="nc" id="L354">							pc_orgSelPC.initIDs(ids);</span>
<span class="nc" id="L355">						} catch (Exception e) {</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">							if (e instanceof BbmException) {</span>
<span class="nc" id="L357">								throw (BbmException) e;</span>
							}
<span class="nc" id="L359">							throw new BbmException(e);</span>
<span class="nc" id="L360">						}</span>
<span class="nc" id="L361">						wrmmh.setSecondaryOgs(ids);</span>
					}

					// The Date pickers do not have a value in the multi-edit scenario.
					// Additionally, they don't have an isedited property to determine
					// when we should use the date from the date picker and when it should
					// be used from the current assignment.
<span class="nc" id="L368">					LocalDate localStartDate = pc_startDate.getLocalDate();</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">					if (localStartDate == null) {</span>
						//The only way we could have a null date here is if we are in multi-edit and the date was not modified.
						// Just use the current assignment date in that case.
<span class="nc bnc" id="L372" title="All 2 branches missed.">						if (currentHoursAssignments.containsKey(employee.getID())) {</span>
<span class="nc" id="L373">							localStartDate = new LocalDate(</span>
<span class="nc" id="L374">									currentHoursAssignments.get(employee.getID()).getStartTime(),</span>
<span class="nc" id="L375">									employee.getTimeZone(currentHoursAssignments.get(employee.getID()).getStartTime()));</span>
						} else {
							//Employee does not have any hours records.  This record should therefore begin on his/her start date.
<span class="nc" id="L378">							localStartDate = employee.getStartTimeLocal();</span>
						}
					}
<span class="nc bnc" id="L381" title="All 2 branches missed.">					if (localStartDate.before(employee.getStartTimeLocal())) {</span>
<span class="nc" id="L382">						localStartDate = employee.getStartTimeLocal();</span>
					}
<span class="nc" id="L384">					wrmmh.setStartTime(localStartDate.getTime(</span>
<span class="nc" id="L385">							employee.getTimeZone(localStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE))));</span>
<span class="nc" id="L386">					LocalDate localEndDate = pc_endDate.getLocalDate();</span>
					//If end date coming back from the picker is null this could mean one of two things:
					// 1 - The picker was multi-edit and did not change.
					// 2 - The picker had its end date explicitly set to null (open-ended).
					// We need to check if the dates were modified, if they were, then that means the date
					// was explicitly set to null (otherwise they were unchanged and we can assume that the
					// picker remained in a multi-value state)
<span class="nc bnc" id="L393" title="All 2 branches missed.">					if (localEndDate == null) {</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">						if (&quot;true&quot;.equals(html_datesModified.getAttribute(&quot;value&quot;))) {</span>
<span class="nc" id="L395">							wrmmh.setEndTime(null);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">						} else if (currentHoursAssignments.containsKey(employee.getID()) &amp;&amp;</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">								currentHoursAssignments.get(employee.getID()).getEndTime() != null) {</span>
<span class="nc" id="L398">							localEndDate = new LocalDate(</span>
<span class="nc" id="L399">									currentHoursAssignments.get(employee.getID()).getEndTime(),</span>
<span class="nc" id="L400">									employee.getTimeZone(currentHoursAssignments.get(employee.getID()).getEndTime()));</span>
						}
					} else {
<span class="nc" id="L403">						localEndDate.add(Calendar.DATE, 1);    //Display date was inclusive, we need to add one day to get the value we should be comparing DB records against</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">						if (localEndDate.after(employee.getEndTimeLocal())) {</span>
<span class="nc" id="L405">							localEndDate = employee.getEndTimeLocal();</span>
						}
<span class="nc" id="L407">						wrmmh.setEndTime(localEndDate.getTime(</span>
<span class="nc" id="L408">								employee.getTimeZone(localEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE))));</span>
					}
					try {
<span class="nc bnc" id="L411" title="All 2 branches missed.">						if (DataContainerPC.UPDATE_MODE_1.equals(html_updateMode.getAttribute(&quot;value&quot;))) {</span>
<span class="nc" id="L412">							ewrm.updatePoolingRuleAssignment(wrmmh, true);</span>
						} else {
<span class="nc" id="L414">							ewrm.createPoolingRuleAssignment(wrmmh);</span>
						}
<span class="nc" id="L416">					} catch (Exception ex) {</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">						if (ex instanceof BbmException) {</span>
<span class="nc" id="L418">							throw (BbmException) ex;</span>
						}
<span class="nc" id="L420">						throw new BbmException(ex);</span>
<span class="nc" id="L421">					}</span>
<span class="nc" id="L422">				}</span>
			}
<span class="pc bpc" id="L424" title="2 of 4 branches missed.">		} else if (!bCanPool &amp;&amp; (employeeIDs.size() &gt; 0)) {</span>
			try {
<span class="fc" id="L426">				poolingRulesAssignments = ewrm.getPoolingRuleAssignments(employeeIDs, null, null);</span>
<span class="nc" id="L427">			} catch (Exception e) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">				if (e instanceof BbmFinderException) {</span>
<span class="nc" id="L429">					throw (BbmFinderException) e;</span>
				}
<span class="nc" id="L431">				throw new BbmFinderException(e);</span>
<span class="fc" id="L432">			}</span>

			// Find all current assignment objects
<span class="fc bfc" id="L435" title="All 2 branches covered.">			for (ID id : employeeIDs) {</span>
<span class="fc" id="L436">				List&lt;EmpPoolingRule&gt; poolingRulesList = poolingRulesAssignments.get(id);</span>
				// if pc_canPool is not checked and it's in multi-edit mode, check if pc_canPool is edited while in multi-edit mode.
				// if edited, we need to update the pooling rule assignments by deleting existing ones for employees selected.
				// if not edited, retain existing pooling rule assignments for employees selected.
<span class="pc bpc" id="L440" title="3 of 4 branches missed.">				if (poolingRulesList != null &amp;&amp; pc_canPool.isEdited()) {</span>
					try {
<span class="nc" id="L442">						ewrm.deletePoolingRuleAssignments(ValueObjectUtil.getIDFromObjects(poolingRulesList));</span>
<span class="nc" id="L443">					} catch (Exception e) {</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">						if (e instanceof BbmException) {</span>
<span class="nc" id="L445">							throw (BbmException) e;</span>
						}
<span class="nc" id="L447">						throw new BbmException(e);</span>
<span class="nc" id="L448">					}</span>
				}
<span class="fc" id="L450">			}</span>
			// set the org selector pc to empty
			try {
<span class="fc" id="L453">				pc_orgSelPC.setIDs(Collections.emptyList());</span>
<span class="nc" id="L454">			} catch (Exception e) {</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">				if (e instanceof BbmException) {</span>
<span class="nc" id="L456">					throw (BbmException) e;</span>
				}
<span class="nc" id="L458">				throw new BbmException(e);</span>
<span class="fc" id="L459">			}</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">		} else if (currentHoursAssignments.size() &gt; 0) {</span>
<span class="nc" id="L461">			Collection&lt;ID&gt; ids = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">			for (EmpPoolingRule poolingrule : currentHoursAssignments.values()) {</span>
<span class="nc" id="L463">				ids.add(poolingrule.getID());</span>
<span class="nc" id="L464">			}</span>
			try {
<span class="nc" id="L466">				ewrm.deletePoolingRuleAssignments(ids);</span>
<span class="nc" id="L467">			} catch (Exception ex) {</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">				if (ex instanceof BbmException) {</span>
<span class="nc" id="L469">					throw (BbmException) ex;</span>
				}
<span class="nc" id="L471">				throw new BbmException(ex);</span>
<span class="nc" id="L472">			}</span>
		}
<span class="fc" id="L474">	}</span>

	private void setEmpEndTime(Employee employee, EmpPoolingRule wrmmh) {
<span class="nc bnc" id="L477" title="All 2 branches missed.">		if (employee.getEndTime() != null) {</span>
<span class="nc" id="L478">			wrmmh.setEndTime(employee.getEndTimeLocal().getTime(</span>
<span class="nc" id="L479">					employee.getTimeZone(employee.getEndTimeLocal().getTime(TimeZoneUtil.GMT_TIMEZONE))));</span>
		} else {
<span class="nc" id="L481">			wrmmh.setEndTime(null);</span>
		}
<span class="nc" id="L483">	}</span>

	@Override
	public String getJavaScriptInitCode() {
<span class="fc" id="L487">		StringBuffer js = new StringBuffer();</span>
<span class="fc" id="L488">		js.append(super.getJavaScriptInitCode());</span>
<span class="fc" id="L489">		js.append(&quot;poolingRuleInitJS(); \n&quot;);</span>

<span class="fc" id="L491">		return js.toString();</span>
	}

	/**
	 * Generate Custom JavaScript Code
	 * &lt;p&gt;
	 * Default behavior is to retrieve sub-component JavaScript Init code
	 */
	public String getCustomJavaScript() {
<span class="fc" id="L500">		StringBuffer js = new StringBuffer();</span>
<span class="fc" id="L501">		js.append(super.getCustomJavaScript());</span>
<span class="fc" id="L502">		js.append(getPoolingRuleInitJS());</span>
<span class="fc" id="L503">		return js.toString();</span>
	}

	/**
	 * This JS is used to force the effective dates to snap to the view period if a duration spinner is modified
	 * when in campaign mode (essentially it will match the view period of the currently selected SP).
	 */
	private String getPoolingRuleInitJS() {
<span class="fc" id="L511">		StringBuffer js = new StringBuffer();</span>
<span class="fc" id="L512">		js.append(&quot;function poolingRuleInitJS() {\n&quot;);</span>
<span class="fc" id="L513">		js.append(&quot;if (document.getElementById('&quot;).append(pc_canPool.getInputID()).append(&quot;').checked) { \n&quot;);</span>
<span class="fc" id="L514">		js.append(&quot;\t &quot;).append(pc_minPaid.getName()).append(&quot;.setEnabled(true); \n&quot;);</span>
<span class="fc" id="L515">		js.append(&quot;\t jQuery('#toolbar_poolingRule__orgs_input_ID').show(); \n&quot;);</span>
<span class="fc" id="L516">		js.append(&quot;\t document.getElementById('poolingRule__startDate_editimage').style.visibility='visible'; ; \n&quot;);</span>
<span class="fc" id="L517">		js.append(&quot;}else {\n&quot;);</span>
<span class="fc" id="L518">		js.append(&quot;\t &quot;).append(pc_minPaid.getName()).append(&quot;.setEnabled(false); \n&quot;);</span>
<span class="fc" id="L519">		js.append(&quot;\t jQuery('#toolbar_poolingRule__orgs_input_ID').hide(); \n&quot;);</span>
<span class="fc" id="L520">		js.append(&quot;\t document.getElementById('poolingRule__startDate_editimage').style.visibility='hidden'; ; \n&quot;);</span>
<span class="fc" id="L521">		js.append(&quot;}\n&quot;);</span>
<span class="fc" id="L522">		js.append(&quot;}\n&quot;);</span>

<span class="fc" id="L524">		return js.toString();</span>
	}

	public Duration getMinPaid() {
<span class="nc" id="L528">		return pc_minPaid.getDuration();</span>
	}

	private void initializeRows() {

<span class="fc" id="L533">		addRowData(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.POOLING_RULES_EMPLOYEE_CAN_POOL),</span>
<span class="fc" id="L534">				pc_canPool.getHtmlDisplay(),</span>
				null,
				null);

<span class="fc" id="L538">		addRowData(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.POOLING_RULES_SECOND_ORGS),</span>
<span class="fc" id="L539">				pc_orgSelPC.toString(),</span>
<span class="fc" id="L540">				m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.POOLING_RULES_MIN_HOURS),</span>
<span class="fc" id="L541">				pc_minPaid.toString());</span>

<span class="fc" id="L543">		final StringBuffer editIconHtml = new StringBuffer();</span>
<span class="fc" id="L544">		editIconHtml.append(HtmlUtil.imageTag(&quot;poolingRule__startDate_editimage&quot;, ImageFileID.EDIT, ImageFileID.EDIT_WIDTH,</span>
<span class="fc" id="L545">				ImageFileID.EDIT_HEIGHT, m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.EDIT), null, null, false))</span>
<span class="fc" id="L546">				.append(&quot; onClick=\&quot;&quot;).append(pc_toolbar.getName()).append(&quot;.onSelect('&quot;).append(PoolingRulesPopupPM.POOLINGRULES_POPUP_ID).append(&quot;',this)\&quot; &quot;)</span>
<span class="fc" id="L547">				.append(&quot;actionType=\&quot;POPUP_WINDOW_TYPE\&quot;&quot;)</span>
<span class="fc" id="L548">				.append(&quot;&gt;&quot;);</span>

<span class="fc" id="L550">		SimpleDateFormat sdf = new SimpleDateFormat(m_context.getLocalizer().getDateInputFormat(), m_context.getLocalizer().getLocaleContext().getRegionalFormatLocale());</span>
<span class="fc" id="L551">		StringBuffer args = new StringBuffer(&quot;selectedID=&quot;).append(StringUtil.createDelimitedString(employeeIDs.toArray(new ID[employeeIDs.size()]), &quot;%2C&quot;));</span>
<span class="fc" id="L552">		args.append(&quot;&amp;&quot;).append(PoolingRulesPopupPM.PARAM_START).append(&quot;=&quot;).append(viewPeriodStart.getTime(TimeZoneUtil.GMT_TIMEZONE).getTime());</span>
		//End date is inclusive
<span class="fc" id="L554">		LocalDate viewPeriodEndDisplay = new LocalDate(viewPeriodEnd);</span>
<span class="fc" id="L555">		viewPeriodEndDisplay.add(Calendar.DATE, -1);</span>
<span class="fc" id="L556">		args.append(&quot;&amp;&quot;).append(PoolingRulesPopupPM.PARAM_END).append(&quot;=&quot;).append(viewPeriodEndDisplay.getTime(TimeZoneUtil.GMT_TIMEZONE).getTime());</span>
<span class="fc" id="L557">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_PERIOD_ONLY).append(&quot;=&quot;).append(false/*onlyPeriodEditable*/);</span>
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">		if (employeeIDs.size() &gt; 1) {    //If in multi-edit mode, we will only be editing along the view date ranges</span>
<span class="nc" id="L559">			args.append(&quot;&amp;CUR_PERIOD_START=&quot; /* Defined in DataContainerPC */).append(sdf.format(viewPeriodStart.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
<span class="nc" id="L560">			args.append(&quot;&amp;CUR_PERIOD_END=&quot; /* Defined in DataContainerPC */).append(sdf.format(viewPeriodEndDisplay.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
		} else {
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">			if (effectiveDateStart != null) {</span>
<span class="nc" id="L563">				args.append(&quot;&amp;CUR_PERIOD_START=&quot; /* Defined in DataContainerPC */).append(sdf.format(effectiveDateStart.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
			}
<span class="pc bpc" id="L565" title="1 of 2 branches missed.">			if (effectiveDateEnd != null) {</span>
<span class="nc" id="L566">				LocalDate effectiveDateEndDisplay = new LocalDate(effectiveDateEnd);</span>
<span class="nc" id="L567">				effectiveDateEndDisplay.add(Calendar.DATE, -1);</span>
<span class="nc" id="L568">				args.append(&quot;&amp;CUR_PERIOD_END=&quot; /* Defined in DataContainerPC */).append(sdf.format(effectiveDateEndDisplay.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
			}
		}
<span class="fc" id="L571">		args.append(&quot;&amp;PERIOD_START=&quot; /* Defined in DataContainerPC */).append(sdf.format(viewPeriodStart.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
<span class="fc" id="L572">		args.append(&quot;&amp;PERIOD_END=&quot; /* Defined in DataContainerPC */).append(sdf.format(viewPeriodEndDisplay.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
<span class="fc" id="L573">		args.append(&quot;&amp;&quot;).append(ProfilePageModel.SHOW_AS_DATE_FN).append(&quot;=&quot;).append(sdf.format(viewPeriodStart.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
<span class="fc" id="L574">		args.append(&quot;&amp;&quot;).append(PoolingRulesPopupPM.PARAM_START_NAME).append(&quot;=&quot;).append(pc_startDate.getDateInputFieldName());</span>
<span class="fc" id="L575">		args.append(&quot;&amp;&quot;).append(PoolingRulesPopupPM.PARAM_END_NAME).append(&quot;=&quot;).append(pc_endDate.getDateInputFieldName());</span>
<span class="fc" id="L576">		args.append(&quot;&amp;&quot;).append(PoolingRulesPopupPM.PARAM_MIN_PAID_NAME).append(&quot;=&quot;).append(pc_minPaid.getName());</span>
<span class="fc" id="L577">		args.append(&quot;&amp;&quot;).append(PoolingRulesPopupPM.PARAM_SECOND_ORGIDs).append(&quot;=&quot;).append(pc_orgSelPC.getName());</span>
<span class="fc" id="L578">		args.append(&quot;&amp;&quot;).append(PoolingRulesPopupPM.PARAM_ORGIDs).append(&quot;=&quot;).append(strOrgIDs);</span>

<span class="fc" id="L580">		args.append(&quot;&amp;&quot;).append(PoolingRulesPopupPM.PARAM_UPDATE_MODE_NAME).append(&quot;=&quot;).append(html_updateMode.getAttribute(&quot;name&quot;));</span>
<span class="fc" id="L581">		args.append(&quot;&amp;&quot;).append(PoolingRulesPopupPM.PARAM_DATES_MODIFIED_NAME).append(&quot;=&quot;).append(html_datesModified.getAttribute(&quot;name&quot;));</span>


<span class="fc" id="L584">		addPopupArgs(PoolingRulesPopupPM.POOLINGRULES_POPUP_ID, &quot;work_rules_assignment_poolingrules_popup&quot;, args.toString(), html_updateMode.getAttribute(&quot;name&quot;), &quot;1000,600,ctr,ctr&quot;, true, 1);</span>
<span class="fc" id="L585">		addRowData(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_START_DATE),</span>
<span class="fc" id="L586">				pc_startDate.toString() + editIconHtml.toString() + html_updateMode.toString() + html_datesModified.toString(),</span>
<span class="fc" id="L587">				m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_END_DATE),</span>
<span class="fc" id="L588">				pc_endDate.toString());</span>

<span class="fc" id="L590">	}</span>

	public boolean validate() {
<span class="fc" id="L593">		boolean success = super.validate();</span>

<span class="pc bpc" id="L595" title="2 of 4 branches missed.">		if (pc_canPool != null &amp;&amp; pc_canPool.isChecked()) {</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">			if (pc_orgSelPC.getIDs().isEmpty()) {</span>
<span class="nc" id="L597">				addPageMessage(Message.WARNING_TYPE, m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.POOLING_RULES_MUST_HAVE_ORGS));</span>
			}
		}

<span class="fc" id="L601">		return success;</span>
	}

	public void setFirstDayOfWeek(int val) {
<span class="fc" id="L605">		pc_startDate.setFirstDayOfWeek(val);</span>
<span class="fc" id="L606">		pc_endDate.setFirstDayOfWeek(val);</span>
<span class="fc" id="L607">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>