<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>HoursPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">HoursPC.java</span></div><h1>HoursPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.ArrayUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.EmpWorkRuleManager;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceMinMaxHour;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.people.profile.ProfilePageModel;
import com.bluepumpkin.web.bbm.people.profile.effectivedate.DataContainerPC;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.web.uif.jsp.HtmlInput;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.form.FormFourColumnPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.DurationSpinnerPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;

public class HoursPC extends FormFourColumnPC {
	private static final long serialVersionUID = 1L;

	// Page Components
	private ToolbarPC pc_toolbar;
	private DurationSpinnerPC  pc_minPaid, pc_maxPaid, pc_otPerDay, pc_otPerWeek, pc_vtoPerDay, pc_vtoPerWeek;
	private DatePickerPC pc_startDate, pc_endDate;
	private HtmlInput html_updateMode, html_datesModified;
	
	// Data
<span class="fc" id="L56">	private Collection&lt;ID&gt; employeeIDs = Collections.emptyList();</span>
	//key = employee ID
	private Map&lt;ID, Employee&gt; employeeMap;
	private LocalDate viewPeriodStart, viewPeriodEnd;
<span class="fc" id="L60">	private LocalDate effectiveDateStart = null;</span>
<span class="fc" id="L61">	private LocalDate effectiveDateEnd = null;</span>
<span class="fc" id="L62">	private LocalDate empStartDate = null;</span>
<span class="fc" id="L63">	private Map&lt;ID, List&lt;WorkResourceMinMaxHour&gt;&gt; hoursAssignments = Collections.emptyMap();</span>
<span class="fc" id="L64">	private Map&lt;ID, WorkResourceMinMaxHour&gt; currentHoursAssignments = new HashMap&lt;ID, WorkResourceMinMaxHour&gt;();</span>
	private boolean onlyPeriodEditable;
<span class="fc" id="L66">	private boolean extractParams = true;</span>
	
	private Map&lt;ID, List&lt;Integer&gt;&gt; authorizedViewFields;
	private Map&lt;ID, List&lt;Integer&gt;&gt; authorizedEditFields;

	public HoursPC(RequestContext context, Collection&lt;ID&gt; employeeIDs, Map&lt;ID, Employee&gt; employeeMap, 
			LocalDate viewPeriodStart, LocalDate viewPeriodEnd, boolean onlyPeriodEditable, boolean extractParams) throws BbmFinderException {
<span class="fc" id="L73">		super(context);</span>
<span class="fc" id="L74">		this.onlyPeriodEditable = onlyPeriodEditable;</span>
<span class="fc" id="L75">		setName(&quot;hoursPC&quot;);</span>
<span class="fc" id="L76">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="fc" id="L77">		this.pc_toolbar = new ToolbarPC(m_context);</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">		if (employeeIDs != null) {</span>
<span class="fc" id="L79">			this.employeeIDs = employeeIDs;</span>
		}
<span class="fc" id="L81">		this.viewPeriodStart = viewPeriodStart;</span>
<span class="fc" id="L82">		this.viewPeriodEnd = viewPeriodEnd;</span>
<span class="fc" id="L83">		this.extractParams = extractParams;</span>
<span class="fc" id="L84">		this.employeeMap = employeeMap;</span>
		
<span class="fc" id="L86">		initializeSecureFieldMetaData();</span>
		
<span class="fc" id="L88">		pc_minPaid = new DurationSpinnerPC(m_context, &quot;hoursPC__minPaid&quot;);</span>
<span class="fc" id="L89">		pc_minPaid.setMaxTime(99, 45, 0);</span>
<span class="fc" id="L90">		pc_minPaid.setMinutesIncrement(15);</span>
<span class="fc" id="L91">		pc_minPaid.setEnabled(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MINMAXPAIDHOURS));</span>
<span class="fc" id="L92">		pc_minPaid.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_MINMAXPAIDHOURS));</span>
<span class="fc" id="L93">		addChildComponent(pc_minPaid);</span>
		
<span class="fc" id="L95">		pc_maxPaid = new DurationSpinnerPC(m_context, &quot;hoursPC__maxPaid&quot;);</span>
<span class="fc" id="L96">		pc_maxPaid.setMaxTime(99, 45, 0);</span>
<span class="fc" id="L97">		pc_maxPaid.setMinutesIncrement(15);</span>
<span class="fc" id="L98">		pc_maxPaid.setEnabled(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MINMAXPAIDHOURS));</span>
<span class="fc" id="L99">		pc_maxPaid.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_MINMAXPAIDHOURS));</span>
<span class="fc" id="L100">		addChildComponent(pc_maxPaid);</span>
		
<span class="fc" id="L102">		pc_otPerDay = new DurationSpinnerPC(m_context, &quot;hoursPC__otPerDay&quot;);</span>
<span class="fc" id="L103">		pc_otPerDay.setMaxTime(24, 0, 0);</span>
<span class="fc" id="L104">		pc_otPerDay.setMinutesIncrement(15);</span>
<span class="fc" id="L105">		pc_otPerDay.setEnabled(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXOTMINSPERDAY));</span>
<span class="fc" id="L106">		pc_otPerDay.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXOTMINSPERDAY));</span>
<span class="fc" id="L107">		addChildComponent(pc_otPerDay);</span>
		
<span class="fc" id="L109">		pc_otPerWeek = new DurationSpinnerPC(m_context, &quot;hoursPC__otPerWeek&quot;);</span>
<span class="fc" id="L110">		pc_otPerWeek.setMaxTime(99, 45, 0);</span>
<span class="fc" id="L111">		pc_otPerWeek.setMinutesIncrement(15);</span>
<span class="fc" id="L112">		pc_otPerWeek.setEnabled(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXOTMINSPERWEEK));</span>
<span class="fc" id="L113">		pc_otPerWeek.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXOTMINSPERWEEK));</span>
<span class="fc" id="L114">		addChildComponent(pc_otPerWeek);</span>
		
<span class="fc" id="L116">		pc_vtoPerDay = new DurationSpinnerPC(m_context, &quot;hoursPC__vtoPerDay&quot;);</span>
<span class="fc" id="L117">		pc_vtoPerDay.setMaxTime(24, 0, 0);</span>
<span class="fc" id="L118">		pc_vtoPerDay.setMinutesIncrement(15);</span>
<span class="fc" id="L119">		pc_vtoPerDay.setEnabled(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXVTOHOURSPERDAY));</span>
<span class="fc" id="L120">		pc_vtoPerDay.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXVTOHOURSPERDAY));</span>
<span class="fc" id="L121">		addChildComponent(pc_vtoPerDay);</span>
		
<span class="fc" id="L123">		pc_vtoPerWeek = new DurationSpinnerPC(m_context, &quot;hoursPC__vtoPerWeek&quot;);</span>
<span class="fc" id="L124">		pc_vtoPerWeek.setMaxTime(99, 45, 0);</span>
<span class="fc" id="L125">		pc_vtoPerWeek.setMinutesIncrement(15);</span>
<span class="fc" id="L126">		pc_vtoPerWeek.setEnabled(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXVTOHOURSPERWEEK));</span>
<span class="fc" id="L127">		pc_vtoPerWeek.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXVTOHOURSPERWEEK));</span>
<span class="fc" id="L128">		addChildComponent(pc_vtoPerWeek);</span>
		
<span class="fc" id="L130">		html_datesModified = new HtmlInput(&quot;hoursPC__datesModified&quot;, &quot;false&quot;, &quot;hidden&quot;); </span>
<span class="pc bpc" id="L131" title="1 of 4 branches missed.">		html_updateMode = new HtmlInput(&quot;hoursPC__updateMode&quot;, onlyPeriodEditable || employeeIDs.size() &gt; 1 ? DataContainerPC.UPDATE_MODE_2 : DataContainerPC.UPDATE_MODE_1, &quot;hidden&quot;);</span>
<span class="fc" id="L132">		pc_startDate = new DatePickerPC(m_context, &quot;hoursPC__startDate_input&quot;);</span>
<span class="fc" id="L133">		pc_startDate.setName(&quot;hoursPC__startDate&quot;);</span>
<span class="fc" id="L134">		pc_startDate.setEnabled(false);</span>
<span class="fc" id="L135">		pc_startDate.setIsPickerEnabled(false);</span>
<span class="fc" id="L136">		pc_startDate.setIsControlEnabled(false);</span>
<span class="fc" id="L137">		pc_startDate.setIsMultiValueSupported(true);</span>
<span class="fc" id="L138">		addChildComponent(pc_startDate);</span>
		
<span class="fc" id="L140">		pc_endDate = new DatePickerPC(m_context, &quot;hoursPC__endDate_input&quot;);</span>
<span class="fc" id="L141">		pc_endDate.setName(&quot;hoursPC__endDate&quot;);</span>
<span class="fc" id="L142">		pc_endDate.setEnabled(false);</span>
<span class="fc" id="L143">		pc_endDate.setIsPickerEnabled(false);</span>
<span class="fc" id="L144">		pc_endDate.setIsControlEnabled(false);</span>
<span class="fc" id="L145">		pc_endDate.setIsDateValueOptional(true);</span>
<span class="fc" id="L146">		pc_endDate.setIsMultiValueSupported(true);</span>
<span class="fc" id="L147">		pc_endDate.setDate((LocalDate)null);</span>
<span class="fc" id="L148">		addChildComponent(pc_endDate);</span>

<span class="fc" id="L150">		loadData();</span>

<span class="fc" id="L152">		extractParameters(m_context.getRequest());</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">		if (&quot;true&quot;.equals(html_datesModified.getAttribute(&quot;value&quot;))) {</span>
			//This is a hack to prevent the date picker from redrawing the &quot;*&quot; on a postback
			//For some reason this does not get reset via extract params in DatePickerPC
<span class="fc" id="L156">			pc_endDate.setIsMultiValue(false);</span>
		}

<span class="fc" id="L159">		setTitle(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_HOURS_TITLE));</span>
<span class="fc" id="L160">		initializeRows();</span>
<span class="fc" id="L161">	}</span>
	
	/**
	 * Initializes the secure field meta data for use in determining viewability/editability of certain fields.
	 */
	private void initializeSecureFieldMetaData() {
<span class="fc" id="L167">		authorizedViewFields = new HashMap&lt;ID, List&lt;Integer&gt;&gt;();</span>
<span class="fc" id="L168">		authorizedEditFields = new HashMap&lt;ID, List&lt;Integer&gt;&gt;();</span>
		
<span class="fc bfc" id="L170" title="All 2 branches covered.">		for(Employee emp : employeeMap.values()) {</span>
<span class="fc" id="L171">			int[] viewableFields = </span>
<span class="fc" id="L172">				m_context.getUser().getAuthorizedFields(</span>
						PrivilegeKeys.CORE_VIEWSECUREFIELD, 
<span class="fc" id="L174">						new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE));</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">			if (viewableFields == null) {</span>
<span class="nc" id="L176">				viewableFields = new int[0];</span>
			}
			
<span class="fc" id="L179">			int[] editableFields = </span>
<span class="fc" id="L180">				m_context.getUser().getAuthorizedFields(</span>
						PrivilegeKeys.CORE_EDITSECUREFIELD, 
<span class="fc" id="L182">						new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE));</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">			if (editableFields == null) {</span>
<span class="nc" id="L184">				editableFields = new int[0];</span>
			}
			
<span class="fc" id="L187">			authorizedViewFields.put(emp.getID(), ArrayUtil.asList(viewableFields));</span>
<span class="fc" id="L188">			authorizedEditFields.put(emp.getID(), ArrayUtil.asList(editableFields));</span>
<span class="fc" id="L189">		}</span>
<span class="fc" id="L190">	}</span>
	
	public void setEnabled(boolean enabled) {
<span class="nc" id="L193">		super.setEnabled(enabled);</span>
<span class="nc" id="L194">		pc_maxPaid.setEnabled(enabled);</span>
<span class="nc" id="L195">		pc_minPaid.setEnabled(enabled);</span>
<span class="nc" id="L196">	}</span>
	
	/**
	 * Returns whether a field is EDITABLE based on the current user and employees/scope selected.
	 * @param secureFieldInfoId Secure field info {@link com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo SecureFieldInfo}
	 * @return boolean
	 */
	private boolean isFieldEditable(int secureFieldInfoId) {
		// If the field is not viewable then we don't even need to check
		// further for editability.
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">		if (!isFieldViewable(secureFieldInfoId)) {</span>
<span class="nc" id="L207">			return false;</span>
		}
		
<span class="fc bfc" id="L210" title="All 2 branches covered.">		for (Employee emp : employeeMap.values()) {</span>
			// Just looking for any employee in the selection that doesn't permit EDITING
			// because we can't permit more access than the lowest permitted or actions
			// can be taken that shouldn't be allowed for some of the employees.
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">			if(authorizedEditFields.containsKey(emp.getID())) {</span>
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">				if(!authorizedEditFields.get(emp.getID()).contains(secureFieldInfoId)) {</span>
					// This field is not EDITABLE for this employee and scope so 
					// we cannot permit the field to be EDITABLE for the selected
					// employees.
<span class="nc" id="L219">					return false;</span>
				}
			} // If the employee doesn't have any secured field information let's assume they can be accessed.
<span class="fc" id="L222">		}</span>
<span class="fc" id="L223">		return true;</span>
	}
	
	/**
	 * Returns whether a field is VIEWABLE based on the current user and employees/scope selected.
	 * @param secureFieldInfoId Secure field info {@link com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo SecureFieldInfo}
	 * @return boolean
	 */
	private boolean isFieldViewable(int secureFieldInfoId) {
<span class="fc bfc" id="L232" title="All 2 branches covered.">		for(Employee emp : employeeMap.values()) {</span>
			// Just looking for any employee in the selection that doesn't permit VIEWING
			// because we can't permit more access than the lowest permitted or actions
			// can be taken that shouldn't be allowed for some of the employees.
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">			if(authorizedViewFields.containsKey(emp.getID())) {</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">				if(!authorizedViewFields.get(emp.getID()).contains(secureFieldInfoId)) {</span>
					// This field is not VIEWABLE for this employee and scope so 
					// we cannot permit the field to be VIEWABLE for the selected
					// employees.
<span class="nc" id="L241">					return false;</span>
				}
			} // If the employee doesn't have any secured field information let's assume they can be accessed.
<span class="fc" id="L244">		}</span>
<span class="fc" id="L245">		return true;</span>
	}
	
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc bfc" id="L250" title="All 2 branches covered.">		if (!extractParams) {</span>
<span class="fc" id="L251">			return true;</span>
		}
<span class="fc" id="L253">		String updateMode = request.getParameter(html_updateMode.getAttribute(&quot;name&quot;));</span>
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(updateMode)) {</span>
<span class="fc" id="L255">			html_updateMode.setAttribute(&quot;value&quot;, updateMode);</span>
		}
<span class="fc" id="L257">		String datesModified = request.getParameter(html_datesModified.getAttribute(&quot;name&quot;));</span>
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(datesModified)) {</span>
<span class="fc" id="L259">			html_datesModified.setAttribute(&quot;value&quot;, datesModified);</span>
		}
<span class="fc" id="L261">		return super.extractParameters(request);</span>
	}

	@Override
	public void setName(String name) {
<span class="fc" id="L266">		super.setName(name);</span>
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">		if (pc_minPaid != null) {</span>
<span class="nc" id="L268">			pc_minPaid.setName(name + &quot;__minPaid&quot;);</span>
		}
		
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">		if (pc_maxPaid != null) {</span>
<span class="nc" id="L272">			pc_maxPaid.setName(name + &quot;__maxPaid&quot;);</span>
		}
		
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">		if (pc_otPerDay != null) {</span>
<span class="nc" id="L276">			pc_otPerDay.setName(name + &quot;__otPerDay&quot;);</span>
		}
		
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">		if (pc_otPerWeek != null) {</span>
<span class="nc" id="L280">			pc_otPerWeek.setName(name + &quot;__otPerWeek&quot;);</span>
		}
		
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">		if (pc_vtoPerDay != null) {</span>
<span class="nc" id="L284">			pc_vtoPerDay.setName(name + &quot;__vtoPerDay&quot;);</span>
		}
		
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">		if (pc_vtoPerWeek != null) {</span>
<span class="nc" id="L288">			pc_vtoPerWeek.setName(name + &quot;__vtoPerWeek&quot;);</span>
		}
		
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">		if (html_updateMode != null) {</span>
<span class="nc" id="L292">			html_updateMode.setAttribute(&quot;name&quot;, name +  &quot;__updateMode&quot;);</span>
		}
		
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">		if (html_datesModified != null) {</span>
<span class="nc" id="L296">			html_datesModified.setAttribute(&quot;name&quot;, name + &quot;__datesModified&quot;);</span>
		}
		
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">		if (pc_startDate != null) {</span>
<span class="nc" id="L300">			pc_startDate.setName(name + &quot;__startDate&quot;);</span>
		}
		
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">		if (pc_endDate != null) {</span>
<span class="nc" id="L304">			pc_endDate.setName(name + &quot;__endDate&quot;);</span>
		}
<span class="fc" id="L306">	}</span>

	private void loadData() throws BbmFinderException {
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">		if (employeeIDs.size() == 0) { return; }</span>
		EmpWorkRuleManager ewrm;
		try {
<span class="fc" id="L312">			ewrm = WfmManagerFactory.getEmpWorkRuleManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L313">			hoursAssignments = ewrm.getMinMaxHourAssignments(employeeIDs, null, null);</span>
<span class="nc" id="L314">		} catch (Exception e) {</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">			if (e instanceof BbmFinderException) throw (BbmFinderException) e;</span>
<span class="nc" id="L316">			throw new BbmFinderException(e);</span>
<span class="fc" id="L317">		}</span>
		
<span class="fc" id="L319">		Duration biggestMinPaid = Duration.fromMinutes(0);</span>
<span class="fc" id="L320">		Duration smallestMaxPaid = Duration.fromMinutes(Integer.MAX_VALUE);</span>
<span class="fc" id="L321">		Duration biggestOTPerDay = Duration.fromMinutes(0);</span>
<span class="fc" id="L322">		Duration smallestOTPerWeek = Duration.fromMinutes(Integer.MAX_VALUE);</span>
<span class="fc" id="L323">		Duration biggestVTOPerDay = Duration.fromMinutes(0);</span>
<span class="fc" id="L324">		Duration smallestVTOPerWeek = Duration.fromMinutes(Integer.MAX_VALUE);</span>
		
<span class="fc" id="L326">		boolean first = true;</span>
		// Find all current assignment objects
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">		for (ID id : employeeIDs) {</span>
<span class="fc" id="L329">			List&lt;WorkResourceMinMaxHour&gt; hoursList = hoursAssignments.get(id);</span>
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">			if (hoursList == null) {</span>
<span class="fc bfc" id="L331" title="All 2 branches covered.">				if (employeeIDs.size() &gt; 1) {</span>
<span class="fc" id="L332">					setAllFieldsMultiEdit();</span>
				} else {
					try {
<span class="fc" id="L335">						empStartDate = employeeMap.values().iterator().next().getStartTimeLocal();</span>
<span class="nc" id="L336">					} catch (Exception ex) {</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">						if (ex instanceof BbmFinderException) {</span>
<span class="nc" id="L338">							throw (BbmFinderException) ex;</span>
						}
<span class="nc" id="L340">						throw new BbmFinderException(ex);</span>
<span class="fc" id="L341">					}</span>
				}
				break;
			}
<span class="nc" id="L345">			boolean foundCurrentRecordForEmployee = false;</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">			for (WorkResourceMinMaxHour hours : hoursList) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">				if (isHoursRecordCurrent(hours)) {</span>
<span class="nc" id="L348">					currentHoursAssignments.put(id, hours);</span>
<span class="nc" id="L349">					foundCurrentRecordForEmployee = true;</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">					if (first) {</span>
<span class="nc" id="L351">						first = false;</span>
<span class="nc" id="L352">						pc_minPaid.setValue(Duration.fromMinutes(hours.getMinMinutes()));</span>
<span class="nc" id="L353">						pc_maxPaid.setValue(Duration.fromMinutes(hours.getMaxMinutes()));</span>
<span class="nc" id="L354">						pc_otPerDay.setValue(Duration.fromMinutes(hours.getMaxOTMinutesPerDay()));</span>
<span class="nc" id="L355">						pc_otPerWeek.setValue(Duration.fromMinutes(hours.getMaxOTMinutesPerWeek()));</span>
<span class="nc" id="L356">						pc_vtoPerDay.setValue(Duration.fromMinutes(hours.getMaxVTOHoursPerDay()));</span>
<span class="nc" id="L357">						pc_vtoPerWeek.setValue(Duration.fromMinutes(hours.getMaxVTOHoursPerWeek()));</span>
<span class="nc" id="L358">						effectiveDateStart = new LocalDate(hours.getStartTime(),</span>
<span class="nc" id="L359">								employeeMap.get(hours.getWorkResourceID()).getTimeZone(hours.getStartTime()));</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">						if (hours.getEndTime() != null) {</span>
<span class="nc" id="L361">							effectiveDateEnd = new LocalDate(hours.getEndTime(),</span>
<span class="nc" id="L362">									employeeMap.get(hours.getWorkResourceID()).getTimeZone(hours.getEndTime()));</span>
						}
					} else {
<span class="nc bnc" id="L365" title="All 2 branches missed.">						if (hours.getMinMinutes() != pc_minPaid.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L366">							pc_minPaid.setMultiEdit(true);</span>
						}
						
<span class="nc bnc" id="L369" title="All 2 branches missed.">						if (hours.getMaxMinutes() != pc_maxPaid.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L370">							pc_maxPaid.setMultiEdit(true);</span>
						}
						
<span class="nc bnc" id="L373" title="All 2 branches missed.">						if (hours.getMaxOTMinutesPerDay() != pc_otPerDay.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L374">							pc_otPerDay.setMultiEdit(true);</span>
						}
						
<span class="nc bnc" id="L377" title="All 2 branches missed.">						if (hours.getMaxOTMinutesPerWeek() != pc_otPerWeek.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L378">							pc_otPerWeek.setMultiEdit(true);</span>
						}
						
<span class="nc bnc" id="L381" title="All 2 branches missed.">						if (hours.getMaxVTOHoursPerDay() != pc_vtoPerDay.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L382">							pc_vtoPerDay.setMultiEdit(true);</span>
						}
						
<span class="nc bnc" id="L385" title="All 2 branches missed.">						if (hours.getMaxVTOHoursPerWeek() != pc_vtoPerWeek.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L386">							pc_vtoPerWeek.setMultiEdit(true);</span>
						}
						
<span class="nc" id="L389">						LocalDate hoursStartLocal = new LocalDate(hours.getStartTime(), employeeMap.get(hours.getWorkResourceID()).getTimeZone(hours.getStartTime()));</span>
						
<span class="nc bnc" id="L391" title="All 2 branches missed.">						if (!hoursStartLocal.equals(effectiveDateStart)) {</span>
<span class="nc" id="L392">							pc_startDate.setIsMultiValue(true);</span>
						}
						
<span class="nc" id="L395">						LocalDate hoursEndLocal = null;</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">						if (hours.getEndTime() != null) {</span>
<span class="nc" id="L397">							hoursEndLocal = new LocalDate(hours.getEndTime(),</span>
<span class="nc" id="L398">									employeeMap.get(hours.getWorkResourceID()).getTimeZone(hours.getEndTime()));</span>
						}
<span class="nc bnc" id="L400" title="All 10 branches missed.">						if ((hoursEndLocal == null &amp;&amp; effectiveDateEnd != null) </span>
								|| (hoursEndLocal!= null &amp;&amp; effectiveDateEnd == null)
<span class="nc bnc" id="L402" title="All 2 branches missed.">								|| (hoursEndLocal != null &amp;&amp; !hoursEndLocal.equals(effectiveDateEnd))) pc_endDate.setIsMultiValue(true);</span>
					}
					
<span class="nc bnc" id="L405" title="All 2 branches missed.">					if (hours.getMinMinutes() &gt; biggestMinPaid.getDurationInMinutes()) {</span>
<span class="nc" id="L406">						biggestMinPaid = Duration.fromMinutes(hours.getMinMinutes());</span>
					}
					
<span class="nc bnc" id="L409" title="All 2 branches missed.">					if (hours.getMaxMinutes() &lt; smallestMaxPaid.getDurationInMinutes()) {</span>
<span class="nc" id="L410">						smallestMaxPaid = Duration.fromMinutes(hours.getMaxMinutes());</span>
					}
					
<span class="nc bnc" id="L413" title="All 2 branches missed.">					if (hours.getMaxOTMinutesPerDay() &gt; biggestOTPerDay.getDurationInMinutes()) {</span>
<span class="nc" id="L414">						biggestOTPerDay = Duration.fromMinutes(hours.getMaxOTMinutesPerDay());</span>
					}
					
<span class="nc bnc" id="L417" title="All 2 branches missed.">					if (hours.getMaxOTMinutesPerWeek() &lt; smallestOTPerWeek.getDurationInMinutes()) {</span>
<span class="nc" id="L418">						smallestOTPerWeek = Duration.fromMinutes(hours.getMaxOTMinutesPerWeek());</span>
					}
					
<span class="nc bnc" id="L421" title="All 2 branches missed.">					if (hours.getMaxVTOHoursPerDay() &gt; biggestVTOPerDay.getDurationInMinutes()) {</span>
<span class="nc" id="L422">						biggestVTOPerDay = Duration.fromMinutes(hours.getMaxVTOHoursPerDay());</span>
					}
					
<span class="nc bnc" id="L425" title="All 2 branches missed.">					if (hours.getMaxVTOHoursPerWeek() &lt; smallestVTOPerWeek.getDurationInMinutes()) {</span>
<span class="nc" id="L426">						smallestVTOPerWeek = Duration.fromMinutes(hours.getMaxVTOHoursPerWeek());</span>
					}
					
					break;
				} // if hours record is current
<span class="nc" id="L431">			} // for each employees hoursList</span>
<span class="nc bnc" id="L432" title="All 4 branches missed.">			if (employeeIDs.size() &gt; 1 &amp;&amp; !foundCurrentRecordForEmployee) {</span>
<span class="nc" id="L433">				setAllFieldsMultiEdit();</span>
			}
<span class="nc" id="L435">			resetMultiEditFields();</span>
<span class="nc" id="L436">		} // for all employees</span>
		
<span class="fc bfc" id="L438" title="All 2 branches covered.">		if (pc_startDate.isMultiValue() == false) {</span>
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">			if (empStartDate != null) {</span>
<span class="fc" id="L440">				pc_startDate.setDate(empStartDate);</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">			} else if (effectiveDateStart != null) {</span>
<span class="nc" id="L442">				pc_startDate.setDate(effectiveDateStart);</span>
			} else {	//This is a wierd case.  It only happens when employees have effective history but none of it covers the current view period.
<span class="nc" id="L444">				pc_startDate.setDate(viewPeriodStart);</span>
<span class="nc" id="L445">				effectiveDateStart = viewPeriodStart;</span>
			}
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">			if (effectiveDateEnd != null) {</span>
<span class="nc" id="L448">				pc_endDate.setDate(effectiveDateEnd);</span>
			}
		}
		
<span class="fc" id="L452">		pc_minPaid.setAsMinimumValueSpinner(pc_maxPaid.getName(), smallestMaxPaid);</span>
<span class="fc" id="L453">		pc_maxPaid.setAsMaximumValueSpinner(pc_minPaid.getName(), biggestMinPaid);</span>
<span class="fc" id="L454">		pc_otPerDay.setAsMinimumValueSpinner(pc_otPerWeek.getName(), smallestOTPerWeek);</span>
<span class="fc" id="L455">		pc_otPerWeek.setAsMaximumValueSpinner(pc_otPerDay.getName(), biggestOTPerDay);</span>
<span class="fc" id="L456">		pc_vtoPerDay.setAsMinimumValueSpinner(pc_vtoPerWeek.getName(), smallestVTOPerWeek);</span>
<span class="fc" id="L457">		pc_vtoPerWeek.setAsMaximumValueSpinner(pc_vtoPerDay.getName(), biggestVTOPerDay);</span>
		
		//If in campaign mode, when the user changes the values for the hours spinners the selected date range
		// will snap to the current view period
<span class="pc bpc" id="L461" title="1 of 2 branches missed.">		if (onlyPeriodEditable) {</span>
<span class="nc" id="L462">			pc_minPaid.setOnChangeJS(&quot;snapHoursEffectiveDatesToViewPeriod();&quot;);</span>
<span class="nc" id="L463">			pc_maxPaid.setOnChangeJS(&quot;snapHoursEffectiveDatesToViewPeriod();&quot;);</span>
<span class="nc" id="L464">			pc_otPerDay.setOnChangeJS(&quot;snapHoursEffectiveDatesToViewPeriod();&quot;);</span>
<span class="nc" id="L465">			pc_otPerWeek.setOnChangeJS(&quot;snapHoursEffectiveDatesToViewPeriod();&quot;);</span>
<span class="nc" id="L466">			pc_vtoPerDay.setOnChangeJS(&quot;snapHoursEffectiveDatesToViewPeriod();&quot;);</span>
<span class="nc" id="L467">			pc_vtoPerWeek.setOnChangeJS(&quot;snapHoursEffectiveDatesToViewPeriod();&quot;);</span>
		}
<span class="fc" id="L469">	}</span>

	
	/**
	 * Determines if the current hours record is &quot;current&quot;, in other words it applies to the current
	 * view period.  This is true if the start date of the hours lies before or at the view period start date
	 * and the hours end date is either null or lies after the view period start date.  Hours records are also
	 * current if they lie between the view start and end dates.
	 */	
	private boolean isHoursRecordCurrent(WorkResourceMinMaxHour hours) {
		TimeZone empTimeZone;
<span class="nc" id="L480">		Employee emp = employeeMap.get(hours.getWorkResourceID());</span>
		//Determine time zone of employee at record start
<span class="nc bnc" id="L482" title="All 2 branches missed.">		if (emp.getStartTime().after(hours.getStartTime())) {</span>
<span class="nc" id="L483">			empTimeZone = emp.getTimeZone(emp.getStartTime());</span>
		} else {
<span class="nc" id="L485">			empTimeZone = emp.getTimeZone(hours.getStartTime());</span>
		}
<span class="nc" id="L487">		LocalDate localEffectiveStart = new LocalDate(hours.getStartTime(), empTimeZone);</span>
<span class="nc" id="L488">		LocalDate localEffectiveEnd = null;</span>
		//Determine time zone of employee at record end
<span class="nc bnc" id="L490" title="All 2 branches missed.">		if (hours.getEndTime() != null) { </span>
<span class="nc bnc" id="L491" title="All 4 branches missed.">			if (emp.getEndTime() == null || emp.getEndTime().after(hours.getEndTime())) {</span>
<span class="nc" id="L492">				empTimeZone = emp.getTimeZone(hours.getEndTime());</span>
			} else {
<span class="nc" id="L494">				empTimeZone = emp.getTimeZone(emp.getEndTime());</span>
			}
<span class="nc" id="L496">			localEffectiveEnd = new LocalDate(hours.getEndTime(), empTimeZone);</span>
		}
<span class="nc bnc" id="L498" title="All 6 branches missed.">		return ((localEffectiveStart.before(viewPeriodStart) || localEffectiveStart.equals(viewPeriodStart))</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">				&amp;&amp; (localEffectiveEnd == null || localEffectiveEnd.after(viewPeriodStart))) ||</span>
<span class="nc bnc" id="L500" title="All 4 branches missed.">				(localEffectiveStart.after(viewPeriodStart) &amp;&amp; localEffectiveStart.before(viewPeriodEnd));</span>
	}
	
	private void setAllFieldsMultiEdit() {
<span class="fc" id="L504">		pc_minPaid.setMultiEdit(true);</span>
<span class="fc" id="L505">		pc_maxPaid.setMultiEdit(true);</span>
<span class="fc" id="L506">		pc_otPerDay.setMultiEdit(true);</span>
<span class="fc" id="L507">		pc_otPerWeek.setMultiEdit(true);</span>
<span class="fc" id="L508">		pc_vtoPerDay.setMultiEdit(true);</span>
<span class="fc" id="L509">		pc_vtoPerWeek.setMultiEdit(true);</span>
<span class="fc" id="L510">		pc_startDate.setIsMultiValue(true);</span>
<span class="fc" id="L511">		pc_endDate.setIsMultiValue(true);</span>
<span class="fc" id="L512">	}</span>
	
	private void resetMultiEditFields() {
<span class="nc bnc" id="L515" title="All 2 branches missed.">		if (pc_minPaid.isMultiEdit()) {</span>
<span class="nc" id="L516">			pc_minPaid.setValue(Duration.fromMinutes(0));</span>
		}
		
<span class="nc bnc" id="L519" title="All 2 branches missed.">		if (pc_maxPaid.isMultiEdit()) {</span>
<span class="nc" id="L520">			pc_maxPaid.setValue(Duration.fromMinutes(0));</span>
		}
		
<span class="nc bnc" id="L523" title="All 2 branches missed.">		if (pc_otPerDay.isMultiEdit()) {</span>
<span class="nc" id="L524">			pc_otPerDay.setValue(Duration.fromMinutes(0));</span>
		}
		
<span class="nc bnc" id="L527" title="All 2 branches missed.">		if (pc_otPerWeek.isMultiEdit()) {</span>
<span class="nc" id="L528">			pc_otPerWeek.setValue(Duration.fromMinutes(0));</span>
		}
		
<span class="nc bnc" id="L531" title="All 2 branches missed.">		if (pc_vtoPerDay.isMultiEdit()) {</span>
<span class="nc" id="L532">			pc_vtoPerDay.setValue(Duration.fromMinutes(0));</span>
		}
		
<span class="nc bnc" id="L535" title="All 2 branches missed.">		if (pc_vtoPerWeek.isMultiEdit()) {</span>
<span class="nc" id="L536">			pc_vtoPerWeek.setValue(Duration.fromMinutes(0));</span>
		}
<span class="nc" id="L538">	}</span>
	
	private void initializeRows() {
<span class="fc" id="L541">		Object leftLabel = null;</span>
<span class="fc" id="L542">		Object left = null;</span>
<span class="fc" id="L543">		Object right = null;</span>
<span class="fc" id="L544">		Object rightLabel = null;</span>
		
<span class="pc bpc" id="L546" title="1 of 2 branches missed.">		leftLabel = pc_minPaid.isVisible() ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MIN_PAID_HOURS) : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L547" title="1 of 2 branches missed.">		left = pc_minPaid.isVisible() ? pc_minPaid.getHtmlDisplay() : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L548" title="1 of 2 branches missed.">		rightLabel = pc_maxPaid.isVisible() ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MAX_PAID_HOURS) : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L549" title="1 of 2 branches missed.">		right = pc_maxPaid.isVisible() ? pc_maxPaid.getHtmlDisplay() : &quot;&amp;nbsp;&quot;;</span>
		
		// Only add the min paid and max paid row if at least one of them is visible.
<span class="pc bpc" id="L552" title="3 of 4 branches missed.">		if (pc_minPaid.isVisible() || pc_maxPaid.isVisible()) {</span>
<span class="fc" id="L553">			addRowData(leftLabel, left, rightLabel, right);</span>
		}
		
<span class="pc bpc" id="L556" title="1 of 2 branches missed.">		leftLabel = pc_otPerDay.isVisible() ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MAX_OT_PER_DAY) : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L557" title="1 of 2 branches missed.">		left = pc_otPerDay.isVisible() ? pc_otPerDay.getHtmlDisplay() : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">		rightLabel = pc_otPerWeek.isVisible() ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MAX_OT_PER_WEEK) : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L559" title="1 of 2 branches missed.">		right = pc_otPerWeek.isVisible() ? pc_otPerWeek.getHtmlDisplay() : &quot;&amp;nbsp;&quot;;</span>
		
<span class="pc bpc" id="L561" title="3 of 4 branches missed.">		if (pc_otPerDay.isVisible() || pc_otPerWeek.isVisible()) {</span>
<span class="fc" id="L562">			addRowData(leftLabel, left, rightLabel, right);</span>
		}
		
<span class="pc bpc" id="L565" title="1 of 2 branches missed.">		leftLabel = pc_vtoPerDay.isVisible() ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MAX_VTO_PER_DAY) : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L566" title="1 of 2 branches missed.">		left = pc_vtoPerDay.isVisible() ? pc_vtoPerDay.getHtmlDisplay() : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L567" title="1 of 2 branches missed.">		rightLabel = pc_vtoPerWeek.isVisible() ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MAX_VTO_PER_WEEK) : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L568" title="1 of 2 branches missed.">		right = pc_vtoPerWeek.isVisible() ? pc_vtoPerWeek.getHtmlDisplay() : &quot;&amp;nbsp;&quot;;</span>
		
<span class="pc bpc" id="L570" title="3 of 4 branches missed.">		if (pc_vtoPerDay.isVisible() || pc_vtoPerWeek.isVisible()) {</span>
<span class="fc" id="L571">			addRowData(leftLabel, left, rightLabel, right);</span>
		}
		
<span class="fc" id="L574">		final StringBuffer editIconHtml = new StringBuffer();</span>
<span class="pc bpc" id="L575" title="1 of 2 branches missed.">		if (isAnySpinnerVisible()) {</span>
<span class="fc" id="L576">			editIconHtml.append(HtmlUtil.imageTag(ImageFileID.EDIT, ImageFileID.EDIT_WIDTH,</span>
<span class="fc" id="L577">					ImageFileID.EDIT_HEIGHT, m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.EDIT), false))</span>
<span class="fc" id="L578">			.append(&quot; onClick=\&quot;&quot;).append(pc_toolbar.getName()).append(&quot;.onSelect('&quot;).append(HoursPopupPM.HOURS_POPUP_ID).append(&quot;',this)\&quot; &quot;)</span>
<span class="fc" id="L579">			.append(&quot;actionType=\&quot;POPUP_WINDOW_TYPE\&quot;&quot;)</span>
<span class="fc" id="L580">			.append(&quot;style=\&quot;vertical-align: middle;\&quot;&quot;)</span>
<span class="fc" id="L581">			.append(&quot;&gt;&quot;);</span>
		}

<span class="fc" id="L584">		SimpleDateFormat sdf = new SimpleDateFormat(m_context.getLocalizer().getDateInputFormat(), m_context.getLocalizer().getLocaleContext().getRegionalFormatLocale());</span>
<span class="fc" id="L585">		StringBuffer args = new StringBuffer(&quot;selectedID=&quot;).append(StringUtil.createDelimitedString(employeeIDs.toArray(new ID[employeeIDs.size()]), &quot;%2C&quot;));</span>
<span class="fc" id="L586">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_START).append(&quot;=&quot;).append(viewPeriodStart.getTime(TimeZoneUtil.GMT_TIMEZONE).getTime());</span>
		//End date is inclusive
<span class="fc" id="L588">		LocalDate viewPeriodEndDisplay = new LocalDate(viewPeriodEnd);</span>
<span class="fc" id="L589">		viewPeriodEndDisplay.add(Calendar.DATE, -1);</span>
<span class="fc" id="L590">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_END).append(&quot;=&quot;).append(viewPeriodEndDisplay.getTime(TimeZoneUtil.GMT_TIMEZONE).getTime());</span>
<span class="fc" id="L591">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_PERIOD_ONLY).append(&quot;=&quot;).append(onlyPeriodEditable);</span>
<span class="fc bfc" id="L592" title="All 2 branches covered.">		if (employeeIDs.size() &gt; 1) {		//If in multi-edit mode, we will only be editing along the view date ranges</span>
<span class="fc" id="L593">			args.append(&quot;&amp;CUR_PERIOD_START=&quot; /* Defined in DataContainerPC */).append(sdf.format(viewPeriodStart.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
<span class="fc" id="L594">			args.append(&quot;&amp;CUR_PERIOD_END=&quot; /* Defined in DataContainerPC */).append(sdf.format(viewPeriodEndDisplay.getTime(TimeZoneUtil.GMT_TIMEZONE)));			</span>
		} else {
<span class="pc bpc" id="L596" title="1 of 2 branches missed.">			if (effectiveDateStart != null) {</span>
<span class="nc" id="L597">				args.append(&quot;&amp;CUR_PERIOD_START=&quot; /* Defined in DataContainerPC */).append(sdf.format(effectiveDateStart.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
			}
<span class="pc bpc" id="L599" title="1 of 2 branches missed.">			if (effectiveDateEnd != null) {</span>
<span class="nc" id="L600">				args.append(&quot;&amp;CUR_PERIOD_END=&quot; /* Defined in DataContainerPC */).append(sdf.format(effectiveDateEnd.getTime(TimeZoneUtil.GMT_TIMEZONE)));			</span>
			}
		}
<span class="fc" id="L603">		args.append(&quot;&amp;PERIOD_START=&quot; /* Defined in DataContainerPC */).append(sdf.format(viewPeriodStart.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
<span class="fc" id="L604">		args.append(&quot;&amp;PERIOD_END=&quot; /* Defined in DataContainerPC */).append(sdf.format(viewPeriodEndDisplay.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
<span class="fc" id="L605">		args.append(&quot;&amp;&quot;).append(ProfilePageModel.SHOW_AS_DATE_FN).append(&quot;=&quot;).append(sdf.format(viewPeriodStart.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
<span class="fc" id="L606">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_START_NAME).append(&quot;=&quot;).append(pc_startDate.getDateInputFieldName());</span>
<span class="fc" id="L607">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_END_NAME).append(&quot;=&quot;).append(pc_endDate.getDateInputFieldName());</span>
<span class="fc" id="L608">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_MIN_PAID_NAME).append(&quot;=&quot;).append(pc_minPaid.getName());</span>
<span class="fc" id="L609">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_MAX_PAID_NAME).append(&quot;=&quot;).append(pc_maxPaid.getName());</span>
<span class="fc" id="L610">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_OT_PER_DAY_NAME).append(&quot;=&quot;).append(pc_otPerDay.getName());</span>
<span class="fc" id="L611">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_OT_PER_WEEK_NAME).append(&quot;=&quot;).append(pc_otPerWeek.getName());</span>
<span class="fc" id="L612">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_VTO_PER_DAY_NAME).append(&quot;=&quot;).append(pc_vtoPerDay.getName());</span>
<span class="fc" id="L613">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_VTO_PER_WEEK_NAME).append(&quot;=&quot;).append(pc_vtoPerWeek.getName());</span>
<span class="fc" id="L614">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_UPDATE_MODE_NAME).append(&quot;=&quot;).append(html_updateMode.getAttribute(&quot;name&quot;));</span>
<span class="fc" id="L615">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_DATES_MODIFIED_NAME).append(&quot;=&quot;).append(html_datesModified.getAttribute(&quot;name&quot;));</span>
<span class="fc" id="L616">		addPopupArgs(HoursPopupPM.HOURS_POPUP_ID, &quot;work_rules_assignment_hours_popup&quot;, args.toString(), html_updateMode.getAttribute(&quot;name&quot;), &quot;1000,600,ctr,ctr&quot;, true, 1);</span>

<span class="fc" id="L618">		addRowData(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_START_DATE),</span>
<span class="fc" id="L619">				pc_startDate.toString() + editIconHtml.toString() + html_updateMode.toString() + html_datesModified.toString(),</span>
<span class="fc" id="L620">				m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_END_DATE),</span>
<span class="fc" id="L621">				pc_endDate.toString());</span>
<span class="fc" id="L622">	}</span>
	
	/**
	 * Returns true if any of the spinner components are enabled.
	 */
	public boolean isAnySpinnerEnabled() {
<span class="pc bpc" id="L628" title="5 of 6 branches missed.">		if (pc_minPaid.isEnabled() || pc_maxPaid.isEnabled() || pc_otPerDay.isEnabled() ||</span>
<span class="nc bnc" id="L629" title="All 6 branches missed.">				pc_otPerWeek.isEnabled() || pc_vtoPerDay.isEnabled() || pc_vtoPerWeek.isEnabled()) {</span>
<span class="fc" id="L630">			return true;</span>
		}
<span class="nc" id="L632">		return false;</span>
	}
	
	/**
	 * Returns true if any of the spinner components are visible.
	 */
	public boolean isAnySpinnerVisible() {
<span class="pc bpc" id="L639" title="5 of 6 branches missed.">		if (pc_minPaid.isVisible() || pc_maxPaid.isVisible() || pc_otPerDay.isVisible() ||</span>
<span class="nc bnc" id="L640" title="All 6 branches missed.">				pc_otPerWeek.isVisible() || pc_vtoPerDay.isVisible() || pc_vtoPerWeek.isVisible()) {</span>
<span class="fc" id="L641">			return true;</span>
		}
<span class="nc" id="L643">		return false;</span>
	}
	
	// ---- Getters &amp; Setters ---- //
	
	public Duration getMinPaid() {
<span class="nc" id="L649">		return pc_minPaid.getDuration();</span>
	}

	public Duration getMaxPaid() {
<span class="nc" id="L653">		return pc_maxPaid.getDuration();</span>
	}

	public Duration getOtPerDay() {
<span class="nc" id="L657">		return pc_otPerDay.getDuration();</span>
	}

	public Duration getOtPerWeek() {
<span class="nc" id="L661">		return pc_otPerWeek.getDuration();</span>
	}

	public Duration getVtoPerDay() {
<span class="nc" id="L665">		return pc_vtoPerDay.getDuration();</span>
	}

	public Duration getVtoPerWeek() {
<span class="nc" id="L669">		return pc_vtoPerWeek.getDuration();</span>
	}

	public LocalDate getStartDate() {
<span class="nc" id="L673">		return pc_startDate.getLocalDate();</span>
	}
	
	public LocalDate getEndDate() {
<span class="nc" id="L677">		return pc_endDate.getLocalDate();</span>
	}
	
	public void setViewPeriodStart(long viewPeriodStart) {
<span class="nc" id="L681">		this.viewPeriodStart = new LocalDate(new Date(viewPeriodStart), TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L682">	}</span>

	public void setViewPeriodEnd(long viewPeriodEnd) {
<span class="nc" id="L685">		this.viewPeriodEnd = new LocalDate(new Date(viewPeriodEnd), TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L686">	}</span>
	
	public void save() throws BbmException {
<span class="fc" id="L689">		boolean edited = </span>
<span class="fc bfc" id="L690" title="All 2 branches covered.">			pc_minPaid.isEdited()</span>
<span class="fc bfc" id="L691" title="All 2 branches covered.">			|| pc_maxPaid.isEdited()</span>
<span class="pc bpc" id="L692" title="1 of 2 branches missed.">			|| pc_otPerDay.isEdited()</span>
<span class="pc bpc" id="L693" title="1 of 2 branches missed.">			|| pc_otPerWeek.isEdited()</span>
<span class="pc bpc" id="L694" title="1 of 2 branches missed.">			|| pc_vtoPerDay.isEdited()</span>
<span class="pc bpc" id="L695" title="1 of 2 branches missed.">			|| pc_vtoPerWeek.isEdited()</span>
<span class="pc bpc" id="L696" title="1 of 2 branches missed.">			|| &quot;true&quot;.equals(html_datesModified.getAttribute(&quot;value&quot;));</span>
<span class="fc bfc" id="L697" title="All 2 branches covered.">		if (edited) {</span>
<span class="fc" id="L698">			EmpWorkRuleManager ewrm = WfmManagerFactory.getEmpWorkRuleManager(m_context.isInWhatIfMode());</span>
<span class="fc bfc" id="L699" title="All 2 branches covered.">			for (Employee employee : employeeMap.values()) {</span>
<span class="fc" id="L700">				WorkResourceMinMaxHour wrmmh = currentHoursAssignments.get(employee.getID());</span>
<span class="pc bpc" id="L701" title="1 of 2 branches missed.">				if (wrmmh == null) {</span>
<span class="fc" id="L702">					wrmmh = new WorkResourceMinMaxHour();</span>
				}
				
<span class="fc" id="L705">				wrmmh.setWorkResourceID(employee.getID());</span>
<span class="fc bfc" id="L706" title="All 2 branches covered.">				if (pc_minPaid.isEdited()) {</span>
<span class="fc" id="L707">					wrmmh.setMinMinutes(pc_minPaid.getDuration().getDurationInMinutes());</span>
				}
				
<span class="fc bfc" id="L710" title="All 2 branches covered.">				if (pc_maxPaid.isEdited()) {</span>
<span class="fc" id="L711">					wrmmh.setMaxMinutes(pc_maxPaid.getDuration().getDurationInMinutes());</span>
				}
				
				// These fields should only be set if the field is editable.  Since the page component may or may not
				// be added to the rendered markup now because of the secured field implementation, you can't rely on 
				// property state of the page components for decision making here.
<span class="pc bpc" id="L717" title="1 of 4 branches missed.">				if (pc_otPerDay.isEdited() &amp;&amp; isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXOTMINSPERDAY)) {</span>
<span class="fc" id="L718">					wrmmh.setMaxOTMinutesPerDay(pc_otPerDay.getDuration().getDurationInMinutes());</span>
				}
				
<span class="pc bpc" id="L721" title="1 of 4 branches missed.">				if (pc_otPerWeek.isEdited() &amp;&amp; isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXOTMINSPERWEEK)) {</span>
<span class="fc" id="L722">					wrmmh.setMaxOTMinutesPerWeek(pc_otPerWeek.getDuration().getDurationInMinutes());</span>
				}
				
<span class="pc bpc" id="L725" title="1 of 4 branches missed.">				if (pc_vtoPerDay.isEdited() &amp;&amp; isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXVTOHOURSPERDAY)) {</span>
<span class="fc" id="L726">					wrmmh.setMaxVTOHoursPerDay(pc_vtoPerDay.getDuration().getDurationInMinutes());</span>
				}
				
<span class="pc bpc" id="L729" title="1 of 4 branches missed.">				if (pc_vtoPerWeek.isEdited() &amp;&amp; isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXVTOHOURSPERWEEK)) {</span>
<span class="fc" id="L730">					wrmmh.setMaxVTOHoursPerWeek(pc_vtoPerWeek.getDuration().getDurationInMinutes());</span>
				}
				
				// The Date pickers do not have a value in the multi-edit scenario.
				// Additionally, they don't have an isedited property to determine
				// when we should use the date from the date picker and when it should
				// be used from the current assignment.
<span class="fc" id="L737">				LocalDate localStartDate = pc_startDate.getLocalDate();</span>
<span class="fc bfc" id="L738" title="All 2 branches covered.">				if (localStartDate == null) {	//The only way we could have a null date here is if we are in multi-edit and the date was not modified.  Just use the current assignment date in that case.</span>
<span class="pc bpc" id="L739" title="1 of 2 branches missed.">					if (currentHoursAssignments.containsKey(employee.getID())) {</span>
<span class="nc" id="L740">						localStartDate = new LocalDate(</span>
<span class="nc" id="L741">								currentHoursAssignments.get(employee.getID()).getStartTime(),</span>
<span class="nc" id="L742">								employee.getTimeZone(currentHoursAssignments.get(employee.getID()).getStartTime()));				</span>
					} else {	//Employee does not have any hours records.  This record should therefore begin on his/her start date.
<span class="fc" id="L744">						localStartDate = employee.getStartTimeLocal();</span>
					}
				}
<span class="pc bpc" id="L747" title="1 of 2 branches missed.">				if (localStartDate.before(employee.getStartTimeLocal())) {</span>
<span class="nc" id="L748">					localStartDate = employee.getStartTimeLocal();</span>
				}
				
<span class="fc" id="L751">				wrmmh.setStartTime(localStartDate.getTime(</span>
<span class="fc" id="L752">						employee.getTimeZone(localStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE))));</span>
<span class="fc" id="L753">				LocalDate localEndDate = pc_endDate.getLocalDate();</span>
				//If end date coming back from the picker is null this could mean one of two things:
				// 1 - The picker was multi-edit and did not change.
				// 2 - The picker had its end date explicitly set to null (open-ended).
				// We need to check if the dates were modified, if they were, then that means the date
				// was explicitly set to null (otherwise they were unchanged and we can assume that the
				// picker remained in a multi-value state) 
<span class="pc bpc" id="L760" title="1 of 2 branches missed.">				if (localEndDate == null) {</span>
<span class="fc bfc" id="L761" title="All 2 branches covered.">					if (&quot;true&quot;.equals(html_datesModified.getAttribute(&quot;value&quot;))) {</span>
<span class="fc" id="L762">						 wrmmh.setEndTime(null);</span>
<span class="pc bpc" id="L763" title="1 of 2 branches missed.">					} else if (currentHoursAssignments.containsKey(employee.getID()) &amp;&amp;</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">						currentHoursAssignments.get(employee.getID()).getEndTime() != null) {</span>
<span class="nc" id="L765">							localEndDate = new LocalDate(</span>
<span class="nc" id="L766">									currentHoursAssignments.get(employee.getID()).getEndTime(),</span>
<span class="nc" id="L767">									employee.getTimeZone(currentHoursAssignments.get(employee.getID()).getEndTime()));							</span>
					}
				} else {
<span class="nc" id="L770">					localEndDate.add(Calendar.DATE, 1);		//Display date was inclusive, we need to add one day to get the value we should be comparing DB records against</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">					if (localEndDate.after(employee.getEndTimeLocal())) {</span>
<span class="nc" id="L772">						localEndDate = employee.getEndTimeLocal();</span>
					}
					
<span class="nc" id="L775">					wrmmh.setEndTime(localEndDate.getTime(</span>
<span class="nc" id="L776">							employee.getTimeZone(localEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE))));</span>
				}
				try {
<span class="fc bfc" id="L779" title="All 2 branches covered.">					if (DataContainerPC.UPDATE_MODE_1.equals(html_updateMode.getAttribute(&quot;value&quot;))) {</span>
<span class="fc" id="L780">						ewrm.updateMinMaxHourAssignment(wrmmh, true);</span>
					} else {
<span class="fc" id="L782">						ewrm.createMinMaxHourAssignment(wrmmh);</span>
					}
<span class="nc" id="L784">				} catch (Exception ex) {</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">					if (ex instanceof BbmException) {</span>
<span class="nc" id="L786">						throw (BbmException) ex;</span>
					}
<span class="nc" id="L788">					throw new BbmException(ex);</span>
<span class="fc" id="L789">				}</span>
<span class="fc" id="L790">			}</span>
		}
<span class="fc" id="L792">	}</span>

	@Override
	public String getJavaScriptInitCode() {
<span class="fc" id="L796">		StringBuffer js = new StringBuffer();</span>
<span class="fc" id="L797">		js.append(super.getJavaScriptInitCode());</span>
<span class="pc bpc" id="L798" title="1 of 2 branches missed.">		if (onlyPeriodEditable) {</span>
<span class="nc" id="L799">			js.append(getDateSnapOnValueChangeJS());</span>
		}
<span class="fc" id="L801">		return js.toString();</span>
	}

	/**
	 * This JS is used to force the effective dates to snap to the view period if a duration spinner is modified
	 * when in campaign mode (essentially it will match the view period of the currently selected SP).
	 */
	private String getDateSnapOnValueChangeJS() {
<span class="nc bnc" id="L809" title="All 2 branches missed.">		String startDateDisplay = viewPeriodStart == null ? &quot;&quot; : m_localizer.formatDate(viewPeriodStart, RegionalFormatBundleKey.DATE_FORMAT);</span>
<span class="nc" id="L810">		String endDateDisplay = &quot;&quot;;</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">		if (viewPeriodEnd != null) {</span>
<span class="nc" id="L812">			LocalDate viewPeriodEndDisplay = new LocalDate(viewPeriodEnd);</span>
<span class="nc" id="L813">			viewPeriodEndDisplay.add(Calendar.DATE, -1);</span>
<span class="nc" id="L814">			endDateDisplay = m_localizer.formatDate(viewPeriodEndDisplay, RegionalFormatBundleKey.DATE_FORMAT);</span>
		}
<span class="nc" id="L816">		StringBuffer js = new StringBuffer();</span>
<span class="nc" id="L817">		js.append(&quot;function snapHoursEffectiveDatesToViewPeriod() {\n&quot;)</span>
<span class="nc" id="L818">			.append(&quot;\t var startElements = document.getElementsByName('&quot;).append(pc_startDate.getDateInputFieldName()).append(&quot;');\n&quot;)</span>
<span class="nc" id="L819">			.append(&quot;\t if (startElements.length == 1) startElements[0].value = '&quot;).append(startDateDisplay).append(&quot;';\n&quot;)</span>
<span class="nc" id="L820">			.append(&quot;\t var endElements = document.getElementsByName('&quot;).append(pc_endDate.getDateInputFieldName()).append(&quot;');\n&quot;)</span>
<span class="nc" id="L821">			.append(&quot;\t if (endElements.length == 1) endElements[0].value = '&quot;).append(endDateDisplay).append(&quot;';\n&quot;)</span>
<span class="nc" id="L822">		.append(&quot;}\n&quot;);</span>
		
<span class="nc" id="L824">		return js.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>