<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FilingRuleEditPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.setup.filingrules</a> &gt; <span class="el_source">FilingRuleEditPageModel.java</span></div><h1>FilingRuleEditPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.setup.filingrules;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.setup.filingrules.model.RequestFilingRule;
import com.bluepumpkin.ejb.rm.setup.filingrules.model.RequestFilingRuleFieldInfo;
import com.bluepumpkin.ejb.rm.setup.timeoffbid.model.TimeOffBidFieldInfo;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.bbm.organization.OrgWorkpaneFormPageModel;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarUtil;
import com.witness.web.uif.pagemodel.WorkpanePageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.validator.IsNonNegativeIntegerFieldValidator;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.bluepumpkin.web.rm.setup.RmSetupUtil;

/**
 * Title          FilingRuleEditPageModel
 * Description    Used to display the Create/Edit filing Rule page
 * Copyright      Copyright (c) 2002
 * Company        Blue Pumpkin Software, Inc
 * @author        Shubhangi Chavan
 * @version       1.0
 */
public class FilingRuleEditPageModel extends OrgWorkpaneFormPageModel { 
<span class="fc" id="L41">	private static final Category log = </span>
<span class="fc" id="L42">		Log.initCategory(FilingRuleEditPageModel.class.getName());</span>

	private static final String NEW_TIMEOFF   = &quot;NEW_TIME_OFF&quot;;
	private static final String NEW_TIMEOFF_WITHDRAW = &quot;NEW_TIMEOFF_WITHDRAW&quot;;
	private static final String NEW_SHIFTSWAP_WITHDRAW = &quot;NEW_SHIFTSWAP_WITHDRAW&quot;;
	private static final String NEW_SHIFTSWAP = &quot;NEW_SHIFT_SWAP&quot;;
	private static final String NEW_SHIFTBID  = &quot;NEW_SHIFT_BID&quot;;
	private static final String NEW_CUSTOMSHIFT  = &quot;NEW_CUSTOM_SHIFT&quot;;
	private static final String NEW_FLEXTIME  = &quot;NEW_FLEX_TIME&quot;;  
	private static final String INTERVAL_COUNT_FN     = FilingRulePC.INTERVAL_COUNT_FN;
	private static final int MINUTES_IN_DAY = 1440;

	private ResourceBundle m_rmBundle;
	private ResourceBundle rmEjbBundle;
	private RequestFilingRule m_filingRule;
	private FilingRulePC m_filingRulePC;
	private Collection m_timeOffTypeList;
	private Collection m_dayTypeList;
	private Collection m_dateComparisonList;
	private Collection m_intervalTypeList;
	private Collection m_intervalUnitList;
	private Collection&lt;StringsPair&gt; flexBeforeAfterList;
	
	/**
	 * Constructor
	 */
	public FilingRuleEditPageModel(RequestContext context) {
<span class="fc" id="L69">		super(context);</span>
<span class="fc" id="L70">		m_rmBundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L71">		rmEjbBundle = m_localizer.getBundle(RmEjbBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L72">		extractParameters(context.getRequest(), WorkpanePageModel.SELECTED_ID_FN);</span>

		// Component specific required JavaScript Files
<span class="fc" id="L75">		addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE);</span>
<span class="fc" id="L76">		addRequiredJavaScriptFile(JavaScriptFileID.DIALOG_PICKERS);</span>
<span class="fc" id="L77">		setJSMediator(JavaScriptFileID.MEDIATOR_WORKPANE_GENERIC);</span>

<span class="fc" id="L79">		m_dayTypeList = RequestUtil.getDayTypeList(m_rmBundle, m_localizer);</span>
<span class="fc" id="L80">		m_dateComparisonList = RequestUtil.getDateComparisonList(m_localizer);</span>
<span class="fc" id="L81">		m_intervalTypeList = RequestUtil.getIntervalTypeList(m_localizer);</span>
<span class="fc" id="L82">		flexBeforeAfterList = FilingRuleModelHandler.getFlexBeforeAfterList(rmEjbBundle, m_localizer);</span>
<span class="fc" id="L83">		m_filingRule = new RequestFilingRule();</span>
<span class="fc" id="L84">		m_filingRulePC = new FilingRulePC(m_context, m_filingRule, RmSetupUtil.getOrgTimeZone(m_context, this.getSelectedIDObject()));</span>
<span class="fc" id="L85">		addChildComponent(m_filingRulePC);</span>
<span class="fc" id="L86">		addValidator(new IsNonNegativeIntegerFieldValidator(this, </span>
				INTERVAL_COUNT_FN,
				RmWebBundleKey.REQUEST_LABEL_INTERVAL_COUNT, 
				RmWebBundleKey.BUNDLE_NAME));
<span class="fc" id="L90">	}</span>

	/**
	 * Initialize the request type when creating a new filing rule (as opposed to editing an existing filing rule).
	 */
	private void initRequestTypeForNewRuleCreation(RequestContext context) {
<span class="fc" id="L96">		String createRuleType = (String)context.getAttribute(RequestContext.REQUEST_SCOPE, &quot;createRuleType&quot;);</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">		if (createRuleType != null) {</span>
<span class="fc" id="L98">			m_filingRule.setRequestType(createRuleType);</span>

<span class="pc bpc" id="L100" title="1 of 2 branches missed.">			if (createRuleType.equals(Request.REQUESTTYPE_FLEXTIME)) {</span>
				//set default interval count for flex time requests
<span class="nc" id="L102">				m_filingRule.setIntervalDays(MINUTES_IN_DAY);</span>
			}
		}
		else {
<span class="nc" id="L106">			m_filingRule.setRequestType(Request.REQUESTTYPE_TIMEOFF);</span>
		}
			
<span class="fc" id="L109">	}</span>

	/**
	 * These initializations require the requestType to have been set.
	 * @param context RequestContext
	 */
	private void initializeSettingsThatDependOnRequestType(RequestContext context) {
<span class="fc" id="L116">		initIntervalUnitList();</span>
<span class="fc" id="L117">		initTimeOffTypeList();</span>
<span class="fc" id="L118">		initForm();</span>
<span class="fc" id="L119">	}</span>

	/**
	 * Initialize the filing rule's m_intervalUnitList member.
	 */
	private void initIntervalUnitList() {
<span class="fc" id="L125">		boolean includeMinutes = m_filingRule.getRequestType().equals(Request.REQUESTTYPE_FLEXTIME);</span>
<span class="fc" id="L126">		m_intervalUnitList = FilingRuleModelHandler.getIntervalUnitList(m_localizer, includeMinutes);</span>
<span class="fc" id="L127">	}</span>

	/**
	 * Get the time off types, filtered by isFlex or not.
	 */
	private void initTimeOffTypeList() {
		try {
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">			if (getSelectedIDObject() != null) {</span>
<span class="fc" id="L135">				boolean isFlex = m_filingRule.getRequestType().equals(Request.REQUESTTYPE_FLEXTIME);</span>
<span class="fc" id="L136">				m_timeOffTypeList = FilingRuleModelHandler.getTimeOffTypes(</span>
<span class="fc" id="L137">					getSelectedIDObject(), isFlex);</span>
			}
		}
<span class="nc" id="L140">		catch (Exception e) {</span>
<span class="nc" id="L141">			log.l7dError(RmWebLogBundleKey.UNABLE_TO_LOAD_DATA, e);</span>
<span class="fc" id="L142">		}</span>

<span class="pc bpc" id="L144" title="1 of 2 branches missed.">		if (m_timeOffTypeList == null) {</span>
<span class="nc" id="L145">			m_timeOffTypeList = new ArrayList();</span>
		}
<span class="fc" id="L147">	}</span>

	/**
	 * Return an instance of FilingRuleEditPageModel ready to be rendered in JSP
	 * @param   context RequestContext
	 * @return  FilingRuleEditPageModel  instance of FilingRuleEditPageModel
	 */
	public static FilingRuleEditPageModel getInstance(RequestContext context) {
<span class="fc" id="L155">		return (FilingRuleEditPageModel)getInstance(context, FilingRuleEditPageModel.class);</span>
	}

	/**
	 * Initialize Form Display
	 */
	@Override
	protected void initForm() {
		//invoke the methods that create the PC
<span class="fc" id="L164">		m_filingRulePC.setPageType(getCreateRuleType());</span>
<span class="fc" id="L165">		m_filingRulePC.setRequestFilingRule(m_filingRule);</span>
<span class="fc" id="L166">		m_filingRulePC.setDayTypeList(m_dayTypeList);</span>
<span class="fc" id="L167">		m_filingRulePC.setComparisonTypeList(m_dateComparisonList);</span>
<span class="fc" id="L168">		m_filingRulePC.setIntervalTypeList(m_intervalTypeList);</span>
<span class="fc" id="L169">		m_filingRulePC.setIntervalUnitList(m_intervalUnitList);</span>
<span class="fc" id="L170">		m_filingRulePC.setTimeOffTypeList(m_timeOffTypeList);</span>
<span class="fc" id="L171">		m_filingRulePC.setFlexBeforeAfterList(flexBeforeAfterList);</span>
	
<span class="fc" id="L173">	}</span>

	/**
	 * Create Form Model
	 */
	@Override
	protected void createFormModel() {
		try {
<span class="pc bpc" id="L181" title="3 of 4 branches missed.">			if (getRuleID()!=null &amp;&amp; !hasError()) {</span>
				//we are editing an existing filing rule. Read it from the DB.
<span class="nc" id="L183">				m_filingRule = FilingRuleModelHandler.getFilingRule(getRuleID());</span>
				
			} else {
<span class="fc" id="L186">				initRequestTypeForNewRuleCreation(m_context);</span>
			}
			
			
<span class="fc" id="L190">			initializeSettingsThatDependOnRequestType(m_context);</span>
<span class="nc" id="L191">		} catch (Exception ex) {</span>
<span class="nc" id="L192">			handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L193">		}</span>
<span class="fc" id="L194">	}</span>

	/**
	 * Initialize the Toolbar
	 * Adds the Save, Cancel and Revert button
	 */
	@Override
	protected void initToolbar() {
<span class="fc" id="L202">		m_toolbar.setName(getName() + &quot;_toolbar&quot;);</span>
<span class="fc" id="L203">		ToolbarUtil.addValidateSaveBtn(m_toolbar, true);</span>
<span class="fc" id="L204">		ToolbarUtil.addConfirmDoneBtn(m_toolbar, true);</span>
<span class="fc" id="L205">		ToolbarUtil.addResetBtn(m_toolbar, true);</span>
<span class="fc" id="L206">	}</span>

	/**
	 * Return the form title
	 * @return String Identifies the form title
	 */
		@Override
	public String getFormTitle() {

		String strType;
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">		if(getCreateRuleType().equals(Request.REQUESTTYPE_TIMEOFF)) {</span>
<span class="fc" id="L217">			strType = i18n(m_rmBundle,RmWebBundleKey.REQUEST_TYPE_TIME_OFF);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">		} else if(getCreateRuleType().equals(Request.REQUESTTYPE_SHIFTSWAP)) {</span>
<span class="nc" id="L219">			strType = i18n(m_rmBundle,RmWebBundleKey.REQUEST_TYPE_SHIFT_SWAP);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">		} else if(getCreateRuleType().equals(Request.REQUESTTYPE_SHIFTSWAP_WITHDRAW)) {</span>
<span class="nc" id="L221">			strType = i18n(m_rmBundle,RmWebBundleKey.REQUEST_TYPE_SHIFT_SWAP_WITHDRAW);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">		}else if(getCreateRuleType().equals(Request.REQUESTTYPE_SHIFTBID)) {</span>
<span class="nc" id="L223">			strType = i18n(m_rmBundle,RmWebBundleKey.REQUEST_TYPE_SHIFT_BIDDING);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">		} else if(getCreateRuleType().equals(Request.REQUESTTYPE_CUSTSHIFT)) {</span>
<span class="nc" id="L225">			strType = i18n(m_rmBundle,RmWebBundleKey.REQUEST_TYPE_CUSTOM_SHIFT);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">		} else if(getCreateRuleType().equals(Request.REQUESTTYPE_FLEXTIME)) {</span>
<span class="nc" id="L227">			strType = i18n(m_rmBundle,RmWebBundleKey.REQUEST_TYPE_FLEX_TIME);</span>
		} else {
<span class="nc" id="L229">			strType = i18n(m_rmBundle,RmWebBundleKey.REQUEST_TYPE_TIME_OFF_WITHDRAW);</span>
		}
<span class="fc" id="L231">		Object[] args = new Object[] {strType};</span>

<span class="pc bpc" id="L233" title="1 of 2 branches missed.">		if (isNew()) {</span>
<span class="fc" id="L234">			return m_localizer.i18n(m_rmBundle,RmWebBundleKey.ORG_RM_CREATE_RULE_TEMPLATE,args);</span>
		} else {
<span class="nc" id="L236">			return m_localizer.i18n(m_rmBundle,RmWebBundleKey.ORG_RM_EDIT_RULE_TEMPLATE,args);</span>
		}
	}

	/**
	 * Gets entity name. Used for title.
	 * @return String Identifies the title entity
	 */
	@Override
	protected String getTitleEntityType() {
<span class="fc" id="L246">		return i18n(m_rmBundle, RmWebBundleKey.ORG_RM_FILING_RULE_LABEL);</span>
	}

	/**
	 * Returns an entity name. Used for title.
	 * @return String Identifies the entity name
	 */
	@Override
	protected String getEntityName() {
<span class="nc" id="L255">		return &quot;&quot;; </span>
	}

	/**
	 * Return URL for HTML Form Action
	 * @return 	String	Identifies the URL
	 */
	@Override
	public String getFormAction() {
<span class="fc" id="L264">		return &quot;request_processing_filingrulelist&quot;;</span>
	}

	/**
	 * @return ID	Identifies the Filing Rule ID
	 */
	public ID getRuleID() {
<span class="fc bfc" id="L271" title="All 2 branches covered.">		if (isAction(m_context, NEW_TIMEOFF) ||</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">			isAction(m_context, NEW_TIMEOFF_WITHDRAW) ||</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">			isAction(m_context, NEW_SHIFTBID) ||</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">			isAction(m_context, NEW_SHIFTSWAP) ||</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">			isAction(m_context, NEW_SHIFTSWAP_WITHDRAW) ||</span>
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">			isAction(m_context, NEW_CUSTOMSHIFT) ||</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">			isAction(m_context, NEW_FLEXTIME)) {</span>
<span class="fc" id="L278">			setPerformActionOnID(null);</span>
<span class="fc" id="L279">			return null;</span>
		}
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">		if (m_performActionOnIDs==null) {</span>
<span class="fc" id="L282">			return null;</span>
		}
<span class="nc" id="L284">		return m_performActionOnIDs[getEditIndex()];</span>
	}

    /**
     * Return true if request action is the same the specified action
     */
	public boolean isAction(RequestContext context, String action){
<span class="fc" id="L291">		String pageAction = getPageAction(context);</span>
<span class="pc bpc" id="L292" title="2 of 4 branches missed.">		if (pageAction==null || action==null) {</span>
<span class="nc" id="L293">			return false;</span>
		}

<span class="fc" id="L296">		return pageAction.equals(action);</span>
	}

	/**
	 * Return Page Action passed to Request Handler
	 */
	public String getPageAction(RequestContext context) {
<span class="fc" id="L303">	  return context.getRequest().getParameter(PageAction.PAGE_ACTION);</span>
	}
	/**
	 * Displays the page Header
	 * @return Identifies the page Header
	 */
	public String getHeaderText() {
<span class="fc" id="L310">		return getFormTitle();</span>
	}

	/**
	 * set and get Methods
	 */
	public void setCreateRuleType(String requestType) {
<span class="nc" id="L317">		m_filingRule.setRequestType(requestType);</span>
<span class="nc" id="L318">	}</span>

	public String getCreateRuleType() {
<span class="fc" id="L321">		return m_filingRule.getRequestType();</span>
	}

	public FilingRulePC getFilingRuleForm() {
<span class="fc" id="L325">		return m_filingRulePC;</span>
	}

	public RequestFilingRule getFilingRule() {
<span class="fc" id="L329">		return m_filingRule;</span>
	}

	public void setDateRangeStart(Date startDate) {
<span class="fc" id="L333">		m_filingRule.setStartDate(startDate);</span>
<span class="fc" id="L334">	}</span>

	public void setDateRangeEnd(Date endDate) {
<span class="fc" id="L337">		m_filingRule.setEndDate(endDate);</span>
<span class="fc" id="L338">	}</span>

	public void setDate(Date date) {
<span class="fc" id="L341">		m_filingRule.setFileByDate(date);</span>
<span class="fc" id="L342">	}</span>

	public Date getDate() {
<span class="nc" id="L345">		return m_filingRule.getFileByDate();</span>
	}
	
	public void setIntervalCount(int intervalInHours){
<span class="fc" id="L349">		m_filingRule.setIntervalDays(intervalInHours);	//@TODO rename setter to reflect hrs </span>
<span class="fc" id="L350">	}</span>

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L354">		boolean success=super.extractParameters(request);</span>

<span class="pc bpc" id="L356" title="1 of 2 branches missed.">		if (m_filingRulePC != null) {</span>
<span class="fc" id="L357">			setDate(m_filingRulePC.getExtractedDate());</span>
<span class="fc" id="L358">			setDateRangeStart(m_filingRulePC.getExtractedDateRangeStart());</span>
<span class="fc" id="L359">			setDateRangeEnd(m_filingRulePC.getExtractedDateRangeEnd());</span>
<span class="fc" id="L360">			setIntervalCount(m_filingRulePC.getExtractedIntervalCount());</span>
		}

<span class="fc" id="L363">		return success;</span>
	}

	@Override
<span class="fc" id="L367">	protected void initFieldValidators(){}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>