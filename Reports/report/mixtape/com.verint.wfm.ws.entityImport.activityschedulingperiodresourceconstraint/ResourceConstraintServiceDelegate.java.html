<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ResourceConstraintServiceDelegate.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.wfm.ws.entityImport.activityschedulingperiodresourceconstraint</a> &gt; <span class="el_source">ResourceConstraintServiceDelegate.java</span></div><h1>ResourceConstraintServiceDelegate.java</h1><pre class="source lang-java linenums">package com.verint.wfm.ws.entityImport.activityschedulingperiodresourceconstraint;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.annotation.PostConstruct;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.ActivitySPResourceConstraint;
import com.bluepumpkin.ejb.bbm.base.BbmCreateDuplicateKeyException;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.SystemType;
import com.bluepumpkin.ejb.core.Log;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.wfm.ws.ServiceApplicationException;
import com.verint.wfm.ws.entityImport.activityschedulingperiodresourceconstraint.model.ResourceConstraintDTO;
import com.verint.wfm.ws.entityImport.schedulingPeriod.SchedulingPeriodServiceDelegate;
import com.verint.wfm.ws.entityImport.schedulingPeriod.model.SchedulingPeriodDTO.SchedulingPeriodExternalNaturalKey;
import com.verint.wfm.ws.util.SyncUtil;

<span class="fc" id="L34">public class ResourceConstraintServiceDelegate {</span>

	private static final long serialVersionUID = 1L;
<span class="fc" id="L37">	private static Category CAT = Log</span>
<span class="fc" id="L38">			.initCategory(ResourceConstraintServiceDelegate.class.getName());</span>

<span class="fc" id="L40">	private CampaignManager m_campaignManager = null;</span>
<span class="fc" id="L41">	private ActivityManager m_activityManager = null;</span>
<span class="fc" id="L42">	private SchedulingPeriodServiceDelegate m_schedulingPeriodServiceDelegate = null;</span>

	public List&lt;ResourceConstraintNotPersistedInfo&gt; createOrUpdate(
			Collection&lt;ResourceConstraintDTO&gt; activitySchedulingPeriodResourceConstrainDTOs,
			String systemTypeName) throws ServiceApplicationException {

<span class="nc" id="L48">		SystemType systemType = SystemType.valueOf(systemTypeName);</span>
<span class="nc" id="L49">		CAT.info(&quot;createOrUpdate(): systemType.name(): &quot; + systemType.name());</span>
		
<span class="nc" id="L51">		List&lt;ResourceConstraintNotPersistedInfo&gt; constraintNotPersistedInfos = new ArrayList&lt;ResourceConstraintNotPersistedInfo&gt;();</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">		if (activitySchedulingPeriodResourceConstrainDTOs == null</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">				|| activitySchedulingPeriodResourceConstrainDTOs.isEmpty()) {</span>
<span class="nc" id="L54">			CAT.debug(&quot;No Resource Constraints to create/update&quot;);</span>
<span class="nc" id="L55">			return constraintNotPersistedInfos;</span>
		}

		// Convert From DTO's to entities so that the EJB layer can handle them
<span class="nc" id="L59">		List&lt;ActivitySPResourceConstraint&gt; newActivitySPResourceConstraints = new ArrayList&lt;ActivitySPResourceConstraint&gt;();</span>
<span class="nc" id="L60">		List&lt;ActivitySPResourceConstraint&gt; oldActivitySPResourceConstraints = new ArrayList&lt;ActivitySPResourceConstraint&gt;();</span>
		try {
<span class="nc" id="L62">			convertToEntity(activitySchedulingPeriodResourceConstrainDTOs, systemType,</span>
					newActivitySPResourceConstraints, oldActivitySPResourceConstraints,
					constraintNotPersistedInfos);
<span class="nc" id="L65">			CAT.info(&quot;Succeeded to convert DTOs!&quot;);</span>
<span class="nc" id="L66">		} catch (RuntimeException e) {</span>
<span class="nc" id="L67">			CAT.error(&quot;Unrecoverable system bug while converting DTO to entity constraint&quot;, e);</span>
<span class="nc" id="L68">			throw new ServiceApplicationException(e);</span>
<span class="nc" id="L69">		}</span>

<span class="nc bnc" id="L71" title="All 2 branches missed.">		if (m_campaignManager == null) {</span>
<span class="nc" id="L72">			CAT.error(&quot;In createOrUpdate method: bean manager does not exist&quot;);</span>
		}

		try {
<span class="nc" id="L76">			m_campaignManager.createActivitySPResourceConstraints(newActivitySPResourceConstraints);</span>
<span class="nc" id="L77">			m_campaignManager.updateActivitySPResourceConstraints(oldActivitySPResourceConstraints);</span>
<span class="nc" id="L78">		} catch (BbmCreateDuplicateKeyException e) {</span>
<span class="nc" id="L79">			CAT.error(&quot;Failed to persist the ActivitySPResourceConstraints!&quot;, e);</span>
<span class="nc" id="L80">			throw new ServiceApplicationException(&quot;Failed to persist the ActivitySPResourceConstraints!&quot;, e);</span>
<span class="nc" id="L81">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L82">			CAT.error(&quot;Failed to create the ActivitySPResourceConstraints!&quot;, e);</span>
<span class="nc" id="L83">			throw new ServiceApplicationException(&quot;Failed to create the ActivitySPResourceConstraints!&quot;, e);</span>
<span class="nc" id="L84">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L85">			CAT.error(&quot;Failed to update the ActivitySPResourceConstraints!&quot;, e);</span>
<span class="nc" id="L86">			throw new ServiceApplicationException(&quot;Failed to update the ActivitySPResourceConstraints!&quot;, e);</span>
<span class="nc" id="L87">		} catch (MultiUserException e) {</span>
<span class="nc" id="L88">			CAT.error(&quot;Failed to update the ActivitySPResourceConstraints!&quot;, e);</span>
<span class="nc" id="L89">			throw new ServiceApplicationException(&quot;Failed to update the ActivitySPResourceConstraints!&quot;, e);</span>
<span class="nc" id="L90">		} catch (RemoteException e) {</span>
<span class="nc" id="L91">			CAT.error(&quot;Failed to persist the ActivitySPResourceConstraints!&quot;, e);</span>
<span class="nc" id="L92">			throw new ServiceApplicationException(&quot;Failed to persist the ActivitySPResourceConstraints!&quot;, e);</span>
<span class="nc" id="L93">		}</span>
<span class="nc" id="L94">		return constraintNotPersistedInfos;</span>
	}

	// TODO areSaved()

	// ---------------------------------------------------------------------- helpers

	@PostConstruct
	public void postConstruct() {
		// Note: These are only available as remote beans which slows things down
		try {
<span class="fc" id="L105">			m_campaignManager = WfmManagerFactory.getCampaignManager();</span>
<span class="fc" id="L106">			m_schedulingPeriodServiceDelegate = new SchedulingPeriodServiceDelegate();</span>
<span class="fc" id="L107">			m_activityManager = WfmManagerFactory.getActivityManager();</span>
<span class="fc" id="L108">			m_schedulingPeriodServiceDelegate.postConstruct();</span>

<span class="fc" id="L110">			CAT.info(&quot;Succeeded to obtain reference to all managers :)&quot;);</span>
<span class="nc" id="L111">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L112">			CAT.error(&quot;Failed to obtain reference to a manager :(&quot;, e);</span>
<span class="fc" id="L113">		}</span>
<span class="fc" id="L114">	}</span>

	protected void convertToEntity(
			Collection&lt;ResourceConstraintDTO&gt; activitySchedulingPeriodResourceConstraintDTOs,
			SystemType systemType,
			Collection&lt;ActivitySPResourceConstraint&gt; newActivitySPResourceConstraints,
			Collection&lt;ActivitySPResourceConstraint&gt; oldActivitySPResourceConstraints,
			List&lt;ResourceConstraintNotPersistedInfo&gt; activitySchedulingPeriodResourceConstraintNotPersistedInfos)
			throws ServiceApplicationException {

<span class="nc" id="L124">		Collection&lt;SchedulingPeriodExternalNaturalKey&gt; keys = ResourceConstraintDTO</span>
<span class="nc" id="L125">				.convertToSchedulingPeriodExternalNaturalKeys(activitySchedulingPeriodResourceConstraintDTOs);</span>
<span class="nc" id="L126">		Map&lt;SchedulingPeriodExternalNaturalKey, ID&gt; naturalKeyLocalSIDMap = m_schedulingPeriodServiceDelegate</span>
<span class="nc" id="L127">				.convertToID(systemType, keys, new HashMap&lt;ID, Campaign&gt;(), false);</span>

		// First pass: detect errors, using iterator to delete erroneous DTOs
<span class="nc" id="L130">		for (Iterator&lt;ResourceConstraintDTO&gt; iterator = activitySchedulingPeriodResourceConstraintDTOs</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">				.iterator(); iterator.hasNext();) {</span>

<span class="nc" id="L133">			ResourceConstraintDTO constraintDTO = iterator.next();</span>
<span class="nc" id="L134">			ResourceConstraintNotPersistedInfo constraintNotPersistedInfo = new ResourceConstraintNotPersistedInfo(</span>
<span class="nc" id="L135">					constraintDTO.getResourceConstraintExternalKey());</span>
<span class="nc" id="L136">			constraintDTO.validate(constraintNotPersistedInfo);</span>

			// Does activity of that name exist?
<span class="nc" id="L139">			ID wfoActivityId = SyncUtil.getActivityIDByNameCaseInsensitive(constraintDTO.getResourceConstraintExternalKey().getActivityName(),</span>
					m_activityManager, false);
<span class="nc bnc" id="L141" title="All 2 branches missed.">			if (wfoActivityId == null) {</span>
<span class="nc" id="L142">				constraintNotPersistedInfo.addNoSuchActivityNameMessage(constraintDTO.getResourceConstraintExternalKey().getActivityName());</span>
			}

			// Does scheduling period of that key exist?
<span class="nc" id="L146">			ID spSID = naturalKeyLocalSIDMap.get(constraintDTO.getResourceConstraintExternalKey().getSchedulingPeriodExternalNaturalKey());</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">			if (spSID == null) {</span>
<span class="nc" id="L148">				constraintNotPersistedInfo.addNoSuchSchedulingPeriodMessage(constraintDTO.getResourceConstraintExternalKey()</span>
<span class="nc" id="L149">						.getSchedulingPeriodExternalNaturalKey());</span>
			}

<span class="nc bnc" id="L152" title="All 2 branches missed.">			if (!constraintNotPersistedInfo.getMessages().isEmpty()) {</span>
<span class="nc" id="L153">				activitySchedulingPeriodResourceConstraintNotPersistedInfos.add(constraintNotPersistedInfo);</span>
<span class="nc" id="L154">				iterator.remove();</span>
			}
<span class="nc" id="L156">		}</span>

		// Look up the pre-existing constraints (outer map by SP ID, inner map by activity ID)
<span class="nc" id="L159">		Map&lt;ID, Map&lt;ID, ActivitySPResourceConstraint&gt;&gt; mapOfMaps = new HashMap&lt;ID, Map&lt;ID, ActivitySPResourceConstraint&gt;&gt;();</span>
		try {
<span class="nc bnc" id="L161" title="All 2 branches missed.">			for (ID schedulingPeriodSID : naturalKeyLocalSIDMap.values()) {</span>
<span class="nc" id="L162">				Map&lt;ID, ActivitySPResourceConstraint&gt; activityConstraintMap = m_campaignManager</span>
<span class="nc" id="L163">						.getActivitySPResourceConstraintMap(schedulingPeriodSID);</span>
<span class="nc" id="L164">				mapOfMaps.put(schedulingPeriodSID, activityConstraintMap);</span>
<span class="nc" id="L165">			}</span>
<span class="nc" id="L166">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L167">			throw new ServiceApplicationException(e);</span>
<span class="nc" id="L168">		} catch (RemoteException e) {</span>
<span class="nc" id="L169">			throw new ServiceApplicationException(e);</span>
<span class="nc" id="L170">		}</span>

		// Second pass: copy data to entity
<span class="nc bnc" id="L173" title="All 2 branches missed.">		for (ResourceConstraintDTO constraintDTO : activitySchedulingPeriodResourceConstraintDTOs) {</span>
<span class="nc" id="L174">			ActivitySPResourceConstraint constraint = new ActivitySPResourceConstraint();</span>

<span class="nc" id="L176">			ID spSID = naturalKeyLocalSIDMap.get(constraintDTO.getResourceConstraintExternalKey().getSchedulingPeriodExternalNaturalKey());</span>
<span class="nc" id="L177">			constraint.setSpID(spSID);</span>

			// Set activity id (that it exists was validated above)
<span class="nc" id="L180">			ID wfoActivityId = SyncUtil.getActivityIDByNameCaseInsensitive(constraintDTO.getResourceConstraintExternalKey().getActivityName(),</span>
					m_activityManager, false);
<span class="nc" id="L182">			constraint.setActivityID(wfoActivityId);</span>

			// Set the minimum and maximum number of seats
<span class="nc" id="L185">			constraint.setMinChair(constraintDTO.getMinChair());</span>
<span class="nc" id="L186">			constraint.setMaxChair(constraintDTO.getMaxChair());</span>

			// Find whether the constraint is already in the database
<span class="nc" id="L189">			Map&lt;ID, ActivitySPResourceConstraint&gt; activityConstraintMap = mapOfMaps.get(spSID);</span>
<span class="nc" id="L190">			ActivitySPResourceConstraint constraintInDatabase = activityConstraintMap.get(wfoActivityId);</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">			if (constraintInDatabase != null) {</span>
<span class="nc" id="L192">				constraint.setID(constraintInDatabase.getID());</span>
<span class="nc" id="L193">				oldActivitySPResourceConstraints.add(constraint);</span>
			} else {
<span class="nc" id="L195">				newActivitySPResourceConstraints.add(constraint);</span>
			}
<span class="nc" id="L197">		}</span>
<span class="nc" id="L198">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>