<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SetingsRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.setup.settings</a> &gt; <span class="el_source">SetingsRequestHandler.java</span></div><h1>SetingsRequestHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.setup.settings;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.rm.l10n.RmSettingKey;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.bbm.organization.OrganizationRequestHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.system.RequestContext;

/**
 * Title          SetingsRequestHandler
 * Description	  Handle request for the Settings page
 * Copyright      Copyright (c) 2002
 * Company        Blue Pumpkin Software, Inc
 * @author        Shubhangi Chavan
 * @version       1.0
 */
<span class="fc" id="L36">public class SetingsRequestHandler extends OrganizationRequestHandler {</span>
<span class="fc" id="L37">	private static final Category log = Log.initCategory(SetingsRequestHandler.class.getName());</span>

	private static final int TYPE_STRING = 0;
	private static final int TYPE_BOOLEAN = 1;
	private static final int TYPE_REAL = 2;
	
	/**
	 * Process Request for the User page
	 * @param   context   RequestContext
	 * @throws Exception
	 */
	@Override
	public void processRequest(RequestContext context) throws Exception {
		// Process requested action
		// Also invoked when user clicks on manager and agent activation/deactivation button
<span class="fc bfc" id="L52" title="All 2 branches covered.">		if (isAction(context, PageAction.SAVE)) {</span>
<span class="fc" id="L53">			processSave(context, true);</span>
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">		} else if (isAction(context, PageAction.SAVE_AS)) {</span>
<span class="nc" id="L55">			processSave(context, false);</span>
		}
<span class="fc" id="L57">	}</span>

	/**
	 * Processes the Save action
	 * Fetch the data submitted by the user and pass it to the backend as a Key,
	 * value pair in the backend.
	 *
	 * @param context RequestContext        The Request context object
     * @param shallow - true if you want to update only this org, false to update children too.
	 */
	private void processSave(RequestContext context, boolean shallow) throws Exception {
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">		if (!isAuthorizedForOrg(context,</span>
				new String[] {
					PrivilegeKeys.TOM_ACTIVATETIMEOFFWORKFLOW,
					PrivilegeKeys.TOM_SETYEARFOREMPLOYEE,
					PrivilegeKeys.TOM_CONFIGURECALENDARCOLORS,
					PrivilegeKeys.TOM_SETPOLICIES,
					PrivilegeKeys.SS_SETPOLICIES,
					PrivilegeKeys.CS_SETPOLICIES,
					PrivilegeKeys.FT_SETPOLICIES,
				},
				true)) {
<span class="nc" id="L79">			return;</span>
		}

<span class="fc" id="L82">		SettingsPageModel model = new SettingsPageModel(context);</span>
<span class="fc" id="L83">		model.extractParameters(context.getRequest());</span>
<span class="fc" id="L84">        ID orgID = model.getSelectedIDObject();</span>

<span class="pc bpc" id="L86" title="2 of 4 branches missed.">		if (model.validate() &amp;&amp; orgID != null) {</span>
			String key;
<span class="fc" id="L88">			Localizer localizer = context.getLocalizer();</span>
<span class="fc" id="L89">			HttpServletRequest request = context.getRequest();</span>

			try {
<span class="fc" id="L92">				OrganizationSetting orgSetting = model.getConfiguration();</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">				if (orgSetting == null) {</span>
<span class="fc" id="L94">					orgSetting = new OrganizationSetting(new HashMap());</span>
				}
<span class="fc" id="L96">				Map map = orgSetting.getValues();</span>
				
				// Pass the HashMap that has the property list extracted from the request.
				// QA 95028: Disabled controls don't send values to back end. Ignore missing values
                
                //Time Off Management Activation 
				//This change is applicable to all fields. Right now doing only for boolean fields as part of ESR 4093766
				//QC-117407 ported from QC-115660
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">				if(model.isAuthorizedToConfigureTOMWorkflow())</span>
				{
<span class="fc" id="L106">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_PROCESS_VACATION_REQUEST,</span>
									 TYPE_BOOLEAN, request, map);
<span class="fc" id="L108">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_REQUEST_VACATION,</span>
									 TYPE_BOOLEAN, request, map);
				}

				//Time Off Request Options
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">				if(model.isAuthorizedToConfigureTORequestOptions()){</span>
<span class="fc" id="L114">					putNonNullValueInMap(RmSettingKey.ORG_RM_TIME_OFF_TIME_INTERVAL,</span>
							 TYPE_STRING, request, map);
<span class="fc" id="L116">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TIME_OFF_CHOICES_COUNT,</span>
							 TYPE_STRING, request, map);
				}

                //Agent Workflow Options
				//This change is applicable to all fields. Right now doing only for fields as part of ESR 4093766
				//QC-117407 ported from QC-115660
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">				if(model.isAuthorizedToConfigureTOMWorkflow())</span>
				{
<span class="fc" id="L125">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_ESCALATION,</span>
									 TYPE_BOOLEAN, request, map);
<span class="fc" id="L127">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_SHOW_AUTOPROCESSING_RULES,</span>
									 TYPE_BOOLEAN, request, map);
				}
<span class="fc" id="L130">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_SHOW_SCHEDULED_TIMEOFF,</span>
									 TYPE_BOOLEAN, request, map);
<span class="fc" id="L132">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_SHOW_PENDING_TIMEOFF,</span>
									 TYPE_BOOLEAN, request, map);
<span class="fc" id="L134">                String value = &quot;&quot;;</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">                if (null != (value = model.getGroupViewOrgIDs())) {</span>
<span class="fc" id="L136">					map.put(RmSettingKey.ORG_RM_SETTINGS_GROUP_VIEW_ORG_LIST, value);</span>
				}

                //Time Off Accrual 
<span class="fc" id="L140">                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ANIVERSARY_DATE, </span>
                                     TYPE_STRING, request, map);
<span class="fc" id="L142">                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_FIXED_DATE_MONTH,</span>
                                     TYPE_STRING, request, map);
<span class="fc" id="L144">                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_FIXED_DATE_DAY,</span>
                                     TYPE_STRING, request, map);
<span class="fc" id="L146">                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_MONTH,</span>
                                     TYPE_STRING, request, map);
<span class="fc" id="L148">                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_WEEK,</span>
                                     TYPE_STRING, request, map);

                //Flex Time
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">				if(model.isAuthorizedToConfigureFlexTime())	{</span>
<span class="nc" id="L153">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_BEFORE_SHIFT,</span>
									 TYPE_BOOLEAN, request, map);
<span class="nc" id="L155">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_AFTER_SHIFT,</span>
									 TYPE_BOOLEAN, request, map);
				}

                //Shift Swap
				//This change is applicable to all fields. Right now doing only for boolean fields as part of ESR 4093766
				//QC-117407 ported from QC-115660
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">				if(model.isAuthorizedToConfigureShiftSwap()) {</span>
<span class="fc" id="L163">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ENABLE_SHIFT_SWAP,</span>
                         TYPE_BOOLEAN, request, map);
				}
<span class="fc" id="L166">                value = &quot;&quot;;</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">                if (null != (value = model.getShiftSwapOrgIDs())) {</span>
<span class="fc" id="L168">					map.put(RmSettingKey.ORG_RM_SETTINGS_SHIFT_SWAP_ORG_LIST, value);</span>
				}
					//This change is applicable to all fields. Right now doing only for boolean fields as part of ESR 4093766
					//QC-117407 ported from QC-115660
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">				if(model.isAuthorizedToConfigureShiftSwap()) {</span>
<span class="fc" id="L173">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_DISABLE_ONE_WAY_SHIFT_SWAP,</span>
									 TYPE_BOOLEAN, request, map);            
<span class="fc" id="L175">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_PARTIAL_SHIFT_SWAP,</span>
                         TYPE_BOOLEAN, request, map);
<span class="fc" id="L177">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_PARTIAL_SHIFT_PICKUP,</span>
                         TYPE_BOOLEAN, request, map);
				}
<span class="fc" id="L180">                key = RmSettingKey.ORG_RM_SETTINGS_MAX_SWAP_NEGOTIATIONS;</span>
<span class="fc" id="L181">                map.put(key, getParameter(request, key));</span>

                //Shift Bidding
<span class="fc" id="L184">                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_MAX_PREFERENCE_VALUE,</span>
                                     TYPE_STRING, request, map);
<span class="fc" id="L186">                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_MAX_BIDS_PER_EMPLOYEE,</span>
                                     TYPE_STRING, request, map);
<span class="fc" id="L188">                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_SENIORITY_FACTOR,</span>
                                     TYPE_REAL, localizer, request, map);
<span class="fc" id="L190">                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_RANK_FACTOR,</span>
                                     TYPE_REAL, localizer, request, map);
<span class="fc" id="L192">                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_BONUSPOINT_FACTOR,</span>
                                     TYPE_REAL, localizer, request, map);
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">                if(LicenseUtil.isAdvancedRMLicense()){</span>
<span class="nc" id="L195">	                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_FILTER_BID_OPTIONS_BY_EMPLOYEE_TYPE,</span>
	                        TYPE_BOOLEAN, request, map);
<span class="nc" id="L197">	                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_DISPLAY_TEMPLATE_DESCRIPTION,</span>
	                        TYPE_BOOLEAN, request, map);
                }
                //Time Off Calendar Colors
<span class="fc" id="L201">                putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_AVAILABLE_COLOR,</span>
									 TYPE_STRING, request, map);
<span class="fc" id="L203">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_WORKING_COLOR,</span>
									 TYPE_STRING, request, map);
<span class="fc" id="L205">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_PENDING_COLOR,</span>
									 TYPE_STRING, request, map);
<span class="fc" id="L207">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_SCHEDULED_COLOR,</span>
									 TYPE_STRING, request, map);
<span class="fc" id="L209">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_NO_AVAILABLE_COLOR,</span>
									 TYPE_STRING, request, map);
<span class="fc" id="L211">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_NON_OPERATION_COLOR,</span>
									 TYPE_STRING, request, map);
<span class="fc" id="L213">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_BLACKOUT_COLOR,</span>
									 TYPE_STRING, request, map);
<span class="fc" id="L215">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_NON_WORKING_COLOR,</span>
									 TYPE_STRING, request, map);

				//Policies
<span class="fc" id="L219">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_POLICY,</span>
									 TYPE_STRING, request, map);
<span class="fc" id="L221">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_SS_POLICY,</span>
									 TYPE_STRING, request, map);
<span class="fc" id="L223">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_SB_POLICY,</span>
									 TYPE_STRING, request, map);
<span class="fc" id="L225">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_CS_POLICY,</span>
						 TYPE_STRING, request, map);
<span class="fc" id="L227">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_FT_POLICY,</span>
						 TYPE_STRING, request, map);

                //Custom Shift Requests 
<span class="fc" id="L231">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ENABLE_CUSTOM_SHIFT_REQUESTS, TYPE_BOOLEAN, request, map);</span>
<span class="fc" id="L232">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_OT_BEFORE_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="fc" id="L233">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_OT_AFTER_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="fc" id="L234">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_ENTIRE_OT_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="fc" id="L235">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_BEFORE_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="fc" id="L236">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_AFTER_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="fc" id="L237">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_ENTIRE_REGULAR_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="fc" id="L238">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_SHIFT_CHANGE_REQUESTS, TYPE_BOOLEAN, request, map);</span>
				
				
				
				
                //Save each section that contains at least one changed item
<span class="fc" id="L244">                keepOnlyChangedSections(orgSetting, orgID);</span>
<span class="fc" id="L245">				SettingsModelHandler.setSettings(orgID, orgSetting, shallow);</span>

<span class="nc" id="L247">			} catch (Exception ex) {</span>
<span class="nc" id="L248">				log.l7dError(RmWebLogBundleKey.ORG_RM_SETTINGS_ERROR_SAVE, ex);</span>
<span class="nc" id="L249">				String msgID = RmWebBundleKey.ORG_RM_SETTINGS_ERROR_SAVE;</span>
<span class="nc" id="L250">				model.addPageMessage(Message.ERROR_TYPE, msgID, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L251">				context.setPageModel(model);</span>
<span class="fc" id="L252">			}</span>
		}
<span class="fc" id="L254">	}</span>
    
	// QA 95028: Disabled controls don't send values to back end. Ignore missing values
	private void putNonNullValueInMap(String key, int parmType, HttpServletRequest request, Map map) {
<span class="fc" id="L258">		putNonNullValueInMap(key, parmType, null, request, map);</span>
<span class="fc" id="L259">	}</span>
	
	private void putNonNullValueInMap(String key, int parmType, Localizer localizer, 
									  HttpServletRequest request, Map map) {
<span class="fc" id="L263">		String parm = null;</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">		if (parmType == TYPE_STRING) {</span>
<span class="fc" id="L265">			parm = getParameter(request, key);</span>
<span class="fc bfc" id="L266" title="All 2 branches covered.">		} else if (parmType == TYPE_BOOLEAN) {</span>
<span class="fc" id="L267">			parm = getBooleanParameter(request, key);</span>
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">		} else if (parmType == TYPE_REAL) {</span>
<span class="fc" id="L269">			parm = getRealNumberParameter(request, key, localizer);</span>
		}
		
<span class="fc bfc" id="L272" title="All 2 branches covered.">		if (parm != null) {</span>
<span class="fc" id="L273">			map.put(key, parm);</span>
		}
<span class="fc" id="L275">	}</span>
	
	/**
	 * Get a normal html paramater.
	 *
	 * @param request - request
	 * @param key - the parameter name.
	 *
	 * @return String - the html parameter or null.
	 */
	private String getParameter(HttpServletRequest request, String key) {
<span class="fc" id="L286">		key = SettingsPageModel.getNameKey(key);</span>
<span class="fc" id="L287">		return request.getParameter(key);</span>
	}

	/**
	 * Get a boolean html paramater.
	 *
	 * @param request - request
	 * @param key - the parameter name.
	 *
	 * @return String - &quot;true&quot; or &quot;false&quot;
	 */
	private String getBooleanParameter(HttpServletRequest request, String key) {
<span class="fc" id="L299">		key = SettingsPageModel.getNameKey(key);</span>
<span class="fc bfc" id="L300" title="All 2 branches covered.">		return request.getParameter(key) == null ? &quot;false&quot; : &quot;true&quot;;</span>
	}

	/**
	 * Get a real number html paramater.
	 *
	 * @param request - request
	 * @param key - the parameter name.
	 *
	 * @return String - &quot;true&quot; or &quot;false&quot;
	 */
	private String getRealNumberParameter(HttpServletRequest request, String key, Localizer localizer) {
<span class="fc" id="L312">		key = SettingsPageModel.getNameKey(key);</span>
<span class="fc" id="L313">		return FormInputPC.extractLocalizedRealNumberAsString(request, key, localizer);</span>
	}
    
    /**
     * Get a list of all of the keys that have different values between two maps.
     * We assume both maps have the same keys.
     * @return A List of all of the keys from the maps which have different values between the two.
     */
    private List getDifferentValueKeys(Map map1, Map map2)
    {
<span class="fc" id="L323">        ArrayList diffValKeys = new ArrayList(20);</span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">        for (Iterator it=map1.keySet().iterator(); it.hasNext();)</span>
        {
<span class="fc" id="L326">            String curKey = (String)it.next();</span>
<span class="fc" id="L327">            String val1 = (String)map1.get(curKey);</span>
<span class="fc" id="L328">            String val2 = (String)map2.get(curKey);</span>
            
<span class="fc bfc" id="L330" title="All 2 branches covered.">            if (!isSameValue(curKey, val1, val2)) {</span>
<span class="fc" id="L331">				diffValKeys.add(curKey);</span>
			}
<span class="fc" id="L333">        }</span>
<span class="fc" id="L334">        return diffValKeys;    </span>
    }
    
    /**
     * Determines if two values are equal, depending on the type of key they represent. 
     * @param key The RM property key.
     * @param val1 The first value.
     * @param val2 The second value.
     * @return true if the two values should be considered equal, false otherwise.
     */
    private boolean isSameValue(String key, String val1, String val2)
    {
<span class="fc" id="L346">        boolean areSame = false;</span>
<span class="pc bpc" id="L347" title="3 of 4 branches missed.">        if (val1==null &amp;&amp; val2==null)</span>
        {
<span class="nc" id="L349">            areSame = true;</span>
        }
<span class="pc bpc" id="L351" title="1 of 4 branches missed.">        else if (val1==null || val2==null)</span>
        {
<span class="fc" id="L353">            areSame = false;</span>
        }
<span class="pc bpc" id="L355" title="1 of 4 branches missed.">        else if (isListKey(key) &amp;&amp; listValuesAreEqual(val1, val2))</span>
        {
<span class="nc" id="L357">            areSame = true;</span>
        }
<span class="fc bfc" id="L359" title="All 2 branches covered.">        else if (val1.equals(val2))</span>
        {
<span class="fc" id="L361">            areSame = true;</span>
        }
<span class="fc" id="L363">        return areSame;</span>
    }
    
    /**
     * Given String, determine whether the value should be interpreted as a comma-delimitted list.
     * @param key The name of the key.
     * @return true the key represents a comma-separated list of values.
     */
    private boolean isListKey(String key)
    {
<span class="fc bfc" id="L373" title="All 2 branches covered.">        if (RmSettingKey.ORG_RM_SETTINGS_GROUP_VIEW_ORG_LIST.equals(key)) {</span>
<span class="fc" id="L374">			return true;</span>
<span class="pc bpc" id="L375" title="1 of 2 branches missed.">		} else if (RmWebBundleKey.ORG_RM_SETTINGS_SHIFT_SWAP_ORG_LIST.equals(key)) {</span>
<span class="nc" id="L376">			return true;</span>
		}
        
<span class="fc" id="L379">        return false;</span>
    }
    
    /**
     * Given two comma-delimitted strings, determine whether they both contain the same values (order doesn't matter).
     * @param list1 The first comma-delimitted string.
     * @param list2 The second comma-delimitted string.
     * @return true if both contain the same values, false otherwise.
     */
    private boolean listValuesAreEqual(String list1, String list2)
    {
<span class="pc bpc" id="L390" title="3 of 4 branches missed.">        if (list1==null &amp;&amp; list2==null) {</span>
<span class="nc" id="L391">			return true;</span>
<span class="pc bpc" id="L392" title="2 of 4 branches missed.">		} else if (list1==null || list2==null) {</span>
<span class="nc" id="L393">			return false;</span>
		}
        
<span class="fc" id="L396">        list1 = list1.trim();</span>
<span class="fc" id="L397">        list2 = list2.trim();</span>
        
<span class="fc" id="L399">        String[] result1 = list1.split(&quot;,&quot;);</span>
<span class="fc" id="L400">        String[] result2 = list2.split(&quot;,&quot;);</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">        if (result1.length != result2.length) {</span>
<span class="fc" id="L402">			return false;</span>
		}
        
<span class="nc" id="L405">        HashSet set1 = new HashSet(result1.length);</span>
<span class="nc" id="L406">        HashSet set2 = new HashSet(result2.length);</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">        for (int i=0; i&lt;result1.length; i++)</span>
        {
<span class="nc" id="L409">            set1.add(result1[i]);</span>
<span class="nc" id="L410">            set2.add(result2[i]);</span>
        }
<span class="nc" id="L412">        return (set1.containsAll(set2));</span>
    }

    /**
     * Given an OrganizationSetting object, remove keys from all sections which have not changed.
     * If even a single key has changed in a section, we keep all of the keys in that section.
     * @param newSettings An OrganizationSetting object which has a settings map in it.
     */
    private void keepOnlyChangedSections(OrganizationSetting newSettings, ID orgID) throws Exception
    {
        //The orgSetting's map has all of the new settings. Compare with the original settings to 
        //decide which settings to actually save in the database.                
<span class="fc" id="L424">        OrganizationSetting oldSettings = SettingsModelHandler.getSettings(orgID);</span>
<span class="fc" id="L425">        Map oldMap = oldSettings.getValues();     </span>
<span class="fc" id="L426">        Map newMap = newSettings.getValues();  </span>
<span class="fc" id="L427">        List differentValueKeys = getDifferentValueKeys(newMap, oldMap);</span>
        
        //System.out.println(&quot;\n\nThe following key\\value pairs will be saved:&quot;);
<span class="fc" id="L430">        HashMap reducedMap = new HashMap(differentValueKeys.size());</span>
<span class="pc bpc" id="L431" title="1 of 2 branches missed.">        if (differentValueKeys.size() &gt; 0)</span>
        {
<span class="fc bfc" id="L433" title="All 2 branches covered.">            for (Iterator it=differentValueKeys.iterator(); it.hasNext();)</span>
            {
<span class="fc" id="L435">                String key = (String)it.next();</span>
                
                //add all of the keys in this key's section to the reducedMap
<span class="fc" id="L438">                String[] sectionKeys = getSectionKeys(key);</span>
<span class="fc bfc" id="L439" title="All 2 branches covered.">                for (int i=0; i&lt;sectionKeys.length; i++)</span>
                {
<span class="fc" id="L441">                    String sectionKey = sectionKeys[i];</span>
<span class="fc" id="L442">                    String value = (String)newMap.get(sectionKey);</span>
<span class="fc" id="L443">                    reducedMap.put(sectionKey, value);</span>
                    //System.out.println(sectionKey + &quot; &gt;&gt;---&gt; &quot; + value);
                }
<span class="fc" id="L446">            }</span>
        }
        //even if the reducedMap is empty, we still need to use it 
<span class="fc" id="L449">        newSettings.setValues(reducedMap);</span>
<span class="fc" id="L450">    }</span>
    
    /**
     * Given an RM property key, return all of the keys in its same section (including itself).
     * These are needed because all keys in a section are saved together.
     * @param key An RM property key
     * @return A String array of all of the keys in the keys's same section (including itself).
     */
    private String[] getSectionKeys(String key)
    {
<span class="pc bpc" id="L460" title="1 of 2 branches missed.">        if (key.equals(RmSettingKey.ORG_RM_SETTINGS_PROCESS_VACATION_REQUEST) </span>
<span class="pc bpc" id="L461" title="1 of 2 branches missed.">            || key.equals(RmSettingKey.ORG_RM_SETTINGS_REQUEST_VACATION)</span>
<span class="fc bfc" id="L462" title="All 2 branches covered.">            || key.equals(RmSettingKey.ORG_RM_SETTINGS_TIME_OFF_CHOICES_COUNT))</span>
        {
<span class="fc" id="L464">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_PROCESS_VACATION_REQUEST, </span>
                    RmSettingKey.ORG_RM_SETTINGS_REQUEST_VACATION,
                    RmSettingKey.ORG_RM_SETTINGS_TIME_OFF_CHOICES_COUNT};
        }
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">        else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_ESCALATION) </span>
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_SHOW_AUTOPROCESSING_RULES)</span>
<span class="fc bfc" id="L470" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_GROUP_VIEW_ORG_LIST))</span>
        {
<span class="fc" id="L472">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_ALLOW_ESCALATION, </span>
                    RmSettingKey.ORG_RM_SETTINGS_SHOW_AUTOPROCESSING_RULES,
                    RmSettingKey.ORG_RM_SETTINGS_GROUP_VIEW_ORG_LIST};
        }
<span class="fc bfc" id="L476" title="All 2 branches covered.">        else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_MAX_PREFERENCE_VALUE) </span>
<span class="fc bfc" id="L477" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_MAX_BIDS_PER_EMPLOYEE)</span>
<span class="fc bfc" id="L478" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_SENIORITY_FACTOR)</span>
<span class="fc bfc" id="L479" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_RANK_FACTOR)</span>
<span class="fc bfc" id="L480" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_BONUSPOINT_FACTOR)</span>
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_FILTER_BID_OPTIONS_BY_EMPLOYEE_TYPE)</span>
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_DISPLAY_TEMPLATE_DESCRIPTION))</span>
        {
<span class="fc" id="L484">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_MAX_PREFERENCE_VALUE, </span>
                    RmSettingKey.ORG_RM_SETTINGS_MAX_BIDS_PER_EMPLOYEE,
                    RmSettingKey.ORG_RM_SETTINGS_SENIORITY_FACTOR,
                    RmSettingKey.ORG_RM_SETTINGS_RANK_FACTOR,
                    RmSettingKey.ORG_RM_SETTINGS_BONUSPOINT_FACTOR,
                    RmSettingKey.ORG_RM_SETTINGS_FILTER_BID_OPTIONS_BY_EMPLOYEE_TYPE,
                    RmSettingKey.ORG_RM_SETTINGS_DISPLAY_TEMPLATE_DESCRIPTION};
        }
<span class="fc bfc" id="L492" title="All 2 branches covered.">        else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_ANIVERSARY_DATE) </span>
<span class="pc bpc" id="L493" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_FIXED_DATE_MONTH)</span>
<span class="pc bpc" id="L494" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_FIXED_DATE_DAY)</span>
                
<span class="pc bpc" id="L496" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_MONTH)</span>
<span class="pc bpc" id="L497" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_WEEK))</span>
        {
<span class="fc" id="L499">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_ANIVERSARY_DATE, </span>
                    RmSettingKey.ORG_RM_SETTINGS_FIXED_DATE_MONTH,
                    RmSettingKey.ORG_RM_SETTINGS_FIXED_DATE_DAY,
                    RmSettingKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_MONTH,
                    RmSettingKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_WEEK};
        }
<span class="pc bpc" id="L505" title="1 of 2 branches missed.">        else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_ENABLE_SHIFT_SWAP) </span>
<span class="fc bfc" id="L506" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_SHIFT_SWAP_ORG_LIST)</span>
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_DISABLE_ONE_WAY_SHIFT_SWAP)</span>
<span class="fc bfc" id="L508" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_PARTIAL_SHIFT_SWAP)</span>
<span class="fc bfc" id="L509" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_PARTIAL_SHIFT_PICKUP)</span>
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_MAX_SWAP_NEGOTIATIONS))</span>
        {
<span class="fc" id="L512">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_ENABLE_SHIFT_SWAP, </span>
                    RmSettingKey.ORG_RM_SETTINGS_SHIFT_SWAP_ORG_LIST,
                    RmSettingKey.ORG_RM_SETTINGS_DISABLE_ONE_WAY_SHIFT_SWAP,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_PARTIAL_SHIFT_SWAP,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_PARTIAL_SHIFT_PICKUP,
                    RmSettingKey.ORG_RM_SETTINGS_MAX_SWAP_NEGOTIATIONS};
        }
<span class="fc bfc" id="L519" title="All 2 branches covered.">        else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_AVAILABLE_COLOR) </span>
<span class="fc bfc" id="L520" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_BLACKOUT_COLOR)</span>
<span class="fc bfc" id="L521" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_NON_OPERATION_COLOR)</span>
<span class="fc bfc" id="L522" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_NON_WORKING_COLOR)</span>
<span class="fc bfc" id="L523" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_NO_AVAILABLE_COLOR)</span>
<span class="fc bfc" id="L524" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_WORKING_COLOR)</span>
<span class="fc bfc" id="L525" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_PENDING_COLOR)</span>
<span class="fc bfc" id="L526" title="All 2 branches covered.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_SCHEDULED_COLOR))</span>
        {
<span class="fc" id="L528">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_TO_AVAILABLE_COLOR, </span>
                    RmSettingKey.ORG_RM_SETTINGS_TO_BLACKOUT_COLOR,
                    RmSettingKey.ORG_RM_SETTINGS_TO_NON_OPERATION_COLOR,
                    RmSettingKey.ORG_RM_SETTINGS_TO_NON_WORKING_COLOR,
                    RmSettingKey.ORG_RM_SETTINGS_TO_NO_AVAILABLE_COLOR,
                    RmSettingKey.ORG_RM_SETTINGS_TO_WORKING_COLOR,
                    RmSettingKey.ORG_RM_SETTINGS_TO_PENDING_COLOR,
                    RmSettingKey.ORG_RM_SETTINGS_TO_SCHEDULED_COLOR};
        }
        
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">        else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_ENABLE_CUSTOM_SHIFT_REQUESTS) </span>
<span class="pc bpc" id="L539" title="1 of 2 branches missed.">        		|| key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_OT_BEFORE_SHIFT)</span>
<span class="pc bpc" id="L540" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_OT_AFTER_SHIFT)</span>
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_ENTIRE_OT_SHIFT)</span>
<span class="pc bpc" id="L542" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_BEFORE_SHIFT)</span>
<span class="pc bpc" id="L543" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_AFTER_SHIFT)</span>
<span class="pc bpc" id="L544" title="1 of 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_ENTIRE_REGULAR_SHIFT)</span>
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">		        || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_SHIFT_CHANGE_REQUESTS))</span>
        {
<span class="nc" id="L547">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_ENABLE_CUSTOM_SHIFT_REQUESTS,</span>
            		RmSettingKey.ORG_RM_SETTINGS_ALLOW_OT_BEFORE_SHIFT, 
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_OT_AFTER_SHIFT,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_ENTIRE_OT_SHIFT,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_BEFORE_SHIFT,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_AFTER_SHIFT,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_ENTIRE_REGULAR_SHIFT,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_SHIFT_CHANGE_REQUESTS};
<span class="pc bpc" id="L555" title="1 of 2 branches missed.">        } else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_BEFORE_SHIFT)</span>
<span class="pc bpc" id="L556" title="1 of 2 branches missed.">        		|| key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_AFTER_SHIFT)) {</span>
<span class="nc" id="L557">        	return new String[] {RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_BEFORE_SHIFT, </span>
        		RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_AFTER_SHIFT};
        }

<span class="fc" id="L561">        return new String[]{key};</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>