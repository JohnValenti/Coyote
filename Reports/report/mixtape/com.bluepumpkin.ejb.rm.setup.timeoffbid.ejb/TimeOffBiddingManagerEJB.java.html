<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffBiddingManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.setup.timeoffbid.ejb</a> &gt; <span class="el_source">TimeOffBiddingManagerEJB.java</span></div><h1>TimeOffBiddingManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.setup.timeoffbid.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.l10n.RmEjbLogBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.setup.timeoffbid.model.TimeOffBid;
import com.bluepumpkin.ejb.rm.setup.timeoffbid.model.TimeOffBidActivity;
import com.bluepumpkin.ejb.rm.setup.timeoffbid.model.TimeOffBidder;
import com.bluepumpkin.ejb.rm.setup.timeoffbid.model.TimeOffBidEmployee;

<span class="nc" id="L34">public class TimeOffBiddingManagerEJB extends SessionEJBBase {</span>

	private static final long serialVersionUID = 3308628928481776660L;
<span class="nc" id="L37">	private static final String CLASSNAME = TimeOffBiddingManagerEJB.class.getName();</span>
<span class="nc" id="L38">	private static Category catLog = Log.initCategory(TimeOffBiddingManagerEJB.CLASSNAME);</span>
	// non-static initializer
	{
<span class="nc" id="L41">		super.init(TimeOffBiddingManagerEJB.class.getName());</span>

<span class="nc" id="L43">	}</span>

	/**
	 * override the base class to provide the appropriate logging category
	 */
	@Override
	protected Category getCategory() {
<span class="nc" id="L50">		return catLog;</span>
	}

	public ID createTimeOffBid(TimeOffBid timeOffBid, Collection&lt;ID&gt; orgIds) throws BbmCreateException, RmHardValidationException {
<span class="nc" id="L54">		methodStart(&quot;createTimeOffBid&quot;, timeOffBid, orgIds);</span>
<span class="nc" id="L55">		TimeOffBidDAO dao = null;</span>
<span class="nc" id="L56">		ID id = null;</span>
		try {
<span class="nc" id="L58">			dao = new TimeOffBidDAO();</span>
<span class="nc" id="L59">			validateAuctionNotDuplicateName(timeOffBid, orgIds, null, RequestUtil.ACTION_CREATE);</span>
<span class="nc" id="L60">			validateRequestPeriodDateAfterBidEndDate(timeOffBid);</span>
<span class="nc" id="L61">			validateMinValueLesserThanMaxValuePerChoice(timeOffBid);</span>
<span class="nc" id="L62">			addTimeOffBidActivity(timeOffBid);</span>
<span class="nc" id="L63">			id = dao.createObject(timeOffBid);</span>
<span class="nc" id="L64">			return id;</span>
<span class="nc" id="L65">		} catch (BbmCreateException ex) {</span>
<span class="nc" id="L66">			handleException(ex);</span>
<span class="nc" id="L67">			throw ex;</span>
<span class="nc" id="L68">		} catch (RmHardValidationException e) {</span>
<span class="nc" id="L69">			handleException(e);</span>
<span class="nc" id="L70">			throw e;</span>
<span class="nc" id="L71">		} catch (Exception e) {</span>
<span class="nc" id="L72">			handleException(e);</span>
<span class="nc" id="L73">			throw RequestUtil.createBbmCreateExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L75" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L76">				dao.cleanUp();</span>
			}
<span class="nc" id="L78">			methodFinish();</span>
		}

	}

	public void deleteTimeOffBidsByIds(Collection&lt;ID&gt; timeOffBidIds) throws BbmRemoveException {
<span class="nc" id="L84">		methodStart(&quot;deleteTimeOffBidsByIds&quot;, timeOffBidIds);</span>
<span class="nc" id="L85">		TimeOffBidDAO dao = null;</span>

		try {
<span class="nc" id="L88">			dao = new TimeOffBidDAO();</span>
<span class="nc" id="L89">			dao.deleteObjects(timeOffBidIds);</span>
<span class="nc" id="L90">		} catch (BbmRemoveException ex) {</span>
<span class="nc" id="L91">			handleException(ex);</span>
<span class="nc" id="L92">			throw ex;</span>
		} finally {
<span class="nc bnc" id="L94" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L95">				dao.cleanUp();</span>
			}
		}
<span class="nc" id="L98">		methodFinish();</span>

<span class="nc" id="L100">	}</span>

	public void updateTimeOffBid(TimeOffBid timeOffBid, Collection&lt;ID&gt; orgIds) throws BbmUpdateException, RmHardValidationException {
<span class="nc" id="L103">		methodStart(&quot;updateTimeOffBid&quot;, timeOffBid, orgIds);</span>
<span class="nc" id="L104">		TimeOffBidDAO dao = null;</span>
		try {
<span class="nc" id="L106">			dao = new TimeOffBidDAO();</span>
<span class="nc" id="L107">			TimeOffBid bidBeforeUpdate = getTimeOffBidByID(timeOffBid.getId());</span>
<span class="nc" id="L108">			validateAuctionNotDuplicateName(timeOffBid, orgIds, bidBeforeUpdate, RequestUtil.ACTION_UPDATE);</span>
<span class="nc" id="L109">			validateRequestPeriodDateAfterBidEndDate(timeOffBid);</span>
<span class="nc" id="L110">			validateMinValueLesserThanMaxValuePerChoice(timeOffBid);</span>
<span class="nc" id="L111">			Collection&lt;String&gt; newSelectedIds = timeOffBid.getSelectedActivityIds();</span>
<span class="nc" id="L112">			updateActivities(bidBeforeUpdate, newSelectedIds);</span>
<span class="nc" id="L113">			dao.updateObject(timeOffBid);</span>

<span class="nc" id="L115">		} catch (MultiUserException e) {</span>
<span class="nc" id="L116">			handleException(e);</span>
<span class="nc" id="L117">			throw RequestUtil.createBbmUpdateExceptionWrapper(e, catLog);</span>
<span class="nc" id="L118">		} catch (RmHardValidationException e) {</span>
<span class="nc" id="L119">			handleException(e);</span>
<span class="nc" id="L120">			throw e;</span>
<span class="nc" id="L121">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L122">			handleException(e);</span>
<span class="nc" id="L123">			throw e;</span>
<span class="nc" id="L124">		} catch (Exception e) {</span>
<span class="nc" id="L125">			handleException(e);</span>
<span class="nc" id="L126">			throw RequestUtil.createBbmUpdateExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L128" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L129">				dao.cleanUp();</span>
			}
		}
<span class="nc" id="L132">		methodFinish();</span>

<span class="nc" id="L134">	}</span>

	public TimeOffBid getTimeOffBidByID(ID timeOffBidId) throws BbmFinderException {
<span class="nc" id="L137">		methodStart(&quot;getTimeOffBidByID&quot;, timeOffBidId);</span>
<span class="nc" id="L138">		TimeOffBidDAO dao = null;</span>
		try {
<span class="nc" id="L140">			dao = new TimeOffBidDAO();</span>
<span class="nc" id="L141">			return dao.getObjectByID(timeOffBidId);</span>
<span class="nc" id="L142">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L143">			handleException(e);</span>
<span class="nc" id="L144">			throw e;</span>
<span class="nc" id="L145">		} catch (Exception e) {</span>
<span class="nc" id="L146">			handleException(e);</span>
<span class="nc" id="L147">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L149" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L150">				dao.cleanUp();</span>
			}
<span class="nc" id="L152">			methodFinish();</span>
		}
	}

	public Collection&lt;TimeOffBid&gt; getTimeOffBidsForOrgIDs(Collection&lt;ID&gt; orgIds) throws BbmFinderException {
<span class="nc" id="L157">		methodStart(&quot;getTimeOffBidsForOrgIDs&quot;, orgIds);</span>
<span class="nc" id="L158">		TimeOffBidDAO dao = null;</span>
		try {
<span class="nc" id="L160">			dao = new TimeOffBidDAO();</span>
<span class="nc" id="L161">			return dao.getTimeOffBidsForOrgIDs(orgIds);</span>
<span class="nc" id="L162">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L163">			handleException(e);</span>
<span class="nc" id="L164">			throw e;</span>
<span class="nc" id="L165">		} catch (Exception e) {</span>
<span class="nc" id="L166">			handleException(e);</span>
<span class="nc" id="L167">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L169" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L170">				dao.cleanUp();</span>
			}
<span class="nc" id="L172">			methodFinish();</span>
		}
	}

	public Collection&lt;TimeOffBid&gt; getTimeOffBidsForOrgIDs(Collection&lt;ID&gt; orgIds, boolean needOrdered, boolean isAscending)
			throws BbmFinderException {
<span class="nc" id="L178">		methodStart(&quot;getTimeOffBidsForOrgIDs&quot;, orgIds, needOrdered, isAscending);</span>
<span class="nc" id="L179">		TimeOffBidDAO dao = null;</span>
		try {
<span class="nc" id="L181">			dao = new TimeOffBidDAO();</span>
<span class="nc" id="L182">			return dao.getTimeOffBidsForOrgIDs(orgIds, needOrdered, isAscending);</span>
<span class="nc" id="L183">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L184">			handleException(e);</span>
<span class="nc" id="L185">			throw e;</span>
<span class="nc" id="L186">		} catch (Exception e) {</span>
<span class="nc" id="L187">			handleException(e);</span>
<span class="nc" id="L188">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L190" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L191">				dao.cleanUp();</span>
			}
<span class="nc" id="L193">			methodFinish();</span>
		}
	}

	public Collection&lt;TimeOffBid&gt; getTimeOffBidsForOrgIDsAndStatus(Collection&lt;ID&gt; orgIds, int status) throws BbmFinderException {
<span class="nc" id="L198">		methodStart(&quot;getTimeOffBidsForOrgIDsAndStatus&quot;, orgIds, status);</span>
<span class="nc" id="L199">		TimeOffBidDAO dao = null;</span>
		try {
<span class="nc" id="L201">			dao = new TimeOffBidDAO();</span>
<span class="nc" id="L202">			return dao.getTimeOffBidsForOrgIDsAndStatus(orgIds, status);</span>
<span class="nc" id="L203">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L204">			handleException(e);</span>
<span class="nc" id="L205">			throw e;</span>
<span class="nc" id="L206">		} catch (Exception e) {</span>
<span class="nc" id="L207">			handleException(e);</span>
<span class="nc" id="L208">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L210" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L211">				dao.cleanUp();</span>
			}
<span class="nc" id="L213">			methodFinish();</span>
		}
	}

	public List&lt;ID&gt; createTimeOffBidders(ID selectedTimeOffBid, Collection&lt;TimeOffBidder&gt; listOfBidders) throws BbmCreateException,
			BbmFinderException {
<span class="nc" id="L219">		methodStart(&quot;createTimeOffBidders&quot;, listOfBidders);</span>
<span class="nc" id="L220">		List&lt;ID&gt; listOfIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">		if (listOfBidders == null || listOfBidders.isEmpty()) {</span>
<span class="nc" id="L222">			return listOfIDs;</span>
		}
<span class="nc" id="L224">		TimeOffBidderDAO dao = null;</span>
<span class="nc" id="L225">		TimeOffBidDAO tobDAO = null;</span>

		try {
<span class="nc" id="L228">			dao = new TimeOffBidderDAO();</span>
<span class="nc" id="L229">			tobDAO = new TimeOffBidDAO();</span>

<span class="nc" id="L231">			listOfIDs = (List&lt;ID&gt;) dao.createObjects(listOfBidders);</span>
			// Update Number of Bidders in Time Off Bid
<span class="nc" id="L233">			TimeOffBid timeOffBid = getTimeOffBidByID(selectedTimeOffBid);</span>
<span class="nc" id="L234">			int currentBidders = timeOffBid.getNumOfBidders();</span>
<span class="nc" id="L235">			timeOffBid.setNumOfBidders(currentBidders + listOfIDs.size());</span>
<span class="nc" id="L236">			tobDAO.updateObject(timeOffBid);</span>
<span class="nc" id="L237">		} catch (BbmCreateException ex) {</span>
<span class="nc" id="L238">			handleException(ex);</span>
<span class="nc" id="L239">			throw ex;</span>
<span class="nc" id="L240">		} catch (BbmFinderException ex) {</span>
<span class="nc" id="L241">			handleException(ex);</span>
<span class="nc" id="L242">			throw ex;</span>
<span class="nc" id="L243">		} catch (BbmUpdateException ex) {</span>
<span class="nc" id="L244">			handleException(ex);</span>
<span class="nc" id="L245">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L246">		} catch (MultiUserException ex) {</span>
<span class="nc" id="L247">			handleException(ex);</span>
<span class="nc" id="L248">			throw new BbmCreateException(ex);</span>
		} finally {
<span class="nc bnc" id="L250" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L251">				dao.cleanUp();</span>
			}
<span class="nc bnc" id="L253" title="All 4 branches missed.">			if (tobDAO != null) {</span>
<span class="nc" id="L254">				tobDAO.cleanUp();</span>
			}
		}
<span class="nc" id="L257">		methodFinish();</span>
<span class="nc" id="L258">		return listOfIDs;</span>
	}

	public void deleteTimeOffBidders(ID selectedTimeOffBid, Collection&lt;ID&gt; ids) throws BbmRemoveException, BbmFinderException {
<span class="nc" id="L262">		methodStart(&quot;removeTimeOffBidders&quot;, ids);</span>
<span class="nc bnc" id="L263" title="All 4 branches missed.">		if (ids == null || ids.isEmpty()) {</span>
<span class="nc" id="L264">			return;</span>
		}
<span class="nc" id="L266">		TimeOffBidderDAO dao = null;</span>
<span class="nc" id="L267">		TimeOffBidDAO tobDAO = null;</span>

		try {
<span class="nc" id="L270">			dao = new TimeOffBidderDAO();</span>
<span class="nc" id="L271">			tobDAO = new TimeOffBidDAO();</span>

<span class="nc" id="L273">			dao.deleteObjects(ids);</span>

			// Update Number of Bidders in Time Off Bid
<span class="nc" id="L276">			TimeOffBid timeOffBid = getTimeOffBidByID(selectedTimeOffBid);</span>
<span class="nc" id="L277">			int currentBidders = timeOffBid.getNumOfBidders();</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">			if (currentBidders - ids.size() &lt; 0) {</span>
<span class="nc" id="L279">				currentBidders = 0;</span>
			} else {
<span class="nc" id="L281">				currentBidders -= ids.size();</span>
			}
<span class="nc" id="L283">			timeOffBid.setNumOfBidders(currentBidders);</span>
<span class="nc" id="L284">			tobDAO.updateObject(timeOffBid);</span>
<span class="nc" id="L285">		} catch (BbmFinderException ex) {</span>
<span class="nc" id="L286">			handleException(ex);</span>
<span class="nc" id="L287">			throw ex;</span>
<span class="nc" id="L288">		} catch (BbmRemoveException ex) {</span>
<span class="nc" id="L289">			handleException(ex);</span>
<span class="nc" id="L290">			throw ex;</span>
<span class="nc" id="L291">		} catch (BbmUpdateException ex) {</span>
<span class="nc" id="L292">			handleException(ex);</span>
<span class="nc" id="L293">			throw new BbmRemoveException(ex);</span>
<span class="nc" id="L294">		} catch (MultiUserException ex) {</span>
<span class="nc" id="L295">			handleException(ex);</span>
<span class="nc" id="L296">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc bnc" id="L298" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L299">				dao.cleanUp();</span>
			}
<span class="nc bnc" id="L301" title="All 4 branches missed.">			if (tobDAO != null) {</span>
<span class="nc" id="L302">				tobDAO.cleanUp();</span>
			}
		}
<span class="nc" id="L305">		methodFinish();</span>
<span class="nc" id="L306">	}</span>

	public ID createTimeOffBidActivity(TimeOffBidActivity bidActivity) throws BbmCreateException {
<span class="nc" id="L309">		methodStart(&quot;createTimeOffBidActivity&quot;, bidActivity);</span>
<span class="nc" id="L310">		TimeOffBidActivityDAO dao = null;</span>
<span class="nc" id="L311">		ID id = null;</span>
		try {
<span class="nc" id="L313">			dao = new TimeOffBidActivityDAO();</span>
<span class="nc" id="L314">			id = dao.createObject(bidActivity);</span>
<span class="nc" id="L315">			return id;</span>
<span class="nc" id="L316">		} catch (BbmCreateException ex) {</span>
<span class="nc" id="L317">			handleException(ex);</span>
<span class="nc" id="L318">			throw ex;</span>
<span class="nc" id="L319">		} catch (Exception e) {</span>
<span class="nc" id="L320">			handleException(e);</span>
<span class="nc" id="L321">			throw RequestUtil.createBbmCreateExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L323" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L324">				dao.cleanUp();</span>
			}
<span class="nc" id="L326">			methodFinish();</span>
		}
	}

	public void deleteTimeOffBidActivity(ID id) throws BbmRemoveException {
<span class="nc" id="L331">		methodStart(&quot;deleteTimeOffBidActivity&quot;, id);</span>
<span class="nc" id="L332">		TimeOffBidActivityDAO dao = null;</span>

		try {
<span class="nc" id="L335">			dao = new TimeOffBidActivityDAO();</span>
<span class="nc" id="L336">			dao.deleteObject(id);</span>
<span class="nc" id="L337">		} catch (BbmRemoveException ex) {</span>
<span class="nc" id="L338">			handleException(ex);</span>
<span class="nc" id="L339">			throw ex;</span>
		} finally {
<span class="nc bnc" id="L341" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L342">				dao.cleanUp();</span>
			}
		}
<span class="nc" id="L345">		methodFinish();</span>

<span class="nc" id="L347">	}</span>

	public boolean checkHaveTimeOffBidRequestPending(ID timeOffBidId) throws BbmFinderException {
<span class="nc" id="L350">		methodStart(&quot;checkHaveTimeOffBidRequestPending&quot;, timeOffBidId);</span>
<span class="nc" id="L351">		TimeOffBidDAO dao = null;</span>
		try {
<span class="nc" id="L353">			dao = new TimeOffBidDAO();</span>
<span class="nc" id="L354">			return dao.checkHaveTimeOffBidRequestPending(timeOffBidId);</span>
<span class="nc" id="L355">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L356">			handleException(e);</span>
<span class="nc" id="L357">			throw e;</span>
<span class="nc" id="L358">		} catch (Exception e) {</span>
<span class="nc" id="L359">			handleException(e);</span>
<span class="nc" id="L360">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L362" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L363">				dao.cleanUp();</span>
			}
<span class="nc" id="L365">			methodFinish();</span>
		}
	}

	private boolean checkTimeOffBidNameExists(String name, Collection&lt;ID&gt; orgIds) throws BbmFinderException {
<span class="nc" id="L370">		methodStart(&quot;checkTimeOffBidNameExists&quot;, name, orgIds);</span>
<span class="nc" id="L371">		TimeOffBidDAO dao = null;</span>
		try {
<span class="nc" id="L373">			dao = new TimeOffBidDAO();</span>
<span class="nc" id="L374">			return dao.checkTimeOffBidNameExists(name, orgIds);</span>
<span class="nc" id="L375">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L376">			handleException(e);</span>
<span class="nc" id="L377">			throw e;</span>
<span class="nc" id="L378">		} catch (Exception e) {</span>
<span class="nc" id="L379">			handleException(e);</span>
<span class="nc" id="L380">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L382" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L383">				dao.cleanUp();</span>
			}
<span class="nc" id="L385">			methodFinish();</span>
		}
	}

	/**
	 * @param bidDao
	 * @param givenBidVoR
	 * @param actionType
	 */
	private void validateAuctionNotDuplicateName(TimeOffBid givenBidVo, Collection&lt;ID&gt; orgIds, TimeOffBid bidVOBeforeUpdate, int actionType)
			throws Exception {
<span class="nc bnc" id="L396" title="All 2 branches missed.">		if (actionType == RequestUtil.ACTION_UPDATE) {</span>
<span class="nc" id="L397">			String givenName = givenBidVo.getName();</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">			if (!givenName.equals(bidVOBeforeUpdate.getName())) {</span>
<span class="nc" id="L399">				boolean nameExist = checkTimeOffBidNameExists(givenName, orgIds);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">				if (nameExist) {</span>
<span class="nc" id="L401">					throw RequestUtil.createRmHardValidationException(RmEjbBundleKey.TIMEOFF_BID_SAME_NAME_EXISTS, givenBidVo.getName(),</span>
							catLog);
				}
			}
<span class="nc bnc" id="L405" title="All 2 branches missed.">		} else if (actionType == RequestUtil.ACTION_CREATE) {</span>
<span class="nc" id="L406">			boolean nameExist = checkTimeOffBidNameExists(givenBidVo.getName(), orgIds);</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">			if (nameExist) {</span>
<span class="nc" id="L408">				throw RequestUtil</span>
<span class="nc" id="L409">						.createRmHardValidationException(RmEjbBundleKey.TIMEOFF_BID_SAME_NAME_EXISTS, givenBidVo.getName(), catLog);</span>
			}
		}
<span class="nc" id="L412">	}</span>

	/**
	 * @param TIMEOFF_BID_PERIOD_OVERLAPPED
	 * @param givenBidVO
	 * @param bidVOBeforeUpdate
	 * @param actionType
	 */
	private void validateRequestPeriodDateAfterBidEndDate(TimeOffBid givenBidVO) throws Exception {
<span class="nc" id="L421">		Date requestPeriodStart = givenBidVO.getRequestStartTime();</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">		if (!requestPeriodStart.after(givenBidVO.getBidEndTime())) {</span>
<span class="nc" id="L423">			throw RequestUtil.createAndLogRmHardValidationException(RmEjbBundleKey.TIMEOFF_BID_REQUEST_START_NOT_AFTER_BID_END,</span>
					RmEjbLogBundleKey.TIMEOFF_BID_REQUEST_START_NOT_AFTER_BID_END,
<span class="nc" id="L425">					new Object[] { givenBidVO.getName(), givenBidVO.getID() }, catLog);</span>
		}
<span class="nc" id="L427">	}</span>

	/**
	

	/**
	 * 
	 * @param givenBidVO
	 */
	private void validateMinValueLesserThanMaxValuePerChoice(TimeOffBid givenBidVO) throws Exception {
<span class="nc" id="L437">		int minimumDays = TimeOffBidUtil.getMinimumDaysPerChoice(givenBidVO);</span>
<span class="nc" id="L438">		int maximumDays = TimeOffBidUtil.getMaximumsPerChoice(givenBidVO);</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">		if (maximumDays &lt; minimumDays) {</span>
<span class="nc" id="L440">			throw RequestUtil.createAndLogRmHardValidationException(RmEjbBundleKey.TIMEOFF_BID_MIN_VALUE_GREATER_MAX_VALUE,</span>
<span class="nc" id="L441">					RmEjbLogBundleKey.TIMEOFF_BID_MIN_VALUE_GREATER_MAX_VALUE, new Object[] { givenBidVO.getName(), givenBidVO.getID() },</span>
					catLog);
		}

<span class="nc" id="L445">	}</span>

	private void updateActivities(TimeOffBid bid, Collection&lt;String&gt; newSelectedIds) throws BbmFinderException, BbmCreateException,
			BbmRemoveException {
<span class="nc bnc" id="L449" title="All 4 branches missed.">		if (newSelectedIds != null &amp;&amp; !newSelectedIds.isEmpty()) {</span>
<span class="nc" id="L450">			Collection&lt;TimeOffBidActivity&gt; existingBidActivites = bid.getTimeOffBidActivities();</span>
<span class="nc" id="L451">			Collection&lt;String&gt; updateBidActivitesList = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">			for (Iterator&lt;TimeOffBidActivity&gt; iter = existingBidActivites.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L453">				TimeOffBidActivity bidActivity = iter.next();</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">				if (doesBidActivityExists(bidActivity.getActivityId(), newSelectedIds)) {</span>
<span class="nc" id="L455">					updateBidActivitesList.add(bidActivity.getActivityId().toString());</span>
				} else {
<span class="nc" id="L457">					deleteTimeOffBidActivity(bidActivity.getId());</span>
				}
<span class="nc" id="L459">			}</span>
			// After handling all removed and updated list, if there are remaining selected Ids, they will be created
<span class="nc" id="L461">			newSelectedIds.removeAll(updateBidActivitesList);</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">			for (Iterator&lt;String&gt; iter = newSelectedIds.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L463">				String activityId = iter.next();</span>
<span class="nc" id="L464">				TimeOffBidActivity bidActivity = new TimeOffBidActivity();</span>
<span class="nc" id="L465">				bidActivity.setActivityId(new ID(activityId));</span>
<span class="nc" id="L466">				bidActivity.setTimeOffBidId(bid.getId());</span>
<span class="nc" id="L467">				createTimeOffBidActivity(bidActivity);</span>
<span class="nc" id="L468">			}</span>
		}
<span class="nc" id="L470">	}</span>

	private void addTimeOffBidActivity(TimeOffBid bid) {
<span class="nc" id="L473">		Collection&lt;String&gt; selectedIds = bid.getSelectedActivityIds();</span>
<span class="nc bnc" id="L474" title="All 4 branches missed.">		if (selectedIds != null &amp;&amp; !selectedIds.isEmpty()) {</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">			for (Iterator&lt;String&gt; iter = selectedIds.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L476">				String activityId = iter.next();</span>
<span class="nc" id="L477">				TimeOffBidActivity bidActivity = new TimeOffBidActivity();</span>
<span class="nc" id="L478">				bidActivity.setActivityId(new ID(activityId));</span>
<span class="nc" id="L479">				bidActivity.setTimeOffBidId(bid.getId());</span>
<span class="nc" id="L480">				bid.addTimeOffBidActivity(bidActivity);</span>
<span class="nc" id="L481">			}</span>
		}
<span class="nc" id="L483">	}</span>

	private boolean doesBidActivityExists(ID checkBidActivityId, Collection&lt;String&gt; bidActivites) {

<span class="nc bnc" id="L487" title="All 2 branches missed.">		for (Iterator&lt;String&gt; iter = bidActivites.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L488">			String bidActivityIdStr = iter.next();</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">			if (checkBidActivityId.toString().equals(bidActivityIdStr)) {</span>
<span class="nc" id="L490">				return true;</span>
			}
<span class="nc" id="L492">		}</span>
<span class="nc" id="L493">		return false;</span>
	}

	public Collection&lt;TimeOffBidder&gt; getWaitingTimeOffBiddersForBid(ID bid, Collection&lt;ID&gt; orgIDs) throws BbmFinderException {
<span class="nc" id="L497">		methodStart(&quot;getWaitingTimeOffBiddersForBid&quot;, bid, orgIDs);</span>
<span class="nc" id="L498">		TimeOffBidderDAO timeOffbidderDAO = null;</span>

		try {
<span class="nc" id="L501">			timeOffbidderDAO = new TimeOffBidderDAO();</span>
<span class="nc" id="L502">			return timeOffbidderDAO.getWaitingTimeOffBiddersForBidByBidID(bid, orgIDs);</span>
<span class="nc" id="L503">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L504">			handleException(e);</span>
<span class="nc" id="L505">			throw e;</span>
<span class="nc" id="L506">		} catch (Exception e) {</span>
<span class="nc" id="L507">			handleException(e);</span>
<span class="nc" id="L508">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L510" title="All 4 branches missed.">			if (timeOffbidderDAO != null) {</span>
<span class="nc" id="L511">				timeOffbidderDAO.cleanUp();</span>
			}
<span class="nc" id="L513">			methodFinish();</span>
		}
	}

	public Pair&lt;Collection&lt;ID&gt;, Collection&lt;TimeOffBidder&gt;&gt; getTimeOffBiddersForBidID(ID bid, Collection&lt;ID&gt; orgIDs, int sortColumn,
			int sortDirection, int pageSize) throws BbmFinderException {
<span class="nc" id="L519">		methodStart(&quot;getTimeOffBiddersForBidID&quot;, bid, orgIDs, sortColumn, sortDirection, pageSize);</span>
<span class="nc" id="L520">		TimeOffBidderDAO timeOffbidderDAO = null;</span>
<span class="nc" id="L521">		int numOfBidders = 0;</span>
		try {
<span class="nc" id="L523">			timeOffbidderDAO = new TimeOffBidderDAO();</span>
<span class="nc" id="L524">			Collection&lt;TimeOffBidder&gt; timeOffBidders = timeOffbidderDAO.getTimeOffBiddersForBidByBidID(bid, orgIDs, sortColumn,</span>
					sortDirection);
<span class="nc" id="L526">			Collection&lt;ID&gt; timeOffBiddersIDs = extractTimeOffBidderEmployeeIDs(timeOffBidders);</span>
<span class="nc" id="L527">			numOfBidders = Math.min(timeOffBidders.size(), pageSize);</span>
<span class="nc" id="L528">			timeOffBidders = new ArrayList&lt;TimeOffBidder&gt;(((List&lt;TimeOffBidder&gt;) timeOffBidders).subList(0, numOfBidders));</span>
<span class="nc" id="L529">			return new Pair&lt;Collection&lt;ID&gt;, Collection&lt;TimeOffBidder&gt;&gt;(timeOffBiddersIDs, timeOffBidders);</span>
<span class="nc" id="L530">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L531">			handleException(e);</span>
<span class="nc" id="L532">			throw e;</span>
<span class="nc" id="L533">		} catch (Exception e) {</span>
<span class="nc" id="L534">			handleException(e);</span>
<span class="nc" id="L535">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L537" title="All 4 branches missed.">			if (timeOffbidderDAO != null) {</span>
<span class="nc" id="L538">				timeOffbidderDAO.cleanUp();</span>
			}
<span class="nc" id="L540">			methodFinish();</span>
		}
	}

	public Pair&lt;Collection&lt;ID&gt;, Collection&lt;TimeOffBidder&gt;&gt; getTimeOffBiddersForBidIDAndEmployeeIDs(ID bid, Collection&lt;ID&gt; employeeIDs,
			Collection&lt;ID&gt; orgIDs, int sortColumn, int sortDirection, int pageSize) throws BbmFinderException {
<span class="nc" id="L546">		methodStart(&quot;getTimeOffBiddersForBidIDAndEmployeeIDs&quot;, bid, employeeIDs, orgIDs, /* sortColumn, sortDirection, */pageSize);</span>
<span class="nc" id="L547">		TimeOffBidderDAO timeOffbidderDAO = null;</span>
<span class="nc" id="L548">		int numOfBidders = 0;</span>

		try {
<span class="nc" id="L551">			timeOffbidderDAO = new TimeOffBidderDAO();</span>
<span class="nc" id="L552">			Collection&lt;TimeOffBidder&gt; timeOffBidders = timeOffbidderDAO.getTimeOffBiddersForBidByBidIDandEmployeeIDs(bid, employeeIDs,</span>
					orgIDs, sortColumn, sortDirection);
<span class="nc" id="L554">			Collection&lt;ID&gt; timeOffBiddersIDs = extractTimeOffBidderEmployeeIDs(timeOffBidders);</span>
<span class="nc" id="L555">			numOfBidders = Math.min(timeOffBidders.size(), pageSize);</span>
<span class="nc" id="L556">			timeOffBidders = new ArrayList&lt;TimeOffBidder&gt;(((List&lt;TimeOffBidder&gt;) timeOffBidders).subList(0, numOfBidders));</span>
<span class="nc" id="L557">			return new Pair&lt;Collection&lt;ID&gt;, Collection&lt;TimeOffBidder&gt;&gt;(timeOffBiddersIDs, timeOffBidders);</span>
<span class="nc" id="L558">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L559">			handleException(e);</span>
<span class="nc" id="L560">			throw e;</span>
<span class="nc" id="L561">		} catch (Exception e) {</span>
<span class="nc" id="L562">			handleException(e);</span>
<span class="nc" id="L563">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L565" title="All 4 branches missed.">			if (timeOffbidderDAO != null) {</span>
<span class="nc" id="L566">				timeOffbidderDAO.cleanUp();</span>
			}
<span class="nc" id="L568">			methodFinish();</span>
		}
	}

	public Collection&lt;TimeOffBidder&gt; getNextTimeOffBidders(ID bid, Collection&lt;ID&gt; bidders, Collection&lt;ID&gt; orgIDs, int sortColumn,
			int sortDirection) throws BbmFinderException {
<span class="nc" id="L574">		methodStart(&quot;getNextTimeOffBidders&quot;, bidders, orgIDs, sortColumn, sortDirection);</span>
<span class="nc" id="L575">		TimeOffBidderDAO timeOffbidderDAO = null;</span>

		try {
<span class="nc" id="L578">			timeOffbidderDAO = new TimeOffBidderDAO();</span>
<span class="nc" id="L579">			return timeOffbidderDAO.getNextTimeOffBiddersForBidIDAndEmployeeIDs(bid, bidders, orgIDs, sortColumn, sortDirection);</span>
<span class="nc" id="L580">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L581">			handleException(e);</span>
<span class="nc" id="L582">			throw e;</span>
<span class="nc" id="L583">		} catch (Exception e) {</span>
<span class="nc" id="L584">			handleException(e);</span>
<span class="nc" id="L585">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L587" title="All 4 branches missed.">			if (timeOffbidderDAO != null) {</span>
<span class="nc" id="L588">				timeOffbidderDAO.cleanUp();</span>
			}
<span class="nc" id="L590">			methodFinish();</span>
		}
	}

	public Collection&lt;TimeOffBidder&gt; getWaitingTimeOffBiddersForBidIDAndEmployeeIDs(ID bid, Collection&lt;ID&gt; employeeIDs,
			Collection&lt;ID&gt; orgIDs) throws BbmFinderException {
<span class="nc" id="L596">		methodStart(&quot;getWaitingTimeOffBiddersForBidIDAndEmployeeIDs&quot;, bid, employeeIDs, orgIDs);</span>
<span class="nc" id="L597">		TimeOffBidderDAO timeOffbidderDAO = null;</span>

		try {
<span class="nc" id="L600">			timeOffbidderDAO = new TimeOffBidderDAO();</span>
<span class="nc" id="L601">			return timeOffbidderDAO.getWaitingTimeOffBiddersForBidIDAndEmployeeIDs(bid, employeeIDs, orgIDs);</span>
<span class="nc" id="L602">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L603">			handleException(e);</span>
<span class="nc" id="L604">			throw e;</span>
<span class="nc" id="L605">		} catch (Exception e) {</span>
<span class="nc" id="L606">			handleException(e);</span>
<span class="nc" id="L607">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L609" title="All 4 branches missed.">			if (timeOffbidderDAO != null) {</span>
<span class="nc" id="L610">				timeOffbidderDAO.cleanUp();</span>
			}
<span class="nc" id="L612">			methodFinish();</span>
		}
	}

	public Collection&lt;TimeOffBidEmployee&gt; assignMaxApprovedTimeToBidder(Collection&lt;TimeOffBidEmployee&gt; employees) {
<span class="nc" id="L617">		methodStart(&quot;assignMaxApprovedTimeToBidder&quot;, employees);</span>
<span class="nc" id="L618">		TimeOffBidderDAO bidderDAO = null;</span>
<span class="nc" id="L619">		boolean inBid = true;</span>
<span class="nc" id="L620">		Collection&lt;TimeOffBidEmployee&gt; notInBid = new ArrayList&lt;TimeOffBidEmployee&gt;();</span>

		try {
<span class="nc" id="L623">			bidderDAO = new TimeOffBidderDAO();</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">			for (Iterator&lt;TimeOffBidEmployee&gt; it = employees.iterator(); it.hasNext();) {</span>
<span class="nc" id="L625">				TimeOffBidEmployee employee = it.next();</span>
				try {
<span class="nc" id="L627">					inBid = bidderDAO.updateBiddersApproveTimeAndUnits(employee.getLastName(), employee.getFirstName(),</span>
<span class="nc" id="L628">							employee.getTimeOffBidID(), employee.getMaxApprovePeriod(), employee.getPeriodType());</span>

					// If result if false, add employee to not in Bid collection 
<span class="nc bnc" id="L631" title="All 2 branches missed.">					if (!inBid) {</span>
<span class="nc" id="L632">						employee.setStatus(TimeOffBidEmployee.NOT_IN_BID);</span>
<span class="nc" id="L633">						notInBid.add(employee);</span>
					}
<span class="nc" id="L635">				} catch (BbmFinderException e) {</span>
					// If BbmFinderException, add employee to not in Bid collection 
<span class="nc" id="L637">					employee.setStatus(TimeOffBidEmployee.NOT_IN_BID);</span>
<span class="nc" id="L638">					notInBid.add(employee);</span>
<span class="nc" id="L639">					handleException(e);</span>
<span class="nc" id="L640">				} catch (Exception e) {</span>
					// If Exception, add employee to not in Bid collection 
<span class="nc" id="L642">					employee.setStatus(TimeOffBidEmployee.NOT_IN_BID);</span>
<span class="nc" id="L643">					notInBid.add(employee);</span>
<span class="nc" id="L644">					handleException(e);</span>
<span class="nc" id="L645">				}</span>
<span class="nc" id="L646">			}</span>
		} finally {
<span class="nc bnc" id="L648" title="All 4 branches missed.">			if (bidderDAO != null) {</span>
<span class="nc" id="L649">				bidderDAO.cleanUp();</span>
			}
<span class="nc" id="L651">			methodFinish();</span>
<span class="nc" id="L652">		}</span>
<span class="nc" id="L653">		return notInBid;</span>
	}

	public Collection &lt;TimeOffBidder&gt; addToBid(ID bidID, Collection&lt;ID&gt; bidders) throws BbmFinderException {
<span class="nc" id="L657">		methodStart(&quot;addToBid&quot;, bidID, bidders);</span>
<span class="nc" id="L658">		TimeOffBid timeOffBid = null;</span>
<span class="nc" id="L659">		Collection &lt;TimeOffBidder&gt; canAddEmployees = Collections.emptyList();</span>

		try {
<span class="nc" id="L662">			timeOffBid = new TimeOffBid();</span>

<span class="nc" id="L664">			timeOffBid = getTimeOffBidByID(bidID);</span>
<span class="nc" id="L665">			canAddEmployees = employeesInOtherBids(bidID, bidders);</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">			if (canAddEmployees.size() == 0) {</span>
<span class="nc" id="L667">				Collection&lt;TimeOffBidder&gt; biddersToSave = createBidders(bidders, timeOffBid);</span>
<span class="nc" id="L668">				createTimeOffBidders(bidID, biddersToSave);</span>
			}
<span class="nc" id="L670">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L671">			handleException(e);</span>
<span class="nc" id="L672">			throw e;</span>
<span class="nc" id="L673">		} catch (Exception e) {</span>
<span class="nc" id="L674">			handleException(e);</span>
<span class="nc" id="L675">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc" id="L677">			methodFinish();</span>
<span class="nc" id="L678">		}</span>
<span class="nc" id="L679">		return canAddEmployees;</span>
	}

	protected Collection&lt;TimeOffBidder&gt; createBidders(Collection&lt;ID&gt; bidders, TimeOffBid bid) {
<span class="nc" id="L683">		Collection&lt;TimeOffBidder&gt; timeOffBidders = new ArrayList&lt;TimeOffBidder&gt;(bidders.size());</span>

<span class="nc bnc" id="L685" title="All 2 branches missed.">		for (Iterator&lt;ID&gt; it = bidders.iterator(); it.hasNext();) {</span>
<span class="nc" id="L686">			ID bidderID = it.next();</span>
<span class="nc" id="L687">			TimeOffBidder bidder = new TimeOffBidder();</span>

<span class="nc" id="L689">			bidder.setTimeOffBidId(bid.getId());</span>
<span class="nc" id="L690">			bidder.setEmployeeId(bidderID);</span>
<span class="nc" id="L691">			bidder.setStatus(1);</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">			if (bid.getIsApprovalMaxValueVariesByEmp()) {</span>
<span class="nc" id="L693">				bidder.setMaxNumOfPeriods(0);</span>
<span class="nc" id="L694">				bidder.setPeriodUnit(0);</span>
			} else {
<span class="nc" id="L696">				bidder.setMaxNumOfPeriods(bid.getMaxValueForApproval());</span>
<span class="nc" id="L697">				bidder.setPeriodUnit(bid.getMaxUnitForApproval());</span>
			}
<span class="nc" id="L699">			timeOffBidders.add(bidder);</span>
<span class="nc" id="L700">		}</span>
<span class="nc" id="L701">		return timeOffBidders;</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	public Collection &lt;TimeOffBidder&gt; employeesInOtherBids(ID bidID, Collection&lt;ID&gt; bidders) throws Exception {
		WorkResourceManager wkrManager;
<span class="nc" id="L707">		Collection&lt;ID&gt; bidOrgIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L708">		Collection&lt;ID&gt; orgIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L709">		Collection&lt;ID&gt; parentOrgIDs = new ArrayList&lt;ID&gt;();</span>
		TimeOffBid timeOffBid;
		Collection&lt;ID&gt; timeOffBidIDs;
<span class="nc" id="L712">		Collection &lt;TimeOffBidder&gt; result = Collections.emptyList();</span>

		try {
<span class="nc" id="L715">			wkrManager = BbmManagerFactory.getWorkResourceManager(false);</span>
<span class="nc" id="L716">			timeOffBid = getTimeOffBidByID(bidID);</span>
<span class="nc" id="L717">			bidOrgIDs.add(timeOffBid.getOrganizationId());</span>
<span class="nc" id="L718">			orgIDs = wkrManager.getOrganizationsChildrenByIDs(bidOrgIDs);</span>
<span class="nc" id="L719">			parentOrgIDs = wkrManager.getOrganizationsParentsByIDs(bidOrgIDs);</span>
<span class="nc" id="L720">			orgIDs.addAll(parentOrgIDs);</span>
<span class="nc" id="L721">			orgIDs.add(timeOffBid.getOrganizationId());</span>

<span class="nc" id="L723">			timeOffBidIDs = validateBidStartEndNotOverlap(timeOffBid, orgIDs);</span>
<span class="nc" id="L724">			result = checkforEmployeesInBids(timeOffBidIDs, bidders);</span>
<span class="nc" id="L725">		} catch (Exception ex) {</span>
<span class="nc" id="L726">			throw ex;</span>
<span class="nc" id="L727">		}</span>
<span class="nc" id="L728">		return result;</span>
	}

	protected Collection &lt;TimeOffBidder&gt; checkforEmployeesInBids(Collection&lt;ID&gt; bids, Collection&lt;ID&gt; bidders) throws BbmFinderException {
<span class="nc" id="L732">		methodStart(&quot;checkforEmployeesInBids&quot;, bids, bidders);</span>
<span class="nc" id="L733">		TimeOffBidderDAO dao = null;</span>
		try {
<span class="nc" id="L735">			dao = new TimeOffBidderDAO();</span>
<span class="nc" id="L736">			return dao.checkforEmployeesInBids(bids, bidders);</span>
<span class="nc" id="L737">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L738">			handleException(e);</span>
<span class="nc" id="L739">			throw e;</span>
<span class="nc" id="L740">		} catch (Exception e) {</span>
<span class="nc" id="L741">			handleException(e);</span>
<span class="nc" id="L742">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L744" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L745">				dao.cleanUp();</span>
			}
<span class="nc" id="L747">			methodFinish();</span>
		}
	}

	/**
	 * @param TIMEOFF_BID_PERIOD_OVERLAPPED
	 * @param givenBidVO
	 * @param bidVOBeforeUpdate
	 * @param actionType
	 */
	protected Collection&lt;ID&gt; validateBidStartEndNotOverlap(TimeOffBid givenBidVO, Collection&lt;ID&gt; orgIDs) throws Exception {
<span class="nc" id="L758">		TimeRange bidTimeRange = new TimeRange(givenBidVO.getBidStartTime(), givenBidVO.getBidEndTime());</span>
<span class="nc" id="L759">		Collection&lt;ID&gt; intersectingBids = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L760">		int status = 0;</span>

<span class="nc" id="L762">		Collection&lt;TimeOffBid&gt; bidsInOrgTree = getTimeOffBidsForOrgIDsAndStatus(orgIDs, status);</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">		for (Iterator&lt;TimeOffBid&gt; it = bidsInOrgTree.iterator(); it.hasNext();) {</span>
<span class="nc" id="L764">			TimeOffBid bid = it.next();</span>
<span class="nc" id="L765">			TimeRange range = new TimeRange(bid.getBidStartTime(), bid.getBidEndTime());</span>
<span class="nc bnc" id="L766" title="All 4 branches missed.">			boolean isOverlaped = bidTimeRange.isInside(range) || range.isInside(bidTimeRange)</span>
<span class="nc bnc" id="L767" title="All 4 branches missed.">					|| range.includes(bidTimeRange.getStartDate()) || range.includes(bidTimeRange.getEndDate());</span>
<span class="nc bnc" id="L768" title="All 4 branches missed.">			if (isOverlaped &amp;&amp; bid.getStatus() == 0) {</span>
<span class="nc" id="L769">				intersectingBids.add(bid.getId());</span>
			}
<span class="nc" id="L771">		}</span>
<span class="nc" id="L772">		return intersectingBids;</span>
	}

	public void removeFromBid(ID bidID, Collection&lt;ID&gt; bidders) throws BbmRemoveException {
<span class="nc" id="L776">		methodStart(&quot;removeFromBid&quot;, bidID, bidders);</span>
<span class="nc" id="L777">		TimeOffBidderDAO timeOffbidderDAO = null;</span>

		try {
<span class="nc" id="L780">			timeOffbidderDAO = new TimeOffBidderDAO();</span>
<span class="nc" id="L781">			Collection&lt;TimeOffBidder&gt; recordBidders = timeOffbidderDAO.getTimeOffBidderByBidIDandEmployeeIDs(bidID, bidders);</span>
<span class="nc" id="L782">			Collection&lt;ID&gt; bidderRecordIDs = extractTimeOffBidderIDs(recordBidders);</span>
<span class="nc" id="L783">			deleteTimeOffBidders(bidID, bidderRecordIDs);</span>
<span class="nc" id="L784">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L785">			handleException(e);</span>
<span class="nc" id="L786">			throw e;</span>
<span class="nc" id="L787">		} catch (Exception e) {</span>
<span class="nc" id="L788">			handleException(e);</span>
<span class="nc" id="L789">			throw RequestUtil.createBbmRemoveExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L791" title="All 4 branches missed.">			if (timeOffbidderDAO != null) {</span>
<span class="nc" id="L792">				timeOffbidderDAO.cleanUp();</span>
			}
<span class="nc" id="L794">			methodFinish();</span>
<span class="nc" id="L795">		}</span>
<span class="nc" id="L796">	}</span>

	protected Collection&lt;ID&gt; extractTimeOffBidderIDs(Collection&lt;TimeOffBidder&gt; bidders) {
<span class="nc" id="L799">		Collection&lt;ID&gt; recordBidderIDs = new ArrayList&lt;ID&gt;(bidders.size());</span>

<span class="nc bnc" id="L801" title="All 2 branches missed.">		for (Iterator&lt;TimeOffBidder&gt; it = bidders.iterator(); it.hasNext();) {</span>
<span class="nc" id="L802">			TimeOffBidder bidder = it.next();</span>
<span class="nc" id="L803">			recordBidderIDs.add(bidder.getID());</span>
<span class="nc" id="L804">		}</span>
<span class="nc" id="L805">		return recordBidderIDs;</span>
	}

	protected Collection&lt;ID&gt; extractTimeOffBidderEmployeeIDs(Collection&lt;TimeOffBidder&gt; bidders) {
<span class="nc" id="L809">		Collection&lt;ID&gt; bidderEmployeeIDs = new ArrayList&lt;ID&gt;(bidders.size());</span>

<span class="nc bnc" id="L811" title="All 2 branches missed.">		for (Iterator&lt;TimeOffBidder&gt; it = bidders.iterator(); it.hasNext();) {</span>
<span class="nc" id="L812">			TimeOffBidder bidder = it.next();</span>
<span class="nc" id="L813">			bidderEmployeeIDs.add(bidder.getEmployeeId());</span>
<span class="nc" id="L814">		}</span>
<span class="nc" id="L815">		return bidderEmployeeIDs;</span>
	}

	public Collection&lt;ID&gt; getActivityIDsByBidId(ID bidId) throws BbmFinderException {
<span class="nc" id="L819">		Collection&lt;ID&gt; activityIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L820">		methodStart(&quot;getActivityIDsByBidId&quot;, bidId);</span>
<span class="nc" id="L821">		TimeOffBidActivityDAO dao = null;</span>

		try {
<span class="nc" id="L824">			dao = new TimeOffBidActivityDAO();</span>
<span class="nc" id="L825">			activityIds = dao.getActivityIDsByBidId(bidId);</span>
<span class="nc" id="L826">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L827">			handleException(e);</span>
<span class="nc" id="L828">			throw e;</span>
<span class="nc" id="L829">		} catch (Exception e) {</span>
<span class="nc" id="L830">			handleException(e);</span>
<span class="nc" id="L831">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L833" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L834">				dao.cleanUp();</span>
			}
<span class="nc" id="L836">			methodFinish();</span>
<span class="nc" id="L837">		}</span>
<span class="nc" id="L838">		return activityIds;</span>
	}

	public Map&lt;ID, String&gt; getActivityIDNamesInBidsByOrgIds(Collection&lt;ID&gt; orgIds) throws BbmFinderException {
<span class="nc" id="L842">		Map&lt;ID, String&gt; hashNames = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L843">		methodStart(&quot;getActivityNamesByBidsIds&quot;, orgIds);</span>
<span class="nc" id="L844">		TimeOffBidActivityDAO dao = null;</span>

		try {
<span class="nc" id="L847">			dao = new TimeOffBidActivityDAO();</span>
<span class="nc" id="L848">			hashNames = dao.getActivityIDNamesInBidsByOrgIds(orgIds);</span>
<span class="nc" id="L849">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L850">			handleException(e);</span>
<span class="nc" id="L851">			throw e;</span>
<span class="nc" id="L852">		} catch (Exception e) {</span>
<span class="nc" id="L853">			handleException(e);</span>
<span class="nc" id="L854">			throw RequestUtil.createBbmFinderExceptionWrapper(e, catLog);</span>
		} finally {
<span class="nc bnc" id="L856" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L857">				dao.cleanUp();</span>
			}
<span class="nc" id="L859">			methodFinish();</span>
<span class="nc" id="L860">		}</span>
<span class="nc" id="L861">		return hashNames;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>