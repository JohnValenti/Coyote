<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OrgCalendarOptionsPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.organization</a> &gt; <span class="el_source">OrgCalendarOptionsPC.java</span></div><h1>OrgCalendarOptionsPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.organization;

import java.util.HashMap;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.Set;

import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.setup.general.BaseOrganizationExtensionPC;
import com.bluepumpkin.web.bbm.organization.setup.general.OrganizationGeneralSettingPageModel;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.container.Collapsible2ColFormPC;
import com.witness.web.uif.pagecomponent.container.ListContainerPC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.reflection.ReflectionObject;
import com.witness.web.uif.validator.InRangeFieldValidator;
import com.bluepumpkin.ejb.rm.l10n.RmSettingKey;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;


/**
 * This class creates a section of the Organization Settings page, specifically for org-based Web Calendar settings.
 */
public class OrgCalendarOptionsPC extends BaseOrganizationExtensionPC {
	
	private static final long serialVersionUID = -1L;
	
	public static final String CONTACT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE_FN = &quot;ContactAboveReqTolerance&quot;;
	public static final String CONTACT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE_FN = &quot;ContactBelowReqTolerance&quot;;
	public static final String PROJECT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE_FN = &quot;ProjectAboveReqTolerance&quot;;
	public static final String PROJECT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE_FN = &quot;ProjectBelowReqTolerance&quot;;

	public static final int MIN_TOLERANCE = 0;
	public static final int MAX_TOLERANCE_ABOVE_REQ = 1000;
	public static final int MAX_TOLERANCE_BELOW_REQ = 100;
	public static final int DEFAULT_TOLERANCE = 15;
	
<span class="fc" id="L48">	int contactAboveReqTolerance = DEFAULT_TOLERANCE;</span>
<span class="fc" id="L49">	int contactBelowReqTolerance = DEFAULT_TOLERANCE;</span>
<span class="fc" id="L50">	int projectAboveReqTolerance = DEFAULT_TOLERANCE;</span>
<span class="fc" id="L51">	int projectBelowReqTolerance = DEFAULT_TOLERANCE;</span>
	
	protected ResourceBundle fsbundle;
	protected ResourceBundle bbmBundle;	
	FormInputPC formInputPC;
	
	//Settings and inheritance variables
	
	//the settings for the selected org (includes inheritted settings)
	OrganizationSetting settings; 
	
	//maps each inheritted key to the ancestor orgName from which it was inheritted
    Map ancestorNames;
    Map ancestorIDs; 
<span class="fc" id="L65">    ID ancestor = null;</span>
    
    //tells us whether the current org has any children.
<span class="fc" id="L68">    boolean hasChildren = false;</span>
    
    RequestContext context;

    /**
     * Constructor.
     */
	public OrgCalendarOptionsPC(RequestContext theContext, OrganizationGeneralSettingPageModel parentPM) {
<span class="fc" id="L76">		super(theContext, parentPM);</span>

<span class="fc" id="L78">		fsbundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L79">		bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L80">		formInputPC = new FormInputPC(theContext);</span>
<span class="fc" id="L81">		context = theContext;</span>
<span class="fc" id="L82">		this.addChildComponent(formInputPC);</span>
<span class="fc" id="L83">	}</span>

	/**
	 * Load data to be displayed.
	 */
	public void loadData() throws Exception {
		
<span class="fc" id="L90">		ID orgID = getOrgID();</span>
		
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">		if (getParentPM().isAddMode()) {</span>
			//By default, new Organization inherits from parent
<span class="nc bnc" id="L94" title="All 2 branches missed.">			if (!this.isInheriting()) {</span>
<span class="nc" id="L95">				this.setInheritFrom( orgID );</span>
			}
		}
		
<span class="fc" id="L99">		initOrgSettings();</span>
<span class="fc" id="L100">	}</span>
	
	/**
	 * Returns true if the user authorized to configure this section.
	 */
	protected boolean isAuthorizedToConfigure() {
<span class="fc" id="L106">		return getParentPM().isAuthorizedToConfigure();</span>
	}

	/**
	 * Initializae the form elements.
	 */
	public void initForm() {
		
<span class="fc" id="L114">		initOrgSettings();</span>
		
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">		if (!isAuthorizedToConfigure()) {</span>
			String key;
<span class="nc" id="L118">			key = BbmWebBundleKey.NOT_AUTHORIZED_TO_CONFIG_SELECTED_ORG;</span>
<span class="nc" id="L119">			String msg = i18n(bbmBundle, key);</span>
<span class="nc" id="L120">			addPageMessage(Message.RESPONSE_TYPE, msg);</span>
		}
		
<span class="fc" id="L123">		boolean isEditable = isAuthorizedToConfigure();</span>
				
		//CONTACT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE setting		
<span class="fc" id="L126">		int contactAboveReqTolerance = getContactAboveReqTolerance();</span>
<span class="fc" id="L127">		String contactAboveReqToleranceUI = getInput(CONTACT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE_FN, </span>
<span class="fc" id="L128">				String.valueOf(contactAboveReqTolerance), </span>
				FormInputPC.TYPE_INTEGER,
				FsWebBundleKey.CONTACT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE, isEditable, true);		
<span class="fc" id="L131">		this.addRow(i18n(fsbundle, FsWebBundleKey.CONTACT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE), contactAboveReqToleranceUI);		</span>
<span class="fc" id="L132">		getParentPM().addValidator(new InRangeFieldValidator(getParentPM(), CONTACT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE_FN,</span>
				FsWebBundleKey.CONTACT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE, FsWebBundleKey.BUNDLE_NAME,	MIN_TOLERANCE, MAX_TOLERANCE_ABOVE_REQ));
		

		//CONTACT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE setting		
<span class="fc" id="L137">		int contactBelowReqTolerance = getContactBelowReqTolerance();		</span>
<span class="fc" id="L138">		String contactBelowReqToleranceUI = getInput(CONTACT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE_FN,</span>
<span class="fc" id="L139">				String.valueOf(contactBelowReqTolerance), </span>
				FormInputPC.TYPE_INTEGER,
				FsWebBundleKey.CONTACT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE, isEditable, true);		
<span class="fc" id="L142">		this.addRow(i18n(fsbundle, FsWebBundleKey.CONTACT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE), contactBelowReqToleranceUI);		</span>
<span class="fc" id="L143">		getParentPM().addValidator(new InRangeFieldValidator(getParentPM(), CONTACT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE_FN,</span>
				FsWebBundleKey.CONTACT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE, FsWebBundleKey.BUNDLE_NAME,	MIN_TOLERANCE, MAX_TOLERANCE_BELOW_REQ));

		
		//PROJECT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE setting		
<span class="fc" id="L148">		int projectAboveReqTolerance = getProjectAboveReqTolerance();		</span>
<span class="fc" id="L149">		String projectAboveReqToleranceUI = getInput(PROJECT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE_FN, </span>
<span class="fc" id="L150">				String.valueOf(projectAboveReqTolerance), </span>
				FormInputPC.TYPE_INTEGER,
				FsWebBundleKey.PROJECT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE, isEditable, true);		
<span class="fc" id="L153">		this.addRow(i18n(fsbundle, FsWebBundleKey.PROJECT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE), projectAboveReqToleranceUI);		</span>
<span class="fc" id="L154">		getParentPM().addValidator(new InRangeFieldValidator(getParentPM(), PROJECT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE_FN,</span>
				FsWebBundleKey.PROJECT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE, FsWebBundleKey.BUNDLE_NAME,	MIN_TOLERANCE, MAX_TOLERANCE_ABOVE_REQ));

		
		//PROJECT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE setting
<span class="fc" id="L159">		int projectBelowReqTolerance = getProjectBelowReqTolerance();		</span>
<span class="fc" id="L160">		String projectBelowReqToleranceUI = getInput(PROJECT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE_FN, </span>
<span class="fc" id="L161">				String.valueOf(projectBelowReqTolerance), </span>
				FormInputPC.TYPE_INTEGER,
				FsWebBundleKey.PROJECT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE, isEditable, true);		
<span class="fc" id="L164">		this.addRow(i18n(fsbundle, FsWebBundleKey.PROJECT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE), projectBelowReqToleranceUI);		</span>
<span class="fc" id="L165">		getParentPM().addValidator(new InRangeFieldValidator(getParentPM(), PROJECT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE_FN,</span>
				FsWebBundleKey.PROJECT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE, FsWebBundleKey.BUNDLE_NAME,	MIN_TOLERANCE, MAX_TOLERANCE_BELOW_REQ));		
<span class="fc" id="L167">	}</span>

	/**
	 * Initialize the m_settings member variable with the org settings for the currently selected organization,
	 * unless it has already been initialized.
	 */
	public void initOrgSettings()  {
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">		if (settings == null) {</span>
			try {
<span class="nc" id="L176">				ID orgID = getOrgID();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">				if (orgID != null) {</span>
<span class="nc" id="L178">					hasChildren = OrgCalendarOptionsMH.getHasChildren(context, orgID);</span>
<span class="nc" id="L179">					settings = OrgCalendarOptionsMH.getSettings(context, orgID);</span>
<span class="nc" id="L180">					ancestorNames = settings.getAncestors();</span>
<span class="nc" id="L181">					ancestorIDs = settings.getAncestorIDs();</span>
<span class="nc" id="L182">					ancestor = getAncestor(RmSettingKey.ORG_FS_SETTINGS_CONTACT_QUEUE_ABOVE_REQ_TOLERANCE);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">					ancestor = (ancestor != null) ? ancestor : getAncestor(RmSettingKey.ORG_FS_SETTINGS_CONTACT_QUEUE_BELOW_REQ_TOLERANCE);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">					ancestor = (ancestor != null) ? ancestor : getAncestor(RmSettingKey.ORG_FS_SETTINGS_PROJECT_QUEUE_ABOVE_REQ_TOLERANCE);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">					ancestor = (ancestor != null) ? ancestor : getAncestor(RmSettingKey.ORG_FS_SETTINGS_PROJECT_QUEUE_BELOW_REQ_TOLERANCE);</span>

				} else {
<span class="nc" id="L188">					settings = null; </span>
<span class="nc" id="L189">					ancestor = null;</span>
				}

<span class="nc" id="L192">			} catch (Exception ex) {</span>
<span class="nc" id="L193">				handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L194">			}</span>
		}
<span class="fc" id="L196">	}</span>
    
	/**
	 * Get the ID of the selected organization.
	 * @return
	 */
	public ID getOrgID() {
<span class="fc" id="L203">		return getOrganization().getID();</span>
	}
	
    /**
     * Given a key, return the ID of the ancestor org from which it was inheritted, or null if none.
     * You must have already set the m_ancestors variable.
     * @param key An RM settings key.
     * @return The ID of the ancestor org from which it was inheritted, or null if none.
     */
    private ID getAncestor(String key)
    {
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (ancestorIDs == null) {</span>
<span class="nc" id="L215">            return null;</span>
        }
<span class="nc" id="L217">        return (ID)ancestorIDs.get(key);</span>
    }

    /**
     * Get an HTML input text field with the specified properties.
     */
	private String getInput(String fn, String value, int type, String rbKey,
			boolean isEditable, boolean isRequired) {
<span class="fc" id="L225">		formInputPC.reset();</span>
<span class="fc" id="L226">		formInputPC.setInputFN(fn);</span>
<span class="fc" id="L227">		formInputPC.setInputValue(value);</span>
<span class="fc" id="L228">		formInputPC.setInputType(type);</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">		formInputPC.setIsReadOnly(!isEditable);</span>
<span class="fc" id="L230">		formInputPC.setIsRequired(isRequired);</span>
<span class="fc" id="L231">		formInputPC.setInputFieldDesc(rbKey, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L232">		formInputPC.initForDisplay();</span>
<span class="fc" id="L233">		formInputPC.setOnChangeJS(formInputPC.getOnChangeJS() + this.getInputOnChangeJS());</span>
<span class="fc" id="L234">		return formInputPC.getHtmlDisplay();</span>
	}
	
	//setters 
	
	/**
	 * Setter for ContactAboveReqTolerance form value.
	 */
	public void setContactAboveReqTolerance(int iValue) {
<span class="nc bnc" id="L243" title="All 2 branches missed.">		if (settings != null) {</span>
<span class="nc" id="L244">			settings.setContactAboveReqTolerance(iValue);</span>
		}
<span class="nc" id="L246">		contactAboveReqTolerance = iValue;</span>
<span class="nc" id="L247">	}</span>

	/**
	 * Setter for ContactBelowReqTolerance form value.
	 */
	public void setContactBelowReqTolerance(int iValue) {
<span class="nc bnc" id="L253" title="All 2 branches missed.">		if (settings != null) {</span>
<span class="nc" id="L254">			settings.setContactBelowReqTolerance(iValue);</span>
		}
<span class="nc" id="L256">		contactBelowReqTolerance = iValue;</span>
<span class="nc" id="L257">	}</span>
	
	/**
	 * Setter for ProjectAboveReqTolerance form value.
	 */
	public void setProjectAboveReqTolerance(int iValue) {
<span class="nc bnc" id="L263" title="All 2 branches missed.">		if (settings != null) {</span>
<span class="nc" id="L264">			settings.setProjectAboveReqTolerance(iValue);</span>
		}
<span class="nc" id="L266">		projectAboveReqTolerance = iValue;</span>
<span class="nc" id="L267">	}</span>
	
	/**
	 * Setter for ProjectBelowReqTolerance form value.
	 */
	public void setProjectBelowReqTolerance(int iValue) {
<span class="nc bnc" id="L273" title="All 2 branches missed.">		if (settings != null) {</span>
<span class="nc" id="L274">			settings.setProjectBelowReqTolerance(iValue);</span>
		}
<span class="nc" id="L276">		projectBelowReqTolerance = iValue;</span>
<span class="nc" id="L277">	}</span>
	
	//getters
	
	/**
	 * Getter for ContactAboveReqTolerance form value.
	 */
	public int getContactAboveReqTolerance() {
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">		if (settings != null) {</span>
<span class="fc" id="L286">			return settings.getContactAboveReqTolerance();</span>
		}
<span class="nc" id="L288">		return contactAboveReqTolerance ;</span>
	}

	/**
	 * Getter for ContactBelowReqTolerance form value.
	 */
	public int getContactBelowReqTolerance() {
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">		if (settings != null) {</span>
<span class="fc" id="L296">			return settings.getContactBelowReqTolerance();</span>
		}
<span class="nc" id="L298">		return contactBelowReqTolerance ;</span>
	}
	
	/**
	 * Getter for ProjectAboveReqTolerance form value.
	 */
	public int getProjectAboveReqTolerance() {
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">		if (settings != null) {</span>
<span class="fc" id="L306">			return settings.getProjectAboveReqTolerance();</span>
		}
<span class="nc" id="L308">		return projectAboveReqTolerance ;</span>
	}
	
	/**
	 * Getter for ProjectBelowReqTolerance form value.
	 */
	public int getProjectBelowReqTolerance() {
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">		if (settings != null) {</span>
<span class="fc" id="L316">			return settings.getProjectBelowReqTolerance();</span>
		}
<span class="nc" id="L318">		return projectBelowReqTolerance ;</span>
	}
	
	/**
	 * This is called during the Process of PageAction.SAVE,
	 * while creating a new Organization. 
	 * @param newOrgID is the ID of the Organization just created.
	 */
	public void create(ID newOrgID) throws Exception {
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">		if (settings != null) {</span>
<span class="nc" id="L328">			settings.setCurrentOrgId(newOrgID.toString());</span>
<span class="nc" id="L329">			OrgCalendarOptionsMH.setSettings(context, newOrgID, settings, false);</span>
		} else {
<span class="pc bpc" id="L331" title="2 of 4 branches missed.">			if (settings == null &amp;&amp; newOrgID != null) {</span>
<span class="fc" id="L332">				settings = new OrganizationSetting(new HashMap&lt;String, String&gt;(), newOrgID.toString());</span>
<span class="fc" id="L333">				settings.setContactAboveReqTolerance(contactAboveReqTolerance);</span>
<span class="fc" id="L334">				settings.setContactBelowReqTolerance(contactBelowReqTolerance);</span>
<span class="fc" id="L335">				settings.setProjectAboveReqTolerance(projectAboveReqTolerance);</span>
<span class="fc" id="L336">				settings.setProjectBelowReqTolerance(projectBelowReqTolerance);</span>
			}
<span class="fc" id="L338">			OrgCalendarOptionsMH.setSettings(context, newOrgID, settings, false);</span>
		}
<span class="fc" id="L340">	}</span>

	/**
	 * Initialize Component for Display.
	 */
	public void initForDisplay() {
<span class="pc bpc" id="L346" title="1 of 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L347">			return;</span>
		} else {
<span class="fc" id="L349">			initOrgSettings();</span>
<span class="fc" id="L350">			m_isInitializedForDisplay = true;</span>
		}
<span class="fc" id="L352">	}</span>
	
	/**
	 * This is called during the Process of PageAction.SAVE, while updating a Organization. 
	 */
	public void save() throws Exception {
<span class="nc" id="L358">		ID orgID = getOrgID();</span>
<span class="nc bnc" id="L359" title="All 4 branches missed.">		if (settings == null &amp;&amp; orgID != null) {</span>
<span class="nc" id="L360">			settings = new OrganizationSetting(new HashMap&lt;String, String&gt;(), orgID.toString());</span>
<span class="nc" id="L361">			settings.setContactAboveReqTolerance(contactAboveReqTolerance);</span>
<span class="nc" id="L362">			settings.setContactBelowReqTolerance(contactBelowReqTolerance);</span>
<span class="nc" id="L363">			settings.setProjectAboveReqTolerance(projectAboveReqTolerance);</span>
<span class="nc" id="L364">			settings.setProjectBelowReqTolerance(projectBelowReqTolerance);</span>
		}
<span class="nc" id="L366">		OrgCalendarOptionsMH.setSettings(context, orgID, settings, true);</span>
<span class="nc" id="L367">	}</span>

	/**
	 * This is called during the Process of PageAction.SAVE, while trying the &quot;Make Subs Inherit&quot; action. 
	 */
	public void makeSubsInherit() throws Exception {
<span class="nc" id="L373">		initForDisplay();</span>
<span class="nc" id="L374">		ID orgID = getOrgID();</span>
<span class="nc" id="L375">		OrgCalendarOptionsMH.setSettings(context, orgID, settings, false);</span>
<span class="nc" id="L376">	}</span>

	/**
	 * Get the name of this section, for the section's title.
	 */
	protected String getTitleString() {
<span class="fc" id="L382">		return i18n(fsbundle, FsWebBundleKey.CALENDAR_STATISTIC_COLORING_PAGE_TITLE);</span>
	}

	/**
	 * Get the ID of the organization from which these settings are inheritted.
	 * @return the ID of the org where the settings are inheritted from, or null if none (custom settings).
	 */
	protected ID getInheritFrom() {
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">		return ancestor == null ? null: ancestor;</span>
	}

	/**
	 * Set the ID of the organization from which these settings are inheritted.
	 */
	protected void setInheritFrom(ID id) {
<span class="fc" id="L397">		ancestor = id;</span>
<span class="fc" id="L398">	}</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>