<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestsFilterPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.filter</a> &gt; <span class="el_source">RequestsFilterPopupPM.java</span></div><h1>RequestsFilterPopupPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.filter;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.IDStringPair;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestFilter;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.tree.OrganizationTreePC;
import com.bluepumpkin.web.rm.keys.RmJavaScriptFileID;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.licensing.ejb.LicenseManager;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.keys.PageKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.container.ListContainerPC;
import com.witness.web.uif.pagecomponent.list.OptionData;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.date.DateRangePickerPC;
import com.witness.web.uif.pagemodel.ConfigPopupPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;
import com.witness.ejb.core.licensing.LicenseKeys;

/**
 * Title: RequestsFilterPopupPM Description: Request Filter Popup Copyright: Copyright (c) 2001 Company: Blue Pumpkin Software, inc
 * 
 * @author David Su
 * @version 1.0
 */
public class RequestsFilterPopupPM extends ConfigPopupPM {
	private static final String RT_CHANGE_JS = &quot;pageMediator.refreshPageWithAction('&quot; + RmPageAction.REQUEST_TYPE_CHANGE_ACTION
			+ &quot;', true);&quot;;
	private static final String FILTER_NAME_FN = &quot;filterName&quot;;

	protected ListContainerPC m_reqTypePC;
	protected OrganizationTreePC m_orgTreePC;
	protected RequestsFilterPropPC m_propPC;
	protected DatePickerPC m_datePC;
	protected DateRangePickerPC m_dateRangePC;

	protected ResourceBundle m_bundle;
	protected RequestFilter m_rFilter;
<span class="nc" id="L65">	protected boolean m_isNewFilter = false;</span>
<span class="nc" id="L66">	protected boolean m_isOrgIDSelected = true;</span>

<span class="nc" id="L68">	protected Collection m_orgList = Collections.EMPTY_LIST;</span>
<span class="nc" id="L69">	protected IDStringPair[] m_filterNames = null;</span>

	/** Creates a new instance of ListConfigPM */
	public RequestsFilterPopupPM(RequestContext context) {
<span class="nc" id="L73">		super(context);</span>

<span class="nc" id="L75">		m_bundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>

		// change the default all value
<span class="nc" id="L78">		m_sAllDisplay = i18n(m_bundle, RmWebBundleKey.REQUEST_FILTER_ALL_ACTIVE);</span>
<span class="nc" id="L79">		m_orgTreePC = new OrganizationTreePC(m_context);</span>
<span class="nc" id="L80">		addChildComponent(m_orgTreePC);</span>

<span class="nc" id="L82">		m_reqTypePC = new ListContainerPC(m_context);</span>
<span class="nc" id="L83">		addChildComponent(m_reqTypePC);</span>

<span class="nc" id="L85">		m_datePC = new DatePickerPC(m_context, &quot;&quot;);</span>
<span class="nc" id="L86">		addChildComponent(m_datePC);</span>

<span class="nc" id="L88">		m_dateRangePC = new DateRangePickerPC(m_context, &quot;&quot;);</span>
<span class="nc" id="L89">		addChildComponent(m_dateRangePC);</span>

<span class="nc" id="L91">		m_propPC = new RequestsFilterPropPC(m_context, m_datePC, m_dateRangePC);</span>
<span class="nc" id="L92">		addChildComponent(m_propPC);</span>

<span class="nc" id="L94">		resetRequestFilter();</span>
<span class="nc" id="L95">	}</span>

	/**
	 * Return an instance of Page Model
	 */
	public static PageModel getInstance(RequestContext context) {
<span class="nc" id="L101">		RequestsFilterPopupPM model = null;</span>

<span class="nc" id="L103">		PageModel cachedModel = context.getPageModel();</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (cachedModel instanceof RequestsFilterPopupPM) {</span>
<span class="nc" id="L105">			model = (RequestsFilterPopupPM) cachedModel;</span>
		} else {
			// Need to create new Model
<span class="nc" id="L108">			model = new RequestsFilterPopupPM(context);</span>
<span class="nc" id="L109">			model.extractParameters(context.getRequest());</span>
<span class="nc" id="L110">			context.setPageModel(model);</span>
		}

<span class="nc" id="L113">		return model;</span>
	}

	/**
	 * Initialize Component For Display
	 */
	@Override
	public void initForDisplay() {
<span class="nc bnc" id="L121" title="All 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L122">			return;</span>
		} else {
<span class="nc" id="L124">			super.initForDisplay();</span>

<span class="nc" id="L126">			initOrgTreeContainer();</span>
<span class="nc" id="L127">			initReqTypeContainer();</span>

<span class="nc" id="L129">			addGenericHTML(HtmlUtil.makeHiddenInput(FILTER_NAME_FN, m_rFilter.getName()));</span>
		}
<span class="nc" id="L131">	}</span>

	/**
	 * Initialize Model with Data
	 */
	protected void setSupportData(IDStringPair[] filterNames, Collection orgList, Collection supervisorList, List reqStatusList,
			Collection skillList, Collection poolList, Collection bidList, Collection campaignList, HashMap&lt;ID, String&gt; shiftMap,
			Collection activityList, HashMap&lt;ID, String&gt; extensionMap) {
<span class="nc" id="L139">		m_orgList = orgList;</span>
<span class="nc" id="L140">		m_filterNames = filterNames;</span>

<span class="nc" id="L142">		m_propPC.init(supervisorList, reqStatusList, skillList, poolList, bidList, campaignList, shiftMap, activityList,</span>
				extensionMap);
<span class="nc" id="L144">	}</span>

	/**
	 * Initialize Filter Names
	 */
	protected void initFilterNames() {
<span class="nc" id="L150">		ArrayList configNames = RequestsFilterUtil.createFilterOptions(m_filterNames, getSelectedConfig());</span>

<span class="nc" id="L152">		OptionData data = new OptionData(i18n(m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME),</span>
				RmWebBundleKey.REQUEST_TYPE_NO_FILTER), RequestUtil.ALL_FILTER);
<span class="nc bnc" id="L154" title="All 2 branches missed.">		if (getSelectedConfig().equals(RequestUtil.ALL_FILTER)) {</span>
<span class="nc" id="L155">			data.setSelected(true);</span>
		}
<span class="nc" id="L157">		configNames.add(0, data);</span>

<span class="nc" id="L159">		super.initConfigNames(configNames);</span>
<span class="nc" id="L160">	}</span>

	/**
	 * Initialize Org Tree Container
	 */
	protected void initOrgTreeContainer() {
<span class="nc" id="L166">		m_orgTreePC.setOnSelectAction(OrganizationTreePC.HANDLE_ON_SELECT_SELECT_CHILD);</span>
<span class="nc" id="L167">		m_orgTreePC.init(m_orgList);</span>

		// Initialize Check Organizations
<span class="nc" id="L170">		Collection orgIDs = (Collection) m_rFilter.getValueForKey(RequestFilter.ORGANIZATION_KEY);</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">		if (orgIDs == null || orgIDs.isEmpty()) {</span>
<span class="nc" id="L172">			m_orgTreePC.setCheckedIDAsCollection(Collections.EMPTY_LIST);</span>
		} else {
<span class="nc" id="L174">			m_orgTreePC.setCheckedIDAsCollection(orgIDs);</span>
		}
<span class="nc" id="L176">	}</span>

	/**
	 * Initialize Request Type Container
	 */
	protected void initReqTypeContainer() {
<span class="nc" id="L182">		String title = i18n(m_bundle, RmWebBundleKey.REQUEST_TYPE_LABEL);</span>
<span class="nc" id="L183">		m_reqTypePC.setTitle(title);</span>
<span class="nc" id="L184">		m_reqTypePC.setWrapperCSSClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>

<span class="nc" id="L186">		m_reqTypePC.addRowData(createReqTypeInput(Request.REQUESTTYPE_ALL, RmWebBundleKey.REQUEST_TYPE_ALL, false));</span>
<span class="nc" id="L187">		boolean hasTOMLicense = false;</span>
<span class="nc" id="L188">		boolean hasSSLicense = false;</span>
<span class="nc" id="L189">		boolean hasSBLicense = false;</span>
<span class="nc" id="L190">		boolean hasCSLicense = false;</span>
<span class="nc" id="L191">		boolean hasAdvRMLicense = false;</span>

		try {
			// get licenses to disable options
<span class="nc" id="L195">			LicenseManager licManager = CoreManagerFactory.getLicenseManager();</span>
<span class="nc" id="L196">			hasTOMLicense = licManager.isLicensed(LicenseKeys.APP_RM_TOM);</span>
<span class="nc" id="L197">			hasSSLicense = licManager.isLicensed(LicenseKeys.APP_RM_SS);</span>
<span class="nc" id="L198">			hasSBLicense = licManager.isLicensed(LicenseKeys.APP_RM_SB);</span>
<span class="nc" id="L199">			hasCSLicense = licManager.isLicensed(LicenseKeys.APP_RM_TOM);</span>
<span class="nc" id="L200">			hasAdvRMLicense =licManager.isLicensed(LicenseKeys.APP_ADVANCED_RM);</span>
<span class="nc" id="L201">		} catch (Exception ex) {</span>
<span class="nc" id="L202">			log.l7dError(BbmWebBundleKey.UNABLE_TO_LOAD_DATA, ex);</span>
<span class="nc" id="L203">		}</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">		m_reqTypePC</span>
<span class="nc" id="L206">				.addRowData(createReqTypeInput(Request.REQUESTTYPE_TIMEOFF, RmWebBundleKey.REQUEST_TYPE_TIME_OFF, !hasTOMLicense));</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">		if(hasAdvRMLicense) {</span>
<span class="nc" id="L208">			m_reqTypePC.addRowData(createReqTypeInput(Request.REQUESTTYPE_FLEXTIME, RmWebBundleKey.REQUEST_TYPE_FLEX_TIME,false));</span>
		}

<span class="nc bnc" id="L211" title="All 2 branches missed.">		m_reqTypePC.addRowData(createReqTypeInput(Request.REQUESTTYPE_SHIFTSWAP, RmWebBundleKey.REQUEST_TYPE_SHIFT_SWAP,</span>
				!hasSSLicense));

<span class="nc bnc" id="L214" title="All 2 branches missed.">		m_reqTypePC.addRowData(createReqTypeInput(Request.REQUESTTYPE_SHIFTBID, RmWebBundleKey.REQUEST_TYPE_SHIFT_BIDDING,</span>
				!hasSBLicense));

<span class="nc bnc" id="L217" title="All 2 branches missed.">		m_reqTypePC.addRowData(createReqTypeInput(Request.REQUESTTYPE_CUSTSHIFT, RmWebBundleKey.REQUEST_TYPE_CUSTOM_SHIFT,</span>
				!hasCSLicense));
<span class="nc" id="L219">	}</span>

	/**
	 * Create RequestType Radio Option
	 */
	protected String createReqTypeInput(String value, String rbKey, boolean isDisabled) {
<span class="nc" id="L225">		StringBuffer sb = new StringBuffer(100);</span>

<span class="nc" id="L227">		String rType = (String) m_rFilter.getValueForKey(RequestFilter.REQUEST_TYPE_KEY);</span>
<span class="nc" id="L228">		boolean isChecked = value.equals(rType);</span>

<span class="nc" id="L230">		String label = i18n(m_bundle, rbKey);</span>
<span class="nc" id="L231">		HtmlChoiceInput choiceInput = HtmlChoiceInput.createRadioInput(&quot;requestType&quot;, value, label, isChecked, isDisabled,</span>
				RT_CHANGE_JS);
<span class="nc" id="L233">		choiceInput.setIsLabelLast(true);</span>
<span class="nc" id="L234">		sb.append(choiceInput.getHtmlDisplay());</span>
<span class="nc" id="L235">		return sb.toString();</span>
	}

	/**
	 * Initialize Content Title
	 */
	@Override
	protected void initContentTitle() {
<span class="nc" id="L243">		initFilterNames();</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">		String rbKey = m_isNewFilter ? UIFWebBundleKey.FILTER_CREATE : UIFWebBundleKey.FILTER_EDIT;</span>
<span class="nc" id="L246">		String pageTitle = i18n(m_common_bundle, rbKey);</span>
<span class="nc" id="L247">		String itemName = getContentTitleItemName();</span>

<span class="nc" id="L249">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="nc" id="L250">		m_contentTitlePC.setItemName(itemName);</span>

<span class="nc bnc" id="L252" title="All 2 branches missed.">		boolean isVisible = !m_isNewFilter;</span>
<span class="nc" id="L253">		String label = i18n(m_common_bundle, UIFWebBundleKey.FILTERS_LABEL);</span>
<span class="nc" id="L254">		m_contentTitlePC.setActiveComponent(label, m_configListBoxPC, isVisible);</span>
<span class="nc" id="L255">	}</span>

	/**
	 * Return Content Title Item Name
	 */
	@Override
	protected String getContentTitleItemName() {
<span class="nc bnc" id="L262" title="All 2 branches missed.">		if (m_isNewFilter) {</span>
<span class="nc" id="L263">			return &quot;&quot;;</span>
		}

<span class="nc" id="L266">		return super.getContentTitleItemName();</span>
	}

	/**
	 * Return True if default Config Name is selected
	 */
	@Override
	public boolean isDefaultConfig() {
<span class="nc" id="L274">		String value = getSelectedConfig();</span>
<span class="nc bnc" id="L275" title="All 6 branches missed.">		return StringUtil.isEmpty(value) || PageKeys.DEFAULT_ALL.equals(value) || RequestUtil.ALL_FILTER.equals(value);</span>
	}

	/**
	 * Return Selected Config as ID
	 */
	@Override
	public ID getSelectedConfigID() {
<span class="nc" id="L283">		ID id = null;</span>

<span class="nc" id="L285">		String sID = getSelectedConfig();</span>
<span class="nc bnc" id="L286" title="All 6 branches missed.">		if (sID != null &amp;&amp; !sID.equals(PageKeys.DEFAULT_ALL) &amp;&amp; !sID.equals(RequestUtil.ALL_FILTER)) {</span>
<span class="nc" id="L287">			id = new ID(sID);</span>
		}
<span class="nc" id="L289">		return id;</span>
	}

	/**
	 * Specify whether it is a new filter
	 */
	public void setIsNewFilter(boolean bSwitch) {
<span class="nc" id="L296">		m_isNewFilter = bSwitch;</span>
<span class="nc" id="L297">	}</span>

	/**
	 * Return true if it is a New Filter
	 */
	public boolean isNewFilter() {
<span class="nc" id="L303">		return m_isNewFilter;</span>
	}

	/**
	 * Set Request Filter Name
	 */
	public void setFilterName(String name) {
<span class="nc" id="L310">		m_rFilter.setName(name);</span>
<span class="nc" id="L311">	}</span>

	/**
	 * Return Request Filter Name
	 */
	public String getFilterName() {
<span class="nc" id="L317">		return m_rFilter.getName();</span>
	}

	/**
	 * Specifiy Request Type
	 */
	public void setRequestType(String type) {
<span class="nc" id="L324">		m_rFilter.setKey(RequestFilter.REQUEST_TYPE_KEY, type);</span>
<span class="nc" id="L325">	}</span>

	/**
	 * Return Request Type
	 */
	public String getRequestType() {
<span class="nc" id="L331">		return (String) m_rFilter.getValueForKey(RequestFilter.REQUEST_TYPE_KEY);</span>
	}

	/**
	 * Return current User ID
	 */
	public User getUser() {
<span class="nc" id="L338">		return m_context.getUser();</span>
	}

	public ID getSelectedFilterID() {
<span class="nc" id="L342">		return getSelectedConfigID();</span>
	}

	/**
	 * Reset Request Filter
	 */
	public void resetRequestFilter() {
<span class="nc" id="L349">		setRequestFilter(new RequestFilter(getUser().getID(), &quot;&quot;));</span>
<span class="nc" id="L350">		m_rFilter.setKey(RequestFilter.REQUEST_TYPE_KEY, Request.REQUESTTYPE_ALL);</span>
<span class="nc" id="L351">	}</span>

	/**
	 * Specify Request Filter to be used
	 */
	public void setRequestFilter(RequestFilter rFilter) {
<span class="nc" id="L357">		m_rFilter = rFilter;</span>
<span class="nc" id="L358">		m_propPC.setRequestFilter(rFilter);</span>
<span class="nc" id="L359">	}</span>

	/**
	 * Return Request Filter
	 */
	public RequestFilter getRequestFilter() {
<span class="nc" id="L365">		return m_rFilter;</span>
	}

	/**
	 * Extract Parameter
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L373">		boolean success = super.extractParameters(request);</span>

<span class="nc" id="L375">		ID[] checkedID = m_orgTreePC.getCheckedID();</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">		if (checkedID == null) {</span>
<span class="nc" id="L377">			m_isOrgIDSelected = false;</span>
		} else {
<span class="nc" id="L379">			m_isOrgIDSelected = true;</span>
<span class="nc" id="L380">			Collection orgIDs = Arrays.asList(checkedID);</span>
<span class="nc" id="L381">			m_rFilter.setKey(RequestFilter.ORGANIZATION_KEY, (Serializable) orgIDs);</span>
		}

<span class="nc" id="L384">		return success;</span>
	}

	/**
	 * Return HTML
	 */
	@Override
	public String getHtmlDisplay() {
<span class="nc" id="L392">		StringBuffer sb = new StringBuffer(512);</span>

<span class="nc" id="L394">		sb.append(&quot;&lt;table border=\&quot;0\&quot; cellpadding=\&quot;2\&quot; cellspacing=\&quot;2\&quot; width=\&quot;100%\&quot;&gt;&quot;);</span>

<span class="nc" id="L396">		sb.append(&quot;&lt;tr valign=\&quot;top\&quot;&gt;&quot;);</span>
<span class="nc" id="L397">		sb.append(&quot;&lt;td width=\50%\&quot;&gt;&quot;).append(m_orgTreePC).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L398">		sb.append(&quot;&lt;td width=\50%\&quot; rowspan=\&quot;2\&quot;&gt;&quot;).append(m_propPC).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L399">		sb.append(&quot;&lt;/tr&gt;&quot;);</span>

<span class="nc" id="L401">		sb.append(&quot;&lt;tr valign=\&quot;top\&quot;&gt;&quot;);</span>
<span class="nc" id="L402">		sb.append(&quot;&lt;td&gt;&quot;).append(m_reqTypePC).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L403">		sb.append(&quot;&lt;/tr&gt;&quot;);</span>

<span class="nc" id="L405">		sb.append(&quot;&lt;/table&gt;&quot;);</span>

<span class="nc" id="L407">		return sb.toString();</span>
	}

	/**
	 * Return Custome JavaScript
	 */
	@Override
	public String getCustomJavaScript() {
<span class="nc" id="L415">		StringBuffer sb = new StringBuffer(512);</span>
<span class="nc" id="L416">		sb.append(super.getCustomJavaScript());</span>

		// Create Custom Resize Function
<span class="nc" id="L419">		sb.append(JSUtil.CUSTOM_RESIZE_FUNC);</span>
<span class="nc" id="L420">		JSUtil.resizePC(m_orgTreePC.getName(), 269, 200, sb);</span>
<span class="nc" id="L421">		JSUtil.resizePC(m_propPC.getName(), 141, 306, sb);</span>
<span class="nc" id="L422">		sb.append(&quot;}\n&quot;);</span>

<span class="nc" id="L424">		return sb.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>