<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GTCCImportAssistDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.am.timecollection.gtcc.ejb</a> &gt; <span class="el_source">GTCCImportAssistDAO.java</span></div><h1>GTCCImportAssistDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.am.timecollection.gtcc.ejb;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.dao.DAONode;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;

/**
 * Title:        Blue Pumpkin Software Activity Management
 *
 * Description: 
 *
 * Copyright:    Copyright (c) 2003
 * Company:      Blue Pumpkin Software, Inc
 * @author       Sankar Nair
 * @version 1.0
 */
public class GTCCImportAssistDAO extends DAONode {

	/**
	 * Default constructor
	 */
	public GTCCImportAssistDAO() {
<span class="nc" id="L36">		super();</span>
<span class="nc" id="L37">	}</span>
	
	public GTCCImportAssistDAO(Jdmo jdmo) {
<span class="nc" id="L40">		super(jdmo);</span>
<span class="nc" id="L41">	}</span>

	
	public Date[][] getActivityEventsForWorkResource(ID workResourceID, ID activityID, Date startDate, Date endDate) throws RemoteException {
<span class="nc" id="L45">		JdmoRowset rs = null;</span>
		try {
<span class="nc" id="L47">		StringBuffer pStmt1 = new StringBuffer();</span>
		
/*		pStmt1.append(&quot;SELECT T.STARTTIME, X.STARTTIME AS ENDTIME, &quot;);
		pStmt1.append(&quot; LASTNODE = CASE WHEN X.ACTIVITYID = -4001 THEN T.STARTTIME ELSE X.STARTTIME END&quot;);
		pStmt1.append(&quot; FROM TIMEENTRYEVENT T INNER JOIN TIMEENTRYEVENT X ON T.ID = (X.ID - 1) &quot;); 
		pStmt1.append(&quot; WHERE T.ACTIVITYID = &quot;).append(activityID).append(&quot; AND T.EMPLOYEEID = &quot;).append(workResourceID).append(&quot; AND X.EMPLOYEEID = &quot;).append(workResourceID);
		pStmt1.append(&quot; AND ((T.STARTTIME &lt;= '&quot;).append(JdmoUtil.formatDBString(startDate)).append(&quot;' AND X.STARTTIME &gt; '&quot;).append(JdmoUtil.formatDBString(startDate)).append(&quot;')&quot;); 		
		pStmt1.append(&quot; OR (T.STARTTIME &gt;= '&quot;).append(JdmoUtil.formatDBString(startDate)).append(&quot;' AND T.STARTTIME &lt;= '&quot;).append(JdmoUtil.formatDBString(endDate)).append(&quot;'))&quot;);
	*/		
		
<span class="nc" id="L57">		pStmt1.append(&quot;SELECT T.STARTTIME, X.ENDTIME, &quot;);</span>
<span class="nc" id="L58">		pStmt1.append(&quot;LASTNODE = CASE WHEN X.ACTIVITYID = -4001 THEN T.STARTTIME ELSE X.ENDTIME END &quot;);</span>
<span class="nc" id="L59">		pStmt1.append(&quot; FROM &quot;);</span>
<span class="nc" id="L60">		pStmt1.append(&quot;(SELECT ROW_NUMBER() OVER (ORDER BY starttime ASC) AS ROWID, STARTTIME, ACTIVITYID,  EMPLOYEEID FROM timeentryevent WHERE EMPLOYEEID = &quot;).append(workResourceID).append(&quot;) AS T &quot;);</span>
<span class="nc" id="L61">		pStmt1.append(&quot; INNER JOIN ( &quot;);</span>
<span class="nc" id="L62">		pStmt1.append(&quot; SELECT ROW_NUMBER() OVER (ORDER BY starttime ASC) AS XROWID, STARTTIME AS ENDTIME, EMPLOYEEID, ACTIVITYID FROM timeentryevent WHERE EMPLOYEEID = &quot;).append(workResourceID).append(&quot;) AS X ON T.ROWID = (X.XROWID - 1) &quot;);</span>
<span class="nc" id="L63">		pStmt1.append(&quot; WHERE T.ACTIVITYID IN (SELECT ID from ACTIVITY WHERE ACTIVITYCATEGORYID = &quot;).append(activityID).append(&quot;)&quot;); </span>
<span class="nc" id="L64">		pStmt1.append(&quot; AND ((T.STARTTIME &lt;= '&quot;).append(JdmoUtil.formatDBString(startDate)).append(&quot;' AND X.ENDTIME &gt; '&quot;).append(JdmoUtil.formatDBString(startDate)).append(&quot;')&quot;); 		</span>
<span class="nc" id="L65">		pStmt1.append(&quot; OR (T.STARTTIME &gt;= '&quot;).append(JdmoUtil.formatDBString(startDate)).append(&quot;' AND T.STARTTIME &lt;= '&quot;).append(JdmoUtil.formatDBString(endDate)).append(&quot;'))&quot;);</span>

		
<span class="nc" id="L68">			JdmoQuery jQuery1 = m_dmo.createQuery(pStmt1.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L69">			rs = m_dmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L70">			ArrayList startDates = new ArrayList();</span>
<span class="nc" id="L71">			ArrayList endDates = new ArrayList();</span>
<span class="nc" id="L72">			ArrayList lastNodes = new ArrayList();</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L74">				startDates.add(TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;)));</span>
<span class="nc" id="L75">				endDates.add(TimeZoneUtil.toDate(rs.getTimestamp(&quot;ENDTIME&quot;)));</span>
<span class="nc" id="L76">				lastNodes.add(TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTNODE&quot;)));</span>
			}

<span class="nc" id="L79">			rs.close();</span>
			
			//Fetching details about the open activity
<span class="nc" id="L82">			pStmt1 = new StringBuffer();</span>
<span class="nc" id="L83">			pStmt1.append(&quot;SELECT TOP 1 T.ACTIVITYID, T.STARTTIME, A.ACTIVITYCATEGORYID FROM TIMEENTRYEVENT T INNER JOIN ACTIVITY A ON T.ACTIVITYID = A.ID &quot;);</span>
<span class="nc" id="L84">			pStmt1.append(&quot; WHERE EMPLOYEEID = &quot;).append(workResourceID);</span>
			//pStmt1.append(&quot; AND STARTTIME &lt;= '&quot;).append(JdmoUtil.formatDBString(endDate)).append(&quot;'&quot;);
<span class="nc" id="L86">			pStmt1.append(&quot; ORDER BY STARTTIME DESC&quot;);</span>
			
<span class="nc" id="L88">			jQuery1 = m_dmo.createQuery(pStmt1.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L89">			rs = m_dmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
			//There will be only one open activity for an employee and that will be the last activity. 
<span class="nc bnc" id="L91" title="All 2 branches missed.">			if(rs.next()) {</span>
<span class="nc" id="L92">				ID openActID = rs.getID(&quot;ACTIVITYCATEGORYID&quot;);</span>
				//The last activity for that employee is the activity which we are trying to replace.
				//So lets add the activity start date, current time as end date &amp; set null as last node date.
<span class="nc bnc" id="L95" title="All 2 branches missed.">				if(openActID.equals(activityID)) {</span>
<span class="nc" id="L96">					startDates.add(TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;)));</span>
<span class="nc" id="L97">					endDates.add(Calendar.getInstance(TimeZone.getTimeZone(&quot;GMT&quot;)).getTime());</span>
<span class="nc" id="L98">					lastNodes.add(null);</span>
				}
			}
			
<span class="nc" id="L102">			Date dates[][] = new Date[startDates.size()][3];</span>
			
<span class="nc bnc" id="L104" title="All 2 branches missed.">			for(int index = 0; index &lt; startDates.size(); index++) {</span>
<span class="nc" id="L105">				dates[index][0] = ((Date)startDates.get(index));</span>
<span class="nc" id="L106">				dates[index][1] = ((Date)endDates.get(index));</span>
<span class="nc" id="L107">				dates[index][2] = ((Date)lastNodes.get(index));</span>
			}
			
			
<span class="nc" id="L111">			return dates;</span>
<span class="nc" id="L112">		} catch(Exception e) {</span>
<span class="nc" id="L113">			e.printStackTrace();</span>
		}
<span class="nc" id="L115">		finally {</span>
<span class="nc" id="L116">		}</span>
<span class="nc" id="L117">		return new Date[0][0];</span>
	}
	
	
	public ID getActivityID(String activityName) {
<span class="nc bnc" id="L122" title="All 4 branches missed.">		if(activityName == null || activityName.trim().length() &lt; 1)</span>
<span class="nc" id="L123">			return null;</span>
		
<span class="nc" id="L125">		JdmoRowset rs = null;</span>
<span class="nc" id="L126">		ID activityId = null;</span>
		try {
		
			
			
<span class="nc" id="L131">			StringBuffer pStmt1 = new StringBuffer();</span>
<span class="nc" id="L132">			pStmt1.append(&quot;SELECT ID FROM ACTIVITY WHERE NAME LIKE ('&quot;).append(activityName).append(&quot;')&quot;);</span>
<span class="nc" id="L133">			JdmoQuery jQuery1 = this.m_dmo.createQuery(pStmt1.toString(), Jdmo.PARAM_QUERY);</span>

<span class="nc" id="L135">			rs = m_dmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L137">				activityId = rs.getID(&quot;ID&quot;);</span>
			}
<span class="nc" id="L139">			rs.close();</span>
<span class="nc" id="L140">		} catch(Exception e) { }</span>
<span class="nc" id="L141">		finally {</span>
<span class="nc" id="L142">		}</span>
		
<span class="nc" id="L144">		return activityId;</span>
	}

	protected DAOBase createChildDAO(int iType) {
		// TODO Auto-generated method stub
<span class="nc" id="L149">		return null;</span>
	}

	protected ValueObjectBase createValueObject() {
		// TODO Auto-generated method stub
<span class="nc" id="L154">		return null;</span>
	}

	protected FieldInfo getFieldInfo() {
		// TODO Auto-generated method stub
<span class="nc" id="L159">		return null;</span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>