<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CalendarEventsMustOverlapValidationRule.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.swap.request.validation</a> &gt; <span class="el_source">CalendarEventsMustOverlapValidationRule.java</span></div><h1>CalendarEventsMustOverlapValidationRule.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.swap.request.validation;

/**
 * Title:        rm
 * Description:
 *  Validates a Shift swap request to ensure that for each employee participating
 *  in the shift swap, he/she does not have 'UNAVAILBILITY' events during the shift
 *  received.
 * Copyright:    Copyright (c) 2002
 * Company:
 * @author
 * @version 1.0
 */

import java.util.Collection;
import java.util.Date;
import java.util.Iterator;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriod;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriodImpl;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriodUtil;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.CalendarEvent;
import com.bluepumpkin.ejb.bbm.schedule.model.CalendarEventTemplate;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.verint.ejb.wfm.WfmManagerFactory;

/**
 * &lt;p&gt;Soft validation Rule
 *
 * This Ensures that for each employee, 
 * &lt;p&gt; all MUST_OVERLAP calendar events (timeoff events do not have this attribute)
 * do not lose their overlap after the swapped in shift is received.
  *
 * &lt;p&gt;
 * Applies for both one and 2 way swaps.  For a one way swap, the shift swap item with the
 * shift is only verified.
 *
 * &lt;p&gt;
 * TODO: fix this. only checks the published schedule. must check both pub and unpub schedule.
 * Applies equally for tentatative and non tentative requests as presently checks only the published
 * schedule.
 *
 */
<span class="nc" id="L57">public class CalendarEventsMustOverlapValidationRule implements Validator{</span>

<span class="nc" id="L59">    private static final Category m_cat = Log.initCategory ( CalendarEventsMustOverlapValidationRule.class.getName ());</span>

<span class="nc" id="L61">    private static final String m_className = CalendarEventsMustOverlapValidationRule.class.getName();</span>

    /**
     * unavailabilities overlapping a shift assignment is no longer a hard validation.  Instead
     * this validation is performed as a soft validation in
     * {@link CalendarEventsValidationRule CalendarEventsValidationRule}.  Any overlapping unavailabilies
     * are simply deleted when the request is approved.
     *
     * @see com.bluepumpkin.ejb.rm.requests.common.validation.Validator#validate(com.bluepumpkin.ejb.rm.requests.common.validation.Validatable)
     */
    public ValidationResult validate(Validatable validatable) throws Exception {
<span class="nc" id="L72">        ShiftSwapRequest ssr = (ShiftSwapRequest) validatable;</span>
<span class="nc" id="L73">        String methodName = &quot;validate&quot;;</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (m_cat.isDebugEnabled()) m_cat.debug(RmUtil.dumpEnterMethod(methodName, ssr));</span>

        // ssitems is an ordered list item(0) ... item(N-1)
        // item(A) gives its shift to item((A+1)modN)
        // item(A) receives its new shift from item((A+N-1)modN)
<span class="nc" id="L79">        ScheduleAccessManager sam = WfmManagerFactory.getScheduleAccessManager();</span>

<span class="nc" id="L81">        List ssItems = ssr.getShiftSwapItems();</span>
<span class="nc" id="L82">        int itemsSize = ssItems.size();</span>

<span class="nc" id="L84">        ValidationResult result = null;</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">        for (int i = 0; i &lt; itemsSize; i++) {</span>
            // shift assignment this employee is exporting.
<span class="nc" id="L87">            ShiftSwapItem itemOut = (ShiftSwapItem) ssItems.get(i);</span>
            // ID of this employee (exporter).
<span class="nc" id="L89">            ID empOutID = ((ShiftSwapItem) ssItems.get(i)).getEmployeeID();</span>

            // shift assignment this employee is importing.
<span class="nc" id="L92">            int inIndex = ( i - 1 + itemsSize ) % itemsSize;</span>
<span class="nc" id="L93">            ShiftSwapItem itemIn = (ShiftSwapItem) ssItems.get(inIndex);</span>

            // if exported item is of type 'shift', then it may have MUST_OVERLAP calendar events.
            //if ( itemOut.isSwapTypeShift() ) {
                // check if must overlap events for the exported shift are contained within
                // itemIn. 
<span class="nc" id="L99">                result = checkMustOverlapPubCalEventsForExportedShift(ssr,</span>
                    empOutID, itemIn, itemOut, sam);
            //}
        }
        
<span class="nc" id="L104">        return result;</span>
    }
    
    /**
      * all MUST_OVERLAP calendar and timeoff events, during the shift being swapped out,
      * must fall within the shift being swapped in.
      *
      * @param validatbale
      * @param employeeId
      * @param itemIn
      * @param itemOut
      * @param sam
      * @throws Exception
      */
     private ValidationResult checkMustOverlapPubCalEventsForExportedShift(ShiftSwapRequest ssr,
             ID empID, ShiftSwapItem itemIn, ShiftSwapItem itemOut, ScheduleAccessManager sam)
             throws Exception
     {
<span class="nc" id="L122">         Date itemInStart = itemIn.getStartDate();</span>
<span class="nc" id="L123">         Date itemInEnd = itemIn.getEndDate();</span>
         //Date itemOutStart = itemOut.getStartDate();
         //Date itemOutEnd = itemOut.getEndDate();
        
         // get MUST_OVERLAP calendar events during the shift being swapped out.
         // time off events ** do not have ** overlap attributes and hence need be checked for MUST_OVERLAP attribute.
<span class="nc" id="L129">         ShiftSwapValidationCache valCache = ssr.getCache();</span>
<span class="nc" id="L130">         Collection calEventsDuringItemOut = valCache.getEventsDuringPeriod(empID,               </span>
<span class="nc" id="L131">             itemOut.getStartDate(), itemOut.getEndDate(), Event.EVENT_TYPE_CALENDAR_EVENT_ASSIGNMENT, true);</span>

         // For each calendar event
<span class="nc" id="L134">         ValidationResult result = null;</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">         for (Iterator it = calEventsDuringItemOut.iterator(); it.hasNext();) {</span>
<span class="nc" id="L136">             CalendarEvent calEventDuringItemOut = (CalendarEvent) it.next();</span>

             // if not must overlap continue
<span class="nc bnc" id="L139" title="All 2 branches missed.">             if (calEventDuringItemOut == null) continue;</span>

<span class="nc" id="L141">             ShiftSwapValidationCache vc = ssr.getCache();</span>

             // if calendar event type is &quot;MUST_OVERLAP&quot;
<span class="nc bnc" id="L144" title="All 2 branches missed.">             if (calEventDuringItemOut.getOverlapType() == CalendarEventTemplate.OVERLAP_TYPE_MUST_OVERLAP_SHIFT) {</span>
            	 //check for overlap with original shift
//            	get overlap with original event
<span class="nc" id="L147">                 TimePeriod p1 = new TimePeriodImpl(itemOut.getStartDate(), itemOut.getEndDate());</span>
                 
<span class="nc" id="L149">                 TimePeriod p2 = new TimePeriodImpl(calEventDuringItemOut.getStartTime(), calEventDuringItemOut.getEndTime());</span>
                
<span class="nc" id="L151">                 TimePeriodUtil.retainOverlappedPeriod(p1, p2);</span>
                 
                 //QA58199: check whether calendar event assignment overlaps the same duration with
                 //shift being received
<span class="nc bnc" id="L155" title="All 4 branches missed.">                 if ( (itemIn.isSwapTypeShift() &amp;&amp; (p1.getStartTime().before(itemInStart) || </span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                 		p1.getEndTime().after(itemInEnd))) </span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                        || !itemIn.isSwapTypeShift() ) {</span>
                            
<span class="nc" id="L159">                     String empName = vc.getEmployeeNameByID(empID);</span>

<span class="nc" id="L161">                     return ValidationUtil.setSoftValidationResult(ssr,</span>
                         RmEjbBundleKey.SS_CALENDAR_EVENTS_MUST_OVERLAP,
<span class="nc" id="L163">                         empName, calEventDuringItemOut.getDescription(), calEventDuringItemOut.getStartTime(), calEventDuringItemOut.getEndTime(), m_className);</span>
                 }
             }
<span class="nc" id="L166">         }</span>

<span class="nc" id="L168">         return null;</span>
     }
}


</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>