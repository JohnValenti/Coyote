<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OrgWeekValidationRule.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.swap.request.validation</a> &gt; <span class="el_source">OrgWeekValidationRule.java</span></div><h1>OrgWeekValidationRule.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.swap.request.validation;

import java.io.Serializable;
import java.util.Collection;
import java.util.Date;
import java.util.Iterator;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.EmpWorkRuleManager;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourceAssignment;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.l10n.RmEjbLogBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.util.DateUtil;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.bluepumpkin.ejb.rm.util.ShiftSwapRequestUtil;
import com.verint.ejb.wfm.WfmManagerFactory;

/**
 * &lt;li&gt;Rule from UI: Both agents comply with a weekly hours rule.
 *
 * For week with shift being given up and for the week with shift being
 * received, verify rule hour constraints, taking into account the shift being
 * given up and the shift being received.
 *
 * &lt;p&gt;
 * TODO: verifyrule contraint for week with shift being given up. Presently
 * validation only for week with shift being received.
 *
 * &lt;p&gt;
 * For one way swaps:&lt;br&gt;
 * for employee giving up shift, for week shift given up, verify rule constraint
 * &lt;br&gt;
 * for employee giving up timeoff, for week shift being received, verify rule
 * constraint. &lt;br&gt;
 *
 * &lt;p&gt;
 * For tentative approvals: processing logic same as non tentative requests as
 * it uses only the published schedule for calculation of rule hours
 *
 * &lt;p&gt;
 * Algorithm:
 * &lt;p&gt;
 * &lt;li&gt;Validation rule to ensure that each employee, participating in the shift
 * swap, does not violate the rule hours per week allocated to him/her.
 * &lt;ul&gt;
 * &lt;li&gt;for the first employee find the start of the week which contains the
 * shift (or day off) this employee will get through the swap.
 * &lt;li&gt;get the schedule information for this employee for this week
 * &lt;li&gt;calculate the work hours for this week plus the shift hours gained
 * &lt;li&gt;compare the week work hours with employee rule hours per week
 * &lt;li&gt;for the first employee, find the start of the week which contains the
 * shift being given up.
 * &lt;li&gt;get the schedule information for this employee for this week.
 * &lt;li&gt;calculate the work hours for this week minus the shift hours lost
 * &lt;li&gt;compare the week work hours with employee rule hours.
 * &lt;li&gt;repeat for each employee
 * &lt;li&gt;validation result in case of failure should have information about the
 * employee, work hours, rule limits
 * &lt;ul&gt;
 *
 * */
public abstract class OrgWeekValidationRule implements Validator {

	// obtain instance for logging
<span class="nc" id="L83">	public static String m_className = OrgWeekValidationRule.class.getName();</span>

<span class="nc" id="L85">	public static Category m_cat = Log.initCategory(m_className);</span>

	protected ShiftSwapValidationCache m_vc;

<span class="nc" id="L89">	protected WorkResourceManager m_wrm = null;</span>

<span class="nc" id="L91">	protected EmpWorkRuleManager m_ewrm = null;</span>

	protected boolean m_isDifferentWeek;

<span class="nc" id="L95">	public OrgWeekValidationRule() {</span>
<span class="nc" id="L96">	};</span>

	@Override
	public ValidationResult validate(Validatable validatable) throws Exception {
		// todo: move to util; common code for casting and checking for null.
<span class="nc" id="L101">		ShiftSwapRequest ssr = (ShiftSwapRequest) validatable;</span>
<span class="nc" id="L102">		String methodName = &quot;validate&quot;;</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L104">			m_cat.debug(RmUtil.dumpEnterMethod(methodName, validatable));</span>
		}

		// todo: accomodate shiftswap items that are of type timeoff
<span class="nc" id="L108">		ValidationResult result = null;</span>

		// todo: can this be assigned once instead of during every invocaton
<span class="nc" id="L111">		m_vc = (ShiftSwapValidationCache) ssr.getValidationCache();</span>

		// items is an ordered list item(0) ... item(N-1)
		// item(A) gives its shift to item((A+1)modN)
		// item(A) receives its new shift from item((A+N-1)modN)
<span class="nc" id="L116">		List ssItems = ssr.getShiftSwapItems();</span>

		// try {
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (m_wrm == null) {</span>
<span class="nc" id="L120">			m_wrm = BbmManagerFactory.getWorkResourceManager();</span>
		}
<span class="nc bnc" id="L122" title="All 2 branches missed.">		if (m_ewrm == null) {</span>
<span class="nc" id="L123">			m_ewrm = WfmManagerFactory.getEmpWorkRuleManager();</span>
		}

<span class="nc" id="L126">		int ssItemsSize = ssItems.size();</span>

<span class="nc bnc" id="L128" title="All 2 branches missed.">		boolean isPartial = ((ShiftSwapItem) ssItems.get(0)).getIsPartial()</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">				|| ((ShiftSwapItem) ssItems.get(1)).getIsPartial();</span>
<span class="nc" id="L130">		ShiftAssignment[] saArray = null;</span>

<span class="nc bnc" id="L132" title="All 2 branches missed.">		if (isPartial) {</span>
			// get the sa array after the swap
<span class="nc" id="L134">			saArray = ShiftSwapRequestUtil.performPartialSwap((ShiftSwapRequest) validatable, false,</span>
<span class="nc" id="L135">					WfmManagerFactory.getScheduleAccessManager(), false, false);</span>

<span class="nc" id="L137">			m_isDifferentWeek = true;</span>
		}

<span class="nc bnc" id="L140" title="All 2 branches missed.">		for (int i = 0; i &lt; ssItemsSize; i++) { // for each shift</span>
			// obtain shift to be swapped out
<span class="nc" id="L142">			ShiftSwapItem itemOut = (ShiftSwapItem) ssItems.get(i); // shift/timeoff </span>

			// employee swapping out shift.
			//
			// Note: DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY used to obtain the
			// org association for the employee.
<span class="nc" id="L148">			Employee empOut = m_vc.getEmployeeForCurrTimeByID(itemOut.getEmployeeID(),</span>
					Employee.DETAIL_LEVEL_EMPLOYEE_BASIC );

			// shift being swapped in
<span class="nc" id="L152">			int itemInIndex = (i + ssItemsSize - 1) % ssItemsSize;</span>
<span class="nc" id="L153">			ShiftSwapItem itemIn = (ShiftSwapItem) ssItems.get(itemInIndex); // shift/timeoff</span>
																				// being
																				// swapped
																				// in

<span class="nc bnc" id="L158" title="All 2 branches missed.">			if (isPartial) {// handle separately</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">				if (itemIn.isSwapTypeShift() &amp;&amp; m_isDifferentWeek) {</span>
					// also do reverse test for other item: call only if
					// different weeks
<span class="nc" id="L162">					Employee empIn = m_vc.getEmployeeForCurrTimeByID(itemIn.getEmployeeID(),</span>
							Employee.DETAIL_LEVEL_EMPLOYEE_BASIC);
<span class="nc" id="L164">					result = checkRuleForReceivingWeekForPartialShift(saArray, validatable, empOut, empIn, itemIn,</span>
							itemOut);
<span class="nc" id="L166">				}</span>
			} else {
				// apply rule constraint for this employee for both weeks
<span class="nc" id="L169">                result  = checkRuleForBothInAndOutSwaps(validatable, empOut, itemIn, itemOut);</span>
			}
		}

<span class="nc bnc" id="L173" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L174">			m_cat.debug(RmUtil.dumpExitMethod(methodName));</span>
		}
<span class="nc" id="L176">		return result;</span>
	}

	/**
	 * Check rule hour constraint for the given employee swapping out a shift
	 * and swapping in another shift.
	 * &lt;p&gt;
	 * This validation applies for Tentatively approved requests too as the
	 * validation is done using the published schedule. (The tentative approval
	 * process only modifed the unpublished schedule).
	 *
     * @param validatable the ShiftSwapRequest
	 * @param pEmpOut
	 *            {@link Employee employee} swapping shift
	 * @param pItemIn
	 *            {@link ShiftSwapItem shift} being swapped in
	 * @param pItemOut
	 *            {@link ShiftSwapItem shift} being swapped out
	 */
    protected ValidationResult checkRuleForBothInAndOutSwaps(Validatable validatable, Employee pEmpOut,
			ShiftSwapItem pItemIn, ShiftSwapItem pItemOut) throws Exception {

		// get workResource assignments
<span class="nc" id="L199">        ScheduleAccessManager sam = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc" id="L200">		Collection wrAssns = ValidationUtil.getWorkResAssnWithTZForWRID(pEmpOut.getID(), pItemIn.getStartDate(),</span>
<span class="nc" id="L201">				pItemIn.getEndDate());</span>
		// if no workResource assignments were found
<span class="nc bnc" id="L203" title="All 2 branches missed.">		if (wrAssns.isEmpty()) {</span>
			// set soft validation result
<span class="nc" id="L205">			ValidationResult valResult = ValidationUtil.setSoftValidationResult(validatable,</span>
<span class="nc" id="L206">					RmEjbBundleKey.EMP_NOT_AFFLIATED_WITH_ANYORG, pEmpOut, pItemIn.getStartDate(),</span>
<span class="nc" id="L207">					pItemIn.getEndDate(), m_className);</span>

			// return.
<span class="nc" id="L210">			return valResult;</span>
		}
		// check for validation errors

<span class="nc" id="L214">		WorkResourceAssignment workResAssn = (WorkResourceAssignment) wrAssns.iterator().next();</span>
<span class="nc" id="L215">		ID empOrgID = workResAssn.getOrganizationID();</span>
<span class="nc" id="L216">		Organization orgForEmpOut = ValidationUtil.getOrganizationByID(empOrgID);</span>

<span class="nc" id="L218">        return validateSchedulesForSwaps(validatable, pEmpOut, pItemIn, pItemOut, sam, orgForEmpOut);</span>
	}
    
	protected ValidationResult validateSchedulesForSwaps(Validatable validatable, Employee pEmpOut, ShiftSwapItem pItemIn,
			ShiftSwapItem pItemOut, ScheduleAccessManager sam, Organization orgForEmpOut)
			throws Exception {
<span class="nc" id="L224">        ValidationResult result = null;</span>
<span class="nc" id="L225">        ID idEmp = pEmpOut.getID();</span>

<span class="nc" id="L227">        Date itemInStartDate = pItemIn.getStartDate();</span>
<span class="nc" id="L228">        Date itemInEndDate = pItemIn.getEndDate();</span>
<span class="nc" id="L229">        Date itemOutStartDate = pItemOut.getStartDate();</span>
<span class="nc" id="L230">        Date itemOutEndDate = pItemOut.getEndDate();</span>

        // get schedule information for employee for the entire org week during which the shift being received falls.
<span class="nc" id="L233">        Date orgWeekStartForItemIn = getDateForOrgWeekStart(orgForEmpOut, itemInStartDate);</span>
<span class="nc" id="L234">        Date orgWeekEndForItemIn = getDateForOrgWeekEnd(orgForEmpOut, itemInStartDate);</span>

<span class="nc" id="L236">        Date orgWeekStartForItemOut = getDateForOrgWeekStart(orgForEmpOut, itemOutStartDate);</span>
<span class="nc" id="L237">        Date  orgWeekEndForItemOut = null;</span>
<span class="nc" id="L238">        boolean inAndOutAreForSameWeek = orgWeekStartForItemIn.equals(orgWeekStartForItemOut);</span>
        
<span class="nc" id="L240">        orgWeekStartForItemIn = extendStartDays(orgWeekStartForItemIn, orgForEmpOut);</span>
<span class="nc" id="L241">        orgWeekEndForItemIn = extendEndDays(orgWeekEndForItemIn, orgForEmpOut);</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (inAndOutAreForSameWeek) {</span>
<span class="nc" id="L244">        	orgWeekStartForItemOut = orgWeekStartForItemIn;</span>
<span class="nc" id="L245">        	orgWeekEndForItemOut = orgWeekEndForItemIn;</span>
        } else {
<span class="nc" id="L247">        	orgWeekStartForItemOut = extendStartDays(orgWeekStartForItemOut, orgForEmpOut);</span>
<span class="nc" id="L248">        	orgWeekEndForItemOut =   getDateForOrgWeekEnd(orgForEmpOut, itemOutStartDate);</span>
<span class="nc" id="L249">            orgWeekEndForItemOut = extendEndDays(orgWeekEndForItemOut, orgForEmpOut);</span>
        }
<span class="nc" id="L251">        Pair&lt;Date,Date&gt; orgWeekForItemIn = new Pair&lt;Date,Date&gt;(orgWeekStartForItemIn, orgWeekEndForItemIn);</span>
<span class="nc" id="L252">        Pair&lt;Date,Date&gt; orgWeekForItemOut = new Pair&lt;Date,Date&gt;(orgWeekStartForItemOut, orgWeekEndForItemOut);</span>
        
<span class="nc" id="L254">        orgWeekForItemIn = extendOrgWeekBasedOnOtherItem(orgForEmpOut, itemOutStartDate, itemOutEndDate,</span>
        		orgWeekForItemIn);
  
<span class="nc" id="L257">        orgWeekForItemOut = extendOrgWeekBasedOnOtherItem(orgForEmpOut, itemInStartDate, itemInEndDate,</span>
        		orgWeekForItemOut);

<span class="nc" id="L260">        inAndOutAreForSameWeek = fixUpForSameWeek(</span>
        		inAndOutAreForSameWeek, orgWeekForItemIn, orgWeekForItemOut);
        
<span class="nc" id="L263">    	orgWeekStartForItemOut = orgWeekForItemOut.getFirst();</span>
<span class="nc" id="L264">    	orgWeekStartForItemIn = orgWeekForItemIn.getFirst();</span>
<span class="nc" id="L265">    	orgWeekEndForItemOut = orgWeekForItemOut.getSecond();</span>
<span class="nc" id="L266">    	orgWeekEndForItemIn = orgWeekForItemIn.getSecond();</span>

<span class="nc" id="L268">        Collection shiftAssnsDuringOrgWeekForItemIn = getShiftAssnsForOrgWeek(idEmp, orgWeekStartForItemIn, orgWeekEndForItemIn);</span>
<span class="nc" id="L269">        result = adjustWeeksShiftAssignments(validatable, pItemIn, shiftAssnsDuringOrgWeekForItemIn, idEmp, sam, true);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (result != null) {</span>
<span class="nc" id="L271">        	return result;</span>
        }

<span class="nc" id="L274">        Collection shiftAssnsDuringOrgWeekForItemOut = null;</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (inAndOutAreForSameWeek) {</span>
<span class="nc" id="L276">        	shiftAssnsDuringOrgWeekForItemOut = shiftAssnsDuringOrgWeekForItemIn;</span>
        } else {
<span class="nc" id="L278">            shiftAssnsDuringOrgWeekForItemOut = getShiftAssnsForOrgWeek(idEmp, orgWeekStartForItemOut, orgWeekEndForItemOut);</span>
        }
        
<span class="nc" id="L281">    	result = adjustWeeksShiftAssignments(validatable, pItemOut, shiftAssnsDuringOrgWeekForItemOut, idEmp, sam, false);		    </span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (result != null) {</span>
<span class="nc" id="L283">        	return result;</span>
        }
	    
<span class="nc" id="L286">        result = checkRuleHours(idEmp, orgWeekStartForItemIn, orgWeekEndForItemIn, </span>
                shiftAssnsDuringOrgWeekForItemIn, orgForEmpOut, pEmpOut, validatable);
        
<span class="nc bnc" id="L289" title="All 4 branches missed.">        if (result == null &amp;&amp; !inAndOutAreForSameWeek) {</span>
<span class="nc" id="L290">        	result = checkRuleHours(idEmp, orgWeekStartForItemOut, orgWeekEndForItemOut,</span>
        			shiftAssnsDuringOrgWeekForItemOut, orgForEmpOut, pEmpOut, validatable);
        }
        
<span class="nc" id="L294">        return result;</span>
	}

	protected ValidationResult adjustWeeksShiftAssignments(Validatable validatable, ShiftSwapItem ssItem, Collection&lt;ShiftAssignment&gt; shiftAssns,
			ID idEmp, ScheduleAccessManager sam, boolean addShiftToShiftsCollection) throws Exception {
<span class="nc" id="L299">		ValidationResult result = null;</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">		if (ssItem.isSwapTypeShift()) {</span>
<span class="nc" id="L301">		    ShiftAssignment shiftAssn = getShiftAssignForShiftSwapItem(ssItem, sam);</span>
<span class="nc" id="L302">		    result = checkForPubShiftIfNotFoundCreateValidationAlert(validatable, result, idEmp, ssItem.getStartDate(),</span>
<span class="nc" id="L303">					ssItem.getEndDate(), shiftAssn, sam);	    	   </span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">		    if (result == null) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">		    	if (addShiftToShiftsCollection) {</span>
<span class="nc" id="L306">		    		shiftAssns.add(shiftAssn);</span>
		    	} else {
<span class="nc" id="L308">		    		shiftAssns.remove(shiftAssn);</span>
		    	}
		    }
		}

<span class="nc" id="L313">	    return result;	</span>
	}
	
	protected boolean fixUpForSameWeek(
			boolean inAndOutAreForSameWeek, Pair&lt;Date,Date&gt; orgWeekForItemIn, Pair&lt;Date,Date&gt; orgWeekForItemOut) {
<span class="nc" id="L318">		Date orgWeekStartForItemIn = orgWeekForItemIn.getFirst();</span>
<span class="nc" id="L319">		Date orgWeekEndForItemIn = orgWeekForItemIn.getSecond();</span>
<span class="nc" id="L320">		Date orgWeekStartForItemOut = orgWeekForItemOut.getFirst();</span>
<span class="nc" id="L321">		Date orgWeekEndForItemOut = orgWeekForItemOut.getSecond();</span>

<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (inAndOutAreForSameWeek) {</span>
        	// in case start and end dates for itemOut have been extended, 
    		// set the start and end for itemIn the same as for itemOut
        	// because checkRuleHours will only be called for itemIn orgWeek
<span class="nc bnc" id="L327" title="All 2 branches missed.">        	if (orgWeekStartForItemOut.before(orgWeekStartForItemIn)) {</span>
<span class="nc" id="L328">        		orgWeekForItemIn.setFirst(orgWeekStartForItemOut);</span>
        	}
<span class="nc bnc" id="L330" title="All 2 branches missed.">        	if (orgWeekEndForItemOut.after(orgWeekEndForItemIn)) {</span>
<span class="nc" id="L331">        		orgWeekForItemIn.setSecond(orgWeekEndForItemOut);</span>
        	}
<span class="nc bnc" id="L333" title="All 2 branches missed.">        } else if (DateUtil.intersectsInclusive(orgWeekStartForItemIn, orgWeekEndForItemIn, </span>
        		orgWeekStartForItemOut, orgWeekEndForItemOut)) {
        	// if separate weeks overlap, merge the two weeks
<span class="nc bnc" id="L336" title="All 2 branches missed.">        	Date minDate = orgWeekStartForItemIn.before(orgWeekStartForItemOut) ? orgWeekStartForItemIn : orgWeekStartForItemOut;</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">        	Date maxDate = orgWeekEndForItemIn.after(orgWeekEndForItemOut) ? orgWeekEndForItemIn : orgWeekEndForItemOut;</span>
<span class="nc" id="L338">        	orgWeekStartForItemIn = orgWeekStartForItemOut = minDate;</span>
<span class="nc" id="L339">        	orgWeekEndForItemIn = orgWeekEndForItemOut = maxDate;</span>
<span class="nc" id="L340">        	inAndOutAreForSameWeek = true;</span>

<span class="nc" id="L342">    		orgWeekForItemIn.setFirst(orgWeekStartForItemIn);</span>
<span class="nc" id="L343">    		orgWeekForItemIn.setSecond(orgWeekEndForItemIn);</span>
<span class="nc" id="L344">    		orgWeekForItemOut.setFirst(orgWeekStartForItemOut);</span>
<span class="nc" id="L345">    		orgWeekForItemOut.setSecond(orgWeekEndForItemOut);</span>
		}
		
        
<span class="nc" id="L349">        return inAndOutAreForSameWeek;</span>
	}
	
	protected Date getDateForOrgWeekEnd(Organization orgForEmpOut, Date itemInStartDate) {
<span class="nc" id="L353">		Date orgWeekEndForItemIn =   TOCalcUtil.getDateForOrgWeekEnd(orgForEmpOut, itemInStartDate);</span>
<span class="nc" id="L354">		return orgWeekEndForItemIn;</span>
	}

	protected Date getDateForOrgWeekStart(Organization orgForEmpOut, Date itemInStartDate) {
<span class="nc" id="L358">		Date orgWeekStartForItemIn = TOCalcUtil.getDateForOrgWeekStart(orgForEmpOut, itemInStartDate);</span>
<span class="nc" id="L359">		return orgWeekStartForItemIn;</span>
	}

	protected ValidationResult checkForPubShiftIfNotFoundCreateValidationAlert(Validatable validatable,
			ValidationResult result, ID idEmp, Date itemStartDate, Date itemEndDate, ShiftAssignment shiftAssn,
			ScheduleAccessManager sam)
			throws Exception {
<span class="nc bnc" id="L366" title="All 2 branches missed.">		if (shiftAssn == null){	  </span>
<span class="nc" id="L367">  	        result = ValidationUtil.setAndLogHardValidationResult(validatable, &quot;SS_CANNOT_FIND_PUB_SHIFT&quot;, &quot;SS_CANNOT_FIND_PUB_SHIFT&quot;, </span>
<span class="nc" id="L368">  	        		new Serializable[] { itemStartDate, itemEndDate, this.m_vc.getEmployeeNameByID(idEmp) }, m_className);</span>
  	    }
<span class="nc" id="L370">		return result;</span>
	}

	protected ShiftAssignment getShiftAssignForShiftSwapItem(ShiftSwapItem itemIn, ScheduleAccessManager sam)
			throws Exception {
		ShiftAssignment shiftAssnIn;
<span class="nc" id="L376">		shiftAssnIn = m_vc.getShiftAssignForShiftSwapItem(itemIn, true, sam);</span>
<span class="nc" id="L377">		return shiftAssnIn;</span>
	}

	protected Date extendOrgWeekEndBasedOnOtherItem(Organization orgForEmpOut, Date itemOutStartDate,
			Date itemOutEndDate, Date orgWeekEndForItem) {
<span class="nc" id="L382">		Date tempOrgWeekEnd = new Date(orgWeekEndForItem.getTime());</span>
<span class="nc bnc" id="L383" title="All 4 branches missed.">		if (!orgWeekEndForItem.before(itemOutStartDate) &amp;&amp; orgWeekEndForItem.before(itemOutEndDate)) {</span>
<span class="nc" id="L384">        	tempOrgWeekEnd = extendEndDays(tempOrgWeekEnd, orgForEmpOut);</span>
<span class="nc" id="L385">        	tempOrgWeekEnd = TOCalcUtil.getDateForOrgDayEnd(orgForEmpOut, tempOrgWeekEnd);</span>
        }
<span class="nc" id="L387">		return tempOrgWeekEnd;</span>
	}

	protected Date extendOrgWeekStartBasedOnOtherItem(Organization orgForEmpOut, Date itemStartDate,
			Date itemEndDate, Date orgWeekStartForItem) {
<span class="nc" id="L392">		Date tempOrgWeekStart = new Date(orgWeekStartForItem.getTime());</span>
<span class="nc bnc" id="L393" title="All 4 branches missed.">		if (orgWeekStartForItem.after(itemStartDate) &amp;&amp; !orgWeekStartForItem.after(itemEndDate)) {</span>
<span class="nc" id="L394">        	tempOrgWeekStart = extendStartDays(tempOrgWeekStart, orgForEmpOut);</span>
<span class="nc" id="L395">        	tempOrgWeekStart = TOCalcUtil.getDateForOrgDayStart(orgForEmpOut, tempOrgWeekStart);</span>
        }
<span class="nc" id="L397">		return tempOrgWeekStart;</span>
	}

	protected Pair&lt;Date,Date&gt; extendOrgWeekBasedOnOtherItem(Organization orgForEmpOut, Date itemStartDate,
			Date itemEndDate, Pair&lt;Date,Date&gt; orgWeekForItem) {
<span class="nc" id="L402">		Date orgWeekStartForItem = orgWeekForItem.getFirst();</span>
<span class="nc" id="L403">		Date orgWeekEndForItem = orgWeekForItem.getSecond();</span>
<span class="nc" id="L404">        orgWeekStartForItem = extendOrgWeekStartBasedOnOtherItem(orgForEmpOut, itemStartDate, itemEndDate,</span>
				orgWeekStartForItem);
<span class="nc" id="L406">        orgWeekEndForItem = extendOrgWeekEndBasedOnOtherItem(orgForEmpOut, itemStartDate, itemEndDate,</span>
				orgWeekEndForItem);
<span class="nc" id="L408">        orgWeekForItem.setFirst(orgWeekStartForItem);</span>
<span class="nc" id="L409">        orgWeekForItem.setSecond(orgWeekEndForItem);</span>
        
<span class="nc" id="L411">        return orgWeekForItem;</span>
    }

    protected Collection getShiftAssnsForOrgWeek(ID empId, Date dtStart, Date dtEnd) throws Exception {
<span class="nc" id="L415">    	return ValidationUtil.getPublishedEventsForWorkResourceByType(Event.EVENT_TYPE_SHIFT_ASSIGNMENT, empId, dtStart, dtEnd);</span>
    }
    
    	
	// overidden by child classes
	public Date extendStartDays(Date startDate, Organization org) {
<span class="nc" id="L421">		return startDate;</span>
	}

	// overidden by child classes
	public Date extendEndDays(Date endDate, Organization org) {
<span class="nc" id="L426">		return endDate;</span>
	}

	/**
	 * This is where you check the rule given the week's assigments after swap
	 * for the empoyee.
	 * 
	 * @param empID
	 * @param orgWeekStart
	 * @param orgWeekEnd
	 * @param shiftsDuringOrgWeek
	 * @param org
	 * @param empOut
	 * @param validatable
	 * @return
	 * @throws Exception
	 */
	abstract protected ValidationResult checkRuleHours(ID empID, Date orgWeekStart, Date orgWeekEnd,
			Collection shiftsDuringOrgWeek, Organization org, Employee empOut, Validatable validatable)
			throws Exception;

	protected ValidationResult checkRuleForReceivingWeekForPartialShift(ShiftAssignment[] saArray,
			Validatable validatable, Employee pEmpOut, Employee pEmpIn, ShiftSwapItem pItemIn, ShiftSwapItem pItemOut)
			throws Exception {
		// get workResource assignments
<span class="nc" id="L451">		Collection wrAssns = ValidationUtil.getWorkResAssnWithTZForWRID(pItemOut.getEmployeeID(),</span>
<span class="nc" id="L452">				pItemOut.getStartDate(), pItemOut.getEndDate());</span>
		// if no workResource assignments were found
<span class="nc bnc" id="L454" title="All 2 branches missed.">		if (wrAssns.isEmpty()) {</span>
			// set soft validation result
<span class="nc" id="L456">			ValidationResult valResult = ValidationUtil.setSoftValidationResult(validatable,</span>
<span class="nc" id="L457">					RmEjbBundleKey.EMP_NOT_AFFLIATED_WITH_ANYORG, pItemOut.getEmployeeID(), pItemOut.getStartDate(),</span>
<span class="nc" id="L458">					pItemOut.getEndDate(), m_className);</span>

			// return.
<span class="nc" id="L461">			return valResult;</span>
		}
		// check for validation errors
<span class="nc" id="L464">		ValidationResult result = null;</span>

<span class="nc" id="L466">		WorkResourceAssignment workResAssn = (WorkResourceAssignment) wrAssns.iterator().next();</span>
<span class="nc" id="L467">		ID empOrgID = workResAssn.getOrganizationID();</span>
<span class="nc" id="L468">		Organization orgForEmpOut = ValidationUtil.getOrganizationByID(empOrgID);</span>

<span class="nc" id="L470">		result = checkRuleForReceivingWeekForItem(saArray, validatable, pEmpOut, pItemIn, pItemOut, orgForEmpOut);</span>

		// get workResource assignments
<span class="nc" id="L473">		wrAssns = ValidationUtil.getWorkResAssnWithTZForWRID(pItemIn.getEmployeeID(), pItemIn.getStartDate(),</span>
<span class="nc" id="L474">				pItemIn.getEndDate());</span>
		// if no workResource assignments were found
<span class="nc bnc" id="L476" title="All 2 branches missed.">		if (wrAssns.isEmpty()) {</span>
			// set soft validation result
<span class="nc" id="L478">			ValidationResult valResult = ValidationUtil.setSoftValidationResult(validatable,</span>
<span class="nc" id="L479">					RmEjbBundleKey.EMP_NOT_AFFLIATED_WITH_ANYORG, pItemIn.getEmployeeID(), pItemIn.getStartDate(),</span>
<span class="nc" id="L480">					pItemIn.getEndDate(), m_className);</span>

			// return.
<span class="nc" id="L483">			return valResult;</span>
		}
<span class="nc" id="L485">		workResAssn = (WorkResourceAssignment) wrAssns.iterator().next();</span>
<span class="nc" id="L486">		empOrgID = workResAssn.getOrganizationID();</span>
<span class="nc" id="L487">		Organization orgForEmpIn = ValidationUtil.getOrganizationByID(empOrgID);</span>
<span class="nc" id="L488">		result = checkRuleForReceivingWeekForItem(saArray, validatable, pEmpIn, pItemIn, pItemOut, orgForEmpIn);</span>

<span class="nc" id="L490">		return result;</span>
	}

	protected ValidationResult checkRuleForReceivingWeekForItem(ShiftAssignment[] saArray, Validatable validatable,
			Employee pEmpOut, ShiftSwapItem pItemIn, ShiftSwapItem pItemOut, Organization orgForEmpOut)
			throws Exception {
<span class="nc" id="L496">		ValidationResult result = null;</span>
		// get schedule information for employee for the entire org week during
		// which the shift being received falls.
<span class="nc" id="L499">		ID idEmpOut = pEmpOut.getID();</span>
<span class="nc" id="L500">		Date orgWeekStartForItemInStart = TOCalcUtil.getDateForOrgWeekStart(orgForEmpOut, pItemIn.getStartDate());</span>
<span class="nc" id="L501">		Date orgWeekEndForItemInStart = TOCalcUtil.getDateForOrgWeekEnd(orgForEmpOut, pItemIn.getStartDate());</span>
<span class="nc" id="L502">		Collection shiftAssnsDuringOrgWeekForItemIn = ValidationUtil.getPublishedEventsForWorkResourceByType(</span>
				Event.EVENT_TYPE_SHIFT_ASSIGNMENT, idEmpOut, orgWeekStartForItemInStart, orgWeekEndForItemInStart);

		// find shift assignment for item to be received &amp;&amp; add it to the
		// collection.
<span class="nc" id="L507">		ScheduleAccessManager sam = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc" id="L508">		ShiftAssignment shiftAssnForItemIn = m_vc.getShiftAssignForShiftSwapItem(pItemIn, true, sam);</span>
<span class="nc bnc" id="L509" title="All 4 branches missed.">		if (pItemIn.isSwapTypeShift() &amp;&amp; shiftAssnForItemIn == null) {</span>
			// SS_CANNOT_FIND_PUB_SHIFT,
			// &quot;Unable to find the published shift between {0} and {1} for employee {2} for the specified shift swap item&quot;},
<span class="nc" id="L512">			result = ValidationUtil.setAndLogHardValidationResult(</span>
					validatable,
					RmEjbBundleKey.SS_CANNOT_FIND_PUB_SHIFT,
					RmEjbLogBundleKey.SS_CANNOT_FIND_PUB_SHIFT,
<span class="nc" id="L516">					new Serializable[] { pItemIn.getStartDate(), pItemIn.getEndDate(),</span>
<span class="nc" id="L517">							m_vc.getEmployeeNameByID(pItemOut.getEmployeeID()) }, m_className);</span>

<span class="nc" id="L519">			return result;</span>
		}

		// get the shift after the swap from the array: get org day start and
		// end for item
<span class="nc" id="L524">		Date dayStart = TOCalcUtil.getDateForOrgDayStart(orgForEmpOut, pItemIn.getStartDate());</span>
<span class="nc" id="L525">		Date dayEnd = TOCalcUtil.getDateForOrgDayEnd(orgForEmpOut, pItemIn.getStartDate());</span>

<span class="nc" id="L527">		fixSAColl(idEmpOut, dayStart, dayEnd, shiftAssnsDuringOrgWeekForItemIn, saArray);</span>

<span class="nc" id="L529">		Date itemOutDayStart = TOCalcUtil.getDateForOrgDayStart(orgForEmpOut, pItemOut.getStartDate());</span>
<span class="nc" id="L530">		Date itemOutDayEnd = TOCalcUtil.getDateForOrgDayEnd(orgForEmpOut, pItemOut.getStartDate());</span>

<span class="nc" id="L532">		Date orgWeekStartForItemOutStart = TOCalcUtil.getDateForOrgWeekStart(orgForEmpOut, pItemOut.getStartDate());</span>

<span class="nc bnc" id="L534" title="All 4 branches missed.">		if (!dayStart.equals(itemOutDayStart) &amp;&amp; orgWeekStartForItemInStart.equals(orgWeekStartForItemOutStart)) {</span>
			// also replace shift being swapped out with new reduced one
<span class="nc" id="L536">			fixSAColl(idEmpOut, itemOutDayStart, itemOutDayEnd, shiftAssnsDuringOrgWeekForItemIn, saArray);</span>
		}

<span class="nc" id="L539">		result = checkRuleHours(idEmpOut, orgWeekStartForItemInStart, orgWeekEndForItemInStart,</span>
				shiftAssnsDuringOrgWeekForItemIn, orgForEmpOut, pEmpOut, validatable);

		// set flag if same week
<span class="nc bnc" id="L543" title="All 2 branches missed.">		m_isDifferentWeek = !orgWeekStartForItemInStart.equals(orgWeekStartForItemOutStart);</span>

<span class="nc" id="L545">		return result;</span>
	}

	protected void fixSAColl(ID empId, Date start, Date end, Collection saColl, ShiftAssignment[] saArray) {
		// now iterate thru shift collection, remove current shift,
<span class="nc bnc" id="L550" title="All 2 branches missed.">		for (Iterator it = saColl.iterator(); it.hasNext();) {</span>
<span class="nc" id="L551">			ShiftAssignment sa = (ShiftAssignment) it.next();</span>
<span class="nc bnc" id="L552" title="All 4 branches missed.">			if (!sa.getStartTime().before(start) &amp;&amp; sa.getStartTime().before(end)) {</span>
<span class="nc" id="L553">				it.remove();</span>
<span class="nc" id="L554">				break;</span>
			}
<span class="nc" id="L556">		}</span>
		// add shift resulting from swap
<span class="nc bnc" id="L558" title="All 2 branches missed.">		for (int i = 0; i &lt; saArray.length; i++) {</span>
<span class="nc" id="L559">			ShiftAssignment sa = saArray[i];</span>
<span class="nc bnc" id="L560" title="All 4 branches missed.">			if (sa != null &amp;&amp; sa.getWorkResourceIDs().iterator().next().equals(empId)</span>
<span class="nc bnc" id="L561" title="All 4 branches missed.">					&amp;&amp; !sa.getStartTime().before(start) &amp;&amp; sa.getStartTime().before(end)) {</span>
<span class="nc" id="L562">				saColl.add(sa);</span>
<span class="nc" id="L563">				break;</span>
			}
		}
<span class="nc" id="L566">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>