<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FteRequirementsRepository.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.rest.wfm.resource.fterequirements</a> &gt; <span class="el_source">FteRequirementsRepository.java</span></div><h1>FteRequirementsRepository.java</h1><pre class="source lang-java linenums">package com.verint.web.rest.wfm.resource.fterequirements;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.timeseries.model.RequireTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.google.common.collect.Sets;
import com.verint.ejb.bbm.fterequirements.ejb.FteRequirementsManager;
import com.verint.web.rest.wfm.exception.EntityCreateException;
import com.verint.web.rest.wfm.exception.EntityTimeSeriesException;
import com.verint.web.rest.wfm.filter.BooleanFilterParamHandler;
import com.verint.web.rest.wfm.filter.DateFilterParamHandler;
import com.verint.web.rest.wfm.filter.IdsFilterParamHandler;
import com.verint.web.rest.wfm.filter.RequiredFilterNotPresentException;
import com.verint.web.rest.wfm.repository.RepositoryLogger;
import com.verint.web.rest.wfm.repository.ValidateJsonApiFilterParams;
import com.verint.web.rest.wfm.repository.WfoResourceRepository;
import io.katharsis.queryParams.QueryParams;
import io.katharsis.repository.annotations.JsonApiResourceRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import javax.ws.rs.container.ContainerRequestContext;
import java.rmi.RemoteException;
import java.util.*;

import static com.verint.web.rest.wfm.filter.DateFilterParamHandler.END_DATE_DEFAULT_FILTER_KEY;
import static com.verint.web.rest.wfm.filter.DateFilterParamHandler.START_DATE_DEFAULT_FILTER_KEY;

@JsonApiResourceRepository(FteRequirementsEntity.class)
<span class="fc" id="L33">public class FteRequirementsRepository extends WfoResourceRepository&lt;Integer, FteRequirementsEntity&gt; {</span>

<span class="fc" id="L35">	private final static Logger log = LoggerFactory.getLogger(FteRequirementsRepository.class.getName());</span>
<span class="fc" id="L36">	private final static String ENTITY_NAME = FteRequirementsEntity.class.getSimpleName();</span>
	private final static String QUEUES_FILTER_KEY = &quot;queueIds&quot;;
	private final static String MEDIAS_FILTER_KEY = &quot;mediaIds&quot;;
	private final static String SP_FILTER_KEY = &quot;spId&quot;;
	private final static String ISWHATIF_FILTER_KEY = &quot;isWhatIf&quot;;
	private final static String ISCOMBINED_FILTER_KEY = &quot;isCombined&quot;;
	protected final static String RESOURCE_NAME = &quot;fterequirements&quot;;

	@Inject
	private FteRequirementsManagerWrapper whatIfManager;
	public FteRequirementsManagerWrapper getWhatIfManager() {
<span class="fc" id="L47">		return whatIfManager;</span>
	}

	@Override
	protected Logger logger() {
<span class="nc" id="L52">		return log;</span>
	}

	protected String getResourceName() {
<span class="fc" id="L56">		return RESOURCE_NAME;</span>
	}

	@Override
	public &lt;S extends FteRequirementsEntity&gt; S save(S entity, ContainerRequestContext requestContext) {
<span class="nc" id="L61">		throw new UnsupportedOperationException(&quot;Method not implemented&quot;);</span>
	}

	@Override
	public void delete(Integer integer, ContainerRequestContext requestContext) {
<span class="nc" id="L66">		throw new UnsupportedOperationException();</span>
	}

	@Override
	public FteRequirementsEntity findOne(Integer spQueueID, QueryParams queryParams, ContainerRequestContext requestContext) {
<span class="nc" id="L71">		throw new UnsupportedOperationException(&quot;Method not implemented&quot;);</span>
	}

	@Override
	public Iterable&lt;FteRequirementsEntity&gt; findAll(Iterable&lt;Integer&gt; spQueueIDs, QueryParams queryParams, ContainerRequestContext requestContext) {
<span class="nc" id="L76">		throw new UnsupportedOperationException(&quot;Method not implemented&quot;);</span>
	}

	@Override
	@RepositoryLogger
	@ValidateJsonApiFilterParams
	public Iterable&lt;FteRequirementsEntity&gt; findAll(QueryParams queryParams, ContainerRequestContext requestContext) {
		try {
<span class="fc" id="L84">			return getFteRequirementsForSP(queryParams);</span>
<span class="nc" id="L85">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L86">			throw handleBbmFinderException(ENTITY_NAME, null, e);</span>
<span class="nc" id="L87">		} catch (RemoteException e) {</span>
<span class="nc" id="L88">			throw handleRemoteException(ENTITY_NAME, null, e);</span>
<span class="nc" id="L89">		} catch (BbmTimeSeriesException e) {</span>
<span class="nc" id="L90">			throw handleBbmTimeSeriesException(ENTITY_NAME, null, e);</span>
		}
	}

	private EntityCreateException handleBbmTimeSeriesException(String entityName, String id, BbmTimeSeriesException e) {
<span class="nc" id="L95">		logger().error(&quot;TimeSeriesException occurred for entity name &quot; + entityName + &quot; with ID &quot; + id, e);</span>
<span class="nc" id="L96">		throw new EntityTimeSeriesException(entityName, id);</span>
	}

	private Collection&lt;FteRequirementsEntity&gt; getFteRequirementsForSP(QueryParams queryParams)
			throws BbmFinderException, RemoteException, BbmTimeSeriesException {

<span class="fc" id="L102">		ID spID = getSP(queryParams);</span>
<span class="fc" id="L103">		Collection&lt;ID&gt; queueIDs = IdsFilterParamHandler.getFilterValue(getFilterParam(QUEUES_FILTER_KEY)).orElse(Collections.emptyList());</span>
<span class="fc" id="L104">		Collection&lt;ID&gt; mediaIDs = IdsFilterParamHandler.getFilterValue(getFilterParam(MEDIAS_FILTER_KEY)).orElse(Collections.emptyList());</span>
<span class="fc" id="L105">		boolean isWhatIf = BooleanFilterParamHandler.getFilterValue(getFilterParam(ISWHATIF_FILTER_KEY)).orElse(false);</span>
<span class="fc" id="L106">		boolean isCombined = BooleanFilterParamHandler.getFilterValue(getFilterParam(ISCOMBINED_FILTER_KEY)).orElse(false);</span>
<span class="fc" id="L107">		Date startDate = DateFilterParamHandler.getFilterValue(getFilterParam(START_DATE_DEFAULT_FILTER_KEY)).orElse(null);</span>
<span class="fc" id="L108">		Date endDate = DateFilterParamHandler.getFilterValue(getFilterParam(END_DATE_DEFAULT_FILTER_KEY)).orElse(null);</span>

<span class="fc" id="L110">		FteRequirementsManager fteManager = getWhatIfManager().getFteRequirementManager(isWhatIf);</span>
<span class="fc" id="L111">		Collection&lt;RequireTraceCube&gt; traces = null;</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">		if (isCombined) {</span>
<span class="fc" id="L113">			traces = fteManager.getCombinedFteRequirementsTraceCubesForSP(spID, mediaIDs, startDate, endDate);</span>
		} else {
<span class="fc" id="L115">			traces = fteManager.getFteRequirementsTraceCubesForSP(spID, queueIDs, startDate, endDate);</span>
		}
<span class="fc" id="L117">		return convertTraces(traces);</span>
	}

	private Collection&lt;FteRequirementsEntity&gt; convertTraces(Collection&lt;RequireTraceCube&gt; traces) {
<span class="fc" id="L121">		List&lt;FteRequirementsEntity&gt; retVal = new ArrayList&lt;FteRequirementsEntity&gt;();</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">		for (RequireTraceCube trace : traces) {</span>
<span class="fc" id="L123">			FteRequirementsEntity entity = createEntityFromCube(trace);</span>
<span class="fc" id="L124">			retVal.add(entity);</span>
<span class="fc" id="L125">		}</span>
<span class="fc" id="L126">		return retVal;</span>
	}

	private FteRequirementsEntity createEntityFromCube(RequireTraceCube cube) {
<span class="fc" id="L130">		double[] data = cube.getTraceValueD(Trace.FTE);</span>
<span class="fc" id="L131">		FteRequirementsEntity entity = new FteRequirementsEntity();</span>
<span class="fc" id="L132">		entity.setStartDate(cube.getRawStartDate());</span>
<span class="fc" id="L133">		entity.setEndDate(cube.getRawEndDate());</span>
<span class="fc" id="L134">		entity.setSeriesValues(data);</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">		if (!isCombined(cube)) {</span>
			// Queue ID is null when combined (since it's a combination of queues), so only set it when !combined
<span class="fc" id="L137">			entity.setQueueID(cube.getQueueID().toInt());</span>
		}
<span class="fc" id="L139">		return entity;</span>
	}

	private boolean isCombined(RequireTraceCube cube) {
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">		return cube.getQueueID() == null;</span>
	}

	private ID getSP(QueryParams queryParams) {
<span class="fc" id="L147">		Optional&lt;Collection&lt;ID&gt;&gt; sps = IdsFilterParamHandler.getFilterValue(getFilterParam(SP_FILTER_KEY));</span>
		// Only allow one SP to be passed in, to avoid ambiguity
<span class="pc bpc" id="L149" title="2 of 4 branches missed.">		if (sps.isPresent() &amp;&amp; sps.get().size() == 1) {</span>
<span class="fc" id="L150">			return sps.get().iterator().next();</span>
		}
<span class="nc" id="L152">		throw new RequiredFilterNotPresentException(ENTITY_NAME, Sets.newHashSet(SP_FILTER_KEY), Sets.newHashSet());</span>
	}

	@Override
	protected Set&lt;String&gt; getValidFilterParamKeys() {
<span class="fc" id="L157">		return Sets.newHashSet(START_DATE_DEFAULT_FILTER_KEY, END_DATE_DEFAULT_FILTER_KEY,</span>
				QUEUES_FILTER_KEY, MEDIAS_FILTER_KEY, SP_FILTER_KEY,
				ISWHATIF_FILTER_KEY, ISCOMBINED_FILTER_KEY);
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>