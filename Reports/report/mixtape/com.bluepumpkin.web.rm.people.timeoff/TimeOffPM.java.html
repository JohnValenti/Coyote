<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.people.timeoff</a> &gt; <span class="el_source">TimeOffPM.java</span></div><h1>TimeOffPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.people.timeoff;

import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.ejb.bbm.people.model.PeopleDataKey;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase.NullObject;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Person;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.EmpTOPoolAssignment;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.EmpTOPoolAssignmentFieldInfo;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.EmployeeReferenceScheduleAssignmentUpdateParameters;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPoolFieldInfo;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.people.PeopleMH;
import com.bluepumpkin.web.bbm.people.PeoplePM;
import com.bluepumpkin.web.bbm.people.PeopleUtil;
import com.bluepumpkin.web.bbm.people.profile.ProfilePageModel;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarUtil;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpaneFieldNames;
import com.witness.web.uif.pagemodel.WorkpanePageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title:        TimeOffPM
 * Description:  People Time Off Page Model
 * Copyright:    Copyright (c) 2003
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, DSu
 * @version      1.0
 *
 * Created on Jul 15, 2003, 11:50:28 AM
 */
public class TimeOffPM extends WorkpanePageModel implements PeoplePM, ContainersInRowsPM {
<span class="fc" id="L60">	private Date m_viewByModDate = null;//input value for the control on Title Component (aka: AsOfDate, viewDate)</span>
	private String m_employeeTokenStr; // contain employee info for single editing
	private String m_editIdStr;

<span class="fc" id="L64">    private boolean m_initFailure = false;</span>
<span class="fc" id="L65">	private boolean m_isMultiEdit = false;</span>
<span class="fc" id="L66">	private boolean m_isAllViewable=false;</span>
<span class="fc" id="L67">	private boolean m_isAllEditable=false;</span>
<span class="fc" id="L68">	private Employee m_employee = null;</span>
<span class="fc" id="L69">    private TOPool m_pool = null; //the selected employee's time off pool on the AsOfDate (viewDate)</span>
<span class="fc" id="L70">    private EmpTOPoolAssignment m_empTOPoolAssignment = null;</span>
	private final ResourceBundle m_bundle;

	private final DatePickerPC m_inputDatePicker;//allow user to select &quot;view-by-date&quot;
<span class="fc" id="L74">	private int[] m_empMonthYearStart=null;</span>
	private static final String SHOW_AS_DATE_FN = &quot;showAsDate&quot;;


    private final ContainerList m_containerList;
    private final TimeOffPC m_timeOffForm;
    private final TimeOffPoolAssignmentPC m_toPoolAssignmentPC;
    private ReferenceScheduleAssignmentPC m_referenceSchedulePC;

	public TimeOffPM(RequestContext context) {
<span class="fc" id="L84">		super(context, FRAMED_MODEL);</span>
<span class="fc" id="L85">		m_bundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>

<span class="fc" id="L87">		m_inputDatePicker = new DatePickerPC(m_context, ProfilePageModel.SHOW_AS_DATE_FN);</span>
<span class="fc" id="L88">		m_inputDatePicker.setOnChangeJS(JSUtil.REFRESH_PAGE);</span>
<span class="fc" id="L89">		addChildComponent(m_inputDatePicker);//for extraction</span>

<span class="fc" id="L91">        m_containerList = new ContainerList(this, 2);</span>


        //-- Time Off Pool Form --
<span class="fc" id="L95">        m_toPoolAssignmentPC = new TimeOffPoolAssignmentPC(context);</span>
<span class="fc" id="L96">        addChildComponent(m_toPoolAssignmentPC);</span>
        //addForm(m_toPoolAssignmentPC);
<span class="fc" id="L98">        m_containerList.add(m_toPoolAssignmentPC);</span>

        //pool effective dates
<span class="fc" id="L101">		ToolbarPC popupToolbar = new ToolbarPC(context, getName() + &quot;_popupToolbar&quot;);</span>
<span class="fc" id="L102">		addChildComponent(popupToolbar);</span>
<span class="fc" id="L103">        m_pool = new TOPool();</span>
<span class="fc" id="L104">        m_empTOPoolAssignment = new EmpTOPoolAssignment();</span>


        //-- Time Off form --
<span class="fc" id="L108">        m_timeOffForm = new TimeOffPC(context);</span>
<span class="fc" id="L109">        m_timeOffForm.setIsBorderEnabled(false);</span>
<span class="fc" id="L110">        m_timeOffForm.setUseWrapper(false);</span>
<span class="fc" id="L111">        addChildComponent(m_timeOffForm);</span>
        //addForm(m_timeOffForm);
<span class="fc" id="L113">        m_containerList.add(m_timeOffForm);</span>

        //Reference schedule form
<span class="fc" id="L116">        createReferenceSchedulePC(context);</span>
        
        
        
		// People filter: V11 SP1 HFR1, V11.1 for Drop 4: Removing employee filter box from expanded work-pane to improve performance for Verizon.

<span class="fc" id="L122">		m_employee = new Employee();</span>
<span class="fc" id="L123">		m_employee.setPerson(new Person());</span>
<span class="fc" id="L124">	}</span>

	private void createReferenceSchedulePC(RequestContext context) {
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">		if (LicenseUtil.isAdvancedRMLicense()) {</span>
<span class="nc" id="L128">			m_referenceSchedulePC = new ReferenceScheduleAssignmentPC(context);</span>
<span class="nc" id="L129">			addChildComponent(m_referenceSchedulePC);</span>
<span class="nc" id="L130">			m_containerList.add(m_referenceSchedulePC);</span>
		}
<span class="fc" id="L132">	}</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="fc" id="L138">		return getInstance(context, TimeOffPM.class);</span>
	}

	@Override
	public Collection getContainers() {
<span class="fc" id="L143">        return m_containerList;</span>
    }

	/**
	 * Initialize Component For Display
	 */
	@Override
	public void initForDisplay() {
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">		if (m_isInitializedForDisplay) return;</span>
		else {
<span class="fc" id="L153">			super.initForDisplay();</span>
<span class="fc" id="L154">			PeopleUtil.initForDisplay(this);</span>
		}
<span class="fc" id="L156">	}</span>

	/**
	 * Initialize Model with Data
	 */
	@Override
	protected void initializeModel() {
<span class="fc bfc" id="L163" title="All 2 branches covered.">		if (m_isInitialized) return; else m_isInitialized = true;</span>
		try {
<span class="fc" id="L165">			loadData();</span>
<span class="nc" id="L166">		} catch (Exception ex) {</span>
<span class="nc" id="L167">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L168">			m_initFailure = true;</span>
		} finally {
<span class="pc" id="L170">			initForm();</span>
<span class="pc" id="L171">			initContentTitle();</span>
<span class="pc" id="L172">			initToolbar();</span>
<span class="pc" id="L173">		}</span>
<span class="fc" id="L174">	}</span>

    /**
     * Initialize JavaScript Variables. Overridden to set helpURL
     * when accrual license is not installed. In this case, we use
     * the old help file (pre-7.8.4) rather than the new one.
     */
	@Override
	protected void initJSVariables()
    {
<span class="fc" id="L184">        super.initJSVariables();</span>
<span class="fc" id="L185">    }</span>

	@Override
	protected void loadData() throws Exception
	{
<span class="fc" id="L190">		User user = m_context.getUser();</span>
<span class="fc" id="L191">		Collection&lt;ID&gt; empIDs = getSelectedIDsAsCollection();</span>
<span class="fc" id="L192">		m_isAllViewable = PeopleMH.isAuthToOrgForAll(m_context, user, empIDs, PrivilegeKeys.TOM_VIEWAVAILABLETIMEOFF_ID);</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">		if (!m_isAllViewable) return;</span>

<span class="fc" id="L195">		m_isAllEditable = PeopleMH.isAuthToOrgForAll(m_context, user, empIDs, PrivilegeKeys.TOM_EDITAVAILABLETIMEOFF_ID);</span>

<span class="fc" id="L197">		m_inputDatePicker.setDate((Date)m_context.getAttribute(RequestContext.SESSION_SCOPE, SHOW_AS_DATE_FN));</span>
<span class="fc" id="L198">		m_viewByModDate = m_inputDatePicker.getDate();</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (m_viewByModDate == null)</span>
<span class="fc" id="L200">            m_viewByModDate = new Date();</span>

<span class="fc" id="L202">		HashMap profileData = null;</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">		if (empIDs.size()&gt;1)</span>
		{
<span class="fc" id="L205">			profileData = PeopleMH.getProfileDataMultiEdit(empIDs, m_viewByModDate, m_context.getLocaleContext(), m_context.isInWhatIfMode());</span>
		}
		else
		{
<span class="fc" id="L209">			ID userID = m_context.getUser().getID();</span>
<span class="fc" id="L210">			profileData = PeopleMH.getProfileData(m_employee.getID(), userID, m_viewByModDate, false, m_context.getLocaleContext(), m_context.isInWhatIfMode());</span>
		}

<span class="fc" id="L213">		m_employee = (Employee)profileData.get(PeopleDataKey.EMPLOYEE);</span>
<span class="fc" id="L214">		m_editIdStr = m_employee.getMultiEditIDsInString();</span>
<span class="fc" id="L215">		m_employeeTokenStr = m_employee.getIDInString();</span>

<span class="fc" id="L217">		m_timeOffForm.init(empIDs, m_employee, false, m_isAllEditable, m_isMultiEdit, m_viewByModDate, this);</span>
		
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">		if(m_referenceSchedulePC != null) {</span>
<span class="nc" id="L220">			m_referenceSchedulePC.initialize(m_employee, empIDs, getAsOfDate(), m_isAllEditable);</span>
		}
		

<span class="fc" id="L224">		boolean noPoolAssignmentsFound = false;</span>
<span class="pc bpc" id="L225" title="2 of 4 branches missed.">		if (empIDs != null &amp;&amp; empIDs.size() &gt; 0) {</span>
<span class="fc" id="L226">			HashMap empPoolsMap = PeopleMH.getTOPoolsForWorkResources(empIDs, m_viewByModDate, m_viewByModDate);</span>
<span class="pc bpc" id="L227" title="1 of 4 branches missed.">			if (empPoolsMap != null &amp;&amp; empPoolsMap.size() &gt; 0) {</span>
<span class="fc" id="L228">				prepareTOPAssignments(empIDs, empPoolsMap);</span>
			} else {
<span class="fc" id="L230">				noPoolAssignmentsFound = true;</span>
			}
		}
<span class="fc" id="L233">		m_toPoolAssignmentPC.init(m_employee, empIDs, m_pool, m_empTOPoolAssignment, m_isAllEditable, m_isMultiEdit, m_viewByModDate,</span>
				noPoolAssignmentsFound);

		// Show Time Off Year Range if Single Employee is Selected
<span class="pc bpc" id="L237" title="1 of 4 branches missed.">		if (empIDs != null &amp;&amp; empIDs.size() == 1) {</span>
<span class="fc" id="L238">			ID empID = getSelectedIDObject();</span>
<span class="fc" id="L239">			ID orgID = OrganizationModelHandler.getEmployeeOrgID(m_context, empID);</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">			if (orgID == null) {</span>
				// add page message
<span class="nc" id="L242">				this.addPageMessage(Message.WARNING_TYPE, BbmWebBundleKey.EMP_NO_ORG, BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L243">				return;</span>
			}
<span class="fc" id="L245">			m_empMonthYearStart = RequestsMH.getEmployeeTimeOffYearStart(m_context, empID, orgID);</span>
		}
<span class="fc" id="L247">	}</span>
	
	/**
	 * Prepares the m_pool, m_empTOPoolAssignment objects for use by the m_toPoolAssignmentPC.
	 *
	 * @param empIDs
	 * @return
	 * @throws Exception
	 */
	private void prepareTOPAssignments(Collection&lt;ID&gt; empIDs, HashMap empPoolsMap) {
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">		if (empPoolsMap.size() &lt; empIDs.size()) {</span>
			// Some of the selected employees have no pool assignment on the AsOfDate, so we set it to multi-value.
<span class="nc" id="L259">			m_pool.setFieldMultiValue(TOPoolFieldInfo.TOPOOL_ID);</span>
<span class="nc" id="L260">			m_pool.setFieldMultiValue(TOPoolFieldInfo.TOPOOL_NAME);</span>
<span class="nc" id="L261">			m_empTOPoolAssignment.setFieldMultiValue(EmpTOPoolAssignmentFieldInfo.EMPTOPOOL_STARTTIME);</span>
<span class="nc" id="L262">			m_empTOPoolAssignment.setFieldMultiValue(EmpTOPoolAssignmentFieldInfo.EMPTOPOOL_ENDTIME);</span>
		} else {
			// All of the selected employees have pool assignments on the AsOfDate. See if all of the assignments are the same or not.
<span class="fc bfc" id="L265" title="All 2 branches covered.">			for (Iterator it = empPoolsMap.keySet().iterator(); it.hasNext();) {</span>
<span class="fc" id="L266">				ID empID = (ID) it.next();</span>
<span class="fc" id="L267">				Collection assignments = (Collection) empPoolsMap.get(empID);</span>
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">				for (Iterator assIt = assignments.iterator(); assIt.hasNext();) {</span>
<span class="fc" id="L269">					EmpTOPoolAssignment curAssignment = (EmpTOPoolAssignment) assIt.next();</span>
<span class="fc" id="L270">					ID poolID = curAssignment.getTOPoolID();</span>
<span class="fc" id="L271">					String poolName = curAssignment.getTOPoolName();</span>

<span class="pc bpc" id="L273" title="1 of 4 branches missed.">					if (m_pool.getID() == null &amp;&amp; !m_pool.isFieldMultiValue(TOPoolFieldInfo.TOPOOL_ID)) {</span>
						// we will only use a single pool object and a single assignment object
<span class="fc" id="L275">						m_pool.setID(poolID);</span>
<span class="fc" id="L276">						m_pool.setName(poolName);</span>
<span class="fc" id="L277">						m_empTOPoolAssignment = curAssignment;</span>
					} else {
						// Check if any of the pool properties are different for this employee than for any other
						// employee. If so, we will set those properties to multi-value properties, so that the
						// UI will show the &quot;*&quot; instead of the mixed values.
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">						if (!poolID.equals(m_pool.getID()))</span>
<span class="nc" id="L283">							m_pool.setFieldMultiValue(TOPoolFieldInfo.TOPOOL_ID);</span>

<span class="pc bpc" id="L285" title="1 of 2 branches missed.">						if (!poolName.equals(m_pool.getName()))</span>
<span class="nc" id="L286">							m_pool.setFieldMultiValue(TOPoolFieldInfo.TOPOOL_NAME);</span>

<span class="pc bpc" id="L288" title="1 of 2 branches missed.">						if (!isSameValue(curAssignment.getStartTime(), m_empTOPoolAssignment.getStartTime()))</span>
<span class="nc" id="L289">							m_empTOPoolAssignment.setFieldMultiValue(EmpTOPoolAssignmentFieldInfo.EMPTOPOOL_STARTTIME);</span>

<span class="pc bpc" id="L291" title="1 of 2 branches missed.">						if (!isSameValue(curAssignment.getEndTime(), m_empTOPoolAssignment.getEndTime()))</span>
<span class="nc" id="L292">							m_empTOPoolAssignment.setFieldMultiValue(EmpTOPoolAssignmentFieldInfo.EMPTOPOOL_ENDTIME);</span>
					}
					break; // there should be only one assignment per employee since we queried for a single instant
				}
<span class="fc" id="L296">			}</span>
		}
<span class="fc" id="L298">	}</span>

    /**
     * Determines if two Object are equal.
     * @param val1 The first Object.
     * @param val2 The second Object.
     * @return true if the two Object should be considered equal, false otherwise.
     */
    private boolean isSameValue(Object val1, Object val2)
    {
<span class="fc" id="L308">        boolean areSame = false;</span>
<span class="pc bpc" id="L309" title="1 of 4 branches missed.">        if (val1==null &amp;&amp; val2==null)</span>
        {
<span class="fc" id="L311">            areSame = true;</span>
        }
<span class="pc bpc" id="L313" title="2 of 4 branches missed.">        else if (val1==null || val2==null)</span>
        {
<span class="nc" id="L315">            areSame = false;</span>
        }
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">        else if (val1.equals(val2))</span>
        {
<span class="fc" id="L319">            areSame = true;</span>
        }
<span class="fc" id="L321">        return areSame;</span>
    }

	public void updateData() throws Exception {
<span class="fc" id="L325">		m_timeOffForm.updateData();</span>
<span class="fc" id="L326">	}</span>

	/**
	 * Return the content title
	 */

	@Override
	protected void initContentTitle() {
<span class="fc" id="L334">	m_contentTitlePC.setPageTitle(i18n(m_bundle, BbmWebBundleKey.BBM_PEOPLE_TIMEOFF));</span>

<span class="fc" id="L336">	String itemName = &quot;&quot;;</span>

<span class="pc bpc" id="L338" title="1 of 2 branches missed.">	if (getSelectedIDSize() &gt; 0) {</span>

<span class="fc bfc" id="L340" title="All 2 branches covered.">	    if (getSelectedIDSize() &gt; 1) {</span>
<span class="fc" id="L341">		itemName = m_localizer.i18n(m_bundle, BbmWebBundleKey.PEOPLE_SUMMARY_TITLE_PEOPLE, getSelectedIDSize());</span>
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">	    } else if (m_employee != null) {</span>
<span class="fc" id="L343">		itemName = m_localizer.formatName(m_employee.getPerson());</span>
	    }
	}

<span class="fc bfc" id="L347" title="All 2 branches covered.">	if (m_empMonthYearStart != null) {</span>
<span class="fc" id="L348">	    TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="fc" id="L349">	    Calendar cal = Calendar.getInstance(tz);</span>
<span class="fc" id="L350">	    cal.set(Calendar.MONTH, m_empMonthYearStart[0]);</span>
<span class="fc" id="L351">	    cal.set(Calendar.DAY_OF_MONTH, m_empMonthYearStart[1]);</span>
<span class="fc" id="L352">	    String dateDisplay = m_localizer.formatDate(cal.getTime(), tz, RegionalFormatBundleKey.DATE_NOYEAR_FORMAT);</span>

<span class="fc" id="L354">	    itemName += &quot; (&quot; + m_localizer.i18n(m_bundle, BbmWebBundleKey.EMP_TIMEOFF_YEAR_START_MF, new Object[] { dateDisplay }) + &quot;)&quot;;</span>

	}

<span class="fc" id="L358">	m_contentTitlePC.setItemName(itemName);</span>

<span class="fc" id="L360">	m_contentTitlePC.setActiveComponent(m_inputDatePicker);</span>
<span class="fc" id="L361">    }</span>

	/**
	 * Initialize the field validators
	 */
<span class="nc" id="L366">	protected void initFieldValidators() {}</span>

	/**
	 * Initialize Form Display
	 */
	protected void initForm()
	{
<span class="fc" id="L373">		initContextDateFieldNames(m_inputDatePicker);</span>
		
<span class="pc bpc" id="L375" title="1 of 2 branches missed.">		if (!m_isAllViewable)</span>
		{
<span class="nc" id="L377">			addPageMessage(Message.WARNING_TYPE,</span>
					BbmWebBundleKey.BBM_PEOPLE_TIMEOFF_NOT_ALL_VIEWABLE, BbmWebBundleKey.BUNDLE_NAME);
		}
<span class="pc bpc" id="L380" title="1 of 2 branches missed.">		else if (!m_isAllEditable)</span>
		{
<span class="nc" id="L382">			addPageMessage(Message.WARNING_TYPE,</span>
					BbmWebBundleKey.BBM_PEOPLE_TIMEOFF_NOT_ALL_EDITABLE, BbmWebBundleKey.BUNDLE_NAME);
		}
<span class="fc" id="L385">	}</span>

	/**
	 * Initialize Toolbar
	 */
	@Override
	protected void initToolbar() {
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">		boolean isBtnEnabled = !m_initFailure &amp;&amp;</span>
<span class="pc bpc" id="L393" title="2 of 4 branches missed.">                hasSelectedID() &amp;&amp; m_isAllViewable;</span>
<span class="pc bpc" id="L394" title="2 of 4 branches missed.">		boolean isSaveEnabled = isBtnEnabled &amp;&amp; m_isAllEditable;</span>
<span class="fc" id="L395">		ToolbarUtil.addValidateSaveBtn(m_toolbar, isSaveEnabled);</span>
<span class="fc" id="L396">		ToolbarUtil.addResetBtn(m_toolbar, isBtnEnabled);</span>
<span class="fc" id="L397">	}</span>

	/**
	 * Return the form title
	 */
<span class="nc" id="L402">	public String getFormTitle() { return null; }</span>

	/**
	 * Set editIdStr
	 */
	public void setEmpTokenStr(String empTokenStr) {
<span class="fc" id="L408">		m_employeeTokenStr = empTokenStr;</span>
<span class="fc" id="L409">	}</span>

	/**
	 * Return editIdStr
	 */
	public String getEmpTokenStr() {
<span class="fc" id="L415">		return m_employeeTokenStr;</span>
	}

	/**
	 * Set editIdStr
	 */
	public void setEditIdStr(String editIdStr) {
<span class="fc" id="L422">		m_editIdStr = editIdStr;</span>
<span class="fc" id="L423">	}</span>

	/**
	 * Return editIdStr
	 */
	public String getEditIdStr() {
<span class="fc" id="L429">		return m_editIdStr;</span>
	}

	/**
	 * Return true if People is Selectable
	 */
	@Override
<span class="nc" id="L436">	public boolean isPeopleSelectable() {	return false;	}</span>

	/**
	 * Return true if Page is in create mode
	 */
	@Override
<span class="fc" id="L442">	public boolean isCreateMode() { return false;	}</span>

	/**
	 * Return true if Multi Edit mode
	 */
	@Override
<span class="fc" id="L448">	public boolean isMultiEdit() { return m_isMultiEdit; }</span>

	/**
	 * Specify whether to Common Message is Enabled
	 */
	@Override
<span class="fc" id="L454">	public boolean isCommonMsgEnabled() { return true; }</span>

	/**
	 * Set the IDs of the selected employees from the selection pane, and set m_empID and m_employee accordingly.
	 * @param ids Comma delimited IDs
	 */
	@Override
	public void setSelectedID(String ids) {
<span class="fc" id="L462">		super.setSelectedID(ids);</span>
<span class="fc" id="L463">		int empCount = getSelectedIDSize();</span>

		// we must do this when coming to the profile page because the employeeid isn't set
		// from the people summary list.  we assume the first listed employee (if any) is the
		// first employee to view.
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">		if (empCount &gt; 0) {</span>
<span class="fc" id="L469">			ID empID = getSelectedIDObject();</span>
<span class="fc" id="L470">			m_employee.setID(empID);</span>
		}

<span class="fc bfc" id="L473" title="All 2 branches covered.">		if (empCount &gt; 1){</span>
<span class="fc" id="L474">			m_isMultiEdit = true;</span>
<span class="fc" id="L475">			setIsMultiObjEditEnabled(true);</span>
		}
<span class="fc" id="L477">	}</span>

	/**
	 * Set the IDs of the selected employees from the selection pane, and set m_empID and m_employee accordingly.
	 * This is called from extractParameters() because we have a hidden WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN
	 * field in the TimeOffPoolAssignmentPC. It's needed because our request handler doesn't have access to the
	 * selected IDs otherwise.
	 * @param ids Comma delimited IDs
	 */
	@Override
	public void setPerformActionOnID(String aVal)
	{
<span class="fc" id="L489">		setSelectedID(aVal);</span>
<span class="fc" id="L490">	}</span>

	/**
	 * Return Associated Employee
	 */
	public Employee getEmployee() {
<span class="fc" id="L496">		Collection&lt;ID&gt; empIDs = getSelectedIDsAsCollection();</span>

<span class="fc" id="L498">		m_viewByModDate = m_inputDatePicker.getDate();</span>
<span class="pc bpc" id="L499" title="1 of 2 branches missed.">		if (m_viewByModDate == null) {</span>
<span class="nc" id="L500">			m_viewByModDate = new Date();</span>
		}

<span class="fc" id="L503">		Map profileData = null;</span>
		try {
<span class="pc bpc" id="L505" title="1 of 2 branches missed.">			if (empIDs.size() &gt; 1) {</span>
<span class="nc" id="L506">				profileData = PeopleMH.getProfileDataMultiEdit(empIDs, m_viewByModDate, m_context.getLocaleContext(), m_context.isInWhatIfMode());</span>
			} else {
<span class="fc" id="L508">				ID userID = m_context.getUser().getID();</span>
<span class="fc" id="L509">				profileData = PeopleMH.getProfileData(m_employee.getID(), userID, m_viewByModDate, false, m_context.getLocaleContext(),</span>
<span class="fc" id="L510">						m_context.isInWhatIfMode());</span>
			}
<span class="fc" id="L512">			Employee temp = (Employee) profileData.get(PeopleDataKey.EMPLOYEE);</span>
<span class="fc" id="L513">			m_employee.setPerson(temp.getPerson());</span>
<span class="nc" id="L514">		} catch (Exception e) {</span>
<span class="nc" id="L515">			log.error(this.i18n(this.m_bundle, RmWebLogBundleKey.UNABLE_TO_LOAD_PERSON_INFO_FOR_EMPLOYEE), e);</span>
<span class="fc" id="L516">		}</span>

<span class="pc bpc" id="L518" title="1 of 2 branches missed.">		if (!m_isMultiEdit) {</span>
<span class="fc" id="L519">			m_employee.setIDInString(m_employeeTokenStr);</span>
		} else {
<span class="nc" id="L521">			m_employee.setMultiEditIDsInString(m_editIdStr);</span>
		}
<span class="fc" id="L523">		return m_employee;</span>
	}

	// override extract parameters to init employee object
	@Override
	public boolean extractParameters(HttpServletRequest request)
	{
		//Note: super.extractParameters() will call setPerformActionOnID(), but we need it to be done
		//before m_timeOffForm.initData(), so I'll call it manually. We cannot move extractParameters()
		//first because it doesn't work properly for some unknown reason.
<span class="fc" id="L533">		String performActionOnID = request.getParameter(WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN);</span>
<span class="pc bpc" id="L534" title="1 of 4 branches missed.">		if (performActionOnID != null &amp;&amp; performActionOnID.length() &gt; 0) {</span>
<span class="fc" id="L535">			setPerformActionOnID(performActionOnID);</span>
		}

<span class="fc" id="L538">		m_timeOffForm.initData(m_employee, false, m_isMultiEdit);</span>
<span class="fc" id="L539">		m_timeOffForm.setIsEditable(true);//Currently only Editable TimeOffPC will extract data to m_employee</span>

<span class="fc" id="L541">		boolean success = super.extractParameters(request); //result;</span>

<span class="fc" id="L543">		Date date = m_inputDatePicker.getDate();</span>
<span class="fc bfc" id="L544" title="All 2 branches covered.">		if (date != null) {</span>
<span class="fc" id="L545">			m_context.setAttribute(RequestContext.SESSION_SCOPE, SHOW_AS_DATE_FN, date);</span>
		}

<span class="fc" id="L548">		return success;</span>
	}

	/**
	 * Generate Custom JavaScript Code
	 */
	@Override
	public String getCustomJavaScript() {
<span class="fc" id="L556">		return super.getCustomJavaScript() + m_timeOffForm.getCustomValidateFormJS();</span>
	}

	/**
	 * Return Required HTML for this component
	 */
	@Override
	public String getRequiredHTML() {
<span class="fc" id="L564">		return super.getRequiredHTML() +</span>
<span class="fc" id="L565">				HtmlUtil.makeHiddenInput(SELECTED_ID_FN, getSelectedID()) +</span>
<span class="fc" id="L566">				HtmlUtil.makeHiddenInput(&quot;editIdStr&quot;, getEditIdStr()) +</span>
<span class="fc" id="L567">				HtmlUtil.makeHiddenInput(&quot;empTokenStr&quot;, getEmpTokenStr());</span>
	}

	/**
	 * Return URL for HTML Form Action
	 */
	@Override
	public String getFormAction() {
<span class="fc" id="L575">		return &quot;people_timeoff&quot;;</span>
	}
	
	
	public EmployeeReferenceScheduleAssignmentUpdateParameters getUpdateAssignment() {
<span class="nc bnc" id="L580" title="All 2 branches missed.">		return  m_referenceSchedulePC == null? null : m_referenceSchedulePC.getUpdateAssignment();</span>
	}

	/**
	 * Return the time off pool ID currently set in the TOPoolAssignment page component.
	 */
	public ID getPoolID()
	{
<span class="fc" id="L588">		return m_toPoolAssignmentPC.getPoolId();</span>
	}
		

	public Object getTOPoolEffStartDate()
	{
<span class="pc bpc" id="L594" title="2 of 4 branches missed.">        boolean isMultiSDate = m_empTOPoolAssignment!=null &amp;&amp; m_empTOPoolAssignment.isFieldMultiValue(EmpTOPoolAssignmentFieldInfo.EMPTOPOOL_STARTTIME);</span>

<span class="fc" id="L596">        Object date = m_toPoolAssignmentPC.getTOPoolEffStartDate();</span>
<span class="pc bpc" id="L597" title="1 of 2 branches missed.">        if (isMultiSDate)</span>
<span class="nc" id="L598">        	date = null; //null indicates NO CHANGE to the date from what is already in the database</span>
<span class="pc bpc" id="L599" title="1 of 2 branches missed.">        else if (date == null)</span>
<span class="nc" id="L600">        	date = new NullObject(); //NullObject SHOULD set the date to null in the db (this should never happen)</span>

<span class="fc" id="L602">		return date;</span>
	}

	public Object getTOPoolEffEndDate()
	{
<span class="pc bpc" id="L607" title="2 of 4 branches missed.">        boolean isMultiEDate = m_empTOPoolAssignment!=null &amp;&amp; m_empTOPoolAssignment.isFieldMultiValue(EmpTOPoolAssignmentFieldInfo.EMPTOPOOL_ENDTIME);</span>

<span class="fc" id="L609">        Object date = m_toPoolAssignmentPC.getTOPoolEffEndDate();</span>
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">        if (isMultiEDate)</span>
<span class="nc" id="L611">        	date = null; //null indicates NO CHANGE to the date from what is already in the database</span>
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">        else if (date == null)</span>
<span class="fc" id="L613">        	date = new NullObject(); //NullObject SHOULD set the date to null in the db (this means &quot;no end date&quot;)</span>

<span class="fc" id="L615">		return date;</span>
	}
	
	public boolean referenceScheduleNeedsUpdate() {
<span class="pc bpc" id="L619" title="1 of 2 branches missed.">		return m_referenceSchedulePC==null? false : m_referenceSchedulePC.needsUpdate();</span>
	}
	

    /**
     * Get the pool effectivity mode telling us whether or not we should save the effective dates.
     * Note: This is not the same as the updateMode, which is the popup radio button setting.
     * @return - one of MODE_VIEW_POOL, MODE_SAVE_POOL
     */
    public String getMode()
    {
<span class="fc" id="L630">    	return m_toPoolAssignmentPC.getMode();</span>
    }

    /**
     * Get the view date, also known as the &quot;As of date&quot; that the user chose in the date picker.
     * @return the view date.
     */
    public Date getAsOfDate()
    {
<span class="pc bpc" id="L639" title="1 of 2 branches missed.">    	if (m_viewByModDate == null)</span>
<span class="nc" id="L640">    		return m_inputDatePicker.getDate();</span>

<span class="fc" id="L642">    	return m_viewByModDate;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>