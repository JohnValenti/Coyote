<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.people.timeoff</a> &gt; <span class="el_source">TimeOffPC.java</span></div><h1>TimeOffPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.people.timeoff;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.TreeModel;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategory;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategoryFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityTimeOffBalance;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityTimeOffBalanceFieldInfo;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOff;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffAccrued;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffAccruedFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
//import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TOAccrualCalculator;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.people.profile.ProfileContainerIF;
import com.bluepumpkin.web.bbm.workresource.WorkResourceModelHandler;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.jsp.HtmlImage;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.table.DefaultHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.tree.MultiColTreePC;
import com.witness.web.uif.pagecomponent.tree.util.DefaultSortableTreeNodeHelper;
import com.witness.web.uif.pagecomponent.tree.util.SortableTreeNodeHelper;
import com.witness.web.uif.pagecomponent.tree.util.TreeModelBuilder;
import com.witness.web.uif.pagecomponent.tree.util.TreeNodeConverter;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpaneFieldNames;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.validator.InNumericRangeFieldValidator;
import com.witness.web.uif.validator.IsNonNegativeFieldValidator;
import com.witness.web.uif.validator.IsNumericFieldValidator;

/**
 * Title:        ProfileTimeOffPC
 * Description:  includes collapsible section of the form with contacts info fields
 *                  to use it   a) construct object
 *                              b) extract parameters
 *                              c) use getters of the field collections
 *                              d) set all fields in setData(...)
 *                              e) customize CSS class if needed
 *                              e) use getHtmlDisplay
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       Swati Tewari
 * @version      1.0
 */
public class TimeOffPC extends MultiColTreePC implements ProfileContainerIF {  
	// Form field names, for use by field validators; should begin with lowercase letter
	private static final String LAST_BALANCE_FN = &quot;lastBalance&quot;;
	private static final String LAST_DATE_FN = &quot;lastDate&quot;;
	private static final String MAX_BALANCE_FN = &quot;maxBalance&quot;;
	private static final String MAX_CARRYOVER_FN = &quot;maxCarryover&quot;;
	private static final String HOURSYEAR_FN = &quot;hoursYear&quot;;
	private static final String PERDAY_FN = &quot;perDay&quot;;
	private static final String PERWEEK_FN = &quot;perWeek&quot;;
	private static final String UNION_ID_FN = &quot;unionID&quot;;
	private static final String TIMEOFFID_FN = &quot;timeOffID&quot;;
	private static final String ACT_CAT_PREFIX = &quot;type&quot;;

	private final ResourceBundle m_bundle;
<span class="fc" id="L97">	private String m_headerCssClass = &quot;tableHeaderLightLeft&quot;;</span>

	private static final int NUM_OF_YEARS = 4;
<span class="fc" id="L100">	private boolean m_isEditable = false;</span>
<span class="fc" id="L101">	private boolean m_isMultiEdit = false;</span>
<span class="fc" id="L102">	private boolean m_hasAccrualLicense = true; //TOAccrualCalculator.hasLicenseForAccrual();</span>

<span class="fc" id="L104">	private Collection m_empIDs = Collections.EMPTY_LIST;</span>
<span class="fc" id="L105">	private Employee m_employee = null;</span>
<span class="fc" id="L106">	private Collection m_colTimeOffs = Collections.EMPTY_LIST;</span>
<span class="fc" id="L107">	private Map m_timeOffMap = Collections.EMPTY_MAP;</span>
<span class="fc" id="L108">	private Map m_rowData = Collections.EMPTY_MAP;</span>
<span class="fc" id="L109">	private int m_rowDataNum = 0;</span>
	private ID m_commonOrgID;

	private final DataUpdater m_dataUpdater;

<span class="fc" id="L114">	private final Map/*&lt;String, String&gt;*/ m_historyPopupArgsMap = new HashMap();</span>

	/**
	 * default Constructor
	 */
	public TimeOffPC(RequestContext context) {
<span class="fc" id="L120">		super(context);</span>
<span class="fc" id="L121">		m_bundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L122">		m_dataUpdater = new DataUpdater(context);</span>
<span class="fc" id="L123">		this.setName(&quot;timeOffForm&quot;);</span>
<span class="fc" id="L124">		this.setIsTreeRootShown(false);</span>
<span class="fc" id="L125">		this.setMultiRowSelectable(false);</span>
<span class="fc" id="L126">	}//constructor</span>

	public boolean isAuthorized(User user, boolean isMyProfile) {
<span class="pc bpc" id="L129" title="3 of 4 branches missed.">		boolean isAuthorized = isMyProfile &amp;&amp; user.isAuthorized(PrivilegeKeys.TOM_VIEWPERSONALSUMMARY);</span>
<span class="fc" id="L130">		return isAuthorized;</span>
	}

	/**
	 * Initialize PC with Data to be displayed
	 */
	public void init(Collection ids, Employee emp, boolean isConfigDataOnly,
			boolean isEditable, boolean isMultiEdit, Date viewDate, PageModel model) throws Exception {

	    
	   
		    
<span class="fc" id="L142">		ID orgID = Organization.YOUR_COMPANY_ID_OBJ;</span>
<span class="pc bpc" id="L143" title="1 of 4 branches missed.">		if (!ids.isEmpty() &amp;&amp; ids.size() &gt; 1)</span>
		{
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">			LocalDate lDate = (viewDate==null) ? new LocalDate(new Date()) : new LocalDate(viewDate);</span>
<span class="fc" id="L146">			orgID = WorkResourceModelHandler.getEmployeesCommonOrganization(m_context, ids, lDate, lDate);</span>
<span class="fc" id="L147">		} </span>
		else 
		{
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">		    if (emp.getID() != null)</span>
<span class="fc" id="L151">			orgID = emp.getOrganizationID();</span>
		}
		
<span class="fc" id="L154">		m_commonOrgID = orgID;</span>
<span class="fc" id="L155">		m_empIDs = ids;</span>

<span class="fc" id="L157">		m_isEditable = isEditable;</span>
<span class="fc" id="L158">		m_hasAccrualLicense = true; //TOAccrualCalculator.hasLicenseForAccrual();</span>
<span class="fc" id="L159">		initData(emp, isConfigDataOnly, isMultiEdit);</span>
<span class="fc" id="L160">		addFieldValidators(model);</span>
<span class="fc" id="L161">	}</span>

	/**
	 * Initialize Data
	 */
	public void initData(Employee emp, boolean bMergeData, boolean isMultiEdit) {
<span class="fc" id="L167">		m_isMultiEdit = isMultiEdit;</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">		if (emp == null) </span>
<span class="nc" id="L169">		    return;</span>
<span class="fc" id="L170">		m_employee = emp;</span>
		
		
		

		// m_colTimeOffs
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">		if (!bMergeData) {</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">			if (!m_isMultiEdit) {</span>
<span class="fc" id="L178">				m_colTimeOffs = m_employee.getTimeOffs();</span>
			} else {
<span class="fc" id="L180">				m_colTimeOffs = m_employee.getMultiEditTimeOffs();</span>
			}
		}

		// m_rowData &amp; m_rowDataNum
<span class="fc" id="L185">		m_rowData = new HashMap();</span>
<span class="fc" id="L186">		Collection activities = null;</span>
<span class="fc" id="L187">		Collection actCats    = null;</span>
<span class="fc" id="L188">		Collection actIDs    = new ArrayList();</span>
<span class="fc" id="L189">		Collection actCatIDs = new ArrayList();</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">		if (m_commonOrgID != null) {</span>
			try {
				//get activities with isAbsence=yes
<span class="fc" id="L193">				ActivityFilter activityFilter = new ActivityFilter();</span>
<span class="fc" id="L194">				activityFilter.setTimeoff(true);  //setTimeoffWithAllotment(true);</span>
<span class="fc" id="L195">				activities = ActivityModelHandler.getActivities(m_context, m_commonOrgID, activityFilter);</span>

<span class="fc" id="L197">				ActivityCategoryFilter filter = new ActivityCategoryFilter();</span>
<span class="fc" id="L198">				filter.setTimeoffWithAllotment(true);</span>
<span class="fc" id="L199">				actCats = ActivityModelHandler.getActivityCategories(m_context, m_commonOrgID, filter);</span>
<span class="nc" id="L200">			} catch (Exception ex) {</span>
<span class="fc" id="L201">			}</span>
		}
<span class="fc bfc" id="L203" title="All 2 branches covered.">		if (actCats != null) {</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">			for (Iterator it = actCats.iterator(); it.hasNext();) {</span>
<span class="nc" id="L205">				ActivityCategory actCat = (ActivityCategory) it.next();</span>
<span class="nc" id="L206">				RowData row = new RowData(actCat);</span>
<span class="nc" id="L207">				row.rowIndex = m_rowData.size();</span>
<span class="nc" id="L208">				m_rowData.put(row.unionID, row);</span>
<span class="nc" id="L209">				actCatIDs.add(actCat.getID());</span>
<span class="nc" id="L210">			}</span>
		}
<span class="fc bfc" id="L212" title="All 2 branches covered.">		if (activities != null) {</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">			for (Iterator it = activities.iterator(); it.hasNext();) {</span>
<span class="fc" id="L214">				Activity act = (Activity) it.next();</span>
<span class="fc" id="L215">				RowData row = new RowData(act);</span>
<span class="fc" id="L216">				row.rowIndex = m_rowData.size();</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">				if (m_rowData.containsKey(row.parentID))//contains this activity's category</span>
<span class="nc" id="L218">					row.isFirstLayer = false;</span>
<span class="fc" id="L219">				m_rowData.put(row.unionID, row);</span>
<span class="fc" id="L220">				actIDs.add(act.getID());</span>
<span class="fc" id="L221">			}</span>
		}
<span class="fc" id="L223">		m_rowDataNum = m_rowData.size();</span>

		// EmployeeTimeOffAccrued &amp; ActivityTimeOffBalance
<span class="fc bfc" id="L226" title="All 2 branches covered.">		if (m_rowDataNum &gt; 0) {//when m_commonOrgID == null</span>
			try {
<span class="fc" id="L228">				Collection toAccrueds = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode())</span>
<span class="fc" id="L229">						.getLastUpdatedTOAccrued(m_empIDs, actIDs, actCatIDs);</span>
<span class="fc" id="L230">				Collection toBalances = WfmManagerFactory.getActivityManager(m_context.isInWhatIfMode())</span>
<span class="fc" id="L231">						.getTOBalanceForActivities(m_empIDs, actIDs, actCatIDs);</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">				for (Iterator it = toAccrueds.iterator(); it.hasNext();) {</span>
<span class="fc" id="L233">					EmployeeTimeOffAccrued toAccrued = (EmployeeTimeOffAccrued) it.next();</span>
<span class="fc" id="L234">					ID unionID = getUnionID(toAccrued.getActivityID(), toAccrued.getActivityCategoryId());</span>
<span class="fc" id="L235">					RowData row = (RowData) m_rowData.get(unionID);</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">					if (row != null) row.toAccrueds.add(toAccrued);</span>
<span class="fc" id="L237">				}</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">				for (Iterator it = toBalances.iterator(); it.hasNext();) {</span>
<span class="nc" id="L239">					ActivityTimeOffBalance toBalance = (ActivityTimeOffBalance) it.next();</span>
<span class="nc" id="L240">					ID unionID = getUnionID(toBalance.getActivityID(), toBalance.getActivityCategoryId());</span>
<span class="nc" id="L241">					RowData row = (RowData) m_rowData.get(unionID);</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">					if (row != null) row.toBalances.add(toBalance);</span>
<span class="nc" id="L243">				}</span>
<span class="nc" id="L244">			} catch (Exception ex) {</span>
<span class="fc" id="L245">			}</span>
		}
<span class="fc" id="L247">	}</span>

	private Collection getEmployeeTimeOffs() {
<span class="fc" id="L250">		return m_colTimeOffs;</span>
	}

	/**
	 * Adds field validators to the page model
	 *
	 * @param pageModel is the page model which contains this component
	 *
	 * Pre-condition: initData has to be called first
	 */
	public void addFieldValidators(PageModel pageModel) {
<span class="pc bpc" id="L261" title="2 of 4 branches missed.">		if (!isEnabled() || !m_isEditable) return;</span>

<span class="fc" id="L263">		String bName = BbmWebBundleKey.BUNDLE_NAME;</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">		for (Iterator it = m_rowData.values().iterator(); it.hasNext();) {</span>
<span class="fc" id="L265">			RowData rowData = (RowData) it.next();</span>
<span class="fc" id="L266">			int i = rowData.rowIndex;</span>

<span class="pc bpc" id="L268" title="1 of 2 branches missed.">			if (rowData.isFirstLayer) {</span>
<span class="pc bpc" id="L269" title="1 of 4 branches missed.">				if (m_hasAccrualLicense &amp;&amp; rowData.isTOAllotment) {</span>
					//Last updated
<span class="fc" id="L271">					pageModel.addValidator(new IsNumericFieldValidator(this, LAST_BALANCE_FN + i, BbmWebBundleKey.LastUpdatedBalance, bName));</span>
					//Max Balance &amp; Carryover
<span class="fc" id="L273">					pageModel.addValidator(new IsNonNegativeFieldValidator(this, MAX_BALANCE_FN + i, BbmWebBundleKey.MaxBalance, bName));</span>
<span class="fc" id="L274">					pageModel.addValidator(new IsNonNegativeFieldValidator(this, MAX_CARRYOVER_FN + i, BbmWebBundleKey.MaxCarryover, bName));</span>
				}
<span class="fc bfc" id="L276" title="All 2 branches covered.">				if (rowData.isTOAllotment) {</span>
					//allotment: this year
<span class="fc bfc" id="L278" title="All 2 branches covered.">					for (int index = 0; index &lt; NUM_OF_YEARS; index++) {</span>
<span class="fc" id="L279">						String yearFN = HOURSYEAR_FN + index + &quot;_&quot; + i;</span>
<span class="fc" id="L280">						pageModel.addValidator(new IsNumericFieldValidator(this, yearFN, BbmWebBundleKey.ThisYear, bName));</span>
<span class="fc" id="L281">						pageModel.addValidator(new InNumericRangeFieldValidator(this, yearFN, BbmWebBundleKey.ThisYear, bName, 0.0, 8760.0, m_localizer));</span>
<span class="fc" id="L282">						pageModel.addValidator(new IsNonNegativeFieldValidator(this, yearFN, BbmWebBundleKey.ThisYear, bName));</span>
					}
				}
			}

<span class="pc bpc" id="L287" title="1 of 2 branches missed.">			if (rowData.act != null) {</span>
				//default per day
<span class="fc" id="L289">				String dayFN = PERDAY_FN + &quot;R&quot; + i;</span>
<span class="fc" id="L290">				pageModel.addValidator(new IsNumericFieldValidator(</span>
						this, dayFN, BbmWebBundleKey.DefaultPerDay, bName));
<span class="fc" id="L292">				pageModel.addValidator(new InNumericRangeFieldValidator(</span>
						this, dayFN, BbmWebBundleKey.DefaultPerDay, bName, 0.0, 24.0, m_localizer));
<span class="fc" id="L294">				pageModel.addValidator(new IsNonNegativeFieldValidator(</span>
						this, dayFN, BbmWebBundleKey.DefaultPerDay, bName));

				//default per week
<span class="fc" id="L298">				String weekFN = PERWEEK_FN + &quot;R&quot; + i;</span>
<span class="fc" id="L299">				pageModel.addValidator(new IsNumericFieldValidator(</span>
						this, weekFN, BbmWebBundleKey.DefaultPerWeek, BbmWebBundleKey.BUNDLE_NAME));
<span class="fc" id="L301">				pageModel.addValidator(new InNumericRangeFieldValidator(</span>
						this, weekFN, BbmWebBundleKey.DefaultPerWeek, BbmWebBundleKey.BUNDLE_NAME, 0.0, 168.0, m_localizer));
<span class="fc" id="L303">				pageModel.addValidator(new IsNonNegativeFieldValidator(</span>
						this, weekFN, BbmWebBundleKey.DefaultPerWeek, bName));
			}
<span class="fc" id="L306">		}</span>
<span class="fc" id="L307">	}</span>
	
	
	


	/**
	 * Page Model should invoke this method in getCustomJavaScript().
	 *
	 * It generates JavaScript Validation to make sure default per week is &gt; than per day.
	 * v11.2 Added validation for having a last date if there is a last balance.
	 */
	public String getCustomValidateFormJS() {
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">		if (m_isEditable) {</span>
<span class="fc" id="L321">			return &quot;function customValidateForm() {\n&quot; +</span>
					&quot;  for (var i=0; i&lt;&quot;+ m_rowDataNum+&quot;; i++) {\n&quot; +
					&quot;    var eDayFN = \&quot;&quot; + PERDAY_FN + &quot;R\&quot; + i;\n&quot; +
					&quot;    var eWeekFN = \&quot;&quot; + PERWEEK_FN + &quot;R\&quot; + i;\n&quot; +
					&quot;    var eLastBalanceFN = \&quot;&quot; + LAST_BALANCE_FN + &quot;\&quot; + i;\n&quot; +
					&quot;    var eLastDateFN = \&quot;&quot; + LAST_DATE_FN + &quot;\&quot; + i;\n&quot; +
					&quot;    var eDay = DOM2.getElementById(eDayFN);\n&quot;+
					&quot;    var eWeek = DOM2.getElementById(eWeekFN);\n&quot;+
					&quot;    var eLastBalance = DOM2.getElementById(eLastBalanceFN);\n&quot;+
					&quot;    var eLastDate = DOM2.getElementById(eLastDateFN);\n&quot;+
					&quot;&quot;	+
					&quot;    if (eLastBalance &amp;&amp; eLastBalance.value != '' &amp;&amp;  (eLastDate &amp;&amp; eLastDate.value == '' )) {\n&quot;+
<span class="fc" id="L333">					&quot;	alert(\&quot;&quot; + i18n(m_bundle, BbmWebBundleKey.INCOMPLETE_LAST_UPDATE_MSG) +&quot;\&quot;);\n&quot; +</span>
					&quot;	eLastDate.focus();\n&quot; +
					&quot;	return false;\n&quot; +
					&quot;	}\n&quot; +
					&quot;&quot;	+
					&quot;    if (eLastDate &amp;&amp; eLastDate.value != '' &amp;&amp;  (eLastBalance &amp;&amp; eLastBalance.value == '' )) {\n&quot;+
<span class="fc" id="L339">					&quot;	alert(\&quot;&quot; + i18n(m_bundle, BbmWebBundleKey.INCOMPLETE_LAST_UPDATE_MSG) +&quot;\&quot;);\n&quot; +</span>
					&quot;	eLastBalance.focus();\n&quot; +
					&quot;	return false;\n&quot; +
					&quot;	}\n&quot; +
					&quot;&quot;	+
					&quot;    if (!eDay || !eWeek) {continue;}\n&quot;+
					&quot;    if (eDay.value != '' &amp;&amp; eWeek.value == ''){\n&quot;+
<span class="fc" id="L346">					&quot;      alert(\&quot;&quot; + i18n(m_bundle, BbmWebBundleKey.REQUIRED_DEFAULT_WEEK_MSG) +&quot;\&quot;);\n&quot; +</span>
					&quot;      eWeek.focus();\n&quot; +
					&quot;      return false;\n&quot; +
					&quot;    }\n&quot; +
					&quot;    if (eDay.value == '' &amp;&amp; eWeek.value != ''){\n&quot;+
<span class="fc" id="L351">					&quot;      alert(\&quot;&quot; + i18n(m_bundle, BbmWebBundleKey.REQUIRED_DEFAULT_DAY_MSG) +&quot;\&quot;);\n&quot; +</span>
					&quot;      eDay.focus();\n&quot; +
					&quot;      return false;\n&quot; +
					&quot;    }\n&quot; +
					&quot;    if (eDay.value &amp;&amp; eWeek.value &amp;&amp; parseFloat(eWeek.value) &lt; parseFloat(eDay.value)) {\n&quot; +
					&quot;      eWeek.select();eWeek.focus();\n&quot; +
<span class="fc" id="L357">					&quot;      alert(\&quot;&quot; + i18n(m_bundle, BbmWebBundleKey.DEFAULT_WEEK_LESS_THAN_DAY_MSG) +&quot;\&quot;);\n&quot; +</span>
					&quot;      return false;\n&quot; +
					&quot;    }\n&quot; +
					&quot;  }\n&quot; +
					&quot;  return true;\n&quot; +
					&quot;}\n&quot;;
			
			
		} else {
<span class="nc" id="L366">			return &quot;&quot;;</span>
		}
	}

	//====================== data ========================================
	/**
	 * customize CSS class
	 */
	public void setCssClass(String sCssClass) {
<span class="nc" id="L375">		m_headerCssClass = sCssClass;</span>
<span class="nc" id="L376">	}//setCssClasses</span>

	public void setIsEditable(boolean isEditable) {
<span class="fc" id="L379">		m_isEditable = isEditable;</span>
<span class="fc" id="L380">	}</span>

	//====================== extracting data ========================================

	/**
	 * Overwrite ExtractParameters to check for component name
	 * @param request The HttpRequest
	 * @return true if no errors were encountered, otherwise false
	 */
	public boolean extractParameters(HttpServletRequest request) {

		//When not editable, avoid extractParameters() and therefore alter data in m_employee object.
		//Because posting data in MyProfile page, although not modified, can result in an Exception. (QC#48185)
		//So here as an easy fix, we avoid extractParameters() when this PC is not editable. (By Default)
		//On the other hand, TimeOffPM will need to enable Editable for this PC, to properly extractParameters() for update.
<span class="pc bpc" id="L395" title="1 of 2 branches missed.">		if (!m_isEditable) </span>
<span class="nc" id="L396">		    return true;</span>

<span class="fc" id="L398">		m_colTimeOffs = new ArrayList();</span>

		//reset multiedit
<span class="fc" id="L401">		String sTmp = request.getParameter(WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN); //(&quot;selectedID&quot;);</span>
<span class="fc bfc" id="L402" title="All 2 branches covered.">		if (!StringUtil.isEmpty(sTmp)) {</span>
<span class="fc" id="L403">			m_empIDs = StringUtil.parseIDStringToCollection(sTmp);</span>
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">			if (m_empIDs.size() &gt; 1)</span>
<span class="nc" id="L405">				m_isMultiEdit = true;</span>
		}

<span class="fc" id="L408">		m_dataUpdater.clear();</span>

<span class="fc" id="L410">		int i = 0;</span>
		//for (int i = 0; i&lt;m_activityNum; i++) {
<span class="fc bfc" id="L412" title="All 2 branches covered.">		while (request.getParameter(UNION_ID_FN + &quot;R&quot; + i) != null) {</span>
<span class="fc" id="L413">			EmployeeTimeOff tmpTimeOff = new EmployeeTimeOff();</span>

<span class="fc" id="L415">			boolean bNewRecord = true;</span>
<span class="fc" id="L416">			boolean bNewRecordEntered = false;</span>

<span class="fc" id="L418">			double val = 0.00;</span>
			//ID
<span class="fc" id="L420">			sTmp = request.getParameter(TIMEOFFID_FN + &quot;R&quot; + i);</span>
<span class="fc bfc" id="L421" title="All 2 branches covered.">			if (!StringUtil.isEmpty(sTmp)) {</span>
<span class="pc bpc" id="L422" title="1 of 2 branches missed.">				if (sTmp.length() &gt; 0) {</span>
<span class="fc" id="L423">					bNewRecord = false;</span>
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">					if (m_isMultiEdit) {</span>
<span class="nc" id="L425">						tmpTimeOff.setMultiEditIDsInString(sTmp);</span>
					} else {
<span class="fc" id="L427">						tmpTimeOff.setIDInString(sTmp);  // setID(new ID(sTmp));</span>
					}
				}
			}

			//activityID &amp; activityCategoryID
<span class="fc" id="L433">			sTmp = request.getParameter(UNION_ID_FN + &quot;R&quot; + i);</span>
<span class="fc" id="L434">			ID unionID = new ID(sTmp);</span>
<span class="pc bpc" id="L435" title="1 of 2 branches missed.">			if (!StringUtil.isEmpty(sTmp)) </span>
			{
<span class="fc" id="L437">				ID[] solvedIDs = solveUnionID(unionID);</span>
				
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">				if (solvedIDs[0] != null)</span>
				{
<span class="fc" id="L441">					tmpTimeOff.setActivityID(solvedIDs[0]);</span>
				}
				
<span class="pc bpc" id="L444" title="1 of 2 branches missed.">				if (solvedIDs[1] != null)</span>
				{
<span class="nc" id="L446">					tmpTimeOff.setActivityCategoryID(solvedIDs[1]);</span>
					
<span class="nc bnc" id="L448" title="All 2 branches missed.">					if (solvedIDs[0] == null)</span>
					{
<span class="nc" id="L450">						tmpTimeOff.setActivityID(null);</span>
					}
				}
			}

			//Last updated
			String sTmp1, sTmp2;
<span class="fc" id="L457">			sTmp1 = request.getParameter(LAST_BALANCE_FN + i);</span>
<span class="fc" id="L458">			sTmp2 = request.getParameter(LAST_DATE_FN + i);</span>
<span class="pc bpc" id="L459" title="1 of 4 branches missed.">			if (sTmp1 != null || sTmp2 != null)</span>
<span class="fc" id="L460">				m_dataUpdater.putTOAccrued(unionID, sTmp1, sTmp2);</span>

			//Max Balance &amp; Carryover
<span class="fc" id="L463">			sTmp1 = request.getParameter(MAX_BALANCE_FN + i);</span>
<span class="fc" id="L464">			sTmp2 = request.getParameter(MAX_CARRYOVER_FN + i);</span>
<span class="pc bpc" id="L465" title="1 of 4 branches missed.">			if (sTmp1 != null || sTmp2 != null)</span>
<span class="fc" id="L466">				m_dataUpdater.putTOBalance(unionID, sTmp1, sTmp2);</span>

			//yearly data
<span class="fc bfc" id="L469" title="All 2 branches covered.">			for (int index = 0; index &lt; NUM_OF_YEARS; index++) {</span>
<span class="fc" id="L470">				sTmp = request.getParameter(HOURSYEAR_FN + index + &quot;_&quot; + i);</span>
<span class="fc bfc" id="L471" title="All 2 branches covered.">				sTmp = (StringUtil.isEmpty(sTmp)) ? &quot;0&quot; : sTmp;</span>
<span class="fc bfc" id="L472" title="All 2 branches covered.">				if (bNewRecord) bNewRecordEntered = true;</span>
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">				if (!sTmp.equals(&quot;*&quot;)) {</span>
<span class="fc" id="L474">					val = FormInputPC.convertLocalizedRealNumber(sTmp, m_localizer);</span>
					//if (m_hasAccrualLicense) {
<span class="fc" id="L476">						tmpTimeOff.setAccrualRateByYear(index, val);</span>
					//} else {
					//	tmpTimeOff.setHoursByYear(index, val);
					//}
				} else {//multiple
<span class="nc" id="L481">					tmpTimeOff.setFieldMultiValue(EmployeeTimeOffFieldInfo.EMPTIMEOFF_ACCRUALRATE_YEAR1 + index);</span>
				}
			}

			//per day
<span class="fc" id="L486">			sTmp = request.getParameter(PERDAY_FN + &quot;R&quot; + i);</span>
<span class="fc bfc" id="L487" title="All 2 branches covered.">			sTmp = (StringUtil.isEmpty(sTmp)) ? &quot;0&quot; : sTmp;</span>
<span class="pc bpc" id="L488" title="1 of 4 branches missed.">			if (bNewRecord &amp;&amp; sTmp.length() &gt; 0) bNewRecordEntered = true;</span>
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">			if (!sTmp.equals(&quot;*&quot;)) {</span>
<span class="fc" id="L490">				val = FormInputPC.convertLocalizedRealNumber(sTmp, m_localizer);</span>
<span class="fc" id="L491">				tmpTimeOff.setHoursPerDay(val);</span>
			} else {//multiple
<span class="nc" id="L493">				tmpTimeOff.setFieldMultiValue(EmployeeTimeOffFieldInfo.EMPTIMEOFF_HOURSPERDAY);</span>
			}

			//per week
<span class="fc" id="L497">			sTmp = request.getParameter(PERWEEK_FN + &quot;R&quot; + i);</span>
<span class="fc bfc" id="L498" title="All 2 branches covered.">			sTmp = (StringUtil.isEmpty(sTmp)) ? &quot;0&quot; : sTmp;</span>
<span class="fc bfc" id="L499" title="All 2 branches covered.">			if (bNewRecord) bNewRecordEntered = true;</span>
<span class="pc bpc" id="L500" title="1 of 2 branches missed.">			if (!sTmp.equals(&quot;*&quot;)) {</span>
<span class="fc" id="L501">				val = FormInputPC.convertLocalizedRealNumber(sTmp, m_localizer);</span>
<span class="fc" id="L502">				tmpTimeOff.setHoursPerWeek(val);</span>
			} else {//multiple
<span class="nc" id="L504">				tmpTimeOff.setFieldMultiValue(EmployeeTimeOffFieldInfo.EMPTIMEOFF_HOURSPERWEEK);</span>
			}

<span class="fc" id="L507">			m_colTimeOffs.add(tmpTimeOff);</span>
<span class="pc bpc" id="L508" title="1 of 4 branches missed.">			if (!bNewRecord || bNewRecordEntered) </span>
			{
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">				if (!m_isMultiEdit) </span>
				{
					//This IF is useless, currently updateTimeOff() is same as addTimeOff().
					//Thus, updateTimeOff() may add redundant Objects, Rick Sun 10/30/2009
					/*
					if (tmpTimeOff.getID() == null)
						m_employee.addTimeOff(tmpTimeOff);
					else
						m_employee.updateTimeOff(tmpTimeOff);
					*/
					
<span class="fc" id="L521">					ArrayList empTimeOffs = m_employee.getTimeOffs();</span>
<span class="fc bfc" id="L522" title="All 2 branches covered.">					if (!empTimeOffsContains(empTimeOffs, tmpTimeOff))</span>
<span class="fc" id="L523">						m_employee.addTimeOff(tmpTimeOff);</span>
					
				}
			}
<span class="fc" id="L527">			i++;</span>
<span class="fc" id="L528">		}//for</span>
<span class="pc bpc" id="L529" title="1 of 2 branches missed.">		if (m_isMultiEdit) {</span>
<span class="nc" id="L530">			m_employee.setMultiEditTimeOffs(m_colTimeOffs);</span>
		}
<span class="fc" id="L532">		return true;</span>
	}//extractParameters

	/**
	 * Check if a list of EmployeeTimeOff objects contains the specified EmployeeTimeOff object.
	 * We do not check ID's, only the accrual values.
	 */
	private boolean empTimeOffsContains(ArrayList empTimeOffs, EmployeeTimeOff to)
	{
<span class="fc bfc" id="L541" title="All 2 branches covered.">		if (empTimeOffs == null)</span>
<span class="fc" id="L542">			return false;</span>
		
<span class="fc bfc" id="L544" title="All 2 branches covered.">		for (Iterator it=empTimeOffs.iterator(); it.hasNext();)</span>
		{	
<span class="fc" id="L546">			EmployeeTimeOff eto = (EmployeeTimeOff)it.next();</span>
			
<span class="pc bpc" id="L548" title="3 of 4 branches missed.">			if (eto==null &amp;&amp; to==null)</span>
<span class="nc" id="L549">				return true;</span>
			
<span class="pc bpc" id="L551" title="2 of 4 branches missed.">			if (eto==null || to==null)</span>
<span class="nc" id="L552">				continue;</span>

<span class="pc bpc" id="L554" title="1 of 2 branches missed.">			if ( areBothNullOrEqual(eto.getEmployeeID(), to.getEmployeeID()) &amp;&amp;</span>
<span class="fc bfc" id="L555" title="All 2 branches covered.">				 areBothNullOrEqual(eto.getActivityID(), to.getActivityID()) &amp;&amp;</span>
<span class="pc bpc" id="L556" title="1 of 2 branches missed.">				 areBothNullOrEqual(eto.getActivityName(), to.getActivityName()) &amp;&amp;</span>
<span class="pc bpc" id="L557" title="1 of 2 branches missed.">				 areBothNullOrEqual(eto.getAccrualRateByYearInObject(0), to.getAccrualRateByYearInObject(0)) &amp;&amp;</span>
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">				 areBothNullOrEqual(eto.getAccrualRateByYearInObject(1), to.getAccrualRateByYearInObject(1)) &amp;&amp;</span>
<span class="pc bpc" id="L559" title="1 of 2 branches missed.">				 areBothNullOrEqual(eto.getAccrualRateByYearInObject(2), to.getAccrualRateByYearInObject(2)) &amp;&amp;</span>
<span class="pc bpc" id="L560" title="1 of 2 branches missed.">				 areBothNullOrEqual(eto.getAccrualRateByYearInObject(3), to.getAccrualRateByYearInObject(3)) &amp;&amp;</span>
<span class="pc bpc" id="L561" title="1 of 2 branches missed.">				 areBothNullOrEqual(eto.getAccrualRateByYearInObject(4), to.getAccrualRateByYearInObject(4)) &amp;&amp;</span>
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">				 areBothNullOrEqual(eto.getActivityCategoryID(), to.getActivityCategoryID()) )</span>
<span class="fc" id="L563">				return true;</span>
<span class="fc" id="L564">		}</span>
<span class="fc" id="L565">		return false;</span>
	}
	
	/**
	 * Return true if both objects are null or if both are equal.
	 * @param val1
	 * @param val2
	 * @return
	 */
	private boolean areBothNullOrEqual(Object val1, Object val2)
	{
<span class="pc bpc" id="L576" title="1 of 4 branches missed.">		if (val1==null &amp;&amp; val2==null)</span>
<span class="fc" id="L577">			return true;</span>
		
<span class="pc bpc" id="L579" title="2 of 4 branches missed.">		if (val1==null || val2==null)</span>
<span class="nc" id="L580">			return false;</span>

<span class="fc bfc" id="L582" title="All 2 branches covered.">		if (val1.equals(val2))</span>
<span class="fc" id="L583">			return true;</span>
		
<span class="fc" id="L585">		return false;</span>
	}
	
	/**
	 * Initialize Component For Display
	 */
	public void initForDisplay() {
<span class="fc bfc" id="L592" title="All 2 branches covered.">		if (m_isInitializedForDisplay) </span>
<span class="fc" id="L593">		    return;</span>
		else {
<span class="fc" id="L595">			super.initForDisplay();</span>
<span class="fc" id="L596">			initContent();</span>
		}
<span class="fc" id="L598">	}</span>

	private void initContent() {
		// Initialize headers
<span class="fc" id="L602">		initHeader();</span>

		//  set form fields
<span class="fc" id="L605">		Collection colTimeOffs = getEmployeeTimeOffs();</span>
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">		if (colTimeOffs == null) colTimeOffs = new ArrayList();</span>
		//create hashmap of EmployeetimeOff objects
<span class="fc" id="L608">		createMap(colTimeOffs);</span>

		//build Tree
<span class="fc" id="L611">		RowData rootData = new RowData(new ActivityCategory());//This empty root won't be shown</span>
		// QC 69951 Activity Types no longer alphabetized: replace DefaultTreeNodeHelper with DefaultSortableTreeNodeHelper
<span class="fc" id="L613">		SortableTreeNodeHelper treeNodeHelper = new DefaultSortableTreeNodeHelper(m_rowData.values(), rootData,</span>
				new RowDataConvertor());
<span class="fc" id="L615">		TreeModel treeModel = TreeModelBuilder.buildTreeModel(treeNodeHelper,</span>
<span class="fc" id="L616">								new int[]{0}, m_headerPC.isAscending(), m_localizer);		</span>
<span class="fc" id="L617">		setTreeModel(treeModel);</span>

		//For all Popup Args stored in m_popupArgsMap (during build tree process), add them.
<span class="fc" id="L620">		realizeHistoryPopupArgs();</span>
<span class="fc" id="L621">	}</span>

	private void storeHistoryPopupArgs(String sCmd, String sParam) {
<span class="fc" id="L624">		m_historyPopupArgsMap.put(sCmd, sParam);</span>
<span class="fc" id="L625">	}</span>

	private void realizeHistoryPopupArgs() {
<span class="fc bfc" id="L628" title="All 2 branches covered.">		for (Iterator it = m_historyPopupArgsMap.entrySet().iterator(); it.hasNext();) {</span>
<span class="fc" id="L629">			Map.Entry entry = (Map.Entry) it.next();</span>
<span class="fc" id="L630">			String sCmd   = (String) entry.getKey();</span>
<span class="fc" id="L631">			String sParam = (String) entry.getValue();</span>
<span class="fc" id="L632">			addPopupArgs(sCmd, &quot;to_accrued_history_pu&quot;, sParam, WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN,</span>
					&quot;720,480,ctr,ctr&quot;, true, 1);
<span class="fc" id="L634">		}</span>
<span class="fc" id="L635">	}</span>

	private HtmlImage buildHistoryPopupButton(String sCmd) {
<span class="fc" id="L638">		String onClick = &quot;pageMediator.popupWindow('&quot; + sCmd + &quot;', pageMediator);&quot;;</span>
<span class="fc" id="L639">		HtmlImage btnImage = new HtmlImage(ImageFileID.EDIT);</span>
<span class="fc" id="L640">		btnImage.setAttribute(&quot;class&quot;, CSSUtil.CLASS_HAND_CURSOR);</span>
<span class="fc" id="L641">		btnImage.setAlign(&quot;absmiddle&quot;);</span>
<span class="fc" id="L642">		btnImage.setAlt(m_localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_ACCRUED_HISTORY));</span>
<span class="fc" id="L643">		btnImage.setOnClick(onClick);</span>
<span class="fc" id="L644">		return btnImage;</span>
	}

	private DefaultMultiColumnNodeData toNodeData(RowData rowData, boolean editable) {
<span class="fc" id="L648">		ArrayList cols = new ArrayList();</span>

		//id and name of activity type and number of items
<span class="fc" id="L651">		String activityName = rowData.name;</span>
<span class="fc" id="L652">		String[] yearVal = new String[NUM_OF_YEARS];</span>
<span class="fc" id="L653">		String perDayVal = &quot;&quot;;</span>
<span class="fc" id="L654">		String perWeekVal = &quot;&quot;;</span>
<span class="fc" id="L655">		String timeOffID = null;</span>
		//get value from hashmap
<span class="fc bfc" id="L657" title="All 2 branches covered.">		if (m_timeOffMap.containsKey(rowData.unionID)) {</span>
			//set values from the map
<span class="fc" id="L659">			EmployeeTimeOff timeOff = (EmployeeTimeOff) m_timeOffMap.get(rowData.unionID);</span>
<span class="fc bfc" id="L660" title="All 2 branches covered.">			for (int index = 0; index &lt; NUM_OF_YEARS; index++) {</span>
<span class="pc bpc" id="L661" title="1 of 2 branches missed.">				if (timeOff.getAccrualRateByYearInObject(index) != null) {</span>
					//if (m_hasAccrualLicense) {
<span class="fc bfc" id="L663" title="All 2 branches covered.">						if (timeOff.getAccrualRateByYear(index) != 0.0)</span>
<span class="fc" id="L664">							yearVal[index] = formatDecimal(2, timeOff.getAccrualRateByYear(index));</span>
					//}else{
					//	if (timeOff.getHoursByYear(index) != 0.0)
					//		yearVal[index] = formatDecimal(2, timeOff.getHoursByYear(index));
					//}
<span class="nc bnc" id="L669" title="All 2 branches missed.">				} else if (timeOff.getEmployeeID() == null) {</span>
<span class="nc" id="L670">					yearVal[index] = &quot;*&quot;;</span>
				}
			}
<span class="pc bpc" id="L673" title="1 of 2 branches missed.">			if (!timeOff.isFieldMultiValue(EmployeeTimeOffFieldInfo.EMPTIMEOFF_HOURSPERDAY)) {</span>
<span class="fc bfc" id="L674" title="All 2 branches covered.">				if (timeOff.getHoursPerDay() != 0.0)</span>
<span class="fc" id="L675">					perDayVal = formatDecimal(2, timeOff.getHoursPerDay());</span>
			} else {
<span class="nc" id="L677">				perDayVal = &quot;*&quot;;</span>
			}
<span class="pc bpc" id="L679" title="1 of 2 branches missed.">			if (!timeOff.isFieldMultiValue(EmployeeTimeOffFieldInfo.EMPTIMEOFF_HOURSPERWEEK)) {</span>
<span class="fc bfc" id="L680" title="All 2 branches covered.">				if (timeOff.getHoursPerWeek() != 0.0)</span>
<span class="fc" id="L681">					perWeekVal = formatDecimal(2, timeOff.getHoursPerWeek());</span>
			} else {
<span class="nc" id="L683">				perWeekVal = &quot;*&quot;;</span>
			}
<span class="fc bfc" id="L685" title="All 2 branches covered.">			if (!m_isMultiEdit) {</span>
<span class="fc" id="L686">				timeOffID = timeOff.getIDInString(); // timeOff.getID()!=null?timeOff.getID().toString():&quot;&quot;;</span>
			} else {
<span class="fc" id="L688">				timeOffID = timeOff.getMultiEditIDsInString();</span>
			}
		}

<span class="fc" id="L692">		int i = rowData.rowIndex;</span>
<span class="fc" id="L693">		StringBuffer aBuf = new StringBuffer(512);</span>
<span class="fc" id="L694">		aBuf.append(activityName);</span>
<span class="fc" id="L695">		aBuf.append(HtmlUtil.makeHiddenInput(UNION_ID_FN, i, rowData.unionID.toString()));</span>
<span class="fc" id="L696">		aBuf.append(HtmlUtil.makeHiddenInput(TIMEOFFID_FN, i, timeOffID));</span>
<span class="fc" id="L697">		cols.add(aBuf.toString());//Time Off Type</span>

		//default per day
<span class="fc" id="L700">		String dayFN = PERDAY_FN + &quot;R&quot; + i;</span>
<span class="fc bfc" id="L701" title="All 2 branches covered.">		if (rowData.act != null) {</span>
<span class="pc bpc" id="L702" title="1 of 2 branches missed.">			if (editable) {</span>
<span class="fc" id="L703">				cols.add(HtmlUtil.makeTextInput(dayFN, 5, 8, perDayVal, null, null, true, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.DefaultPerDay)));</span>
			} else {
<span class="nc" id="L705">				cols.add(HtmlUtil.makeTextInput(dayFN, 5, 0, perDayVal, null, null, false, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.DefaultPerDay)));</span>
			}
		} else {
<span class="fc" id="L708">			cols.add(&quot;&quot;);</span>
		}

		//default per week
<span class="fc" id="L712">		String weekFN = PERWEEK_FN + &quot;R&quot; + i;</span>
<span class="fc bfc" id="L713" title="All 2 branches covered.">		if (rowData.act != null) {</span>
<span class="pc bpc" id="L714" title="1 of 2 branches missed.">			if (editable) {</span>
<span class="fc" id="L715">				cols.add(HtmlUtil.makeTextInput(weekFN, 5, 8, perWeekVal, null, null, true, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.DefaultPerWeek)));</span>
			} else {
<span class="nc" id="L717">				cols.add(HtmlUtil.makeTextInput(weekFN, 5, 0, perWeekVal, null, null, false, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.DefaultPerWeek)));</span>
			}
		} else {
<span class="fc" id="L720">			cols.add(&quot;&quot;);</span>
		}

		//Only show accrual fields if has Accrual License
<span class="pc bpc" id="L724" title="1 of 2 branches missed.">		if (m_hasAccrualLicense) {</span>

			//Accrual Schedule
<span class="pc bpc" id="L727" title="1 of 4 branches missed.">			if (rowData.isFirstLayer &amp;&amp; rowData.isTOAllotment)</span>
<span class="fc" id="L728">				cols.add(ActivityModelHandler.getAccrualScheduleStr(m_localizer, rowData.accrualSchedule));</span>
			else
<span class="fc" id="L730">				cols.add(&quot;&quot;);</span>

			//Last updated
<span class="pc bpc" id="L733" title="1 of 2 branches missed.">			if (rowData.isFirstLayer) {</span>
<span class="fc" id="L734">				String lastBalance = null;</span>
<span class="fc" id="L735">				String lastDate = null;</span>
<span class="fc bfc" id="L736" title="All 2 branches covered.">				if (rowData.toAccrueds.size() &lt; m_empIDs.size()) {//some of emps have empty values</span>
<span class="fc" id="L737">					lastBalance = &quot;&quot;;</span>
<span class="fc" id="L738">					lastDate = &quot;&quot;;</span>
				}
<span class="fc bfc" id="L740" title="All 2 branches covered.">				for (Iterator it = rowData.toAccrueds.iterator(); it.hasNext();) {</span>
<span class="fc" id="L741">					EmployeeTimeOffAccrued toAccrued = (EmployeeTimeOffAccrued) it.next();</span>

<span class="fc" id="L743">					String balance = &quot;&quot;;</span>
<span class="pc bpc" id="L744" title="1 of 2 branches missed.">					if (!toAccrued.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)) {</span>
<span class="fc" id="L745">						balance = formatDecimal(2, toAccrued.getAccruedHours());</span>
					}
<span class="fc" id="L747">					String date = m_localizer.formatDate(toAccrued.getAccruedAtDate(),</span>
<span class="fc" id="L748">							m_context.getViewingTimeZone(), RegionalFormatBundleKey.DATE_FORMAT);</span>

<span class="pc bpc" id="L750" title="1 of 2 branches missed.">					if (lastBalance == null) {</span>
<span class="fc" id="L751">						lastBalance = balance;</span>
					} else {
<span class="nc bnc" id="L753" title="All 2 branches missed.">						if (!lastBalance.equals(balance))</span>
<span class="nc" id="L754">							lastBalance = &quot;*&quot;;//multi value</span>
					}
<span class="pc bpc" id="L756" title="1 of 2 branches missed.">					if (lastDate == null) {</span>
<span class="fc" id="L757">						lastDate = date;</span>
					} else {
<span class="nc bnc" id="L759" title="All 2 branches missed.">						if (!lastDate.equals(date))</span>
<span class="nc" id="L760">							lastDate = &quot;*&quot;;//multi value</span>
					}
<span class="fc" id="L762">				}</span>
<span class="pc bpc" id="L763" title="1 of 4 branches missed.">				if (editable &amp;&amp; rowData.isTOAllotment) {</span>
					//TO Accrued History Popup Button
<span class="fc" id="L765">					String sCmd = &quot;TO_ACCRUED_HISTORY_&quot; + i;</span>
<span class="fc" id="L766">					String sParam = &quot;&quot;;</span>
<span class="fc" id="L767">					ID[] solvedIDs = solveUnionID(rowData.unionID);</span>
<span class="pc bpc" id="L768" title="1 of 2 branches missed.">					if (solvedIDs[0] != null)</span>
<span class="fc" id="L769">						sParam = &quot;actID=&quot; + solvedIDs[0].toString();</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">					else if (solvedIDs[1] != null)</span>
<span class="nc" id="L771">						sParam = &quot;actCatID=&quot; + solvedIDs[1].toString();</span>
<span class="fc" id="L772">					storeHistoryPopupArgs(sCmd, sParam);</span>
<span class="fc" id="L773">					String popupBtn = buildHistoryPopupButton(sCmd).toString();</span>

<span class="fc" id="L775">					cols.add(HtmlUtil.makeTextInput(LAST_BALANCE_FN + i, 5, 8, lastBalance, null, null, true, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.LastUpdatedBalance)));</span>
<span class="fc" id="L776">					cols.add(HtmlUtil.makeTextInput(LAST_DATE_FN + i, 10, 12, lastDate, null, null, true, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.LastUpdatedDate)) + popupBtn);</span>
<span class="fc" id="L777">				} else {</span>
<span class="pc bpc" id="L778" title="1 of 2 branches missed.">					if(rowData.isTOAllotment){</span>
<span class="nc" id="L779">						cols.add(HtmlUtil.makeTextInput(LAST_BALANCE_FN + i, 5, 0, lastBalance, null, null, false, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.LastUpdatedBalance)));</span>
<span class="nc" id="L780">						cols.add(HtmlUtil.makeTextInput(LAST_DATE_FN + i, 10, 0, lastDate, null, null, false, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.LastUpdatedDate)));</span>
					}else {
<span class="fc" id="L782">						cols.add(&quot;&quot;);</span>
<span class="fc" id="L783">						cols.add(&quot;&quot;);</span>
					}
				}
<span class="fc" id="L786">			} else {</span>
<span class="nc" id="L787">				cols.add(&quot;&quot;);</span>
<span class="nc" id="L788">				cols.add(&quot;&quot;);</span>
			}

			//Max Balance &amp; Carryover
<span class="pc bpc" id="L792" title="1 of 2 branches missed.">			if (rowData.isFirstLayer) {</span>
<span class="fc" id="L793">				String maxBalance = null;</span>
<span class="fc" id="L794">				String maxCarryover = null;</span>
<span class="pc bpc" id="L795" title="1 of 2 branches missed.">				if (rowData.toBalances.size() &lt; m_empIDs.size()) {//some of emps have empty values</span>
<span class="fc" id="L796">					maxBalance = &quot;&quot;;</span>
<span class="fc" id="L797">					maxCarryover = &quot;&quot;;</span>
				}
<span class="pc bpc" id="L799" title="1 of 2 branches missed.">				for (Iterator it = rowData.toBalances.iterator(); it.hasNext();) {</span>
<span class="nc" id="L800">					ActivityTimeOffBalance toBalance = (ActivityTimeOffBalance) it.next();</span>

<span class="nc" id="L802">					String balance = &quot;&quot;;</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">					if (!toBalance.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">							&amp;&amp; toBalance.getMaxBalance() != ActivityTimeOffBalance.MAX_BALANCE_NA) {</span>
<span class="nc" id="L805">						balance = formatDecimal(2, toBalance.getMaxBalance());</span>
					}
<span class="nc" id="L807">					String carryover = &quot;&quot;;</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">					if (!toBalance.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER)</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">							&amp;&amp; toBalance.getMaxCarryOver() != ActivityTimeOffBalance.MAX_BALANCE_NA) {</span>
<span class="nc" id="L810">						carryover = formatDecimal(2, toBalance.getMaxCarryOver());</span>
					}

<span class="nc bnc" id="L813" title="All 2 branches missed.">					if (maxBalance == null) {</span>
<span class="nc" id="L814">						maxBalance = balance;</span>
					} else {
<span class="nc bnc" id="L816" title="All 2 branches missed.">						if (!maxBalance.equals(balance))</span>
<span class="nc" id="L817">							maxBalance = &quot;*&quot;;//multi value</span>
					}
<span class="nc bnc" id="L819" title="All 2 branches missed.">					if (maxCarryover == null) {</span>
<span class="nc" id="L820">						maxCarryover = carryover;</span>
					} else {
<span class="nc bnc" id="L822" title="All 2 branches missed.">						if (!maxCarryover.equals(carryover))</span>
<span class="nc" id="L823">							maxCarryover = &quot;*&quot;;//multi value</span>
					}
<span class="nc" id="L825">				}</span>
<span class="pc bpc" id="L826" title="1 of 4 branches missed.">				if (editable &amp;&amp; rowData.isTOAllotment) {</span>
<span class="fc" id="L827">					cols.add(HtmlUtil.makeTextInput(MAX_BALANCE_FN + i, 5, 8, maxBalance, null, null, true, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.MaxBalance)));</span>
<span class="fc" id="L828">					cols.add(HtmlUtil.makeTextInput(MAX_CARRYOVER_FN + i, 5, 8, maxCarryover, null, null, true, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.MaxCarryover)));</span>
				} else {
<span class="pc bpc" id="L830" title="1 of 2 branches missed.">					if (rowData.isTOAllotment) {</span>
<span class="nc" id="L831">						cols.add(HtmlUtil.makeTextInput(MAX_BALANCE_FN + i, 5, 0, maxBalance, null, null, false, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.MaxBalance)));</span>
<span class="nc" id="L832">						cols.add(HtmlUtil.makeTextInput(MAX_CARRYOVER_FN + i, 5, 0, maxCarryover, null, null, false, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.MaxCarryover)));</span>
					} else {
<span class="fc" id="L834">						cols.add(&quot;&quot;);</span>
<span class="fc" id="L835">						cols.add(&quot;&quot;);</span>
					}
				}
<span class="fc" id="L838">			} else {</span>
<span class="nc" id="L839">				cols.add(&quot;&quot;);</span>
<span class="nc" id="L840">				cols.add(&quot;&quot;);</span>
			}

		}

		//allotment: this year
<span class="pc bpc" id="L846" title="1 of 2 branches missed.">		if (rowData.isFirstLayer) {</span>
<span class="pc bpc" id="L847" title="1 of 4 branches missed.">			if (editable &amp;&amp; rowData.isTOAllotment) {</span>
<span class="fc bfc" id="L848" title="All 2 branches covered.">				for (int index = 0; index &lt; NUM_OF_YEARS; index++)</span>
<span class="fc" id="L849">					cols.add(HtmlUtil.makeTextInput(HOURSYEAR_FN + index + &quot;_&quot; + i, 4, 8, yearVal[index], null, null, true, false, activityName + &quot;, &quot; + (Calendar.getInstance().get(Calendar.YEAR)+index-1)));</span>
			} else {
<span class="fc bfc" id="L851" title="All 2 branches covered.">				for (int index = 0; index &lt; NUM_OF_YEARS; index++) {</span>
<span class="pc bpc" id="L852" title="1 of 2 branches missed.">					if (rowData.isTOAllotment) {</span>
<span class="nc" id="L853">						cols.add(HtmlUtil.makeTextInput(HOURSYEAR_FN + index + &quot;_&quot; + i, 4, 0, yearVal[index], null, null, false, false, activityName + &quot;, &quot; + (Calendar.getInstance().get(Calendar.YEAR)+index-1)));</span>
					} else {
<span class="fc" id="L855">						cols.add(&quot;&quot;);</span>
					}
				}
			}
		} else {
<span class="nc bnc" id="L860" title="All 2 branches missed.">			for (int index = 0; index &lt; NUM_OF_YEARS; index++)</span>
<span class="nc" id="L861">				cols.add(&quot;&quot;);</span>
		}

<span class="fc" id="L864">		DefaultMultiColumnNodeData timeOffData = new DefaultMultiColumnNodeData(&quot;timeOffProfile&quot;, cols);</span>
<span class="fc" id="L865">		timeOffData.setSelectable(false);</span>
<span class="fc" id="L866">		return timeOffData;</span>
	}

	//////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	//////////////////////////////////////////////////////////////////////////////
	private void initHeader() {
<span class="fc" id="L873">		int thisYear = m_employee.getTimeOffYear();</span>
<span class="pc bpc" id="L874" title="1 of 2 branches missed.">		if (thisYear == -1) {</span>
<span class="nc" id="L875">			Calendar rightNow = Calendar.getInstance();</span>
<span class="nc" id="L876">			thisYear = rightNow.get(Calendar.YEAR);</span>
		}

<span class="fc" id="L879">		DefaultHeaderData hdrTOType  = new DefaultHeaderData(&quot;cTOType&quot;, i18n(m_bundle, BbmWebBundleKey.TimeOffType), null, m_headerCssClass, false);</span>
<span class="fc" id="L880">		DefaultHeaderData hdrPerday  = new DefaultHeaderData(&quot;cPerDay&quot;, i18n(m_bundle, BbmWebBundleKey.DefaultPerDay), null, m_headerCssClass, false);</span>
<span class="fc" id="L881">		DefaultHeaderData hdrPerweek = new DefaultHeaderData(&quot;cPerWeek&quot;, i18n(m_bundle, BbmWebBundleKey.DefaultPerWeek), null, m_headerCssClass, false);</span>
<span class="fc" id="L882">		DefaultHeaderData hdrSchedule     = new DefaultHeaderData(&quot;cSchedule&quot;, i18n(m_bundle, BbmWebBundleKey.AccrualSchedule), &quot;65&quot;, m_headerCssClass, false);</span>
<span class="fc" id="L883">		DefaultHeaderData hdrLastBalance  = new DefaultHeaderData(&quot;cLastBalance&quot;, i18n(m_bundle, BbmWebBundleKey.LastUpdatedBalance), &quot;55&quot;, m_headerCssClass, false);</span>
<span class="fc" id="L884">		DefaultHeaderData hdrLastDate     = new DefaultHeaderData(&quot;cLastDate&quot;, i18n(m_bundle, BbmWebBundleKey.LastUpdatedDate), &quot;98&quot;, m_headerCssClass, false);</span>
<span class="fc" id="L885">		DefaultHeaderData hdrMaxBalance   = new DefaultHeaderData(&quot;cMaxBalance&quot;, i18n(m_bundle, BbmWebBundleKey.MaxBalance), &quot;55&quot;, m_headerCssClass, false);</span>
<span class="fc" id="L886">		DefaultHeaderData hdrMaxCarryover = new DefaultHeaderData(&quot;cMaxCarryover&quot;, i18n(m_bundle, BbmWebBundleKey.MaxCarryover), &quot;55&quot;, m_headerCssClass, false);</span>
<span class="fc" id="L887">		DefaultHeaderData hdrYearSpan     = new DefaultHeaderData(&quot;cYearSpan&quot;, &quot;&lt;center&gt;&quot;+i18n(m_bundle, BbmWebBundleKey.AccrualRate)+&quot;&lt;/center&gt;&quot;, null, m_headerCssClass, false);</span>
<span class="fc" id="L888">		List hdrListYears = new ArrayList();</span>
<span class="fc bfc" id="L889" title="All 2 branches covered.">		for (int i = 1; i &lt;= NUM_OF_YEARS; i++) {</span>
<span class="fc" id="L890">			hdrListYears.add(new DefaultHeaderData(&quot;c&quot; + i, &quot;&quot; + (thisYear + i - 2), null, m_headerCssClass, false));</span>
		}

<span class="fc" id="L893">		TableHeaderPC headerPC = getHeader();</span>
		ArrayList hdrList;
		//Only show accrual fields if has Accrual License
<span class="pc bpc" id="L896" title="1 of 2 branches missed.">		if (!m_hasAccrualLicense) {</span>
			//One layer of headers:
			//TOType, PerDay, PerWeek, 2008, 2009, 2010, 2011
<span class="nc" id="L899">			hdrList = new ArrayList();</span>
<span class="nc" id="L900">			hdrList.add(hdrTOType);</span>
<span class="nc" id="L901">			hdrList.add(hdrPerday);</span>
<span class="nc" id="L902">			hdrList.add(hdrPerweek);</span>
<span class="nc" id="L903">			hdrList.addAll(hdrListYears);</span>
<span class="nc" id="L904">			headerPC.setHeaders(hdrList);</span>
		} else {
			//Two layer of headers:
			//TOType, PerDay, PerWeek, Schedule, LastBalance, LastDate, MaxBalance, MaxCarryover, |&lt;---- YearSpan ----&gt;|
			//                                                                                    2008, 2009, 2010, 2011
<span class="fc" id="L909">			hdrTOType.setRowSpan(2);</span>
<span class="fc" id="L910">			hdrPerday.setRowSpan(2);</span>
<span class="fc" id="L911">			hdrPerweek.setRowSpan(2);</span>
<span class="fc" id="L912">			hdrSchedule.setRowSpan(2);</span>
<span class="fc" id="L913">			hdrLastBalance.setRowSpan(2);</span>
<span class="fc" id="L914">			hdrLastDate.setRowSpan(2);</span>
<span class="fc" id="L915">			hdrMaxBalance.setRowSpan(2);</span>
<span class="fc" id="L916">			hdrMaxCarryover.setRowSpan(2);</span>
<span class="fc" id="L917">			hdrYearSpan.setColSpan(NUM_OF_YEARS);</span>

<span class="fc" id="L919">			hdrPerday.setColumnWidth(&quot;55&quot;);</span>
<span class="fc" id="L920">			hdrPerweek.setColumnWidth(&quot;55&quot;);</span>
<span class="fc bfc" id="L921" title="All 2 branches covered.">			for (Iterator it = hdrListYears.iterator(); it.hasNext();) {</span>
<span class="fc" id="L922">				DefaultHeaderData hdrYear = (DefaultHeaderData) it.next();</span>
<span class="fc" id="L923">				hdrYear.setColumnWidth(&quot;50&quot;);</span>
<span class="fc" id="L924">			}</span>

			//2nd layer
<span class="fc" id="L927">			headerPC.setHeaders(hdrListYears);</span>
			//1st layer
<span class="fc" id="L929">			hdrList = new ArrayList();</span>
<span class="fc" id="L930">			hdrList.add(hdrTOType);</span>
<span class="fc" id="L931">			hdrList.add(hdrPerday);</span>
<span class="fc" id="L932">			hdrList.add(hdrPerweek);</span>
<span class="fc" id="L933">			hdrList.add(hdrSchedule);</span>
<span class="fc" id="L934">			hdrList.add(hdrLastBalance);</span>
<span class="fc" id="L935">			hdrList.add(hdrLastDate);</span>
<span class="fc" id="L936">			hdrList.add(hdrMaxBalance);</span>
<span class="fc" id="L937">			hdrList.add(hdrMaxCarryover);</span>
<span class="fc" id="L938">			hdrList.add(hdrYearSpan);</span>
<span class="fc" id="L939">			headerPC.incActiveHeaderLevel();</span>
<span class="fc" id="L940">			headerPC.setHeaders(hdrList);</span>
			//Toggle button doesn't show properly with 2 layer header
<span class="fc" id="L942">			this.setToggleable(false);</span>
		}
<span class="fc" id="L944">	}</span>


	private void createMap(Collection empTimeOffCol) {
<span class="fc" id="L948">		m_timeOffMap = new HashMap();</span>
<span class="pc bpc" id="L949" title="1 of 4 branches missed.">		if (empTimeOffCol != null &amp;&amp; empTimeOffCol.size() &gt; 0) {</span>
<span class="fc bfc" id="L950" title="All 2 branches covered.">			for (Iterator j = empTimeOffCol.iterator(); j.hasNext();) {</span>
<span class="fc" id="L951">				EmployeeTimeOff empTimeOff = (EmployeeTimeOff) j.next();</span>
<span class="fc" id="L952">				ID unionID = getUnionID(empTimeOff.getActivityID(), empTimeOff.getActivityCategoryID());</span>
<span class="fc" id="L953">				m_timeOffMap.put(unionID, empTimeOff);</span>
<span class="fc" id="L954">			}</span>
		}
<span class="fc" id="L956">	}</span>

	private String formatDecimal(int prec, double num) {
		try {
<span class="fc" id="L960">			BigDecimal n = new BigDecimal(num);</span>
<span class="fc" id="L961">			String strFormat = (n.setScale(prec, BigDecimal.ROUND_HALF_UP)).toString();</span>
<span class="fc" id="L962">			strFormat = FormInputPC.localizeRealNumber(strFormat, m_localizer);</span>
<span class="fc" id="L963">			return strFormat;</span>
<span class="nc" id="L964">		} catch (ArithmeticException e) {</span>
<span class="nc" id="L965">			return null;</span>
		}
	}

	public void initStickyCollapsedState(String cacheMode, boolean defaultState) {
<span class="nc" id="L970">	}</span>

	public void setIsToggleable(boolean value) {
<span class="nc" id="L973">	}</span>

	private class RowData {
		final Activity act;
		final ActivityCategory actCate;
		final ID unionID;//ActivityID or ActivityCategoryID
		final ID parentID;//ActivityCategoryID
		final String name;
		final int accrualSchedule;// monthly, yearly, etc.
		final boolean isTOAllotment;
<span class="fc" id="L983">		int rowIndex = -1;</span>
<span class="fc" id="L984">		boolean isFirstLayer = true;// of the tree</span>
<span class="fc" id="L985">		Collection toAccrueds = new ArrayList();</span>
<span class="fc" id="L986">		Collection toBalances = new ArrayList();</span>
		//EmployeeTimeOff

<span class="fc" id="L989">		public RowData(Activity activity) {</span>
<span class="fc" id="L990">			this.act     = activity;</span>
<span class="fc" id="L991">			this.actCate = null;</span>
<span class="fc" id="L992">			this.unionID  = getUnionID(activity.getID(), activity.getActivityCategoryId());</span>
<span class="fc" id="L993">			this.parentID = getUnionID(null, activity.getActivityCategoryId());</span>
<span class="fc" id="L994">			this.name            = activity.getName();</span>
<span class="fc" id="L995">			this.accrualSchedule = activity.getTOAccrualSchedule();</span>
<span class="fc" id="L996">			this.isTOAllotment   = activity.isTimeoffWithAllotment();</span>
<span class="fc" id="L997">		}</span>

<span class="fc" id="L999">		public RowData(ActivityCategory actCategory) {</span>
<span class="fc" id="L1000">			this.act     = null;</span>
<span class="fc" id="L1001">			this.actCate = actCategory;</span>
<span class="fc" id="L1002">			this.unionID  = getUnionID(null, actCategory.getID());</span>
<span class="fc" id="L1003">			this.parentID = getUnionID(null, actCategory.getID());</span>
<span class="fc" id="L1004">			this.name            = actCategory.getName();</span>
<span class="fc" id="L1005">			this.accrualSchedule = actCategory.getTOAccrualSchedule();</span>
<span class="fc" id="L1006">			this.isTOAllotment   = actCategory.isTOAllotment();</span>
<span class="fc" id="L1007">		}</span>
	}

	private ID getUnionID(ID activityID, ID actCategoryID) {
<span class="fc" id="L1011">		ID unionID = activityID;</span>
<span class="fc bfc" id="L1012" title="All 2 branches covered.">		if (unionID == null)</span>
<span class="fc" id="L1013">			unionID = new ID(ACT_CAT_PREFIX + actCategoryID);</span>
<span class="fc" id="L1014">		return unionID;</span>
	}

	private ID[] solveUnionID(ID unionID) {
<span class="fc" id="L1018">		ID[] result = new ID[2];</span>
<span class="fc" id="L1019">		String unionStr = unionID.toString();</span>
<span class="pc bpc" id="L1020" title="1 of 2 branches missed.">		if (unionStr.startsWith(ACT_CAT_PREFIX))</span>
<span class="nc" id="L1021">			result[1] = new ID(unionStr.substring(ACT_CAT_PREFIX.length()));</span>
		else
<span class="fc" id="L1023">			result[0] = new ID(unionStr);</span>
<span class="fc" id="L1024">		return result;</span>
	}

<span class="fc" id="L1027">	private class RowDataConvertor implements TreeNodeConverter {</span>
		public ID getNodeID(Object data) {
<span class="fc" id="L1029">			RowData rowData = (RowData) data;</span>
<span class="fc" id="L1030">			return rowData.unionID;</span>
		}

		public ID getParentNodeID(Object data) {
<span class="fc" id="L1034">			RowData rowData = (RowData) data;</span>
<span class="fc" id="L1035">			return rowData.parentID;</span>
		}

		public DefaultMutableTreeNode toTreeNode(Object data) {
<span class="fc" id="L1039">			RowData rowData = (RowData) data;</span>
<span class="fc" id="L1040">			return new DefaultMutableTreeNode(toNodeData(rowData, m_isEditable));</span>
		}
	}

	class DataUpdater {
<span class="fc" id="L1045">		private final Map/*&lt;unionID, EmployeeTimeOffAccrued&gt;*/ toAccruedInputs = new HashMap();</span>
<span class="fc" id="L1046">		private final Map/*&lt;unionID, ActivityTimeOffBalance&gt;*/ toBalanceInputs = new HashMap();</span>
		private final DatePickerPC datePicker;

<span class="fc" id="L1049">		public DataUpdater(RequestContext context) {</span>
<span class="fc" id="L1050">			datePicker = new DatePickerPC(context, &quot;dpInputFN&quot;);</span>
<span class="fc" id="L1051">		}</span>

		void clear() {
<span class="fc" id="L1054">			toAccruedInputs.clear();</span>
<span class="fc" id="L1055">			toBalanceInputs.clear();</span>
<span class="fc" id="L1056">		}</span>

		/**
		 * @param unionID	must be provided
		 * Empty value for accruedHours or accruedAtDate means to delete it.
		 * Multi value for accruedHours or accruedAtDate means to ignore it.
		 */
		void putTOAccrued(ID unionID, String accruedHours, String accruedAtDate) {
<span class="fc" id="L1064">			EmployeeTimeOffAccrued toAccrued = new EmployeeTimeOffAccrued();</span>
<span class="fc bfc" id="L1065" title="All 2 branches covered.">			if (!StringUtil.isEmpty(accruedHours)) {</span>
<span class="pc bpc" id="L1066" title="1 of 2 branches missed.">				if (accruedHours.equals(&quot;*&quot;))</span>
<span class="nc" id="L1067">					toAccrued.setFieldMultiValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS);</span>
				else
<span class="fc" id="L1069">					toAccrued.setAccruedHours(FormInputPC.convertLocalizedRealNumber(accruedHours, m_localizer));</span>
			} else {
<span class="fc" id="L1071">				toAccrued.setFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS);</span>
			}
<span class="fc bfc" id="L1073" title="All 2 branches covered.">			if (!StringUtil.isEmpty(accruedAtDate)) {</span>
<span class="pc bpc" id="L1074" title="1 of 2 branches missed.">				if (accruedAtDate.equals(&quot;*&quot;))</span>
<span class="nc" id="L1075">					toAccrued.setFieldMultiValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT);</span>
				else
<span class="fc" id="L1077">					toAccrued.setAccruedAtDate(datePicker.convertStrToDate(accruedAtDate));</span>
			} else {
<span class="fc" id="L1079">				toAccrued.setFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT);</span>
			}

<span class="pc bpc" id="L1082" title="1 of 2 branches missed.">			if (toAccrued.isFieldMultiValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">					&amp;&amp; toAccrued.isFieldMultiValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT))</span>
<span class="nc" id="L1084">				return;//both value ignored</span>

<span class="fc bfc" id="L1086" title="All 2 branches covered.">			if ( (toAccrued.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)</span>
<span class="pc bpc" id="L1087" title="1 of 2 branches missed.">					&amp;&amp; !toAccrued.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT))</span>
<span class="fc bfc" id="L1088" title="All 2 branches covered.">					|| (!toAccrued.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)</span>
<span class="pc bpc" id="L1089" title="1 of 2 branches missed.">							&amp;&amp; toAccrued.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT)) ) {</span>
				//Incomplete input
<span class="nc" id="L1091">				TimeOffPC.this.addPageMessage(Message.ERROR_TYPE,</span>
						BbmWebBundleKey.INCOMPLETE_LAST_UPDATE_MSG, BbmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1093">				return;</span>
			}

<span class="fc" id="L1096">			toAccruedInputs.put(unionID, toAccrued);</span>
<span class="fc" id="L1097">		}</span>

		/**
		 * @param unionID	must be provided
		 * Empty value for maxBalance or maxCarryover means to delete it.
		 * Multi value for maxBalance or maxCarryover means to ignore it.
		 */
		void putTOBalance(ID unionID, String maxBalance, String maxCarryover) {
<span class="fc" id="L1105">			ActivityTimeOffBalance toBalance = new ActivityTimeOffBalance();</span>
<span class="pc bpc" id="L1106" title="1 of 2 branches missed.">			if (!StringUtil.isEmpty(maxBalance)) {</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">				if (maxBalance.equals(&quot;*&quot;))</span>
<span class="nc" id="L1108">					toBalance.setFieldMultiValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE);</span>
				else
<span class="nc" id="L1110">					toBalance.setMaxBalance(FormInputPC.convertLocalizedRealNumber(maxBalance, m_localizer));</span>
			} else {
<span class="fc" id="L1112">				toBalance.setFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE);</span>
			}
<span class="pc bpc" id="L1114" title="1 of 2 branches missed.">			if (!StringUtil.isEmpty(maxCarryover)) {</span>
<span class="nc bnc" id="L1115" title="All 2 branches missed.">				if (maxCarryover.equals(&quot;*&quot;))</span>
<span class="nc" id="L1116">					toBalance.setFieldMultiValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER);</span>
				else
<span class="nc" id="L1118">					toBalance.setMaxCarryOver(FormInputPC.convertLocalizedRealNumber(maxCarryover, m_localizer));</span>
			} else {
<span class="fc" id="L1120">				toBalance.setFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER);</span>
			}

<span class="pc bpc" id="L1123" title="1 of 2 branches missed.">			if (toBalance.isFieldMultiValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">					&amp;&amp; toBalance.isFieldMultiValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER))</span>
<span class="nc" id="L1125">				return;//both value ignored</span>

<span class="fc" id="L1127">			toBalanceInputs.put(unionID, toBalance);</span>
<span class="fc" id="L1128">		}</span>

		void updateTOAccrued() throws Exception {
<span class="fc" id="L1131">			Collection/*&lt;ID&gt;*/ actIDs = new ArrayList();</span>
<span class="fc" id="L1132">			Collection/*&lt;ID&gt;*/ actCatIDs = new ArrayList();</span>
<span class="fc bfc" id="L1133" title="All 2 branches covered.">			for (Iterator it = toAccruedInputs.keySet().iterator(); it.hasNext();) {</span>
<span class="fc" id="L1134">				ID unionID = (ID) it.next();</span>
<span class="fc" id="L1135">				ID[] solvedIDs = solveUnionID(unionID);</span>
<span class="pc bpc" id="L1136" title="1 of 2 branches missed.">				if (solvedIDs[0] != null)</span>
<span class="fc" id="L1137">					actIDs.add(solvedIDs[0]);</span>
<span class="pc bpc" id="L1138" title="1 of 2 branches missed.">				if (solvedIDs[1] != null)</span>
<span class="nc" id="L1139">					actCatIDs.add(solvedIDs[1]);</span>
<span class="fc" id="L1140">			}</span>
<span class="fc" id="L1141">			Collection toAccruedsOld = Collections.EMPTY_LIST;</span>
<span class="pc bpc" id="L1142" title="3 of 4 branches missed.">			if (actIDs.size() &gt; 0 || actCatIDs.size() &gt; 0) {</span>
<span class="fc" id="L1143">				toAccruedsOld = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode())</span>
<span class="fc" id="L1144">						.getLastUpdatedTOAccrued(m_empIDs, actIDs, actCatIDs);</span>
			}

<span class="fc" id="L1147">			Map/*&lt;dbID, EmployeeTimeOffAccrued&gt;*/ toAccruedsOldMap = new HashMap();</span>
<span class="fc bfc" id="L1148" title="All 2 branches covered.">			for (Iterator it = toAccruedsOld.iterator(); it.hasNext();) {</span>
<span class="fc" id="L1149">				EmployeeTimeOffAccrued toAccruedOld = (EmployeeTimeOffAccrued) it.next();</span>
<span class="fc" id="L1150">				String dbID = getDbID(toAccruedOld.getEmployeeID(),</span>
<span class="fc" id="L1151">						getUnionID(toAccruedOld.getActivityID(), toAccruedOld.getActivityCategoryId()));</span>
<span class="fc" id="L1152">				toAccruedsOldMap.put(dbID, toAccruedOld);</span>
<span class="fc" id="L1153">			}</span>

<span class="fc" id="L1155">			Collection toAccruedsNew = new ArrayList();</span>
<span class="fc" id="L1156">			Collection toAccruedIDsDelete = new ArrayList();</span>
<span class="fc" id="L1157">			boolean isUpdatingEarlierDate = false;</span>
<span class="fc bfc" id="L1158" title="All 2 branches covered.">			for (Iterator it = toAccruedInputs.entrySet().iterator(); it.hasNext();) {</span>
<span class="fc" id="L1159">				Map.Entry entry = (Map.Entry) it.next();</span>
<span class="fc" id="L1160">				ID unionID = (ID) entry.getKey();</span>
<span class="fc" id="L1161">				EmployeeTimeOffAccrued toAccruedInput = (EmployeeTimeOffAccrued) entry.getValue();</span>
<span class="fc bfc" id="L1162" title="All 2 branches covered.">				for (Iterator i = m_empIDs.iterator(); i.hasNext();) {</span>
<span class="fc" id="L1163">					ID empID = (ID) i.next();</span>
<span class="fc" id="L1164">					String dbID = getDbID(empID, unionID);</span>
<span class="fc" id="L1165">					EmployeeTimeOffAccrued toAccruedOld = (EmployeeTimeOffAccrued) toAccruedsOldMap.get(dbID);</span>

					//To Delete
<span class="fc bfc" id="L1168" title="All 2 branches covered.">					if (toAccruedInput.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)</span>
<span class="pc bpc" id="L1169" title="1 of 2 branches missed.">							&amp;&amp; toAccruedInput.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT)) {</span>
<span class="pc bpc" id="L1170" title="1 of 2 branches missed.">						if (toAccruedOld != null)</span>
<span class="nc" id="L1171">							toAccruedIDsDelete.add(toAccruedOld.getID());</span>
						continue;
					}
					//To Create or Update
<span class="fc" id="L1175">					boolean modified = false;</span>
<span class="fc bfc" id="L1176" title="All 2 branches covered.">					if (toAccruedOld == null) {//If Old does not exist, create a New one</span>
<span class="fc" id="L1177">						toAccruedOld = new EmployeeTimeOffAccrued();</span>
<span class="fc" id="L1178">						toAccruedOld.setEmployeeID(empID);</span>
<span class="fc" id="L1179">						ID[] solvedIDs = solveUnionID(unionID);</span>
<span class="pc bpc" id="L1180" title="1 of 2 branches missed.">						if (solvedIDs[0] != null)</span>
<span class="fc" id="L1181">							toAccruedOld.setActivityID(solvedIDs[0]);</span>
<span class="pc bpc" id="L1182" title="1 of 2 branches missed.">						if (solvedIDs[1] != null)</span>
<span class="nc" id="L1183">							toAccruedOld.setActivityCategoryId(solvedIDs[1]);</span>
<span class="fc" id="L1184">						modified = true;</span>
					}
					//Update toAccrued according to Input
<span class="pc bpc" id="L1187" title="1 of 2 branches missed.">					if (!toAccruedInput.isFieldMultiValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)) {</span>
<span class="pc bpc" id="L1188" title="1 of 2 branches missed.">						if (toAccruedInput.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)) {</span>
<span class="nc bnc" id="L1189" title="All 2 branches missed.">							if (!toAccruedOld.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)) {</span>
<span class="nc" id="L1190">								toAccruedOld.setFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS);</span>
<span class="nc" id="L1191">								modified = true;</span>
							}
						} else {
<span class="pc bpc" id="L1194" title="1 of 2 branches missed.">							if (toAccruedInput.getAccruedHours() != toAccruedOld.getAccruedHours()</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">									|| toAccruedOld.getFieldValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)</span>
											== null/*NullObject or null as new created didn't set*/) {
<span class="fc" id="L1197">								toAccruedOld.setAccruedHours(toAccruedInput.getAccruedHours());</span>
<span class="fc" id="L1198">								modified = true;</span>
							}
						}
					}
<span class="pc bpc" id="L1202" title="1 of 2 branches missed.">					if (!toAccruedInput.isFieldMultiValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT)) {</span>
<span class="pc bpc" id="L1203" title="1 of 2 branches missed.">						if (toAccruedInput.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT)) {</span>
<span class="nc bnc" id="L1204" title="All 2 branches missed.">							if (!toAccruedOld.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT)) {</span>
<span class="nc" id="L1205">								toAccruedOld.setFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT);</span>
<span class="nc" id="L1206">								modified = true;</span>
							}
						} else {
<span class="fc bfc" id="L1209" title="All 2 branches covered.">							if (!toAccruedInput.getAccruedAtDate().equals(toAccruedOld.getAccruedAtDate())) {</span>
<span class="fc bfc" id="L1210" title="All 2 branches covered.">								if (toAccruedOld.getAccruedAtDate() != null</span>
<span class="pc bpc" id="L1211" title="1 of 2 branches missed.">										&amp;&amp; toAccruedInput.getAccruedAtDate().before(toAccruedOld.getAccruedAtDate()))</span>
<span class="fc" id="L1212">									isUpdatingEarlierDate = true;</span>
<span class="fc" id="L1213">								toAccruedOld.setAccruedAtDate(toAccruedInput.getAccruedAtDate());</span>
<span class="fc" id="L1214">								modified = true;</span>
							}
						}
					}
<span class="pc bpc" id="L1218" title="1 of 2 branches missed.">					if (modified) {</span>
<span class="pc bpc" id="L1219" title="1 of 2 branches missed.">						if ( toAccruedOld.getFieldValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS) == null</span>
<span class="pc bpc" id="L1220" title="1 of 2 branches missed.">								|| toAccruedOld.getAccruedAtDate() == null ) {</span>
							//Incomplete input, (When one input is *, and the current record is new created)
<span class="nc" id="L1222">							TimeOffPC.this.addPageMessage(Message.ERROR_TYPE,</span>
									BbmWebBundleKey.INCOMPLETE_LAST_UPDATE_MSG, BbmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1224">							throw new BbmException(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.INCOMPLETE_LAST_UPDATE_MSG);</span>
						}

<span class="fc" id="L1227">						toAccruedsNew.add(toAccruedOld);</span>
					}
<span class="fc" id="L1229">				}</span>
<span class="fc" id="L1230">			}</span>

			//Update or Insert, new created toAccrued doesn't have an value object ID
<span class="fc bfc" id="L1233" title="All 2 branches covered.">			if (toAccruedsNew.size() &gt; 0) {</span>
<span class="fc" id="L1234">				BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode())</span>
<span class="fc" id="L1235">						.updateOrInsertTOAccrued(toAccruedsNew);</span>
<span class="fc bfc" id="L1236" title="All 2 branches covered.">				if (isUpdatingEarlierDate)</span>
<span class="fc" id="L1237">					TimeOffPC.this.addPageMessage(Message.INFO_TYPE,//TODO: l10n</span>
							&quot;You have updated the balance for a date which is earlier than the most recent update date.&quot;);
			}
			//Delete
<span class="pc bpc" id="L1241" title="1 of 2 branches missed.">			if (toAccruedIDsDelete.size() &gt; 0) {</span>
<span class="nc" id="L1242">				BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode())</span>
<span class="nc" id="L1243">						.deleteTOAccrued(toAccruedIDsDelete);</span>
			}
<span class="fc" id="L1245">		}</span>

		void updateTOBalance() throws Exception {
<span class="fc" id="L1248">			Collection/*&lt;ID&gt;*/ actIDs = new ArrayList();</span>
<span class="fc" id="L1249">			Collection/*&lt;ID&gt;*/ actCatIDs = new ArrayList();</span>
<span class="fc bfc" id="L1250" title="All 2 branches covered.">			for (Iterator it = toBalanceInputs.keySet().iterator(); it.hasNext();) {</span>
<span class="fc" id="L1251">				ID unionID = (ID) it.next();</span>
<span class="fc" id="L1252">				ID[] solvedIDs = solveUnionID(unionID);</span>
<span class="pc bpc" id="L1253" title="1 of 2 branches missed.">				if (solvedIDs[0] != null)</span>
<span class="fc" id="L1254">					actIDs.add(solvedIDs[0]);</span>
<span class="pc bpc" id="L1255" title="1 of 2 branches missed.">				if (solvedIDs[1] != null)</span>
<span class="nc" id="L1256">					actCatIDs.add(solvedIDs[1]);</span>
<span class="fc" id="L1257">			}</span>
<span class="fc" id="L1258">			Collection toBalancesOld = Collections.EMPTY_LIST;</span>
<span class="pc bpc" id="L1259" title="3 of 4 branches missed.">			if (actIDs.size() &gt; 0 || actCatIDs.size() &gt; 0) {</span>
<span class="fc" id="L1260">				toBalancesOld = WfmManagerFactory.getActivityManager(m_context.isInWhatIfMode())</span>
<span class="fc" id="L1261">						.getTOBalanceForActivities(m_empIDs, actIDs, actCatIDs);</span>
			}

<span class="fc" id="L1264">			Map/*&lt;dbID, ActivityTimeOffBalance&gt;*/ toBalancesOldMap = new HashMap();</span>
<span class="pc bpc" id="L1265" title="1 of 2 branches missed.">			for (Iterator it = toBalancesOld.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1266">				ActivityTimeOffBalance toBalanceOld = (ActivityTimeOffBalance) it.next();</span>
<span class="nc" id="L1267">				String dbID = getDbID(toBalanceOld.getWorkResourceID(),</span>
<span class="nc" id="L1268">						getUnionID(toBalanceOld.getActivityID(), toBalanceOld.getActivityCategoryId()));</span>
<span class="nc" id="L1269">				toBalancesOldMap.put(dbID, toBalanceOld);</span>
<span class="nc" id="L1270">			}</span>

<span class="fc" id="L1272">			Collection toBalancesNew = new ArrayList();</span>
<span class="fc" id="L1273">			Collection toBalanceIDsDelete = new ArrayList();</span>
<span class="fc bfc" id="L1274" title="All 2 branches covered.">			for (Iterator it = toBalanceInputs.entrySet().iterator(); it.hasNext();) {</span>
<span class="fc" id="L1275">				Map.Entry entry = (Map.Entry) it.next();</span>
<span class="fc" id="L1276">				ID unionID = (ID) entry.getKey();</span>
<span class="fc" id="L1277">				ActivityTimeOffBalance toBalanceInput = (ActivityTimeOffBalance) entry.getValue();</span>
<span class="fc bfc" id="L1278" title="All 2 branches covered.">				for (Iterator i = m_empIDs.iterator(); i.hasNext();) {</span>
<span class="fc" id="L1279">					ID empID = (ID) i.next();</span>
<span class="fc" id="L1280">					String dbID = getDbID(empID, unionID);</span>
<span class="fc" id="L1281">					ActivityTimeOffBalance toBalanceOld = (ActivityTimeOffBalance) toBalancesOldMap.get(dbID);</span>

					//To Delete
<span class="pc bpc" id="L1284" title="1 of 2 branches missed.">					if (toBalanceInput.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)</span>
<span class="pc bpc" id="L1285" title="1 of 2 branches missed.">							&amp;&amp; toBalanceInput.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER)) {</span>
<span class="pc bpc" id="L1286" title="1 of 2 branches missed.">						if (toBalanceOld != null)</span>
<span class="nc" id="L1287">							toBalanceIDsDelete.add(toBalanceOld.getID());</span>
						continue;
					}
					//To Create or Update
<span class="nc" id="L1291">					boolean modified = false;</span>
<span class="nc bnc" id="L1292" title="All 2 branches missed.">					if (toBalanceOld == null) {//If Old does not exist, create a New one</span>
<span class="nc" id="L1293">						toBalanceOld = new ActivityTimeOffBalance();</span>
<span class="nc" id="L1294">						toBalanceOld.setWorkResourceID(empID);</span>
<span class="nc" id="L1295">						ID[] solvedIDs = solveUnionID(unionID);</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">						if (solvedIDs[0] != null)</span>
<span class="nc" id="L1297">							toBalanceOld.setActivityID(solvedIDs[0]);</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed.">						if (solvedIDs[1] != null)</span>
<span class="nc" id="L1299">							toBalanceOld.setActivityCategoryId(solvedIDs[1]);</span>
<span class="nc" id="L1300">						modified = true;</span>
					}
					//Update toBalance according to Input
<span class="nc bnc" id="L1303" title="All 2 branches missed.">					if (!toBalanceInput.isFieldMultiValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)) {</span>
<span class="nc bnc" id="L1304" title="All 2 branches missed.">						if (toBalanceInput.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)) {</span>
<span class="nc bnc" id="L1305" title="All 2 branches missed.">							if (!toBalanceOld.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)</span>
<span class="nc bnc" id="L1306" title="All 2 branches missed.">									&amp;&amp; toBalanceOld.getMaxBalance() != ActivityTimeOffBalance.MAX_BALANCE_NA) {</span>
<span class="nc" id="L1307">								toBalanceOld.setFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE);</span>
<span class="nc" id="L1308">								modified = true;</span>
							}
						} else {
<span class="nc bnc" id="L1311" title="All 2 branches missed.">							if (toBalanceInput.getMaxBalance() != toBalanceOld.getMaxBalance()</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">									|| toBalanceOld.getFieldValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)</span>
											== null/*NullObject or null as new created didn't set*/) {
<span class="nc" id="L1314">								toBalanceOld.setMaxBalance(toBalanceInput.getMaxBalance());</span>
<span class="nc" id="L1315">								modified = true;</span>
							}
						}
					}
<span class="nc bnc" id="L1319" title="All 2 branches missed.">					if (!toBalanceInput.isFieldMultiValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER)) {</span>
<span class="nc bnc" id="L1320" title="All 2 branches missed.">						if (toBalanceInput.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER)) {</span>
<span class="nc bnc" id="L1321" title="All 2 branches missed.">							if (!toBalanceOld.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER)</span>
<span class="nc bnc" id="L1322" title="All 2 branches missed.">									&amp;&amp; toBalanceOld.getMaxCarryOver() != ActivityTimeOffBalance.MAX_BALANCE_NA) {</span>
<span class="nc" id="L1323">								toBalanceOld.setFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER);</span>
<span class="nc" id="L1324">								modified = true;</span>
							}
						} else {
<span class="nc bnc" id="L1327" title="All 2 branches missed.">							if (toBalanceInput.getMaxCarryOver() != toBalanceOld.getMaxCarryOver()</span>
<span class="nc bnc" id="L1328" title="All 2 branches missed.">									|| toBalanceOld.getFieldValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER)</span>
											== null/*NullObject or null as new created didn't set*/) {
<span class="nc" id="L1330">								toBalanceOld.setMaxCarryOver(toBalanceInput.getMaxCarryOver());</span>
<span class="nc" id="L1331">								modified = true;</span>
							}
						}
					}
<span class="nc bnc" id="L1335" title="All 2 branches missed.">					if (modified) {</span>
<span class="nc" id="L1336">						toBalancesNew.add(toBalanceOld);</span>
					}
<span class="nc" id="L1338">				}</span>
<span class="fc" id="L1339">			}</span>

			//Update or Insert, new created toBalance doesn't have an value object ID
<span class="pc bpc" id="L1342" title="1 of 2 branches missed.">			if (toBalancesNew.size() &gt; 0) {</span>
<span class="nc" id="L1343">				WfmManagerFactory.getActivityManager(m_context.isInWhatIfMode())</span>
<span class="nc" id="L1344">						.updateOrInsertActivityTOBalance(toBalancesNew);</span>
			}
			//Delete
<span class="pc bpc" id="L1347" title="1 of 2 branches missed.">			if (toBalanceIDsDelete.size() &gt; 0) {</span>
<span class="nc" id="L1348">				WfmManagerFactory.getActivityManager(m_context.isInWhatIfMode())</span>
<span class="nc" id="L1349">						.deleteActivityTOBalance(toBalanceIDsDelete);</span>
			}
<span class="fc" id="L1351">		}</span>

		private String getDbID(ID empID, ID unionID) {
<span class="fc" id="L1354">			return empID.toString() + &quot;+&quot; + unionID.toString();</span>
		}
	}

	public void updateData() throws Exception {
<span class="fc" id="L1359">		m_dataUpdater.updateTOAccrued();</span>
<span class="fc" id="L1360">		m_dataUpdater.updateTOBalance();</span>
<span class="fc" id="L1361">	}</span>
}//class
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>