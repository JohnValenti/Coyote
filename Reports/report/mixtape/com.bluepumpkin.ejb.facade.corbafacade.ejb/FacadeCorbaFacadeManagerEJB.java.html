<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FacadeCorbaFacadeManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.facade.corbafacade.ejb</a> &gt; <span class="el_source">FacadeCorbaFacadeManagerEJB.java</span></div><h1>FacadeCorbaFacadeManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.facade.corbafacade.ejb;

import java.rmi.Naming;
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Queue;

import javax.naming.Context;
import javax.naming.InitialContext;

import com.bluepumpkin.bpxCommon.common.rmi.IRemoteInterface;
import com.bluepumpkin.bpxCommon.common.rmi.IRemoteScheduleImport;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.employeefilter.ejb.EmployeeFilter;
import com.bluepumpkin.ejb.bbm.employeefilter.model.Filter;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bpx.fxregistration.ejb.FXRegistrationManager;
import com.bluepumpkin.ejb.bpx.fxregistration.model.FXServer;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.bluepumpkin.ejb.facade.Log;
import com.bluepumpkin.ejb.facade.corbafacade.model.CFUserRemote;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.UserManager;
import com.witness.ejb.core.security.model.User;
import com.witness.ejb.core.security.util.UserConverter;

/**
 * @author AYu
 *
 * TODO To change the template for this generated type comment go to
 * Window - Preferences - Java - Code Style - Code Templates
 */
<span class="fc" id="L49">public class FacadeCorbaFacadeManagerEJB extends SessionEJBBase {</span>
	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;

<span class="fc" id="L55">	private static Category m_cat = Log.initCategory(FacadeCorbaFacadeManagerEJB.class.getName());</span>
	
	private EmployeeFilter m_employeeFilterEJB;
	private UserManager m_userManager;
	private CampaignManager m_campaignManager;

	
	/*
	 * Constants for error conditions encountered when importing staffing
	 * profiles. This will be interpreted by DE and signalled accordingly 
	 */
	public static final int OUTSOURCER_IMPORT_SUCCESSFUL = 0;

	/*
	 * The import operation failed because of adapter errors and could be 
	 * due to the following reasons: 
	 * 1. Empty or non-existent file to import
	 * 2. File did not contain staffing profiles for the date/time specified
	 */
	public static final int OUTSOURCER_ADAPTER_PROCESSING_ERROR = 1;

	/*
	 * The import operation failed because of adapter errors and could be 
	 * due to the following reasons:
	 * 1. Remote connection to the adapter was broken.
	 * 2. The Integration server or adapter was shutdown.  
	 */
	public static final int OUTSOURCER_ADAPTER_ERROR = 2;

	/*
	 * The import operation failed because of integration server errors 
	 * and could be due to the following reasons: 
	 * 1. Integration server not configured
	 * 2. Integration server not running
	 * 3. Import adapter not configured on the integration server.
	 */
	public static final int OUTSOURCER_INTEGRATION_SERVER_ERROR = 3;

	/*
	 * The import operation failed because of adapter errors and could be 
	 * due to the following reasons: 
	 * 1. Import adapter not configured for the correct organization and
	 * campaign.
	 */
	public static final int OUTSOURCER_ADAPTER_CONFIGURATION_ERROR = 4;
	
	/*
	 * The import operation was unsuccessful due to application server errors
	 */
	public static final int OUTSOURCER_APPLICATION_SERVER_ERROR = 5;

	
	/* a flag that indicates whether or not this instance is running in what
	 if mode */
<span class="fc" id="L109">	private boolean m_isWhatIf = false;</span>

	{
<span class="fc" id="L112">		super.init(FacadeCorbaFacadeManagerEJB.class.getName());</span>
<span class="fc" id="L113">	}</span>

	/**
	 * Perform one-time initialization of this EJB instance
	 */
	public void onEjbCreate() {
		try {
			// First query environment to get WIF setting from DD
<span class="fc" id="L121">			Context initialContext = new InitialContext();</span>
<span class="fc" id="L122">			Boolean WIF = (Boolean) initialContext.lookup(&quot;java:comp/env/WIF&quot;);</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">			if (WIF != null)</span>
<span class="fc" id="L124">				m_isWhatIf = WIF.booleanValue();</span>
<span class="fc" id="L125">			m_employeeFilterEJB = BbmManagerFactory.getEmployeeFilter(m_isWhatIf);</span>
<span class="fc" id="L126">			m_userManager = CoreManagerFactory.getUserManager(m_isWhatIf);</span>
<span class="fc" id="L127">			m_campaignManager = WfmManagerFactory.getCampaignManager(m_isWhatIf);</span>
<span class="nc" id="L128">		} catch (Exception e) {</span>
<span class="nc" id="L129">			handleException(&quot;onEjbCreate&quot;, e, false);</span>
<span class="fc" id="L130">		}</span>
<span class="fc" id="L131">	}</span>
	
	protected Category getCategory() {
<span class="fc" id="L134">		return m_cat;</span>
	}
	
	public Collection&lt;ID&gt; getEmployeeIDsForOrgs(Collection&lt;ID&gt; orgIDs, Date start, Date end) 
		throws RemoteException {
<span class="nc" id="L139">		methodStart(&quot;getEmployeeIDsForOrgs&quot;, orgIDs, start, end);</span>
		try {
<span class="nc" id="L141">			User currentUser = getCurrentUser();</span>
<span class="nc" id="L142">			Filter filter = buildEmployeeFilterForOrgs(currentUser, orgIDs, start, end);</span>
<span class="nc" id="L143">			Collection&lt;ID&gt; employeeIDs = getEmployeeIDs(currentUser,filter, null);</span>
<span class="nc" id="L144">			return employeeIDs;</span>
<span class="nc" id="L145">		} catch (Exception ex) {</span>
<span class="nc" id="L146">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L147">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="nc" id="L149">			methodFinish();</span>
		}
	}	
	
	public Collection&lt;ID&gt; getEmployeeIDsAssignedToSP(ID spID)
		throws RemoteException{
<span class="fc" id="L155">		methodStart(&quot;getEmployeeIDsAssignedToSP&quot;, spID);</span>
		try {
			
<span class="fc" id="L158">			SchedulingPeriod schedulingPeriod = m_campaignManager.getSchedulingPeriodByID(spID);</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">			if (schedulingPeriod.isUsingAllEmployees()){</span>
<span class="fc" id="L160">				Collection&lt;ID&gt; organizationIDs = m_campaignManager.getLinkedOrgsforSP(spID);</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">				if (organizationIDs == null){</span>
<span class="nc" id="L162">					organizationIDs = new ArrayList&lt;ID&gt;();</span>
				}
<span class="fc" id="L164">				User currentUser = getCurrentUser();</span>
<span class="fc" id="L165">				Filter filter = buildEmployeeFilterForOrgs(currentUser, organizationIDs, </span>
<span class="fc" id="L166">						schedulingPeriod.getStartTime(), schedulingPeriod.getEndTime());</span>
<span class="fc" id="L167">				Collection&lt;ID&gt; employeeIDs = getEmployeeIDs(currentUser,filter, spID);</span>
<span class="fc" id="L168">				return employeeIDs; </span>
			} else {
<span class="fc" id="L170">				User currentUser = getCurrentUser();</span>
<span class="fc" id="L171">				Filter filter = Filter.createAllFilter(currentUser.getID());</span>
<span class="fc" id="L172">				Collection&lt;ID&gt; employeeIDs = getEmployeeIDsAssignedDirectlyToSP(currentUser, spID, filter);</span>
<span class="fc" id="L173">				return employeeIDs;</span>
			}
<span class="nc" id="L175">		} catch (Exception ex) {</span>
			//how to handle?
<span class="nc" id="L177">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L178">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="pc" id="L180">			methodFinish();</span>
		}
	}
	
	public Collection&lt;ID&gt; getFilteredEmployeeIDsAssignedToSP(ID spID, ID filterID) throws RemoteException {
<span class="fc" id="L185">		methodStart(&quot;getFilteredEmployeeIDsAssignedToSP&quot;, spID, filterID);</span>
		try {
<span class="fc" id="L187">			User currentUser = getCurrentUser();</span>
<span class="fc" id="L188">			return getFilteredEmployeeIDsAssignedToSPWithUser(spID, filterID, currentUser);</span>
<span class="nc" id="L189">		} catch (Exception ex) {</span>
<span class="nc" id="L190">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L191">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="pc" id="L193">			methodFinish();</span>
		}
	}
	
	private Collection&lt;ID&gt; getFilteredEmployeeIDsAssignedToSPWithUser(ID spID,
			ID filterID, User currentUser) throws BbmFinderException,
			BbmObjectNotFoundException, RemoteException {
<span class="fc" id="L200">		SchedulingPeriod schedulingPeriod = m_campaignManager.getSchedulingPeriodByID(spID);</span>
<span class="fc" id="L201">		Collection&lt;ID&gt; employeeIDs = m_campaignManager.getWorkResourceIDsBySchedulingPeriod(schedulingPeriod);</span>
<span class="fc" id="L202">		Filter filter = m_employeeFilterEJB.getFilterByID(filterID);</span>
<span class="fc" id="L203">		employeeIDs.retainAll(m_employeeFilterEJB.getEmployeeIDs(filter, currentUser,</span>
<span class="fc" id="L204">				Collections.emptyList(), true, 0, Integer.MAX_VALUE));</span>
<span class="fc" id="L205">		return employeeIDs;</span>
	}

	private Collection&lt;ID&gt; getEmployeeIDs(User currentUser, Filter filter, ID spID) 
		throws RemoteException {
<span class="fc" id="L210">		methodStart(&quot;getEmployeeIDs&quot;, filter);</span>
		try {
<span class="fc" id="L212">			Collection&lt;ID&gt; employeeIDs = new  ArrayList&lt;ID&gt;(m_employeeFilterEJB.getEmployeeIDs(filter, currentUser,  new ArrayList(), true, 0, Integer.MAX_VALUE, false, spID));</span>
<span class="fc" id="L213">			return employeeIDs;</span>
<span class="nc" id="L214">		} catch (Exception ex) {</span>
			//how to handle?
<span class="nc" id="L216">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L217">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="pc" id="L219">			methodFinish();</span>
		}
	}
	
	private Collection&lt;ID&gt; getEmployeeIDsAssignedDirectlyToSP(User currentUser, ID spID, Filter filter)
		throws RemoteException{
<span class="fc" id="L225">		methodStart(&quot;getEmployeeIDsAssignedDirectlyToSP&quot;, spID, filter);</span>
		try {
<span class="fc" id="L227">				SchedulingPeriod schedulingPeriod = m_campaignManager.getSchedulingPeriodByID(spID);</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">				if (filter.getStartTime() == null){</span>
<span class="fc" id="L229">					filter.setStartTime(schedulingPeriod.getStartTime());</span>
				}
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">				if (filter.getEndTime() == null){</span>
<span class="fc" id="L232">					filter.setEndTime(schedulingPeriod.getEndTime());</span>
				}
<span class="fc" id="L234">				List&lt;ID&gt; employeeIDs = new ArrayList&lt;ID&gt;(m_employeeFilterEJB.getEmployeeIDs(filter, currentUser, new ArrayList(), true, 0, Integer.MAX_VALUE, false, spID));</span>
<span class="fc" id="L235">				return employeeIDs;</span>
<span class="nc" id="L236">		} catch (Exception ex) {</span>
<span class="nc" id="L237">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L238">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="pc" id="L240">			methodFinish();</span>
		}
	}

	private Filter buildEmployeeFilterForOrgs(User currentUser, Collection orgIDs, Date start, Date end) throws Exception {
<span class="fc" id="L245">		ArrayList alParameters = new ArrayList();</span>
<span class="fc" id="L246">		alParameters.add(new ArrayList(orgIDs)); // the parameter must be a list of lists in the sacred interest of confusion, not telling and type un-safety.</span>
<span class="fc" id="L247">		Filter filter = new Filter(Filter.ORGANIZATIONID,Filter.OPERATOR_IN,alParameters);</span>
<span class="fc" id="L248">		filter.setUserID(currentUser.getID());</span>
<span class="fc" id="L249">		filter.setTimePeriodType(Filter.TIMEPERIODTYPE_TIMEWINDOW);</span>
<span class="fc" id="L250">		filter.setStartTime(start);</span>
<span class="fc" id="L251">		filter.setEndTime(end);</span>
<span class="fc" id="L252">		return filter;</span>
	}
	
	public Collection&lt;ID&gt; getPhantomsIDsAssignedToSP(ID spID) 
		throws RemoteException{
<span class="fc" id="L257">		methodStart(&quot;getPhantomsIDsAssignedToSP&quot;, spID);</span>
		try {
<span class="fc" id="L259">			User currentUser = getCurrentUser();</span>
<span class="fc" id="L260">			Filter filter = Filter.createAllFilter(currentUser.getID());</span>
<span class="fc" id="L261">			return new ArrayList&lt;ID&gt;(m_employeeFilterEJB.getEmployeeIDs(filter, currentUser, new ArrayList(), true, 0, Integer.MAX_VALUE, true, spID));</span>
<span class="nc" id="L262">		} catch (Exception ex) {</span>
			//how to handle?
<span class="nc" id="L264">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L265">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="pc" id="L267">			methodFinish();</span>
		}
	}
	
	public CFUserRemote getUserByName(String userName) throws RemoteException {
<span class="fc" id="L272">		methodStart(&quot;getUserByName&quot;, userName);</span>
		try {
<span class="fc" id="L274">			return CFUserRemote.convert(UserConverter.convertUser(m_userManager</span>
<span class="fc" id="L275">					.getUserByName(userName), new short[] { 1 }));</span>
<span class="nc" id="L276">		} catch (Exception ex) {</span>
<span class="nc" id="L277">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L278">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="pc" id="L280">			methodFinish();</span>
		}
	}
	
	
	private User getCurrentUser() throws Exception {
<span class="fc" id="L286">		String userName = this.m_sessionContext.getCallerPrincipal().getName();</span>
		
<span class="fc" id="L288">		User currentUser = m_userManager.getUserByName(userName);</span>
		
<span class="fc bfc" id="L290" title="All 2 branches covered.">		if (currentUser == null){</span>
<span class="fc" id="L291">			m_cat.debug(&quot;Can't get current user name &quot; + userName + &quot;, use supperuser as default user&quot;);</span>
<span class="fc" id="L292">			currentUser = m_userManager.getUserByID(User.SUPER_USERID);</span>
		}
		
<span class="fc" id="L295">		return currentUser;</span>
	}

	private IRemoteScheduleImport[] getOutsourcerImportStubs() throws Exception{
<span class="nc" id="L299">		 return getRemoteImportStubs(IRemoteScheduleImport.class, IRemoteScheduleImport.RMT_ID );</span>
	}

	private IRemoteInterface[] getGenericStubs() throws Exception{
<span class="fc" id="L303">		 return getRemoteImportStubs(IRemoteInterface.class, IRemoteInterface.RMT_ID );</span>
	}

	
	private &lt;T&gt; T[] getRemoteImportStubs(Class&lt;T&gt; cls, String typeID ) throws Exception
	{
<span class="fc" id="L309">		methodStart(&quot;getRemoteImportStubs&quot;);</span>
		
		try
		{
<span class="fc" id="L313">			FXRegistrationManager fxMgr = BbmManagerFactory.getFXRegistrationManager();</span>
	
<span class="fc" id="L315">			Collection coll = fxMgr.getAllServers();</span>
<span class="pc bpc" id="L316" title="2 of 4 branches missed.">			if( coll == null || coll.size() &lt;= 0 )</span>
			{
<span class="nc bnc" id="L318" title="All 2 branches missed.">				if( m_cat.isDebugEnabled() )</span>
<span class="nc" id="L319">					m_cat.debug(&quot; No integration servers registered &quot;);</span>
<span class="nc" id="L320">				return null;</span>
			}
		
<span class="fc" id="L323">			ArrayList&lt;T&gt; objList = new ArrayList&lt;T&gt;();</span>
			
<span class="fc" id="L325">			Iterator iter = coll.iterator();</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">			while( iter.hasNext() )</span>
			{
<span class="fc" id="L328">				int count = 0;</span>
<span class="fc" id="L329">				FXServer srvr = (FXServer)iter.next();</span>
<span class="fc" id="L330">				String url =  &quot;//&quot; + srvr.getRmiHost() + &quot;:&quot; + srvr.getRmiPort();</span>
<span class="pc bpc" id="L331" title="1 of 2 branches missed.">				if( m_cat.isDebugEnabled() )</span>
<span class="fc" id="L332">					m_cat.debug(&quot; Looking up integration server url=&quot; + url );</span>
			
				try
				{
<span class="fc" id="L336">					String []list = Naming.list(url);</span>
<span class="fc" id="L337">					url = url + &quot;/&quot;;</span>
<span class="pc bpc" id="L338" title="1 of 4 branches missed.">					for( int i=0; list != null  &amp;&amp; i &lt; list.length; ++i )</span>
					{
<span class="fc" id="L340">						String objUrl = list[i].substring( url.length() );</span>
						
<span class="pc bpc" id="L342" title="1 of 4 branches missed.">						if( objUrl != null &amp;&amp; objUrl.startsWith(typeID) )</span>
						{
<span class="pc bpc" id="L344" title="1 of 2 branches missed.">							if( m_cat.isDebugEnabled() )</span>
<span class="fc" id="L345">								m_cat.debug(&quot; Looking up adapter=&quot; + list[i] );	</span>
<span class="fc" id="L346">							T obj = (T)Naming.lookup(list[i]);</span>
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">							if( obj != null )</span>
							{
<span class="fc" id="L349">								objList.add(obj);</span>
<span class="fc" id="L350">								++count;</span>
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">								if( m_cat.isDebugEnabled() )</span>
<span class="fc" id="L352">									m_cat.debug(&quot; Found Import Adapter running on url=&quot; + list[i] ); </span>
							}
						}
					}
				}
<span class="nc" id="L357">				catch( Exception ex )</span>
				{
<span class="nc" id="L359">					m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L360">					continue;</span>
<span class="fc" id="L361">				}</span>

<span class="pc bpc" id="L363" title="1 of 2 branches missed.">				if( count == 0 )</span>
<span class="nc" id="L364">					m_cat.debug(&quot; Import Adapter is not running on url=&quot; + url ); </span>
<span class="fc" id="L365">			}</span>
			
<span class="fc" id="L367">			return  objList.toArray( (T[])java.lang.reflect.Array.newInstance(cls, objList.size())  );</span>
		}
		finally
		{
<span class="pc" id="L371">			methodFinish();</span>
		}
	}
	
	public boolean isConfiguredForImport( ID orgID, ID campaignID )
														throws RemoteException
	{
<span class="nc" id="L378">		methodStart(&quot;isConfiguredForImport&quot;, orgID, campaignID);</span>
		try 
		{
<span class="nc" id="L381">			IRemoteScheduleImport []impList = this.getOutsourcerImportStubs();</span>
<span class="nc bnc" id="L382" title="All 4 branches missed.">			if( impList == null || impList.length &lt;= 0 )</span>
			{
<span class="nc" id="L384">				return false;</span>
			}
			
<span class="nc bnc" id="L387" title="All 2 branches missed.">			for( int i=0; i &lt; impList.length; ++i)</span>
			{
				try
				{
<span class="nc" id="L391">					IRemoteScheduleImport imp = impList[i];</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">					if( imp.isConfiguredForImport(orgID,campaignID) )</span>
					{
<span class="nc" id="L394">						return true;</span>
					}
				}
<span class="nc" id="L397">				catch (Exception ex) </span>
				{
<span class="nc" id="L399">					m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L400">				}				</span>
			}

<span class="nc bnc" id="L403" title="All 2 branches missed.">			if( m_cat.isDebugEnabled() )</span>
<span class="nc" id="L404">				m_cat.debug(&quot; No Adapters configured for import&quot;  ); </span>
			
<span class="nc" id="L406">			return false;</span>
		}
<span class="nc" id="L408">		catch (Exception ex) </span>
		{
<span class="nc" id="L410">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L411">			throw new RemoteException(ex.getMessage(), ex);</span>
		} 
		finally
		{
<span class="nc" id="L415">			methodFinish();</span>
		}
	}

	public int importOutsourcerStaffingProfiles( ID orgID, ID campaignID,
														Date start,
														Date end)
							throws RemoteException
	{

<span class="nc" id="L425">		methodStart(&quot;importOutsourcerStaffingProfiles&quot;, orgID, campaignID, start, end);</span>

		try
		{
<span class="nc" id="L429">			ArrayList retVal = null;</span>
<span class="nc" id="L430">			IRemoteScheduleImport []impList = null;</span>
			
			try
			{
<span class="nc" id="L434">				impList = this.getOutsourcerImportStubs();</span>
<span class="nc bnc" id="L435" title="All 4 branches missed.">				if( impList == null || impList.length &lt;= 0 )</span>
				{
<span class="nc" id="L437">					return OUTSOURCER_INTEGRATION_SERVER_ERROR;</span>
				}
			}
<span class="nc" id="L440">			catch( Exception ex )</span>
			{
<span class="nc" id="L442">				return OUTSOURCER_INTEGRATION_SERVER_ERROR;</span>
<span class="nc" id="L443">			}</span>
	
<span class="nc bnc" id="L445" title="All 2 branches missed.">			for( int i=0; i &lt; impList.length; ++i)</span>
			{
				try
				{
<span class="nc" id="L449">					IRemoteScheduleImport imp = impList[i];</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">					if( !imp.isConfiguredForImport(orgID,campaignID) )</span>
					{
<span class="nc" id="L452">						continue;</span>
					}
							
<span class="nc bnc" id="L455" title="All 2 branches missed.">					if( m_cat.isDebugEnabled() )</span>
<span class="nc" id="L456">						m_cat.debug(&quot; Importing staffing profile for orgID=&quot; + orgID +</span>
								&quot; campaignID=&quot; + campaignID +
								&quot; start=&quot; + start +
								&quot; end=&quot; + end );
<span class="nc" id="L460">						retVal = (ArrayList)imp.importStaffingProfiles(orgID, campaignID, start, end);</span>
				}
<span class="nc" id="L462">				catch( Exception ex )</span>
				{
<span class="nc" id="L464">					m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L465">					return OUTSOURCER_ADAPTER_ERROR;</span>
<span class="nc" id="L466">				}</span>
				
<span class="nc" id="L468">				int count = 0;</span>
<span class="nc bnc" id="L469" title="All 4 branches missed.">				if( retVal != null  &amp;&amp; retVal.size() &gt; 1 )</span>
				{
<span class="nc" id="L471">					count = ((ArrayList)retVal.get(1)).size();</span>
				}

				// check if profiles are available for import
<span class="nc bnc" id="L475" title="All 2 branches missed.">				if(  count &gt; 0 )</span>
				{
					try
					{
<span class="nc" id="L479">						ScheduleAccessManager mgr = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc" id="L480">						mgr.importStaffingProfiles(orgID, </span>
													campaignID, 
													(ArrayList)retVal,
													start,
													end );
<span class="nc" id="L485">						return OUTSOURCER_IMPORT_SUCCESSFUL;</span>
					}
<span class="nc" id="L487">					catch( Exception ex )</span>
					{
<span class="nc" id="L489">						m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L490">						return OUTSOURCER_APPLICATION_SERVER_ERROR;</span>
					}
				}
				else
				{
<span class="nc bnc" id="L495" title="All 2 branches missed.">					if( m_cat.isDebugEnabled() )</span>
<span class="nc" id="L496">						m_cat.debug(&quot; Adapter returned null or empty collection for &quot; +</span>
								&quot; orgID=&quot; + orgID +
								&quot; campaignID=&quot; + campaignID +
								&quot; start=&quot; + start +
								&quot; end=&quot; + end);
<span class="nc" id="L501">					return OUTSOURCER_ADAPTER_PROCESSING_ERROR;</span>
				}
			}
	
<span class="nc bnc" id="L505" title="All 2 branches missed.">			if( m_cat.isDebugEnabled() )</span>
<span class="nc" id="L506">				m_cat.debug(&quot; No adapters configured to import orgID=&quot; + orgID +</span>
						&quot; campaignID=&quot; + campaignID);
			
<span class="nc" id="L509">			return OUTSOURCER_ADAPTER_CONFIGURATION_ERROR;</span>
		}
		finally 
		{
<span class="nc" id="L513">			methodFinish();</span>
		}
	}
	
<span class="fc" id="L517">	public static String SILENT_FNS_ADAPTER = &quot;SILENT_FNS_ADAPTER&quot;;</span>
<span class="fc" id="L518">	public static String SILENT_FNS_ADAPER_IDLE = &quot;SILENT_FNS_ADAPER_IDLE&quot;;</span>

	/**
	 * Initiates a schedule recalculation for the given SP (spID) using the Silent FnS Adapter in Integration Services.
	 * @param userName
	 * @param token
	 * @param isWhatIfMode
	 * @param actionID	1-recalc; 2-scheduling; 3-analyze
	 * @param spID
	 * @param isEnableLQF
	 * @param isRecalcSubCampaign
	 * @param params
	 * @return An integer indicating the status of the operation.
	 * 	1 - recalc was successfully initiated (the calc itself is done asynchronously so this gives no information on whether the
	 * 	calc itself was successful).
	 * OUTSOURCER_INTEGRATION_SERVER_ERROR (3) - Will be returned if there was a problem connecting to the integration server.
	 * OUTSOURCER_ADAPTER_CONFIGURATION_ERROR (4) - Will be returned if there was a problem with the configuration of the integration
	 * server (perhaps the Silent FnS module was not present or configured?)
	 */
	public int recalcScheduling(String userName, String token, boolean isWhatIfMode, int actionID, ID spID, boolean isEnableLQF, boolean isRecalcSubCampaign, String[] params){
<span class="fc" id="L538">		methodStart(&quot;recalcScheduling&quot;, new Integer(actionID), spID, new Boolean(isEnableLQF));</span>
<span class="fc" id="L539">		String command = &quot;&quot;;</span>
<span class="pc bpc" id="L540" title="3 of 4 branches missed.">		switch (actionID) {</span>
<span class="nc" id="L541">			case 1: command = &quot;ReCalc&quot;; break;</span>
<span class="fc" id="L542">			case 2: command = &quot;Scheduling&quot;; break;</span>
<span class="nc" id="L543">			case 3: command = &quot;Analyze&quot;; break;</span>
		}
		try {
<span class="fc" id="L546">			Pair stubPair = getStub();</span>
<span class="pc bpc" id="L547" title="1 of 2 branches missed.">			IRemoteInterface imp = (IRemoteInterface) (stubPair != null ? stubPair.getSecond() : null);</span>
<span class="pc bpc" id="L548" title="1 of 2 branches missed.">			if (imp == null) {</span>
<span class="nc" id="L549">				m_cat.info(&quot; No adapters configured to recalc or scheduling!&quot;);</span>
<span class="nc bnc" id="L550" title="All 4 branches missed.">				if (stubPair != null &amp;&amp; stubPair.getFirst() != null) {</span>
<span class="nc" id="L551">					return ((Integer) stubPair.getFirst()).intValue();</span>
				}
<span class="nc" id="L553">				return OUTSOURCER_ADAPTER_CONFIGURATION_ERROR;</span>
			}
<span class="pc bpc" id="L555" title="1 of 2 branches missed.">			if (m_cat.isDebugEnabled()) m_cat.debug(command + &quot; for spID=&quot; + spID);</span>
<span class="fc" id="L556">			String[] deiParams = new String[]{userName, token, String.valueOf(isWhatIfMode), String.valueOf(actionID), spID.toString(), String.valueOf(isEnableLQF)};</span>
<span class="pc bpc" id="L557" title="3 of 4 branches missed.">			if(actionID == 1 &amp;&amp; isRecalcSubCampaign)//1-recalc,2-scheduling, 3-analyze</span>
			{
<span class="nc" id="L559">				deiParams = new String[]{userName, token, String.valueOf(isWhatIfMode), String.valueOf(actionID), spID.toString(), String.valueOf(isEnableLQF), String.valueOf(isRecalcSubCampaign)};</span>
			}
			
<span class="pc bpc" id="L562" title="3 of 4 branches missed.">			if (actionID == 2 || actionID == 3) {//1-recalc,2-scheduling, 3-analyze</span>
		    		//maybe more parameters for dei file
<span class="pc bpc" id="L564" title="2 of 4 branches missed.">				if (params != null &amp;&amp; params.length &gt; 0) {</span>
<span class="fc" id="L565">					int numParams = 6 + params.length;</span>
<span class="fc" id="L566">					deiParams = new String[numParams];</span>
<span class="fc" id="L567">					int index = 0;</span>
<span class="fc" id="L568">					deiParams[index++] = userName;</span>
<span class="fc" id="L569">					deiParams[index++] = token;</span>
<span class="fc" id="L570">					deiParams[index++] = String.valueOf(isWhatIfMode);</span>
<span class="fc" id="L571">					deiParams[index++] = String.valueOf(actionID);</span>
<span class="fc" id="L572">					deiParams[index++] = spID.toString();</span>
<span class="fc" id="L573">					deiParams[index++] = String.valueOf(isEnableLQF);</span>

<span class="fc bfc" id="L575" title="All 2 branches covered.">					for (int j = 0; j &lt; params.length; j++) {</span>
<span class="fc" id="L576">						deiParams[index++] = params[j];</span>
					}
				}
			}
			// test here
			//generateDEI(deiParams);
<span class="fc" id="L582">			System.out.println(imp+ &quot;================&quot; + imp.doCommand(deiParams));</span>
<span class="fc" id="L583">			return 1;</span>
<span class="nc" id="L584">		} catch (Exception ex) {</span>
<span class="nc" id="L585">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L586">			return OUTSOURCER_ADAPTER_ERROR;</span>
		} finally {
<span class="pc" id="L588">			methodFinish();</span>
		}
	}
	

	public int getCountOfServers(String type) throws RemoteException {
<span class="fc" id="L594">		int count = 0;</span>

		try {
			FXRegistrationManager fxMgr = BbmManagerFactory
<span class="fc" id="L598">					.getFXRegistrationManager();</span>

<span class="fc" id="L600">			Collection coll = fxMgr.getAllServers();</span>
<span class="pc bpc" id="L601" title="1 of 4 branches missed.">			if (coll == null || coll.size() &lt;= 0) {</span>
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">				if (m_cat.isDebugEnabled())</span>
<span class="fc" id="L603">					m_cat.debug(&quot; No integration servers registered &quot;);</span>
<span class="fc" id="L604">				return 0;</span>
			}

<span class="fc" id="L607">			Iterator iter = coll.iterator();</span>
<span class="fc bfc" id="L608" title="All 2 branches covered.">			while (iter.hasNext()) {</span>
<span class="fc" id="L609">				FXServer srvr = (FXServer) iter.next();</span>
<span class="fc" id="L610">				String url = &quot;//&quot; + srvr.getRmiHost() + &quot;:&quot; + srvr.getRmiPort();</span>
<span class="pc bpc" id="L611" title="1 of 2 branches missed.">				if (m_cat.isDebugEnabled())</span>
<span class="fc" id="L612">					m_cat.debug(&quot; Looking up integration server url=&quot; + url);</span>

				try {
<span class="fc" id="L615">					String[] list = Naming.list(url);</span>
<span class="fc" id="L616">					url = url + &quot;/&quot;;</span>
<span class="pc bpc" id="L617" title="1 of 4 branches missed.">					for (int i = 0; list != null &amp;&amp; i &lt; list.length; ++i) {</span>
<span class="fc" id="L618">						String objUrl = list[i].substring(url.length());</span>

<span class="pc bpc" id="L620" title="1 of 2 branches missed.">						if (objUrl != null</span>
<span class="fc bfc" id="L621" title="All 2 branches covered.">								&amp;&amp; objUrl.startsWith(IRemoteInterface.RMT_ID)) {</span>
<span class="pc bpc" id="L622" title="1 of 2 branches missed.">							if (m_cat.isDebugEnabled())</span>
<span class="fc" id="L623">								m_cat.debug(&quot; Looking up adapter=&quot; + list[i]);</span>
<span class="fc" id="L624">							IRemoteInterface iRemInterface = (IRemoteInterface) Naming</span>
<span class="fc" id="L625">									.lookup(list[i]);</span>
<span class="pc bpc" id="L626" title="1 of 2 branches missed.">							if (iRemInterface != null</span>
<span class="pc bpc" id="L627" title="1 of 2 branches missed.">									&amp;&amp; iRemInterface.getInstanceID() != null</span>
<span class="fc" id="L628">									&amp;&amp; iRemInterface.getInstanceID()</span>
<span class="pc bpc" id="L629" title="1 of 2 branches missed.">											.startsWith(type)) {</span>
								// count only one adapter for one server
<span class="fc" id="L631">								count++;</span>
<span class="fc" id="L632">								break;</span>

							}
						}
					}
<span class="fc" id="L637">				} catch (Exception ex) {</span>
<span class="fc" id="L638">					m_cat.error(ex.getMessage(), ex);</span>
<span class="fc" id="L639">					continue;</span>
<span class="fc" id="L640">				}</span>
<span class="fc" id="L641">			}</span>
<span class="nc" id="L642">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L643">			m_cat.error(e.getMessage(), e);</span>
<span class="nc" id="L644">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L645">			m_cat.error(e.getMessage(), e);</span>
<span class="pc" id="L646">		}</span>
<span class="fc" id="L647">		return count;</span>
	}

	/*private void generateDEI (String args[]) throws Exception
	{
		// for debug: test here
	}*/
<span class="fc" id="L654">	static Queue&lt;String&gt; queue = new LinkedList&lt;String&gt;();</span>
	public Pair&lt;Integer, IRemoteInterface&gt; getStub() throws Exception {
<span class="fc" id="L656">		Pair&lt;Integer, IRemoteInterface&gt; retPair = new Pair&lt;Integer, IRemoteInterface&gt;();</span>
<span class="fc" id="L657">		HashMap&lt;String, IRemoteInterface&gt; remoteListUsable = new HashMap&lt;String, IRemoteInterface&gt;();</span>
<span class="fc" id="L658">		IRemoteInterface iRemInterface = null;</span>
		try  {
<span class="fc" id="L660">			IRemoteInterface[] remoteList  = this.getGenericStubs();</span>
<span class="pc bpc" id="L661" title="2 of 4 branches missed.">			if (remoteList == null || remoteList.length &lt;= 0) {</span>
<span class="nc" id="L662">				retPair.setPair(new Integer(OUTSOURCER_INTEGRATION_SERVER_ERROR), null);</span>
<span class="nc" id="L663">				return retPair;</span>
			}
<span class="fc bfc" id="L665" title="All 2 branches covered.">			for (int i = 0; i &lt; remoteList.length; ++i) {</span>
				try {
<span class="fc" id="L667">					iRemInterface = remoteList[i];</span>
<span class="pc bpc" id="L668" title="2 of 4 branches missed.">					if (iRemInterface != null &amp;&amp; iRemInterface.getInstanceID() != null</span>
<span class="pc bpc" id="L669" title="2 of 4 branches missed.">					        &amp;&amp; iRemInterface.getInstanceID().startsWith(SILENT_FNS_ADAPTER) &amp;&amp; isAdapterIdle(iRemInterface)) {</span>
<span class="fc" id="L670">						remoteListUsable.put(iRemInterface.getInstanceID(), iRemInterface);</span>
					}
<span class="nc" id="L672">				} catch (RemoteException e) {</span>
<span class="nc" id="L673">					m_cat.debug(e);</span>
<span class="nc" id="L674">					m_cat.info(&quot;Adapter is not responding; ignoring it (must be stopped). moving to next one i=&quot;+i);</span>
<span class="fc" id="L675">				}</span>
			}
<span class="pc bpc" id="L677" title="2 of 4 branches missed.">			if (remoteListUsable == null || remoteListUsable.isEmpty()) {</span>
<span class="nc" id="L678">				retPair.setPair(new Integer(OUTSOURCER_ADAPTER_CONFIGURATION_ERROR), null);</span>
<span class="nc" id="L679">				return retPair;</span>
			}
<span class="nc" id="L681">		} catch (Exception ex) {</span>
<span class="nc" id="L682">			retPair.setPair(new Integer(OUTSOURCER_INTEGRATION_SERVER_ERROR), null);</span>
<span class="nc" id="L683">			return retPair;</span>
<span class="fc" id="L684">		}</span>
<span class="fc" id="L685">		iRemInterface = null;</span>
		//If size is 1 then no need to bother about round robin implementation. just return the first adapter.
<span class="pc bpc" id="L687" title="2 of 4 branches missed.">		if (remoteListUsable != null &amp;&amp; remoteListUsable.size() == 1) {</span>
<span class="pc bpc" id="L688" title="2 of 4 branches missed.">			if (queue != null &amp;&amp; !queue.isEmpty()) queue.clear();</span>
<span class="fc" id="L689">			iRemInterface = (IRemoteInterface) remoteListUsable.values().iterator().next();</span>
<span class="fc" id="L690">			retPair.setPair(null, iRemInterface);</span>
<span class="fc" id="L691">			return retPair;</span>
		}
		//round robin implementation; applicable only if adapters found on more than one integration servers.
<span class="nc" id="L694">		synchronized (queue) {</span>
<span class="nc bnc" id="L695" title="All 4 branches missed.">			if (remoteListUsable != null &amp;&amp; queue.size() &gt; remoteListUsable.size()) {</span>
				//should go here only if a running adapter is removed
<span class="nc" id="L697">				m_cat.info(&quot;Existing adapter has been removed; clearing the round robin queue&quot;);</span>
<span class="nc" id="L698">				queue.clear();</span>
			}
<span class="nc bnc" id="L700" title="All 4 branches missed.">			if ( queue.size() == remoteListUsable.size() &amp;&amp; remoteListUsable.keySet().containsAll(queue)) {</span>
				//normal scenario get the adapters in round robin. Rely on linked list for that
<span class="nc" id="L702">				String interfaceName= (String)queue.remove();</span>
<span class="nc" id="L703">				iRemInterface = (IRemoteInterface) remoteListUsable.get(interfaceName);</span>
<span class="nc" id="L704">				queue.add(interfaceName);</span>
<span class="nc" id="L705">			} else {</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">				for (Iterator&lt;IRemoteInterface&gt; iterator = remoteListUsable.values().iterator(); iterator.hasNext();) {</span>
					//only should got here on startup or when a new adapter is added
<span class="nc" id="L708">					iRemInterface = iterator.next();</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">					if (!queue.contains(iRemInterface.getInstanceID())) {</span>
<span class="nc" id="L710">						m_cat.info(&quot; new Adapter found; adding it to the round robin queue:&quot; + iRemInterface.getInstanceID());</span>
<span class="nc" id="L711">						queue.add(iRemInterface.getInstanceID());</span>
<span class="nc" id="L712">						break;</span>
					}
				}
			}
<span class="nc" id="L716">		}</span>
<span class="nc" id="L717">		retPair.setPair(null, iRemInterface);</span>
<span class="nc" id="L718">		return retPair;</span>
	}

<span class="fc" id="L721">	private static String STAT_IDLE_KEY = &quot;STAT_IDLE_KEY&quot;; //defined in SilentFnSAdapter.java as well</span>
	private boolean isAdapterIdle(IRemoteInterface imp) throws RemoteException {
<span class="fc" id="L723">		boolean isAdapterIdle = true;</span>
<span class="fc" id="L724">		String[] keys = new String[]{STAT_IDLE_KEY};</span>
<span class="fc" id="L725">		String[] values = imp.get(keys);</span>
<span class="pc bpc" id="L726" title="1 of 2 branches missed.">		if (values.length == 1) {</span>
<span class="pc bpc" id="L727" title="2 of 4 branches missed.">			if (values[0] != null &amp;&amp; values[0].trim().equals(&quot;false&quot;))</span>
<span class="nc" id="L728">				isAdapterIdle = false;</span>
		}
<span class="fc" id="L730">		return isAdapterIdle;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>