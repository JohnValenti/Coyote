<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeRecordDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.timerecord.ejb</a> &gt; <span class="el_source">TimeRecordDAO.java</span></div><h1>TimeRecordDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.timerecord.ejb;

import java.math.BigDecimal;
import java.rmi.RemoteException;
import java.sql.Timestamp;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoParam;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.NumberFactory;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.config.model.Config;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeInterval;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecord;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecordEntry;
import com.bluepumpkin.ejb.bbm.util.DateAdjustmentUtil;

import com.bluepumpkin.common.cache.CacheFactory;
import com.bluepumpkin.common.cache.Cache;

/**
 * TimeRecordDAO is not to be accessed by other objects directly. Use default package level restriction.
 */
public class TimeRecordDAO {
	static final String REMAKERCOLNAME = &quot;MODIFIERBPUSERID&quot;;
	static final String APPROVERCOLSTR = &quot;A.APPROVEDBY, A.APPROVEDDATE, &quot;;
	static final String APPROVERCOLNAME = &quot;APPROVEDBY&quot;;
	static final String APPROVETIMECOLNAME = &quot;APPROVEDDATE&quot;;
	static final String ENTRYLASTMOFIDIEAT = &quot;LASTMODIFIEDAT&quot;;

	private static final String MYTIME_EMP_LAST_ACT_CACHE = &quot;MYTIME_EMP_LAST_ACT_CACHE&quot;;
<span class="fc" id="L46">	private static boolean cacheEnabled = true;</span>
<span class="fc" id="L47">	private static boolean m_ignoreFutureData = false; //used to ignore data in the future for data filling project</span>

//	private static boolean m_Init_ResetImmidiateToLastActivity = false;
//	private static boolean m_ResetImmidiateToLastActivity = false;
//	private static DBConfigManager m_DBConfigManager;
	/**
	 * default constructor
	 */
<span class="nc" id="L55">	public TimeRecordDAO() {</span>
<span class="nc" id="L56">	}</span>

	public static void setIgnoreFutureData(boolean ignore) {
<span class="fc" id="L59">		m_ignoreFutureData = ignore;</span>
<span class="fc" id="L60">	}</span>

	/**
	 * Approve a TimeRecord.
	 * &lt;p&gt;
	 * @param record
	 * @param approver
	 * @param vote
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void approveTimeRecord(ID trID, String approver, boolean vote)
			throws JdmoException {
<span class="nc" id="L73">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L75">			int size = 5;</span>
<span class="nc" id="L76">			StringBuffer pStmt = new StringBuffer(&quot;update TIMERECORD set ISAPPROVED=?, LASTMODIFIEDAT=?, &quot;);</span>
<span class="nc" id="L77">			pStmt.append(APPROVETIMECOLNAME).append(&quot;=?,&quot;);</span>
<span class="nc" id="L78">			pStmt.append(APPROVERCOLNAME).append(&quot;=?&quot;);</span>
<span class="nc" id="L79">			pStmt.append(&quot; where ISPOSTED=0 and ID=?&quot;);</span>
<span class="nc" id="L80">			Object[] param = new Object[size];</span>
<span class="nc" id="L81">			param[0] = JdmoParam.getObject(vote);</span>
<span class="nc" id="L82">			param[1] = new Date();</span>
<span class="nc" id="L83">			param[2] = new Date();</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">			if (approver != null) {</span>
<span class="nc" id="L85">				param[size - 2] = approver;</span>
			} else {
<span class="nc" id="L87">				param[size - 2] = new JdmoParam(null, Types.VARCHAR);</span>
			}
<span class="nc" id="L89">			param[size - 1] = trID;</span>
<span class="nc" id="L90">			jdmo.executePCommand(pStmt.toString(), param);</span>
		} finally {
<span class="nc" id="L92">			jdmo.cleanUp();</span>
<span class="nc" id="L93">		}</span>
<span class="nc" id="L94">	}</span>

	/**
	 * Approve a TimeRecord and will check multi-user Exception.
	 * &lt;p&gt;
	 * @param record
	 * @param approver
	 * @param vote
	 * @param jdmo
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void approveTimeRecord(TimeRecord record, String approver, boolean vote, Jdmo jdmo)
			throws JdmoException {
<span class="nc" id="L108">		int size = 7;</span>
<span class="nc" id="L109">		StringBuffer pStmt = new StringBuffer(&quot;update TIMERECORD set ISAPPROVED=?, CHANGESTATUS =?, CHANGECOUNTER=?, LASTMODIFIEDAT=?, &quot;);</span>
<span class="nc" id="L110">		pStmt.append(APPROVETIMECOLNAME).append(&quot;=?,&quot;);</span>
<span class="nc" id="L111">		pStmt.append(APPROVERCOLNAME).append(&quot;=?&quot;);</span>
<span class="nc" id="L112">		pStmt.append(&quot; where ISPOSTED=0 and ID=?&quot;);</span>
<span class="nc" id="L113">		Object[] param = new Object[size];</span>
<span class="nc" id="L114">		param[0] = JdmoParam.getObject(vote);</span>
		// if it is 0 promote it to 1, if 1 to 1, then 2 to 2
<span class="nc bnc" id="L116" title="All 2 branches missed.">		param[1] = new Short(record.getSyncStatus() == 0 ? 1 : record.getSyncStatus());</span>
<span class="nc" id="L117">		param[2] = new Long(record.getVersion());</span>
<span class="nc" id="L118">		param[3] = new Date();</span>
<span class="nc" id="L119">		param[4] = new Date();</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">		if (approver != null) {</span>
<span class="nc" id="L121">			param[size - 2] = approver;</span>
		} else {
<span class="nc" id="L123">			param[size - 2] = new JdmoParam(null, Types.VARCHAR);</span>
		}
<span class="nc" id="L125">		param[size - 1] = record.getID();</span>
<span class="nc" id="L126">		jdmo.executePCommand(pStmt.toString(), param);</span>
<span class="nc" id="L127">	}</span>

	/**
	 * Approve a TimeRecord and will check Multi-User Exception.
	 * &lt;p&gt;
	 * @param record
	 * @param approver
	 * @param vote
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void approveTimeRecord(TimeRecord record, String approver, boolean vote)
			throws JdmoException {
<span class="nc" id="L140">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L142">			approveTimeRecord(record, approver, vote, jdmo);</span>
		} finally {
<span class="nc" id="L144">			jdmo.cleanUp();</span>
<span class="nc" id="L145">		}</span>
<span class="nc" id="L146">	}</span>

	/**
	 * Check a TimeInterval by a period and work resource ID, which will check the overlap rule and remove those not posted time record.
	 * &lt;p&gt;
	 * @param wrID
	 * @param actID
	 * @param start
	 * @param end
	 * &lt;p&gt;
	 * @return true if the time interval exists, false otherwise
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static boolean checkExistingTimeInterval(ID wrID, ID actID, Timestamp start, Timestamp end)
			throws JdmoException {
<span class="nc" id="L162">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L164">			String pStmt = &quot;select A.ID from TIMERECORD A, TIMERECORDADJUSTMENT B where A.ISPOSTED=0 and A.EMPLOYEEID=? and A.ID=B.TIMERECORDID and B.STARTTIME&lt;? and B.ENDTIME&gt;? and B.ACTIVITYID=?&quot;;</span>
<span class="nc" id="L165">			JdmoQuery jQuery1 = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L166">			jQuery1.setParID(1, wrID);</span>
<span class="nc" id="L167">			jQuery1.setParTimestamp(2, end);</span>
<span class="nc" id="L168">			jQuery1.setParTimestamp(3, start);</span>
<span class="nc" id="L169">			jQuery1.setParID(4, actID);</span>
			// Check if there is any TimeRecord meets the criteria and overlap
<span class="nc" id="L171">			JdmoRowset rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L173">				return true;</span>
			}
<span class="nc" id="L175">			return false;</span>
		} finally {
<span class="nc bnc" id="L177" title="All 6 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L178">				jdmo.cleanUp();</span>
			}
		}
	}

	/**
	 * Used by the UI to create TimeInterval, which will create a new TimeRecord.
	 * &lt;p&gt;
	 * @param interval
	 * &lt;p&gt;
	 * @return the ID for the newly created time interval
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ID createTimeInterval(TimeInterval interval)
			throws JdmoException {
<span class="nc" id="L194">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L196">			HashMap map = new HashMap();</span>
<span class="nc" id="L197">			map.put(&quot;TIMERECORDID&quot;, interval.getParentID());</span>
<span class="nc" id="L198">			map.put(&quot;ACTIVITYID&quot;, interval.getActivityID());</span>
<span class="nc" id="L199">			map.put(&quot;STARTTIME&quot;, TimeZoneUtil.toTimestamp(interval.getStartTime()));</span>
<span class="nc" id="L200">			map.put(&quot;ENDTIME&quot;, TimeZoneUtil.toTimestamp(interval.getEndTime()));</span>
<span class="nc" id="L201">			map.put(&quot;COUNTTOWARDSMINUTES&quot;, new Integer(interval.getDuration()));</span>
<span class="nc" id="L202">			map.put(&quot;TIMESOURCECODE&quot;, new Integer(interval.getTimeSourceCode()));</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">			if (interval.getDescription() != null) {</span>
<span class="nc" id="L204">				map.put(&quot;DESCRIPTION&quot;, interval.getDescription());</span>
			}
<span class="nc" id="L206">			map.put(&quot;ISPAID&quot;, JdmoParam.getObject(interval.getPaid()));</span>
<span class="nc" id="L207">			ID id = jdmo.addBatchInsert(&quot;TIMERECORDADJUSTMENT&quot;, map);</span>
<span class="nc" id="L208">			jdmo.executeBatch();</span>
<span class="nc" id="L209">			return id;</span>
		} finally {
<span class="nc" id="L211">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Used by the UI to create TimeInterval, which will create a new TimeRecord.
	 * &lt;p&gt;
	 * @param record
	 * &lt;p&gt;
	 * @return the ID for the newly created time record
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ID createTimeInterval(TimeRecord record)
			throws JdmoException {
<span class="nc bnc" id="L226" title="All 2 branches missed.">		if (record.getType() != TimeRecord.TIMEINTERVAL) {</span>
<span class="nc" id="L227">			return null;</span>
		}
<span class="nc" id="L229">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L231">			HashMap map = new HashMap();</span>
			// Create the record first
<span class="nc" id="L233">			map.put(&quot;EMPLOYEEID&quot;, record.getEmployeeID());</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">			if (record.getRemarkEmployeeID() != null) {</span>
<span class="nc" id="L235">				map.put(REMAKERCOLNAME, record.getRemarkEmployeeID());</span>
			}
<span class="nc bnc" id="L237" title="All 2 branches missed.">			if (record.getLastModifiedTime() == null) {</span>
<span class="nc" id="L238">				map.put(&quot;LASTMODIFIEDAT&quot;, new Date());</span>
			} else {
<span class="nc" id="L240">				map.put(&quot;LASTMODIFIEDAT&quot;, record.getLastModifiedTime());</span>
			}
<span class="nc bnc" id="L242" title="All 2 branches missed.">			if (record.getDescription() != null) {</span>
<span class="nc" id="L243">				map.put(&quot;REMARK&quot;, record.getDescription());</span>
			}
<span class="nc" id="L245">			map.put(&quot;ISAPPROVED&quot;, JdmoParam.getObject(record.getApprove()));</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">			if (record.getApprove()) {</span>
<span class="nc" id="L247">				map.put(APPROVETIMECOLNAME, new Date());</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">				if (record.getApproverName() != null) {</span>
<span class="nc" id="L249">					map.put(APPROVERCOLNAME, record.getApproverName());</span>
				}
			}
<span class="nc" id="L252">			map.put(&quot;ISPOSTED&quot;, JdmoParam.getObject(record.isLocked()));</span>
<span class="nc" id="L253">			map.put(&quot;CHANGECOUNTER&quot;, new Long(record.getVersion()));</span>
<span class="nc" id="L254">			map.put(&quot;CHANGESTATUS&quot;, new Short(record.getSyncStatus()));</span>
			// If record is approved, need get Approver name
<span class="nc bnc" id="L256" title="All 2 branches missed.">			if (record.getApprove()) {</span>
<span class="nc" id="L257">				map.put(APPROVETIMECOLNAME, new Date());</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">				if (record.getApproverName() != null) {</span>
<span class="nc" id="L259">					map.put(APPROVERCOLNAME, record.getApproverName());</span>
				}
			}
<span class="nc" id="L262">			ID id = jdmo.addBatchInsert(&quot;TIMERECORD&quot;, map);</span>
<span class="nc" id="L263">			record.setID(id);</span>
			// Create the interval
<span class="nc" id="L265">			map.clear();</span>
<span class="nc" id="L266">			TimeInterval interval = (TimeInterval)record.getChild().get(0);</span>
<span class="nc" id="L267">			map.put(&quot;TIMERECORDID&quot;, id);</span>
<span class="nc" id="L268">			map.put(&quot;ACTIVITYID&quot;, interval.getActivityID());</span>
<span class="nc" id="L269">			map.put(&quot;STARTTIME&quot;, TimeZoneUtil.toTimestamp(interval.getStartTime()));</span>
<span class="nc" id="L270">			map.put(&quot;ENDTIME&quot;, TimeZoneUtil.toTimestamp(interval.getEndTime()));</span>
<span class="nc" id="L271">			map.put(&quot;COUNTTOWARDSMINUTES&quot;, new Integer(interval.getDuration()));</span>
<span class="nc" id="L272">			map.put(&quot;TIMESOURCECODE&quot;, new Integer(interval.getTimeSourceCode()));</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">			if (interval.getDescription() != null) {</span>
<span class="nc" id="L274">				map.put(&quot;DESCRIPTION&quot;, interval.getDescription());</span>
			}
<span class="nc" id="L276">			map.put(&quot;ISPAID&quot;, JdmoParam.getObject(interval.getPaid()));</span>
<span class="nc" id="L277">			jdmo.addBatchInsert(&quot;TIMERECORDADJUSTMENT&quot;, map);</span>
<span class="nc" id="L278">			jdmo.executeBatch();</span>
<span class="nc" id="L279">			return id;</span>
		} finally {
<span class="nc" id="L281">			jdmo.cleanUp();</span>
		}
	} //createTimeInterval

	/**
	 * Create a TimeRecordEntry.
	 * &lt;p&gt;
	 * @param entry
	 * @param b_ResetImmidiateToLastActivity
	 * &lt;p&gt;
	 * @return the ID for the newly created time record
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ID createTimeRecordEntry(TimeRecordEntry entry, boolean b_ResetImmidiateToLastActivity)
			throws JdmoException {
<span class="fc" id="L297">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="fc" id="L299">			ID result = createTimeRecordEntry(entry, jdmo);</span>
<span class="fc" id="L300">			entry.setID(result);</span>
<span class="fc" id="L301">			jdmo.executeBatch();</span>

<span class="pc bpc" id="L303" title="1 of 2 branches missed.">			if (b_ResetImmidiateToLastActivity) {</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">				if (entry.getDataSourceID() == null) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">					if (entry.getActivityID() != null) {</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">						if (entry.getActivityID().toString().compareToIgnoreCase(&quot;-4001&quot;) != 0) {</span>
							//record is created manually be user so populate in cache
<span class="nc" id="L308">							setEmpLastActCache(entry.getEmployeeID(), entry.getActivityID());</span>
						}
					}
				}
			}

<span class="fc" id="L314">			return result;</span>
<span class="nc" id="L315">		} catch (Exception e) {</span>
<span class="nc" id="L316">			throw new JdmoException(e);</span>
		} finally {
<span class="pc bpc" id="L318" title="3 of 4 branches missed.">			if (jdmo != null) {</span>
<span class="pc" id="L319">				jdmo.cleanUp();</span>
			}
		}
	}

	/**
	 * Create a TimeRecordEntry.
	 * &lt;p&gt;
	 * @param entryList
	 * @param b_ResetImmidiateToLastActivity
	 * &lt;p&gt;
	 * @return an ID collection of newly created time records
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ArrayList createTimeRecordEntry(ArrayList entryList, boolean b_ResetImmidiateToLastActivity)
			throws JdmoException {
<span class="fc" id="L336">		Jdmo jdmo = new Jdmo();</span>

<span class="fc" id="L338">		ArrayList idList = new ArrayList(entryList.size());</span>
		try {
<span class="fc bfc" id="L340" title="All 2 branches covered.">			for (Iterator it = entryList.iterator(); it.hasNext();) {</span>
<span class="fc" id="L341">				TimeRecordEntry entry = (TimeRecordEntry)it.next();</span>

<span class="pc bpc" id="L343" title="1 of 2 branches missed.">				if (b_ResetImmidiateToLastActivity) {</span>
<span class="nc" id="L344">					Cache b_cache = CacheFactory.getCache(MYTIME_EMP_LAST_ACT_CACHE, TimeRecordDAO.class.getClassLoader());</span>

<span class="nc" id="L346">					String sValue = (String)b_cache.get(&quot;Emp_Last_Act&quot; + &quot;_&quot; + entry.getEmployeeID());</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">					if (sValue == null) {</span>
						//last act was not found in cache, look in DB
<span class="nc" id="L349">						ID lastactID = getEmpLastActFromDB(entry.getEmployeeID());</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">						if (lastactID != null) {</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">							if (entry.getActivityID().toString().equals(&quot;-4101&quot;)) {</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">								if (lastactID.toString().compareToIgnoreCase(&quot;-4001&quot;) != 0) {</span>
<span class="nc" id="L353">									entry.setActivityID(lastactID);</span>
								}
							}
						}
<span class="nc" id="L357">					} else {</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">						if (entry.getActivityID().toString().equals(&quot;-4101&quot;)) {</span>
<span class="nc" id="L359">							entry.setActivityID(new ID(sValue));</span>
						}
					}
				}

<span class="fc" id="L364">				ID result = createTimeRecordEntry(entry, jdmo);</span>
<span class="fc" id="L365">				entry.setID(result);</span>
<span class="fc" id="L366">				idList.add(result);</span>
<span class="fc" id="L367">			}</span>
<span class="fc" id="L368">			jdmo.executeBatch();</span>
<span class="fc" id="L369">			return idList;</span>
<span class="nc" id="L370">		} catch (Exception e) {</span>
<span class="nc" id="L371">			throw new JdmoException(e);</span>
		} finally {
<span class="pc bpc" id="L373" title="3 of 4 branches missed.">			if (jdmo != null) {</span>
<span class="pc" id="L374">				jdmo.cleanUp();</span>
			}
		}
	}

	/**
	 * Create a TimeRecordEntry with a predefined Jdmo.
	 * &lt;p&gt;
	 * @param entry
	 * @param jdmo
	 * &lt;p&gt;
	 * @return the ID for the newly created time record
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ID createTimeRecordEntry(TimeRecordEntry entry, Jdmo jdmo)
			throws JdmoException {
<span class="fc" id="L391">		HashMap map = new HashMap(8);</span>

<span class="fc" id="L393">		map.put(&quot;ACTIVITYID&quot;, entry.getActivityID());</span>

<span class="pc bpc" id="L395" title="1 of 2 branches missed.">		if (entry.getRawTimeEntryID() != null) {</span>
<span class="nc" id="L396">			map.put(&quot;RAWTIMEENTRYID&quot;, entry.getRawTimeEntryID());</span>
		}
<span class="fc" id="L398">		map.put(&quot;TIMERECORDID&quot;, entry.getParentID());</span>
<span class="fc" id="L399">		map.put(&quot;STARTTIME&quot;, entry.getStartTime());</span>
<span class="fc" id="L400">		map.put(&quot;UPDATETIMESTAMP&quot;, BigDecimal.valueOf(entry.getSortTime().getTime()));</span>
<span class="fc" id="L401">		map.put(&quot;TIMESOURCECODE&quot;, new Integer(entry.getTimeSourceCode()));</span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">		if (entry.getDescription() != null) {</span>
<span class="fc" id="L403">			map.put(&quot;DESCRIPTION&quot;, entry.getDescription());</span>
		}
<span class="fc" id="L405">		map.put(&quot;ISPAID&quot;, JdmoParam.getObject(entry.getPaid()));</span>
<span class="fc" id="L406">		map.put(&quot;EMPLOYEEID&quot;, entry.getEmployeeID());</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">		if (entry.getLastUpdateTimestamp() != null) {</span>
<span class="nc" id="L408">			map.put(&quot;LASTMODIFIEDAT&quot;, entry.getLastModifiedTime());</span>
		} else {
<span class="fc" id="L410">			map.put(&quot;LASTMODIFIEDAT&quot;, new Date());</span>
		}
<span class="fc bfc" id="L412" title="All 2 branches covered.">		if (entry.getModifier() != null) {</span>
<span class="fc" id="L413">			map.put(&quot;MODIFIEDBY&quot;, entry.getModifier());</span>
		}
<span class="pc bpc" id="L415" title="1 of 2 branches missed.">		if (entry.getDataSourceID() != null) {</span>
<span class="nc" id="L416">			map.put(&quot;DATASOURCEID&quot;, entry.getDataSourceID());</span>
		}
<span class="fc" id="L418">		ID result = jdmo.addBatchInsert(&quot;TIMEENTRYEVENT&quot;, map);</span>
<span class="fc" id="L419">		entry.setID(result);</span>
<span class="fc" id="L420">		return result;</span>
	}

	/**
	 * Gets the Valid Intervals for workResource.
	 * &lt;p&gt;
	 * @param workResourceID
	 * @param dtStart
	 * @param dtEnd
	 * &lt;p&gt;
	 * @return HashMap, Keyed by WorkResourceID and associated collection of time records
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static HashMap findTimeIntervals(Collection workResourceID, Timestamp dtStart, Timestamp dtEnd)
			throws JdmoException {
<span class="nc" id="L436">		HashMap timeRecords = new HashMap(workResourceID.size());</span>
<span class="nc" id="L437">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L439">			String empInClause = jdmo.createInClause(workResourceID);</span>
<span class="nc" id="L440">			StringBuffer pStmt2 = new StringBuffer(200);</span>
<span class="nc" id="L441">			pStmt2.append(</span>
					&quot;select A.ID, B.ID, C.NAME, D.ID, D.NAME, B.ISPAID, B.DESCRIPTION, A.EMPLOYEEID, B.STARTTIME, B.ENDTIME, FIRSTNAME, LASTNAME, &quot;).
<span class="nc" id="L443">					append(APPROVERCOLSTR).append(REMAKERCOLNAME).append(&quot;, a.LASTMODIFIEDAT, REMARK, ISAPPROVED, ISPOSTED, A.CHANGECOUNTER, CHANGESTATUS, ACTIVITYID, &quot;).</span>
<span class="nc" id="L444">					append(&quot;COUNTTOWARDSMINUTES, TIMESOURCECODE FROM TIMERECORD A, TIMERECORDADJUSTMENT B, ACTIVITY C, ACTIVITYCATEGORY D, EMPLOYEEAM E, PERSON F where A.ID=B.TIMERECORDID and B.ACTIVITYID=C.ID and A.EMPLOYEEID=E.ID and E.PERSONID=F.ID and D.ID=&quot;).</span>
<span class="nc" id="L445">					append(&quot;C.ACTIVITYCATEGORYID and A.ID in (select distinct A.ID from TIMERECORD A, TIMERECORDADJUSTMENT B where A.EMPLOYEEID in&quot;).</span>
<span class="nc" id="L446">					append(empInClause).append(&quot; and A.ID=B.TIMERECORDID and B.STARTTIME&lt;=? and B.ENDTIME&gt;?) order by A.EMPLOYEEID, A.ID, B.STARTTIME asc&quot;);</span>
<span class="nc" id="L447">			JdmoQuery jQuery2 = jdmo.createQuery(pStmt2.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L448">			jQuery2.setParTimestamp(1, dtEnd);</span>
<span class="nc" id="L449">			jQuery2.setParTimestamp(2, dtStart);</span>
			// Load the TimeIntervals
<span class="nc" id="L451">			JdmoRowset rs = jdmo.createRowset(jQuery2, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
			// One TimeRecord can only have one TimeInterval, enforced by index
<span class="nc bnc" id="L453" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L454">				ID empID = rs.getID(8);</span>
<span class="nc" id="L455">				ArrayList trArray = (ArrayList)timeRecords.get(empID);</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">				if (trArray == null) {</span>
<span class="nc" id="L457">					trArray = new ArrayList(1);</span>
				}
<span class="nc" id="L459">				ID key = rs.getID(1);</span>
<span class="nc" id="L460">				TimeRecord record = new TimeRecord(</span>
						key,
						empID,
<span class="nc" id="L463">						rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L464">						TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L465">						rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L466">						TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L467">						rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L468">						rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L469">						rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L470">				record.setEmpFirstName(rs.getString(&quot;FIRSTNAME&quot;));</span>
<span class="nc" id="L471">				record.setEmpLastName(rs.getString(&quot;LASTNAME&quot;));</span>
<span class="nc" id="L472">				record.setType(TimeRecord.TIMEINTERVAL);</span>
<span class="nc" id="L473">				TimeInterval interval = new TimeInterval(</span>
<span class="nc" id="L474">						rs.getID(2),</span>
<span class="nc" id="L475">						rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L476">						TimeZoneUtil.toDate(rs.getTimestamp(9)),</span>
<span class="nc" id="L477">						TimeZoneUtil.toDate(rs.getTimestamp(10)),</span>
<span class="nc" id="L478">						rs.getInt(&quot;COUNTTOWARDSMINUTES&quot;),</span>
<span class="nc" id="L479">						rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L480">						rs.getBoolean(6),</span>
<span class="nc" id="L481">						rs.getString(7),</span>
						record);
<span class="nc" id="L483">				interval.setActivityName(rs.getString(3));</span>
<span class="nc" id="L484">				interval.setActivityCategoryID(rs.getID(4));</span>
<span class="nc" id="L485">				interval.setActivityCategoryName(rs.getString(5));</span>
<span class="nc" id="L486">				record.getChild().add(interval);</span>
<span class="nc" id="L487">				trArray.add(record);</span>
<span class="nc" id="L488">				timeRecords.put(empID, trArray);</span>
<span class="nc" id="L489">			}</span>
<span class="nc" id="L490">			return timeRecords;</span>
		} finally {
<span class="nc" id="L492">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Return EmployeeID for a given Time Record ID.
	 * &lt;p&gt;
	 * @param trID
	 * &lt;p&gt;
	 * @return an employee ID for the given time record ID
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ID getEmployeeIDWithTimeRecordID(ID trID)
			throws JdmoException {
<span class="nc" id="L507">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L509">			StringBuffer pStmt = new StringBuffer(&quot;select EMPLOYEEID from TIMERECORD where ID=?&quot;);</span>
<span class="nc" id="L510">			JdmoQuery jq = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L511">			jq.setParID(1, trID);</span>
<span class="nc" id="L512">			JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L513">			ID empID = null;</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L515">				empID = rs.getID(1);</span>
			}
<span class="nc" id="L517">			return empID;</span>
		} finally {
<span class="nc" id="L519">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Load all TimeRecord IDs with TimeRecordEntries based on given period for one work resource.
	 * &lt;p&gt;
	 * @param wrID
	 * @param start
	 * @param end
	 * &lt;p&gt;
	 * @return a collection of event IDs for a work resource
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ArrayList getEventIDsForWorkResource(ID wrID, Date start, Date end)
			throws JdmoException {
<span class="nc" id="L536">		Jdmo jdmo = new Jdmo();</span>
<span class="nc" id="L537">		Date end1 = DateAdjustmentUtil.adjustEndDateForDemo(end, m_ignoreFutureData);</span>
		try {
<span class="nc" id="L539">			String pStmt</span>
					= &quot;select distinct A2.ID from TIMERECORD A2, TIMEENTRYEVENT B2 where A2.EMPLOYEEID=? and A2.ID=B2.TIMERECORDID and B2.UPDATETIMESTAMP&lt;? and B2.UPDATETIMESTAMP&gt;=?&quot;;
<span class="nc" id="L541">			JdmoQuery jQuery1 = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L542">			jQuery1.setParID(1, wrID);</span>
<span class="nc" id="L543">			jQuery1.setParLong(2, end1.getTime());</span>
<span class="nc" id="L544">			jQuery1.setParLong(3, start.getTime());</span>
<span class="nc" id="L545">			JdmoRowset rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L546">			ArrayList trArray = new ArrayList();</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L548">				trArray.add(rs.getID(1));</span>
			}
<span class="nc" id="L550">			return trArray;</span>
		} finally {
<span class="nc" id="L552">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Retrieve one Time Record by ID, will check if there is TimeEntry associated with it or not, then check TimeInterval.
	 * &lt;p&gt;
	 * @param timeRecordID
	 * &lt;p&gt;
	 * @return a time record using the given ID
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	public static TimeRecord getTimeRecordByID(ID timeRecordID)
			throws JdmoException {
<span class="nc" id="L567">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L569">			JdmoRowset rs = null;</span>
<span class="nc" id="L570">			StringBuffer sb = new StringBuffer(&quot;SELECT EMPLOYEEID, LASTNAME, FIRSTNAME, &quot;);</span>
<span class="nc" id="L571">			sb.append(TimeRecordDAO.APPROVERCOLSTR).append(TimeRecordDAO.REMAKERCOLNAME);</span>
<span class="nc" id="L572">			sb.append(&quot;, a.LASTMODIFIEDAT, REMARK, ISAPPROVED, ISPOSTED, CHANGESTATUS, &quot;);</span>
<span class="nc" id="L573">			sb.append(&quot;A.CHANGECOUNTER FROM TIMERECORD A, EMPLOYEEAM B, PERSON C WHERE &quot;);</span>
<span class="nc" id="L574">			sb.append(&quot;A.EMPLOYEEID=B.ID and B.PERSONID=C.ID and A.ID=?&quot;);</span>
<span class="nc" id="L575">			JdmoQuery jQuery = jdmo.createQuery(sb.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L576">			jQuery.setParID(1, timeRecordID);</span>
<span class="nc" id="L577">			rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L578">			TimeRecord record = null;</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L580">				record = new TimeRecord(</span>
						timeRecordID,
<span class="nc" id="L582">						rs.getID(&quot;EMPLOYEEID&quot;),</span>
<span class="nc" id="L583">						rs.getID(TimeRecordDAO.REMAKERCOLNAME),</span>
<span class="nc" id="L584">						TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L585">						rs.getString(TimeRecordDAO.APPROVERCOLNAME),</span>
<span class="nc" id="L586">						TimeZoneUtil.toDate(rs.getTimestamp(TimeRecordDAO.APPROVETIMECOLNAME)),</span>
<span class="nc" id="L587">						rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L588">						rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L589">						rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L590">				record.setEmpFirstName(rs.getString(&quot;FIRSTNAME&quot;));</span>
<span class="nc" id="L591">				record.setEmpLastName(rs.getString(&quot;LASTNAME&quot;));</span>
<span class="nc" id="L592">				record.setVersion(rs.getLong(&quot;CHANGECOUNTER&quot;));</span>
<span class="nc" id="L593">				record.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
			}
<span class="nc" id="L595">			rs.close();</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">			if (record != null) {</span>
				// Load Entries first
<span class="nc" id="L598">				StringBuffer buf = new StringBuffer(</span>
						&quot;SELECT B.ID, B.ISPAID, B.DESCRIPTION, C.NAME, D.ID, D.NAME, B.LASTMODIFIEDAT, B.MODIFIEDBY, B.DATASOURCEID, RAWTIMEENTRYID, ACTIVITYID, STARTTIME, UPDATETIMESTAMP, TIMESOURCECODE FROM TIMEENTRYEVENT B, ACTIVITY C, ACTIVITYCATEGORY D WHERE B.TIMERECORDID =? AND B.ACTIVITYID = C.ID AND D.ID = C.ACTIVITYCATEGORYID&quot;);
<span class="nc bnc" id="L600" title="All 2 branches missed.">				if (m_ignoreFutureData) {</span>
<span class="nc" id="L601">					buf.append(&quot; AND UPDATETIMESTAMP&lt;=?&quot;);</span>
				}
<span class="nc" id="L603">				buf.append(&quot; ORDER BY B.UPDATETIMESTAMP ASC&quot;);</span>
<span class="nc" id="L604">				JdmoQuery jQuery2 = jdmo.createQuery(buf.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L605">				jQuery2.setParID(1, timeRecordID);</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">				if (m_ignoreFutureData) {</span>
<span class="nc" id="L607">					jQuery2.setParLong(2, new Date().getTime());</span>
				}
<span class="nc" id="L609">				rs = jdmo.createRowset(jQuery2, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L611">					record.setType(TimeRecord.TIMEENTRY);</span>
					do {
<span class="nc" id="L613">						Date entryStart = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L614">						TimeRecordEntry entry = new TimeRecordEntry(</span>
<span class="nc" id="L615">								rs.getID(1),</span>
<span class="nc" id="L616">								rs.getID(&quot;RAWTIMEENTRYID&quot;),</span>
<span class="nc" id="L617">								rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L618">								rs.getID(&quot;DATASOURCEID&quot;),</span>
								entryStart,
								entryStart,
<span class="nc" id="L621">								new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)),</span>
<span class="nc" id="L622">								rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L623">								rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L624">								rs.getString(&quot;DESCRIPTION&quot;),</span>
								record);
<span class="nc" id="L626">						entry.setActivityName(rs.getString(4));</span>
<span class="nc" id="L627">						entry.setActivityCategoryID(rs.getID(5));</span>
<span class="nc" id="L628">						entry.setActivityCategoryName(rs.getString(6));</span>
<span class="nc" id="L629">						entry.setLastModifiedTime(TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)));</span>
<span class="nc" id="L630">						entry.setModifier(rs.getString(&quot;MODIFIEDBY&quot;));</span>
<span class="nc" id="L631">						ArrayList temp = record.getChild();</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">						if (!temp.isEmpty()) {</span>
<span class="nc" id="L633">							((TimeRecordEntry)temp.get(temp.size() - 1)).setEndTime(entryStart);</span>
						}
<span class="nc" id="L635">						record.getChild().add(entry);</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">					} while (rs.next());</span>
<span class="nc" id="L637">					rs.close();</span>
				} else {
					// Load TimeInterval
<span class="nc" id="L640">					String pStmt</span>
							= &quot;SELECT B.ID, B.ISPAID, B.DESCRIPTION, C.NAME, D.ID, D.NAME, ACTIVITYID, STARTTIME, ENDTIME, COUNTTOWARDSMINUTES, TIMESOURCECODE FROM TIMERECORDADJUSTMENT B, ACTIVITY C, ACTIVITYCATEGORY D WHERE B.TIMERECORDID =? AND B.ACTIVITYID = C.ID AND D.ID = C.ACTIVITYCATEGORYID ORDER BY B.STARTTIME ASC&quot;;
<span class="nc" id="L642">					jQuery = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L643">					jQuery.setParID(1, timeRecordID);</span>
<span class="nc" id="L644">					rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">					if (rs.next()) {</span>
<span class="nc" id="L646">						record.setType(TimeRecord.TIMEINTERVAL);</span>
						do {
<span class="nc" id="L648">							TimeInterval entry = new TimeInterval(</span>
<span class="nc" id="L649">									rs.getID(1),</span>
<span class="nc" id="L650">									rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L651">									TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;)),</span>
<span class="nc" id="L652">									TimeZoneUtil.toDate(rs.getTimestamp(&quot;ENDTIME&quot;)),</span>
<span class="nc" id="L653">									rs.getInt(&quot;COUNTTOWARDSMINUTES&quot;),</span>
<span class="nc" id="L654">									rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L655">									rs.getBoolean(2),</span>
<span class="nc" id="L656">									rs.getString(3),</span>
									record);
<span class="nc" id="L658">							entry.setActivityName(rs.getString(4));</span>
<span class="nc" id="L659">							entry.setActivityCategoryID(rs.getID(5));</span>
<span class="nc" id="L660">							entry.setActivityCategoryName(rs.getString(6));</span>
<span class="nc" id="L661">							record.getChild().add(entry);</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">						} while (rs.next());</span>
<span class="nc" id="L663">						rs.close();</span>
					}
				}
			}
<span class="nc" id="L667">			return record;</span>
		} finally {
<span class="nc" id="L669">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Load all TimeRecord with TimeRecordEntries based on given collection of ID.
	 * &lt;p&gt;
	 * @param idCol
	 * &lt;p&gt;
	 * @return a collection of time records based on a collection of time record IDs
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ArrayList getTimeRecordByIDs(Collection idCol)
			throws JdmoException {
<span class="nc" id="L684">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L686">			StringBuffer pStmt1 = new StringBuffer(&quot;select A.ID, B.ID, C.NAME, D.ID, D.NAME, B.ISPAID, &quot;).append(</span>
<span class="nc" id="L687">					&quot;B.DESCRIPTION, A.EMPLOYEEID, &quot;).append(APPROVERCOLSTR).append(&quot; A.&quot;).append(REMAKERCOLNAME).append(</span>
<span class="nc" id="L688">							&quot;, A.CHANGECOUNTER, a.LASTMODIFIEDAT, REMARK, ISAPPROVED, ISPOSTED, &quot;).append(</span>
<span class="nc" id="L689">							&quot;CHANGESTATUS, RAWTIMEENTRYID, ACTIVITYID, STARTTIME, UPDATETIMESTAMP, TIMESOURCECODE, &quot;).append(</span>
<span class="nc" id="L690">							&quot;B.LASTMODIFIEDAT BLASTMODIFIEDAT, B.MODIFIEDBY BMODIFIEDBY FROM TIMERECORD A, &quot;).append(</span>
<span class="nc" id="L691">							&quot;TIMEENTRYEVENT B, ACTIVITY C, ACTIVITYCATEGORY D &quot;).append(</span>
<span class="nc" id="L692">							&quot; where A.ID=B.TIMERECORDID and B.ACTIVITYID=C.ID and &quot;).append(</span>
<span class="nc" id="L693">							&quot;D.ID=C.ACTIVITYCATEGORYID and A.ID in &quot;).append(jdmo.createInClause(idCol));</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L695">				pStmt1.append(&quot; and B.UPDATETIMESTAMP&lt;=?&quot;);</span>
			}
<span class="nc" id="L697">			pStmt1.append(&quot; order by A.EMPLOYEEID, A.ID, B.UPDATETIMESTAMP asc&quot;);</span>
<span class="nc" id="L698">			JdmoQuery jQuery1 = jdmo.createQuery(pStmt1.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L699">			jQuery1.setParLong(2, new Date().getTime());</span>
<span class="nc" id="L700">			JdmoRowset rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L701">			ArrayList trArray = new ArrayList(idCol.size());</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L703">				ID empID = rs.getID(8);</span>
<span class="nc" id="L704">				ID key = rs.getID(1);</span>
<span class="nc" id="L705">				TimeRecord record = null;</span>
<span class="nc" id="L706">				TimeRecord previous = null;</span>
<span class="nc" id="L707">				int last = trArray.size();</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">				if (last == 0) {</span>
<span class="nc" id="L709">					record = new TimeRecord(</span>
							key,
							empID,
<span class="nc" id="L712">							rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L713">							TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L714">							rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L715">							TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L716">							rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L717">							rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L718">							rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L719">					record.setVersion(rs.getLong(10));</span>
<span class="nc" id="L720">					record.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
<span class="nc" id="L721">					trArray.add(record);</span>
<span class="nc" id="L722">					previous = record;</span>
				} else {
<span class="nc" id="L724">					previous = (TimeRecord)trArray.get(last - 1);</span>
				}
				// if it is a new timerecord
<span class="nc bnc" id="L727" title="All 2 branches missed.">				if (!previous.getID().equals(key)) {</span>
<span class="nc" id="L728">					record = new TimeRecord(</span>
							key,
							empID,
<span class="nc" id="L731">							rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L732">							TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L733">							rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L734">							TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L735">							rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L736">							rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L737">							rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L738">					record.setVersion(rs.getLong(10));</span>
<span class="nc" id="L739">					record.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
<span class="nc" id="L740">					trArray.add(record);</span>
				} else {
					// if it is not a new timerecord
<span class="nc" id="L743">					record = previous;</span>
				}
<span class="nc" id="L745">				Date entryStart = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L746">				TimeRecordEntry entry = new TimeRecordEntry(</span>
<span class="nc" id="L747">						rs.getID(2),</span>
<span class="nc" id="L748">						rs.getID(&quot;RAWTIMEENTRYID&quot;),</span>
<span class="nc" id="L749">						rs.getID(&quot;ACTIVITYID&quot;),</span>
						entryStart,
						entryStart,
<span class="nc" id="L752">						new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)),</span>
<span class="nc" id="L753">						rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L754">						rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L755">						rs.getString(7),</span>
						record);
<span class="nc" id="L757">				entry.setActivityName(rs.getString(3));</span>
<span class="nc" id="L758">				entry.setActivityCategoryID(rs.getID(4));</span>
<span class="nc" id="L759">				entry.setActivityCategoryName(rs.getString(5));</span>
<span class="nc" id="L760">				entry.setLastModifiedTime(TimeZoneUtil.toDate(rs.getTimestamp(&quot;BLASTMODIFIEDAT&quot;)));</span>
<span class="nc" id="L761">				entry.setModifier(rs.getString(&quot;BMODIFIEDBY&quot;));</span>
<span class="nc" id="L762">				ArrayList temp = record.getChild();</span>
				// need to set the previous entry's endtime
<span class="nc bnc" id="L764" title="All 2 branches missed.">				if (!temp.isEmpty()) {</span>
<span class="nc" id="L765">					TimeRecordEntry lastEntry = (TimeRecordEntry)temp.get(temp.size() - 1);</span>
<span class="nc" id="L766">					lastEntry.setEndTime(entryStart);</span>
				}
				// add the new entry directly
<span class="nc" id="L769">				record.getChild().add(entry);</span>
<span class="nc" id="L770">			}</span>
<span class="nc" id="L771">			return trArray;</span>
		} finally {
<span class="nc" id="L773">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * The optimistic locking of TimeRecord for TimeRecordEntry Operations,
	 * used internally for all create/update time record entry operation.
	 * This version retrieves basic information of TimeRecord/TimeRecordEntry.
	 * TODO: Change it to pessimistic locking
	 * &lt;p&gt;
	 * @param timeRecordID
	 * &lt;p&gt;
	 * @return TimeRecord
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static TimeRecord getTimeRecordForUpdate(ID timeRecordID)
			throws JdmoException {
<span class="nc" id="L791">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L793">			Object[] param = new Object[1];</span>
<span class="nc" id="L794">			param[0] = timeRecordID;</span>
			// Select for update, obtain the current TimeRecord status
<span class="nc" id="L796">			jdmo.executePCommand(&quot;update TIMERECORD set REMARK=REMARK where ID=?&quot;, param);</span>
<span class="nc" id="L797">			JdmoRowset rs = null;</span>
<span class="nc" id="L798">			StringBuffer pStmt = new StringBuffer(&quot;select a.EMPLOYEEID, &quot;).append(APPROVERCOLSTR);</span>
<span class="nc" id="L799">			pStmt.append(REMAKERCOLNAME).append(&quot;, a.LASTMODIFIEDAT, REMARK, &quot;).append(</span>
<span class="nc" id="L800">					&quot;ISAPPROVED, ISPOSTED, CHANGESTATUS, CHANGECOUNTER, &quot;).append(</span>
<span class="nc" id="L801">							&quot;B.ID, DATASOURCEID, RAWTIMEENTRYID, ACTIVITYID, STARTTIME, UPDATETIMESTAMP, &quot;).append(</span>
<span class="nc" id="L802">							&quot;TIMESOURCECODE, ISPAID, DESCRIPTION, b.LASTMODIFIEDAT BLASTMODIFIEDAT, b.MODIFIEDBY BMODIFIEDBY &quot;).append(</span>
							&quot;from TIMERECORD a, TIMEENTRYEVENT b where a.ID=? and a.ID=b.TIMERECORDID &quot;);
<span class="nc bnc" id="L804" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L805">				pStmt.append(&quot;and UPDATETIMESTAMP&lt;=? &quot;);</span>
			}
<span class="nc" id="L807">			pStmt.append(&quot;order by b.UPDATETIMESTAMP asc&quot;);</span>
<span class="nc" id="L808">			JdmoQuery jQuery = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L809">			jQuery.setParID(1, timeRecordID);</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L811">				jQuery.setParLong(2, new Date().getTime());</span>
			}
<span class="nc" id="L813">			rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L814">			TimeRecord record = null;</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L816" title="All 2 branches missed.">				if (record == null) {</span>
<span class="nc" id="L817">					record = new TimeRecord(</span>
							timeRecordID,
<span class="nc" id="L819">							rs.getID(&quot;EMPLOYEEID&quot;),</span>
<span class="nc" id="L820">							rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L821">							TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L822">							rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L823">							TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L824">							rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L825">							rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L826">							rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L827">					record.setVersion(rs.getLong(&quot;CHANGECOUNTER&quot;));</span>
<span class="nc" id="L828">					record.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
				}
<span class="nc" id="L830">				Date entryStart = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L831">				TimeRecordEntry entry = new TimeRecordEntry(</span>
<span class="nc" id="L832">						rs.getID(&quot;ID&quot;),</span>
<span class="nc" id="L833">						rs.getID(&quot;RAWTIMEENTRYID&quot;),</span>
<span class="nc" id="L834">						rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L835">						rs.getID(&quot;DATASOURCEID&quot;),</span>
						entryStart,
						entryStart, // EndTime is the same as StartTime
<span class="nc" id="L838">						new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)),</span>
<span class="nc" id="L839">						rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L840">						rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L841">						rs.getString(&quot;DESCRIPTION&quot;),</span>
						record);
<span class="nc" id="L843">				entry.setLastModifiedTime(TimeZoneUtil.toDate(rs.getTimestamp(&quot;BLASTMODIFIEDAT&quot;)));</span>
<span class="nc" id="L844">				entry.setModifier(rs.getString(&quot;BMODIFIEDBY&quot;));</span>
<span class="nc" id="L845">				ArrayList temp = record.getChild();</span>
				// Adjust EndTime of previous Entry
<span class="nc bnc" id="L847" title="All 2 branches missed.">				if (!temp.isEmpty()) {</span>
<span class="nc" id="L848">					((TimeRecordEntry)temp.get(temp.size() - 1)).setEndTime(entryStart);</span>
				}
				// Add the entry directly into TimeRecord
<span class="nc" id="L851">				record.getChild().add(entry);</span>
<span class="nc" id="L852">			}</span>
<span class="nc" id="L853">			return record;</span>
		} finally {
<span class="nc" id="L855">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * The optimistic locking of TimeRecord for TimeRecordEntry Operations,
	 * used internally for all create/update timerecord entry operation.
	 * This version retrieves basic information of TimeRecord/TimeRecordEntry.
	 * It will check the version, early detect the version.
	 * If there is version mismatch, will return null.
	 * The danger is, it cannot tell the difference between
	 * TimeRecord Removed(ID is gone) or Version mismatch.
	 * But in most cases, it is version mismatch.
	 * &lt;p&gt;
	 * @param timeRecordID
	 * @param version
	 * @param interval
	 * &lt;p&gt;
	 * @return TimeRecord
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static TimeRecord getTimeRecordForUpdate(ID timeRecordID, long version, boolean interval)
			throws JdmoException {
<span class="nc" id="L879">		TimeRecord record = null;</span>
<span class="nc" id="L880">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L882" title="All 2 branches missed.">			if (!interval) {</span>
				// Only retrieve TimeEntry
<span class="nc" id="L884">				StringBuffer pStmt = new StringBuffer(</span>
<span class="nc" id="L885">						&quot;select a.EMPLOYEEID, &quot;).append(APPROVERCOLSTR).append(REMAKERCOLNAME).append(&quot;, a.LASTMODIFIEDAT, REMARK, &quot;).append(</span>
<span class="nc" id="L886">								&quot;ISAPPROVED, ISPOSTED, CHANGESTATUS, b.ID, b.DATASOURCEID, RAWTIMEENTRYID, ACTIVITYID, &quot;).append(</span>
<span class="nc" id="L887">								&quot;STARTTIME, UPDATETIMESTAMP, TIMESOURCECODE, ISPAID, DESCRIPTION, &quot;).append(</span>
<span class="nc" id="L888">								&quot;b.LASTMODIFIEDAT BLASTMODIFIEDAT, b.MODIFIEDBY BMODIFIEDBY from TIMERECORD a, &quot;).append(</span>
<span class="nc" id="L889">								&quot;TIMEENTRYEVENT b where a.ID=? and a.CHANGECOUNTER=? &quot;).append(</span>
								&quot;and a.ID = b.TIMERECORDID &quot;);
<span class="nc bnc" id="L891" title="All 2 branches missed.">				if (m_ignoreFutureData) {</span>
<span class="nc" id="L892">					pStmt.append(&quot;and b.UPDATETIMESTAMP&lt;=? &quot;);</span>
				}
<span class="nc" id="L894">				pStmt.append(&quot;order by b.UPDATETIMESTAMP asc&quot;);</span>
<span class="nc" id="L895">				JdmoQuery jQuery = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L896">				jQuery.setParID(1, timeRecordID);</span>
<span class="nc" id="L897">				jQuery.setParLong(2, version);</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">				if (m_ignoreFutureData) {</span>
<span class="nc" id="L899">					jQuery.setParLong(3, new Date().getTime());</span>
				}
<span class="nc" id="L901">				JdmoRowset rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">					if (record == null) {</span>
<span class="nc" id="L904">						record = new TimeRecord(</span>
								timeRecordID,
<span class="nc" id="L906">								rs.getID(&quot;EMPLOYEEID&quot;),</span>
<span class="nc" id="L907">								rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L908">								TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L909">								rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L910">								TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L911">								rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L912">								rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L913">								rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L914">						record.setVersion(version);</span>
<span class="nc" id="L915">						record.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
					}
<span class="nc" id="L917">					Date entryStart = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L918">					TimeRecordEntry entry = new TimeRecordEntry(</span>
<span class="nc" id="L919">							rs.getID(&quot;ID&quot;),</span>
<span class="nc" id="L920">							rs.getID(&quot;RAWTIMEENTRYID&quot;),</span>
<span class="nc" id="L921">							rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L922">							rs.getID(&quot;DATASOURCEID&quot;),</span>
							entryStart,
							entryStart, // EndTime is the same as StartTime
<span class="nc" id="L925">							new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)),</span>
<span class="nc" id="L926">							rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L927">							rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L928">							rs.getString(&quot;DESCRIPTION&quot;),</span>
							record);
<span class="nc" id="L930">					entry.setLastModifiedTime(TimeZoneUtil.toDate(rs.getTimestamp(&quot;BLASTMODIFIEDAT&quot;)));</span>
<span class="nc" id="L931">					entry.setModifier(rs.getString(&quot;BMODIFIEDBY&quot;));</span>
<span class="nc" id="L932">					entry.setEmployeeID(record.getEmployeeID());</span>
<span class="nc" id="L933">					ArrayList temp = record.getChild();</span>
					// Adjust EndTime of previous Entry
<span class="nc bnc" id="L935" title="All 2 branches missed.">					if (!temp.isEmpty()) {</span>
<span class="nc" id="L936">						((TimeRecordEntry)temp.get(temp.size() - 1)).setEndTime(entryStart);</span>
					}
					// Add the entry directly into TimeRecord
<span class="nc" id="L939">					record.getChild().add(entry);</span>
<span class="nc" id="L940">				}</span>
<span class="nc" id="L941">				rs.close();</span>
<span class="nc" id="L942">			} else {</span>
				// Only retrieve TimeInterval
				// Load TimeInterval
<span class="nc" id="L945">				StringBuffer pStmt = new StringBuffer(</span>
<span class="nc" id="L946">						&quot;select a.EMPLOYEEID, &quot;).append(APPROVERCOLSTR).append(REMAKERCOLNAME).append(&quot;, a.LASTMODIFIEDAT, REMARK, &quot;).append(</span>
<span class="nc" id="L947">								&quot;ISAPPROVED, ISPOSTED, CHANGESTATUS, B.ID, &quot;).append(</span>
<span class="nc" id="L948">								&quot;ACTIVITYID, STARTTIME, ENDTIME, COUNTTOWARDSMINUTES, &quot;).append(</span>
<span class="nc" id="L949">								&quot;TIMESOURCECODE, ISPAID, DESCRIPTION from TIMERECORD a, &quot;).append(</span>
<span class="nc" id="L950">								&quot;TIMERECORDADJUSTMENT b where a.ID=? and a.CHANGECOUNTER=? &quot;).append(</span>
								&quot;and a.ID = b.TIMERECORDID order by b.STARTTIME asc&quot;);
<span class="nc" id="L952">				JdmoQuery jQuery = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L953">				jQuery.setParID(1, timeRecordID);</span>
<span class="nc" id="L954">				jQuery.setParLong(2, version);</span>
<span class="nc" id="L955">				JdmoRowset rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">					if (record == null) {</span>
<span class="nc" id="L958">						record = new TimeRecord(</span>
								timeRecordID,
<span class="nc" id="L960">								rs.getID(&quot;EMPLOYEEID&quot;),</span>
<span class="nc" id="L961">								rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L962">								TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L963">								rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L964">								TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L965">								rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L966">								rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L967">								rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L968">						record.setVersion(version);</span>
<span class="nc" id="L969">						record.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
					}
<span class="nc" id="L971">					TimeInterval intv = new TimeInterval(</span>
<span class="nc" id="L972">							rs.getID(&quot;ID&quot;),</span>
<span class="nc" id="L973">							rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L974">							TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;)),</span>
<span class="nc" id="L975">							TimeZoneUtil.toDate(rs.getTimestamp(&quot;ENDTIME&quot;)),</span>
<span class="nc" id="L976">							rs.getInt(&quot;COUNTTOWARDSMINUTES&quot;),</span>
<span class="nc" id="L977">							rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L978">							rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L979">							rs.getString(&quot;DESCRIPTION&quot;),</span>
							record);
<span class="nc" id="L981">					record.addChild(intv);</span>
<span class="nc" id="L982">				}</span>
<span class="nc" id="L983">				rs.close();</span>
			}
<span class="nc" id="L985">			return record;</span>
		} finally {
<span class="nc" id="L987">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Initial design is to use &quot;select for update&quot; pessimistic lock.
	 * Switched to Optimistic locking mechanism now.
	 * &lt;p&gt;
	 * @param id
	 * &lt;p&gt;
	 * @return TimeRecord
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static TimeRecord getTimeRecordForUpdateOnly(ID id)
			throws JdmoException {
<span class="nc" id="L1003">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1005">			StringBuffer pStmt = new StringBuffer(&quot;select EMPLOYEEID, &quot;);</span>
<span class="nc" id="L1006">			pStmt.append(APPROVERCOLSTR);</span>
<span class="nc" id="L1007">			pStmt.append(REMAKERCOLNAME).append(&quot;, LASTMODIFIEDAT, REMARK, ISAPPROVED, ISPOSTED, CHANGECOUNTER, CHANGESTATUS from TIMERECORD A where ID=?&quot;);</span>
<span class="nc" id="L1008">			JdmoQuery jq = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L1009">			jq.setParID(1, id);</span>
<span class="nc" id="L1010">			JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L1011">			TimeRecord tr = null;</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1013">				tr = new TimeRecord(id,</span>
<span class="nc" id="L1014">						rs.getID(&quot;EMPLOYEEID&quot;),</span>
<span class="nc" id="L1015">						rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L1016">						TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L1017">						rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L1018">						TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L1019">						rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L1020">						rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L1021">						rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L1022">				tr.setVersion(rs.getLong(&quot;CHANGECOUNTER&quot;));</span>
<span class="nc" id="L1023">				tr.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
			}
<span class="nc bnc" id="L1025" title="All 2 branches missed.">			if (rs != null) {</span>
				try {
<span class="nc" id="L1027">					rs.close();</span>
<span class="nc" id="L1028">				} catch (Exception e) {</span>
<span class="nc" id="L1029">				}</span>
			}
<span class="nc" id="L1031">			return tr;</span>
		} finally {
<span class="nc" id="L1033">			jdmo.cleanUp();</span>
		}
	} //getTimeRecordForUpdateOnly

	/**
	 * Using pessimistic locking, lock TimeRecord based on its entry ID.
	 * &lt;p&gt;
	 * @param entryID
	 * &lt;p&gt;
	 * @return TimeRecord
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static TimeRecord getTimeRecordForUpdateOnlyByEntryID(ID entryID)
			throws JdmoException {
<span class="nc" id="L1048">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1050">			StringBuffer pStmt = new StringBuffer(&quot;select ID, EMPLOYEEID, &quot;);</span>
<span class="nc" id="L1051">			pStmt.append(APPROVERCOLSTR);</span>
<span class="nc" id="L1052">			pStmt.append(REMAKERCOLNAME).append(&quot;, LASTMODIFIEDAT, REMARK, ISAPPROVED, ISPOSTED, CHANGECOUNTER, CHANGESTATUS from TIMERECORD where ID=(select timerecordid from TIMEENTRYEVENT A, TIMERECORD B where A.ID=? and A.TIMERECORDID=B.ID)&quot;);</span>
<span class="nc" id="L1053">			JdmoQuery jq = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L1054">			jq.setParID(1, entryID);</span>
<span class="nc" id="L1055">			JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L1056">			TimeRecord tr = null;</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1058">				tr = new TimeRecord(rs.getID(&quot;ID&quot;),</span>
<span class="nc" id="L1059">						rs.getID(&quot;EMPLOYEEID&quot;),</span>
<span class="nc" id="L1060">						rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L1061">						TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L1062">						rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L1063">						TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L1064">						rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L1065">						rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L1066">						rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L1067">				tr.setVersion(rs.getLong(&quot;CHANGECOUNTER&quot;));</span>
<span class="nc" id="L1068">				tr.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
			}
<span class="nc bnc" id="L1070" title="All 2 branches missed.">			if (rs != null) {</span>
				try {
<span class="nc" id="L1072">					rs.close();</span>
<span class="nc" id="L1073">				} catch (Exception e) {</span>
<span class="nc" id="L1074">				}</span>
			}
<span class="nc" id="L1076">			return tr;</span>
		} finally {
<span class="nc" id="L1078">			jdmo.cleanUp();</span>
		}
	} //getTimeRecordForUpdateOnlyByEntryID

	/**
	 * Check if there is an open TimeRecord just before a given date.
	 * &lt;p&gt;
	 * @param trID
	 * @param dtStart
	 * &lt;p&gt;
	 * @return true if the shift is open, false otherwise
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static boolean isOpenShift(ID trID, Date dtStart)
			throws JdmoException {
<span class="nc" id="L1094">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1096">			StringBuffer pStmt = new StringBuffer(&quot;select ID from TIMEENTRYEVENT where TIMERECORDID=? and UPDATETIMESTAMP&gt;=? and ACTIVITYID=-4001&quot;);</span>
<span class="nc bnc" id="L1097" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L1098">				pStmt.append(&quot; and UPDATETIMESTAMP&lt;?&quot;);</span>
			}
<span class="nc" id="L1100">			JdmoQuery jQuery = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L1101">			jQuery.setParID(1, trID);</span>
<span class="nc" id="L1102">			jQuery.setParLong(2, dtStart.getTime());</span>
<span class="nc bnc" id="L1103" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L1104">				jQuery.setParLong(3, new Date().getTime());</span>
			}
<span class="nc" id="L1106">			JdmoRowset rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1108">				return false;</span>
			}
<span class="nc" id="L1110">			return true;</span>
		} finally {
<span class="nc" id="L1112">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Tries to get the SyncStatus of the TimeRecord.
	 * &lt;p&gt;
	 * @param ID,
	 * &lt;p&gt;
	 * @return boolean
	 * &lt;p&gt;
	 * @exception JdmoException, any DB system level exception
	 * @exception BbmObjectNotFoundException, if TimeRecord no longer exist
	 */
	static boolean isTimeRecordModified(ID id)
			throws JdmoException, BbmObjectNotFoundException {
<span class="nc" id="L1128">		Jdmo jdmo = new Jdmo();</span>
<span class="nc" id="L1129">		JdmoRowset rs = null;</span>
		try {
<span class="nc" id="L1131">			String pStmt = &quot;select CHANGESTATUS from TIMERECORD where ID=?&quot;;</span>
<span class="nc" id="L1132">			JdmoQuery jq = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L1133">			jq.setParID(1, id);</span>
<span class="nc" id="L1134">			rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1136">				short status = rs.getShort(&quot;CHANGESTATUS&quot;);</span>
<span class="nc bnc" id="L1137" title="All 2 branches missed.">				return (status == 0) ? false : true;</span>
			}
<span class="nc" id="L1139">			throw new BbmObjectNotFoundException();</span>
		} finally {
<span class="nc bnc" id="L1141" title="All 4 branches missed.">			if (rs != null) {</span>
				try {
<span class="nc" id="L1143">					rs.close();</span>
<span class="nc" id="L1144">				} catch (Exception e) {</span>
<span class="nc" id="L1145">				}</span>
			}
<span class="nc bnc" id="L1147" title="All 4 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L1148">				jdmo.cleanUp();</span>
			}
		}
	} //isTimeRecordModified

	/**
	 * Update an existing TimeRecordEntry without knowing the TimeRecordID.
	 * Provided for BPX quick update for previous entry's activity.
	 * &lt;p&gt;
	 * @param entry
	 * &lt;p&gt;
	 * @return the number of rows that were modified by the executed Jdmo.executePCommand method
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static int quickUpdateTimeRecordEntry(TimeRecordEntry entry)
			throws JdmoException {
<span class="nc" id="L1165">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1167">			String pStmt = null;</span>
<span class="nc" id="L1168">			Object[] param = new Object[3];</span>
<span class="nc bnc" id="L1169" title="All 2 branches missed.">			if (entry.getRawTimeEntryID() != null) {</span>
<span class="nc" id="L1170">				pStmt = &quot;update TIMEENTRYEVENT set ACTIVITYID=?, ISPAID=? where RAWTIMEENTRYID=?&quot;;</span>
<span class="nc" id="L1171">				param[2] = entry.getRawTimeEntryID();</span>
			} else {
<span class="nc" id="L1173">				pStmt = &quot;update TIMEENTRYEVENT set ACTIVITYID=?, ISPAID=? where ID=?&quot;;</span>
<span class="nc" id="L1174">				param[2] = entry.getID();</span>
			}
<span class="nc" id="L1176">			param[0] = entry.getActivityID();</span>
<span class="nc" id="L1177">			param[1] = JdmoParam.getObject(entry.getPaid());</span>
<span class="nc" id="L1178">			return jdmo.executePCommand(pStmt, param);</span>
		} finally {
<span class="nc" id="L1180">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Update an existing TimeRecordEntry without knowing the TimeRecordID.
	 * Provided for BPX quick update for previous entry's activity.
	 * &lt;p&gt;
	 * @param entry
	 * @param jdmo
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static int quickUpdateTimeRecordEntry(TimeRecordEntry entry, Jdmo jdmo)
			throws JdmoException {
<span class="nc" id="L1195">		String pStmt = null;</span>
<span class="nc" id="L1196">		Object[] param = new Object[3];</span>
<span class="nc bnc" id="L1197" title="All 2 branches missed.">		if (entry.getRawTimeEntryID() != null) {</span>
<span class="nc" id="L1198">			pStmt = &quot;update TIMEENTRYEVENT set ACTIVITYID=?, ISPAID=? where RAWTIMEENTRYID=?&quot;;</span>
<span class="nc" id="L1199">			param[2] = entry.getRawTimeEntryID();</span>
		} else {
<span class="nc" id="L1201">			pStmt = &quot;update TIMEENTRYEVENT set ACTIVITYID=?, ISPAID=? where ID=?&quot;;</span>
<span class="nc" id="L1202">			param[2] = entry.getID();</span>
		}
<span class="nc" id="L1204">		param[0] = entry.getActivityID();</span>
<span class="nc" id="L1205">		param[1] = JdmoParam.getObject(entry.getPaid());</span>
<span class="nc" id="L1206">		return jdmo.executePCommand(pStmt, param);</span>
	}

	/**
	 * Used by the UI to refresh a TimeRecord, which cleans up all entries first.
	 * &lt;p&gt;
	 * @param record
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void refreshTimeRecord(TimeRecord record)
			throws JdmoException {
<span class="nc bnc" id="L1218" title="All 4 branches missed.">		if (record.getID() == null || record.getType() != TimeRecord.TIMEENTRY) {</span>
<span class="nc" id="L1219">			return;</span>
		}
<span class="nc" id="L1221">		ArrayList child = record.getChild();</span>
<span class="nc bnc" id="L1222" title="All 4 branches missed.">		if (child == null || child.isEmpty()) {</span>
<span class="nc" id="L1223">			return;</span>
		}
<span class="nc" id="L1225">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1227">			String pStmt = &quot;delete TIMEENTRYEVENT where TIMERECORDID=?&quot;;</span>
<span class="nc" id="L1228">			Object[] param = new Object[1];</span>
<span class="nc" id="L1229">			param[0] = record.getID();</span>
<span class="nc" id="L1230">			jdmo.executePCommand(pStmt, param);</span>
<span class="nc" id="L1231">			HashMap map = new HashMap(8);</span>
<span class="nc bnc" id="L1232" title="All 2 branches missed.">			for (Iterator it = child.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1233">				TimeRecordEntry entry = (TimeRecordEntry)it.next();</span>
<span class="nc bnc" id="L1234" title="All 2 branches missed.">				if (entry.getID() != null) {</span>
<span class="nc" id="L1235">					map.put(&quot;ID&quot;, entry.getID());</span>
				}
<span class="nc" id="L1237">				map.put(&quot;ACTIVITYID&quot;, entry.getActivityID());</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">				if (entry.getRawTimeEntryID() != null) {</span>
<span class="nc" id="L1239">					map.put(&quot;RAWTIMEENTRYID&quot;, entry.getRawTimeEntryID());</span>
				}
<span class="nc" id="L1241">				map.put(&quot;TIMERECORDID&quot;, record.getID());</span>
<span class="nc" id="L1242">				map.put(&quot;STARTTIME&quot;, entry.getStartTime());</span>
<span class="nc" id="L1243">				map.put(&quot;UPDATETIMESTAMP&quot;, BigDecimal.valueOf(entry.getSortTime().getTime()));</span>
<span class="nc" id="L1244">				map.put(&quot;TIMESOURCECODE&quot;, NumberFactory.newInteger(entry.getTimeSourceCode()));</span>
<span class="nc bnc" id="L1245" title="All 2 branches missed.">				if (entry.getDescription() != null) {</span>
<span class="nc" id="L1246">					map.put(&quot;DESCRIPTION&quot;, entry.getDescription());</span>
				}
<span class="nc" id="L1248">				map.put(&quot;ISPAID&quot;, JdmoParam.getObject(entry.getPaid()));</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">				if (entry.getLastModifiedTime() != null) {</span>
<span class="nc" id="L1250">					map.put(&quot;LASTMODIFIEDAT&quot;, entry.getLastModifiedTime());</span>
				} else {
<span class="nc" id="L1252">					map.put(&quot;LASTMODIFIEDAT&quot;, new Date());</span>
				}
<span class="nc bnc" id="L1254" title="All 2 branches missed.">				if (entry.getDataSourceID() != null) {</span>
<span class="nc" id="L1255">					map.put(&quot;DATASOURCEID&quot;, entry.getDataSourceID());</span>
				}
<span class="nc" id="L1257">				jdmo.addBatchInsert(&quot;TIMEENTRYEVENT&quot;, map);</span>
<span class="nc" id="L1258">				map.clear();</span>
<span class="nc" id="L1259">			}</span>
<span class="nc" id="L1260">			jdmo.executeBatch();</span>
		} finally {
<span class="nc" id="L1262">			jdmo.cleanUp();</span>
<span class="nc" id="L1263">		}</span>
<span class="nc" id="L1264">	} //cleanTimeRecord</span>

	/**
	 * Remove a TimeInterval by ID.
	 * &lt;p&gt;
	 * @param id
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void removeTimeInterval(ID id)
			throws JdmoException {
<span class="nc" id="L1275">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L1277" title="All 2 branches missed.">			if (id != null) {</span>
<span class="nc" id="L1278">				ArrayList trCol = new ArrayList(1);</span>
<span class="nc" id="L1279">				trCol.add(id);</span>
<span class="nc" id="L1280">				DAOUtil.deleteObjects(jdmo, &quot;TIMERECORDADJUSTMENT&quot;, trCol);</span>
			}
		} finally {
<span class="nc" id="L1283">			jdmo.cleanUp();</span>
<span class="nc" id="L1284">		}</span>
<span class="nc" id="L1285">	}</span>

	/**
	 * Remove a TimeInterval by a period and workresource ID,
	 * which will check the overlap rule, and remove those not posted timerecord.
	 * &lt;p&gt;
	 * @param wrID
	 * @param type
	 * @param activityCol
	 * @param start
	 * @param end
	 * @param overlap
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void removeTimeInterval(
			ID wrID,
			int type,
			Collection activityCol,
			Timestamp start,
			Timestamp end,
			int overlap)
			throws JdmoException {
<span class="nc" id="L1308">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1310">			StringBuffer pStmt = new StringBuffer(400);</span>
<span class="nc bnc" id="L1311" title="All 3 branches missed.">			switch (overlap) {</span>
				case Config.STARTSIN:
<span class="nc" id="L1313">					pStmt.append(&quot;select A.ID from TIMERECORD A, TIMERECORDADJUSTMENT B where A.ISPOSTED=0 &quot;).</span>
<span class="nc" id="L1314">							append(&quot;and A.EMPLOYEEID=&quot;).append(wrID).append(&quot; and A.ID=B.TIMERECORDID&quot;);</span>
<span class="nc bnc" id="L1315" title="All 2 branches missed.">					if (type != 0) {</span>
<span class="nc" id="L1316">						pStmt.append(&quot; and B.TIMESOURCECODE=&quot;).append(type);</span>
					}
<span class="nc" id="L1318">					pStmt.append(&quot; and B.STARTTIME&gt;='&quot;).append(JdmoUtil.formatDBString(start)).append(&quot;' and B.STARTTIME&lt;'&quot;).append(JdmoUtil.formatDBString(end)).append(&quot;'&quot;);</span>
<span class="nc bnc" id="L1319" title="All 4 branches missed.">					if (activityCol != null &amp;&amp; !activityCol.isEmpty()) {</span>
<span class="nc" id="L1320">						pStmt.append(&quot; and B.ACTIVITYID in &quot;).append(jdmo.createInClause(activityCol));</span>
					}
<span class="nc" id="L1322">					DAOUtil.deleteObjects(jdmo, &quot;TIMERECORD&quot;, pStmt.toString());</span>
<span class="nc" id="L1323">					break;</span>
				case Config.ENDSIN:
<span class="nc" id="L1325">					pStmt.append(&quot;select A.ID from TIMERECORD A, TIMERECORDADJUSTMENT B where A.ISPOSTED=0 &quot;).</span>
<span class="nc" id="L1326">							append(&quot;and A.EMPLOYEEID=&quot;).append(wrID).append(&quot; and A.ID=B.TIMERECORDID&quot;);</span>
<span class="nc bnc" id="L1327" title="All 2 branches missed.">					if (type != 0) {</span>
<span class="nc" id="L1328">						pStmt.append(&quot; and B.TIMESOURCECODE=&quot;).append(type);</span>
					}
<span class="nc" id="L1330">					pStmt.append(&quot; and B.ENDTIME&gt;='&quot;).append(JdmoUtil.formatDBString(start)).append(&quot;' and B.ENDTIME&lt;'&quot;).append(JdmoUtil.formatDBString(end)).append(&quot;'&quot;);</span>
<span class="nc bnc" id="L1331" title="All 4 branches missed.">					if (activityCol != null &amp;&amp; !activityCol.isEmpty()) {</span>
<span class="nc" id="L1332">						pStmt.append(&quot; and B.ACTIVITYID in &quot;).append(jdmo.createInClause(activityCol));</span>
					}
<span class="nc" id="L1334">					DAOUtil.deleteObjects(jdmo, &quot;TIMERECORD&quot;, pStmt.toString());</span>
<span class="nc" id="L1335">					break;</span>
				default:
<span class="nc" id="L1337">					pStmt.append(&quot;select TIMERECORDID, STARTTIME, ENDTIME from TIMERECORD A, &quot;).</span>
<span class="nc" id="L1338">							append(&quot;TIMERECORDADJUSTMENT B where A.ISPOSTED=0 and A.EMPLOYEEID=? &quot;).append(&quot;and A.ID=B.TIMERECORDID&quot;);</span>
<span class="nc bnc" id="L1339" title="All 2 branches missed.">					if (type != 0) {</span>
<span class="nc" id="L1340">						pStmt.append(&quot; and B.TIMESOURCECODE=? &quot;);</span>
					}
<span class="nc" id="L1342">					pStmt.append(&quot; and B.STARTTIME&lt;=? and B.ENDTIME&gt;=?&quot;);</span>
<span class="nc bnc" id="L1343" title="All 4 branches missed.">					if (activityCol != null &amp;&amp; !activityCol.isEmpty()) {</span>
<span class="nc" id="L1344">						pStmt.append(&quot; and B.ACTIVITYID in &quot;).append(jdmo.createInClause(activityCol));</span>
					}
<span class="nc" id="L1346">					pStmt.append(&quot; order by B.STARTTIME asc&quot;);</span>
<span class="nc" id="L1347">					JdmoQuery jQuery2 = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L1348">					jQuery2.setParID(1, wrID);</span>
<span class="nc" id="L1349">					jQuery2.setParInt(2, type);</span>
<span class="nc" id="L1350">					jQuery2.setParTimestamp(3, end);</span>
<span class="nc" id="L1351">					jQuery2.setParTimestamp(4, start);</span>
					// Load the TimeIntervals
<span class="nc" id="L1353">					JdmoRowset rs = jdmo.createRowset(jQuery2, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L1354">					Collection trCol = new ArrayList(1);</span>
<span class="nc" id="L1355">					Date dtPeriodStart = TimeZoneUtil.toDate(start);</span>
<span class="nc" id="L1356">					Date dtPeriodEnd = TimeZoneUtil.toDate(end);</span>
<span class="nc" id="L1357">					Date dtStart = null;</span>
<span class="nc" id="L1358">					Date dtEnd = null;</span>
<span class="nc" id="L1359">					Date dtMidDate = null;</span>
<span class="nc bnc" id="L1360" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L1361">						dtStart = rs.getTimestamp(&quot;STARTTIME&quot;);</span>
<span class="nc" id="L1362">						dtEnd = rs.getTimestamp(&quot;ENDTIME&quot;);</span>
<span class="nc" id="L1363">						dtMidDate = new Date(dtStart.getTime() + (dtEnd.getTime() - dtStart.getTime()) / 2);</span>
<span class="nc bnc" id="L1364" title="All 2 branches missed.">						if (!dtMidDate.before(dtPeriodStart)</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">								&amp;&amp; dtMidDate.before(dtPeriodEnd)) {</span>
<span class="nc" id="L1366">							trCol.add(rs.getID(&quot;TIMERECORDID&quot;));</span>
						}
					}
<span class="nc bnc" id="L1369" title="All 2 branches missed.">					if (!trCol.isEmpty()) {</span>
<span class="nc" id="L1370">						DAOUtil.deleteObjects(jdmo, &quot;TIMERECORD&quot;, trCol);</span>
					}
			}
		} finally {
<span class="nc" id="L1374">			jdmo.cleanUp();</span>
<span class="nc" id="L1375">		}</span>
<span class="nc" id="L1376">	}</span>

	/**
	 * Remove an existing TimeRecordEntry by ID.
	 * &lt;p&gt;
	 * @param id
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void removeTimeRecordEntry(ID id)
			throws JdmoException {
<span class="nc" id="L1387">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L1389" title="All 2 branches missed.">			if (id != null) {</span>
<span class="nc" id="L1390">				ArrayList trCol = new ArrayList(1);</span>
<span class="nc" id="L1391">				trCol.add(id);</span>
<span class="nc" id="L1392">				DAOUtil.deleteObjects(jdmo, &quot;TIMEENTRYEVENT&quot;, trCol);</span>
			}
		} finally {
<span class="nc" id="L1395">			jdmo.cleanUp();</span>
<span class="nc" id="L1396">		}</span>
<span class="nc" id="L1397">	}</span>

	/**
	 * Update a TimeInterval value object.
	 * &lt;p&gt;
	 * @param interval
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void updateTimeIntervalOnly(TimeInterval interval)
			throws JdmoException {
<span class="nc" id="L1408">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1410">			StringBuffer pStmt = new StringBuffer(</span>
<span class="nc" id="L1411">					&quot;update TIMERECORDADJUSTMENT set ACTIVITYID=?, &quot;).append(</span>
<span class="nc" id="L1412">							&quot;TIMERECORDID=?, STARTTIME=?, ENDTIME=?, &quot;).append(</span>
<span class="nc" id="L1413">							&quot;COUNTTOWARDSMINUTES=?, TIMESOURCECODE=?, &quot;).append(</span>
							&quot;DESCRIPTION=?, ISPAID=? where ID=?&quot;);
<span class="nc" id="L1415">			Object[] param = new Object[9];</span>
<span class="nc" id="L1416">			param[0] = interval.getActivityID();</span>
<span class="nc" id="L1417">			param[1] = interval.getParentID();</span>
<span class="nc" id="L1418">			param[2] = TimeZoneUtil.toTimestamp(interval.getStartTime());</span>
<span class="nc" id="L1419">			param[3] = TimeZoneUtil.toTimestamp(interval.getEndTime());</span>
<span class="nc" id="L1420">			param[4] = new Integer(interval.getDuration());</span>
<span class="nc" id="L1421">			param[5] = new Integer(interval.getTimeSourceCode());</span>
<span class="nc bnc" id="L1422" title="All 2 branches missed.">			if (interval.getDescription() != null) {</span>
<span class="nc" id="L1423">				param[6] = interval.getDescription();</span>
			} else {
<span class="nc" id="L1425">				param[6] = new JdmoParam(null, Types.VARCHAR);</span>
			}
<span class="nc" id="L1427">			param[7] = JdmoParam.getObject(interval.getPaid());</span>
<span class="nc" id="L1428">			param[8] = interval.getID();</span>
<span class="nc" id="L1429">			jdmo.executePCommand(pStmt.toString(), param);</span>
		} finally {
<span class="nc" id="L1431">			jdmo.cleanUp();</span>
<span class="nc" id="L1432">		}</span>
<span class="nc" id="L1433">	}</span>

	/**
	 * Update TimeRecord and will check Mutli-User Exception.
	 * If there is checkMulti flag is set, it will utilize ChangeCounter to
	 * detect obsolete record.
	 * If there is lockTR flag is set, it will promote the SyncStatus of the
	 * TimeRecord to prevent backend operations on the TimeRecord.
	 * It is set to True, in createEndShift/approveTimeRecord operations.
	 * So at least an Exclusive lock is applied via &quot;update&quot; operation, and
	 * optimistic locking is optional to enforce via the boolean flag.
	 * All update operations will invoke this method to acquire the lock on
	 * TimeRecord.
	 * &lt;p&gt;
	 * @param record
	 * @param checkMulti if need to detect version change
	 * @param lockTR if need to update the syncStatus to forbid TimeCollection
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static int updateTimeRecord(TimeRecord record, boolean checkMulti, boolean lockTR)
			throws JdmoException {
<span class="nc" id="L1455">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1457">			StringBuffer pStmt = new StringBuffer(</span>
<span class="nc" id="L1458">					&quot;update TIMERECORD set &quot;).append(</span>
<span class="nc" id="L1459">							REMAKERCOLNAME).append(&quot;=?, LASTMODIFIEDAT=?, REMARK=?, &quot;).append(</span>
<span class="nc" id="L1460">							&quot;ISAPPROVED=?,&quot;).append(APPROVERCOLNAME).append(&quot;=?,&quot;).append(</span>
<span class="nc" id="L1461">							APPROVETIMECOLNAME).append(&quot;=?&quot;);</span>
<span class="nc" id="L1462">			int paramSize = 7;</span>
<span class="nc bnc" id="L1463" title="All 2 branches missed.">			if (lockTR) {</span>
<span class="nc" id="L1464">				pStmt.append(&quot;, CHANGESTATUS =?&quot;);</span>
<span class="nc" id="L1465">				++paramSize;</span>
			}
<span class="nc bnc" id="L1467" title="All 2 branches missed.">			if (checkMulti) {</span>
<span class="nc" id="L1468">				pStmt.append(&quot;, CHANGECOUNTER=?&quot;);</span>
<span class="nc" id="L1469">				++paramSize;</span>
			}
<span class="nc" id="L1471">			pStmt.append(&quot; where ISPOSTED=0 and ID=?&quot;);</span>
<span class="nc" id="L1472">			Object[] param = new Object[paramSize];</span>
<span class="nc bnc" id="L1473" title="All 2 branches missed.">			if (record.getRemarkEmployeeID() != null) {</span>
<span class="nc" id="L1474">				param[0] = record.getRemarkEmployeeID();</span>
			} else {
<span class="nc" id="L1476">				param[0] = new JdmoParam(null, Types.INTEGER);</span>
			}
<span class="nc" id="L1478">			param[1] = TimeZoneUtil.toTimestamp(new Date());</span>
<span class="nc bnc" id="L1479" title="All 2 branches missed.">			if (record.getDescription() != null) {</span>
<span class="nc" id="L1480">				param[2] = record.getDescription();</span>
			} else {
<span class="nc" id="L1482">				param[2] = new JdmoParam(null, Types.VARCHAR);</span>
			}
<span class="nc" id="L1484">			param[3] = JdmoParam.getObject(record.getApprove());</span>
<span class="nc bnc" id="L1485" title="All 2 branches missed.">			if (record.getApproverName() != null) {</span>
<span class="nc" id="L1486">				param[4] = record.getApproverName();</span>
			} else {
<span class="nc" id="L1488">				param[4] = new JdmoParam(null, Types.VARCHAR);</span>
			}
<span class="nc bnc" id="L1490" title="All 2 branches missed.">			if (record.getApproveTime() != null) {</span>
<span class="nc" id="L1491">				param[5] = record.getApproveTime();</span>
			} else {
<span class="nc" id="L1493">				param[5] = new JdmoParam(null, Types.TIMESTAMP);</span>
			}
<span class="nc bnc" id="L1495" title="All 2 branches missed.">			if (lockTR)</span>
			{
				// if it is 0, promote it to 1, if 1 to 1, then 2 to 2
<span class="nc bnc" id="L1498" title="All 2 branches missed.">				param[paramSize - 3] = new Short(record.getSyncStatus() == 0 ? 1 : record.getSyncStatus());</span>
			}
<span class="nc bnc" id="L1500" title="All 2 branches missed.">			if (checkMulti) {</span>
<span class="nc" id="L1501">				param[paramSize - 2] = new Long(record.getVersion());</span>
			}
<span class="nc" id="L1503">			param[paramSize - 1] = record.getID();</span>
<span class="nc" id="L1504">			return jdmo.executePCommand(pStmt.toString(), param);</span>
		} finally {
<span class="nc" id="L1506">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Update a TimeRecordEntry.
	 * &lt;p&gt;
	 * @param entry
	 * @param b_ResetImmidiateToLastActivity
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static int updateTimeRecordEntry(TimeRecordEntry entry, boolean b_ResetImmidiateToLastActivity)
			throws JdmoException {
<span class="nc" id="L1520">		Jdmo jdmo = new Jdmo();</span>
		try {

<span class="nc bnc" id="L1523" title="All 2 branches missed.">			if (b_ResetImmidiateToLastActivity) {</span>
<span class="nc" id="L1524">				Cache b_cache = CacheFactory.getCache(MYTIME_EMP_LAST_ACT_CACHE, TimeRecordDAO.class.getClassLoader());</span>

<span class="nc" id="L1526">				String sValue = (String)b_cache.get(&quot;Emp_Last_Act&quot; + &quot;_&quot; + entry.getEmployeeID());</span>
<span class="nc bnc" id="L1527" title="All 2 branches missed.">				if (sValue == null) {</span>
					//last act was not found in cache, look in DB
<span class="nc" id="L1529">					ID lastactID = getEmpLastActFromDB(entry.getEmployeeID());</span>
<span class="nc bnc" id="L1530" title="All 2 branches missed.">					if (lastactID != null) {</span>
<span class="nc bnc" id="L1531" title="All 2 branches missed.">						if (entry.getActivityID().toString().equals(&quot;-4101&quot;)) {</span>
<span class="nc bnc" id="L1532" title="All 2 branches missed.">							if (lastactID.toString().compareToIgnoreCase(&quot;-4001&quot;) != 0) {</span>
<span class="nc" id="L1533">								entry.setActivityID(lastactID);</span>
							}
						}
					}
<span class="nc" id="L1537">				} else {</span>
<span class="nc bnc" id="L1538" title="All 2 branches missed.">					if (entry.getActivityID().toString().equals(&quot;-4101&quot;)) {</span>
<span class="nc" id="L1539">						entry.setActivityID(new ID(sValue));</span>
					}
				}
			}

			// TimeEntryEvent cannot be moved to another TimeRecord,
			// so no need to update TIMERECORDID, EMPLOYEEID, and RAWTIMEENTRYID
<span class="nc" id="L1546">			StringBuffer pStmt = new StringBuffer(</span>
<span class="nc" id="L1547">					&quot;update TIMEENTRYEVENT set ACTIVITYID=?, &quot;).append(</span>
<span class="nc" id="L1548">							&quot; STARTTIME=?, UPDATETIMESTAMP=?, &quot;).append(</span>
<span class="nc" id="L1549">							&quot;TIMESOURCECODE=?, DESCRIPTION=?, ISPAID=?, &quot;).append(</span>
							&quot;LASTMODIFIEDAT=?, MODIFIEDBY=? where ID=?&quot;);
<span class="nc" id="L1551">			Object[] param = new Object[9];</span>
<span class="nc" id="L1552">			param[0] = entry.getActivityID();</span>
<span class="nc" id="L1553">			param[1] = TimeZoneUtil.toTimestamp(entry.getStartTime());</span>
<span class="nc" id="L1554">			param[2] = BigDecimal.valueOf(entry.getSortTime().getTime());</span>
<span class="nc" id="L1555">			param[3] = new Integer(entry.getTimeSourceCode());</span>
<span class="nc bnc" id="L1556" title="All 2 branches missed.">			if (entry.getDescription() != null) {</span>
<span class="nc" id="L1557">				param[4] = entry.getDescription();</span>
			} else {
<span class="nc" id="L1559">				param[4] = new JdmoParam(null, Types.VARCHAR);</span>
			}
<span class="nc" id="L1561">			param[5] = JdmoParam.getObject(entry.getPaid());</span>
<span class="nc bnc" id="L1562" title="All 2 branches missed.">			if (entry.getLastModifiedTime() != null) {</span>
<span class="nc" id="L1563">				param[6] = TimeZoneUtil.toTimestamp(entry.getLastModifiedTime());</span>
			} else {
<span class="nc" id="L1565">				param[6] = TimeZoneUtil.toTimestamp(new Date());</span>
			}
<span class="nc bnc" id="L1567" title="All 2 branches missed.">			if (entry.getModifier() != null) {</span>
<span class="nc" id="L1568">				param[7] = entry.getModifier();</span>
			} else {
<span class="nc" id="L1570">				param[7] = new JdmoParam(null, Types.VARCHAR);</span>
			}
<span class="nc" id="L1572">			param[8] = entry.getID();</span>
<span class="nc" id="L1573">			return jdmo.executePCommand(pStmt.toString(), param);</span>
<span class="nc" id="L1574">		} catch (Exception e) {</span>
<span class="nc" id="L1575">			throw new JdmoException(e);</span>
		} finally {
<span class="nc" id="L1577">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Mainly used by RemoveTimeRecord function to just update the TimeRecord timestamp, and is for backend only.
	 * &lt;p&gt;
	 * @param timeRecordID
	 * @param jdmo
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static int updateTimeRecordTimeStamp(ID timeRecordID, Jdmo jdmo)
			throws JdmoException {
<span class="nc" id="L1591">		Object[] param = new Object[2];</span>
<span class="nc" id="L1592">		param[0] = TimeZoneUtil.toTimestamp(new Date());</span>
<span class="nc" id="L1593">		param[1] = timeRecordID;</span>
<span class="nc" id="L1594">		int updated = 0;</span>
<span class="nc" id="L1595">		jdmo.executePCommand(&quot;update TIMERECORD set LASTMODIFIEDAT=? where ID=?&quot;, param);</span>
<span class="nc" id="L1596">		return updated;</span>
	} // updateTimeRecordTimeStamp

	/**
	 * Mainly used by RemoveTimeRecord function to remove all Entries, and is for backend only.
	 * &lt;p&gt;
	 * @param timeRecordID
	 * @param jdmo
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void removeTimeRecordEntries(ID timeRecordID, Jdmo jdmo)
			throws JdmoException {
<span class="nc" id="L1609">		Object[] param = new Object[1];</span>
<span class="nc" id="L1610">		param[0] = timeRecordID;</span>
<span class="nc" id="L1611">		jdmo.executePCommand(&quot;delete TIMEENTRYEVENT where TIMERECORDID=?&quot;, param);</span>
<span class="nc" id="L1612">	} // updateTimeRecordEntries</span>

	/**
	 * Find last open TimeRecordEntry before a given time, only retrieve TimeRecordID, StartTime/SortTime, ActivityID.
	 * &lt;p&gt;
	 * @param workResourceID
	 * @param dtStart
	 * &lt;p&gt;
	 * @return TimeRecordEntry, if find any, null means no such time record
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static TimeRecordEntry findLastTimeEntry(ID workResourceID, Date dtStart)
			throws JdmoException {
<span class="fc" id="L1626">		Jdmo jdmo = new Jdmo();</span>
		try {
			// TimeEntryEvent table is denormailzed, so no need to join TimeRecord table to get EMPLOYEEID information
<span class="fc" id="L1629">			String pStmt</span>
					= &quot;select b.TIMERECORDID, b.STARTTIME, b.UPDATETIMESTAMP, b.ACTIVITYID from TIMEENTRYEVENT b where b.UPDATETIMESTAMP=(select max(b2.UPDATETIMESTAMP) from TIMEENTRYEVENT b2 where b.TIMERECORDID=b2.TIMERECORDID and b2.UPDATETIMESTAMP&lt;=? and b2.EMPLOYEEID=?)&quot;;
<span class="fc" id="L1631">			JdmoQuery jQuery = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="pc bpc" id="L1632" title="1 of 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L1633">				jQuery.setParLong(1, DateAdjustmentUtil.adjustEndDateForDemo(dtStart, m_ignoreFutureData).getTime());</span>
			} else {
<span class="fc" id="L1635">				jQuery.setParLong(1, dtStart.getTime());</span>
			}
<span class="fc" id="L1637">			jQuery.setParID(2, workResourceID);</span>
<span class="fc" id="L1638">			JdmoRowset rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="fc bfc" id="L1639" title="All 2 branches covered.">			if (rs.next()) {</span>
<span class="fc" id="L1640">				ID actID = rs.getID(&quot;ACTIVITYID&quot;);</span>
<span class="pc bpc" id="L1641" title="1 of 2 branches missed.">				if (!actID.equals(Activity.ACTIVITY_NONE)) {</span>
<span class="nc" id="L1642">					Date start = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L1643">					TimeRecordEntry entry = new TimeRecordEntry(actID, start, start, 0, false, null);</span>
<span class="nc" id="L1644">					entry.setEmployeeID(workResourceID);</span>
<span class="nc" id="L1645">					entry.setParentID(rs.getID(&quot;TIMERECORDID&quot;));</span>
<span class="nc" id="L1646">					entry.setSortTime(new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)));</span>
<span class="nc" id="L1647">					return entry;</span>
				}
			}
<span class="fc" id="L1650">			return null;</span>
		} finally {
<span class="pc" id="L1652">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Returns a collection of the last time entries, using a default lookback value of two weeks.  Used to find out who is active in the system (open shift).
	 * &lt;p&gt;
	 * @param empCol
	 * @param date
	 * &lt;p&gt;
	 * @return
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static Collection findLastEntry(Collection empCol, Date date)
			throws JdmoException {
		//by default we will look back 14 days for open shift.
<span class="nc" id="L1669">		return findLastEntry(empCol, date, 14 * TimeZoneUtil.DAY_IN_MILLISECONDS_LONG);</span>
	}

	/**
	 * Returns a collection of the last time entries, using a given lookback.  Used to find out who is active in the system (open shift).
	 * &lt;p&gt;
	 * @param empCol
	 * @param date
	 * @param numDayLookback
	 * &lt;p&gt;
	 * @return
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static Collection findLastEntry(Collection empCol, Date date, long numDayLookback)
			throws JdmoException {
<span class="fc" id="L1685">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="fc" id="L1687">			long currentMilli = System.currentTimeMillis();</span>
<span class="pc bpc" id="L1688" title="5 of 6 branches missed.">			currentMilli = (date == null || (m_ignoreFutureData &amp;&amp; date.getTime() &gt; currentMilli)) ? currentMilli : date.getTime();</span>
<span class="fc" id="L1689">			StringBuffer pStmt = new StringBuffer(1000);</span>
<span class="fc" id="L1690">			String empInClause = jdmo.createInClause(empCol);</span>
<span class="fc" id="L1691">			String tempTable = &quot;emplatest&quot;;</span>
			// From JDMO get real temp table name
<span class="fc" id="L1693">			String realTempTable = jdmo.getNativeTemptableName(tempTable);</span>
			// Drop temp first
			try {
<span class="fc" id="L1696">				jdmo.dropTempTable(tempTable);</span>
<span class="nc" id="L1697">			} catch (JdmoException e) {</span>
<span class="fc" id="L1698">			}</span>
			// Create a new temp table
<span class="fc" id="L1700">			StringBuffer strSQLCreate = new StringBuffer();</span>
<span class="fc" id="L1701">			strSQLCreate.append(realTempTable);</span>
<span class="fc" id="L1702">			strSQLCreate.append(&quot; (UPDATETIMESTAMP decimal(17,0), EMPLOYEEID int)&quot;);</span>
<span class="fc" id="L1703">			jdmo.createTempTable(strSQLCreate.toString());</span>
			// Insert data into temp table
<span class="fc" id="L1705">			StringBuffer pInsert = new StringBuffer(&quot;insert into &quot;);</span>
<span class="fc" id="L1706">			pInsert.append(realTempTable).append(&quot; select MAX(updatetimestamp),&quot;);</span>
<span class="fc" id="L1707">			pInsert.append(&quot; b2.employeeid FROM timeentryevent b2&quot;);</span>
<span class="fc" id="L1708">			pInsert.append(&quot; WHERE b2.updatetimestamp&lt;=&quot;).append(currentMilli).append(&quot; AND b2.updatetimestamp&gt;=&quot;).append(currentMilli - numDayLookback).</span>
<span class="fc" id="L1709">					append(&quot; and b2.employeeID in &quot;).append(empInClause);</span>
<span class="fc" id="L1710">			pInsert.append(&quot; GROUP BY b2.employeeid&quot;);</span>
<span class="fc" id="L1711">			jdmo.executeCommand(pInsert.toString());</span>
			// now select again
<span class="fc" id="L1713">			pStmt.append(&quot;select distinct b.EMPLOYEEID, b.ID, b.ACTIVITYID, &quot;).</span>
<span class="fc" id="L1714">					append(&quot;RAWTIMEENTRYID, TIMERECORDID, STARTTIME, b.UPDATETIMESTAMP, TIMESOURCECODE, B.DATASOURCEID, &quot;).</span>
<span class="fc" id="L1715">					append(&quot;LASTMODIFIEDAT, MODIFIEDBY, ISPAID, DESCRIPTION&quot;).</span>
<span class="fc" id="L1716">					append(&quot; from &quot;).append(realTempTable).append(&quot; t, TIMEENTRYEVENT b where t.EMPLOYEEID=b.EMPLOYEEID and&quot;).</span>
<span class="fc" id="L1717">					append(&quot; b.UPDATETIMESTAMP=t.UPDATETIMESTAMP&quot;);</span>
<span class="fc" id="L1718">			JdmoRowset rs = jdmo.createRowset(pStmt.toString(), Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="fc" id="L1719">			ArrayList entryList = new ArrayList(empCol.size());</span>
<span class="pc bpc" id="L1720" title="1 of 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1721">				Date start = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L1722">				TimeRecordEntry entry = new TimeRecordEntry(rs.getID(&quot;ID&quot;),</span>
<span class="nc" id="L1723">						rs.getID(&quot;RAWTIMEENTRYID&quot;),</span>
<span class="nc" id="L1724">						rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L1725">						rs.getID(&quot;DATASOURCEID&quot;),</span>
						start,
						start,
<span class="nc" id="L1728">						new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)),</span>
<span class="nc" id="L1729">						rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L1730">						rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L1731">						rs.getString(&quot;DESCRIPTION&quot;));</span>
<span class="nc" id="L1732">				entry.setEmployeeID(rs.getID(&quot;EMPLOYEEID&quot;));</span>
<span class="nc" id="L1733">				entry.setParentID(rs.getID(&quot;TIMERECORDID&quot;));</span>
<span class="nc" id="L1734">				entry.setLastModifiedTime(TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)));</span>
<span class="nc" id="L1735">				entry.setModifier(rs.getString(&quot;MODIFIEDBY&quot;));</span>
<span class="nc" id="L1736">				entryList.add(entry);</span>
<span class="nc" id="L1737">			}</span>
<span class="fc" id="L1738">			return entryList;</span>
		} finally {
<span class="pc" id="L1740">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Returns a collection of the last time entries.  Used to find out who is active in the system (open shift).
	 * &lt;p&gt;
	 * @return Collection, those have Open Shift
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static Collection findLastEntries()
			throws JdmoException {
<span class="nc" id="L1753">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1755">			long currentMilli = System.currentTimeMillis();</span>
<span class="nc" id="L1756">			String tempTable = &quot;empdatasourcelatest&quot;;</span>
			// From JDMO get real temp table name
<span class="nc" id="L1758">			String realTempTable = jdmo.getNativeTemptableName(tempTable);</span>
			// Drop temp first
			try {
<span class="nc" id="L1761">				jdmo.dropTempTable(tempTable);</span>
<span class="nc" id="L1762">			} catch (JdmoException e) {</span>
<span class="nc" id="L1763">			}</span>
			// Create a new temp table
<span class="nc" id="L1765">			StringBuffer strSQLCreate = new StringBuffer();</span>
<span class="nc" id="L1766">			strSQLCreate.append(realTempTable);</span>
<span class="nc" id="L1767">			strSQLCreate.append(&quot; (UPDATETIMESTAMP decimal(17,0), EMPLOYEEID int, DATASOURCEID int)&quot;);</span>
<span class="nc" id="L1768">			jdmo.createTempTable(strSQLCreate.toString());</span>
			// Insert data into temp table
<span class="nc" id="L1770">			StringBuffer pInsert = new StringBuffer(&quot;insert into &quot;);</span>
<span class="nc" id="L1771">			pInsert.append(realTempTable).append(&quot; select max(UPDATETIMESTAMP), &quot;).</span>
<span class="nc" id="L1772">					append(&quot;b2.EMPLOYEEID, b2.DATASOURCEID from TIMEENTRYEVENT b2, DATASOURCE d&quot;).</span>
<span class="nc" id="L1773">					append(&quot; where b2.UPDATETIMESTAMP&lt;=&quot;).append(currentMilli).</span>
<span class="nc" id="L1774">					append(&quot; and d.ISMANAGED=1 &quot;).append(&quot;and (b2.DATASOURCEID=d.ID or b2.DATASOURCEID is NULL)&quot;).</span>
<span class="nc" id="L1775">					append(&quot; group by b2.EMPLOYEEID, b2.DATASOURCEID&quot;);</span>
<span class="nc" id="L1776">			jdmo.executeCommand(pInsert.toString());</span>
			// now select again
<span class="nc" id="L1778">			StringBuffer pStmt = new StringBuffer(300);</span>
<span class="nc" id="L1779">			pStmt.append(&quot;select distinct b.EMPLOYEEID, b.ID, b.ACTIVITYID, &quot;).</span>
<span class="nc" id="L1780">					append(&quot;RAWTIMEENTRYID, TIMERECORDID, STARTTIME, b.UPDATETIMESTAMP, TIMESOURCECODE, B.DATASOURCEID, &quot;).</span>
<span class="nc" id="L1781">					append(&quot;LASTMODIFIEDAT, MODIFIEDBY, ISPAID, DESCRIPTION&quot;).</span>
<span class="nc" id="L1782">					append(&quot; from &quot;).append(realTempTable).append(&quot; t, TIMEENTRYEVENT b where t.EMPLOYEEID=b.EMPLOYEEID and&quot;).</span>
<span class="nc" id="L1783">					append(&quot;  (b.DATASOURCEID = T.DATASOURCEID or &quot;).</span>
<span class="nc" id="L1784">					append(&quot; (t.DATASOURCEID is NULL and b.DATASOURCEID is NULL)) and &quot;).</span>
<span class="nc" id="L1785">					append(&quot; b.UPDATETIMESTAMP=t.UPDATETIMESTAMP&quot;);</span>
<span class="nc" id="L1786">			JdmoRowset rs = jdmo.createRowset(pStmt.toString(), Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L1787">			ArrayList entryList = new ArrayList(1000);</span>
<span class="nc bnc" id="L1788" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1789">				Date start = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L1790">				TimeRecordEntry entry = new TimeRecordEntry(rs.getID(&quot;ID&quot;),</span>
<span class="nc" id="L1791">						rs.getID(&quot;RAWTIMEENTRYID&quot;),</span>
<span class="nc" id="L1792">						rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L1793">						rs.getID(&quot;DATASOURCEID&quot;),</span>
						start,
						start,
<span class="nc" id="L1796">						new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)),</span>
<span class="nc" id="L1797">						rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L1798">						rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L1799">						rs.getString(&quot;DESCRIPTION&quot;));</span>
<span class="nc" id="L1800">				entry.setEmployeeID(rs.getID(&quot;EMPLOYEEID&quot;));</span>
<span class="nc" id="L1801">				entry.setParentID(rs.getID(&quot;TIMERECORDID&quot;));</span>
<span class="nc" id="L1802">				entry.setLastModifiedTime(TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)));</span>
<span class="nc" id="L1803">				entry.setModifier(rs.getString(&quot;MODIFIEDBY&quot;));</span>
<span class="nc" id="L1804">				entryList.add(entry);</span>
<span class="nc" id="L1805">			}</span>
<span class="nc" id="L1806">			return entryList;</span>
		} finally {
<span class="nc" id="L1808">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Sets the last activity the employee was working on in the MY TIME cache.
	 * &lt;p&gt;
	 * @param empID
	 * @param activityID
	 * &lt;p&gt;
	 * @throws Exception
	 */
	public static void setEmpLastActCache(ID empID, ID activityID)
			throws Exception {
<span class="nc bnc" id="L1822" title="All 2 branches missed.">		if (cacheEnabled) {</span>
<span class="nc" id="L1823">			Cache a_cache = CacheFactory.getCache(MYTIME_EMP_LAST_ACT_CACHE, TimeRecordDAO.class.getClassLoader());</span>
<span class="nc" id="L1824">			a_cache.put(&quot;Emp_Last_Act&quot; + &quot;_&quot; + empID, activityID.toString());</span>
		}
<span class="nc" id="L1826">	}</span>

	/**
	 * Gets the last activity the employee was working on from the database.
	 * &lt;p&gt;
	 * @param employeeID
	 * &lt;p&gt;
	 * @return
	 * &lt;p&gt;
	 * @throws Exception
	 */
	private static ID getEmpLastActFromDB(ID employeeID)
			throws Exception {
<span class="nc" id="L1839">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1841">			Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L1842">			cal.setTime(new Date());</span>
<span class="nc" id="L1843">			cal.add(Calendar.DAY_OF_MONTH, -1);</span>

<span class="nc" id="L1845">			String selectedFields = &quot;ACTIVITYID&quot;;</span>
<span class="nc" id="L1846">			String tableName = &quot;TIMEENTRYEVENT&quot;;</span>
<span class="nc" id="L1847">			StringBuffer where = new StringBuffer();</span>
<span class="nc" id="L1848">			where.append(&quot; EMPLOYEEID = &quot;).append(employeeID.toInt())</span>
<span class="nc" id="L1849">					.append(&quot; AND DATASOURCEID IS NULL&quot;)</span>
<span class="nc" id="L1850">					.append(&quot; AND STARTTIME &gt; '&quot;).append(JdmoUtil.formatDBString(cal.getTime())).append(&quot;'&quot;)</span>
<span class="nc" id="L1851">					.append(&quot; AND ACTIVITYID != -4001 and TIMESOURCECODE in (1,5) &quot;);</span>
<span class="nc bnc" id="L1852" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L1853">				where.append(&quot;AND UPDATETIMESTAMP&lt;=&quot; + System.currentTimeMillis() + &quot; &quot;);</span>
			}

<span class="nc" id="L1856">			String orderByFields = &quot;STARTTIME DESC&quot;;</span>
<span class="nc" id="L1857">			int nRows = 1;</span>

<span class="nc" id="L1859">			String query = jdmo.getSelectTopNRows(selectedFields, tableName, where.toString(), orderByFields, nRows, false);</span>

<span class="nc" id="L1861">			JdmoRowset rs = jdmo.createRowset(query);</span>

<span class="nc" id="L1863">			ID actID = null;</span>
<span class="nc bnc" id="L1864" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1865">				actID = rs.getID(&quot;ACTIVITYID&quot;);</span>
			}

<span class="nc bnc" id="L1868" title="All 2 branches missed.">			if (actID != null) {</span>
<span class="nc" id="L1869">				setEmpLastActCache(employeeID, actID);</span>
			}
<span class="nc" id="L1871">			return actID;</span>
		} finally {
<span class="nc" id="L1873">			jdmo.cleanUp();</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>