<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DeleteActivityDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.facade.delete.ejb</a> &gt; <span class="el_source">DeleteActivityDAO.java</span></div><h1>DeleteActivityDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.facade.delete.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.localization.DefaultLocalizationManager;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bpx.auxcodeactivity.ejb.AuxCodeActivityManager;
import com.bluepumpkin.ejb.facade.l10n.FacadeEjbBundleKey;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.setup.autoprocessing.ejb.AutoProcessingRuleManager;
import com.bluepumpkin.ejb.rm.setup.autoprocessing.model.AutoProcessingRule;
import com.bluepumpkin.ejb.rm.setup.filingrules.ejb.RequestFilingRuleManager;
import com.bluepumpkin.ejb.rm.setup.filingrules.model.RequestFilingRule;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.bbm.LinkedObject;
import com.witness.ejb.bbm.delete.DeleteException;
import com.witness.ejb.bbm.delete.DeleteableObjectPlugin;
import com.witness.ejb.bbm.delete.ejb.DAOUtil;
import com.witness.ejb.bbm.delete.model.BPObjectInfo;
import com.witness.ejb.bbm.delete.model.DeletionResult;

/**
 * Title:        Blue Pumpkin Software Facade Module
 * Description:  handle the delete operation of activity
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       lixin zhang
 * @version      1.0
 */

public class DeleteActivityDAO implements DeleteableObjectPlugin {

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;


<span class="fc" id="L49">	public DeleteActivityDAO() {</span>
<span class="fc" id="L50">	}</span>

	/**
	 * check if activity is linked to other objects by check the link tables
	 *       ActivityMapping,
	 *       AgentState, AuxCodeActivity, DataSourceState,
	 *       ImportedEvent,
	 *       RawTimeEntry, TimeEntryEvent, TimeRecordAdjustMent
	 *       WorkRuleParamValue
	 *
	 * @return DeletionResult
	 *    1) if activity is linked to work rule, set ResultCode to PROHIBIT_DELETE
	 *       and fill DeleteResult.m_colLinkedObject with linked work rule (ID, Name)s
	 *    2) if activity is linked to data source, set ResultCode to PROHIBIT_DELETE
	 *       and fill DeleteResult.m_colLinkedObject with linked datasource (ID, Name)s
	 *    3) if activity is linked to some other objects
	 *       set ResultCode to INACTIVATED
	 *    4) if activity is linked to no other object, set ResultCode to DELETED
	 */
	private DeletionResult checkLinkedObjects(ID idActivity, Jdmo dmo) throws Exception
	{
<span class="fc" id="L71">			DeletionResult dResult = new DeletionResult();</span>

			// check work rule and data source links
<span class="fc" id="L74">			Collection colLinkedObjects = new ArrayList();</span>

			// load linked work rule object
<span class="fc" id="L77">			StringBuffer strSQL = new StringBuffer();</span>
<span class="fc" id="L78">			strSQL.append(&quot;select ID, NAME from WORKRULE where ID in &quot;);</span>
<span class="fc" id="L79">			strSQL.append(&quot;(select distinct WORKRULEID from WORKRULEPARAMVALUE where ACTIVITYID = &quot;);</span>
<span class="fc" id="L80">			strSQL.append(idActivity.toString()).append(&quot;)&quot;);</span>

<span class="fc" id="L82">			DAOUtil.loadLinkedObjects(colLinkedObjects, new String(strSQL), BPObjectInfo.BPOBJECT_WORKRULE,</span>
					BbmEjbBundleKey.BUNDLE_NAME, BbmEjbBundleKey.OBJECT_WORK_RULE, dmo);

			// load linked shift object
<span class="fc" id="L86">			strSQL = new StringBuffer();</span>
			//Tample changed for QA 79327
<span class="fc" id="L88">			strSQL.append(&quot;select 1 ID,NAME from SHIFT where DELETEONDATE is NULL AND ACTIVITYID = &quot;);</span>
<span class="fc" id="L89">			strSQL.append(idActivity);</span>

<span class="fc" id="L91">			DAOUtil.loadLinkedObjects(colLinkedObjects, new String(strSQL), BPObjectInfo.BPOBJECT_SHIFT,</span>
					FacadeEjbBundleKey.BUNDLE_NAME, FacadeEjbBundleKey.OBJECT_SHIFT, dmo);

			// load linked shift OT Extension object
<span class="fc" id="L95">			strSQL = new StringBuffer();</span>
<span class="fc" id="L96">			strSQL.append(&quot;select 1 ID,NAME from SHIFTOTEXTENSION where DELETEONDATE is NULL and ACTIVITYID = &quot;);</span>
<span class="fc" id="L97">			strSQL.append(idActivity);</span>

<span class="fc" id="L99">			DAOUtil.loadLinkedObjects(colLinkedObjects, new String(strSQL), BPObjectInfo.BPOBJECT_SHIFTOTEXTENSION,</span>
					FacadeEjbBundleKey.BUNDLE_NAME, FacadeEjbBundleKey.OBJECT_SHIFTOTEXTENSION, dmo);

			// load linked live shift event objects
<span class="fc" id="L103">			strSQL = new StringBuffer();</span>
			//Tample changed for QA 79327
<span class="fc" id="L105">			strSQL.append(&quot;select 1 ID,NAME from SHIFTEVENT where DELETEONDATE is NULL AND ACTIVITYID = &quot;);</span>
<span class="fc" id="L106">			strSQL.append(idActivity);</span>
			
<span class="fc" id="L108">			DAOUtil.loadLinkedObjects(colLinkedObjects, new String(strSQL), BPObjectInfo.BPOBJECT_SHIFTEVENT,</span>
					FacadeEjbBundleKey.BUNDLE_NAME, FacadeEjbBundleKey.OBJECT_SHIFTEVENT, dmo);

			// load linked notification rule objects
<span class="fc" id="L112">			strSQL = new StringBuffer();</span>
<span class="fc" id="L113">			strSQL.append(&quot;select ID, NAME from NOTIFYRULE where ID in &quot;);</span>
<span class="fc" id="L114">			strSQL.append(&quot;(select distinct NOTIFYRULEID from NOTIFYRULEPARAM where ACTIVITYID = &quot;);</span>
<span class="fc" id="L115">			strSQL.append(idActivity.toString()).append(&quot;)&quot;);</span>

<span class="fc" id="L117">			DAOUtil.loadLinkedObjects(colLinkedObjects, new String(strSQL), BPObjectInfo.BPOBJECT_NOTIFICATIONRULE,</span>
					FacadeEjbBundleKey.BUNDLE_NAME, FacadeEjbBundleKey.OBJECT_NOTIFICAITON_RULE, dmo);

			// load linked autoprocessing rule objects
<span class="fc" id="L121">			strSQL = new StringBuffer();</span>
<span class="fc" id="L122">			strSQL.append(&quot;select ID,'' NAME from autoprocessingrule where ACTIVITYID = &quot;);</span>
<span class="fc" id="L123">			strSQL.append(idActivity);</span>

<span class="fc" id="L125">			DAOUtil.loadLinkedObjects(colLinkedObjects, new String(strSQL), BPObjectInfo.BPOBJECT_AUTOPROCESSING_RULE,</span>
					RmEjbBundleKey.BUNDLE_NAME, RmEjbBundleKey.OBJECT_AUTOPROCESSING_RULE, dmo);

			// load linked filing rule objects
<span class="fc" id="L129">			strSQL = new StringBuffer();</span>
<span class="fc" id="L130">			strSQL.append(&quot;select ID,'' NAME from requestfilingrule where ACTIVITYID = &quot;);</span>
<span class="fc" id="L131">			strSQL.append(idActivity);</span>

<span class="fc" id="L133">			DAOUtil.loadLinkedObjects(colLinkedObjects, new String(strSQL), BPObjectInfo.BPOBJECT_FILING_RULE,</span>
					RmEjbBundleKey.BUNDLE_NAME, RmEjbBundleKey.OBJECT_FILING_RULE, dmo);

			// load linked data source object
/*			strSQL = new StringBuffer();

			strSQL.append(&quot;select ID, NAME from DATASOURCE where ID in &quot;);
			strSQL.append(&quot;(select DATASOURCEID from DATASOURCESTATE where ACTIVITYID = &quot;);
			strSQL.append(idActivity.toString()).append(&quot;)&quot;);

			DAOUtil.loadLinkedObjects(colLinkedObjects, new String(strSQL), BPObjectInfo.BPOBJECT_DATASOURCE, dmo);
*/
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">			if (colLinkedObjects.size() &gt; 0)</span>
			{
<span class="nc" id="L147">					dResult.setResultCode(DeletionResult.PROHIBIT_DELETE);</span>
<span class="nc" id="L148">					dResult.setLinkedObjects(colLinkedObjects);</span>
<span class="nc" id="L149">					return dResult;</span>
			}

			// check other links
<span class="fc" id="L153">			dResult.setResultCode(DeletionResult.INACTIVATED);</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">			if (DAOUtil.isObjectLinkedTo(idActivity, &quot;SHIFTASSIGNMENT&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L155">				 return dResult;</span>

<span class="pc bpc" id="L157" title="1 of 2 branches missed.">			if (DAOUtil.isObjectLinkedTo(idActivity, &quot;SHIFTASSIGNMENTPUB&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L158">				 return dResult;</span>

<span class="pc bpc" id="L160" title="1 of 2 branches missed.">			if (DAOUtil.isObjectLinkedTo(idActivity, &quot;SHIFTEVENTASSIGNMENT&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L161">				 return dResult;</span>

<span class="pc bpc" id="L163" title="1 of 2 branches missed.">			if (DAOUtil.isObjectLinkedTo(idActivity, &quot;SHIFTEVENTASSIGNMENTPUB&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L164">				 return dResult;</span>

<span class="pc bpc" id="L166" title="1 of 2 branches missed.">			if (DAOUtil.isObjectLinkedTo(idActivity, &quot;CALENDAREVENTASSIGNMENT&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L167">				 return dResult;</span>

<span class="pc bpc" id="L169" title="1 of 2 branches missed.">			if (DAOUtil.isObjectLinkedTo(idActivity, &quot;CALENDAREVENTASSIGNMENTPUB&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L170">				 return dResult;</span>

<span class="pc bpc" id="L172" title="1 of 2 branches missed.">			if (DAOUtil.isObjectLinkedTo(idActivity, &quot;CALENDAREVENTTEMPLATE&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L173">				 return dResult;</span>

<span class="pc bpc" id="L175" title="1 of 2 branches missed.">			if (DAOUtil.isObjectLinkedTo(idActivity, &quot;IMPORTEDEVENT&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L176">				 return dResult;</span>

<span class="pc bpc" id="L178" title="1 of 2 branches missed.">			if (DAOUtil.isObjectLinkedTo(idActivity, &quot;RAWTIMEENTRY&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L179">				 return dResult;</span>

<span class="pc bpc" id="L181" title="1 of 2 branches missed.">			if (DAOUtil.isObjectLinkedTo(idActivity, &quot;HAATIMEENTRY&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L182">				   return dResult;</span>

<span class="pc bpc" id="L184" title="1 of 2 branches missed.">			if (DAOUtil.isObjectLinkedTo(idActivity, &quot;TIMEENTRYEVENT&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L185">				 return dResult;</span>

<span class="pc bpc" id="L187" title="1 of 2 branches missed.">			if (DAOUtil.isObjectLinkedTo(idActivity, &quot;TIMERECORDADJUSTMENT&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L188">				 return dResult;</span>

<span class="pc bpc" id="L190" title="1 of 2 branches missed.">			 if (DAOUtil.isObjectLinkedTo(idActivity, &quot;TIMEOFFREQUEST&quot;, &quot;ACTIVITYID&quot;, dmo))</span>
<span class="nc" id="L191">				 return dResult;</span>
		    
		    //mark the record as deleted if it is only linked to dead shift event.
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">		    if (DAOUtil.isObjectLinkedTo(idActivity, &quot;SHIFTEVENT&quot;, &quot;DELETEONDATE != NULL AND A.ACTIVITYID &quot;, dmo))</span>
<span class="nc" id="L195">		    	return dResult;</span>
		    
		    //mark the record as deleted if it is only linked to dead shift OT extension.
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">		    if (DAOUtil.isObjectLinkedTo(idActivity, &quot;SHIFTOTEXTENSION&quot;, &quot;DELETEONDATE != NULL AND A.ACTIVITYID &quot;, dmo))</span>
<span class="nc" id="L199">		    	return dResult;</span>

			// not linked, or only linked to ACTIVITYMAPPING, AGENTSTATE, AUXCODEACTIVITY
			// do cascade delete
<span class="fc" id="L203">			dResult.setResultCode(DeletionResult.DELETED);</span>
<span class="fc" id="L204">			return dResult;</span>
	}

	/**
	 *  delete activity implements the following algorithms
	 *  1) call checkLinkedObjects() to check if activity is linked to any other objects
	 *  2) if activity linked to WorkRule or DataSource objects
	 *     deny the deletion.
	 *  3) if activity linked to no other object, delete it.
	 *  4) otherwise, mark activity as deleted (inactive)
	 *
	 */
	public DeletionResult deleteObject(ID idObject,
					Date dtDeleteOnDate, Localizer localizer, Object objCustomDefined)
					throws DeleteException
	{
<span class="fc" id="L220">			Jdmo dmo = new Jdmo(false);</span>
			try
			{
<span class="fc" id="L223">					DeletionResult dResult = checkLinkedObjects(idObject, dmo);</span>
<span class="pc bpc" id="L224" title="3 of 4 branches missed.">					switch (dResult.getResultCode())</span>
					{
						 case DeletionResult.PROHIBIT_DELETE:
<span class="nc" id="L227">						   WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager();</span>
						   
<span class="nc bnc" id="L229" title="All 2 branches missed.">						   for (Iterator i = dResult.getLinkedObjects().iterator(); i.hasNext();) {</span>
<span class="nc" id="L230">						     LinkedObject pLink = (LinkedObject) i.next();</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">						     if (pLink.getType() == BPObjectInfo.BPOBJECT_FILING_RULE) {</span>
<span class="nc" id="L232">						       RequestFilingRuleManager manager = RmManagerFactory.getInstance().getFilingRuleManager();</span>
<span class="nc" id="L233">						       RequestFilingRule pRule = manager.findFilingRuleById(pLink.getID());</span>
<span class="nc" id="L234">							   Organization ruleOrg = wrm.getOrganizationByID(pRule.getOrganizationId());</span>
<span class="nc" id="L235">						       pLink.setName(pRule.getSentence(localizer, ruleOrg));</span>
<span class="nc" id="L236">						     }</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">						     else if (pLink.getType() == BPObjectInfo.BPOBJECT_AUTOPROCESSING_RULE) {</span>
<span class="nc" id="L238">						       AutoProcessingRuleManager manager = RmManagerFactory.getInstance().getAutoProcessingRuleManager();</span>
<span class="nc" id="L239">						       AutoProcessingRule pRule = manager.findAutoProcessingRuleById(pLink.getID());</span>
<span class="nc" id="L240">						       Organization ruleOrg = wrm.getOrganizationByID(pRule.getOrganizationId());</span>
<span class="nc" id="L241">						       pLink.setName(pRule.getSentence(localizer, ruleOrg));</span>
						     }

<span class="nc" id="L244">						   }</span>



<span class="nc" id="L248">						   break;</span>

						 case DeletionResult.DELETED:
									// delete the object
<span class="fc" id="L252">									DAOUtil.deleteObjectCascade(idObject, &quot;ACTIVITY&quot;, dmo);</span>
<span class="fc" id="L253">									WfmManagerFactory.getActivityManager().deleteActivityFromCache(idObject, false);</span>
<span class="fc" id="L254">									break;</span>
						 case DeletionResult.INACTIVATED:
									// mark object as deleted
<span class="nc" id="L257">									DAOUtil.markObjectAsDeleted(idObject, &quot;ACTIVITY&quot;, dmo, true);</span>
<span class="nc" id="L258">									WfmManagerFactory.getActivityManager().deleteActivityFromCache(idObject, true);</span>
									AuxCodeActivityManager aam =
<span class="nc" id="L260">										BbmManagerFactory.getAuxCodeActivityManager();</span>
<span class="nc" id="L261">									aam.deleteAuxCodeActivitiesByActivity(idObject);</span>
<span class="nc" id="L262">									break;</span>

						 default:
									// do nothing if prohibit delete or need substitute
									break;
					}

<span class="fc" id="L269">					return dResult;</span>
			}
<span class="nc" id="L271">			catch(Exception e)</span>
			{
<span class="nc" id="L273">					throw new DeleteException(e);</span>
			}
			finally
			{
<span class="pc" id="L277">					dmo.cleanUp();</span>
			}
	}

	/**
	 * substitute the object with another object in object relationship
	 * 
	 * @param objID
	 *            the id of the object being substituted
	 * @param substituteObjID
	 *            the id of the substitute object
	 * @param dtSubstituteDate
	 *            the date where the substitution occurred
	 */
	public void substituteObject(ID objID, ID substituteObjID,
			Date dtSubstituteDate) throws DeleteException {
<span class="nc" id="L293">	}</span>

	/**
	 * force delete or inactive the object after user confirms the operation
	 * 
	 * @param objID
	 * 			the id of the object to force delete on
	 */	
	public void forceDeleteObject(ID objID) throws DeleteException {
<span class="nc" id="L302">	}</span>

	/**
	 * Converts an object type to a localized string
	 * 
	 * @param localizer The localizer
	 * @param isPlural Specify whether display is for multiple object 
	 * @return a localized object type string
	 */
	public String convertType(Localizer localizer, boolean isPlural) {
<span class="nc bnc" id="L312" title="All 2 branches missed.">		String rbKey = isPlural ? BbmEjbBundleKey.OBJECT_ACTIVITY_PLURAL</span>
				: BbmEjbBundleKey.OBJECT_ACTIVITY;
<span class="nc" id="L314">		return localizer.i18n(BbmEjbBundleKey.BUNDLE_NAME, rbKey);</span>
	}


	public static void main(String[] args) {
		try {
			//need to initialize the client jdmo
<span class="nc" id="L321">			Jdmo jdmo = new Jdmo(&quot;sun.jdbc.odbc.JdbcOdbcDriver&quot;,</span>
					&quot;jdbc:odbc:activity&quot;, &quot;sa&quot;, &quot;blue&quot;);

<span class="nc" id="L324">			DeleteActivityDAO pDAO = new DeleteActivityDAO();</span>
<span class="nc" id="L325">			DeletionResult pResult = pDAO.checkLinkedObjects(new ID(-4101),jdmo);</span>

<span class="nc bnc" id="L327" title="All 2 branches missed.">			for (Iterator i = pResult.getLinkedObjects().iterator(); i.hasNext();) {</span>
<span class="nc" id="L328">				LinkedObject pLO = (LinkedObject)i.next();</span>
<span class="nc" id="L329">				System.out.println(pLO.getType());</span>
<span class="nc" id="L330">				Localizer localizer = DefaultLocalizationManager.getDefaultInstance().getLocalizer();</span>
<span class="nc" id="L331">				System.out.println(pLO.getDisplayName(localizer));</span>
<span class="nc" id="L332">			}</span>
		}
<span class="nc" id="L334">		catch (Exception e) {</span>
<span class="nc" id="L335">			e.printStackTrace();</span>
<span class="nc" id="L336">		}</span>
<span class="nc" id="L337">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>