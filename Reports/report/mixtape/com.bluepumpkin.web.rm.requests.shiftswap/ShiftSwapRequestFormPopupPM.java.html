<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftSwapRequestFormPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.shiftswap</a> &gt; <span class="el_source">ShiftSwapRequestFormPopupPM.java</span></div><h1>ShiftSwapRequestFormPopupPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.shiftswap;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.util.BPMessageFormat;
import com.bluepumpkin.common.util.DateTimeUtil;
import com.bluepumpkin.common.util.PersonNameUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.ShiftSwapPosting;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.bluepumpkin.web.rm.requests.RequestUtil;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.bluepumpkin.web.rm.requests.SwapFormPopupPM;
import com.bluepumpkin.web.rm.requests.SwapUtil;
import com.bluepumpkin.web.rm.requests.swapboard.RequestsSwapBoardMH;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.message.MessagePC;
import com.witness.web.uif.pagecomponent.picker.date.DateRangePickerPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;
import com.witness.web.uif.validator.InLengthRangeFieldValidator;

/**
 * Title:        ShiftSwapRequestFormPopupPM
 * Description:  Form to Create or Edit Shift Swap Request
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, dsu
 * @version      1.0
 *
 * Created on November 5, 2002, 10:20 AM
 */
public class ShiftSwapRequestFormPopupPM extends SwapFormPopupPM {
	private static final int NEG_COMMENT_MAX_LEN = 500;

	public static final String POSTING_ID_FN     = &quot;postingID&quot;;
	public static final String AGENT_ID_FN       = &quot;agentID&quot;;
	public static final String REQUEST_DATE_1_FN = &quot;requestDate1&quot;;
	public static final String REQUEST_DATE_2_FN = &quot;requestDate2&quot;;
	public static final String SUBMIT2MGR_FN     = &quot;isSubmitToMgr&quot;;
	public static final String NEGOTIATION_CMT_FN = &quot;negotiationComment&quot;;
	public static final String SUBMIT_TO_MANAGER_ONLY_FN = &quot;showSubmitToManagerOnly&quot;;
	public static final String PARTIAL_SWAP_FN = &quot;isSwapPartial&quot;;
	public static final String PARTIAL_PICKUP_FN = &quot;isPickupPartial&quot;;
	private static final String TIMERANGE_SWAP_FN  = &quot;timeRangeSwap&quot;;
	private static final String TIMERANGE_PICKUP_FN  = &quot;timeRangePickup&quot;;

	private ShiftSwapRequest m_ssRequest;
	private ShiftSwapPosting m_posting;
	private ID m_postingID;

<span class="nc" id="L84">	private Collection m_eNames = Collections.EMPTY_LIST;</span>
<span class="nc" id="L85">	private Map m_eNameMap = Collections.EMPTY_MAP;</span>
<span class="nc" id="L86">	private HashMap m_orgSettingMap = new HashMap();</span>
<span class="nc" id="L87">	private Map m_empOrgMap = Collections.EMPTY_MAP;</span>
	private String m_shiftType;
	private ID m_agentID1;
	private ID m_agentID2;
	private Date m_requestDate1;
	private Date m_requestDate2;
	private Date m_expireTime1;
	private Date m_expireTime2;
<span class="nc" id="L95">	private boolean m_isSubmitToMgr=false;</span>
<span class="nc" id="L96">	private boolean m_isNegotiable1=true;</span>
<span class="nc" id="L97">	private boolean m_isNegotiable2=true;</span>
<span class="nc" id="L98">	private boolean m_isRequestSaved=false;</span>
<span class="nc" id="L99">	private boolean m_isWithdrawConfirmed=false;</span>
<span class="nc" id="L100">	private ShiftSwapItem m_ssItem1=null;</span>
<span class="nc" id="L101">	private ShiftSwapItem m_ssItem2=null;</span>
<span class="nc" id="L102">	private boolean m_allowPartial=true;</span>
	private Date m_requestEndDate;
<span class="nc" id="L104">	private boolean m_isSwapPartial=false;</span>
<span class="nc" id="L105">	private boolean m_isPickupPartial=false;</span>
	private DateRangePickerPC m_swapDateRangePickerPC;
	private DateRangePickerPC m_pickupDateRangePickerPC;
	private Date m_swapStartDate;
	private Date m_swapEndDate;
	private Date m_pickupStartDate;
	private Date m_pickupEndDate;

	//Determines whether user should only be shown the 'Submit to Manager' section.
<span class="nc" id="L114">	private boolean m_showSubmitToManagerOnly=false;</span>

	/**
	 * Constructor
	 */
	public ShiftSwapRequestFormPopupPM(RequestContext context) {
<span class="nc" id="L120">		super(context, RmKeys.RH_SHIFTSWAP_FORM);</span>

<span class="nc" id="L122">		initNewShiftSwapRequest(context);</span>

		// Add Field Validator
<span class="nc" id="L125">		addValidator( new InLengthRangeFieldValidator(this,</span>
				COMMENT_FN, RmWebBundleKey.SWAP_REQUEST_SUBMIT_TO_MGR_COMMENT,
				RmWebBundleKey.BUNDLE_NAME, 0, 200)
		);

<span class="nc" id="L130">		addValidator( new InLengthRangeFieldValidator(this,</span>
				NEGOTIATION_CMT_FN, RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT,
				RmWebBundleKey.BUNDLE_NAME, 0, 500)
		);

<span class="nc" id="L135">		initDateRangePickers();</span>
<span class="nc" id="L136">	}</span>

	protected void initDataPickersWithOrgWeekStartDay(int weekStartDay) {
<span class="nc" id="L139">		m_swapDateRangePickerPC.setFirstDayOfWeek(weekStartDay);</span>
<span class="nc" id="L140">		m_pickupDateRangePickerPC.setFirstDayOfWeek(weekStartDay);</span>
<span class="nc" id="L141">	}</span>

	/**
	 * Initialize New Shift Swap Request
	 */
	private void initNewShiftSwapRequest(RequestContext context) {
<span class="nc" id="L147">		setShiftSwapRequest(new ShiftSwapRequest(ShiftSwapRequest.DL_BASIC));</span>
<span class="nc" id="L148">		m_ssRequest.setSwapType(ShiftSwapRequest.SHIFTSWAP_TYPE_TWOWAY);</span>
<span class="nc" id="L149">		m_ssRequest.setRequestStatus(RequestAuditTrail.STATUS_NEGOTIATION);</span>
<span class="nc" id="L150">		m_agentID1 = m_empID;</span>

<span class="nc" id="L152">		String showSubmitToManagerOnly = (String)context.getAttribute(RequestContext.REQUEST_SCOPE, RmKeys.SHIFT_SWAP_FORM_SHOW_SUBMIT_ONLY);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">		if (showSubmitToManagerOnly != null)</span>
		{
<span class="nc" id="L155">			m_showSubmitToManagerOnly = showSubmitToManagerOnly.equals(&quot;true&quot;);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">			if (m_showSubmitToManagerOnly)</span>
			{
				//The default for the submit to manager checkbox should be true
<span class="nc" id="L159">				m_isSubmitToMgr = true;</span>
			}
		}
<span class="nc" id="L162">	}</span>

	private void initDateRangePickers(){
<span class="nc" id="L165">		initPickupDateRangePicker();</span>
<span class="nc" id="L166">		initSwapDateRangePicker();</span>
<span class="nc" id="L167">	}</span>

	/**
	 * Create and add Date Range Picker as Child Component
	 */
	private void initPickupDateRangePicker() {
<span class="nc" id="L173">		m_pickupDateRangePickerPC = new DateRangePickerPC(m_context, TIMERANGE_PICKUP_FN);</span>
<span class="nc" id="L174">		m_pickupDateRangePickerPC.setIsTimeEnabled(true);</span>
<span class="nc" id="L175">		setDateRangePickerStartAndEnd(m_pickupDateRangePickerPC);</span>

<span class="nc" id="L177">		m_pickupDateRangePickerPC.getStartDatePickerPC().setTimeInterval(15);</span>
<span class="nc" id="L178">		m_pickupDateRangePickerPC.getEndDatePickerPC().setTimeInterval(15);</span>
<span class="nc" id="L179">		addChildComponent(m_pickupDateRangePickerPC);</span>
<span class="nc" id="L180">	}</span>

	/**
	 * Create and add Date Range Picker as Child Component
	 */
	private void initSwapDateRangePicker() {
<span class="nc" id="L186">		m_swapDateRangePickerPC = new DateRangePickerPC(m_context, TIMERANGE_SWAP_FN);</span>
<span class="nc" id="L187">		m_swapDateRangePickerPC.setIsTimeEnabled(true);</span>
<span class="nc" id="L188">		setDateRangePickerStartAndEnd(m_swapDateRangePickerPC);</span>

<span class="nc" id="L190">		m_swapDateRangePickerPC.getStartDatePickerPC().setTimeInterval(15);</span>
<span class="nc" id="L191">		m_swapDateRangePickerPC.getEndDatePickerPC().setTimeInterval(15);</span>
<span class="nc" id="L192">		addChildComponent(m_swapDateRangePickerPC);</span>
<span class="nc" id="L193">	}</span>

	/**
	 * Return an instance of the model that is ready for rendering
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L199">		return getInstance(context, ShiftSwapRequestFormPopupPM.class);</span>
	}

	/**
	 * Load Specific Data
	 */
	protected void loadSpecificData() throws Exception {
<span class="nc bnc" id="L206" title="All 2 branches missed.">		if (isCreateNewFromScratch()) {</span>
<span class="nc" id="L207">			m_eNames = ShiftSwapRequestsMH.getEmpNamesOneCanSwapShiftWith(m_context, m_empID);</span>
<span class="nc" id="L208">			fillOrgSettingMap();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">		} else if (isCreateRequestFromPosting()) {</span>
<span class="nc" id="L210">			ID postingID = getPostingID();</span>
<span class="nc" id="L211">			m_posting = RequestsSwapBoardMH.getPostingByID(postingID);</span>
<span class="nc" id="L212">			m_eNameMap = RequestsSwapBoardMH.getEmployeeNameMap(m_context, m_posting);</span>
<span class="nc" id="L213">			processShiftSwapPosting(m_posting);</span>
<span class="nc" id="L214">		} else {</span>
<span class="nc" id="L215">			ID requestID = getRequestID();</span>
<span class="nc" id="L216">			ShiftSwapRequest request = ShiftSwapRequestsMH.getRequestByID(requestID);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">			if (request == null) {</span>
<span class="nc" id="L218">				this.addPageMessage(Message.ERROR_TYPE, i18n(m_bundle, RmWebBundleKey.REQUEST_NOT_FOUND_ERROR));</span>
<span class="nc" id="L219">				initToolbar(false);</span>
			}
			else {
<span class="nc" id="L222">				m_isAuthorized = RequestUtil.isAuthToUpdate(m_context, request);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">				if (m_isAuthorized) {</span>
<span class="nc" id="L224">					m_eNameMap = ShiftSwapRequestsMH.getEmpNameMapForRequest(m_context, request);</span>
<span class="nc" id="L225">					processShiftSwapRequest(request);</span>
				}
			}
		}
<span class="nc" id="L229">	}</span>

	private void fillOrgSettingMap(){
//		 Sort Employee Names
<span class="nc" id="L233">		List sortedENames = new ArrayList(m_eNames);</span>
<span class="nc" id="L234">		PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>
<span class="nc" id="L235">		ArrayList empList = new ArrayList();</span>
		// Convert to Options
<span class="nc bnc" id="L237" title="All 2 branches missed.">		for(Iterator it=sortedENames.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L238">			EmployeeName eName = (EmployeeName)it.next();</span>
<span class="nc" id="L239">			empList.add(eName.getID());</span>
<span class="nc" id="L240">		}</span>

		//add array of empOrgs: get orgs for the employees
<span class="nc" id="L243">		HashSet orgIDSet = new HashSet();</span>
		try {
<span class="nc" id="L245">			m_empOrgMap = (HashMap)OrganizationModelHandler.getEmployeeOrgMap(m_context, empList, new Date());</span>

<span class="nc bnc" id="L247" title="All 2 branches missed.">			for (Iterator it = m_empOrgMap.values().iterator(); it.hasNext(); ){</span>
<span class="nc" id="L248">				orgIDSet.add(it.next());</span>
			}

<span class="nc bnc" id="L251" title="All 2 branches missed.">			for (Iterator orgIDSetIter = orgIDSet.iterator(); orgIDSetIter.hasNext();){</span>
<span class="nc" id="L252">				ID orgID = (ID)orgIDSetIter.next();</span>
<span class="nc" id="L253">				OrganizationSetting orgSetting = RequestsMH.getOrgSetting(orgID);</span>
<span class="nc" id="L254">				m_orgSettingMap.put(orgID, orgSetting);</span>
<span class="nc" id="L255">			}</span>
<span class="nc" id="L256">		} catch (Exception ex){</span>
			//log.l7dError(RmWebLogBundleKey.EXTRACT_PARAM_FAILED, ex);//TODO
<span class="nc" id="L258">		}</span>
<span class="nc" id="L259">	}</span>

	/**
	 * Process Request for Edit
	 */
	private void processShiftSwapRequest(ShiftSwapRequest request) {
<span class="nc" id="L265">		setShiftSwapRequest(request);</span>

<span class="nc" id="L267">		List ssItems = request.getShiftSwapItems();</span>
<span class="nc" id="L268">		m_ssItem1 = (ShiftSwapItem)ssItems.get(0);</span>
<span class="nc" id="L269">		m_ssItem2 = (ShiftSwapItem)ssItems.get(1);</span>

		// Determine which item to be displayed first
<span class="nc bnc" id="L272" title="All 2 branches missed.">		if (!m_empID.equals(m_ssItem1.getEmployeeID()) &amp;&amp;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">				m_empID.equals(m_ssItem2.getEmployeeID())) {</span>
<span class="nc" id="L274">			ShiftSwapItem tmpItem = m_ssItem1;</span>
<span class="nc" id="L275">			m_ssItem1 = m_ssItem2;</span>
<span class="nc" id="L276">			m_ssItem2 = tmpItem;</span>
		}

<span class="nc" id="L279">		m_agentID1 = m_ssItem1.getEmployeeID();</span>
<span class="nc" id="L280">		m_shiftType = m_ssItem1.getShiftType();</span>
<span class="nc" id="L281">		m_requestDate1 = m_ssItem1.getStartDate();</span>
<span class="nc" id="L282">		m_expireTime1 = m_ssItem1.getExpirationDate();</span>
<span class="nc" id="L283">		m_isNegotiable1 = m_ssItem1.getNegotiation();</span>

<span class="nc" id="L285">		m_agentID2 = m_ssItem2.getEmployeeID();</span>
<span class="nc" id="L286">		m_requestDate2 = m_ssItem2.getStartDate();</span>
<span class="nc" id="L287">		m_expireTime2 = m_ssItem2.getExpirationDate();</span>
<span class="nc" id="L288">		m_isNegotiable2 = m_ssItem2.getNegotiation();</span>

<span class="nc bnc" id="L290" title="All 2 branches missed.">		if (m_isRequestSaved) {</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">			if (isWithdrawConfirmed()){</span>
<span class="nc" id="L292">				RequestUtil.addSavedRequestMsg(request.getWithdrawInfo().getRequestStatus(), this);</span>
			} else {
<span class="nc" id="L294">				RequestUtil.addSavedRequestMsg(request, this);</span>
			}
		}
<span class="nc" id="L297">	}</span>

	/**
	 * Process Posting to create New Request
	 */
	private void processShiftSwapPosting(ShiftSwapPosting posting) {
<span class="nc" id="L303">		setSwapType(posting.getSwapType());</span>

<span class="nc" id="L305">		ShiftSwapItem item = posting.getShiftSwapItem();</span>
<span class="nc" id="L306">		Date shiftDate = item.getStartDate();</span>
<span class="nc" id="L307">		Date shiftEndDate = item.getEndDate();</span>
<span class="nc" id="L308">		String shiftType = item.getShiftType();</span>

		// Keep extracted value if available
<span class="nc bnc" id="L311" title="All 2 branches missed.">		if (m_expireTime1==null) m_expireTime1 = createNewOfferExpDate();</span>
<span class="nc" id="L312">		String nComment = getNegotiationComment();</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">		if (StringUtil.isEmpty(nComment)) setNegotiationComment(posting.getComment());</span>

<span class="nc bnc" id="L315" title="All 2 branches missed.">		if (isTwoWaySwap()) {</span>
<span class="nc" id="L316">			m_shiftType = shiftType;</span>

			// Keep extracted date if available
<span class="nc bnc" id="L319" title="All 2 branches missed.">			if (m_requestDate1==null) m_requestDate1 = shiftDate;</span>
		} else {
			//if (!item.getIsPartial())
<span class="nc bnc" id="L322" title="All 2 branches missed.">				m_shiftType = SwapUtil.isTimeOffShift(shiftType)</span>
						? ShiftSwapItem.SWAPITEMTYPE_SHIFT
						: ShiftSwapItem.SWAPITEMTYPE_TIMEOFF;
<span class="nc" id="L325">			m_requestDate1 = shiftDate;</span>
		}
<span class="nc" id="L327">		m_requestEndDate = shiftEndDate;</span>
<span class="nc" id="L328">		m_agentID2 = item.getEmployeeID();</span>
<span class="nc" id="L329">		m_requestDate2 = shiftDate;</span>
<span class="nc" id="L330">		m_expireTime2 = item.getExpirationDate();</span>
<span class="nc" id="L331">		m_isNegotiable2 = item.getNegotiation();</span>
<span class="nc" id="L332">		m_allowPartial = item.getAllowPartial();</span>

		//set values of date range pickers
<span class="nc bnc" id="L335" title="All 2 branches missed.">		if (m_swapStartDate == null) m_swapStartDate = shiftDate;</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">		if (m_swapEndDate == null) m_swapEndDate = shiftEndDate;</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">		if (m_pickupStartDate == null) m_pickupStartDate = shiftDate;</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">		if (m_pickupEndDate == null) m_pickupEndDate = shiftEndDate;</span>

<span class="nc" id="L340">		m_pickupDateRangePickerPC.getStartDatePickerPC().setDate(m_pickupStartDate);</span>
<span class="nc" id="L341">		m_pickupDateRangePickerPC.getEndDatePickerPC().setDate(m_pickupEndDate);</span>

<span class="nc" id="L343">		m_swapDateRangePickerPC.getStartDatePickerPC().setDate(m_swapStartDate);</span>
<span class="nc" id="L344">		m_swapDateRangePickerPC.getEndDatePickerPC().setDate(m_swapEndDate);</span>
<span class="nc" id="L345">	}</span>

	/**
	 * Prepare content title for rendering
	 */
	protected void initContentTitle() {
<span class="nc bnc" id="L351" title="All 2 branches missed.">		String rbKey = isNew()</span>
<span class="nc bnc" id="L352" title="All 4 branches missed.">				? (isCreateRequestFromPosting()</span>
				? RmWebBundleKey.CREATE_NEW_REQUEST_FROM_POSTING
				: RmWebBundleKey.CREATE_NEW_REQUEST
				)
				: (m_showSubmitToManagerOnly ? RmWebBundleKey.SWAP_REQUEST_SUBMIT_TO_MGR_COMMENT : RmWebBundleKey.EDIT_REQUEST);

<span class="nc" id="L358">		String pageTitle = i18n(m_bundle, rbKey);</span>

<span class="nc" id="L360">		String itemName = i18n(m_bundle, RmWebBundleKey.REQUEST_TYPE_SHIFT_SWAP);</span>
<span class="nc" id="L361">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="nc" id="L362">		m_contentTitlePC.setItemName(itemName);</span>
<span class="nc" id="L363">	}</span>

	/**
	 * Add List Content
	 */
	protected void addListContent(List listModel)
	{
<span class="nc bnc" id="L370" title="All 2 branches missed.">		if (isWithdrawConfirmation()){</span>
<span class="nc" id="L371">			addWithdrawApproveSentance(listModel);</span>
<span class="nc bnc" id="L372" title="All 6 branches missed.">		} else if (canSwapPartial() &amp;&amp; (m_posting != null &amp;&amp; m_posting.getShiftSwapItem().getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT) ||</span>
<span class="nc bnc" id="L373" title="All 4 branches missed.">				(isCreateNewFromScratch() &amp;&amp; this.getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT)))){</span>
<span class="nc" id="L374">			addPartialSwapSentence(listModel);</span>
		} else {
<span class="nc" id="L376">			addSwapSentence(listModel);</span>
		}
<span class="nc bnc" id="L378" title="All 2 branches missed.">		if (!m_showSubmitToManagerOnly)</span>
		{
<span class="nc bnc" id="L380" title="All 6 branches missed.">			if (canSwapPartial() &amp;&amp; ((m_posting != null &amp;&amp; m_posting.getShiftSwapItem().getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT)) ||</span>
<span class="nc bnc" id="L381" title="All 6 branches missed.">					(isCreateNewFromScratch() &amp;&amp; getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT))) &amp;&amp; getRequestID()==null){</span>
<span class="nc bnc" id="L382" title="All 4 branches missed.">				if (isTwoWaySwap() || isCreateNewFromScratch())</span>
<span class="nc" id="L383">					addPartialSwapOptionRow(listModel);</span>
<span class="nc bnc" id="L384" title="All 4 branches missed.">				if (isCreateRequestFromPosting() || isTwoWaySwap())</span>
<span class="nc" id="L385">					addPartialPickupOptionRow(listModel);</span>
			}
<span class="nc" id="L387">			addExpireSentence(listModel);</span>
<span class="nc" id="L388">			addNegotiationOptionRow(listModel);</span>
<span class="nc" id="L389">			addNegotiatioCommentRow(listModel);</span>
<span class="nc" id="L390">			addCommentHistory(listModel);</span>
		}
<span class="nc" id="L392">		addCommentRow(listModel);</span>
<span class="nc" id="L393">		addSubmitToMgrRow(listModel);</span>
<span class="nc" id="L394">	}</span>


	/**
	 * Add Swap Sentence
	 */
	private void addSwapSentence(List listModel) {
<span class="nc bnc" id="L401" title="All 2 branches missed.">		String rbKey = isTwoWaySwap()?RmWebBundleKey.SWAP_REQUEST_TWOWAY_SENTENCE</span>
				:RmWebBundleKey.SWAP_REQUEST_ONEWAY_SENTENCE;

<span class="nc bnc" id="L404" title="All 6 branches missed.">		if (!isTwoWaySwap() &amp;&amp; m_empID.equals(m_agentID1) &amp;&amp; getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF)){</span>
			//shift detail message
<span class="nc" id="L406">			rbKey = RmWebBundleKey.SWAP_REQUEST_ONEWAY_DAYOFF_SENTENCE;</span>
		}

<span class="nc" id="L409">		String sentence_template = i18n(m_bundle, rbKey);</span>
<span class="nc" id="L410">		Object[] args = null;</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">		if (isNew()) {</span>
<span class="nc" id="L412">			args = createArgsForNewSwapSentence();</span>
		} else {
<span class="nc bnc" id="L414" title="All 2 branches missed.">			if (m_ssItem1.getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF) &amp;&amp;</span>
<span class="nc bnc" id="L415" title="All 8 branches missed.">					m_empID.equals(m_agentID1) &amp;&amp; !isTwoWaySwap() &amp;&amp; m_ssItem2.getIsPartial() &amp;&amp; !isCreateNewFromScratch()){//do not display day off</span>
<span class="nc" id="L416">				sentence_template = i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_ONEWAY_DAYOFF_PARTIAL_SENTENCE);</span>
<span class="nc" id="L417">				args = new Object[] {</span>
<span class="nc" id="L418">						getAgent2Name(),</span>
<span class="nc" id="L419">						SwapUtil.formatShiftDate(m_ssItem2, m_localizer, m_view_tz),</span>
<span class="nc" id="L420">						getShiftSwapTypeDisplayWithHiddenInput()</span>
					};
		} else {
<span class="nc" id="L423">			args = new Object[] {</span>
<span class="nc" id="L424">				getAgent1Name(),</span>
<span class="nc" id="L425">				getShiftTypeDisplay(),</span>
<span class="nc" id="L426">				SwapUtil.formatShiftDate(m_ssItem1, m_localizer, m_view_tz),</span>
<span class="nc" id="L427">				getAgent2Name(),</span>
<span class="nc" id="L428">				SwapUtil.formatShiftDate(m_ssItem2, m_localizer, m_view_tz),</span>
<span class="nc" id="L429">				getShiftSwapTypeDisplay()</span>
			};
			}
		}

<span class="nc" id="L434">		String sentence = BPMessageFormat.format(sentence_template, args);</span>
<span class="nc" id="L435">		addDataRow(sentence, listModel);</span>
<span class="nc" id="L436">	}</span>

	/**
	 * Add Swap Sentence
	 */
	private void addPartialSwapSentence(List listModel) {
<span class="nc bnc" id="L442" title="All 2 branches missed.">		if (getRequestID() != null){</span>
			//add for already created request
<span class="nc" id="L444">			addSwapSentence(listModel);</span>
		} else {
<span class="nc" id="L446">			String sentence_template = i18n(m_bundle, RmWebBundleKey.SWAP_POSTING_TWOWAY_PARTIAL_SENTENCE);</span>
<span class="nc" id="L447">			Object[] args = null;</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">			if (getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF) &amp;&amp;</span>
<span class="nc bnc" id="L449" title="All 6 branches missed.">					m_empID.equals(m_agentID1) &amp;&amp; m_posting.getIsPartial() &amp;&amp; !isCreateNewFromScratch()){//do not display day off</span>
<span class="nc" id="L450">				sentence_template = i18n(m_bundle, RmWebBundleKey.SWAP_POSTING_ONEWAY_DAYOFF_PARTIAL_SENTENCE);</span>
			}
<span class="nc bnc" id="L452" title="All 2 branches missed.">			if (isNew()) {</span>
<span class="nc" id="L453">				args = createArgsForNewPartialSwapSentence();</span>
			} else {
<span class="nc" id="L455">				args = new Object[] {</span>
<span class="nc" id="L456">					getAgent1Name(),</span>
<span class="nc" id="L457">					getShiftTypeDisplay(),</span>
<span class="nc" id="L458">					getAgent2Name(),</span>
<span class="nc" id="L459">					getShiftSwapTypeDisplay()</span>
				};
			}
<span class="nc" id="L462">			String sentence = BPMessageFormat.format(sentence_template, args);</span>
<span class="nc" id="L463">			addDataRow(sentence, listModel);</span>
		}
<span class="nc" id="L465">	}</span>

	private void addWithdrawApproveSentance(List listModel){
		try{
<span class="nc" id="L469">			String swapEmployee = RequestUtil.getSwapEmployeeName(m_request, m_context);</span>
<span class="nc" id="L470">			String simpleText = m_localizer.i18n(m_bundle, RmWebBundleKey.SHIFTSWAP_WITHDRAW_REQUESTED_NEEDS_CONFIRMATION,swapEmployee);</span>
<span class="nc" id="L471">			addDataRow(simpleText, listModel);</span>
<span class="nc" id="L472">		} catch (Exception ex) {</span>
<span class="nc" id="L473">			log.l7dError(RmWebLogBundleKey.UNABLE_TO_LOAD_PERSON_INFO_FOR_EMPLOYEE, ex);</span>
<span class="nc" id="L474">		}</span>
<span class="nc" id="L475">	}</span>

	/**
	 * Create Args for New Swap Sentence
	 */
	private Object[] createArgsForNewSwapSentence() {
<span class="nc" id="L481">		Object[] args = null;</span>

<span class="nc" id="L483">		String agent1Name = i18n(m_common_bundle, UIFWebBundleKey.MY);</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">		if (isCreateNewFromScratch()) {</span>
<span class="nc" id="L485">			args = new Object[] {</span>
				agent1Name,
<span class="nc" id="L487">				createShiftTypeDD(),</span>
<span class="nc" id="L488">				getDatePickerHTML(REQUEST_DATE_1_FN, m_requestDate1, false),</span>
<span class="nc" id="L489">				createAgentDD(),</span>
<span class="nc" id="L490">				getDatePickerHTML(REQUEST_DATE_2_FN, m_requestDate2, false),</span>
<span class="nc" id="L491">				createShiftSwapTypeDD(true)</span>
			};
		} else {
<span class="nc bnc" id="L494" title="All 2 branches missed.">			String datePicker= isTwoWaySwap()</span>
<span class="nc" id="L495">					? getDatePickerHTML(REQUEST_DATE_1_FN, m_requestDate1, false)</span>
<span class="nc" id="L496">					: getReadOnlyDate(REQUEST_DATE_1_FN, m_requestDate1, false);</span>
<span class="nc" id="L497">			args = new Object[] {</span>
				agent1Name,
<span class="nc" id="L499">				getShiftTypeDisplayWithHiddenInput(),</span>
				datePicker,
<span class="nc" id="L501">				getAgent2Name(),</span>
<span class="nc" id="L502">				getReadOnlyDate(REQUEST_DATE_2_FN, m_requestDate2, false),</span>
<span class="nc" id="L503">				getShiftSwapTypeDisplayWithHiddenInput()</span>
			};
		}

<span class="nc" id="L507">		return args;</span>
	}

	/**
	 * Create Args for New Swap Sentence
	 */
	private Object[] createArgsForNewPartialSwapSentence() {
<span class="nc" id="L514">		Object[] args = null;</span>

<span class="nc" id="L516">		String agent1Name = i18n(m_common_bundle, UIFWebBundleKey.MY);</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">		if (isCreateNewFromScratch()) {</span>
<span class="nc" id="L518">			args = new Object[] {</span>
				agent1Name,
<span class="nc" id="L520">				createShiftTypeDD(),</span>
<span class="nc" id="L521">				createAgentDD(),</span>
<span class="nc" id="L522">				createShiftSwapTypeDD(true)</span>
			};
		} else {
<span class="nc bnc" id="L525" title="All 2 branches missed.">			if (getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF) &amp;&amp;</span>
<span class="nc bnc" id="L526" title="All 6 branches missed.">					m_empID.equals(m_agentID1) &amp;&amp; m_posting.getIsPartial() &amp;&amp; !isCreateNewFromScratch()){</span>
<span class="nc" id="L527">				args = new Object[] {</span>
<span class="nc" id="L528">						getAgent2Name() + HtmlUtil.makeHiddenInput(SHIFT_TYPE_FN, getShiftType()),</span>
<span class="nc" id="L529">						getShiftSwapTypeDisplayWithHiddenInput()</span>
					};
			} else {
<span class="nc" id="L532">				args = new Object[] {</span>
					agent1Name,
<span class="nc" id="L534">					getShiftTypeDisplayWithHiddenInput(),</span>
<span class="nc" id="L535">					getAgent2Name(),</span>
<span class="nc" id="L536">					getShiftSwapTypeDisplayWithHiddenInput()</span>
				};
			}
		}

<span class="nc" id="L541">		return args;</span>
	}

	/**
	 * Return Agent 1 Name
	 */
	private String getAgent1Name() {
<span class="nc bnc" id="L548" title="All 2 branches missed.">		if (m_empID.equals(m_agentID1)) return i18n(m_common_bundle, UIFWebBundleKey.MY);</span>

<span class="nc" id="L550">		return getEmployeeName(m_agentID1, m_eNameMap);</span>
	}

	/**
	 * Return Agent 2 Name
	 */
	private String getAgent2Name() {
<span class="nc" id="L557">		return getEmployeeName(m_agentID2, m_eNameMap) +</span>
<span class="nc" id="L558">				HtmlUtil.makeHiddenInput(AGENT_ID_FN, m_agentID2);</span>
	}

	/**
	 * Add Negotiation Option Row
	 */
	protected void addPartialSwapOptionRow(List listModel) {
<span class="nc" id="L565">		String label_toAgt = i18n(m_bundle, RmWebBundleKey.ENTIRE_SHIFT);</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">		String input_toAgt = HtmlChoiceInput.makeRadioInput(PARTIAL_SWAP_FN, &quot;false&quot;, label_toAgt, !m_isSwapPartial,&quot;disableTab('partialSwapTab');enableTab('entireSwapTab');&quot;);</span>

<span class="nc" id="L568">		String label_toMgr = i18n(m_bundle, RmWebBundleKey.PARTIAL_SHIFT);</span>
<span class="nc" id="L569">		String input_toMgr = HtmlChoiceInput.makeRadioInput(PARTIAL_SWAP_FN, &quot;true&quot;, label_toMgr,  m_isSwapPartial, &quot;disableTab('entireSwapTab');enableTab('partialSwapTab');&quot;);</span>

<span class="nc" id="L571">		StringBuffer sb = new StringBuffer(100);</span>

		/**/
<span class="nc" id="L574">		sb.append(&quot;&lt;table id=\&quot;partialTable\&quot; border=\&quot;0\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;&lt;tr&gt;&lt;td&gt;&quot;);</span>
<span class="nc" id="L575">		sb.append(input_toAgt);</span>
<span class="nc" id="L576">		sb.append(&quot;&lt;/td&gt;&lt;td  id=\&quot;entireSwapTab\&quot;&quot;);</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">	 	if(m_isSwapPartial){</span>
<span class="nc" id="L578">       		sb.append(&quot; disabled&quot;);</span>
       	}
<span class="nc" id="L580">       	sb.append(&quot;&gt;&quot;);</span>
<span class="nc" id="L581">       	sb.append(getDatePickerHTML(REQUEST_DATE_1_FN, m_requestDate1, false));</span>
<span class="nc" id="L582">       	sb.append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&quot;);</span>
<span class="nc" id="L583">       	sb.append(input_toMgr);</span>
<span class="nc" id="L584">       	sb.append(&quot;&lt;/td&gt;&lt;td  id=\&quot;partialSwapTab\&quot;&quot;);</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">    	if(!m_isSwapPartial){</span>
<span class="nc" id="L586">       		sb.append(&quot; disabled&quot;);</span>
       	}
<span class="nc" id="L588">       	sb.append(&quot;&gt;&quot;);</span>

<span class="nc" id="L590">	    sb.append(m_swapDateRangePickerPC.toString());</span>
<span class="nc" id="L591">	    sb.append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>

<span class="nc" id="L593">		addDataRow(sb.toString(), listModel);</span>
<span class="nc" id="L594">	}</span>

	/**
	 * Add Negotiation Option Row
	 */
	protected void addPartialPickupOptionRow(List listModel) {
		//TODO add partial shift pickup support
<span class="nc bnc" id="L601" title="All 6 branches missed.">		boolean canPickPartial =  (m_postingID!=null &amp;&amp; m_allowPartial) || isCreateNewFromScratch();</span>

<span class="nc" id="L603">		String label_toAgt = i18n(m_bundle, RmWebBundleKey.ENTIRE_SHIFT);</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">		String input_toAgt = HtmlChoiceInput.makeRadioInput(PARTIAL_PICKUP_FN, &quot;false&quot;, label_toAgt, !m_isPickupPartial, &quot;disableTab('partialPickupTab');enableTab('entirePickupTab');&quot;);</span>

<span class="nc bnc" id="L606" title="All 10 branches missed.">		boolean isSelected = (m_postingID != null &amp;&amp; !m_allowPartial?true:m_isPickupPartial)</span>
			|| !(m_postingID == null &amp;&amp; m_allowPartial);
<span class="nc" id="L608">		String label_toMgr = i18n(m_bundle, RmWebBundleKey.PARTIAL_SHIFT);</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">		String input_toMgr = HtmlChoiceInput.makeRadioInput(PARTIAL_PICKUP_FN, &quot;true&quot;, label_toMgr, isSelected, !canPickPartial, &quot;disableTab('entirePickupTab');enableTab('partialPickupTab');&quot;);</span>

<span class="nc bnc" id="L611" title="All 6 branches missed.">		if (m_postingID != null &amp;&amp; m_posting != null &amp;&amp; !m_posting.getAllowPartial()){</span>
			//label should say &quot;Entire Shift&quot; if posting is not partial
<span class="nc" id="L613">			label_toMgr = i18n(m_bundle, RmWebBundleKey.ENTIRE_SHIFT);</span>
		}

<span class="nc" id="L616">		StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L617">		sb.append(i18n(m_bundle, RmWebBundleKey.PICKUP_SENTENCE)).append(&quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L618">		sb.append(&quot;&lt;table id=\&quot;pickupTable\&quot; border=\&quot;0\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;&quot;);</span>
<span class="nc bnc" id="L619" title="All 4 branches missed.">		if (m_postingID == null &amp;&amp; m_allowPartial){</span>
<span class="nc" id="L620">			String requestDateStr =&quot;&quot;;</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">			if (m_requestDate2 == null)</span>
<span class="nc" id="L622">				m_requestDate2 = new Date();</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">			if (isCreateNewFromScratch())</span>
<span class="nc" id="L624">				requestDateStr =getDatePickerHTML(REQUEST_DATE_2_FN, m_requestDate2, false) ;</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">			else if (m_postingID!=null){//get item start and end</span>
<span class="nc" id="L626">				requestDateStr =formatDateTime(m_posting.getStartDate()) + &quot; - &quot; + formatDateTime(m_posting.getEndDate());</span>
			} else
<span class="nc" id="L628">				requestDateStr =getReadOnlyDate(REQUEST_DATE_2_FN, m_requestDate2, false);</span>
<span class="nc" id="L629">			sb.append(&quot;&lt;tr&gt;&lt;td&gt;&quot;);</span>
<span class="nc" id="L630">			sb.append(input_toAgt);</span>
<span class="nc" id="L631">			sb.append(&quot;&lt;/td&gt;&lt;td  id=\&quot;entirePickupTab\&quot;&quot;);</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">			if(m_isPickupPartial)</span>
<span class="nc" id="L633">				sb.append(&quot;disabled=\&quot;\&quot; &gt;&quot;);</span>
			else
<span class="nc" id="L635">				sb.append(&quot;&gt;&quot;);</span>
<span class="nc" id="L636">		 	sb.append(requestDateStr);</span>

<span class="nc" id="L638">			sb.append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
		}
<span class="nc" id="L640">		sb.append(&quot;&lt;tr&gt;&lt;td&gt;&quot;);</span>
<span class="nc" id="L641">		sb.append(input_toMgr);</span>
<span class="nc" id="L642">		sb.append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L643">		String pickupDateRangeStr =&quot;&quot;;</span>
<span class="nc" id="L644">		sb.append(&quot;&lt;td  id=\&quot;partialPickupTab\&quot; &quot;);</span>

<span class="nc bnc" id="L646" title="All 4 branches missed.">		if (isCreateNewFromScratch() || canPickPartial){</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">				if (m_postingID != null){</span>
					//set range values to posting start and end
<span class="nc" id="L649">					m_pickupDateRangePickerPC.getStartDatePickerPC().setDate(m_posting.getStartDate());</span>
<span class="nc" id="L650">					m_pickupDateRangePickerPC.getEndDatePickerPC().setDate(m_posting.getEndDate());</span>
					//set upper and lower limit to the same
<span class="nc" id="L652">					m_pickupDateRangePickerPC.getStartDatePickerPC().setLowerLimit(m_posting.getStartDate());</span>
<span class="nc" id="L653">					m_pickupDateRangePickerPC.getEndDatePickerPC().setUpperLimit(m_posting.getEndDate());</span>
				}
<span class="nc" id="L655">				pickupDateRangeStr= m_pickupDateRangePickerPC.toString();</span>
			} else {
<span class="nc" id="L657">				pickupDateRangeStr = StringUtil.NBSP + formatDateTime(m_posting.getDisplayStartDate()) + &quot; - &quot; + formatDateTime(m_requestEndDate);</span>
			}
<span class="nc" id="L659">		sb.append(&quot; &gt;&quot;);</span>
<span class="nc" id="L660">		sb.append(pickupDateRangeStr);</span>
<span class="nc" id="L661">		sb.append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>

<span class="nc" id="L663">		addDataRow(sb.toString(), listModel);</span>
<span class="nc" id="L664">	}</span>

	/**
	 * Add Expire Sentence
	 */
	private void addExpireSentence(List listModel) {
<span class="nc" id="L670">		String sentence = &quot;&quot;;</span>

<span class="nc bnc" id="L672" title="All 2 branches missed.">		if (isCreateNewFromScratch()) {</span>
<span class="nc" id="L673">			String name = i18n(m_common_bundle, UIFWebBundleKey.I);</span>
<span class="nc" id="L674">			Date expDate = createNewOfferExpDate();</span>
<span class="nc" id="L675">			sentence = createOfferExpireSentence(name, expDate, true);</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">		} else if (isInNegotiation()) {</span>
<span class="nc" id="L677">			String agent1Name = i18n(m_common_bundle, UIFWebBundleKey.I);</span>
<span class="nc" id="L678">			String agent2Name = getEmployeeName(m_agentID2, m_eNameMap);</span>

<span class="nc" id="L680">			sentence = createOfferExpireSentence(agent2Name, m_expireTime2, false) +</span>
<span class="nc" id="L681">					&quot;&lt;br&gt;&quot; + createOfferExpireSentence(agent1Name, m_expireTime1, true);</span>
<span class="nc" id="L682">		} else {</span>
<span class="nc" id="L683">			sentence = createExpirationSentence();</span>
		};

<span class="nc" id="L686">		addDataRow(sentence, listModel);</span>
<span class="nc" id="L687">	}</span>

	/**
	 * Create Offer Expire Sentence
	 */
	private String createOfferExpireSentence(String agentName, Date date, boolean isEditable) {
<span class="nc" id="L693">		String sentence_template = i18n(m_bundle, RmWebBundleKey.SWAP_OFFER_EXPIRE_SENTENCE);</span>

<span class="nc bnc" id="L695" title="All 2 branches missed.">		Object dateArg = isEditable?</span>
<span class="nc" id="L696">				getDatePickerHTML(EXPIRATION_FN, date, true):</span>
<span class="nc" id="L697">				formatDateTime(date);</span>

<span class="nc" id="L699">		Object[] args = new Object[] {agentName, dateArg};</span>
<span class="nc" id="L700">		String sentence = BPMessageFormat.format(sentence_template, args);</span>
<span class="nc" id="L701">		return sentence;</span>
	}

	/**
	 * Return Expiration Sentation
	 */
	private String createExpirationSentence() {
<span class="nc" id="L708">		String sentence_template = i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_EXPIRE_SENTENCE);</span>
<span class="nc" id="L709">		Date date = m_ssRequest.getExpirationDate();</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">		Object dateArg = isManagerMode()?</span>
<span class="nc" id="L711">				formatDateTime(date):</span>
<span class="nc" id="L712">				getDatePickerHTML(EXPIRATION_FN, date, true);</span>

<span class="nc" id="L714">		Object[] args = new Object[] { dateArg };</span>
<span class="nc" id="L715">		return BPMessageFormat.format(sentence_template, args);</span>
	}

	/**
	 * Add Negotiation Option Row
	 */
	private void addNegotiationOptionRow(List listModel) {
<span class="nc bnc" id="L722" title="All 2 branches missed.">		if (!isInNegotiation()) return;</span>
<span class="nc" id="L723">		super.addNegotiationOptionRow(listModel, isNegotiable(),</span>
				RmWebBundleKey.SWAP_REQUEST_ALLOW_FEEDBACK_FROM_AGENT,
				RmWebBundleKey.SWAP_REQUEST_ALLOW_SUBMIT_TO_MGR);
<span class="nc" id="L726">	}</span>

	/**
	 * Add Negotiation Comment Row
	 */
	private void addNegotiatioCommentRow(List listModel)
    {
<span class="nc bnc" id="L733" title="All 2 branches missed.">		if (!isInNegotiation())</span>
<span class="nc" id="L734">            return;</span>


<span class="nc" id="L737">        boolean isReadOnly = false;</span>
        try
        {//GQ
<span class="nc" id="L740">            Collection auditTrails = m_ssRequest.getAuditTrail();</span>
<span class="nc bnc" id="L741" title="All 6 branches missed.">            if (!isManagerMode() &amp;&amp; auditTrails!=null &amp;&amp; !auditTrails.isEmpty())</span>
            {
                //get the Users for this request
<span class="nc" id="L744">                Map userMap = null;</span>
<span class="nc" id="L745">                userMap = RequestsMH.getUserMapForRequest(m_ssRequest);</span>

                //get the max number of shift swap request updates per agent for the org
<span class="nc" id="L748">                fillOrgSettingMap(); //populates m_empOrgMap and m_orgSettingMap</span>

<span class="nc bnc" id="L750" title="All 2 branches missed.">                if (userMap != null)</span>
                {
                    //ID orgID = (ID)m_empOrgMap.get(m_empID);
<span class="nc" id="L753">                    Organization org = OrganizationModelHandler.getEmployeeOrg(m_context, m_empID);</span>

                    //OrganizationSetting orgSetting = (OrganizationSetting)m_orgSettingMap.get(orgID); //RequestsMH.getOrgSetting(orgID);
<span class="nc" id="L756">                    OrganizationSetting orgSetting = RequestsMH.getOrgSetting(org.getID());</span>

<span class="nc" id="L758">                    int maxNumUpdates = orgSetting.getShiftSwapMaxNegotiationUpdates();</span>

                    //get the &quot;Updated&quot; note string
<span class="nc" id="L761">                    ResourceBundle rmEjbBundle = m_localizer.getBundle(RmEjbBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L762">                    String sUpdatedNote = i18n(rmEjbBundle, RmEjbBundleKey.UPDATED);</span>

<span class="nc" id="L764">                    int numUpdatesByCurAgent = 0;</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">                    for (Iterator it=auditTrails.iterator(); it.hasNext(); )</span>
                    {
<span class="nc" id="L767">                        RequestAuditTrail rat = (RequestAuditTrail)it.next();</span>
<span class="nc" id="L768">                        User user = (User)userMap.get(rat.getBpUserId());</span>

<span class="nc bnc" id="L770" title="All 2 branches missed.">                        if (rat.getNote().equals(sUpdatedNote))</span>
                        {
<span class="nc bnc" id="L772" title="All 4 branches missed.">                            if (user!=null &amp;&amp; user.getEmployeeID().equals(m_empID))</span>
<span class="nc" id="L773">                                numUpdatesByCurAgent++;</span>
                        }
<span class="nc" id="L775">                    }</span>

<span class="nc bnc" id="L777" title="All 2 branches missed.">                    if (numUpdatesByCurAgent &gt;= maxNumUpdates)</span>
<span class="nc" id="L778">                        isReadOnly = true;</span>
                }
            }
        }
<span class="nc" id="L782">        catch (Exception ex)</span>
<span class="nc" id="L783">        {}</span>


<span class="nc" id="L786">        String label = null;</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">        if (!isReadOnly)</span>
        {
<span class="nc" id="L789">            label = i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT); //Negotiation comment</span>
        }
        else
        {
<span class="nc" id="L793">            label = i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT_NONEDITABLE); //Negotiation comment (Maximum number of comments has been reached)</span>
<span class="nc" id="L794">            String warning = i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT_NONEDITABLE_WARNING); //Maximum number of comments has been reached. The swap request must be submitted to manager or withdrawn.</span>
<span class="nc" id="L795">            addPageMessage(Message.WARNING_TYPE, warning);</span>
        }

<span class="nc" id="L798">        String input = RequestUtil.createTextArea(NEGOTIATION_CMT_FN,</span>
<span class="nc" id="L799">                getNegotiationComment(), 95, 5, NEG_COMMENT_MAX_LEN, this,</span>
                RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT,
<span class="nc" id="L801">                RmWebBundleKey.BUNDLE_NAME, isReadOnly, i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT));</span>

<span class="nc" id="L803">        StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L804">		sb.append(label).append(&quot;&lt;br&gt;&quot;).append(input);</span>
<span class="nc" id="L805">		addDataRow(sb.toString(), listModel);</span>
<span class="nc" id="L806">	}</span>

	/**
	 * Add Comment History Row
	 */
	private void addCommentHistory(List listModel) {
<span class="nc bnc" id="L812" title="All 2 branches missed.">		if (isInNegotiation()) return;</span>

<span class="nc" id="L814">		MessagePC msgPC = RequestUtil.createCmntMsgPC(m_context, &quot;490px&quot;, &quot;70px&quot;, &quot;&quot;);</span>
<span class="nc" id="L815">		Collection msgs = RequestUtil.getCommentsAsMessages(m_ssRequest);</span>
<span class="nc" id="L816">		msgPC.addMessage(msgs);</span>

<span class="nc" id="L818">		String label = i18n(m_common_bundle, UIFWebBundleKey.COMMENT_HISTORY);</span>
<span class="nc" id="L819">		StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L820">		sb.append(label).append(&quot;&lt;br&gt;&quot;).append(msgPC);</span>
<span class="nc" id="L821">		addDataRow(sb.toString(), listModel);</span>
<span class="nc" id="L822">	}</span>

	/**
	 * Return True if request is in negotiation
	 */
	private boolean isInNegotiation() {
<span class="nc" id="L828">		return RequestAuditTrail.STATUS_NEGOTIATION.</span>
<span class="nc" id="L829">				equals(m_ssRequest.getRequestStatus());</span>
	}

	/**
	 * Add Comment Row by verifying if it's editable or not
	 * If withdraw request is sent to manager for approval, then it should be disabled
	 */
	private void addCommentRow(List listModel) {
<span class="nc bnc" id="L837" title="All 2 branches missed.">		if (isInNegotiation()) return;</span>
<span class="nc" id="L838">		boolean isReadOnly = false;</span>
<span class="nc bnc" id="L839" title="All 6 branches missed.">		if(!isManagerMode() &amp;&amp; (m_ssRequest!= null &amp;&amp; m_ssRequest.getWithdrawInfo() != null &amp;&amp; RequestAuditTrail.STATUS_WITHDRAW_REQUEST.</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">				equals(m_ssRequest.getWithdrawInfo().getRequestStatus()))) {</span>
<span class="nc" id="L841">			isReadOnly = true;</span>
		}

<span class="nc" id="L844">		addCommentRow(listModel, m_common_bundle, UIFWebBundleKey.ADD_COMMENT, isReadOnly);</span>
<span class="nc" id="L845">	}</span>

	/**
	 * Add Submit to Manager Row
	 */
	private void addSubmitToMgrRow(List listModel) {
<span class="nc bnc" id="L851" title="All 4 branches missed.">		if (isManagerMode() || isCreateNewFromScratch()</span>
<span class="nc bnc" id="L852" title="All 4 branches missed.">				|| !isInNegotiation() || m_isNegotiable2) return;</span>

<span class="nc" id="L854">		String label = i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_SUBMIT_TO_MGR);</span>
<span class="nc" id="L855">		String checkBox = HtmlChoiceInput.makeChkBoxInput(SUBMIT2MGR_FN, &quot;true&quot;,</span>
				label, m_isSubmitToMgr, JSUtil.ON_CHANGE);
<span class="nc" id="L857">		String input = RequestUtil.createCommentUI(COMMENT_FN, getComment(), 95, 5, this, i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_SUBMIT_TO_MGR_COMMENT));</span>

<span class="nc" id="L859">		StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L860">		sb.append(checkBox).append(&quot;&lt;br&gt;&quot;).append(input);</span>
<span class="nc" id="L861">		addDataRow(sb.toString(), listModel);</span>
<span class="nc" id="L862">	}</span>

	/**
	 * Create Agent Drop Down
	 */
	private String createAgentDD() {
<span class="nc" id="L868">		List options = Collections.EMPTY_LIST;</span>

<span class="nc bnc" id="L870" title="All 2 branches missed.">		if (!m_eNames.isEmpty()) {</span>
<span class="nc" id="L871">			options = new ArrayList(m_eNames.size());</span>

			// Sort Employee Names
<span class="nc" id="L874">			List sortedENames = new ArrayList(m_eNames);</span>
<span class="nc" id="L875">			PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>

			// Convert to Options
<span class="nc bnc" id="L878" title="All 2 branches missed.">			for(Iterator it=sortedENames.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L879">				EmployeeName eName = (EmployeeName)it.next();</span>
<span class="nc" id="L880">				String key = eName.getID().toString();</span>
<span class="nc" id="L881">				String display = m_localizer.formatName(eName);</span>
<span class="nc" id="L882">				options.add( new StringsPair(key, display) );</span>
<span class="nc" id="L883">			}</span>
		}

<span class="nc bnc" id="L886" title="All 2 branches missed.">		String selectedOption = (m_agentID2!=null)?m_agentID2.toString():&quot;&quot;;</span>

		//return HtmlUtil.makeSelectInput(AGENT_ID_FN, selectedOption, &quot;validateOrgSetting();&quot;, options);

        //508 TBD: passing selectedValue instead of selectedText. SHould still work, but let's see!
<span class="nc" id="L891">        String agentNameLabel = i18n(m_bundle, RmWebBundleKey.AGENT_NAME); //508</span>
<span class="nc" id="L892">        return HtmlUtil.makeSelectInput(AGENT_ID_FN, options, null, selectedOption, agentNameLabel,</span>
                &quot;validateOrgSetting();&quot;, true);
	}

	protected boolean isSaveButtonEnabled() {
<span class="nc bnc" id="L897" title="All 4 branches missed.">		return isWithdrawConfirmation() || RequestUtil.isRequestFormSaveBtnEnabled(m_request);</span>
	}

	/**
	 * Override extract Parameters to handle date input
	 */
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L904">		boolean success = super.extractParameters(request);</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">		if (m_swapDateRangePickerPC.getStartDatePickerPC().getDate() == null ||</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">				m_pickupDateRangePickerPC.getStartDatePickerPC().getDate() == null){</span>

			//see if date is set, try to get the shift for that day
<span class="nc" id="L909">			Date shiftStart = null;</span>
<span class="nc" id="L910">			Date shiftEnd = null;</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">			if (m_postingID == null){</span>
				//get shift for current agent on this day
<span class="nc" id="L913">				ArrayList empList = new ArrayList();</span>
<span class="nc" id="L914">				empList.add(m_empID);</span>
<span class="nc" id="L915">				Date date = extractDate(REQUEST_DATE_1_FN, false);</span>

<span class="nc bnc" id="L917" title="All 2 branches missed.">				if (date != null){</span>
<span class="nc" id="L918">					Date endDate = DateTimeUtil.getDayEnd(date);</span>
					try {
<span class="nc" id="L920">						Collection saColl = WfmManagerFactory.getScheduleAccessManager()</span>
<span class="nc" id="L921">							.getPublishedEventsForWorkResourcesByType(Event.EVENT_TYPE_SHIFT_ASSIGNMENT, empList, date, endDate);</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">						if (!saColl.isEmpty()){</span>
<span class="nc bnc" id="L923" title="All 2 branches missed.">							for (Iterator it=saColl.iterator(); it.hasNext();){</span>
<span class="nc" id="L924">								ArrayList saList = (ArrayList) it.next();</span>

<span class="nc bnc" id="L926" title="All 2 branches missed.">								if (!saList.isEmpty()){</span>
<span class="nc" id="L927">									ShiftAssignment sa = (ShiftAssignment) saList.get(0);</span>
<span class="nc" id="L928">									shiftStart = sa.getStartTime();</span>
<span class="nc" id="L929">									shiftEnd = sa.getEndTime();</span>
<span class="nc" id="L930">									break;</span>
								}
<span class="nc" id="L932">							}</span>
						}
<span class="nc" id="L934">					} catch (Exception ex) {</span>
<span class="nc" id="L935">						log.l7dError(RmWebLogBundleKey.EXTRACT_PARAM_FAILED, ex);</span>
<span class="nc" id="L936">					}</span>
				}
			}
<span class="nc bnc" id="L939" title="All 2 branches missed.">			if (m_swapDateRangePickerPC.getStartDatePickerPC().getDate() == null){//init picker</span>
				//see if date is set, try to get the shift for that day
<span class="nc bnc" id="L941" title="All 4 branches missed.">				if (shiftStart != null &amp;&amp; shiftEnd != null){</span>
<span class="nc" id="L942">					m_swapDateRangePickerPC.getStartDatePickerPC().setDate(shiftStart);</span>
<span class="nc" id="L943">					m_swapDateRangePickerPC.getEndDatePickerPC().setDate(shiftEnd);</span>
				} else
<span class="nc" id="L945">					setDateRangePickerStartAndEnd(m_swapDateRangePickerPC);</span>
			}
<span class="nc bnc" id="L947" title="All 2 branches missed.">			if (m_pickupDateRangePickerPC.getStartDatePickerPC().getDate() == null){//init picker</span>
<span class="nc bnc" id="L948" title="All 4 branches missed.">				if (shiftStart != null &amp;&amp; shiftEnd != null){</span>
<span class="nc" id="L949">					m_pickupDateRangePickerPC.getStartDatePickerPC().setDate(shiftStart);</span>
<span class="nc" id="L950">					m_pickupDateRangePickerPC.getEndDatePickerPC().setDate(shiftEnd);</span>
				} else
<span class="nc" id="L952">					setDateRangePickerStartAndEnd(m_pickupDateRangePickerPC);</span>
			}
		}
		try {
<span class="nc" id="L956">			m_requestDate1 = extractDate(REQUEST_DATE_1_FN, false);</span>
<span class="nc" id="L957">			m_requestDate2 = extractDate(REQUEST_DATE_2_FN, false);</span>
<span class="nc" id="L958">			m_expireTime1   = extractDate(EXPIRATION_FN, true);</span>
<span class="nc" id="L959">			m_swapStartDate = m_swapDateRangePickerPC.getStartDatePickerPC().getDate();</span>
<span class="nc" id="L960">			m_swapEndDate = m_swapDateRangePickerPC.getEndDatePickerPC().getDate();</span>
<span class="nc" id="L961">			m_pickupStartDate = m_pickupDateRangePickerPC.getStartDatePickerPC().getDate();</span>
<span class="nc" id="L962">			m_pickupEndDate = m_pickupDateRangePickerPC.getEndDatePickerPC().getDate();</span>
<span class="nc" id="L963">		} catch (Exception ex) {</span>
<span class="nc" id="L964">			success=false;</span>
<span class="nc" id="L965">			log.l7dError(RmWebLogBundleKey.EXTRACT_PARAM_FAILED, ex);</span>
<span class="nc" id="L966">		}</span>

<span class="nc" id="L968">		return success;</span>
	}

	public void setShiftSwapRequest(ShiftSwapRequest request) {
<span class="nc" id="L972">		m_ssRequest = request;</span>
<span class="nc" id="L973">		m_request = request;</span>
<span class="nc" id="L974">	}</span>

	public ShiftSwapRequest getShiftSwapRequest() {
<span class="nc" id="L977">		return m_ssRequest;</span>
	}

	public void setSwapType(String type) {
<span class="nc" id="L981">		m_ssRequest.setSwapType(type);</span>
<span class="nc" id="L982">	}</span>

	public String getSwapType() {
<span class="nc" id="L985">		return m_ssRequest.getSwapType();</span>
	}

	public void setShiftType(String type) {
<span class="nc" id="L989">		m_shiftType = type;</span>
<span class="nc" id="L990">	}</span>

	public String getShiftType(){
<span class="nc bnc" id="L993" title="All 2 branches missed.">		if (m_shiftType==null) m_shiftType = ShiftSwapItem.SWAPITEMTYPE_SHIFT;</span>
<span class="nc" id="L994">		return m_shiftType;</span>
	}

	public boolean isNegotiable() {
<span class="nc" id="L998">		return m_isNegotiable1;</span>
	}

	public void setIsNegotiable(boolean bSwitch){
<span class="nc" id="L1002">		m_isNegotiable1 = bSwitch;</span>
<span class="nc" id="L1003">	}</span>

	public Date getRequestDate1(){
<span class="nc" id="L1006">		return m_requestDate1;</span>
	}

	public Date getRequestDate2(){
<span class="nc" id="L1010">		return m_requestDate2;</span>
	}

	public void setExpiration(Date date) {
<span class="nc" id="L1014">		m_expireTime1 = date;</span>
<span class="nc" id="L1015">	}</span>

	public Date getExpiration(){
<span class="nc" id="L1018">		return m_expireTime1;</span>
	}

	public ID getAgentID(){
<span class="nc" id="L1022">		return m_agentID2;</span>
	}

	public void setAgentID(ID agentID){
<span class="nc" id="L1026">		m_agentID2 = agentID;</span>
<span class="nc" id="L1027">	}</span>

	public void setNegotiationComment(String comment) {
<span class="nc" id="L1030">		m_ssRequest.setNegotiationComment(comment);</span>
<span class="nc" id="L1031">	}</span>

	public String getNegotiationComment() {
<span class="nc" id="L1034">		return m_ssRequest.getNegotiationComment();</span>
	}

	/**
	 * Specify whether to submit request to Manager
	 */
	public void setIsSubmitToMgr(boolean bSwitch) {
<span class="nc" id="L1041">		m_isSubmitToMgr = bSwitch;</span>
<span class="nc" id="L1042">	}</span>

	/**
	 * Return true if Submit request to manager is enabled
	 */
	public boolean isSubmitToMgr() {
<span class="nc" id="L1048">		return m_isSubmitToMgr;</span>
	}

	public boolean isWithdrawConfirmation(){
<span class="nc" id="L1052">		boolean ret = false;</span>
<span class="nc bnc" id="L1053" title="All 4 branches missed.">		if (m_request!=null &amp;&amp; ((ShiftSwapRequest)m_request).getWithdrawInfo()!=null){</span>
<span class="nc" id="L1054">			ret = ((ShiftSwapRequest)m_request).getWithdrawInfo().getRequestStatus().equals(RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION);</span>
		}
<span class="nc" id="L1056">		return ret;</span>
	}

	/**
	 * Specify whether to show only the &quot;Submit request to Manager&quot; row.
	 */
	public void setShowSubmitToManagerOnly(boolean bSwitch) {
<span class="nc" id="L1063">		m_showSubmitToManagerOnly = bSwitch;</span>
<span class="nc" id="L1064">	}</span>

	/**
	 * Get whether to show only the &quot;Submit request to Manager&quot; row.
	 */
	public boolean getShowSubmitToManagerOnly() {
<span class="nc" id="L1070">		return m_showSubmitToManagerOnly;</span>
	}

	/**
	 * Set Posting ID
	 */
	public void setPostingID(ID id) {
<span class="nc" id="L1077">		m_postingID = id;</span>
<span class="nc" id="L1078">	}</span>

	/**
	 * Return Posting ID
	 */
	public ID getPostingID() {
<span class="nc" id="L1084">		return m_postingID;</span>
	}

	/**
	 * Return true if Creating Request From Posting
	 */
	public boolean isCreateRequestFromPosting() {
<span class="nc bnc" id="L1091" title="All 2 branches missed.">		return m_postingID!=null;</span>
	}

	/**
	 * Is Creating new Request from Scratch
	 */
	public boolean isCreateNewFromScratch() {
<span class="nc bnc" id="L1098" title="All 4 branches missed.">		return isNew() &amp;&amp; !isCreateRequestFromPosting();</span>
	}

	public void setIsSwapPartial(boolean bSwitch){
<span class="nc" id="L1102">		m_isSwapPartial = bSwitch;</span>
<span class="nc" id="L1103">	}</span>

	public boolean getIsSwapPartial(){
<span class="nc" id="L1106">		return m_isSwapPartial;</span>
	}

	public void setIsPickupPartial(boolean bSwitch){
<span class="nc" id="L1110">		m_isPickupPartial = bSwitch;</span>
<span class="nc" id="L1111">	}</span>

	public boolean getIsPickupPartial(){
<span class="nc" id="L1114">		return m_isPickupPartial;</span>
	}

	public void setSavedRequestID(ID requsetID) {
<span class="nc" id="L1118">		m_isRequestSaved = true;</span>
<span class="nc" id="L1119">		setPostingID(null);</span>
<span class="nc" id="L1120">		super.setSavedRequestID(requsetID);</span>
<span class="nc" id="L1121">	}</span>

	public void setWithdrawConfirmed(boolean bSwitch){
<span class="nc" id="L1124">		m_isWithdrawConfirmed=bSwitch;</span>
<span class="nc" id="L1125">	}</span>

	public boolean isWithdrawConfirmed(){
<span class="nc" id="L1128">		return m_isWithdrawConfirmed;</span>
	}



	public DateRangePickerPC getSwapDateRangePicker(){
<span class="nc" id="L1134">		return m_swapDateRangePickerPC;</span>
	}

	public DateRangePickerPC getPickupDateRangePicker(){
<span class="nc" id="L1138">		return m_pickupDateRangePickerPC;</span>
	}

	public ShiftSwapPosting getPosting(){
<span class="nc" id="L1142">		return m_posting;</span>
	}

	public boolean isPartialSwapAllowed(){
<span class="nc" id="L1146">		return m_allowPartial;</span>
	}

	/**
	 * Return the custom JavaScript code for the Page model.
	 */
	public String getCustomJavaScript() {
<span class="nc" id="L1153">		StringBuffer jsInitCode = new StringBuffer(512);</span>

//		 Sort Employee Names
<span class="nc" id="L1156">		List sortedENames = new ArrayList(m_eNames);</span>
<span class="nc" id="L1157">		PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>

		//add array of empIds to get index for getting org for settings
<span class="nc" id="L1160">		jsInitCode.append(&quot;var empIDIndex = new Array();\n&quot;);</span>
<span class="nc" id="L1161">		int num = 0;</span>

		// Convert to Options
<span class="nc bnc" id="L1164" title="All 2 branches missed.">		for(Iterator it=sortedENames.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L1165">			EmployeeName eName = (EmployeeName)it.next();</span>
<span class="nc" id="L1166">			String key = eName.getID().toString();</span>
<span class="nc" id="L1167">			jsInitCode.append(&quot;empIDIndex[&quot; + num + &quot;] = &quot; + key + &quot;;\n&quot;);</span>
<span class="nc" id="L1168">			num++;</span>
<span class="nc" id="L1169">		}</span>

<span class="nc" id="L1171">		jsInitCode.append(&quot;var swapArr = new Array();\n&quot;);</span>
<span class="nc" id="L1172">		jsInitCode.append(&quot;var pickupArr = new Array();\n&quot;);</span>
<span class="nc" id="L1173">		num = 0;</span>
		// Convert to Options
<span class="nc bnc" id="L1175" title="All 2 branches missed.">		for(Iterator it=sortedENames.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L1176">			EmployeeName eName = (EmployeeName)it.next();</span>
			//get setting
<span class="nc" id="L1178">			OrganizationSetting setting = (OrganizationSetting)m_orgSettingMap.get(m_empOrgMap.get(eName.getID()));</span>
<span class="nc" id="L1179">			jsInitCode.append(&quot;swapArr[&quot; + num + &quot;] = &quot; + setting.getAllowPartialShiftSwap() + &quot;;\n&quot;);</span>
<span class="nc" id="L1180">			jsInitCode.append(&quot;pickupArr[&quot; + num + &quot;] = &quot; + setting.getAllowPartialShiftPickup() + &quot;;\n&quot;);</span>
<span class="nc" id="L1181">			num++;</span>
<span class="nc" id="L1182">		}</span>

<span class="nc" id="L1184">		jsInitCode.append(&quot;\nfunction validateOrgSetting(){&quot;);</span>
		//only needed to do the check if partial swap is allowed
<span class="nc bnc" id="L1186" title="All 4 branches missed.">		if (canSwapPartial() &amp;&amp; getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT)){</span>
<span class="nc" id="L1187">			jsInitCode.append(&quot;var index = getEmpIndex(document.oFormMain.agentID.value);&quot;)</span>
<span class="nc" id="L1188">			.append(&quot;var swap = swapArr[index];&quot;)</span>
<span class="nc" id="L1189">			.append(&quot;var pickup = pickupArr[index];&quot;)</span>
<span class="nc" id="L1190">			.append(&quot;if (swap == false){&quot;)</span>
<span class="nc" id="L1191">			.append(&quot;\n\tdocument.oFormMain.isSwapPartial[1].disabled=true;\n&quot;)</span>
<span class="nc" id="L1192">			.append(&quot;\n\tdocument.oFormMain.isSwapPartial[0].checked=true;\n&quot;)</span>
<span class="nc" id="L1193">			.append(&quot;\n\tdocument.oFormMain.timeRangeSwap_START.disabled=true;\n&quot;)</span>
<span class="nc" id="L1194">			.append(&quot;\n\tdocument.oFormMain.timeRangeSwap_END.disabled=true;\n&quot;)</span>
<span class="nc" id="L1195">			.append(&quot;} else {\n&quot;)</span>
<span class="nc" id="L1196">			.append(&quot;\n\tdocument.oFormMain.isSwapPartial[1].disabled=false;\n&quot;)</span>
<span class="nc" id="L1197">			.append(&quot;\n\tdocument.oFormMain.timeRangeSwap_START.disabled=false;\n&quot;)</span>
<span class="nc" id="L1198">			.append(&quot;\n\tdocument.oFormMain.timeRangeSwap_END.disabled=false;\n&quot;)</span>
<span class="nc" id="L1199">			.append(&quot;}\n&quot;);</span>
<span class="nc bnc" id="L1200" title="All 2 branches missed.">			if (isTwoWaySwap()){</span>
<span class="nc" id="L1201">				jsInitCode.append(&quot;if (swap == false){&quot;)</span>
<span class="nc" id="L1202">					.append(&quot;\n\tdocument.oFormMain.isPickupPartial[1].disabled=true;\n&quot;)</span>
<span class="nc" id="L1203">					.append(&quot;\n\tdocument.oFormMain.timeRangePickup_START.disabled=true;\n&quot;)</span>
<span class="nc" id="L1204">					.append(&quot;\n\tdocument.oFormMain.timeRangePickup_END.disabled=true;\n&quot;)</span>
<span class="nc" id="L1205">					.append(&quot;\n\tdocument.oFormMain.isPickupPartial[0].checked=true;\n&quot;)</span>
<span class="nc" id="L1206">					.append(&quot;} else {\n&quot;)</span>
<span class="nc" id="L1207">					.append(&quot;\n\tdocument.oFormMain.isPickupPartial[1].disabled=false;\n&quot;)</span>
<span class="nc" id="L1208">					.append(&quot;\n\tdocument.oFormMain.timeRangePickup_START.disabled=false;\n&quot;)</span>
<span class="nc" id="L1209">					.append(&quot;\n\tdocument.oFormMain.timeRangePickup_END.disabled=false;\n&quot;)</span>
<span class="nc" id="L1210">					.append(&quot;}\n&quot;);</span>
			}
		}
<span class="nc" id="L1213">		jsInitCode.append(&quot;}\n&quot;);</span>

		//function to get index for employee
<span class="nc" id="L1216">		jsInitCode.append(&quot;\nfunction getEmpIndex(empID){\n&quot;)</span>
<span class="nc" id="L1217">		.append(&quot;\n\tfor (var i =0; i&lt; empIDIndex.length; i++){\n&quot;)</span>
<span class="nc" id="L1218">		.append(&quot;\n\tif (empIDIndex[i] == empID){\n&quot;)</span>
<span class="nc" id="L1219">		.append(&quot;\n\treturn i;}\n&quot;)</span>
<span class="nc" id="L1220">		.append(&quot;}\n&quot;)</span>
<span class="nc" id="L1221">		.append(&quot;}\n&quot;);</span>

<span class="nc" id="L1223">		return jsInitCode.toString();</span>
	}

	/**
	 * Return Required HTML for Request Popups
	 */
	public String getRequiredHTML() {
<span class="nc" id="L1230">		return super.getRequiredHTML() +</span>
<span class="nc" id="L1231">				HtmlUtil.makeHiddenInput(POSTING_ID_FN, m_postingID) +</span>
<span class="nc" id="L1232">				HtmlUtil.makeHiddenInput(SUBMIT_TO_MANAGER_ONLY_FN, m_showSubmitToManagerOnly);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>