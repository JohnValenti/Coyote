<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ScheduledDifferential.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.workrules.model.externalrules</a> &gt; <span class="el_source">ScheduledDifferential.java</span></div><h1>ScheduledDifferential.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.workrules.model.externalrules;

/**
 * Title:        Blue Pumpkin Software BBM
 * Description:
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author
 * @version 1.0
 */

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.Locale;
import java.util.StringTokenizer;
import java.util.TimeZone;
import java.util.TreeSet;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeInterval;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecord;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.CommonConflict;
import com.bluepumpkin.ejb.bbm.workrules.model.ExternalWorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.WorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.WorkRuleException;
import com.bluepumpkin.ejb.bbm.workrules.model.WorkRuleParameter;
import com.bluepumpkin.ejb.bbm.workrules.model.WorkRuleUtil;
import com.verint.ejb.wfm.WfmManagerFactory;

<span class="nc" id="L46">public class ScheduledDifferential implements ExternalWorkRule, java.io.Serializable {</span>

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
	HashMap m_hEmployeeImportedEvents;
	ArrayList m_aDifferentials;

	public void initialize(
		LocalDate dtStartDate,
		LocalDate dtEndDate,
		Collection pOrganizations,
		Collection cWorkResourceIDs)
		throws WorkRuleException {
<span class="nc" id="L61">		m_hEmployeeImportedEvents = new HashMap();</span>
<span class="nc" id="L62">		m_aDifferentials = new ArrayList();</span>
<span class="nc" id="L63">		ScheduleAccessManager pScheduleManager = null;</span>

		try {
<span class="nc" id="L66">			pScheduleManager = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc" id="L67">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L68">			e.printStackTrace();</span>
<span class="nc" id="L69">			throw new WorkRuleException(&quot;Failed to get Schedule Manager&quot;);</span>
<span class="nc" id="L70">		}</span>
<span class="nc" id="L71">		Date dtEarlyStart = new Date(dtStartDate.getTime().getTime() - 24 * 60 * 60 * 1000);</span>
<span class="nc" id="L72">		Date dtLateEnd = new Date(dtEndDate.getTime().getTime() + 24 * 60 * 60 * 1000);</span>

		//get the imported events
		try {
<span class="nc" id="L76">			Collection cEvents =</span>
<span class="nc" id="L77">				pScheduleManager.getEventsForWorkResources(cWorkResourceIDs, dtEarlyStart, dtLateEnd);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">			if (cEvents != null) {</span>
<span class="nc" id="L79">				Iterator j = cEvents.iterator();</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">				for (Iterator i = cWorkResourceIDs.iterator(); i.hasNext();) {</span>
<span class="nc" id="L81">					m_hEmployeeImportedEvents.put(i.next(), j.next());</span>
				}
			}
<span class="nc" id="L84">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L85">			e.printStackTrace();</span>
<span class="nc" id="L86">			throw new WorkRuleException(&quot;Failed to get Schedules&quot;);</span>
<span class="nc" id="L87">		} catch (RemoteException e) {</span>
<span class="nc" id="L88">			e.printStackTrace();</span>
<span class="nc" id="L89">			throw new WorkRuleException(&quot;Failed to get Schedules&quot;);</span>
<span class="nc" id="L90">		}</span>

		//get the differentials, this is kinda ugly...
<span class="nc" id="L93">		Jdmo jdmo = new Jdmo(true);</span>

		try {
<span class="nc" id="L96">			String query = &quot;SELECT NAME,VALUE FROM BPCONFIG WHERE NAME LIKE \'DIFFERENTIAL%\'&quot;;</span>

<span class="nc" id="L98">			JdmoRowset r = jdmo.createRowset(query);</span>

<span class="nc bnc" id="L100" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L101">				String sKey = r.getString(&quot;NAME&quot;);</span>
<span class="nc" id="L102">				String sValue = r.getString(&quot;VALUE&quot;);</span>
<span class="nc" id="L103">				m_aDifferentials.add(new Pair(sKey, new Integer(sValue)));</span>
<span class="nc" id="L104">			}</span>
<span class="nc" id="L105">		} catch (JdmoException e) {</span>
<span class="nc" id="L106">			e.printStackTrace();</span>
<span class="nc" id="L107">			throw new WorkRuleException(&quot;couldn't get differential&quot;);</span>
		} finally {
<span class="nc" id="L109">			jdmo.cleanUp();</span>
<span class="nc" id="L110">		}</span>
<span class="nc" id="L111">	}</span>

	private static int ParseKeyTime(String sKey) {
<span class="nc" id="L114">		StringTokenizer pTok = new StringTokenizer(sKey, &quot;_&quot;);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">		if (pTok.countTokens() == 3) {</span>
<span class="nc" id="L116">			String sInitial = pTok.nextToken();</span>
<span class="nc" id="L117">			String sDate = pTok.nextToken();</span>
<span class="nc" id="L118">			String sTime = pTok.nextToken();</span>

<span class="nc" id="L120">			pTok = new StringTokenizer(sTime, &quot;:&quot;);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">			if (pTok.countTokens() == 2) {</span>
<span class="nc" id="L122">				String sHour = pTok.nextToken();</span>
<span class="nc" id="L123">				String sMinute = pTok.nextToken();</span>
<span class="nc" id="L124">				return Integer.parseInt(sHour) * 60 + Integer.parseInt(sMinute);</span>
			}
		}
<span class="nc" id="L127">		return -1;</span>
	}

	private static int ParseKeyDay(String sKey) {
<span class="nc" id="L131">		StringTokenizer pTok = new StringTokenizer(sKey, &quot;_&quot;);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">		if (pTok.countTokens() == 3) {</span>
<span class="nc" id="L133">			String sInitial = pTok.nextToken();</span>
<span class="nc" id="L134">			String sDate = pTok.nextToken();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">			if (sDate.equals(&quot;Sunday&quot;))</span>
<span class="nc" id="L136">				return Calendar.SUNDAY;</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">			else if (sDate.equals(&quot;Monday&quot;))</span>
<span class="nc" id="L138">				return Calendar.MONDAY;</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">			else if (sDate.equals(&quot;Tuesday&quot;))</span>
<span class="nc" id="L140">				return Calendar.TUESDAY;</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">			else if (sDate.equals(&quot;Wednesday&quot;))</span>
<span class="nc" id="L142">				return Calendar.WEDNESDAY;</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">			else if (sDate.equals(&quot;Thursday&quot;))</span>
<span class="nc" id="L144">				return Calendar.THURSDAY;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">			else if (sDate.equals(&quot;Friday&quot;))</span>
<span class="nc" id="L146">				return Calendar.FRIDAY;</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">			else if (sDate.equals(&quot;Saturday&quot;))</span>
<span class="nc" id="L148">				return Calendar.SATURDAY;</span>
		}
<span class="nc" id="L150">		return -1;</span>
	}

	public Collection getWorkRuleConflicts(
		Collection pWorkRuleParameters,
		int nPriority,
		Organization pOrganization,
		int eOverlap,
		Date dtStartDate,
		Date dtEndDate,
		Collection pEvents,
		Collection pOldConflicts)
		throws WorkRuleException {
		//Employees who are scheduled to work Weekday Start Times specified as &lt;int&gt; are paid...
<span class="nc" id="L164">		int nDifferentialTag = ((WorkRuleParameter) pWorkRuleParameters.iterator().next()).getIntValue();</span>
<span class="nc" id="L165">		LinkedList pNewConflicts = new LinkedList();</span>

		//find the employee id
<span class="nc" id="L168">		Iterator i = pEvents.iterator();</span>
<span class="nc" id="L169">		ID idEmployee = null;</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">		if (i.hasNext()) {</span>
<span class="nc" id="L171">			Event pEvent = (Event) i.next();</span>
<span class="nc" id="L172">			idEmployee = (ID) pEvent.getWorkResourceIDs().iterator().next();</span>
<span class="nc" id="L173">		} else</span>
<span class="nc" id="L174">			return pNewConflicts;</span>

		//get the imported events for this employee
<span class="nc" id="L177">		Collection cImportedEvents = (Collection) m_hEmployeeImportedEvents.get(idEmployee);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">		if (cImportedEvents == null)</span>
<span class="nc" id="L179">			return pNewConflicts;</span>

<span class="nc" id="L181">		Calendar cCal = Calendar.getInstance(pOrganization.getTimeZone());</span>
<span class="nc" id="L182">		Calendar cCal1 = Calendar.getInstance(pOrganization.getTimeZone());</span>

		//iterate over the imported event collection
<span class="nc bnc" id="L185" title="All 2 branches missed.">		for (i = cImportedEvents.iterator(); i.hasNext();) {</span>
<span class="nc" id="L186">			Event pEvent = (Event) i.next();</span>
<span class="nc bnc" id="L187" title="All 4 branches missed.">			if (!pEvent.getPaid() || pEvent.getOverlayPrecedence() != 1)</span>
<span class="nc" id="L188">				continue;</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">			for (Iterator j = m_aDifferentials.iterator(); j.hasNext();) {</span>
<span class="nc" id="L191">				Pair pDifferential = (Pair) j.next();</span>
<span class="nc" id="L192">				String sKey = (String) pDifferential.getFirst();</span>
<span class="nc" id="L193">				Integer nValue = (Integer) pDifferential.getSecond();</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">				if (nValue.intValue() == nDifferentialTag) {</span>
<span class="nc" id="L195">					int nMinuteOffset = ParseKeyTime(sKey);</span>
<span class="nc" id="L196">					int nWeekday = ParseKeyDay(sKey);</span>
<span class="nc bnc" id="L197" title="All 4 branches missed.">					if (nMinuteOffset == -1 || nWeekday == -1)</span>
<span class="nc" id="L198">						continue;</span>

<span class="nc" id="L200">					cCal.setTime(pEvent.getStartTime());</span>
<span class="nc" id="L201">					int nStartOffset = cCal.get(Calendar.HOUR_OF_DAY) * 60 + cCal.get(Calendar.MINUTE);</span>
<span class="nc bnc" id="L202" title="All 6 branches missed.">					if (nWeekday == cCal.get(Calendar.DAY_OF_WEEK)</span>
						&amp;&amp; nStartOffset &gt;= nMinuteOffset
						&amp;&amp; nStartOffset &lt; nMinuteOffset + 30) {
						//found an imported event which triggers the differential,
						//iterate over the timerecords and create a conflict on the same day
<span class="nc bnc" id="L207" title="All 2 branches missed.">						for (Iterator k = pEvents.iterator(); k.hasNext();) {</span>
<span class="nc" id="L208">							Event pEvent1 = (Event) k.next();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">							if (pEvent1.getEventType() == Event.EVENT_TYPE_TIME_RECORD</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">								&amp;&amp; ((TimeRecord) pEvent1).getType() == TimeRecord.TIMEINTERVAL</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">								&amp;&amp; pEvent1.getPaid()</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">								&amp;&amp; WorkRuleUtil.isInPeriod(</span>
<span class="nc" id="L213">									pEvent1.getStartTime(),</span>
<span class="nc" id="L214">									pEvent1.getEndTime(),</span>
									dtStartDate,
									dtEndDate,
									eOverlap)) {
<span class="nc" id="L218">								cCal1.setTime(pEvent1.getStartTime());</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">								if (cCal1.get(Calendar.DAY_OF_YEAR) == cCal.get(Calendar.DAY_OF_YEAR)) {</span>
<span class="nc" id="L220">									CommonConflict pConflict =</span>
										new CommonConflict(
<span class="nc" id="L222">											pEvent1.getStartTime(),</span>
<span class="nc" id="L223">											pEvent1.getStartTime(),</span>
<span class="nc" id="L224">											pEvent1.getID());</span>
<span class="nc" id="L225">									TimeInterval pTimeInterval =</span>
<span class="nc" id="L226">										(TimeInterval) pEvent1.getChildren().iterator().next();</span>
<span class="nc" id="L227">									pConflict.setAdjustment(pTimeInterval.getDuration());</span>
<span class="nc" id="L228">									pNewConflicts.add(pConflict);</span>
<span class="nc" id="L229">								}</span>
<span class="nc" id="L230">							} else if (</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">								WorkRuleUtil.isInPeriodAndApproved(</span>
									pEvent1,
									dtStartDate,
									dtEndDate,
									eOverlap)) {
<span class="nc" id="L236">								cCal1.setTime(pEvent1.getStartTime());</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">								if (cCal1.get(Calendar.DAY_OF_YEAR) == cCal.get(Calendar.DAY_OF_YEAR)) {</span>
<span class="nc" id="L238">									CommonConflict pConflict =</span>
										new CommonConflict(
<span class="nc" id="L240">											pEvent1.getStartTime(),</span>
<span class="nc" id="L241">											pEvent1.getStartTime(),</span>
<span class="nc" id="L242">											pEvent1.getID());</span>
<span class="nc" id="L243">									pConflict.setAdjustment(pEvent1.getDuration());</span>
<span class="nc" id="L244">									pNewConflicts.add(pConflict);</span>
								}
							}
<span class="nc" id="L247">						}</span>
					}
				}
<span class="nc" id="L250">			}</span>
<span class="nc" id="L251">		}</span>
<span class="nc" id="L252">		return pNewConflicts;</span>
	}

	public int getLookBack(Collection pWorkRuleParameters) {
<span class="nc" id="L256">		return 0;</span>
	}

	public int getLookForward(Collection pWorkRuleParameters) {
<span class="nc" id="L260">		return 0;</span>
	}

	public boolean isValid(
		Collection pWorkRuleParameters,
		int ePeriodType,
		int nPeriodLength,
		Locale locale,
		StringBuffer sMessage) {
<span class="nc" id="L269">		return true;</span>
	}

	public static void main(String[] args) {
		try {

<span class="nc" id="L275">			ID idOrganization = new ID(-3002);</span>
<span class="nc" id="L276">			ID idEarningType = new ID(1);</span>
<span class="nc" id="L277">			LocalDate dtStartDate = new LocalDate(1910, 1, 1, 0, 0);</span>
<span class="nc" id="L278">			LocalDate dtEndDate = new LocalDate(1960, 1, 1, 0, 0);</span>

<span class="nc" id="L280">			StringBuffer sMessage = new StringBuffer();</span>

<span class="nc" id="L282">			ID idWorkResource = new ID(100);</span>
<span class="nc" id="L283">			Organization pOrganization = new Organization();</span>
<span class="nc" id="L284">			pOrganization.setID(idOrganization);</span>
<span class="nc" id="L285">			pOrganization.setTimeZone(TimeZone.getTimeZone(&quot;PST&quot;));</span>
<span class="nc" id="L286">			HashMap pActivites = new HashMap();</span>
<span class="nc" id="L287">			Collection cOrganizations = new ArrayList();</span>
<span class="nc" id="L288">			cOrganizations.add(pOrganization);</span>

<span class="nc" id="L290">			ID idActivity = new ID(1);</span>
<span class="nc" id="L291">			ID idActivity1 = new ID(2);</span>

<span class="nc" id="L293">			Collection cWorkResources = new ArrayList();</span>
<span class="nc" id="L294">			cWorkResources.add(idWorkResource);</span>

<span class="nc" id="L296">			Calendar cCalendar = Calendar.getInstance();</span>

<span class="nc" id="L298">			LocalDate dtStart = new LocalDate(1950, 7, 11, 0, 0);</span>
<span class="nc" id="L299">			LocalDate dtEnd = new LocalDate(1950, 7, 20, 0, 0);</span>

<span class="nc" id="L301">			ArrayList pEvents = new ArrayList();</span>
<span class="nc" id="L302">			ArrayList pConflicts = new ArrayList();</span>
			/*
				pEvents.add(new TestEvent(new Date(50,7,13,9,0),new Date(50,7,13,20,30))) ;
				pEvents.add(new TestEvent(new Date(50,7,14,9,0),new Date(50,7,14,19,30))) ;
			
				TimeRecord pTimeInterval1 = new TimeRecord(idWorkResource,idWorkResource,TimeRecord.EVENT_TYPE_TIME_INTERVAL);
				pTimeInterval1.addChild(new TimeInterval(idActivity,new Date(50,7,11,9,0),new Date(50,7,11,19,30),400,1,true,&quot;&quot;));
				pEvents.add(pTimeInterval1);
			
				TimeRecord pTimeInterval2 = new TimeRecord(idWorkResource,idWorkResource,TimeRecord.EVENT_TYPE_TIME_INTERVAL);
				pTimeInterval2.addChild(new TimeInterval(idActivity1,new Date(50,7,18,9,0),new Date(50,7,18,19,30),400,1,true,&quot;&quot;));
				pEvents.add(pTimeInterval2);
			
				TimeRecord pTimeInterval4 = new TimeRecord(idWorkResource,idWorkResource,TimeRecord.EVENT_TYPE_TIME_INTERVAL);
				pTimeInterval4.setID(new ID(10));
				pTimeInterval4.addChild(new TimeInterval(idActivity1,new Date(50,7,18,9,0),new Date(50,7,18,19,30),400,1,true,&quot;&quot;));
				pEvents.add(pTimeInterval4);
			
				TimeRecord pTimeInterval3 = new TimeRecord(idWorkResource,idWorkResource,TimeRecord.EVENT_TYPE_TIME_INTERVAL);
				pTimeInterval3.addChild(new TimeInterval(idActivity,new Date(50,7,11,9,0),new Date(50,7,11,19,30),400,1,true,&quot;&quot;));
				pEvents.add(pTimeInterval3);
			
			
			
				pEvents.add(new TestEvent(new Date(50,7,19,9,0),new Date(50,7,19,19,30))) ;
			*/
			//create Test WorkRule

<span class="nc" id="L330">			TreeSet pWorkRuleParameters5 = new TreeSet();</span>
<span class="nc" id="L331">			pWorkRuleParameters5.add(new WorkRuleParameter(0, WorkRuleParameter.INT, 1));</span>

<span class="nc" id="L333">			WorkRule pWorkRule5 =</span>
				new WorkRule(
					null,
					null,
					&quot;holiday adjacent to sick&quot;,
					idOrganization,
					dtStartDate,
					dtEndDate,
					WorkRule.NOPERIOD,
					0,
					idEarningType,
					0,
					pWorkRuleParameters5,
					0);
<span class="nc" id="L347">			pWorkRule5.setExternalFunction(</span>
				&quot;com.bluepumpkin.ejb.bbm.workrules.model.externalrules.ScheduledDifferential&quot;);

<span class="nc" id="L350">			System.out.println(&quot;******Validity &quot; + pWorkRule5.isValid(sMessage) + &quot; &quot; + sMessage);</span>

<span class="nc" id="L352">			pWorkRule5.initialize(dtStart, dtEnd, cOrganizations, cWorkResources, WorkRule.STARTSIN);</span>

<span class="nc" id="L354">			Collection pNewConflicts =</span>
<span class="nc" id="L355">				pWorkRule5.getConflicts(</span>
					idWorkResource,
					pOrganization,
					dtStart,
					dtEnd,
					pEvents,
					pConflicts);

<span class="nc" id="L363">			System.out.println(&quot;**********Got exceptions&quot;);</span>

<span class="nc bnc" id="L365" title="All 2 branches missed.">			for (Iterator i = pNewConflicts.iterator(); i.hasNext();) {</span>
<span class="nc" id="L366">				CommonConflict pException = (CommonConflict) i.next();</span>
<span class="nc" id="L367">				System.out.println(&quot;************************&quot; + pException);</span>
<span class="nc" id="L368">			}</span>

<span class="nc" id="L370">		} catch (Exception e) {</span>
<span class="nc" id="L371">			e.printStackTrace(System.out);</span>
<span class="nc" id="L372">		}</span>

<span class="nc" id="L374">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>