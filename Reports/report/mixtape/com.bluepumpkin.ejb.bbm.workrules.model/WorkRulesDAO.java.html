<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WorkRulesDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.workrules.model</a> &gt; <span class="el_source">WorkRulesDAO.java</span></div><h1>WorkRulesDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.workrules.model;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author
 * @version 1.0
 */

import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.TreeSet;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.TimeOfDay;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoDuplicateKeyException;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateDuplicateKeyException;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateDuplicateKeyException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;

public class WorkRulesDAO {
	
<span class="nc" id="L38">	Jdmo m_jdmo = null;</span>
	
	/**
	 * default constructor
	 */
<span class="nc" id="L43">	public WorkRulesDAO() {</span>
<span class="nc" id="L44">	}</span>
	
	private Jdmo getJdmo() {
		//XXX:RC is there a test to check connection we can put here?
<span class="nc bnc" id="L48" title="All 2 branches missed.">		if( m_jdmo == null )</span>
<span class="nc" id="L49">			m_jdmo = new Jdmo(true);</span>
<span class="nc" id="L50">		return m_jdmo;</span>
	}
	
	public HashMap GetWorkRulesForOrganization(ID idOrganization, int eType,int nDuration)
	throws WorkRuleException,BbmFinderException{
<span class="nc" id="L55">		Jdmo jdmo = getJdmo();</span>
		
		try {
			//load all work rules
<span class="nc" id="L59">			Collection cParentOrgs = DAOUtil.getParentOrganizationsCollection(idOrganization,jdmo);</span>
<span class="nc" id="L60">			cParentOrgs.add(idOrganization);</span>
			
<span class="nc" id="L62">			String query = &quot;SELECT WORKRULE.ID,WORKRULE.NAME,STARTDATE,ENDDATE,PERIODUNIT,PERIODLENGTH,&quot;+</span>
			&quot;PAYMODIFICATIONAMOUNT,EARNINGTYPEID, WORKRULETEMPLATEID,PRIORITY,ORGANIZATIONID, EXTERNALFUNCTION &quot; +
			&quot;FROM WORKRULE,WORKRULETEMPLATE &quot; +
			&quot;WHERE WORKRULE.WORKRULETEMPLATEID = WORKRULETEMPLATE.ID &quot; +
			&quot;AND ISPAYRULE = &quot; + eType +
<span class="nc" id="L67">			&quot; AND ORGANIZATIONID IN &quot; + jdmo.createInClause(cParentOrgs);</span>
			
<span class="nc bnc" id="L69" title="All 2 branches missed.">			if (nDuration != -1) {</span>
<span class="nc" id="L70">				query += &quot;AND ((PERIODUNIT = 0 AND PERIODLENGTH = &quot; + nDuration + &quot;)&quot;;</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">				if (nDuration % 7 == 0)</span>
<span class="nc" id="L72">					query += &quot;OR (PERIODUNIT = 1 AND PERIODLENGTH = &quot; + nDuration/7 + &quot;)&quot;;</span>
<span class="nc" id="L73">				query += &quot;)&quot;;</span>
			}
			
//			System.out.println(query);
<span class="nc" id="L77">			return(loadWorkRules(query));</span>
			
<span class="nc" id="L79">		} catch(JdmoException e) {</span>
<span class="nc" id="L80">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L82">			jdmo.cleanUp();</span>
		}
	}
	
	
	public HashMap GetWorkRulesByIDs(Collection cWorkRuleIDs)
	throws WorkRuleException,BbmFinderException{
		
		
<span class="nc bnc" id="L91" title="All 2 branches missed.">		if (cWorkRuleIDs.isEmpty())</span>
<span class="nc" id="L92">			return new HashMap();</span>
		
<span class="nc" id="L94">		Jdmo jdmo = getJdmo();</span>
		
		try {
			//load all work rules
<span class="nc" id="L98">			String query = &quot;SELECT WORKRULE.ID,WORKRULE.NAME,STARTDATE,ENDDATE,PERIODUNIT,PERIODLENGTH,&quot;+</span>
			&quot;PAYMODIFICATIONAMOUNT,EARNINGTYPEID, WORKRULETEMPLATEID,PRIORITY,ORGANIZATIONID, EXTERNALFUNCTION &quot; +
			&quot;FROM WORKRULE,WORKRULETEMPLATE &quot; +
			&quot;WHERE WORKRULE.WORKRULETEMPLATEID = WORKRULETEMPLATE.ID &quot; +
<span class="nc" id="L102">			&quot;AND WORKRULE.ID IN &quot; + jdmo.createInClause(cWorkRuleIDs);</span>
			
<span class="nc" id="L104">			return loadWorkRules(query);</span>
			
<span class="nc" id="L106">		} catch(JdmoException e) {</span>
<span class="nc" id="L107">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L109">			jdmo.cleanUp();</span>
		}
	}
	
	
	private HashMap loadWorkRules(String query) throws WorkRuleException,BbmFinderException{
		
<span class="nc" id="L116">		HashMap hpWorkRules = new HashMap();</span>
<span class="nc" id="L117">		Jdmo jdmo = getJdmo();</span>
		try {
<span class="nc" id="L119">			JdmoRowset r = jdmo.createRowset( query );</span>
			
			//-------------------------------------------------
			// get data and create workrules
			//-------------------------------------------------
			
<span class="nc bnc" id="L125" title="All 2 branches missed.">			while(r.next()) {</span>
				
<span class="nc" id="L127">				ID idWorkRule = r.getID(&quot;ID&quot;);</span>
<span class="nc" id="L128">				String sName = r.getString(&quot;NAME&quot;);</span>
<span class="nc" id="L129">				LocalDate dtLocalStart = TimeZoneUtil.toLocalDate(r.getTimestamp(&quot;STARTDATE&quot;));</span>
<span class="nc" id="L130">				LocalDate dtLocalEnd = TimeZoneUtil.toLocalDate(r.getTimestamp(&quot;ENDDATE&quot;));</span>
<span class="nc" id="L131">				int ePeriodType = r.getInt(&quot;PERIODUNIT&quot;);</span>
<span class="nc" id="L132">				int nPeriodLength = r.getInt(&quot;PERIODLENGTH&quot;);</span>
<span class="nc" id="L133">				double dPayModification = r.getDouble(&quot;PAYMODIFICATIONAMOUNT&quot;);</span>
<span class="nc" id="L134">				ID idEarningType = r.getID(&quot;EARNINGTYPEID&quot;);</span>
<span class="nc" id="L135">				ID idWorkRuleTemplate = r.getID(&quot;WORKRULETEMPLATEID&quot;);</span>
<span class="nc" id="L136">				int nPriority = r.getInt(&quot;PRIORITY&quot;);</span>
<span class="nc" id="L137">				ID idOrganization = r.getID(&quot;ORGANIZATIONID&quot;);</span>
<span class="nc" id="L138">				String sExternalFunction = r.getString(&quot;EXTERNALFUNCTION&quot;);</span>
				
<span class="nc" id="L140">				WorkRule pWorkRule =</span>
					new WorkRule(idWorkRule, idWorkRuleTemplate,sName,idOrganization,
							dtLocalStart,dtLocalEnd,ePeriodType,nPeriodLength,idEarningType,dPayModification
							, new TreeSet(),nPriority,sExternalFunction);
				
<span class="nc" id="L145">				hpWorkRules.put(idWorkRule,pWorkRule);</span>
<span class="nc" id="L146">			}</span>
			
<span class="nc" id="L148">			r.close();</span>
			
<span class="nc bnc" id="L150" title="All 2 branches missed.">			if (hpWorkRules.keySet().isEmpty())</span>
<span class="nc" id="L151">				return hpWorkRules;</span>
			//now load the parameters
			
<span class="nc" id="L154">			query = &quot;SELECT WORKRULEID,PARAMORDER,PARAMTYPE,INTEGERVALUE,FLOATVALUE,TIMEVALUE,&quot; +</span>
			&quot;CLAUSENUMBER,WEEKDAYNUMBER,ACTIVITYID,ACTIVITYCATEGORYID,SHIFTID,PARTOFDAY &quot; +
			&quot;FROM WORKRULEPARAMVALUE &quot;+
<span class="nc" id="L157">			&quot;WHERE WORKRULEID IN &quot; + jdmo.createInClause(hpWorkRules.keySet());</span>
			
<span class="nc" id="L159">			r = jdmo.createRowset( query );</span>
			
			//-------------------------------------------------
			// add work rule parameters
			//-------------------------------------------------
			
<span class="nc bnc" id="L165" title="All 2 branches missed.">			while(r.next()) {</span>
<span class="nc" id="L166">				ID idWorkRule = r.getID(&quot;WORKRULEID&quot;);</span>
<span class="nc" id="L167">				int nOrder = r.getInt(&quot;PARAMORDER&quot;);</span>
<span class="nc" id="L168">				int eType = r.getInt(&quot;PARAMTYPE&quot;);</span>
				
<span class="nc bnc" id="L170" title="All 2 branches missed.">				if (eType == WorkRuleParameter.INT) {</span>
<span class="nc" id="L171">					int nValue = r.getInt(&quot;INTEGERVALUE&quot;);</span>
<span class="nc" id="L172">					WorkRuleParameter pWorkRuleParameter =</span>
						new WorkRuleParameter(nOrder,eType,nValue);
<span class="nc" id="L174">					((WorkRule)hpWorkRules.get(idWorkRule)).getWorkRuleParameters().</span>
<span class="nc" id="L175">					add(pWorkRuleParameter);</span>
<span class="nc" id="L176">				}</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.DOUBLE) {</span>
<span class="nc" id="L178">					double dValue = r.getDouble(&quot;FLOATVALUE&quot;);</span>
<span class="nc" id="L179">					WorkRuleParameter pWorkRuleParameter =</span>
						new WorkRuleParameter(nOrder,eType,dValue);
<span class="nc" id="L181">					((WorkRule)hpWorkRules.get(idWorkRule)).getWorkRuleParameters().</span>
<span class="nc" id="L182">					add(pWorkRuleParameter);</span>
<span class="nc" id="L183">				}</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.TIME) {</span>
<span class="nc" id="L185">					TimeOfDay tValue = new TimeOfDay(r.getInt(&quot;TIMEVALUE&quot;));</span>
<span class="nc" id="L186">					WorkRuleParameter pWorkRuleParameter =</span>
						new WorkRuleParameter(nOrder,eType,tValue);
<span class="nc" id="L188">					((WorkRule)hpWorkRules.get(idWorkRule)).getWorkRuleParameters().</span>
<span class="nc" id="L189">					add(pWorkRuleParameter);</span>
<span class="nc" id="L190">				}</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.CLAUSE) {</span>
<span class="nc" id="L192">					int nValue = r.getInt(&quot;CLAUSENUMBER&quot;);</span>
<span class="nc" id="L193">					WorkRuleParameter pWorkRuleParameter =</span>
						new WorkRuleParameter(nOrder,eType,nValue);
<span class="nc" id="L195">					((WorkRule)hpWorkRules.get(idWorkRule)).getWorkRuleParameters().</span>
<span class="nc" id="L196">					add(pWorkRuleParameter);</span>
<span class="nc" id="L197">				}</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.WEEKDAY) {</span>
<span class="nc" id="L199">					int nValue = r.getInt(&quot;WEEKDAYNUMBER&quot;);</span>
<span class="nc" id="L200">					WorkRuleParameter pWorkRuleParameter =</span>
						new WorkRuleParameter(nOrder,eType,nValue);
<span class="nc" id="L202">					((WorkRule)hpWorkRules.get(idWorkRule)).getWorkRuleParameters().</span>
<span class="nc" id="L203">					add(pWorkRuleParameter);</span>
<span class="nc" id="L204">				}</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.ACTIVITY) {</span>
<span class="nc" id="L206">					ID idValue = r.getID(&quot;ACTIVITYID&quot;);</span>
<span class="nc" id="L207">					WorkRuleParameter pWorkRuleParameter =</span>
						new WorkRuleParameter(nOrder,eType,idValue);
<span class="nc" id="L209">					((WorkRule)hpWorkRules.get(idWorkRule)).getWorkRuleParameters().</span>
<span class="nc" id="L210">					add(pWorkRuleParameter);</span>
<span class="nc" id="L211">				}</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.ACTIVITYCATEGORY) {</span>
<span class="nc" id="L213">					ID idValue = r.getID(&quot;ACTIVITYCATEGORYID&quot;);</span>
<span class="nc" id="L214">					WorkRuleParameter pWorkRuleParameter =</span>
						new WorkRuleParameter(nOrder,eType,idValue);
<span class="nc" id="L216">					((WorkRule)hpWorkRules.get(idWorkRule)).getWorkRuleParameters().</span>
<span class="nc" id="L217">					add(pWorkRuleParameter);</span>
<span class="nc" id="L218">				}</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.SHIFT) {</span>
<span class="nc" id="L220">					ID idValue = r.getID(&quot;SHIFTID&quot;);</span>
<span class="nc" id="L221">					WorkRuleParameter pWorkRuleParameter =</span>
						new WorkRuleParameter(nOrder,eType,idValue);
<span class="nc" id="L223">					((WorkRule)hpWorkRules.get(idWorkRule)).getWorkRuleParameters().</span>
<span class="nc" id="L224">					add(pWorkRuleParameter);</span>
<span class="nc" id="L225">				}</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.PARTOFDAY) {</span>
<span class="nc" id="L227">					int nValue = r.getInt(&quot;PARTOFDAY&quot;);</span>
<span class="nc" id="L228">					WorkRuleParameter pWorkRuleParameter =</span>
						new WorkRuleParameter(nOrder,eType,nValue);
<span class="nc" id="L230">					((WorkRule)hpWorkRules.get(idWorkRule)).getWorkRuleParameters().</span>
<span class="nc" id="L231">					add(pWorkRuleParameter);</span>
<span class="nc" id="L232">				}</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.ELEMENT) {</span>
<span class="nc" id="L234">					int nValue = r.getInt(&quot;INTEGERVALUE&quot;);</span>
<span class="nc" id="L235">					WorkRuleParameter pWorkRuleParameter =</span>
						new WorkRuleParameter(nOrder,eType,nValue);
<span class="nc" id="L237">					((WorkRule)hpWorkRules.get(idWorkRule)).getWorkRuleParameters().</span>
<span class="nc" id="L238">					add(pWorkRuleParameter);</span>
				}
<span class="nc" id="L240">			}</span>
<span class="nc" id="L241">		} catch(JdmoException e) {</span>
<span class="nc" id="L242">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L244">			jdmo.cleanUp();</span>
//			jdmo = null;
<span class="nc" id="L246">		}</span>
<span class="nc" id="L247">		return hpWorkRules;</span>
	}
	
	public ID CreateWorkRule(WorkRule pWorkRule)
	throws WorkRuleException,BbmCreateException{
		
<span class="nc" id="L253">		ID generatedID = new ID(0);</span>
		//----------------------------------------------
		// create hashmap for insert into db
		//----------------------------------------------
<span class="nc" id="L257">		HashMap insertHashMap = new HashMap();</span>
<span class="nc" id="L258">		insertHashMap.put(&quot;ORGANIZATIONID&quot;,pWorkRule.getOrganizationID());</span>
<span class="nc" id="L259">		insertHashMap.put(&quot;NAME&quot;, pWorkRule.getName());</span>
<span class="nc" id="L260">		insertHashMap.put(&quot;STARTDATE&quot;, TimeZoneUtil.toTimestamp(pWorkRule.getStartDate()));</span>
<span class="nc" id="L261">		insertHashMap.put(&quot;ENDDATE&quot;, TimeZoneUtil.toTimestamp(pWorkRule.getEndDate()));</span>
<span class="nc" id="L262">		insertHashMap.put(&quot;PERIODUNIT&quot;,new Integer(pWorkRule.getPeriodType()));</span>
<span class="nc" id="L263">		insertHashMap.put(&quot;PERIODLENGTH&quot;,new Integer(pWorkRule.getPeriodLength()));</span>
<span class="nc" id="L264">		insertHashMap.put(&quot;PAYMODIFICATIONAMOUNT&quot;,new Double(pWorkRule.getPayModification()));</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">		if (pWorkRule.getEarningType() != null)</span>
<span class="nc" id="L266">			insertHashMap.put(&quot;EARNINGTYPEID&quot;,pWorkRule.getEarningType());</span>
<span class="nc" id="L267">		insertHashMap.put(&quot;WORKRULETEMPLATEID&quot;,pWorkRule.getWorkRuleTemplateId());</span>
<span class="nc" id="L268">		insertHashMap.put(&quot;PRIORITY&quot;,new Integer(pWorkRule.getPriority()));</span>
		
<span class="nc" id="L270">		Jdmo jdmo = getJdmo();</span>
		
		//----------------------------------------------
		// insert workrule into db
		//----------------------------------------------
		try {
<span class="nc" id="L276">			generatedID = jdmo.addBatchInsert(&quot;WORKRULE&quot;, insertHashMap);</span>
<span class="nc" id="L277">			jdmo.executeBatch();</span>
			
			//insert parameters into db
<span class="nc bnc" id="L280" title="All 2 branches missed.">			for( Iterator i = pWorkRule.getWorkRuleParameters().iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L281">				WorkRuleParameter pWorkRuleParameter</span>
<span class="nc" id="L282">				= (WorkRuleParameter)i.next();</span>
				
<span class="nc" id="L284">				HashMap insertHashMap1 = new HashMap();</span>
<span class="nc" id="L285">				insertHashMap1.put( &quot;WORKRULEID&quot;,generatedID);</span>
<span class="nc" id="L286">				insertHashMap1.put( &quot;PARAMORDER&quot;, new Integer(pWorkRuleParameter.getOrder()));</span>
<span class="nc" id="L287">				insertHashMap1.put( &quot;PARAMTYPE&quot;, new Integer(pWorkRuleParameter.getType()));</span>
<span class="nc" id="L288">				int eType = pWorkRuleParameter.getType();</span>
				
<span class="nc bnc" id="L290" title="All 2 branches missed.">				if (eType == WorkRuleParameter.INT) {</span>
<span class="nc" id="L291">					insertHashMap1.put( &quot;INTEGERVALUE&quot;, new Integer(pWorkRuleParameter.getIntValue()));</span>
				}
<span class="nc bnc" id="L293" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.DOUBLE) {</span>
<span class="nc" id="L294">					insertHashMap1.put( &quot;FLOATVALUE&quot;, new Double(pWorkRuleParameter.getDoubleValue()));</span>
				}
<span class="nc bnc" id="L296" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.TIME) {</span>
<span class="nc" id="L297">					insertHashMap1.put( &quot;TIMEVALUE&quot;,</span>
<span class="nc" id="L298">							new Integer(pWorkRuleParameter.getTimeValue().getMinutesSinceMindnight()));</span>
				}
<span class="nc bnc" id="L300" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.CLAUSE) {</span>
<span class="nc" id="L301">					insertHashMap1.put( &quot;CLAUSENUMBER&quot;, new Integer(pWorkRuleParameter.getClauseValue()));</span>
				}
<span class="nc bnc" id="L303" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.WEEKDAY) {</span>
<span class="nc" id="L304">					insertHashMap1.put( &quot;WEEKDAYNUMBER&quot;, new Integer(pWorkRuleParameter.getWeekDayValue()));</span>
				}
<span class="nc bnc" id="L306" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.ACTIVITY) {</span>
<span class="nc" id="L307">					insertHashMap1.put( &quot;ACTIVITYID&quot;, pWorkRuleParameter.getActivityIDValue());</span>
				}
<span class="nc bnc" id="L309" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.ACTIVITYCATEGORY) {</span>
<span class="nc" id="L310">					insertHashMap1.put( &quot;ACTIVITYCATEGORYID&quot;, pWorkRuleParameter.getActivityCategoryIDValue());</span>
				}
<span class="nc bnc" id="L312" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.SHIFT) {</span>
<span class="nc" id="L313">					insertHashMap1.put( &quot;SHIFTID&quot;, pWorkRuleParameter.getShiftIDValue());</span>
				}
<span class="nc bnc" id="L315" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.PARTOFDAY) {</span>
<span class="nc" id="L316">					insertHashMap1.put( &quot;PARTOFDAY&quot;, new Integer(pWorkRuleParameter.getIntValue()));</span>
				}
<span class="nc bnc" id="L318" title="All 2 branches missed.">				else if (eType == WorkRuleParameter.ELEMENT) {</span>
<span class="nc" id="L319">					insertHashMap1.put( &quot;INTEGERVALUE&quot;, new Integer(pWorkRuleParameter.getIntValue()));</span>
				}
				
<span class="nc" id="L322">				jdmo.addBatchInsert(&quot;WORKRULEPARAMVALUE&quot;, insertHashMap1);</span>
<span class="nc" id="L323">				jdmo.executeBatch();</span>
<span class="nc" id="L324">			}</span>
<span class="nc" id="L325">		} catch(JdmoDuplicateKeyException e) {</span>
<span class="nc" id="L326">			throw new BbmCreateDuplicateKeyException(e);</span>
<span class="nc" id="L327">		} catch(JdmoException e) {</span>
<span class="nc" id="L328">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L330">			jdmo.cleanUp();</span>
//			jdmo = null;
<span class="nc" id="L332">		}</span>
<span class="nc" id="L333">		return generatedID;</span>
	}
	
	public void RemoveWorkRule(ID idWorkRule) throws BbmRemoveException
	{
<span class="nc" id="L338">		Jdmo jdmo = getJdmo();</span>
		
<span class="nc" id="L340">		String query = &quot;DELETE FROM WORKRULEPARAMVALUE WHERE WORKRULEID = &quot; + idWorkRule;</span>
		
		try {
<span class="nc" id="L343">			jdmo.executeCommand(query);</span>
			
<span class="nc" id="L345">			query = &quot;DELETE FROM WORKRULE WHERE ID = &quot; + idWorkRule;</span>
<span class="nc" id="L346">			jdmo.executeCommand(query);</span>
			
<span class="nc" id="L348">		} catch(JdmoException e) {</span>
<span class="nc" id="L349">			throw new BbmRemoveException(e);</span>
		} finally {
<span class="nc" id="L351">			jdmo.cleanUp();</span>
//			jdmo = null;
<span class="nc" id="L353">		}</span>
<span class="nc" id="L354">	}</span>
	
	public void UpdateWorkRule(WorkRule pWorkRule)
	throws WorkRuleException,BbmUpdateException
	{
<span class="nc" id="L359">		Jdmo jdmo = getJdmo();</span>
		
		//update the work rule
<span class="nc" id="L362">		String query = &quot;UPDATE WORKRULE SET&quot; +</span>
<span class="nc" id="L363">		&quot; NAME = \'&quot; + JdmoUtil.formatDBString(pWorkRule.getName()) +</span>
<span class="nc" id="L364">		&quot;\',STARTDATE = \'&quot; + JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(pWorkRule.getStartDate())) +</span>
<span class="nc" id="L365">		&quot;\',ENDDATE = \'&quot; + JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(pWorkRule.getEndDate())) +</span>
<span class="nc" id="L366">		&quot;\',PERIODUNIT = &quot; + pWorkRule.getPeriodType() +</span>
<span class="nc" id="L367">		&quot;,PERIODLENGTH = &quot; + pWorkRule.getPeriodLength() +</span>
<span class="nc" id="L368">		&quot;,PAYMODIFICATIONAMOUNT = &quot; + pWorkRule.getPayModification();</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">		if (pWorkRule.getEarningType() != null)</span>
<span class="nc" id="L370">			query += &quot;,EARNINGTYPEID = &quot; + pWorkRule.getEarningType();</span>
		
<span class="nc" id="L372">		query += &quot;,WORKRULETEMPLATEID = &quot; + pWorkRule.getWorkRuleTemplateId();</span>
<span class="nc" id="L373">		query += &quot;,PRIORITY = &quot; + pWorkRule.getPriority();</span>
<span class="nc" id="L374">		query += &quot; WHERE ID = &quot;+ pWorkRule.getId();</span>
		
		try {
<span class="nc" id="L377">			int nUpdated = jdmo.executeCommand(query);</span>
			
<span class="nc bnc" id="L379" title="All 2 branches missed.">			if (nUpdated &gt; 0) {</span>
				//delete the parameters
<span class="nc" id="L381">				query = &quot;DELETE FROM WORKRULEPARAMVALUE WHERE WORKRULEID = &quot; + pWorkRule.getId();</span>
<span class="nc" id="L382">				jdmo.executeCommand(query);</span>
				
				//re-insert the parameters
<span class="nc bnc" id="L385" title="All 2 branches missed.">				for( Iterator i = pWorkRule.getWorkRuleParameters().iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L386">					WorkRuleParameter pWorkRuleParameter</span>
<span class="nc" id="L387">					= (WorkRuleParameter)i.next();</span>
					
<span class="nc" id="L389">					HashMap insertHashMap1 = new HashMap();</span>
<span class="nc" id="L390">					insertHashMap1.put( &quot;WORKRULEID&quot;,pWorkRule.getId());</span>
<span class="nc" id="L391">					insertHashMap1.put( &quot;PARAMORDER&quot;, new Integer(pWorkRuleParameter.getOrder()));</span>
<span class="nc" id="L392">					insertHashMap1.put( &quot;PARAMTYPE&quot;, new Integer(pWorkRuleParameter.getType()));</span>
<span class="nc" id="L393">					int eType = pWorkRuleParameter.getType();</span>
					
<span class="nc bnc" id="L395" title="All 2 branches missed.">					if (eType == WorkRuleParameter.INT) {</span>
<span class="nc" id="L396">						insertHashMap1.put( &quot;INTEGERVALUE&quot;, new Integer(pWorkRuleParameter.getIntValue()));</span>
					}
<span class="nc bnc" id="L398" title="All 2 branches missed.">					else if (eType == WorkRuleParameter.DOUBLE) {</span>
<span class="nc" id="L399">						insertHashMap1.put( &quot;FLOATVALUE&quot;, new Double(pWorkRuleParameter.getDoubleValue()));</span>
					}
<span class="nc bnc" id="L401" title="All 2 branches missed.">					else if (eType == WorkRuleParameter.TIME) {</span>
<span class="nc" id="L402">						insertHashMap1.put( &quot;TIMEVALUE&quot;,</span>
<span class="nc" id="L403">								new Integer(pWorkRuleParameter.getTimeValue().getMinutesSinceMindnight()));</span>
					}
<span class="nc bnc" id="L405" title="All 2 branches missed.">					else if (eType == WorkRuleParameter.CLAUSE) {</span>
<span class="nc" id="L406">						insertHashMap1.put( &quot;CLAUSENUMBER&quot;, new Integer(pWorkRuleParameter.getClauseValue()));</span>
					}
<span class="nc bnc" id="L408" title="All 2 branches missed.">					else if (eType == WorkRuleParameter.WEEKDAY) {</span>
<span class="nc" id="L409">						insertHashMap1.put( &quot;WEEKDAYNUMBER&quot;, new Integer(pWorkRuleParameter.getWeekDayValue()));</span>
					}
<span class="nc bnc" id="L411" title="All 2 branches missed.">					else if (eType == WorkRuleParameter.ACTIVITY) {</span>
<span class="nc" id="L412">						insertHashMap1.put( &quot;ACTIVITYID&quot;, pWorkRuleParameter.getActivityIDValue());</span>
					}
<span class="nc bnc" id="L414" title="All 2 branches missed.">					else if (eType == WorkRuleParameter.ACTIVITYCATEGORY) {</span>
<span class="nc" id="L415">						insertHashMap1.put( &quot;ACTIVITYCATEGORYID&quot;, pWorkRuleParameter.getActivityCategoryIDValue());</span>
					}
<span class="nc bnc" id="L417" title="All 2 branches missed.">					else if (eType == WorkRuleParameter.SHIFT) {</span>
<span class="nc" id="L418">						insertHashMap1.put( &quot;SHIFTID&quot;, pWorkRuleParameter.getShiftIDValue());</span>
					}
<span class="nc bnc" id="L420" title="All 2 branches missed.">					else if (eType == WorkRuleParameter.PARTOFDAY) {</span>
<span class="nc" id="L421">						insertHashMap1.put( &quot;PARTOFDAY&quot;, new Integer(pWorkRuleParameter.getIntValue()));</span>
					}
<span class="nc bnc" id="L423" title="All 2 branches missed.">					else if (eType == WorkRuleParameter.ELEMENT) {</span>
<span class="nc" id="L424">						insertHashMap1.put( &quot;INTEGERVALUE&quot;, new Integer(pWorkRuleParameter.getIntValue()));</span>
					}
					
<span class="nc" id="L427">					jdmo.addBatchInsert(&quot;WORKRULEPARAMVALUE&quot;, insertHashMap1);</span>
<span class="nc" id="L428">					jdmo.executeBatch();</span>
<span class="nc" id="L429">				}</span>
			}
<span class="nc" id="L431">		} catch(JdmoDuplicateKeyException e) {</span>
<span class="nc" id="L432">			throw new BbmUpdateDuplicateKeyException(e);</span>
<span class="nc" id="L433">		} catch(JdmoException e) {</span>
<span class="nc" id="L434">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L436">			jdmo.cleanUp();</span>
//			jdmo = null;
<span class="nc" id="L438">		}</span>
<span class="nc" id="L439">	}</span>
	
	public HashMap getWorkRuleTemplates(int eType) throws BbmFinderException {
<span class="nc" id="L442">		HashMap pWorkRuleTemplates = new HashMap();</span>
		
<span class="nc" id="L444">		Jdmo jdmo = getJdmo();</span>
		
		try {
			//load all work rules
<span class="nc" id="L448">			String query = &quot;SELECT ID,NAME,XMLTEXT,ISSCHEDULERSUPPORTED,&quot;+</span>
			&quot;EXTERNALFUNCTION,ISPAYRULE,ISBUILTIN,ISRULEWITHPERIOD &quot; +
			&quot;FROM WORKRULETEMPLATE &quot;;
<span class="nc bnc" id="L451" title="All 2 branches missed.">			if (eType != -1)</span>
<span class="nc" id="L452">				query +=&quot;WHERE ISPAYRULE = &quot; +eType;</span>
			
<span class="nc" id="L454">			JdmoRowset r = jdmo.createRowset( query );</span>
			
			//-------------------------------------------------
			// get data and create workrules
			//-------------------------------------------------
			
<span class="nc bnc" id="L460" title="All 2 branches missed.">			while(r.next()) {</span>
				
<span class="nc" id="L462">				ID idWorkRuleTemplate = r.getID(&quot;ID&quot;);</span>
<span class="nc" id="L463">				String sName = r.getString(&quot;NAME&quot;);</span>
<span class="nc" id="L464">				String sXML = r.getString(&quot;XMLTEXT&quot;);</span>
<span class="nc" id="L465">				boolean bSchedulable = r.getBoolean(&quot;ISSCHEDULERSUPPORTED&quot;);</span>
<span class="nc" id="L466">				String sExternalFunction = r.getString(&quot;EXTERNALFUNCTION&quot;);</span>
<span class="nc" id="L467">				boolean bPayRule = r.getBoolean(&quot;ISPAYRULE&quot;);</span>
<span class="nc" id="L468">				boolean bBuiltIn = r.getBoolean(&quot;ISBUILTIN&quot;);</span>
<span class="nc" id="L469">				boolean bPeriod = r.getBoolean(&quot;ISRULEWITHPERIOD&quot;);</span>
				
<span class="nc" id="L471">				WorkRuleTemplate pExternalWorkRuleTemplate = new WorkRuleTemplate(idWorkRuleTemplate,</span>
						sName,bBuiltIn,bPeriod,bPayRule,bSchedulable,sXML,
						sExternalFunction);
<span class="nc" id="L474">				pWorkRuleTemplates.put(idWorkRuleTemplate,pExternalWorkRuleTemplate);</span>
<span class="nc" id="L475">			}</span>
<span class="nc" id="L476">		} catch(JdmoException e) {</span>
<span class="nc" id="L477">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L479">			jdmo.cleanUp();</span>
//			jdmo = null;
<span class="nc" id="L481">		}</span>
<span class="nc" id="L482">		return pWorkRuleTemplates;</span>
	}
	
	public void updatePostedConflicts(HashMap hEmployeeConflicts, ID idPayPeriod)
	throws BbmUpdateException{
		
<span class="nc" id="L488">		Collection cEmployeeIDs = hEmployeeConflicts.keySet();</span>
		
<span class="nc bnc" id="L490" title="All 2 branches missed.">		if (cEmployeeIDs.isEmpty())</span>
<span class="nc" id="L491">			return;</span>
		
<span class="nc" id="L493">		Jdmo jdmo = getJdmo();</span>
		
		try {
			//delete all conflicts
<span class="nc" id="L497">			String query = &quot;DELETE FROM WORKRULEALERT &quot; +</span>
			&quot;WHERE PAYPERIODID = &quot; + idPayPeriod +
<span class="nc" id="L499">			&quot; AND WORKRESOURCEID IN &quot; + jdmo.createInClause(cEmployeeIDs);</span>
			
<span class="nc" id="L501">			jdmo.executeCommand(query);</span>
			
<span class="nc bnc" id="L503" title="All 2 branches missed.">			for( Iterator i = hEmployeeConflicts.values().iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L504">				Collection cConflicts = (Collection)i.next();</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">				for( Iterator j = cConflicts.iterator(); j.hasNext(); ) {</span>
<span class="nc" id="L506">					CommonConflict pConflict = (CommonConflict)j.next();</span>
					
<span class="nc" id="L508">					HashMap insertHashMap = new HashMap();</span>
<span class="nc" id="L509">					insertHashMap.put(&quot;WORKRESOURCEID&quot;,pConflict.getWorkResourceID());</span>
<span class="nc" id="L510">					insertHashMap.put(&quot;STARTTIME&quot;, pConflict.getStartDate());</span>
<span class="nc" id="L511">					insertHashMap.put(&quot;ENDTIME&quot;, pConflict.getEndDate());</span>
<span class="nc" id="L512">					insertHashMap.put(&quot;AMOUNT&quot;,new Double(pConflict.getAdjustment()));</span>
<span class="nc" id="L513">					insertHashMap.put(&quot;RULEDESCRIPTION&quot;,pConflict.getDescription());</span>
<span class="nc" id="L514">					insertHashMap.put(&quot;PAYPERIODID&quot;,idPayPeriod);</span>
					
<span class="nc" id="L516">					jdmo.addBatchInsert(&quot;WORKRULEALERT&quot;, insertHashMap);</span>
<span class="nc" id="L517">				}</span>
<span class="nc" id="L518">			}</span>
<span class="nc" id="L519">			jdmo.executeBatch();</span>
			
<span class="nc" id="L521">		} catch(JdmoException e) {</span>
<span class="nc" id="L522">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L524">			jdmo.cleanUp();</span>
<span class="nc" id="L525">		}</span>
<span class="nc" id="L526">	}</span>
	
	public HashMap getPostedConflicts(Collection cEmployeeIDs, ID idPayPeriod) throws
	BbmFinderException{
		
<span class="nc" id="L531">		HashMap hEmployeeConflicts = new HashMap();</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">		for( Iterator i = cEmployeeIDs.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L533">			ID idEmployee = (ID)i.next();</span>
<span class="nc" id="L534">			hEmployeeConflicts.put(idEmployee,new LinkedList());</span>
<span class="nc" id="L535">		}</span>
		
<span class="nc bnc" id="L537" title="All 2 branches missed.">		if (cEmployeeIDs.isEmpty())</span>
<span class="nc" id="L538">			return hEmployeeConflicts;</span>
		
<span class="nc" id="L540">		Jdmo jdmo = getJdmo();</span>
		
		try {
			//load all conflicts
<span class="nc" id="L544">			String query = &quot;SELECT WORKRESOURCEID,STARTTIME,ENDTIME,EARNINGTYPEID,AMOUNT,RULEDESCRIPTION &quot; +</span>
			&quot;FROM WORKRULEALERT &quot;+
			&quot;WHERE PAYPERIODID = &quot; + idPayPeriod +
<span class="nc" id="L547">			&quot; AND WORKRESOURCEID IN &quot; + jdmo.createInClause(cEmployeeIDs);</span>
			
<span class="nc" id="L549">			JdmoRowset r = jdmo.createRowset( query );</span>
			
			//-------------------------------------------------
			// get data and create workrules
			//-------------------------------------------------
			
<span class="nc bnc" id="L555" title="All 2 branches missed.">			while(r.next()) {</span>
				
<span class="nc" id="L557">				ID idWorkResource = r.getID(&quot;WORKRESOURCEID&quot;);</span>
<span class="nc" id="L558">				Date dtStartDate = r.getTimestamp(&quot;STARTTIME&quot;);</span>
<span class="nc" id="L559">				Date dtEndDate = r.getTimestamp(&quot;ENDTIME&quot;);</span>
<span class="nc" id="L560">				ID idEarningType = r.getID(&quot;EARNINGTYPEID&quot;);</span>
<span class="nc" id="L561">				double dPayModificationAmount = r.getDouble(&quot;AMOUNT&quot;);</span>
<span class="nc" id="L562">				String sName = r.getString(&quot;RULEDESCRIPTION&quot;);</span>
				
<span class="nc" id="L564">				CommonConflict pConflict = new CommonConflict(CommonConflict.PAYRULE,idWorkResource,</span>
						dtStartDate,dtEndDate,sName,idEarningType,dPayModificationAmount,0,null);
				
<span class="nc" id="L567">				((Collection)hEmployeeConflicts.get(idWorkResource)).add(pConflict);</span>
<span class="nc" id="L568">			}</span>
			
<span class="nc" id="L570">			return hEmployeeConflicts;</span>
			
<span class="nc" id="L572">		} catch(JdmoException e) {</span>
<span class="nc" id="L573">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L575">			jdmo.cleanUp();</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>