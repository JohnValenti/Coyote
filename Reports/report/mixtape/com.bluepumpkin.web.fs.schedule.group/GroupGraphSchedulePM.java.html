<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GroupGraphSchedulePM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.schedule.group</a> &gt; <span class="el_source">GroupGraphSchedulePM.java</span></div><h1>GroupGraphSchedulePM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.schedule.group;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.util.BPMessageFormat;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.SimpleEvent;
import com.bluepumpkin.ejb.bbm.timeseries.model.NetStaffingCube;
import com.bluepumpkin.ejb.bbm.vo.HOOAssignment;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.web.fs.keys.FsJavaScriptFileID;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.schedule.ScheduleViewMH;
import com.bluepumpkin.web.fs.schedule.ScheduleViewPM;
import com.bluepumpkin.web.fs.schedule.summary.DailyScheduleSummary;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        GroupGraphSchedulePM 
 * Description:  Personal Schedule printable display.
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, inc
 * @author       Chris King, Pavel Bosin
 * @version      1.0
 */
public class GroupGraphSchedulePM extends GroupSchedulePM {
	public static final String FORM_ACTION = &quot;schedulegraph&quot;;
    
    /**
     * The horizontal position to scroll to by default when the page loads.
     */
<span class="nc" id="L45">    int m_scrollX = 0;</span>
	/**
	 * Constructor
	 */
	public GroupGraphSchedulePM(RequestContext context) {
<span class="nc" id="L50">		super(context, FORM_ACTION, ScheduleViewPM.VIEW_TYPE_GROUP_GRAPH, true);</span>
<span class="nc" id="L51">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="nc" id="L52">		addRequiredJavaScriptFile(FsJavaScriptFileID.GRAPH_SCHEDULE_VIEW);</span>
<span class="nc" id="L53">	}//constructor</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L59">		return getInstance(context, GroupGraphSchedulePM.class);</span>
	}
	
	/**
	 * Initialize Component For Display
	 */
	public void initForDisplay() 
	{
<span class="nc" id="L67">		super.initForDisplay();</span>

<span class="nc" id="L69">		initNetStaffingDisambiguationMenu();</span>
<span class="nc" id="L70">		initNetStaffingPopupWindowArgs();</span>
<span class="nc" id="L71">	}</span>

    /**
     * Return the Html code to render the display of the component.
     * For 508 Accessibility compliance, we show descriptive text above the list which
     * tells the user that a textual view of the data is available.
     */
    public String getHtmlDisplay() 
    {
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (ScheduleViewMH.isAccessibilityMode(m_context))</span>
        {
<span class="nc" id="L82">            String sTemplate = &quot;&lt;table cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot; width=\&quot;100%\&quot;&gt;&quot;</span>
                    +&quot;&lt;tr&gt;&lt;td class=\&quot;schedPrefText\&quot;&gt;{0}&lt;/td&gt;&lt;/tr&gt;&quot;
                    +&quot;&lt;tr&gt;&lt;td class=\&quot;schedPrefText\&quot;&gt;{1}&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
            
<span class="nc" id="L86">            Object[] params = new Object[2];</span>
<span class="nc" id="L87">            params[0] = i18n(m_bundle, FsWebBundleKey.SV_GRAPH_ACCESSIBILITY_DESC);</span>
<span class="nc" id="L88">            params[1] = super.getHtmlDisplay();</span>
<span class="nc" id="L89">            return BPMessageFormat.format(sTemplate, params);</span>
        }
        else
        {
<span class="nc" id="L93">            return super.getHtmlDisplay();</span>
        }
    }
    
	/**
	 * populate list model m_dualList with data - prepare for rendering
	 */
	protected void populateList(HashMap theData) throws Exception
	{
<span class="nc bnc" id="L102" title="All 4 branches missed.">		if (theData==null || theData.isEmpty()) </span>
<span class="nc" id="L103">		    return;</span>

<span class="nc" id="L105">		boolean isPublished = messageIfNotPublished(theData);</span>
<span class="nc" id="L106">		Collection&lt;Collection&lt;TimeRange&gt;&gt; publishedPeriods = (Collection&lt;Collection&lt;TimeRange&gt;&gt;)theData.get(ScheduleViewMH.PUB_PERIODS_KEY);</span>
<span class="nc" id="L107">		readNetStaffingSettingsForUserAndOrg();</span>

<span class="nc" id="L109">		Collection&lt;Collection&lt;SimpleEvent&gt;&gt; schedule = (Collection&lt;Collection&lt;SimpleEvent&gt;&gt;) theData.get(ScheduleViewMH.SCHEDULE_ITEMS_KEY);</span>
<span class="nc" id="L110">		HashMap&lt;ID, Activity&gt; activities = (HashMap&lt;ID, Activity&gt;) theData.get(ScheduleViewMH.ACTIVITIES_KEY);</span>
<span class="nc" id="L111">		Map&lt;ID, Collection&lt;ID&gt;&gt; activityMedias = (Map&lt;ID, Collection&lt;ID&gt;&gt;) theData.get(ScheduleViewMH.ACTIVITY_MEDIAS_KEY);</span>
<span class="nc" id="L112">		Map&lt;ID, Collection&lt;ID&gt;&gt; activityQueues = (Map&lt;ID, Collection&lt;ID&gt;&gt;) theData.get(ScheduleViewMH.ACTIVITY_QUEUES_KEY);</span>
<span class="nc" id="L113">		HOOAssignment hoos = (HOOAssignment) theData.get(ScheduleViewMH.HOOS_KEY);</span>
<span class="nc" id="L114">		HashMap&lt;ID, EmployeeName&gt; employeeNames = (HashMap&lt;ID, EmployeeName&gt;) theData.get(ScheduleViewMH.EMPLOYEE_NAMES_KEY);</span>
<span class="nc" id="L115">		Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) theData.get(ScheduleViewMH.EMPLOYEE_IDS_KEY);	</span>
<span class="nc" id="L116">		Map&lt;ID, String&gt; campaignNamesBySpId = (Map&lt;ID, String&gt;) theData.get(ScheduleViewMH.CAMPAIGN_NAMES_BY_SP_ID_KEY);</span>
<span class="nc" id="L117">        Collection&lt;Collection&lt;DailyScheduleSummary&gt;&gt; daySummaries = (Collection&lt;Collection&lt;DailyScheduleSummary&gt;&gt;) theData.get(ScheduleViewMH.DAY_SUMMARIES_KEY);</span>
		
<span class="nc" id="L119">		boolean bShowUnavailable = showUnavailable(theData);</span>
<span class="nc" id="L120">		boolean bShowTimeoff = showTimeoff(theData);</span>
<span class="nc" id="L121">		boolean bEnabledAbsentReasonToOnlySupervisor = isEnabledAbsentReasonToOnlySupervisor();</span>
		//--- initialize generated JavaScript data objects
<span class="nc" id="L123">		startGenerateJSData();</span>
		
		try
		{
			//--- calculate shown hours range ---
<span class="nc" id="L128">			int shownHours[] = calculateShownHours(schedule, hoos, bShowUnavailable,m_dayRange);</span>
<span class="nc" id="L129">			showNetStaffingWarningIfNotAgentPage();</span>
			
			//--- set headers -------------------
<span class="nc" id="L132">			setListHeaders(shownHours);</span>
	
<span class="nc" id="L134">			ID userEID = m_context.getUser().getEmployeeID();</span>
<span class="nc" id="L135">			ArrayList&lt;DefaultMultiColumnNodeData&gt; leftListModel = new ArrayList&lt;DefaultMultiColumnNodeData&gt;();</span>
<span class="nc" id="L136">			ArrayList&lt;DefaultMultiColumnNodeData&gt; rightListModel = new ArrayList&lt;DefaultMultiColumnNodeData&gt;();</span>
	        DefaultMultiColumnNodeData leftRowData, rightRowData;
<span class="nc bnc" id="L138" title="All 6 branches missed.">			if (employeeIDs != null &amp;&amp; schedule != null &amp;&amp; publishedPeriods != null)</span>
	        {
				//--- for each employee create a rows
				// (1) the schedule row
				// (2) If net staffing ribbon enabled, the net staffing row
				// (3) If net staffing ribbon enabled, the spacer row
				
<span class="nc" id="L145">				int rowIndex = 0;</span>
<span class="nc" id="L146">				Date now = getNowSnappedTo15MinuteInterval();</span>
<span class="nc" id="L147">				boolean firstRow = true;</span>
				
<span class="nc" id="L149">				TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L150">				dstTransitionMode mode = getDstTransitionMode(tz); // this will help determine whether to add spacer cells</span>
<span class="nc" id="L151">				int dstTransitionHour = findDSTTransition(shownHours, mode, tz);</span>
				
<span class="nc" id="L153">				for (Iterator iEID = employeeIDs.iterator(),</span>
<span class="nc" id="L154">					iSchedule = schedule.iterator(),</span>
<span class="nc" id="L155">					iPub = publishedPeriods.iterator(),</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">					idaySums = daySummaries.iterator(); iEID.hasNext();)</span>
	            {
<span class="nc" id="L158">					ID eID = (ID) iEID.next();</span>
<span class="nc" id="L159">					boolean isMyRow = eID.equals(userEID);</span>
<span class="nc" id="L160">					boolean isSupervisor = isSupervisor(eID);</span>
<span class="nc" id="L161">					Collection&lt;SimpleEvent&gt; personalSchedule = (Collection&lt;SimpleEvent&gt;) iSchedule.next();</span>
<span class="nc" id="L162">					Collection&lt;DailyScheduleSummary&gt; empDaySummaries = (Collection&lt;DailyScheduleSummary&gt;)idaySums.next();</span>
<span class="nc" id="L163">	                EmployeeName employeeName = (EmployeeName) employeeNames.get(eID);</span>
					
					//(0) Add a spacer row before the user's net staffing section (unless he's first)
<span class="nc bnc" id="L166" title="All 8 branches missed.">					if (m_isNetStaffingRibbonEnabled &amp;&amp; m_isFullPageMode &amp;&amp; isMyRow &amp;&amp; !firstRow)</span>
					{
<span class="nc" id="L168">						leftRowData = makeLeftRowStringForGraph(&quot;&quot;);</span>
<span class="nc" id="L169">						leftListModel.add(leftRowData);</span>
<span class="nc" id="L170">						rightRowData = makeRightSpacerRowForGraph(m_sbJS, shownHours, rowIndex++);</span>
<span class="nc" id="L171">						rightListModel.add(rightRowData);</span>
					}
					
					// (1) the schedule row
<span class="nc" id="L175">					leftRowData = makeLeftRow(employeeName,isMyRow);</span>
<span class="nc" id="L176">					leftListModel.add(leftRowData);</span>
					//Story34045- PSR 6104 - Reason for Absence viewable only by Supervisor
<span class="nc" id="L178">					boolean isShowAbsentReason =true;</span>
<span class="nc bnc" id="L179" title="All 6 branches missed.">					if (bEnabledAbsentReasonToOnlySupervisor &amp;&amp; !isMyRow &amp;&amp; !isSupervisor)</span>
<span class="nc" id="L180">						isShowAbsentReason = false;</span>
					
<span class="nc" id="L182">					rightRowData = makeRightRowForGraph(m_context, m_sbJS, m_dayRange, </span>
							shownHours, personalSchedule, activities, bShowUnavailable, 
							bShowTimeoff, rowIndex++, isMyRow, empDaySummaries, campaignNamesBySpId,  mode, dstTransitionHour,isShowAbsentReason);
<span class="nc" id="L185">					rightListModel.add(rightRowData);</span>
					
<span class="nc bnc" id="L187" title="All 6 branches missed.">					if (m_isNetStaffingRibbonEnabled &amp;&amp; m_isFullPageMode &amp;&amp; isMyRow)</span>
					{
						// (2) the net staffing row
<span class="nc" id="L190">						leftRowData = makeLeftRowStringForGraph(i18n(m_bundle, FsWebBundleKey.NET_STAFFING));</span>
<span class="nc" id="L191">						leftListModel.add(leftRowData);</span>
						
						//TraceCube cube = null;
<span class="nc" id="L194">						NetStaffingCube nsCube = null;</span>
<span class="nc" id="L195">						Date startDate = m_dayRange.getStartDate();</span>
<span class="nc" id="L196">						Date endDate = m_dayRange.getEndDate();</span>
<span class="nc bnc" id="L197" title="All 4 branches missed.">						if (m_dayRange.getEndDate().after(now) &amp;&amp; isMyRow)</span>
						{
<span class="nc bnc" id="L199" title="All 2 branches missed.">							startDate = now.after(startDate) ? now : startDate;</span>
<span class="nc" id="L200">							nsCube = getTimeSeriesManager(m_context).getNetStaffing(eID, startDate, endDate);</span>
							
<span class="nc bnc" id="L202" title="All 2 branches missed.">							if (nsCube != null) {</span>
<span class="nc" id="L203">								loadOrgsAndOpenPeriodsForNetStaffingEmp(m_context, eID, startDate, endDate);</span>
							}
						}
						
<span class="nc" id="L207">						rightRowData = makeRightNetStaffingRowForGraph(m_context, m_sbJS, m_dayRange, startDate, endDate, </span>
								shownHours, personalSchedule, nsCube, rowIndex++, true, empDaySummaries, isPublished, mode,
								dstTransitionHour, activities, activityMedias, activityQueues);
<span class="nc" id="L210">						rightListModel.add(rightRowData);</span>
						
						// (3) the spacer row
<span class="nc" id="L213">						leftRowData = makeLeftRowStringForGraph(&quot;&quot;);</span>
<span class="nc" id="L214">						leftListModel.add(leftRowData);</span>
<span class="nc" id="L215">						rightRowData = makeRightSpacerRowForGraph(m_sbJS, shownHours, rowIndex++);</span>
<span class="nc" id="L216">						rightListModel.add(rightRowData);</span>
					}
<span class="nc" id="L218">					firstRow = false;</span>
<span class="nc" id="L219">				}</span>
			}
<span class="nc" id="L221">			setDualListModels(leftListModel, rightListModel);</span>
	        
	        //Calculate the minimum starting time of all events for all employees, to determine the amount to scroll.
<span class="nc bnc" id="L224" title="All 2 branches missed.">	        Collection scheduleEvents = (m_bGroupView)? makeSingleEventsCollectionForGroup(schedule): schedule;</span>
<span class="nc" id="L225">	        int eventHoursRange[] = getMinMaxEventHours(scheduleEvents, bShowUnavailable, m_dayRange, true);</span>
<span class="nc" id="L226">	        int minHour = eventHoursRange[0];        </span>
<span class="nc" id="L227">	        m_scrollX = 0;</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">	        if (shownHours != null)</span>
	        {
<span class="nc bnc" id="L230" title="All 2 branches missed.">	            if (minHour &gt; shownHours[0])</span>
<span class="nc" id="L231">	                m_scrollX = (minHour - shownHours[0]) * 61; //There are 61 graph pixels in an hour</span>
	        }
		}
<span class="nc" id="L234">        catch (Exception ex)</span>
        {
<span class="nc" id="L236">        	throw ex;</span>
        }
        finally
        {
    		//--- finish JS data creation
<span class="nc" id="L241">    		finishGenerateJSData();</span>
<span class="nc" id="L242">        }</span>
<span class="nc" id="L243">	}</span>

	/**
	 * Net Staffing can only be shown for one agent at a time. If this is the agent's Group view,
	 * then we will only show him his own Net Staffing data. If this is the manager's Group view,
	 * then we know that he must have multiple agents selected, since if he has more agents selected,
	 * he will automatically be shown the multiday graph view rather than this page. Therefore, if
	 * we are in the manager's view, then we should show a warning indicating that Net Staffing 
	 * will not be shown since multiple agents are selected.
	 */
	protected void showNetStaffingWarningIfNotAgentPage()
	{
<span class="nc bnc" id="L255" title="All 4 branches missed.">		if (m_isNetStaffingRibbonEnabled &amp;&amp; !m_isFullPageMode)</span>
		{
<span class="nc" id="L257">			this.addPageMessage(Message.INFO_TYPE, FsWebBundleKey.NET_STAFFING_MULTIPLE_AGENTS_WARNING, FsWebBundleKey.BUNDLE_NAME);</span>
		}
<span class="nc" id="L259">	}</span>

	/**
	 * set list headers for the multicolumn list using parent class methods
	 */
	private void setListHeaders(int[] shownHours){
<span class="nc" id="L265">		makeLeftDualLIstHeader(i18n(m_common_bundle,UIFWebBundleKey.NAME));</span>
<span class="nc" id="L266">		makeRightDualListHeader(shownHours);</span>
<span class="nc" id="L267">	}//setListHeaders</span>


    /**
     * Generate Custom JavaScript Code.
     */
    public String getCustomJavaScript() 
    {
<span class="nc" id="L275">        m_sbJS.append(&quot;\n\n&quot;);</span>
<span class="nc" id="L276">        m_sbJS.append(&quot;function scrollIt(posX){\n&quot;);</span>
<span class="nc" id="L277">        m_sbJS.append(&quot;DOM2.getElementById(\&quot;dualList_rPane\&quot;).scrollLeft = posX;\n&quot;);</span>
<span class="nc" id="L278">        m_sbJS.append(&quot;}\n\n&quot;);</span>
        
<span class="nc" id="L280">        return super.getCustomJavaScript() + m_sbJS.toString();</span>
    }//getCustomJavaScript
    
    /**
     * Return the JavaScript init code required to initialize this component.
     * This code is put in the JavaScript main() function.
     */
    public String getJavaScriptInitCode() 
    {
<span class="nc" id="L289">        StringBuffer jsInitCode = new StringBuffer(512);</span>
<span class="nc" id="L290">        jsInitCode.append(super.getJavaScriptInitCode() + &quot;scrollIt(&quot; + m_scrollX + &quot;);\n\n&quot;);</span>
<span class="nc" id="L291">        return jsInitCode.toString();</span>
    }

	protected void initRightListProperties() 
	{
<span class="nc" id="L296">		super.initRightListProperties();	</span>
<span class="nc" id="L297">		initRightListPropertiesForGraph();</span>
<span class="nc" id="L298">	}</span>
    
}//class GroupGraphSchedulePM
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>