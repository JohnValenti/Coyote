<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AuctionMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.auction</a> &gt; <span class="el_source">AuctionMH.java</span></div><h1>AuctionMH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.auction;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.IDStringPair;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.EmpWorkRuleManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.core.base.SupportNavigation;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.base.RmRuntimeException;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestDetailLevel;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionManager;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.SerializedAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb.ShiftBidRequestManager;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableSchedule;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidder;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.UnsubmittedShiftBidPreference;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.RmFilterChain;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.workresource.WorkResourceModelHandler;
import com.bluepumpkin.web.core.base.ModelHandler;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.system.RequestContext;

/**
 * File:         AuctionMH
 * Description:  Model Handler for the auctions pages
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, inc
 * @author       David Su
 * @version      1.0
 * Created on August 2, 2002, 10:15 AM
 */
<span class="nc" id="L61">public class AuctionMH extends ModelHandler {</span>
	//////////////////////////////////////////////////////////////////////////////
	// Auction Related Code
	//////////////////////////////////////////////////////////////////////////////
	public static ID createAuction(ShiftBidAuction auction) throws RmHardValidationException, Exception {
<span class="nc" id="L66">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L67">		return sbAuctionMgr.createAuction(auction);</span>
	}

	public static void updateAuction(ShiftBidAuction auction) throws RmHardValidationException, Exception {
<span class="nc" id="L71">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L72">		sbAuctionMgr.updateAuction(auction);</span>
<span class="nc" id="L73">	}</span>

	public static ShiftBidAuction getAuction(ID id) throws RmHardValidationException, Exception {
<span class="nc" id="L76">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L77">		return sbAuctionMgr.getAuctionByID(id, ShiftBidAuction.DL_CAMPAIGN);</span>
	}

	public static Collection getAuctionsByIDs(Collection auctionIds) throws RmHardValidationException, Exception {
<span class="nc" id="L81">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L82">		return sbAuctionMgr.getAuctionsByIDs(auctionIds, ShiftBidAuction.DL_CAMPAIGN);</span>
	}

	public static void removeAuction(ID id) throws RmHardValidationException, Exception {
<span class="nc" id="L86">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L87">		ArrayList idList = new ArrayList(1);</span>
<span class="nc" id="L88">		idList.add(id);</span>
<span class="nc" id="L89">		sbAuctionMgr.deleteAuctions(idList);</span>
<span class="nc" id="L90">	}</span>

	public static void openAuction(ID id) throws RmHardValidationException, Exception {
<span class="nc" id="L93">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L94">		sbAuctionMgr.openAuction(id);</span>
<span class="nc" id="L95">	}</span>

	public static void closeAuction(ID id, boolean isAddNoneApprBonus) throws RmHardValidationException, Exception {
<span class="nc" id="L98">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L99">		sbAuctionMgr.closeAuction(id, isAddNoneApprBonus);</span>
<span class="nc" id="L100">	}</span>

	public static Collection getAuctionsForManager(User user) throws RmHardValidationException, Exception {
<span class="nc" id="L103">		ID empID = user.getEmployeeID();</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (empID == null) {</span>
<span class="nc" id="L105">			return Collections.emptyList();</span>
		}

<span class="nc" id="L108">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L109">		return sbAuctionMgr.getAuctionsForManagerEmpID(empID, ShiftBidAuction.DL_BASIC | ShiftBidAuction.DL_EXCLUDE_EXPIRED_AUCTION);</span>
	}

	public static Collection getAuctionsForBidder(User user) throws RmHardValidationException, Exception {
<span class="nc" id="L113">		ID empID = user.getEmployeeID();</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">		if (empID == null) {</span>
<span class="nc" id="L115">			return Collections.emptyList();</span>
		}

<span class="nc" id="L118">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L119">		return sbAuctionMgr.getAuctionsForBidderEmpID(empID, ShiftBidAuction.DL_BASIC | ShiftBidAuction.DL_EXCLUDE_EXPIRED_AUCTION);</span>
	}

	public static Collection getAuctionsForManagerWithCampaign(User user) throws RmHardValidationException, Exception {
<span class="nc" id="L123">		ID empID = user.getEmployeeID();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">		if (empID == null) {</span>
<span class="nc" id="L125">			return Collections.emptyList();</span>
		}

<span class="nc" id="L128">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L129">		return sbAuctionMgr.getAuctionsForManagerEmpID(empID, ShiftBidAuction.DL_CAMPAIGN | ShiftBidAuction.DL_EXCLUDE_EXPIRED_AUCTION);</span>
	}

	//////////////////////////////////////////////////////////////////////////////
	// Schedules Related Code
	//////////////////////////////////////////////////////////////////////////////
	public static Collection getBiddableSchedules(ID auctionID, ID orgID, Collection bsIDs) 
            throws RmHardValidationException, Exception {
		// @todo: [OPTIMIZATION] need backend support
<span class="nc" id="L138">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L139">		Collection schedList = (Collection) sbAuctionMgr.getBiddableSchedulesForAuction(auctionID, orgID, null, null, false,</span>
                		BiddableSchedule.SORTBY_NONE, SupportNavigation.SORT_ASCENDING, Integer.MAX_VALUE,
                        BiddableSchedule.DL_SHIFT_ASSIGNMENTS_COLL | BiddableSchedule.DL_EMPLOYEE,
<span class="nc" id="L142">                        null).getSecond();</span>

<span class="nc" id="L144">		Set idSet = new HashSet(bsIDs);</span>
<span class="nc" id="L145">		List result = new ArrayList(bsIDs.size());</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">		for (Iterator it = schedList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L147">			BiddableSchedule sched = (BiddableSchedule) it.next();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">			if (idSet.contains(sched.getID())) {</span>
<span class="nc" id="L149">				result.add(sched);</span>
			}
<span class="nc" id="L151">		}</span>

<span class="nc" id="L153">		return result;</span>
	}

    public static Collection getBiddableSchedulesByIDs(Collection bsIDs, ID bidderID) throws RmHardValidationException, Exception {
<span class="nc" id="L157">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L158">		Collection schedList = sbAuctionMgr.getBiddableSchedulesByIDs(bsIDs, bidderID, true,</span>
                        BiddableSchedule.DL_SHIFT_ASSIGNMENTS_COLL |
                        BiddableSchedule.DL_EMPLOYEE |
                        BiddableSchedule.DL_SHIFT_BID_REQUEST_FOR_SHIFT_BIDDER |
				        BiddableSchedule.DL_BIDRANK_FOR_SHIFTBIDREQUEST);

<span class="nc" id="L164">		return schedList;</span>
	}

	public static Collection getBiddableSchedules(ID auctionID, ID orgID, TimeRange[] weekRanges) 
	        throws RmHardValidationException, Exception {
<span class="nc" id="L169">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L170">		return (Collection) sbAuctionMgr.getBiddableSchedulesForAuction(auctionID, orgID, null, null, false,</span>
                BiddableSchedule.SORTBY_NONE, SupportNavigation.SORT_ASCENDING, Integer.MAX_VALUE,
				BiddableSchedule.DL_SHIFT_ASSIGNMENTS_COLL | BiddableSchedule.DL_EMPLOYEE,
<span class="nc" id="L173">                weekRanges).getSecond();</span>
	}

	public static Pair getBiddableSchedulesForAuction(ID auctionID, ID orgID, ID bidderID, ID emplID, boolean byEmplType, String sortColumn, 
            boolean isSortAscending, int blockSize, TimeRange[] weekRanges)
            throws RmHardValidationException, Exception {
<span class="nc" id="L179">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>

<span class="nc bnc" id="L181" title="All 2 branches missed.">        int iSortOrder = isSortAscending?</span>
				SupportNavigation.SORT_ASCENDING:SupportNavigation.SORT_DESCENDING;

<span class="nc bnc" id="L184" title="All 2 branches missed.">		int iSortColumn = StringUtil.isEmpty(sortColumn)?</span>
<span class="nc" id="L185">				ShiftBidder.SORTBY_NONE:Integer.parseInt(sortColumn);</span>

<span class="nc" id="L187">		return sbAuctionMgr.getBiddableSchedulesForAuction(auctionID, orgID, bidderID, emplID, byEmplType,</span>
                iSortColumn, iSortOrder, blockSize,
				BiddableSchedule.DL_SHIFT_ASSIGNMENTS_COLL |
				BiddableSchedule.DL_EMPLOYEE |
				BiddableSchedule.DL_SHIFT_BID_REQUEST_FOR_SHIFT_BIDDER |
				BiddableSchedule.DL_BIDRANK_FOR_SHIFTBIDREQUEST,
                weekRanges);
	}

	/**
	 * Get biddable schedules for an auction. We pass a filter object containing all the filters.
	 * This method also takes arrays for the sort columns and sort orders, to allow for a 3-tiered
	 * sort. For example, user can sort by Template ascending, then by Monday shift start decending, 
	 * then by availability ascending. 
	 * @param auctionID
	 * @param orgID
	 * @param bidderID
	 * @param sortColumns array of up to 3 sort columns. The columns are defined in BiddableSchedule.java.
	 * @param sortOrders array of up to 3 sort orders (ascending or descending). length must match sortColumns array.
	 * @param blockSize
	 * @param filterChain
	 * @return
	 * @throws RmHardValidationException
	 * @throws Exception
	 */
	public static Pair getBiddableSchedulesForAuction(ID auctionID, ID orgID, ID bidderID, ID emplID, boolean byEmplType,
			int sortColumns[], int sortOrders[], int blockSize, RmFilterChain filterChain, TimeRange[] weekRanges)
    			throws RmHardValidationException, Exception 
	{
<span class="nc" id="L216">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>

<span class="nc" id="L218">		return sbAuctionMgr.getBiddableSchedulesForAuction(auctionID, orgID, bidderID, emplID, byEmplType,</span>
				sortColumns, sortOrders, blockSize,
			BiddableSchedule.DL_SHIFT_ASSIGNMENTS_COLL |
			BiddableSchedule.DL_EMPLOYEE |
			BiddableSchedule.DL_SHIFT_BID_REQUEST_FOR_SHIFT_BIDDER |
			BiddableSchedule.DL_BIDRANK_FOR_SHIFTBIDREQUEST,
            weekRanges,
			filterChain);
	}

	
	public static void updateSchedulesBonus(ID auctionID, Map bonusMap) throws RmHardValidationException, Exception {
<span class="nc bnc" id="L230" title="All 2 branches missed.">		if (bonusMap.isEmpty()) {</span>
<span class="nc" id="L231">			return;</span>
		}

<span class="nc" id="L234">		List bsList = new ArrayList(bonusMap.size());</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">		for(Iterator it=bonusMap.entrySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L236">			Map.Entry entry = (Map.Entry)it.next();</span>
<span class="nc" id="L237">			ID bsID = (ID)entry.getKey();</span>

<span class="nc" id="L239">			BiddableSchedule bs = new BiddableSchedule(BiddableSchedule.DL_BASIC);</span>
<span class="nc" id="L240">			bs.setID(bsID);</span>
<span class="nc" id="L241">			Object value = entry.getValue();</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">			if (value!=null) {</span>
<span class="nc" id="L243">				String strBonus = (String)value;</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">				int intBonus = StringUtil.isEmpty(strBonus) ? 0 : Integer.parseInt(strBonus);</span>
<span class="nc" id="L245">				bs.setBonusPoints(intBonus);</span>
			}
<span class="nc" id="L247">			bsList.add( bs );</span>
<span class="nc" id="L248">		}</span>

<span class="nc" id="L250">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L251">		sbAuctionMgr.updateBiddableSchedulesForAuction(auctionID, bsList, null);</span>
<span class="nc" id="L252">	}</span>

	public static void updateSchedulesBonusAndDescription(ID auctionID, Map bonusMap, Map descriptionMap) throws RmHardValidationException, Exception {
<span class="nc bnc" id="L255" title="All 4 branches missed.">		if (bonusMap.isEmpty() || descriptionMap.isEmpty()) { </span>
<span class="nc" id="L256">			return;</span>
		}

<span class="nc" id="L259">		List bsList = new ArrayList(bonusMap.size());</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">		for(Iterator it = bonusMap.entrySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L261">			Map.Entry entry = (Map.Entry)it.next();</span>
<span class="nc" id="L262">			ID bsID = (ID)entry.getKey();</span>

<span class="nc" id="L264">			BiddableSchedule bs = new BiddableSchedule(BiddableSchedule.DL_BASIC);</span>
<span class="nc" id="L265">			bs.setID(bsID);</span>
<span class="nc" id="L266">			Object value = entry.getValue();</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">			if (value!=null) {</span>
<span class="nc" id="L268">				String strBonus = (String)value;</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">				int intBonus = StringUtil.isEmpty(strBonus) ? 0 : Integer.parseInt(strBonus);</span>
<span class="nc" id="L270">				bs.setBonusPoints(intBonus);</span>
			}
			
			// Update Description for Schedule that has the same ID
<span class="nc" id="L274">			String description = (String)descriptionMap.get(bsID);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">			if (description != null) {</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">				description = StringUtil.isEmpty(description) ? null : description;</span>
<span class="nc" id="L277">				bs.setDescription(description);</span>
			}
			
<span class="nc" id="L280">			bsList.add( bs );</span>
<span class="nc" id="L281">		}</span>
		
<span class="nc" id="L283">		Collection&lt;ID&gt; descriptionIDs = descriptionMap.keySet();</span>
		
<span class="nc" id="L285">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L286">		sbAuctionMgr.updateBiddableSchedulesForAuction(auctionID, bsList, descriptionIDs);</span>
<span class="nc" id="L287">	}</span>

	public static Collection getShiftAssignments(ID auctionID, Collection scheduleIDs) 
            throws RmHardValidationException, Exception {
		// @todo: [OPTIMIZATION] need backend support
<span class="nc" id="L292">		ArrayList result = new ArrayList(10);</span>

<span class="nc" id="L294">		Collection bsList = getBiddableSchedules(auctionID, null, scheduleIDs);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">		for(Iterator it=bsList.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L296">			BiddableSchedule bSched = (BiddableSchedule)it.next();</span>
<span class="nc" id="L297">			Collection shiftAssignList = bSched.getOptMethods().getShiftAssignments();</span>
<span class="nc" id="L298">			result.addAll( shiftAssignList );</span>
<span class="nc" id="L299">		}</span>
		// @TODO: need to sort using ShiftBidAuctionUtil ShiftAssignmentComparator

<span class="nc" id="L302">		return result;</span>
	}
	
	
	/**
	 * Get a collection of IDStringPair's of WorkPatterns.
	 * @param orgIDs
	 */
	public static Collection getWorkPatternIDNamePairs (Collection orgIDs) 
		throws RemoteException, BbmFinderException, BbmEJBCreateException
	{
<span class="nc" id="L313">		EmpWorkRuleManager empWorkRuleManager = WfmManagerFactory.getEmpWorkRuleManager();</span>
<span class="nc" id="L314">		return empWorkRuleManager.getWorkPatternIDNamePairs(orgIDs);</span>
	}
	
	/**
	 * Get a collection of IDStringPair's of Shifts.
	 * @param orgIDs
	 */
	public static Collection getShiftIDNamePairs (Collection orgIDs) 		
		throws RemoteException, BbmFinderException, BbmEJBCreateException
	{
<span class="nc" id="L324">		EmpWorkRuleManager empWorkRuleManager = WfmManagerFactory.getEmpWorkRuleManager();</span>
<span class="nc" id="L325">		return empWorkRuleManager.getShiftIDNamePairs(orgIDs);</span>
	}

	/**
	 * Get a collection of IDStringPair's of EmployeeTemplate's.
	 * The templates come from the entire (unsorted, unfiltered, unpaginated) list of 
	 * BiddableSchedules for this bidder.
	 */
	public static Collection getTemplateIDNamePairs (RequestContext context, ID auctionID, ID orgID, ID bidderID, ID emplID, boolean byEmplType, TimeRange[] weekRanges)
		throws RmHardValidationException, Exception
	{
<span class="nc" id="L336">		ArrayList idStringPairs = new ArrayList();</span>
		
<span class="nc" id="L338">		Pair biddableSchedPair = AuctionMH.getBiddableSchedulesForAuction(auctionID, orgID, bidderID, emplID, byEmplType,</span>
				&quot;&quot;+BiddableSchedule.SORTBY_NONE, true, Integer.MAX_VALUE, weekRanges);
<span class="nc" id="L340">		Collection biddableSchedules = (Collection) biddableSchedPair.getSecond();</span>

<span class="nc" id="L342">		return  getTemplateIDNamePairs (context, biddableSchedules);</span>
	}
	
	/**
	 * Get a collection of IDStringPair's of EmployeeTemplate's.
	 * @param biddableSchedules The list of BiddableSchedules to get the templates from.
	 */
	public static Collection getTemplateIDNamePairs (RequestContext context, Collection biddableSchedules)
		throws RmHardValidationException, Exception
	{
<span class="nc" id="L352">		ArrayList idStringPairs = new ArrayList();</span>
		
<span class="nc bnc" id="L354" title="All 2 branches missed.">		if (biddableSchedules != null)</span>
		{
<span class="nc" id="L356">			HashMap empTemplateNameMap = AuctionUtil.getEmpTemplateNameMap(biddableSchedules, context);			</span>
			
<span class="nc bnc" id="L358" title="All 2 branches missed.">			for (Iterator it=empTemplateNameMap.keySet().iterator(); it.hasNext();)</span>
			{
<span class="nc" id="L360">				ID templateId = (ID)it.next();</span>
<span class="nc" id="L361">				String templateName = (String)empTemplateNameMap.get(templateId);</span>
<span class="nc" id="L362">				IDStringPair idStringPair = new IDStringPair(templateId, templateName);</span>
<span class="nc" id="L363">				idStringPairs.add(idStringPair);</span>
<span class="nc" id="L364">			}</span>
		}
<span class="nc" id="L366">		return idStringPairs;</span>
	}
	
	/**
	 * Returns a hashmap containing names of the employee templates used in the phantoms for display
	 * The templates come from the entire (unsorted, unfiltered, unpaginated) list of 
	 * BiddableSchedules for this bidder.
	 */
	public static HashMap getEmpTemplateNameMap(RequestContext context, ID auctionID, ID orgID, ID bidderID, ID emplID, boolean byEmplType, TimeRange[] weekRanges)
		throws RmHardValidationException, Exception
	{
<span class="nc" id="L377">		ArrayList idStringPairs = new ArrayList();</span>
		
<span class="nc" id="L379">		Pair biddableSchedPair = AuctionMH.getBiddableSchedulesForAuction(auctionID, orgID, bidderID, emplID, byEmplType,</span>
				&quot;&quot;+BiddableSchedule.SORTBY_NONE, true, Integer.MAX_VALUE, weekRanges);
<span class="nc" id="L381">		Collection biddableSchedules = (Collection) biddableSchedPair.getSecond();</span>

<span class="nc" id="L383">		HashMap empTemplateNameMap = new HashMap();</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">		if (biddableSchedules != null)</span>
		{
<span class="nc" id="L386">			empTemplateNameMap = AuctionUtil.getEmpTemplateNameMap(biddableSchedules, context);			</span>
		}
<span class="nc" id="L388">		return empTemplateNameMap;</span>
	}

	
	//////////////////////////////////////////////////////////////////////////////
	// Bidders Related Code
	//////////////////////////////////////////////////////////////////////////////
	public static EmployeeName getEmployeeNameByBidderID(RequestContext context, ID bidderID) throws RmHardValidationException, Exception {
<span class="nc" id="L396">		ShiftBidder bidder = getShiftBidderByID(bidderID);</span>
<span class="nc" id="L397">		ID empID = bidder.getEmployeeID();</span>
<span class="nc" id="L398">		return EmployeeModelHandler.getEmployeeNameByID(context, empID);</span>
	}

	public static ShiftBidder getShiftBidderByID(ID bidderID) throws RmHardValidationException, Exception {
<span class="nc" id="L402">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L403">		ShiftBidder shiftbidder = sbAuctionMgr.getShiftBidderByID(bidderID, ShiftBidder.DL_BASIC);</span>
<span class="nc" id="L404">		return shiftbidder;</span>
	}

	public static ShiftBidder getShiftBidder(ID auctionID, ID empID) throws RmHardValidationException, Exception {
<span class="nc" id="L408">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L409">		ShiftBidder shiftbidder = sbAuctionMgr.getShiftBidderForEmpID(empID, auctionID, ShiftBidder.DL_BASIC);</span>
<span class="nc" id="L410">		return shiftbidder;</span>
	}

	/**
	 * Gets the basic ShiftBidder data for the employee and specified auctions.
	 */
	public static Collection&lt;ShiftBidder&gt; getBasicShiftBidderForEmpAndAuctions(ID employeeID, Collection&lt;ID&gt; auctionIDs)
			throws Exception {
<span class="nc" id="L418">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L419">		return sbAuctionMgr.getBasicShiftBidderForEmpAndAuctions(employeeID, auctionIDs);</span>
	}

	public static Pair getBidders(ID auctionID, ID orgID, String sortColumn, boolean isSortAscending, int blockSize)
            throws RmHardValidationException, Exception {
<span class="nc" id="L424">        ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>

<span class="nc bnc" id="L426" title="All 2 branches missed.">		int iSortOrder = isSortAscending?</span>
				SupportNavigation.SORT_ASCENDING:SupportNavigation.SORT_DESCENDING;

<span class="nc bnc" id="L429" title="All 2 branches missed.">		int iSortColumn = StringUtil.isEmpty(sortColumn)?</span>
<span class="nc" id="L430">				ShiftBidder.SORTBY_NONE:Integer.parseInt(sortColumn);</span>

<span class="nc" id="L432">        return sbAuctionMgr.getShiftBiddersForAuction(auctionID, orgID, true, iSortColumn,</span>
                iSortOrder, blockSize, PrivilegeKeys.SB_MODIFYPEOPLEINAUCTIONS_ID,
				ShiftBidder.DL_BASIC | ShiftBidder.DL_EMPLOYEE | ShiftBidder.DL_NUMBER_OF_SHIFTBIDREQUESTS | ShiftBidder.DL_SHIFTBIDDER_SCORE);
	}

    	public static Collection getBidders(ID auctionID, ID orgID) throws RmHardValidationException, Exception {
<span class="nc" id="L438">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L439">		return (Collection) sbAuctionMgr.getShiftBiddersForAuction(auctionID, orgID, true, ShiftBidder.SORTBY_NONE,</span>
                SupportNavigation.SORT_ASCENDING, Integer.MAX_VALUE, PrivilegeKeys.SB_MODIFYPEOPLEINAUCTIONS_ID,
<span class="nc" id="L441">				ShiftBidder.DL_BASIC | ShiftBidder.DL_EMPLOYEE | ShiftBidder.DL_SHIFTBIDDER_SCORE | ShiftBidder.DL_NUMBER_OF_SHIFTBIDREQUESTS).getSecond();</span>
	}

	public static Collection getNextShiftBidders(ID auctionID, Collection bidderIDs)
            throws Exception, RmHardValidationException {
<span class="nc" id="L446">        ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L447">		return sbAuctionMgr.getNextShiftBidders(auctionID, bidderIDs,</span>
                ShiftBidder.DL_BASIC | ShiftBidder.DL_EMPLOYEE | ShiftBidder.DL_SHIFTBIDDER_SCORE | ShiftBidder.DL_NUMBER_OF_SHIFTBIDREQUESTS);
	}

	public static Collection getBiddersAddedToAuction(ID auctionID) throws RmHardValidationException, Exception {
<span class="nc" id="L452">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L453">		return (Collection) sbAuctionMgr.getShiftBiddersForAuction(auctionID, null, false, ShiftBidder.SORTBY_NONE, </span>
                SupportNavigation.SORT_ASCENDING, Integer.MAX_VALUE, PrivilegeKeys.SB_MODIFYPEOPLEINAUCTIONS_ID,
<span class="nc" id="L455">                ShiftBidder.DL_BASIC | ShiftBidder.DL_EMPLOYEE).getSecond();</span>
	}

	public static ID getOrgIDForEmp(RequestContext context, ID empID) throws Exception {
<span class="nc" id="L459">		ID orgID = null;</span>

<span class="nc bnc" id="L461" title="All 2 branches missed.">		if (empID!=null) {</span>
<span class="nc" id="L462">			orgID = OrganizationModelHandler.getEmployeeOrgID(context, empID);</span>
		}

<span class="nc" id="L465">		return orgID;</span>
	}

	public static int getEmpMaxPrefLevel(RequestContext context, ID empID) throws RemoteException, BbmException {
<span class="nc" id="L469">		OrganizationSetting orgSetting = RequestsMH.getOrgSettingForEmployee(context, empID);</span>
<span class="nc" id="L470">		return orgSetting.getShiftBidMaxPref();</span>
	}

	public static void updateShiftBidders(ID auctionID, Map bonusMap, Map deadlineMap) throws RmHardValidationException, Exception {
<span class="nc bnc" id="L474" title="All 2 branches missed.">		if (bonusMap.isEmpty()) {</span>
<span class="nc" id="L475">			return;</span>
		}

<span class="nc" id="L478">		List bidderList = new ArrayList(bonusMap.size());</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">		for(Iterator it=bonusMap.entrySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L480">			Map.Entry entry = (Map.Entry)it.next();</span>
<span class="nc" id="L481">			ID bidderID = (ID)entry.getKey();</span>

<span class="nc" id="L483">			ShiftBidder sb = new ShiftBidder(ShiftBidder.DL_BASIC);</span>
<span class="nc" id="L484">			sb.setID(bidderID);</span>
<span class="nc" id="L485">			Object value = entry.getValue();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">			if (value!=null) {</span>
<span class="nc" id="L487">				sb.setBonusThisAuction(Integer.parseInt((String)value));</span>
			}
<span class="nc" id="L489">			Date deadline = (Date)deadlineMap.get(bidderID);</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">			if (deadline!=null) {</span>
<span class="nc" id="L491">				sb.setDeadlineDate(deadline);</span>
			}
<span class="nc" id="L493">			bidderList.add(sb);</span>
<span class="nc" id="L494">		}</span>
<span class="nc" id="L495">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L496">		sbAuctionMgr.updateShiftBiddersForAuction(auctionID, bidderList);</span>
<span class="nc" id="L497">	}</span>

	public static void startAuctionSerialization(Collection bidderIDs,
			int rankBy, int thinkTime, ID auctionID) throws RmHardValidationException, Exception {
<span class="nc" id="L501">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L502">		sbAuctionMgr.startAuctionSerialization(auctionID, bidderIDs, thinkTime, rankBy);</span>
<span class="nc" id="L503">	}</span>

	public static void stopAuctionSerialization(ID auctionID) throws RmHardValidationException, Exception {
<span class="nc" id="L506">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L507">		sbAuctionMgr.stopAuctionSerialization(auctionID);</span>
<span class="nc" id="L508">	}</span>

	public static SerializedAuction getSerializedAuction(ID auctionID) throws RmHardValidationException, Exception {
<span class="nc" id="L511">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L512">		return sbAuctionMgr.getSerializedAuction(auctionID);</span>
	}


	public static void addShiftBidderToAuction(Collection bidderIDs, Date deadline, ID auctionID) throws RmHardValidationException, Exception {
<span class="nc bnc" id="L517" title="All 2 branches missed.">		if (bidderIDs.isEmpty()) {</span>
<span class="nc" id="L518">			return;</span>
		}

<span class="nc" id="L521">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L522">		sbAuctionMgr.addShiftBiddersToAuction(auctionID, bidderIDs, deadline);</span>
<span class="nc" id="L523">	}</span>

	public static void removeShiftBidderFromAuction(Collection bidderIDs, ID auctionID) throws RmHardValidationException, Exception {
<span class="nc" id="L526">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L527">		sbAuctionMgr.removeShiftBiddersFromAuction(auctionID, bidderIDs);</span>
<span class="nc" id="L528">	}</span>

	//////////////////////////////////////////////////////////////////////////////
	// Shift Bid Request Code
	//////////////////////////////////////////////////////////////////////////////
	/**
	 * Return ShiftBidRequest with Rank info if valid
	 */
	public static ShiftBidRequest validateRequestAndComputeRank(ShiftBidRequest request) throws RmHardValidationException, Exception {
<span class="nc" id="L537">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L538">		return (ShiftBidRequest)sbrMgr.validateRequestBeforeCreate(request);</span>
	}

	public static ID createRequest(ShiftBidRequest request, String comment) throws RmHardValidationException, Exception {
<span class="nc" id="L542">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L543">		return sbrMgr.createRequest(request, comment);</span>
	}

	public static void updateRequest(ShiftBidRequest request, String comment) throws RmHardValidationException, Exception {
<span class="nc" id="L547">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L548">		sbrMgr.updateRequest(request, comment);</span>
<span class="nc" id="L549">	}</span>

	public static ShiftBidRequest getRequest(ID id, boolean isSoftValExec) throws RmHardValidationException, Exception {
<span class="nc" id="L552">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L553">		return (ShiftBidRequest)sbrMgr.getRequestByID(id, true, isSoftValExec,</span>
				ShiftBidRequest.DL_BASIC |
				ShiftBidRequest.DL_SHIFTBID_AUCTION |
				ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL |
				ShiftBidRequest.DL_AUDIT_TRAIL |
				ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
				RequestDetailLevel.DL_INCLUDE_ZERO_NUM_OF_AVAIL_INSTANCES |
				RequestDetailLevel.DL_BIDDABLESCHEDULEINSTANCES);
	}

	public static Collection&lt;RequestAggregate&gt; getRequestsByIDs(Collection&lt;ID&gt; requestIDs) throws RmHardValidationException, Exception {
<span class="nc" id="L564">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L565">		return sbrMgr.getRequestsById(requestIDs, true, true, false,</span>
				ShiftBidRequest.DL_BASIC |
				ShiftBidRequest.DL_SHIFTBID_AUCTION |
				ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL |
				ShiftBidRequest.DL_AUDIT_TRAIL |
				ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
				RequestDetailLevel.DL_INCLUDE_ZERO_NUM_OF_AVAIL_INSTANCES |
				RequestDetailLevel.DL_BIDDABLESCHEDULEINSTANCES);
	}

	/**
	 * Gets the request with phantom/employee information as well.
	 */
	public static ShiftBidRequest getRequestWithPhantom(ID id, boolean isSoftValExec) throws RmHardValidationException, Exception {
<span class="nc" id="L579">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L580">		return (ShiftBidRequest) sbrMgr.getRequestByID(id, true, isSoftValExec,</span>
				BiddableSchedule.DL_EMPLOYEE |
				ShiftBidRequest.DL_BASIC |
				ShiftBidRequest.DL_SHIFTBID_AUCTION |
				ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL |
				ShiftBidRequest.DL_AUDIT_TRAIL |
				ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
				RequestDetailLevel.DL_INCLUDE_ZERO_NUM_OF_AVAIL_INSTANCES);
	}

	public static ID getApprovedRequestID(ID shiftBidderID, ID auctionID) throws Exception {
<span class="nc" id="L591">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L592">		return sbrMgr.getApprovedRequestID(shiftBidderID, auctionID);</span>
	}
	
	public static void withdrawApprovedBidRequest(ShiftBidRequest req, String comment) throws Exception {
<span class="nc" id="L596">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L597">		sbrMgr.withdrawApprovedBidRequest(req, comment);</span>
<span class="nc" id="L598">	}</span>

	/**
	 * The the  preference for requests that have not yet been submitted for the given employee and auction 
	 * The key is the BiddableSchedule ID and the value is the preference.  
	 */
	public static Map&lt;ID, Integer&gt; getUnsubmittedSchedulePreference(ID auctionID, ID employeeID) {
		try {
<span class="nc" id="L606">			ShiftBidRequestManager mgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L607">			return mgr.getUnsubmittedSchedulePreference(auctionID, employeeID);</span>
<span class="nc" id="L608">		} catch (Exception e) {</span>
<span class="nc" id="L609">			throw RmRuntimeException.toRuntimeException(e);</span>
		}

	}

	public static void updateUnsubmittedSchedulePreference(Collection&lt;UnsubmittedShiftBidPreference&gt; preferences) {
		try {
<span class="nc" id="L616">			ShiftBidRequestManager mgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L617">			mgr.updateUnsubmittedSchedulePreference(preferences);</span>
<span class="nc" id="L618">		} catch (Exception e) {</span>
<span class="nc" id="L619">			throw RmRuntimeException.toRuntimeException(e);</span>
<span class="nc" id="L620">		}</span>
<span class="nc" id="L621">	}</span>

	public static void createRequestsFromUnsubmittedPreferences(RequestContext context, ID auctionID, ID bidderID, ID employeeID) {
		try {
<span class="nc" id="L625">			ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L626">			ShiftBidAuction auction = sbAuctionMgr.getAuctionByID(auctionID, ShiftBidAuction.DL_BASIC);</span>

<span class="nc" id="L628">			ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L629">			int employeeRank = getEmployeeRankFromEmployeeID(context, employeeID);</span>
			
<span class="nc" id="L631">			sbrMgr.createRequestsFromUnsubmittedPreferences(auction, bidderID, employeeRank);</span>
<span class="nc" id="L632">		} catch (Exception e) {</span>
<span class="nc" id="L633">			throw RmRuntimeException.toRuntimeException(e);</span>
<span class="nc" id="L634">		}</span>
<span class="nc" id="L635">	}</span>

	public static int getTotalSubmittedBids(ID auctionID, ID bidderID) {
		try {
<span class="nc" id="L639">			ShiftBidRequestManager mgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L640">			return mgr.getTotalSubmittedBids(auctionID, bidderID);</span>
<span class="nc" id="L641">		} catch (Exception e) {</span>
<span class="nc" id="L642">			throw RmRuntimeException.toRuntimeException(e);</span>
		}
	}

	public static int getEmployeeRankFromEmployeeID(RequestContext context, ID employeeID) {
<span class="nc bnc" id="L647" title="All 2 branches missed.">		if (employeeID == null) {</span>
<span class="nc" id="L648">			return 0;</span>
		}
		try {
<span class="nc" id="L651">			Employee emp = WorkResourceModelHandler.getWorkResourceManager(context).getEmployeeByID(employeeID, null,</span>
					Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);
<span class="nc" id="L653">			return emp.getRank();</span>
<span class="nc" id="L654">		} catch (Exception e) {</span>
<span class="nc" id="L655">			throw RmRuntimeException.toRuntimeException(e);</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>