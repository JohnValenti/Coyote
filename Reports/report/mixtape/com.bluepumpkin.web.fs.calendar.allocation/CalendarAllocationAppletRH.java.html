<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CalendarAllocationAppletRH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.calendar.allocation</a> &gt; <span class="el_source">CalendarAllocationAppletRH.java</span></div><h1>CalendarAllocationAppletRH.java</h1><pre class="source lang-java linenums">/*
 * (c) 2011 Verint Systems, Inc.
 */
package com.bluepumpkin.web.fs.calendar.allocation;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOO;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.timeseries.ejb.TimeSeriesManager;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceOperator;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.core.CoreEJBCreateException;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.core.l10n.CoreWebLogBundleKey;
import com.verint.ejb.bbm.forecast.ejb.ForecastTimeSeriesManager;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.fs.optimization.CombinedQueuePartialResponse;
import com.verint.web.fs.optimization.Response;
import com.verint.web.fs.optimization.allocation.AllocationAppletKeys;
import com.verint.web.fs.optimization.allocation.AllocationAppletRH;
import com.verint.web.fs.optimization.allocation.AllocationCombinedQueueDTO;
import com.verint.web.fs.optimization.allocation.AllocationMultiQueueDTO;
import com.verint.web.fs.optimization.allocation.AllocationSingleQueueDTO;
import com.witness.web.uif.system.RequestContext;

/**
 * Handles applet requests for the Calendar Allocation Tool, a variant
 * of the Forecast Allocation applet.  This request handler uses the same
 * request keys as {@link AllocationAppletRH} except that it can also
 * handle combined queues.  It also returns predicted data as opposed to 
 * the forecast data that the superclass returns.
 */
<span class="nc" id="L54">public class CalendarAllocationAppletRH extends AllocationAppletRH {</span>

	@Override
	protected void processAppletRequest(RequestContext context, Map request, Map response) {
		try {
<span class="nc bnc" id="L59" title="All 2 branches missed.">			if (isAppletAction(request, AllocationAppletKeys.PROC_GET_ALLOCATION_COMBINED_QUEUE_APPLET_DATA)) {</span>
<span class="nc" id="L60">				getAllocationCombinedQueueAppletData(context, request, response);</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">			} else if (isAppletAction(request, AllocationAppletKeys.PROC_SAVE_PREDICTED_ALLOCATIONS_SKILLED)) {</span>
<span class="nc" id="L62">				saveAndApplyPredictedAllocationsForCombinedQueueSkilled(context, request, response);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">			} else if (isAppletAction(request, AllocationAppletKeys.PROC_SAVE_PREDICTED_ALLOCATIONS_UNSKILLED)) {</span>
<span class="nc" id="L64">				saveAndApplyPredictedAllocationsForCombinedQueueUnskilled(context, request, response);</span>
			} else {
<span class="nc" id="L66">				super.processAppletRequest(context, request, response);</span>
			}
<span class="nc" id="L68">		} catch (Exception e) {</span>
<span class="nc" id="L69">				handleError(context, e,</span>
				CoreWebLogBundleKey.APPLET_PROCESS_REQUEST_ERROR,
				CoreWebBundleKey.APPLET_PROCESS_REQUEST_ERROR,
				CoreWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L73">		}</span>
<span class="nc" id="L74">	}</span>

	/**
	 * Populates the specified response with an allocation DTO object wrapped in a
	 * response object.
	 * 
	 * @param context
	 * @param request
	 * @param response
	 */
	private void getAllocationCombinedQueueAppletData(RequestContext context, Map request, Map response) {
		try {
<span class="nc" id="L86">			Response&lt;AllocationCombinedQueueDTO&gt; partialResponse = getPartialResponseForCombinedQueue(context, request, response);</span>
<span class="nc" id="L87">			response.put(AllocationAppletKeys.RETVAL_ALLOCATION_APPLET_DATA, partialResponse);</span>
		}
<span class="nc" id="L89">		catch (Exception e) {</span>
<span class="nc" id="L90">			notifyError(context, response, e);</span>
<span class="nc" id="L91">		}</span>
<span class="nc" id="L92">	}</span>

	/**
	 * Returns the predicted child queue allocations for the specified SP queue ID.
	 */
	@Override
	protected Map&lt;ID, double[]&gt; getChildAllocations(RequestContext context, Map request, ID spQueueId)
			throws RemoteException, CoreEJBCreateException, BbmException {
<span class="nc" id="L100">		ForecastTimeSeriesManager forecastTimeSeriesManager = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L101">		return forecastTimeSeriesManager.getChildPredictedAllocationsForDistributedSpQueue(spQueueId);</span>
	}

	/**
	 * Returns the predicted child queue paid staffing levels for each fifteen-minute
	 * interval.
	 * 
	 * @param context
	 * @param spQueueId
	 * @return an empty map
	 * @throws RemoteException
	 * @throws CoreEJBCreateException
	 * @throws BbmException
	 */
	@Override
	protected Map&lt;ID, double[]&gt; getChildStaffing(RequestContext context, ID spQueueId)
			throws RemoteException, CoreEJBCreateException, BbmException {
<span class="nc" id="L118">		ForecastTimeSeriesManager forecastTimeSeriesManager = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L119">		return forecastTimeSeriesManager.getChildPredictedStaffingForDistributedSpQueue(spQueueId);</span>
	}

	/**
	 * Creates and returns a Forecast Allocation response for a combined queue.
	 * Technically it's a combined-queue full response with a bunch of single-queue
	 * partial responses packed inside.
	 */
	private Response&lt;AllocationCombinedQueueDTO&gt; getPartialResponseForCombinedQueue(RequestContext context, Map request, Map response) throws Exception 
	{
<span class="nc" id="L129">		CombinedQueuePartialResponse partialResponse = createCombinedQueuePartialResponse(context, request);</span>
<span class="nc" id="L130">		Date spStart = partialResponse.getSp().getStartTime();</span>
<span class="nc" id="L131">		Date spEnd = partialResponse.getSp().getEndTime();</span>

		// Don't need forecast data for individual queues, only for the combined queue.
<span class="nc" id="L134">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L135">		ForecastTraceCube meta = new ForecastTraceCube(new short[] {Trace.CV});</span>
<span class="nc" id="L136">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L137">		Collection&lt;TraceCube&gt; constituentForecasts = tsm.getRawCombinedQueuesTimeSeries(meta, partialResponse.getCampaign().getID(), </span>
<span class="nc" id="L138">				partialResponse.getMedia().getID(), spStart, spEnd);</span>
		TraceCube aggregateForecast;
<span class="nc bnc" id="L140" title="All 2 branches missed.">		if (constituentForecasts.size() &gt; 0) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">			for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {       		</span>
<span class="nc" id="L142">				queueMediaMap.put(partialResponse.getQueues().get(i).getID(), partialResponse.getMedia().getID());</span>
			}
<span class="nc" id="L144">			TraceCube[] forecastArray = constituentForecasts.toArray(new TraceCube[constituentForecasts.size()]); </span>
<span class="nc" id="L145">			aggregateForecast = TraceOperator.combineQueue(forecastArray, true, queueMediaMap);</span>
<span class="nc" id="L146">			adjustVolumeAhtForecastTraceValues(aggregateForecast);</span>
<span class="nc" id="L147">		} else {</span>
<span class="nc" id="L148">			aggregateForecast = createZeroForecast(null, spStart, spEnd);</span>
		}

		// Get child allocations.  For the calendar Allocation Tool applet the
		// child allocations are the predicted volume and the predicted
		// staffing for each child campaign's combined queue for the selected
		// media type over each 15-minute interval.
<span class="nc" id="L155">		Map&lt;ID, double[]&gt; combinedChildAllocations = getChildAllocations(context, request, partialResponse.getSPQueue().getID());</span>

<span class="nc" id="L157">		Map&lt;ID, double[]&gt; combinedChildStaffing = getChildStaffing(context, partialResponse.getSPQueue().getID());</span>

		// Get child campaign HOOs.
		// Then map every SP queue in the child campaign with the current media type to the HOOs to simplify
		// retrieving them later.
<span class="nc" id="L162">		Map&lt;ID, Collection&lt;CampaignHOO&gt;&gt; childSpQueueHOOs = new HashMap&lt;ID, Collection&lt;CampaignHOO&gt;&gt;();</span>
<span class="nc" id="L163">		Map&lt;ID, Campaign&gt; childCampaigns = new HashMap&lt;ID, Campaign&gt;();</span>
<span class="nc" id="L164">		Map&lt;ID, String&gt; childNames = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L165">		CampaignManager campaignManager = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L166">		Collection&lt;ID&gt; childSpIds = campaignManager.getSubSPIDsFromParentSPID(partialResponse.getSp().getID());</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">		for (ID spId : childSpIds) {</span>
<span class="nc" id="L168">			SchedulingPeriod childSp = campaignManager.getSchedulingPeriodByID(spId);</span>
<span class="nc" id="L169">			ID campaignId = childSp.getCampaignID();</span>
<span class="nc" id="L170">		    Collection&lt;CampaignHOO&gt; hoo = CampaignModelHandler.getCampaignHOOAssignments(</span>
		    		context,
		    		campaignId,
		    		spStart,
		    		spEnd);
<span class="nc" id="L175">			Campaign childCampaign = campaignManager.getCampaignByID(campaignId);</span>
<span class="nc" id="L176">			SPQueue childSpQueue = campaignManager.getCombinedSPQueue(spId, partialResponse.getMedia().getID());</span>
<span class="nc" id="L177">			childSpQueueHOOs.put(childSpQueue.getID(), hoo);</span>
<span class="nc" id="L178">			childCampaigns.put(childSpQueue.getID(), childCampaign);</span>
<span class="nc" id="L179">			childNames.put(childSpQueue.getID(), childCampaign.getName());</span>
<span class="nc" id="L180">		}</span>

		// Create partial DTOs for each single parent queue in the parent campaign with the
		// current media type.
<span class="nc" id="L184">		List&lt;AllocationSingleQueueDTO&gt; childSingleQueueDTOs = new ArrayList&lt;AllocationSingleQueueDTO&gt;();</span>
<span class="nc" id="L185">		WorkloadManager workloadManager = WfmManagerFactory.getWorkloadManager();</span>
<span class="nc" id="L186">		Collection&lt;Queue&gt; singleParentQueues = workloadManager.getNonCombinedQueuesByMediaAndSP(partialResponse.getMedia().getId(), partialResponse.getSp().getID());</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">		for (Queue singleParentQueue : singleParentQueues) {</span>
<span class="nc" id="L188">			childSingleQueueDTOs.add(new AllocationSingleQueueDTO(singleParentQueue, partialResponse.getSPQueue()));</span>
<span class="nc" id="L189">		}</span>

		// Create a multi-queue DTO with the aggregate data and the list of partial single-queue
		// DTOs.
<span class="nc" id="L193">		AllocationMultiQueueDTO multiDto = new AllocationMultiQueueDTO(</span>
				childSingleQueueDTOs,
				aggregateForecast,
				combinedChildAllocations,
				combinedChildStaffing,
				childSpQueueHOOs,
				childCampaigns,
				childNames);

		// Create a combined-queue DTO with the multi-queue delegate.
<span class="nc" id="L203">		AllocationCombinedQueueDTO combinedDto = new AllocationCombinedQueueDTO(</span>
<span class="nc" id="L204">				partialResponse.getSPQueue(),</span>
				multiDto);

		// Create and return a full response based on the combined-queue DTO.
<span class="nc" id="L208">		Response&lt;AllocationCombinedQueueDTO&gt; fullResponse = new Response&lt;AllocationCombinedQueueDTO&gt;(</span>
<span class="nc" id="L209">				partialResponse.getMedia(), </span>
<span class="nc" id="L210">				partialResponse.getCampaign(), </span>
<span class="nc" id="L211">				partialResponse.getSp(),</span>
				combinedDto,
<span class="nc" id="L213">				partialResponse.getHoursOfOperation());</span>

<span class="nc" id="L215">		return fullResponse;</span>
	}

	private static ForecastTraceCube createZeroForecast(ID queueId, Date start, Date end) throws BbmTimeSeriesException {
<span class="nc" id="L219">		short[] types = new short[] {Trace.CV};</span>
<span class="nc" id="L220">		ForecastTraceCube result = new ForecastTraceCube(queueId, start, end, types);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">		for (short type : types) {</span>
<span class="nc" id="L222">			result.initTraceValue(type, 0);</span>
		}
<span class="nc" id="L224">		return result;</span>
	}

	/**
	 * Obtains the predicted child queue allocations for each distributed parent queue
	 * with the specified media type, aggregates that data according to the specified
	 * granularity, and saves it as the queue's forecast allocation percentages.
	 */
	private void saveAndApplyPredictedAllocationsForCombinedQueueSkilled(RequestContext context, Map request, Map response) {
<span class="nc" id="L233">		Campaign campaign = (Campaign)request.get(AllocationAppletKeys.CAMPAIGN);</span>
<span class="nc" id="L234">		SPQueue spQueue = (SPQueue)request.get(AllocationAppletKeys.SP_QUEUE);</span>
<span class="nc" id="L235">		SchedulingPeriod schedulingPeriod = (SchedulingPeriod)request.get(AllocationAppletKeys.SP);</span>
<span class="nc" id="L236">		ID mediaId = (ID)request.get(AllocationAppletKeys.PARAM_MEDIA_ID);</span>
<span class="nc" id="L237">		Duration granularity = (Duration)request.get(AllocationAppletKeys.PARAM_GRANULARITY);</span>

		try
		{
<span class="nc" id="L241">			ForecastTimeSeriesManager forecastTimeSeriesManager = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>

			// Save child allocations and apply them to the forecast
<span class="nc" id="L244">			forecastTimeSeriesManager.saveAndApplyPredictedAllocationsForCombinedQueueSkilled(campaign, spQueue, schedulingPeriod, mediaId, granularity);</span>
		}
<span class="nc" id="L246">		catch (RemoteException re){</span>
<span class="nc" id="L247">			notifyError(context, response, re);</span>
		}
<span class="nc" id="L249">		catch (BbmEJBCreateException bece){</span>
<span class="nc" id="L250">			notifyError(context, response, bece);</span>
		}
<span class="nc" id="L252">		catch (BbmFinderException bfe) {</span>
<span class="nc" id="L253">			notifyError(context, response, bfe);</span>
<span class="nc" id="L254">		}		</span>
<span class="nc" id="L255">	}</span>

	/**
	 * Obtains the predicted child queue allocations for the combined parent queue
	 * with the specified media type, aggregates that data according to the specified
	 * granularity, and saves it to each constituent parent distributed queue for the
	 * specified media type as that queue's forecast allocation percentages.
	 * &lt;p&gt;
	 * Returns a collection of constituent parent queue names for parent queues that
	 * could not be updated because at least one child SpQueue in the combined predicted 
	 * allocation data did not have any child queue of the failed parent queue linked to
	 * its scheduling period.
	 */
	private void saveAndApplyPredictedAllocationsForCombinedQueueUnskilled(RequestContext context, Map request, Map response) {
<span class="nc" id="L269">		Campaign campaign = (Campaign)request.get(AllocationAppletKeys.CAMPAIGN);</span>
<span class="nc" id="L270">		SPQueue spQueue = (SPQueue)request.get(AllocationAppletKeys.SP_QUEUE);</span>
<span class="nc" id="L271">		SchedulingPeriod schedulingPeriod = (SchedulingPeriod)request.get(AllocationAppletKeys.SP);</span>
<span class="nc" id="L272">		ID mediaId = (ID)request.get(AllocationAppletKeys.PARAM_MEDIA_ID);</span>
<span class="nc" id="L273">		Duration granularity = (Duration)request.get(AllocationAppletKeys.PARAM_GRANULARITY);</span>

		try
		{
<span class="nc" id="L277">			ForecastTimeSeriesManager forecastTimeSeriesManager = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>

			// Save child allocations and apply them to the forecast
<span class="nc" id="L280">			Collection&lt;String&gt; failedSpQueues = forecastTimeSeriesManager.saveAndApplyPredictedAllocationsForCombinedQueueUnskilled(campaign, spQueue, schedulingPeriod, mediaId, granularity);</span>
<span class="nc" id="L281">			response.put(AllocationAppletKeys.RETVAL_FAILED_QUEUE_NAMES, failedSpQueues);</span>
		}
<span class="nc" id="L283">		catch (RemoteException re){</span>
<span class="nc" id="L284">			notifyError(context, response, re);</span>
		}
<span class="nc" id="L286">		catch (BbmEJBCreateException bece){</span>
<span class="nc" id="L287">			notifyError(context, response, bece);</span>
		}
<span class="nc" id="L289">		catch (BbmFinderException bfe) {</span>
<span class="nc" id="L290">			notifyError(context, response, bfe);</span>
<span class="nc" id="L291">		}		</span>
<span class="nc" id="L292">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>