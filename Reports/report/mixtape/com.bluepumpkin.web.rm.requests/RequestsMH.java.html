<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestsMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests</a> &gt; <span class="el_source">RequestsMH.java</span></div><h1>RequestsMH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests;

import java.io.Serializable;
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.IDStringPair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.DateTimeUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriodUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.CoreException;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.core.base.SupportNavigation;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.base.RmException;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestDetailLevel;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestFieldInfo;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.ejb.CommonRequestManager;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestCollection;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestFilter;
import com.bluepumpkin.ejb.rm.requests.custshift.model.CustShiftReq;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.ejb.CalendarTimeOffDayFacade;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.EmpTOPoolAssignment;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.ejb.rm.setup.settings.ejb.OrganizationConfigManager;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.people.PeopleMH;
import com.bluepumpkin.web.core.base.ModelHandler;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.UserManager;
import com.witness.web.uif.Log;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        RequestsMH
 * Description:  Handle EJB interaction for Requests
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su
 * @version 1.0
 */
<span class="fc" id="L71">public class RequestsMH extends ModelHandler {</span>
<span class="fc" id="L72">	protected static Category log	= Log.initCategory(RequestsMH.class.getName());</span>
<span class="fc" id="L73">	protected static RmManagerFactory m_managerFactory = RmManagerFactory.getInstance();</span>

	protected static CommonRequestManager getRequestManager() throws BbmCreateException {
<span class="fc" id="L76">		return m_managerFactory.getCommonRequestManager();</span>
	}

	protected static OrganizationConfigManager getOrgConfigManager() throws BbmCreateException {
<span class="fc" id="L80">		return m_managerFactory.getOrganizationConfigManager();</span>
	}

	/**
	 * Return Request Type from Filter ID
	 */
	public static String getRequestTypeFromFilterID(ID filterID) {
<span class="nc" id="L87">		String result=null;</span>

		try {
<span class="nc" id="L90">			RequestFilter rFilter = getRequestManager().getRequestFilterById(filterID);</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">			if (rFilter!=null) {</span>
<span class="nc" id="L92">				result = (String)rFilter.getValueForKey(RequestFilter.REQUEST_TYPE_KEY);</span>

<span class="nc bnc" id="L94" title="All 2 branches missed.">				if (rFilter.getValueForKey(RequestFilter.STATUS_KEY) != null</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">						&amp;&amp; rFilter.getValueForKey(RequestFilter.STATUS_KEY).equals(RequestAuditTrail.STATUS_WAITLIST)){</span>
<span class="nc" id="L96">					result = RequestAuditTrail.STATUS_WAITLIST;</span>
				}
			}
<span class="nc" id="L99">		} catch (Exception ex) {</span>
			// We can ignore this exception and just return null;
<span class="nc" id="L101">		}</span>

<span class="nc" id="L103">		return result;</span>
	}

	/**
	 * Check if there is status on Filter
	 */
	public static boolean filterDependOnStatus(ID filterID) {
<span class="nc" id="L110">		boolean result=false;</span>

		try {
<span class="nc" id="L113">			RequestFilter rFilter = getRequestManager().getRequestFilterById(filterID);</span>
<span class="nc bnc" id="L114" title="All 4 branches missed.">			if (rFilter!=null &amp;&amp; rFilter.getValueForKey(RequestFilter.STATUS_KEY) != null) {</span>
<span class="nc" id="L115">				result = true;</span>
			}
<span class="nc" id="L117">		} catch (Exception ex) {</span>
			// We can ignore this exception and just return null;
<span class="nc" id="L119">		}</span>

<span class="nc" id="L121">		return result;</span>
	}

	/**
	 * Return Filter ID and Names for specified User ID
	 */
	public static IDStringPair[] getRequestFilterNamesByUserID(ID userID)
			throws RemoteException, BbmFinderException, BbmCreateException {
<span class="fc" id="L129">		return getRequestManager().getRequestFilterNamesByUserID(userID);</span>
	}

	/**
	 * Change Request Status
	 *
	 * @param requestID The ID of the Request
	 * @param requestType The Request Type
	 * @param requestVersion The Request Value Object version
	 * @param requestStatus The request Status to change to
	 * @param comment The comment associated with the action
	 */
	public static void changeRequestStatus(ID requestID, String requestType,
			String requestVersion, String requestStatus, String comment)
			throws RemoteException, RmHardValidationException, BbmCreateException, RmException
	{
<span class="fc" id="L145">		getRequestManager().changeRequestState(requestID, requestStatus,</span>
				requestVersion, comment, requestType);
<span class="fc" id="L147">	}</span>


	/**
	 * Return Requests for specified EmployeeID and Request Type
	 *
	 * @param empID The Employee ID
	 * @param reqType The Request Type
	 * @param incExpired Specify whether expired request is included
	 * @return Collection of Requests Objects
	 */
	public static Collection&lt;RequestAggregate&gt; getRequestsForEmp(ID empID, String reqType, boolean incExpired)
			throws RemoteException, BbmFinderException, BbmCreateException, RmHardValidationException {
<span class="fc" id="L160">		return fixRequestTypeForFlexRequests(getRequestManager().getRequestsByEmployee(empID, reqType, incExpired, true, RequestAggregate.DL_AUDIT_TRAIL));</span>
	}

	/**
	 * Return Requests for specified EmployeeID and Request Type.
	 * &lt;p&gt;
	 * This was added because getRequestsForEmp will not return shift bid requests with the biddable schedules if there are 0 instances
	 * available. See ShiftBidRequestBiddableSchedule.getBiddableSchedule for details.
	 * &lt;/p&gt;
	 * RM is already slow, so it was safer to add another call with the proper detail level instead of modifying the call used elsewhere.
	 *
	 * @param empID
	 *            The Employee ID
	 * @param reqType
	 *            The Request Type
	 * @param incExpired
	 *            Specify whether expired request is included
	 * @return Collection of Requests Objects
	 */
	public static Collection&lt;RequestAggregate&gt; getRequestsForEmpFull(ID empID, String reqType, boolean incExpired)
			throws RemoteException, BbmFinderException, BbmCreateException, RmHardValidationException {

<span class="nc" id="L182">		long detailLevel = RequestAggregate.DL_AUDIT_TRAIL |</span>
				RequestDetailLevel.DL_INCLUDE_ZERO_NUM_OF_AVAIL_INSTANCES |
				ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST;

<span class="nc" id="L186">		return fixRequestTypeForFlexRequests(getRequestManager().getRequestsByEmployee(empID, reqType, incExpired, true, detailLevel));</span>
	}

	/**
	 * To save effort when implementing adding flex time requests, it is decided that the new flex time objects
	 * (with the property flexType=FLEXWITHMAKEUP) will use the request type of time-off (to reuse back end logic of time off requests.)
	 * One issue with the decision is it would complicate the front end logic to display request objects (which depends
	 * heavily on the request types.)
	 * To simplify the front end logic for the new requests, after querying requests from database,
	 * we will update the request type for flex requests to flex-time so the front end logic can handle the flex requests
	 * like the other requests (time off requests, shift swap requests etc.)
	 *
	 * @param requests
	 * @return
	 */
	protected static Collection&lt;RequestAggregate&gt; fixRequestTypeForFlexRequests(Collection&lt;RequestAggregate&gt; requests) {
<span class="pc bpc" id="L202" title="1 of 4 branches missed.">		if (requests != null &amp;&amp; !requests.isEmpty()) {</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">			for (RequestAggregate request : requests) {</span>
<span class="fc" id="L204">				fixRequestTypeForFlexRequest(request);</span>
<span class="fc" id="L205">			}</span>
		}
<span class="fc" id="L207">		return requests;</span>
	}

	/**
	 * @param request - the request to &quot;fix&quot; if it's a flex request. If not a flex request, do nothing.
	 */
	protected static RequestAggregate fixRequestTypeForFlexRequest(RequestAggregate request) {
<span class="pc bpc" id="L214" title="2 of 4 branches missed.">		if (request != null &amp;&amp; request.isFlexTimeRequest()) {</span>
<span class="nc" id="L215">			request.getAggregatedRequest().setFieldValue(RequestFieldInfo.REQUEST_S_REQUESTTYPE, Request.REQUESTTYPE_FLEXTIME);</span>
		}
<span class="fc" id="L217">		return request;</span>
	}

	private static RequestCollection fixRequestTypeForFlexRequests(RequestCollection requests) {
<span class="fc" id="L221">		fixRequestTypeForFlexRequests(requests.getRequests());</span>
<span class="fc" id="L222">		return requests;</span>
	}

	/**
	 * Return Default Request Detail Level for specified Filter Type
	 */
	private static long getDefaultDetailLevelForRequestFilter(RequestFilter reqFilter) {
<span class="fc" id="L229">		long detailLevel = RequestAggregate.DL_AUDIT_TRAIL;</span>

<span class="fc bfc" id="L231" title="All 2 branches covered.">		if (reqFilter!=null) {</span>
<span class="fc" id="L232">			String reqType = (String)reqFilter.getValueForKey(RequestFilter.REQUEST_TYPE_KEY);</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">			if (Request.REQUESTTYPE_TIMEOFF.equals(reqType)) {</span>
<span class="nc" id="L234">				detailLevel |= TORequest.DL_TIMEOFF_CHOICES</span>
						| TORequest.DL_TIMEOFF_CHOICES_LENGTH
                        | Request.DL_EMPLOYEE;
                /* commenting this, since
				String reqStatus = (String)reqFilter.getValueForKey(RequestFilter.STATUS_KEY);
				if(RequestAuditTrail.STATUS_WAITLIST.equals(reqStatus)){*/
<span class="nc" id="L240">                    detailLevel |= TORequest.DL_TIMEOFF_WAITLIST;</span>
<span class="nc" id="L241">                    detailLevel |= TORequest.DL_TIMEOFF_WITHDRAW;</span>
                /*} */
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">            } else if (Request.REQUESTTYPE_SHIFTSWAP.equals(reqType)) {</span>
<span class="nc" id="L244">				detailLevel |= ShiftSwapRequest.DL_SHIFTSWAP_ITEMS;</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">			} else if (Request.REQUESTTYPE_SHIFTBID.equals(reqType)) {</span>
<span class="nc" id="L246">				detailLevel |= ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST</span>
						| ShiftBidRequest.DL_SCORECOMPUTED_FOR_SHIFTBID_REQUEST;
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">            } else if (Request.REQUESTTYPE_CUSTSHIFT.equals(reqType)) {</span>
<span class="nc" id="L249">				detailLevel |= CustShiftReq.DL_BASIC;</span>
			}
		}

<span class="fc" id="L253">		return detailLevel;</span>
	}

	/**
	 * Return Requests for specified Manager, filter, find Name and list configuration
	 *
	 * @param empID The Employee ID of the Manager
	 * @param filterID The Filter ID to filter requests
	 * @param findName The Employee Name which Requests belong to
	 * @param blockSize The indicates the maximum number of records returned
	 * @param isSoftValEnabled Specifies whether Soft validation is enabled
	 * @return RequestCollection The Value Object which contain Collection of Requests
	 *  and HashMap of Employee Names.
	 */
	public static RequestCollection getRequestsForManager(ID empID, ID filterID,
			String findName, String sortColumn, boolean isSortAscending, int blockSize,
			boolean isSoftValEnabled, boolean isNetStaffingSoftValEnabled, Date sDate, Date eDate, String allFilterName) throws RemoteException, BbmException, RmHardValidationException {
		//ESR3001270 fix -- catch the exception if filter doesn't exists
<span class="fc" id="L271">		RequestFilter reqFilter = null;</span>
		try {
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">			reqFilter = filterID != null ? getRequestManager().getRequestFilterById(filterID) : null;</span>
		}
<span class="nc" id="L275">		catch(Exception e) {</span>
<span class="nc" id="L276">			log.info(&quot;unable to load the request filter because filter has been deleted&quot;);</span>
<span class="nc" id="L277">			e.printStackTrace();</span>
<span class="fc" id="L278">		}</span>

        // if reqFilter == null, then create a default filter.
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        if (reqFilter == null) {</span>
<span class="fc" id="L282">            reqFilter = new RequestFilter(empID, RequestUtil.DEFAULT_FILTER);//&quot;default filter&quot;);</span>
            //set key based on &quot;All&quot; vs &quot;All Active&quot;
<span class="pc bpc" id="L284" title="1 of 4 branches missed."> 			if (allFilterName != null &amp;&amp; allFilterName.equals(RequestUtil.ALL_FILTER)){</span>
<span class="fc" id="L285"> 				reqFilter.setName(RequestUtil.ALL_FILTER);</span>
 			}
<span class="fc" id="L287"> 			reqFilter.setKey(RequestFilter.REQUEST_TYPE_KEY, Request.REQUESTTYPE_ALL);</span>
        }

        //set filter date range if not null
<span class="pc bpc" id="L291" title="2 of 4 branches missed.">        if (sDate != null &amp;&amp; eDate != null){</span>
<span class="fc" id="L292">	        List dates = new ArrayList(2);</span>
<span class="fc" id="L293">	        dates.add(sDate);</span>
<span class="fc" id="L294">	        dates.add(eDate);</span>
<span class="fc" id="L295">	        reqFilter.setKey(RequestFilter.REQUEST_DATE_RANGE_KEY, (Serializable) dates);</span>
        }

<span class="fc" id="L298">        return fixRequestTypeForFlexRequests(getRequestsForManager(empID, reqFilter, findName, sortColumn, isSortAscending, blockSize, isSoftValEnabled, isNetStaffingSoftValEnabled));</span>
	}

	/**
	 * Return Requests for specified Manager, reqFilter, find Name and list configuration
	 *
	 * @param empID The Employee ID of the Manager
	 * @param reqFilter The Filter to reqFilter requests
	 * @param findName The Employee Name which Requests belong to
	 * @param blockSize The indicates the maximum number of records returned
	 * @return RequestCollection The Value Object which contain Collection of Requests
	 *  and HashMap of Employee Names.
	 */
	public static RequestCollection getRequestsForManager(ID empID, RequestFilter reqFilter,
			String findName, String sortColumn, boolean isSortAscending, int blockSize,
			boolean isSoftValEnabled, boolean isNetStaffingSoftValEnabled)	throws RemoteException, BbmException, RmHardValidationException {
<span class="pc bpc" id="L314" title="1 of 4 branches missed.">		if (findName!=null &amp;&amp; findName.trim().equals(&quot;&quot;)) {</span>
<span class="fc" id="L315">			findName = null;</span>
		}

<span class="pc bpc" id="L318" title="1 of 2 branches missed.">		int iSortOrder = isSortAscending?</span>
				SupportNavigation.SORT_ASCENDING:SupportNavigation.SORT_DESCENDING;

<span class="pc bpc" id="L321" title="1 of 2 branches missed.">		int iSortColumn = StringUtil.isEmpty(sortColumn)?</span>
<span class="pc" id="L322">				Request.SORT_LAST_NAME_FIRST:Integer.parseInt(sortColumn);</span>

<span class="fc" id="L324">		long detailLevel = getDefaultDetailLevelForRequestFilter(reqFilter);</span>
<span class="fc" id="L325">        return getRequestManager().getRequestsForManager(empID, reqFilter, findName,</span>
        		iSortColumn, iSortOrder, blockSize, true, isSoftValEnabled, isNetStaffingSoftValEnabled,
				detailLevel);

    }

	/**
	 * Return Requests for specified Manager, filter, find Name and list configuration
	 *
	 * @param empID The Employee ID of the Manager
	 * @param filterID The Filter ID to filter requests
	 * @param reqIDs The list of Requests IDs
	 * @param isSoftValEnabled Specifies whether Soft validation is enabled
	 * @return RequestCollection The Value Object which contain Collection of Requests
	 *  and HashMap of Employee Names.
	 */
	public static RequestCollection getNextRequestsForManager(ID empID, ID filterID,
			Collection reqIDs, boolean isSoftValEnabled, boolean isNetStaffingSoftValEnabled) throws RemoteException, BbmException, RmHardValidationException {
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">		List requestIDs = (reqIDs instanceof List)?(List)reqIDs:new ArrayList(reqIDs);</span>

<span class="pc bpc" id="L345" title="1 of 2 branches missed.">		RequestFilter reqFilter = filterID!=null?getRequestManager().getRequestFilterById(filterID) : null;</span>
<span class="fc" id="L346">		long detailLevel = getDefaultDetailLevelForRequestFilter(reqFilter);</span>

<span class="fc" id="L348">		return fixRequestTypeForFlexRequests(getRequestManager().getNextRequestsForManager(empID, requestIDs, null, true, isSoftValEnabled, isNetStaffingSoftValEnabled, detailLevel));</span>
	}

	/**
	 * Return Request specified by request ID and Type
	 */
	public static RequestAggregate getRequest(ID requestID, String requestType)
			throws RemoteException, BbmFinderException, BbmCreateException, RmHardValidationException {

		// Pass Time Off Choice Length if its time off
<span class="fc" id="L358">		long detailLevel = Request.DL_BASIC|Request.DL_AUDIT_TRAIL;</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">		if (Request.REQUESTTYPE_TIMEOFF.equals(requestType)) {</span>
<span class="fc" id="L360">			detailLevel|=TORequest.DL_TIMEOFF_CHOICES_LENGTH;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">		} else if (Request.REQUESTTYPE_FLEXTIME.equals(requestType)) {</span>
<span class="nc" id="L362">			detailLevel|=TORequest.DL_TIMEOFF_CHOICES_LENGTH | TORequest.DL_TIMEOFF_FLEXMAKEUP;</span>
		}

<span class="fc" id="L365">		return fixRequestTypeForFlexRequest(getRequestManager().getRequestByID(requestID, requestType, true, true, detailLevel));</span>
	}

	/**
	 * Return Request Collection for request specified by request ID and Type
	 */
	public static RequestCollection getRequestCollectionForRequest(ID requestID, String requestType, RequestContext context)
			throws RemoteException, BbmFinderException, BbmCreateException, RmHardValidationException, BbmException {

<span class="nc" id="L374">		RequestAggregate request = getRequest(requestID, requestType);</span>
		// Pass Time Off Choice Length if its time off
<span class="nc" id="L376">		long detailLevel = Request.DL_BASIC;</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">		if (Request.REQUESTTYPE_TIMEOFF.equals(requestType)) {</span>
<span class="nc" id="L378">			detailLevel|=TORequest.DL_TIMEOFF_CHOICES_LENGTH;</span>
		}

<span class="nc" id="L381">		ArrayList listIDs = new ArrayList();</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">		if (request != null) {</span>
<span class="nc" id="L383">			listIDs.add(request.getID());</span>
		}

<span class="nc" id="L386">		ArrayList requestList = new ArrayList();</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">		if (request != null) {</span>
<span class="nc" id="L388">			requestList.add(request);</span>
		}

<span class="nc" id="L391">		Map&lt;ID, EmployeeName&gt; empNameMap = new HashMap&lt;ID, EmployeeName&gt;(1);</span>
<span class="nc" id="L392">		List&lt;ID&gt; empList = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">		if (request != null){</span>
<span class="nc" id="L394">			empList.add(request.getEmployeeID());</span>
<span class="nc" id="L395">			empNameMap = getEmpNameMap(context, empList);</span>
		}

<span class="nc" id="L398">		return new RequestCollection(listIDs, requestList, empNameMap);</span>
	}

	/**
	 * Return OrganizationSetting for specified Organization ID
	 */
	public static OrganizationSetting getOrgSetting(ID orgID)
			throws RemoteException, BbmFinderException, BbmCreateException {
<span class="fc" id="L406">		return getOrgConfigManager().getConfiguration(orgID);</span>
	}

	/**
	 * Return OrganizationSetting for specified Employee ID
	 */
	public static OrganizationSetting getOrgSettingForEmployee(RequestContext context, ID empID)
			throws RemoteException, BbmException {
<span class="fc" id="L414">		ID orgID = OrganizationModelHandler.getEmployeeOrgID(context, empID);</span>
<span class="pc bpc" id="L415" title="1 of 2 branches missed.">		if (orgID==null) {</span>
<span class="nc" id="L416">			return null;</span>
		}

<span class="fc" id="L419">		return getOrgSetting(orgID);</span>
	}

	/**
	 * Return User Map for Audit Trails
	 */
	public static Map getUserMapForRequest(RequestAggregate request)
			throws RemoteException, CoreException {
<span class="nc" id="L427">		Map userMap = Collections.EMPTY_MAP;</span>

<span class="nc" id="L429">		UserManager uManager = CoreManagerFactory.getUserManager(false);</span>

		// Handle users from Request Audit
<span class="nc" id="L432">		Collection ratList = request.getAuditTrail();</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">		if (!ratList.isEmpty()) {</span>
<span class="nc" id="L434">			HashSet userIDs = new HashSet(ratList.size());</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">			for(Iterator it=ratList.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L436">				RequestAuditTrail rat = (RequestAuditTrail)it.next();</span>
<span class="nc" id="L437">				ID userID = rat.getBpUserId();</span>
<span class="nc" id="L438">				userIDs.add(userID);</span>
<span class="nc" id="L439">			}</span>
<span class="nc" id="L440">			userMap = uManager.getUsersByIDs(userIDs);</span>
		}

<span class="nc" id="L443">		return userMap;</span>
	}

	/**
	 * Return Event for Shift Assignment for the specified employee at
	 * specified shift Date
	 */
	public static Event findShiftAssignmentEvent(ID empID, Date shiftDate, TimeZone tz)
			throws RemoteException, BbmException {
<span class="nc" id="L452">		Event result = null;</span>
<span class="nc" id="L453">		Date fromDate = DateTimeUtil.getDayStart(shiftDate, tz);</span>
<span class="nc" id="L454">		Date toDate = DateTimeUtil.getDayEnd(shiftDate, tz);</span>

<span class="nc" id="L456">		int eventTypeMask = Event.EVENT_TYPE_SHIFT_ASSIGNMENT;</span>
<span class="nc" id="L457">		Collection scheduleEvents = WfmManagerFactory.getScheduleAccessManager()</span>
<span class="nc" id="L458">				.getPublishedEventsForWorkResourceByType(eventTypeMask, empID, fromDate, toDate);</span>

		// Find Shift Assignment Event and adjust Shift Swap Item
<span class="nc bnc" id="L461" title="All 2 branches missed.">		for (Iterator i = scheduleEvents.iterator(); i.hasNext();){</span>
<span class="nc" id="L462">			Event event = (Event)i.next();</span>
			// IN40778-1: ensure that starttime of event is after fromDate
<span class="nc bnc" id="L464" title="All 2 branches missed.">			if (event.getStartTime().compareTo(fromDate) &gt;= 0) {</span>
<span class="nc" id="L465">				result = event;</span>
<span class="nc" id="L466">				break;</span>
			}
<span class="nc" id="L468">		}</span>

<span class="nc" id="L470">		return result;</span>
	}

	/**
	 * Return Collection of Unique Employee IDs for specified collection of
	 * Requests
	 */
	public static Collection&lt;ID&gt; getUniqueEmpIDs(Collection requests) {
<span class="fc" id="L478">		Set&lt;ID&gt; empIDSet = new HashSet&lt;ID&gt;(requests.size());</span>

<span class="fc bfc" id="L480" title="All 2 branches covered.">		for (Iterator it = requests.iterator(); it.hasNext(); ) {</span>
<span class="fc" id="L481">			RequestAggregate req = (RequestAggregate)it.next();</span>
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">			if (req instanceof TORequest) {</span>
<span class="fc" id="L483">				TORequest tor = (TORequest)req;</span>
<span class="fc" id="L484">				empIDSet.add(tor.getEmployeeID());</span>
<span class="pc bnc" id="L485" title="All 2 branches missed.">			} else if (req instanceof ShiftSwapRequest) {</span>
<span class="nc" id="L486">				ShiftSwapRequest ssr = (ShiftSwapRequest)req;</span>
<span class="nc" id="L487">				empIDSet.addAll(ssr.getEmployees());</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">			} else if (req instanceof ShiftBidRequest) {</span>
<span class="nc" id="L489">				ShiftBidRequest sbr = (ShiftBidRequest)req;</span>
<span class="nc" id="L490">				empIDSet.add(sbr.getEmployeeID());</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">			} else if (req instanceof CustShiftReq) {</span>
<span class="nc" id="L492">				CustShiftReq csr = (CustShiftReq)req;</span>
<span class="nc" id="L493">				empIDSet.add(csr.getEmployeeID());</span>
			}
<span class="fc" id="L495">		}</span>

<span class="fc" id="L497">		return empIDSet;</span>
	}

	/**
	 * Return Map of EmployeeID and EmployeeName
	 */
	public static Map&lt;ID, EmployeeName&gt; getEmpNameMap(RequestContext context, Collection&lt;ID&gt; empIDList)
			throws RemoteException, BbmException {
<span class="nc" id="L505">		return EmployeeModelHandler.getEmployeeNamesByIDs(context, empIDList);</span>
	}

	/**
	 * Return Employee Name Map for all users and the requests employee
	 */
	public static Map getEmpNameMap(RequestContext context, Map userMap, RequestAggregate request)
			throws RemoteException, BbmException {

		// Get Employee Names for Users
<span class="nc" id="L515">		Collection users = userMap.values();</span>
<span class="nc" id="L516">		HashMap empNameMap = EmployeeModelHandler.getEmployeeNamesByUsers(context, users);</span>

<span class="nc bnc" id="L518" title="All 2 branches missed.">		if(empNameMap==null) {</span>
<span class="nc" id="L519">			empNameMap = new HashMap();</span>
		}
		// Get Employee Name for Request
<span class="nc" id="L522">		ID empID = request.getEmployeeID();</span>
<span class="nc" id="L523">		EmployeeName empName = EmployeeModelHandler.getEmployeeNameByID(context, empID);</span>
<span class="nc" id="L524">		empNameMap.put(empID, empName);</span>

<span class="nc" id="L526">		return empNameMap;</span>
	}

	/**
	 * Return Map of EmployeeID and their Organization IDs
	 */
	public static Map getEmpOrgMap(RequestContext context, Collection empIDList)
			throws RemoteException, BbmException {
<span class="fc" id="L534">		return OrganizationModelHandler.getEmployeeOrgMap(context, empIDList, null);</span>
	}

	/**
	 * Return Employee's Organization ID
	 */
	public static ID getEmpOrgID(RequestContext context, ID empID) throws RemoteException, BbmException {
<span class="fc" id="L541">		return OrganizationModelHandler.getEmployeeOrgID(context, empID);</span>
	}

	/**
	 * Return Employee's current Time Off Pool. If he isn't assigned to any pool right now,
	 * return his first pool assignment. If he has no pool assignments, return null.
	 */
	public static TOPool getEmpPool(RequestContext context, ID empoyeeID) throws Exception
	{
<span class="fc" id="L550">		ID poolID = null;</span>
<span class="fc" id="L551">		TOPool pool = null;</span>
<span class="fc" id="L552">		Date now = new Date();</span>

        //Get all the pool assignments for the employee
<span class="fc" id="L555">        Calendar bigBangCal = Calendar.getInstance();</span>
<span class="fc" id="L556">		bigBangCal.set(Calendar.YEAR, 1900);</span>
<span class="fc" id="L557">		Calendar armageddonCal = Calendar.getInstance();</span>
<span class="fc" id="L558">		armageddonCal.set(Calendar.YEAR, 2100);</span>
<span class="fc" id="L559">		Collection poolHistoryList = PeopleMH.getValidEmpTOPoolAssignments(empoyeeID, bigBangCal.getTime(), armageddonCal.getTime());</span>

<span class="pc bpc" id="L561" title="2 of 4 branches missed.">		if (poolHistoryList != null &amp;&amp; poolHistoryList.size() &gt; 0)</span>
		{
			//Look for overlap with current time
<span class="pc bpc" id="L564" title="1 of 2 branches missed.">			for (Iterator it= poolHistoryList.iterator(); it.hasNext();)</span>
			{
<span class="fc" id="L566">				EmpTOPoolAssignment poolAss = (EmpTOPoolAssignment) it.next();</span>
<span class="pc bpc" id="L567" title="1 of 2 branches missed.">				if (TimePeriodUtil.overlap(poolAss.getStartTime(), poolAss.getEndTime(), now, null))</span>
				{
<span class="fc" id="L569">					poolID = poolAss.getTOPoolID();</span>
<span class="fc" id="L570">					break;</span>
				}
<span class="nc" id="L572">			}</span>

<span class="pc bpc" id="L574" title="1 of 2 branches missed.">			if (poolID == null)</span>
			{
				//still not found: use first available pool
<span class="nc" id="L577">				EmpTOPoolAssignment poolAss = (EmpTOPoolAssignment) poolHistoryList.iterator().next();</span>
<span class="nc" id="L578">				poolID = poolAss.getTOPoolID();</span>
			}

<span class="pc bpc" id="L581" title="1 of 2 branches missed.">			if (poolID != null)</span>
			{
				//get the pool
<span class="fc" id="L584">		        CalendarTimeOffDayFacade ctodf = RmManagerFactory.getInstance().getTimeOffDayFacade();</span>
<span class="fc" id="L585">		        pool = ctodf.getTOPool(poolID);</span>
			}
		}
<span class="fc" id="L588">        return pool;</span>
	}

	/**
	 * Process Requests
	 *
	 * @param reqIDs - Collection of IDs
	 * @param objVerNums - Collection request object version number
	 * @param action - Action to perform
	 * @throws MultiUserException
	 * @throws RmException
	 * @throws RemoteException
	 */
	public static void processRequests(Collection reqIDs, Collection objVerNums, String action)
			throws MultiUserException, RemoteException, BbmCreateException, RmException, RmHardValidationException {
<span class="nc" id="L603">		getRequestManager().processRequests(reqIDs, objVerNums, action);</span>
<span class="nc" id="L604">	}</span>

	/**
	 * Get the time off year month and day for an employee
	 * @param empID the id of the employee
	 * @return a two-element array of int.  The first element is the month,
	 * the second is the day.
	 */
	public static int[] getEmployeeTimeOffYearStart(RequestContext context, ID empID, ID orgID) throws BbmFinderException, Exception {
		// Get the month and day for the employee's time off year
<span class="fc" id="L614">		return com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil.getEmployeeTimeOffYearStart(empID, orgID);</span>
	}

	/**
	 * Get the Request filetr by id
	 */
	public static RequestFilter getRequestFilterById(ID filterID) throws BbmFinderException, Exception {
<span class="nc" id="L621">		return getRequestManager().getRequestFilterById(filterID);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>