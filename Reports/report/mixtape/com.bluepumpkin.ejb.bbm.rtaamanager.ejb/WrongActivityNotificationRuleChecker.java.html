<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WrongActivityNotificationRuleChecker.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.rtaamanager.ejb</a> &gt; <span class="el_source">WrongActivityNotificationRuleChecker.java</span></div><h1>WrongActivityNotificationRuleChecker.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.rtaamanager.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  This notification rule checker checks whether the schedule
 *               has been changed for any work resources and if so, constructs
 *               an action detail object with messages specific to work
 *               resources
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, inc
 * @author       Greg Fichtenholtz
 * @version 1.0
 */
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedList;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;

import com.bluepumpkin.common.cache.Cache;
import com.bluepumpkin.common.cache.CacheFactory;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.localization.LocaleContext;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.JNDINames;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.employeefilter.ejb.EmployeeFilter;
import com.bluepumpkin.ejb.bbm.employeefilter.model.Filter;
import com.bluepumpkin.ejb.bbm.localization.DefaultLocalizationManager;
import com.bluepumpkin.ejb.bbm.notifyrules.model.ActionDetail;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleParameter;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate;
import com.witness.ejb.core.security.model.User;

<span class="nc" id="L51">public class WrongActivityNotificationRuleChecker implements NotifyRuleChecker</span>
{
	protected Localizer m_localizer;
<span class="nc" id="L54">	private RTAAManager m_rtaaManager = null;</span>
<span class="nc" id="L55">	private EmployeeFilter m_employeeFilter = null;</span>
<span class="nc" id="L56">	private DocumentBuilder m_parser = null;</span>
<span class="nc" id="L57">	private static Category m_cat = Log.initCategory(WrongActivityNotificationRuleChecker.class.getName());</span>
<span class="nc" id="L58">	private Cache m_employeesRecordingCache = null;</span>

	/**
	 * Initialize method called once per notify rule checker type to perform
	 * one-time initialization
	 */
	public void init() throws Exception
	{
<span class="nc" id="L66">		m_rtaaManager = BbmManagerFactory.getRTAAManager();</span>
<span class="nc" id="L67">		m_employeeFilter = BbmManagerFactory.getEmployeeFilter();</span>
<span class="nc" id="L68">		DocumentBuilderFactory docBuilderFactory = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L69">		docBuilderFactory.setValidating(false);</span>
<span class="nc" id="L70">		m_parser = docBuilderFactory.newDocumentBuilder();</span>
<span class="nc" id="L71">		m_localizer = DefaultLocalizationManager.getDefaultInstance().getLocalizer();</span>

<span class="nc" id="L73">		m_employeesRecordingCache =</span>
<span class="nc" id="L74">			CacheFactory.getCache(</span>
				JNDINames.BBM_RTAAMANAGER_EJBHOME + &quot;EmployeesRecording&quot;,
<span class="nc" id="L76">				RTAAManagerEJB.class.getClassLoader());</span>


<span class="nc" id="L79">	}</span>

	/**
	 * Tests whether this rule &quot;fires&quot;. If so, returns an action detail object
	 * with specific messages for each of the workresources whose schedule has
	 * been changed
	 */
	public ActionDetail testRule(NotifyRule notifyRule, Object actionContext) throws Exception
	{
<span class="nc bnc" id="L88" title="All 2 branches missed.">		if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L89">			m_cat.debug(&quot;ENTER: testRule&quot;);</span>

<span class="nc" id="L91">		Collection colScheduledActivityIDs = null;</span>
<span class="nc" id="L92">		Collection colActualActivityIDs = null;</span>
<span class="nc" id="L93">		int nScheduledActivityClause = 0;</span>
<span class="nc" id="L94">		int nActualActivityClause = 0;</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">		for (Iterator itRuleParameter = notifyRule.getRuleParameters().iterator(); itRuleParameter.hasNext();)</span>
		{
<span class="nc" id="L97">			NotifyRuleParameter notifyRuleParameter = (NotifyRuleParameter) itRuleParameter.next();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;ScheduledActivity&quot;))</span>
			{
<span class="nc bnc" id="L100" title="All 2 branches missed.">				if (notifyRuleParameter.getValue() instanceof ID)</span>
				{
<span class="nc" id="L102">					ID idActivity = (ID) notifyRuleParameter.getValue();</span>
<span class="nc" id="L103">					colScheduledActivityIDs = new LinkedList();</span>
<span class="nc" id="L104">					colScheduledActivityIDs.add(idActivity);</span>
<span class="nc" id="L105">				}</span>
				else
<span class="nc" id="L107">					colScheduledActivityIDs = (Collection) notifyRuleParameter.getValue();</span>
			}

<span class="nc bnc" id="L110" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;ScheduledActivityClause&quot;))</span>
<span class="nc" id="L111">				nScheduledActivityClause = ((Integer) notifyRuleParameter.getValue()).intValue();</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;ActualActivity&quot;))</span>
			{
<span class="nc bnc" id="L114" title="All 2 branches missed.">				if (notifyRuleParameter.getValue() instanceof ID)</span>
				{
<span class="nc" id="L116">					ID idActivity = (ID) notifyRuleParameter.getValue();</span>
<span class="nc" id="L117">					colActualActivityIDs = new LinkedList();</span>
<span class="nc" id="L118">					colActualActivityIDs.add(idActivity);</span>
<span class="nc" id="L119">				}</span>
				else
<span class="nc" id="L121">					colActualActivityIDs = (Collection) notifyRuleParameter.getValue();</span>
			}

<span class="nc bnc" id="L124" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;ActualActivityClause&quot;))</span>
<span class="nc" id="L125">				nActualActivityClause = ((Integer) notifyRuleParameter.getValue()).intValue();</span>
<span class="nc" id="L126">		}</span>
<span class="nc bnc" id="L127" title="All 4 branches missed.">		if ((colScheduledActivityIDs == null &amp;&amp; nScheduledActivityClause == 0))</span>
<span class="nc" id="L128">			throw new BbmException(&quot;Bad Notify Rule: missing Scheduled Activity&quot;);</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">		if (nScheduledActivityClause &lt; 0 || nScheduledActivityClause &gt; 1)</span>
<span class="nc" id="L130">			throw new BbmException(&quot;Bad Notify Rule: bad Scheduled Activity Clause&quot;);</span>
<span class="nc bnc" id="L131" title="All 4 branches missed.">		if ((colActualActivityIDs == null &amp;&amp; nActualActivityClause == 0))</span>
<span class="nc" id="L132">			throw new BbmException(&quot;Bad Notify Rule: missing Actual Activity&quot;);</span>
<span class="nc bnc" id="L133" title="All 4 branches missed.">		if (nActualActivityClause &lt; 0 || nActualActivityClause &gt; 1)</span>
<span class="nc" id="L134">			throw new BbmException(&quot;Bad Notify Rule: bad Actual Activity Clause&quot;);</span>

<span class="nc" id="L136">		Collection colEmployeeIDs = getRuleScopeEmployeeIDs(notifyRule);</span>

<span class="nc" id="L138">		Date dateCurrent = Calendar.getInstance().getTime();</span>

<span class="nc" id="L140">		m_cat.debug(&quot;Begin: getEmployeesInWrongActvity: for EmployeeIDs&quot; + colEmployeeIDs);</span>

<span class="nc" id="L142">		Collection colEmployeesRecording = new LinkedList(m_employeesRecordingCache.keySet()); // get from cache</span>

<span class="nc" id="L144">		m_cat.debug(&quot;EmployeesRecording: &quot; + colEmployeesRecording);</span>

<span class="nc" id="L146">		Collection colEmpoyeeIDsNotRecording = new LinkedList(colEmployeeIDs);</span>
<span class="nc" id="L147">		colEmpoyeeIDsNotRecording.removeAll(colEmployeesRecording);</span>
<span class="nc" id="L148">		m_cat.debug(&quot;Employees Not Recording: &quot; + colEmpoyeeIDsNotRecording);</span>

<span class="nc" id="L150">		Collection colEmployeesRecordON =</span>
<span class="nc" id="L151">			m_rtaaManager.getEmployeesInWrongActivity(</span>
				colEmpoyeeIDsNotRecording,
				colScheduledActivityIDs,
				colActualActivityIDs);

<span class="nc" id="L156">		m_cat.debug(&quot;Employees Not Recording and Not adhering: &quot; + colEmployeesRecordON);</span>


<span class="nc" id="L159">		Collection colEmployeesInWrongActivityAndRecording =</span>
<span class="nc" id="L160">			m_rtaaManager.getEmployeesInWrongActivity(</span>
				colEmployeesRecording,
				null,
				null);
<span class="nc" id="L164">		m_cat.debug(&quot;EmployeesInWrongActivityAndRecording: &quot; + colEmployeesInWrongActivityAndRecording);</span>

<span class="nc" id="L166">		colEmployeesRecording.removeAll(colEmployeesInWrongActivityAndRecording);</span>

<span class="nc" id="L168">		Collection colEmployeesRecordOFF = colEmployeesRecording;</span>

<span class="nc" id="L170">		m_cat.debug(&quot;EmployeesRecording: &quot; + colEmployeesRecording);</span>


<span class="nc" id="L173">		ActionDetail actionDetail = new ActionDetail();</span>
<span class="nc" id="L174">		actionDetail.setObjectType(ActionDetail.WORKRESOUCEID);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">		for (Iterator itEmployeeID = colEmployeesRecordON.iterator(); itEmployeeID.hasNext();)</span>
		{
<span class="nc" id="L177">			ID idEmployee = (ID) itEmployeeID.next();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">			if (m_employeesRecordingCache.get(idEmployee) != null)</span>
<span class="nc" id="L179">				m_cat.debug(&quot;Detected multiple record ONs for employeeID: &quot; + idEmployee.toString());</span>

<span class="nc" id="L181">			m_employeesRecordingCache.put(idEmployee, new Boolean(true));</span>
<span class="nc" id="L182">			m_cat.debug(&quot;Record ON for employeeID: &quot; + idEmployee.toString());</span>
<span class="nc" id="L183">			Element elementXmlMessageRecordON =</span>
<span class="nc" id="L184">				createXmlMessage(</span>
					idEmployee,
					&quot;RECORD ON&quot;,
					&quot;&quot;,
					&quot;&quot;,
					0);
<span class="nc" id="L190">			actionDetail.setDetails(idEmployee, elementXmlMessageRecordON);</span>
<span class="nc" id="L191">		}</span>
<span class="nc" id="L192">		m_cat.debug(&quot;EmployeesEmployeesRecordOFF: &quot; + colEmployeesRecordOFF);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">		for (Iterator itEmployeeID = colEmployeesRecordOFF.iterator(); itEmployeeID.hasNext();)</span>
		{
<span class="nc" id="L195">			ID idEmployee = (ID) itEmployeeID.next();</span>
<span class="nc" id="L196">			m_cat.debug(&quot;Record OFF for employeeID: &quot; + idEmployee.toString());</span>
<span class="nc" id="L197">			Element elementXmlMessageRecordOFF =</span>
<span class="nc" id="L198">				createXmlMessage(</span>
					idEmployee,
					&quot;RECORD OFF&quot;,
					&quot;&quot;,
					&quot;&quot;,
					0);
<span class="nc" id="L204">			actionDetail.setDetails(idEmployee, elementXmlMessageRecordOFF);</span>
<span class="nc" id="L205">			m_employeesRecordingCache.remove(idEmployee);</span>
<span class="nc" id="L206">		}</span>

<span class="nc bnc" id="L208" title="All 2 branches missed.">		if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L209">			m_cat.debug(&quot;EXIT: testRule&quot;);</span>

<span class="nc" id="L211">		return actionDetail;</span>
	}

	private Collection getRuleScopeEmployeeIDs(NotifyRule rule)
		throws Exception {
<span class="nc" id="L216">		HashSet ids = new HashSet();</span>
<span class="nc" id="L217">		ArrayList alParameters = new ArrayList();</span>
<span class="nc" id="L218">		Filter filter = null;</span>
<span class="nc bnc" id="L219" title="All 4 branches missed.">		switch (rule.getScopeType()) {</span>
			case NotifyRule.GENERIC_SCOPE:
<span class="nc" id="L221">				return ids;</span>
			case NotifyRule.ORG_SCOPE:
<span class="nc" id="L223">				ID idOrganization = rule.getScopeID();</span>
<span class="nc" id="L224">				Jdmo jdmo = null;</span>
<span class="nc" id="L225">				Collection colOrganizationIDs = null;</span>
				try {
<span class="nc" id="L227">					jdmo = new Jdmo();</span>
<span class="nc" id="L228">					colOrganizationIDs = DAOUtil.getChildOrganizations(idOrganization, jdmo);</span>
<span class="nc" id="L229">					colOrganizationIDs.add(idOrganization);</span>
				} finally {
<span class="nc" id="L231">					jdmo.cleanUp();</span>
<span class="nc" id="L232">				}</span>
<span class="nc" id="L233">				alParameters.add(colOrganizationIDs);</span>
<span class="nc" id="L234">				filter = new com.bluepumpkin.ejb.bbm.employeefilter.model.Filter(Filter.ORGANIZATIONID, Filter.OPERATOR_IN, alParameters);</span>
<span class="nc" id="L235">				break;</span>
			case NotifyRule.CAMPAIGN_SCOPE:
<span class="nc" id="L237">				ID idCampaign = rule.getScopeID();</span>
<span class="nc" id="L238">				ArrayList campaignIDs = new ArrayList();</span>
<span class="nc" id="L239">				campaignIDs.add(idCampaign);</span>
<span class="nc" id="L240">				alParameters.add(campaignIDs);</span>
<span class="nc" id="L241">				filter = new com.bluepumpkin.ejb.bbm.employeefilter.model.Filter(Filter.CAMPAIGNID, Filter.OPERATOR_IN, alParameters);</span>
				break;
		}
<span class="nc" id="L244">		filter.setUserID(User.SUPER_USERID);</span>
<span class="nc" id="L245">		filter.setTimePeriodType(Filter.TIMEPERIODTYPE_CURRENT);</span>
<span class="nc" id="L246">		return m_employeeFilter.getEmployeeIDs(filter, -1, true, 0, Integer.MAX_VALUE);</span>
	}
	/**
	 * Returns the XML node that represents the root of the tree that describes the
	 * schedule changes for a certain employee
	 */
	private Element createXmlMessage(
		ID idEmployee,
		String strEmployeeName,
		String strPlannedActivityName,
		String strActualActivityName,
		int nMinutesOutOfAdherance)
		throws Exception
	{
<span class="nc" id="L260">		Document doc = m_parser.newDocument();</span>
<span class="nc" id="L261">		Element xmlRoot = doc.createElement(&quot;OutOfAdherance&quot;);</span>
<span class="nc" id="L262">		doc.appendChild(xmlRoot);</span>
<span class="nc" id="L263">		Element xmlEmployee = doc.createElement(&quot;Employee&quot;);</span>
<span class="nc" id="L264">		xmlRoot.appendChild(xmlEmployee);</span>
<span class="nc" id="L265">		Node xmlId = doc.createElement(&quot;ID&quot;);</span>
<span class="nc" id="L266">		xmlId.appendChild(doc.createTextNode(idEmployee.toString()));</span>
<span class="nc" id="L267">		xmlEmployee.appendChild(xmlId);</span>
<span class="nc" id="L268">		Element xmlName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L269">		xmlName.appendChild(doc.createTextNode(strEmployeeName));</span>
<span class="nc" id="L270">		xmlEmployee.appendChild(xmlName);</span>

<span class="nc" id="L272">		Element elementPlannedActivity = doc.createElement(&quot;PlannedActivity&quot;);</span>
<span class="nc" id="L273">		elementPlannedActivity.appendChild(doc.createTextNode(strPlannedActivityName));</span>
<span class="nc" id="L274">		xmlEmployee.appendChild(elementPlannedActivity);</span>

<span class="nc" id="L276">		Element elementActualActivity = doc.createElement(&quot;ActualActivity&quot;);</span>
<span class="nc" id="L277">		elementActualActivity.appendChild(doc.createTextNode(strActualActivityName));</span>
<span class="nc" id="L278">		xmlEmployee.appendChild(elementActualActivity);</span>

<span class="nc" id="L280">		Integer intMinutesOutOfAdherance = new Integer(nMinutesOutOfAdherance);</span>
<span class="nc" id="L281">		String strMinutesOutOfAdherance = intMinutesOutOfAdherance.toString();</span>
<span class="nc" id="L282">		Element elementMinutesOutOfAdherance = doc.createElement(&quot;MinutesOutOfAdherance&quot;);</span>
<span class="nc" id="L283">		elementMinutesOutOfAdherance.appendChild(doc.createTextNode(strMinutesOutOfAdherance));</span>
<span class="nc" id="L284">		xmlEmployee.appendChild(elementMinutesOutOfAdherance);</span>
<span class="nc" id="L285">		return xmlRoot;</span>
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker#isRuleValid(com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule, com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate)
	 */
	public boolean isRuleValid(NotifyRule notifyRule, NotifyRuleTemplate notifyRuleTemplate)
	{
<span class="nc" id="L293">		return true;</span>
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker#getRuleViolation(com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule, com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate, com.bluepumpkin.common.localization.LocaleContext)
	 */
	public String getRuleViolation(NotifyRule notifyRule, NotifyRuleTemplate notifyRuleTemplate, LocaleContext localeContext)
	{
<span class="nc" id="L301">		return null;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>