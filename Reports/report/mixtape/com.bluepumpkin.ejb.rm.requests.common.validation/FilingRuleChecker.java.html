<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FilingRuleChecker.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.common.validation</a> &gt; <span class="el_source">FilingRuleChecker.java</span></div><h1>FilingRuleChecker.java</h1><pre class="source lang-java linenums">/*
 * FilingRuleChecker.java
 * Copyright (c) 2002, Blue Pumpkin Software, Inc
 * All rights reserved.
 */

package com.bluepumpkin.ejb.rm.requests.common.validation;

import java.util.BitSet;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.Iterator;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.setup.filingrules.model.RequestFilingRule;
import com.bluepumpkin.ejb.rm.util.RmUtil;

/**
 * Check whether requests for a given date adhere to the set of filing rules in effect for an organization.
 */
public class FilingRuleChecker {
	/**
	 * Logging category
	 */
<span class="fc" id="L31">	private static Category m_cat = Log.initCategory(FilingRuleChecker.class.getName());</span>

	/**
	 * The collection of filing rules used by this checker.
	 */
<span class="fc" id="L36">	protected Collection m_filingRules = null;</span>

	/**
	 * The collection of holidays germain to this checker.
	 */
<span class="fc" id="L41">	protected Collection m_holidays = null;</span>

	/**
	 * The timezone to use for this rule checker. This comes from the organization.
	 */
<span class="fc" id="L46">	protected TimeZone m_tz = null;</span>

	/**
	 * The rule that indicated a compliance failure. Only the last such rule is saved. Compliance checking stops after the
	 * first failure.
	 */
<span class="fc" id="L52">	protected RequestFilingRule m_failingRule = null;</span>

	/**
	 * The day boundary offset for the organization. Offset in minutes from midnight, local time
	 */
<span class="fc" id="L57">	int m_dayBoundaryOffset = 0;</span>

	/**
	 * Create a new filing rule checker. The checker performs date-based applicability tests and filing rule checkes.
	 * Therefore, the set of rules for an organization, request type and activity type must be determined and passed to this
	 * constructor. See the {@link FilingRuleCheckerHelper the helper class} for convenience methods that invoke this
	 * constructor after being passed higher level information.
	 * &lt;p/&gt;
	 * &lt;p&gt;
	 * See {@link RequestFilingRule RequestFilingRule} for the representation and documentation of a filing rule.
	 * &lt;p/&gt;
	 * &lt;p&gt;
	 * see {@link RequestFilingRule RequestFilingRule} for the difference in filing rule type &quot;interval (days in advance)&quot;
	 * between SS/TO reqs and SB reqs.
	 *
	 * @param filingRules the rules that will be used by this checker. This is a collection of
	 *            {@link com.bluepumpkin.ejb.rm.setup.filingrules.model.RequestFilingRule RequestFilingRule} objects.
	 * @param holidays the holidays for the organization. This is a collection of
	 *            {@link com.bluepumpkin.ejb.bbm.holiday.model.Holiday Holiday} objects.
	 * @param tz the timezone for the organization
	 * @param dayBoundaryOffset the number of minutes offset set from midnight, local time, that markes the start of an
	 *            organization day. This value is used to compute which days a request covers and figures in the
	 *            applicability of request filing rules that use a DAYRANGETYPE of DAYTYPE.
	 */
	public FilingRuleChecker(Collection filingRules, Collection holidays, TimeZone tz, int dayBoundaryOffset) {
<span class="fc" id="L82">		super();</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">		if (filingRules == null)</span>
<span class="nc" id="L84">			throw new IllegalArgumentException(&quot;filingRules == null&quot;);</span>
<span class="fc" id="L85">		m_filingRules = filingRules;</span>

<span class="pc bpc" id="L87" title="1 of 2 branches missed.">		if (holidays == null)</span>
<span class="nc" id="L88">			throw new IllegalArgumentException(&quot;holidays == null&quot;);</span>
<span class="fc" id="L89">		m_holidays = holidays;</span>

<span class="pc bpc" id="L91" title="1 of 2 branches missed.">		if (tz == null)</span>
<span class="nc" id="L92">			throw new IllegalArgumentException(&quot;tz == null&quot;);</span>
<span class="fc" id="L93">		m_tz = tz;</span>

<span class="pc bpc" id="L95" title="2 of 4 branches missed.">		if (dayBoundaryOffset &lt; 0 || dayBoundaryOffset &gt;= 1440)</span>
<span class="nc" id="L96">			throw new IllegalArgumentException(&quot;dayBoundaryOffset out of bounds&quot;);</span>
<span class="fc" id="L97">		m_dayBoundaryOffset = dayBoundaryOffset;</span>

<span class="pc bpc" id="L99" title="1 of 2 branches missed.">		if (m_cat.isDebugEnabled())</span>
<span class="fc" id="L100">			m_cat.debug(&quot;FilingRuleChecker created: &quot; + toString());</span>
<span class="fc" id="L101">	}</span>

	/**
	 * Check to see if a request with the given start time complies with the applicable filing rules used when this instance
	 * of FilingRuleChecker was constructed. This assumes that the questions of organization, request type and activity (if
	 * applicable) have been resolved in the construction of the checker. The tests performed by this method look at the date
	 * to ensure that the date-based rule applicability test and then checks the date-based filing rule.
	 * &lt;p/&gt;
	 * &lt;p&gt;
	 * See {@link RequestFilingRule RequestFilingRule} for the representation and documentation of a filing rule.
	 * &lt;p/&gt;
	 * &lt;p&gt;
	 * see {@link RequestFilingRule RequestFilingRule} for the difference in filing rule type &quot;interval (days in advance)&quot;
	 * between SS/TO reqs and SB reqs.
	 *
	 * @param reqFileDate the date that the request was filed.
	 * @param reqTimeRangeStart the beginning of the request period
	 * @param reqTimeRangeEnd the end of the request period
	 * @param startOfTOorSS_OR_AucEnd start time for TO choice or SS item **or** end of auction.
	 */
	public boolean requestComplies(Date reqFileDate, Date reqTimeRangeStart, Date reqTimeRangeEnd,
			Date startOfTOorSS_OR_AucEnd) {
<span class="fc" id="L123">		String methodName = &quot;requestComplies(fileDate, dtStart, dtEnd): &quot;;</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="fc" id="L125">			m_cat.debug(RmUtil.ENTERPREFIX</span>
<span class="fc" id="L126">					+ RmUtil.dumpEnterMethod(methodName, reqFileDate, reqTimeRangeStart, reqTimeRangeEnd));</span>
		}

<span class="fc" id="L129">		boolean result = true;</span>

		// Determine wheter or not the range includes time on a holiday.
<span class="fc" id="L132">		boolean onWorkingHoliday =</span>
<span class="fc" id="L133">				RuleScopeChecker.overlapsTimeOnAWorkingHoliday(m_holidays, m_tz, reqTimeRangeStart, reqTimeRangeEnd);</span>

		// Build the map of days of the week that this range includes
<span class="fc" id="L136">		BitSet daysOfWeek = RuleScopeChecker.buildDaysBitSet(reqTimeRangeStart, reqTimeRangeEnd, m_tz, m_dayBoundaryOffset);</span>

<span class="pc bpc" id="L138" title="1 of 2 branches missed.">		for (Iterator it = m_filingRules.iterator(); it.hasNext();) {</span>
<span class="fc" id="L139">			RequestFilingRule rule = (RequestFilingRule) it.next();</span>
<span class="fc" id="L140">			m_cat.debug(&quot;Checking filing rule = &quot; + rule);</span>

			// Check if the filing rule is applicaable to the given startDate based on the effectivity
			// period of the filing rule.
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">			if (!RuleScopeChecker.ruleApplies(rule, reqTimeRangeStart, onWorkingHoliday, daysOfWeek)) {</span>
<span class="nc" id="L145">				continue;</span>
			}

			// verify if the request complies with the filing rule. (either filed 'n' # of days in advance or
			// by absolute date).
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">			if (!requestAgreesWithRule(rule, reqFileDate, startOfTOorSS_OR_AucEnd)) {</span>
<span class="fc" id="L151">				result = false;</span>
<span class="fc" id="L152">				break;</span>
			}
<span class="nc" id="L154">		}</span>

<span class="fc" id="L156">		m_cat.debug(RmUtil.EXITPREFIX + methodName + &quot; result &quot; + result);</span>
<span class="fc" id="L157">		return result;</span>
	}

	/**
	 * Return the last rule that failed, null if none have failed since checker was constructed or failing rule reset.
	 */
	public RequestFilingRule getLastFailingRule() {
<span class="fc" id="L164">		return m_failingRule;</span>
	}

	/**
	 * Reset the last failing rule
	 */
	public void resetLastFailingRule() {
<span class="fc" id="L171">		m_failingRule = null;</span>
<span class="fc" id="L172">	}</span>

	/**
	 * Test to see if a request for the given date meets the filing test for the given rule.
	 * &lt;p/&gt;
	 * &lt;p&gt;
	 * See {@link RequestFilingRule RequestFilingRule} for the representation and documentation of a filing rule.
	 * &lt;p/&gt;
	 * &lt;p&gt;
	 * see {@link RequestFilingRule RequestFilingRule} for the difference in filing rule type &quot;interval (days in advance)&quot;
	 * between SS/TO reqs and SB reqs.
	 *
	 * @param rule the rule to test with
	 * @param fileDate the date that the request was filed
	 * @param startOfTOorSS_OR_AucEnd start time for TO choice or SS item **or** end of auction.
	 */
	protected boolean requestAgreesWithRule(RequestFilingRule rule, Date reqFileDate, Date startOfTOorSS_OR_AucEnd) {
<span class="fc" id="L189">		String methodName = &quot;requestAgreesWithRule(rule, fileDate, dtStart): &quot;;</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="fc" id="L191">			m_cat.debug(RmUtil.ENTERPREFIX + RmUtil.dumpEnterMethod(methodName, rule, reqFileDate, startOfTOorSS_OR_AucEnd));</span>
		}

<span class="fc" id="L194">		boolean result = false;</span>

		// Check the rule type
<span class="fc" id="L197">		String ruleType = rule.getTimeType();</span>
<span class="fc" id="L198">		m_cat.debug(&quot;ruleType = &quot; + ruleType);</span>
<span class="fc" id="L199">		String REQUEST_AGREES_WITH_FILING_RULE = &quot;Request agrees with filing rule: &quot;;</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">		if (ruleType.equals(RequestFilingRule.TIMETYPE_BYDATE)) {</span>
<span class="fc" id="L201">			result = requestAgreesWithByDateRule(rule, reqFileDate, REQUEST_AGREES_WITH_FILING_RULE);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">		} else if (ruleType.equals(RequestFilingRule.TIMETYPE_INTERVAL)) {</span>
			// Filing rule specifies: &quot;Request filed before|after|on 'n' days in advance&quot;.
<span class="nc" id="L204">			Calendar startOfTOorSS_OR_AucEndCal = Calendar.getInstance(m_tz);</span>
<span class="nc" id="L205">			startOfTOorSS_OR_AucEndCal.setTime(startOfTOorSS_OR_AucEnd);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">			boolean inAdvanceRule = rule.getTimeLine() == rule.TIMELINE_IN_ADVANCE;</span>
<span class="nc" id="L207">			boolean inAdvRequest = startOfTOorSS_OR_AucEndCal.getTime().after(reqFileDate);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">			if (inAdvRequest != inAdvanceRule) {</span>
<span class="nc" id="L209">				m_cat.debug(&quot;this filing rule is does not apply to this request start date=&quot; + startOfTOorSS_OR_AucEndCal</span>
						+ &quot; ; File Date:=&quot; + reqFileDate + &quot; : rule=&quot; + rule);
<span class="nc" id="L211">				return true;</span>
			}
<span class="nc" id="L213">			result = requestAgreesWithByTimeRule(rule, reqFileDate, REQUEST_AGREES_WITH_FILING_RULE,</span>
							startOfTOorSS_OR_AucEndCal, inAdvanceRule, inAdvRequest);
<span class="nc" id="L215">		} else {</span>
<span class="nc" id="L216">			throw new IllegalArgumentException(&quot;Unknow ruleType for filing rule: ID, ruleType: &quot; + rule.getID() + ','</span>
					+ ruleType);
		}

		// If this rule failed, then remember it
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">		if (!result) {</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="fc" id="L223">				m_cat.debug(&quot;Request does not agree with filing rule: &quot; + rule);</span>
<span class="fc" id="L224">			m_failingRule = rule;</span>
		}

<span class="fc" id="L227">		m_cat.debug(RmUtil.EXITPREFIX + methodName + &quot; result = &quot; + result);</span>
<span class="fc" id="L228">		return result;</span>
	}

	/**
	 * By date checks that the filing was done before, after or on a certain date. If before or after, the comparison value
	 * is a full datetime (non-local). If the comparison operator is &quot;on&quot; then the comparison value is accurate to the
	 * organization month, day and year and the request must be made on that calendar day. Check the comparison operator
	 * @param rule
	 * @param reqFileDate
	 * @param result
	 * @param REQUEST_AGREES_WITH_FILING_RULE
	 * @return
	 */
	private boolean requestAgreesWithByDateRule(RequestFilingRule rule, Date reqFileDate, 
			String REQUEST_AGREES_WITH_FILING_RULE) {
<span class="fc" id="L243">		boolean result = false;</span>
<span class="fc" id="L244">		String dateComparisonType = rule.getDateComparision();</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">		if (m_cat.isDebugEnabled())</span>
<span class="fc" id="L246">			m_cat.debug(&quot;dateComparison = &quot; + dateComparisonType);</span>
<span class="fc" id="L247">		Date ruleFileByDate = rule.getFileByDate();</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">		if (m_cat.isDebugEnabled())</span>
<span class="fc" id="L249">			m_cat.debug(&quot;getFileByDate = &quot; + ruleFileByDate);</span>
		// if filing rule specifies: &quot;Request filed on date&quot;
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">		if (dateComparisonType.equals(RequestFilingRule.DATECOMPARISION_ON_DATE)) {</span>
<span class="nc" id="L252">			Calendar fileByDateCal = Calendar.getInstance(m_tz);</span>
			// get the date in the rule clause: before|on|after &lt;specified date&gt;
<span class="nc" id="L254">			fileByDateCal.setTime(ruleFileByDate);</span>

<span class="nc" id="L256">			fileByDateCal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L257">			fileByDateCal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L258">			fileByDateCal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L259">			fileByDateCal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L260">			Date dayStartForFileByDate = fileByDateCal.getTime();</span>

<span class="nc" id="L262">			fileByDateCal.set(Calendar.HOUR_OF_DAY, 23);</span>
<span class="nc" id="L263">			fileByDateCal.set(Calendar.MINUTE, 59);</span>
<span class="nc" id="L264">			fileByDateCal.set(Calendar.SECOND, 59);</span>
<span class="nc" id="L265">			fileByDateCal.set(Calendar.MILLISECOND, 999);</span>
<span class="nc" id="L266">			Date dayEndForFileByDate = fileByDateCal.getTime();</span>

			// if fileDate &gt;= startForFileByDate and fileDate &lt;= endForFileByDate, request complies with filing rule.
<span class="nc bnc" id="L269" title="All 4 branches missed.">			if (!reqFileDate.before(dayStartForFileByDate) &amp;&amp; !reqFileDate.after(dayEndForFileByDate)) {</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">				if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L271">					m_cat.debug(REQUEST_AGREES_WITH_FILING_RULE</span>
<span class="nc" id="L272">							+ RmUtil.dumpCommaSeparated(RequestFilingRule.TIMETYPE_BYDATE, reqFileDate,</span>
									RequestFilingRule.DATECOMPARISION_ON_DATE, ruleFileByDate));
<span class="nc" id="L274">				result = true;</span>
			}
<span class="nc" id="L276">		} // if filing rule specifies: &quot;Request filed after date&quot;</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">		else if (dateComparisonType.equals(RequestFilingRule.DATECOMPARISION_AFTER_DATE)) {</span>
			// if request's file date is after the rule's date
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">			if (reqFileDate.after(ruleFileByDate)) {</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">				if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L281">					m_cat.debug(REQUEST_AGREES_WITH_FILING_RULE</span>
<span class="nc" id="L282">							+ RmUtil.dumpCommaSeparated(RequestFilingRule.TIMETYPE_BYDATE, reqFileDate,</span>
									RequestFilingRule.DATECOMPARISION_AFTER_DATE, ruleFileByDate));
<span class="nc" id="L284">				result = true;</span>
			}
		} // if filing rule specifies: &quot;Request filed before date&quot;
<span class="nc bnc" id="L287" title="All 2 branches missed.">		else if (dateComparisonType.equals(RequestFilingRule.DATECOMPARISION_BEFORE_DATE)) {</span>
			// if request's file date is before the rule's date
<span class="nc bnc" id="L289" title="All 2 branches missed.">			if (reqFileDate.before(ruleFileByDate)) {</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">				if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L291">					m_cat.debug(REQUEST_AGREES_WITH_FILING_RULE</span>
<span class="nc" id="L292">							+ RmUtil.dumpCommaSeparated(RequestFilingRule.TIMETYPE_BYDATE, reqFileDate,</span>
									RequestFilingRule.DATECOMPARISION_BEFORE_DATE, ruleFileByDate));
<span class="nc" id="L294">				result = true;</span>
			}
		} else {
<span class="nc" id="L297">			throw new IllegalArgumentException(&quot;Unknow dateComparisonType for filing rule: ID, dateComparisonType: &quot;</span>
<span class="nc" id="L298">					+ rule.getID() + ',' + dateComparisonType);</span>
		}
<span class="fc" id="L300">		return result;</span>
	}

	/**
	 * By interval checks against a relative interval to the requested date. The difference between the requested date and
	 * the filing date can either more-than, equal-to or less-than a fixed number of days. To implement more-than and
	 * less-than, the number of days is subtracted from the request date and compared to the filing date. To implement
	 * equal-to, the number of days is subtracted from the requested date and the file date is checked to ensure that it was
	 * made on that calendar day.
	 * @param rule
	 * @param reqFileDate
	 * @param result
	 * @param REQUEST_AGREES_WITH_FILING_RULE
	 * @param startOfTOorSS_OR_AucEndCal
	 * @param inAdvanceRule
	 * @param inAdvRequest
	 * @return
	 */
	private boolean requestAgreesWithByTimeRule(RequestFilingRule rule, Date reqFileDate, 
			String REQUEST_AGREES_WITH_FILING_RULE, Calendar startOfTOorSS_OR_AucEndCal, boolean inAdvanceRule,
			boolean inAdvRequest) {
<span class="nc" id="L321">		boolean result = false;</span>
<span class="nc" id="L322">		adjustCalByRuleInterval(rule, startOfTOorSS_OR_AucEndCal, inAdvanceRule);</span>
<span class="nc" id="L323">		Date timeForDaysInAdvOffset = startOfTOorSS_OR_AucEndCal.getTime();</span>

<span class="nc" id="L325">		String intervalType = rule.getIntervalType();</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">		if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L327">			m_cat.debug(&quot;intervalType = &quot; + intervalType);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">		if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L329">			m_cat.debug(&quot;getIntervalDays = &quot; + rule.getIntervalDays());</span>

		// if filing rule specifies: &quot;Request filed less than 'n' days in advance&quot;
<span class="nc bnc" id="L332" title="All 2 branches missed.">		if (intervalType.equals(RequestFilingRule.INTERVALTYPE_LESSTHAN)) {</span>
			// if the request was filed less than 'n' days in advance
			// The file date must be after the interval day
<span class="nc bnc" id="L335" title="All 6 branches missed.">			if ((inAdvRequest &amp;&amp; reqFileDate.after(timeForDaysInAdvOffset))</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">					|| (!inAdvRequest &amp;&amp; reqFileDate.before(timeForDaysInAdvOffset))) {</span>

<span class="nc bnc" id="L338" title="All 2 branches missed.">				if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L339">					m_cat.debug(REQUEST_AGREES_WITH_FILING_RULE</span>
<span class="nc" id="L340">							+ RmUtil.dumpCommaSeparated(RequestFilingRule.TIMETYPE_INTERVAL, reqFileDate,</span>
									RequestFilingRule.INTERVALTYPE_LESSTHAN, timeForDaysInAdvOffset));
<span class="nc" id="L342">				result = true;</span>
			}
		} // if filing rule specifies: &quot;Request filed more than 'n' days in advance&quot;
			// OR &quot;Request files les
<span class="nc bnc" id="L346" title="All 2 branches missed.">		else if (intervalType.equals(RequestFilingRule.INTERVALTYPE_MORETHAN)) {</span>
			// if the request was filed greater 'n' days in advance
			// The file date must be before the interval day
<span class="nc bnc" id="L349" title="All 6 branches missed.">			if ((inAdvRequest &amp;&amp; reqFileDate.before(timeForDaysInAdvOffset))</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">					|| (!inAdvRequest &amp;&amp; reqFileDate.after(timeForDaysInAdvOffset))) {</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">				if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L352">					m_cat.debug(REQUEST_AGREES_WITH_FILING_RULE</span>
<span class="nc" id="L353">							+ RmUtil.dumpCommaSeparated(RequestFilingRule.TIMETYPE_INTERVAL, reqFileDate,</span>
									RequestFilingRule.INTERVALTYPE_MORETHAN, timeForDaysInAdvOffset));
<span class="nc" id="L355">				result = true;</span>
			}
		} // if filing rule specifies: &quot;Request filed equal to 'n' days in advance&quot;
<span class="nc bnc" id="L358" title="All 2 branches missed.">		else if (intervalType.equals(RequestFilingRule.INTERVALTYPE_EQUALTO)) {</span>

<span class="nc" id="L360">			StringsPair intervalCountAndUnit = RequestUtil.getIntervalCountAndUnit(rule.getIntervalDays(), </span>
<span class="nc" id="L361">					rule.getRequestType().equals(Request.REQUESTTYPE_FLEXTIME));</span>
<span class="nc" id="L362">			String sUnits = intervalCountAndUnit.getValue();</span>

<span class="nc" id="L364">			Date startForTimeForInAdvOff = null;</span>
<span class="nc" id="L365">			Date endForTimeForInAdvOff = null;</span>

<span class="nc bnc" id="L367" title="All 2 branches missed.">			if(sUnits.equals(RequestUtil.DAYS)) {</span>
				// if the request was filed equal to 'n' days in advance
				// The filing time must occur on the organization calendar day corresponding
				// to the interval day.
<span class="nc" id="L371">				startForTimeForInAdvOff = getStartOfDay(startOfTOorSS_OR_AucEndCal);</span>
<span class="nc" id="L372">				endForTimeForInAdvOff = getEndOfDay(startOfTOorSS_OR_AucEndCal);</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">			} else if(sUnits.equals(RequestUtil.HOURS)) {</span>
<span class="nc" id="L374">				startForTimeForInAdvOff = getStartOfHour(startOfTOorSS_OR_AucEndCal);</span>
<span class="nc" id="L375">				endForTimeForInAdvOff = getEndOfHour(startOfTOorSS_OR_AucEndCal);</span>
			} else {
<span class="nc" id="L377">				startForTimeForInAdvOff = getStartOfMinute(startOfTOorSS_OR_AucEndCal);</span>
<span class="nc" id="L378">				endForTimeForInAdvOff = getEndOfMinute(startOfTOorSS_OR_AucEndCal);</span>
			}

			// if filingDate &gt;= start and filing &lt;= end, then req complies with rule.
<span class="nc bnc" id="L382" title="All 4 branches missed.">			if (!reqFileDate.before(startForTimeForInAdvOff) &amp;&amp; !reqFileDate.after(endForTimeForInAdvOff)) {</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">				if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L384">					m_cat.debug(REQUEST_AGREES_WITH_FILING_RULE</span>
<span class="nc" id="L385">							+ RmUtil.dumpCommaSeparated(RequestFilingRule.TIMETYPE_INTERVAL, reqFileDate,</span>
									RequestFilingRule.INTERVALTYPE_EQUALTO, timeForDaysInAdvOffset));
<span class="nc" id="L387">				result = true;</span>
			}
<span class="nc" id="L389">		} else {</span>
<span class="nc" id="L390">			throw new IllegalArgumentException(&quot;Unknow intervalType for filing rule: ID, intervalType: &quot; + rule.getID()</span>
					+ ',' + intervalType);
		}
<span class="nc" id="L393">		return result;</span>
	}

	private Date getStartOfDay(Calendar startOfTOorSS_OR_AucEndCal) {
<span class="nc" id="L397">		startOfTOorSS_OR_AucEndCal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L398">		return getStartOfHour(startOfTOorSS_OR_AucEndCal);</span>
	}

	private Date getStartOfHour(Calendar startOfTOorSS_OR_AucEndCal) {
<span class="nc" id="L402">		startOfTOorSS_OR_AucEndCal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L403">		return getStartOfMinute(startOfTOorSS_OR_AucEndCal);</span>
	}

	private Date getStartOfMinute(Calendar startOfTOorSS_OR_AucEndCal) {
<span class="nc" id="L407">		startOfTOorSS_OR_AucEndCal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L408">		startOfTOorSS_OR_AucEndCal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L409">		return startOfTOorSS_OR_AucEndCal.getTime();</span>
	}

	private Date getEndOfDay(Calendar startOfTOorSS_OR_AucEndCal) {
<span class="nc" id="L413">		startOfTOorSS_OR_AucEndCal.set(Calendar.HOUR_OF_DAY, 23);</span>
<span class="nc" id="L414">		return getEndOfHour(startOfTOorSS_OR_AucEndCal);</span>
	}

	private Date getEndOfHour(Calendar startOfTOorSS_OR_AucEndCal) {
<span class="nc" id="L418">		startOfTOorSS_OR_AucEndCal.set(Calendar.MINUTE, 59);</span>
<span class="nc" id="L419">		return getEndOfMinute(startOfTOorSS_OR_AucEndCal);</span>
	}

	private Date getEndOfMinute(Calendar startOfTOorSS_OR_AucEndCal) {
<span class="nc" id="L423">		startOfTOorSS_OR_AucEndCal.set(Calendar.SECOND, 59);</span>
<span class="nc" id="L424">		startOfTOorSS_OR_AucEndCal.set(Calendar.MILLISECOND, 999);</span>
<span class="nc" id="L425">		return startOfTOorSS_OR_AucEndCal.getTime();</span>
	}

	/**
	 * Adjust the given calendar with the given filing rule's configured interval. All filing rules are defined in hourly
	 * intervals, except Flex Time filing rules, which are defined in minute intervals.
	 * @param rule
	 * @param startOfTOorSS_OR_AucEndCal
	 * @param inAdvanceRule
	 */
	private void adjustCalByRuleInterval(RequestFilingRule rule, Calendar startOfTOorSS_OR_AucEndCal, boolean inAdvanceRule) {
<span class="nc bnc" id="L436" title="All 2 branches missed.">		int intervalCount = (inAdvanceRule ? -1 : 1) * rule.getIntervalDays();</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">		if (rule.getRequestType().equals(Request.REQUESTTYPE_FLEXTIME)) {</span>
<span class="nc" id="L438">			startOfTOorSS_OR_AucEndCal.add(Calendar.MINUTE, intervalCount);</span>
		} else {
<span class="nc" id="L440">			startOfTOorSS_OR_AucEndCal.add(Calendar.HOUR, intervalCount);</span>
		}
<span class="nc" id="L442">	}</span>

	public String toString() {
<span class="fc" id="L445">		StringBuffer buf = new StringBuffer(&quot;dumping FilingRuleChecker: &quot;);</span>

<span class="fc" id="L447">		buf.append(&quot;*** m_filingRules *** = &quot;).append(RmUtil.dumpCollection(m_filingRules));</span>
<span class="fc" id="L448">		buf.append(&quot;*** m_holidays *** = &quot;).append(RmUtil.dumpCollection(m_holidays));</span>
<span class="fc" id="L449">		buf.append(&quot;*** m_tz *** = &quot;).append(m_tz.getDisplayName()).append('\n');</span>

<span class="fc" id="L451">		return buf.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>