<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftEventListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">ShiftEventListPC.java</span></div><h1>ShiftEventListPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeContext;
import com.bluepumpkin.common.datatypes.TimeOfDay;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.time.TimeContextFactory;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftEvent;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftEventSortField;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.widgets.MultiColMasterDetailListPC;
import com.witness.web.uif.jsp.HtmlDiv;
import com.witness.web.uif.jsp.HtmlTag;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.table.DefaultHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.SortUtil;

public class ShiftEventListPC extends MultiColMasterDetailListPC {
	private static final long serialVersionUID = 1L;

	private TimeZone optimizationTargetTimeZone;
	private Date timeZoneEffectiveDate;	
<span class="fc" id="L50">	private Collection&lt;ShiftEvent&gt; shiftEvents = new ArrayList&lt;ShiftEvent&gt;();</span>
<span class="fc" id="L51">	private boolean isUserSortable = true;</span>
	
<span class="fc" id="L53">	Map&lt;ID, Organization&gt; orgMap = null;</span>
<span class="fc" id="L54">	Map&lt;ID, Campaign&gt; campaignMap = null;</span>
<span class="fc" id="L55">	Map&lt;ID, Activity&gt; activityMap = null;</span>
<span class="fc" id="L56">	private boolean m_isUsedInList = false;</span>
<span class="fc" id="L57">	private boolean isChildTable = false;</span>
	public static final String SHIFTEVENTLIST_SORTCOLUMN = &quot;SHIFTEVENTLIST_SORTCOLUMN&quot;;
	public static final String SHIFTEVENTLIST_SORTORDER = &quot;SHIFTEVENTLIST_SORTORDER&quot;;
	
	
	/**
	 * 
	 * @param isChildTable - If this table is used as a child table (for example the Shift list page where this is a child table showing
	 * the shift events linked to shifts), set this value to true so child table styling can be applied.
	 */
	public ShiftEventListPC(RequestContext context, String name, Collection&lt;ShiftEvent&gt; shiftEvents,
			TimeZone optimizationTargetTimezone, Date timeZoneEffectiveDate, Map&lt;ID, Organization&gt; orgMap, Map&lt;ID, Campaign&gt; campaignMap,
			Map&lt;ID, Activity&gt; activityMap, boolean isChildTable) {
<span class="fc" id="L70">		this(context,name, shiftEvents,optimizationTargetTimezone, timeZoneEffectiveDate,orgMap, campaignMap, activityMap, false, isChildTable);</span>
<span class="fc" id="L71">	}</span>
	
	/**
	 * 
	 * @param isChildTable - If this table is used as a child table (for example the Shift list page where this is a child table showing
	 * the shift events linked to shifts), set this value to true so child table styling can be applied.
	 */
	public ShiftEventListPC(RequestContext context, String name, Collection&lt;ShiftEvent&gt; shiftEvents,
			TimeZone optimizationTargetTimezone, Date timeZoneEffectiveDate, Map&lt;ID, Organization&gt; orgMap, Map&lt;ID, Campaign&gt; campaignMap,
			Map&lt;ID, Activity&gt; activityMap, boolean isUsedInList, boolean isChildTable) {
<span class="fc" id="L81">		super(context);</span>
<span class="fc" id="L82">		setName(name);</span>

<span class="fc bfc" id="L84" title="All 2 branches covered.">		if (optimizationTargetTimezone != null) {</span>
<span class="fc" id="L85">			this.optimizationTargetTimeZone = optimizationTargetTimezone;</span>
		} else {
<span class="fc" id="L87">			this.optimizationTargetTimeZone = getRequestContext().getViewingTimeZone();</span>
		}
<span class="fc" id="L89">		this.timeZoneEffectiveDate = timeZoneEffectiveDate;</span>
		
<span class="fc" id="L91">		this.shiftEvents = shiftEvents;</span>
<span class="fc" id="L92">		this.orgMap = orgMap;</span>
<span class="fc" id="L93">		this.campaignMap = campaignMap;</span>
<span class="fc" id="L94">		this.activityMap = activityMap;</span>
<span class="fc" id="L95">		this.m_isUsedInList = isUsedInList; //Must be assign before initHeader which is in extractParameters</span>
<span class="fc" id="L96">		this.isChildTable = isChildTable;</span>
<span class="fc" id="L97">		extractParameters(m_context.getRequest());</span>
		
		
<span class="fc" id="L100">		addRequiredJavaScriptFile(WorkRulesJSFileID.WORK_RULES_UTIL);</span>
<span class="fc" id="L101">		addPopupArgs(ActivityPopupPM.POPUP_ID, ActivityPopupPM.FORM_ACTION, &quot;&quot;,</span>
				ActivityPopupPM.POPUP_ARGS, &quot;1000,600,ctr,ctr&quot;, true, 1);
<span class="fc" id="L103">	}</span>
	
	@Override
	public String getJavaScriptInitCode() {
<span class="fc" id="L107">		StringBuffer js = new StringBuffer(super.getJavaScriptInitCode());</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">		if (getToolbar() != null) {</span>
<span class="fc" id="L109">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.setToolbar(&quot;).append(getToolbar().getName()).append(&quot;);&quot;);</span>
<span class="fc" id="L110">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.addButtonEnableAttribute('isDeleteable', 'removeShiftEvent');\n&quot;);</span>
		}
<span class="fc" id="L112">		return js.toString();</span>
	}
	
	@Override
	public String getHtmlDisplay() {
<span class="fc" id="L117">		initRows();</span>
<span class="fc" id="L118">		return super.getHtmlDisplay();</span>
	}
	
	public HtmlTag getWrapper() {
<span class="fc bfc" id="L122" title="All 2 branches covered.">		if (isChildTable) {</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">			if (m_wrapper == null) m_wrapper = new HtmlDiv();</span>
<span class="fc" id="L124">			m_wrapper.setStyle(&quot;margin:20px&quot;);</span>
<span class="fc" id="L125">			return m_wrapper;</span>
		} else {
<span class="fc" id="L127">			return super.getWrapper();</span>
		}
	}

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L133">		boolean retVal = super.extractParameters(request);</span>
<span class="fc" id="L134">		HashSet&lt;ID&gt; removedIDs = new HashSet&lt;ID&gt;(Arrays.asList(StringUtil.parseIDString(getRemovedRowIDs())));</span>
<span class="fc" id="L135">		HashSet&lt;ID&gt; addedIDs = new HashSet&lt;ID&gt;(Arrays.asList(StringUtil.parseIDString(getAddedRowIDs())));</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">		if (shiftEvents != null) {</span>
<span class="fc" id="L137">			Iterator&lt;ShiftEvent&gt; seIter = shiftEvents.iterator(); </span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">			while (seIter.hasNext()) {</span>
<span class="fc" id="L139">				ShiftEvent se = seIter.next();</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">				if (removedIDs.contains(se.getID())) seIter.remove();</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">				if (addedIDs.contains(se.getID())) addedIDs.remove(se.getID());</span>
<span class="fc" id="L142">			}</span>
			
<span class="fc bfc" id="L144" title="All 2 branches covered.">			if (addedIDs.size() &gt; 0) {</span>
				try {
<span class="fc" id="L146">					Collection&lt;ShiftEvent&gt; newShiftEvents = WorkRulesModelHandler.getShiftEvents(m_context, addedIDs);</span>
<span class="fc" id="L147">					ArrayList&lt;ID&gt; newActivityIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L148">					ArrayList&lt;ID&gt; newOrgIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">					for (ShiftEvent se : newShiftEvents) {</span>
<span class="fc" id="L150">						newActivityIDs.add(se.getActivityID());</span>
<span class="fc" id="L151">						newOrgIDs.add(se.getOrganizationID());</span>
<span class="fc" id="L152">					}</span>

<span class="fc" id="L154">					Map&lt;ID, Organization&gt; newOrgMap = WorkRulesModelHandler.getOrgs(m_context, newOrgIDs);</span>
<span class="fc" id="L155">					Map&lt;ID, Activity&gt; newActivityMap = WorkRulesModelHandler.getActivities(m_context, newActivityIDs);</span>
					
<span class="fc" id="L157">					shiftEvents.addAll(WorkRulesModelHandler.getShiftEvents(m_context, addedIDs));</span>
<span class="fc" id="L158">					orgMap.putAll(newOrgMap);</span>
<span class="fc" id="L159">					activityMap.putAll(newActivityMap);</span>
<span class="nc" id="L160">				} catch (BbmFinderException e) {</span>
<span class="nc" id="L161">					handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L162">					retVal = false;</span>
<span class="fc" id="L163">				}</span>
			}
		}
<span class="fc" id="L166">		initHeader();</span>
<span class="fc" id="L167">		return retVal;</span>
	}

<span class="fc" id="L170">	private boolean isHeaderInited = false;</span>
	private void initHeader() {
<span class="fc bfc" id="L172" title="All 2 branches covered.">		if (isHeaderInited) return;</span>
<span class="fc" id="L173">		isHeaderInited = true;</span>
<span class="fc" id="L174">		TableHeaderPC header = getHeader();</span>
<span class="fc" id="L175">		header.setPartialSortable(isUserSortable);</span>

<span class="fc" id="L177">		Localizer localizer = m_context.getLocalizer();</span>
<span class="fc" id="L178">		header.addColumnHeaderData(UIFWebBundleKey.LIST_HEADER_NAME, localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.LIST_HEADER_NAME), isUserSortable);</span>
<span class="fc" id="L179">		DefaultHeaderData dhd = new DefaultHeaderData(FsWebBundleKey.FS_EVENT_ACTIVITY,</span>
<span class="fc" id="L180">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_EVENT_ACTIVITY));</span>
<span class="fc" id="L181">		dhd.addImageButton(getActivityPopupImage(), getActivityPopupCaption(), getActivityPopupJS());</span>
<span class="fc" id="L182">		dhd.setSortable(isUserSortable);</span>
<span class="fc" id="L183">		header.addColumnHeaderData(dhd);</span>
<span class="fc" id="L184">		header.addColumnHeaderData(FsWebBundleKey.FS_EVENT_LENGTH, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_EVENT_LENGTH), isUserSortable);</span>
<span class="fc" id="L185">		header.addColumnHeaderData(FsWebBundleKey.FS_START_TIME_TYPE, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_START_TIME_TYPE), isUserSortable);</span>
<span class="fc" id="L186">		header.addColumnHeaderData(FsWebBundleKey.FS_START_WINDOW, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_START_WINDOW), isUserSortable);</span>
<span class="fc" id="L187">		header.addColumnHeaderData(FsWebBundleKey.FS_EVENT_PAID, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_EVENT_PAID), isUserSortable);</span>
<span class="fc" id="L188">		header.addColumnHeaderData(FsWebBundleKey.FS_FLEXIBLE, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_FLEXIBLE), isUserSortable);</span>
<span class="fc" id="L189">		header.addColumnHeaderData(FsWebBundleKey.FS_MIN_COUNT, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MIN_COUNT), isUserSortable);</span>
<span class="fc" id="L190">		header.addColumnHeaderData(FsWebBundleKey.FS_MAX_COUNT, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MAX_COUNT), isUserSortable);</span>
<span class="fc" id="L191">		header.addColumnHeaderData(FsWebBundleKey.FS_ADDITIONAL_ACTIVITIES, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ADDITIONAL_ACTIVITIES), false);</span>
<span class="fc" id="L192">		header.addColumnHeaderData(FsWebBundleKey.FS_SHIFT_ORG_SELECTOR, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SHIFT_ORG_SELECTOR), isUserSortable);</span>
<span class="fc" id="L193">		header.addColumnHeaderData(UIFWebBundleKey.LIST_HEADER_DESCRIPTION, localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.LIST_HEADER_DESCRIPTION), isUserSortable);</span>
<span class="fc" id="L194">		setPersitedSortHeader(m_isUsedInList, header);</span>
<span class="fc" id="L195">	}</span>

<span class="fc" id="L197">	private boolean isRowsInited = false;</span>
	private void initRows() {
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">		if (isRowsInited) return;</span>
<span class="fc" id="L200">		isRowsInited = true;</span>
		
<span class="fc" id="L202">		List&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>
		
<span class="fc" id="L204">		Localizer localizer = m_context.getLocalizer();</span>

<span class="fc" id="L206">		StringBuffer shiftEventIDList = new StringBuffer();</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">		for (ShiftEvent shiftEvent : shiftEvents) {</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">			if (shiftEventIDList.length() &gt; 0) { shiftEventIDList.append(&quot;,&quot;); }</span>
<span class="fc" id="L209">			shiftEventIDList.append(shiftEvent.getID().toString());</span>
			
<span class="fc" id="L211">			DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(</span>
<span class="fc" id="L212">					shiftEvent.getID());</span>
			
			//Name
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">			if (shiftEvent.isMultiEditCommon() == false) {</span>
<span class="nc" id="L216">				nodeData.add(MULTI_VALUE_DATA + shiftEvent.getName());</span>
			} else {
<span class="fc" id="L218">				nodeData.add(shiftEvent.getName());</span>
			}
			// Activity
<span class="fc" id="L221">			Activity a = activityMap.get(shiftEvent.getActivityID());</span>
			//The activity should never be null, but if it is it's preferable to display a blank value for
			//  activity name instead of having the app crash
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">			if (a != null) {</span>
<span class="fc" id="L225">				nodeData.add(a.getName());</span>
			} else { 
<span class="nc" id="L227">				nodeData.add(&quot;&quot;);</span>
			}

			//Duration
<span class="fc" id="L231">			nodeData.add(localizer.formatDurationInMins(shiftEvent.getDuration().getDurationInMinutes()));</span>
			
			//Start Time Type
<span class="fc bfc" id="L234" title="All 2 branches covered.">			if (shiftEvent.isAnyTime()) {</span>
<span class="fc" id="L235">				nodeData.add(localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ANY_TIME));</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">			} else if (shiftEvent.isCafeteria()) {</span>
<span class="fc" id="L237">				nodeData.add(localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ABSOLUTE));</span>
			} else {
<span class="fc" id="L239">				nodeData.add(localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_RELATIVE_TO_SHIFT_START));</span>
			}

			//Start Window
<span class="fc bfc" id="L243" title="All 2 branches covered.">			if (shiftEvent.isAnyTime()) {</span>
<span class="fc" id="L244">				nodeData.add(&quot;&quot;);</span>
			} else {
<span class="fc bfc" id="L246" title="All 2 branches covered.">				if (shiftEvent.isCafeteria()) {</span>
<span class="fc" id="L247">					TimeContext seTimeContext = TimeContextFactory.getTimeContext(shiftEvent, orgMap, campaignMap);</span>
<span class="fc" id="L248">					int timeZoneOffsetInMins = WorkRulesUtil.getTotalTimeZoneOffsetForWorkRuleDisplay(m_context,</span>
<span class="fc" id="L249">							optimizationTargetTimeZone, seTimeContext.getTimeZone(), timeZoneEffectiveDate);</span>
					
<span class="fc" id="L251">					int dayBoundary = seTimeContext.getDayBoundary();</span>
<span class="fc" id="L252">					nodeData.add(localizer.formatTimeInMins(new TimeOfDay(shiftEvent.getStart() + dayBoundary).addMinutes(timeZoneOffsetInMins).getMinutesSinceMindnight())</span>
<span class="fc" id="L253">							+ &quot;-&quot; + localizer.formatTimeInMins(new TimeOfDay(shiftEvent.getEnd() + dayBoundary).addMinutes(timeZoneOffsetInMins).getMinutesSinceMindnight()));</span>
<span class="fc" id="L254">				} else {</span>
<span class="fc" id="L255">					nodeData.add(localizer.formatDurationInMins(shiftEvent.getStart())</span>
<span class="fc" id="L256">							+ &quot;-&quot; + localizer.formatDurationInMins(shiftEvent.getEnd()));</span>
				}
			}
			
			//IsPaid
<span class="fc" id="L261">			nodeData.add(localizer.formatYesNo(shiftEvent.isPaid()));</span>

			//IsFlexible
<span class="fc bfc" id="L264" title="All 2 branches covered.">			if (shiftEvent.isPaid()) nodeData.add(localizer.formatYesNo(shiftEvent.isFlexible()));</span>
<span class="fc" id="L265">			else nodeData.add(&quot;&quot;);</span>
			
<span class="fc bfc" id="L267" title="All 4 branches covered.">			if (shiftEvent.isPaid() &amp;&amp; shiftEvent.isFlexible()) {</span>
				//Min Count
<span class="fc" id="L269">				nodeData.add(Integer.toString(shiftEvent.getMinCount()));</span>
				//Max Count
<span class="fc" id="L271">				nodeData.add(Integer.toString(shiftEvent.getMaxCount()));</span>
			} else {
<span class="fc" id="L273">				nodeData.add(&quot;&quot;);</span>
<span class="fc" id="L274">				nodeData.add(&quot;&quot;);</span>
			}
			
			//Additional activities
<span class="fc" id="L278">			ArrayList&lt;String&gt; activityNames = new ArrayList&lt;String&gt;();</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">			for (Activity activity : shiftEvent.getAdditionalActivities()) {</span>
<span class="nc" id="L280">				activityNames.add(activity.getName());</span>
<span class="nc" id="L281">			}</span>
<span class="fc" id="L282">			Collections.sort(activityNames, getLocalizer().getCollator());</span>
<span class="fc" id="L283">			nodeData.add(StringUtil.join(activityNames, &quot;, &quot;));</span>
			
			//Organization or Campaign name
<span class="fc" id="L286">			Organization o = orgMap.get(shiftEvent.getOrganizationID());</span>
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">			nodeData.add(o == null ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.LOCAL) : WorkRulesUtil.getEscapedStringRepresentation(o.getName()));</span>

			// Description
<span class="fc" id="L290">			nodeData.add(shiftEvent.getDescription());</span>

<span class="fc" id="L292">			setRowAttributes(nodeData, shiftEvent);</span>
			
<span class="fc" id="L294">			rows.add(nodeData);</span>
<span class="fc" id="L295">		}</span>
		
		//Sort the rows by item name as a default only if user sorting is disabled
<span class="fc bfc" id="L298" title="All 2 branches covered.">		if (isUserSortable == false) {</span>
<span class="fc" id="L299">			SortUtil.sort(rows, getHeader().getColumnIndexByName(UIFWebBundleKey.LIST_HEADER_NAME), true, m_context.getLocalizer());</span>
		}

<span class="fc" id="L302">		setRowIDs(shiftEventIDList.toString());</span>
<span class="fc" id="L303">	}</span>
	
	/**
	 * Sub-classes can override this method to set attributes on the MultiColumnNodeData.
	 * @param mcnd MultiColumnNodeData that is populated with the Shift Event's values. Set the node attributes on this object.
	 * @param shiftEvent that is represented by this row. Use this object to determine if attributes should be set on the MultiColumnNodeData
	 */
	protected void setRowAttributes(DefaultMultiColumnNodeData mcnd, ShiftEvent shiftEvent) {
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">		if (shiftEvent.getActivityID() != null) {</span>
<span class="fc" id="L312">			mcnd.setNodeAttribute(ActivityPopupPM.POPUP_ARG_VO_ID, shiftEvent.getActivityID().toString());</span>
		}
<span class="fc" id="L314">	}</span>
	
	public Collection&lt;ShiftEvent&gt; getShiftEvents() {
<span class="nc" id="L317">		return shiftEvents;</span>
	}
	
	private String getActivityPopupImage() {
<span class="fc" id="L321">		return ImageFileID.TOOLTIP_BUTTON;</span>
	}
	
	private String getActivityPopupCaption() {
<span class="fc" id="L325">		return m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.ACTIVITY_VIEW_ACTION);</span>
	}
	
	private String getActivityPopupJS() {
<span class="fc" id="L329">		return &quot;WorkRulesUtil.handleInfoPopup(this, &quot; + getName() + &quot;,&quot; + getHeader().getName() + &quot;,'&quot; +</span>
			ActivityPopupPM.POPUP_ID + &quot;','&quot; + ActivityPopupPM.POPUP_ARG_VO_ID + &quot;','&quot; +
			ActivityPopupPM.POPUP_ARG_VO_IDS + &quot;');&quot;;	
	}
	
	public LinkedHashMap&lt;DBSortField, Comparator&gt; getSortComparators() {
<span class="fc" id="L335">		LinkedHashMap&lt;DBSortField, Comparator&gt; comparators =</span>
			new LinkedHashMap&lt;DBSortField, Comparator&gt;();
<span class="fc bfc" id="L337" title="All 2 branches covered.">		for (ShiftEventSortField sortField : getDBSortFieldIndices()) {</span>
<span class="pc bpc" id="L338" title="13 of 14 branches missed.">			switch (sortField) {</span>
				case ID:
<span class="fc" id="L340">					comparators.put(ShiftEventSortField.ID, null);</span>
<span class="fc" id="L341">					break;</span>
				case NAME:
<span class="nc" id="L343">					comparators.put(ShiftEventSortField.NAME, null);</span>
<span class="nc" id="L344">					break;</span>
				case ACTIVITY:
<span class="nc" id="L346">					comparators.put(ShiftEventSortField.ACTIVITY, null);</span>
<span class="nc" id="L347">					break;</span>
				case LENGTH:
<span class="nc" id="L349">					comparators.put(ShiftEventSortField.LENGTH, null);</span>
<span class="nc" id="L350">					break;</span>
				case START_TIME_TYPE:
<span class="nc" id="L352">					comparators.put(ShiftEventSortField.START_TIME_TYPE, new StartWindowTypeComparator(getLocalizer()));</span>
<span class="nc" id="L353">					break;</span>
				case START_WINDOW:
<span class="nc" id="L355">					comparators.put(ShiftEventSortField.START_WINDOW, new IntegerComparator());</span>
<span class="nc" id="L356">					break;</span>
				case PAID:
<span class="nc" id="L358">					comparators.put(ShiftEventSortField.PAID, new YesNoComparator(getLocalizer()));</span>
<span class="nc" id="L359">					break;</span>
				case FLEXIBLE:
<span class="nc" id="L361">					comparators.put(ShiftEventSortField.FLEXIBLE, new YesNoComparator(getLocalizer()));</span>
<span class="nc" id="L362">					break;</span>
				case MIN_COUNT:
<span class="nc" id="L364">					comparators.put(ShiftEventSortField.MIN_COUNT, new IntegerComparator());</span>
<span class="nc" id="L365">					break;</span>
				case MAX_COUNT:
<span class="nc" id="L367">					comparators.put(ShiftEventSortField.MAX_COUNT, new IntegerComparator());</span>
<span class="nc" id="L368">					break;</span>
				case ADDITIONAL_ACTIVITIES:
<span class="nc" id="L370">					comparators.put(ShiftEventSortField.ADDITIONAL_ACTIVITIES, null);</span>
<span class="nc" id="L371">					break;</span>
				case ORGANIZATION:
<span class="nc" id="L373">					comparators.put(ShiftEventSortField.ORGANIZATION, new OrganizationCampaignNameComparator(getLocalizer()));</span>
<span class="nc" id="L374">					break;</span>
				case DESCRIPTION:
<span class="nc" id="L376">					comparators.put(ShiftEventSortField.DESCRIPTION, null);</span>
					break;
			}
<span class="fc" id="L379">		}</span>
		
<span class="fc" id="L381">		return comparators;</span>
	}
	
	public ArrayList&lt;ShiftEventSortField&gt; getDBSortFieldIndices() {
<span class="fc" id="L385">		ArrayList&lt;ShiftEventSortField&gt; retVal = new ArrayList&lt;ShiftEventSortField&gt;();</span>
<span class="fc" id="L386">		TableHeaderPC header = getHeader();</span>
<span class="fc" id="L387">		setPersitedSortHeader(m_isUsedInList, header);</span>
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">		if (header.getSortColumnIndexes() == null) {</span>
			//Default sort index is by ID (chronological order in which object was created)
<span class="fc" id="L390">			retVal.add(ShiftEventSortField.ID);</span>
		} else {
<span class="nc bnc" id="L392" title="All 2 branches missed.">			for (int sortField : header.getSortColumnIndexes()) {</span>
<span class="nc bnc" id="L393" title="All 13 branches missed.">				switch (sortField) {</span>
					case 0: 
<span class="nc" id="L395">						retVal.add(ShiftEventSortField.NAME);</span>
<span class="nc" id="L396">						break;</span>
					case 1: 
<span class="nc" id="L398">						retVal.add(ShiftEventSortField.ACTIVITY);</span>
<span class="nc" id="L399">						break;</span>
					case 2: 
<span class="nc" id="L401">						retVal.add(ShiftEventSortField.LENGTH);</span>
<span class="nc" id="L402">						break;</span>
					case 3: 
<span class="nc" id="L404">						retVal.add(ShiftEventSortField.START_TIME_TYPE);</span>
<span class="nc" id="L405">						break;</span>
					case 4: 
<span class="nc" id="L407">						retVal.add(ShiftEventSortField.START_WINDOW);</span>
<span class="nc" id="L408">						break;</span>
					case 5: 
<span class="nc" id="L410">						retVal.add(ShiftEventSortField.PAID);</span>
<span class="nc" id="L411">						break;</span>
					case 6: 
<span class="nc" id="L413">						retVal.add(ShiftEventSortField.FLEXIBLE);</span>
<span class="nc" id="L414">						break;</span>
					case 7: 
<span class="nc" id="L416">						retVal.add(ShiftEventSortField.MIN_COUNT);</span>
<span class="nc" id="L417">						break;</span>
					case 8: 
<span class="nc" id="L419">						retVal.add(ShiftEventSortField.MAX_COUNT);</span>
<span class="nc" id="L420">						break;</span>
					case 9:
<span class="nc" id="L422">						retVal.add(ShiftEventSortField.ADDITIONAL_ACTIVITIES);</span>
<span class="nc" id="L423">						break;</span>
					case 10: 
<span class="nc" id="L425">						retVal.add(ShiftEventSortField.ORGANIZATION);</span>
<span class="nc" id="L426">						break;</span>
					case 11: 
<span class="nc" id="L428">						retVal.add(ShiftEventSortField.DESCRIPTION);</span>
<span class="nc" id="L429">						break;</span>
					default: break;
				}
			}
		}
<span class="fc" id="L434">		return retVal;</span>
	}
	
	/**
	 * Setting this to false will prevent the user from being able to change
	 * the sort order by clicking on the column header.  This behavior may be
	 * desirable if this list is used as an assignment list for another master
	 * list.  If this value is set to false, the list will be sorted by shift event
	 * name.  Default value is true.
	 */
	public void setIsUserSortable(boolean isUserSortable) {
<span class="fc" id="L445">		this.isUserSortable = isUserSortable;</span>
<span class="pc bpc" id="L446" title="1 of 2 branches missed.">		if (this.getHeader() != null) {</span>
<span class="fc" id="L447">			this.getHeader().setSortable(isUserSortable);</span>
<span class="fc" id="L448">			this.getHeader().setPartialSortable(isUserSortable);</span>
		}
<span class="fc" id="L450">	}</span>

	private void setPersitedSortHeader(boolean isUsedInList, TableHeaderPC header) {
<span class="fc" id="L453">		String sortColumn = null;</span>
<span class="fc" id="L454">		String sortOrder = null;</span>
<span class="fc bfc" id="L455" title="All 2 branches covered.">		if (isUsedInList) {</span>
<span class="fc" id="L456">			sortColumn = m_context.getUserProperty(SHIFTEVENTLIST_SORTCOLUMN);</span>
<span class="fc" id="L457">			sortOrder = m_context.getUserProperty(SHIFTEVENTLIST_SORTORDER);</span>
		}
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">		if (sortColumn != null) {</span>
<span class="nc" id="L460">			header.setSortColumn(sortColumn);</span>
		}
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">		if (sortOrder != null) {</span>
<span class="nc" id="L463">			header.setSortOrder(sortOrder);</span>
		}
<span class="fc" id="L465">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>