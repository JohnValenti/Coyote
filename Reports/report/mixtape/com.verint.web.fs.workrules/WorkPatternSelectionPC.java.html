<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WorkPatternSelectionPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">WorkPatternSelectionPC.java</span></div><h1>WorkPatternSelectionPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeType;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.workrules.assignment.WorkPatternListPopupPM;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.list.DynamicMultiColListWithToolbarPC;
import com.witness.web.uif.pagecomponent.table.DefaultHeaderData;
import com.witness.web.uif.pagecomponent.table.GenericHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.system.RequestContext;

/**
 * This component is a dynamic list of Work Patterns. It has a toolbar
 * which has buttons for manipulating the list.
 * @author rfunderburg
 */
@SuppressWarnings(&quot;serial&quot;)
public class WorkPatternSelectionPC extends PageComponent {
<span class="fc" id="L42">	private ID data_selectedOrgID = null;</span>
<span class="fc" id="L43">	private List&lt;ShiftPattern&gt; data_workPatterns = new ArrayList&lt;ShiftPattern&gt;();;</span>
	private MyDynamicMultiColListPC pc_list;
<span class="fc" id="L45">	private Map&lt;ID, EmployeeType&gt; data_employeeTypeMap = new HashMap&lt;ID, EmployeeType&gt;();</span>
<span class="fc" id="L46">	private Map&lt;ID, Organization&gt; data_orgMap = new HashMap&lt;ID, Organization&gt;();</span>

	/**
	 * This subclass only exists so that we can change the visibility of the initJSVariables
	 * method, which is vital for component initialization.
	 */
	private static class MyDynamicMultiColListPC extends DynamicMultiColListWithToolbarPC {
		public MyDynamicMultiColListPC(RequestContext context) {
<span class="fc" id="L54">			super(context);</span>
<span class="fc" id="L55">			addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="fc" id="L56">		}</span>

		@Override
		protected void initJSVariables() {
<span class="fc" id="L60">			super.initJSVariables();</span>
<span class="fc" id="L61">		}</span>

		@SuppressWarnings(&quot;rawtypes&quot;)
		@Override
		protected Map getJSVariableMap() {
<span class="fc" id="L66">			return super.getJSVariableMap();</span>
		}
	}
	
	
	public WorkPatternSelectionPC(RequestContext context, String name) {
<span class="fc" id="L72">		super(context);</span>
<span class="fc" id="L73">		pc_list = new MyDynamicMultiColListPC(context);</span>
<span class="fc" id="L74">		pc_list.setName(name);</span>
<span class="fc" id="L75">		pc_list.setIsCreateButtonShown(false);</span>
<span class="fc" id="L76">	}</span>

	@Override
	public boolean validate() {
<span class="fc" id="L80">		return pc_list.validate();</span>
	}

	@Override
	public String getRequiredHTML() {
<span class="fc" id="L85">		return pc_list.getRequiredHTML();</span>
	}
	
	

	@Override
	public void setEnabled(boolean enabled) {
<span class="nc" id="L92">		pc_list.setEnabled(enabled);</span>
<span class="nc" id="L93">	}</span>

	@Override
	public void setVisible(boolean visible) {
<span class="nc" id="L97">		pc_list.setVisible(visible);</span>
<span class="nc" id="L98">	}</span>

	public void setData(ID selectedOrgID, Collection&lt;ShiftPattern&gt; workPatterns,
			Map&lt;ID, EmployeeType&gt; employeeTypeMap, 
			Map&lt;ID, Organization&gt; orgMap) {
<span class="fc" id="L103">		data_selectedOrgID = selectedOrgID;</span>
<span class="fc" id="L104">		data_workPatterns.addAll(workPatterns);</span>
<span class="fc" id="L105">		data_employeeTypeMap.putAll(employeeTypeMap);</span>
<span class="fc" id="L106">		data_orgMap.putAll(orgMap);</span>
<span class="fc" id="L107">	}</span>

	@Override
	protected void initJSVariables() {
<span class="fc" id="L111">		super.initJSVariables();</span>
<span class="fc" id="L112">		pc_list.initJSVariables();</span>
<span class="fc" id="L113">	}</span>
	
	@SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
	@Override
	protected Map getJSVariableMap() {
<span class="fc" id="L118">		Map retVal = new HashMap();</span>
<span class="fc" id="L119">		retVal.putAll(super.getJSVariableMap());</span>
<span class="fc" id="L120">		retVal.putAll(pc_list.getJSVariableMap());</span>
<span class="fc" id="L121">		return retVal;</span>
	}

	@Override
	public void initValidators() {
<span class="fc" id="L126">		pc_list.initValidators();</span>
<span class="fc" id="L127">	}</span>

	@Override
	public void setName(String name) {
<span class="nc" id="L131">		pc_list.setName(name);</span>
<span class="nc" id="L132">	}</span>

	@Override
	public String getName() {
<span class="fc" id="L136">		return pc_list.getName();</span>
	}

	@Override
	public Collection&lt;String&gt; getRequireJavaScriptFiles() {
<span class="fc" id="L141">		LinkedList&lt;String&gt; files = new LinkedList&lt;String&gt;();</span>
<span class="fc" id="L142">		files.addAll(super.getRequireJavaScriptFiles());</span>
<span class="fc" id="L143">		files.addAll(pc_list.getRequireJavaScriptFiles());</span>
<span class="fc" id="L144">		return files;</span>
	}

	@Override
	public void initForDisplay() {
<span class="fc" id="L149">		super.initForDisplay();</span>
<span class="fc" id="L150">		initHeader();</span>
<span class="fc" id="L151">		initRows();</span>

<span class="fc" id="L153">		pc_list.getDynamicMultiColList().setIsRowNumberEnabled(true);</span>
		
<span class="fc" id="L155">		ToolbarPC toolbar = pc_list.getToolbar();</span>
<span class="fc" id="L156">		ToolbarTextButton addButton = toolbar.createPopupWindowButton(</span>
				WorkPatternSelectionPopupPM.POPUP_ID,
<span class="fc" id="L158">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_ADD), </span>
				true);
<span class="fc" id="L160">		toolbar.addToolbarElement(addButton);</span>
		
<span class="fc" id="L162">		addButton.setAttribute(WorkPatternSelectionPopupPM.POPUP_ARG_PARENT_TABLE, pc_list.getDynamicMultiColList().getName());</span>
<span class="fc" id="L163">		addButton.setAttribute(WorkPatternSelectionPopupPM.POPUP_ARG_ORG_ID, data_selectedOrgID.toString());</span>
		
		// Popup for the add button
<span class="fc" id="L166">		addPopupArgs(</span>
				WorkPatternSelectionPopupPM.POPUP_ID, 
				WorkPatternSelectionPopupPM.POPUP_URL, 
				&quot;&quot;, // Static params
				WorkPatternSelectionPopupPM.POPUP_ARGS, // dynamic param names 
				&quot;1000,600,ctr,ctr&quot;, // window properties
				true, // isModal
				1); // num windows allowed
		
		// Popup for the info button
<span class="fc" id="L176">		addPopupArgs(</span>
				WorkPatternListPopupPM.POPUP_ID, 
				WorkPatternListPopupPM.FORM_ACTION, 
				&quot;&quot;, // Static params
				WorkPatternListPopupPM.POPUP_ARGS, // dynamic param names 
				&quot;1000,600,ctr,ctr&quot;, // window properties
				false, // isModal
				1); // num windows allowed
		
<span class="fc" id="L185">		pc_list.initForDisplay();</span>
<span class="fc" id="L186">	}</span>
	
	private String getInfoButtonPopupJS() {
		/* This logic is based on the WorkRulesUtil.js function handleInfoPopup. However because this component
		 * uses a DynamicTable instead of a InsertableTable, the method to get the work pattern ids differs.
		 */
		
		//String 
<span class="fc" id="L194">		TimeZone tz = data_orgMap.get(data_selectedOrgID).getTimeZone();</span>
<span class="fc" id="L195">		StringBuffer js = new StringBuffer();</span>
		// Set the selectedIDs attr on the button
<span class="fc" id="L197">		js.append(&quot;jQuery(this).attr('&quot;)</span>
<span class="fc" id="L198">			.append(WorkPatternListPopupPM.POPUP_ARG_SELECTED_IDS).append(&quot;',&quot;)</span>
<span class="fc" id="L199">			.append(pc_list.getDynamicMultiColList().getName()).append(&quot;.getRowIDs().join());&quot;);</span>
		// Set the is info popup attr on the button
<span class="fc" id="L201">		js.append(&quot;jQuery(this).attr('&quot;).append(WorkPatternListPopupPM.POPUP_ARG_IS_INFO_POPUP).append(&quot;', 'true');&quot;);</span>
		// set the time zone arg on the button
<span class="fc" id="L203">		js.append(&quot;jQuery(this).attr('&quot;).append(OTExtensionListPopupPM.ARG_TIME_ZONE).append(&quot;', '&quot;).append(tz.getID()).append(&quot;');&quot;);</span>
		// set the time zone date arg on the button
<span class="fc" id="L205">		js.append(&quot;jQuery(this).attr('&quot;).append(OTExtensionListPopupPM.ARG_TIME_ZONE_DATE).append(&quot;', &quot;).append(System.currentTimeMillis()).append(&quot;);&quot;);</span>
		// call the onSelect function of the header. This does the actual popup
<span class="fc" id="L207">		js.append(pc_list.getDynamicMultiColList().getHeader().getName()).append(&quot;.onSelect('&quot;).append(WorkPatternListPopupPM.POPUP_ID).append(&quot;', this);&quot;);</span>
<span class="fc" id="L208">		return js.toString();</span>
	}
	


	private void initHeader() {
<span class="fc" id="L214">		TableHeaderPC header = pc_list.getDynamicMultiColList().getHeader();</span>
<span class="fc" id="L215">		header.setHeaders(new ArrayList&lt;GenericHeaderData&gt;());</span>
		
<span class="fc" id="L217">		Localizer localizer = m_context.getLocalizer();</span>

<span class="fc" id="L219">		DefaultHeaderData dhd = new DefaultHeaderData(FsWebBundleKey.FS_NAME,</span>
<span class="fc" id="L220">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_NAME));</span>
		// Add info button to header
<span class="fc" id="L222">		dhd.addImageButton(</span>
				ImageFileID.TOOLTIP_BUTTON, 
<span class="fc" id="L224">				m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_VIEW_WORK_PATTERN_DETAILS), </span>
<span class="fc" id="L225">				getInfoButtonPopupJS());</span>
<span class="fc" id="L226">		dhd.setSortable(false);</span>
<span class="fc" id="L227">		header.addColumnHeaderData(dhd);</span>
<span class="fc" id="L228">		header.addColumnHeaderData(FsWebBundleKey.FS_CONSISTENCY_TOLERANCE, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_CONSISTENCY_TOLERANCE), true);</span>
<span class="fc" id="L229">		header.addColumnHeaderData(FsWebBundleKey.FS_EMPLOYEE_TYPE, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_EMPLOYEE_TYPE), true);</span>
<span class="fc" id="L230">		header.addColumnHeaderData(FsWebBundleKey.FS_SHIFT_ORG_SELECTOR, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SHIFT_ORG_SELECTOR), true);</span>
<span class="fc" id="L231">		header.addColumnHeaderData(UIFWebBundleKey.LIST_HEADER_DESCRIPTION, localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.LIST_HEADER_DESCRIPTION), true);</span>
		
<span class="fc" id="L233">		DefaultMultiColumnNodeData nd = new DefaultMultiColumnNodeData();</span>
<span class="fc" id="L234">		nd.add(&quot;Name&quot;);</span>
<span class="fc" id="L235">		nd.add(&quot;ConsistencyTolerance&quot;);</span>
<span class="fc" id="L236">		nd.add(&quot;EmployeeType&quot;);</span>
<span class="fc" id="L237">		nd.add(&quot;Organization&quot;);</span>
<span class="fc" id="L238">		nd.add(&quot;Description&quot;);</span>
<span class="fc" id="L239">		pc_list.getDynamicMultiColList().setTemplateNodeData(nd);</span>
<span class="fc" id="L240">	}</span>

	private void initRows() {
		@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L244">		List&lt;MultiColumnNodeData&gt; rows = pc_list.getDynamicMultiColList().getListModel();</span>
<span class="fc" id="L245">		rows.clear();</span>
		
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">		if (data_workPatterns != null) {</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">			for (ShiftPattern shiftPattern : data_workPatterns) {</span>
<span class="nc" id="L249">				DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData(shiftPattern.getID());</span>
				
				//Name
<span class="nc bnc" id="L252" title="All 2 branches missed.">				if (shiftPattern.getDeletedOnDate() != null ) {		</span>
					//Work pattern was deleted before the view end date or sp end date if in campaign mode
<span class="nc" id="L254">					rowData.add(shiftPattern.getName() + &quot; (&quot; + getLocalizer().i18n(</span>
							FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_TRAINING_STATUS_DELETED) + &quot;)&quot; );
				} else {
<span class="nc" id="L257">					rowData.add(shiftPattern.getName());</span>
				}
				
				//Consistency Tolerance
<span class="nc" id="L261">				rowData.add(m_localizer.formatDurationInMins(shiftPattern.getConsistentStartsTolerance()));</span>
				
				//Employee Type
<span class="nc" id="L264">				EmployeeType et = data_employeeTypeMap.get(shiftPattern.getEmployeeTypeID());</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">				rowData.add(et == null ? &quot;&quot; : et.getDescription());</span>
				
				//Organization
<span class="nc" id="L268">				ID orgID = shiftPattern.getOrganizationID();</span>
<span class="nc" id="L269">				Organization org = null;</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">				if (orgID != null) {</span>
<span class="nc" id="L271">					org = data_orgMap.get(shiftPattern.getOrganizationID());</span>
<span class="nc" id="L272">					rowData.add(org.getName());</span>
				} else {
<span class="nc" id="L274">					rowData.add(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.LOCAL));</span>
				}
				
				//Description
<span class="nc" id="L278">				rowData.add(shiftPattern.getDescription());</span>
				
<span class="nc" id="L280">				rows.add(rowData);</span>
<span class="nc" id="L281">			}</span>
		}
		
		// You would think this isn't necessary, but it is. The MultiColListPC sets some internal state when
		// this method is called.
<span class="fc" id="L286">		pc_list.getDynamicMultiColList().setListModel(rows);</span>
<span class="fc" id="L287">	}</span>
	
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L290">		return pc_list.extractParameters(request);</span>
	}

	@Override
	public String getJavaScriptInitCode() {
<span class="fc" id="L295">		return pc_list.getJavaScriptInitCode();</span>
	}
	
	@Override
	public String getHtmlDisplay() {
<span class="fc" id="L300">		return pc_list.getHtmlDisplay();</span>
	}
	
	public List&lt;ID&gt; getExtractedWorkPatternIDs() {
<span class="fc" id="L304">		return pc_list.getDynamicMultiColList().getExtractedRowIDs();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>