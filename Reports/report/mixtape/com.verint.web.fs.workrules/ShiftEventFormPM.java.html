<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftEventFormPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">ShiftEventFormPM.java</span></div><h1>ShiftEventFormPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeOfDay;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignOrg;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectIDListComparator;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftEvent;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler.ActivitySelectionProperty;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.core.pagecomponent.CheckBoxPC;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.shift.ShiftUtil;
import com.verint.web.fs.widgets.ActivitySelectorDDPC;
import com.verint.web.fs.widgets.IntegerDropDownSelection;
import com.verint.web.fs.widgets.RadioSelectionGroupPC;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.container.CollapsibleListContainerPC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.list.InsertableMultiColListPC;
import com.witness.web.uif.pagecomponent.picker.time.DurationSpinnerPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.WorkpaneMultiColPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.TimeZoneOverrideUtil;

/**
 * Title: WorkRulesShiftEventsFormPM.java Description: Form Page Model for Shift
 * Events tab in Work Rules Copyright: Copyright (c) 2009 Company: Verint
 * Systems, Inc
 * 
 * @author Dustin Stanley
 * @author Rick Funderburg
 * @since 11
 */
public class ShiftEventFormPM extends WorkRulesFormPM {
	private static final long serialVersionUID = 1L;

	private final ResourceBundle m_bundle;
	private static final String FN_SHIFT_EVENT_NAME = &quot;shiftEventName&quot;;
	private static final String FN_SHIFT_EVENT_DESC = &quot;shiftEventDescription&quot;;
	private static final String JSVARNAME_ACTIVITY_ID = &quot;activityID&quot;;
	private static final String JSVARNAME_DURATION = &quot;duration&quot;;
	private static final String JSVARNAME_IS_PAID = &quot;isPaid&quot;;
	private static final String JSVARNAME_IS_FLEXIBLE = &quot;isFlexible&quot;;
	private static final String JSVARNAME_START_TIME_TYPE = &quot;startTimeType&quot;;
	private static final String JSVARNAME_EARLIEST_START = &quot;earliestStart&quot;;
	private static final String JSVARNAME_LATEST_START = &quot;latestStart&quot;;
	private static final String JSVARNAME_MINIMUM_COUNT = &quot;minCount&quot;;
	private static final String JSVARNAME_MAXIMUM_COUNT = &quot;maxCount&quot;;

	// pc_ prefix is for page components
	private FormTwoColumnPC pc_form;
	private FormInputPC pc_name;
	private FormInputPC pc_description;

	private ActivitySelectorDDPC pc_activity;
	private DurationSpinnerPC pc_duration;
	private DurationSpinnerPC pc_earliestStart;
	private DurationSpinnerPC pc_latestStart;
	private IntegerDropDownSelection pc_minimumCount;
	private IntegerDropDownSelection pc_maximumCount;
	private CheckBoxPC pc_isFlexible;
	private CheckBoxPC pc_isPaid;
	private RadioSelectionGroupPC&lt;StartType&gt; pc_startWindowType;
	private CompactActivityListPC pc_additionalActivities;

	// Data
<span class="fc" id="L94">	private List&lt;ShiftEvent&gt; shiftEvents = new ArrayList&lt;ShiftEvent&gt;();</span>
<span class="fc" id="L95">	protected Map&lt;ID, Activity&gt; activityMap = new HashMap&lt;ID, Activity&gt;();</span>
<span class="fc" id="L96">	private String m_optimizationTargetName = &quot;&quot;;</span>
<span class="fc" id="L97">	private int tzOffset = 0;</span>
	private int dayBoundary;

	public ShiftEventFormPM(RequestContext context) {
<span class="fc" id="L101">		super(context);</span>
<span class="fc" id="L102">		setRenderJavaScriptIfDisabled(true);</span>
<span class="fc" id="L103">		setName(&quot;WorkRulesShiftEventsFormPM&quot;);</span>
<span class="fc" id="L104">		m_bundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

<span class="fc" id="L106">		addPopupArgs(ActivityPopupPM.POPUP_ID, ActivityPopupPM.FORM_ACTION, &quot;&quot;, ActivityPopupPM.POPUP_ARGS,</span>
				&quot;1000,600,ctr,ctr&quot;, true, 1);
<span class="fc" id="L108">	}</span>

	public static ShiftEventFormPM getInstance(RequestContext context) {
<span class="fc" id="L111">		return (ShiftEventFormPM) getInstance(context, ShiftEventFormPM.class);</span>
	}

	@Override
	protected void initContentTitle() {
<span class="fc" id="L116">		super.initContentTitle();</span>
<span class="fc" id="L117">		m_contentTitlePC.setPageTitle(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SHIFT_EVENTS));</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">		if (isMultiEdit()) {</span>
<span class="nc" id="L119">			m_contentTitlePC.setItemName(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.N_SHIFT_EVENTS,</span>
<span class="nc" id="L120">					new Integer(shiftEvents.size())));</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">		} else if (!shiftEvents.isEmpty()) {</span>
<span class="nc" id="L122">			m_contentTitlePC.setItemName(shiftEvents.iterator().next().getName());</span>
		}
<span class="fc" id="L124">	}</span>

	@Override
	protected void loadData() throws Exception {
<span class="fc" id="L128">		super.loadData();</span>

		// Get timezone offset
<span class="pc bpc" id="L131" title="2 of 4 branches missed.">		if (isByOrg &amp;&amp; selectedOrg != null) {</span>
<span class="fc" id="L132">			tzOffset = TimeZoneOverrideUtil.getTimeZoneOffset(m_context, selectedOrg.getTimeZone(), new Date());</span>
<span class="fc" id="L133">			dayBoundary = selectedOrg.getDayBoundaryOffset();</span>
<span class="nc bnc" id="L134" title="All 4 branches missed.">		} else if (!isByOrg &amp;&amp; selectedCampaign != null) {</span>
<span class="nc" id="L135">			tzOffset = TimeZoneOverrideUtil.getTimeZoneOffset(m_context, selectedCampaign.getTimeZone(), new Date());</span>
<span class="nc" id="L136">			dayBoundary = selectedCampaign.getDayBoundaryOffset();</span>
		}

<span class="pc bpc" id="L139" title="1 of 2 branches missed.">		if (getPerformActionOnIDSize() &gt; 0) {</span>
<span class="nc" id="L140">			List&lt;ID&gt; paoIDs = Arrays.asList(getPerformActionOnIDs());</span>
<span class="nc" id="L141">			shiftEvents = new ArrayList&lt;ShiftEvent&gt;(WorkRulesModelHandler.getShiftEvents(m_context, paoIDs));</span>
<span class="nc" id="L142">			Collections.sort(shiftEvents, new ValueObjectIDListComparator(paoIDs));</span>

			// For single edit, get optimization target name (either org name or
			// &quot;Local&quot;)
<span class="nc bnc" id="L146" title="All 2 branches missed.">			if (shiftEvents.size() == 1) {</span>
<span class="nc" id="L147">				ShiftEvent se = shiftEvents.iterator().next();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">				if (se.getCampaignID() != null) {</span>
<span class="nc" id="L149">					m_optimizationTargetName = m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.LOCAL);</span>
				}
<span class="nc bnc" id="L151" title="All 2 branches missed.">				if (se.getOrganizationID() != null) {</span>
<span class="nc" id="L152">					Organization o = OrganizationModelHandler.getOrganization(m_context, se.getOrganizationID());</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">					if (o != null) {</span>
<span class="nc" id="L154">						m_optimizationTargetName = o.getName();</span>
					}
				}
			}
<span class="nc" id="L158">			Collection&lt;ID&gt; activityIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">			for (ShiftEvent se : shiftEvents) {</span>
<span class="nc" id="L160">				ID id = se.getActivityID();</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">				if (id != null) {</span>
<span class="nc" id="L162">					activityIDs.add(id);</span>
				}
<span class="nc" id="L164">			}</span>
<span class="nc" id="L165">			Collection&lt;Activity&gt; activities = ActivityModelHandler.getActivitiesByIDs(m_context, activityIDs);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">			for (Activity a : activities) {</span>
<span class="nc" id="L167">				activityMap.put(a.getID(), a);</span>
<span class="nc" id="L168">			}</span>
		}

		// If editing a new Shift Event, or multi-editing
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">		if (StringUtil.isEmpty(m_optimizationTargetName)) {</span>
<span class="pc bpc" id="L173" title="2 of 4 branches missed.">			if (isByOrg &amp;&amp; selectedOrg != null) {</span>
<span class="fc" id="L174">				m_optimizationTargetName = selectedOrg.getName();</span>
<span class="nc bnc" id="L175" title="All 4 branches missed.">			} else if (!isByOrg &amp;&amp; selectedCampaign != null) {</span>
<span class="nc" id="L176">				m_optimizationTargetName = selectedCampaign.getName();</span>
			}
		}
<span class="fc" id="L179">	}</span>

	@Override
	protected void initForm() {
<span class="fc" id="L183">		pc_form = new FormTwoColumnPC(m_context);</span>
<span class="fc" id="L184">		pc_form.setIsBorderEnabled(true);</span>
<span class="fc" id="L185">		setForm(pc_form);</span>

		try {
<span class="fc" id="L188">			ShiftEvent se = new ShiftEvent();</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">			if (shiftEvents.size() &gt; 0) {</span>
<span class="nc" id="L190">				se = shiftEvents.iterator().next();</span>
			}

			// Org or Campaign
			// Net to build a list of organizations to use for scoped
			// retrieval of valid activities.
<span class="fc" id="L196">			Collection&lt;ID&gt; orgs = new ArrayList&lt;ID&gt;();</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">			if (isByOrg) {</span>
<span class="fc" id="L198">				String orgName = &quot;&quot;;</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">				if (selectedOrg != null) {</span>
<span class="fc" id="L200">					orgName = selectedOrg.getName();</span>
<span class="fc" id="L201">					orgs.add(selectedOrg.getID());</span>
				}
<span class="fc" id="L203">				pc_form.addRow(i(FsWebBundleKey.FS_ORGANIZATION), orgName);</span>
<span class="fc" id="L204">			} else {</span>
<span class="nc" id="L205">				String campaignName = &quot;&quot;;</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">				if (selectedCampaign != null) {</span>
<span class="nc" id="L207">					campaignName = selectedCampaign.getName();</span>

<span class="nc" id="L209">					Collection&lt;CampaignOrg&gt; orgAssigned = CampaignModelHandler.getCampaignOrgAssignments(m_context,</span>
<span class="nc" id="L210">							selectedCampaign.getID(), selectedSchedulingPeriod.getStartTime(),</span>
<span class="nc" id="L211">							selectedSchedulingPeriod.getEndTime());</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">					for (CampaignOrg co : orgAssigned) {</span>
<span class="nc" id="L213">						orgs.add(co.getOrganizationID());</span>
<span class="nc" id="L214">					}</span>
				}
<span class="nc" id="L216">				pc_form.addRow(i(FsWebBundleKey.FS_CAMPAIGN), campaignName);</span>
			}

<span class="pc bpc" id="L219" title="1 of 2 branches missed.">			if (isMultiEdit() == false) {</span>
				// Name
<span class="fc" id="L221">				pc_name = new FormInputPC(m_context);</span>
<span class="fc" id="L222">				pc_name.reset(FN_SHIFT_EVENT_NAME, se.getName(), FormInputPC.TYPE_STRING, true);</span>
<span class="fc" id="L223">				pc_name.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L224">				pc_name.setMaxLength(50);</span>
<span class="fc" id="L225">				pc_name.setInputFieldDesc(UIFWebBundleKey.NAME, UIFWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L226">				pc_name.setIsRequired(true);</span>
<span class="fc" id="L227">				pc_name.setInputValue(se.getName());</span>
<span class="fc" id="L228">				this.addChildComponent(pc_name);</span>
<span class="fc" id="L229">				pc_form.addRow(i18n(m_common_bundle, UIFWebBundleKey.NAME), pc_name);</span>

				// Description
<span class="fc" id="L232">				pc_description = new FormInputPC(m_context);</span>
<span class="fc" id="L233">				pc_description.reset(FN_SHIFT_EVENT_DESC, se.getName(), FormInputPC.TYPE_STRING, false);</span>
<span class="fc" id="L234">				pc_description.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L235">				pc_description.setMaxLength(250);</span>
<span class="fc" id="L236">				pc_description.setInputFieldDesc(UIFWebBundleKey.DESCRIPTION, UIFWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L237">				pc_description.setInputValue(se.getDescription());</span>
<span class="fc" id="L238">				this.addChildComponent(pc_description);</span>
<span class="fc" id="L239">				pc_form.addRow(i18n(m_common_bundle, UIFWebBundleKey.DESCRIPTION), pc_description);</span>
			}

			// Activity
<span class="fc" id="L243">			Collection&lt;Activity&gt; activities = ActivityModelHandler.getActivitiesByActivitySelectionType(getRequestContext(),</span>
					ActivityModelHandler.ActivitySelectionProperty.UsedInShiftEvent, orgs);
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">			if (activityMap.size() &gt; 0) {</span>
<span class="nc" id="L246">				pc_activity = new ActivitySelectorDDPC(m_context, JSVARNAME_ACTIVITY_ID, activities, activityMap.keySet()</span>
<span class="nc" id="L247">						.iterator().next().toString());</span>
			} else {
<span class="fc" id="L249">				pc_activity = new ActivitySelectorDDPC(m_context, JSVARNAME_ACTIVITY_ID, activities);</span>
			}
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">			pc_activity.setMultiEdit(activityMap.size() &gt; 1);</span>
<span class="fc" id="L252">			this.addChildComponent(pc_activity);</span>
<span class="fc" id="L253">			pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_ACTIVITY), pc_activity);</span>

			// Length
<span class="fc" id="L256">			HashSet&lt;Duration&gt; durations = new HashSet&lt;Duration&gt;();</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">			for (ShiftEvent dse : shiftEvents) {</span>
<span class="nc" id="L258">				durations.add(dse.getDuration());</span>
<span class="nc" id="L259">			}</span>
<span class="fc" id="L260">			pc_duration = new DurationSpinnerPC(m_context, JSVARNAME_DURATION);</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">			if (isNew()) {</span>
				// Default the duration to 15 minutes if new like F&amp;S client.
<span class="fc" id="L263">				pc_duration.setValue(Duration.fromMinutes(15));</span>
			} else {
<span class="nc" id="L265">				pc_duration.setValue(se.getDuration());</span>
			}

			// Cannot create/define shift
			// events less than 5 minutes in
			// duration in the websuite -
			// ESR#4162272
<span class="fc" id="L272">			pc_duration.setMinTime(0, 1, 0);</span>

<span class="fc" id="L274">			initializeDurationSpinner(pc_duration, durations, 1);</span>
<span class="fc" id="L275">			this.addChildComponent(pc_duration);</span>
<span class="fc" id="L276">			pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_EVENT_LENGTH), pc_duration);</span>

			// Paid
<span class="fc" id="L279">			HashSet&lt;Boolean&gt; isPaidVals = new HashSet&lt;Boolean&gt;();</span>
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">			for (ShiftEvent ipse : shiftEvents) {</span>
<span class="nc" id="L281">				isPaidVals.add(ipse.isPaid());</span>
<span class="nc" id="L282">			}</span>
<span class="fc" id="L283">			String onIsPaidJS = eJS(JSVARNAME_IS_FLEXIBLE, true) + &quot;if (&quot; + JSVARNAME_IS_FLEXIBLE + &quot;.isChecked()) { &quot;</span>
<span class="fc" id="L284">					+ eJS(JSVARNAME_MINIMUM_COUNT, true) + eJS(JSVARNAME_MAXIMUM_COUNT, true) + &quot; }&quot;;</span>
<span class="fc" id="L285">			String onIsNotPaidJS = eJS(JSVARNAME_IS_FLEXIBLE, false) + eJS(JSVARNAME_MINIMUM_COUNT, false)</span>
<span class="fc" id="L286">					+ eJS(JSVARNAME_MAXIMUM_COUNT, false);</span>
<span class="fc" id="L287">			pc_isPaid = new CheckBoxPC(m_context, JSVARNAME_IS_PAID, se.isPaid(), onIsPaidJS, onIsNotPaidJS);</span>
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">			pc_isPaid.setMultiEdit(isPaidVals.size() &gt; 1);</span>
<span class="fc" id="L289">			this.addChildComponent(pc_isPaid);</span>
<span class="fc" id="L290">			pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_EVENT_PAID), pc_isPaid);</span>

			// Is Flexible
<span class="fc" id="L293">			HashSet&lt;Boolean&gt; isFlexibleCol = new HashSet&lt;Boolean&gt;();</span>
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">			for (ShiftEvent ifse : shiftEvents) {</span>
<span class="nc" id="L295">				isFlexibleCol.add(ifse.isFlexible());</span>
<span class="nc" id="L296">			}</span>
<span class="fc" id="L297">			String enabledJS = eJS(JSVARNAME_MINIMUM_COUNT, true) + eJS(JSVARNAME_MAXIMUM_COUNT, true)</span>
					+ &quot;additionalActivityContainer.setToggleable(true);&quot;
					+ &quot;if(additionalActivityContainer.getIsCollapsed()) {&quot; + &quot;additionalActivityContainer.defaultToggle();&quot;
					+ &quot;}&quot;;
<span class="fc" id="L301">			String disabledJS = eJS(JSVARNAME_MINIMUM_COUNT, false) + eJS(JSVARNAME_MAXIMUM_COUNT, false)</span>
					+ &quot;if(!additionalActivityContainer.getIsCollapsed()) {&quot; + &quot;additionalActivityContainer.defaultToggle();&quot;
					+ &quot;}&quot; + &quot;additionalActivityContainer.setToggleable(false);&quot;;
<span class="fc" id="L304">			pc_isFlexible = new CheckBoxPC(m_context, JSVARNAME_IS_FLEXIBLE, se.isFlexible(), enabledJS, disabledJS);</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">			pc_isFlexible.setMultiEdit(isFlexibleCol.size() &gt; 1);</span>
<span class="fc" id="L306">			this.addChildComponent(pc_isFlexible);</span>
<span class="fc" id="L307">			pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_FLEXIBLE), pc_isFlexible);</span>

			// Min &amp; Max Counts
<span class="fc" id="L310">			initMinMaxCountPCs(se);</span>

			// Start Type &amp; Times
<span class="fc" id="L313">			initStartWindowPCs(se);</span>

			// Additional Activities
<span class="fc" id="L316">			ToolbarPC additionalActivitiesToolbar = new ToolbarPC(m_context);</span>
<span class="fc" id="L317">			additionalActivitiesToolbar.setName(&quot;additionalActivitiesToolbar&quot;);</span>
<span class="fc" id="L318">			ToolbarTextButton addButton = additionalActivitiesToolbar.createPopupWindowButton(ActivityPopupPM.POPUP_ID,</span>
<span class="fc" id="L319">					m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_ADD), true);</span>
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">			if (isByOrg) {</span>
<span class="fc" id="L321">				addButton.setAttribute(&quot;ownerID&quot;, selectedOrg.getID().toString());</span>
			} else {
<span class="nc" id="L323">				addButton.setAttribute(&quot;ownerID&quot;, selectedSchedulingPeriod.getID().toString());</span>
			}
<span class="fc" id="L325">			addButton.setAttribute(&quot;isByOrg&quot;, String.valueOf(isByOrg));</span>
<span class="fc" id="L326">			addButton.setAttribute(&quot;showAddButton&quot;, String.valueOf(true));</span>
<span class="fc" id="L327">			addButton.setAttribute(&quot;activitySelection&quot;, ActivitySelectionProperty.UsedInShiftEvent.toString());</span>
			// Overwrite the onclick event handling to set the selectedIDs
			// attribute from the table
			// Set the selectedIDs popup parameter. The selectedIDs parameter
			// consists of ids of shift events to leave out of the options to
			// select
<span class="fc" id="L333">			addButton.setAttribute(&quot;onClick&quot;, WorkRulesUtil.getAddButtonIdFilterJavaScript(&quot;activityTable_rowIDs&quot;,</span>
<span class="fc" id="L334">					&quot;filteredActivityIDs&quot;, additionalActivitiesToolbar.getName(), ActivityPopupPM.POPUP_ID));</span>
<span class="fc" id="L335">			additionalActivitiesToolbar.addToolbarElement(addButton);</span>
<span class="fc" id="L336">			ToolbarTextButton removeButton = new ToolbarTextButton(additionalActivitiesToolbar, &quot;removeActivity&quot;,</span>
<span class="fc" id="L337">					m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_REMOVE),</span>
					InsertableMultiColListPC.REMOVE_ROW_BUTTON_ACTION, ToolbarTextButton.BLUE_BUTTON, false);
<span class="fc" id="L339">			additionalActivitiesToolbar.addToolbarElement(removeButton);</span>

<span class="fc" id="L341">			pc_additionalActivities = new CompactActivityListPC(getRequestContext(), &quot;activityTable&quot;,</span>
<span class="fc" id="L342">					getAdditionalActivitesFromSelectedShiftEvents()) {</span>
				@Override
				protected void setRowAttributes(DefaultMultiColumnNodeData mcnd, Activity activity) {
<span class="nc" id="L345">					super.setRowAttributes(mcnd, activity);</span>
<span class="nc" id="L346">					mcnd.setNodeAttribute(WorkpaneMultiColPM.IS_DELETEABLE, String.valueOf(true));</span>
					// This attribute will be used to determine if this row is
					// not common. If it is not
					// common to all shift events, we will not suppress it in
					// the popup choice
<span class="nc bnc" id="L351" title="All 2 branches missed.">					if (!activity.isMultiEditCommon()) {</span>
<span class="nc" id="L352">						mcnd.setNodeAttribute(&quot;multiEditNotCommon&quot;, &quot;true&quot;);</span>
					}
<span class="nc" id="L354">				}</span>
			};
<span class="fc" id="L356">			pc_additionalActivities.setToolbar(additionalActivitiesToolbar);</span>
<span class="fc" id="L357">			pc_additionalActivities.setName(&quot;activityTable&quot;);</span>
<span class="fc" id="L358">			CollapsibleListContainerPC additionalActivityContainer = new CollapsibleListContainerPC(getRequestContext(),</span>
<span class="fc" id="L359">					&quot;additionalActivityContainer&quot;, getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
							FsWebBundleKey.FS_ADDITIONAL_ACTIVITIES_EDIT), pc_additionalActivities);
<span class="fc" id="L361">			addChildComponent(additionalActivityContainer);</span>
<span class="fc" id="L362">			addForm(additionalActivityContainer);</span>

			// Set page component state from submitted values
<span class="pc bpc" id="L365" title="2 of 4 branches missed.">			if (null != getPageAction() &amp;&amp; !PageAction.EDIT.equals(getPageAction())) {</span>
<span class="fc" id="L366">				this.extractParameters(m_context.getRequest());</span>
			}

			// Custom enable logic. must come after extract params in order to
			// accurately reflect the state after a postback
<span class="fc" id="L371">			pc_isFlexible.setEnabled(pc_isPaid.isChecked());</span>
<span class="fc bfc" id="L372" title="All 4 branches covered.">			pc_minimumCount.setEnabled(pc_isFlexible.isEnabled() &amp;&amp; pc_isFlexible.isChecked());</span>
<span class="fc bfc" id="L373" title="All 4 branches covered.">			pc_maximumCount.setEnabled(pc_isFlexible.isEnabled() &amp;&amp; pc_isFlexible.isChecked());</span>
<span class="fc bfc" id="L374" title="All 2 branches covered.">			pc_earliestStart.setEnabled(!StartType.AnyTime.equals(pc_startWindowType.getSelected()));</span>
<span class="fc bfc" id="L375" title="All 2 branches covered.">			pc_latestStart.setEnabled(!StartType.AnyTime.equals(pc_startWindowType.getSelected()));</span>
<span class="fc bfc" id="L376" title="All 4 branches covered.">			if (pc_isFlexible.isEnabled() == false || pc_isFlexible.isChecked() == false) {</span>
<span class="fc" id="L377">				additionalActivityContainer.setCollapsed(true);</span>
<span class="fc" id="L378">				additionalActivityContainer.setIsToggleEnabled(false);</span>
<span class="fc" id="L379">				this.setRenderJavaScriptIfDisabled(true);</span>
			}

<span class="nc" id="L382">		} catch (Exception ex) {</span>
<span class="nc" id="L383">			handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L384">		}</span>
<span class="fc" id="L385">	}</span>

	/**
	 * 
	 */
	private Collection&lt;Activity&gt; getAdditionalActivitesFromSelectedShiftEvents() {
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">		if (shiftEvents.size() == 0) {</span>
<span class="fc" id="L392">			return new ArrayList&lt;Activity&gt;();</span>
		}

<span class="nc" id="L395">		HashMap&lt;ID, Activity&gt; activityMap = new HashMap&lt;ID, Activity&gt;();</span>

		// initialize the map
<span class="nc" id="L398">		ShiftEvent tempShiftEvent = shiftEvents.get(0);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">		for (Activity activity : new ArrayList&lt;Activity&gt;(tempShiftEvent.getAdditionalActivities())) {</span>
<span class="nc" id="L400">			activity.setMultiEditCommon(true);</span>
<span class="nc" id="L401">			activityMap.put(activity.getID(), activity);</span>
<span class="nc" id="L402">		}</span>

<span class="nc bnc" id="L404" title="All 2 branches missed.">		for (ShiftEvent se : shiftEvents) {</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">			for (Activity activity : activityMap.values()) {</span>
				// if an activity in the map does not belong to the shift event
				// in this iteration,
				// we want to set multi edit common to false as it is no longer
				// common between
				// all shift events in the set
<span class="nc bnc" id="L411" title="All 4 branches missed.">				if (activity.isMultiEditCommon() &amp;&amp; se.getAdditionalActivities().contains(activity) == false) {</span>
<span class="nc" id="L412">					activity.setMultiEditCommon(false);</span>
				}
<span class="nc" id="L414">			}</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">			for (Activity activity : se.getAdditionalActivities()) {</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">				if (activityMap.containsKey(activity.getID()) == false) {</span>
<span class="nc" id="L417">					activity.setMultiEditCommon(false);</span>
<span class="nc" id="L418">					activityMap.put(activity.getID(), activity);</span>
				}
<span class="nc" id="L420">			}</span>
<span class="nc" id="L421">		}</span>
<span class="nc" id="L422">		return new ArrayList&lt;Activity&gt;(activityMap.values());</span>
	}

	private void initMinMaxCountPCs(ShiftEvent se) {
		// Minimum Counts
<span class="fc" id="L427">		HashSet&lt;Integer&gt; minCounts = new HashSet&lt;Integer&gt;();</span>
<span class="fc" id="L428">		Integer highestMinCount = null;</span>
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">		for (ShiftEvent mcse : shiftEvents) {</span>
<span class="nc" id="L430">			Integer minCount = mcse.getMinCount();</span>
<span class="nc" id="L431">			minCounts.add(minCount);</span>
<span class="nc bnc" id="L432" title="All 4 branches missed.">			if (highestMinCount == null || minCount &gt; highestMinCount) {</span>
<span class="nc" id="L433">				highestMinCount = minCount;</span>
			}
<span class="nc" id="L435">		}</span>

<span class="fc" id="L437">		HashSet&lt;Integer&gt; maxCounts = new HashSet&lt;Integer&gt;();</span>
<span class="fc" id="L438">		Integer lowestMaxCount = null;</span>
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">		for (ShiftEvent mcse : shiftEvents) {</span>
<span class="nc" id="L440">			int maxCount = mcse.getMaxCount();</span>
<span class="nc" id="L441">			maxCounts.add(maxCount);</span>
<span class="nc bnc" id="L442" title="All 4 branches missed.">			if (lowestMaxCount == null || maxCount &lt; lowestMaxCount) {</span>
<span class="nc" id="L443">				lowestMaxCount = maxCount;</span>
			}
<span class="nc" id="L445">		}</span>

<span class="fc" id="L447">		pc_minimumCount = new IntegerDropDownSelection(m_context, JSVARNAME_MINIMUM_COUNT, 0, 99,</span>
<span class="fc" id="L448">				new int[] { se.getMinCount() });</span>
<span class="pc bpc" id="L449" title="1 of 2 branches missed.">		String minCountChangeJS = &quot;\n var minCountSelections = &quot;</span>
				+ JSVARNAME_MINIMUM_COUNT
				+ &quot;.getSelections();&quot;
				+ &quot;\n var maxCountSelections = &quot;
				+ JSVARNAME_MAXIMUM_COUNT
				+ &quot;.getSelections();&quot;
				+ &quot;\n if (minCountSelections.length &gt; 0) {&quot;
				+ &quot;\n if (maxCountSelections.length &gt; 0 &amp;&amp; parseInt(minCountSelections[0]) &gt; parseInt(maxCountSelections[0])) { &quot;
				+ &quot;\n &quot;
				+ JSVARNAME_MAXIMUM_COUNT
				+ &quot;.setSelections([minCountSelections[0]]);&quot;
				+ &quot;\n }&quot;
				+ (lowestMaxCount == null ? &quot;&quot; : &quot;if (parseInt(minCountSelections[0]) &gt; &quot; + lowestMaxCount + &quot;) { &quot;
						+ JSVARNAME_MAXIMUM_COUNT + &quot;.setEdited(true); }&quot;) + &quot;\n }&quot;;
<span class="fc" id="L463">		pc_minimumCount.setOnChangeJS(minCountChangeJS);</span>
<span class="pc bpc" id="L464" title="1 of 2 branches missed.">		pc_minimumCount.setMultiEdit(minCounts.size() &gt; 1);</span>
<span class="fc" id="L465">		this.addChildComponent(pc_minimumCount);</span>
<span class="fc" id="L466">		pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_MINIMUM_COUNT), pc_minimumCount);</span>

		// Maximum Counts
<span class="fc" id="L469">		pc_maximumCount = new IntegerDropDownSelection(m_context, JSVARNAME_MAXIMUM_COUNT, 1, 99,</span>
<span class="fc" id="L470">				new int[] { se.getMaxCount() });</span>
<span class="pc bpc" id="L471" title="1 of 2 branches missed.">		String maxCountChangeJS = &quot;\n var minCountSelections = &quot;</span>
				+ JSVARNAME_MINIMUM_COUNT
				+ &quot;.getSelections();&quot;
				+ &quot;\n var maxCountSelections = &quot;
				+ JSVARNAME_MAXIMUM_COUNT
				+ &quot;.getSelections();&quot;
				+ &quot;\n if (maxCountSelections.length &gt; 0) {&quot;
				+ &quot;\n if (minCountSelections.length &gt; 0 &amp;&amp; parseInt(minCountSelections[0]) &gt; parseInt(maxCountSelections[0])) { &quot;
				+ &quot;\n &quot;
				+ JSVARNAME_MINIMUM_COUNT
				+ &quot;.setSelections([maxCountSelections[0]]);&quot;
				+ &quot;\n }&quot;
				+ (highestMinCount == null ? &quot;&quot; : &quot;if (parseInt(maxCountSelections[0]) &lt; &quot; + highestMinCount + &quot;) { &quot;
						+ JSVARNAME_MINIMUM_COUNT + &quot;.setEdited(true); }&quot;) + &quot;\n }&quot;;
<span class="fc" id="L485">		pc_maximumCount.setOnChangeJS(maxCountChangeJS);</span>
<span class="pc bpc" id="L486" title="1 of 2 branches missed.">		pc_maximumCount.setMultiEdit(maxCounts.size() &gt; 1);</span>
<span class="fc" id="L487">		this.addChildComponent(pc_maximumCount);</span>
<span class="fc" id="L488">		pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_MAXIMUM_COUNT), pc_maximumCount);</span>
<span class="fc" id="L489">	}</span>

	private void initStartWindowPCs(ShiftEvent se) {
		/*
		 * The logic behind the start window components is somewhat complex
		 * because the fields' behaviors are dependent on each others' values.
		 * 1) If the start type is &quot;Any Time&quot;, the start and end pickers should
		 * be disabled. 2) If the start time is changed to be after the end
		 * time, the end time should be set to be equal to the start time. 3) if
		 * the end time is change to be before the start time, the start time
		 * should be set to be equal to the end time. 4) If we are in multi-edit
		 * mode and the start time is changed to be after any one of the end
		 * time values, we need to set the end times to the edited state 5) If
		 * we are in multi-edit mode and the end time is change to be before any
		 * one of the start time values, we need to set the start times to the
		 * edited state
		 */

		// Start Window Type
<span class="fc" id="L508">		HashSet&lt;Boolean&gt; startTimeTypes = new HashSet&lt;Boolean&gt;();</span>
<span class="pc bpc" id="L509" title="1 of 2 branches missed.">		for (ShiftEvent sttse : shiftEvents) {</span>
<span class="nc" id="L510">			startTimeTypes.add(sttse.isCafeteria());</span>
<span class="nc" id="L511">		}</span>
<span class="fc" id="L512">		pc_startWindowType = new RadioSelectionGroupPC&lt;StartType&gt;(m_context, JSVARNAME_START_TIME_TYPE);</span>
<span class="fc" id="L513">		String diableTimeWindowSelectorJS = JSVARNAME_EARLIEST_START + &quot;.setEnabled(false); &quot; + JSVARNAME_LATEST_START</span>
				+ &quot;.setEnabled(false);&quot;;
<span class="fc" id="L515">		String enableTimeWindowSelectorJS = JSVARNAME_EARLIEST_START + &quot;.setEnabled(true); &quot; + JSVARNAME_LATEST_START</span>
				+ &quot;.setEnabled(true);&quot;;
<span class="fc" id="L517">		pc_startWindowType.addRadioOption(&quot;anyTime&quot;, i18n(m_bundle, FsWebBundleKey.FS_ANY_TIME), &quot;&quot;, StartType.AnyTime,</span>
<span class="fc" id="L518">				se.isAnyTime(), diableTimeWindowSelectorJS);</span>
<span class="fc" id="L519">		pc_startWindowType.addRadioOption(&quot;absolute&quot;, i18n(m_bundle, FsWebBundleKey.FS_ABSOLUTE), &quot;&quot;, StartType.Absolute,</span>
<span class="pc bpc" id="L520" title="2 of 4 branches missed.">				!se.isAnyTime() &amp;&amp; se.isCafeteria(), enableTimeWindowSelectorJS);</span>
<span class="fc" id="L521">		pc_startWindowType.addRadioOption(&quot;relative&quot;, i18n(m_bundle, FsWebBundleKey.FS_RELATIVE_TO_SHIFT_START), &quot;&quot;,</span>
<span class="pc bpc" id="L522" title="2 of 4 branches missed.">				StartType.Relative, !se.isAnyTime() &amp;&amp; !se.isCafeteria(), enableTimeWindowSelectorJS);</span>
<span class="pc bpc" id="L523" title="1 of 2 branches missed.">		pc_startWindowType.setMultiEdit(startTimeTypes.size() &gt; 1);</span>
<span class="fc" id="L524">		this.addChildComponent(pc_startWindowType);</span>
<span class="fc" id="L525">		pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_START_TIME_TYPE), pc_startWindowType);</span>

		// Start window earliest &amp; latest values
<span class="fc" id="L528">		LinkedHashSet&lt;Duration&gt; earliestStarts = new LinkedHashSet&lt;Duration&gt;();</span>
		// find the lastEarliestStart for req 5 above
<span class="fc" id="L530">		Duration lastEarliestStart = null;</span>
<span class="pc bpc" id="L531" title="1 of 2 branches missed.">		for (ShiftEvent esse : shiftEvents) {</span>
<span class="nc" id="L532">			Duration start = Duration.fromMinutes(esse.getStart());</span>
<span class="nc bnc" id="L533" title="All 4 branches missed.">			if (lastEarliestStart == null || start.isLongerThan(lastEarliestStart)) {</span>
<span class="nc" id="L534">				lastEarliestStart = start;</span>
			}
<span class="nc" id="L536">			earliestStarts.add(start);</span>
<span class="nc" id="L537">		}</span>

<span class="fc" id="L539">		LinkedHashSet&lt;Duration&gt; latestStarts = new LinkedHashSet&lt;Duration&gt;();</span>
		// find the firstLatestStart for req 4 above
<span class="fc" id="L541">		Duration firstLatestStart = null;</span>
<span class="pc bpc" id="L542" title="1 of 2 branches missed.">		for (ShiftEvent lsse : shiftEvents) {</span>
<span class="nc" id="L543">			Duration end = Duration.fromMinutes(lsse.getEnd());</span>
<span class="nc bnc" id="L544" title="All 4 branches missed.">			if (firstLatestStart == null || end.isShorterThan(firstLatestStart)) {</span>
<span class="nc" id="L545">				firstLatestStart = end;</span>
			}
<span class="nc" id="L547">			latestStarts.add(end);</span>
<span class="nc" id="L548">		}</span>

		// Earliest Start PC
<span class="fc" id="L551">		pc_earliestStart = new DurationSpinnerPC(m_context, JSVARNAME_EARLIEST_START);</span>
<span class="fc" id="L552">		int mins = se.getStart();</span>
<span class="pc bpc" id="L553" title="1 of 2 branches missed.">		if (se.isCafeteria()) {</span>
<span class="nc" id="L554">			mins = new TimeOfDay(se.getStart() + dayBoundary).addMinutes(tzOffset).getMinutesSinceMindnight();</span>
		}
<span class="fc" id="L556">		pc_earliestStart.setValue(Duration.fromMinutes(mins));</span>
<span class="fc" id="L557">		initializeDurationSpinner(pc_earliestStart, earliestStarts, 15);</span>
<span class="fc" id="L558">		pc_earliestStart.setAsMinimumValueSpinner(JSVARNAME_LATEST_START, firstLatestStart);</span>

<span class="pc bpc" id="L560" title="3 of 4 branches missed.">		if (firstLatestStart != null &amp;&amp; se.getStart() &gt; firstLatestStart.getDurationInMinutes()</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">				&amp;&amp; firstLatestStart.getDurationInMinutes() != se.getEnd()) {</span>
			// Because the fields are related, force the multi edit
<span class="nc" id="L563">			pc_earliestStart.setMultiEdit(true);</span>
		}

<span class="fc" id="L566">		this.addChildComponent(pc_earliestStart);</span>
<span class="fc" id="L567">		pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_EARLIEST_START), pc_earliestStart);</span>

		// Latest Start PC
<span class="fc" id="L570">		pc_latestStart = new DurationSpinnerPC(m_context, JSVARNAME_LATEST_START);</span>
<span class="fc" id="L571">		mins = se.getEnd();</span>
<span class="pc bpc" id="L572" title="1 of 2 branches missed.">		if (se.isCafeteria()) {</span>
<span class="nc" id="L573">			mins = new TimeOfDay(se.getEnd() + dayBoundary).addMinutes(tzOffset).getMinutesSinceMindnight();</span>
		}
<span class="fc" id="L575">		pc_latestStart.setValue(Duration.fromMinutes(mins));</span>
<span class="fc" id="L576">		initializeDurationSpinner(pc_latestStart, latestStarts, 15);</span>
<span class="fc" id="L577">		pc_latestStart.setAsMaximumValueSpinner(JSVARNAME_EARLIEST_START, lastEarliestStart);</span>

<span class="pc bpc" id="L579" title="3 of 4 branches missed.">		if (lastEarliestStart != null &amp;&amp; se.getEnd() &lt; lastEarliestStart.getDurationInMinutes()</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">				&amp;&amp; lastEarliestStart.getDurationInMinutes() != se.getStart()) {</span>
<span class="nc" id="L581">			pc_latestStart.setMultiEdit(true);</span>
		}
<span class="fc" id="L583">		this.addChildComponent(pc_latestStart);</span>
<span class="fc" id="L584">		pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_LATEST_START), pc_latestStart);</span>
<span class="fc" id="L585">	}</span>

	private void initializeDurationSpinner(DurationSpinnerPC spinner, Collection&lt;?&gt; values, int minutesIncrement) {
<span class="fc" id="L588">		spinner.setMinutesIncrement(minutesIncrement);</span>
<span class="pc bpc" id="L589" title="1 of 2 branches missed.">		spinner.setMultiEdit(values.size() &gt; 1);</span>
<span class="fc" id="L590">	}</span>

	/** Get setEnabled JavaScript */
	private static String eJS(String varName, boolean enabled) {
<span class="fc" id="L594">		return varName + &quot;.setEnabled(&quot; + enabled + &quot;); &quot;;</span>
	}

	/**
	 * Gets shift events represented by this form.
	 * 
	 * @return
	 * @throws BbmException
	 * @throws RemoteException
	 */
	public Collection&lt;ShiftEvent&gt; getShiftEvents() throws RemoteException, BbmException {
<span class="fc" id="L605">		Collection&lt;ShiftEvent&gt; ret = new ArrayList&lt;ShiftEvent&gt;(shiftEvents);</span>
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">		if (ret.isEmpty()) {</span>
<span class="fc" id="L607">			ret.add(new ShiftEvent());</span>
		}

<span class="fc" id="L610">		boolean isMultiEdit = isMultiEdit();</span>

<span class="fc bfc" id="L612" title="All 2 branches covered.">		for (ShiftEvent se : ret) {</span>
			// Construct a shift event from the form field
<span class="pc bpc" id="L614" title="1 of 2 branches missed.">			if (!isMultiEdit) {</span>
<span class="pc bpc" id="L615" title="1 of 2 branches missed.">				se.setName(pc_name.getInputValue() != null ? pc_name.getInputValue().trim() : null);</span>
<span class="fc" id="L616">				se.setDescription(pc_description.getInputValue());</span>
<span class="pc bpc" id="L617" title="1 of 2 branches missed.">				if (isByOrg) {</span>
<span class="fc" id="L618">					se.setOrganizationID(selectedOrg.getID());</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">				} else if (!isByOrg) {</span>
<span class="nc" id="L620">					se.setCampaignID(selectedCampaign.getDEID());</span>
				}
			}
<span class="pc bpc" id="L623" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_activity.isEdited()) {</span>
<span class="fc" id="L624">				se.setActivityID(pc_activity.getSelections().iterator().next().getID());</span>
			}
<span class="pc bpc" id="L626" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_duration.isEdited()) {</span>
<span class="fc" id="L627">				se.setDuration(pc_duration.getDuration());</span>
			}
<span class="pc bpc" id="L629" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_startWindowType.isEdited()) {</span>
<span class="fc" id="L630">				se.setIsCafeteria(StartType.Absolute.equals(pc_startWindowType.getSelected()));</span>
<span class="fc" id="L631">				se.setIsAnyTime(StartType.AnyTime.equals(pc_startWindowType.getSelected()));</span>
			}
<span class="pc bpc" id="L633" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_earliestStart.isEdited()) {</span>
<span class="fc" id="L634">				TimeOfDay tod = new TimeOfDay(pc_earliestStart.getDuration().getDurationInMinutes());</span>
<span class="fc bfc" id="L635" title="All 2 branches covered.">				if (se.isCafeteria()) {</span>
<span class="fc" id="L636">					tod = tod.addMinutes(-tzOffset);</span>
<span class="fc" id="L637">					tod = tod.addMinutes(-adjustMinuteByDayBoundary(tod.getMinutesSinceMindnight(), dayBoundary));</span>
				}
<span class="fc" id="L639">				se.setStart(tod.getMinutesSinceMindnight());</span>
			}
<span class="pc bpc" id="L641" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_latestStart.isEdited()) {</span>
<span class="fc" id="L642">				TimeOfDay tod = new TimeOfDay(pc_latestStart.getDuration().getDurationInMinutes());</span>
<span class="fc bfc" id="L643" title="All 2 branches covered.">				if (se.isCafeteria()) {</span>
<span class="fc" id="L644">					tod = tod.addMinutes(-tzOffset);</span>
<span class="fc" id="L645">					tod = tod.addMinutes(-adjustMinuteByDayBoundary(tod.getMinutesSinceMindnight(), dayBoundary));</span>
				}
<span class="fc" id="L647">				se.setEnd(tod.getMinutesSinceMindnight());</span>
			}
<span class="pc bpc" id="L649" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_isFlexible.isEdited()) {</span>
<span class="fc bfc" id="L650" title="All 4 branches covered.">				se.setIsFlexible(pc_isFlexible.isChecked() &amp;&amp; pc_isPaid.isChecked());</span>
			}
<span class="pc bpc" id="L652" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_isPaid.isEdited()) {</span>
<span class="fc" id="L653">				se.setIsPaid(pc_isPaid.isChecked());</span>
			}
<span class="fc" id="L655">			int maxCount = 1, minCount = 1;</span>
<span class="pc bpc" id="L656" title="1 of 2 branches missed.">			if (pc_maximumCount.getSelections().size() &gt; 0) {</span>
<span class="fc" id="L657">				maxCount = pc_maximumCount.getSelections().iterator().next();</span>
<span class="fc bfc" id="L658" title="All 4 branches covered.">				if (!pc_isFlexible.isChecked() || !pc_isPaid.isChecked()) {</span>
<span class="fc" id="L659">					maxCount = 1;</span>
				}
			}
<span class="pc bpc" id="L662" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_maximumCount.isEdited()) {</span>
<span class="fc" id="L663">				se.setMaxCount(maxCount);</span>
			}
<span class="pc bpc" id="L665" title="1 of 2 branches missed.">			if (pc_minimumCount.getSelections().size() &gt; 0) {</span>
<span class="fc" id="L666">				minCount = pc_minimumCount.getSelections().iterator().next();</span>
<span class="fc bfc" id="L667" title="All 4 branches covered.">				if (!pc_isFlexible.isChecked() || !pc_isPaid.isChecked()) {</span>
<span class="fc" id="L668">					minCount = 0;</span>
				}
			}
<span class="pc bpc" id="L671" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_minimumCount.isEdited()) {</span>
<span class="fc" id="L672">				se.setMinCount(minCount);</span>
			}

<span class="pc bpc" id="L675" title="1 of 2 branches missed.">			if (pc_additionalActivities.getRemovedRowIDs().length() &gt; 0) {</span>
<span class="nc" id="L676">				removeAdditionalActivitiesFromShiftEvent(se,</span>
<span class="nc" id="L677">						StringUtil.parseIDStringToCollection(pc_additionalActivities.getRemovedRowIDs()));</span>
			}
<span class="pc bpc" id="L679" title="1 of 2 branches missed.">			if (pc_additionalActivities.getAddedRowIDs().length() &gt; 0) {</span>
<span class="nc" id="L680">				Collection&lt;Activity&gt; addedActivities = new ArrayList&lt;Activity&gt;();</span>
<span class="nc" id="L681">				addedActivities = ActivityModelHandler.getActivitiesByIDs(getRequestContext(),</span>
<span class="nc" id="L682">						StringUtil.parseIDStringToCollection(pc_additionalActivities.getAddedRowIDs()));</span>
<span class="nc" id="L683">				addAdditionalActivitiesToShiftEvent(se, addedActivities);</span>
			}
			// If the shift event has an additional activity that is also set as
			// the primary activity,
			// we remove it from the list of additional activities.
<span class="fc" id="L688">		}</span>
<span class="fc" id="L689">		return ret;</span>
	}

	private void removeAdditionalActivitiesFromShiftEvent(ShiftEvent se, Collection&lt;ID&gt; activityIDsToRemove) {
<span class="nc" id="L693">		ArrayList&lt;Activity&gt; activitiesToRemove = new ArrayList&lt;Activity&gt;();</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">		for (Activity activity : se.getAdditionalActivities()) {</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">			for (ID idToRemove : activityIDsToRemove) {</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">				if (activity.getID().equals(idToRemove)) {</span>
<span class="nc" id="L697">					activitiesToRemove.add(activity);</span>
<span class="nc" id="L698">					break;</span>
				}
<span class="nc" id="L700">			}</span>
<span class="nc" id="L701">		}</span>
<span class="nc" id="L702">		se.removeAdditionalActivities(activitiesToRemove);</span>
<span class="nc" id="L703">	}</span>

	// It's possible that the activities that are being added might already be
	// associated to a shift event.
	// Only add the activities that are not already associated
	private void addAdditionalActivitiesToShiftEvent(ShiftEvent se, Collection&lt;Activity&gt; activities) {
		// WFM:Creating shift events with add activities - ESR#4225100 - Dup
		// activities
<span class="nc" id="L711">		activities.removeAll(se.getAdditionalActivities());</span>
<span class="nc" id="L712">		se.addAdditionalActivities(activities);</span>
<span class="nc" id="L713">	}</span>

	/**
	 * Intended to be used to adjust the spinner minutes value for start times
	 * to the value that will eventually be stored in the database. Values in
	 * the database are stored with the org/campaign's day boundary offset (if
	 * it is an absolute shift event).
	 */
	private int adjustMinuteByDayBoundary(int min, int dayBoundary) {
<span class="pc bpc" id="L722" title="1 of 2 branches missed.">		if (min &lt; dayBoundary) {</span>
<span class="nc" id="L723">			return -(1440 - dayBoundary);</span>
		}
<span class="fc" id="L725">		return dayBoundary;</span>
	}

	@Override
	public boolean validate() {
<span class="fc" id="L730">		boolean retVal = super.validate();</span>
		try {
			// getShiftEvents() will rebuild all selected shift events based on
			// the set values from the page components.
			// We then iterate through these shift events to determine their
			// validity.
<span class="fc" id="L736">			Collection&lt;ShiftEvent&gt; shiftEvents = getShiftEvents();</span>

<span class="pc bpc" id="L738" title="1 of 2 branches missed.">			if (isMultiEdit() == false) {</span>
<span class="fc" id="L739">				String name = pc_name.getInputValue();</span>

<span class="fc" id="L741">				Collection&lt;ShiftEvent&gt; shiftEventsExisting = new ArrayList&lt;ShiftEvent&gt;();</span>
<span class="pc bpc" id="L742" title="1 of 2 branches missed.">				if (isByOrg) { // By Organization.</span>
<span class="fc" id="L743">					shiftEventsExisting = WorkRulesModelHandler.getShiftEventsByOrgHierarchy(m_context, selectedOrg.getID());</span>
				} else { // By scheduling period.
<span class="nc" id="L745">					shiftEventsExisting = WorkRulesModelHandler.getShiftEventsBySchedulingPeriod(m_context,</span>
<span class="nc" id="L746">							selectedSchedulingPeriod.getID());</span>
				}

<span class="fc bfc" id="L749" title="All 2 branches covered.">				for (ShiftEvent formShiftEvent : shiftEvents) {</span>
<span class="fc bfc" id="L750" title="All 2 branches covered.">					for (ShiftEvent existingShiftEvent : shiftEventsExisting) {</span>
<span class="pc bpc" id="L751" title="1 of 2 branches missed.">						if (existingShiftEvent.getID().equals(formShiftEvent.getID())) {</span>
<span class="nc" id="L752">							continue;</span>
						}
<span class="pc bpc" id="L754" title="1 of 2 branches missed.">						if (formShiftEvent.getName().equals(existingShiftEvent.getName())) {</span>
<span class="nc" id="L755">							addPageMessage(Message.ERROR_TYPE,</span>
<span class="nc" id="L756">									m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_NAME_MUST_BE_UNIQUE));</span>
<span class="nc" id="L757">							retVal = false;</span>
						}
<span class="fc" id="L759">					}</span>
<span class="fc" id="L760">				}</span>
			}

<span class="fc" id="L763">			ArrayList&lt;Message&gt; results = ShiftUtil.validateShiftEventDefinitions(m_localizer, shiftEvents);</span>
<span class="pc bpc" id="L764" title="1 of 2 branches missed.">			for (Message m : results) {</span>
<span class="nc" id="L765">				addPageMessage(m);</span>
<span class="nc" id="L766">			}</span>
<span class="pc bpc" id="L767" title="1 of 2 branches missed.">			if (results.size() &gt; 0) {</span>
<span class="nc" id="L768">				retVal = false;</span>
			}

<span class="fc" id="L771">			List&lt;Message&gt; validationMessages = ShiftUtil.validateShiftEvents(m_localizer, shiftEvents);</span>
<span class="pc bpc" id="L772" title="1 of 2 branches missed.">			for (Message m : validationMessages) {</span>
<span class="nc" id="L773">				addPageMessage(m);</span>
<span class="nc" id="L774">			}</span>
<span class="pc bpc" id="L775" title="1 of 2 branches missed.">			if (validationMessages.size() &gt; 0) {</span>
<span class="nc" id="L776">				retVal = false;</span>
			}

<span class="fc" id="L779">			return retVal;</span>
<span class="nc" id="L780">		} catch (Exception ex) {</span>
<span class="nc" id="L781">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L782">			return false;</span>
		}
	}

	private String i(String key) {
<span class="fc" id="L787">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, key);</span>
	}

<span class="pc" id="L790">	private enum StartType {</span>
<span class="fc" id="L791">		AnyTime, Relative, Absolute</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>