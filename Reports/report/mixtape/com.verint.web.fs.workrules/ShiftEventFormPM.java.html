<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftEventFormPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">ShiftEventFormPM.java</span></div><h1>ShiftEventFormPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeOfDay;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignOrg;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectIDListComparator;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftEvent;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler.ActivitySelectionProperty;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.core.pagecomponent.CheckBoxPC;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.shift.ShiftUtil;
import com.verint.web.fs.widgets.ActivitySelectorDDPC;
import com.verint.web.fs.widgets.IntegerDropDownSelection;
import com.verint.web.fs.widgets.RadioSelectionGroupPC;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.container.CollapsibleListContainerPC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.list.InsertableMultiColListPC;
import com.witness.web.uif.pagecomponent.picker.time.DurationSpinnerPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.WorkpaneMultiColPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.TimeZoneOverrideUtil;

import java.rmi.RemoteException;
import java.util.*;

/**
 * Title: WorkRulesShiftEventsFormPM.java Description: Form Page Model for Shift
 * Events tab in Work Rules Copyright: Copyright (c) 2009 Company: Verint
 * Systems, Inc
 *
 * @author Dustin Stanley
 * @author Rick Funderburg
 * @since 11
 */
public class ShiftEventFormPM extends WorkRulesFormPM {
	private static final long serialVersionUID = 1L;

	private final ResourceBundle m_bundle;
	private static final String FN_SHIFT_EVENT_NAME = &quot;shiftEventName&quot;;
	private static final String FN_SHIFT_EVENT_DESC = &quot;shiftEventDescription&quot;;
	private static final String JSVARNAME_ACTIVITY_ID = &quot;activityID&quot;;
	private static final String JSVARNAME_DURATION = &quot;duration&quot;;
	private static final String JSVARNAME_IS_PAID = &quot;isPaid&quot;;
	private static final String JSVARNAME_IS_FLEXIBLE = &quot;isFlexible&quot;;
	private static final String JSVARNAME_START_TIME_TYPE = &quot;startTimeType&quot;;
	private static final String JSVARNAME_EARLIEST_START = &quot;earliestStart&quot;;
	private static final String JSVARNAME_LATEST_START = &quot;latestStart&quot;;
	private static final String JSVARNAME_MINIMUM_COUNT = &quot;minCount&quot;;
	private static final String JSVARNAME_MAXIMUM_COUNT = &quot;maxCount&quot;;

	// pc_ prefix is for page components
	private FormTwoColumnPC pc_form;
	private FormInputPC pc_name;
	private FormInputPC pc_description;

	private ActivitySelectorDDPC pc_activity;
	private DurationSpinnerPC pc_duration;
	private DurationSpinnerPC pc_earliestStart;
	private DurationSpinnerPC pc_latestStart;
	private IntegerDropDownSelection pc_minimumCount;
	private IntegerDropDownSelection pc_maximumCount;
	private CheckBoxPC pc_isFlexible;
	private CheckBoxPC pc_isPaid;
	private RadioSelectionGroupPC&lt;StartType&gt; pc_startWindowType;
	private CompactActivityListPC pc_additionalActivities;

	// Data
<span class="fc" id="L84">	private List&lt;ShiftEvent&gt; shiftEvents = new ArrayList&lt;ShiftEvent&gt;();</span>
<span class="fc" id="L85">	protected Map&lt;ID, Activity&gt; activityMap = new HashMap&lt;ID, Activity&gt;();</span>
<span class="fc" id="L86">	private String m_optimizationTargetName = &quot;&quot;;</span>
<span class="fc" id="L87">	private int tzOffset = 0;</span>
	private int dayBoundary;

	public ShiftEventFormPM(RequestContext context) {
<span class="fc" id="L91">		super(context);</span>
<span class="fc" id="L92">		setRenderJavaScriptIfDisabled(true);</span>
<span class="fc" id="L93">		setName(&quot;WorkRulesShiftEventsFormPM&quot;);</span>
<span class="fc" id="L94">		m_bundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

<span class="fc" id="L96">		addPopupArgs(ActivityPopupPM.POPUP_ID, ActivityPopupPM.FORM_ACTION, &quot;&quot;, ActivityPopupPM.POPUP_ARGS,</span>
				&quot;1000,600,ctr,ctr&quot;, true, 1);
<span class="fc" id="L98">	}</span>

	public static ShiftEventFormPM getInstance(RequestContext context) {
<span class="fc" id="L101">		return (ShiftEventFormPM) getInstance(context, ShiftEventFormPM.class);</span>
	}

	@Override
	protected void initContentTitle() {
<span class="fc" id="L106">		super.initContentTitle();</span>
<span class="fc" id="L107">		m_contentTitlePC.setPageTitle(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SHIFT_EVENTS));</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">		if (isMultiEdit()) {</span>
<span class="nc" id="L109">			m_contentTitlePC.setItemName(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.N_SHIFT_EVENTS,</span>
<span class="nc" id="L110">					new Integer(shiftEvents.size())));</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">		} else if (!shiftEvents.isEmpty()) {</span>
<span class="nc" id="L112">			m_contentTitlePC.setItemName(shiftEvents.iterator().next().getName());</span>
		}
<span class="fc" id="L114">	}</span>

	@Override
	protected void loadData() throws Exception {
<span class="fc" id="L118">		super.loadData();</span>

		// Get timezone offset
<span class="pc bpc" id="L121" title="2 of 4 branches missed.">		if (isByOrg &amp;&amp; selectedOrg != null) {</span>
<span class="fc" id="L122">			tzOffset = TimeZoneOverrideUtil.getTimeZoneOffset(m_context, selectedOrg.getTimeZone(), new Date());</span>
<span class="fc" id="L123">			dayBoundary = selectedOrg.getDayBoundaryOffset();</span>
<span class="nc bnc" id="L124" title="All 4 branches missed.">		} else if (!isByOrg &amp;&amp; selectedCampaign != null) {</span>
<span class="nc" id="L125">			tzOffset = TimeZoneOverrideUtil.getTimeZoneOffset(m_context, selectedCampaign.getTimeZone(), new Date());</span>
<span class="nc" id="L126">			dayBoundary = selectedCampaign.getDayBoundaryOffset();</span>
		}

<span class="pc bpc" id="L129" title="1 of 2 branches missed.">		if (getPerformActionOnIDSize() &gt; 0) {</span>
<span class="nc" id="L130">			List&lt;ID&gt; paoIDs = Arrays.asList(getPerformActionOnIDs());</span>
<span class="nc" id="L131">			shiftEvents = new ArrayList&lt;ShiftEvent&gt;(WorkRulesModelHandler.getShiftEvents(m_context, paoIDs));</span>
<span class="nc" id="L132">			Collections.sort(shiftEvents, new ValueObjectIDListComparator(paoIDs));</span>

			// For single edit, get optimization target name (either org name or
			// &quot;Local&quot;)
<span class="nc bnc" id="L136" title="All 2 branches missed.">			if (shiftEvents.size() == 1) {</span>
<span class="nc" id="L137">				ShiftEvent se = shiftEvents.iterator().next();</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">				if (se.getCampaignID() != null) {</span>
<span class="nc" id="L139">					m_optimizationTargetName = m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.LOCAL);</span>
				}
<span class="nc bnc" id="L141" title="All 2 branches missed.">				if (se.getOrganizationID() != null) {</span>
<span class="nc" id="L142">					Organization o = OrganizationModelHandler.getOrganization(m_context, se.getOrganizationID());</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">					if (o != null) {</span>
<span class="nc" id="L144">						m_optimizationTargetName = o.getName();</span>
					}
				}
			}
<span class="nc" id="L148">			Collection&lt;ID&gt; activityIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">			for (ShiftEvent se : shiftEvents) {</span>
<span class="nc" id="L150">				ID id = se.getActivityID();</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">				if (id != null) {</span>
<span class="nc" id="L152">					activityIDs.add(id);</span>
				}
<span class="nc" id="L154">			}</span>
<span class="nc" id="L155">			Collection&lt;Activity&gt; activities = ActivityModelHandler.getActivitiesByIDs(m_context, activityIDs);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">			for (Activity a : activities) {</span>
<span class="nc" id="L157">				activityMap.put(a.getID(), a);</span>
<span class="nc" id="L158">			}</span>
		}

		// If editing a new Shift Event, or multi-editing
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">		if (StringUtil.isEmpty(m_optimizationTargetName)) {</span>
<span class="pc bpc" id="L163" title="2 of 4 branches missed.">			if (isByOrg &amp;&amp; selectedOrg != null) {</span>
<span class="fc" id="L164">				m_optimizationTargetName = selectedOrg.getName();</span>
<span class="nc bnc" id="L165" title="All 4 branches missed.">			} else if (!isByOrg &amp;&amp; selectedCampaign != null) {</span>
<span class="nc" id="L166">				m_optimizationTargetName = selectedCampaign.getName();</span>
			}
		}
<span class="fc" id="L169">	}</span>

	@Override
	protected void initForm() {
<span class="fc" id="L173">		pc_form = new FormTwoColumnPC(m_context);</span>
<span class="fc" id="L174">		pc_form.setIsBorderEnabled(true);</span>
<span class="fc" id="L175">		setForm(pc_form);</span>

		try {
<span class="fc" id="L178">			ShiftEvent se = new ShiftEvent();</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">			if (shiftEvents.size() &gt; 0) {</span>
<span class="nc" id="L180">				se = shiftEvents.iterator().next();</span>
			}

			// Org or Campaign
			// Net to build a list of organizations to use for scoped
			// retrieval of valid activities.
<span class="fc" id="L186">			Collection&lt;ID&gt; orgs = new ArrayList&lt;ID&gt;();</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">			if (isByOrg) {</span>
<span class="fc" id="L188">				String orgName = &quot;&quot;;</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">				if (selectedOrg != null) {</span>
<span class="fc" id="L190">					orgName = selectedOrg.getName();</span>
<span class="fc" id="L191">					orgs.add(selectedOrg.getID());</span>
				}
<span class="fc" id="L193">				pc_form.addRow(i(FsWebBundleKey.FS_ORGANIZATION), orgName);</span>
<span class="fc" id="L194">			} else {</span>
<span class="nc" id="L195">				String campaignName = &quot;&quot;;</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">				if (selectedCampaign != null) {</span>
<span class="nc" id="L197">					campaignName = selectedCampaign.getName();</span>

<span class="nc" id="L199">					Collection&lt;CampaignOrg&gt; orgAssigned = CampaignModelHandler.getCampaignOrgAssignments(m_context,</span>
<span class="nc" id="L200">							selectedCampaign.getID(), selectedSchedulingPeriod.getStartTime(),</span>
<span class="nc" id="L201">							selectedSchedulingPeriod.getEndTime());</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">					for (CampaignOrg co : orgAssigned) {</span>
<span class="nc" id="L203">						orgs.add(co.getOrganizationID());</span>
<span class="nc" id="L204">					}</span>
				}
<span class="nc" id="L206">				pc_form.addRow(i(FsWebBundleKey.FS_CAMPAIGN), campaignName);</span>
			}

<span class="pc bpc" id="L209" title="1 of 2 branches missed.">			if (isMultiEdit() == false) {</span>
				// Name
<span class="fc" id="L211">				pc_name = new FormInputPC(m_context);</span>
<span class="fc" id="L212">				pc_name.reset(FN_SHIFT_EVENT_NAME, se.getName(), FormInputPC.TYPE_STRING, true);</span>
<span class="fc" id="L213">				pc_name.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L214">				pc_name.setMaxLength(50);</span>
<span class="fc" id="L215">				pc_name.setInputFieldDesc(UIFWebBundleKey.NAME, UIFWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L216">				pc_name.setIsRequired(true);</span>
<span class="fc" id="L217">				pc_name.setInputValue(se.getName());</span>
<span class="fc" id="L218">				this.addChildComponent(pc_name);</span>
<span class="fc" id="L219">				pc_form.addRow(i18n(m_common_bundle, UIFWebBundleKey.NAME), pc_name);</span>

				// Description
<span class="fc" id="L222">				pc_description = new FormInputPC(m_context);</span>
<span class="fc" id="L223">				pc_description.reset(FN_SHIFT_EVENT_DESC, se.getName(), FormInputPC.TYPE_STRING, false);</span>
<span class="fc" id="L224">				pc_description.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L225">				pc_description.setMaxLength(250);</span>
<span class="fc" id="L226">				pc_description.setInputFieldDesc(UIFWebBundleKey.DESCRIPTION, UIFWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L227">				pc_description.setInputValue(se.getDescription());</span>
<span class="fc" id="L228">				this.addChildComponent(pc_description);</span>
<span class="fc" id="L229">				pc_form.addRow(i18n(m_common_bundle, UIFWebBundleKey.DESCRIPTION), pc_description);</span>
			}

			// Activity
<span class="fc" id="L233">			Collection&lt;Activity&gt; activities = ActivityModelHandler.getActivitiesByActivitySelectionType(getRequestContext(),</span>
					ActivityModelHandler.ActivitySelectionProperty.UsedInShiftEvent, orgs);
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">			if (activityMap.size() &gt; 0) {</span>
<span class="nc" id="L236">				pc_activity = new ActivitySelectorDDPC(m_context, JSVARNAME_ACTIVITY_ID, activities, activityMap.keySet()</span>
<span class="nc" id="L237">						.iterator().next().toString());</span>
			} else {
<span class="fc" id="L239">				pc_activity = new ActivitySelectorDDPC(m_context, JSVARNAME_ACTIVITY_ID, activities);</span>
			}
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">			pc_activity.setMultiEdit(activityMap.size() &gt; 1);</span>
<span class="fc" id="L242">			this.addChildComponent(pc_activity);</span>
<span class="fc" id="L243">			pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_ACTIVITY), pc_activity);</span>

			// Length
<span class="fc" id="L246">			HashSet&lt;Duration&gt; durations = new HashSet&lt;Duration&gt;();</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">			for (ShiftEvent dse : shiftEvents) {</span>
<span class="nc" id="L248">				durations.add(dse.getDuration());</span>
<span class="nc" id="L249">			}</span>
<span class="fc" id="L250">			pc_duration = new DurationSpinnerPC(m_context, JSVARNAME_DURATION);</span>
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">			if (isNew()) {</span>
				// Default the duration to 15 minutes if new like F&amp;S client.
<span class="fc" id="L253">				pc_duration.setValue(Duration.fromMinutes(15));</span>
			} else {
<span class="nc" id="L255">				pc_duration.setValue(se.getDuration());</span>
			}

			// Cannot create/define shift
			// events less than 5 minutes in
			// duration in the websuite -
			// ESR#4162272
<span class="fc" id="L262">			pc_duration.setMinTime(0, 1, 0);</span>

<span class="fc" id="L264">			initializeDurationSpinner(pc_duration, durations, 1);</span>
<span class="fc" id="L265">			this.addChildComponent(pc_duration);</span>
<span class="fc" id="L266">			pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_EVENT_LENGTH), pc_duration);</span>

			// Paid
<span class="fc" id="L269">			HashSet&lt;Boolean&gt; isPaidVals = new HashSet&lt;Boolean&gt;();</span>
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">			for (ShiftEvent ipse : shiftEvents) {</span>
<span class="nc" id="L271">				isPaidVals.add(ipse.isPaid());</span>
<span class="nc" id="L272">			}</span>
<span class="fc" id="L273">			String onIsPaidJS = eJS(JSVARNAME_IS_FLEXIBLE, true) + &quot;if (&quot; + JSVARNAME_IS_FLEXIBLE + &quot;.isChecked()) { &quot;</span>
<span class="fc" id="L274">					+ eJS(JSVARNAME_MINIMUM_COUNT, true) + eJS(JSVARNAME_MAXIMUM_COUNT, true) + &quot; }&quot;;</span>
<span class="fc" id="L275">			String onIsNotPaidJS = eJS(JSVARNAME_IS_FLEXIBLE, false) + eJS(JSVARNAME_MINIMUM_COUNT, false)</span>
<span class="fc" id="L276">					+ eJS(JSVARNAME_MAXIMUM_COUNT, false);</span>
<span class="fc" id="L277">			pc_isPaid = new CheckBoxPC(m_context, JSVARNAME_IS_PAID, se.isPaid(), onIsPaidJS, onIsNotPaidJS);</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">			pc_isPaid.setMultiEdit(isPaidVals.size() &gt; 1);</span>
<span class="fc" id="L279">			this.addChildComponent(pc_isPaid);</span>
<span class="fc" id="L280">			pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_EVENT_PAID), pc_isPaid);</span>

			// Is Flexible
<span class="fc" id="L283">			HashSet&lt;Boolean&gt; isFlexibleCol = new HashSet&lt;Boolean&gt;();</span>
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">			for (ShiftEvent ifse : shiftEvents) {</span>
<span class="nc" id="L285">				isFlexibleCol.add(ifse.isFlexible());</span>
<span class="nc" id="L286">			}</span>
<span class="fc" id="L287">			String enabledJS = eJS(JSVARNAME_MINIMUM_COUNT, true) + eJS(JSVARNAME_MAXIMUM_COUNT, true)</span>
					+ &quot;additionalActivityContainer.setToggleable(true);&quot;
					+ &quot;if(additionalActivityContainer.getIsCollapsed()) {&quot; + &quot;additionalActivityContainer.defaultToggle();&quot;
					+ &quot;}&quot;;
<span class="fc" id="L291">			String disabledJS = eJS(JSVARNAME_MINIMUM_COUNT, false) + eJS(JSVARNAME_MAXIMUM_COUNT, false)</span>
					+ &quot;if(!additionalActivityContainer.getIsCollapsed()) {&quot; + &quot;additionalActivityContainer.defaultToggle();&quot;
					+ &quot;}&quot; + &quot;additionalActivityContainer.setToggleable(false);&quot;;
<span class="fc" id="L294">			pc_isFlexible = new CheckBoxPC(m_context, JSVARNAME_IS_FLEXIBLE, se.isFlexible(), enabledJS, disabledJS);</span>
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">			pc_isFlexible.setMultiEdit(isFlexibleCol.size() &gt; 1);</span>
<span class="fc" id="L296">			this.addChildComponent(pc_isFlexible);</span>
<span class="fc" id="L297">			pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_FLEXIBLE), pc_isFlexible);</span>

			// Min &amp; Max Counts
<span class="fc" id="L300">			initMinMaxCountPCs(se);</span>

			// Start Type &amp; Times
<span class="fc" id="L303">			initStartWindowPCs(se);</span>

			// Additional Activities
<span class="fc" id="L306">			ToolbarPC additionalActivitiesToolbar = new ToolbarPC(m_context);</span>
<span class="fc" id="L307">			additionalActivitiesToolbar.setName(&quot;additionalActivitiesToolbar&quot;);</span>
<span class="fc" id="L308">			ToolbarTextButton addButton = additionalActivitiesToolbar.createPopupWindowButton(ActivityPopupPM.POPUP_ID,</span>
<span class="fc" id="L309">					m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_ADD), true);</span>
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">			if (isByOrg) {</span>
<span class="fc" id="L311">				addButton.setAttribute(&quot;ownerID&quot;, selectedOrg.getID().toString());</span>
			} else {
<span class="nc" id="L313">				addButton.setAttribute(&quot;ownerID&quot;, selectedSchedulingPeriod.getID().toString());</span>
			}
<span class="fc" id="L315">			addButton.setAttribute(&quot;isByOrg&quot;, String.valueOf(isByOrg));</span>
<span class="fc" id="L316">			addButton.setAttribute(&quot;showAddButton&quot;, String.valueOf(true));</span>
<span class="fc" id="L317">			addButton.setAttribute(&quot;activitySelection&quot;, ActivitySelectionProperty.UsedInShiftEvent.toString());</span>
			// Overwrite the onclick event handling to set the selectedIDs
			// attribute from the table
			// Set the selectedIDs popup parameter. The selectedIDs parameter
			// consists of ids of shift events to leave out of the options to
			// select
<span class="fc" id="L323">			addButton.setAttribute(&quot;onClick&quot;, WorkRulesUtil.getAddButtonIdFilterJavaScript(&quot;activityTable_rowIDs&quot;,</span>
<span class="fc" id="L324">					&quot;filteredActivityIDs&quot;, additionalActivitiesToolbar.getName(), ActivityPopupPM.POPUP_ID));</span>
<span class="fc" id="L325">			additionalActivitiesToolbar.addToolbarElement(addButton);</span>
<span class="fc" id="L326">			ToolbarTextButton removeButton = new ToolbarTextButton(additionalActivitiesToolbar, &quot;removeActivity&quot;,</span>
<span class="fc" id="L327">					m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_REMOVE),</span>
					InsertableMultiColListPC.REMOVE_ROW_BUTTON_ACTION, ToolbarTextButton.BLUE_BUTTON, false);
<span class="fc" id="L329">			additionalActivitiesToolbar.addToolbarElement(removeButton);</span>

<span class="fc" id="L331">			pc_additionalActivities = new CompactActivityListPC(getRequestContext(), &quot;activityTable&quot;,</span>
<span class="fc" id="L332">					getAdditionalActivitesFromSelectedShiftEvents()) {</span>
				@Override
				protected void setRowAttributes(DefaultMultiColumnNodeData mcnd, Activity activity) {
<span class="nc" id="L335">					super.setRowAttributes(mcnd, activity);</span>
<span class="nc" id="L336">					mcnd.setNodeAttribute(WorkpaneMultiColPM.IS_DELETEABLE, String.valueOf(true));</span>
					// This attribute will be used to determine if this row is
					// not common. If it is not
					// common to all shift events, we will not suppress it in
					// the popup choice
<span class="nc bnc" id="L341" title="All 2 branches missed.">					if (!activity.isMultiEditCommon()) {</span>
<span class="nc" id="L342">						mcnd.setNodeAttribute(&quot;multiEditNotCommon&quot;, &quot;true&quot;);</span>
					}
<span class="nc" id="L344">				}</span>
			};
<span class="fc" id="L346">			pc_additionalActivities.setToolbar(additionalActivitiesToolbar);</span>
<span class="fc" id="L347">			pc_additionalActivities.setName(&quot;activityTable&quot;);</span>
<span class="fc" id="L348">			CollapsibleListContainerPC additionalActivityContainer = new CollapsibleListContainerPC(getRequestContext(),</span>
<span class="fc" id="L349">					&quot;additionalActivityContainer&quot;, getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
					FsWebBundleKey.FS_ADDITIONAL_ACTIVITIES_EDIT), pc_additionalActivities);
<span class="fc" id="L351">			addChildComponent(additionalActivityContainer);</span>
<span class="fc" id="L352">			addForm(additionalActivityContainer);</span>

			// Set page component state from submitted values
<span class="pc bpc" id="L355" title="2 of 4 branches missed.">			if (null != getPageAction() &amp;&amp; !PageAction.EDIT.equals(getPageAction())) {</span>
<span class="fc" id="L356">				this.extractParameters(m_context.getRequest());</span>
			}

			// Custom enable logic. must come after extract params in order to
			// accurately reflect the state after a postback
<span class="fc" id="L361">			pc_isFlexible.setEnabled(pc_isPaid.isChecked());</span>
<span class="pc bpc" id="L362" title="3 of 4 branches missed.">			pc_minimumCount.setEnabled(pc_isFlexible.isEnabled() &amp;&amp; pc_isFlexible.isChecked());</span>
<span class="pc bpc" id="L363" title="3 of 4 branches missed.">			pc_maximumCount.setEnabled(pc_isFlexible.isEnabled() &amp;&amp; pc_isFlexible.isChecked());</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">			pc_earliestStart.setEnabled(!StartType.AnyTime.equals(pc_startWindowType.getSelected()));</span>
<span class="pc bpc" id="L365" title="1 of 2 branches missed.">			pc_latestStart.setEnabled(!StartType.AnyTime.equals(pc_startWindowType.getSelected()));</span>
<span class="pc bpc" id="L366" title="3 of 4 branches missed.">			if (pc_isFlexible.isEnabled() == false || pc_isFlexible.isChecked() == false) {</span>
<span class="fc" id="L367">				additionalActivityContainer.setCollapsed(true);</span>
<span class="fc" id="L368">				additionalActivityContainer.setIsToggleEnabled(false);</span>
<span class="fc" id="L369">				this.setRenderJavaScriptIfDisabled(true);</span>
			}

<span class="nc" id="L372">		} catch (Exception ex) {</span>
<span class="nc" id="L373">			handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L374">		}</span>
<span class="fc" id="L375">	}</span>

	/**
	 *
	 */
	private Collection&lt;Activity&gt; getAdditionalActivitesFromSelectedShiftEvents() {
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">		if (shiftEvents.size() == 0) {</span>
<span class="fc" id="L382">			return new ArrayList&lt;Activity&gt;();</span>
		}

<span class="nc" id="L385">		HashMap&lt;ID, Activity&gt; activityMap = new HashMap&lt;ID, Activity&gt;();</span>

		// initialize the map
<span class="nc" id="L388">		ShiftEvent tempShiftEvent = shiftEvents.get(0);</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">		for (Activity activity : new ArrayList&lt;Activity&gt;(tempShiftEvent.getAdditionalActivities())) {</span>
<span class="nc" id="L390">			activity.setMultiEditCommon(true);</span>
<span class="nc" id="L391">			activityMap.put(activity.getID(), activity);</span>
<span class="nc" id="L392">		}</span>

<span class="nc bnc" id="L394" title="All 2 branches missed.">		for (ShiftEvent se : shiftEvents) {</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">			for (Activity activity : activityMap.values()) {</span>
				// if an activity in the map does not belong to the shift event
				// in this iteration,
				// we want to set multi edit common to false as it is no longer
				// common between
				// all shift events in the set
<span class="nc bnc" id="L401" title="All 4 branches missed.">				if (activity.isMultiEditCommon() &amp;&amp; se.getAdditionalActivities().contains(activity) == false) {</span>
<span class="nc" id="L402">					activity.setMultiEditCommon(false);</span>
				}
<span class="nc" id="L404">			}</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">			for (Activity activity : se.getAdditionalActivities()) {</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">				if (activityMap.containsKey(activity.getID()) == false) {</span>
<span class="nc" id="L407">					activity.setMultiEditCommon(false);</span>
<span class="nc" id="L408">					activityMap.put(activity.getID(), activity);</span>
				}
<span class="nc" id="L410">			}</span>
<span class="nc" id="L411">		}</span>
<span class="nc" id="L412">		return new ArrayList&lt;Activity&gt;(activityMap.values());</span>
	}

	private void initMinMaxCountPCs(ShiftEvent se) {
		// Minimum Counts
<span class="fc" id="L417">		HashSet&lt;Integer&gt; minCounts = new HashSet&lt;Integer&gt;();</span>
<span class="fc" id="L418">		Integer highestMinCount = null;</span>
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">		for (ShiftEvent mcse : shiftEvents) {</span>
<span class="nc" id="L420">			Integer minCount = mcse.getMinCount();</span>
<span class="nc" id="L421">			minCounts.add(minCount);</span>
<span class="nc bnc" id="L422" title="All 4 branches missed.">			if (highestMinCount == null || minCount &gt; highestMinCount) {</span>
<span class="nc" id="L423">				highestMinCount = minCount;</span>
			}
<span class="nc" id="L425">		}</span>

<span class="fc" id="L427">		HashSet&lt;Integer&gt; maxCounts = new HashSet&lt;Integer&gt;();</span>
<span class="fc" id="L428">		Integer lowestMaxCount = null;</span>
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">		for (ShiftEvent mcse : shiftEvents) {</span>
<span class="nc" id="L430">			int maxCount = mcse.getMaxCount();</span>
<span class="nc" id="L431">			maxCounts.add(maxCount);</span>
<span class="nc bnc" id="L432" title="All 4 branches missed.">			if (lowestMaxCount == null || maxCount &lt; lowestMaxCount) {</span>
<span class="nc" id="L433">				lowestMaxCount = maxCount;</span>
			}
<span class="nc" id="L435">		}</span>

<span class="fc" id="L437">		pc_minimumCount = new IntegerDropDownSelection(m_context, JSVARNAME_MINIMUM_COUNT, 0, 99,</span>
<span class="fc" id="L438">				new int[]{se.getMinCount()});</span>
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">		String minCountChangeJS = &quot;\n var minCountSelections = &quot;</span>
				+ JSVARNAME_MINIMUM_COUNT
				+ &quot;.getSelections();&quot;
				+ &quot;\n var maxCountSelections = &quot;
				+ JSVARNAME_MAXIMUM_COUNT
				+ &quot;.getSelections();&quot;
				+ &quot;\n if (minCountSelections.length &gt; 0) {&quot;
				+ &quot;\n if (maxCountSelections.length &gt; 0 &amp;&amp; parseInt(minCountSelections[0]) &gt; parseInt(maxCountSelections[0])) { &quot;
				+ &quot;\n &quot;
				+ JSVARNAME_MAXIMUM_COUNT
				+ &quot;.setSelections([minCountSelections[0]]);&quot;
				+ &quot;\n }&quot;
				+ (lowestMaxCount == null ? &quot;&quot; : &quot;if (parseInt(minCountSelections[0]) &gt; &quot; + lowestMaxCount + &quot;) { &quot;
				+ JSVARNAME_MAXIMUM_COUNT + &quot;.setEdited(true); }&quot;) + &quot;\n }&quot;;
<span class="fc" id="L453">		pc_minimumCount.setOnChangeJS(minCountChangeJS);</span>
<span class="pc bpc" id="L454" title="1 of 2 branches missed.">		pc_minimumCount.setMultiEdit(minCounts.size() &gt; 1);</span>
<span class="fc" id="L455">		this.addChildComponent(pc_minimumCount);</span>
<span class="fc" id="L456">		pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_MINIMUM_COUNT), pc_minimumCount);</span>

		// Maximum Counts
<span class="fc" id="L459">		pc_maximumCount = new IntegerDropDownSelection(m_context, JSVARNAME_MAXIMUM_COUNT, 1, 99,</span>
<span class="fc" id="L460">				new int[]{se.getMaxCount()});</span>
<span class="pc bpc" id="L461" title="1 of 2 branches missed.">		String maxCountChangeJS = &quot;\n var minCountSelections = &quot;</span>
				+ JSVARNAME_MINIMUM_COUNT
				+ &quot;.getSelections();&quot;
				+ &quot;\n var maxCountSelections = &quot;
				+ JSVARNAME_MAXIMUM_COUNT
				+ &quot;.getSelections();&quot;
				+ &quot;\n if (maxCountSelections.length &gt; 0) {&quot;
				+ &quot;\n if (minCountSelections.length &gt; 0 &amp;&amp; parseInt(minCountSelections[0]) &gt; parseInt(maxCountSelections[0])) { &quot;
				+ &quot;\n &quot;
				+ JSVARNAME_MINIMUM_COUNT
				+ &quot;.setSelections([maxCountSelections[0]]);&quot;
				+ &quot;\n }&quot;
				+ (highestMinCount == null ? &quot;&quot; : &quot;if (parseInt(maxCountSelections[0]) &lt; &quot; + highestMinCount + &quot;) { &quot;
				+ JSVARNAME_MINIMUM_COUNT + &quot;.setEdited(true); }&quot;) + &quot;\n }&quot;;
<span class="fc" id="L475">		pc_maximumCount.setOnChangeJS(maxCountChangeJS);</span>
<span class="pc bpc" id="L476" title="1 of 2 branches missed.">		pc_maximumCount.setMultiEdit(maxCounts.size() &gt; 1);</span>
<span class="fc" id="L477">		this.addChildComponent(pc_maximumCount);</span>
<span class="fc" id="L478">		pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_MAXIMUM_COUNT), pc_maximumCount);</span>
<span class="fc" id="L479">	}</span>

	private void initStartWindowPCs(ShiftEvent se) {
	/*
		 * The logic behind the start window components is somewhat complex
		 * because the fields' behaviors are dependent on each others' values.
		 * 1) If the start type is &quot;Any Time&quot;, the start and end pickers should
		 * be disabled. 2) If the start time is changed to be after the end
		 * time, the end time should be set to be equal to the start time. 3) if
		 * the end time is change to be before the start time, the start time
		 * should be set to be equal to the end time. 4) If we are in multi-edit
		 * mode and the start time is changed to be after any one of the end
		 * time values, we need to set the end times to the edited state 5) If
		 * we are in multi-edit mode and the end time is change to be before any
		 * one of the start time values, we need to set the start times to the
		 * edited state
		 */

		// Start Window Type
<span class="fc" id="L498">		HashSet&lt;Boolean&gt; startTimeTypes = new HashSet&lt;Boolean&gt;();</span>
<span class="pc bpc" id="L499" title="1 of 2 branches missed.">		for (ShiftEvent sttse : shiftEvents) {</span>
<span class="nc" id="L500">			startTimeTypes.add(sttse.isCafeteria());</span>
<span class="nc" id="L501">		}</span>
<span class="fc" id="L502">		pc_startWindowType = new RadioSelectionGroupPC&lt;StartType&gt;(m_context, JSVARNAME_START_TIME_TYPE);</span>
<span class="fc" id="L503">		String diableTimeWindowSelectorJS = JSVARNAME_EARLIEST_START + &quot;.setEnabled(false); &quot; + JSVARNAME_LATEST_START</span>
				+ &quot;.setEnabled(false);&quot;;
<span class="fc" id="L505">		String enableTimeWindowSelectorJS = JSVARNAME_EARLIEST_START + &quot;.setEnabled(true); &quot; + JSVARNAME_LATEST_START</span>
				+ &quot;.setEnabled(true);&quot;;
<span class="fc" id="L507">		pc_startWindowType.addRadioOption(&quot;anyTime&quot;, i18n(m_bundle, FsWebBundleKey.FS_ANY_TIME), &quot;&quot;, StartType.AnyTime,</span>
<span class="fc" id="L508">				se.isAnyTime(), diableTimeWindowSelectorJS);</span>
<span class="fc" id="L509">		pc_startWindowType.addRadioOption(&quot;absolute&quot;, i18n(m_bundle, FsWebBundleKey.FS_ABSOLUTE), &quot;&quot;, StartType.Absolute,</span>
<span class="pc bpc" id="L510" title="2 of 4 branches missed.">				!se.isAnyTime() &amp;&amp; se.isCafeteria(), enableTimeWindowSelectorJS);</span>
<span class="fc" id="L511">		pc_startWindowType.addRadioOption(&quot;relative&quot;, i18n(m_bundle, FsWebBundleKey.FS_RELATIVE_TO_SHIFT_START), &quot;&quot;,</span>
<span class="pc bpc" id="L512" title="2 of 4 branches missed.">				StartType.Relative, !se.isAnyTime() &amp;&amp; !se.isCafeteria(), enableTimeWindowSelectorJS);</span>
<span class="pc bpc" id="L513" title="1 of 2 branches missed.">		pc_startWindowType.setMultiEdit(startTimeTypes.size() &gt; 1);</span>
<span class="fc" id="L514">		this.addChildComponent(pc_startWindowType);</span>
<span class="fc" id="L515">		pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_START_TIME_TYPE), pc_startWindowType);</span>

		// Start window earliest &amp; latest values
<span class="fc" id="L518">		LinkedHashSet&lt;Duration&gt; earliestStarts = new LinkedHashSet&lt;Duration&gt;();</span>
		// find the lastEarliestStart for req 5 above
<span class="fc" id="L520">		Duration lastEarliestStart = null;</span>
<span class="pc bpc" id="L521" title="1 of 2 branches missed.">		for (ShiftEvent esse : shiftEvents) {</span>
<span class="nc" id="L522">			Duration start = Duration.fromMinutes(esse.getStart());</span>
<span class="nc bnc" id="L523" title="All 4 branches missed.">			if (lastEarliestStart == null || start.isLongerThan(lastEarliestStart)) {</span>
<span class="nc" id="L524">				lastEarliestStart = start;</span>
			}
<span class="nc" id="L526">			earliestStarts.add(start);</span>
<span class="nc" id="L527">		}</span>

<span class="fc" id="L529">		LinkedHashSet&lt;Duration&gt; latestStarts = new LinkedHashSet&lt;Duration&gt;();</span>
		// find the firstLatestStart for req 4 above
<span class="fc" id="L531">		Duration firstLatestStart = null;</span>
<span class="pc bpc" id="L532" title="1 of 2 branches missed.">		for (ShiftEvent lsse : shiftEvents) {</span>
<span class="nc" id="L533">			Duration end = Duration.fromMinutes(lsse.getEnd());</span>
<span class="nc bnc" id="L534" title="All 4 branches missed.">			if (firstLatestStart == null || end.isShorterThan(firstLatestStart)) {</span>
<span class="nc" id="L535">				firstLatestStart = end;</span>
			}
<span class="nc" id="L537">			latestStarts.add(end);</span>
<span class="nc" id="L538">		}</span>

		// Earliest Start PC
<span class="fc" id="L541">		pc_earliestStart = new DurationSpinnerPC(m_context, JSVARNAME_EARLIEST_START);</span>
<span class="fc" id="L542">		int mins = se.getStart();</span>
<span class="pc bpc" id="L543" title="1 of 2 branches missed.">		if (se.isCafeteria()) {</span>
<span class="nc" id="L544">			mins = new TimeOfDay(se.getStart() + dayBoundary).addMinutes(tzOffset).getMinutesSinceMindnight();</span>
		}
<span class="fc" id="L546">		pc_earliestStart.setValue(Duration.fromMinutes(mins));</span>
<span class="fc" id="L547">		initializeDurationSpinner(pc_earliestStart, earliestStarts, 15);</span>
<span class="fc" id="L548">		pc_earliestStart.setAsMinimumValueSpinner(JSVARNAME_LATEST_START, firstLatestStart);</span>

<span class="pc bpc" id="L550" title="3 of 4 branches missed.">		if (firstLatestStart != null &amp;&amp; se.getStart() &gt; firstLatestStart.getDurationInMinutes()</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">				&amp;&amp; firstLatestStart.getDurationInMinutes() != se.getEnd()) {</span>
			// Because the fields are related, force the multi edit
<span class="nc" id="L553">			pc_earliestStart.setMultiEdit(true);</span>
		}

<span class="fc" id="L556">		this.addChildComponent(pc_earliestStart);</span>
<span class="fc" id="L557">		pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_EARLIEST_START), pc_earliestStart);</span>

		// Latest Start PC
<span class="fc" id="L560">		pc_latestStart = new DurationSpinnerPC(m_context, JSVARNAME_LATEST_START);</span>
<span class="fc" id="L561">		mins = se.getEnd();</span>
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">		if (se.isCafeteria()) {</span>
<span class="nc" id="L563">			mins = new TimeOfDay(se.getEnd() + dayBoundary).addMinutes(tzOffset).getMinutesSinceMindnight();</span>
		}
<span class="fc" id="L565">		pc_latestStart.setValue(Duration.fromMinutes(mins));</span>
<span class="fc" id="L566">		initializeDurationSpinner(pc_latestStart, latestStarts, 15);</span>
<span class="fc" id="L567">		pc_latestStart.setAsMaximumValueSpinner(JSVARNAME_EARLIEST_START, lastEarliestStart);</span>

<span class="pc bpc" id="L569" title="3 of 4 branches missed.">		if (lastEarliestStart != null &amp;&amp; se.getEnd() &lt; lastEarliestStart.getDurationInMinutes()</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">				&amp;&amp; lastEarliestStart.getDurationInMinutes() != se.getStart()) {</span>
<span class="nc" id="L571">			pc_latestStart.setMultiEdit(true);</span>
		}
<span class="fc" id="L573">		this.addChildComponent(pc_latestStart);</span>
<span class="fc" id="L574">		pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_LATEST_START), pc_latestStart);</span>
<span class="fc" id="L575">	}</span>

	private void initializeDurationSpinner(DurationSpinnerPC spinner, Collection&lt;?&gt; values, int minutesIncrement) {
<span class="fc" id="L578">		spinner.setMinutesIncrement(minutesIncrement);</span>
<span class="pc bpc" id="L579" title="1 of 2 branches missed.">		spinner.setMultiEdit(values.size() &gt; 1);</span>
<span class="fc" id="L580">	}</span>

	/**
	 * Get setEnabled JavaScript
	 */
	private static String eJS(String varName, boolean enabled) {
<span class="fc" id="L586">		return varName + &quot;.setEnabled(&quot; + enabled + &quot;); &quot;;</span>
	}

	/**
	 * Gets shift events represented by this form.
	 *
	 * @return
	 * @throws BbmException
	 * @throws RemoteException
	 */
	public Collection&lt;ShiftEvent&gt; getShiftEvents() throws RemoteException, BbmException {
<span class="fc" id="L597">		Collection&lt;ShiftEvent&gt; ret = new ArrayList&lt;ShiftEvent&gt;(shiftEvents);</span>
<span class="pc bpc" id="L598" title="1 of 2 branches missed.">		if (ret.isEmpty()) {</span>
<span class="fc" id="L599">			ret.add(new ShiftEvent());</span>
		}

<span class="fc" id="L602">		boolean isMultiEdit = isMultiEdit();</span>

<span class="fc bfc" id="L604" title="All 2 branches covered.">		for (ShiftEvent se : ret) {</span>
			// Construct a shift event from the form field
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">			if (!isMultiEdit) {</span>
<span class="pc bpc" id="L607" title="1 of 2 branches missed.">				se.setName(pc_name.getInputValue() != null ? pc_name.getInputValue().trim() : null);</span>
<span class="fc" id="L608">				se.setDescription(pc_description.getInputValue());</span>
<span class="pc bpc" id="L609" title="1 of 2 branches missed.">				if (isByOrg) {</span>
<span class="fc" id="L610">					se.setOrganizationID(selectedOrg.getID());</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">				} else if (!isByOrg) {</span>
<span class="nc" id="L612">					se.setCampaignID(selectedCampaign.getDEID());</span>
				}
			}
<span class="pc bpc" id="L615" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_activity.isEdited()) {</span>
<span class="fc" id="L616">				se.setActivityID(pc_activity.getSelections().iterator().next().getID());</span>
			}
<span class="pc bpc" id="L618" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_duration.isEdited()) {</span>
<span class="fc" id="L619">				se.setDuration(pc_duration.getDuration());</span>
			}
<span class="pc bpc" id="L621" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_startWindowType.isEdited()) {</span>
<span class="fc" id="L622">				se.setIsCafeteria(StartType.Absolute.equals(pc_startWindowType.getSelected()));</span>
<span class="fc" id="L623">				se.setIsAnyTime(StartType.AnyTime.equals(pc_startWindowType.getSelected()));</span>
			}
<span class="pc bpc" id="L625" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_earliestStart.isEdited()) {</span>
<span class="fc" id="L626">				TimeOfDay tod = new TimeOfDay(pc_earliestStart.getDuration().getDurationInMinutes());</span>
<span class="pc bpc" id="L627" title="1 of 2 branches missed.">				if (se.isCafeteria()) {</span>
<span class="nc" id="L628">					tod = tod.addMinutes(-tzOffset);</span>
<span class="nc" id="L629">					tod = tod.addMinutes(-adjustMinuteByDayBoundary(tod.getMinutesSinceMindnight(), dayBoundary));</span>
				}
<span class="fc" id="L631">				se.setStart(tod.getMinutesSinceMindnight());</span>
			}
<span class="pc bpc" id="L633" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_latestStart.isEdited()) {</span>
<span class="fc" id="L634">				TimeOfDay tod = new TimeOfDay(pc_latestStart.getDuration().getDurationInMinutes());</span>
<span class="pc bpc" id="L635" title="1 of 2 branches missed.">				if (se.isCafeteria()) {</span>
<span class="nc" id="L636">					tod = tod.addMinutes(-tzOffset);</span>
<span class="nc" id="L637">					tod = tod.addMinutes(-adjustMinuteByDayBoundary(tod.getMinutesSinceMindnight(), dayBoundary));</span>
				}
<span class="fc" id="L639">				se.setEnd(tod.getMinutesSinceMindnight());</span>
			}
<span class="pc bpc" id="L641" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_isFlexible.isEdited()) {</span>
<span class="pc bpc" id="L642" title="3 of 4 branches missed.">				se.setIsFlexible(pc_isFlexible.isChecked() &amp;&amp; pc_isPaid.isChecked());</span>
			}
<span class="pc bpc" id="L644" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_isPaid.isEdited()) {</span>
<span class="fc" id="L645">				se.setIsPaid(pc_isPaid.isChecked());</span>
			}
<span class="fc" id="L647">			int maxCount = 1, minCount = 1;</span>
<span class="pc bpc" id="L648" title="1 of 2 branches missed.">			if (pc_maximumCount.getSelections().size() &gt; 0) {</span>
<span class="fc" id="L649">				maxCount = pc_maximumCount.getSelections().iterator().next();</span>
<span class="pc bpc" id="L650" title="3 of 4 branches missed.">				if (!pc_isFlexible.isChecked() || !pc_isPaid.isChecked()) {</span>
<span class="fc" id="L651">					maxCount = 1;</span>
				}
			}
<span class="pc bpc" id="L654" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_maximumCount.isEdited()) {</span>
<span class="fc" id="L655">				se.setMaxCount(maxCount);</span>
			}
<span class="pc bpc" id="L657" title="1 of 2 branches missed.">			if (pc_minimumCount.getSelections().size() &gt; 0) {</span>
<span class="fc" id="L658">				minCount = pc_minimumCount.getSelections().iterator().next();</span>
<span class="pc bpc" id="L659" title="3 of 4 branches missed.">				if (!pc_isFlexible.isChecked() || !pc_isPaid.isChecked()) {</span>
<span class="fc" id="L660">					minCount = 0;</span>
				}
			}
<span class="pc bpc" id="L663" title="3 of 4 branches missed.">			if (!isMultiEdit || pc_minimumCount.isEdited()) {</span>
<span class="fc" id="L664">				se.setMinCount(minCount);</span>
			}

<span class="pc bpc" id="L667" title="1 of 2 branches missed.">			if (pc_additionalActivities.getRemovedRowIDs().length() &gt; 0) {</span>
<span class="nc" id="L668">				removeAdditionalActivitiesFromShiftEvent(se,</span>
<span class="nc" id="L669">						StringUtil.parseIDStringToCollection(pc_additionalActivities.getRemovedRowIDs()));</span>
			}
<span class="pc bpc" id="L671" title="1 of 2 branches missed.">			if (pc_additionalActivities.getAddedRowIDs().length() &gt; 0) {</span>
<span class="nc" id="L672">				Collection&lt;Activity&gt; addedActivities = new ArrayList&lt;Activity&gt;();</span>
<span class="nc" id="L673">				addedActivities = ActivityModelHandler.getActivitiesByIDs(getRequestContext(),</span>
<span class="nc" id="L674">						StringUtil.parseIDStringToCollection(pc_additionalActivities.getAddedRowIDs()));</span>
<span class="nc" id="L675">				addAdditionalActivitiesToShiftEvent(se, addedActivities);</span>
			}
			// If the shift event has an additional activity that is also set as
			// the primary activity,
			// we remove it from the list of additional activities.
<span class="fc" id="L680">		}</span>
<span class="fc" id="L681">		return ret;</span>
	}

	private void removeAdditionalActivitiesFromShiftEvent(ShiftEvent se, Collection&lt;ID&gt; activityIDsToRemove) {
<span class="nc" id="L685">		ArrayList&lt;Activity&gt; activitiesToRemove = new ArrayList&lt;Activity&gt;();</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">		for (Activity activity : se.getAdditionalActivities()) {</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">			for (ID idToRemove : activityIDsToRemove) {</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">				if (activity.getID().equals(idToRemove)) {</span>
<span class="nc" id="L689">					activitiesToRemove.add(activity);</span>
<span class="nc" id="L690">					break;</span>
				}
<span class="nc" id="L692">			}</span>
<span class="nc" id="L693">		}</span>
<span class="nc" id="L694">		se.removeAdditionalActivities(activitiesToRemove);</span>
<span class="nc" id="L695">	}</span>

	// It's possible that the activities that are being added might already be
	// associated to a shift event.
	// Only add the activities that are not already associated
	private void addAdditionalActivitiesToShiftEvent(ShiftEvent se, Collection&lt;Activity&gt; activities) {
		// WFM:Creating shift events with add activities - ESR#4225100 - Dup
		// activities
<span class="nc" id="L703">		activities.removeAll(se.getAdditionalActivities());</span>
<span class="nc" id="L704">		se.addAdditionalActivities(activities);</span>
<span class="nc" id="L705">	}</span>

	/**
	 * Intended to be used to adjust the spinner minutes value for start times
	 * to the value that will eventually be stored in the database. Values in
	 * the database are stored with the org/campaign's day boundary offset (if
	 * it is an absolute shift event).
	 */
	private int adjustMinuteByDayBoundary(int min, int dayBoundary) {
<span class="nc bnc" id="L714" title="All 2 branches missed.">		if (min &lt; dayBoundary) {</span>
<span class="nc" id="L715">			return -(1440 - dayBoundary);</span>
		}
<span class="nc" id="L717">		return dayBoundary;</span>
	}

	@Override
	public boolean validate() {
<span class="fc" id="L722">		boolean retVal = super.validate();</span>
		try {
			// getShiftEvents() will rebuild all selected shift events based on
			// the set values from the page components.
			// We then iterate through these shift events to determine their
			// validity.
<span class="fc" id="L728">			Collection&lt;ShiftEvent&gt; shiftEvents = getShiftEvents();</span>

<span class="pc bpc" id="L730" title="1 of 2 branches missed.">			if (isMultiEdit() == false) {</span>
<span class="fc" id="L731">				String name = pc_name.getInputValue();</span>

<span class="fc" id="L733">				Collection&lt;ShiftEvent&gt; shiftEventsExisting = new ArrayList&lt;ShiftEvent&gt;();</span>
<span class="pc bpc" id="L734" title="1 of 2 branches missed.">				if (isByOrg) { // By Organization.</span>
<span class="fc" id="L735">					shiftEventsExisting = WorkRulesModelHandler.getShiftEventsByOrgHierarchy(m_context, selectedOrg.getID());</span>
				} else { // By scheduling period.
<span class="nc" id="L737">					shiftEventsExisting = WorkRulesModelHandler.getShiftEventsBySchedulingPeriod(m_context,</span>
<span class="nc" id="L738">							selectedSchedulingPeriod.getID());</span>
				}

<span class="fc bfc" id="L741" title="All 2 branches covered.">				for (ShiftEvent formShiftEvent : shiftEvents) {</span>
<span class="pc bpc" id="L742" title="1 of 2 branches missed.">					for (ShiftEvent existingShiftEvent : shiftEventsExisting) {</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">						if (existingShiftEvent.getID().equals(formShiftEvent.getID())) {</span>
<span class="nc" id="L744">							continue;</span>
						}
<span class="nc bnc" id="L746" title="All 2 branches missed.">						if (formShiftEvent.getName().equals(existingShiftEvent.getName())) {</span>
<span class="nc" id="L747">							addPageMessage(Message.ERROR_TYPE,</span>
<span class="nc" id="L748">									m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_NAME_MUST_BE_UNIQUE));</span>
<span class="nc" id="L749">							retVal = false;</span>
						}
<span class="nc" id="L751">					}</span>
<span class="fc" id="L752">				}</span>
			}

<span class="fc" id="L755">			ArrayList&lt;Message&gt; results = ShiftUtil.validateShiftEventDefinitions(m_localizer, shiftEvents);</span>
<span class="pc bpc" id="L756" title="1 of 2 branches missed.">			for (Message m : results) {</span>
<span class="nc" id="L757">				addPageMessage(m);</span>
<span class="nc" id="L758">			}</span>
<span class="pc bpc" id="L759" title="1 of 2 branches missed.">			if (results.size() &gt; 0) {</span>
<span class="nc" id="L760">				retVal = false;</span>
			}

<span class="fc" id="L763">			List&lt;Message&gt; validationMessages = ShiftUtil.validateShiftEvents(m_localizer, shiftEvents);</span>
<span class="pc bpc" id="L764" title="1 of 2 branches missed.">			for (Message m : validationMessages) {</span>
<span class="nc" id="L765">				addPageMessage(m);</span>
<span class="nc" id="L766">			}</span>
<span class="pc bpc" id="L767" title="1 of 2 branches missed.">			if (validationMessages.size() &gt; 0) {</span>
<span class="nc" id="L768">				retVal = false;</span>
			}

<span class="fc" id="L771">			return retVal;</span>
<span class="nc" id="L772">		} catch (Exception ex) {</span>
<span class="nc" id="L773">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L774">			return false;</span>
		}
	}

	private String i(String key) {
<span class="fc" id="L779">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, key);</span>
	}

<span class="pc" id="L782">	private enum StartType {</span>
<span class="fc" id="L783">		AnyTime, Relative, Absolute</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>