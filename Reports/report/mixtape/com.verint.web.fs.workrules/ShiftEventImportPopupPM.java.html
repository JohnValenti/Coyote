<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftEventImportPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">ShiftEventImportPopupPM.java</span></div><h1>ShiftEventImportPopupPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignOrg;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftEvent;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.shift.ShiftUtil;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.data.DataSet;
import com.witness.web.uif.data.DataTable;
import com.witness.web.uif.data.DataTableRow;
import com.witness.web.uif.system.RequestContext;

public class ShiftEventImportPopupPM extends WorkRulesImportPopupPM {
	private static final long serialVersionUID = 1L;

	public static final String FORM_ACTION = &quot;shift_event_import&quot;;
	
	private final static String SHIFT_EVENT_FN = &quot;SHIFT_EVENT_FN&quot;;
	private final static String ACTIVITY_FN = &quot;ACTIVITY_FN&quot;;
	private final static String LENGTH_FN = &quot;LENGTH_FN&quot;;
	private final static String START_TIME_TYPE_FN = &quot;START_TIME_TYPE_FN&quot;;
	private final static String START_WINDOW_FN = &quot;START_WINDOW_FN&quot;;
	private final static String EVENT_PAID_FN = &quot;EVENT_PAID_FN&quot;;
	private final static String FLEXIBLE_FN = &quot;FLEXIBLE_FN&quot;;
	private final static String MIN_COUNT_FN = &quot;MIN_COUNT_FN&quot;;
	private final static String MAX_COUNT_FN = &quot;MAX_COUNT_FN&quot;;
	private final static String ADDITIONAL_ACTIVITIES_FN = &quot;ADDITIONAL_ACTIVITIES_FN&quot;;
	private final static String ORGANIZATION_FN = &quot;ORGANIZATION_FN&quot;;
	private final static String DESCRIPTION_FN = &quot;DESCRIPTION_FN&quot;;
	
	private Map&lt;ID, Organization&gt; m_organizationMap;
	private Map&lt;ID, Campaign&gt; m_campaignMap;
	
	public ShiftEventImportPopupPM(RequestContext context) {
<span class="nc" id="L55">		super(context);</span>
		
<span class="nc" id="L57">		setIsCommaDelimiterEnabled(false); </span>
<span class="nc" id="L58">		setNumberOfLinesToIgnore(1);</span>
<span class="nc" id="L59">	}</span>

	public static ShiftEventImportPopupPM getInstance(RequestContext context) {
<span class="nc" id="L62">		return (ShiftEventImportPopupPM)getInstance(context, ShiftEventImportPopupPM.class);</span>
	}

	@Override
	protected void initializeFieldInfo() {
<span class="nc" id="L67">		m_fsResourceBundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>
		
<span class="nc" id="L69">		ArrayList&lt;FieldInfo&gt; fieldDefinitions = new ArrayList&lt;FieldInfo&gt;();</span>
<span class="nc" id="L70">		fieldDefinitions.add(new FieldInfo(SHIFT_EVENT_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_EVENT), true, true, false));</span>
<span class="nc" id="L71">		fieldDefinitions.add(new FieldInfo(ACTIVITY_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_ACTIVITY), true, true, false));</span>
<span class="nc" id="L72">		fieldDefinitions.add(new FieldInfo(LENGTH_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_LENGTH), true, true, false));</span>
<span class="nc" id="L73">		fieldDefinitions.add(new FieldInfo(START_TIME_TYPE_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_START_TIME_TYPE), false, true, true));</span>
<span class="nc" id="L74">		fieldDefinitions.add(new FieldInfo(START_WINDOW_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_START_WINDOW), false, true, true));</span>
<span class="nc" id="L75">		fieldDefinitions.add(new FieldInfo(EVENT_PAID_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_EVENT_PAID), false, true, true));</span>
<span class="nc" id="L76">		fieldDefinitions.add(new FieldInfo(FLEXIBLE_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_FLEXIBLE), false, true, true));</span>
<span class="nc" id="L77">		fieldDefinitions.add(new FieldInfo(MIN_COUNT_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_MIN_COUNT), false, true, true));</span>
<span class="nc" id="L78">		fieldDefinitions.add(new FieldInfo(MAX_COUNT_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_MAX_COUNT), false, true, true));</span>
<span class="nc" id="L79">		fieldDefinitions.add(new FieldInfo(ADDITIONAL_ACTIVITIES_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_ADDITIONAL_ACTIVITIES), false, true, false));</span>
<span class="nc" id="L80">		fieldDefinitions.add(new FieldInfo(ORGANIZATION_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_ORGANIZATION), true, true, false));</span>
<span class="nc" id="L81">		fieldDefinitions.add(new FieldInfo(DESCRIPTION_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_DESCRIPTION), false, true, true));</span>
		
		// Not defining a table because this is the only one.
<span class="nc" id="L84">		addTableFieldInfo(fieldDefinitions);</span>
<span class="nc" id="L85">	}</span>

	@Override
	protected void parseImport(DataSet dataSet) throws Exception {
<span class="nc" id="L89">		boolean success = true;</span>
<span class="nc" id="L90">		DataTable table = dataSet.getDefaultTable();</span>
		
<span class="nc" id="L92">		Map&lt;String, ShiftEvent&gt; shiftEventsMap = new HashMap&lt;String, ShiftEvent&gt;();</span>
<span class="nc" id="L93">		Collection&lt;ID&gt; orgIds = new ArrayList&lt;ID&gt;();</span>
		
<span class="nc" id="L95">		m_organizationMap = new HashMap&lt;ID, Organization&gt;();</span>
<span class="nc" id="L96">		m_campaignMap = new HashMap&lt;ID, Campaign&gt;();</span>
		
		
<span class="nc" id="L99">		Collection&lt;String&gt; reservedNames = new ArrayList&lt;String&gt;();</span>
		try {
<span class="nc bnc" id="L101" title="All 2 branches missed.">			if(m_isByOrganization) {</span>
<span class="nc" id="L102">				shiftEventsMap = WorkRulesModelHandler.getShiftEventsByOrg(m_context, new ID(m_organizationId));</span>
<span class="nc" id="L103">				orgIds.add(new ID(this.m_organizationId));</span>
<span class="nc" id="L104">				m_organizationMap = WorkRulesModelHandler.getOrgs(m_context, orgIds);</span>
			} else {
<span class="nc" id="L106">				SchedulingPeriod sp = CampaignModelHandler.getSchedulingPeriodByID(m_context, new ID(m_schedulingPeriodId));</span>
				
<span class="nc" id="L108">				Collection&lt;CampaignOrg&gt; orgAssigned = CampaignModelHandler.getCampaignOrgAssignments(m_context, new ID(m_campaignId), sp.getStartTime(), sp.getEndTime());</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">				for(CampaignOrg co : orgAssigned)</span>
				{
<span class="nc" id="L111">					orgIds.add(co.getOrganizationID());</span>
<span class="nc" id="L112">				}</span>
				
<span class="nc" id="L114">				Collection&lt;ShiftEvent&gt; existingShiftEvents = WorkRulesModelHandler.getShiftEventsBySchedulingPeriod(m_context, sp.getID());</span>
<span class="nc" id="L115">				Collection&lt;ShiftEvent&gt; shiftEvents = WorkRulesModelHandler.getShiftEventsBySchedulingPeriodCampaignOnly(m_context, sp.getID());</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">				for(ShiftEvent se : shiftEvents) {</span>
<span class="nc" id="L117">					shiftEventsMap.put(se.getName(), se);</span>
<span class="nc" id="L118">				}</span>
				
<span class="nc bnc" id="L120" title="All 2 branches missed.">				for(ShiftEvent se : existingShiftEvents) {</span>
<span class="nc" id="L121">					reservedNames.add(se.getName());</span>
<span class="nc" id="L122">				}</span>
				
<span class="nc" id="L124">				Collection&lt;ID&gt; campaignIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L125">				campaignIds.add(sp.getCampaignID());</span>
				
<span class="nc" id="L127">				m_campaignMap = WorkRulesModelHandler.getCampaigns(m_context, campaignIds);</span>
			}
<span class="nc" id="L129">		} catch (Exception ex) {</span>
<span class="nc" id="L130">			log.error(ex);</span>
<span class="nc" id="L131">			addPageMessage(Message.ERROR_TYPE,  &quot;Error: &quot; + ex.getMessage());</span>
<span class="nc" id="L132">		}</span>
		
		// Get Activities that are viable for the current selection.
<span class="nc" id="L135">		Collection&lt;Activity&gt; activities = ActivityModelHandler.getActivitiesByActivitySelectionType(getRequestContext(), ActivityModelHandler.ActivitySelectionProperty.UsedInShiftEvent, orgIds);</span>
<span class="nc" id="L136">		Map&lt;String, ID&gt; activityNameIDMap = new HashMap&lt;String, ID&gt;();</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">		for(Activity activity : activities) {</span>
<span class="nc" id="L138">			activityNameIDMap.put(activity.getName(), activity.getID());</span>
<span class="nc" id="L139">		}</span>
		
<span class="nc" id="L141">		Map&lt;String, Activity&gt; activityByNameMap = new HashMap&lt;String, Activity&gt;();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">		for(Activity activity : activities) {</span>
<span class="nc" id="L143">			activityByNameMap.put(activity.getName(), activity);</span>
<span class="nc" id="L144">		}</span>
		
		// Populate a map with reverse look up of name instead of ID.
<span class="nc" id="L147">		Map&lt;String, ID&gt; orgsNameIDMap = new HashMap&lt;String, ID&gt;();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">		for(ID key : m_organizationMap.keySet()) {</span>
<span class="nc" id="L149">			orgsNameIDMap.put(m_organizationMap.get(key).getName(), key);</span>
<span class="nc" id="L150">		}</span>
		
<span class="nc" id="L152">		Collection&lt;ShiftEvent&gt; shiftEventsToUpdate = new ArrayList&lt;ShiftEvent&gt;();</span>
<span class="nc" id="L153">		int shiftEventsCreated = 0;</span>
<span class="nc" id="L154">		int shiftEventsSkipped = 0;</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">		for(DataTableRow row : table.getRows()) {</span>
<span class="nc" id="L156">			boolean hasErrors = false;</span>
<span class="nc" id="L157">			boolean isNew = true;</span>
			
<span class="nc" id="L159">			Object shiftEventName = null;			</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">			if (isChecked(SHIFT_EVENT_FN)) { // REQUIRED</span>
<span class="nc" id="L161">				shiftEventName = row.get(SHIFT_EVENT_FN);</span>
			}
			
<span class="nc" id="L164">			ShiftEvent shiftEvent = null;</span>
			
<span class="nc bnc" id="L166" title="All 2 branches missed.">			if(shiftEventName != null) {</span>
				// Identify the shift to work with.
<span class="nc" id="L168">				shiftEvent = shiftEventsMap.get(shiftEventName);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">				if(shiftEvent != null) {</span>
<span class="nc" id="L170">					isNew = false;</span>
				}
			}
			
			// If not shift is found, create a new shift.
<span class="nc bnc" id="L175" title="All 2 branches missed.">			if(shiftEvent == null) {</span>
				// We now need to check if the name conflicts with 
				// any shift visible by this sp or org, not just the updatable ones.
<span class="nc bnc" id="L178" title="All 2 branches missed.">				if(reservedNames.contains(shiftEventName.toString())) {</span>
<span class="nc" id="L179">					addImportStatusMessage(</span>
<span class="nc" id="L180">							m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_EVENT_IMPORT_NAME_IN_USE, </span>
<span class="nc" id="L181">									new Object[] { shiftEventName.toString() }));</span>
<span class="nc" id="L182">					hasErrors = true;</span>
				}
				
<span class="nc" id="L185">				shiftEvent = new ShiftEvent();</span>
<span class="nc" id="L186">				shiftEvent.setName(shiftEventName.toString());</span>
<span class="nc" id="L187">				isNew = true;</span>
			}
			
			// Activities (REQUIRED) 
<span class="nc bnc" id="L191" title="All 2 branches missed.">			if (isChecked(ACTIVITY_FN)) { // REQUIRED</span>
<span class="nc" id="L192">				Object shiftActivity = row.get(ACTIVITY_FN);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">				if (activityNameIDMap.containsKey(shiftActivity)) {</span>
<span class="nc" id="L194">					shiftEvent.setActivityID(activityNameIDMap.get(shiftActivity));</span>
				} else {
<span class="nc" id="L196">					addImportStatusMessage(</span>
<span class="nc" id="L197">							m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_ACTIVITY,</span>
									new Object[] { shiftEventName, shiftActivity }));
<span class="nc" id="L199">					hasErrors = true;</span>
				}
			}
			
			// Length (default = 5 minutes)
<span class="nc bnc" id="L204" title="All 2 branches missed.">			if (isChecked(LENGTH_FN)) {</span>
<span class="nc" id="L205">				Object shiftEventLength = row.get(LENGTH_FN);				</span>
				try {
<span class="nc" id="L207">					shiftEvent.setDuration(Duration.fromMinutes(parseDurationMinutesFromHHMM(shiftEventLength.toString())));</span>
<span class="nc" id="L208">				} catch (Exception ex) {</span>
<span class="nc" id="L209">					addImportStatusMessage(</span>
<span class="nc" id="L210">							m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_DURATION_FORMAT,</span>
<span class="nc" id="L211">									new Object[] { shiftEventName, String.valueOf(shiftEventLength) })); 					</span>
<span class="nc" id="L212">					hasErrors = true;</span>
<span class="nc" id="L213">				}</span>
<span class="nc" id="L214">			} else {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">				if (isNew) shiftEvent.setDuration(Duration.fromMinutes(5));</span>
			}
			
			// Start Time Type (default = Relative to Shift Start)
<span class="nc" id="L219">			boolean startTimeTypeHasErrors = false;</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">			if (isChecked(START_TIME_TYPE_FN)) {</span>
<span class="nc" id="L221">				Object shiftStartTimeType = row.get(START_TIME_TYPE_FN);</span>
				
<span class="nc bnc" id="L223" title="All 2 branches missed.">				if(!shiftStartTimeType.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_ANY_TIME)) &amp;&amp;</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">				   !shiftStartTimeType.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_RELATIVE_TO_SHIFT_START)) &amp;&amp;</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">				   !shiftStartTimeType.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_ABSOLUTE))) {</span>
<span class="nc" id="L226">					addImportStatusMessage(</span>
<span class="nc" id="L227">							m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_STARTTIME_TYPE,</span>
<span class="nc" id="L228">									new Object[] { shiftEventName, String.valueOf(shiftStartTimeType) })); </span>
<span class="nc" id="L229">					hasErrors = true;</span>
<span class="nc" id="L230">					startTimeTypeHasErrors = true;</span>
				}
<span class="nc" id="L232">				shiftEvent.setIsAnyTime(i18n(m_fsResourceBundle, FsWebBundleKey.FS_ANY_TIME).equalsIgnoreCase(shiftStartTimeType.toString()));</span>
<span class="nc" id="L233">				shiftEvent.setIsCafeteria(i18n(m_fsResourceBundle, FsWebBundleKey.FS_ABSOLUTE).equalsIgnoreCase(shiftStartTimeType.toString()));</span>
			}
			
			// Earliest Start (default = 00:00)
			// Latest Start (default = 00:00)
			// Start Window
<span class="nc bnc" id="L239" title="All 4 branches missed.">			if (isChecked(START_WINDOW_FN) &amp;&amp; !startTimeTypeHasErrors) {</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">				if (!shiftEvent.isAnyTime()) {</span>
					// TODO: Fix the time parsing to be locale, timezone sensitive.
<span class="nc" id="L242">					Object shiftEventWindow = row.get(START_WINDOW_FN);</span>
<span class="nc" id="L243">					String[] timeRangeTokens = shiftEventWindow.toString().split(&quot;-&quot;, -1); // !Magic String				</span>
					try {
<span class="nc bnc" id="L245" title="All 2 branches missed.">						if (shiftEvent.isCafeteria()) { // Absolute</span>
<span class="nc" id="L246">							Date startTime = m_localizer.parseTime(timeRangeTokens[0], RegionalFormatBundleKey.TIME_FORMAT); </span>
<span class="nc" id="L247">							Date endTime = m_localizer.parseTime(timeRangeTokens[1], RegionalFormatBundleKey.TIME_FORMAT); </span>
							
<span class="nc" id="L249">							Calendar c = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L250">							c.setTime(startTime);</span>
<span class="nc" id="L251">							int hour = c.get(Calendar.HOUR_OF_DAY);</span>
<span class="nc" id="L252">							int minutes = c.get(Calendar.MINUTE);</span>
							
<span class="nc" id="L254">							shiftEvent.setStart(hour * 60 + minutes);</span>
							
<span class="nc" id="L256">							c.setTime(endTime);</span>
<span class="nc" id="L257">							hour = c.get(Calendar.HOUR_OF_DAY);</span>
<span class="nc" id="L258">							minutes = c.get(Calendar.MINUTE);</span>
							
<span class="nc" id="L260">							shiftEvent.setEnd(hour * 60 + minutes);</span>
							
<span class="nc" id="L262">						} else {	// Relative so the times are military time hh24:mm without AM/PM.</span>
<span class="nc" id="L263">							String[] startTimeTokens = timeRangeTokens[0].trim().split(&quot;:&quot;, -1);</span>
<span class="nc" id="L264">							int hour = Integer.valueOf(startTimeTokens[0]);</span>
<span class="nc" id="L265">							int minutes = Integer.valueOf(startTimeTokens[1]);</span>
							
<span class="nc" id="L267">							shiftEvent.setStart(hour * 60 + minutes);</span>
							
<span class="nc" id="L269">							String[] endTimeTokens = timeRangeTokens[1].trim().split(&quot;:&quot;, -1);</span>
<span class="nc" id="L270">							hour = Integer.valueOf(endTimeTokens[0]);</span>
<span class="nc" id="L271">							minutes = Integer.valueOf(endTimeTokens[1]);</span>
							
<span class="nc" id="L273">							shiftEvent.setEnd(hour * 60 + minutes);</span>
						}
<span class="nc" id="L275">					} catch (Exception ex) {</span>
<span class="nc" id="L276">						addImportStatusMessage(</span>
<span class="nc" id="L277">								m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_INVALID_SHIFTEVENT_WINDOW_FORMAT,</span>
<span class="nc" id="L278">										new Object[] { shiftEventName, String.valueOf(shiftEventWindow) })); 					</span>
<span class="nc" id="L279">						hasErrors = true;</span>
<span class="nc" id="L280">					}</span>
				}
			}
			
			// Is Paid (default = false)
<span class="nc bnc" id="L285" title="All 2 branches missed.">			if (isChecked(EVENT_PAID_FN)) {</span>
<span class="nc" id="L286">				Object shiftEventIsPaid = row.get(EVENT_PAID_FN);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">				if(shiftEventIsPaid.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_YES))) {</span>
<span class="nc" id="L288">					shiftEvent.setIsPaid(true);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">				} else if (shiftEventIsPaid.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_NO))) {</span>
<span class="nc" id="L290">					shiftEvent.setIsPaid(false);</span>
				} else {
<span class="nc" id="L292">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_ISPAID_FORMAT,</span>
<span class="nc" id="L293">							new Object[] { shiftEventName, String.valueOf(shiftEventIsPaid) }));</span>
<span class="nc" id="L294">					hasErrors = true;</span>
				}
			}
			// Is Flexible (default = false)
<span class="nc bnc" id="L298" title="All 2 branches missed.">			if (isChecked(FLEXIBLE_FN)) {</span>
<span class="nc" id="L299">				Object shiftEventIsFlexible = row.get(FLEXIBLE_FN);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">				if(shiftEventIsFlexible.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_YES))) {</span>
<span class="nc" id="L301">					shiftEvent.setIsFlexible(true);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">				} else if (shiftEventIsFlexible.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_NO))) {</span>
<span class="nc" id="L303">					shiftEvent.setIsFlexible(false);</span>
				} else {
<span class="nc" id="L305">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_ISFLEXIBLE_FORMAT,</span>
<span class="nc" id="L306">							new Object[] { shiftEventName, String.valueOf(shiftEventIsFlexible) }));</span>
<span class="nc" id="L307">					hasErrors = true;</span>
				}			
			}
			
<span class="nc bnc" id="L311" title="All 4 branches missed.">			if(shiftEvent.isPaid() &amp;&amp; shiftEvent.isFlexible()) {</span>
				// Min Count (default = 0)
<span class="nc bnc" id="L313" title="All 2 branches missed.">				if (isChecked(MIN_COUNT_FN)) {</span>
<span class="nc" id="L314">					Object minCount = row.get(MIN_COUNT_FN);</span>
					try {
<span class="nc" id="L316">						shiftEvent.setMinCount(Integer.valueOf(minCount.toString()));</span>
<span class="nc" id="L317">					} catch(Exception ex) {</span>
<span class="nc" id="L318">						addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_MIN_COUNT_FORMAT,</span>
<span class="nc" id="L319">								new Object[] { shiftEventName, String.valueOf(minCount) }));</span>
<span class="nc" id="L320">						hasErrors = true;</span>
<span class="nc" id="L321">					}</span>
				}
				
				// Max Count (default = 0)
<span class="nc bnc" id="L325" title="All 2 branches missed.">				if (isChecked(MAX_COUNT_FN)) {</span>
<span class="nc" id="L326">					Object maxCount = row.get(MAX_COUNT_FN);</span>
					try {
<span class="nc" id="L328">						shiftEvent.setMaxCount(Integer.valueOf(maxCount.toString()));</span>
<span class="nc" id="L329">					} catch(Exception ex) {</span>
<span class="nc" id="L330">						addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_MAX_COUNT_FORMAT,</span>
<span class="nc" id="L331">								new Object[] { shiftEventName, String.valueOf(maxCount) }));</span>
<span class="nc" id="L332">						hasErrors = true;</span>
<span class="nc" id="L333">					}</span>
				}
				
				// min count must be &lt;= max count.
<span class="nc bnc" id="L337" title="All 2 branches missed.">				if(shiftEvent.getMinCount() &gt; shiftEvent.getMaxCount()) {</span>
<span class="nc" id="L338">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_INVALID_MIN_MAX_COUNT,</span>
<span class="nc" id="L339">							new Object[] { shiftEventName, String.valueOf(shiftEvent.getMinCount()), String.valueOf(shiftEvent.getMaxCount()) }));</span>
<span class="nc" id="L340">					hasErrors = true;</span>
				}
			}
			
			// Additional Activities (Only if 'Is Flexible' enabled)
<span class="nc bnc" id="L345" title="All 4 branches missed.">			if(shiftEvent.isPaid() &amp;&amp; shiftEvent.isFlexible()) {</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">				if(isChecked(ADDITIONAL_ACTIVITIES_FN)) {</span>
<span class="nc" id="L347">					Object additionalActivities = row.get(ADDITIONAL_ACTIVITIES_FN);</span>
<span class="nc" id="L348">					String[] activityTokens = additionalActivities.toString().split(&quot;, &quot;, -1);</span>
<span class="nc" id="L349">					Collection&lt;Activity&gt; activitiesToAdd = new ArrayList&lt;Activity&gt;();</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">					for(String activityName : activityTokens) {</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">						if(activityName.trim().length() == 0) continue;</span>
<span class="nc" id="L352">						Activity activity = activityByNameMap.get(activityName);</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">						if (activity == null) {</span>
<span class="nc" id="L354">							addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_ACTIVITY,</span>
<span class="nc" id="L355">									new Object[] { shiftEventName, String.valueOf(activityName) }));</span>
<span class="nc" id="L356">							hasErrors = true;</span>
						} else {
<span class="nc" id="L358">							activitiesToAdd.add(activity);</span>
						}
					}
<span class="nc" id="L361">					shiftEvent.removeAdditionalActivities(shiftEvent.getAdditionalActivities());</span>
<span class="nc" id="L362">					shiftEvent.addAdditionalActivities(activitiesToAdd);</span>
				}
			}
			
			// Organization
<span class="nc bnc" id="L367" title="All 2 branches missed.">			if (isChecked(ORGANIZATION_FN)) { // REQUIRED </span>
<span class="nc" id="L368">				Object organization = row.get(ORGANIZATION_FN);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">				if(organization.toString().trim().length() == 0) {</span>
<span class="nc" id="L370">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_ORGANIZATION,</span>
<span class="nc" id="L371">							new Object[] { shiftEventName, String.valueOf(organization) }));</span>
				}
				else {
<span class="nc bnc" id="L374" title="All 2 branches missed.">					if(organization.toString().toLowerCase().compareTo(i18n(m_fsResourceBundle, FsWebBundleKey.LOCAL).toLowerCase()) == 0) {	// ! magic string.</span>
<span class="nc" id="L375">						shiftEvent.setOrganizationID(null);</span>
<span class="nc" id="L376">						shiftEvent.setCampaignID(new ID(m_campaignId));</span>
					} else {
<span class="nc" id="L378">						ID lookupOrg = orgsNameIDMap.get(organization.toString());				</span>
<span class="nc bnc" id="L379" title="All 4 branches missed.">						if(lookupOrg == null || !lookupOrg.equals(new ID(m_organizationId))) {</span>
<span class="nc" id="L380">							addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_ORGANIZATION,</span>
<span class="nc" id="L381">									new Object[] { shiftEventName, String.valueOf(organization) }));</span>
<span class="nc" id="L382">							hasErrors = true;</span>
						} else {
<span class="nc" id="L384">							shiftEvent.setCampaignID(null);</span>
<span class="nc" id="L385">							shiftEvent.setOrganizationID(lookupOrg);</span>
						}
					}
				}
			}
			
			// Description (default = '')
<span class="nc bnc" id="L392" title="All 2 branches missed.">			if (isChecked(DESCRIPTION_FN)) {</span>
<span class="nc" id="L393">				Object description = row.get(DESCRIPTION_FN);</span>
<span class="nc" id="L394">				shiftEvent.setDescription(description.toString());</span>
			}
			
<span class="nc" id="L397">			List&lt;Message&gt; shiftEventValidationResults = ShiftUtil.validateShiftEvent(m_localizer, shiftEvent);</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">			for(Message m : shiftEventValidationResults) {</span>
<span class="nc" id="L399">				addImportStatusMessage(m.getLocalizedMessage(m_localizer));</span>
<span class="nc" id="L400">			}</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">			if(shiftEventValidationResults.size() &gt; 0) hasErrors = true;</span>
			
<span class="nc bnc" id="L403" title="All 2 branches missed.">			if(!hasErrors) {</span>
<span class="nc bnc" id="L404" title="All 6 branches missed.">				if (isNew &amp;&amp; (m_importBehavior.compareTo(IMPORT_BEHAVIOR_ADD_UPDATE) == 0 || m_importBehavior.compareTo(IMPORT_BEHAVIOR_ADD_ONLY) == 0)) {</span>
<span class="nc" id="L405">					shiftEvent = WorkRulesModelHandler.createShiftEvent(m_context, shiftEvent);</span>
<span class="nc" id="L406">					shiftEventsCreated++;</span>
<span class="nc" id="L407">					shiftEventsMap.put(shiftEvent.getName(), shiftEvent);</span>
<span class="nc bnc" id="L408" title="All 6 branches missed.">				} else if (!isNew  &amp;&amp; (m_importBehavior.compareTo(IMPORT_BEHAVIOR_ADD_UPDATE) == 0 || m_importBehavior.compareTo(IMPORT_BEHAVIOR_UPDATE_ONLY) == 0)) {</span>
					// See if the shift event was already added, only update the last shift event encountered if duplicates exist.
<span class="nc" id="L410">					Iterator&lt;ShiftEvent&gt; iter = shiftEventsToUpdate.iterator();</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">				 	if(iter != null) {</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">						while (iter.hasNext()) {</span>
<span class="nc" id="L413">							ShiftEvent s = iter.next();</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">							if (s.getName().compareToIgnoreCase(shiftEvent.getName()) == 0) {</span>
<span class="nc" id="L415">								iter.remove(); // remove this copy, there is a later entry for this shift in the file.</span>
							}
<span class="nc" id="L417">						}</span>
				 	}
<span class="nc" id="L419">					shiftEventsToUpdate.add(shiftEvent);</span>
<span class="nc" id="L420">				}</span>
			} else {
<span class="nc" id="L422">				shiftEventsSkipped++;</span>
			}
<span class="nc" id="L424">		}</span>
		
<span class="nc bnc" id="L426" title="All 4 branches missed.">		if (m_importBehavior.compareTo(IMPORT_BEHAVIOR_ADD_UPDATE) == 0 || m_importBehavior.compareTo(IMPORT_BEHAVIOR_UPDATE_ONLY) == 0) {</span>
<span class="nc" id="L427">			WorkRulesModelHandler.updateShiftEvents(m_context, shiftEventsToUpdate);</span>
		}
		
<span class="nc bnc" id="L430" title="All 2 branches missed.">		if(m_importStatusMessages.size() &gt; 0){</span>
<span class="nc" id="L431">			addPageMessage(new Message(Message.WARNING_TYPE, FsWebBundleKey.FS_IMPORT_FAILURE_MESSAGE, </span>
					FsWebBundleKey.BUNDLE_NAME, 
					new String[] { 
<span class="nc" id="L434">						String.valueOf(i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_EVENT)),</span>
<span class="nc" id="L435">						String.valueOf(shiftEventsCreated), </span>
<span class="nc" id="L436">						String.valueOf(shiftEventsToUpdate.size()), </span>
<span class="nc" id="L437">						String.valueOf(shiftEventsSkipped) </span>
					}));
		} else {
<span class="nc" id="L440">			addPageMessage(new Message(Message.INFO_TYPE, FsWebBundleKey.FS_IMPORT_SUCCESS_MESSAGE,</span>
					FsWebBundleKey.BUNDLE_NAME,
					new String[] {
<span class="nc" id="L443">						String.valueOf(i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_EVENT)),	</span>
<span class="nc" id="L444">						String.valueOf(shiftEventsCreated),</span>
<span class="nc" id="L445">						String.valueOf(shiftEventsToUpdate.size())</span>
					}));
		}
<span class="nc bnc" id="L448" title="All 2 branches missed.">		if (success) { </span>
<span class="nc" id="L449">			setPageAction(SUCCESS);</span>
		}
<span class="nc" id="L451">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>