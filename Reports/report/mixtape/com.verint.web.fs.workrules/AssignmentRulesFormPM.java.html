<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AssignmentRulesFormPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">AssignmentRulesFormPM.java</span></div><h1>AssignmentRulesFormPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.base.BPException;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkUnit;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkUnit.WorkUnitType;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager.AssignmentRuleValidationError;
import com.bluepumpkin.ejb.bbm.workrules.model.CalendarPeriod.CalendarUnit;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.l10n.FsWebLogBundleKey;
import com.verint.web.fs.widgets.IntegerDropDownSelection;
import com.verint.web.fs.workrules.assignmentrules.Response;
import com.verint.web.fs.workrules.assignmentrules.ResponseParam;
import com.verint.web.fs.workrules.assignmentrules.question.DefaultQuestionDataProvider;
import com.verint.web.fs.workrules.assignmentrules.question.Question;
import com.verint.web.fs.workrules.assignmentrules.question.QuestionFactory;
import com.verint.web.fs.workrules.assignmentrules.question.QuestionType;
import com.verint.web.fs.workrules.assignmentrules.question.RuleTypeQuestion.RuleTypeResponseType;
import com.verint.web.fs.workrules.assignmentrules.ui.ARParamPCUtil;
import com.verint.web.fs.workrules.assignmentrules.ui.QuestionI18N;
import com.verint.web.fs.workrules.assignmentrules.ui.QuestionI18NFactory;
import com.verint.web.fs.workrules.assignmentrules.ui.QuestionPC;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.CommonWebBundleKey;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpaneFieldNames;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;

@SuppressWarnings(&quot;serial&quot;)
public class AssignmentRulesFormPM extends WorkRulesFormPM {

    private boolean b_isLastQuestion;
<span class="fc" id="L62">	private int previousQuestionIndex = 0;</span>
	private static final String FN_NAME = &quot;ar_name&quot;;
	private static final String FN_QUESTIONLIST = &quot;questionListStr&quot;;

	private ComplexWorkRule data_assignmentRule;
<span class="fc" id="L67">	private List&lt;String&gt; data_answeredQuestionNames = new ArrayList&lt;String&gt;();</span>
	
	/**
	 * Since the page may be re-submitted before a save, this request param will be used
	 * to keep track of the original page action.
	 */
	private static final String FN_ORIGINAL_ACTION = &quot;originalPageAction&quot;;

	private FormTwoColumnPC pc_form;
	private FormInputPC pc_name;
	private Organization data_org;
	private IntegerDropDownSelection pc_priority;
	private DefaultQuestionDataProvider m_dataProvider;
<span class="fc" id="L80">	private ArrayList&lt;Question&gt; data_questionsToAsk = new ArrayList&lt;Question&gt;();</span>
	private RuleTypeResponseType data_ruleType;

<span class="fc" id="L83">	private static HashSet&lt;RuleTypeResponseType&gt; ruleTypesWithoutPriority = new HashSet&lt;RuleTypeResponseType&gt;();</span>
	static {
<span class="fc" id="L85">		ruleTypesWithoutPriority.add(RuleTypeResponseType.Team);</span>
<span class="fc" id="L86">		ruleTypesWithoutPriority.add(RuleTypeResponseType.Start);</span>
<span class="fc" id="L87">	}</span>

	public AssignmentRulesFormPM(RequestContext context) {
<span class="fc" id="L90">		super(context);</span>
<span class="fc" id="L91">		optimizationTargetTimeZone = null;</span>
<span class="fc" id="L92">	}</span>

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc bfc" id="L96" title="All 2 branches covered.">		if (!isPostBack()) {</span>
			// If this is a NEW or EDIT request, only extract the basics.
			// This helps with page revert, which is currently implemented as
			// resubmitting the original page action.
<span class="fc" id="L100">			extractParameters(request, WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN);</span>
<span class="fc" id="L101">			extractParameters(request, WorkpaneFieldNames.SELECTED_ID_FN);</span>
<span class="fc" id="L102">			return true;</span>
		}

<span class="fc" id="L105">		String qlStr = request.getParameter(FN_QUESTIONLIST);</span>
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(qlStr)) {</span>
<span class="fc" id="L107">			data_answeredQuestionNames.addAll(Arrays.asList(qlStr.split(&quot;,&quot;)));</span>
		}
<span class="fc" id="L109">		return super.extractParameters(request);</span>
	}

<span class="fc" id="L112">	boolean pageActionExtracted = false;</span>
	public boolean isPostBack() {
<span class="fc bfc" id="L114" title="All 2 branches covered.">		if (!pageActionExtracted) {</span>
<span class="fc" id="L115">			extractParameters(m_context.getRequest(), PageAction.PAGE_ACTION);</span>
<span class="fc" id="L116">			pageActionExtracted = true;</span>
		}
<span class="pc bpc" id="L118" title="1 of 4 branches missed.">		return !isAction(PageAction.ADD) &amp;&amp; !isAction(PageAction.EDIT);</span>
	}

	@Override
	protected void loadData() throws Exception {
<span class="fc" id="L123">		super.loadData();</span>

<span class="fc" id="L125">		ID orgID = getSelectedIDObject();</span>
<span class="fc" id="L126">		data_org = WorkRulesModelHandler.getOrgs(m_context, Collections.singleton(orgID)).values().iterator().next();</span>

<span class="pc bpc" id="L128" title="1 of 2 branches missed.">		if (getPerformActionOnIDSize() &gt; 0) {</span>
<span class="nc" id="L129">			data_assignmentRule = WorkRulesModelHandler</span>
<span class="nc" id="L130">					.getComplexWorkRulesByIDs(m_context, getPerfromActionOnIDsAsCollection())</span>
<span class="nc" id="L131">					.iterator()</span>
<span class="nc" id="L132">					.next();</span>
		}

<span class="fc" id="L135">		determineAnsweredQuestions();</span>
<span class="fc" id="L136">	}</span>

	private void determineAnsweredQuestions() throws BPException {
<span class="fc" id="L139">		Map&lt;ID, String&gt; shiftIDNameMapPerOrg = WorkRulesModelHandler.getShiftIDNameListByOrg(m_context,	data_org.getID());</span>
<span class="fc" id="L140">		m_dataProvider = new DefaultQuestionDataProvider(m_context, data_org, data_assignmentRule, shiftIDNameMapPerOrg);</span>

<span class="fc" id="L142">		data_questionsToAsk = new ArrayList&lt;Question&gt;();</span>

<span class="fc bfc" id="L144" title="All 2 branches covered.">		if (data_answeredQuestionNames.size() &gt; 0) {</span>
<span class="fc" id="L145">			Question nextExpectedQuestion = QuestionFactory.getNextQuestion(m_dataProvider);</span>
			// Get questions that have been answered already on this page
<span class="fc" id="L147">			Iterator&lt;String&gt; answeredQuestionTypeIter = data_answeredQuestionNames.iterator();</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">			while (nextExpectedQuestion != null) {</span>
<span class="fc" id="L149">				QuestionType questionType = null;</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">				if (answeredQuestionTypeIter.hasNext()) questionType = QuestionType.valueOf(answeredQuestionTypeIter.next());</span>
				// If the user answered a question that doesn't match the next expected question, break;
<span class="pc bpc" id="L152" title="1 of 4 branches missed.">				if (nextExpectedQuestion == null || !nextExpectedQuestion.getQuestionType().equals(questionType))</span>
<span class="fc" id="L153">					break;</span>

				// Otherwise, record the answer in the data provider and get the next expected question
<span class="fc" id="L156">				Response answer = getSubmittedAnswer(nextExpectedQuestion);</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">				if (answer != null) {</span>
<span class="fc" id="L158">					data_questionsToAsk.add(nextExpectedQuestion);</span>
<span class="fc" id="L159">					m_dataProvider.setAnswer(questionType, answer);</span>
<span class="fc" id="L160">					nextExpectedQuestion = QuestionFactory.getNextQuestion(m_dataProvider);</span>
				} else break;
<span class="fc" id="L162">			}</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">		} else if (data_assignmentRule != null) {</span>
<span class="nc" id="L164">			int questionCount = 0;</span>
			// if the user hasn't answered any questions yet, initialize the questions from the Assignment Rule
<span class="nc" id="L166">			Question q = QuestionFactory.getNextQuestion(m_dataProvider);</span>
<span class="nc bnc" id="L167" title="All 4 branches missed.">			while (q != null &amp;&amp; q.getInitialAnswer() != null) {</span>
<span class="nc" id="L168">				data_questionsToAsk.add(q);</span>
<span class="nc" id="L169">				m_dataProvider.setAnswer(q.getQuestionType(), q.getInitialAnswer());</span>
<span class="nc" id="L170">				q = QuestionFactory.getNextQuestion(m_dataProvider);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">				if (questionCount++ &gt;= 100) {</span>
<span class="nc" id="L172">					throw new IllegalStateException(&quot;Infinite Loop detected determining Assignment Rules questions&quot;);</span>
				}
			}
		}
		// set the index of the previous question
<span class="fc" id="L177">		previousQuestionIndex = data_questionsToAsk.size();</span>

		// Now add the next question
<span class="fc" id="L180">		Question nextQuestion = QuestionFactory.getNextQuestion(m_dataProvider);</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">        b_isLastQuestion = (nextQuestion == null);</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">		while (nextQuestion != null) {</span>
<span class="fc" id="L183">			data_questionsToAsk.add(nextQuestion);</span>
			// For Questions with only one response, auto select it.
<span class="fc bfc" id="L185" title="All 2 branches covered.">			if (nextQuestion.getResponses().size() == 1) {</span>
<span class="fc" id="L186">				m_dataProvider.setAnswer(nextQuestion.getQuestionType(), nextQuestion.getResponses().iterator().next());</span>
<span class="fc" id="L187">				nextQuestion = QuestionFactory.getNextQuestion(m_dataProvider);</span>
                // record whether we're on the last question for the current path
<span class="fc bfc" id="L189" title="All 2 branches covered.">                b_isLastQuestion = (nextQuestion == null);</span>
			} else {
                // record whether we're on the last question for the current path
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">                b_isLastQuestion = (QuestionFactory.getNextQuestion(m_dataProvider) == null);</span>
<span class="fc" id="L193">				break;</span>
			}
		}

<span class="fc" id="L197">		data_ruleType = m_dataProvider.getRuleType();</span>
<span class="fc" id="L198">	}</span>

	private Response getSubmittedAnswer(Question question) throws BPException {
<span class="fc" id="L201">		return getPC(question).getAnswer();</span>
	}

	private QuestionPC getPC(Question questionToAsk) throws BbmException {
		// If the user manually answered any questions, do not auto-select answers from the assignment rule.
<span class="fc bfc" id="L206" title="All 2 branches covered.">		boolean ignoreAnswersFromAssignmentRule = data_answeredQuestionNames.size() &gt; 0;</span>
<span class="fc" id="L207">		QuestionPC pc = new QuestionPC(m_context, data_org.getID(), getName() + &quot;_&quot;</span>
<span class="fc" id="L208">				+ questionToAsk.getQuestionType().name(), questionToAsk, ignoreAnswersFromAssignmentRule);</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">		if (isPostBack()) {</span>
<span class="fc" id="L210">			pc.extractParameters(m_context.getRequest());</span>
		}
<span class="fc" id="L212">		return pc;</span>
	}

	@Override
	protected void initContentTitle() {
<span class="fc" id="L217">		super.initContentTitle();</span>
<span class="fc" id="L218">		m_contentTitlePC.setPageTitle(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ASSIGNMENT_RULES));</span>
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">		if (data_assignmentRule != null)</span>
<span class="nc" id="L220">			m_contentTitlePC.setItemName(data_assignmentRule.getName());</span>
<span class="fc" id="L221">	}</span>

	@Override
	protected void initForm() {
<span class="fc" id="L225">		pc_form = new FormTwoColumnPC(m_context);</span>
<span class="fc" id="L226">		setForm(pc_form);</span>

<span class="fc" id="L228">		ComplexWorkRule assignmentRule = new ComplexWorkRule();</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">		if (data_assignmentRule != null)</span>
<span class="nc" id="L230">			assignmentRule = data_assignmentRule;</span>

		// Name Input
<span class="fc" id="L233">		pc_name = new FormInputPC(m_context);</span>
<span class="fc" id="L234">		pc_name.reset(FN_NAME, assignmentRule.getName(), FormInputPC.TYPE_STRING, true);</span>
<span class="fc" id="L235">		pc_name.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L236">		pc_name.setAllowAllChars(false);</span>
<span class="fc" id="L237">		pc_name.setMaxLength(50);</span>
<span class="fc" id="L238">		pc_name.setInputFieldDesc(UIFWebBundleKey.NAME, UIFWebBundleKey.BUNDLE_NAME);</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">		if (m_context.getRequest().getParameter(FN_NAME) != null) {</span>
<span class="fc" id="L240">			pc_name.setInputValue(m_context.getRequest().getParameter(FN_NAME));</span>
		}
<span class="fc" id="L242">		this.addChildComponent(pc_name);</span>
<span class="fc" id="L243">		pc_form.addRow(i18n(m_common_bundle, UIFWebBundleKey.NAME), pc_name);</span>

		// Organization
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">		pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_ORGANIZATION), data_org == null ? &quot;&quot; : data_org.getName());</span>

		// Priority
<span class="fc" id="L249">		boolean enablePriority = true;</span>
<span class="pc bpc" id="L250" title="1 of 6 branches missed.">		if (m_dataProvider != null &amp;&amp; data_ruleType != null &amp;&amp; ruleTypesWithoutPriority.contains(data_ruleType)) {</span>
<span class="fc" id="L251">			enablePriority = false;</span>
		}
<span class="fc" id="L253">		pc_priority = new IntegerDropDownSelection(</span>
				m_context,
				&quot;priority&quot;,
				1,
				9,
<span class="fc" id="L258">				new int[] { assignmentRule.getPriority() });</span>
<span class="fc" id="L259">		pc_priority.setEnabled(enablePriority);</span>
<span class="fc" id="L260">		pc_priority.extractParameters(m_context.getRequest());</span>
<span class="fc" id="L261">		this.addChildComponent(pc_priority);</span>
<span class="fc" id="L262">		pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_PRIORITY), pc_priority);</span>

		try {
<span class="fc" id="L265">			int ctr = 1;</span>
			// Make PC's for each question to ask
<span class="fc bfc" id="L267" title="All 2 branches covered.">			for (Question questionToAsk : data_questionsToAsk) {</span>
<span class="fc" id="L268">				QuestionPC pc = getPC(questionToAsk);</span>
<span class="fc" id="L269">				this.addChildComponent(pc);</span>
<span class="fc" id="L270">				CollapsibleContainerPC collapsePC = new CollapsibleContainerPC(m_context) {</span>
					@Override public String getToggleJSMethodname() {
<span class="fc" id="L272">						return super.getToggleJSMethodname();</span>
					}
				};
<span class="fc" id="L275">				collapsePC.setName(&quot;questionContainer&quot; + ctr);</span>
<span class="fc" id="L276">				collapsePC.addComponent(pc);</span>
<span class="fc" id="L277">				collapsePC.setTitle(pc.getText());</span>
<span class="fc" id="L278">				String oldStyle = collapsePC.getStyleClass();</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">				if (oldStyle == null) oldStyle = &quot;&quot;;</span>
<span class="fc" id="L280">				collapsePC.setStyleClass(&quot;tblRowNoPaddn &quot; + oldStyle);</span>
<span class="fc" id="L281">				collapsePC.setIsBorderEnabled(true);</span>
				// Collapse the container if the question has been answered. However, if there is only a single
				// response with a parameterized value, leave it expanded. This is because questions with single 
				// options are auto selected.  Keeping the previously answered question uncollapsed for quick
				// editing purposes.
<span class="fc bfc" id="L286" title="All 2 branches covered.">				if (pc.getAnswer() != null &amp;&amp;</span>
<span class="pc bpc" id="L287" title="1 of 6 branches missed.">					(questionToAsk.getResponses().size() &gt; 1 || questionToAsk.getResponses().iterator().next().getResponseParameters().isEmpty()) &amp;&amp;</span>
					ctr &lt; previousQuestionIndex) {
<span class="fc" id="L289">					collapsePC.setCollapsed(true);</span>
				}

<span class="fc bfc" id="L292" title="All 2 branches covered.">				if (pc.getAnswer() != null) {</span>
<span class="fc" id="L293">					collapsePC.setTitle(getResponseText(questionToAsk, pc));</span>
				}
<span class="fc" id="L295">				this.addChildComponent(collapsePC);</span>
<span class="fc" id="L296">				this.addForm(collapsePC);</span>
<span class="fc" id="L297">				ctr++;</span>
<span class="fc" id="L298">            }</span>
<span class="nc" id="L299">		} catch (BbmException e) {</span>
<span class="nc" id="L300">			this.handleUnableToLoadDataError(log, e);</span>
<span class="fc" id="L301">		}</span>
        // if the current question is not the last one in the list, hide the Save button
<span class="fc bfc" id="L303" title="All 2 branches covered.">        if (!b_isLastQuestion) {</span>
<span class="fc" id="L304">            m_isSaveButtonShown = false;</span>
        }
		// otherwise show the Save button
		else {
<span class="fc" id="L308">            m_isSaveButtonShown = true;</span>
		}
                    
		// Fill in the hidden input of questions on this page
<span class="fc" id="L312">		List&lt;String&gt; questionIDs = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">		for (Question question : data_questionsToAsk) {</span>
<span class="fc" id="L314">			questionIDs.add(question.getQuestionType().name());</span>
<span class="fc" id="L315">		}</span>
<span class="fc" id="L316">		addGenericHTML(HtmlUtil.makeHiddenInput(FN_QUESTIONLIST, StringUtil.join(questionIDs, &quot;,&quot;)));</span>
		
		// Keep submitting the original page action for form revert
<span class="fc" id="L319">		String originalPageAction = m_context.getParameter(FN_ORIGINAL_ACTION);</span>
<span class="fc bfc" id="L320" title="All 2 branches covered.">		if (StringUtil.isEmpty(originalPageAction)) {</span>
<span class="fc" id="L321">			originalPageAction = getPageAction();</span>
		}
		
<span class="fc" id="L324">		addGenericHTML(HtmlUtil.makeHiddenInput(FN_ORIGINAL_ACTION, originalPageAction));</span>
		
		//We need to escape originalPageAction because it is used in dynamic JS creation below, and is a parameter sent
		//from the client.  Leaving it unescaped is a XSS vulnerability.
<span class="fc" id="L328">		originalPageAction = JSUtil.createStringLiteral(originalPageAction);</span>
<span class="fc" id="L329">		addGenericHTML(&quot;&lt;script&gt;resetJSArray[resetJSArray.length] = &quot; + JSUtil.createStringLiteral(</span>
<span class="fc" id="L330">				getMediatorRef() + &quot;.refreshPageWithAction(&quot; + originalPageAction + &quot;, true);&quot;) + &quot;&lt;/script&gt;&quot;);</span>
<span class="fc" id="L331">	}</span>
	
	private String getResponseText(Question question, QuestionPC qPC) {
<span class="fc" id="L334">		QuestionI18N i18n = QuestionI18NFactory.getI18NInfo(question.getQuestionType());</span>
<span class="fc" id="L335">		List&lt;String&gt; paramValues = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L336">		Response selectedAnswer = qPC.getAnswer();</span>
<span class="pc bpc" id="L337" title="1 of 2 branches missed.">		if (selectedAnswer != null) {</span>
<span class="fc bfc" id="L338" title="All 2 branches covered.">			for (ResponseParam param : selectedAnswer.getResponseParameters()) {</span>
<span class="fc" id="L339">				paramValues.add(ARParamPCUtil.getLocalizedParameterValue(m_context.getLocalizer(), param));</span>
<span class="fc" id="L340">			}</span>
<span class="fc" id="L341">			return i18n.getResponseText(m_localizer, selectedAnswer, paramValues.toArray());</span>
		}
<span class="nc" id="L343">		return &quot;&quot;;</span>
	}

	public static AssignmentRulesFormPM getInstance(RequestContext context) {
<span class="fc" id="L347">		return (AssignmentRulesFormPM) PageModel.getInstance(context, AssignmentRulesFormPM.class);</span>
	}

	public ComplexWorkRule getAssignmentRule() throws BPException {
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">		if (data_assignmentRule == null) {</span>
<span class="fc" id="L352">			data_assignmentRule = new ComplexWorkRule();</span>
		}

<span class="pc bpc" id="L355" title="1 of 2 branches missed.">		data_assignmentRule.setName(pc_name.getInputValue() != null ? pc_name.getInputValue().trim() : null);</span>
<span class="fc" id="L356">		data_assignmentRule.setOrganizationID(data_org.getID());</span>
<span class="fc" id="L357">		data_assignmentRule.setPriority(pc_priority.getSelection().shortValue());</span>

<span class="fc bfc" id="L359" title="All 2 branches covered.">		for (Question question : data_questionsToAsk) {</span>
<span class="fc" id="L360">			Response response = getSubmittedAnswer(question);</span>
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">			if (response == null) {</span>
<span class="nc" id="L362">				QuestionI18N qi18n = QuestionI18NFactory.getI18NInfo(question.getQuestionType());</span>
<span class="nc" id="L363">				this.addPageMessage(new Message(Message.ERROR_TYPE, m_localizer.i18n(</span>
						FsWebBundleKey.BUNDLE_NAME,
						FsWebBundleKey.ASSIGNMENT_RULE_ERROR_QUESTION_NOT_ANSWERED,
<span class="nc" id="L366">						qi18n.getQuestionText(m_localizer, question))));</span>
<span class="nc" id="L367">				return null;</span>
			}
<span class="fc" id="L369">			question.applyAnswer(response, data_assignmentRule);</span>
<span class="fc" id="L370">		}</span>
<span class="fc" id="L371">		return data_assignmentRule;</span>
	}

	public void addErrorMessages(Collection&lt;Pair&lt;AssignmentRuleValidationError, List&lt;?&gt;&gt;&gt; errors) {
<span class="nc" id="L375">		errors = new LinkedHashSet&lt;Pair&lt;AssignmentRuleValidationError, List&lt;?&gt;&gt;&gt;(errors);</span>

<span class="nc" id="L377">		Iterator&lt;Pair&lt;AssignmentRuleValidationError, List&lt;?&gt;&gt;&gt; iter = errors.iterator();</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L379">			Pair&lt;AssignmentRuleValidationError, List&lt;?&gt;&gt; entry = iter.next();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">			int messageType = entry.getFirst().isWarning() ? Message.WARNING_TYPE : Message.ERROR_TYPE;</span>
<span class="nc bnc" id="L381" title="All 6 branches missed.">			switch (entry.getFirst()) {</span>
			case NameMustBeUnique:
<span class="nc" id="L383">				addPageMessage(messageType, FsWebBundleKey.OBJECT_NAME_MUST_BE_UNIQUE, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L384">				iter.remove();</span>
<span class="nc" id="L385">				break;</span>
			case AlignmentDateBoundaryMismatch:
			case AlignmentDateBoundaryMismatchWarning:
<span class="nc" id="L388">				addPageMessage(</span>
						messageType,
						FsWebBundleKey.ASSIGNMENT_RULE_ERROR_ALIGNMENT_DATE_MISMATCH,
						FsWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L392">				iter.remove();</span>
<span class="nc" id="L393">				break;</span>
			case UnsatisfiedRule:
			case RedundantRule: {
<span class="nc" id="L396">				String messageKey = &quot;&quot;;</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">				if (entry.getFirst() == AssignmentRuleValidationError.UnsatisfiedRule)</span>
<span class="nc" id="L398">					messageKey = FsWebBundleKey.ASSIGNMENT_RULE_ERROR_UNSATISFIED_RULE;</span>
				else
<span class="nc" id="L400">					messageKey = FsWebBundleKey.ASSIGNMENT_RULE_ERROR_REDUNDANT_RULE;</span>

				// UnsatisfiedRule(Integer.class, WorkUnit.class, Integer.class, CalendarUnit.class)
				// &quot;%1!i! %2 cannot fit into %3!i! %4, therefore this rule can never be satisfied.&quot;
				//
				// RedundantRule(Integer.class, WorkUnit.class, Integer.class, CalendarUnit.class)
				// &quot;more than %1!i! %2 cannot fit into %3!i! %4, therefore this rule is redundant.&quot;

<span class="nc" id="L408">				Iterator&lt;?&gt; paramObjectIter = entry.getSecond().iterator();</span>
<span class="nc" id="L409">				Integer wuCount = (Integer) paramObjectIter.next();</span>
<span class="nc" id="L410">				WorkUnit wu = (WorkUnit) paramObjectIter.next();</span>
<span class="nc" id="L411">				Integer cuCount = (Integer) paramObjectIter.next();</span>
<span class="nc" id="L412">				CalendarUnit cu = (CalendarUnit) paramObjectIter.next();</span>
<span class="nc" id="L413">				String[] messageArgs = new String[] { wuCount.toString(), localizeWorkUnitType(wu.getWorkUnitType()),</span>
<span class="nc" id="L414">						cuCount.toString(), localizeCalendarUnit(cu) };</span>
<span class="nc" id="L415">				addPageMessage(messageType, messageKey, FsWebBundleKey.BUNDLE_NAME, messageArgs);</span>
<span class="nc" id="L416">				iter.remove();</span>
<span class="nc" id="L417">				break;</span>
			}
			case EndDateNotAfterStart: {
<span class="nc" id="L420">				addPageMessage(messageType, FsWebBundleKey.ASSIGNMENT_RULE_ERROR_END_DATE_NOT_AFTER_START, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L421">				break;</span>
			}
			case CalendarPeriodTooLong: {
<span class="nc" id="L424">				addPageMessage(messageType, FsWebBundleKey.ASSIGNMENT_RULE_ERROR_CALENDAR_PERIOD_TOO_LONG, FsWebBundleKey.BUNDLE_NAME);</span>
				break;
			}
			}
<span class="nc" id="L428">		}</span>

		// Any other errors should have been caught by the client-side validation, so just log them and give a
		// generic message.
<span class="nc bnc" id="L432" title="All 2 branches missed.">		if (errors.size() &gt; 0) {</span>
<span class="nc" id="L433">			log.error(m_localizer.i18n(</span>
					FsWebLogBundleKey.BUNDLE_NAME,
					FsWebLogBundleKey.ERROR_VALIDATING,
<span class="nc" id="L436">					new Object[] { StringUtil.join(errors, &quot;, &quot;) }));</span>
<span class="nc" id="L437">			addPageMessage(Message.ERROR_TYPE, CommonWebBundleKey.UNABLE_TO_UPDATE_INFO, CommonWebBundleKey.BUNDLE_NAME);</span>
		}

<span class="nc" id="L440">	}</span>

	private String localizeCalendarUnit(CalendarUnit cu) {
<span class="nc" id="L443">		String messageKey = null;</span>
<span class="nc bnc" id="L444" title="All 10 branches missed.">		switch (cu) {</span>
		case Day:
<span class="nc" id="L446">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_CU_DAYS;</span>
<span class="nc" id="L447">			break;</span>
		case Month:
<span class="nc" id="L449">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_CU_MONTHS;</span>
<span class="nc" id="L450">			break;</span>
		case Month28Day:
<span class="nc" id="L452">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_CU_28_DAY_MONTHS;</span>
<span class="nc" id="L453">			break;</span>
		case Month29Day:
<span class="nc" id="L455">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_CU_29_DAY_MONTHS;</span>
<span class="nc" id="L456">			break;</span>
		case Month30Day:
<span class="nc" id="L458">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_CU_30_DAY_MONTHS;</span>
<span class="nc" id="L459">			break;</span>
		case Month31Day:
<span class="nc" id="L461">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_CU_31_DAY_MONTHS;</span>
<span class="nc" id="L462">			break;</span>
		case Week:
<span class="nc" id="L464">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_CU_WEEKS;</span>
<span class="nc" id="L465">			break;</span>
		case RollingWeek:
<span class="nc" id="L467">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_CU_ROLLING_WEEKS;</span>
<span class="nc" id="L468">			break;</span>
		case Year:
<span class="nc" id="L470">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_CU_YEARS;</span>
<span class="nc" id="L471">			break;</span>
		default:
<span class="nc" id="L473">			throw new IllegalArgumentException(&quot;Unknown value of &quot; + cu);</span>
		}
<span class="nc" id="L475">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, messageKey);</span>
	}

	private String localizeWorkUnitType(WorkUnitType wut) {
<span class="nc" id="L479">		String messageKey = null;</span>
<span class="nc bnc" id="L480" title="All 15 branches missed.">		switch (wut) {</span>
		case Activity:
<span class="nc" id="L482">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WU_ACTIVITY;</span>
<span class="nc" id="L483">			break;</span>
		case AnyDay:
<span class="nc" id="L485">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WORK_UNIT_DAY;</span>
<span class="nc" id="L486">			break;</span>
		case ConsecutiveDay:
		case ConsecutiveDayOff:
<span class="nc" id="L489">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WORK_UNIT_CONSECUTIVE_DAY;</span>
<span class="nc" id="L490">			break;</span>
		case ConsecutiveDayOfWeek:
		case ConsecutiveDayOfWeekOff:
<span class="nc" id="L493">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WU_CONSECUTIVE_DAY_OF_WEEK;</span>
<span class="nc" id="L494">			break;</span>
		case ConsecutiveFullWeekend:
		case ConsecutiveFullWeekendOff:
<span class="nc" id="L497">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WORK_UNIT_CONSECUTIVE_FULL_WEEKEND;</span>
<span class="nc" id="L498">			break;</span>
		case ConsecutivePartialWeekend:
		case ConsecutivePartialWeekendOff:
<span class="nc" id="L501">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WORK_UNIT_CONSECUTIVE_PARTIAL_WEEKEND;</span>
<span class="nc" id="L502">			break;</span>
		case DayOfWeek:
<span class="nc" id="L504">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WU_DAY_OF_WEEK;</span>
<span class="nc" id="L505">			break;</span>
		/* Dollars is no longer used, so the string was removed.
		case Dollars:
			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WORK_UNIT_DOLLARS;
			break;
		*/
		case FullWeekend:
<span class="nc" id="L512">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WORK_UNIT_FULL_WEEKEND;</span>
<span class="nc" id="L513">			break;</span>
		case Hours:
<span class="nc" id="L515">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WORK_UNIT_HOURS;</span>
<span class="nc" id="L516">			break;</span>
		case MinShiftEventSpacing:
<span class="nc" id="L518">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WORK_UNIT_MIN_SHIFT_EVENT_SPACING;</span>
<span class="nc" id="L519">			break;</span>
		case MinShiftSpacing:
<span class="nc" id="L521">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WORK_UNIT_MIN_SHIFT_SPACING;</span>
<span class="nc" id="L522">			break;</span>
		case PartialWeekend:
<span class="nc" id="L524">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WORK_UNIT_PARTIAL_WEEKEND;</span>
<span class="nc" id="L525">			break;</span>
		case Shift:
<span class="nc" id="L527">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WU_SHIFT;</span>
<span class="nc" id="L528">			break;</span>
		case Weekend:
<span class="nc" id="L530">			messageKey = FsWebBundleKey.ASSIGNMENT_RULE_WORK_UNIT_WEEKEND;</span>
<span class="nc" id="L531">			break;</span>
		default:
<span class="nc" id="L533">			throw new IllegalArgumentException(&quot;Unexpected response type: &quot; + wut);</span>
		}
<span class="nc" id="L535">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, messageKey);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>