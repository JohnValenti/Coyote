<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WorkPatternExportPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">WorkPatternExportPopupPM.java</span></div><h1>WorkPatternExportPopupPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Set;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeType;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftEvent;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftFieldInfo;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftOTExtension;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPatternPeriod;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPatternShiftAttributes;
import com.bluepumpkin.ejb.bbm.workrules.model.VTOEvent;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.organization.setup.employeetype.EmployeeTypeModelHandler;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.shift.ShiftUtil;
import com.witness.web.uif.data.DataSet;
import com.witness.web.uif.data.DataTable;
import com.witness.web.uif.data.DataTableColumn;
import com.witness.web.uif.data.DataTableRow;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.TimeZoneOverrideUtil;

public class WorkPatternExportPopupPM extends WorkRulesExportPopupPM {
	private static final long serialVersionUID = 1L;
	
	public static final String VIEW_ACTION = &quot;work_pattern_export&quot;;
	public static final String FORM_ACTION = &quot;work_pattern_export_download&quot;;
	
	private Collection&lt;EmployeeType&gt; allEmployeeTypes;
<span class="nc" id="L48">	private Organization m_organization = null;</span>
<span class="nc" id="L49">	private SchedulingPeriod m_schedulingPeriod = null;</span>
	protected TimeZone m_optimizationTargetTimeZone;
<span class="nc" id="L51">	protected Date m_timeZoneEffectiveDate = new Date();</span>
	
<span class="nc" id="L53">	private Map&lt;ID, Organization&gt; m_organizationMap = null;</span>
<span class="nc" id="L54">	private Map&lt;ID, Campaign&gt; m_campaignMap = null;</span>
<span class="nc" id="L55">	private Map&lt;ID, Activity&gt; m_activityMap = null;</span>
<span class="nc" id="L56">	private Map&lt;ID, EmployeeType&gt; m_employeeTypeMap = null;</span>
<span class="nc" id="L57">	private int displayDayOfWeekStart = 1;</span>
	
	public WorkPatternExportPopupPM(RequestContext context) {
<span class="nc" id="L60">		super(context);</span>
		
		// Disable comma delimiter because shift event additional activities field comma delimits multiple assignments.
<span class="nc" id="L63">		setIsCommaDelimiterEnabled(false);</span>
<span class="nc" id="L64">	}</span>
	
	public static WorkPatternExportPopupPM getInstance(RequestContext context) {
<span class="nc" id="L67">		return (WorkPatternExportPopupPM)getInstance(context, WorkPatternExportPopupPM.class);</span>
	}

	@Override
	public DataSet getDataSet() throws Exception {
<span class="nc" id="L72">		DataSet ds = new DataSet();</span>
		
<span class="nc" id="L74">		Collection&lt;ShiftPattern&gt; shiftPatterns = null;</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">		if (m_isByOrganization) {	// Organization Mode</span>
<span class="nc" id="L76">			ID organizationId = new ID(m_organizationId);</span>
<span class="nc" id="L77">			m_organization = OrganizationModelHandler.getOrganization(m_context, organizationId);</span>
<span class="nc" id="L78">			m_optimizationTargetTimeZone = m_organization.getTimeZone();</span>
<span class="nc" id="L79">			m_timeZoneEffectiveDate = new Date();</span>
<span class="nc" id="L80">			allEmployeeTypes = EmployeeTypeModelHandler.getEmployeeTypes(m_context, organizationId);</span>
<span class="nc" id="L81">			shiftPatterns = WorkRulesModelHandler.getShiftPatternsByOrg(m_context, organizationId);</span>
<span class="nc" id="L82">		} else {	// Campaign Mode</span>
<span class="nc" id="L83">			ID schedulingPeriodId = new ID(m_schedulingPeriodId);</span>
<span class="nc" id="L84">			m_schedulingPeriod = CampaignModelHandler.getSchedulingPeriodByID(</span>
					m_context, schedulingPeriodId);
<span class="nc" id="L86">			m_timeZoneEffectiveDate = m_schedulingPeriod.getStartTime();</span>
<span class="nc" id="L87">			allEmployeeTypes = EmployeeTypeModelHandler.getEmployeeTypes(m_context,</span>
<span class="nc" id="L88">					WorkRulesModelHandler.getOrgIDsLinkedToSP(m_context, schedulingPeriodId));</span>
<span class="nc" id="L89">			shiftPatterns = WorkRulesModelHandler.getShiftPatternsBySchedulingPeriodCampaignOnly(m_context, m_schedulingPeriod);</span>
		}
		
<span class="nc" id="L92">		initMaps(shiftPatterns);</span>

		// Work Patterns Start
<span class="nc" id="L95">		DataTable table = new DataTable(i18n(m_fsResourceBundle, FsWebBundleKey.WORK_PATTERNS));</span>
<span class="nc" id="L96">		ds.add(table);</span>
		
<span class="nc bnc" id="L98" title="All 2 branches missed.">		if(m_isByOrganization) {</span>
<span class="nc" id="L99">			table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_ORGANIZATION)));</span>
		} else {
<span class="nc" id="L101">			table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_CAMPAIGN)));</span>
		}
<span class="nc" id="L103">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_NAME)));</span>
<span class="nc" id="L104">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_DESCRIPTION)));</span>
<span class="nc" id="L105">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_CONSISTENCY_TOLERANCE))); </span>
<span class="nc" id="L106">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_EMPLOYEE_TYPE)));</span>
<span class="nc" id="L107">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_PATTERN_TYPE)));</span>
		
<span class="nc bnc" id="L109" title="All 2 branches missed.">		for(ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="nc" id="L110">			DataTableRow row = table.newRow();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">			if	(shiftPattern.getOrganizationID() == null) {</span>
<span class="nc" id="L112">				row.add(i18n(m_fsResourceBundle, FsWebBundleKey.LOCAL));</span>
			} else {
<span class="nc" id="L114">				row.add(m_organizationMap.get(shiftPattern.getOrganizationID()).getName());</span>
			}
<span class="nc" id="L116">			row.add(shiftPattern.getName());</span>
<span class="nc" id="L117">			row.add(shiftPattern.getDescription());</span>
<span class="nc" id="L118">			row.add(m_localizer.formatDurationInMins(shiftPattern.getConsistentStartsTolerance()));</span>
<span class="nc" id="L119">			row.add(m_employeeTypeMap.get(shiftPattern.getEmployeeTypeID()).getDescription());</span>
<span class="nc" id="L120">			row.add(ShiftUtil.getWorkPatternPeriodLocalizedValue(m_localizer, shiftPattern.getPeriod()));</span>
<span class="nc" id="L121">		}</span>
		// Work Patterns End
		
		// Work Patterns Work Days Start
<span class="nc" id="L125">		table = new DataTable(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_DAYS));</span>
<span class="nc" id="L126">		ds.add(table);</span>
		
<span class="nc" id="L128">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_PATTERN_NAME)));</span>
<span class="nc" id="L129">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_NAME)));</span>
<span class="nc" id="L130">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_DAYS)));</span>
<span class="nc" id="L131">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_CONSISTENT_SHIFT_EVENTS_HEADER)));</span>
<span class="nc" id="L132">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_MIN_CONSECUTIVE_DAYS_HEADER)));</span>
<span class="nc" id="L133">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_MAX_CONSECUTIVE_DAYS_HEADER)));</span>
		
		// The shift occurrences are stored relative to the start of week.				
<span class="nc bnc" id="L136" title="All 2 branches missed.">		for(ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="nc" id="L137">			HashMap&lt;Shift, ShiftPatternShiftAttributes&gt; shiftInfo = shiftPattern.getShiftPatternShiftAttributes();</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">			for (Shift shift : shiftInfo.keySet()) {</span>
<span class="nc" id="L139">				DataTableRow row = table.newRow();</span>
<span class="nc" id="L140">				row.add(shiftPattern.getName());</span>
<span class="nc" id="L141">				row.add(shift.getName());</span>
				
<span class="nc" id="L143">				StringBuilder sb = new StringBuilder();</span>
				
<span class="nc" id="L145">				ShiftPatternPeriod sp = shiftPattern.getPeriod();</span>
<span class="nc" id="L146">				int[] daysInPeriod = sp.getDaysInPeriod();</span>
				
<span class="nc" id="L148">				int maxDayInPeriod = 0;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">				for(int entry : daysInPeriod) {</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">					if(entry &gt; maxDayInPeriod) maxDayInPeriod = entry;</span>
				}
				 
<span class="nc" id="L153">				ShiftPatternShiftAttributes shiftPatternAttr = shiftInfo.get(shift);</span>
<span class="nc" id="L154">				Set&lt;Integer&gt; occurrenceDays = new HashSet&lt;Integer&gt;();</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">				for(Integer entry : shiftPatternAttr.getOccurrenceDays()) {</span>
					// if the entry is not outside the bounds of the days in period, it is ok, otherwise filter it out.
<span class="nc bnc" id="L157" title="All 2 branches missed.">					if(entry &lt;= maxDayInPeriod) occurrenceDays.add(entry);</span>
<span class="nc" id="L158">				}</span>
<span class="nc" id="L159">				sb.append(ShiftUtil.workDaysArrayToString(occurrenceDays.toArray(new Integer[0])));</span>

<span class="nc" id="L161">				row.add(sb.toString());</span>
				
				//Consistent Shift Activities
<span class="nc" id="L164">				row.add(getLocalizer().formatYesNo(shiftInfo.get(shift).isConsistentShiftActivities()));</span>
				
				//Min Consecutive Days
<span class="nc" id="L167">				row.add(Integer.toString(shiftInfo.get(shift).getMinConsecutiveDay()));</span>
				
				//Max Consecutive Days
<span class="nc" id="L170">				row.add(Integer.toString(shiftInfo.get(shift).getMaxConsecutiveDay()));</span>
<span class="nc" id="L171">			}</span>
<span class="nc" id="L172">		}</span>
		// Work Patterns Work Days End
		
		// Work Pattern Consistency Start
<span class="nc" id="L176">		table = new DataTable(i18n(m_fsResourceBundle, FsWebBundleKey.FS_CONSISTENCY));</span>
<span class="nc" id="L177">		ds.add(table);</span>
		
<span class="nc" id="L179">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_PATTERN_NAME)));</span>
<span class="nc" id="L180">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_NAME)));</span>
<span class="nc" id="L181">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_CONSISTENCY)));</span>
		
<span class="nc bnc" id="L183" title="All 2 branches missed.">		for(ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="nc" id="L184">			HashMap&lt;Shift, ShiftPatternShiftAttributes&gt; shiftInfo = shiftPattern.getShiftPatternShiftAttributes();</span>
<span class="nc" id="L185">			ShiftPatternPeriod sp = shiftPattern.getPeriod();</span>
<span class="nc" id="L186">			int[] daysInPeriod = sp.getDaysInPeriod();</span>
			
<span class="nc bnc" id="L188" title="All 2 branches missed.">			for (Shift shift : shiftInfo.keySet()) {</span>
				// Ignore possible days off for consistency.
<span class="nc bnc" id="L190" title="All 2 branches missed.">				if(shift.getID().toInt() == ShiftFieldInfo.POSSIBLE_DAYS_OFF_SHIFT_ID) continue;</span>
				
<span class="nc" id="L192">				DataTableRow row = table.newRow();</span>
<span class="nc" id="L193">				row.add(shiftPattern.getName());</span>
<span class="nc" id="L194">				row.add(shift.getName());</span>
<span class="nc" id="L195">				HashMap&lt;Integer, Integer&gt; consistencyMap = shiftInfo.get(shift).getConsistentShiftGroupMap();</span>
				
<span class="nc" id="L197">				StringBuilder sb = new StringBuilder();</span>
				
<span class="nc bnc" id="L199" title="All 2 branches missed.">				for (int i=0; i &lt; daysInPeriod.length; i++) {</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">					if (sb.length() &gt; 0) sb.append(&quot;,&quot;);		// We don't currently localize list delimiters.</span>
<span class="nc" id="L201">					Object consistencyValue = consistencyMap.get(i+1);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">					sb.append(String.valueOf(consistencyValue == null ? 0 : consistencyValue));</span>
				}
				
<span class="nc" id="L205">				row.add(sb.toString());</span>
<span class="nc" id="L206">			}</span>
<span class="nc" id="L207">		}</span>
		// Work Pattern Consistency End
		
		// VTO Events Start
<span class="nc" id="L211">		table = new DataTable(i18n(m_fsResourceBundle, FsWebBundleKey.FS_VTO_EVENTS));</span>
<span class="nc" id="L212">		ds.add(table);</span>
		
<span class="nc" id="L214">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_PATTERN_NAME)));</span>
<span class="nc" id="L215">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_VTO_EVENT)));</span>
<span class="nc" id="L216">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_START_TIMES)));</span>
				
<span class="nc bnc" id="L218" title="All 2 branches missed.">		for(ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="nc" id="L219">			HashMap&lt;Shift, ShiftPatternShiftAttributes&gt; shiftInfo = shiftPattern.getShiftPatternShiftAttributes();</span>

<span class="nc" id="L221">			LinkedHashMap&lt;VTOEvent, ShiftPattern.StartTime&gt; vtoEventStartTimeMap = </span>
<span class="nc" id="L222">				new LinkedHashMap&lt;VTOEvent, ShiftPattern.StartTime&gt;(shiftPattern.getVTOEventStartTimes());</span>
			// Filter out vto events deleted before view date
<span class="nc bnc" id="L224" title="All 2 branches missed.">			for (Iterator&lt;Map.Entry&lt;VTOEvent, ShiftPattern.StartTime&gt;&gt; iter = vtoEventStartTimeMap.entrySet().iterator(); iter.hasNext(); ) {</span>
<span class="nc" id="L225">				VTOEvent vto = iter.next().getKey();</span>
<span class="nc bnc" id="L226" title="All 4 branches missed.">				if (vto.getDeleteOnDate() != null &amp;&amp; vto.getDeleteOnDate().before(m_timeZoneEffectiveDate)) iter.remove();</span>
<span class="nc" id="L227">			}</span>
			
<span class="nc bnc" id="L229" title="All 2 branches missed.">			for (VTOEvent vtoEvent : vtoEventStartTimeMap.keySet()) {</span>
<span class="nc" id="L230">				DataTableRow row = table.newRow();</span>
				
				// Work Pattern VTO Extension is Assigned to.
<span class="nc" id="L233">				row.add(shiftPattern.getName());</span>
				
				// Name
<span class="nc" id="L236">				row.add(vtoEvent.getName());</span>
				
				// Start Times
<span class="nc" id="L239">				row.add(WorkRulesUtil.getVTOEventStartTimeText(getLocalizer(), vtoEventStartTimeMap.get(vtoEvent)));</span>
<span class="nc" id="L240">			}</span>
<span class="nc" id="L241">		}</span>
		// VTO Events End
		
		// OT Extensions Start
<span class="nc" id="L245">		table = new DataTable(i18n(m_fsResourceBundle, FsWebBundleKey.FS_OT_EXTS));</span>
<span class="nc" id="L246">		ds.add(table);</span>
		
<span class="nc" id="L248">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_PATTERN_NAME)));</span>
<span class="nc" id="L249">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_OT_EXTENSION)));</span>
<span class="nc" id="L250">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_START_TIMES)));</span>
		
<span class="nc bnc" id="L252" title="All 2 branches missed.">		for(ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="nc" id="L253">			HashMap&lt;Shift, ShiftPatternShiftAttributes&gt; shiftInfo = shiftPattern.getShiftPatternShiftAttributes();</span>
			
<span class="nc" id="L255">			LinkedHashMap&lt;ShiftOTExtension, ShiftPattern.StartTime&gt; otExtensionStartTimeMap = </span>
<span class="nc" id="L256">				new LinkedHashMap&lt;ShiftOTExtension, ShiftPattern.StartTime&gt;(shiftPattern.getOTExtensionStartTimes());</span>
			
			// Filter out shift overtime extensions deleted before the view date
<span class="nc bnc" id="L259" title="All 2 branches missed.">			for (Iterator&lt;Map.Entry&lt;ShiftOTExtension, ShiftPattern.StartTime&gt;&gt; iter = otExtensionStartTimeMap.entrySet().iterator(); iter.hasNext(); ) {</span>
<span class="nc" id="L260">				ShiftOTExtension otExtension = iter.next().getKey();</span>
<span class="nc bnc" id="L261" title="All 4 branches missed.">				if (otExtension.getDeleteOnDate() != null &amp;&amp; otExtension.getDeleteOnDate().before(m_timeZoneEffectiveDate)) iter.remove();</span>
<span class="nc" id="L262">			}</span>
			
<span class="nc bnc" id="L264" title="All 2 branches missed.">			for (ShiftOTExtension otExtension : otExtensionStartTimeMap.keySet()) {</span>
<span class="nc" id="L265">				DataTableRow row = table.newRow();</span>
				
				// Work Pattern OT Extension is Assigned to
<span class="nc" id="L268">				row.add(shiftPattern.getName());</span>
				
				// OT Extension Name
<span class="nc" id="L271">				row.add(otExtension.getName());</span>
				
				// Start Times
<span class="nc" id="L274">				row.add(WorkRulesUtil.getOTExtensionStartTimeText(getLocalizer(), otExtensionStartTimeMap.get(otExtension)));</span>
<span class="nc" id="L275">			}</span>
<span class="nc" id="L276">		}</span>
		// OT Extensions End
		
<span class="nc" id="L279">		return ds;</span>
	}
	
	private void initMaps(Collection&lt;ShiftPattern&gt; shiftPatterns) throws Exception {
		// Collections of IDs of objects we will need for display
<span class="nc" id="L284">		Collection&lt;ID&gt; orgIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L285">		Collection&lt;ID&gt; campaignIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L286">		Collection&lt;ID&gt; activityIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L287">		Collection&lt;ID&gt; empTypeIDs = new HashSet&lt;ID&gt;();</span>
		
<span class="nc bnc" id="L289" title="All 2 branches missed.">		for (ShiftPattern sp : shiftPatterns) {</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">			if (sp.getOrganizationID() != null) orgIDs.add(sp.getOrganizationID());</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">			if (sp.getCampaignID() != null) campaignIDs.add(sp.getCampaignID());</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">			if (sp.getEmployeeTypeID() != null) empTypeIDs.add(sp.getEmployeeTypeID());</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">			for (Shift shift : sp.getShiftPatternShiftAttributes().keySet()) {</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">				if (shift.getOrganizationID() != null) orgIDs.add(shift.getOrganizationID());</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">				if (shift.getCampaignID() != null) campaignIDs.add(shift.getCampaignID());</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">				if (shift.getActivityID() != null) activityIDs.add(shift.getActivityID());</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">				for (ShiftEvent se : shift.getShiftEvents()) {</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">					if (se.getOrganizationID() != null) orgIDs.add(se.getOrganizationID());</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">					if (se.getCampaignID() != null) campaignIDs.add(se.getCampaignID());</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">					if (se.getActivityID() != null) activityIDs.add(se.getActivityID());</span>
<span class="nc" id="L301">				}</span>
<span class="nc" id="L302">			}</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">			for (VTOEvent vtoe : sp.getVTOEventStartTimes().keySet()) {</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">				if (vtoe.getOrganizationID() != null) orgIDs.add(vtoe.getOrganizationID());</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">				if (vtoe.getCampaignID() != null) campaignIDs.add(vtoe.getCampaignID());</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">				if (vtoe.getActivityID() != null) activityIDs.add(vtoe.getActivityID());</span>
<span class="nc" id="L307">			}</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">			for (ShiftOTExtension sote : sp.getOTExtensionStartTimes().keySet()) {</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">				if (sote.getOrganizationID() != null) orgIDs.add(sote.getOrganizationID());</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">				if (sote.getCampaignID() != null) campaignIDs.add(sote.getCampaignID());</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">				if (sote.getActivityID() != null) activityIDs.add(sote.getActivityID());</span>
<span class="nc" id="L312">			}</span>
<span class="nc" id="L313">		}</span>
		
<span class="nc" id="L315">		m_organizationMap = WorkRulesModelHandler.getOrgs(m_context, orgIDs);</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">		if (!m_isByOrganization) m_campaignMap = WorkRulesModelHandler.getCampaigns(m_context, campaignIDs);</span>
<span class="nc" id="L317">		m_activityMap = WorkRulesModelHandler.getActivities(m_context, activityIDs);</span>
<span class="nc" id="L318">		m_employeeTypeMap = EmployeeTypeModelHandler.getEmployeeTypesByIDs(m_context, empTypeIDs);</span>
<span class="nc" id="L319">	}</span>
	
	/*
	 * Initializes the start of week for display headers as well as data since they may
	 * not both be aligned depending on viewing time zone.
	 */
	private void initStartOfWeekForDataDisplay()
	{
<span class="nc" id="L327">		Calendar workingCalendar = null;</span>
<span class="nc" id="L328">		int weekStartDayOfWeek = Calendar.SUNDAY;</span>
<span class="nc" id="L329">		int dayBoundaryOffset = 0;</span>

<span class="nc bnc" id="L331" title="All 2 branches missed.">		if (m_isByOrganization) { </span>
			// For organization the week start is the day of week + day boundary.
<span class="nc" id="L333">			workingCalendar = Calendar.getInstance(m_organization.getTimeZone());</span>
		
<span class="nc" id="L335">			weekStartDayOfWeek = m_organization.getWeekStartDate(); // 1 = Sunday.</span>
<span class="nc" id="L336">			dayBoundaryOffset = m_organization.getDayBoundaryOffset();</span>

			// Configure the working date to the start of week and day boundary hours.
<span class="nc" id="L339">			workingCalendar.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L340">			workingCalendar.set(Calendar.MINUTE, dayBoundaryOffset);</span>
<span class="nc" id="L341">			workingCalendar.set(Calendar.SECOND,0);				</span>
<span class="nc" id="L342">			workingCalendar.set(Calendar.MILLISECOND,0);</span>

<span class="nc bnc" id="L344" title="All 2 branches missed.">			while(workingCalendar.get(Calendar.DAY_OF_WEEK) != weekStartDayOfWeek) {</span>
<span class="nc" id="L345">				workingCalendar.add(Calendar.DAY_OF_WEEK, -1);</span>
			}
		}
		else // This is a local organization/information related to a campaign scope definition.
		{
<span class="nc" id="L350">			Campaign cam = m_campaignMap.get(m_schedulingPeriod.getCampaignID());</span>

<span class="nc" id="L352">			workingCalendar = Calendar.getInstance(m_optimizationTargetTimeZone);</span>
<span class="nc" id="L353">			weekStartDayOfWeek = 1; // Campaign always defined as minute offset from sunday.</span>
			
<span class="nc" id="L355">			dayBoundaryOffset = cam.getWeekStart(); // Minute offset from sunday 12am.</span>
			
<span class="nc" id="L357">			workingCalendar.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L358">			workingCalendar.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L359">			workingCalendar.set(Calendar.SECOND,0);				</span>
<span class="nc" id="L360">			workingCalendar.set(Calendar.MILLISECOND,0);</span>
			
<span class="nc bnc" id="L362" title="All 2 branches missed.">			while(workingCalendar.get(Calendar.DAY_OF_WEEK) != weekStartDayOfWeek) {</span>
<span class="nc" id="L363">				workingCalendar.add(Calendar.DAY_OF_WEEK, -1);</span>
			}
			
<span class="nc" id="L366">			workingCalendar.add(Calendar.MINUTE, dayBoundaryOffset);</span>
		}
			
<span class="nc bnc" id="L369" title="All 2 branches missed.">		if(TimeZoneOverrideUtil.isTimeZoneOverridden(m_context)) {</span>
<span class="nc" id="L370">			workingCalendar.setTimeZone(m_context.getViewingTimeZone());</span>
		}
		else {
<span class="nc" id="L373">			workingCalendar.setTimeZone(m_optimizationTargetTimeZone);</span>
		}
		
<span class="nc" id="L376">		displayDayOfWeekStart = workingCalendar.get(Calendar.DAY_OF_WEEK);</span>
<span class="nc" id="L377">	}</span>
	
	/**
	 * Gets the appropriate day of week cell for a dow index (monday = 1)
	 * @param shiftInfo
	 * @param dow (Monday=1 per db schema)
	 * @return
	 */
	private String getDOWCellText(ShiftPatternShiftAttributes shiftInfo, /*DayOfWeek*/int dow) {
<span class="nc bnc" id="L386" title="All 2 branches missed.">		if (shiftInfo.getConsistentShiftGroupMap().get(dow) == null) {</span>
<span class="nc" id="L387">			return getLocalizer().formatYesNo(shiftInfo.getOccurrenceDays().contains(dow));</span>
		} else {
<span class="nc" id="L389">			return getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_CONSISTENT_START_TIMES_FORMAT,</span>
<span class="nc" id="L390">					new Object[] { getLocalizer().formatYesNo(shiftInfo.getOccurrenceDays().contains(dow)),</span>
<span class="nc" id="L391">					Integer.toString(shiftInfo.getConsistentShiftGroupMap().get(dow)) });</span>
		}
	}
	
	@Override
	public String getDefaultFileName() {
<span class="nc" id="L397">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_WORK_PATTERN_FILE_NAME);</span>
	}
	
	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc" id="L404">		return FORM_ACTION;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>