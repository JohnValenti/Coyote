<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeTrackingCache.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.timerecord.cache</a> &gt; <span class="el_source">TimeTrackingCache.java</span></div><h1>TimeTrackingCache.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.timerecord.cache;

import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.SortedSet;
import java.util.TreeSet;
import java.util.ArrayList;

import com.bluepumpkin.common.cache.Cache;
import com.bluepumpkin.common.cache.CacheFactory;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.config.ejb.DBConfigManager;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeTrackingEvent;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.timerecord.ejb.TimeTrackingDAO;
import com.bluepumpkin.ejb.bbm.timerecord.ejb.TimeTrackingManager;
import com.bluepumpkin.ejb.bbm.timerecord.ejb.TimeTrackingManagerEJB;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;

<span class="nc" id="L27">public class TimeTrackingCache {</span>
<span class="nc" id="L28">	private static Category m_cat = Log.initCategory(TimeTrackingCache.class.getName());</span>
<span class="nc" id="L29">	private static int m_CachedMilliSeconds = TimeZoneUtil.DAY_IN_MILLISECONDS;</span>
<span class="nc" id="L30">	public static ID initKey = new ID(-1);</span>
<span class="nc" id="L31">	public static int m_CacheCleanupInterval = TimeZoneUtil.HOUR_IN_MILLISECONDS;</span>

	public static Cache getCache()
			throws Exception {
<span class="nc" id="L35">		Cache cache = CacheFactory.getCache(TimeTrackingManager.TIMETRACKING_CACHE_NAME, TimeTrackingManagerEJB.class.getClassLoader());</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">		if (cache == null) {</span>
<span class="nc" id="L37">			return null;</span>
		}
<span class="nc" id="L39">		initCache(cache);</span>
<span class="nc" id="L40">		return cache;</span>
	}

	public static void reloadCache(Cache cache)
			throws Exception {
<span class="nc bnc" id="L45" title="All 2 branches missed.">		if (cache.lock(initKey, -1)) {</span>
			try {
<span class="nc" id="L47">				Object value = cache.get(initKey);</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">				if (value != null) {</span>
<span class="nc" id="L49">					cache.put(initKey, null);</span>
				}
			} finally {
<span class="nc" id="L52">				cache.unLock(initKey);</span>
<span class="nc" id="L53">			}</span>
		}
<span class="nc" id="L55">		initCache(cache);</span>
<span class="nc" id="L56">	}</span>

	public static void initCache(Cache cache)
			throws Exception {
<span class="nc bnc" id="L60" title="All 2 branches missed.">		if (cache.get(initKey) != null) {</span>
<span class="nc" id="L61">			return;</span>
		}

<span class="nc bnc" id="L64" title="All 2 branches missed.">		if (cache.lock(initKey, -1)) {</span>
			try {
<span class="nc" id="L66">				Object value = cache.get(initKey);</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">				if (value != null) {</span>
<span class="nc" id="L68">					return;</span>
				}

<span class="nc" id="L71">				DBConfigManager dbConfig = BbmManagerFactory.getDBConfigManager();</span>
<span class="nc" id="L72">				String val = (String)dbConfig.getValue(&quot;bluepumpkin/bbm/cache/timetracking/cleanupInterval&quot;);</span>
<span class="nc bnc" id="L73" title="All 4 branches missed.">				if (val != null &amp;&amp; val.trim().length() &gt; 0) {</span>
<span class="nc" id="L74">					m_CacheCleanupInterval = Integer.parseInt(val);</span>
				}

<span class="nc" id="L77">				Date dt[] = getCurrentCacheWindow();</span>
<span class="nc" id="L78">				TimeTrackingDAO dao = new TimeTrackingDAO();</span>
<span class="nc" id="L79">				HashMap hm = dao.getEventsForWorkResource(Collections.EMPTY_LIST, dt[0], dt[1]);</span>
<span class="nc bnc" id="L80" title="All 4 branches missed.">				if (hm != null &amp;&amp; hm.size() &gt; 0) {</span>
<span class="nc" id="L81">					Iterator iter = hm.values().iterator();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">					while (iter.hasNext()) {</span>
<span class="nc" id="L83">						insertInCache(cache, (Collection)iter.next());</span>
					}
				}

				// update cache reload time stamp
<span class="nc" id="L88">				Date lastTs = new Date();</span>
<span class="nc" id="L89">				cache.put(initKey, lastTs);</span>
			} finally {
<span class="nc" id="L91">				cache.unLock(initKey);</span>
<span class="nc" id="L92">			}</span>
		}
<span class="nc" id="L94">	}</span>

	public static Date[] getCurrentCacheWindow() {
<span class="nc" id="L97">		Date end = new Date();</span>
<span class="nc" id="L98">		Date[] window = new Date[2];</span>
<span class="nc" id="L99">		Date start = new Date(end.getTime() - m_CachedMilliSeconds);</span>

<span class="nc" id="L101">		window[0] = start;</span>
<span class="nc" id="L102">		window[1] = end;</span>
<span class="nc" id="L103">		return window;</span>
	}

	public static boolean fitsInCache(Date startTime, Date endTime, Date cacheStartTime, Date cacheEndTime, boolean checkStartTime) {
<span class="nc bnc" id="L107" title="All 4 branches missed.">		if (checkStartTime &amp;&amp; startTime.before(cacheStartTime)) {</span>
<span class="nc" id="L108">			return false;</span>
		}
<span class="nc" id="L110">		return TimeZoneUtil.periodsOverlap(startTime, endTime, cacheStartTime, cacheEndTime);</span>
	}

	public static boolean fitsInCache(Date startTime, Date endTime) {
<span class="nc" id="L114">		Date[] cacheWindow = getCurrentCacheWindow();</span>
<span class="nc" id="L115">		return fitsInCache(startTime, endTime, cacheWindow[0], cacheWindow[1], true);</span>
	}

	public static boolean fitsInCache(TimeTrackingEvent event, Date cacheStartTime, Date cacheEndTime, boolean checkStartTime) {
<span class="nc" id="L119">		Date endTime = event.getEndTime();</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">		if (endTime == null) {</span>
<span class="nc" id="L121">			endTime = new Date();</span>
		}
<span class="nc" id="L123">		return fitsInCache(event.getStartTime(), endTime, cacheStartTime, cacheEndTime, checkStartTime);</span>
	}

	static private void removeOldEvents(Cache cache) {
<span class="nc" id="L127">		Date cacheWindow[] = getCurrentCacheWindow();</span>
<span class="nc" id="L128">		Date lastTs = null;</span>

<span class="nc bnc" id="L130" title="All 2 branches missed.">		if (cache.lock(initKey, -1)) {</span>
			try {
<span class="nc" id="L132">				lastTs = (Date)cache.get(initKey);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">				if (lastTs == null) {</span>
<span class="nc" id="L134">					lastTs = new Date();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">				} else if (Math.abs(System.currentTimeMillis() - lastTs.getTime()) &lt; m_CacheCleanupInterval) {</span>
<span class="nc" id="L136">					return;</span>
				}

<span class="nc" id="L139">				m_cat.info(&quot;*********  Entered TimeTrackingCache - removeOldEvents() &quot;);</span>

				// iterate all the cache contents and remove old events
				// store updated lists
<span class="nc" id="L143">				HashMap hmUpdate = new HashMap();</span>
<span class="nc" id="L144">				HashMap eventRemStat = new HashMap();</span>

<span class="nc" id="L146">				Iterator keyIter = cache.keySet().iterator();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">				while (keyIter.hasNext()) {</span>
<span class="nc" id="L148">					Object nKey = keyIter.next();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">					if (nKey.equals(initKey)) {</span>
<span class="nc" id="L150">						continue;</span>
					}

<span class="nc" id="L153">					Collection lst = getListFromCache(cache, nKey);</span>

<span class="nc" id="L155">					int counter = 0;</span>
<span class="nc" id="L156">					int keyCount = 1;</span>
<span class="nc bnc" id="L157" title="All 4 branches missed.">					if (lst != null &amp;&amp; lst.size() &gt; 0) {</span>

<span class="nc" id="L159">						Iterator lstIter = lst.iterator();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">						while (lstIter.hasNext()) {</span>
<span class="nc" id="L161">							TimeTrackingEvent cur = (TimeTrackingEvent)lstIter.next();</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">							if (fitsInCache(cur, cacheWindow[0], cacheWindow[1], true)) {</span>
<span class="nc" id="L163">								break;</span>
							}

<span class="nc" id="L166">							lstIter.remove();</span>
<span class="nc" id="L167">							hmUpdate.put(nKey, lst);</span>
<span class="nc" id="L168">							counter++;</span>
<span class="nc" id="L169">						}</span>
					}

<span class="nc bnc" id="L172" title="All 2 branches missed.">					if (keyCount &lt; 10) {</span>
<span class="nc" id="L173">						eventRemStat.put(nKey, new Integer(counter));</span>
					}
<span class="nc" id="L175">					keyCount++;</span>
<span class="nc" id="L176">				}</span>

<span class="nc" id="L178">				updateListInCache(cache, hmUpdate);</span>

<span class="nc" id="L180">				lastTs = new Date();</span>
<span class="nc" id="L181">				cache.put(initKey, lastTs);</span>

<span class="nc bnc" id="L183" title="All 2 branches missed.">				if (eventRemStat != null) {</span>
<span class="nc" id="L184">					Iterator iter = eventRemStat.keySet().iterator();</span>
<span class="nc" id="L185">					StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L186">					buf.append(&quot; *********  TimeTrackingCache - removeOldEvents  &quot;);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">					while (iter.hasNext()) {</span>

<span class="nc" id="L189">						Object key = iter.next();</span>

<span class="nc" id="L191">						buf.append(&quot; EmpId : &quot;);</span>
<span class="nc" id="L192">						buf.append(key.toString());</span>
<span class="nc" id="L193">						buf.append(&quot;;&quot;);</span>
<span class="nc" id="L194">						buf.append(&quot; removedEvents : &quot;);</span>
<span class="nc" id="L195">						buf.append(eventRemStat.get(key).toString());</span>
<span class="nc" id="L196">						buf.append(&quot;\\n&quot;);</span>

<span class="nc" id="L198">					}</span>
<span class="nc" id="L199">					m_cat.info(buf.toString());</span>
				}
			} finally {
<span class="nc" id="L202">				cache.unLock(initKey);</span>
<span class="nc" id="L203">			}</span>
		}
<span class="nc" id="L205">	}</span>

	public static void insertInCache(Cache trCache, Collection values) {
<span class="nc bnc" id="L208" title="All 6 branches missed.">		if (trCache == null || values == null || values.size() &lt;= 0) {</span>
<span class="nc" id="L209">			return;</span>
		}

<span class="nc" id="L212">		Date cacheWindow[] = getCurrentCacheWindow();</span>

<span class="nc" id="L214">		HashMap hmUpdate = new HashMap();</span>

<span class="nc" id="L216">		Iterator iter = values.iterator();</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L218">			TimeTrackingEvent cur = (TimeTrackingEvent)iter.next();</span>

<span class="nc" id="L220">			ID key = cur.getEmployeeID();</span>

<span class="nc" id="L222">			TreeSet lst = getListFromCache(trCache, key);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">			if (lst == null) {</span>
<span class="nc" id="L224">				lst = new TreeSet();</span>
			}

<span class="nc" id="L227">			hmUpdate.put(key, lst);</span>

			// replace existing object with the new one if they are same
<span class="nc bnc" id="L230" title="All 2 branches missed.">			if (lst.contains(cur)) {</span>
<span class="nc" id="L231">				SortedSet dset = lst.tailSet(cur);</span>
<span class="nc" id="L232">				lst.remove(dset.first());</span>
			}

			// if the cache is empty it's okay to add the event even if it does not fit the time range
<span class="nc bnc" id="L236" title="All 2 branches missed.">			if (!fitsInCache(cur, cacheWindow[0], cacheWindow[1], true)) {</span>
<span class="nc" id="L237">				continue;</span>
			}

<span class="nc" id="L240">			lst.add(cur);</span>
<span class="nc" id="L241">		}</span>

<span class="nc" id="L243">		updateListInCache(trCache, hmUpdate);</span>

<span class="nc" id="L245">		removeOldEvents(trCache);</span>
<span class="nc" id="L246">	}</span>

	public static void filterNoActivity(HashMap hmEvents) {
<span class="nc bnc" id="L249" title="All 4 branches missed.">		if (hmEvents == null || hmEvents.size() &lt;= 0) {</span>
<span class="nc" id="L250">			return;</span>
		}

<span class="nc" id="L253">		Iterator iter = hmEvents.values().iterator();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L255">			TimeTrackingEvent prev = null;</span>

<span class="nc" id="L257">			Collection lst = (Collection)iter.next();</span>
<span class="nc" id="L258">			Iterator lstIter = lst.iterator();</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">			while (lstIter.hasNext()) {</span>
<span class="nc" id="L260">				TimeTrackingEvent cur = (TimeTrackingEvent)lstIter.next();</span>

				// Filter this out, but set the end time of the previous event
<span class="nc bnc" id="L263" title="All 2 branches missed.">				if (cur.getActivityID().equals(Activity.ACTIVITY_NONE)) {</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">					if (prev != null) {</span>
<span class="nc" id="L265">						prev.setEndTime(cur.getStartTime());</span>
<span class="nc" id="L266">						prev = cur;</span>
					}
<span class="nc" id="L268">					lstIter.remove();</span>
<span class="nc" id="L269">					continue;</span>
				}

<span class="nc bnc" id="L272" title="All 2 branches missed.">				if (prev != null) {</span>
<span class="nc" id="L273">					prev.setEndTime(cur.getStartTime());</span>
				}
<span class="nc" id="L275">				prev = cur;</span>
<span class="nc" id="L276">			}</span>
			// set the end time of the last event to null
<span class="nc bnc" id="L278" title="All 2 branches missed.">			if (prev != null) {</span>
<span class="nc" id="L279">				prev.setEndTime(null);</span>
			}
<span class="nc" id="L281">		}</span>
<span class="nc" id="L282">	}</span>

	private static void updateListInCache(Cache trCache, Map hmList) {
<span class="nc bnc" id="L285" title="All 4 branches missed.">		if (hmList == null || hmList.size() &lt;= 0) {</span>
<span class="nc" id="L286">			return;</span>
		}

<span class="nc" id="L289">		Iterator iter = hmList.keySet().iterator();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L291">			ID key = (ID)iter.next();</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">			if (trCache.lock(key, -1)) {</span>
				try {
<span class="nc" id="L294">					Object value = hmList.get(key);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">					if (value != null) {</span>
<span class="nc" id="L296">						trCache.put(key, value);</span>
					}
				} finally {
<span class="nc" id="L299">					trCache.unLock(key);</span>
<span class="nc" id="L300">				}</span>
			}
<span class="nc" id="L302">		}</span>
<span class="nc" id="L303">	}</span>

	private static TreeSet getListFromCache(Cache trCache, Object key) {
<span class="nc bnc" id="L306" title="All 2 branches missed.">		if (trCache.lock(key, -1)) {</span>
			try {
<span class="nc" id="L308">				return (TreeSet)trCache.get(key);</span>
			} finally {
<span class="nc" id="L310">				trCache.unLock(key);</span>
			}
		}

<span class="nc" id="L314">		return null;</span>
	}

	public static HashMap getObjects(Cache trCache, Collection empIDColl, Date startTime, Date endTime) {
<span class="nc bnc" id="L318" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L319">			StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L320">			buf.append(&quot;Enter: getObjects&quot;);</span>
<span class="nc" id="L321">			buf.append(empIDColl);</span>
<span class="nc" id="L322">			buf.append(&quot;;&quot;);</span>
<span class="nc" id="L323">			buf.append(startTime);</span>
<span class="nc" id="L324">			buf.append(&quot;;&quot;);</span>
<span class="nc" id="L325">			buf.append(endTime);</span>

<span class="nc" id="L327">			m_cat.debug(buf.toString());</span>
		}

<span class="nc" id="L330">		HashMap retVal = new HashMap();</span>
<span class="nc" id="L331">		Date dt[] = getCurrentCacheWindow();</span>
<span class="nc" id="L332">		TreeSet lst = null;</span>

<span class="nc" id="L334">		Iterator iter = empIDColl.iterator();</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L336">			ID key = (ID)iter.next();</span>
<span class="nc" id="L337">			ArrayList empLst = new ArrayList();</span>

<span class="nc" id="L339">			lst = getListFromCache(trCache, key);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">			if (lst == null) //reload the cache</span>
			{
				try {
<span class="nc" id="L343">					TimeTrackingDAO dao = new TimeTrackingDAO();</span>
<span class="nc" id="L344">					HashMap hm = dao.getEventsForWorkResource(Collections.singletonList(key), dt[0], dt[1]);</span>
<span class="nc bnc" id="L345" title="All 4 branches missed.">					if (hm != null &amp;&amp; hm.size() &gt; 0) {</span>
<span class="nc" id="L346">						Iterator listIter = hm.values().iterator();</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">						while (listIter.hasNext()) {</span>
<span class="nc" id="L348">							insertInCache(trCache, (Collection)listIter.next());</span>
						}
						// get the updated list
<span class="nc" id="L351">						lst = getListFromCache(trCache, key);</span>
<span class="nc" id="L352">					} else {</span>
						// add an empty list, this will prevent reloading the cache
<span class="nc" id="L354">						updateListInCache(trCache, Collections.singletonMap(key, new TreeSet()));</span>
					}
<span class="nc" id="L356">				} catch (Exception ex) {</span>
<span class="nc" id="L357">					m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L358">				}</span>
			}

<span class="nc bnc" id="L361" title="All 2 branches missed.">			if (lst != null) {</span>
<span class="nc" id="L362">				Iterator lstIter = lst.iterator();</span>

<span class="nc bnc" id="L364" title="All 2 branches missed.">				while (lstIter.hasNext()) {</span>
<span class="nc" id="L365">					TimeTrackingEvent cur = (TimeTrackingEvent)lstIter.next();</span>

					// make a copy 
<span class="nc" id="L368">					TimeTrackingEvent newEvent = new TimeTrackingEvent(cur);</span>
<span class="nc" id="L369">					empLst.add(newEvent);</span>
<span class="nc" id="L370">				}</span>
<span class="nc" id="L371">				retVal.put(key, empLst);</span>
			}
<span class="nc" id="L373">		}</span>
		// filter &quot;No Activity&quot; events
<span class="nc" id="L375">		filterNoActivity(retVal);</span>

<span class="nc bnc" id="L377" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L378">			StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L379">			buf.append(retVal);</span>

<span class="nc" id="L381">			m_cat.debug(buf.toString());</span>
		}
<span class="nc" id="L383">		return retVal;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>