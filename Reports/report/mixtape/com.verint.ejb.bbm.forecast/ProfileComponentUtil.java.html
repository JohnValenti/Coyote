<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ProfileComponentUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.ejb.bbm.forecast</a> &gt; <span class="el_source">ProfileComponentUtil.java</span></div><h1>ProfileComponentUtil.java</h1><pre class="source lang-java linenums">/*
 * (c) 2012 Verint Systems, Inc.
 */
package com.verint.ejb.bbm.forecast;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;

import com.bluepumpkin.common.datatypes.DayOfWeek;
import com.bluepumpkin.common.datatypes.TimeContext;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.verint.ejb.bbm.forecast.model.ProfileComponent;
import com.verint.ejb.bbm.forecast.model.ProfileComponent.Type;
import com.bluepumpkin.ejb.bbm.time.TimeInterval;
import com.bluepumpkin.ejb.bbm.time.TimeUnits;
import com.verint.ejb.bbm.forecast.model.history.ProfileEntry;

/**
 * This static class provides methods to insert and extract a {@link ProfileComponent}'s
 * absolute date, relative offset, and reference date.  These methods are collected here
 * to keep them out of {@code ProfileComponent} and are not included in {@link ProfileEntry}
 * because of complications arising from that class's constructor design.
 */
public class ProfileComponentUtil {
<span class="nc" id="L27">	public static final SimpleDateFormat DATE_FORMAT = new SimpleDateFormat(&quot;yyyyMMdd H:mm:ss&quot;);</span>
	static {
<span class="nc" id="L29">		DATE_FORMAT.setTimeZone(TimeZoneUtil.GMT_TIMEZONE);		//Date is stored in the DB in GMT time</span>
<span class="nc" id="L30">	}</span>

<span class="nc" id="L32">	private ProfileComponentUtil() {</span>
		// Static class.
<span class="nc" id="L34">	}</span>

	public static int getRelativeOffset(ProfileComponent item) {
<span class="nc bnc" id="L37" title="All 2 branches missed.">		if (Type.Absolute.equals(item.getType())) {</span>
<span class="nc" id="L38">			throw new IllegalArgumentException(&quot;Can't get relative offset for an absolute profile component.&quot;);</span>
		} else {
<span class="nc" id="L40">			String rawValue = item.getValue();</span>
<span class="nc" id="L41">			int offset = 0;</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">			if (item.isMonthly()) {	//Monthly components have their relative offsets stored with negative numbers to represent months back</span>
<span class="nc" id="L43">				offset = -Integer.parseInt(rawValue);</span>
			} else {			//Weekly components have their relative offsets stored with positive numbers to represent weeks back
<span class="nc" id="L45">				offset = Integer.parseInt(rawValue);</span>
			}
<span class="nc" id="L47">			return offset;</span>
		}
	}

	public static Date getAbsoluteDate(ProfileComponent item, TimeContext spTimeContext) {
<span class="nc bnc" id="L52" title="All 2 branches missed.">		if (Type.Relative.equals(item.getType())) {</span>
<span class="nc" id="L53">			throw new IllegalArgumentException(&quot;Can't get absolute date for a relative profile component.&quot;);</span>
		} else {
<span class="nc" id="L55">			String rawValue = item.getValue();</span>
			try {
<span class="nc" id="L57">				Date startDate = DATE_FORMAT.parse(rawValue);</span>
				// Convert date to the start of the business week:
<span class="nc" id="L59">				TimeInterval spWeek = new TimeInterval(TimeUnits.Week, 1, spTimeContext);</span>
				// Push the date forward by one day to avoid problems with time zone.
<span class="nc" id="L61">				startDate = new Date(startDate.getTime() + TimeZoneUtil.DAY_IN_MILLISECONDS);</span>
				// Find the start of the week containing the date using the SP's time context.
<span class="nc" id="L63">				startDate = spWeek.getStartTime(startDate);</span>
				// Truncate the resulting date/time to midnight in the SP's time zone.
<span class="nc" id="L65">				Calendar startCal = Calendar.getInstance(spTimeContext.getTimeZone());</span>
<span class="nc" id="L66">				startCal.setTime(startDate);</span>
<span class="nc" id="L67">				startCal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L68">				startCal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L69">				startCal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L70">				startCal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L71">				return startCal.getTime();</span>
			}
<span class="nc" id="L73">			catch (ParseException pe) {</span>
<span class="nc" id="L74">				throw new IllegalArgumentException(&quot;ProfileComponent had invalid date string &quot; + rawValue + &quot; in its VALUE field&quot;);</span>
			}
		}
	}
	
	/**
	 * Returns the date of this profile component.  The reference date is required in case
	 * this is a relative profile component, in which case it will return a relative date
	 * from the reference date (the date being adjusted a number of weeks or months away from the
	 * reference date).
	 * 
	 * Note that if this is an absolute ProfileComponent, the time component of this date will always
	 * be midnight at the Campaign's time zone, regardless of the day boundary of the Campaign (Campaign
	 * being the Campaign of the SP of the SP week to which this ProfileComponent belongs).
	 * 
	 * NOTE: If this is an absolute monthly or custom week component, the date value returned from this method may
	 * be incorrect.  Do not use the getDate method for these types of components!  For some reason, the FS
	 * Client stores an incorrect date value for these types of components.  Use getCustomDates() for these
	 * components instead.
	 * 
	 * @param spTimeContext the SP's time context
	 * @param spWeekStart the start of the current SP week, in the SP's time zone
	 */
	public static Date getDate(ProfileComponent component, TimeContext spTimeContext, Date spWeekStart) {
<span class="nc bnc" id="L98" title="All 2 branches missed.">		if (Type.Absolute.equals(component.getType())) {</span>
<span class="nc" id="L99">			return getAbsoluteDate(component, spTimeContext);</span>
		} else {
<span class="nc" id="L101">			Calendar c = Calendar.getInstance(spTimeContext.getTimeZone());</span>
<span class="nc" id="L102">			c.setTime(spWeekStart);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">			if (component.isMonthly()) {</span>
<span class="nc" id="L104">				c.add(Calendar.MONTH, -getRelativeOffset(component));</span>
			} else {
<span class="nc" id="L106">				c.add(Calendar.WEEK_OF_YEAR, -getRelativeOffset(component));</span>
			}
<span class="nc" id="L108">			return c.getTime();</span>
		}
	}

	/**
	 * Sets the absolute date of this profile component, which is what ends up being persisted on the
	 * VALUE field in the database.  This date should be the start date of this component (history week), with the
	 * time value corresponding to midnight (regardless of the SP's day boundary) at the SP's TimeZone.
	 */
	public static void setAbsoluteDate(ProfileComponent component, Date absoluteDate) {
<span class="nc" id="L118">		component.setType(Type.Absolute);</span>
<span class="nc" id="L119">		component.setValue(DATE_FORMAT.format(absoluteDate));</span>
<span class="nc" id="L120">	}</span>

	/**
	 * @param relativeOffset number of weeks (or months if isMonthly is true) in the past (a positive integer)
	 */
	public static void setRelativeOffset(ProfileComponent component, int relativeOffset) {
<span class="nc" id="L126">		component.setType(Type.Relative);</span>
<span class="nc" id="L127">		component.setValue(&quot;&quot; + relativeOffset);</span>
<span class="nc" id="L128">	}</span>


	/**
	 * Returns the nearest week start date lying before selectedDate (or on, if selectedDate is at start of week already),
	 * using timeContext's definition for week start.
	 */
	public static Date findNearestStartOfWeekDateBehindSelectedDate(Date selectedDate, TimeContext timeContext) {
<span class="nc" id="L136">		Calendar cal = Calendar.getInstance(timeContext.getTimeZone());</span>
<span class="nc" id="L137">		cal.setTime(selectedDate);</span>
<span class="nc" id="L138">		DayOfWeek startDayOfWeek = timeContext.getStartDayOfWeek();</span>

<span class="nc bnc" id="L140" title="All 2 branches missed.">		while (cal.get(Calendar.DAY_OF_WEEK) != startDayOfWeek.getCalendarConstant()) {</span>
<span class="nc" id="L141">			cal.add(Calendar.DATE, -1);</span>
		}

<span class="nc" id="L144">		return cal.getTime();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>