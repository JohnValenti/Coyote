<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestStatusChangeRuleChecker.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.notification.rulecheckers</a> &gt; <span class="el_source">RequestStatusChangeRuleChecker.java</span></div><h1>RequestStatusChangeRuleChecker.java</h1><pre class="source lang-java linenums">/*
 * Created on Sep 25, 2003
 *
 * To change this generated comment go to 
 * Window&gt;Preferences&gt;Java&gt;Code Generation&gt;Code and Comments
 */
package com.bluepumpkin.ejb.rm.notification.rulecheckers;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.w3c.dom.Document;
import org.w3c.dom.Element;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.localization.LocaleContext;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.cache.CacheUtilBBM;
import com.bluepumpkin.ejb.bbm.notifyrules.model.ActionDetail;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleParameter;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate;
import com.bluepumpkin.ejb.bbm.notifyrules.rulecheckers.AbstractRuleChecker;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourceAssignment;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.rm.notification.model.RequestNotificationDetail;
import com.bluepumpkin.ejb.rm.notification.notifyrules.RequestTypeSelector;
import com.bluepumpkin.ejb.rm.notification.util.NotificationUtil;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestFieldInfo;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.witness.ejb.core.security.UserManager;


/**
 * This code lives in BBM, rather than RM, due to class loader issues
 * in the development environment with 2 EAR files.  These class loader issues
 * do not exist in the produciton version which has a single EAR file.
 * &lt;p/&gt;
 * &lt;p&gt; BBM's notification framework needs to load this rule checker class
 * to check if a notification must be sent or not.
 * &lt;li&gt;In the 2 EAR file approach
 * in development environment, the Notification framework lives in OtherEjbsAndWars.ear
 * while the RM module lives in EjbsAndWarsToBeUnitTested.ear.  The notification framework
 * cannot load this rule checker since RmEjbTierUtils.jar (which contains this rule checker)
 * is not added to the classpath
 * of the class loader created for OtherEjbsAndWars.ear (To add an entry to the class loader's
 * classpath, the .jar must be specified in one of the manifest class paths of the EJB .jar
 * files.  In this case RmEjbTierUtils.jar must be added to the classpath of any EJB jars
 * in OtherEjbsAndWars.ear).
 * &lt;li&gt; In the 1 EAR approach in the production environment, RM EJB jars reside in the same
 * EAR file as BBM EJB jars and RM EJB jars refer to RmEjbTierUtils.jar in their manifest
 * classpath.  This results in RmEjbTierUtils.jar being added to the classloader's classpath
 * and makes the rule checker visible to BBM's notification framework.
 * &lt;p/&gt;
 * &lt;p&gt; The same issues apply for the value objects RequestNotificationDetail and
 * SerializedAuctionDetail value objects passed by RM to BBM's notification framework.
 *
 * @author rrajendran
 *         &lt;p/&gt;
 *         To change this generated comment go to
 *         Window&gt;Preferences&gt;Java&gt;Code Generation&gt;Code and Comments
 */
<span class="nc" id="L83">public class RequestStatusChangeRuleChecker extends AbstractRuleChecker {</span>
<span class="nc" id="L84">	private static final String m_className = RequestStatusChangeRuleChecker.class.getName();</span>

<span class="nc" id="L86">	private static final Category m_cat = Log.initCategory(m_className);</span>

	/**
	 * These are the parameters defined for the &quot;RequestStatusChange notification rule template&quot;.
	 * Each instance of this rule template has values assigned to these parameters.
	 * &lt;p/&gt;
	 * This rule checker checks the rule's (passed as an argument) parameters against
	 * the request status change details (passed as an argument) to determine if the rule must fire or not.
	 */
	public static final String RULE_PARAMNAME_REQUEST_TYPE = &quot;rulerequesttype&quot;;
	public static final String RULE_PARAMNAME_STATUS_CHANGE_TYPE = &quot;rulerequesttype_SEC&quot;;

	public static final String STATUSCHANGETYPE_AUTOPROCESS_APPROVED =
	        &quot;AutoProcess &quot; + RequestAuditTrail.STATUS_APPROVED;
	public static final String STATUSCHANGETYPE_AUTOPROCESS_DENIED =
	        &quot;AutoProcess &quot; + RequestAuditTrail.STATUS_DENIED;

	/*
	INSERT INTO NOTIFYRULETEMPLATE (ID, NAME, IMPLEMENTATIONCLASS, XMLTEXT, TIMERFREQUENCY)
	VALUES (- 249004, 'Reqeust status change rule', 'com.bluepumpkin.ejb.rm.notification.notifyrules.RequestStatusChangeRuleChecker',
	'&lt;Clause&gt;
	            &lt;Text&gt;Request Type&lt;/Text&gt;
	            &lt;Selector name=&quot;rulerequesttype&quot;&gt;
	                element
	                &lt;e&gt; time-off &lt;/e&gt;
	                &lt;e&gt; shift-swap &lt;/e&gt;
	                &lt;e&gt; shift-bid &lt;/e&gt;
	            &lt;/Selector&gt;
	            &lt;Text&gt; Status Change Type &lt;/Text&gt;
	            &lt;Selector name=&quot;rulestatuschangetype&quot;&gt;
	                element
	                &lt;e&gt;Autoprocess Approved&lt;/e&gt;
	                &lt;e&gt;Autoprocess Denied&lt;/e&gt;
	                &lt;e&gt;Approved&lt;/e&gt;
	                &lt;e&gt;Denied&lt;/e&gt;
	                &lt;e&gt;Pending&lt;/e&gt;
	                &lt;e&gt;Escalaed&lt;/e&gt;
	                &lt;e&gt;Invalidated&lt;/e&gt;
	            &lt;/Selector&gt;
	        &lt;/Clause&gt;
	', NULL)
	*/

	/*
	 * Note: Key used must correspond to the XMLText associated with template rule (See SQL above).
	 */
<span class="nc" id="L132">	public static final Map STATUSCHANGETYPE_VALIDVALUES_MAP = new HashMap();</span>

	static {
//        STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(0), STATUSCHANGETYPE_AUTOPROCESS_APPROVED);
//        STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(1), STATUSCHANGETYPE_AUTOPROCESS_DENIED);
<span class="nc" id="L137">		STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(0), RequestAuditTrail.STATUS_APPROVED);</span>
<span class="nc" id="L138">		STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(1), RequestAuditTrail.STATUS_DENIED);</span>
<span class="nc" id="L139">		STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(2), RequestAuditTrail.STATUS_PENDING);</span>
<span class="nc" id="L140">		STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(3), RequestAuditTrail.STATUS_ESCALATED);</span>
<span class="nc" id="L141">		STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(4), RequestAuditTrail.STATUS_INVALID);</span>
<span class="nc" id="L142">		STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(5), RequestAuditTrail.STATUS_WAITLIST);</span>
<span class="nc" id="L143">		STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(6), RequestAuditTrail.STATUS_WITHDRAW_REQUEST);</span>
<span class="nc" id="L144">		STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(7), RequestAuditTrail.STATUS_WITHDRAW_ACCEPT);</span>
<span class="nc" id="L145">		STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(8), RequestAuditTrail.STATUS_WITHDRAW_REJECT);</span>
<span class="nc" id="L146">		STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(9), RequestAuditTrail.STATUS_NEGOTIATION);</span>
		//STATUS_NEGOTIATION Applies to shiftswap only and maps to &quot;Change in Ownership&quot; in UI
<span class="nc" id="L148">		STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(10), RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION);</span>
		// This status is added for shift swap withdraw cancellation notification only. doesn't apply for TO
<span class="nc" id="L150">		STATUSCHANGETYPE_VALIDVALUES_MAP.put(new Integer(11), RequestAuditTrail.STATUS_WITHDRAW_CANCEL);</span>
<span class="nc" id="L151">	}</span>

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker#testRule(com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule, java.lang.Object)
	 */
	@Override
	public ActionDetail testRule(NotifyRule notifyRule, Object notifDetail) throws Exception {
		// if notifyDetail is not a RequestNotificationDetail instance, then notification
		// not by the RM subsystem.
<span class="nc bnc" id="L160" title="All 2 branches missed.">		if (!(notifDetail instanceof RequestNotificationDetail)) {</span>
<span class="nc" id="L161">			return null;</span>
		}

		// get rule's orgID
<span class="nc bnc" id="L165" title="All 2 branches missed.">		if (notifyRule.getScopeType() != notifyRule.ORG_SCOPE) {</span>
			//should throw exception here ?????
<span class="nc" id="L167">			return null;</span>
		}
<span class="nc" id="L169">		ID ruleOrgID = notifyRule.getScopeID();</span>

<span class="nc" id="L171">		RequestNotificationDetail reqNotifDetail = (RequestNotificationDetail) notifDetail;</span>
<span class="nc" id="L172">		m_cat.debug(&quot;processing request notification detail: &quot; + reqNotifDetail);</span>

		// Fetch the rule parameters to find the ruleSubtype and requestStatusChangeType.
		// Rule parameters are passed to this method as String representation of integers.
<span class="nc" id="L176">		Integer ruleReqTypeInt = null;</span>
<span class="nc" id="L177">		Integer ruleStatusChangeTypeInt = null;</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">		for (Iterator itRuleParameter = notifyRule.getRuleParameters().iterator(); itRuleParameter.hasNext();) {</span>
<span class="nc" id="L179">			NotifyRuleParameter notifyRuleParameter = (NotifyRuleParameter) itRuleParameter.next();</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">			if (notifyRuleParameter.getName().toLowerCase().equals(RULE_PARAMNAME_REQUEST_TYPE)) {</span>
<span class="nc" id="L181">				ruleReqTypeInt = (Integer) notifyRuleParameter.getValue();</span>
			}

<span class="nc bnc" id="L184" title="All 2 branches missed.">			if (notifyRuleParameter.getName().toLowerCase().equals(RULE_PARAMNAME_STATUS_CHANGE_TYPE.toLowerCase())) {</span>
<span class="nc" id="L185">				ruleStatusChangeTypeInt = (Integer) notifyRuleParameter.getValue();</span>
			}
<span class="nc" id="L187">		}</span>

<span class="nc" id="L189">		Map&lt;Integer, String&gt; requestTypeMap = RequestTypeSelector.getRequestTypeMap();</span>
		
		// if rule request type was not specified, then raise an exception.
<span class="nc bnc" id="L192" title="All 4 branches missed.">		if (ruleReqTypeInt == null || !(requestTypeMap.containsKey(ruleReqTypeInt))) {</span>
<span class="nc" id="L193">			throw RequestUtil.createIllegalArgumentException(&quot;&quot; + notifyRule.getID() + ',' +</span>
					RULE_PARAMNAME_REQUEST_TYPE + ',' + ruleReqTypeInt, m_cat);
		}

		// if rule request status change type was not specified, then raise an exception.
<span class="nc bnc" id="L198" title="All 4 branches missed.">		if (ruleStatusChangeTypeInt == null || !STATUSCHANGETYPE_VALIDVALUES_MAP.containsKey(ruleStatusChangeTypeInt)) {</span>
<span class="nc" id="L199">			throw RequestUtil.createIllegalArgumentException(&quot;&quot; + notifyRule.getID() + ',' +</span>
					RULE_PARAMNAME_STATUS_CHANGE_TYPE + ',' + ruleStatusChangeTypeInt, m_cat);
		}

<span class="nc" id="L203">        String ruleReqTypeStr = requestTypeMap.get(ruleReqTypeInt);</span>
<span class="nc" id="L204">		String ruleStatusChangeTypeStr = (String) STATUSCHANGETYPE_VALIDVALUES_MAP.get(ruleStatusChangeTypeInt);</span>
<span class="nc" id="L205">		m_cat.debug(&quot;Processing rule: reqType, statusChageType = &quot; + ruleReqTypeStr + ',' + ruleStatusChangeTypeStr);</span>

<span class="nc" id="L207">		RequestAggregate reqAgg = reqNotifDetail.getReqAgg();</span>
		// Modify the request type here for Flex requests so as to avoid error during below check
<span class="nc bnc" id="L209" title="All 2 branches missed.">		if(reqAgg.isFlexTimeRequest()) {</span>
<span class="nc" id="L210">			reqAgg.getAggregatedRequest().setFieldValue(RequestFieldInfo.REQUEST_S_REQUESTTYPE, Request.REQUESTTYPE_FLEXTIME);</span>
		}

		// check rule's request type to see if it applies to this status change notification
<span class="nc" id="L214">		String givenRequestType = reqAgg.getRequestType();</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">		if (!ruleReqTypeStr.equals(givenRequestType)) {</span>
<span class="nc" id="L216">			m_cat.debug(&quot;Rule failed: ruleReqTypeStr != passed request type: &quot; + ruleReqTypeStr + &quot; != &quot; + givenRequestType);</span>
<span class="nc" id="L217">			return null;</span>
		}

		// check if rule's status change type matches notification's status change type.
<span class="nc" id="L221">		String newReqStatus = reqNotifDetail.getNewRequestStatus();</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">		if (!ruleStatusChangeTypeStr.equals(newReqStatus)) {</span>
<span class="nc" id="L223">			m_cat.debug(&quot;Rule failed: ruleStatusChangeTypeStr != passed request statusChangeType: &quot; + ruleStatusChangeTypeStr + &quot; != &quot; + newReqStatus);</span>
<span class="nc" id="L224">			return null;</span>
		}

		// Now determine which employees, associated with the request, the rule applies
		// to. Consider this scenario: emp1 is associated with org1; emp2 is assoc with org2;
		// shift swap request between emp1 and emp2; notification rule defined in org1;.  In
		// this scenario, notification must be sent to emp1 but not emp2.

<span class="nc" id="L232">		List reqEmpIDs = null;</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">		if (Request.REQUESTTYPE_SHIFTSWAP.equals(givenRequestType)) {</span>
<span class="nc" id="L234">			ShiftSwapRequest ssr = (ShiftSwapRequest) reqAgg;</span>

			// method is not named correctly.  Returns a collection of employee IDs and not employees.
<span class="nc" id="L237">			reqEmpIDs = ssr.getEmployees();</span>

<span class="nc" id="L239">		} else {</span>
<span class="nc" id="L240">			reqEmpIDs = Collections.singletonList(reqAgg.getEmployeeID());</span>
		}

		// For employee's associated with the request, get the empID to orgID mapping
<span class="nc" id="L244">		WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L245">		Map reqEmpIDtoWRAssnWithTZMap = getWRAssnsWithTimeZone(reqAgg.getEmpIDTimeRangePairs(), wrm);</span>

		// Verify if the rule is defined in the employee's orgID or one of its parent orgIDs
		//
		// For each empID, verify if the emp's orgID or its parent orgIDs match the rule's orgID.
		// If match found, then save the matching employee ID(s).
<span class="nc" id="L251">		List empIDsInRuleOrgIDOrItsChildren = null;</span>
<span class="nc" id="L252">		Map empIDToTZMap = new HashMap(reqEmpIDtoWRAssnWithTZMap.size() * 2);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">		for (Iterator mapEntryIter = reqEmpIDtoWRAssnWithTZMap.entrySet().iterator(); mapEntryIter.hasNext();) {</span>
<span class="nc" id="L254">			Map.Entry mapEntry = (Map.Entry) mapEntryIter.next();</span>

<span class="nc" id="L256">			ID reqEmpID = (ID) mapEntry.getKey();</span>
<span class="nc" id="L257">			WorkResourceAssignment wrAssn = (WorkResourceAssignment) mapEntry.getValue();</span>

			// add the TZ for the workresource to the map
<span class="nc" id="L260">			empIDToTZMap.put(reqEmpID, wrAssn.getStartTimeZone());</span>

			// get the org ID and its parents for the employee's org.
<span class="nc" id="L263">			ID empOrgID = wrAssn.getOrganizationID();</span>
<span class="nc" id="L264">			Collection empOrgParentIDs = CacheUtilBBM.getParentOrgIDs(empOrgID, null);</span>

			// if ruleOrgID != empOrgID and ruleOrgID != any of emp's parent orgID
<span class="nc bnc" id="L267" title="All 4 branches missed.">			if (!ruleOrgID.equals(empOrgID) &amp;&amp; !empOrgParentIDs.contains(ruleOrgID)) {</span>
<span class="nc" id="L268">				continue;</span>
			}

<span class="nc bnc" id="L271" title="All 2 branches missed.">			if (Request.REQUESTTYPE_SHIFTSWAP.equals(givenRequestType)</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">			        &amp;&amp; (RequestAuditTrail.STATUS_NEGOTIATION.equals(newReqStatus) ||</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">			        		RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION.equals(newReqStatus))</span>
<span class="nc bnc" id="L274" title="All 4 branches missed.">			        &amp;&amp; reqNotifDetail.getEmployeeID() != null &amp;&amp; reqNotifDetail.getEmployeeID().equals(reqEmpID)) {</span>
				// included the shift swap withdrawal negotiation status as well to behave similar as the general negotiation
				//This employee does not need to be notified since he is the one who added the comment /changed expiry date etc.
<span class="nc" id="L277">				continue;</span>
			}
			// allocate list if necessary.
<span class="nc bnc" id="L280" title="All 2 branches missed.">			empIDsInRuleOrgIDOrItsChildren = (empIDsInRuleOrgIDOrItsChildren == null) ?</span>
			        new ArrayList(2) : empIDsInRuleOrgIDOrItsChildren;

			// add employee ID to collection.
<span class="nc" id="L284">			empIDsInRuleOrgIDOrItsChildren.add(reqEmpID);</span>
<span class="nc" id="L285">		}</span>

		// if no employee's in rule's organization or its children, then rule does not fire.
<span class="nc bnc" id="L288" title="All 4 branches missed.">		if (empIDsInRuleOrgIDOrItsChildren == null || empIDsInRuleOrgIDOrItsChildren.isEmpty()) {</span>
<span class="nc" id="L289">			m_cat.debug(&quot;No employee for this request is associated with rule's orgID or its children: &quot; + ruleOrgID);</span>
<span class="nc" id="L290">			return null;</span>
		}

<span class="nc" id="L293">		Map empIDToEmpNameMap = wrm.getEmployeeNamesByIDs(reqEmpIDs);</span>

		// we have determined that the rule's requestType and statusChangeType match the request and
		// the request's employees belong to the rule's org.  Now format the notification message
		//ActionDetail actionDetail = new ActionDetail();
<span class="nc" id="L298">		UserManager userManager = CoreManagerFactory.getUserManager(false);</span>
<span class="nc" id="L299">		RequestStatusChangeActionDetail actionDetail = new RequestStatusChangeActionDetail(m_parser, reqAgg, m_localizer, empIDToTZMap, newReqStatus, userManager);</span>
<span class="nc" id="L300">		actionDetail.setIsSupervisorMessageCustomized(true);</span>
<span class="nc" id="L301">		actionDetail.setIsRoleMessageCustomized(true);</span>
<span class="nc" id="L302">		actionDetail.setIsUserIDMessageCustomized(true);</span>
<span class="nc" id="L303">		actionDetail.setIsSpecialTargetMessageCustomized(true);</span>

<span class="nc" id="L305">		actionDetail.setObjectType(ActionDetail.WORKRESOUCEID);</span>
<span class="nc" id="L306">		String requestType = reqAgg.getRequestType();</span>
<span class="nc" id="L307">		Element rootElem = null;</span>
<span class="nc" id="L308">		Document doc = m_parser.newDocument();</span>
<span class="nc bnc" id="L309" title="All 4 branches missed.">		if (reqAgg.isTimeOffRequest() &amp;&amp; ((TORequest) reqAgg).getWithdrawInfo() != null) {</span>
<span class="nc" id="L310">			requestType = Request.REQUESTTYPE_TIMEOFF_WITHDRAW;</span>
		}
<span class="nc bnc" id="L312" title="All 2 branches missed.">		for (Iterator iter = empIDsInRuleOrgIDOrItsChildren.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L313">			ID empIDInRuleOrgOrItsChildren = (ID) iter.next();</span>

			// append the necessary elements to descripe the request change.
<span class="nc" id="L316">			rootElem = NotificationUtil.getXMLLocalizedFrag(null, reqAgg, doc, m_localizer,</span>
			        empIDToTZMap, newReqStatus);
			//add url for agent
<span class="nc" id="L319">			NotificationUtil.createAndAppendXMLLocalizedFragForRequestURL(rootElem, reqAgg, false);</span>
<span class="nc" id="L320">			actionDetail.setDetails(empIDInRuleOrgOrItsChildren, rootElem);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">			if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc" id="L322">				m_cat.info(&quot;Sending notification: &quot; + RequestUtil.getXMLStringForElemOrDoc(rootElem, rootElem.getOwnerDocument()));</span>
			}
<span class="nc" id="L324">			m_cat.debug(&quot;Sending notification: &quot; + RequestUtil.getXMLStringForElemOrDoc(null, rootElem.getOwnerDocument()));</span>
<span class="nc" id="L325">		}</span>

//      set actionDetail as per delivery targets of the rule
//      combine and get personalized url for supervisors
<span class="nc" id="L329">		HashMap messageMap = new HashMap();</span>
//        HashMap mapCustomizedMsg = NotificationUtil.getCustomizedMessagesMap(notifyRule, actionDetail,
//        		wrm, reqAgg, rootElem, m_parser, messageMap, m_localizer, empIDToTZMap, newReqStatus);

		/*
		actionDetail.setObjectType(ActionDetail.WORKRESOUCEID);
		if (mapCustomizedMsg != null) {
			for (Iterator it = mapCustomizedMsg.keySet().iterator(); it.hasNext();) {
				Object obj = it.next();
				if (obj instanceof String){
					Element elem = (Element)mapCustomizedMsg.get(obj);
					appendTextNode(elem, NotifyRule.CUSTOMIZE_MESSAGE, &quot; &quot;);
					actionDetail.setSpecialTargetDetails(obj, (Element)mapCustomizedMsg.get(obj));
				}
				else {
					ID workResourceID = (ID)obj;
					Element elem = (Element)mapCustomizedMsg.get(workResourceID);
					appendTextNode(elem, NotifyRule.CUSTOMIZE_MESSAGE, &quot; &quot;);
					actionDetail.setDetails(obj, elem);
				}
			}
		}*/

<span class="nc" id="L352">		return actionDetail;</span>
	}

	public static Map getWRAssnsWithTimeZone(Collection wrAssnForEmps, WorkResourceManager wrm)
	        throws BbmFinderException, RemoteException, BbmEJBCreateException {

<span class="nc bnc" id="L358" title="All 2 branches missed.">		wrm = (wrm == null) ? BbmManagerFactory.getWorkResourceManager() : wrm;</span>
<span class="nc" id="L359">		Map empTimeHashMap = new HashMap();</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">		for (Iterator iterator = wrAssnForEmps.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L361">			Pair empPair = (Pair) iterator.next();</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">			if (empTimeHashMap.get(empPair.getFirst()) == null) { //we only want the first request for the employee</span>
<span class="nc" id="L363">				empTimeHashMap.put(empPair.getFirst(), empPair.getSecond());</span>
			}
<span class="nc" id="L365">		}</span>
<span class="nc" id="L366">		Map workResIDToworkResAssnsMap = wrm.getWRAssignmentsWithTimeZone(empTimeHashMap.keySet());</span>
		//Sameet, march 2006 get all wrk assignments
		// select the organization  where request start date falls between org start date and end date
<span class="nc" id="L369">		Set entrySet = workResIDToworkResAssnsMap.entrySet();</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">		for (Iterator iter = entrySet.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L371">			Map.Entry mapEntry = (Map.Entry) iter.next();</span>
<span class="nc" id="L372">			Collection wrAssns = (Collection) mapEntry.getValue();</span>
<span class="nc bnc" id="L373" title="All 4 branches missed.">			if (wrAssns == null || wrAssns.isEmpty()) {</span>
<span class="nc" id="L374">				throw new RuntimeException(&quot;&quot; + mapEntry.getKey() + &quot;Employee is not assigned to any organization&quot;);</span>
			}
<span class="nc bnc" id="L376" title="All 2 branches missed.">			for (Iterator iterator = wrAssns.iterator(); iterator.hasNext();) {</span>
				// In the map, replace collection with the single workResourceAssn in the collection
<span class="nc" id="L378">				WorkResourceAssignment wra = (WorkResourceAssignment) iterator.next();</span>
<span class="nc" id="L379">				TimeRange timeRange = (TimeRange) empTimeHashMap.get(wra.getParentID());</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">				if (fallsIn(timeRange.getStartDate(), wra.getStartTime(), wra.getEndTime())) {</span>
<span class="nc" id="L381">					mapEntry.setValue(wra);</span>
<span class="nc" id="L382">					break;</span>
				}
<span class="nc" id="L384">			}</span>
<span class="nc" id="L385">		}</span>
<span class="nc" id="L386">		return workResIDToworkResAssnsMap;</span>
	}

	protected static boolean fallsIn(Date point, Date start, Date end) {
<span class="nc bnc" id="L390" title="All 2 branches missed.">		if (start == null) {</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">			if (end != null) {</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">				return !point.after(end);</span>
			}
		} else {
<span class="nc bnc" id="L395" title="All 2 branches missed.">			if (!point.before(start)) {</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">				if (end != null) {</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">					return !point.after(end);</span>
				}
			} else {
<span class="nc" id="L400">				return false;</span>
			}
		}
<span class="nc" id="L403">		return true;</span>
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker#isRuleValid(com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule, com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate)
	 */
	@Override
	public boolean isRuleValid(NotifyRule rule, NotifyRuleTemplate template) {
<span class="nc" id="L411">		return true;</span>
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker#getRuleViolation(com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule, com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate, com.bluepumpkin.common.localization.LocaleContext)
	 */
	@Override
	public String getRuleViolation(NotifyRule rule, NotifyRuleTemplate template, LocaleContext context) {
<span class="nc" id="L419">		return null;</span>
	}
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>