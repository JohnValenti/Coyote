<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PayrollProviderSetupManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.am.payrollmanager.ejb</a> &gt; <span class="el_source">PayrollProviderSetupManagerEJB.java</span></div><h1>PayrollProviderSetupManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.am.payrollmanager.ejb;

import java.io.IOException;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoDuplicateKeyException;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoParam;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.logging.Priority;
import com.bluepumpkin.ejb.am.Log;
import com.bluepumpkin.ejb.am.base.AmCreateDuplicateKeyException;
import com.bluepumpkin.ejb.am.base.AmException;
import com.bluepumpkin.ejb.am.base.AmUpdateDuplicateKeyException;
import com.bluepumpkin.ejb.am.l10n.AmEjbBundleKey;
import com.bluepumpkin.ejb.am.payrollmanager.model.DataSourcePayrollProvider;
import com.bluepumpkin.ejb.am.payrollmanager.model.PayrollEarningTypeMapping;
import com.bluepumpkin.ejb.am.payrollmanager.model.PayrollExportConfig;
import com.bluepumpkin.ejb.am.payrollmanager.model.PayrollProvider;
import com.bluepumpkin.ejb.am.payrollmanager.util.PayrollProviderConfigBuilder;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.datasource.ejb.DataSourceManager;
import com.bluepumpkin.ejb.bbm.datasource.model.DataSource;
import com.bluepumpkin.ejb.bbm.datasourcetype.model.DataSourceType;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;

/**
 * Title:        Blue Pumpkin Software Activity Management
 * Description:  EJB Implementation for PayrollProviderManager
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       Sheng Song
 * @version 1.0
 */

<span class="nc" id="L47">public class PayrollProviderSetupManagerEJB extends SessionEJBBase {</span>

<span class="nc" id="L49">	private static Category m_cat = Log.initCategory(PayrollProviderSetupManagerEJB.class.getName());</span>
		/** override the base class to provide the appropriate logging category */
	protected Category getCategory() {
<span class="nc" id="L52">		return m_cat;</span>
	}

	{
<span class="nc" id="L56">		super.init(PayrollProviderSetupManagerEJB.class.getName());</span>
<span class="nc" id="L57">	}</span>
	/**
	 * Load all PayrollProvidersdefined
	 * @return Collection, (DataSourceName, DATASOURCEPAYROLLPROVIDERID)
	 */
	public Collection getAllPayrollProviders()
								throws AmException
	{
<span class="nc" id="L65">		methodStart(&quot;getAllPayrollProviders&quot;);</span>
<span class="nc" id="L66">		Jdmo jdmo = null;</span>
<span class="nc" id="L67">		JdmoRowset rs = null;</span>
<span class="nc" id="L68">		HashMap map = new HashMap();</span>
		try {
<span class="nc" id="L70">			jdmo = new Jdmo();</span>
<span class="nc" id="L71">			String pStmt =</span>
&quot;select A.ID, A.NAME, CONFIGFILENAME, FORMATTERFILENAME, A.DESCRIPTION, B.ID from PAYROLLPROVIDER A, DATASOURCEPAYROLLPROVIDER B where B.PAYROLLPROVIDERID &quot;+
<span class="nc" id="L73">jdmo.getOuterJoin()+&quot; A.ID&quot;;</span>
<span class="nc" id="L74">			JdmoQuery jQuery1 = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L75">			rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L77">				ID id = rs.getID(1);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">				if (map.get(id) == null) {</span>
<span class="nc" id="L79">					PayrollProvider pp = new PayrollProvider(</span>
										 id,
<span class="nc" id="L81">										 rs.getString(2),</span>
<span class="nc" id="L82">										 rs.getString(&quot;CONFIGFILENAME&quot;),</span>
<span class="nc" id="L83">										 rs.getString(&quot;FORMATTERFILENAME&quot;),</span>
<span class="nc" id="L84">										 rs.getString(5));</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">					pp.setIsConfigured(!(rs.getID(6)==null));</span>
<span class="nc" id="L86">					map.put(id, pp);</span>
				}
<span class="nc" id="L88">			}</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">			if (map.isEmpty())</span>
<span class="nc" id="L90">				return Collections.EMPTY_LIST;</span>
<span class="nc" id="L91">			return new ArrayList(map.values());</span>
<span class="nc" id="L92">		} catch (JdmoException e) {</span>
<span class="nc" id="L93">			handleException(e, false);</span>
<span class="nc" id="L94">			throw new AmException(e);</span>
		} finally {
<span class="nc bnc" id="L96" title="All 6 branches missed.">			if (rs != null)</span>
				try {
<span class="nc" id="L98">					rs.close();</span>
<span class="nc" id="L99">				} catch (Exception e) {}</span>
<span class="nc bnc" id="L100" title="All 6 branches missed.">			if (jdmo != null)</span>
<span class="nc" id="L101">				jdmo.cleanUp();</span>
<span class="nc" id="L102">			methodFinish();</span>
		}
	}
	/**
	 * Return the Config file location
	 * @param ID
	 * @return String, Version of the XML File, throw Exception if file doesn't exist
	 */
	public String getConfigVersionByPayrollProviderID(ID ppID)
								throws AmException
	{
<span class="nc" id="L113">		methodStart(&quot;getConfigLocationByPayrollProviderID&quot;, ppID);</span>
<span class="nc" id="L114">		Jdmo jdmo = null;</span>
<span class="nc" id="L115">		JdmoRowset rs = null;</span>
		try {
<span class="nc" id="L117">			jdmo = new Jdmo();</span>
<span class="nc" id="L118">			String pStmt =</span>
				&quot;select CONFIGFILENAME from PAYROLLPROVIDER where ID=?&quot;;
<span class="nc" id="L120">			JdmoQuery jQuery1 = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L121">			jQuery1.setParID(1, ppID);</span>
<span class="nc" id="L122">			rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">			if (rs.next())</span>
<span class="nc" id="L124">				return PayrollProviderConfigBuilder.getVersion(rs.getString(&quot;CONFIGFILENAME&quot;));</span>
<span class="nc" id="L125">			return null;</span>
<span class="nc" id="L126">		} catch(Exception e) {</span>
<span class="nc" id="L127">			handleException(e, false);</span>
<span class="nc" id="L128">			throw new AmException(e);</span>
		} finally {
<span class="nc bnc" id="L130" title="All 6 branches missed.">			if (rs != null)</span>
				try {
<span class="nc" id="L132">					rs.close();</span>
<span class="nc" id="L133">				} catch (Exception e) {}</span>
<span class="nc bnc" id="L134" title="All 6 branches missed.">			if (jdmo != null)</span>
<span class="nc" id="L135">				jdmo.cleanUp();</span>
<span class="nc" id="L136">			methodFinish();</span>
		}
	}
	/**
	 * Load all DataSource the type is PayrollProvider defined
	 * @return Collection, DataSourcePayrollProvider
	 */
	public Collection findAllPayrollProviderDataSources()
								throws AmException
	{
<span class="nc" id="L146">		methodStart(&quot;findAllPayrollProviderDataSources&quot;);</span>
<span class="nc" id="L147">		Jdmo jdmo = null;</span>
<span class="nc" id="L148">		JdmoRowset rs = null;</span>
<span class="nc" id="L149">		Collection col = new ArrayList(5);</span>
		try {
<span class="nc" id="L151">			jdmo = new Jdmo();</span>
<span class="nc" id="L152">			String pStmt =</span>
&quot;select a.ID, b.NAME, b.DESCRIPTION, c.NAME, DATASOURCEID, PAYROLLPROVIDERID, EXPORTDESTINATION, CONFIGFILEVERSION from DATASOURCEPAYROLLPROVIDER a, DATASOURCE b, PAYROLLPROVIDER c where a.DATASOURCEID = b.ID and b.ISDELETED = 0 and a.PAYROLLPROVIDERID = c.ID&quot;;
<span class="nc" id="L154">			JdmoQuery jQuery1 = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L155">			rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L157">				ID dsppID = rs.getID(&quot;ID&quot;);</span>
<span class="nc" id="L158">				DataSourcePayrollProvider dspp = new DataSourcePayrollProvider(</span>
												 dsppID,
<span class="nc" id="L160">												 rs.getID(&quot;DATASOURCEID&quot;),</span>
<span class="nc" id="L161">												 rs.getID(&quot;PAYROLLPROVIDERID&quot;),</span>
<span class="nc" id="L162">												 rs.getString(&quot;EXPORTDESTINATION&quot;),</span>
<span class="nc" id="L163">												 rs.getString(&quot;CONFIGFILEVERSION&quot;));</span>
<span class="nc" id="L164">				dspp.setDataSourceName(rs.getString(2));</span>
<span class="nc" id="L165">				dspp.setPayrollProviderName(rs.getString(4));</span>
<span class="nc" id="L166">				dspp.setDescription(rs.getString(&quot;DESCRIPTION&quot;));</span>
<span class="nc" id="L167">				col.add(dspp);</span>
<span class="nc" id="L168">			}</span>
<span class="nc" id="L169">   			String pStmt2 =</span>
&quot;select a.NAME, b.NAME, a.ID, EARNINGTYPEID from PAYROLLEARNINGTYPE a, EARNINGTYPE b where a.DATASOURCEPAYROLLPROVIDERID=? and a.EARNINGTYPEID=b.ID&quot;;
<span class="nc" id="L171">    		JdmoQuery jQuery2 = jdmo.createQuery(pStmt2, Jdmo.PARAM_QUERY);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            for (Iterator it = col.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L173">                DataSourcePayrollProvider dspp = (DataSourcePayrollProvider)it.next();</span>
<span class="nc" id="L174">                ID dsppID = dspp.getID();</span>
<span class="nc" id="L175">				jQuery2.setParID(1, dsppID);</span>
<span class="nc" id="L176">				JdmoRowset rs2 = jdmo.createRowset(jQuery2, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L177">				ArrayList mapping = new ArrayList();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">				while (rs2.next()) {</span>
<span class="nc" id="L179">					PayrollEarningTypeMapping petm = new</span>
<span class="nc" id="L180">						PayrollEarningTypeMapping(rs2.getID(&quot;ID&quot;),</span>
													dsppID,
<span class="nc" id="L182">													rs2.getID(&quot;EARNINGTYPEID&quot;),</span>
<span class="nc" id="L183">													rs2.getString(2),</span>
<span class="nc" id="L184">													rs2.getString(1));</span>
<span class="nc" id="L185">					mapping.add(petm);</span>
<span class="nc" id="L186">				}</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">				if (!mapping.isEmpty())</span>
<span class="nc" id="L188">					dspp.setMapping(mapping);</span>
<span class="nc" id="L189">				dspp.setConfig(getPayrollExportConfig(dsppID));</span>
<span class="nc" id="L190">            }</span>
<span class="nc" id="L191">			return col;</span>
<span class="nc" id="L192">		} catch(JdmoException e) {</span>
<span class="nc" id="L193">			handleException(e, false);</span>
<span class="nc" id="L194">			throw new AmException(e);</span>
		} finally {
<span class="nc bnc" id="L196" title="All 4 branches missed.">			if (rs != null)</span>
				try {
<span class="nc" id="L198">					rs.close();</span>
<span class="nc" id="L199">				} catch (Exception e) {}</span>
<span class="nc bnc" id="L200" title="All 4 branches missed.">			if (jdmo != null)</span>
<span class="nc" id="L201">				jdmo.cleanUp();</span>
<span class="nc" id="L202">			methodFinish();</span>
		}
	}
	/**
	 * Load all DataSource the type is PayrollProvider defined
	 * DATASOURCEPAYROLLPROVIDERID is used for future operation
	 * @return HashMap, (DataSourceName, DATASOURCEPAYROLLPROVIDERID)
	 */
	public HashMap getAllPayrollProviderDataSources()
								throws AmException
	{
<span class="nc" id="L213">		methodStart(&quot;getAllPayrollProviderDataSources&quot;);</span>
<span class="nc" id="L214">		Jdmo jdmo = null;</span>
<span class="nc" id="L215">		JdmoRowset rs = null;</span>
<span class="nc" id="L216">		HashMap map = new HashMap();</span>
		try {
<span class="nc" id="L218">			jdmo = new Jdmo();</span>
/*			String pStmt =
&quot;select A.ID, A.NAME, FILENAME, A.DESCRIPTION, B.ID from PAYROLLPROVIDER A, DATASOURCEPAYROLLPROVIDER B where B.PAYROLLPROVIDERID &quot;+
jdmo.getOuterJoin()+&quot; A.ID&quot;;
<span class="nc" id="L222">*/          String pStmt =</span>
&quot;select B.ID, A.NAME from DATASOURCE A, DATASOURCEPAYROLLPROVIDER B where A.DATASOURCETYPEID =? and A.ID = B.DATASOURCEID and A.ISDELETED=0&quot;;
<span class="nc" id="L224">			JdmoQuery jQuery1 = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L225">			jQuery1.setParInt(1, -27001);</span>
<span class="nc" id="L226">			rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L228">				map.put(rs.getString(2), rs.getID(1));</span>
/*				ID id = rs.getID(1);
				if (map.get(id) == null) {
					PayrollProvider pp = new PayrollProvider(
									 id,
									 rs.getString(2),
									 rs.getString(&quot;FILENAME&quot;),
									 rs.getString(4));
					pp.setIsConfigured(!(rs.getID(5)==null));
					map.put(id, pp);
				}
*/
			}
//			return new ArrayList(map.values());
<span class="nc" id="L242">			return map;</span>
<span class="nc" id="L243">		} catch (JdmoException e) {</span>
<span class="nc" id="L244">			handleException(e, false);</span>
<span class="nc" id="L245">			throw new AmException(e);</span>
		} finally {
<span class="nc bnc" id="L247" title="All 4 branches missed.">			if (rs != null)</span>
				try {
<span class="nc" id="L249">					rs.close();</span>
<span class="nc" id="L250">				} catch (Exception e) {}</span>
<span class="nc bnc" id="L251" title="All 4 branches missed.">			if (jdmo != null)</span>
<span class="nc" id="L252">				jdmo.cleanUp();</span>
<span class="nc" id="L253">			methodFinish();</span>
		}
	}
	/**
	 * Load the DataSource the type is PayrollProvider via a given ID
	 * @param ID
	 * @return DataSourcePayrollProvider (which embeds the mapping)
	 */
	public DataSourcePayrollProvider getPayrollProviderDataSourceByID(ID dsppID)
															throws AmException
	{
<span class="nc" id="L264">		methodStart(&quot;getPayrollProviderDataSourceByID&quot;, dsppID);</span>
<span class="nc" id="L265">		Jdmo jdmo = null;</span>
<span class="nc" id="L266">		JdmoRowset rs = null;</span>
		try {
<span class="nc" id="L268">			jdmo = new Jdmo();</span>
<span class="nc" id="L269">			String pStmt =</span>
&quot;select c.NAME, DATASOURCEID, PAYROLLPROVIDERID, EXPORTDESTINATION, CONFIGFILEVERSION, b.NAME, b.DESCRIPTION from DATASOURCEPAYROLLPROVIDER a, DATASOURCE b, PAYROLLPROVIDER c where a.DATASOURCEID = b.ID and b.ISDELETED = 0 and a.PAYROLLPROVIDERID = c.ID and a.ID = ?&quot;;
<span class="nc" id="L271">			JdmoQuery jQuery1 = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L272">			jQuery1.setParID(1, dsppID);</span>
<span class="nc" id="L273">			rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L274">			DataSourcePayrollProvider dspp = null;</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L276">				dspp = new DataSourcePayrollProvider(</span>
										dsppID,
<span class="nc" id="L278">										rs.getID(&quot;DATASOURCEID&quot;),</span>
<span class="nc" id="L279">										rs.getID(&quot;PAYROLLPROVIDERID&quot;),</span>
<span class="nc" id="L280">										rs.getString(&quot;EXPORTDESTINATION&quot;),</span>
<span class="nc" id="L281">										rs.getString(&quot;CONFIGFILEVERSION&quot;));</span>
<span class="nc" id="L282">				dspp.setDataSourceName(rs.getString(&quot;NAME&quot;));</span>
<span class="nc" id="L283">				dspp.setPayrollProviderName(rs.getString(1));</span>
<span class="nc" id="L284">				dspp.setDescription(rs.getString(&quot;DESCRIPTION&quot;));</span>
			}
<span class="nc bnc" id="L286" title="All 2 branches missed.">			if (dspp != null) {</span>
<span class="nc" id="L287">				pStmt =</span>
&quot;select a.NAME, b.NAME, a.ID, EARNINGTYPEID from PAYROLLEARNINGTYPE a, EARNINGTYPE b where a.DATASOURCEPAYROLLPROVIDERID=? and a.EARNINGTYPEID=b.ID&quot;;
<span class="nc" id="L289">				jQuery1 = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L290">				jQuery1.setParID(1, dsppID);</span>
<span class="nc" id="L291">				rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L292">				ArrayList mapping = new ArrayList();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L294">					PayrollEarningTypeMapping petm = new</span>
<span class="nc" id="L295">						PayrollEarningTypeMapping(rs.getID(&quot;ID&quot;),</span>
													dsppID,
<span class="nc" id="L297">													rs.getID(&quot;EARNINGTYPEID&quot;),</span>
<span class="nc" id="L298">													rs.getString(2),</span>
<span class="nc" id="L299">													rs.getString(1));</span>
<span class="nc" id="L300">					mapping.add(petm);</span>
<span class="nc" id="L301">				}</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">				if (!mapping.isEmpty())</span>
<span class="nc" id="L303">					dspp.setMapping(mapping);</span>
			}
<span class="nc" id="L305">			return dspp;</span>
<span class="nc" id="L306">		} catch (JdmoException e) {</span>
<span class="nc" id="L307">			handleException(e, false);</span>
<span class="nc" id="L308">			throw new AmException(e);</span>
		} finally {
<span class="nc bnc" id="L310" title="All 4 branches missed.">			if (rs != null)</span>
				try {
<span class="nc" id="L312">					rs.close();</span>
<span class="nc" id="L313">				} catch (Exception e) {}</span>
<span class="nc bnc" id="L314" title="All 4 branches missed.">			if (jdmo != null)</span>
<span class="nc" id="L315">				jdmo.cleanUp();</span>
<span class="nc" id="L316">			methodFinish();</span>
		}
	}
	/**
	 * update Payroll Provider DataSource
	 * @param DataSourcePayrollProvider
	 * @param Collection, mappings
	 */
	public void updatePayrollProviderDataSource(DataSourcePayrollProvider dspp,
											 Collection payrollEarningTypeMapping)
															throws AmException
	{
<span class="nc" id="L328">		methodStart(&quot;updatePayrollProviderDataSource&quot;, dspp, payrollEarningTypeMapping);</span>
<span class="nc" id="L329">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L331">			ID psID = dspp.getID();</span>
<span class="nc" id="L332">			String pStmt =</span>
	&quot;update DATASOURCE set NAME=?, DESCRIPTION=? where ID = ?&quot;;
<span class="nc" id="L334">			Object[] param = new Object[3];</span>
<span class="nc" id="L335">			param[0] = dspp.getDataSourceName();</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">			if (dspp.getDescription() != null)</span>
<span class="nc" id="L337">				param[1] = dspp.getDescription();</span>
			else
<span class="nc" id="L339">				param[1] = new JdmoParam(null, Types.VARCHAR);</span>
<span class="nc" id="L340">			param[2] = dspp.getDataSourceID();</span>
<span class="nc" id="L341">			jdmo.executePCommand(pStmt, param);</span>
			// We persist the version in each PayrollExportConfig
<span class="nc" id="L343">			Collection payrollProviderConfig = dspp.getConfig();</span>
			// If there is PEC, retrieve the version and save into DSPP
<span class="nc bnc" id="L345" title="All 2 branches missed.">			if (payrollProviderConfig != null)</span>
<span class="nc" id="L346">				dspp.setVersion(((PayrollExportConfig)payrollProviderConfig.iterator().next()).getVersion());</span>
<span class="nc" id="L347">			pStmt =</span>
	&quot;update DATASOURCEPAYROLLPROVIDER set PAYROLLPROVIDERID=?, EXPORTDESTINATION=?, CONFIGFILEVERSION=? where ID=?&quot;;
<span class="nc" id="L349">			param = new Object[4];</span>
<span class="nc" id="L350">			param[0] = dspp.getPayrollProviderID();</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">			if (dspp.getExportDestination() != null)</span>
<span class="nc" id="L352">				param[1] = dspp.getExportDestination();</span>
			else
<span class="nc" id="L354">				param[1] = new JdmoParam(null, Types.VARCHAR);</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">			if (dspp.getVersion() != null)</span>
<span class="nc" id="L356">				param[2] = dspp.getVersion();</span>
			else
<span class="nc" id="L358">				param[2] = new JdmoParam(null, Types.VARCHAR);</span>
<span class="nc" id="L359">			param[3] = psID;</span>
<span class="nc" id="L360">			jdmo.executePCommand(pStmt, param);</span>
			// If there is mapping, for Update
			// ID, Name both exist means update
			// ID exist, Name null means delete
			// ID not exist, means create
<span class="nc bnc" id="L365" title="All 2 branches missed.">			if (payrollEarningTypeMapping != null &amp;&amp;</span>
<span class="nc bnc" id="L366" title="All 4 branches missed.">				!payrollEarningTypeMapping.isEmpty() &amp;&amp; psID != null)</span>
			{
<span class="nc" id="L368">				HashMap map = new HashMap(3);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">				for (Iterator it = payrollEarningTypeMapping.iterator(); it.hasNext(); )</span>
				{
<span class="nc" id="L371">					PayrollEarningTypeMapping petm = (PayrollEarningTypeMapping)it.next();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">					if (petm.getID() == null) {</span>
<span class="nc" id="L373">						map.put(&quot;NAME&quot;, petm.getPayrollEarningType());</span>
<span class="nc" id="L374">						map.put(&quot;DATASOURCEPAYROLLPROVIDERID&quot;, psID);</span>
<span class="nc" id="L375">						map.put(&quot;EARNINGTYPEID&quot;, petm.getEarningTypeID());</span>
<span class="nc" id="L376">						jdmo.addBatchInsert(&quot;PAYROLLEARNINGTYPE&quot;, map);</span>
<span class="nc" id="L377">						map.clear();</span>
					} else {
<span class="nc bnc" id="L379" title="All 2 branches missed.">						if (petm.getPayrollEarningType() != null) {</span>
<span class="nc" id="L380">							pStmt =</span>
							&quot;update PAYROLLEARNINGTYPE set NAME=? where ID=?&quot;;
<span class="nc" id="L382">							param = new Object[2];</span>
<span class="nc" id="L383">							param[0] = petm.getPayrollEarningType();</span>
<span class="nc" id="L384">							param[1] = petm.getID();</span>
<span class="nc" id="L385">							jdmo.executePCommand(pStmt, param);</span>
						} else {
<span class="nc" id="L387">							String pStmt2 =</span>
							&quot;update PAYROLLEXPORTCONFIG set PAYROLLEARNINGTYPEID=null, SEQUENCENUM=0, ISEXPORTED=0 where PAYROLLEARNINGTYPEID=?&quot;;
<span class="nc" id="L389">							Object[] param2 = new Object[1];</span>
<span class="nc" id="L390">							param2[0] = petm.getID();</span>
<span class="nc" id="L391">							jdmo.executePCommand(pStmt2, param2);</span>
<span class="nc" id="L392">							pStmt2 = &quot;delete PAYROLLEARNINGTYPE where ID=?&quot;;</span>
<span class="nc" id="L393">							jdmo.executePCommand(pStmt2, param2);</span>
						}
					}
<span class="nc" id="L396">				}</span>
<span class="nc" id="L397">				jdmo.executeBatch();</span>
			}
<span class="nc" id="L399">		} catch (JdmoDuplicateKeyException e) {</span>
<span class="nc" id="L400">			handleException(Priority.INFO, e);</span>
<span class="nc" id="L401">			throw new AmUpdateDuplicateKeyException(e);</span>
<span class="nc" id="L402">		} catch (JdmoException e) {</span>
<span class="nc" id="L403">			handleException(e);</span>
<span class="nc" id="L404">			throw new AmException(e);</span>
		} finally {
<span class="nc bnc" id="L406" title="All 4 branches missed.">			if (jdmo != null)</span>
<span class="nc" id="L407">				jdmo.cleanUp();</span>
<span class="nc" id="L408">			methodFinish();</span>
<span class="nc" id="L409">		}</span>
<span class="nc" id="L410">	}</span>
	/**
	 * Create a PayrollProvider instance
	 * Which will create DataSource first
	 * then create DataSourcePayrollProvider
	 * at last create the mapping
	 * @param DataSourcePayrollProvider
	 * @param Collection, mapping
	 * @return ID, DSPP ID
	 */
	public ID createPayrollProvider(DataSourcePayrollProvider dspp,
									Collection payrollEarningTypeMapping)
								throws AmException
	{
<span class="nc" id="L424">		methodStart(&quot;createPayrollProvider&quot;, dspp, payrollEarningTypeMapping);</span>
<span class="nc" id="L425">		Jdmo jdmo = null;</span>
<span class="nc" id="L426">		JdmoRowset rs = null;</span>
		try {
<span class="nc" id="L428">			DataSource ds = new DataSource();</span>
<span class="nc" id="L429">			ds.setName(dspp.getDataSourceName());</span>
<span class="nc" id="L430">			ds.setDescription(dspp.getDescription());</span>
<span class="nc" id="L431">			ds.setTimeZone(TimeZone.getDefault());</span>
<span class="nc" id="L432">			ds.setDataSourceTypeID(DataSourceType.ID_PAYROLLPROVIDER);</span>
<span class="nc" id="L433">			DataSourceManager dsm = BbmManagerFactory.getDataSourceManager();</span>
<span class="nc" id="L434">			ID dsID = dsm.createDataSource(ds);</span>
<span class="nc" id="L435">			jdmo = new Jdmo();</span>
			// Create a DataSource First
<span class="nc" id="L437">			HashMap map = new HashMap();</span>
/*			map.put(&quot;ISPASSWORDPROTECTED&quot;, JdmoParam.getObject(false));
			map.put(&quot;ISHAASUPPORTED&quot;, JdmoParam.getObject(false));
*/			// Create the DataSourcePayrollProvider
<span class="nc" id="L441">			map.clear();</span>
			// To use the same ID as obtained from DataSource
<span class="nc" id="L443">			map.put(&quot;ID&quot;, dsID);</span>
<span class="nc" id="L444">			map.put(&quot;DATASOURCEID&quot;, dsID);</span>
<span class="nc" id="L445">			map.put(&quot;PAYROLLPROVIDERID&quot;, dspp.getPayrollProviderID());</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">			if (dspp.getExportDestination()!= null)</span>
<span class="nc" id="L447">				map.put(&quot;EXPORTDESTINATION&quot;, dspp.getExportDestination());</span>
			// We persist the version in each PayrollExportConfig
<span class="nc" id="L449">			Collection payrollProviderConfig = dspp.getConfig();</span>
			// If there is PEC, retrieve the version and save into DSPP
<span class="nc bnc" id="L451" title="All 2 branches missed.">			if (payrollProviderConfig != null)</span>
<span class="nc" id="L452">				dspp.setVersion(((PayrollExportConfig)payrollProviderConfig.iterator().next()).getVersion());</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">			if (dspp.getVersion() != null)</span>
<span class="nc" id="L454">				map.put(&quot;CONFIGFILEVERSION&quot;, dspp.getVersion());</span>
<span class="nc" id="L455">			ID dsppID = jdmo.addBatchInsert(&quot;DATASOURCEPAYROLLPROVIDER&quot;, map);</span>
<span class="nc" id="L456">			jdmo.executeBatch();</span>
<span class="nc bnc" id="L457" title="All 4 branches missed.">			if (payrollEarningTypeMapping != null &amp;&amp; payrollEarningTypeMapping.size() != 0) {</span>
				// Create PayrollEarningTypeMapping
<span class="nc" id="L459">				Iterator it = payrollEarningTypeMapping.iterator();</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">				while (it.hasNext()) {</span>
<span class="nc" id="L461">					map.clear();</span>
<span class="nc" id="L462">					PayrollEarningTypeMapping petm = (PayrollEarningTypeMapping)it.next();</span>
<span class="nc" id="L463">					map.put(&quot;EARNINGTYPEID&quot;, petm.getEarningTypeID());</span>
<span class="nc" id="L464">					map.put(&quot;DATASOURCEPAYROLLPROVIDERID&quot;, dsID);</span>
<span class="nc" id="L465">					map.put(&quot;NAME&quot;, petm.getPayrollEarningType());</span>
<span class="nc" id="L466">					jdmo.addBatchInsert(&quot;PAYROLLEARNINGTYPE&quot;, map);</span>
<span class="nc" id="L467">				}</span>
<span class="nc" id="L468">				jdmo.executeBatch();</span>
			}
<span class="nc" id="L470">			return dsppID;</span>
<span class="nc" id="L471">		} catch(JdmoDuplicateKeyException e) {</span>
<span class="nc" id="L472">			handleException(Priority.INFO, e);</span>
<span class="nc" id="L473">			throw new AmCreateDuplicateKeyException(e);</span>
<span class="nc" id="L474">		}  catch(JdmoException e) {</span>
<span class="nc" id="L475">			handleException(e);</span>
<span class="nc" id="L476">			throw new AmException(e);</span>
<span class="nc" id="L477">		} catch(Exception e) {</span>
<span class="nc" id="L478">			handleException(e);</span>
<span class="nc" id="L479">			throw new AmException(e);</span>
		} finally {
<span class="nc bnc" id="L481" title="All 4 branches missed.">			if (rs != null)</span>
				try {
<span class="nc" id="L483">					rs.close();</span>
<span class="nc" id="L484">				} catch (Exception e) {}</span>
<span class="nc bnc" id="L485" title="All 4 branches missed.">			if (jdmo != null)</span>
<span class="nc" id="L486">				jdmo.cleanUp();</span>
<span class="nc" id="L487">			methodFinish();</span>
		}
	}
	/**
	 * Setup a PayrollProvider, recreate the payrollproviderconfig table
	 * @param ID, DataSourcePayrollProviderID
	 * @param String, config version
	 * @param Collection, PayrollExportConfig
	 */
	public void setupPayrollProvider(ID dsppID, String version, Collection payrollProviderConfig)
								throws AmException
	{
<span class="nc" id="L499">		methodStart(&quot;setupPayrollProvider&quot;, dsppID, version, payrollProviderConfig);</span>
<span class="nc bnc" id="L500" title="All 6 branches missed.">		if (dsppID == null || payrollProviderConfig == null || payrollProviderConfig.size() == 0)</span>
<span class="nc" id="L501">			return;</span>
<span class="nc" id="L502">		Jdmo jdmo = new Jdmo();</span>
		try {
			// If no row if affected then the DataSourcePayrollProvider is removed
<span class="nc bnc" id="L505" title="All 2 branches missed.">			if (updateDataSourcePayrollProviderVersion(dsppID,</span>
												 version,
												 jdmo) == 0)
<span class="nc" id="L508">				throw new AmException(&quot;DataSourcePayrollProvider not exist&quot;);</span>
<span class="nc" id="L509">			removePayrollExportConfig(dsppID, jdmo);</span>
<span class="nc" id="L510">			createPayrollExportConfig(dsppID, payrollProviderConfig, jdmo);</span>
<span class="nc" id="L511">		} catch (JdmoDuplicateKeyException e) {</span>
<span class="nc" id="L512">			handleException(Priority.INFO, e);</span>
<span class="nc" id="L513">			throw new AmCreateDuplicateKeyException(e);</span>
<span class="nc" id="L514">		} catch (JdmoException e) {</span>
<span class="nc" id="L515">			handleException(e);</span>
<span class="nc" id="L516">			throw new AmException(e);</span>
		} finally {
<span class="nc" id="L518">			methodFinish();</span>
<span class="nc" id="L519">		}</span>
<span class="nc" id="L520">	}</span>
	/**
	 * Setup a PayrollProvider, recreate the payrollproviderconfig table
	 * @param Collection
	 */
	public void setupPayrollProvider(Collection payrollProviderConfig)
								throws AmException
	{
<span class="nc" id="L528">		methodStart(&quot;setupPayrollProvider&quot;, payrollProviderConfig);</span>
<span class="nc bnc" id="L529" title="All 4 branches missed.">		if (payrollProviderConfig == null || payrollProviderConfig.size() == 0)</span>
<span class="nc" id="L530">			return;</span>
<span class="nc" id="L531">		Iterator it = payrollProviderConfig.iterator();</span>
<span class="nc" id="L532">		PayrollExportConfig pec = (PayrollExportConfig)it.next();</span>
<span class="nc" id="L533">		Jdmo jdmo = new Jdmo();</span>
		try {
			// If no row if affected then the DataSourcePayrollProvider is removed
<span class="nc bnc" id="L536" title="All 2 branches missed.">			if (pec.getPayrollProviderDataSourceID() != null) {</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">				if (updateDataSourcePayrollProviderVersion(pec.getPayrollProviderDataSourceID(),</span>
<span class="nc" id="L538">													 pec.getVersion(),</span>
													 jdmo) == 0)
<span class="nc" id="L540">					throw new AmException(&quot;DataSourcePayrollProvider not exist&quot;);</span>
<span class="nc" id="L541">				removePayrollExportConfig(pec.getPayrollProviderDataSourceID(), jdmo);</span>
<span class="nc" id="L542">				createPayrollExportConfig(pec.getPayrollProviderDataSourceID(), payrollProviderConfig, jdmo);</span>
			}
<span class="nc" id="L544">		} catch (JdmoDuplicateKeyException e) {</span>
<span class="nc" id="L545">			handleException(Priority.INFO, e);</span>
<span class="nc" id="L546">			throw new AmCreateDuplicateKeyException(e);</span>
<span class="nc" id="L547">		} catch (JdmoException e) {</span>
<span class="nc" id="L548">			handleException(e);</span>
<span class="nc" id="L549">			throw new AmException(e);</span>
		} finally {
<span class="nc" id="L551">			methodFinish();</span>
<span class="nc" id="L552">		}</span>
<span class="nc" id="L553">	}</span>
	/**
	 * Create PayrollExportConfig into DB
	 * @param ID, DataSourcePayrollProviderID
	 * @param Collection
	 * @param Jdmo
	 */
	private void createPayrollExportConfig(ID dsppID,
											 Collection payrollProviderConfig,
											 Jdmo jdmo)
											 throws JdmoException
	{
<span class="nc" id="L565">		Iterator it = payrollProviderConfig.iterator();</span>
<span class="nc" id="L566">		HashMap map = new HashMap(10);</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">		while (it.hasNext()) {</span>
<span class="nc" id="L568">			PayrollExportConfig pec = (PayrollExportConfig)it.next();</span>
<span class="nc" id="L569">			map.clear();</span>
<span class="nc" id="L570">			map.put(&quot;DATASOURCEPAYROLLPROVIDERID&quot;, dsppID);</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">			if (pec.getPayrollEarningTypeID() != null)</span>
<span class="nc" id="L572">				map.put(&quot;PAYROLLEARNINGTYPEID&quot;, pec.getPayrollEarningTypeID());</span>
<span class="nc" id="L573">			map.put(&quot;FIELDNAME&quot;, pec.getFieldName());</span>
<span class="nc" id="L574">			map.put(&quot;FIELDTYPE&quot;, new Short(pec.getFieldType()));</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">			if (pec.getDisplayName() != null)</span>
<span class="nc" id="L576">				map.put(&quot;DISPLAYNAME&quot;, pec.getDisplayName());</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">			if (pec.getSequence() != 0)</span>
<span class="nc" id="L578">				map.put(&quot;SEQUENCENUM&quot;, new Integer(pec.getSequence()));</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">			if (pec.getValue() != null)</span>
<span class="nc" id="L580">				map.put(&quot;FIELDVALUE&quot;, pec.getValue());</span>
<span class="nc" id="L581">			map.put(&quot;ISMANDATORY&quot;, JdmoParam.getObject(pec.isMandatory()));</span>
<span class="nc" id="L582">			map.put(&quot;ISEXPORTED&quot;, JdmoParam.getObject(pec.isExported()));</span>
<span class="nc" id="L583">			map.put(&quot;ISPEREXPORT&quot;, JdmoParam.getObject(pec.isPerExport()));</span>
<span class="nc" id="L584">			jdmo.addBatchInsert(&quot;PAYROLLEXPORTCONFIG&quot;, map);</span>
<span class="nc" id="L585">		}</span>
<span class="nc" id="L586">		jdmo.executeBatch();</span>
<span class="nc" id="L587">	}</span>
	/**
	 * Remove a PayrollProviderDataSource from DB
	 * @param ID, DataSourcePayrollProviderID
	 * @deprecated
	 */
	public void removePayrollProviderDataSource(ID dsppID)
								throws AmException
	{
<span class="nc" id="L596">		methodStart(&quot;removePayrollProviderDataSource&quot;, dsppID);</span>
<span class="nc" id="L597">		Jdmo jdmo = new Jdmo();</span>
<span class="nc" id="L598">		String pStmt = &quot;update DATASOURCE set ISDELETED=1 where ID=?&quot;;</span>
<span class="nc" id="L599">		Object[] param = new Object[1];</span>
<span class="nc" id="L600">		param[0] = dsppID;</span>
		try {
<span class="nc" id="L602">			jdmo.executePCommand(pStmt, param);</span>
<span class="nc" id="L603">		} catch (JdmoException e) {</span>
<span class="nc" id="L604">			handleException(e);</span>
<span class="nc" id="L605">			throw new AmException(e);</span>
		} finally {
<span class="nc" id="L607">			methodFinish();</span>
<span class="nc" id="L608">		}</span>
<span class="nc" id="L609">	}</span>
	/**
	 * Remove existing PayrollExportConfig from DB
	 * @param ID, DataSourcePayrollProviderID
	 * @param Jdmo
	 */
	private void removePayrollExportConfig(ID dsppID, Jdmo jdmo) throws JdmoException
	{
<span class="nc" id="L617">		String pStmt =</span>
		&quot;delete PAYROLLEXPORTCONFIG where DATASOURCEPAYROLLPROVIDERID = ?&quot;;
<span class="nc" id="L619">		Object[] param = new Object[1];</span>
<span class="nc" id="L620">		param[0] = dsppID;</span>
<span class="nc" id="L621">		jdmo.executePCommand(pStmt, param);</span>
<span class="nc" id="L622">	}</span>
	/**
	 * Actually this is kind of a lock to acquire for setup PayrollProvider
	 * @param ID, DataSourcePayrollProviderID
	 * @param int, version
	 * @param Jdmo
	 * @return int, affected row
	 */
	private int updateDataSourcePayrollProviderVersion(ID dsppID,
														 String version,
														 Jdmo jdmo)
														 throws JdmoException
	{
<span class="nc" id="L635">		String pStmt =</span>
		&quot;update DATASOURCEPAYROLLPROVIDER set CONFIGFILEVERSION = ? where ID = ?&quot;;
<span class="nc" id="L637">		Object[] param = new Object[2];</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">		if (version != null)</span>
<span class="nc" id="L639">			param[0] = version;</span>
		else
<span class="nc" id="L641">			param[0] = new JdmoParam(null, Types.VARCHAR);</span>
<span class="nc" id="L642">		param[1] = dsppID;</span>
<span class="nc" id="L643">		return jdmo.executePCommand(pStmt, param);</span>
	}
	/**
	 * Load the PayrollExportConfig from DB, if failed from XML file
	 * @param String, Location of the xml file
	 * @return String, Version
	 * @deprecated
	 */
	public String getPayrollExportConfigVersionFromXML(String location)
								throws AmException
	{
<span class="nc" id="L654">		methodStart(&quot;getPayrollExportConfigVersionFromXML&quot;, location);</span>
		try {
<span class="nc" id="L656">			return PayrollProviderConfigBuilder.getVersion(location);</span>
<span class="nc" id="L657">		} catch(IOException e) {</span>
<span class="nc" id="L658">			Object[] param = new Object[1];</span>
<span class="nc" id="L659">			param[0] = location;</span>
<span class="nc" id="L660">			handleException(AmEjbBundleKey.PAYROLLMANAGER_FILE_ERROR, param, e, false);</span>
<span class="nc" id="L661">			throw new AmException(e);</span>
<span class="nc" id="L662">		} catch(Exception e) {</span>
<span class="nc" id="L663">			handleException(e, false);</span>
<span class="nc" id="L664">			throw new AmException(e);</span>
		} finally {
<span class="nc" id="L666">			methodFinish();</span>
		}
	}
	/**
	 * Load the PayrollExportConfig from DB, if failed from XML file
	 * @param ID, DataSourcePayrollProviderID
	 * @return List, PayrollExportConfig
	 */
	public List getPayrollExportConfig(ID dsppID)
								throws AmException
	{
<span class="nc" id="L677">		methodStart(&quot;getPayrollExportConfig&quot;, dsppID);</span>
<span class="nc" id="L678">		JdmoRowset rs = null;</span>
<span class="nc" id="L679">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L681">			String pStmt =</span>
&quot;select A.ID, FIELDNAME, FIELDTYPE, DISPLAYNAME, SEQUENCENUM,&quot;+
&quot; ISMANDATORY, ISEXPORTED, ISPEREXPORT, FIELDVALUE, PAYROLLEARNINGTYPEID, CONFIGFILEVERSION&quot;+
&quot; from PAYROLLEXPORTCONFIG A, DATASOURCEPAYROLLPROVIDER B where DATASOURCEPAYROLLPROVIDERID = ?&quot;+
&quot; and B.ID = DATASOURCEPAYROLLPROVIDERID order by SEQUENCENUM, FIELDNAME asc&quot;;
<span class="nc" id="L686">			JdmoQuery jQuery1 = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L687">			jQuery1.setParID(1, dsppID);</span>
<span class="nc" id="L688">			rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L689">			ArrayList config = new ArrayList();</span>
<span class="nc" id="L690">			HashMap map = new HashMap();</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L692">				String fName = rs.getString(&quot;FIELDNAME&quot;);</span>
<span class="nc" id="L693">				PayrollExportConfig pec = new PayrollExportConfig(</span>
<span class="nc" id="L694">											rs.getID(1),</span>
											dsppID,
<span class="nc" id="L696">											rs.getID(&quot;PAYROLLEARNINGTYPEID&quot;),</span>
											fName,
<span class="nc" id="L698">											rs.getShort(&quot;FIELDTYPE&quot;),</span>
<span class="nc" id="L699">											rs.getString(&quot;FIELDVALUE&quot;),</span>
<span class="nc" id="L700">											rs.getString(&quot;DISPLAYNAME&quot;),</span>
<span class="nc" id="L701">											rs.getInt(&quot;SEQUENCENUM&quot;),</span>
<span class="nc" id="L702">											rs.getBoolean(&quot;ISMANDATORY&quot;),</span>
<span class="nc" id="L703">											rs.getBoolean(&quot;ISEXPORTED&quot;),</span>
<span class="nc" id="L704">											rs.getBoolean(&quot;ISPEREXPORT&quot;));</span>
<span class="nc" id="L705">				Integer counter = (Integer)map.get(fName);</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">				int counterNum = counter==null?0:counter.intValue();</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">				if (counter==null)</span>
<span class="nc" id="L708">					map.put(fName, new Integer(counterNum));</span>
				else {
<span class="nc" id="L710">					counterNum++;</span>
<span class="nc" id="L711">					map.put(fName, new Integer(counterNum));</span>
				}
<span class="nc" id="L713">				pec.setVersion(rs.getString(&quot;CONFIGFILEVERSION&quot;));</span>
<span class="nc" id="L714">				pec.setUniqueNum(counterNum);</span>
<span class="nc" id="L715">				config.add(pec);</span>
<span class="nc" id="L716">			}</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">			if (config.isEmpty()) {</span>
<span class="nc" id="L718">				return getPayrollExportConfigFromXML(dsppID);</span>
			} else
<span class="nc" id="L720">				return config;</span>
<span class="nc" id="L721">		} catch (JdmoException e) {</span>
<span class="nc" id="L722">			handleException(e, false);</span>
<span class="nc" id="L723">			throw new AmException(e);</span>
<span class="nc" id="L724">		} catch (Exception e) {</span>
<span class="nc" id="L725">			handleException(e, false);</span>
<span class="nc" id="L726">			throw new AmException(e);</span>
		} finally {
<span class="nc bnc" id="L728" title="All 6 branches missed.">			if (rs != null)</span>
				try {
<span class="nc" id="L730">					rs.close();</span>
<span class="nc" id="L731">				} catch (Exception e) {}</span>
<span class="nc bnc" id="L732" title="All 6 branches missed.">			if (jdmo != null)</span>
<span class="nc" id="L733">				jdmo.cleanUp();</span>
<span class="nc" id="L734">			methodFinish();</span>
		}
	}
	/**
	 * Load the PayrollExportConfig from XML
	 * @param ID, DataSourcePayrollProviderID
	 * @return List, PayrollExportConfig
	 */
	public List getPayrollExportConfigFromXML(ID dsppID)
								throws AmException
	{
<span class="nc" id="L745">		methodStart(&quot;getPayrollExportConfigFromXML&quot;, dsppID);</span>
<span class="nc" id="L746">		String location = null;</span>
		try {
<span class="nc" id="L748">			location = getConfigLocation(dsppID);</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">			if (location != null)</span>
<span class="nc" id="L750">				return PayrollProviderConfigBuilder.parse(location, dsppID);</span>
			else
<span class="nc" id="L752">				return new ArrayList(1);</span>
<span class="nc" id="L753">		} catch(IOException e) {</span>
<span class="nc" id="L754">			Object[] param = new Object[1];</span>
<span class="nc" id="L755">			param[0] = location;</span>
<span class="nc" id="L756">			handleException(AmEjbBundleKey.PAYROLLMANAGER_FILE_ERROR, param, e, false);</span>
<span class="nc" id="L757">			throw new AmException(e);</span>
<span class="nc" id="L758">		} catch (Exception e) {</span>
<span class="nc" id="L759">			handleException(e, false);</span>
<span class="nc" id="L760">			throw new AmException(e);</span>
		} finally {
<span class="nc" id="L762">			methodFinish();</span>
		}
	}
	/**
	 * Internal function to load the filelocation of a datasourcepayrollprovider
	 * @return String
	 */
	private String getConfigLocation(ID dsppID) throws JdmoException
	{
<span class="nc" id="L771">		JdmoRowset rs = null;</span>
<span class="nc" id="L772">		Jdmo jdmo = new Jdmo();</span>
<span class="nc" id="L773">		String pStmt =</span>
&quot;select CONFIGFILENAME from PAYROLLPROVIDER A, DATASOURCEPAYROLLPROVIDER B where B.PAYROLLPROVIDERID = A.ID and B.ID = ?&quot;;
<span class="nc" id="L775">		JdmoQuery jQuery1 = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L776">		jQuery1.setParID(1, dsppID);</span>
<span class="nc" id="L777">		rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L779">			return rs.getString(&quot;CONFIGFILENAME&quot;);</span>
		} else {
<span class="nc" id="L781">			return null;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>