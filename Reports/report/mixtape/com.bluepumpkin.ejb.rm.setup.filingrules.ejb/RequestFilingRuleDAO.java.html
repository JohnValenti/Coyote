<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestFilingRuleDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.setup.filingrules.ejb</a> &gt; <span class="el_source">RequestFilingRuleDAO.java</span></div><h1>RequestFilingRuleDAO.java</h1><pre class="source lang-java linenums">/*
 * RequestFilingRuleDAO.java
 * Copyright (c) 2002, Blue Pumpkin Software, Inc.
 * All rights reserved.
 */
package com.bluepumpkin.ejb.rm.setup.filingrules.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.cache.CacheUtilBBM;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.setup.filingrules.model.RequestFilingRule;
import com.bluepumpkin.ejb.rm.setup.filingrules.model.RequestFilingRuleFieldInfo;

/**
 * This class is DAO class for the RequestFilingRule.
 */
public class RequestFilingRuleDAO extends DAOBase {

    //Field info object array.
<span class="fc" id="L38">    private static FieldInfo m_fieldInfo = new RequestFilingRuleFieldInfo();</span>

<span class="fc" id="L40">    protected FieldInfo getFieldInfo() { return m_fieldInfo; }</span>

<span class="fc" id="L42">    private static Category m_cat = Log.initCategory(RequestFilingRuleDAO.class.getName());</span>

    protected Category getCategory() {
<span class="nc" id="L45">        return m_cat;</span>
    }

    /* Default constructor for the class.
     **/
    public RequestFilingRuleDAO() {
<span class="fc" id="L51">        super();</span>
<span class="fc" id="L52">    }</span>

    /* Constructor for the class with the Jdmo instance passed as argument.
     * @param Jdmo - Jdmo class instance.
     **/
    public RequestFilingRuleDAO(Jdmo dmo) {
<span class="nc" id="L58">        super(dmo);</span>
<span class="nc" id="L59">    }</span>

    /* Create RequestFilingRule object and return it as ValueObjectBase object .
     * @return ValueObjectBase - ValueObjectBase Object.
     **/
    protected ValueObjectBase createValueObject() {
<span class="fc" id="L65">        return (new RequestFilingRule());</span>
    }

    /**
     * Find the RequestFilingRules for the OrganizationId and request type
     * passed as argument and returns a collection of RequestFilingRule
     * Object if found.
     * @param pOrganizationId - Organisation ID object.
     * @param pRequestType - RequestType.
     * @param pActivityId - optional activity id, can be null.
     * @param onlyIfApplied true=&gt; only return if rule if enabled (applied) to org.
     * @return Collection A collection of RequestFilingRule Object
     */
    public Collection findFilingRules(ID pOrganizationId,
                                      String pRequestType,
                                      boolean onlyIfApplied,
                                      ID pActivityId)
    throws Exception   
    {
        //Get all Filing Rules defined for the given Organizationid and its parents.  If param
        // onlyIfApplied is true, then returns only the 'applied' rules.  Otherwise returns both 'applied'
        // and 'not-applied' rules.
<span class="fc" id="L87">        Collection filingRules = new ArrayList(10);</span>

        // First, get the list of parent organizations. returned list is ordered by the closest
        // to the farthest parent org for the given orgID.
<span class="fc" id="L91">        List selfAndParentOrgIDs = CacheUtilBBM.getParentOrgIDs(pOrganizationId, getDMO());</span>
<span class="fc" id="L92">        selfAndParentOrgIDs.add(0, pOrganizationId); //include itself</span>

        // this is the ids of rules we found
<span class="fc" id="L95">        Collection foundRuleIDs = new ArrayList(10);</span>
<span class="fc" id="L96">        StringBuffer strQuery = null;</span>
<span class="fc" id="L97">        JdmoQuery jQuery1 = null;</span>

        // for each orgID, starting with self and then the closest parent, determine the list of
        // filing rules that 'apply' or 'donot-apply' to the orgID.
<span class="fc bfc" id="L101" title="All 2 branches covered.">        for (Iterator orgIt=selfAndParentOrgIDs.iterator(); orgIt.hasNext();)    </span>
        {
<span class="fc" id="L103">            ID curOrgId = (ID)orgIt.next();</span>

<span class="fc bfc" id="L105" title="All 2 branches covered.">            if (strQuery == null) </span>
            {
<span class="fc" id="L107">                strQuery = getSelectStatement();</span>
<span class="fc" id="L108">                strQuery.append(&quot;, B.ISAPPLIED &quot;);</span>
<span class="fc" id="L109">                strQuery.append(&quot; FROM REQUESTFILINGRULE A, APPLIEDFILINGRULE B &quot;);</span>
<span class="fc" id="L110">                strQuery.append(&quot; WHERE B.ORGANIZATIONID = ? &quot;);</span>
<span class="fc" id="L111">                strQuery.append(&quot; AND A.ID = B.REQUESTFILINGRULEID &quot;);</span>

<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                boolean lUseRequstType = pRequestType != null &amp;&amp;</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">                    !pRequestType.equalsIgnoreCase(Request.REQUESTTYPE_ALL);</span>

<span class="fc bfc" id="L116" title="All 2 branches covered.">                if (lUseRequstType) </span>
                {
<span class="fc" id="L118">                    strQuery.append(&quot; AND REQUESTTYPE = '&quot;);</span>
<span class="fc" id="L119">                    strQuery.append(pRequestType);</span>
<span class="fc" id="L120">                    strQuery.append(&quot;'&quot;);</span>
                }
<span class="fc bfc" id="L122" title="All 2 branches covered.">                if (pActivityId != null) </span>
                {
<span class="fc" id="L124">                    strQuery.append(&quot; AND A.ACTIVITYID = &quot;);</span>
<span class="fc" id="L125">                    strQuery.append(pActivityId);</span>
                }

                // ignore rules that were already processed earlier at a child org level.
<span class="fc bfc" id="L129" title="All 2 branches covered.">                if (foundRuleIDs.size() != 0) </span>
                {
<span class="fc" id="L131">                    strQuery.append(&quot; AND A.ID NOT IN &quot;);</span>
<span class="fc" id="L132">                    strQuery.append(m_dmo.createInClause(foundRuleIDs));</span>
                }

<span class="fc" id="L135">                strQuery.append(&quot; ORDER BY REQUESTTYPE &quot;);</span>


<span class="fc" id="L138">                jQuery1 = m_dmo.createQuery(strQuery.toString(),</span>
                                            Jdmo.PARAM_QUERY);
            }

<span class="fc" id="L142">            jQuery1.setParID(1, curOrgId);</span>
<span class="fc" id="L143">            JdmoRowset rs = m_dmo.createRowset(jQuery1,</span>
                                               Jdmo.FORWARD_ONLY,
                                               Jdmo.READ_ONLY);

<span class="fc bfc" id="L147" title="All 2 branches covered.">            while (rs.next()) </span>
            {
<span class="fc" id="L149">                RequestFilingRule filingRule = (RequestFilingRule) readObjectFromDB(rs);</span>

<span class="fc" id="L151">                filingRule.setApplied(rs.getBoolean(&quot;ISAPPLIED&quot;));</span>
                
                //If rule's org scope is thisOrgOnly, then child orgs must have isApplied=false  
<span class="pc bpc" id="L154" title="3 of 4 branches missed.">                if (filingRule.getOrgScope().equals(RequestFilingRule.SCOPE_THIS_ORG_ONLY) &amp;&amp; (!curOrgId.equals(pOrganizationId)))</span>
<span class="nc" id="L155">                    filingRule.setApplied(false);</span>

<span class="pc bpc" id="L157" title="1 of 2 branches missed.">                if (filingRule.getOrgScope().equals(RequestFilingRule.SCOPE_SUB_ORGS_ALLOW_OVERRIDE))</span>
<span class="fc" id="L158">                    filingRule.setCanChangeApply(true);</span>
                else
<span class="nc" id="L160">                    filingRule.setCanChangeApply(false);</span>

<span class="pc bpc" id="L162" title="1 of 4 branches missed.">                if (onlyIfApplied &amp;&amp; filingRule.getApplied())</span>
<span class="fc" id="L163">                    filingRules.add(filingRule);</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">                else if (!onlyIfApplied)</span>
<span class="fc" id="L165">                    filingRules.add(filingRule);</span>

<span class="fc" id="L167">                foundRuleIDs.add(filingRule.getID());</span>
                // we will need to rebuild the query if we continue up the tree.
<span class="fc" id="L169">                strQuery = null;</span>
<span class="fc" id="L170">            }</span>
<span class="fc" id="L171">            rs.close();</span>
            
<span class="fc" id="L173">        }//end parent orgs loop</span>

<span class="fc" id="L175">        return filingRules;</span>
    }

    /**
     * Find the RequestFilingRules for the ID, RequestFilingRuleId passed as argument
     * and returns a RequestFilingRule Object if found.
     * @param ruleId -  ID for RequestFilingRule object.
     * @return RequestFilingRule - A RequestFilingRule Object
     * @throws BbmFinderException if there is an error.
     * Note: Although the RequestFilingRule's getApplied and canChangeApplied properties will be set, they 
     *       are only referring to the APPLIEDFILINGRULE for the org where the RequestFilingRule was defined.
     */
    public RequestFilingRule findFilingRuleById( ID ruleId )
    throws Exception 
    {
<span class="nc" id="L190">        RequestFilingRule lRequestFilingRule = null;</span>

<span class="nc" id="L192">        StringBuffer strQuery = getSelectStatement();</span>
        
<span class="nc" id="L194">        strQuery.append(&quot;, B.ISAPPLIED &quot;);</span>
<span class="nc" id="L195">        strQuery.append(&quot; FROM REQUESTFILINGRULE A, APPLIEDFILINGRULE B  &quot;);</span>
<span class="nc" id="L196">        strQuery.append(&quot; WHERE B.REQUESTFILINGRULEID = ?&quot;);</span>
<span class="nc" id="L197">        strQuery.append(&quot; AND A.ID = B.REQUESTFILINGRULEID &quot;);</span>
<span class="nc" id="L198">        strQuery.append(&quot; AND A.ORGANIZATIONID = B.ORGANIZATIONID &quot;); //only look at the APPLIEDFILINGRULE for the org where the rule was defined</span>

<span class="nc" id="L200">        JdmoQuery jQuery1 = m_dmo.createQuery(strQuery.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L201">        jQuery1.setParString(1, ruleId.toString());</span>
<span class="nc" id="L202">        JdmoRowset rs = m_dmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="nc bnc" id="L204" title="All 2 branches missed.">        if(rs.next()) {</span>
<span class="nc" id="L205">            lRequestFilingRule = (RequestFilingRule) readObjectFromDB(rs);</span>
<span class="nc" id="L206">            lRequestFilingRule.setApplied(rs.getBoolean(&quot;ISAPPLIED&quot;));</span>
            
<span class="nc bnc" id="L208" title="All 2 branches missed.">            if (lRequestFilingRule.getOrgScope().equals(RequestFilingRule.SCOPE_SUB_ORGS_ALLOW_OVERRIDE))</span>
<span class="nc" id="L209">                lRequestFilingRule.setCanChangeApply(true);</span>
            else
<span class="nc" id="L211">                lRequestFilingRule.setCanChangeApply(false);</span>
        }
<span class="nc" id="L213">        rs.close();</span>

<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (lRequestFilingRule == null) {</span>
<span class="nc" id="L216">            throw new BbmObjectNotFoundException(ruleId.toString());</span>
        }

<span class="nc" id="L219">        return lRequestFilingRule;</span>
    }


    /**
     * Creates a new RequestFilingRule
     * @param rule -  rule to create
     * @throws BbmCreateException if there is an error.
     */
    public ID createObject(RequestFilingRule rule)
    throws Exception 
    {
<span class="fc" id="L231">        ID ruleId = super.createObject(rule);</span>
<span class="fc" id="L232">        rule.setID(ruleId);</span>

<span class="fc" id="L234">        AppliedFilingRuleDAO appliedDAO =</span>
            new AppliedFilingRuleDAO(m_dmo);
<span class="fc" id="L236">        appliedDAO.createObjects(rule);</span>

<span class="fc" id="L238">        return ruleId;</span>
    }


    /**
     * Update the  RequestFilingRule database with the RequestFilingRule object
     * values passed as argument.
     * @param rule - RequestFilingRule object.
     * @throws BbmUpdateException if there is an error.
     */
    public void updateObject(RequestFilingRule rule)
    throws Exception  
    {
        //super.updateObject(rule);

        //The update is applied first because applied query needs to see if orgScope is being changed from original
<span class="nc" id="L254">        AppliedFilingRuleDAO appliedDAO =</span>
            new AppliedFilingRuleDAO(m_dmo);
<span class="nc" id="L256">        appliedDAO.updateObjects(rule);</span>
        
<span class="nc" id="L258">        super.updateObject(rule); </span>
<span class="nc" id="L259">    }</span>

    /**
     * Delete the RequestFilingRule from database whose ID is passed as argument.
     * @param ruleId - Id for RequestFilingRule.
     * @throws BbmRemoveException if there is an error.
     */
    public void deleteObject(ID ruleID)
    throws BbmRemoveException {

        //delete dependent Applied status rows first.

        try {
<span class="nc" id="L272">            AppliedFilingRuleDAO appliedDAO = new AppliedFilingRuleDAO();</span>
<span class="nc" id="L273">            appliedDAO.deleteByFilingRuleID(ruleID);</span>

            //delete the filing rule now.
<span class="nc" id="L276">            super.deleteObject(ruleID);</span>
        }
<span class="nc" id="L278">        catch(BbmRemoveException e) {</span>
<span class="nc" id="L279">            m_cat.error(ruleID, e);</span>
<span class="nc" id="L280">            throw e;</span>
        }
<span class="nc" id="L282">        catch(Exception e ) {</span>
<span class="nc" id="L283">            m_cat.error(ruleID, e);</span>
<span class="nc" id="L284">            throw new BbmRemoveException(e);</span>
<span class="nc" id="L285">        }</span>

<span class="nc" id="L287">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>