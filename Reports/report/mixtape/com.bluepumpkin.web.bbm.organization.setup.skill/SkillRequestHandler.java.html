<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SkillRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.organization.setup.skill</a> &gt; <span class="el_source">SkillRequestHandler.java</span></div><h1>SkillRequestHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.organization.setup.skill;

import java.rmi.RemoteException;

import com.bluepumpkin.common.base.BPException;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.base.BbmCreateDuplicateKeyException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateDuplicateKeyException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.web.bbm.workload.WorkloadModelHandler;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.l10n.BbmWebLogBundleKey;
import com.witness.web.uif.base.Message;
import com.bluepumpkin.web.core.base.RequestHandler;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.system.RequestContext;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.web.bbm.skill.SkillModelHandler;
import java.util.*;
import java.text.MessageFormat;

/**
 * Title:        SkillRequestHandler
 * Description:  Handle requests from the Skills Edit Page
 * Copyright:    Copyright (c) 2008
 * Company:      Verint Systems, Inc.
 * @author       Gonzalo Quintanar
 */
<span class="fc" id="L34">public class SkillRequestHandler extends RequestHandler {</span>
<span class="fc" id="L35">    private static final Category log = Log.initCategory(SkillRequestHandler.class.getName());</span>

    private static final String REQUIRED_CONFIG_PRIVILEGE = PrivilegeKeys.CORE_CONFIGURESKILLS;
    private static final String REQUIRED_VIEW_PRIVILEGE = PrivilegeKeys.CORE_VIEWSKILLS;
    private static final String LIST_PAGE = &quot;listPage&quot;;
    private static final String FORM_PAGE = &quot;editPage&quot;;
    private static final String SKILLS_EXPORT = &quot;skills_export&quot;;


    /**
     * Process Request for the User page
     */
    public void processRequest(RequestContext context) throws Exception
    {
        //System.out.println(&quot;\n\n\nSkillRequestHandler.processRequest(): PageAction=&quot; + getPageAction(context) + &quot;\n\n&quot;);

<span class="pc bpc" id="L51" title="1 of 4 branches missed.">        if (isAction(context, PageAction.ADD) || isAction(context, PageAction.EDIT))</span>
        {
<span class="fc" id="L53">            goToFormPage(context);</span>
        }
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">        else if (isAction(context, PageAction.DONE))</span>
        {
            //Done or Cancel button was clicked. This should close the import dialog
<span class="nc" id="L58">            processDone(context);</span>
        }
<span class="fc bfc" id="L60" title="All 2 branches covered.">        else if (isAction(context, PageAction.NEW_ID))</span>
        {
<span class="fc" id="L62">            processDone(context);</span>
        }
<span class="fc bfc" id="L64" title="All 2 branches covered.">        else if (isAction(context, PageAction.SAVE))</span>
        {
<span class="fc" id="L66">            processSave(context);</span>
        }
<span class="fc bfc" id="L68" title="All 2 branches covered.">        else if (isAction(context, PageAction.DELETE))</span>
        {
<span class="fc" id="L70">            processDelete(context);</span>
        }
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">        else if (isAction(context, PageAction.CONFIRMED_DELETE))</span>
        {
<span class="nc" id="L74">            processForceDelete(context);</span>
        }
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">        else if (isAction(context, PageAction.IMPORT))</span>
        {
            //this simply displays the Import dialog
<span class="nc" id="L79">            processImport(context);</span>
        }
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        else if (isAction(context, PageAction.UPLOAD))</span>
        {
            //the user clicked &quot;Save&quot; in the Import dialog. Proceed to do the actual file upload/import
<span class="nc" id="L84">            processUpload(context);</span>
        }
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">        else if (isAction(context, SkillImportPageModel.SUCCESS))</span>
        {
            //the upload succeeded
<span class="nc" id="L89">            processUploadSuccess(context);</span>
        }
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        else if (isAction(context, PageAction.EXPORT))</span>
        {
            //this simply displays the Export dialog
<span class="nc" id="L94">            processExport(context);</span>
        }
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">        else if (isAction(context, PageAction.DOWNLOAD))</span>
        {
            //the user clicked &quot;Save&quot; in the Export dialog. Proceed to do the actual file download/export
<span class="nc" id="L99">            processDownload(context);</span>
        }
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        else if (isAction(context, SkillExportPageModel.DOWNLOAD_SUCCESS))</span>
        {
            //the download succeeded. NOTE: This case will never actually happen because the download
            //doesn't result in the request handler being called when it complete. We have no way
            //of knowing when it completes or if it was successful, because of browser security.
<span class="nc" id="L106">            processDownloadSuccess(context);</span>
        }
        else
        {
            //System.out.println(&quot;\n\n\nSkillRequestHandler.processRequest(): PageAction not found! will call processRefresh() by default...\n\n&quot;);
<span class="fc" id="L111">            processRefresh(context);</span>
        }
<span class="fc" id="L113">    }</span>

    /**
     * To go Form Page
     */
    private void goToFormPage(RequestContext context) {
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">        if (isAuthorized(context, REQUIRED_CONFIG_PRIVILEGE)) {</span>
<span class="fc" id="L120">            setNextPage(context, FORM_PAGE);</span>
        } else {
<span class="nc" id="L122">            setNextPage(context, LIST_PAGE);</span>
        }
<span class="fc" id="L124">    }</span>

    /**
     * Process Save Action
     */
    private void processSave(RequestContext context) throws RemoteException, MultiUserException
    {
<span class="fc" id="L131">        setNextPage(context, FORM_PAGE);</span>

        // Security check
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">        if (!isAuthorized(context, REQUIRED_CONFIG_PRIVILEGE)) return;</span>

<span class="fc" id="L136">        SkillEditPageModel model = new SkillEditPageModel(context);</span>

        // Retrieve Information and validate it
<span class="fc" id="L139">        model.extractParameters(context.getRequest());</span>
<span class="fc" id="L140">        model.validate();</span>

<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if (!model.hasError())</span>
        {
<span class="fc" id="L144">            Skill skill = model.getSkill();</span>
            try
            {
                //remove any leading or trailing whitespcae from Skill name
<span class="fc" id="L148">                skill.setName(skill.getName().trim());</span>

<span class="pc bpc" id="L150" title="1 of 2 branches missed.">                if (model.isNew())</span>
                {
                    // Create New Skill
<span class="fc" id="L153">                    ID newID = SkillModelHandler.createSkill(skill);</span>

                    // Prepare List Model for List page so that newly created Record is selected
<span class="fc" id="L156">                    SkillListPageModel listModel = new SkillListPageModel(context);</span>
<span class="fc" id="L157">                    listModel.setPerformActionOnIDs(new ID[] {newID});</span>
<span class="fc" id="L158">                    context.setPageModel(listModel);</span>
<span class="fc" id="L159">                }</span>
                else
                {
                    // Update Information to back end
<span class="nc" id="L163">                    SkillModelHandler.saveSkill(context, skill);</span>
                }
            }
<span class="nc" id="L166">            catch (BbmCreateDuplicateKeyException ex)</span>
            {
<span class="nc" id="L168">                logDuplicateSkillNameError(context, model, ex, skill);</span>
            }
<span class="nc" id="L170">            catch (BbmUpdateDuplicateKeyException ex) //TBD: Doesn't seem to get caught</span>
            {
<span class="nc" id="L172">                logDuplicateSkillNameError(context, model, ex, skill);</span>
            }
<span class="nc" id="L174">            catch (BbmUpdateException ex) //TBD: Since BbmUpdateDuplicateKeyException is not caught, using BbmUpdateException</span>
            {
<span class="nc" id="L176">                logDuplicateSkillNameError(context, model, ex, skill);</span>
            }
<span class="nc" id="L178">            catch (Exception ex)</span>
            {
<span class="nc" id="L180">                String msgID = BbmWebBundleKey.ORG_SKILL_ERROR_SAVE;</span>
<span class="nc" id="L181">                log.l7dError(msgID, ex);</span>
<span class="nc" id="L182">                model.addPageMessage(Message.ERROR_TYPE, msgID,	BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="pc" id="L183">            }</span>
        }

        // Only proceed to List page if page model does not have any errors
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">        if (model.hasError()) {</span>
<span class="nc" id="L188">            context.setPageModel(model);</span>
<span class="nc" id="L189">            setNextPage(context, FORM_PAGE);</span>
        } else {
<span class="fc" id="L191">            setNextPage(context, LIST_PAGE);</span>
        }
<span class="fc" id="L193">    }</span>

    private void logDuplicateSkillNameError(RequestContext context, SkillEditPageModel model, Exception ex, Skill skill) {
<span class="nc" id="L196">        String msgID = BbmWebBundleKey.ORG_SKILL_ERROR_IMPORT_DUPLICATED_KEY;</span>
<span class="nc" id="L197">        log.l7dError(msgID, ex);</span>
<span class="nc" id="L198">        String localizedMessage = &quot;&quot;;</span>
        try {
<span class="nc" id="L200">            localizedMessage = context.getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME, msgID);</span>
<span class="nc" id="L201">            Collection&lt;ID&gt; mediaIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L202">            mediaIDs.add(skill.getMediaID());</span>
<span class="nc" id="L203">            String mediaName = WorkloadModelHandler.getMediaDisplayFromIds(context, mediaIDs);</span>
<span class="nc" id="L204">            Object[] args = new Object[] { skill.getName(), mediaName };</span>
<span class="nc" id="L205">            model.addPageMessage(Message.ERROR_TYPE, MessageFormat.format(localizedMessage, args));</span>
        }
<span class="nc" id="L207">        catch (Exception ex2) {</span>
            //do nothing
<span class="nc" id="L209">        }</span>
<span class="nc" id="L210">    }</span>

    /**
     * Process Delete Action
     */
    private void processDelete(RequestContext context)
    {
<span class="fc" id="L217">        setNextPage(context, LIST_PAGE);</span>

        // Security check
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">        if (!isAuthorized(context, REQUIRED_CONFIG_PRIVILEGE)) return;</span>

        // Extract Parameter
<span class="fc" id="L223">        SkillListPageModel model = new SkillListPageModel(context);</span>
<span class="fc" id="L224">        model.extractParameters(context.getRequest());</span>

        // Process Delete
<span class="fc" id="L227">        ID[] ids = model.getSelectedSkillIDs();</span>
<span class="fc" id="L228">        ID id = ids[0];</span>

<span class="fc" id="L230">        processDelete(context, id, &quot;SKILL&quot;, model,</span>
                BbmWebBundleKey.ORG_SKILL_DELETE_FAILURE, BbmWebBundleKey.BUNDLE_NAME,
                BbmWebLogBundleKey.ORG_SKILL_DELETE_FAILURE, log);

        // Cache Model
<span class="fc" id="L235">        context.setPageModel(model);</span>
<span class="fc" id="L236">    }</span>

    /**
     * Process Force Delete Action
     */
    private void processForceDelete(RequestContext context)
    {
<span class="nc" id="L243">        setNextPage(context, LIST_PAGE);</span>

        // Security check
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (!isAuthorized(context, REQUIRED_CONFIG_PRIVILEGE)) return;</span>

        // Extract Parameter
<span class="nc" id="L249">        SkillListPageModel model = new SkillListPageModel(context);</span>
<span class="nc" id="L250">        model.extractParameters(context.getRequest());</span>

        // Process Force Delete
<span class="nc" id="L253">        ID[] ids = model.getSelectedSkillIDs();</span>
<span class="nc" id="L254">        ID id = ids[0];</span>

<span class="nc" id="L256">        processForceDelete(context, id, &quot;SKILL&quot;, model,</span>
                BbmWebBundleKey.ORG_SKILL_DELETE_FAILURE, BbmWebBundleKey.BUNDLE_NAME,
                BbmWebLogBundleKey.ORG_SKILL_DELETE_FAILURE, log);

        // Cache Model
<span class="nc" id="L261">        context.setPageModel(model);</span>
<span class="nc" id="L262">    }</span>


    /**
     * Process Done Action
     */
    private void processDone(RequestContext context) {
<span class="fc" id="L269">        setNextPage(context, LIST_PAGE);</span>
<span class="fc" id="L270">    }</span>

    /**
     * Process Refresh Action
     */
    private void processRefresh(RequestContext context) {
<span class="fc" id="L276">        setNextPage(context, LIST_PAGE);</span>
<span class="fc" id="L277">    }</span>

    /**
     * Process Import Action, which displays the Import Dialog.
     */
    private void processImport(RequestContext context)
    {
        //setNextPage(context, LIST_PAGE);

        // Extract Parameter
<span class="nc" id="L287">        SkillImportPageModel model = new SkillImportPageModel(context);</span>
<span class="nc" id="L288">        model.extractParameters(context.getRequest());</span>

        //Cache the SkillImportPageModel in the Request
<span class="nc" id="L291">        model.setPageDirty(false);</span>
<span class="nc" id="L292">        context.setPageModel(model);</span>
<span class="nc" id="L293">    }</span>

    /**
     * Process Upload Action, which actually imports all the new skills.
     */
    private void processUpload(RequestContext context)
    {
        //setNextPage(context, &quot;skills_import&quot;);

        // Security check
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (!isAuthorized(context, REQUIRED_CONFIG_PRIVILEGE))</span>
<span class="nc" id="L304">            return;</span>

        // Extract Parameter
<span class="nc" id="L307">        SkillImportPageModel model = new SkillImportPageModel(context);</span>
<span class="nc" id="L308">        model.extractParameters(context.getRequest());</span>

        try
        {
<span class="nc" id="L312">            model.processUpload(context);</span>
        }
<span class="nc" id="L314">        catch (BPException ex)</span>
        {
<span class="nc" id="L316">            log.l7dError(BbmWebLogBundleKey.UNABLE_TO_UPLOAD_DATA_FROM_FILE, ex);</span>
<span class="nc" id="L317">            model.addPageMessage(Message.ERROR_TYPE, BbmWebBundleKey.UploadDataFailure, BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L318">            Object[] params = ex.getParamObject();</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            if (params != null)</span>
            {
<span class="nc" id="L321">                String[] args = new String[params.length];</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                for (int i=0; i&lt;params.length; i++)</span>
                {
<span class="nc" id="L324">                    args[i] = (String) params[i];</span>
                }
<span class="nc" id="L326">                model.addPageMessage(Message.ERROR_TYPE, ex.getMsgID(), BbmEjbBundleKey.BUNDLE_NAME, args);</span>
<span class="nc" id="L327">            }</span>
            else
<span class="nc" id="L329">                model.addPageMessage(Message.ERROR_TYPE, ex.getMsgID(), BbmEjbBundleKey.BUNDLE_NAME);</span>
        }
<span class="nc" id="L331">        catch (Exception ex)</span>
        {
<span class="nc" id="L333">            log.l7dError(BbmWebLogBundleKey.UNABLE_TO_UPLOAD_DATA_FROM_FILE, ex);</span>
<span class="nc" id="L334">            model.addPageMessage(Message.ERROR_TYPE, BbmWebBundleKey.UploadDataFailure, BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L335">        }</span>

        //Cache the SkillImportPageModel in the Request
<span class="nc" id="L338">        model.setPageDirty(false);</span>
<span class="nc bnc" id="L339" title="All 4 branches missed.">        if (model.getPageAction() != null &amp;&amp; model.getPageAction().equals(SkillImportPageModel.SUCCESS))</span>
<span class="nc" id="L340">            model.setShowDoneButton(true);</span>

<span class="nc" id="L342">        context.setPageModel(model);</span>
<span class="nc" id="L343">    }</span>

    /**
     * Process Success Action, which happens after a successful import (upload)
     */
    private void processUploadSuccess(RequestContext context)
    {
        //setNextPage(context, LIST_PAGE);

        // Extract Parameter
<span class="nc" id="L353">        SkillImportPageModel model = new SkillImportPageModel(context);</span>
<span class="nc" id="L354">        model.extractParameters(context.getRequest());</span>

        //Cache the SkillImportPageModel in the Request
<span class="nc" id="L357">        model.setPageDirty(false);</span>
<span class="nc bnc" id="L358" title="All 4 branches missed.">        if (model.getPageAction() != null &amp;&amp; model.getPageAction().equals(SkillImportPageModel.SUCCESS))</span>
<span class="nc" id="L359">            model.setShowDoneButton(true);</span>

<span class="nc" id="L361">        context.setPageModel(model);</span>
<span class="nc" id="L362">    }</span>


    /**
     * Process Export Action, which displays the Export Dialog.
     */
    private void processExport(RequestContext context)
    {
<span class="nc" id="L370">        setNextPage(context, SKILLS_EXPORT);</span>

        // Extract Parameter
<span class="nc" id="L373">        SkillExportPageModel model = new SkillExportPageModel(context);</span>
<span class="nc" id="L374">        model.extractParameters(context.getRequest());</span>

        //Cache the SkillExportPageModel in the Request
<span class="nc" id="L377">        model.setPageDirty(false);</span>
<span class="nc" id="L378">        context.setPageModel(model);</span>
<span class="nc" id="L379">    }</span>

    /**
     * Process Download Action, which actually exports all the new skills.
     */
    private void processDownload(RequestContext context)
    {
        // Security check
<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (!isAuthorized(context, REQUIRED_VIEW_PRIVILEGE))</span>
<span class="nc" id="L388">            return;</span>

        // Extract Parameter
<span class="nc" id="L391">        SkillExportPageModel model = new SkillExportPageModel(context);</span>
<span class="nc" id="L392">        model.extractParameters(context.getRequest());</span>

        try
        {
<span class="nc" id="L396">            model.processDownload(context);</span>
        }
<span class="nc" id="L398">        catch (BPException ex)</span>
        {
<span class="nc" id="L400">            log.l7dError(BbmWebLogBundleKey.UNABLE_TO_UPLOAD_DATA_FROM_FILE, ex);</span>
<span class="nc" id="L401">            model.addPageMessage(Message.ERROR_TYPE, BbmWebBundleKey.UploadDataFailure, BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L402">            Object[] params = ex.getParamObject();</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">            if (params != null)</span>
            {
<span class="nc" id="L405">                String[] args = new String[params.length];</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">                for (int i=0; i&lt;params.length; i++)</span>
                {
<span class="nc" id="L408">                    args[i] = (String) params[i];</span>
                }
<span class="nc" id="L410">                model.addPageMessage(Message.ERROR_TYPE, ex.getMsgID(), BbmEjbBundleKey.BUNDLE_NAME, args);</span>
<span class="nc" id="L411">            }</span>
            else
<span class="nc" id="L413">                model.addPageMessage(Message.ERROR_TYPE, ex.getMsgID(), BbmEjbBundleKey.BUNDLE_NAME);</span>
        }
<span class="nc" id="L415">        catch (Exception ex)</span>
        {
<span class="nc" id="L417">            log.l7dError(BbmWebLogBundleKey.UNABLE_TO_UPLOAD_DATA_FROM_FILE, ex);</span>
<span class="nc" id="L418">            model.addPageMessage(Message.ERROR_TYPE, BbmWebBundleKey.UploadDataFailure, BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L419">        }</span>

        //Cache the SkillExportPageModel in the Request
<span class="nc" id="L422">        model.setPageDirty(false);</span>
<span class="nc bnc" id="L423" title="All 4 branches missed.">        if (model.getPageAction() != null &amp;&amp; model.getPageAction().equals(SkillExportPageModel.DOWNLOAD_SUCCESS))</span>
        {
            //We successfully sent the export file as the page response. We cannot show a &quot;success&quot; page 
            //because only a single response is allowed per Http request.
        }
        else
        {
            //Since download failed, we assume that nothing got sent in the page response, so we must show the same page.
<span class="nc" id="L431">            setNextPage(context, SKILLS_EXPORT);</span>
<span class="nc" id="L432">            context.setPageModel(model);</span>
        }
<span class="nc" id="L434">    }</span>

    /**
     * Process Success Action, which happens after a successful export (download)
     */
    private void processDownloadSuccess(RequestContext context)
    {
<span class="nc" id="L441">        setNextPage(context, SKILLS_EXPORT);</span>

        // Extract Parameter
<span class="nc" id="L444">        SkillExportPageModel model = new SkillExportPageModel(context);</span>
<span class="nc" id="L445">        model.extractParameters(context.getRequest());</span>

        //Cache the SkillExportPageModel in the Request
<span class="nc" id="L448">        model.setPageDirty(false);</span>

        //if (model.getPageAction() != null &amp;&amp; model.getPageAction().equals(SkillExportPageModel.DOWNLOAD_SUCCESS))
        //    model.setShowDoneButton(true);

<span class="nc" id="L453">        context.setPageModel(model);</span>
<span class="nc" id="L454">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>