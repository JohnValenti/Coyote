<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CalendarAppletRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.calendar</a> &gt; <span class="el_source">CalendarAppletRequestHandler.java</span></div><h1>CalendarAppletRequestHandler.java</h1><pre class="source lang-java linenums">/*
 * (c) 2002-2013 Verint Systems, Inc.
 */
package com.bluepumpkin.web.fs.calendar;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.Set;
import java.util.TimeZone;

import com.bluepumpkin.common.base.BPException;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.NullablePair;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.datatypes.TimeContext;
import com.bluepumpkin.common.datatypes.TimeOfDay;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.NumberFactory;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignWorkResource;
import com.bluepumpkin.ejb.bbm.campaign.model.FTECalculator;
import com.bluepumpkin.ejb.bbm.campaign.model.SP;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueueFieldInfo;
import com.bluepumpkin.ejb.bbm.campaign.model.SPShrinkage;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingRequest;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingSession;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingState;
import com.bluepumpkin.ejb.bbm.coaching.BbmCoachingBridgeInterface;
import com.bluepumpkin.ejb.bbm.config.ejb.DBConfigManager;
import com.bluepumpkin.ejb.bbm.elearning.BbmELearningBridgeInterface;
import com.bluepumpkin.ejb.bbm.elearning.model.LearningAssignmentInt;
import com.bluepumpkin.ejb.bbm.employeefilter.ejb.EmployeeFilter;
import com.bluepumpkin.ejb.bbm.employeefilter.model.Filter;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.EmpWorkRuleManager;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpPoolingRule;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpTimeBank;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRule;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceMonthlyMinMaxHour;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceWorkPattern;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.paypolicy.ejb.PayPolicyManager;
import com.bluepumpkin.ejb.bbm.pulse.ejb.TrackingManager;
import com.bluepumpkin.ejb.bbm.pulse.model.TrackingView;
import com.bluepumpkin.ejb.bbm.pulse.util.PulseUtil;
import com.bluepumpkin.ejb.bbm.rm.ShiftSwapCalendarInfo;
import com.bluepumpkin.ejb.bbm.rm.ShiftSwapCalendarInfoManager;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.BbmScheduleConflict;
import com.bluepumpkin.ejb.bbm.schedule.model.BbmScheduleConflictException;
import com.bluepumpkin.ejb.bbm.schedule.model.BbmScheduleConflictResolutions;
import com.bluepumpkin.ejb.bbm.schedule.model.CalendarEvent;
import com.bluepumpkin.ejb.bbm.schedule.model.CalendarEventAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.CalendarEventTemplate;
import com.bluepumpkin.ejb.bbm.schedule.model.EventTemplateExceptionCreateData;
import com.bluepumpkin.ejb.bbm.schedule.model.FloatingEventTemplate;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignmentFields;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftEventAssignment;
import com.bluepumpkin.ejb.bbm.skill.ejb.SkillManager;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.time.TimeContextFactory;
import com.bluepumpkin.ejb.bbm.timeseries.model.AggrForecastedTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.PredictTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.RequireTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.SPQueueTraceCubeData;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.vo.HOOPeriod;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.MediaFieldInfo;
import com.bluepumpkin.ejb.bbm.workload.model.MediaType;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.ServiceGoalsType;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.PersonData;
import com.bluepumpkin.ejb.bbm.workresource.model.Phantom;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourceAssignment;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.core.CoreEJBCreateException;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.facade.FacadeEJBCreateException;
import com.bluepumpkin.ejb.facade.FacadeManagerFactory;
import com.bluepumpkin.ejb.facade.corbafacade.ejb.FacadeCorbaFacadeManager;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.core.applet.AppletError;
import com.bluepumpkin.web.core.applet.AppletIO;
import com.bluepumpkin.web.core.applet.AppletRH;
import com.bluepumpkin.web.core.applet.TextAppletIO;
import com.bluepumpkin.web.core.cache.SelectionCacheUtil;
import com.bluepumpkin.web.core.keys.PageKeys;
import com.bluepumpkin.web.fs.Log;
import com.bluepumpkin.web.fs.keys.FsKeys;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.pulse.keys.PulseKeys;
import com.verint.ejb.bbm.forecast.ejb.ForecastTimeSeriesManager;
import com.verint.ejb.bbm.fterequirements.ejb.FteRequirementsManager;
import com.verint.ejb.bbm.fterequirements.model.RequiredTimeSeries;
import com.verint.ejb.bbm.fterequirements.util.FteRequirementsTimeSeriesUtil;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.fs.keys.WfmPageKeys;
import com.verint.web.fs.optimization.forecasting.l10n.ForecastingWebBundleKey;
import com.verint.web.fs.organization.OrgCalendarOptionsMH;
import com.witness.ejb.core.base.CoreFinderException;
import com.witness.ejb.core.gcr.ejb.GCRManager;
import com.witness.ejb.core.gcr.model.GCREntry;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.licensing.ejb.LicenseManager;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.ejb.core.security.UserManager;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.VerticalizationWebBundleKey;
import com.witness.web.uif.pagecomponent.screentoggler.ScreenTogglerPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.cache.UserCacheManager;
import com.witness.web.uif.system.manager.VerticalizationManager;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;

<span class="fc" id="L161">public class CalendarAppletRequestHandler extends AppletRH {</span>
<span class="fc" id="L162">	private CampaignManager m_campaignManager = null;</span>
<span class="fc" id="L163">	private ScheduleAccessManager m_scheduleAccessManager = null;</span>
<span class="fc" id="L164">	private WorkResourceManager m_workResourceManager = null;</span>
<span class="fc" id="L165">	private SkillManager m_skillManager = null;</span>
<span class="fc" id="L166">	private PayPolicyManager m_payPolicyManager = null;</span>
<span class="fc" id="L167">	private WorkloadManager m_workloadManager = null;</span>
<span class="fc" id="L168">	private WorkRuleManager m_workruleManager = null;</span>
<span class="fc" id="L169">	private EmployeeFilter m_empFilterManager = null;</span>
<span class="fc" id="L170">	private DBConfigManager m_dbManager = null;</span>
	private ResourceBundle m_fs_bundle;
<span class="fc" id="L172">	private EmpWorkRuleManager m_empWorkRuleManager = null;</span>
<span class="fc" id="L173">	private FteRequirementsManager m_fteRequirementsManager = null;</span>
<span class="fc" id="L174">	private TrackingManager m_trackingManager = null;</span>
<span class="fc" id="L175">	private ActivityManager m_activityManager = null;</span>
<span class="fc" id="L176">	private FacadeCorbaFacadeManager m_facadeCorbaFacadeManager = null;</span>
	private BbmELearningBridgeInterface m_bbmELearningBridge;
	private BbmCoachingBridgeInterface m_bbmCoachingBridge;
	private ShiftSwapCalendarInfoManager m_shiftSwapManager;
<span class="fc" id="L180">	private LicenseManager m_licenseManager = null;</span>
<span class="fc" id="L181">	private ForecastTimeSeriesManager m_forecastManager = null;</span>
<span class="fc" id="L182">	private UserManager m_userManager = null;</span>
	
<span class="fc" id="L184">	private static final Category log = Log.initCategory(CalendarAppletRequestHandler.class.getName(), FsWebBundleKey.BUNDLE_NAME);</span>
	private static final int DEFAULT_CHUNK_SIZE = 50;
	private static final int OVERLAP_PRECEDENCE = 2;
	private static final int SWAP_PRECEDENCE = 100;
	private static final int MILLIS_IN_MINUTES = 60000;
	private static final int DEFAULT_EMPLOYEE_CHUNK_SIZE = 100;
	private static final int DEFAULT_POLLING_INTERVAL_SECONDS = 5;
	private static final String CALENDAR_EMPLOYEE_CHUNK_SIZE = &quot;CalendarEmployeeChunkSize&quot;;

	private void processGetData(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="fc" id="L194">		String msgID = FsWebBundleKey.FS_CAL_REQHNDLR_UNKNOWN_REQUEST_TYPE;</span>
<span class="fc" id="L195">		Locale locale = context.getLocaleContext().getLanguageLocale();</span>
		try {
<span class="fc" id="L197">			String typeData = (String) appletRequest.get(PageKeys.GET_TYPE);</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">			if (PageKeys.GET_EMPLOYEE_NAMES.equals(typeData)) {</span>
<span class="fc" id="L199">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_EMPLOYEES;</span>
<span class="fc" id="L200">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L201">				Map hashEmployeeNames = this.getWorkResourceManager(context).getWorkResourceNamesByIDs(employeeIDs);</span>
<span class="fc" id="L202">				addResponseData(hashEmployeeNames, appletResponse);</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">			} else if (FsKeys.GET_EMPLOYEE_BASIC.equals(typeData)) {</span>
<span class="fc" id="L204">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_EMPLOYEES;</span>
<span class="fc" id="L205">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L206">				Map hashEmployeeStartEnd = this.getWorkResourceManager(context).getEmployeeStartEnd(employeeIDs);</span>
<span class="fc" id="L207">				addResponseData(hashEmployeeStartEnd, appletResponse);</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">			} else if (FsKeys.GET_EMPLOYEE_PROFICIENCY.equals(typeData)) {</span>
<span class="fc" id="L209">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_EMPLOYEES;</span>
<span class="fc" id="L210">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L211">				Map hashEmployeeProficiencies = null;</span>
<span class="pc bpc" id="L212" title="2 of 4 branches missed.">				if (employeeIDs != null &amp;&amp; employeeIDs.size() &gt; 0) {</span>
<span class="fc" id="L213">					Date timeSpot = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L214">					hashEmployeeProficiencies = this.getWorkResourceManager(context).getWorkResourceProficiency(employeeIDs, timeSpot);</span>
<span class="fc" id="L215">				} else {</span>
<span class="nc" id="L216">					hashEmployeeProficiencies = new HashMap();</span>
				}
<span class="fc" id="L218">				addResponseData(hashEmployeeProficiencies, appletResponse);</span>
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">			} else if (FsKeys.GET_CLASS_SESSIONS.equals(typeData)) {</span>
				//load class sessions from db
<span class="nc" id="L221">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_FLOATINGID_FORLESSONS;</span>
<span class="nc" id="L222">				Collection&lt;ID&gt; classIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EVENTTEMPLATE_ID);</span>
<span class="nc" id="L223">				Collection&lt;Collection&lt;CalendarEventAssignment&gt;&gt; sessions = this.getScheduleAccessManager(context)</span>
<span class="nc" id="L224">					.getCalendarEventAssignmentsForCalendarEventTemplate(classIDs);</span>
<span class="nc" id="L225">				Iterator&lt;ID&gt; iClass = classIDs.iterator();</span>
<span class="nc" id="L226">				Iterator&lt;Collection&lt;CalendarEventAssignment&gt;&gt; iSessions = sessions.iterator();</span>
<span class="nc" id="L227">				Map&lt;ID, Collection&lt;CalendarEventAssignment&gt;&gt; mapClassSession = new HashMap&lt;&gt;(classIDs.size());</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">				while (iClass.hasNext()) {</span>
<span class="nc" id="L229">					mapClassSession.put(iClass.next(), iSessions.next());</span>
				}
<span class="nc" id="L231">				addResponseData(mapClassSession, appletResponse);</span>

<span class="pc bfc" id="L233" title="All 2 branches covered.">			} else if (PageKeys.GET_EVENTS.equals(typeData)) {</span>
<span class="fc" id="L234">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_EVENT_DATA;</span>
<span class="fc" id="L235">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L236">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L237">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L238">				Pair eventsAndTemplates = new Pair();</span>
<span class="fc" id="L239">				Collection collectionEvents = this.getScheduleAccessManager(context)</span>
<span class="fc" id="L240">					.getEventsForWorkResources(employeeIDs, startDate, endDate);</span>
<span class="fc" id="L241">				Collection colletionTemplates = this.getScheduleAccessManager(context)</span>
<span class="fc" id="L242">					.getEventTemplatesForWorkResourceIDs(employeeIDs, startDate, endDate);</span>
<span class="fc" id="L243">				eventsAndTemplates.setFirst(collectionEvents);</span>
<span class="fc" id="L244">				eventsAndTemplates.setSecond(colletionTemplates);</span>
<span class="fc" id="L245">				addResponseData(eventsAndTemplates, appletResponse);</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">			} else if (PageKeys.GET_PUBLISHING_PERIOD.equals(typeData)) {</span>
<span class="fc" id="L247">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_PUBLISHING_PERIOD;</span>
<span class="fc" id="L248">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L249">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L250">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L251">				Collection periods = null;</span>
<span class="fc" id="L252">				periods = this.getScheduleAccessManager(context).getPublishedPeriods(employeeIDs, startDate, endDate);</span>
<span class="fc" id="L253">				addResponseData(periods, appletResponse);</span>
<span class="fc bfc" id="L254" title="All 2 branches covered.">			} else if (PageKeys.GET_SHIFTS.equals(typeData)) {</span>
<span class="fc" id="L255">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;</span>
<span class="fc" id="L256">				Map mapShifts = null;</span>
				//return all shifts
<span class="fc" id="L258">				mapShifts = ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context).getAllShifts());</span>
<span class="fc" id="L259">				addResponseData(mapShifts, appletResponse);</span>
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">			} else if (FsKeys.GET_SCREEN_TOGGLE_STATE.equals(typeData)) {</span>
<span class="nc" id="L261">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;</span>

				//the following screen toggler state key is from screen definition and web suite will pass to javascript
				//during init and don't keep in session. so applet can not get it. but since it is coming from screen
				//definition, it is ok to hard code here. but be aware of the key may not work if screen definition changed later.
<span class="nc" id="L266">				String screenTogglerStateKey = &quot;campaign_sp_people_selection?isDistributedCampaignEnabled=true-campaign_sp_people_summary&quot;;</span>
<span class="nc" id="L267">				Integer value = ScreenTogglerPC.getSessionState(context, screenTogglerStateKey);</span>
<span class="nc bnc" id="L268" title="All 4 branches missed.">				boolean isFullScreenCalendar = (value != null &amp;&amp; value.intValue() == 0) ? true : false;</span>
<span class="nc" id="L269">				addResponseData(Boolean.valueOf(isFullScreenCalendar), appletResponse);</span>
<span class="pc bfc" id="L270" title="All 2 branches covered.">			} else if (FsKeys.GET_EMPLOYEE_FILTERS.equals(typeData)) {</span>
<span class="fc" id="L271">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_ORGANIZATION_FILTER;</span>
<span class="fc" id="L272">				Collection filters = getEmployeeFilterManager(context).getFiltersByUserID(context.getUser().getID());</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">				filters = filters == null ? new ArrayList() : filters;</span>
<span class="fc" id="L274">				ArrayList filterNames = new ArrayList();</span>
<span class="fc" id="L275">				Filter filter = null;</span>
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">				for (Iterator i = filters.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L277">					filter = (Filter) i.next();</span>
<span class="nc" id="L278">					filterNames.add(filter.getFilterName());</span>
				}
<span class="fc" id="L280">				addResponseData(filterNames, appletResponse);</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">			} else if (FsKeys.GET_SHIFT_IDS.equals(typeData)) {</span>
<span class="fc" id="L282">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;</span>
<span class="fc" id="L283">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L284">				Collection&lt;ID&gt; empIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L285">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L286">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L287">				Collection&lt;ID&gt; shiftIDsInOrder = null;</span>
				//return all shift ot extension that available for the current set of employee
				//in the specific time range	
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">				if (campaignID != null) {</span>
<span class="fc" id="L291">					shiftIDsInOrder = getCampaignManager(context).getShift(campaignID, startDate, endDate);</span>
				} else {
<span class="nc" id="L293">					shiftIDsInOrder = getWorkRuleManager(context).getShiftIDsOrderByName(empIDs, startDate, endDate);</span>
				}
<span class="fc" id="L295">				addResponseData(shiftIDsInOrder, appletResponse);</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">			} else if (PageKeys.GET_SHIFTOTEXTENSION.equals(typeData)) {</span>
<span class="fc" id="L297">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFTOTEXTENSION;</span>
<span class="fc" id="L298">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L299">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L300">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
				//angela: for org scope it should return the list of ot extension available for 
				//the current selection of employees in the current time range.
<span class="fc" id="L303">				Map mapShiftOTE = null;</span>
<span class="pc bpc" id="L304" title="1 of 2 branches missed.">				if (campaignID == null) {</span>
					//return all shift ot extension that available for the current set of employee
					//in the specific time range
<span class="nc" id="L307">					Collection&lt;ID&gt; empIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L308">					mapShiftOTE = ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context).getShiftOTExtension(empIDs, startDate, endDate));</span>
<span class="nc" id="L309">				} else {</span>
					//return shifts under the campaign only.
<span class="fc" id="L311">					mapShiftOTE = ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context).getShiftOTExtension(</span>
						new ScopeID(campaignID, Scope.CAMPAIGN_SCOPE), startDate, endDate));
					//campaignID should be SID
				}
<span class="fc" id="L315">				addResponseData(mapShiftOTE, appletResponse);</span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">			} else if (PageKeys.GET_SHIFT.equals(typeData)) {</span>
<span class="nc" id="L317">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT;</span>
<span class="nc" id="L318">				ID shiftID = (ID) appletRequest.get(PageKeys.SHIFT_ID);</span>
<span class="nc" id="L319">				Shift shift = this.getWorkRuleManager(context).getShift(shiftID);</span>
<span class="nc" id="L320">				addResponseData(shift, appletResponse);</span>
<span class="pc bfc" id="L321" title="All 2 branches covered.">			} else if (PageKeys.GET_SCHEDULING_STATE.equals(typeData)) {</span>
<span class="fc" id="L322">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;</span>
<span class="fc" id="L323">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L324">				String modeChar = (String) appletRequest.get(FsKeys.MODE_CHAR);</span>
<span class="fc" id="L325">				SchedulingState state = getCampaignManager(context).getSchedulingState(spID, modeChar);</span>
<span class="fc" id="L326">				addResponseData(state, appletResponse);</span>
<span class="fc bfc" id="L327" title="All 2 branches covered.">			} else if (PageKeys.GET_SCHEDULING_SESSION.equals(typeData)) {</span>
<span class="fc" id="L328">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;</span>
<span class="fc" id="L329">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L330">				Collection&lt;SchedulingSession&gt; sessions = getCampaignManager(context).getSPScheduleSession(spID);</span>
<span class="fc" id="L331">				addResponseData(sessions, appletResponse);</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">			} else if (PageKeys.GET_ACTIVITY.equals(typeData)) {</span>
<span class="nc" id="L333">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_ACTIVITY;</span>
<span class="nc" id="L334">				ID activityID = (ID) appletRequest.get(PageKeys.ACTIVITY_ID);</span>
<span class="nc" id="L335">				ActivityManager activityManager = getActivityManager(context);</span>
<span class="nc" id="L336">				Activity activity = activityManager.findActivityById(activityID);</span>
<span class="nc" id="L337">				addResponseData(activity, appletResponse);</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">			} else if (PageKeys.GET_ACTIVITIES.equals(typeData)) {</span>
<span class="nc" id="L339">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_ACTIVITIES;</span>
<span class="nc" id="L340">				Collection&lt;ID&gt; activityID = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.ACTIVITY_IDS);</span>
<span class="nc" id="L341">				ActivityManager activityManager = getActivityManager(context);</span>
<span class="nc" id="L342">				Collection&lt;Activity&gt; activities = activityManager.findActivities(activityID);</span>
<span class="nc" id="L343">				addResponseData(activities, appletResponse);</span>
<span class="pc bfc" id="L344" title="All 2 branches covered.">			} else if (PageKeys.GET_EVENT_ATTRIBUTES.equals(typeData)) {</span>
<span class="fc" id="L345">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_EVENTATTRIBUTE_DATA;</span>
<span class="fc" id="L346">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L347">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L348">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L349">				Map&lt;ID, Activity&gt; mapActivities = null;</span>
				//angela: in the current release, activity can not be created under campaign. 
<span class="fc" id="L351">				ActivityManager activityManager = getActivityManager(context);</span>
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">				if (campaignID == null) {</span>
					//return all activities
<span class="nc" id="L354">					ActivityFilter activityOrganizationFilter = new ActivityFilter();</span>
<span class="nc" id="L355">					Collection&lt;Activity&gt; activities = activityManager.findActivities(activityOrganizationFilter);</span>
<span class="nc" id="L356">					mapActivities = ValueObjectUtil.getIDObjectMap(activities);</span>
<span class="nc" id="L357">				} else {</span>
					//return the activities created or inherited in the org that links to the campaign.
<span class="fc" id="L359">					Collection&lt;ID&gt; campaignOrgIDs = getCampaignManager(context).getOrganizationsForCampaign(campaignID, startDate, endDate);</span>
<span class="fc" id="L360">					mapActivities = ValueObjectUtil.getIDObjectMap(activityManager.findOrganizationActivities(campaignOrgIDs, true));</span>
				}
<span class="fc" id="L362">				addResponseData(mapActivities, appletResponse);</span>

<span class="pc bpc" id="L364" title="1 of 2 branches missed.">			} else if (PageKeys.GET_REALTIME_STATS_SUPPORT_DATA.equals(typeData)) {</span>
<span class="nc" id="L365">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_QUEUEACTIVITY_DATA;</span>
<span class="nc" id="L366">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L367">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L368">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L369">				SchedulingPeriod sp = getCampaignManager(context).getSchedulingPeriodByID(spID);</span>
<span class="nc" id="L370">				Campaign c = getCampaignManager(context).getCampaignByID(sp.getCampaignID());</span>
<span class="nc" id="L371">				Collection&lt;SPQueue&gt; spQueues = getCampaignManager(context).getSPQueuesBySPID(spID);</span>

				// Get a map (queue SID -&gt; PCA goal seconds) for each queue in the SP
<span class="nc" id="L374">				appletResponse.put(PageKeys.QUEUE_SERVICE_LEVEL_GOAL_SECONDS_MAP, getQueueServiceLevelGoalSecondsMap(spQueues,</span>
<span class="nc" id="L375">					sp.getSkillBased()));</span>

				// Get shrinkage and modeling factors
<span class="nc" id="L378">				Pair&lt;float[], float[]&gt; shrinkageAndModelingFactors = getShrinkageAndModelingFactorsForSP(c, sp);</span>
<span class="nc" id="L379">				appletResponse.put(PageKeys.SP_SHRINKAGE, shrinkageAndModelingFactors.getFirst());</span>
<span class="nc" id="L380">				appletResponse.put(PageKeys.SP_MODELING_FACTORS, shrinkageAndModelingFactors.getSecond());</span>

				// For an unskilled SP we add raw (no min occupancy) FTE values to assist in
				// doing real-time service level calculations.
<span class="nc bnc" id="L384" title="All 2 branches missed.">				if (!sp.getSkillBased()) {</span>
<span class="nc" id="L385">					appletResponse.put(PageKeys.QUEUE_REQUIRED_FTE_NO_MIN_OCCUPANCY, getQueueRequiredFTEForRealTimeServiceLevelMap(</span>
<span class="nc" id="L386">						context, c.getID(), spQueues, startDate, endDate, false, false));</span>

<span class="nc" id="L388">					appletResponse.put(WfmPageKeys.QUEUE_REQUIRED_FTE_WITH_MIN_OCCUPANCY, getQueueRequiredFTEForRealTimeServiceLevelMap(</span>
<span class="nc" id="L389">						context, c.getID(), spQueues, startDate, endDate, true, false));</span>
				}
<span class="pc bfc" id="L391" title="All 2 branches covered.">			} else if (PageKeys.GET_ACTIVITY_QUEUES.equals(typeData)) {</span>
<span class="fc" id="L392">				msgID = getQueueActivitiesMaps(context, appletRequest, appletResponse, locale);</span>
<span class="pc bpc" id="L393" title="1 of 2 branches missed.">			} else if (FsKeys.GET_CHILD_ACTIVITIES_QUEUES.equals(typeData)) {</span>
<span class="nc" id="L394">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_QUEUEACTIVITY_DATA;</span>
<span class="nc" id="L395">				Collection&lt;ID&gt; spIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>

<span class="nc" id="L397">				ActivityManager activityManager = getActivityManager(context);</span>
				//TODO AJP: Is this the proper scope for the activities?  I believe this is all undeleted activities
<span class="nc" id="L399">				Collection allActivityIDs = activityManager.findActivitiesIds(new ActivityFilter(ActivityFilter.FILTER_DELETED));</span>
<span class="nc" id="L400">				Map&lt;ID, Collection&lt;ID&gt;&gt; activityToMediaMap = activityManager.findMediaForActivities(allActivityIDs);</span>

<span class="nc" id="L402">				Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L403">				Map&lt;ID, ID&gt; queueToSkillMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L404">				Map&lt;ID, ArrayList&lt;ID&gt;&gt; mediaIdToQueueIDMap = new HashMap&lt;ID, ArrayList&lt;ID&gt;&gt;();</span>
<span class="nc" id="L405">				WorkloadManager wm = getWorkloadManager(context);</span>
<span class="nc" id="L406">				Collection&lt;Queue&gt; qCollection = new ArrayList&lt;Queue&gt;();</span>

<span class="nc bnc" id="L408" title="All 2 branches missed.">				for (ID spID : spIDs) {</span>
<span class="nc" id="L409">					qCollection.addAll(wm.getNonCombinedQueuesByMediaAndSP(null, spID));</span>
					//get a hashmap that links each individual queue in the SP to its skill. If a queue has no skill, it won't be in the map.
<span class="nc" id="L411">					queueToSkillMap.putAll(getCampaignManager(context).getQueueIDToSkillMap(spID));</span>
<span class="nc" id="L412">				}</span>

<span class="nc" id="L414">				appletResponse.put(FsKeys.SKILL, queueToSkillMap);</span>

				//CRITICAL AJP: We need to Explicitly create IDs from the queue collection. 
				//	Do Not Call: HashMap&lt;ID, Queue&gt; mapQueue = ValueObjectUtil.getIDObjectMap(qCollection);
				//	I am encountering an odd Java issue when iterating through the keySet of a HashMap, which will be done in Jdmo.createInClause(...) 
<span class="nc bnc" id="L419" title="All 2 branches missed.">				for (Queue q : qCollection) {</span>
<span class="nc" id="L420">					queueIds.add(q.getID());</span>
<span class="nc" id="L421">					ArrayList&lt;ID&gt; queuesForMedia = mediaIdToQueueIDMap.get(q.getMediaID());</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">					if (queuesForMedia == null)</span>
<span class="nc" id="L423">						queuesForMedia = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L424">					queuesForMedia.add(q.getID());</span>
<span class="nc" id="L425">					mediaIdToQueueIDMap.put(q.getMediaID(), queuesForMedia);</span>
<span class="nc" id="L426">				}</span>

				//findAllActivitiesForQueues just returns queue hopping links.  It is a Map of Queue ID (key) and collection of Activity Ids (value)
				//We then add all activities that are indirectly mapped to the Queues through the media in &quot;Non-Queue Hopping&quot; scenarios.
<span class="nc" id="L430">				Map&lt;ID, ArrayList&lt;ID&gt;&gt; queueToActivityMap = activityManager.findActivitiesDirectlyMappedToQueuesInDB(queueIds);</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">				for (Map.Entry&lt;ID, Collection&lt;ID&gt;&gt; entry : activityToMediaMap.entrySet()) {</span>
<span class="nc" id="L432">					Activity activity = activityManager.findActivityById(entry.getKey());</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">					if (!activity.isQueueHopping()) {</span>
						//Get all queues with Media from entry.getValue()
						//Add this activity to that queueToActivityMap
<span class="nc bnc" id="L436" title="All 2 branches missed.">						for (ID mediaId : entry.getValue()) {</span>
<span class="nc" id="L437">							ArrayList&lt;ID&gt; queuesForMedia = mediaIdToQueueIDMap.get(mediaId);</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">							if (queuesForMedia != null) {</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">								for (ID queueId : queuesForMedia) {</span>
<span class="nc" id="L440">									ArrayList&lt;ID&gt; activityIds = queueToActivityMap.get(queueId);</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">									if (activityIds == null) {</span>
<span class="nc" id="L442">										activityIds = new ArrayList&lt;ID&gt;();</span>
									}
<span class="nc" id="L444">									activityIds.add(entry.getKey());</span>
<span class="nc" id="L445">									queueToActivityMap.put(queueId, activityIds);</span>
<span class="nc" id="L446">								}</span>
							}
<span class="nc" id="L448">						}</span>
					}
<span class="nc" id="L450">				}</span>
<span class="nc" id="L451">				appletResponse.put(PageKeys.APPLET_DATA, queueToActivityMap);</span>
<span class="pc bfc" id="L452" title="All 2 branches covered.">			} else if (FsKeys.ORGANIZATIONS_AND_HOOS.equals(typeData)) {</span>
<span class="fc" id="L453">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_ORGANIZATION_AND_HOOS;</span>
<span class="fc" id="L454">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L455">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L456">				Collection&lt;ID&gt; list = new ArrayList();</span>
<span class="fc" id="L457">				list.add(new ID(-3002));</span>
<span class="fc" id="L458">				list.addAll(getWorkResourceManager(context).getOrganizationsChildrenByIDs(list));</span>
<span class="fc" id="L459">				Collection&lt;Organization&gt; allOrgs = getWorkResourceManager(context).getOrganizationsByIDs(list);</span>
<span class="fc" id="L460">				appletResponse.put(PageKeys.ORGANIZATIONS, ValueObjectUtil.getIDObjectMap(allOrgs));</span>
				//though the call takes start and end dates but they are not used
<span class="fc" id="L462">				Map mapOrgHOOs = getWorkResourceManager(context).getHOOPeriod(ValueObjectUtil.getIDFromObjects(allOrgs), startDate, endDate);</span>
<span class="fc" id="L463">				appletResponse.put(PageKeys.ORGANIZATIONHOOS, mapOrgHOOs);</span>
<span class="fc bfc" id="L464" title="All 2 branches covered.">			} else if (FsKeys.SP_DATA.equals(typeData)) {</span>
<span class="fc" id="L465">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SP_DATA;</span>
<span class="fc" id="L466">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L467">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L468">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L469">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
				
				//Get all employee &amp; phantom ID's linked to the scheduling period
<span class="fc" id="L472">				Campaign campaign = getCampaignManager(context).getCampaignByID(campaignID);</span>
<span class="fc" id="L473">				SchedulingPeriod sp = getCampaignManager(context).getSchedulingPeriodByID(spID);</span>
<span class="fc" id="L474">				List employeeIDs = getSpEmployeeIDs(context, spID, campaign, startDate, endDate);</span>
<span class="fc" id="L475">				appletResponse.put(PageKeys.EMPLOYEE_IDS, employeeIDs);</span>

				//if the SP is a child SP, includes its parent SP ID. If it's a parent SP, include its children SP ID's.
<span class="pc bpc" id="L478" title="1 of 2 branches missed.">				if (campaign.getIsDistributed()) {</span>
					//This is a parent SP. Return its children SP ID's
<span class="nc" id="L480">					appletResponse.put(PageKeys.CHILD_SPIDS, getChildSPIDs(context, campaign, startDate, endDate));</span>
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">				} else if (sp.getParentSPID() != null) {</span>
					//This is a child SP. Return its parent SP ID.
<span class="nc" id="L483">					appletResponse.put(PageKeys.PARENT_SPID, getCampaignManager(context).getParentSchedulingPeriodID(spID));</span>
				}
<span class="fc bfc" id="L485" title="All 2 branches covered.">			} else if (FsKeys.GET_LICENSES_AND_CONFIG.equals(typeData)) {</span>
<span class="fc" id="L486">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_LICENSES;</span>
<span class="fc" id="L487">				getLicenses(appletResponse);</span>

				

<span class="fc" id="L491">				appletResponse.put(FsKeys.IS_WHATIFMODE, context.isInWhatIfMode());</span>
				//secret key
<span class="pc bpc" id="L493" title="1 of 2 branches missed.">				appletResponse.put(FsKeys.IS_EXPORTABSENCETYPE, new Boolean(getDBManager(context).getIntValue(&quot;EXPORTABSENCETYPE&quot;) == 1));</span>

				//  Added key for enabling/disabling Employee filter
<span class="fc" id="L496">				appletResponse.put(FsKeys.EMPLOYEEFILTER_DISABLE, new Boolean(isEmployeeFilterBpconfigEnabled()));</span>

<span class="fc" id="L498">				appletResponse.put(FsKeys.EMPLOYEE_CHUNK_SIZE, new Integer(getEmployeeChunkSize()));</span>
				
<span class="fc" id="L500">				appletResponse.put(FsKeys.STATUS_POLLING_INTERVAL_SECONDS, new Integer(getPollingInterval()));</span>
				
<span class="fc" id="L502">				String value = getDBManager(context).getValue(FsKeys.IS_SIMPLIFIEDCALENDAR);</span>
<span class="pc bpc" id="L503" title="2 of 4 branches missed.">				appletResponse.put(FsKeys.IS_SIMPLIFIEDCALENDAR, value != null &amp;&amp; value.equals(&quot;true&quot;));</span>
				
<span class="pc bpc" id="L505" title="1 of 2 branches missed.">			} else if( PageKeys.GET_CAMPAIGNHOO_DATA.equals(typeData) ) {</span>
<span class="nc" id="L506">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGNHOOS_DATA;</span>
<span class="nc" id="L507">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L508">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L509">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
								
<span class="nc" id="L511">				Collection campaignHOOAssignments = getCampaignManager(context).getCampaignHOOAssignments(campaignID, startDate, endDate);</span>
				
<span class="nc" id="L513">				HOOPeriod hooPeriod = getCampaignManager(context).getHOOPeriod(campaignID, startDate, endDate);</span>
<span class="nc" id="L514">				appletResponse.put(PageKeys.CAMPAIGN_HOO_PERIOD, hooPeriod);</span>
				
<span class="pc bfc" id="L516" title="All 2 branches covered.">			} else if (PageKeys.GET_CONFLICT_BACKGROUND_DATA.equals(typeData)) {</span>
<span class="fc" id="L517">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CONFLICTCHECKING_DATA;</span>
				// get all input parameters
<span class="fc" id="L519">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L520">				SchedulingPeriod sp = (SchedulingPeriod) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD);</span>
<span class="fc" id="L521">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L522">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L523">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
				// get all output parameters
<span class="pc bpc" id="L525" title="1 of 2 branches missed.">				if (campaignID != null) {</span>
<span class="fc" id="L526">					HOOPeriod hooPeriod = getCampaignManager(context).getHOOPeriod(campaignID, startDate, endDate);</span>
<span class="fc" id="L527">					appletResponse.put(PageKeys.CAMPAIGN_HOO_PERIOD, hooPeriod);</span>
				}

<span class="fc" id="L530">				Map workResourceCampaignAssignments = getCampaignManager(context).getWorkResourceCampaignAssignments(employeeIDs, </span>
					startDate, endDate);

<span class="fc" id="L533">				Map empOrgAssignments = getEmpOrgAssignments(context, employeeIDs, startDate, endDate);</span>

<span class="fc" id="L535">				Map mapEmpWorkPatternAssignments = getEmpWorkRuleManager(context).getWorkPatternAssignments(employeeIDs, startDate, endDate);</span>
				//load workpattern used by those employees
<span class="fc" id="L537">				Collection colAssignments = null;</span>
<span class="fc" id="L538">				WorkResourceWorkPattern ww= null;</span>
<span class="fc" id="L539">				Set&lt;ID&gt; colWWSID = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L540" title="All 2 branches covered.">				for (Iterator i = mapEmpWorkPatternAssignments.values().iterator(); i.hasNext();) {</span>
<span class="fc" id="L541">					colAssignments = (Collection)i.next();</span>
<span class="pc bpc" id="L542" title="2 of 4 branches missed.">					if (colAssignments != null &amp;&amp; !colAssignments.isEmpty()) {</span>
<span class="fc bfc" id="L543" title="All 2 branches covered.">						for (Iterator ix = colAssignments.iterator(); ix.hasNext(); ) {</span>
<span class="fc" id="L544">							ww= (WorkResourceWorkPattern)ix.next();</span>
<span class="fc" id="L545">							colWWSID.add(ww.getWorkPatternSID());</span>
						}
					}
				}
<span class="fc" id="L549">				Map mapWorkPatterns = new HashMap();</span>
<span class="pc bpc" id="L550" title="1 of 2 branches missed.">				if (!colWWSID.isEmpty())</span>
<span class="fc" id="L551">					mapWorkPatterns = ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context).getShiftPatternsByIDs(colWWSID));</span>

<span class="fc" id="L553">				Map mapEmpRotationAssignments = getEmpWorkRuleManager(context).getRotationAssignments(employeeIDs);</span>


<span class="fc" id="L556">				Map mapMinMaxHourAssignments = getEmpWorkRuleManager(context).getMinMaxHourAssignments(employeeIDs, startDate, endDate);</span>
				
<span class="fc" id="L558">				Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L559">				cal.setTime(startDate);</span>
<span class="fc" id="L560">				int year = cal.get(Calendar.YEAR);</span>
<span class="fc" id="L561">				Map&lt;ID, List&lt;WorkResourceMonthlyMinMaxHour&gt;&gt; mapMonthlyMinMaxHourAssignments = getEmpWorkRuleManager(context)</span>
<span class="fc" id="L562">						.getMonthlyMinMaxHourAssignments(employeeIDs, year);</span>
				
				// put all output parameters into the applet response
<span class="fc" id="L565">				Map empWorkRuleAssignment = getEmpWorkRuleManager(context).getComplexWorkRuleAssignments(employeeIDs);</span>
<span class="fc" id="L566">				colAssignments = null;</span>
<span class="fc" id="L567">				WorkResourceComplexWorkRule wc= null;</span>
<span class="fc" id="L568">				Set&lt;ID&gt; colCWSID = new HashSet&lt;ID&gt;();</span>
<span class="fc bfc" id="L569" title="All 2 branches covered.">				for (Iterator i = empWorkRuleAssignment.values().iterator(); i.hasNext();) {</span>
<span class="fc" id="L570">					colAssignments = (Collection)i.next();</span>
<span class="pc bpc" id="L571" title="2 of 4 branches missed.">					if (colAssignments != null &amp;&amp; !colAssignments.isEmpty()) {</span>
<span class="fc bfc" id="L572" title="All 2 branches covered.">						for (Iterator ix = colAssignments.iterator(); ix.hasNext(); ) {</span>
<span class="fc" id="L573">							wc= (WorkResourceComplexWorkRule)ix.next();</span>
<span class="fc" id="L574">							colCWSID.add(wc.getComplexWorkRuleID());</span>
						}
					}
				}
<span class="fc" id="L578">				Map mapWorkRules = new HashMap();</span>
<span class="fc bfc" id="L579" title="All 2 branches covered.">				if (!colCWSID.isEmpty()) {</span>
<span class="fc" id="L580">					mapWorkRules = ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context).getComplexWorkRulesByIDs(colCWSID));</span>
				}

				// get shift swap calendar info
<span class="fc" id="L584">				List&lt;ShiftSwapCalendarInfo&gt; shiftSwapCalendarInfos = getShiftSwapCalendarInfos(startDate, endDate, </span>
					new ArrayList&lt;ID&gt;(employeeIDs));
<span class="fc" id="L586">				appletResponse.put(PageKeys.GET_SHIFT_SWAP_INFO, shiftSwapCalendarInfos);</span>

<span class="pc bpc" id="L588" title="1 of 2 branches missed.">				appletResponse.put(PageKeys.EMPLOYEE_WORKRULE_ASSIGNMENTS, empWorkRuleAssignment == null </span>
					? new HashMap():empWorkRuleAssignment);
<span class="fc" id="L590">				appletResponse.put(PageKeys.WORKRULES, mapWorkRules);</span>
<span class="fc" id="L591">				appletResponse.put(PageKeys.EMPLOYEE_CAMPAIGN_ASSIGNMENTS, workResourceCampaignAssignments);</span>
<span class="fc" id="L592">				appletResponse.put(PageKeys.EMPLOYEE_ORGANIZATION_ASSIGNMENTS, empOrgAssignments);</span>
<span class="pc bpc" id="L593" title="1 of 2 branches missed.">				appletResponse.put(PageKeys.EMPLOYEE_WORKPATTERN_ASSIGNMENTS, mapEmpWorkPatternAssignments == null </span>
					? new HashMap():mapEmpWorkPatternAssignments);
<span class="fc" id="L595">				appletResponse.put(PageKeys.WORKPATTERNS, mapWorkPatterns);</span>
<span class="pc bpc" id="L596" title="1 of 2 branches missed.">				appletResponse.put(PageKeys.EMPLOYEE_ROTATION_ASSIGNMENTS, mapEmpRotationAssignments == null </span>
					? new HashMap():mapEmpRotationAssignments);
<span class="pc bpc" id="L598" title="1 of 2 branches missed.">				appletResponse.put(PageKeys.EMPLOYEE_MINMAXHOURS_ASSIGNMENTS, mapMinMaxHourAssignments == null </span>
					? new HashMap():mapMinMaxHourAssignments);
<span class="pc bpc" id="L600" title="1 of 2 branches missed.">				appletResponse.put(FsKeys.EMPLOYEE_MONTHLY_MINMAXHOURS_ASSIGNMENTS, mapMonthlyMinMaxHourAssignments == null </span>
					? new HashMap() : mapMonthlyMinMaxHourAssignments);
				
				//load shift events
<span class="fc bfc" id="L604" title="All 2 branches covered.">				if ((Boolean)appletRequest.get(PageKeys.IS_LOADING_SHIFT_EVENTS)) {</span>
<span class="pc bpc" id="L605" title="1 of 2 branches missed.">					if (sp != null) {</span>
<span class="fc" id="L606">						appletResponse.put(PageKeys.SHIFTEVENTS, getWorkRuleManager(context).getShiftEventsBySchedulingPeriod(sp));</span>
					} else {
<span class="nc" id="L608">						appletResponse.put(PageKeys.SHIFTEVENTS, getWorkRuleManager(context)</span>
<span class="nc" id="L609">							.getShiftEvents(employeeIDs, startDate, endDate));</span>
					}
				}
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">			} else if (FsKeys.GET_SHIFT_SWAP_INFO.equals(typeData)) {</span>
<span class="nc" id="L613">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L614">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L615">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L616">				List&lt;ShiftSwapCalendarInfo&gt; shiftSwapCalendarInfos = getShiftSwapCalendarInfos(startDate, endDate, new ArrayList&lt;ID&gt;(employeeIDs));</span>
<span class="nc" id="L617">				appletResponse.put(FsKeys.GET_SHIFT_SWAP_INFO, shiftSwapCalendarInfos);</span>
<span class="pc bfc" id="L618" title="All 2 branches covered.">			} else if (PageKeys.GET_CAMPAIGNS.equals(typeData)) {</span>
<span class="fc" id="L619">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_DATA;</span>
<span class="fc" id="L620">				Collection&lt;Campaign&gt; campaigns = getCampaignManager(context).getCampaigns();</span>
<span class="fc" id="L621">				Collection&lt;ID&gt; campaignIDs = ValueObjectUtil.getIDFromObjects(campaigns);</span>
<span class="fc" id="L622">				Map&lt;ID, Integer&gt; spsByCampaignID = getCampaignManager(context).getCampaignSIDAttachedSchedulingPeriodCountMap(campaignIDs);</span>
				// Only return campaigns that have at least one attached SP.
<span class="fc" id="L624">				Collection&lt;Campaign&gt; filteredCampaigns = new ArrayList&lt;Campaign&gt;();</span>
<span class="fc bfc" id="L625" title="All 2 branches covered.">				for (Campaign c : campaigns) {</span>
<span class="fc" id="L626">					Integer spCount = spsByCampaignID.get(c.getID());</span>
<span class="pc bpc" id="L627" title="2 of 4 branches missed.">					if (spCount != null &amp;&amp; spCount &gt; 0) {</span>
<span class="fc" id="L628">						filteredCampaigns.add(c);</span>
					}
<span class="fc" id="L630">				}</span>
				
<span class="fc" id="L632">				appletResponse.put(PageKeys.CAMPAIGNS, filteredCampaigns);</span>
<span class="fc bfc" id="L633" title="All 2 branches covered.">			} else if (FsKeys.GET_VERTICALIZED_STRING.equals(typeData)) {</span>
				//load verticalized strings map
<span class="fc" id="L635">				appletResponse.put(PageKeys.VERTICALIZED_STRINGS, getVerticalizedStrings(context));</span>
<span class="fc bfc" id="L636" title="All 2 branches covered.">			} else if (PageKeys.GET_CAMPAIGN_SCHEDULEPERIODS.equals(typeData)) {</span>
<span class="fc" id="L637">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_SCHEDULING_PERIODS;</span>
<span class="fc" id="L638">				Campaign campaign = (Campaign) appletRequest.get(PageKeys.CAMPAIGN);</span>
<span class="fc" id="L639">				Collection schedulingPeriods = getCampaignManager(context).getSchedulingPeriods(campaign);</span>
<span class="fc" id="L640">				appletResponse.put(PageKeys.CAMPAIGN_SCHEDULINGPERIODS, schedulingPeriods);</span>
<span class="fc bfc" id="L641" title="All 2 branches covered.">			} else if (PageKeys.GET_CAMPAIGN_HOODATEPAIRS.equals(typeData)) {</span>
<span class="fc" id="L642">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_HOOS;</span>
<span class="fc" id="L643">				Campaign campaign = (Campaign) appletRequest.get(PageKeys.CAMPAIGN);</span>
<span class="fc" id="L644">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L645">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L646">				Collection hooDatePairs = null;</span>
<span class="pc bpc" id="L647" title="3 of 6 branches missed.">				if (campaign == null || startDate == null || endDate == null) {</span>
<span class="nc" id="L648">					hooDatePairs =  new ArrayList(0);</span>
				}
<span class="fc" id="L650">				ID campaignId = campaign.getID();</span>
<span class="fc" id="L651">				HOOPeriod hooPeriod = getCampaignManager(context).getHOOPeriod(campaignId, startDate, endDate);</span>
<span class="fc" id="L652">				hooDatePairs = hooPeriod.getOpenPeriods(startDate, endDate);</span>
<span class="fc" id="L653">				appletResponse.put(PageKeys.CAMPAIGN_HOODATEPAIRS, hooDatePairs);</span>
				
<span class="fc bfc" id="L655" title="All 2 branches covered.">			} else if (PageKeys.GET_CAMPAIGN_SCHEDULEPERIOD.equals(typeData)) {</span>
<span class="fc" id="L656">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_SCHEDULING_PERIOD;</span>
<span class="fc" id="L657">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L658">				SchedulingPeriod schedulingPeriod = getCampaignManager(context).getSchedulingPeriodByID(spID);</span>
<span class="fc" id="L659">				getScheduleAccessManager(context).linkShiftAssignmentsToSchedulingPeriod(spID);</span>
<span class="fc" id="L660">				appletResponse.put(PageKeys.CAMPAIGN_SCHEDULINGPERIOD, schedulingPeriod);</span>
<span class="pc bpc" id="L661" title="1 of 2 branches missed.">			} else if (PageKeys.GET_CAMPAIGN_ORGANIZATIONS.equals(typeData)) {</span>
<span class="nc" id="L662">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_ORGANIZATIONS;</span>
				// get all input parameters
<span class="nc" id="L664">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L665">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L666">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L667">				Collection organizationsForCampaign = getCampaignManager(context).getOrganizationsForCampaign(campaignID, startDate, endDate);</span>
<span class="nc" id="L668">				appletResponse.put(PageKeys.CAMPAIGN_ORG_LIST, organizationsForCampaign);</span>
<span class="pc bpc" id="L669" title="1 of 2 branches missed.">			} else if (PageKeys.GET_ORGFORIMPORT.equals(typeData)) {</span>
<span class="nc" id="L670">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_IMPORT_ORGANIZATIONS;</span>
				// get all input parameters
<span class="nc" id="L672">				ID orgID = (ID) appletRequest.get(PageKeys.ORG_ID);</span>
<span class="nc" id="L673">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L674">				boolean bImport = getFacadeCorbaFacadeManager().isConfiguredForImport(orgID, campaignID);</span>
<span class="nc" id="L675">				Boolean bb = Boolean.valueOf(bImport);</span>
<span class="nc" id="L676">				appletResponse.put(PageKeys.ORGFORIMPORT, bb);</span>
<span class="pc bpc" id="L677" title="1 of 2 branches missed.">			} else if (PageKeys.GET_SP_ORGS.equals(typeData)) {</span>
<span class="nc" id="L678">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GET_SP_OGS;</span>
<span class="nc" id="L679">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L680">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L681">				Collection orgs = getCampaignManager(context).getLinkedOrgsforSP(spID);</span>
<span class="nc" id="L682">				Collection importOrgs = new ArrayList();</span>
<span class="nc" id="L683">				Iterator orgIdIterator = orgs.iterator();</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">				while (orgIdIterator.hasNext()) {</span>
<span class="nc" id="L685">					ID orgID = (ID)orgIdIterator.next();</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">					if (getFacadeCorbaFacadeManager().isConfiguredForImport(orgID, campaignID)){</span>
<span class="nc" id="L687">						importOrgs.add(orgID);</span>
					}
<span class="nc" id="L689">				}</span>
<span class="nc" id="L690">				addResponseData(importOrgs, appletResponse);</span>
<span class="pc bpc" id="L691" title="1 of 2 branches missed.">			}  else if (PageKeys.GET_LEARNINGASSIGNMENTS.equals(typeData)) {</span>
<span class="nc" id="L692">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_LEARNING_ASSIGNMENTS;</span>
<span class="nc" id="L693">				Collection employeeIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L694">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L695">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L696">				Collection collectionLearnings = null;</span>
<span class="nc" id="L697">				collectionLearnings = this.getLearningAssignmentManager().getLearningAssignmentsForWorkResource(employeeIDs, startDate, endDate);</span>
<span class="nc" id="L698">				appletResponse.put(PageKeys.LEARNING_ASSIGNMENTS, collectionLearnings);</span>
<span class="pc bpc" id="L699" title="1 of 2 branches missed.">			} else if (PageKeys.GET_COACHINGASSIGNMENTS.equals(typeData)) {</span>
<span class="nc" id="L700">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_COACHING_ASSIGNMENTS;</span>
<span class="nc" id="L701">				Collection employeeIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L702">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L703">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L704">				Collection collectionCoachings = null;</span>
<span class="nc" id="L705">				collectionCoachings = this.getCoachingBridgeInterface().getCoachingAssignmentsForWorkResource(employeeIDs, startDate,</span>
					endDate);
<span class="nc" id="L707">				appletResponse.put(PageKeys.COACHING_ASSIGNMENTS, collectionCoachings);</span>
<span class="pc bfc" id="L708" title="All 2 branches covered.">			} else if (PageKeys.CALENDAR_APPLET_GET_POOLER_IDS.equals(typeData)) { </span>
<span class="fc" id="L709">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_POOLERS;</span>
<span class="fc" id="L710">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L711">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L712">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L713">				Collection ids= null;</span>
<span class="fc" id="L714">				ids = this.getCampaignManager(context).getSPPoolerAssignments(spID, startDate, endDate);</span>
<span class="fc" id="L715">				appletResponse.put(PageKeys.POOLER_IDS, ids);</span>
<span class="pc bpc" id="L716" title="1 of 2 branches missed.">			} else if (PageKeys.GET_FLOATINGIDS_FORLESSONS.equals(typeData)) {</span>
<span class="nc" id="L717">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_FLOATINGID_FORLESSONS;</span>
<span class="nc" id="L718">				Collection employeeIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L719">				Collection lessonIDs = (Collection) appletRequest.get(PageKeys.LESSON_IDS);</span>
<span class="nc" id="L720">				Map mapFloatingIDs = null;</span>
<span class="nc" id="L721">				mapFloatingIDs = this.getLearningAssignmentManager().getFloatingEventIDsForLesson(employeeIDs, lessonIDs);</span>
<span class="nc" id="L722">				appletResponse.put(PageKeys.FLOATINGIDS_FORLESSONS, mapFloatingIDs);</span>
<span class="pc bpc" id="L723" title="1 of 2 branches missed.">			} else if (PageKeys.GET_FLOATINGIDS_FORCOACHINGS.equals(typeData)) {</span>
<span class="nc" id="L724">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_FLOATINGID_FORCOACHINGS;</span>
<span class="nc" id="L725">				Collection employeeIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L726">				Collection lessonIDs = (Collection) appletRequest.get(PageKeys.LESSON_IDS);</span>
<span class="nc" id="L727">				Map mapFloatingIDs = null;</span>
<span class="nc" id="L728">				mapFloatingIDs = this.getCoachingBridgeInterface().getFloatingEventIDsForCoachingSession(employeeIDs, lessonIDs);</span>
<span class="nc" id="L729">				appletResponse.put(PageKeys.FLOATINGIDS_FORCOACHINGS, mapFloatingIDs);</span>
<span class="pc bpc" id="L730" title="1 of 2 branches missed.">			} else if (PageKeys.GET_CALEVENTS_FORTRAINING.equals(typeData)) {</span>
<span class="nc" id="L731">				Collection templateIDs = (Collection) appletRequest.get(PageKeys.LESSON_TEMPLATE_IDS);</span>
<span class="nc" id="L732">				Collection calEvents = null;</span>
<span class="nc" id="L733">				calEvents = this.getScheduleAccessManager(context).getCalendarEventAssignmentsForCalendarEventTemplate(templateIDs);</span>
<span class="nc" id="L734">				appletResponse.put(PageKeys.CALEVENTS_FORTRAINING, calEvents);</span>
<span class="pc bpc" id="L735" title="1 of 2 branches missed.">			}  else if (PageAction.ACTION_CHANGE_LEARNING_ASSIGNMENT.equals(typeData)) {</span>
<span class="nc" id="L736">				msgID = FsWebBundleKey.FS_CAL_UPDATE_LEARNINGASSIGNMENT;</span>
<span class="nc" id="L737">				LearningAssignmentInt learn = (LearningAssignmentInt)  appletRequest.get(PageKeys.LEARNING_ASSIGNMENT);</span>
<span class="nc" id="L738">				Collection templateIDs = (Collection) appletRequest.get(PageKeys.LEARNING_FLOATING_IDS);</span>
<span class="nc" id="L739">				this.getLearningAssignmentManager().saveLearningAssignment(learn, templateIDs);</span>

<span class="pc bpc" id="L741" title="1 of 2 branches missed.">			}  else if (PageAction.ACTION_CHANGE_COACHING_ASSIGNMENT.equals(typeData)) {</span>
<span class="nc" id="L742">				msgID = FsWebBundleKey.FS_CAL_UPDATE_COACHINGASSIGNMENT;</span>
<span class="nc" id="L743">				ID coachingID = (ID) appletRequest.get(FsKeys.COACHING_ID);</span>
<span class="nc" id="L744">				ID workResourceID = (ID) appletRequest.get(FsKeys.WORKRESOURCE_ID);</span>
<span class="nc" id="L745">				ID lessonID = (ID) appletRequest.get(FsKeys.LESSON_ID); </span>
<span class="nc" id="L746">				int	timeToScheduleThisWeek = (Integer) appletRequest.get(FsKeys.TIME_TO_SCHEDULE);</span>
<span class="nc" id="L747">				int maximumSessionLength = (Integer) appletRequest.get(FsKeys.MAX_SESSION_LENGTH);</span>

<span class="nc" id="L749">				Collection templateIDs = (Collection) appletRequest.get(PageKeys.LEARNING_FLOATING_IDS);</span>
<span class="nc" id="L750">				this.getCoachingBridgeInterface().saveCoachingAssignment(coachingID, workResourceID,</span>
					lessonID, timeToScheduleThisWeek, maximumSessionLength, templateIDs);
<span class="pc bpc" id="L752" title="1 of 2 branches missed.">			} else if (PageKeys.GET_CAMPAIGN_FILTER.equals(typeData)) {</span>
<span class="nc" id="L753">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_FILTER;</span>
				// get all input parameters
<span class="nc" id="L755">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L756">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L757">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L758">				Collection colCampaigns = new LinkedList();</span>
<span class="nc" id="L759">				colCampaigns.add(campaignID);</span>
<span class="nc" id="L760">				ArrayList params = new ArrayList();</span>
<span class="nc" id="L761">				params.add(colCampaigns);	//filter expects nested collections</span>
<span class="nc" id="L762">				Filter filter = new Filter(</span>
						Filter.CAMPAIGNID,
						Filter.OPERATOR_IN,
						params);
<span class="nc" id="L766">				filter.setUserID(context.getUser().getID());</span>
<span class="nc" id="L767">				filter.setStartTime(startDate);</span>
<span class="nc" id="L768">				filter.setEndTime(endDate);</span>
<span class="nc" id="L769">				filter.setTimePeriodType(Filter.TIMEPERIODTYPE_TIMEWINDOW);</span>
				// get the full list of employee IDs and names - this is for use by CalendarViewCache
<span class="nc" id="L771">				String empFilterName = getEmployeeFilterName(context);</span>
<span class="nc" id="L772">				Collection employeeIDs = getEmployeeIDsByFilter(context, context.getUser(), empFilterName, filter);</span>

<span class="nc" id="L774">				Boolean isShowPhantom = (Boolean)appletRequest.get(FsKeys.SHOW_PHANTOM);</span>
<span class="nc bnc" id="L775" title="All 4 branches missed.">				if (isShowPhantom != null &amp;&amp; isShowPhantom.booleanValue()) {</span>
<span class="nc" id="L776">					ID idSchedulingPeriod = (ID)appletRequest.get(FsKeys.SCHEDULING_PERIOD);</span>
<span class="nc" id="L777">					Collection phantoms = this.getScheduleAccessManager(context).getPhantoms(idSchedulingPeriod);</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">					if (phantoms != null) {</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">						for (Iterator i = phantoms.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L780">							employeeIDs.add(((Phantom)i.next()).getID());</span>
						}
					}
				}

<span class="nc" id="L785">				appletResponse.put(PageKeys.EMPLOYEE_FILTER_ALL_IDS, employeeIDs);				</span>
<span class="pc bpc" id="L786" title="1 of 2 branches missed.">			} else if (PageKeys.GET_ORG.equals(typeData)) {</span>
<span class="nc" id="L787">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_ORGANIZATION;</span>
<span class="nc" id="L788">				ID orgID = (ID) appletRequest.get(PageKeys.ORG_ID);</span>
<span class="nc" id="L789">				Organization organization = getWorkResourceManager(context).getOrganizationByID(orgID);</span>
<span class="nc" id="L790">				appletResponse.put(PageKeys.ORG, organization);</span>
<span class="pc bpc" id="L791" title="1 of 2 branches missed.">			} else if (PageKeys.GET_EMPLOYEE_ORGANIZATION.equals(typeData)) {</span>
<span class="nc" id="L792">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_EMPLOYEE_ORGANIZATION;</span>
<span class="nc" id="L793">				ID employeeID = (ID) appletRequest.get(PageKeys.EMPLOYEE_ID);</span>
<span class="nc" id="L794">				Date effectiveDate = (Date) appletRequest.get(PageKeys.EFFECTIVE_DATE);</span>
<span class="nc" id="L795">				List&lt;Pair&lt;ID, Date&gt;&gt; employeeIDDatePairs = Collections.singletonList(new Pair&lt;ID, Date&gt;(employeeID, effectiveDate));</span>
<span class="nc" id="L796">				ID orgID = (ID)getWorkResourceManager(context).getEmployeeOrganizations(employeeIDDatePairs).iterator().next();</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">				Organization organization = (orgID == null) ? null : getWorkResourceManager(context).getOrganizationByID(orgID);</span>
<span class="nc" id="L798">				appletResponse.put(PageKeys.ORG, organization);</span>
<span class="pc bpc" id="L799" title="1 of 2 branches missed.">			} else if (PageKeys.GET_ORG_FILTER.equals(typeData)) {</span>
<span class="nc" id="L800">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_ORGANIZATION_FILTER;</span>
<span class="nc" id="L801">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L802">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L803">				HashSet setOrgs = new HashSet(context.getUser().getAuthorizedScopes(PrivilegeKeys.FS_VIEWORGSCHEDULES));</span>

<span class="nc" id="L805">				ArrayList alParameters = new ArrayList();</span>
<span class="nc" id="L806">				Collection colOrgs = new LinkedList();</span>
<span class="nc" id="L807">				colOrgs.addAll(setOrgs);</span>
<span class="nc" id="L808">				alParameters.add(colOrgs);</span>
<span class="nc" id="L809">				Filter filter = new Filter(</span>
						Filter.ORGANIZATIONID,
						Filter.OPERATOR_IN,
						alParameters/*new ArrayList(setOrgs)*/);
<span class="nc" id="L813">				filter.setUserID(context.getUser().getID());</span>
<span class="nc" id="L814">				filter.setStartTime(startDate);</span>
<span class="nc" id="L815">				filter.setEndTime(endDate);</span>
<span class="nc" id="L816">				filter.setTimePeriodType(Filter.TIMEPERIODTYPE_TIMEWINDOW);</span>
<span class="nc" id="L817">				String str = Filter.filterToString(filter);</span>
<span class="nc" id="L818">				appletResponse.put(PageKeys.ORG_FILTER, str);</span>
				// get the full list of employee IDs and names - this is for use by CalendarViewCache
<span class="nc" id="L820">				String empFilterName = getEmployeeFilterName(context);</span>
<span class="nc" id="L821">				Collection employeeIDs = getEmployeeIDsByFilter(context, context.getUser(), empFilterName, filter);</span>
<span class="nc" id="L822">				appletResponse.put(PageKeys.EMPLOYEE_FILTER_ALL_IDS, employeeIDs);</span>

				//pass filter to people selection pane
<span class="nc" id="L825">				context.setAttribute(RequestContext.SESSION_SCOPE, PageKeys.PRE_FILTER_KEY, str);</span>
<span class="pc bfc" id="L826" title="All 2 branches covered.">			} else if (PageKeys.GET_EMP_ORGASSIGNMENTS_AND_PERSONDATA.equals(typeData)) {</span>
<span class="fc" id="L827">					Collection&lt;ID&gt; employeeIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L828">					Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L829">					Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
					
<span class="fc" id="L831">					Collection&lt;PersonData&gt; workResources = getWorkResourceManager(context).getPersonDataByIDs(employeeIDs, startDate);</span>
<span class="fc" id="L832">					appletResponse.put(PageKeys.EMPLOYEES, workResources);</span>

<span class="fc" id="L834">			        EmpWorkRuleManager empWorkRuleManager = getEmpWorkRuleManager(context);</span>
<span class="fc" id="L835">					Map&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; hmTimeBank = empWorkRuleManager.getTimeBankAssignments(employeeIDs, startDate, endDate);</span>
<span class="fc" id="L836">					appletResponse.put(PageKeys.TIMEBANKS, hmTimeBank);</span>
	
<span class="fc" id="L838">					Map empOrgAssignments = getEmpOrgAssignments(context, employeeIDs, startDate, endDate);</span>
<span class="fc" id="L839">					appletResponse.put(PageKeys.EMPLOYEE_ORGANIZATION_ASSIGNMENTS, empOrgAssignments);</span>
					
<span class="pc bpc" id="L841" title="1 of 2 branches missed.">			} else if (PageKeys.GET_TIMEBANKS.equals(typeData)) {</span>
<span class="nc" id="L842">					Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L843">					Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L844">			        WorkRuleManager workRuleManager =  getWorkRuleManager(context);</span>
					//Returns an ArrayList of TimeBank
<span class="nc" id="L846">					appletResponse.put(PageKeys.TIMEBANKS, workRuleManager.getAllTimeBanks());</span>
				
<span class="pc bfc" id="L848" title="All 2 branches covered.">			} else if (PageKeys.GET_EMPLOYEE_SKILLS.equals(typeData)) {</span>
<span class="fc" id="L849">					ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L850">					Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L851">					Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L852">					ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="pc bpc" id="L853" title="1 of 2 branches missed.">					Campaign campaign = campaignID==null?null : getCampaignManager(context).getCampaignByID(campaignID);</span>
<span class="fc" id="L854">					List workResourceIDs = getSpEmployeeIDs(context, spID, campaign, startDate, endDate);</span>
<span class="fc" id="L855">					SkillManager skillManager = getSkillManager(context);</span>
			        
					//Returns a HashMap&lt;ID, ArrayList&lt;SkillAssignment&gt;&gt;
<span class="fc" id="L858">					Map empIDSkills = skillManager.getSkillsForWorkResources(workResourceIDs, adjustStartDateToAddAMinute(startDate), endDate);</span>
<span class="fc" id="L859">                    Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; hmSkillAssignments = skillManager.getSkillAssignments(workResourceIDs, </span>
<span class="fc" id="L860">						adjustStartDateToAddAMinute(startDate), endDate);</span>
					
					//just in case there is phantom in sp
<span class="fc" id="L863">					workResourceIDs.removeAll(empIDSkills.keySet());</span>
					
<span class="pc bpc" id="L865" title="1 of 2 branches missed.">					if (!workResourceIDs.isEmpty()) {</span>
<span class="fc" id="L866">						Map empTempSkill = new HashMap();</span>
<span class="fc" id="L867">                        Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; hmTempSkillAssignments = new HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt;();</span>

<span class="fc" id="L869">                        ScheduleAccessManager saManager = getScheduleAccessManager(context);</span>
<span class="fc" id="L870">						Collection phantoms = saManager.getPhantomsByIDs(workResourceIDs);</span>
<span class="fc" id="L871">						Phantom phantom = null;</span>
<span class="fc" id="L872">						ID empTemplateID = null;</span>
<span class="pc bpc" id="L873" title="1 of 2 branches missed.">						for (Iterator i = phantoms.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L874">							phantom = (Phantom)i.next();</span>
<span class="nc" id="L875">							empTemplateID = phantom.getEmployeeTemplateID();</span>
<span class="nc" id="L876">							Collection skills = null;</span>
							
<span class="nc bnc" id="L878" title="All 2 branches missed.">							if (empTempSkill.keySet().contains(empTemplateID)) {</span>
<span class="nc" id="L879">								empIDSkills.put(phantom.getID(), empTempSkill.get(empTemplateID));</span>
<span class="nc" id="L880">                                hmSkillAssignments.put(phantom.getID(),hmTempSkillAssignments.get(empTemplateID));</span>
<span class="nc" id="L881">								continue;</span>
							}
							
<span class="nc" id="L884">							Collection assignments = skillManager.getSkillAssignmentsForTemplate(empTemplateID, startDate, endDate);</span>

<span class="nc" id="L886">							List skillIDs = new ArrayList();</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">							if (assignments != null) {</span>
<span class="nc" id="L888">								ID skillID = null;</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">								for (Iterator iSkill = assignments.iterator(); iSkill.hasNext(); ) {</span>
<span class="nc" id="L890">									skillID = ((SkillAssignment)iSkill.next()).getSkillID();</span>
<span class="nc" id="L891">									skillIDs.add(skillID);</span>
								}
							}
<span class="nc bnc" id="L894" title="All 2 branches missed.">							if (!skillIDs.isEmpty())</span>
<span class="nc" id="L895">								skills = skillManager.getSkillsByIDs(skillIDs);</span>

							//cache locally to avoid load for another phantom again
<span class="nc" id="L898">							empTempSkill.put(empTemplateID, skills);</span>
							//cache locally to avoid load for another phantom again
<span class="nc" id="L900">							hmTempSkillAssignments.put(empTemplateID, assignments); </span>
<span class="nc" id="L901">							empIDSkills.put(phantom.getID(), skills);</span>
<span class="nc" id="L902">                            hmSkillAssignments.put(phantom.getID(), assignments);</span>
<span class="nc" id="L903">                        }</span>
					}
					
<span class="fc" id="L906">					appletResponse.put(PageKeys.EMPLOYEE_SKILLS, empIDSkills);</span>
<span class="fc" id="L907">					appletResponse.put(PageKeys.EMPLOYEE_SKILL_ASSIGNMENTS, hmSkillAssignments);</span>
				
<span class="fc bfc" id="L909" title="All 2 branches covered.">			} else if (PageKeys.GET_SP_SCHEDULINGPARAMETERS.equals(typeData)) {</span>
<span class="fc" id="L910">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SP_SCHEDULING_PARAMS;</span>
<span class="fc" id="L911">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L912">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L913">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L914">				Map parameters = getSPSchedulingParameters(context, startDate, spID, campaignID);</span>
<span class="fc" id="L915">				appletResponse.put(PageKeys.SP_SCHEDULINGPARAMS, parameters);</span>
<span class="pc bpc" id="L916" title="1 of 2 branches missed.">			} else if (PageKeys.GET_SORTED_EMPLOYEEIDS.equals(typeData)) {</span>
<span class="nc" id="L917">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SORTED_EMPLOYEES;</span>
<span class="nc" id="L918">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L919">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L920">				Collection empIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L921">				appletResponse.put(PageKeys.SORTED_EMPLOYEE_IDS, empIDs);</span>
<span class="pc bpc" id="L922" title="1 of 2 branches missed.">			} else if (PageKeys.GET_CAMPAIGN_QUEUES.equals(typeData)) {</span>
<span class="nc" id="L923">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_QUEUES;</span>
<span class="nc" id="L924">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L925">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L926">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L927">				Collection campaignQueueAssignments = getCampaignManager(context)</span>
<span class="nc" id="L928">					.getCampaignQueueAssignments(campaignID, startDate, endDate);</span>
<span class="nc" id="L929">				List listQueueIDs = new ArrayList(campaignQueueAssignments.size());</span>
<span class="nc" id="L930">				Iterator itCampQueueAsmts = campaignQueueAssignments.iterator();</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">				while (itCampQueueAsmts.hasNext()) {</span>
<span class="nc" id="L932">					CampaignQueue nextCampQ = (CampaignQueue) itCampQueueAsmts.next();</span>
<span class="nc" id="L933">					ID nextQID = nextCampQ.getQueueID();</span>
<span class="nc" id="L934">					listQueueIDs.add(nextQID);</span>
<span class="nc" id="L935">				}</span>
<span class="nc" id="L936">				appletResponse.put(PageKeys.CAMPAIGN_QUEUEID_COLLECTION, listQueueIDs);</span>
<span class="nc" id="L937">				Collection queuesByIDs = getWorkloadManager(context).getQueuesByIDs(listQueueIDs);</span>
<span class="nc" id="L938">				appletResponse.put(PageKeys.CAMPAIGN_QUEUE_COLLECTION, queuesByIDs);</span>
<span class="pc bpc" id="L939" title="1 of 2 branches missed.">			} else if (PageKeys.GET_RECALC_DIRTYSTATUS.equals(typeData)) {</span>
<span class="nc" id="L940">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_RECALC_DIRTY_STATUS;</span>
<span class="nc" id="L941">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L942">				Pair dirtyStatus = getCampaignManager(context).getDirtyStatus(spID);</span>
<span class="nc" id="L943">				Date lastModifiedTime = (Date) dirtyStatus.getFirst();</span>
<span class="nc" id="L944">				Date lastRecalcTime = (Date) dirtyStatus.getSecond();</span>
<span class="nc" id="L945">				appletResponse.put(PageKeys.LAST_MODIFIED_TIME, lastModifiedTime);</span>
<span class="nc" id="L946">				appletResponse.put(PageKeys.LAST_RECALC_TIME, lastRecalcTime);</span>
<span class="pc bfc" id="L947" title="All 2 branches covered.">			} else if (PageKeys.GET_SERVICELEVEL_RIBBONS.equals(typeData)) {</span>
<span class="fc" id="L948">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_STATISTIC_RIBBONS;</span>
<span class="fc" id="L949">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L950">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L951">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
				
<span class="fc" id="L953">				getServiceLevelRibbons(context, appletResponse, spID, startDate, endDate);</span>
<span class="pc bpc" id="L954" title="1 of 2 branches missed.">			} else if (PageKeys.GET_FTE_CALCULATION_DATA.equals(typeData)) {</span>
<span class="nc" id="L955">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_FTECALC_DATA;</span>
<span class="nc" id="L956">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L957">				Boolean hasProjectQueue = (Boolean) appletRequest.get(PageKeys.HAS_PROJECT_QUEUE);</span>
<span class="nc" id="L958">				List&lt;ID&gt; workResIds = (List&lt;ID&gt;)appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L959">				Double defaultWage = (Double) appletRequest.get(PageKeys.DEFAULT_WAGE);</span>
<span class="nc" id="L960">				FTECalculator fteCalculator = getCampaignManager(context).getFTECalculator(spID, </span>
<span class="nc" id="L961">					hasProjectQueue.booleanValue(), workResIds, defaultWage.doubleValue());</span>
<span class="nc" id="L962">				SP sp = getCampaignManager(context).getRealSP(spID);</span>
<span class="nc" id="L963">				appletResponse.put(PageKeys.FTE_CALCULATION, new Pair(fteCalculator, sp));</span>
<span class="pc bpc" id="L964" title="1 of 2 branches missed.">			} else if (PageKeys.GET_WORKPATTERN.equals(typeData)) {</span>
<span class="nc" id="L965">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_WORKPATTERN_SETS;</span>
<span class="nc" id="L966">				Collection ids = (Collection) appletRequest.get(PageKeys.WORKPATTERN_IDS);</span>
<span class="nc" id="L967">				Collection wpSets = this.getWorkRuleManager(context).getShiftPatternsByIDs(ids);</span>
<span class="nc" id="L968">				appletResponse.put(PageKeys.COLLECTION_WORKPATTERNS, wpSets);</span>
<span class="pc bpc" id="L969" title="1 of 2 branches missed.">			} else if (PageKeys.GET_EVENTTEMPLATE.equals(typeData)) {</span>
				//get all template defined for view employee in view period
<span class="nc" id="L971">				Collection employeeIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L972">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L973">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L974">				Collection templates = getScheduleAccessManager(context)</span>
<span class="nc" id="L975">					.getEventTemplatesForWorkResourceIDs(employeeIDs, startDate, endDate);</span>
<span class="nc" id="L976">				appletResponse.put(PageKeys.EVENT_TEMPLATE, templates);</span>
<span class="pc bpc" id="L977" title="1 of 2 branches missed.">			} else if (PageKeys.GET_EVENTTEMPLATES.equals(typeData)) {</span>
<span class="nc" id="L978">				Collection eventTemplateIDs = (Collection) appletRequest.get(PageKeys.EVENTTEMPLATE_ID);</span>
<span class="nc" id="L979">				Collection calendarEventTemplates = getScheduleAccessManager(context).getCalendarEventTemplatesByIDs(eventTemplateIDs);</span>
<span class="nc" id="L980">				appletResponse.put(PageKeys.EVENT_TEMPLATE, calendarEventTemplates);</span>
<span class="pc bfc" id="L981" title="All 2 branches covered.">			} else if (PageKeys.GET_BASEFORCAST_NOTSET_SPQUEUEIDS.equals(typeData)) {</span>
<span class="fc" id="L982">				ID spSID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L983">				Collection&lt;SPQueue&gt; spQueues = getCampaignManager(context).getSPQueuesBySPID(spSID);</span>
<span class="fc" id="L984">				SchedulingPeriod sp = getCampaignManager(context).getSchedulingPeriodByID(spSID);</span>
<span class="fc" id="L985">				Collection notSetQueueSIDs = new ArrayList();</span>
<span class="pc bpc" id="L986" title="2 of 4 branches missed.">				if (spQueues != null &amp;&amp; !spQueues.isEmpty()) {</span>
<span class="fc" id="L987">					Collection&lt;ID&gt; spQueueIDs = getSPQueueIDsCouldHaveBaseForecast(sp, spQueues); </span>
<span class="fc" id="L988">					Map map = getForecastManager(context).isBaseForecastSet(spQueueIDs);</span>
<span class="fc" id="L989">					Map.Entry entry = null;</span>
<span class="fc bfc" id="L990" title="All 2 branches covered.">					for (Iterator i = map.entrySet().iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L991">						entry = (Map.Entry)i.next();</span>
<span class="fc bfc" id="L992" title="All 2 branches covered.">						if (!((Boolean)entry.getValue()).booleanValue())</span>
<span class="fc" id="L993">							notSetQueueSIDs.add(entry.getKey());</span>
					}
				}
<span class="fc" id="L996">				appletResponse.put(PageKeys.BASEFORCAST_NOTSET_SPQUEUEIDS, notSetQueueSIDs);				</span>
<span class="pc bpc" id="L997" title="1 of 2 branches missed.">			} else if (PageKeys.FS_SHIFT_DURATION_PICKER_CACHE_SHIFT_DURATION.equals(typeData)) {</span>
<span class="nc" id="L998">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;</span>

<span class="nc" id="L1000">				String cmd = (String)appletRequest.get(PageKeys.FS_SHIFT_DURATION_PICKER_CACHE_SHIFT_DURATION);</span>

<span class="nc" id="L1002">				String shiftDurationCache = processShiftDurationCommand(context, cmd);</span>
				// return the new cache to the caller
<span class="nc" id="L1004">				appletResponse.put(</span>
						PageKeys.FS_SHIFT_DURATION_PICKER_CACHE_SHIFT_DURATION,
						shiftDurationCache);

<span class="pc bpc" id="L1008" title="1 of 2 branches missed.">			} else if (PageKeys.FS_SHIFT_DURATION_PICKER_GET_SHIFT_DURATION.equals(typeData)) {</span>
<span class="nc" id="L1009">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;</span>

<span class="nc" id="L1011">				addShiftDurationCache(context, appletResponse);</span>
<span class="pc bpc" id="L1012" title="1 of 2 branches missed.">			} else if (PageKeys.FS_SHIFT_DURATION_PICKER_GET_SHIFTS.equals(typeData)) {</span>
<span class="nc" id="L1013">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;</span>

<span class="nc" id="L1015">				ID orgId = (ID)appletRequest.get(</span>
						PageKeys.FS_SHIFT_DURATION_PICKER_SELECTED_ORG_ID);
<span class="nc" id="L1017">				ID payPolicyId = (ID)appletRequest.get(</span>
						PageKeys.FS_SHIFT_DURATION_PICKER_SELECTED_PAY_POLICY_ID);

<span class="pc bpc" id="L1020" title="1 of 2 branches missed.">			} else if (PageKeys.FS_SHIFT_DURATION_PICKER_GET_ORGS.equals(typeData)) {</span>
<span class="nc" id="L1021">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_PICKER_DATA;</span>

<span class="nc" id="L1023">				Collection orgs =  getWorkResourceManager(context).getOrganizations(null);</span>
<span class="nc bnc" id="L1024" title="All 4 branches missed.">				if (orgs == null || orgs.size() == 0) {</span>
					// This is not expected
<span class="nc" id="L1026">					appletResponse.put(PageKeys.APPLET_ERROR, &quot;There are no organizations!?&quot;);</span>
				} else {
<span class="nc" id="L1028">					Organization root = Organization.buildOrganizationTree(orgs);</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">					if (root != null) {</span>
<span class="nc" id="L1030">						appletResponse.put(</span>
								PageKeys.FS_SHIFT_DURATION_PICKER_ROOT_ORG,
								root);
<span class="nc" id="L1033">						HashMap payPolicies =</span>
<span class="nc" id="L1034">							getPayPolicyManager().getManagedPayPolicyInOrg(root.getID());</span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">						if (payPolicies != null) {</span>
<span class="nc" id="L1036">							appletResponse.put(</span>
									PageKeys.FS_SHIFT_DURATION_PICKER_PAY_POLICIES,
									payPolicies);
						}

<span class="nc" id="L1041">						ID orgId = null;</span>
<span class="nc" id="L1042">						ID payPolicyId = null;</span>
<span class="nc" id="L1043">						String orgIdStr =</span>
<span class="nc" id="L1044">							context.getUserProperty(&quot;SHIFT_DURATION_SELECTED_ORG_ID&quot;);</span>
<span class="nc" id="L1045">						String payPolicyIdStr =</span>
<span class="nc" id="L1046">							context.getUserProperty(&quot;SHIFT_DURATION_SELECTED_PAY_POLICY_ID&quot;);</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">						if (!StringUtil.isEmpty(orgIdStr))	{</span>
							// invalid orgId will be handled on the the client side.
<span class="nc" id="L1049">							orgId = new ID(orgIdStr);</span>
						}
<span class="nc bnc" id="L1051" title="All 2 branches missed.">						if (!StringUtil.isEmpty(payPolicyIdStr))  {</span>
<span class="nc" id="L1052">							payPolicyId = new ID(payPolicyIdStr);</span>
							// check for invalid pay policy id
<span class="nc bnc" id="L1054" title="All 2 branches missed.">							if (payPolicies == null ||</span>
<span class="nc bnc" id="L1055" title="All 2 branches missed.">									!payPolicies.containsKey(payPolicyId)) {</span>
<span class="nc" id="L1056">								payPolicyId = null;</span>
<span class="nc" id="L1057">								payPolicyIdStr = &quot;&quot;;</span>
<span class="nc" id="L1058">								context.setUserProperty(&quot;SHIFT_DURATION_SELECTED_PAY_POLICY_ID&quot;, &quot;&quot;);</span>
							}
						}

<span class="nc" id="L1062">						appletResponse.put(</span>
								PageKeys.FS_SHIFT_DURATION_PICKER_SELECTED_PAY_POLICY_ID,
								payPolicyIdStr);

<span class="nc" id="L1066">						appletResponse.put(</span>
								PageKeys.FS_SHIFT_DURATION_PICKER_SELECTED_ORG_ID,
								orgIdStr);

						// this may not be necessary since a call to get
						// the shift cache will most likely have to made
						// prior to a call for this request data
<span class="nc" id="L1073">						appletResponse.put(</span>
								PageKeys.FS_SHIFT_DURATION_PICKER_CACHE_SHIFT_DURATION,
<span class="nc" id="L1075">								context.getUserProperty(&quot;SHIFT_DURATION_CACHE&quot;));</span>

					}
				}
<span class="pc bpc" id="L1079" title="1 of 2 branches missed.">			} else if (PageKeys.GET_CHILDREN_ORG_IDS.equals(typeData)) {</span>
<span class="nc" id="L1080">				msgID = FsWebBundleKey.FS_CAL_MSG_GETTING_ORGANIZATION;</span>
<span class="nc" id="L1081">				Collection orgIDs = (Collection) appletRequest.get(PageKeys.ORG_IDS);</span>
<span class="nc" id="L1082">				Collection parentsOrgIDs = null;</span>
<span class="nc" id="L1083">				parentsOrgIDs = this.getWorkResourceManager(context).getOrganizationsChildrenByIDs(orgIDs);</span>
<span class="nc" id="L1084">				addResponseData(parentsOrgIDs, appletResponse);</span>
<span class="pc bfc" id="L1085" title="All 2 branches covered.">			} else if(PageKeys.GET_FILTER_ID_FROM_NAME.equals(typeData)) {</span>
				// get the full list of employee IDs and names - this is for use by CalendarViewCache
<span class="fc" id="L1087">				String empFilterName = getEmployeeFilterName(context);</span>
<span class="fc" id="L1088">				ID empFilterID = null;</span>
<span class="pc bpc" id="L1089" title="4 of 6 branches missed.">				if (empFilterName != null &amp;&amp; (empFilterName.equals(&quot;DEFAULT_ALL&quot;) || empFilterName.equals(&quot;DEFAULT_NONE&quot;))) {</span>
<span class="fc" id="L1090">					empFilterID = new ID(-1);</span>
				} else {
<span class="nc" id="L1092">					Filter filter = getEmployeeFilterManager(context).getFilterByName(context.getUser().getID(), empFilterName);</span>
<span class="nc" id="L1093">					empFilterID = filter.getFilterID();</span>
				}
<span class="fc" id="L1095">				appletResponse.put(PageKeys.EMP_FILTER_ID, empFilterID);</span>
<span class="fc bfc" id="L1096" title="All 2 branches covered.">	        } else if (PageKeys.GET_IS_TIMEZONE_OVERRIDDEN.equals(typeData)) {</span>
<span class="fc" id="L1097">	        	msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_TIME_ZONE_OVERRIDE;</span>
<span class="fc" id="L1098">	        	isTimeZoneOverridden(context, appletResponse);</span>
<span class="pc bpc" id="L1099" title="1 of 2 branches missed.">	        } else if (PageAction.ACTION_TOGGLE_TIMEZONE_OVERRIDE.equals(typeData)) {</span>
<span class="nc" id="L1100">	        	msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_SETTING_TIME_ZONE_OVERRIDE;</span>
<span class="nc" id="L1101">	        	toggleTimeZoneOverride(context);</span>
<span class="fc bfc" id="L1102" title="All 2 branches covered.">			} else if (FsKeys.GET_CHILD_AND_SELF_ORGANIZATION_IDS.equals(typeData)) {</span>
<span class="fc" id="L1103">				Collection&lt;ID&gt; orgIds = (Collection&lt;ID&gt;)appletRequest.get(</span>
						FsKeys.ORGANIZATION_ID_COLLECTION_PARAM);
<span class="fc" id="L1105">				Collection&lt;ID&gt; childAndSelfOrgIDs = getChildAndSelfOrganizationIDs(context, orgIds);</span>
<span class="fc" id="L1106">				appletResponse.put(FsKeys.CHILD_AND_SELF_ORGANIZATION_IDS_RETVAL, childAndSelfOrgIDs);</span>
<span class="pc bpc" id="L1107" title="1 of 2 branches missed.">			} else if(PageKeys.GET_EMPLOYEES_SUB_CAMPAIGNS.equals(typeData)){</span>
<span class="nc" id="L1108">				ID parentCampaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L1109">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L1110">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L1111">				Collection&lt;ID&gt; empIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>

<span class="nc" id="L1113">				Map&lt;ID, ID&gt; empSubCampaignID = new HashMap&lt;ID, ID&gt;(empIDs.size());</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">				if (parentCampaignID != null) {</span>
<span class="nc" id="L1115">					Collection&lt;ID&gt; subCampaignIDs = getCampaignManager(context).getSubCampaignIDs(parentCampaignID);</span>
<span class="nc" id="L1116">					Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; empCampaignWR = getCampaignManager(context)</span>
<span class="nc" id="L1117">						.getWorkResourceCampaignAssignments(empIDs, startDate, endDate);</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">					for(ID workResourceID: empCampaignWR.keySet()){</span>
<span class="nc" id="L1119">						List&lt;CampaignWorkResource&gt; campaignWR = empCampaignWR.get(workResourceID);</span>
						outerloop:
<span class="nc bnc" id="L1121" title="All 2 branches missed.">							for(ID subCampaignID : subCampaignIDs){</span>
<span class="nc bnc" id="L1122" title="All 2 branches missed.">								for(CampaignWorkResource cwr: campaignWR){</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">									if( cwr.getCampaignID().equals(subCampaignID) ){</span>
<span class="nc" id="L1124">										empSubCampaignID.put(workResourceID,subCampaignID);</span>
<span class="nc" id="L1125">										break outerloop; </span>
									}
<span class="nc" id="L1127">								}</span>
<span class="nc" id="L1128">							}</span>
<span class="nc" id="L1129">					}</span>
				}
<span class="nc" id="L1131">				appletResponse.put(PageKeys.CAMPAIGNS, empSubCampaignID);</span>
			}
<span class="nc" id="L1133">		} catch (RuntimeException e) {</span>
<span class="nc" id="L1134">			handleUnexpectedError(context, appletResponse, locale, e, msgID, null, null);</span>
<span class="nc" id="L1135">		} catch (Exception e) {</span>
<span class="nc" id="L1136">			handleExpectedError(context, appletResponse, locale, e, msgID, null, null);</span>
<span class="pc" id="L1137">		}</span>
<span class="fc" id="L1138">	}</span>

	protected Collection&lt;ID&gt; getSPQueueIDsCouldHaveBaseForecast(SchedulingPeriod sp, Collection&lt;SPQueue&gt; spQueues) {
<span class="fc" id="L1141">		ArrayList spQueueIDs = new ArrayList(spQueues.size());</span>
<span class="fc bfc" id="L1142" title="All 2 branches covered.">		for (SPQueue spQ : spQueues) {</span>
			// we do not need base forecasts to be set on the project queues or
			// the combined queues of the skilled SPs.
<span class="pc bpc" id="L1145" title="1 of 2 branches missed.">			if (spQ.getMediaID() == Media.MEDIA_ID_PROJECT</span>
<span class="pc bpc" id="L1146" title="3 of 6 branches missed.">					|| (sp.getSkillBased() &amp;&amp; (spQ.getQueueID() == null || spQ.getMediaID() == null))) {</span>
<span class="nc" id="L1147">				continue;</span>
			}
<span class="fc" id="L1149">			spQueueIDs.add(spQ.getID());</span>
<span class="fc" id="L1150">		}</span>
<span class="fc" id="L1151">		return spQueueIDs;</span>
	}

	private List&lt;ShiftSwapCalendarInfo&gt; getShiftSwapCalendarInfos(Date start, Date end, List&lt;ID&gt; empIDs) throws Exception {
<span class="pc bpc" id="L1155" title="1 of 2 branches missed.">		if (m_shiftSwapManager == null) {</span>
<span class="fc" id="L1156">			m_shiftSwapManager = new ShiftSwapCalendarInfoManager();</span>
		}
<span class="fc" id="L1158">		return m_shiftSwapManager.getListApprovedShiftSwapCalendarInfo(start, end, empIDs);</span>
	}

	/**
	 * Get all the undeleted activities mapped to their Media.
	 * Get all Queues associated with the SP's Media.
	 * Get all the &quot;Queue Hopping&quot; activities that are directly mapped to the queue  
	 * Get all the &quot;Non Queue Hoping&quot; activities indirectly associated to the queue through the Activity's media
	 * Get the skillID for each queue.
	 * Get all queue Organization ID's mapped to their organization's color tolerance settings (from Organization Settings)
	 * @throws BbmCreateException 
	 */
	private String getQueueActivitiesMaps(RequestContext context, Map appletRequest, Map appletResponse, Locale locale)
			throws BbmFinderException, RemoteException, BbmEJBCreateException, BbmCreateException {
		String msgID;
<span class="fc" id="L1173">		msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_QUEUEACTIVITY_DATA;</span>
<span class="fc" id="L1174">		ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>

<span class="fc" id="L1176">		ActivityManager activityManager = getActivityManager(context);</span>
		
		//TODO AJP: Is this the proper scope for the activities?  I believe this is all undeleted activities
<span class="fc" id="L1179">		Collection&lt;Activity&gt; allActivities = activityManager.findActivities(new ActivityFilter(ActivityFilter.FILTER_DELETED));</span>
<span class="fc" id="L1180">		Map&lt;ID, Activity&gt; idToActivityMap = new HashMap&lt;ID, Activity&gt;(allActivities.size());</span>
<span class="fc" id="L1181">		Collection&lt;ID&gt; allActivityIDs = new ArrayList&lt;ID&gt;(allActivities.size());</span>
<span class="fc bfc" id="L1182" title="All 2 branches covered.">		for (Activity activity : allActivities) {</span>
<span class="fc" id="L1183">			idToActivityMap.put(activity.getID(), activity);</span>
<span class="fc" id="L1184">			allActivityIDs.add(activity.getID());</span>
<span class="fc" id="L1185">		}</span>
<span class="fc" id="L1186">		Map&lt;ID, Collection&lt;ID&gt;&gt; activityToMediaMap = activityManager.findMediaForActivities(allActivityIDs);</span>

<span class="fc" id="L1188">		appletResponse.put(FsKeys.ACTIVITYTOMEDIA, activityToMediaMap);</span>
		
<span class="fc" id="L1190">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L1191">		Map&lt;ID, Media&gt; queueToMediaMap = new HashMap&lt;ID, Media&gt;();</span>
<span class="fc" id="L1192">		Map&lt;ID, ID&gt; queueToSkillMap = null;</span>
<span class="fc" id="L1193">		Map&lt;ID, ArrayList&lt;ID&gt;&gt; mediaIdToQueueIDMap = new HashMap&lt;ID, ArrayList&lt;ID&gt;&gt;();</span>
<span class="fc" id="L1194">		Map&lt;ID, ArrayList&lt;Integer&gt;&gt; orgIDToToleranceMap = new HashMap&lt;ID, ArrayList&lt;Integer&gt;&gt;();</span>
<span class="fc" id="L1195">		WorkloadManager wm = getWorkloadManager(context);</span>
		
<span class="fc" id="L1197">		Map&lt;ID, Media&gt; idToMediaMap = ValueObjectUtil.getFieldObjectMap(MediaFieldInfo.MEDIA_ID, </span>
<span class="fc" id="L1198">													wm.getAllMedia());</span>
		
<span class="fc" id="L1200">		Collection&lt;Queue&gt; qCollection = wm.getNonCombinedQueuesByMediaAndSP(null, spID);</span>
		//CRITICAL AJP: We need to Explicitly create IDs from the queue collection. 
		//	I am encountering an odd Java issue when iterating through the keySet of a HashMap, which will be done in Jdmo.createInClause(...) 
<span class="fc bfc" id="L1203" title="All 2 branches covered.">		for (Queue q : qCollection) {</span>
<span class="fc" id="L1204">			queueIds.add(q.getID());</span>
<span class="fc" id="L1205">			queueToMediaMap.put( q.getID(), idToMediaMap.get(q.getMediaID()) );</span>
<span class="fc" id="L1206">			ArrayList&lt;ID&gt; queuesForMedia = mediaIdToQueueIDMap.get(q.getMediaID());</span>
<span class="pc bpc" id="L1207" title="1 of 2 branches missed.">			if (queuesForMedia == null)</span>
<span class="fc" id="L1208">				queuesForMedia = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L1209">			queuesForMedia.add(q.getID());</span>
<span class="fc" id="L1210">			mediaIdToQueueIDMap.put( q.getMediaID(), queuesForMedia);</span>
<span class="pc bpc" id="L1211" title="1 of 2 branches missed.">			if (!orgIDToToleranceMap.containsKey(q.getOrganizationID())) {</span>
<span class="fc" id="L1212">				orgIDToToleranceMap.put(q.getOrganizationID(), getQueueToleranceArrayForOrg(context, q.getOrganizationID()));</span>
			}
<span class="fc" id="L1214">		}</span>
<span class="fc" id="L1215">		appletResponse.put(FsKeys.MEDIA, queueToMediaMap);</span>
<span class="fc" id="L1216">		appletResponse.put(FsKeys.ORG_ID_TO_QUEUE_TOLERANCES, orgIDToToleranceMap);</span>
		
		//get a hashmap that links each individual queue in the SP to its skill. If a queue has no skill, it won't be in the map.
<span class="fc" id="L1219">		queueToSkillMap =  getCampaignManager(context).getQueueIDToSkillMap(spID);</span>
<span class="pc bpc" id="L1220" title="1 of 2 branches missed.">		if (queueToSkillMap==null) {</span>
<span class="nc" id="L1221">			queueToSkillMap = new HashMap&lt;ID, ID&gt;();</span>
		}
<span class="fc" id="L1223">		appletResponse.put(FsKeys.SKILL, queueToSkillMap);</span>
						
		//Get a HashMap (queue SID -&gt; ServiceGoalsType) for each queue in the SP
<span class="fc" id="L1226">		Collection&lt;SPQueue&gt; spQueues = getCampaignManager(context).getSPQueuesBySPID(spID);</span>
<span class="fc" id="L1227">		appletResponse.put(PageKeys.QUEUE_GOAL_MAP, getQueueGoalsMap(spQueues));</span>
		
		// findAllActivitiesForQueues just returns queue hopping links.  It is a Map of Queue ID (key) and collection of Activity Ids (value)
		// We then add all activities that are indirectly mapped to the Queues through the media in &quot;Non-Queue Hopping&quot; scenarios.
<span class="fc" id="L1231">		Map&lt;ID, ArrayList&lt;ID&gt;&gt; queueToActivityMap = activityManager.findActivitiesDirectlyMappedToQueuesInDB(queueIds);</span>
<span class="fc bfc" id="L1232" title="All 2 branches covered.">		for (Map.Entry&lt;ID, Collection&lt;ID&gt;&gt; entry : activityToMediaMap.entrySet()) {</span>
<span class="fc" id="L1233">			Activity activity = idToActivityMap.get(entry.getKey());</span>
<span class="pc bpc" id="L1234" title="1 of 2 branches missed.">			if ( ! activity.isQueueHopping() ) {</span>
				//Get all queues with Media from entry.getValue()
				//Add this activity to that queueToActivityMap
<span class="fc bfc" id="L1237" title="All 2 branches covered.">				for (ID mediaId : entry.getValue()) {</span>
<span class="fc" id="L1238">					ArrayList&lt;ID&gt; queuesForMedia = mediaIdToQueueIDMap.get(mediaId);</span>
<span class="fc bfc" id="L1239" title="All 2 branches covered.">					if ( queuesForMedia != null ) {</span>
<span class="fc bfc" id="L1240" title="All 2 branches covered.">						for ( ID queueId : queuesForMedia) {</span>
<span class="fc" id="L1241">							ArrayList&lt;ID&gt; activityIds = queueToActivityMap.get(queueId);</span>
<span class="fc bfc" id="L1242" title="All 2 branches covered.">							if (activityIds == null) {</span>
<span class="fc" id="L1243">								activityIds = new ArrayList&lt;ID&gt;();</span>
							}
<span class="fc" id="L1245">							activityIds.add(entry.getKey());</span>
<span class="fc" id="L1246">							queueToActivityMap.put(queueId, activityIds);</span>
<span class="fc" id="L1247">						}</span>
					}
<span class="fc" id="L1249">				}	</span>
			}
<span class="fc" id="L1251">		}</span>
<span class="fc" id="L1252">		appletResponse.put(PageKeys.APPLET_DATA, queueToActivityMap);</span>

		//get all activities with queues from the ActivityQueue table. These are needed when optimizing break placements in new shift assignments.
<span class="fc" id="L1255">		Map&lt;ID, Collection&lt;ID&gt;&gt; hmActivityQueues = activityManager.findQueueForActivities(allActivityIDs);</span>
<span class="fc" id="L1256">		appletResponse.put(PageKeys.ACTIVITY_QUEUES_ID, hmActivityQueues);</span>

		//Get all queues from hmActivityQueues as well as all queues for the SP. These are needed when optimizing break placements in new shift assignments.
<span class="fc" id="L1259">		Map&lt;ID, Queue&gt; relevantQueues = getRelevantQueues(spQueues, hmActivityQueues);</span>
<span class="fc" id="L1260">		appletResponse.put(PageKeys.RELEVANT_QUEUES_ID, relevantQueues);</span>
<span class="fc" id="L1261">		return msgID;</span>
	}

	
	/**
	 * Apply a skill start date adjustment so a time of say 22:00:00 in GMT will be adjusted to start at 22:01:00.
	 * This adjustment when applied to a skill that's being removed  from the emp's assignments
	 * ensures that this skill is no longer accounted for in the staffing count, when viewed for the SP week 
	 * starting at the new adjusted time of 22:01 soon after it was end-dated to end at 22:00.
	 * &lt;p&gt;
	 * See &lt;tt&gt;ESR4534014&lt;/tt&gt; details.
	 * 
	 * @param startDate
	 */
	protected Date adjustStartDateToAddAMinute(Date startDate) {
<span class="fc" id="L1276">		Calendar startCal = Calendar.getInstance();</span>
<span class="fc" id="L1277">		startCal.setTimeInMillis(startDate.getTime());</span>
<span class="fc" id="L1278">		startCal.add(Calendar.MINUTE, 1);</span>
<span class="fc" id="L1279">		return startCal.getTime();</span>
	}
	
	/**
	 * Given an organization ID, get the queue color tolerance for it settings from the Organization Settings page,
	 * @param orgID - The organization where the queue is defined.
	 * @return An ArrayList containing the four queue tolerance settings for any queue belonging to the specified org.
	 * The four integer values will be in the following order: 
	 *     [0] = CONTACT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE
	 *     [1] = CONTACT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE
	 *     [2] = PROJECT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE
	 *     [3] = PROJECT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE 
	 * @throws RemoteException 
	 * @throws BbmCreateException 
	 * @throws BbmFinderException 
	 */
	 ArrayList&lt;Integer&gt; getQueueToleranceArrayForOrg(RequestContext context, ID orgID) throws BbmFinderException, BbmCreateException, RemoteException {
<span class="fc" id="L1296">		 ArrayList&lt;Integer&gt; tolerances = new  ArrayList&lt;Integer&gt;(4);		  </span>
<span class="fc" id="L1297">		 OrganizationSetting orgSettings = OrgCalendarOptionsMH.getSettings(context, orgID);</span>
<span class="fc" id="L1298">		 tolerances.add(new Integer(orgSettings.getContactAboveReqTolerance()));</span>
<span class="fc" id="L1299">		 tolerances.add(new Integer(orgSettings.getContactBelowReqTolerance()));</span>
<span class="fc" id="L1300">		 tolerances.add(new Integer(orgSettings.getProjectAboveReqTolerance()));</span>
<span class="fc" id="L1301">		 tolerances.add(new Integer(orgSettings.getProjectBelowReqTolerance()));</span>
<span class="fc" id="L1302">		 return tolerances;</span>
	 }

    /**
     * Get all queues from hmActivityQueues as well as all queues for the SP. These are needed when optimizing break placements in new shift assignments.
     */
    Map&lt;ID, Queue&gt; getRelevantQueues(Collection&lt;SPQueue&gt; spQueues, Map&lt;ID, Collection&lt;ID&gt;&gt; hmActivityQueues)
        throws BbmEJBCreateException, BbmFinderException, RemoteException {
<span class="fc" id="L1310">        Set&lt;ID&gt; queueIDs = new HashSet&lt;ID&gt;();</span>

<span class="fc bfc" id="L1312" title="All 2 branches covered.">        for (SPQueue spq : spQueues) {</span>
<span class="fc" id="L1313">            queueIDs.add(spq.getQueueID());</span>
<span class="fc" id="L1314">        }</span>

<span class="pc bpc" id="L1316" title="1 of 2 branches missed.">        for (ID activityID : hmActivityQueues.keySet()) {</span>
<span class="nc" id="L1317">            queueIDs.addAll(hmActivityQueues.get(activityID));</span>
<span class="nc" id="L1318">        }</span>

<span class="fc" id="L1320">        Map&lt;ID, Queue&gt; hmQueues = new HashMap&lt;ID, Queue&gt;();</span>

<span class="pc bpc" id="L1322" title="1 of 2 branches missed.">        if (!queueIDs.isEmpty()) {</span>
<span class="fc" id="L1323">            Collection&lt;Queue&gt; queues = WfmManagerFactory.getWorkloadManager().getQueuesByIDs(queueIDs);</span>
<span class="pc bpc" id="L1324" title="2 of 4 branches missed.">            if (queues != null &amp;&amp; !queues.isEmpty()) {</span>
<span class="fc bfc" id="L1325" title="All 2 branches covered.">                for (Queue queue : queues) {</span>
<span class="fc" id="L1326">                    hmQueues.put(queue.getID(), queue);</span>
<span class="fc" id="L1327">                }</span>
            }
        }

<span class="fc" id="L1331">        return hmQueues;</span>
    }
	
	/**
	 * Get a map (queue SID -&gt; ServiceGoalsType) for each queue in the SP.
	 * For an unskilled SP or a skilled SP with a single immediate-media queue,
	 * it stores the immediate media queue service goal type
	 * under both the queue ID and null for the combined queue.
	 */
	private Map&lt;ID, ServiceGoalsType&gt; getQueueGoalsMap(Collection&lt;SPQueue&gt; spQueues) {
<span class="fc" id="L1341">		Map&lt;ID, ServiceGoalsType&gt; queueGoalsMap = new HashMap&lt;ID, ServiceGoalsType&gt;();</span>
		
<span class="fc" id="L1343">		Set&lt;SPQueue&gt; immediateSPQueues = new HashSet&lt;SPQueue&gt;();</span>
<span class="fc bfc" id="L1344" title="All 2 branches covered.">		for ( SPQueue spQ : spQueues ) {</span>
<span class="fc" id="L1345">			queueGoalsMap.put(spQ.getQueueID(), ServiceGoalsType.get(MediaType.get(spQ.getMediaID()), spQ));</span>
<span class="fc bfc" id="L1346" title="All 2 branches covered.">			if (Media.isMediaImmediate(spQ.getMediaID())) {</span>
<span class="fc" id="L1347">				immediateSPQueues.add(spQ);</span>
			}
<span class="fc" id="L1349">		}</span>
<span class="fc bfc" id="L1350" title="All 2 branches covered.">		if ( immediateSPQueues.size() == 1 ) {</span>
<span class="fc" id="L1351">			SPQueue spQ = immediateSPQueues.iterator().next();</span>
<span class="fc" id="L1352">			queueGoalsMap.put(null, queueGoalsMap.get(spQ.getQueueID()));</span>
		}
		
<span class="fc" id="L1355">		return queueGoalsMap;</span>
	}

	/**
	 * Returns a map (queue SID -&gt; service level goal seconds) for each queue in the SP.
	 */
	private Map&lt;NullablePair&lt;ID, ID&gt;, Integer&gt; getQueueServiceLevelGoalSecondsMap(Collection&lt;SPQueue&gt; spQueues, boolean isSkillBased)
			throws BbmFinderException, RemoteException {
<span class="fc" id="L1363">		Map&lt;NullablePair&lt;ID, ID&gt;, Integer&gt; queueSLGoalSecondsMap = new HashMap&lt;NullablePair&lt;ID, ID&gt;, Integer&gt;();</span>

<span class="pc bpc" id="L1365" title="1 of 2 branches missed.">		if ( ! spQueues.isEmpty() ) {</span>
<span class="fc" id="L1366">			Set&lt;SPQueue&gt; immediateSPQueues = new HashSet&lt;SPQueue&gt;();</span>
<span class="pc bpc" id="L1367" title="1 of 2 branches missed.">			if ( isSkillBased ) {</span>
<span class="fc bfc" id="L1368" title="All 2 branches covered.">				for ( SPQueue spQ : spQueues ) {</span>
<span class="pc bpc" id="L1369" title="1 of 2 branches missed.">					if (spQ.getMediaID() != null) {</span>
<span class="fc" id="L1370">						queueSLGoalSecondsMap.put(new NullablePair&lt;ID, ID&gt;(spQ.getMediaID(), spQ.getQueueID()), </span>
<span class="fc" id="L1371">							spQ.getSlAnswerWaitingTime());</span>
<span class="fc bfc" id="L1372" title="All 2 branches covered.">						if (Media.isMediaImmediate(spQ.getMediaID())) {</span>
<span class="fc" id="L1373">							immediateSPQueues.add(spQ);</span>
						}
					}
<span class="fc" id="L1376">				}</span>
			} else {
				// For unskilled SPs, just store the media combined queue service levels
				// for any immediate media queues.
				// DHM: Normally unskilled just supports phone but I'm not sure how
				// RFS might deal with face-to-face.
<span class="nc" id="L1382">				ID spID = spQueues.iterator().next().getSpID();</span>
<span class="nc bnc" id="L1383" title="All 2 branches missed.">				for (SPQueue spQ : spQueues) {</span>
<span class="nc" id="L1384">					ID mediaID = spQ.getMediaID();</span>
<span class="nc bnc" id="L1385" title="All 4 branches missed.">					if (mediaID != null &amp;&amp; Media.isMediaImmediate(mediaID)) {</span>
<span class="nc" id="L1386">						NullablePair&lt;ID, ID&gt; mediaCombinedPair = new NullablePair&lt;ID, ID&gt;(mediaID, null);</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">						if ( ! queueSLGoalSecondsMap.containsKey(mediaCombinedPair)) {</span>
<span class="nc" id="L1388">							SPQueue combinedSpQ = m_campaignManager.getCombinedSPQueue(spID, mediaID);</span>
<span class="nc" id="L1389">							queueSLGoalSecondsMap.put(mediaCombinedPair, combinedSpQ.getSlAnswerWaitingTime());</span>
						}
<span class="nc" id="L1391">						immediateSPQueues.add(spQ);</span>
					}
<span class="nc" id="L1393">				}</span>
			}
<span class="fc bfc" id="L1395" title="All 2 branches covered.">			if (immediateSPQueues.size() == 1) {</span>
<span class="fc" id="L1396">				SPQueue spQ = immediateSPQueues.iterator().next();</span>
<span class="pc bpc" id="L1397" title="1 of 2 branches missed.">				ID queueID = isSkillBased ? spQ.getQueueID() : null;</span>
				// Copy the only immediate media service goal to combined-combined.
<span class="fc" id="L1399">				queueSLGoalSecondsMap.put(new NullablePair&lt;ID, ID&gt;(null, null), </span>
<span class="fc" id="L1400">					queueSLGoalSecondsMap.get(new NullablePair&lt;ID, ID&gt;(spQ.getMediaID(), queueID)));</span>
			}
		}

<span class="fc" id="L1404">		return queueSLGoalSecondsMap;</span>
	}

	/**
	 * Returns a map from queue ID to FTE requirements calculated without regard for minimum
	 * occupancy.  If the user has manually defined FTE requirements for a queue then those
	 * requirements are returned for that queue.
	 * &lt;p/&gt;
	 * Note: This method should only be called for an unskilled SP.
	 * 
	 * @param context
	 * @param spQueues
	 * @param startDate
	 * @param endDate
	 * @param useMinimumOccupancy if {@code false}, then the returned FTE level does not reflect
	 * minimum occupancy; if {@code true} then minimum occupancy is taken into account.  Only affects
	 * results for an unskilled SP with a PCA service goal type.
	 * @param useShrinkage If true, we compute the required FTE using the full formula, which includes reverse-compensating for shrinkage.
	 * @return
	 * @throws BbmFinderException
	 * @throws BbmTimeSeriesException
	 * @throws RemoteException
	 */
	private Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; getQueueRequiredFTEForRealTimeServiceLevelMap(
			RequestContext context,
			ID campaignID,
			Collection&lt;SPQueue&gt; spQueues,
			Date startDate,
			Date endDate,
			boolean useMinimumOccupancy,
			boolean useShrinkage)
			throws BbmFinderException, BbmTimeSeriesException, BbmEJBCreateException, RemoteException {
<span class="nc" id="L1436">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; queueMediaFTEMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1437">		FteRequirementsManager fteReqtsMgr = getFteRequirementsManager(context);</span>
<span class="nc bnc" id="L1438" title="All 2 branches missed.">		for (SPQueue spQueue : spQueues) {</span>
			// We are only interested in immediate media queues.
<span class="nc bnc" id="L1440" title="All 4 branches missed.">			if (spQueue.getMediaID() != null &amp;&amp; Media.isMediaImmediate(spQueue.getMediaID())) {</span>
<span class="nc" id="L1441">				ID queueID = spQueue.getQueueID();</span>
<span class="nc" id="L1442">				Collection&lt;RequiredTimeSeries&gt; fteForThisSpQueue = fteReqtsMgr.calculateFteRequirementsForSPQueues(</span>
<span class="nc" id="L1443">						Collections.singleton(spQueue.getID()), useMinimumOccupancy, useShrinkage);</span>
				RequireTraceCube fteRequirementsCube;
<span class="nc bnc" id="L1445" title="All 2 branches missed.">				if (fteForThisSpQueue.isEmpty()) {</span>
					// If the calculate method returned an empty list, it's because there were
					// manually defined FTE requirements for this queue.  We get those instead.
<span class="nc" id="L1448">					fteRequirementsCube = fteReqtsMgr.getFteRequirementsTraceCube(campaignID, queueID, spQueue.getMediaID(), </span>
						startDate, endDate);
				} else {
<span class="nc" id="L1451">					fteRequirementsCube = FteRequirementsTimeSeriesUtil.convertRequiredTimeSeriesToTraceCube(fteForThisSpQueue, </span>
						queueID, startDate, endDate);
				}
<span class="nc" id="L1454">				queueMediaFTEMap.put(new NullablePair&lt;ID, ID&gt;(spQueue.getMediaID(), queueID), fteRequirementsCube);</span>
			}
<span class="nc" id="L1456">		}</span>
		// Copy any non-combined queue data to the combined queue.
<span class="nc bnc" id="L1458" title="All 4 branches missed.">		if ( ! queueMediaFTEMap.containsKey(new NullablePair&lt;ID, ID&gt;(null, null)) &amp;&amp; ! queueMediaFTEMap.isEmpty()) {</span>
<span class="nc" id="L1459">			queueMediaFTEMap.put(new NullablePair&lt;ID, ID&gt;(null, null), queueMediaFTEMap.values().iterator().next());</span>
		}
<span class="nc" id="L1461">		return queueMediaFTEMap;</span>
	}

	private String getEmployeeFilterName(RequestContext context) {
<span class="fc" id="L1465">		String empFilterName = context.getUserProperty(PageKeys.EMP_FILTER);</span>
<span class="fc" id="L1466">		return empFilterName;</span>
	}

	private void addShiftDurationCache(RequestContext context, Map appletResponse)
			throws RemoteException,BbmFinderException, BbmEJBCreateException {
<span class="nc" id="L1471">		String shiftDurationCache = context.getUserProperty(&quot;SHIFT_DURATION_CACHE&quot;);</span>
		// the format of this property is 'shiftId.duration.timeInMilliseconds,[...]'
<span class="nc bnc" id="L1473" title="All 2 branches missed.">		if (!StringUtil.isEmpty(shiftDurationCache)) {</span>
			// the format of the array is [shiftId, duration, timeInMilliseconds,...]
<span class="nc" id="L1475">			String data[] = StringUtil.parseStringToArray(shiftDurationCache,&quot;.,&quot;);</span>

			// the id can appear more than once in the list so
			// we use a hashset to make the results unique.
<span class="nc" id="L1479">			Set&lt;ID&gt; shiftIds = new HashSet&lt;&gt;(31);</span>
<span class="nc bnc" id="L1480" title="All 2 branches missed.">			for (int i = 0; i &lt; data.length; i += 3)</span>
<span class="nc" id="L1481">				shiftIds.add(new ID(data[i]));</span>

<span class="nc bnc" id="L1483" title="All 2 branches missed.">			if (!shiftIds.isEmpty()) {</span>
<span class="nc" id="L1484">				HashMap cacheShifts = ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context).getShiftsByIDs(shiftIds));</span>
				// remove items from cache that are longer valid
<span class="nc" id="L1486">				Iterator itr = shiftIds.iterator();</span>
				// format of delete cmd is &quot;-shiftId.duration[,...]*&quot;
<span class="nc" id="L1488">				StringBuilder sb = new StringBuilder(1024);</span>
<span class="nc" id="L1489">				sb.append(&quot;-&quot;); // delete command</span>
<span class="nc" id="L1490">				boolean addComma = false;</span>
<span class="nc bnc" id="L1491" title="All 2 branches missed.">				while (itr.hasNext()) {</span>
<span class="nc" id="L1492">					Object id = itr.next();</span>
<span class="nc" id="L1493">					Shift shift = (Shift)cacheShifts.get(id);</span>
					// remove invalid ids
<span class="nc bnc" id="L1495" title="All 2 branches missed.">					if (shift == null) {</span>
<span class="nc" id="L1496">						String idStr = id.toString();</span>
<span class="nc bnc" id="L1497" title="All 2 branches missed.">						for (int i = 0; i &lt; data.length; i += 3) {</span>
<span class="nc bnc" id="L1498" title="All 2 branches missed.">							if (idStr.equals(data[i])) {</span>
<span class="nc bnc" id="L1499" title="All 2 branches missed.">								if (addComma)</span>
<span class="nc" id="L1500">									sb.append(',');</span>
<span class="nc" id="L1501">								sb.append(idStr);</span>
<span class="nc" id="L1502">								sb.append('.');</span>
<span class="nc" id="L1503">								sb.append(data[i+1]);</span>
<span class="nc" id="L1504">								addComma = true;</span>
							}
						}
					}
<span class="nc" id="L1508">				}</span>
<span class="nc bnc" id="L1509" title="All 2 branches missed.">				if (addComma) {</span>
<span class="nc" id="L1510">					shiftDurationCache = processShiftDurationCommand(context, sb.toString());</span>
				}
				
<span class="nc" id="L1513">				appletResponse.put(PageKeys.FS_SHIFT_DURATION_PICKER_SHIFTS, cacheShifts);</span>
			}
<span class="nc" id="L1515">			appletResponse.put(PageKeys.FS_SHIFT_DURATION_PICKER_CACHE_SHIFT_DURATION, shiftDurationCache);</span>
<span class="nc" id="L1516">		} else {</span>
<span class="nc" id="L1517">			appletResponse.put(PageKeys.FS_SHIFT_DURATION_PICKER_CACHE_SHIFT_DURATION, &quot;&quot;);</span>
		}
<span class="nc" id="L1519">	}</span>

	private StringBuilder createShiftDurationCache(StringBuilder sb, String data[]) {
		// create a new cache by removing the null items
<span class="nc bnc" id="L1523" title="All 2 branches missed.">		if (sb == null) {</span>
<span class="nc" id="L1524">			sb = new StringBuilder(1024);</span>
		}
<span class="nc bnc" id="L1526" title="All 2 branches missed.">		boolean addComma = sb.length() != 0;</span>
<span class="nc bnc" id="L1527" title="All 2 branches missed.">		for (int i = 0; i &lt; data.length; i += 3) {</span>
<span class="nc bnc" id="L1528" title="All 2 branches missed.">			if (data[i] == null) {</span>
<span class="nc" id="L1529">				continue;</span>
			}
<span class="nc bnc" id="L1531" title="All 2 branches missed.">			if (addComma) {</span>
<span class="nc" id="L1532">				sb.append(&quot;,&quot;);</span>
			}
<span class="nc" id="L1534">			sb.append(data[i]);</span>
<span class="nc" id="L1535">			sb.append(&quot;.&quot;);</span>
<span class="nc" id="L1536">			sb.append(data[i+1]);</span>
<span class="nc" id="L1537">			sb.append(&quot;.&quot;);</span>
<span class="nc" id="L1538">			sb.append(data[i+2]);</span>
<span class="nc" id="L1539">			addComma = true;</span>
		}
<span class="nc" id="L1541">		return sb;</span>
	}

	private String trimShiftDurationCache(String shiftDurationCache) {
		// count the number of ',' in the string
<span class="nc" id="L1546">		int count = 0;</span>
<span class="nc" id="L1547">		int i = 0;</span>
<span class="nc" id="L1548">		int l = shiftDurationCache.length();</span>
<span class="nc bnc" id="L1549" title="All 4 branches missed.">		while (i &lt; l &amp;&amp; (i = shiftDurationCache.indexOf(',', i)) &gt; 0) {</span>
<span class="nc" id="L1550">			count++;</span>
<span class="nc" id="L1551">			i++;</span>
		}

		// make sure that there are only 20 items in the cache
<span class="nc bnc" id="L1555" title="All 2 branches missed.">		if (count &gt; 20) {</span>
<span class="nc" id="L1556">			String data[] = StringUtil.parseStringToArray(shiftDurationCache,</span>
			&quot;.,&quot;);
<span class="nc" id="L1558">			int size = count - 20;</span>
<span class="nc" id="L1559">			int delete[] = new int[size];</span>
			// figure which entries to remove
<span class="nc bnc" id="L1561" title="All 2 branches missed.">			for (i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L1562">				delete[i] = i*3;</span>
			}
			// find the entries that are least used
			// format of data is [shiftId, duration, millisecond,...]
<span class="nc bnc" id="L1566" title="All 2 branches missed.">			for (i = size*3; i &lt; data.length; i += 3) {</span>
<span class="nc" id="L1567">				int ii = i;</span>
<span class="nc bnc" id="L1568" title="All 2 branches missed.">				for (int j = 0; j &lt; size; j++) {</span>
<span class="nc" id="L1569">					if (Long.parseLong(data[ii+2]) &lt;</span>
<span class="nc bnc" id="L1570" title="All 2 branches missed.">							Long.parseLong(data[delete[j]+2])) {</span>
<span class="nc" id="L1571">						int tmp = delete[j];</span>
<span class="nc" id="L1572">						delete[j] = ii;</span>
<span class="nc" id="L1573">						ii = tmp;</span>
					}
				}
			}

			// mark the entry for deletion
<span class="nc bnc" id="L1579" title="All 2 branches missed.">			for (i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L1580">				data[ delete[i] ] = null;</span>
			}
			
<span class="nc" id="L1583">			shiftDurationCache = createShiftDurationCache(null, data).toString();</span>
		}
<span class="nc" id="L1585">		return shiftDurationCache;</span>
	}

	private String processShiftDurationCommand(RequestContext context, String cmd) {
		String shiftDurationCache;
<span class="nc" id="L1590">		shiftDurationCache = context.getUserProperty(&quot;SHIFT_DURATION_CACHE&quot;);</span>
<span class="nc" id="L1591">		boolean changed = false;</span>
		// add shift-duration
<span class="nc bnc" id="L1593" title="All 2 branches missed.">		if (cmd.startsWith(&quot;+&quot;)) {</span>
<span class="nc bnc" id="L1594" title="All 2 branches missed.">			if (!StringUtil.isEmpty(shiftDurationCache))  {</span>
<span class="nc" id="L1595">				shiftDurationCache =</span>
<span class="nc" id="L1596">					trimShiftDurationCache(shiftDurationCache + &quot;,&quot; + cmd.substring(1));</span>
			} else {
<span class="nc" id="L1598">				shiftDurationCache = cmd.substring(1);</span>
			}
<span class="nc" id="L1600">			changed = true;</span>
		}
		// delete shift-duration
<span class="nc bnc" id="L1603" title="All 2 branches missed.">		else if (cmd.startsWith(&quot;-&quot;)) {</span>
<span class="nc bnc" id="L1604" title="All 2 branches missed.">			if (!StringUtil.isEmpty(shiftDurationCache)) {</span>
<span class="nc" id="L1605">				String data[] = StringUtil.parseStringToArray(shiftDurationCache,</span>
				&quot;.,&quot;);
				// format of delta is ['shiftId', 'duration', ...]
<span class="nc" id="L1608">				String delta[] = StringUtil.parseStringToArray(cmd.substring(1),</span>
				&quot;.,&quot;);
<span class="nc bnc" id="L1610" title="All 2 branches missed.">				for (int i = 0; i &lt; data.length; i += 3) {</span>
<span class="nc bnc" id="L1611" title="All 2 branches missed.">					for (int j = 0; j &lt; delta.length; j += 2) {</span>
						// if shift ids match
<span class="nc bnc" id="L1613" title="All 2 branches missed.">						if (data[i].equals(delta[j]) &amp;&amp;</span>
								// if shift duration match
<span class="nc bnc" id="L1615" title="All 2 branches missed.">								data[i+1].equals(delta[j+1])) {</span>
<span class="nc" id="L1616">							changed = true;</span>
							// remove the shift id
<span class="nc" id="L1618">							data[i] = null;</span>
						}
					}
				}
<span class="nc bnc" id="L1622" title="All 2 branches missed.">				if (changed) {</span>
<span class="nc" id="L1623">					shiftDurationCache = createShiftDurationCache(null, data).toString();</span>
				}
<span class="nc" id="L1625">			}</span>
		} else {
			// update shift-duration
<span class="nc bnc" id="L1628" title="All 2 branches missed.">			if (!StringUtil.isEmpty(shiftDurationCache)) {</span>
<span class="nc" id="L1629">				String data[] = StringUtil.parseStringToArray(shiftDurationCache,</span>
				&quot;.,&quot;);
<span class="nc" id="L1631">				String delta[] = StringUtil.parseStringToArray(cmd,</span>
				&quot;.,&quot;);
<span class="nc bnc" id="L1633" title="All 2 branches missed.">				for (int i = 0; i &lt; data.length; i += 3) {</span>
<span class="nc bnc" id="L1634" title="All 2 branches missed.">					for (int j = 0; j &lt; delta.length; j += 3) {</span>
<span class="nc bnc" id="L1635" title="All 2 branches missed.">						if (delta[j] == null) {</span>
<span class="nc" id="L1636">							continue;</span>
						}
						// if shift ids match
<span class="nc bnc" id="L1639" title="All 2 branches missed.">						if (data[i].equals(delta[j]) &amp;&amp;</span>
								// if shift duration match
<span class="nc bnc" id="L1641" title="All 2 branches missed.">								data[i+1].equals(delta[j+1])) {</span>
							// copy last used time stamp
<span class="nc" id="L1643">							data[i+2] = delta[j+2];</span>
<span class="nc" id="L1644">							delta[j] = null;</span>
						}
					}
				}
<span class="nc" id="L1648">				StringBuilder sb = createShiftDurationCache(null, data);</span>
				// allow updates to do implicit additions
<span class="nc" id="L1650">				createShiftDurationCache(sb, delta);</span>
<span class="nc" id="L1651">				shiftDurationCache = trimShiftDurationCache(sb.toString());</span>
<span class="nc" id="L1652">			} else {</span>
<span class="nc" id="L1653">				shiftDurationCache = cmd;</span>
			}
<span class="nc" id="L1655">			changed = true;</span>
		}
<span class="nc bnc" id="L1657" title="All 2 branches missed.">		if (changed) {</span>
<span class="nc" id="L1658">			context.setUserProperty(&quot;SHIFT_DURATION_CACHE&quot;,</span>
					shiftDurationCache);
		}
<span class="nc" id="L1661">		return shiftDurationCache;</span>
	}

<span class="fc" id="L1664">	public static final ID DEFAULT_ID = new ID(0);</span>
<span class="fc" id="L1665">	public static final Integer DEFAULT_INT = new Integer(0);</span>
<span class="fc" id="L1666">	public static final TimeOfDay DEFAULT_TIME = new TimeOfDay(0);</span>

<span class="fc" id="L1668">	public static class ShiftComparator implements Comparator {</span>
		public static final int NAME_SORT = 0;
		public static final int PAY_POLICY_SORT = 1;
		public static final int START_SORT = 2;
		public static final int DESC_SORT = 3;
		public static final int DURATION_SORT = 4;
		public static final int ORG_SORT = 5;

<span class="nc" id="L1676">		int m_sortType = NAME_SORT;</span>
<span class="nc" id="L1677">		public ShiftComparator(String column) {</span>
<span class="nc bnc" id="L1678" title="All 2 branches missed.">			if (StringUtil.isEmpty(column) ||</span>
<span class="nc bnc" id="L1679" title="All 2 branches missed.">					column.equalsIgnoreCase(&quot;NAME&quot;)) {</span>
<span class="nc" id="L1680">				m_sortType = NAME_SORT;</span>
<span class="nc bnc" id="L1681" title="All 2 branches missed.">			} else if (column.equalsIgnoreCase(&quot;START&quot;)) {</span>
<span class="nc" id="L1682">				m_sortType = START_SORT;</span>
<span class="nc bnc" id="L1683" title="All 2 branches missed.">			} else if (column.equalsIgnoreCase(&quot;DESC&quot;)) {</span>
<span class="nc" id="L1684">				m_sortType = DESC_SORT;</span>
<span class="nc bnc" id="L1685" title="All 2 branches missed.">			} else if (column.equalsIgnoreCase(&quot;DURATION&quot;)) {</span>
<span class="nc" id="L1686">				m_sortType = DURATION_SORT;</span>
<span class="nc bnc" id="L1687" title="All 2 branches missed.">			} else if (column.equalsIgnoreCase(&quot;PAY_POLICY&quot;)) {</span>
<span class="nc" id="L1688">				m_sortType = PAY_POLICY_SORT;</span>
<span class="nc bnc" id="L1689" title="All 2 branches missed.">			} else if (column.equalsIgnoreCase(&quot;ORG&quot;)) {</span>
<span class="nc" id="L1690">				m_sortType = ORG_SORT;</span>
			}
<span class="nc" id="L1692">		}</span>
		public TimeOfDay getMinTime(Collection times) {
<span class="nc" id="L1694">			Iterator itr = times.iterator();</span>
<span class="nc" id="L1695">			TimeOfDay t1 = DEFAULT_TIME;</span>
<span class="nc bnc" id="L1696" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L1697">				TimeOfDay t2 = (TimeOfDay)itr.next();</span>
<span class="nc bnc" id="L1698" title="All 4 branches missed.">				if (t1 == DEFAULT_TIME || t1.after(t2)) {</span>
<span class="nc" id="L1699">					t1 = t2;</span>
				}
<span class="nc" id="L1701">			}</span>
<span class="nc" id="L1702">			return t1;</span>
		}
		public Integer getMaxDuration(Collection durations) {
<span class="nc" id="L1705">			Iterator itr = durations.iterator();</span>
<span class="nc" id="L1706">			Integer t1 = DEFAULT_INT;</span>
<span class="nc bnc" id="L1707" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L1708">				Integer t2 = (Integer)itr.next();</span>
<span class="nc bnc" id="L1709" title="All 4 branches missed.">				if (t1 == DEFAULT_INT || t1.intValue() &lt; t2.intValue()) {</span>
<span class="nc" id="L1710">					t1 = t2;</span>
				}
<span class="nc" id="L1712">			}</span>
<span class="nc" id="L1713">			return t1;</span>
		}
		@Override
		public int compare(Object o1, Object o2) {
<span class="nc" id="L1717">			Shift s1 = (Shift)o1;</span>
<span class="nc" id="L1718">			Shift s2 = (Shift)o2;</span>
<span class="nc bnc" id="L1719" title="All 3 branches missed.">			switch(m_sortType) {</span>

			case DESC_SORT:
<span class="nc" id="L1722">				String desc1 = s1.getDescription();</span>
<span class="nc" id="L1723">				String desc2 = s2.getDescription();</span>
<span class="nc bnc" id="L1724" title="All 2 branches missed.">				if (desc1 == null) {</span>
<span class="nc" id="L1725">					desc1 = &quot;&quot;;</span>
				}
<span class="nc bnc" id="L1727" title="All 2 branches missed.">				if (desc2 == null) {</span>
<span class="nc" id="L1728">					desc2 = &quot;&quot;;</span>
				}
<span class="nc" id="L1730">				return desc1.compareTo(desc2);</span>

			case ORG_SORT: 
				// should use org name ...
<span class="nc" id="L1734">				ID oid1 = s1.getOrganizationID();</span>
<span class="nc" id="L1735">				ID oid2 = s2.getOrganizationID();</span>
<span class="nc bnc" id="L1736" title="All 2 branches missed.">				if (oid1 == null) {</span>
<span class="nc" id="L1737">					oid1 = DEFAULT_ID;</span>
				}
<span class="nc bnc" id="L1739" title="All 2 branches missed.">				if (oid2 == null) {</span>
<span class="nc" id="L1740">					oid2 = DEFAULT_ID;</span>
				}
<span class="nc" id="L1742">				return oid1.compareTo(oid2);</span>
			}

<span class="nc" id="L1745">			return s1.getName().compareTo(s2.getName());</span>
		}
	}

	private Map&lt;ID, Boolean&gt; getEmpEditablesForEvent(Event eventToCheck, Date startDate, 
			Date endDate, RequestContext context) throws BbmFinderException, RemoteException, BbmEJBCreateException {
<span class="nc" id="L1751">		return getEmpEditablesForEvents(Collections.singletonList(eventToCheck), startDate, endDate, context);</span>
	}

	private Map&lt;ID, Boolean&gt; getEmpEditablesForEventTemplate(CalendarEventTemplate templateToCheck, RequestContext context)
			throws BbmFinderException, RemoteException, BbmEJBCreateException {
<span class="nc" id="L1756">		Collection&lt;ID&gt; cEmpIDs = templateToCheck.getWorkResourceIDs();</span>
		// TYLER you may need to do something smarter than null, null
<span class="nc" id="L1758">		return getEmpEditables(cEmpIDs, null, null, context);</span>
	}

	private Map&lt;ID, Boolean&gt; getEmpEditablesForEvents(List&lt;Event&gt; eventsToCheck, Date startDate, Date endDate, RequestContext context)
			throws BbmFinderException, RemoteException, BbmEJBCreateException {
<span class="nc" id="L1763">		Set&lt;ID&gt; setEmpIDs = new HashSet&lt;ID&gt;(eventsToCheck.size());</span>
<span class="nc" id="L1764">		Iterator&lt;Event&gt; itEvents = eventsToCheck.iterator();</span>
<span class="nc bnc" id="L1765" title="All 2 branches missed.">		while (itEvents.hasNext()) {</span>
<span class="nc" id="L1766">			Event nextEvent = itEvents.next();</span>
<span class="nc" id="L1767">			setEmpIDs.addAll(nextEvent.getWorkResourceIDs());</span>
<span class="nc" id="L1768">		}</span>
<span class="nc" id="L1769">		return getEmpEditables(setEmpIDs, startDate, endDate, context);</span>
	}

	private Map&lt;ID, Boolean&gt; getEmpEditables(Collection&lt;ID&gt; idsToCheck, Date startDate, Date endDate, RequestContext context)
			throws BbmFinderException, RemoteException, BbmEJBCreateException {
<span class="nc" id="L1774">		WorkResourceManager wrManager = getWorkResourceManager(context);</span>
<span class="nc" id="L1775">		Collection authorizedOrgs = context.getUser().getAuthorizedScopes(PrivilegeKeys.FS_VIEWORGSCHEDULES);</span>
<span class="nc" id="L1776">		Map&lt;ID, Boolean&gt; empEditables = new HashMap&lt;ID, Boolean&gt;(idsToCheck.size());</span>
<span class="nc bnc" id="L1777" title="All 4 branches missed.">		if (authorizedOrgs == null || authorizedOrgs.isEmpty()) {</span>
<span class="nc" id="L1778">			Iterator&lt;ID&gt; itIDs = idsToCheck.iterator();</span>
<span class="nc bnc" id="L1779" title="All 2 branches missed.">			while (itIDs.hasNext()) {</span>
<span class="nc" id="L1780">				ID nextID = itIDs.next();</span>
<span class="nc" id="L1781">				empEditables.put(nextID, Boolean.FALSE);</span>
<span class="nc" id="L1782">			}</span>
<span class="nc" id="L1783">		} else {</span>
<span class="nc" id="L1784">			Map&lt;ID, Object&gt; employeesReportingOrgs = wrManager.getEmployeesReportingOrgs(idsToCheck, startDate, endDate);</span>
<span class="nc bnc" id="L1785" title="All 2 branches missed.">			if (employeesReportingOrgs.isEmpty()) {</span>
				//could be phantom, return phantomid-orgid map
<span class="nc" id="L1787">				employeesReportingOrgs = getScheduleAccessManager(context).getPhantomsOrganizations(idsToCheck);</span>
			}
<span class="nc" id="L1789">			Iterator&lt;ID&gt; itIDs = idsToCheck.iterator();</span>
<span class="nc bnc" id="L1790" title="All 2 branches missed.">			while (itIDs.hasNext()) {</span>
<span class="nc" id="L1791">				ID nextID = itIDs.next();</span>
<span class="nc" id="L1792">				Object orgs = employeesReportingOrgs.get(nextID);</span>
<span class="nc" id="L1793">				Collection&lt;ID&gt; colOrgIDs = null;</span>
<span class="nc bnc" id="L1794" title="All 2 branches missed.">				if (orgs instanceof ID) {</span>
					//phantom
<span class="nc" id="L1796">					colOrgIDs = Collections.singleton((ID)orgs);</span>
				} else {
					//employee
<span class="nc" id="L1799">					colOrgIDs = (Collection&lt;ID&gt;)orgs;</span>
				}
<span class="nc" id="L1801">				boolean hasPermissions = false;</span>
<span class="nc bnc" id="L1802" title="All 4 branches missed.">				if (colOrgIDs != null &amp;&amp; !colOrgIDs.isEmpty()) {</span>
<span class="nc" id="L1803">					Iterator&lt;ID&gt; itEmpOrgIDs = colOrgIDs.iterator();</span>
<span class="nc bnc" id="L1804" title="All 2 branches missed.">					while (itEmpOrgIDs.hasNext()) {</span>
<span class="nc" id="L1805">						ID nextOrgID = itEmpOrgIDs.next();</span>
<span class="nc bnc" id="L1806" title="All 2 branches missed.">						if (authorizedOrgs.contains(nextOrgID)) {</span>
<span class="nc" id="L1807">							hasPermissions = true;</span>
						}
<span class="nc" id="L1809">					}</span>
				}
<span class="nc bnc" id="L1811" title="All 2 branches missed.">				if (!hasPermissions) {</span>
					//if no permission, check if it is pooler
					//check pooler assignment
<span class="nc" id="L1814">					Collection&lt;EmpPoolingRule&gt; rules = getEmpWorkRuleManager(context).getPoolingRuleAssignments(nextID, startDate, endDate);</span>
<span class="nc bnc" id="L1815" title="All 2 branches missed.">					if( rules != null){</span>
<span class="nc bnc" id="L1816" title="All 2 branches missed.">						for (Iterator&lt;EmpPoolingRule&gt; iInner = rules.iterator(); iInner.hasNext();) {</span>
<span class="nc" id="L1817">							Iterator it = iInner.next().getSecondaryOgs().iterator();</span>
<span class="nc bnc" id="L1818" title="All 2 branches missed.">							while (it.hasNext()) {</span>
<span class="nc bnc" id="L1819" title="All 2 branches missed.">								if (authorizedOrgs.contains(it.next())) {</span>
<span class="nc" id="L1820">									hasPermissions = true;</span>
<span class="nc" id="L1821">									break;</span>
								}
							}
<span class="nc" id="L1824">						}</span>
					}
				}
				
<span class="nc bnc" id="L1828" title="All 4 branches missed.">				if (!hasPermissions &amp;&amp; isAuthorizedToTerminatedEmployeeLastOrg(authorizedOrgs, nextID, startDate, wrManager)) { </span>
<span class="nc" id="L1829">						hasPermissions = true ; </span>

				}
<span class="nc" id="L1832">				empEditables.put(nextID, Boolean.valueOf(hasPermissions));</span>
<span class="nc" id="L1833">			}</span>
		}
<span class="nc" id="L1835">		return empEditables;</span>
	}
	
	protected boolean isAuthorizedToTerminatedEmployeeLastOrg(Collection&lt;ID&gt; authorizedOrgs, ID empID, Date startDate, 
			WorkResourceManager wrManager) throws BbmFinderException, BbmEJBCreateException, RemoteException {
<span class="nc bnc" id="L1840" title="All 2 branches missed.">		if (wrManager.isEmployeeTerminated(empID, startDate)) {</span>
<span class="nc" id="L1841">			Collection&lt;WorkResourceAssignment&gt; colWRAsSortedByStartTimeASC = wrManager.getWRAssignmentsWithTimeZone(empID); </span>
<span class="nc bnc" id="L1842" title="All 4 branches missed.">			if (colWRAsSortedByStartTimeASC != null &amp;&amp; !colWRAsSortedByStartTimeASC.isEmpty()) {</span>
<span class="nc" id="L1843">				ArrayList&lt;WorkResourceAssignment&gt; listWRAsSortedByStartTime = new ArrayList&lt;&gt;(colWRAsSortedByStartTimeASC); </span>
<span class="nc" id="L1844">				WorkResourceAssignment lastOrgSegment = listWRAsSortedByStartTime.get(listWRAsSortedByStartTime.size() - 1); </span>
<span class="nc bnc" id="L1845" title="All 2 branches missed.">				if (authorizedOrgs.contains(lastOrgSegment.getOrganizationID())) {</span>
<span class="nc" id="L1846">					return true;</span>
				}
			}
		}
<span class="nc" id="L1850">		return false;</span>
	}

	private Collection&lt;ID&gt; getEmpIDsWithoutPermissionToEditEvent(Collection&lt;ID&gt; workResourceIDs, Map&lt;ID, Boolean&gt; mapEmpEditables) {
<span class="nc" id="L1854">		Iterator&lt;ID&gt; itWorkResourceIDs = workResourceIDs.iterator();</span>
<span class="nc" id="L1855">		Collection&lt;ID&gt; empIDsWithoutPermission = new ArrayList&lt;ID&gt;(workResourceIDs.size());</span>
<span class="nc bnc" id="L1856" title="All 2 branches missed.">		while (itWorkResourceIDs.hasNext()) {</span>
<span class="nc" id="L1857">			ID nextWRID = itWorkResourceIDs.next();</span>
<span class="nc" id="L1858">			Boolean empHasPermissions = mapEmpEditables.get(nextWRID);</span>
<span class="nc bnc" id="L1859" title="All 4 branches missed.">			if (empHasPermissions == null || !empHasPermissions.booleanValue()) {</span>
<span class="nc" id="L1860">				empIDsWithoutPermission.add(nextWRID);</span>
			}
<span class="nc" id="L1862">		}</span>
<span class="nc" id="L1863">		return empIDsWithoutPermission;</span>
	}

	private void processCustomRequest(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="fc" id="L1867">		String msgID = FsWebBundleKey.FS_CAL_REQHNDLR_UNKNOWN_REQUEST_TYPE;</span>
<span class="fc" id="L1868">		Locale locale = context.getLocaleContext().getLanguageLocale();</span>
<span class="fc" id="L1869">		Object[] params = null;</span>
		try {
<span class="pc bpc" id="L1871" title="1 of 2 branches missed.">			if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_SHIFT_ASSIGNMENT)) {</span>
<span class="nc" id="L1872">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_SHIFTASSIGNMENT;</span>
<span class="nc" id="L1873">				ShiftAssignment newAssignment = (ShiftAssignment) appletRequest.get(PageKeys.SHIFT_ASSIGNMENT);</span>
<span class="nc" id="L1874">				ID newShiftID = null;</span>
<span class="nc" id="L1875">				Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEvent(newAssignment, newAssignment.getStartTime(), </span>
<span class="nc" id="L1876">					newAssignment.getEndTime(), context);</span>
<span class="nc" id="L1877">				Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(</span>
<span class="nc" id="L1878">					newAssignment.getWorkResourceIDs(), mapEmpEditables);</span>
<span class="nc bnc" id="L1879" title="All 4 branches missed.">				if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; !empIDsWithoutPermissionToEditEvent.isEmpty()) {</span>
<span class="nc" id="L1880">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_NO_PERMISSION_EMPLOYEE;</span>
<span class="nc" id="L1881">					handleExpectedError(context, appletResponse, msgID, params);</span>
<span class="nc" id="L1882">					return;</span>
				} else {
<span class="nc" id="L1884">					removeOTEventHolderBeforeSave(newAssignment);</span>
<span class="nc" id="L1885">					newShiftID = getScheduleAccessManager(context).createShiftAssignment(newAssignment);</span>
				}
<span class="nc" id="L1887">				ShiftAssignment newSA = null;</span>
<span class="nc bnc" id="L1888" title="All 2 branches missed.">				if (newShiftID != null) {</span>
<span class="nc" id="L1889">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_RETRIEVING_SHIFTASSIGNMENT;</span>
<span class="nc" id="L1890">					newSA = getScheduleAccessManager(context).getShiftAssignmentByID(newShiftID);</span>
<span class="nc" id="L1891">					appletResponse.put(PageKeys.NEW_SHIFT_ASSIGNMENT, newSA);</span>
				}
<span class="pc bpc" id="L1893" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_CALENDAR_EVENT_ASSIGNMENT)) {</span>
<span class="nc" id="L1894">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_CALENDAR_EVENT;</span>
<span class="nc" id="L1895">				CalendarEventAssignment newAssignment = (CalendarEventAssignment) appletRequest.get(PageKeys.CALENDAR_EVENT_ASSIGNMENT);</span>
<span class="nc" id="L1896">				ID newCalendarEventID = null;</span>
<span class="nc" id="L1897">				Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEvent(newAssignment, </span>
<span class="nc" id="L1898">					newAssignment.getStartTime(), newAssignment.getEndTime(), context);</span>
<span class="nc" id="L1899">				Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(</span>
<span class="nc" id="L1900">					newAssignment.getWorkResourceIDs(), mapEmpEditables);</span>
<span class="nc bnc" id="L1901" title="All 4 branches missed.">				if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; !empIDsWithoutPermissionToEditEvent.isEmpty()) {</span>
<span class="nc" id="L1902">					params = new Object[] {new Integer(empIDsWithoutPermissionToEditEvent.size())};</span>
<span class="nc" id="L1903">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_NONECHANGED;</span>
<span class="nc" id="L1904">					handleExpectedError(context, appletResponse, msgID, params);</span>
<span class="nc" id="L1905">					return;</span>
				} else {
<span class="nc" id="L1907">					newCalendarEventID = getScheduleAccessManager(context).createCalendarEventAssignment(newAssignment);</span>
				}
<span class="nc" id="L1909">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_RETRIEVING_CALENDAR_EVENT;</span>
<span class="nc" id="L1910">				CalendarEventAssignment newCE = null;</span>
<span class="nc bnc" id="L1911" title="All 2 branches missed.">				if (newCalendarEventID != null) {</span>
<span class="nc" id="L1912">					newCE = getScheduleAccessManager(context).getCalendarEventAssignmentByID(newCalendarEventID);</span>
				}
<span class="nc" id="L1914">				appletResponse.put(PageKeys.NEW_CALENDAR_EVENT_ASSIGNMENT, newCE);</span>
<span class="pc bpc" id="L1915" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_CLASS_SESSION)) {</span>
<span class="nc" id="L1916">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_CLASS_SESSION;</span>
<span class="nc" id="L1917">				ID classID = (ID) appletRequest.get(PageKeys.EVENTTEMPLATE_ID);</span>
<span class="nc" id="L1918">				CalendarEvent session = (CalendarEvent)appletRequest.get(PageKeys.CLASS_SESSION_TO_CREATE);</span>
<span class="nc" id="L1919">				ID newSessionID = null;</span>
<span class="nc" id="L1920">				Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEvent(session, session.getStartTime(), </span>
<span class="nc" id="L1921">					session.getEndTime(), context);</span>
<span class="nc" id="L1922">				Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(session.getWorkResourceIDs(), </span>
					mapEmpEditables);
<span class="nc bnc" id="L1924" title="All 4 branches missed.">				if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; !empIDsWithoutPermissionToEditEvent.isEmpty()) {</span>
<span class="nc" id="L1925">					params = new Object[] {new Integer(empIDsWithoutPermissionToEditEvent.size())};</span>
<span class="nc" id="L1926">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_NONECHANGED;</span>
<span class="nc" id="L1927">					handleExpectedError(context, appletResponse, msgID, params);</span>
<span class="nc" id="L1928">					return;</span>
				} else {
<span class="nc" id="L1930">					newSessionID = getScheduleAccessManager(context).createClassSession(classID, session);</span>
				}
<span class="nc" id="L1932">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_RETRIEVING_CLASS_SESSION;</span>
<span class="nc" id="L1933">				CalendarEventAssignment newSession = null;</span>
<span class="nc bnc" id="L1934" title="All 2 branches missed.">				if (newSessionID != null) {</span>
<span class="nc" id="L1935">					newSession = getScheduleAccessManager(context).getCalendarEventAssignmentByID(newSessionID);</span>
				}
<span class="nc" id="L1937">				appletResponse.put(PageKeys.NEW_CALENDAR_EVENT_ASSIGNMENT, newSession);</span>
<span class="pc bpc" id="L1938" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_GET_CALENDAR_EVENT_TEMPLATE_CONFLICTS)) {</span>
<span class="nc" id="L1939">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CALENDAREVENT_CONFLICTS;</span>
<span class="nc" id="L1940">				CalendarEventTemplate eventTemplateToCreate = (CalendarEventTemplate) appletRequest.get(PageKeys.CALENDAR_EVENT_TEMPLATE);</span>
<span class="nc" id="L1941">				Collection conflicts = getScheduleAccessManager(context).getConflictsForCalendarEventTemplate(eventTemplateToCreate);</span>
<span class="nc" id="L1942">				appletResponse.put(PageKeys.CALENDAR_EVENT_TEMPLATE_CONFLICTS, conflicts);</span>
<span class="pc bpc" id="L1943" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_CALENDAR_EVENT_TEMPLATE)) {</span>
<span class="nc" id="L1944">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_CALENDAREVENT_TEMPLATE;</span>
<span class="nc" id="L1945">				CalendarEventTemplate eventTemplateToCreate = (CalendarEventTemplate) appletRequest.get(PageKeys.CALENDAR_EVENT_TEMPLATE);</span>
<span class="nc" id="L1946">				Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEventTemplate(eventTemplateToCreate, context);</span>
<span class="nc" id="L1947">				Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(eventTemplateToCreate.getWorkResourceIDs(), </span>
					mapEmpEditables);
<span class="nc bnc" id="L1949" title="All 4 branches missed.">				if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; !empIDsWithoutPermissionToEditEvent.isEmpty()) {</span>
<span class="nc" id="L1950">					params = new Object[] {new Integer(empIDsWithoutPermissionToEditEvent.size())};</span>
<span class="nc" id="L1951">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_NONECHANGED;</span>
<span class="nc" id="L1952">					handleExpectedError(context, appletResponse, msgID, params);</span>
				} else {
<span class="nc" id="L1954">					BbmScheduleConflictResolutions conflictResolutions = (BbmScheduleConflictResolutions) appletRequest.get(</span>
						PageKeys.CALENDAR_EVENT_TEMPLATE_RESOLUTIONS);
<span class="nc" id="L1956">					ID templateID = getScheduleAccessManager(context).createEventTemplateWithInstances(eventTemplateToCreate, conflictResolutions);</span>
<span class="nc bnc" id="L1957" title="All 2 branches missed.">					if (templateID != null) {</span>
<span class="nc" id="L1958">						msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_RETRIEVING_CALENDAREVENT_TEMPLATE;</span>
<span class="nc" id="L1959">						CalendarEventTemplate createdTemplate = getScheduleAccessManager(context).getCalendarEventTemplateByID(templateID);</span>
<span class="nc" id="L1960">						appletResponse.put(PageKeys.NEW_CALENDAR_EVENT_TEMPLATE, createdTemplate);</span>
					}
				}
<span class="pc bpc" id="L1963" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_SAVE_EVENT_CHANGES)) {</span>
<span class="nc" id="L1964">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_EVENTS;</span>
<span class="nc" id="L1965">				ID spID = (ID)appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc bnc" id="L1966" title="All 2 branches missed.">				if (spID != null){</span>
					//set shift assignment sp id and lock customized shift assignment
<span class="nc" id="L1968">					Collection idShiftToSetSPID = (Collection)appletRequest.get(PageKeys.EVENTS_TO_UPDATE_COLLECTION);</span>
<span class="nc" id="L1969">					Collection idShiftToLock = (Collection)appletRequest.get(PageKeys.LOCKUNLOCK_EVENT_MASK);</span>
<span class="nc" id="L1970">					getScheduleAccessManager(context).setSPIDLockCustomizedShifts(spID, idShiftToSetSPID, idShiftToLock);</span>
<span class="nc" id="L1971">				} else {</span>
					//update events
<span class="nc" id="L1973">					Collection eventsToChange = (Collection) appletRequest.get(PageKeys.EVENTS_TO_UPDATE_COLLECTION);</span>
<span class="nc" id="L1974">					Iterator itEvents = eventsToChange.iterator();</span>
<span class="nc" id="L1975">					boolean someEventChangesSaved = false;</span>
<span class="nc" id="L1976">					Set setEmpsWithNoPermission = new HashSet();</span>
<span class="nc" id="L1977">					List changedEvents = new ArrayList(eventsToChange.size());</span>
<span class="nc bnc" id="L1978" title="All 2 branches missed.">					while (itEvents.hasNext()) {</span>
<span class="nc" id="L1979">						Event nextEventObj = (Event) itEvents.next();</span>
<span class="nc" id="L1980">						Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEvent(nextEventObj, </span>
<span class="nc" id="L1981">							nextEventObj.getStartTime(), nextEventObj.getEndTime(), context);</span>
<span class="nc" id="L1982">						Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(</span>
<span class="nc" id="L1983">							nextEventObj.getWorkResourceIDs(), mapEmpEditables);</span>
<span class="nc bnc" id="L1984" title="All 4 branches missed.">						if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; empIDsWithoutPermissionToEditEvent.size() &gt; 0) {</span>
<span class="nc" id="L1985">							setEmpsWithNoPermission.addAll(empIDsWithoutPermissionToEditEvent);</span>
						} else {
<span class="nc bnc" id="L1987" title="All 2 branches missed.">							if (nextEventObj instanceof ShiftAssignment) {</span>
<span class="nc" id="L1988">								msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_SHIFTASSIGNMENT;</span>
<span class="nc" id="L1989">								ShiftAssignment shift = (ShiftAssignment)nextEventObj;</span>
<span class="nc" id="L1990">								removeOTEventHolderBeforeSave(shift);</span>
<span class="nc" id="L1991">								shift.setUpdateUser(context.getUserName());</span>
<span class="nc" id="L1992">								getScheduleAccessManager(context).updateShiftAssignment(shift);</span>
<span class="nc" id="L1993">								changedEvents.add(getScheduleAccessManager(context).getShiftAssignmentByID(shift.getID()));</span>
<span class="nc" id="L1994">								someEventChangesSaved = true;</span>
<span class="nc bnc" id="L1995" title="All 2 branches missed.">							} else if (nextEventObj instanceof CalendarEventAssignment) {</span>
<span class="nc" id="L1996">								msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT;</span>
<span class="nc" id="L1997">								((CalendarEventAssignment) nextEventObj).setUpdateUser(context.getUserName());</span>
<span class="nc" id="L1998">								getScheduleAccessManager(context).updateCalendarEventAssignment((CalendarEventAssignment) nextEventObj);</span>
<span class="nc" id="L1999">								changedEvents.add(getScheduleAccessManager(context).getCalendarEventAssignmentByID((</span>
<span class="nc" id="L2000">									(CalendarEventAssignment) nextEventObj).getID()));</span>
<span class="nc" id="L2001">								someEventChangesSaved = true;</span>
							} else {
<span class="nc" id="L2003">								msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_UNKNOWNTYPE;</span>
<span class="nc" id="L2004">								handleExpectedError(context, appletResponse, msgID, params);</span>
<span class="nc" id="L2005">								return;</span>
							}
						}
<span class="nc" id="L2008">					}</span>
<span class="nc" id="L2009">					addResponseData(changedEvents, appletResponse);</span>
<span class="nc bnc" id="L2010" title="All 2 branches missed.">					if (!setEmpsWithNoPermission.isEmpty()) {</span>
<span class="nc" id="L2011">						params = new Object[] {new Integer(setEmpsWithNoPermission.size())};</span>
<span class="nc bnc" id="L2012" title="All 2 branches missed.">						if (someEventChangesSaved) {</span>
<span class="nc" id="L2013">							msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_SOMECHANGED;</span>
						} else {
<span class="nc" id="L2015">							msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_NONECHANGED;</span>
						}
<span class="nc" id="L2017">						handleExpectedError(context, appletResponse, msgID, params);</span>
<span class="nc" id="L2018">						return;</span>
					}
				}
<span class="pc bpc" id="L2021" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_RECURRING_EVENT_EXCEPTION)) {</span>
<span class="nc" id="L2022">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_EVENT_EXCEPTION;</span>
<span class="nc" id="L2023">				CalendarEventAssignment event = (CalendarEventAssignment)appletRequest.get(PageKeys.EVENT_TO_CREATE);</span>
<span class="nc" id="L2024">				CalendarEventAssignment recurringEventException = getScheduleAccessManager(context).createRecurringEventException(</span>
<span class="nc" id="L2025">                        event.getEventTemplateID(), </span>
<span class="nc" id="L2026">                        event.getWorkResourceIDs(), </span>
<span class="nc" id="L2027">                        event.getStartTime());</span>
<span class="nc" id="L2028">				appletResponse.put(PageKeys.EVENT_TO_CREATE, recurringEventException);</span>
<span class="pc bpc" id="L2029" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_EVENT_EXCEPTION)) {</span>
<span class="nc" id="L2030">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_EVENT_EXCEPTION;</span>
<span class="nc" id="L2031">				EventTemplateExceptionCreateData exceptionCreateData = (EventTemplateExceptionCreateData) </span>
<span class="nc" id="L2032">					appletRequest.get(PageKeys.EVENT_TEMPLATE_EXCEPTION_CREATE_DATA);</span>
				//conflictResolutionsForUpdate
<span class="nc" id="L2034">				CalendarEventTemplate template = exceptionCreateData.getTemplate();</span>
<span class="nc" id="L2035">				short templateType = template.getTemplateType();</span>
<span class="nc" id="L2036">				ID exceptionID = null;</span>
<span class="nc bnc" id="L2037" title="All 2 branches missed.">				if (templateType == CalendarEventTemplate.EVENT_TEMPLATE_RECURRING) {</span>
<span class="nc" id="L2038">					exceptionID = getScheduleAccessManager(context).createRecurringEventExceptionAndUpdateCalendarEventAssignment(</span>
<span class="nc" id="L2039">						exceptionCreateData, context.getUserName());</span>
				}
<span class="nc bnc" id="L2041" title="All 2 branches missed.">				if (templateType == CalendarEventTemplate.EVENT_TEMPLATE_RECURRING_FLOATING) {</span>
<span class="nc" id="L2042">					Date floatingStart = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L2043">					Date floatingEnd = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L2044">					Collection&lt;ID&gt; workResourceIDs = exceptionCreateData.getTemplate().getWorkResourceIDs();</span>
<span class="nc" id="L2045">					FloatingEventTemplate floatTemplate = getScheduleAccessManager(context).createRecurringFloatingEventException(</span>
<span class="nc" id="L2046">						template.getID(), workResourceIDs, exceptionCreateData.getNewStartDate(), exceptionCreateData.getNewDuration(), </span>
<span class="nc" id="L2047">						floatingStart, floatingEnd, exceptionCreateData.isLocked());</span>
<span class="nc bnc" id="L2048" title="All 2 branches missed.">					if (!exceptionCreateData.isCreateExceptionByLock()) { </span>
						//if locking creates exception, then no attributes change, don't need to update the exception here.
<span class="nc" id="L2050">						FloatingEventTemplate newFloat = (FloatingEventTemplate)exceptionCreateData.getExceptionTemplate();</span>
<span class="nc" id="L2051">						floatTemplate.setInstanceStart(exceptionCreateData.getNewStartDate());</span>
<span class="nc" id="L2052">						floatTemplate.setActivityID(newFloat.getActivityID());</span>
<span class="nc" id="L2053">						floatTemplate.setDescription(newFloat.getDescription());</span>
						
<span class="nc" id="L2055">						Collection newWorkResourceIDs = exceptionCreateData.getNewWorkResourceIDs();</span>
<span class="nc" id="L2056">						Iterator itOldWRIDs = exceptionCreateData.getTemplate().getWorkResourceIDs().iterator();</span>
<span class="nc bnc" id="L2057" title="All 2 branches missed.">						while (itOldWRIDs.hasNext()) {</span>
<span class="nc" id="L2058">							ID nextID = (ID) itOldWRIDs.next();</span>
<span class="nc bnc" id="L2059" title="All 2 branches missed.">							if (!newWorkResourceIDs.contains(nextID)) {</span>
<span class="nc" id="L2060">								floatTemplate.removeWorkResourceID(nextID);</span>
							}
<span class="nc" id="L2062">						}</span>
<span class="nc" id="L2063">						Iterator itNewWRIDs = newWorkResourceIDs.iterator();</span>
<span class="nc bnc" id="L2064" title="All 2 branches missed.">						while (itNewWRIDs.hasNext()) {</span>
<span class="nc" id="L2065">							ID nextID = (ID) itNewWRIDs.next();</span>
<span class="nc bnc" id="L2066" title="All 2 branches missed.">							if (!floatTemplate.getWorkResourceIDs().contains(nextID)) {</span>
<span class="nc" id="L2067">								floatTemplate.addWorkResourceID(nextID);</span>
							}
<span class="nc" id="L2069">						}</span>

<span class="nc bnc" id="L2071" title="All 2 branches missed.">						for (int ix=1;ix&lt;=7; ix++) {				</span>
<span class="nc" id="L2072">							floatTemplate.setWindowDayStartOffset(ix, newFloat.getWindowDayStartOffset(ix));</span>
<span class="nc" id="L2073">							floatTemplate.setWindowDayEndOffset(ix, newFloat.getWindowDayEndOffset(ix));</span>
						}

<span class="nc" id="L2076">						BbmScheduleConflictResolutions conflictResolutions = new BbmScheduleConflictResolutions();</span>
<span class="nc" id="L2077">						floatTemplate.setUpdateUser(context.getUserName());</span>
<span class="nc" id="L2078">						getScheduleAccessManager(context).updateEventTemplateWithInstances(floatTemplate, conflictResolutions);</span>
					}
<span class="nc" id="L2080">					exceptionID = floatTemplate.getID();</span>
				}
<span class="nc" id="L2082">				appletResponse.put(PageKeys.NEW_EXCEPTION_ID, exceptionID);</span>
<span class="pc bpc" id="L2083" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_DELETE_TEMPLATE_EXCEPTION)) {</span>
<span class="nc" id="L2084">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_DELETING_CALENDAREVENT;</span>
<span class="nc" id="L2085">				CalendarEventTemplate template = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE);</span>
<span class="nc" id="L2086">				Date dateToDelete = (Date) appletRequest.get(PageKeys.EVENT_TEMPLATE_DATE_TO_DELETE);</span>
<span class="nc" id="L2087">				getScheduleAccessManager(context).deleteRecurringEventInstance(template.getID(), template.getWorkResourceIDs(), dateToDelete);</span>
<span class="pc bpc" id="L2088" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UPDATE_EVENT_EXTENSIVE)) {</span>
<span class="nc" id="L2089">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT;</span>
				// delete the old event
<span class="nc" id="L2091">				CalendarEventAssignment eventToDelete = (CalendarEventAssignment) appletRequest.get(PageKeys.EVENT_TO_DELETE);</span>
<span class="nc" id="L2092">				ArrayList listOneEventID = new ArrayList(1);</span>
<span class="nc" id="L2093">				listOneEventID.add(eventToDelete.getID());</span>
<span class="nc" id="L2094">				getScheduleAccessManager(context).deleteCalendarEventAssignments(listOneEventID);</span>
				// create the new event
<span class="nc" id="L2096">				CalendarEventAssignment eventToCreate = (CalendarEventAssignment) appletRequest.get(PageKeys.EVENT_TO_CREATE);</span>
<span class="nc" id="L2097">				ID eventID = getScheduleAccessManager(context).createCalendarEventAssignment(eventToCreate);</span>
<span class="nc" id="L2098">				CalendarEventAssignment newlyCreated = getScheduleAccessManager(context).getCalendarEventAssignmentByID(eventID);</span>
<span class="nc" id="L2099">				appletResponse.put(PageKeys.NEW_CALENDAR_EVENT_ASSIGNMENT, newlyCreated);</span>
<span class="pc bpc" id="L2100" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UPDATE_EVENT_TEMPLATE)) {</span>
<span class="nc" id="L2101">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT_TEMPLATE;</span>
<span class="nc" id="L2102">				CalendarEventTemplate templateToUpdate = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_UPDATE);</span>
<span class="nc" id="L2103">				BbmScheduleConflictResolutions conflictResolutionsForUpdate = (BbmScheduleConflictResolutions) appletRequest.get(</span>
					PageKeys.EVENT_TEMPLATE_TO_UPDATE_RESOLUTIONS);
<span class="nc" id="L2105">				getScheduleAccessManager(context).updateEventTemplateWithInstances(templateToUpdate, conflictResolutionsForUpdate);</span>
<span class="pc bpc" id="L2106" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UPDATE_EVENT_TEMPLATE_EXTENSIVE)) {</span>
<span class="nc" id="L2107">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT_TEMPLATE;</span>
				// first delete template
<span class="nc" id="L2109">				CalendarEventTemplate templateToDelete = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_DELETE);</span>
<span class="nc" id="L2110">				getScheduleAccessManager(context).deleteEventTemplateWithInstances(templateToDelete.getID());</span>
				// then create the new template
<span class="nc" id="L2112">				CalendarEventTemplate templateToCreate = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_CREATE);</span>
<span class="nc" id="L2113">				BbmScheduleConflictResolutions conflictResolutionsForCreate = (BbmScheduleConflictResolutions) </span>
<span class="nc" id="L2114">					appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_CREATE_RESOLUTIONS);</span>
<span class="nc" id="L2115">				ID templateID = getScheduleAccessManager(context).createEventTemplateWithInstances(templateToCreate, conflictResolutionsForCreate);</span>
<span class="nc bnc" id="L2116" title="All 2 branches missed.">				if (templateID != null) {</span>
<span class="nc" id="L2117">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_RETRIEVING_CALENDAREVENT_TEMPLATE;</span>
<span class="nc" id="L2118">					CalendarEventTemplate createdTemplate = getScheduleAccessManager(context).getCalendarEventTemplateByID(templateID);</span>
<span class="nc" id="L2119">					appletResponse.put(PageKeys.NEW_CALENDAR_EVENT_TEMPLATE, createdTemplate);</span>
				}
<span class="pc bpc" id="L2121" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CHANGE_EVENT_TEMPLATE_TO_EVENT)) {</span>
<span class="nc" id="L2122">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT;</span>
				// delete the event template
<span class="nc" id="L2124">				CalendarEventTemplate templateToDelete = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_DELETE);</span>
<span class="nc" id="L2125">				getScheduleAccessManager(context).deleteEventTemplateWithInstances(templateToDelete.getID());</span>
				// create the new event
<span class="nc" id="L2127">				CalendarEventAssignment eventToCreate = (CalendarEventAssignment) appletRequest.get(PageKeys.EVENT_TO_CREATE);</span>
<span class="nc bnc" id="L2128" title="All 2 branches missed.">				if (eventToCreate != null) {</span>
<span class="nc" id="L2129">					getScheduleAccessManager(context).createCalendarEventAssignment(eventToCreate);</span>
				}
<span class="pc bpc" id="L2131" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CHANGE_EVENT_TO_EVENT_TEMPLATE)) {</span>
<span class="nc" id="L2132">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT;</span>
				// delete the event
<span class="nc" id="L2134">				CalendarEventAssignment eventToDelete = (CalendarEventAssignment) appletRequest.get(PageKeys.EVENT_TO_DELETE);</span>
<span class="nc" id="L2135">				getScheduleAccessManager(context).deleteCalendarEventAssignments(Collections.singletonList(eventToDelete.getID()));</span>
				// create the new event template
<span class="nc" id="L2137">				CalendarEventTemplate templateToCreate = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_CREATE);</span>
<span class="nc" id="L2138">				BbmScheduleConflictResolutions conflictResolutionsForCreate = (BbmScheduleConflictResolutions) </span>
<span class="nc" id="L2139">					appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_CREATE_RESOLUTIONS);</span>
<span class="nc" id="L2140">				getScheduleAccessManager(context).createEventTemplateWithInstances(templateToCreate, conflictResolutionsForCreate);</span>
<span class="pc bpc" id="L2141" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_SPLIT_EVENT_TEMPLATE)) {</span>
<span class="nc" id="L2142">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT_TEMPLATE;</span>
<span class="nc" id="L2143">				CalendarEventTemplate templateToUpdate = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_UPDATE);</span>
<span class="nc" id="L2144">				BbmScheduleConflictResolutions conflictResolutionsForUpdate = (BbmScheduleConflictResolutions) </span>
<span class="nc" id="L2145">					appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_UPDATE_RESOLUTIONS);</span>
				
				//the split template happens when &quot;From this point on&quot; is chosen when editing the template. one template is created and old template is shortened.
				//First we'll shorten the old template...
<span class="nc" id="L2149">				getScheduleAccessManager(context).updateEventTemplateWithInstances(templateToUpdate, conflictResolutionsForUpdate);</span>
				
<span class="nc" id="L2151">				CalendarEventTemplate templateToCreate = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_CREATE);</span>
<span class="nc" id="L2152">				BbmScheduleConflictResolutions conflictResolutionsForCreate = (BbmScheduleConflictResolutions) </span>
<span class="nc" id="L2153">					appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_CREATE_RESOLUTIONS);</span>
				//Then we'll create the new template...
<span class="nc" id="L2155">				ID templateID = getScheduleAccessManager(context).createEventTemplateWithInstances(templateToCreate, </span>
					conflictResolutionsForCreate);
				
<span class="nc bnc" id="L2158" title="All 2 branches missed.">				if (templateID != null) {</span>
<span class="nc" id="L2159">					CalendarEventTemplate createdTemplate = getScheduleAccessManager(context).getCalendarEventTemplateByID(templateID);</span>
<span class="nc" id="L2160">					appletResponse.put(PageKeys.NEW_CALENDAR_EVENT_TEMPLATE, createdTemplate);</span>
				}
<span class="pc bpc" id="L2162" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UPDATE_AND_DELETE_EVENTS)) {</span>
				// sort the events to delete into a collection of shift assignments and a collection of calendar event assignments
<span class="nc" id="L2164">				boolean someEventChangesSaved = false;</span>
<span class="nc" id="L2165">				Set&lt;ID&gt; setEmpsWithNoPermission = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L2166">				Collection&lt;Event&gt; eventsToDelete = (Collection&lt;Event&gt;) appletRequest.get(PageKeys.EVENTS_TO_DELETE_COLLECTION);</span>
<span class="nc" id="L2167">				Iterator&lt;Event&gt; itEventsToDelete = eventsToDelete.iterator();</span>
<span class="nc" id="L2168">				List&lt;ID&gt; arrayShiftIDsToDelete = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L2169">				List&lt;ID&gt; arrayCalendarEventIDsToDelete = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L2170" title="All 2 branches missed.">				while (itEventsToDelete.hasNext()) {</span>
<span class="nc" id="L2171">					Event nextEventToDelete = itEventsToDelete.next();</span>
<span class="nc" id="L2172">					Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEvent(nextEventToDelete, nextEventToDelete.getStartTime(), </span>
<span class="nc" id="L2173">						nextEventToDelete.getEndTime(), context);</span>
<span class="nc" id="L2174">					Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(</span>
<span class="nc" id="L2175">						nextEventToDelete.getWorkResourceIDs(), mapEmpEditables);</span>
<span class="nc bnc" id="L2176" title="All 4 branches missed.">					if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; !empIDsWithoutPermissionToEditEvent.isEmpty()) {</span>
<span class="nc" id="L2177">						setEmpsWithNoPermission.addAll(empIDsWithoutPermissionToEditEvent);</span>
					} else {
<span class="nc bnc" id="L2179" title="All 2 branches missed.">						if (nextEventToDelete instanceof ShiftAssignment) {</span>
<span class="nc" id="L2180">							arrayShiftIDsToDelete.add(nextEventToDelete.getID());</span>
<span class="nc bnc" id="L2181" title="All 2 branches missed.">						} else if (nextEventToDelete instanceof CalendarEventAssignment) {</span>
<span class="nc" id="L2182">							arrayCalendarEventIDsToDelete.add(nextEventToDelete.getID());</span>
						} else {
							// TYLER - we need to log and/or throw an exception here
<span class="nc" id="L2185">							msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_DELETING_UNKNOWNTYPE;</span>
<span class="nc" id="L2186">							appletResponse.put(PageKeys.APPLET_ERROR, &quot;Delete request made for unsupported event type &quot; </span>
<span class="nc" id="L2187">								+ nextEventToDelete.getClass() + &quot;.&quot;);</span>
<span class="nc" id="L2188">							return;</span>
						}
					}
<span class="nc" id="L2191">				}</span>
				// delete the shift assignments and calendar events
<span class="nc bnc" id="L2193" title="All 2 branches missed.">				if (!arrayShiftIDsToDelete.isEmpty()) {</span>
<span class="nc" id="L2194">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_DELETING_SHIFTASSIGNMENT;</span>
<span class="nc" id="L2195">					getScheduleAccessManager(context).deleteShiftAssignments(arrayShiftIDsToDelete);</span>
<span class="nc" id="L2196">					someEventChangesSaved = true;</span>
				}
<span class="nc bnc" id="L2198" title="All 2 branches missed.">				if (!arrayCalendarEventIDsToDelete.isEmpty()) {</span>
<span class="nc" id="L2199">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_DELETING_CALENDAREVENT;</span>
<span class="nc" id="L2200">					getScheduleAccessManager(context).deleteCalendarEventAssignments(arrayCalendarEventIDsToDelete);</span>
<span class="nc" id="L2201">					someEventChangesSaved = true;</span>
				}

<span class="nc" id="L2204">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_EVENTS;</span>
<span class="nc" id="L2205">				Collection&lt;Event&gt; eventsToChange = (Collection&lt;Event&gt;) appletRequest.get(PageKeys.EVENTS_TO_UPDATE_COLLECTION);</span>
<span class="nc bnc" id="L2206" title="All 2 branches missed.">				if(eventsToChange != null) {</span>
<span class="nc" id="L2207">					Iterator&lt;Event&gt; itEventsToUpdate = eventsToChange.iterator();</span>
<span class="nc" id="L2208">					List&lt;Event&gt; changedEvents = new ArrayList&lt;Event&gt;(eventsToChange.size());</span>
<span class="nc bnc" id="L2209" title="All 2 branches missed.">					while (itEventsToUpdate.hasNext()) {</span>
<span class="nc" id="L2210">						Event nextEventObj = itEventsToUpdate.next();</span>
<span class="nc" id="L2211">						Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEvent(nextEventObj, </span>
<span class="nc" id="L2212">							nextEventObj.getStartTime(), nextEventObj.getEndTime(), context);</span>
<span class="nc" id="L2213">						Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(</span>
<span class="nc" id="L2214">							nextEventObj.getWorkResourceIDs(), mapEmpEditables);</span>
<span class="nc bnc" id="L2215" title="All 4 branches missed.">						if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; !empIDsWithoutPermissionToEditEvent.isEmpty()) {</span>
<span class="nc" id="L2216">							setEmpsWithNoPermission.addAll(empIDsWithoutPermissionToEditEvent);</span>
						} else {
<span class="nc bnc" id="L2218" title="All 2 branches missed.">							if (nextEventObj instanceof ShiftAssignment) {</span>
<span class="nc" id="L2219">								msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_SHIFTASSIGNMENT;</span>
<span class="nc" id="L2220">								ShiftAssignment shift = ((ShiftAssignment)nextEventObj);</span>
<span class="nc" id="L2221">								removeOTEventHolderBeforeSave(shift);</span>
<span class="nc" id="L2222">								shift.setUpdateUser(context.getUserName());</span>
<span class="nc" id="L2223">								getScheduleAccessManager(context).updateShiftAssignment(shift);</span>
<span class="nc" id="L2224">								changedEvents.add(getScheduleAccessManager(context).getShiftAssignmentByID(shift.getID()));</span>
<span class="nc" id="L2225">								someEventChangesSaved = true;</span>
<span class="nc bnc" id="L2226" title="All 2 branches missed.">							} else if (nextEventObj instanceof CalendarEventAssignment) {</span>
<span class="nc" id="L2227">								msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT;</span>
<span class="nc" id="L2228">								((CalendarEventAssignment) nextEventObj).setUpdateUser(context.getUserName());</span>
<span class="nc" id="L2229">								getScheduleAccessManager(context).updateCalendarEventAssignment((CalendarEventAssignment) nextEventObj);</span>
<span class="nc" id="L2230">								changedEvents.add(getScheduleAccessManager(context).getCalendarEventAssignmentByID((</span>
<span class="nc" id="L2231">									(CalendarEventAssignment) nextEventObj).getID()));</span>
<span class="nc" id="L2232">								someEventChangesSaved = true;</span>
							} else {
								// TYLER - we need to log and/or throw an exception here
<span class="nc" id="L2235">								msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_UNKNOWNTYPE;</span>
<span class="nc" id="L2236">								handleExpectedError(context, appletResponse, msgID, params);</span>
<span class="nc" id="L2237">								return;</span>
							}
						}
<span class="nc" id="L2240">					}</span>
<span class="nc" id="L2241">					addResponseData(changedEvents, appletResponse);</span>
				}				
				// if there were events that could not be updated because of permissions, let the user know
<span class="nc bnc" id="L2244" title="All 2 branches missed.">				if (!setEmpsWithNoPermission.isEmpty()) {</span>
<span class="nc" id="L2245">					params = new Object[] {new Integer(setEmpsWithNoPermission.size())};</span>
<span class="nc bnc" id="L2246" title="All 2 branches missed.">					if (someEventChangesSaved) {</span>
<span class="nc" id="L2247">						msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_SOMECHANGED;</span>
					} else {
<span class="nc" id="L2249">						msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_NONECHANGED;</span>
					}
<span class="nc" id="L2251">					handleExpectedError(context, appletResponse, msgID, params);</span>
				}
<span class="pc bfc" id="L2253" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_SAVE_SCHEDULINGPARAMS)) {</span>
<span class="fc" id="L2254">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_SAVING_SCHEDULINGPARAMS;</span>
<span class="fc" id="L2255">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L2256">				Map parameters = (Map) appletRequest.get(PageKeys.SP_SCHEDULINGPARAMS);</span>
<span class="fc" id="L2257">				String empIDs = (String) appletRequest.get(PageKeys.SP_SCHEDULINGPARAMS_EMPIDSTRING);</span>
<span class="pc bpc" id="L2258" title="1 of 2 branches missed.">				if (empIDs == null) {</span>
<span class="nc" id="L2259">					empIDs = &quot;&quot;;</span>
				}
<span class="fc" id="L2261">				getCampaignManager(context).setSchedulingParameters(spID, parameters, empIDs);</span>
<span class="pc bpc" id="L2262" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_START_RECALC)) {</span>
<span class="nc" id="L2263">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REQUESTING_RECALC;</span>
<span class="nc" id="L2264">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L2265">				Boolean isEnableLQF = (Boolean)appletRequest.get(FsKeys.IS_ENABLE_LQF);</span>
<span class="nc" id="L2266">				Boolean isRecalcSubCampaign = (Boolean)appletRequest.get(FsKeys.IS_RECALC_SUB_CAMPAIGNS);</span>
				// recalcscheduling error code : 1 - success, 2 - adapter error , 4 - no adapter configured
<span class="nc" id="L2268">				int errorCode = getFacadeCorbaFacadeManager().recalcScheduling(</span>
<span class="nc" id="L2269">						UserCacheManager.getInstance().getCachedUserName(context),</span>
<span class="nc" id="L2270">						getUserManager(context).generateToken(UserCacheManager.getInstance().getCachedUserSeal(context)),</span>
<span class="nc" id="L2271">						context.isInWhatIfMode(),</span>
<span class="nc" id="L2272">						1, spID, isEnableLQF, isRecalcSubCampaign,null);</span>
<span class="nc" id="L2273">				appletResponse.put(PageKeys.CALENDAR_APPLET_GET_RECALC_SCHEDULING_ERROR_CODE, new Integer(errorCode));</span>
<span class="pc bfc" id="L2274" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_START_SCHEDULE)) {</span>
<span class="fc" id="L2275">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CLEARING_SCHEDULES;</span>
<span class="fc" id="L2276">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L2277">				Boolean isEnableLQF = (Boolean)appletRequest.get(FsKeys.IS_ENABLE_LQF);</span>
<span class="fc" id="L2278">				String modeChar = (String)appletRequest.get(FsKeys.MODE_CHAR);</span>
<span class="fc" id="L2279">				String[] deiParams = (String[])appletRequest.get(FsKeys.SCHEDULE_DEI_PARAMS);</span>
				// recalcscheduling error code : 1 - success, 2 - adapter error , 4 - no adapter configured
<span class="fc" id="L2281">				int errorCode = 1; </span>
<span class="pc bpc" id="L2282" title="1 of 2 branches missed.">				if (modeChar.equals(&quot;S&quot;)) {</span>
<span class="fc" id="L2283">					errorCode = getFacadeCorbaFacadeManager().recalcScheduling(</span>
<span class="fc" id="L2284">						UserCacheManager.getInstance().getCachedUserName(context),</span>
<span class="fc" id="L2285">						getUserManager(context).generateToken(UserCacheManager.getInstance().getCachedUserSeal(context)),</span>
<span class="fc" id="L2286">						context.isInWhatIfMode(),</span>
<span class="fc" id="L2287">						2, spID, isEnableLQF, false,deiParams);</span>
				} else {
					//analyzing
<span class="nc" id="L2290">					errorCode = getFacadeCorbaFacadeManager().recalcScheduling(</span>
<span class="nc" id="L2291">						UserCacheManager.getInstance().getCachedUserName(context),</span>
<span class="nc" id="L2292">						getUserManager(context).generateToken(UserCacheManager.getInstance().getCachedUserSeal(context)),</span>
<span class="nc" id="L2293">						context.isInWhatIfMode(),</span>
<span class="nc" id="L2294">						3, spID, isEnableLQF, false, deiParams);</span>
				}
<span class="fc" id="L2296">				appletResponse.put(PageKeys.CALENDAR_APPLET_GET_RECALC_SCHEDULING_ERROR_CODE, new Integer(errorCode));</span>
<span class="fc bfc" id="L2297" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, FsKeys.ACTION_PUBLISH_COMPLETE)) {</span>
<span class="fc" id="L2298">				Collection workResourceIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L2299">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L2300">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L2301">				getScheduleAccessManager(context).notifyPublishComplete(workResourceIDs, startDate, endDate, true);</span>
<span class="fc bfc" id="L2302" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_PUBLISH)) {</span>
<span class="fc" id="L2303">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_PUBLISHING_SCHEDULES;</span>
<span class="fc" id="L2304">				String publishingErrorMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_PUBLISHING_CHUNK;</span>
<span class="fc" id="L2305">				String someFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_PUBLISHING_SOME;</span>
<span class="fc" id="L2306">				String allFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_PUBLISHING_ALL;</span>
<span class="fc" id="L2307">				doPublish(context, appletRequest, appletResponse, PUBLISH, publishingErrorMsgID, allFailedMsgID, someFailedMsgID);</span>
<span class="pc bpc" id="L2308" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UNPUBLISH)) {</span>
<span class="nc" id="L2309">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_SCHEDULES;</span>
<span class="nc" id="L2310">				String unpublishingErrorMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_CHUNK;</span>
<span class="nc" id="L2311">				String someFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_SOME;</span>
<span class="nc" id="L2312">				String allFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_ALL;</span>
<span class="nc" id="L2313">				doPublish(context, appletRequest, appletResponse, UNPUBLISH, unpublishingErrorMsgID, allFailedMsgID, someFailedMsgID);</span>
<span class="pc bpc" id="L2314" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_REVERTTOPUBLISHED)) {</span>
<span class="nc" id="L2315">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_SCHEDULES;</span>
<span class="nc" id="L2316">				String revertToPublishErrorMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REVERTTOPUBLISHED_CHUNK;</span>
<span class="nc" id="L2317">				String someFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REVERTTOPUBLISHED_SOME;</span>
<span class="nc" id="L2318">				String allFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REVERTTOPUBLISHED_ALL;</span>
<span class="nc" id="L2319">				doPublish(context, appletRequest, appletResponse, REVERT_TO_PUBLISHED, revertToPublishErrorMsgID, </span>
					allFailedMsgID, someFailedMsgID);
<span class="pc bpc" id="L2321" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_WORKPATTERNSET)) {</span>
				//never used in GIT History
<span class="pc bpc" id="L2323" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UPDATE_WORKPATTERNSET)) {</span>
				//never used in GIT HISTORY
<span class="pc bpc" id="L2325" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CLEAR_SCHEDULES)) {</span>
<span class="nc" id="L2326">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CLEARING_SCHEDULES;</span>
<span class="nc" id="L2327">				Collection&lt;ID&gt; employees = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L2328">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L2329">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L2330">				Collection&lt;ID&gt; spIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc bnc" id="L2331" title="All 2 branches missed.">				for( ID spID: spIDs)</span>
<span class="nc" id="L2332">					getScheduleAccessManager(context).deleteShiftAssignments(employees, startDate, endDate, spID, false); </span>
				//ID spID, boolean unlockedOnly, boolean byStartTime
<span class="pc bpc" id="L2334" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_REMOVE_PROFILE_SCHEDULES)) {</span>
<span class="nc" id="L2335">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CLEARING_SCHEDULES;</span>
<span class="nc" id="L2336">				Collection&lt;ID&gt; phantomIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L2337">				getScheduleAccessManager(context).deletePhantoms(phantomIDs);</span>
<span class="pc bpc" id="L2338" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_IMPORT_PROFILES)) {</span>
<span class="nc" id="L2339">				msgID = FsWebBundleKey.FS_CAL_IMPORT_OUTSOURCER;</span>
<span class="nc" id="L2340">				ID orgID = (ID) appletRequest.get(PageKeys.ORG_ID);</span>
<span class="nc" id="L2341">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L2342">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L2343">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L2344">				int ret = getFacadeCorbaFacadeManager().importOutsourcerStaffingProfiles(orgID, campaignID, startDate, endDate);</span>

<span class="nc" id="L2346">				Integer intRet = new Integer(ret);</span>
<span class="nc" id="L2347">				appletResponse.put(PageKeys.GET_IMPORT_RESULT, intRet);</span>
<span class="pc bpc" id="L2348" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_LOCK_MULTIPLE)) {</span>
<span class="nc" id="L2349">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_LOCKING_EVENTS;</span>
<span class="nc" id="L2350">				Integer eventMask = (Integer) appletRequest.get(PageKeys.LOCKUNLOCK_EVENT_MASK);</span>
<span class="nc" id="L2351">				Collection employees = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L2352">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L2353">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L2354">				getScheduleAccessManager(context).lockEvents(eventMask.intValue(), employees, startDate, endDate);</span>
<span class="pc bpc" id="L2355" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UNLOCK_MULTIPLE)) {</span>
<span class="nc" id="L2356">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNLOCKING_EVENTS;</span>
<span class="nc" id="L2357">				Integer eventMask = (Integer) appletRequest.get(PageKeys.LOCKUNLOCK_EVENT_MASK);</span>
<span class="nc" id="L2358">				Collection employees = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L2359">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L2360">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L2361">				getScheduleAccessManager(context).unlockEvents(eventMask.intValue(), employees, startDate, endDate);</span>
<span class="pc bpc" id="L2362" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_PHANTOM)) {</span>
<span class="nc" id="L2363">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATE_PHANTOM;</span>
<span class="nc" id="L2364">				Collection employees = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L2365">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L2366">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
				
<span class="nc" id="L2368">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L2369">				List&lt;SchedulingPeriod&gt; sps = (List&lt;SchedulingPeriod&gt;) getCampaignManager(context).getSchedulingPeriods(campaignID, </span>
					startDate, endDate);
				//in the period only one sp is expected
<span class="nc bnc" id="L2372" title="All 2 branches missed.">				if(sps.size()==1){</span>
<span class="nc" id="L2373">					Collection newPhantomIDs = getScheduleAccessManager(context).createPhantoms(employees, </span>
<span class="nc" id="L2374">						sps.get(0).getID(), startDate, endDate);</span>
<span class="nc bnc" id="L2375" title="All 2 branches missed.">					newPhantomIDs = newPhantomIDs instanceof ArrayList ?  newPhantomIDs : new ArrayList(newPhantomIDs); </span>
					//need to make sure it's a list
<span class="nc" id="L2377">					appletResponse.put(PageKeys.PHANTOM_IDS, newPhantomIDs);</span>
				}
<span class="pc bpc" id="L2379" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_SEND_SCHEDULE_REQUEST)) {</span>
<span class="nc" id="L2380">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REQUESTING_SCHEDULE;</span>
<span class="nc" id="L2381">				SchedulingRequest request = (SchedulingRequest) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULING_REQUEST);</span>
<span class="nc" id="L2382">				getCampaignManager(context).makeSchedulingRequest(request);</span>
<span class="pc bfc" id="L2383" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CLEAR_SCHEDULE_REQUEST_SESSION_AND_STATE)) {</span>
<span class="fc" id="L2384">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CLEARING_SCHEDULE_REQUEST;</span>
<span class="fc" id="L2385">				SchedulingRequest request = (SchedulingRequest) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULING_REQUEST);</span>
<span class="fc" id="L2386">				clearScheduleRequestSessionAndState(request, getCampaignManager(context));</span>
<span class="pc bpc" id="L2387" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageKeys.DELETE_SCHEDULE_WARNINGS)) {</span>
<span class="nc" id="L2388">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;</span>
<span class="nc" id="L2389">				Collection warningIDs = (Collection) appletRequest.get(PageKeys.SCHEDULEWARNING_IDS);</span>
<span class="nc" id="L2390">				getCampaignManager(context).clearSchedulingStateWarnings(warningIDs);</span>
<span class="pc bfc" id="L2391" title="All 2 branches covered.">			} else if(isAppletAction(appletRequest, PageKeys.CALENDAR_APPLET_GET__LOCALE_ID_FOR_DEI)) {</span>
<span class="fc" id="L2392">				String userLocale = (String) appletRequest.get(PageKeys.USER_LOCALE);</span>
<span class="fc" id="L2393">				String userRegLocale = (String) appletRequest.get(PageKeys.USER_REG_LOCALE);</span>
<span class="fc" id="L2394">				DBConfigManager configMgr = getDBManager(context);</span>
<span class="fc" id="L2395">				String supportedLangKey = &quot;SupportedRegionalFormats&quot;;</span>
<span class="fc" id="L2396">				String supportedLangIDKey = &quot;SupportedRegionalFormatLocaleIDs&quot;;</span>
<span class="fc" id="L2397">				String supportedLangValue = configMgr.getValue(supportedLangKey);</span>
<span class="fc" id="L2398">				String supportedLangIDsValue = configMgr.getValue(supportedLangIDKey);</span>
<span class="fc" id="L2399">				Map localeMap = new HashMap(0);</span>
<span class="fc" id="L2400">				localeMap.put(supportedLangKey, supportedLangValue);</span>
<span class="fc" id="L2401">				localeMap.put(supportedLangIDKey, supportedLangIDsValue);</span>
<span class="fc" id="L2402">				String localeID = getLocaleID(userLocale, localeMap);</span>
<span class="fc" id="L2403">				String regLocaleID = getLocaleID(userRegLocale, localeMap);</span>
<span class="fc" id="L2404">				appletResponse.put(PageKeys.USER_LOCALE_ID, localeID);</span>
<span class="fc" id="L2405">				appletResponse.put(PageKeys.USER_REG_LOCALE_ID, regLocaleID);</span>
<span class="fc" id="L2406">			}</span>

			// ================= text applet support starts =======================
<span class="pc bpc" id="L2409" title="1 of 2 branches missed.">			else if (isAppletAction(appletRequest, FsKeys.TEXTAPPLET_CALENDAR_REPUBLISH)) {</span>
				//GET SP ID FROM TEXT APPLET CALL, IT SHOULD BE SID OF SP
<span class="nc" id="L2411">				String str = (String)appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L2412">				ID spID = new ID(str);</span>
<span class="nc" id="L2413">				str = (String)appletRequest.get(FsKeys.TEXTAPPLET_CALENDAR_PUBLISH_ONLY);</span>
<span class="nc" id="L2414">				boolean doPublishOnly = new Boolean(str);</span>
				
<span class="nc bnc" id="L2416" title="All 2 branches missed.">				if (spID != null) {</span>
<span class="nc" id="L2417">					SchedulingPeriod sp = this.getCampaignManager(context).getSchedulingPeriodByID(spID);</span>
					//get employee ids in this SP
<span class="nc" id="L2419">					Filter filter = Filter.createAllCurrentFilter(context.getUser().getID());</span>

<span class="nc" id="L2421">					List sortFlds = new ArrayList();</span>
<span class="nc" id="L2422">					sortFlds.add(NumberFactory.newInteger(Filter.LASTNAME));</span>
					
<span class="nc" id="L2424">					Collection employeeIDs =  getEmployeeFilterManager(context).getEmployeeIDs(filter, context.getUser(), </span>
						sortFlds, true, 0, Integer.MAX_VALUE,false, spID);
					
<span class="nc" id="L2427">					appletRequest.put(PageKeys.EMPLOYEE_IDS, employeeIDs);</span>
<span class="nc" id="L2428">					appletRequest.put(PageKeys.START_DATE, sp.getStartTime());</span>
<span class="nc" id="L2429">					appletRequest.put(PageKeys.END_DATE, sp.getEndTime());</span>
<span class="nc" id="L2430">					appletRequest.put(PageKeys.PUBLISH_TIMEOFF_ONLY, Boolean.FALSE);</span>
				}

				//un-publish for all
<span class="nc" id="L2434">				String unpublishingErrorMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_CHUNK;</span>
<span class="nc" id="L2435">				String someFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_SOME;</span>
<span class="nc" id="L2436">				String allFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_ALL;</span>
<span class="nc bnc" id="L2437" title="All 2 branches missed.">				if(!doPublishOnly){</span>
<span class="nc" id="L2438">					doPublish(context, appletRequest, appletResponse, UNPUBLISH, unpublishingErrorMsgID, allFailedMsgID, someFailedMsgID);</span>
				}
				//publish for all
<span class="nc" id="L2441">				String publishingErrorMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_PUBLISHING_CHUNK;</span>
<span class="nc" id="L2442">				doPublish(context, appletRequest, appletResponse, PUBLISH, publishingErrorMsgID, allFailedMsgID, someFailedMsgID);				</span>
<span class="pc bpc" id="L2443" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, FsKeys.TEXTAPPLET_CALENDAR_UPDATEEMPSCHEDULE)) {</span>
				//get employee shifts in one sp and then save it without change
<span class="nc" id="L2445">				String str = (String)appletRequest.get(PageKeys.EMPLOYEE_IDS); </span>
				//return single employee id
<span class="nc" id="L2447">				ID empID = new ID(str);</span>
<span class="nc" id="L2448">				str = (String)appletRequest.get(PageKeys.START_DATE); </span>
				//time in milliseconds
<span class="nc" id="L2450">				Date start = TextAppletIO.convertToDate(str); </span>
<span class="nc" id="L2451">				str = (String)appletRequest.get(PageKeys.END_DATE); </span>
				//time in milliseconds
<span class="nc" id="L2453">				Date end = TextAppletIO.convertToDate(str); </span>

				//get shifts for employee 
<span class="nc" id="L2456">				Collection shifts = getScheduleAccessManager(context).getEventsForWorkResourceByType(Event.EVENT_TYPE_SHIFT_ASSIGNMENT, </span>
					empID, start, end);

				//update shifts for employee
<span class="nc" id="L2460">				ShiftAssignment event = null;</span>
<span class="nc bnc" id="L2461" title="All 2 branches missed.">				for (Iterator i = shifts.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L2462">					event = (ShiftAssignment)i.next();</span>
<span class="nc" id="L2463">					event.setUpdateUser(context.getUserName());</span>
<span class="nc" id="L2464">					getScheduleAccessManager(context).updateShiftAssignment(event);</span>
				}
<span class="pc bpc" id="L2466" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, FsKeys.TEXTAPPLET_CALENDAR_OPENCAMPAIGN)) {</span>
				//GET SP ID FROM TEXT APPLET CALL, IT SHOULD BE SID OF SP
<span class="nc" id="L2468">				String str = (String)appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L2469">				ID spID = new ID(str);</span>
				//get employee ids in this SP
<span class="nc" id="L2471">				Filter filter = Filter.createAllCurrentFilter(context.getUser().getID());</span>

<span class="nc" id="L2473">				List sortFlds = new ArrayList();</span>
<span class="nc" id="L2474">				sortFlds.add(NumberFactory.newInteger(Filter.LASTNAME));</span>
				
<span class="nc" id="L2476">				Collection employeeIDs =  getEmployeeFilterManager(context).getEmployeeIDs(filter, context.getUser(), sortFlds, </span>
					true, 0, Integer.MAX_VALUE,false, spID);
<span class="nc" id="L2478">				SchedulingPeriod sp = this.getCampaignManager(context).getSchedulingPeriodByID(spID);</span>
				//basic data fetch 
<span class="nc" id="L2480">				loadBasicForCalendar(context, sp, employeeIDs, sp.getStartTime(), sp.getEndTime());</span>

<span class="pc bpc" id="L2482" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, FsKeys.TEXTAPPLET_CALENDAR_OPENORG)) {</span>
<span class="nc" id="L2483">				String str = (String)appletRequest.get(PageKeys.EMP_FILTER);</span>
<span class="nc" id="L2484">				Filter filter = this.getEmployeeFilterManager(context).getFilterByName(context.getUser().getID(), str);</span>
<span class="nc" id="L2485">				Collection employeeIDs = getEmployeeIDsByFilter(context, context.getUser(), null, filter);</span>

<span class="nc" id="L2487">				str = (String)appletRequest.get(PageKeys.START_DATE); </span>
				//time in milliseconds
<span class="nc" id="L2489">				Date start = TextAppletIO.convertToDate(str); </span>
<span class="nc" id="L2490">				str = (String)appletRequest.get(PageKeys.END_DATE); </span>
				//time in milliseconds
<span class="nc" id="L2492">				Date end = TextAppletIO.convertToDate(str);</span>

				//basic data fetch
<span class="nc" id="L2495">				loadBasicForCalendar(context,null, employeeIDs, start, end);</span>

<span class="pc bpc" id="L2497" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, FsKeys.TEXTAPPLET_CALENDAR_SCHEDULE)) {</span>
				//GET SP ID FROM TEXT APPLET CALL, IT SHOULD BE SID OF SP
<span class="nc" id="L2499">				String str = (String)appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L2500">				ID spID = new ID(str);</span>
				//call integration server to schedule
				//QC115821:Change implementation of performance API for calendar on the web to create a different dei file
<span class="nc" id="L2503">				String[] deiParams = new String[6];</span>
<span class="nc" id="L2504">				deiParams[0] = &quot;en_US&quot;; //default user locale</span>
<span class="nc" id="L2505">				deiParams[1] = &quot;1033&quot;; //default user locale id</span>
<span class="nc" id="L2506">				deiParams[2] = &quot;en_US&quot;; //default regional locale</span>
<span class="nc" id="L2507">				deiParams[3] = &quot;1033&quot;; //default regLocale id</span>
<span class="nc" id="L2508">				deiParams[4] = &quot;true&quot;; //ignoreInitialWarnings for text api</span>
<span class="nc" id="L2509">				deiParams[5] = &quot;true&quot;; //ignoreSecondaryWarnings for text api</span>
<span class="nc" id="L2510">				getFacadeCorbaFacadeManager().recalcScheduling(UserCacheManager.getInstance().getCachedUserName(context),</span>
<span class="nc" id="L2511">						getUserManager(context).generateToken(UserCacheManager.getInstance().getCachedUserSeal(context)),</span>
<span class="nc" id="L2512">						context.isInWhatIfMode(),2, spID, false,false, deiParams);</span>
				//wait till it is end
<span class="nc" id="L2514">				boolean isDone = false;</span>
				
<span class="nc" id="L2516">				int pollingInterval = getPollingInterval();</span>
				
<span class="nc" id="L2518">				int progress = 0;</span>
<span class="nc" id="L2519">				int count = 0;</span>
<span class="nc bnc" id="L2520" title="All 2 branches missed.">				while (!isDone) {</span>
<span class="nc" id="L2521">					SchedulingState state = getCampaignManager(context).getSchedulingState(spID, &quot;S&quot;);</span>
<span class="nc bnc" id="L2522" title="All 2 branches missed.">					if (state != null) {</span>
<span class="nc" id="L2523">						progress = state.getOverallStatus();</span>
<span class="nc bnc" id="L2524" title="All 2 branches missed.">						if (progress == 100) {</span>
							//show done button on process dialog
<span class="nc" id="L2526">							appletResponse.put(FsKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L2527">							return;</span>
						}
						
					} else {
						//count the number of times scheduling state is null
<span class="nc" id="L2532">						count++;</span>
					}
					
<span class="nc bnc" id="L2535" title="All 2 branches missed.">					if (count &lt; 40) {</span>
						try {
							//We should never sleep on the server side!
<span class="nc" id="L2538">							Thread.sleep(pollingInterval*1000);</span>
<span class="nc" id="L2539">						} catch (Exception ex) {</span>
							//ignore
<span class="nc" id="L2541">						}</span>
					} else{
						//exit the loop when the scheduling state is null for 40 times
<span class="nc" id="L2544">						return;</span>
					}
<span class="nc" id="L2546">				}</span>
				
<span class="pc bpc" id="L2548" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, FsKeys.TEXTAPPLET_CALENDAR_SERVICELEVEL_RIBBONS)) { </span>
<span class="nc" id="L2549">				String str = (String)appletRequest.get(PageKeys.START_DATE);</span>
				//time in milliseconds
<span class="nc" id="L2551">				Date startDate = TextAppletIO.convertToDate(str);</span>
				
<span class="nc" id="L2553">				str = (String)appletRequest.get(PageKeys.END_DATE); </span>
				//time in milliseconds
<span class="nc" id="L2555">				Date endDate = TextAppletIO.convertToDate(str);</span>
				
<span class="nc" id="L2557">				str = (String)appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L2558">				ID spID = new ID(str);</span>
<span class="nc" id="L2559">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_STATISTIC_RIBBONS;</span>
				
<span class="nc" id="L2561">				getServiceLevelRibbons(context, appletResponse, spID, startDate, endDate);</span>
<span class="pc bpc" id="L2562" title="1 of 2 branches missed.">			}else if (isAppletAction(appletRequest, PageAction.ACTION_SAVE_FTE_CALC_INPUTS)) {</span>
<span class="nc" id="L2563">				SP sp = (SP) appletRequest.get(PageKeys.SP_SCHEDULINGPARAMS);</span>
<span class="nc" id="L2564">				getCampaignManager(context).updateRealSP(sp);</span>
<span class="pc bfc" id="L2565" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, FsKeys.CLEAR_SCHEDULE_STATE)) {</span>
<span class="fc" id="L2566">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;</span>
<span class="fc" id="L2567">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L2568">				String modeChar = (String)appletRequest.get(FsKeys.MODE_CHAR);	</span>
<span class="fc" id="L2569">				getCampaignManager(context).clearSchedulingState(spID, modeChar);</span>
<span class="fc bfc" id="L2570" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_SET_BASE_FORECAST)) {</span>
<span class="fc" id="L2571">				Collection spQueueSIDs = (Collection)appletRequest.get(PageKeys.SPQUEUE_SIDS);</span>
<span class="fc" id="L2572">				SchedulingPeriod sp = (SchedulingPeriod)appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD);</span>
<span class="fc" id="L2573">				String name = context.getLocalizer().i18n(ForecastingWebBundleKey.BUNDLE_NAME, </span>
					ForecastingWebBundleKey.BASE_FORECAST_INSTANCE_NAME);
<span class="fc" id="L2575">				getForecastManager(context).saveActiveForecastAsBase(name, spQueueSIDs, sp);</span>
			}

<span class="nc" id="L2578">		} catch (RuntimeException e) {</span>
<span class="nc" id="L2579">			TimeZone tz = null;</span>
<span class="nc" id="L2580">			String sTZ = (String)appletRequest.get(FsKeys.EXPORTSCHED_VIEWTIMEZONE);</span>
<span class="nc bnc" id="L2581" title="All 2 branches missed.">			if (sTZ != null) {</span>
<span class="nc" id="L2582">				tz = TimeZone.getTimeZone(sTZ);</span>
			}
<span class="nc" id="L2584">			handleUnexpectedError(context, appletResponse, locale, e, msgID, params, tz);</span>
<span class="nc" id="L2585">		} catch (Exception e) {</span>
<span class="nc" id="L2586">			TimeZone tz = null;</span>
<span class="nc" id="L2587">			String sTZ = (String)appletRequest.get(FsKeys.EXPORTSCHED_VIEWTIMEZONE);</span>
<span class="nc bnc" id="L2588" title="All 2 branches missed.">			if (sTZ != null) {</span>
<span class="nc" id="L2589">				tz = TimeZone.getTimeZone(sTZ);</span>
			}
<span class="nc" id="L2591">			handleExpectedError(context, appletResponse, locale, e, msgID, params, tz);</span>
<span class="pc" id="L2592">		}</span>
<span class="fc" id="L2593">	}</span>

	/**
	 * Removes scheduling request, session, and state entries for the specified SP.  If any such
	 * entries are not found, that entry type is skipped silently and the rest are cleared.
	 */
	private void clearScheduleRequestSessionAndState(SchedulingRequest request, CampaignManager campaignManager)
			throws RemoteException {
		try {
<span class="fc" id="L2602">			campaignManager.clearSchedulingRequest(request);</span>
<span class="nc" id="L2603">		} catch (BbmRemoveException bre) {</span>
			// We don't care if there wasn't anything to clear.
<span class="fc" id="L2605">		}</span>
		
		try {
<span class="fc" id="L2608">			campaignManager.clearSPScheduleSession(request.getSPSID());</span>
<span class="nc" id="L2609">		} catch (BbmFinderException bfe) {</span>
			// We don't care if there wasn't anything to clear.
<span class="nc" id="L2611">		} catch (BbmRemoveException bre) {</span>
			// We don't care if there wasn't anything to clear.
<span class="pc" id="L2613">		}</span>
		
		try {
<span class="fc" id="L2616">			campaignManager.clearSchedulingState(request.getSPSID(), request.getMode());</span>
<span class="nc" id="L2617">		} catch (BbmRemoveException bre) {</span>
			// We don't care if there wasn't anything to clear.
<span class="fc" id="L2619">		}</span>
<span class="fc" id="L2620">	}</span>

	@Override
	protected void convertToDefaultIO(Map appletRequest, AppletIO io) {
<span class="nc" id="L2624">		super.convertToDefaultIO(appletRequest, io);</span>
<span class="nc" id="L2625">	}</span>

	private void loadBasicForCalendar(RequestContext context, SchedulingPeriod sp, Collection&lt;ID&gt; empIDs, Date startDate, Date endDate)
			throws Exception {
<span class="nc" id="L2629">		getCampaignManager(context).getCampaigns();</span>
<span class="nc" id="L2630">		Collection allOrgs = getWorkResourceManager(context).getOrganizations(null);</span>

<span class="nc bnc" id="L2632" title="All 2 branches missed.">		if (sp == null) {</span>
			//load shifts
<span class="nc" id="L2634">			ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context).getShifts(empIDs, startDate, endDate));</span>
			//load activities
<span class="nc" id="L2636">			ActivityManager m_activityManager = getActivityManager(context);</span>
<span class="nc" id="L2637">			ActivityFilter activityOrganizationFilter = new ActivityFilter();</span>
<span class="nc" id="L2638">			Collection activities = m_activityManager.findActivities(activityOrganizationFilter);</span>
			//shift ot
<span class="nc" id="L2640">			getWorkRuleManager(context).getShiftOTExtension(empIDs, startDate, endDate);</span>
<span class="nc" id="L2641">		} else {</span>
<span class="nc" id="L2642">			getCampaignManager(context).getShift(sp.getCampaignID(), startDate, endDate);</span>
			
			//load activities
<span class="nc" id="L2645">			Collection&lt;ID&gt; campaignOrgIDs = getCampaignManager(context).getOrganizationsForCampaign(sp.getCampaignID(), startDate, endDate);</span>
<span class="nc" id="L2646">			ValueObjectUtil.getIDObjectMap(getActivityManager(context).findOrganizationActivities(campaignOrgIDs, true));</span>
			//load sps
<span class="nc" id="L2648">			Campaign campaign = getCampaignManager(context).getCampaignByID(sp.getCampaignID());</span>
<span class="nc" id="L2649">			getCampaignManager(context).getSchedulingPeriods(campaign);</span>
			//campaign hoo
<span class="nc" id="L2651">			getCampaignManager(context).getCampaignHOOAssignments(sp.getCampaignID(), startDate, endDate);</span>
<span class="nc" id="L2652">			getCampaignManager(context).getHOOPeriod(sp.getCampaignID(), startDate, endDate);</span>
			//shift ot
<span class="nc" id="L2654">			getWorkRuleManager(context).getShiftOTExtension(new ScopeID(sp.getCampaignID(), Scope.CAMPAIGN_SCOPE), startDate, endDate);</span>
		}

<span class="nc" id="L2657">		getWorkResourceManager(context).getWorkResourceNamesByIDs(empIDs);</span>
		//load conflick checking background data
<span class="nc" id="L2659">		Map mapEmpWorkPatternAssignments = getEmpWorkRuleManager(context).getWorkPatternAssignments(empIDs, startDate, endDate);</span>
<span class="nc" id="L2660">		Collection colAssignments = null;</span>
<span class="nc" id="L2661">		WorkResourceWorkPattern ww= null;</span>
<span class="nc" id="L2662">		Set colWWSID = new HashSet();</span>
<span class="nc bnc" id="L2663" title="All 2 branches missed.">		for (Iterator i = mapEmpWorkPatternAssignments.values().iterator(); i.hasNext();) {</span>
<span class="nc" id="L2664">			colAssignments = (Collection)i.next();</span>
<span class="nc bnc" id="L2665" title="All 4 branches missed.">			if (colAssignments != null &amp;&amp; !colAssignments.isEmpty()) {</span>
<span class="nc bnc" id="L2666" title="All 2 branches missed.">				for (Iterator ix = colAssignments.iterator(); ix.hasNext(); ) {</span>
<span class="nc" id="L2667">					ww= (WorkResourceWorkPattern)ix.next();</span>
<span class="nc" id="L2668">					colWWSID.add(ww.getWorkPatternSID());</span>
				}
			}
		}
		
<span class="nc" id="L2673">		getWorkRuleManager(context).getShiftPatternsByIDs(colWWSID);</span>
<span class="nc" id="L2674">		getEmpWorkRuleManager(context).getMinMaxHourAssignments(empIDs, startDate, endDate);</span>
<span class="nc" id="L2675">	}</span>

	private static final int PUBLISH = -1;
	private static final int UNPUBLISH = -2;
	private static final int REVERT_TO_PUBLISHED = -3;
	
	private void doPublish(RequestContext context, Map appletRequest, Map appletResponse, int publishType, String publishingErrorMsgID, 
			String allFailedMsgID, String someFailedMsgID) throws BbmFinderException, RemoteException, BbmEJBCreateException {
<span class="fc" id="L2683">		String errorMsg = &quot;&quot;;</span>
<span class="fc" id="L2684">		Collection workResourceIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L2685">		Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L2686">		Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L2687">		boolean isTimeOffOnly = ((Boolean)appletRequest.get(PageKeys.PUBLISH_TIMEOFF_ONLY)).booleanValue();</span>
		// @todo - check for permissions
		// get the chunk size - we now publish in chunks to avoid transaction timeouts
<span class="fc" id="L2690">		int chunkSize = getPublishingChunkSize();</span>
<span class="fc" id="L2691">		List listFailedIDs = new ArrayList();</span>
<span class="fc" id="L2692">		List listChunkIDs = new ArrayList(chunkSize);</span>
<span class="fc bfc" id="L2693" title="All 2 branches covered.">		for (Iterator it = workResourceIDs.iterator(); it.hasNext();) {</span>
<span class="fc bfc" id="L2694" title="All 2 branches covered.">			while (it.hasNext()) {</span>
<span class="fc" id="L2695">				listChunkIDs.add(it.next());</span>
<span class="pc bpc" id="L2696" title="1 of 2 branches missed.">				if (listChunkIDs.size() == chunkSize) {</span>
<span class="nc" id="L2697">					break;</span>
				}
			}
			try {
<span class="pc bpc" id="L2701" title="3 of 4 branches missed.">				switch (publishType) {</span>
				case PUBLISH:
<span class="pc bpc" id="L2703" title="1 of 2 branches missed.">					if (isTimeOffOnly) {</span>
<span class="nc" id="L2704">						getScheduleAccessManager(context).publishTimeOffEvents(listChunkIDs, startDate, endDate);</span>
					} else {
<span class="fc" id="L2706">						getScheduleAccessManager(context).publishScheduleInBatch(listChunkIDs, startDate, endDate, true);</span>
					}
<span class="fc" id="L2708">					break;</span>
				case UNPUBLISH:
<span class="nc bnc" id="L2710" title="All 2 branches missed.">					if (isTimeOffOnly) {</span>
<span class="nc" id="L2711">						getScheduleAccessManager(context).unPublishTimeOffEvents(listChunkIDs, startDate, endDate);</span>
					} else {
<span class="nc" id="L2713">						getScheduleAccessManager(context).unPublishSchedule(listChunkIDs, startDate, endDate);</span>
					}
<span class="nc" id="L2715">					break;</span>
				case REVERT_TO_PUBLISHED:
<span class="nc" id="L2717">					getScheduleAccessManager(context).revertToPublishedSchedule(listChunkIDs, startDate, endDate);</span>
					break;
				}
<span class="nc" id="L2720">			} catch (BPException e) {</span>
<span class="nc" id="L2721">				listFailedIDs.addAll(listChunkIDs);</span>
<span class="nc" id="L2722">				log.l7dDebug(publishingErrorMsgID, e);</span>
<span class="nc" id="L2723">				errorMsg = e.getCoreException().getLocalizedMessage();</span>
<span class="fc" id="L2724">			}</span>
<span class="fc" id="L2725">			listChunkIDs.clear();</span>
		}
<span class="pc bpc" id="L2727" title="1 of 2 branches missed.">		if (!listFailedIDs.isEmpty()) {</span>
<span class="nc bnc" id="L2728" title="All 2 branches missed.">			if (listFailedIDs.size() == workResourceIDs.size()) {</span>
				// let the user know that all employees failed to publish
<span class="nc" id="L2730">				appletResponse.put(PageKeys.APPLET_ERROR, context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, allFailedMsgID) </span>
					+ &quot;\n&quot; + errorMsg);
			} else {
				// let the user know that some employees failed to publish
<span class="nc" id="L2734">				StringBuffer strBuffEmps = new StringBuffer();</span>
<span class="nc" id="L2735">				Iterator itFailedEmpIDs = listFailedIDs.iterator();</span>
<span class="nc" id="L2736">				Map employeeNamesByIDs = getWorkResourceManager(context).getEmployeeNamesByIDs(listFailedIDs);</span>
<span class="nc bnc" id="L2737" title="All 2 branches missed.">				while (itFailedEmpIDs.hasNext()) {</span>
<span class="nc bnc" id="L2738" title="All 2 branches missed.">					if (strBuffEmps.length() &gt; 0) {</span>
<span class="nc" id="L2739">						strBuffEmps.append(&quot;; &quot;);</span>
					}
<span class="nc" id="L2741">					ID nextID = (ID) itFailedEmpIDs.next();</span>
<span class="nc" id="L2742">					EmployeeName nextName = (EmployeeName) employeeNamesByIDs.get(nextID);</span>
<span class="nc" id="L2743">				}</span>
<span class="nc" id="L2744">				Object [] parameters = new Object[] {strBuffEmps};</span>
<span class="nc" id="L2745">				appletResponse.put(PageKeys.APPLET_ERROR, context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, someFailedMsgID, </span>
					parameters) + &quot;\n&quot; + errorMsg);
			}
		}
<span class="fc" id="L2749">	}</span>

	private int getPublishingChunkSize() {
		try {
<span class="fc" id="L2753">			int chunkSize = 0;</span>
<span class="pc bpc" id="L2754" title="1 of 2 branches missed.">			if (chunkSize &lt;= 0) {</span>
<span class="fc" id="L2755">				chunkSize = DEFAULT_CHUNK_SIZE;</span>
			}
<span class="fc" id="L2757">			return chunkSize;</span>
<span class="nc" id="L2758">		} catch (Exception e) {</span>
<span class="nc" id="L2759">			log.l7dDebug(FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_SHIFTASSIGNMENT, e);</span>
			// we don't really want everything to fail just because we couldn't get the value from the database
<span class="nc" id="L2761">			return DEFAULT_CHUNK_SIZE;</span>
		}
	}

	/**
	 * Added Config key for enabling/disabling employee filter , Config key :DisableEmployeeFilter.
	 * The Filter Employees popup window displays when adding an absence. - ESR#4380762
	 * @throws BbmEJBCreateException
	 * @throws RemoteException
	 */
	 protected String isEmployeeFilterBpconfigEnabled() throws BbmEJBCreateException, RemoteException {
<span class="fc" id="L2772">		String disableEmployeeFilter = &quot;false&quot;;</span>
<span class="fc" id="L2773">		String EmployeeFilterVal = BbmManagerFactory.getDBConfigManager().getValue(&quot;DisableEmployeeFilter&quot;); </span>
<span class="pc bpc" id="L2774" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(EmployeeFilterVal) ) {</span>
<span class="nc" id="L2775">			 disableEmployeeFilter = EmployeeFilterVal;</span>
		} else {
<span class="fc" id="L2777">			disableEmployeeFilter=&quot;false&quot;;</span>
		}
<span class="fc" id="L2779">		return disableEmployeeFilter;</span>
	}

	/**
	 * Get the chunk size to use when loading employee schedules and PersonData.
	 * @throws BbmEJBCreateException
	 * @throws RemoteException
	 */
	protected int getEmployeeChunkSize() throws BbmEJBCreateException, RemoteException {
<span class="fc" id="L2788">		int chunkSize = DEFAULT_EMPLOYEE_CHUNK_SIZE;</span>
<span class="fc" id="L2789">		String val = BbmManagerFactory.getDBConfigManager().getValue(CALENDAR_EMPLOYEE_CHUNK_SIZE);</span>
<span class="pc bpc" id="L2790" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(val) ) {</span>
			try {
<span class="nc" id="L2792">				chunkSize = Integer.parseInt(val);</span>
<span class="nc" id="L2793">			} catch (NumberFormatException nfe) {</span>
				//do nothing
<span class="nc" id="L2795">			}</span>
		}
<span class="fc" id="L2797">		return chunkSize;</span>
	}
	
	private int getPollingInterval() throws BbmEJBCreateException, RemoteException {
<span class="fc" id="L2801">		String rawValue = BbmManagerFactory.getDBConfigManager().getValue(FsKeys.STATUS_POLLING_INTERVAL_SECONDS);</span>
<span class="fc" id="L2802">		int value = DEFAULT_POLLING_INTERVAL_SECONDS;</span>
		try {
<span class="nc" id="L2804">			value = Integer.parseInt(rawValue);</span>
<span class="fc" id="L2805">		} catch (NumberFormatException nfe) {</span>
<span class="fc" id="L2806">			log.l7dDebug(&quot;STATUS_POLLING_INTERVAL_SECONDS could not be parsed '&quot; + rawValue + &quot;', defaulting to 5 seconds.&quot;);</span>
<span class="nc" id="L2807">		}</span>
<span class="fc" id="L2808">		return value;</span>
	}

	private void handleExpectedError(RequestContext context, Map appletResponse, String msgID, Object[] params) {
<span class="nc" id="L2812">		log.l7dDebug(msgID, params);</span>
<span class="nc" id="L2813">		String message = context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, msgID, params);</span>
		
<span class="nc" id="L2815">		appletResponse.put(PageKeys.APPLET_ERROR, message);</span>
<span class="nc" id="L2816">	}</span>

	private void handleExpectedError(RequestContext context, Map appletResponse, Locale locale, Exception e, String msgID, 	
			Object[] params, TimeZone viewTimeZone) {
<span class="nc" id="L2820">		log.l7dDebug(msgID, e);</span>
<span class="nc" id="L2821">		String message = context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, msgID, params);</span>
		
<span class="nc" id="L2823">		String extraMessage = null;</span>
<span class="nc bnc" id="L2824" title="All 4 branches missed.">		if (e instanceof MultiUserException || e instanceof BbmObjectNotFoundException) {</span>
<span class="nc" id="L2825">			extraMessage = context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, </span>
				FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_MULTIUSER_EXTENSION);
<span class="nc bnc" id="L2827" title="All 2 branches missed.">		} else if (e instanceof RemoteException) {</span>
<span class="nc" id="L2828">			extraMessage = context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, </span>
				FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_MULTIUSER_EXTENSION);
<span class="nc bnc" id="L2830" title="All 2 branches missed.">		} else if (e instanceof BbmUpdateException) {</span>
<span class="nc" id="L2831">			Exception core = ((BbmUpdateException)e).getCoreException();</span>
<span class="nc bnc" id="L2832" title="All 2 branches missed.">			if (core != null)</span>
<span class="nc" id="L2833">				extraMessage = core.getLocalizedMessage();</span>
		} 
<span class="nc bnc" id="L2835" title="All 2 branches missed.">		if (extraMessage != null) {</span>
<span class="nc" id="L2836">			message += &quot; &quot; + extraMessage;</span>
		}

<span class="nc" id="L2839">		appletResponse.put(PageKeys.APPLET_ERROR, message);</span>
<span class="nc" id="L2840">		String [] exceptionMessages = getExceptionMessages(context, locale, e, viewTimeZone);</span>
<span class="nc" id="L2841">		AppletError appletError = new AppletError(e.getClass().getName(), exceptionMessages);</span>
<span class="nc" id="L2842">		appletResponse.put(PageKeys.APPLET_ERROR_OBJECT, appletError);</span>
<span class="nc" id="L2843">	}</span>

	private String[] getExceptionMessages(RequestContext context, Locale locale, Exception e, TimeZone viewTimeZone) {
<span class="nc" id="L2846">		String[] messages = null;</span>
		String nextMessage;
<span class="nc bnc" id="L2848" title="All 2 branches missed.">		if (e instanceof BbmScheduleConflictException) {</span>
<span class="nc" id="L2849">			Collection conflicts = ((BbmScheduleConflictException)e).getConflicts();</span>
<span class="nc" id="L2850">			messages = new String[conflicts.size()];</span>
<span class="nc" id="L2851">			int nextIndex = 0;</span>
<span class="nc" id="L2852">			Iterator itConflicts = conflicts.iterator();</span>

<span class="nc bnc" id="L2854" title="All 2 branches missed.">			while (itConflicts.hasNext()) {</span>
<span class="nc" id="L2855">				BbmScheduleConflict nextConflict = (BbmScheduleConflict) itConflicts.next();</span>
<span class="nc bnc" id="L2856" title="All 2 branches missed.">				messages[nextIndex++] = nextConflict.getLocalizedMessage(context.getLocalizer(), viewTimeZone == null ? </span>
<span class="nc" id="L2857">					context.getViewingTimeZone(): viewTimeZone);</span>
<span class="nc" id="L2858">			}</span>
<span class="nc bnc" id="L2859" title="All 2 branches missed.">		} else if (e instanceof BbmCreateException) {</span>
<span class="nc" id="L2860">			Exception core = ((BbmCreateException)e).getCoreException();</span>
<span class="nc bnc" id="L2861" title="All 2 branches missed.">			if (core != null) {</span>
<span class="nc" id="L2862">				nextMessage = core.getLocalizedMessage();</span>
<span class="nc" id="L2863">				messages = new String[]{nextMessage};</span>
			}
<span class="nc bnc" id="L2865" title="All 2 branches missed.">		} else if (e instanceof BPException) {</span>
<span class="nc" id="L2866">			nextMessage = ((BPException) e).getLocalizedMessage(locale);</span>
<span class="nc" id="L2867">			messages = new String[] {nextMessage};</span>
<span class="nc bnc" id="L2868" title="All 2 branches missed.">		} else if (e instanceof RemoteException) {</span>
<span class="nc" id="L2869">			nextMessage = ((RemoteException)e).getLocalizedMessage();</span>
<span class="nc" id="L2870">			messages = new String[]{nextMessage};</span>
		} else {
<span class="nc" id="L2872">			nextMessage = e.getLocalizedMessage();</span>
<span class="nc" id="L2873">			messages = new String[]{nextMessage};</span>
		}
<span class="nc" id="L2875">		return messages;</span>
	}

	private void handleUnexpectedError(RequestContext context, Map appletResponse, Locale locale, RuntimeException e, 
			String msgID, Object[] params, TimeZone viewTimeZone) {
<span class="nc" id="L2880">		log.l7dError(msgID, e);</span>
		// DEBUG ONLY
<span class="nc" id="L2882">		String message = context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, msgID, params);</span>
		
<span class="nc" id="L2884">		appletResponse.put(PageKeys.APPLET_ERROR, message);</span>
<span class="nc" id="L2885">		String[] exceptionMessages = getExceptionMessages(context, locale, e, viewTimeZone);</span>
<span class="nc" id="L2886">		AppletError appletError = new AppletError(e.getClass().getName(), exceptionMessages);</span>
<span class="nc" id="L2887">		appletResponse.put(PageKeys.APPLET_ERROR_OBJECT, appletError);</span>
<span class="nc" id="L2888">	}</span>

	private CampaignManager getCampaignManager(RequestContext context) throws BbmEJBCreateException {
<span class="fc bfc" id="L2891" title="All 2 branches covered.">		if (m_campaignManager == null) {</span>
<span class="fc" id="L2892">			m_campaignManager = WfmManagerFactory.getCampaignManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2894">		return m_campaignManager;</span>
	}

	private WorkRuleManager getWorkRuleManager(RequestContext context) throws BbmEJBCreateException {
<span class="fc bfc" id="L2898" title="All 2 branches covered.">		if (m_workruleManager == null) {</span>
<span class="fc" id="L2899">			m_workruleManager = WfmManagerFactory.getWorkRuleManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2901">		return m_workruleManager;</span>
	}

	private ScheduleAccessManager getScheduleAccessManager(RequestContext context) throws BbmEJBCreateException {
<span class="fc bfc" id="L2905" title="All 2 branches covered.">		if (m_scheduleAccessManager == null) {</span>
<span class="fc" id="L2906">			m_scheduleAccessManager = WfmManagerFactory.getScheduleAccessManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2908">		return m_scheduleAccessManager;</span>
	}

	private BbmELearningBridgeInterface getLearningAssignmentManager() throws CoreEJBCreateException, CoreFinderException, 
			RemoteException, ClassNotFoundException, InstantiationException, IllegalAccessException, BbmFinderException {
<span class="nc bnc" id="L2913" title="All 2 branches missed.">		if (m_bbmELearningBridge == null) {</span>
<span class="nc" id="L2914">			GCRManager gcrManager = CoreManagerFactory.getGCRManagerRemote(false);</span>
<span class="nc" id="L2915">			Collection entries = gcrManager.getGCREntryOfType(BbmELearningBridgeInterface.GCR_NAME);</span>
<span class="nc bnc" id="L2916" title="All 4 branches missed.">			if (entries == null || entries.isEmpty()){</span>
<span class="nc" id="L2917">				throw new BbmFinderException(FsWebBundleKey.FS_CAL_ERR_ERROR_GETTING_GCRMANAGER_BRIDGE_ENTRIES, </span>
					new Object[]{BbmELearningBridgeInterface.GCR_NAME});
			}
<span class="nc" id="L2920">			GCREntry entry = (GCREntry)entries.iterator().next();</span>
<span class="nc" id="L2921">			Class bridgeClass = Class.forName(entry.getHook());</span>
<span class="nc" id="L2922">			m_bbmELearningBridge = (BbmELearningBridgeInterface)bridgeClass.newInstance();			</span>
		}
<span class="nc" id="L2924">		return m_bbmELearningBridge;</span>
	}

	private WorkResourceManager getWorkResourceManager(RequestContext context) throws BbmEJBCreateException {
<span class="fc bfc" id="L2928" title="All 2 branches covered.">		if (m_workResourceManager == null) {</span>
<span class="fc" id="L2929">			m_workResourceManager = BbmManagerFactory.getWorkResourceManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2931">		return m_workResourceManager;</span>
	}

	private SkillManager getSkillManager(RequestContext context) throws BbmEJBCreateException {
<span class="pc bpc" id="L2935" title="1 of 2 branches missed.">		if (m_skillManager == null) {</span>
<span class="fc" id="L2936">			m_skillManager = WfmManagerFactory.getSkillManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2938">		return m_skillManager;</span>
	}
	
	private EmpWorkRuleManager getEmpWorkRuleManager(RequestContext context) throws BbmEJBCreateException {
<span class="fc bfc" id="L2942" title="All 2 branches covered.">		if (m_empWorkRuleManager == null) {</span>
<span class="fc" id="L2943">			m_empWorkRuleManager = WfmManagerFactory.getEmpWorkRuleManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2945">		return m_empWorkRuleManager;</span>
	}

	private FacadeCorbaFacadeManager getFacadeCorbaFacadeManager() throws FacadeEJBCreateException {
<span class="pc bpc" id="L2949" title="1 of 2 branches missed.">		if (m_facadeCorbaFacadeManager == null) {</span>
<span class="fc" id="L2950">			m_facadeCorbaFacadeManager = FacadeManagerFactory.getFacadeCorbaFacadeManager();</span>
		}
<span class="fc" id="L2952">		return m_facadeCorbaFacadeManager;</span>
	}

	private PayPolicyManager getPayPolicyManager() throws BbmEJBCreateException {
<span class="nc bnc" id="L2956" title="All 2 branches missed.">		if (m_payPolicyManager == null) {</span>
<span class="nc" id="L2957">			m_payPolicyManager = BbmManagerFactory.getPayPolicyManager();</span>
		}
<span class="nc" id="L2959">		return m_payPolicyManager;</span>
	}

	private WorkloadManager getWorkloadManager(RequestContext context) throws BbmEJBCreateException {
<span class="fc bfc" id="L2963" title="All 2 branches covered.">		if (m_workloadManager == null) {</span>
<span class="fc" id="L2964">			m_workloadManager  = WfmManagerFactory.getWorkloadManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2966">		return m_workloadManager;</span>
	}

	private FteRequirementsManager getFteRequirementsManager(RequestContext context) throws BbmEJBCreateException {
<span class="nc bnc" id="L2970" title="All 2 branches missed.">		if (m_fteRequirementsManager == null) {</span>
<span class="nc" id="L2971">			m_fteRequirementsManager = WfmManagerFactory.getFteRequirementsManager(context.isInWhatIfMode());</span>
		}
<span class="nc" id="L2973">		return m_fteRequirementsManager;		</span>
	}

	private TrackingManager getTrackingManager(RequestContext context) throws BbmEJBCreateException {
<span class="pc bpc" id="L2977" title="1 of 2 branches missed.">		if (m_trackingManager == null) {</span>
<span class="fc" id="L2978">			m_trackingManager = WfmManagerFactory.getPulseTrackingManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2980">		return m_trackingManager;</span>
	}

	private ActivityManager getActivityManager(RequestContext context) throws BbmEJBCreateException {
<span class="pc bpc" id="L2984" title="1 of 2 branches missed.">		if (m_activityManager == null) {</span>
<span class="fc" id="L2985">			m_activityManager = WfmManagerFactory.getActivityManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2987">		return m_activityManager;</span>
	}

	private UserManager getUserManager(RequestContext context) throws CoreEJBCreateException {
<span class="pc bpc" id="L2991" title="1 of 2 branches missed.">		if (m_userManager == null) {</span>
<span class="fc" id="L2992">			m_userManager = CoreManagerFactory.getUserManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2994">		return m_userManager;</span>
	}

	private ForecastTimeSeriesManager getForecastManager(RequestContext context) throws BbmEJBCreateException {
<span class="pc bpc" id="L2998" title="1 of 2 branches missed.">		if (m_forecastManager == null) {</span>
<span class="fc" id="L2999">			m_forecastManager = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L3001">		return m_forecastManager;</span>
	}

	private Map&lt;ID, Organization&gt; getOrgIDMap(RequestContext context, Collection&lt;Collection&lt;WorkResourceAssignment&gt;&gt; wrkAssignments)
			throws RemoteException, BbmFinderException, BbmEJBCreateException {
<span class="nc" id="L3006">		Iterator&lt;Collection&lt;WorkResourceAssignment&gt;&gt; itOrgAssignmentCollections = wrkAssignments.iterator();</span>
<span class="nc" id="L3007">		Set setOrgIDs = new HashSet();</span>
<span class="nc bnc" id="L3008" title="All 2 branches missed.">		while (itOrgAssignmentCollections.hasNext()) {</span>
<span class="nc" id="L3009">			Collection&lt;WorkResourceAssignment&gt; nextOrgAssignmentCollection = itOrgAssignmentCollections.next();</span>
<span class="nc" id="L3010">			Iterator&lt;WorkResourceAssignment&gt; itOrgAssignments = nextOrgAssignmentCollection.iterator();</span>
<span class="nc bnc" id="L3011" title="All 2 branches missed.">			while (itOrgAssignments.hasNext()) {</span>
<span class="nc" id="L3012">				ID nextOrgID = itOrgAssignments.next().getOrganizationID();</span>
<span class="nc" id="L3013">				setOrgIDs.add(nextOrgID);</span>
<span class="nc" id="L3014">			}</span>
<span class="nc" id="L3015">		}</span>
<span class="nc" id="L3016">		Collection&lt;Organization&gt; orgs = this.getWorkResourceManager(context).getOrganizationsByIDs(setOrgIDs);</span>
<span class="nc" id="L3017">		Iterator&lt;Organization&gt; itOrgs = orgs.iterator();</span>
<span class="nc" id="L3018">		Map&lt;ID, Organization&gt; mapOrgs = new HashMap(orgs.size());</span>
<span class="nc bnc" id="L3019" title="All 2 branches missed.">		while (itOrgs.hasNext()) {</span>
<span class="nc" id="L3020">			Organization nextOrg = itOrgs.next();</span>
<span class="nc" id="L3021">			mapOrgs.put(nextOrg.getID(), nextOrg);</span>
<span class="nc" id="L3022">		}</span>
<span class="nc" id="L3023">		return mapOrgs;</span>
	}

	private EmployeeFilter getEmployeeFilterManager(RequestContext context) throws BbmEJBCreateException {
<span class="pc bpc" id="L3027" title="1 of 2 branches missed.">		if (m_empFilterManager == null) {</span>
<span class="fc" id="L3028">			m_empFilterManager = BbmManagerFactory.getEmployeeFilter(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L3030">		return m_empFilterManager;</span>
	}

	private DBConfigManager getDBManager(RequestContext context) throws BbmEJBCreateException {
<span class="fc bfc" id="L3034" title="All 2 branches covered.">		if (m_dbManager == null) {</span>
<span class="fc" id="L3035">			m_dbManager = BbmManagerFactory.getDBConfigManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L3037">		return m_dbManager;</span>
	}


	private LicenseManager getLicenserManager() throws CoreEJBCreateException {
<span class="fc bfc" id="L3042" title="All 2 branches covered.">		if (m_licenseManager == null) {</span>
<span class="fc" id="L3043">			m_licenseManager = CoreManagerFactory.getLicenseManager();</span>
		}
<span class="fc" id="L3045">		return m_licenseManager;</span>
	}

	private void getLicenses(Map appletResponse) throws CoreEJBCreateException, RemoteException {
		
<span class="fc" id="L3050">		appletResponse.put(FsKeys.HAS_OPS_LICENSE, getLicenserManager().isLicensed(LicenseKeys.APP_Operations));</span>

<span class="fc" id="L3052">		appletResponse.put(FsKeys.HAS_POOLER_LICENSE, getLicenserManager().isLicensed(LicenseKeys.APP_CAMP_POOLING));</span>

<span class="fc" id="L3054">		appletResponse.put(FsKeys.HAS_MONTHLY_LICENSE, getLicenserManager().isLicensed(LicenseKeys.APP_MONTHLY_FORECAST_AND_RULES));</span>

<span class="fc" id="L3056">		appletResponse.put(PageKeys.LEARNING_LICENSE, getLicenserManager().isLicensed(LicenseKeys.APP_ELEARNING_LESSONS));</span>
		
<span class="fc" id="L3058">		appletResponse.put(PageKeys.COACHING_LICENSE, getLicenserManager().isLicensed(LicenseKeys.APP_COACHING));</span>

<span class="fc" id="L3060">		appletResponse.put(PageKeys.HAS_OUTBOUND_LICENSE, getLicenserManager().isLicensed(LicenseKeys.APP_MEDIA_OUTBOUND));</span>

<span class="fc" id="L3062">		appletResponse.put(PageKeys.HAS_RFS_LICENSE, getLicenserManager().isLicensed(LicenseKeys.APP_RFS));</span>

		//advanced RM license is now always enabled
<span class="fc" id="L3065">		appletResponse.put(FsKeys.HAS_ADVANCEDRM_LICENSE, true);</span>
<span class="fc" id="L3066">	}</span>

	private Collection&lt;ID&gt; getEmployeeIDsByFilter(RequestContext context, User user, String empFilterName, Filter filter) throws Exception {
		Collection&lt;ID&gt; employeeIDs;
<span class="nc bnc" id="L3070" title="All 4 branches missed.">		if (empFilterName != null &amp;&amp; empFilterName.length() &gt; 0) {</span>
<span class="nc" id="L3071">			employeeIDs = getEmployeeFilterManager(context).getEmployeeIDs(user, empFilterName, filter, Filter.LASTNAME, true, </span>
				0, Integer.MAX_VALUE);
		} else {
<span class="nc" id="L3074">			employeeIDs = getEmployeeFilterManager(context).getEmployeeIDs(filter, user, Filter.LASTNAME, true, 0, Integer.MAX_VALUE);</span>
		}
<span class="nc" id="L3076">		return employeeIDs;</span>
	}

	private Map getEmpOrgAssignments(RequestContext context, Collection employeeIDs, Date startDate, Date endDate) throws Exception {
<span class="fc" id="L3080">		Map empOrgAssignments = getWorkResourceManager(context).getValidWorkResourceAssignments(employeeIDs, </span>
<span class="fc" id="L3081">				new LocalDate(startDate, TimeZone.getTimeZone(&quot;GMT&quot;)), new LocalDate(endDate, TimeZone.getTimeZone(&quot;GMT&quot;)), </span>
				false);
<span class="fc" id="L3083">		return empOrgAssignments;</span>
	}


	private Map getSPSchedulingParameters(RequestContext context, Date date, ID spID, ID campaignID) 
			throws BbmFinderException, BbmEJBCreateException, RemoteException {
		Map parameters;
<span class="fc" id="L3090">		parameters = getCampaignManager(context).getSchedulingParameters(spID);</span>
<span class="pc bpc" id="L3091" title="2 of 4 branches missed.">		if (parameters == null || parameters.size() == 0) {</span>
<span class="nc" id="L3092">			ID mostRecentSPID = getCampaignManager(context).getMostRecentSPWithParameters(date, campaignID);</span>
<span class="nc bnc" id="L3093" title="All 2 branches missed.">			if (mostRecentSPID == null) {</span>
<span class="nc" id="L3094">				return new HashMap();</span>
			}
<span class="nc" id="L3096">			parameters = getCampaignManager(context).getSchedulingParameters(mostRecentSPID);</span>
		}
<span class="fc" id="L3098">		return parameters;</span>
	}

	@Override
	protected void processAppletRequest(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="fc" id="L3103">		super.processAppletRequest(context, appletRequest, appletResponse);</span>
<span class="fc" id="L3104">		this.processGetData(context, appletRequest, appletResponse);</span>
<span class="fc" id="L3105">		this.processCustomRequest(context, appletRequest, appletResponse);</span>
<span class="fc" id="L3106">	}</span>

	/**
	 * It appears that this returns a map with NullablePair&lt;MediaId, QueueID&gt; for the key mapped to a trace Cube with:
	 * 		the Forecasted Schedule Value, 
	 * 		and Required values that are set to the FTE Differential values.
	 * 
	 * The key is (null, null) for the &quot;combined combined&quot; queue
	 * The key is (mediaId, null) for the &quot;combined&quot; media queue
	 * The key is (mediaId, queueId) for an individual queue
	 *
	 */
	private List&lt;Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt;&gt; getStatisticRibbons(RequestContext context, Map appletResponse, SchedulingPeriod sp,
			Collection&lt;SPQueue&gt; spQueues) throws BbmFinderException, BbmEJBCreateException, RemoteException, CoreEJBCreateException, 
			BbmTimeSeriesException {
<span class="fc" id="L3121">		List&lt;Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt;&gt; listLineTypes = new ArrayList();</span>

<span class="fc" id="L3123">		WorkloadManager workloadManager = getWorkloadManager(context);</span>
<span class="fc" id="L3124">		boolean hasAppMediaOutboundLicense = getLicenserManager().isLicensed(LicenseKeys.APP_MEDIA_OUTBOUND);</span>

<span class="fc" id="L3126">		SPQueueTraceCubeData spQueueData = new SPQueueTraceCubeData(sp, spQueues, hasAppMediaOutboundLicense);</span>
<span class="fc" id="L3127">		Collection&lt;ID&gt; qIDs = ValueObjectUtil.getFieldObjectCol(SPQueueFieldInfo.SPQUEUE_QUEUEID, spQueues);</span>
<span class="fc" id="L3128">		spQueueData.init(workloadManager.getQueuesByIDs(qIDs));</span>
		
<span class="fc" id="L3130">		appletResponse.put(PageKeys.IS_SKILLED_SP, sp.getSkillBased());</span>

<span class="fc" id="L3132">		TrackingManager trackingManager = getTrackingManager(context);</span>
		
<span class="pc bpc" id="L3134" title="1 of 2 branches missed.">		if (spQueueData.isComplexSP()) {</span>
<span class="nc" id="L3135">			populateTraceCubeForComplexSP(context, spQueueData, trackingManager);</span>
		} else {
<span class="fc" id="L3137">			populateTraceCubeForAllQs(spQueueData, trackingManager, workloadManager);</span>
		}

<span class="fc" id="L3140">		listLineTypes.add(spQueueData.getMapQueueRibbons());</span>
<span class="fc" id="L3141">		listLineTypes.add(spQueueData.getMapQueueRibbonsRequiredLine());</span>
<span class="pc bpc" id="L3142" title="1 of 2 branches missed.">		if (!spQueueData.getMapQueueRibbonsNoPhantomLine().isEmpty()) {</span>
<span class="nc" id="L3143">			listLineTypes.add(spQueueData.getMapQueueRibbonsNoPhantomLine());</span>
		}
		
<span class="fc" id="L3146">		return listLineTypes;</span>
	}

	private void populateTraceCubeForComplexSP(RequestContext context, SPQueueTraceCubeData spQueueData, 
			TrackingManager trackingMgr) throws BbmFinderException, RemoteException, BbmTimeSeriesException {
		//For Orange, only load selected Q instead of all Qs
<span class="nc" id="L3152">		String strQID = context.getUserProperty(PageKeys.FS_WEB_SELECTED_QUEUE);</span>
<span class="nc bnc" id="L3153" title="All 2 branches missed.">		ID selectedQID = StringUtil.isEmpty(strQID) ? null : new ID(strQID);</span>
<span class="nc" id="L3154">		String strMediaID =  context.getUserProperty(PageKeys.FS_WEB_SELECTED_MEDIA);</span>
<span class="nc bnc" id="L3155" title="All 2 branches missed.">		ID selectedMediaID = StringUtil.isEmpty(strMediaID) ? null : new ID(strMediaID);</span>
<span class="nc" id="L3156">		SchedulingPeriod sp = spQueueData.getSp();</span>
<span class="nc" id="L3157">		Date adjustedEndDate = new Date(sp.getEndTime().getTime() - MILLIS_IN_MINUTES);</span>
		
<span class="nc bnc" id="L3159" title="All 4 branches missed.">		if (selectedQID != null &amp;&amp; !spQueueData.getIdQueueMap().containsKey(selectedQID)) {</span>
<span class="nc" id="L3160">			selectedQID = null;</span>
<span class="nc" id="L3161">			selectedMediaID = null;</span>
		}
		
<span class="nc" id="L3164">		TrackingView tv = spQueueData.getTv();</span>
<span class="nc" id="L3165">		TrackingView tvNoPhantom = spQueueData.getTvNoPhantom();</span>

		//Get Combined Combined Queue
<span class="nc" id="L3168">		HashMap&lt;ID, TraceCube[]&gt; mapQueueCubes = null;</span>
<span class="nc" id="L3169">		HashMap&lt;ID, TraceCube[]&gt; mapQueueCubesNoPhantoms = null;</span>
		
<span class="nc bnc" id="L3171" title="All 4 branches missed.">		if (selectedMediaID == null &amp;&amp; selectedQID == null) { </span>
			//combine combine
<span class="nc" id="L3173">			mapQueueCubes = trackingMgr.getCombineTraceCubesByTrackingView(tv, sp.getCampaignID(), </span>
<span class="nc bnc" id="L3174" title="All 2 branches missed.">				sp.getSkillBased() ? null : Media.MEDIA_ID_PHONE, sp.getStartTime(), adjustedEndDate);</span>
<span class="nc" id="L3175">			mapQueueCubesNoPhantoms = trackingMgr.getCombineTraceCubesByTrackingView(tvNoPhantom, sp.getCampaignID(),</span>
<span class="nc bnc" id="L3176" title="All 2 branches missed.">				sp.getSkillBased() ? null : Media.MEDIA_ID_PHONE, sp.getStartTime(), adjustedEndDate);</span>
		}
<span class="nc bnc" id="L3178" title="All 4 branches missed.">		if (selectedMediaID != null &amp;&amp; selectedQID == null) {</span>
<span class="nc" id="L3179">			mapQueueCubes = trackingMgr.getCombineTraceCubesByTrackingView(tv, sp.getCampaignID(), selectedMediaID, sp.getStartTime(),</span>
				adjustedEndDate);
<span class="nc" id="L3181">			mapQueueCubesNoPhantoms = trackingMgr.getCombineTraceCubesByTrackingView(tvNoPhantom, sp.getCampaignID(), selectedMediaID, </span>
<span class="nc" id="L3182">				sp.getStartTime(), adjustedEndDate);</span>
		}
<span class="nc bnc" id="L3184" title="All 4 branches missed.">		if (selectedMediaID == null &amp;&amp; selectedQID != null) {</span>
<span class="nc" id="L3185">			mapQueueCubes = trackingMgr.getTraceCubesByTrackingView(tv, sp.getCampaignID(), new ArrayList(Arrays.asList(selectedQID)),</span>
<span class="nc" id="L3186">				sp.getStartTime(), adjustedEndDate);</span>
<span class="nc" id="L3187">			mapQueueCubesNoPhantoms = trackingMgr.getTraceCubesByTrackingView(tvNoPhantom, sp.getCampaignID(), </span>
<span class="nc" id="L3188">				new ArrayList(Arrays.asList(selectedQID)), sp.getStartTime(), adjustedEndDate);</span>
<span class="nc" id="L3189">			Queue q = spQueueData.getIdQueueMap().get(selectedQID);</span>
<span class="nc" id="L3190">			selectedMediaID = q.getMediaID();</span>
		}
<span class="nc bnc" id="L3192" title="All 2 branches missed.">		if (mapQueueCubes != null) {</span>
<span class="nc bnc" id="L3193" title="All 2 branches missed.">			for (Map.Entry&lt;ID, TraceCube[]&gt; entry: mapQueueCubes.entrySet()) {</span>
<span class="nc" id="L3194">				Pair&lt;TraceCube, TraceCube&gt; consolidatedCube = getRibbonTraceCube(entry, tv, sp.getStartTime(), adjustedEndDate);</span>
<span class="nc" id="L3195">				spQueueData.getMapQueueRibbons().put(new NullablePair&lt;ID, ID&gt;(selectedMediaID, selectedQID), consolidatedCube.getFirst());</span>
<span class="nc" id="L3196">				spQueueData.getMapQueueRibbonsRequiredLine().put(new NullablePair&lt;ID, ID&gt;(selectedMediaID, selectedQID), consolidatedCube.getSecond());</span>
<span class="nc" id="L3197">			}</span>
		}
<span class="nc bnc" id="L3199" title="All 2 branches missed.">		if (mapQueueCubesNoPhantoms != null) {</span>
<span class="nc bnc" id="L3200" title="All 2 branches missed.">			for (Map.Entry&lt;ID, TraceCube[]&gt; entry: mapQueueCubesNoPhantoms.entrySet()) {</span>
<span class="nc" id="L3201">				Pair&lt;TraceCube, TraceCube&gt; consolidatedCube = getRibbonTraceCube(entry, tvNoPhantom, sp.getStartTime(), adjustedEndDate);</span>
<span class="nc bnc" id="L3202" title="All 2 branches missed.">				if (!isAllNullPredicedValues((AggrForecastedTraceCube)consolidatedCube.getFirst())) {</span>
<span class="nc" id="L3203">					spQueueData.getMapQueueRibbonsNoPhantomLine().put(new NullablePair&lt;ID, ID&gt;(null, null), consolidatedCube.getFirst());</span>
				}
<span class="nc" id="L3205">			}</span>
		}
<span class="nc" id="L3207">	}</span>

	private void populateTraceCubeForAllQs(SPQueueTraceCubeData spQueueData, TrackingManager trackingMgr, WorkloadManager workloadMgr)
		throws BbmFinderException, RemoteException, BbmTimeSeriesException, BbmEJBCreateException {

<span class="fc" id="L3212">		SchedulingPeriod sp = spQueueData.getSp();</span>
<span class="fc" id="L3213">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; mapQueueRibbons = spQueueData.getMapQueueRibbons();</span>
<span class="fc" id="L3214">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; mapQueueRibbonsRequiredLine = spQueueData.getMapQueueRibbonsRequiredLine();</span>
<span class="fc" id="L3215">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; mapQueueRibbonsNoPhantomLine = spQueueData.getMapQueueRibbonsNoPhantomLine();</span>
<span class="fc" id="L3216">		TrackingView tv = spQueueData.getTv();</span>
<span class="fc" id="L3217">		TrackingView tvNoPhantom = spQueueData.getTvNoPhantom();</span>
<span class="fc" id="L3218">		Date adjustedEndDate = new Date(sp.getEndTime().getTime() - MILLIS_IN_MINUTES);</span>
		
		//Get Combined Combined Queue
<span class="fc" id="L3221">		Map&lt;ID, TraceCube[]&gt; combinedCube = trackingMgr.getCombineTraceCubesByTrackingView(tv,</span>
<span class="pc bpc" id="L3222" title="1 of 2 branches missed.">			sp.getCampaignID(), sp.getSkillBased() ? null : Media.MEDIA_ID_PHONE, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc" id="L3223">		Map.Entry&lt;ID, TraceCube[]&gt; entry = combinedCube.entrySet().iterator().next();</span>
<span class="fc" id="L3224">		Pair &lt;TraceCube, TraceCube&gt; consolidatedCube = getRibbonTraceCube(entry, tv, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc" id="L3225">		mapQueueRibbons.put(new NullablePair&lt;ID, ID&gt;(null, null), consolidatedCube.getFirst());</span>
<span class="fc" id="L3226">		mapQueueRibbonsRequiredLine.put(new NullablePair&lt;ID, ID&gt;(null, null), consolidatedCube.getSecond());</span>

		//Get Combined Combined Queue for No Phantoms
<span class="fc" id="L3229">		combinedCube = trackingMgr.getCombineTraceCubesByTrackingView(tvNoPhantom,</span>
<span class="pc bpc" id="L3230" title="1 of 2 branches missed.">			sp.getCampaignID(), sp.getSkillBased() ? null : Media.MEDIA_ID_PHONE, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc" id="L3231">		entry = combinedCube.entrySet().iterator().next();</span>
<span class="fc" id="L3232">		consolidatedCube = getRibbonTraceCube(entry, tvNoPhantom, sp.getStartTime(), adjustedEndDate);</span>
<span class="pc bpc" id="L3233" title="1 of 2 branches missed.">		if (!isAllNullPredicedValues((AggrForecastedTraceCube)consolidatedCube.getFirst())) {</span>
<span class="nc" id="L3234">			mapQueueRibbonsNoPhantomLine.put(new NullablePair&lt;ID, ID&gt;(null, null), consolidatedCube.getFirst());</span>
		}

		//Get Combined Media Queues
<span class="fc bfc" id="L3238" title="All 2 branches covered.">		for (ID mediaId : spQueueData.getMediaIDCollection()) {</span>
<span class="fc" id="L3239">			Map&lt;ID, TraceCube[]&gt; combinedMediaCube = trackingMgr.getCombineTraceCubesByTrackingView(tv,</span>
<span class="fc" id="L3240">				sp.getCampaignID(),	mediaId, sp.getStartTime(),	adjustedEndDate);</span>
<span class="fc" id="L3241">			entry = combinedMediaCube.entrySet().iterator().next();</span>
<span class="fc" id="L3242">			consolidatedCube = getRibbonTraceCube(entry, tv, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc" id="L3243">			mapQueueRibbons.put(new NullablePair&lt;ID, ID&gt;(mediaId, null), consolidatedCube.getFirst());</span>
<span class="fc" id="L3244">			mapQueueRibbonsRequiredLine.put(new NullablePair&lt;ID, ID&gt;(mediaId, null), consolidatedCube.getSecond());</span>
<span class="fc" id="L3245">		}</span>

		//Get Combined Media Queues for No Phantoms
<span class="fc bfc" id="L3248" title="All 2 branches covered.">		for (ID mediaId : spQueueData.getMediaIDCollection()) {</span>
<span class="fc" id="L3249">			Map&lt;ID, TraceCube[]&gt; combinedMediaCube = trackingMgr.getCombineTraceCubesByTrackingView(tvNoPhantom,</span>
<span class="fc" id="L3250">				sp.getCampaignID(),	mediaId, sp.getStartTime(),	adjustedEndDate);</span>
<span class="fc" id="L3251">			entry = combinedMediaCube.entrySet().iterator().next();</span>
<span class="fc" id="L3252">			consolidatedCube = getRibbonTraceCube(entry, tvNoPhantom, sp.getStartTime(), adjustedEndDate);</span>
<span class="pc bpc" id="L3253" title="1 of 2 branches missed.">			if (!isAllNullPredicedValues((AggrForecastedTraceCube)consolidatedCube.getFirst())) {</span>
<span class="nc" id="L3254">				mapQueueRibbonsNoPhantomLine.put(new NullablePair&lt;ID, ID&gt;(mediaId, null), consolidatedCube.getFirst());</span>
			}
<span class="fc" id="L3256">		}</span>

		//Get Each individual Queue
<span class="fc" id="L3259">		Map&lt;ID, TraceCube[]&gt; mapQueueCubes = trackingMgr.getTraceCubesByTrackingView(tv,</span>
<span class="fc" id="L3260">			sp.getCampaignID(), spQueueData.getQueueIDCollection(), sp.getStartTime(), adjustedEndDate);</span>
<span class="pc bpc" id="L3261" title="1 of 2 branches missed.">		if (mapQueueCubes != null) {</span>
<span class="fc bfc" id="L3262" title="All 2 branches covered.">			for (Iterator&lt;Map.Entry&lt;ID, TraceCube[]&gt;&gt; i = mapQueueCubes.entrySet().iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L3263">				entry = i.next();</span>
<span class="fc" id="L3264">				consolidatedCube = getRibbonTraceCube(entry, tv, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc" id="L3265">				Queue queue = workloadMgr.getQueueByID(entry.getKey());</span>
<span class="fc" id="L3266">				mapQueueRibbons.put(new NullablePair&lt;ID, ID&gt;(queue.getMediaID(), entry.getKey()), consolidatedCube.getFirst());</span>
<span class="fc" id="L3267">				mapQueueRibbonsRequiredLine.put(new NullablePair&lt;ID, ID&gt;(queue.getMediaID(), entry.getKey()), consolidatedCube.getSecond());</span>
<span class="fc" id="L3268">			}</span>
		}

		//Get Each individual Queue for No Phantoms
<span class="fc" id="L3272">		mapQueueCubes = trackingMgr.getTraceCubesByTrackingView(tvNoPhantom,</span>
<span class="fc" id="L3273">			sp.getCampaignID(), spQueueData.getQueueIDCollection(), sp.getStartTime(), adjustedEndDate);</span>
<span class="pc bpc" id="L3274" title="1 of 2 branches missed.">		if (mapQueueCubes != null) {</span>
<span class="pc bpc" id="L3275" title="1 of 2 branches missed.">			for (Iterator&lt;Map.Entry&lt;ID, TraceCube[]&gt;&gt; i = mapQueueCubes.entrySet().iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L3276">				entry = i.next();</span>
<span class="nc" id="L3277">				consolidatedCube = getRibbonTraceCube(entry, tvNoPhantom, sp.getStartTime(), adjustedEndDate);</span>
<span class="nc bnc" id="L3278" title="All 2 branches missed.">				if (!isAllNullPredicedValues((AggrForecastedTraceCube)consolidatedCube.getFirst())) {</span>
<span class="nc" id="L3279">					Queue queue = workloadMgr.getQueueByID(entry.getKey());</span>
<span class="nc" id="L3280">					mapQueueRibbonsNoPhantomLine.put(new NullablePair&lt;ID, ID&gt;(queue.getMediaID(), entry.getKey()), consolidatedCube.getFirst());</span>
<span class="nc" id="L3281">				}</span>
			}
		}
<span class="fc" id="L3284">	}</span>
	
	/**
	 * Checks to see if all of the trace values in the given AggrForecastedTraceCube are null.
	 * @param tc
	 */
	public boolean isAllNullPredicedValues(AggrForecastedTraceCube tc) {
<span class="pc bpc" id="L3291" title="1 of 2 branches missed.">		if (tc != null) {</span>
<span class="fc" id="L3292">			PredictTraceCube ptc = tc.getPredictTrace();</span>
<span class="pc bpc" id="L3293" title="1 of 2 branches missed.">			if (ptc != null) {</span>
<span class="fc" id="L3294">				return ptc.isAllNull();</span>
			}
		}
<span class="nc" id="L3297">		return true;</span>
	}
	
	/**
	 * Retrieve the consolidated TraceCube from sourceCubes
	 * 
	 * During consolidation it appears to set the Required values to the FTE Differential values???
	 * 
	 * @param entry
	 * @param tv
	 * @param startDate
	 * @param endDate
	 * @throws BbmTimeSeriesException
	 */
	private Pair&lt;TraceCube, TraceCube&gt; getRibbonTraceCube(Map.Entry&lt;ID, TraceCube[]&gt; entry, TrackingView tv, Date startDate, Date endDate)
		throws BbmTimeSeriesException {
<span class="fc" id="L3313">		TraceCube[] serverCubes = entry.getValue(); </span>
		//it has predict and forcast cubes, has to merge them together
<span class="fc" id="L3315">		TraceCube[] uiCubes = PulseUtil.createUICubes(tv, entry.getKey(), startDate, endDate);</span>
<span class="pc bpc" id="L3316" title="1 of 2 branches missed.">		if (uiCubes != null) {</span>
			// init the actual TraceCube
<span class="fc" id="L3318">			PulseUtil.initTraceCube(uiCubes[0]);					</span>
		}
<span class="fc" id="L3320">		PulseUtil.mergeTraceCubes(uiCubes, serverCubes);</span>
			
<span class="fc" id="L3322">		TraceCube forecastCube = uiCubes[1];</span>
<span class="fc" id="L3323">		TraceCube requiredCube = uiCubes[2];</span>
		
<span class="fc" id="L3325">		return new Pair(forecastCube, requiredCube);</span>
	}
	
	/** 
	 *  To show a ot event on calendar, an event place holder will be created
	 *  but before updating shift, the event holder should be removed since ot is never
	 *  saved in format of shift event.
	 */	
	private void removeOTEventHolderBeforeSave(ShiftAssignment shift) {
<span class="nc" id="L3334">		Collection newEvents = shift.getCreatedChildObjects(ShiftAssignmentFields.CHILD_SHIFT_EVENT);</span>
<span class="nc" id="L3335">		removeOTPlaceHolderShiftEvents(newEvents);</span>

<span class="nc" id="L3337">		newEvents = shift.getUpdatedChildObjects(ShiftAssignmentFields.CHILD_SHIFT_EVENT);</span>
<span class="nc" id="L3338">		removeOTPlaceHolderShiftEvents(newEvents);</span>
		
<span class="nc" id="L3340">		Map childrenMap = shift.getChildObjectMap();</span>
<span class="nc bnc" id="L3341" title="All 2 branches missed.">		if (childrenMap != null){</span>
<span class="nc" id="L3342">			Object events = childrenMap.get(NumberFactory.newInteger(ShiftAssignmentFields.CHILD_SHIFT_EVENT));</span>
<span class="nc bnc" id="L3343" title="All 4 branches missed.">			if (events != null &amp;&amp; !((Map)events).isEmpty()) {</span>
<span class="nc" id="L3344">				Collection objs = ((Map) events).values();</span>
<span class="nc" id="L3345">				removeOTPlaceHolderShiftEvents(objs);</span>
			}
		}
<span class="nc" id="L3348">	}</span>
	
	private void removeOTPlaceHolderShiftEvents(Collection events) {
<span class="nc bnc" id="L3351" title="All 4 branches missed.">		if (events != null &amp;&amp; !events.isEmpty()) {</span>
<span class="nc" id="L3352">			ShiftEventAssignment event =  null;</span>
<span class="nc bnc" id="L3353" title="All 2 branches missed.">			for (Iterator i = events.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L3354">				event = (ShiftEventAssignment)i.next();</span>
<span class="nc bnc" id="L3355" title="All 4 branches missed.">				if (event.getID() == null &amp;&amp; event.getShiftEventID() == null &amp;&amp;</span>
<span class="nc bnc" id="L3356" title="All 4 branches missed.">					(event.getOverlayPrecedence() == OVERLAP_PRECEDENCE || event.getOverlayPrecedence()== SWAP_PRECEDENCE)) {</span>
					//2 is for ote before and after place holder event
					//100 is for swap indicators
<span class="nc" id="L3359">					i.remove();</span>
				}
			}
		}
<span class="nc" id="L3363">	}</span>

	/**
	 * Gets all of the verticalized strings needed by the Calendar applet.
	 * @param context
	 * @return A HashMap of PulseKey -&gt; VerticalizedString. The PulseKey keys identify keys 
	 * in the PulseKeys class, while the VerticalizedString values are the verticalized/localized 
	 * strings. 
	 */
	private Map getVerticalizedStrings(RequestContext context) {
<span class="fc" id="L3373">		Map resultMap = new HashMap(10);</span>
<span class="fc" id="L3374">		VerticalizationManager vm = context.getSystemManagerFactory().getVerticalizationManager(); </span>

<span class="fc" id="L3376">		resultMap.put(PulseKeys.CONTACTVOLUME, </span>
<span class="fc" id="L3377">				vm.getVerticalizedString(context, VerticalizationWebBundleKey.BUNDLE_NAME, DefaultVerticalizationManager.CONTACTVOLUME));</span>
<span class="fc" id="L3378">		resultMap.put(PulseKeys.AVERAGEHANDLETIME, </span>
<span class="fc" id="L3379">				vm.getVerticalizedString(context, VerticalizationWebBundleKey.BUNDLE_NAME, DefaultVerticalizationManager.AVERAGEHANDLETIME));</span>
<span class="fc" id="L3380">		resultMap.put(PulseKeys.FILTERBOX_CAMPAIGN,</span>
<span class="fc" id="L3381">				vm.getVerticalizedString(context, BbmWebBundleKey.BUNDLE_NAME,  BbmWebBundleKey.FILTERBOX_CAMPAIGN) );</span>
<span class="fc" id="L3382">		resultMap.put(PulseKeys.CAMPAIGN_SP_SELECTOR_NO_CAMPAIGN_OPTION,</span>
<span class="fc" id="L3383">				vm.getVerticalizedString(context, BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.CAMPAIGN_SP_SELECTOR_NO_CAMPAIGN_OPTION) );</span>


<span class="fc" id="L3386">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_PROJECT,</span>
<span class="fc" id="L3387">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_PROJECT) );</span>

<span class="fc" id="L3389">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_PROJECT_FORECASTED,</span>
<span class="fc" id="L3390">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_PROJECT_FORECASTED) );</span>

<span class="fc" id="L3392">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_PROJECT_REQUIRED,</span>
<span class="fc" id="L3393">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_PROJECT_REQUIRED) );</span>


<span class="fc" id="L3396">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_FTE,</span>
<span class="fc" id="L3397">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_FTE) );</span>

<span class="fc" id="L3399">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_FTED,</span>
<span class="fc" id="L3400">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_FTED) );</span>


<span class="fc" id="L3403">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_FTE_FORECASTED,</span>
<span class="fc" id="L3404">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_FTE_FORECASTED) );</span>

<span class="fc" id="L3406">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_FTE_REQUIRED,</span>
<span class="fc" id="L3407">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_FTE_REQUIRED) );</span>

<span class="fc" id="L3409">		resultMap.put(PulseKeys.FS_FTECALC_PROJECT_QUEUE_NAME,</span>
<span class="fc" id="L3410">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_FTECALC_PROJECT_QUEUE_NAME) );</span>

<span class="fc" id="L3412">		resultMap.put(PulseKeys.FS_CLEARSCHED_TYPE_PROJECT,</span>
<span class="fc" id="L3413">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_CLEARSCHED_TYPE_PROJECT) );</span>

<span class="fc" id="L3415">		resultMap.put(PulseKeys.FS_LOCKMULTI_PROJECTS,</span>
<span class="fc" id="L3416">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_LOCKMULTI_PROJECTS) );</span>

<span class="fc" id="L3418">		resultMap.put(BbmEjbBundleKey.FS_CAL_CONFLICTSGROUP_CAMPAIGNHOO,</span>
<span class="fc" id="L3419">				vm.getVerticalizedString(context, BbmEjbBundleKey.BUNDLE_NAME, BbmEjbBundleKey.FS_CAL_CONFLICTSGROUP_CAMPAIGNHOO) );</span>

<span class="fc" id="L3421">		resultMap.put(BbmEjbBundleKey.CAMPAIGN_HOO,</span>
<span class="fc" id="L3422">				vm.getVerticalizedString(context, BbmEjbBundleKey.BUNDLE_NAME, BbmEjbBundleKey.CAMPAIGN_HOO) );</span>


<span class="fc" id="L3425">		resultMap.put(FsWebBundleKey.FS_CAL_TOOLBAR_TOOLTIP_CAMPAIGNTIMEZONE,</span>
<span class="fc" id="L3426">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_CAL_TOOLBAR_TOOLTIP_CAMPAIGNTIMEZONE) );</span>


<span class="fc" id="L3429">		resultMap.put(BbmWebBundleKey.SubCampaign,</span>
<span class="fc" id="L3430">				vm.getVerticalizedString(context, BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.SubCampaign) );</span>


		// Added 11.2
		// Scheduler dialog
<span class="fc" id="L3435">		resultMap.put(FsWebBundleKey.FS_SCHEDPARAMS_ALG_SCHEDULEATLEAST,</span>
<span class="fc" id="L3436">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SCHEDPARAMS_ALG_SCHEDULEATLEAST) );</span>

<span class="fc" id="L3438">		resultMap.put(FsWebBundleKey.FS_SCHEDPARAMS_AGENTSTOSCHED,</span>
<span class="fc" id="L3439">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SCHEDPARAMS_AGENTSTOSCHED) );</span>

<span class="fc" id="L3441">		resultMap.put(FsWebBundleKey.FS_SCHEDPARAMS_AGENTPREF_TITLE,</span>
<span class="fc" id="L3442">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SCHEDPARAMS_AGENTPREF_TITLE) );</span>


<span class="fc" id="L3445">		return resultMap;</span>
	}

	/**
	 * Given a distributed parent SP, return the child SPIDs.
	 * @throws RemoteException 
	 * @throws BbmEJBCreateException 
	 * @throws BbmFinderException 
	 */
	private Set getChildSPIDs(RequestContext context, Campaign campaign, Date startDate, Date endDate) 
			throws BbmFinderException, BbmEJBCreateException, RemoteException {
<span class="nc" id="L3456">		Set childSPIDs = new HashSet();</span>

<span class="nc bnc" id="L3458" title="All 4 branches missed.">		if (campaign != null &amp;&amp; campaign.getIsDistributed()) {</span>
			//get the employees from the sub-campaigns					
<span class="nc" id="L3460">			Collection childCampaigns = getCampaignManager(context).getSubCampaignIDs(campaign.getID());</span>
<span class="nc bnc" id="L3461" title="All 2 branches missed.">			for (Iterator it=childCampaigns.iterator(); it.hasNext();) {</span>
<span class="nc" id="L3462">				ID curCampaignID = (ID)it.next();</span>
<span class="nc" id="L3463">				Collection sps = getCampaignManager(context).getSchedulingPeriods(curCampaignID, startDate, endDate);</span>
<span class="nc bnc" id="L3464" title="All 4 branches missed.">				if (sps != null &amp;&amp; sps.size() &gt; 0) {</span>
<span class="nc bnc" id="L3465" title="All 2 branches missed.">					for (Iterator spit=sps.iterator(); spit.hasNext();) {</span>
<span class="nc" id="L3466">						ID curSpID = ((SchedulingPeriod)spit.next()).getID(); </span>
<span class="nc" id="L3467">						childSPIDs.add(curSpID);</span>
						//there should only be a single SP per child campaign because of our date range.
<span class="nc" id="L3469">						break;</span>
					}
				}
<span class="nc" id="L3472">			}</span>
		}
<span class="nc" id="L3474">		return childSPIDs;</span>
	}
	
	
	/**
	 * Get all the employee/phantom ID's assigned to an SP. If this is a parent 
	 * SP, we include all employees assigned to the children SP's.
	 * @throws Exception 
	 */
	private List&lt;ID&gt; getSpEmployeeIDs(RequestContext context, ID spID, Campaign campaign, Date startDate, Date endDate)
			throws Exception {
<span class="fc" id="L3485">		Set&lt;ID&gt; employeeIDs = new HashSet&lt;&gt;();</span>

<span class="fc" id="L3487">		boolean isDistributed = false;</span>
<span class="pc bpc" id="L3488" title="1 of 2 branches missed.">		if (campaign != null) {</span>
<span class="fc" id="L3489">			isDistributed = campaign.getIsDistributed();</span>
<span class="pc bpc" id="L3490" title="1 of 2 branches missed.">			if (isDistributed) {</span>
				//get the employees from the sub-campaigns					
<span class="nc" id="L3492">				Collection childCampaigns = getCampaignManager(context).getSubCampaignIDs(campaign.getID());</span>
<span class="nc bnc" id="L3493" title="All 2 branches missed.">				for (Iterator it=childCampaigns.iterator(); it.hasNext();) {</span>
<span class="nc" id="L3494">					ID curCampaignID = (ID)it.next();</span>
<span class="nc" id="L3495">					Collection sps = getCampaignManager(context).getSchedulingPeriods(curCampaignID, startDate, endDate);</span>
<span class="nc bnc" id="L3496" title="All 4 branches missed.">					if (sps != null &amp;&amp; sps.size()&gt;0) {</span>
<span class="nc bnc" id="L3497" title="All 2 branches missed.">						for (Iterator spit=sps.iterator(); spit.hasNext();) {</span>
<span class="nc" id="L3498">							ID curSpID = ((SchedulingPeriod)spit.next()).getID(); </span>
<span class="nc" id="L3499">							employeeIDs.addAll(getEmployeeIDsForSingleSP(context, curSpID, curCampaignID, startDate, endDate));</span>
							//there should only be a single SP per child campaign because of our date range.
<span class="nc" id="L3501">							break;</span>
						}
					}
<span class="nc" id="L3504">				}</span>
			}
		}

<span class="pc bpc" id="L3508" title="1 of 2 branches missed.">		if (!isDistributed) {</span>
<span class="fc" id="L3509">			employeeIDs.addAll(getEmployeeIDsForSingleSP(context, spID, campaign.getID(), startDate, endDate));</span>
		}

<span class="fc" id="L3512">		return new ArrayList&lt;&gt;(employeeIDs);</span>
	}

	/**
	 * Get all the employee/phantom ID's assigned to a single SP. If this is a parent 
	 * SP, we do not query its children.
	 */
	private Collection getEmployeeIDsForSingleSP(RequestContext context, ID spID, ID campaignID, Date startDate, Date endDate) 
			throws Exception {
<span class="fc" id="L3521">		Collection employeeIDs = new ArrayList();</span>

<span class="fc" id="L3523">		Collection campWorkResources = getCampaignManager(context).getCampaignWorkResourceAssignments(campaignID, startDate, endDate);</span>
<span class="fc" id="L3524">		Collection cPhantoms = getScheduleAccessManager(context).getPhantoms(spID);</span>
<span class="pc bpc" id="L3525" title="1 of 2 branches missed.">		if (campWorkResources != null) {</span>
<span class="fc bfc" id="L3526" title="All 2 branches covered.">			for (Iterator it=campWorkResources.iterator(); it.hasNext();) {</span>
<span class="fc" id="L3527">				employeeIDs.add(((CampaignWorkResource)it.next()).getWorkResourceID());</span>
			}
		}
		
<span class="pc bpc" id="L3531" title="1 of 2 branches missed.">		if (cPhantoms != null) {</span>
<span class="pc bpc" id="L3532" title="1 of 2 branches missed.">			for (Iterator it=cPhantoms.iterator(); it.hasNext();) {</span>
<span class="nc" id="L3533">				employeeIDs.add(((Phantom)it.next()).getID());</span>
			}
		}

<span class="fc" id="L3537">		return employeeIDs;</span>
	}

	/**
	 * Check whether the specified SP is linked to any Dererred, Outbound, Project, or Immediate queues.
	 * @param context
	 * @return an array of 3 Booleans: {bHasDeferredQueue, bHasOutboundQueuue, bHasProjectQueuue, bHasImmediateQueuue}
	 */
	private Boolean[] checkQueueTypes(RequestContext context, ID campaignID, Date fromDate, Date toDate) throws Exception {

<span class="fc" id="L3547">		boolean spHasDeferredQueue = false;</span>
<span class="fc" id="L3548">		boolean spHasOutboundQueue = false;</span>
<span class="fc" id="L3549">		boolean spHasProjectQueue = false;</span>
<span class="fc" id="L3550">		boolean spHasImmediateQueue = false;</span>

		//Get the queues linked to the SP, and see if any of them are deferred or outbound
<span class="fc" id="L3553">		Collection campaignQueueAssignments = getCampaignManager(context).getCampaignQueueAssignments(campaignID, fromDate, toDate); </span>
<span class="fc" id="L3554">		Iterator itCampQueueAsmts = campaignQueueAssignments.iterator();</span>
<span class="fc bfc" id="L3555" title="All 2 branches covered.">		while (itCampQueueAsmts.hasNext()) {</span>
<span class="fc" id="L3556">			CampaignQueue nextCampQ = (CampaignQueue) itCampQueueAsmts.next();</span>
<span class="fc" id="L3557">			ID nextQID = nextCampQ.getQueueID();</span>
<span class="fc" id="L3558">			Queue queue = getWorkloadManager(context).getQueueByID(nextQID);</span>

<span class="pc bpc" id="L3560" title="1 of 2 branches missed.">			if (Media.isMediaDeferred(queue.getMediaID())) {</span>
<span class="nc" id="L3561">				spHasDeferredQueue = true;</span>
<span class="fc bfc" id="L3562" title="All 2 branches covered.">			} else if (Media.isMediaImmediate(queue.getMediaID())) {</span>
<span class="fc" id="L3563">				spHasImmediateQueue = true;</span>
<span class="pc bpc" id="L3564" title="1 of 2 branches missed.">			} else if (queue.getMediaID().equals(Media.MEDIA_ID_PHONE_OUTBOUND)) {</span>
<span class="fc" id="L3565">				spHasOutboundQueue = true;</span>
<span class="nc bnc" id="L3566" title="All 2 branches missed.">			} else if (queue.getMediaID().equals(Media.MEDIA_ID_PROJECT)) {</span>
<span class="nc" id="L3567">				spHasProjectQueue = true;				</span>
			}

<span class="pc bpc" id="L3570" title="7 of 8 branches missed.">			if (spHasDeferredQueue &amp;&amp; spHasOutboundQueue &amp;&amp; spHasProjectQueue &amp;&amp; spHasImmediateQueue) {</span>
<span class="nc" id="L3571">				break;</span>
			}
<span class="fc" id="L3573">		}</span>

<span class="fc" id="L3575">		return new Boolean[]{Boolean.valueOf(spHasDeferredQueue), Boolean.valueOf(spHasOutboundQueue), Boolean.valueOf(spHasProjectQueue), </span>
<span class="fc" id="L3576">			Boolean.valueOf(spHasImmediateQueue)};</span>
	}

	private void getServiceLevelRibbons(RequestContext context, Map appletResponse, ID spID, Date startDate, 
			Date endDate) throws Exception{
<span class="fc" id="L3581">		Collection&lt;SPQueue&gt; spQueues = getCampaignManager(context).getSPQueuesBySPID(spID);</span>

		//Get the SP
<span class="fc" id="L3584">		SchedulingPeriod sp = getCampaignManager(context).getSchedulingPeriodByID(spID);</span>

		// Get the campaign
<span class="fc" id="L3587">		Campaign campaign = getCampaignManager(context).getCampaignByID(sp.getCampaignID());</span>

		//load TraceCubes
<span class="fc" id="L3590">		List&lt;Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt;&gt; traceCubes = getStatisticRibbons(context, appletResponse, sp, spQueues);</span>
<span class="fc" id="L3591">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; forecastLine = traceCubes.get(0);</span>
<span class="fc" id="L3592">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; requiredLine = traceCubes.get(1);</span>
<span class="pc bpc" id="L3593" title="1 of 2 branches missed.">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; noPhantomLine = traceCubes.size() &gt; 2 ? traceCubes.get(2) : null;</span>
		
<span class="fc" id="L3595">		appletResponse.put(PageKeys.SERVICELEVEL_RIBBONS, forecastLine);</span>
<span class="fc" id="L3596">		appletResponse.put(PageKeys.RIBBONS_REQUIREDLINE, requiredLine);</span>
<span class="fc" id="L3597">		appletResponse.put(FsKeys.RIBBONS_NOPAHNTOMLINE, noPhantomLine);</span>

		//check if the SP has a deferred/outbound queues as well
<span class="fc" id="L3600">		Boolean[] queueTypes = checkQueueTypes(context, sp.getCampaignID(), startDate, endDate);</span>
<span class="fc" id="L3601">		appletResponse.put(PageKeys.HAS_DEFERRED_QUEUE, queueTypes[0]);</span>
<span class="fc" id="L3602">		appletResponse.put(PageKeys.HAS_OUTBOUND_QUEUE, queueTypes[1]);</span>
<span class="fc" id="L3603">		appletResponse.put(PageKeys.HAS_PROJECT_QUEUE, queueTypes[2]);</span>
<span class="fc" id="L3604">		appletResponse.put(PageKeys.HAS_IMMEDIATE_QUEUE, queueTypes[3]);</span>
<span class="fc" id="L3605">		appletResponse.put(PageKeys.FS_FEATURES, getFsFeatures(context));</span>

		//Get a map (queue SID -&gt; ServiceGoalsType) for each queue in the SP
<span class="fc" id="L3608">		appletResponse.put(PageKeys.QUEUE_GOAL_MAP, getQueueGoalsMap(spQueues));</span>

		// Get a map (queue SID -&gt; PCA goal seconds) for each queue in the SP
<span class="fc" id="L3611">		appletResponse.put(PageKeys.QUEUE_SERVICE_LEVEL_GOAL_SECONDS_MAP, getQueueServiceLevelGoalSecondsMap(spQueues, </span>
<span class="fc" id="L3612">			sp.getSkillBased()));</span>

		// Get shrinkage and modeling factors
<span class="fc" id="L3615">		Pair&lt;float[], float[]&gt; shrinkageAndModelingFactors = getShrinkageAndModelingFactorsForSP(campaign, sp);</span>
<span class="fc" id="L3616">		appletResponse.put(PageKeys.SP_SHRINKAGE, shrinkageAndModelingFactors.getFirst());</span>
<span class="fc" id="L3617">		appletResponse.put(PageKeys.SP_MODELING_FACTORS, shrinkageAndModelingFactors.getSecond());</span>

		// For an unskilled SP we add raw (no min occupancy) FTE values to assist in
		// doing real-time service level calculations.
<span class="pc bpc" id="L3621" title="1 of 2 branches missed.">		if (!sp.getSkillBased()) {</span>
<span class="nc" id="L3622">			appletResponse.put(PageKeys.QUEUE_REQUIRED_FTE_NO_MIN_OCCUPANCY, getQueueRequiredFTEForRealTimeServiceLevelMap(</span>
<span class="nc" id="L3623">					context, sp.getCampaignID(), spQueues, startDate, endDate, false, false));</span>
<span class="nc" id="L3624">			appletResponse.put(WfmPageKeys.QUEUE_REQUIRED_FTE_WITH_MIN_OCCUPANCY, getQueueRequiredFTEForRealTimeServiceLevelMap(</span>
<span class="nc" id="L3625">					context, sp.getCampaignID(), spQueues, startDate, endDate, true, false));</span>
		}

		//Get all employee &amp; phantom ID's liked to the scheduling period
<span class="fc" id="L3629">		List&lt;ID&gt; employeeIDs = getSpEmployeeIDs(context, spID, campaign, startDate, endDate);</span>

		//Get all employee &amp; phantom ChatSession counts
<span class="fc" id="L3632">		Map&lt;ID, Integer&gt; hashEmployeeChatSessions = getWorkResourceManager(context).getNumberOfChatSessionsForEmployees(employeeIDs, false);</span>
<span class="fc" id="L3633">		appletResponse.put(FsKeys.EMPLOYEE_CHAT_SESSIONS, hashEmployeeChatSessions);</span>
<span class="fc" id="L3634">	}</span>
	
	private Pair&lt;float[], float[]&gt; getShrinkageAndModelingFactorsForSP(Campaign c, SchedulingPeriod sp)
			throws RemoteException, BbmException {
<span class="fc" id="L3638">		Collection&lt;SPShrinkage&gt; spShrinkage = m_campaignManager.getOrCreateSPShrinkageBySPID(sp.getID());</span>
<span class="fc" id="L3639">		TimeContext tc = TimeContextFactory.getTimeContext(c);</span>
		// Create arrays for shrinkage and modeling factor values
<span class="fc" id="L3641">		float[] shrinkage = FteRequirementsTimeSeriesUtil.getShrinkageValuesFromSPShrinkage(spShrinkage, sp, tc);</span>
<span class="fc" id="L3642">		float[] modelingFactors = FteRequirementsTimeSeriesUtil.getModelingFactorsFromSPShrinkage(spShrinkage, sp, tc);</span>
<span class="fc" id="L3643">		return new Pair&lt;float[], float[]&gt;(shrinkage, modelingFactors);</span>
	}


	private String getLocaleID(String locale, Map&lt;String,String&gt; localeMap) {
<span class="fc" id="L3648">		String localeID =  &quot;1033&quot;;</span>
<span class="pc bpc" id="L3649" title="1 of 2 branches missed.">		if(localeMap != null) {</span>
<span class="fc" id="L3650">			Map&lt;String,String&gt; langCodeMap = new HashMap(0);</span>

<span class="fc" id="L3652">			String langKey = &quot;SupportedRegionalFormats&quot;;</span>
<span class="fc" id="L3653">			String langCodeKey = &quot;SupportedRegionalFormatLocaleIDs&quot;;</span>

<span class="fc" id="L3655">			String langValue = localeMap.get(langKey);</span>
<span class="fc" id="L3656">			String langCodeValue = localeMap.get(langCodeKey);</span>

<span class="pc bpc" id="L3658" title="2 of 4 branches missed.">			if (langValue == null || langCodeValue == null) {</span>
				//should not, it is read from dbconfig table, but just in case here
<span class="nc" id="L3660">				return localeID;</span>
			}
<span class="fc" id="L3662">			String[] langArray = langValue.split(&quot;,&quot;);</span>
<span class="fc" id="L3663">			String[] langCodeArray = langCodeValue.split(&quot;,&quot;);</span>

<span class="pc bpc" id="L3665" title="1 of 2 branches missed.">			for(int i =0; i&lt;langArray.length; i++ ){</span>
<span class="fc" id="L3666">				langCodeMap.put(langArray[i], langCodeArray[i]);</span>
<span class="pc bpc" id="L3667" title="1 of 2 branches missed.">				if(langArray[i].equals(locale)) {</span>
<span class="fc" id="L3668">					localeID = langCodeArray[i];</span>
<span class="fc" id="L3669">					break;</span>
				}
			}
		}

<span class="fc" id="L3674">		return localeID;</span>
	}

	/**
	 * Returns true if the viewing time zone is overridden (i.e. we are viewing
	 * data in the user's time zone defined in user prefs).  If it is not overridden,
	 * then we are viewing data in the campaign's time zone.
	 */
	protected void isTimeZoneOverridden(RequestContext context, Map appletResponse) {
<span class="fc" id="L3683">		appletResponse.put(PageKeys.IS_TIMEZONE_OVERRIDDEN_RETVAL,</span>
<span class="fc" id="L3684">				SelectionCacheUtil.isTimeZoneOverridden(context));</span>
<span class="fc" id="L3685">	}</span>
	
	/**
	 * Toggles the cached viewing time zone override between on/off states.
	 * If it is on, that means the user will be viewing data in their time
	 * zone (defined in user preferences).  If it is off, then the user will
	 * be viewing data in the selected campaign's time zone.
	 */
	protected void toggleTimeZoneOverride(RequestContext context) {
<span class="nc" id="L3694">		SelectionCacheUtil.toggleTimeZoneOverride(context);</span>
<span class="nc" id="L3695">	}</span>
	
	/**
	 * Returns the child organization IDs belonging to the given orgs.  The returned value
	 * also includes the IDs contained in the parameter parentOrgIDs.
	 */
	protected Collection&lt;ID&gt; getChildAndSelfOrganizationIDs(
			RequestContext context,
			Collection&lt;ID&gt; parentOrgIDs) throws RemoteException, BbmException {
<span class="fc" id="L3704">		return OrganizationModelHandler.getSelfAndChildOrganizationIDs(context, parentOrgIDs);</span>
	}
	
	
	private BbmCoachingBridgeInterface getCoachingBridgeInterface() throws CoreEJBCreateException, CoreFinderException, 
			RemoteException, ClassNotFoundException, InstantiationException, IllegalAccessException, BbmFinderException {
<span class="nc bnc" id="L3710" title="All 2 branches missed.">		if (m_bbmCoachingBridge == null) {</span>
			//get the implementation class of the BBM-Coaching bridge from the global code registry
<span class="nc" id="L3712">			GCRManager 	gcrManager 	= CoreManagerFactory.getGCRManagerRemote(false);</span>
<span class="nc" id="L3713">			Collection 	entries 	= gcrManager.getGCREntryOfType(BbmCoachingBridgeInterface.GCR_NAME);</span>
<span class="nc bnc" id="L3714" title="All 4 branches missed.">			if (entries == null || entries.isEmpty()) {</span>
<span class="nc" id="L3715">				throw new BbmFinderException(FsWebBundleKey.FS_CAL_ERR_ERROR_GETTING_GCRMANAGER_BRIDGE_ENTRIES, </span>
					new Object[]{BbmCoachingBridgeInterface.GCR_NAME});
			} 
			//should only have one entry if the customer has the license of coaching
<span class="nc" id="L3719">			GCREntry entry = (GCREntry)entries.iterator().next();</span>
<span class="nc" id="L3720">			Class bridgeClass = Class.forName(entry.getHook());</span>

<span class="nc" id="L3722">			m_bbmCoachingBridge = (BbmCoachingBridgeInterface)bridgeClass.newInstance();</span>
		}
<span class="nc" id="L3724">		return m_bbmCoachingBridge;</span>
	}

	private String getFsFeatures(RequestContext context) {
		try {
<span class="fc" id="L3729">			String fsFeatures = getDBManager(context).getValue(FsKeys.FEATURES);</span>
<span class="pc bpc" id="L3730" title="1 of 2 branches missed.">			return fsFeatures == null ? &quot;&quot; : fsFeatures;</span>
<span class="nc" id="L3731">		} catch (Exception e) {</span>
<span class="nc" id="L3732">			return &quot;&quot;;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>