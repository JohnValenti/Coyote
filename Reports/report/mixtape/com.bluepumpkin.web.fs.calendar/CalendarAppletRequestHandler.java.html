<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CalendarAppletRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.calendar</a> &gt; <span class="el_source">CalendarAppletRequestHandler.java</span></div><h1>CalendarAppletRequestHandler.java</h1><pre class="source lang-java linenums">/*
 * 2002-2013 Verint Systems, Inc.
 */
package com.bluepumpkin.web.fs.calendar;

import java.rmi.RemoteException;
import java.util.*;
import java.util.Arrays;

import com.bluepumpkin.common.base.BPException;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.NullablePair;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.datatypes.TimeContext;
import com.bluepumpkin.common.datatypes.TimeOfDay;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.NumberFactory;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignWorkResource;
import com.bluepumpkin.ejb.bbm.campaign.model.FTECalculator;
import com.bluepumpkin.ejb.bbm.campaign.model.SP;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueueFieldInfo;
import com.bluepumpkin.ejb.bbm.campaign.model.SPShrinkage;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingRequest;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingSession;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingState;
import com.bluepumpkin.ejb.bbm.coaching.BbmCoachingBridgeInterface;
import com.bluepumpkin.ejb.bbm.config.ejb.DBConfigManager;
import com.bluepumpkin.ejb.bbm.elearning.BbmELearningBridgeInterface;
import com.bluepumpkin.ejb.bbm.elearning.model.LearningAssignmentInt;
import com.bluepumpkin.ejb.bbm.employeefilter.ejb.EmployeeFilter;
import com.bluepumpkin.ejb.bbm.employeefilter.model.Filter;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.EmpWorkRuleManager;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpPoolingRule;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpTimeBank;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRule;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceMonthlyMinMaxHour;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceWorkPattern;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.paypolicy.ejb.PayPolicyManager;
import com.bluepumpkin.ejb.bbm.pulse.ejb.TrackingManager;
import com.bluepumpkin.ejb.bbm.pulse.model.TrackingView;
import com.bluepumpkin.ejb.bbm.pulse.util.PulseUtil;
import com.bluepumpkin.ejb.bbm.rm.ShiftSwapCalendarInfo;
import com.bluepumpkin.ejb.bbm.rm.ShiftSwapCalendarInfoManager;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.BbmScheduleConflict;
import com.bluepumpkin.ejb.bbm.schedule.model.BbmScheduleConflictException;
import com.bluepumpkin.ejb.bbm.schedule.model.BbmScheduleConflictResolutions;
import com.bluepumpkin.ejb.bbm.schedule.model.CalendarEvent;
import com.bluepumpkin.ejb.bbm.schedule.model.CalendarEventAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.CalendarEventTemplate;
import com.bluepumpkin.ejb.bbm.schedule.model.FloatingEventTemplate;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignmentFields;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftEventAssignment;
import com.bluepumpkin.ejb.bbm.skill.ejb.SkillManager;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.time.TimeContextFactory;
import com.bluepumpkin.ejb.bbm.timeseries.model.AggrForecastedTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.PredictTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.RequireTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.vo.HOOPeriod;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.MediaType;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.ServiceGoalsType;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.PersonData;
import com.bluepumpkin.ejb.bbm.workresource.model.Phantom;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourceAssignment;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.core.CoreEJBCreateException;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.facade.FacadeEJBCreateException;
import com.bluepumpkin.ejb.facade.FacadeManagerFactory;
import com.bluepumpkin.ejb.facade.corbafacade.ejb.FacadeCorbaFacadeManager;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.core.applet.AppletError;
import com.bluepumpkin.web.core.applet.AppletIO;
import com.bluepumpkin.web.core.applet.AppletRH;
import com.bluepumpkin.web.core.applet.TextAppletIO;
import com.bluepumpkin.web.core.cache.SelectionCacheUtil;
import com.bluepumpkin.web.core.keys.PageKeys;
import com.bluepumpkin.web.fs.Log;
import com.bluepumpkin.web.fs.calendar.data.EventTemplateExceptionCreateData;
import com.bluepumpkin.web.fs.calendar.data.SPQueueTraceCubeData;
import com.bluepumpkin.web.fs.keys.FsKeys;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.pulse.keys.PulseKeys;
import com.verint.ejb.bbm.forecast.ejb.ForecastTimeSeriesManager;
import com.verint.ejb.bbm.fterequirements.ejb.FteRequirementsManager;
import com.verint.ejb.bbm.fterequirements.model.RequiredTimeSeries;
import com.verint.ejb.bbm.fterequirements.util.FteRequirementsTimeSeriesUtil;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.fs.keys.WfmPageKeys;
import com.verint.web.fs.optimization.forecasting.l10n.ForecastingWebBundleKey;
import com.verint.web.fs.organization.OrgCalendarOptionsMH;
import com.witness.ejb.core.base.CoreFinderException;
import com.witness.ejb.core.gcr.ejb.GCRManager;
import com.witness.ejb.core.gcr.model.GCREntry;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.licensing.ejb.LicenseManager;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.ejb.core.security.UserManager;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.VerticalizationWebBundleKey;
import com.witness.web.uif.pagecomponent.screentoggler.ScreenTogglerPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.cache.UserCacheManager;
import com.witness.web.uif.system.manager.VerticalizationManager;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;

<span class="fc" id="L146">public class CalendarAppletRequestHandler extends AppletRH{</span>
<span class="fc" id="L147">	private CampaignManager m_campaignManager = null;</span>
<span class="fc" id="L148">	private ScheduleAccessManager m_scheduleAccessManager = null;</span>
<span class="fc" id="L149">	private WorkResourceManager m_workResourceManager = null;</span>
<span class="fc" id="L150">	private SkillManager m_skillManager = null;</span>
<span class="fc" id="L151">	private PayPolicyManager m_payPolicyManager = null;</span>
<span class="fc" id="L152">	private WorkloadManager m_workloadManager = null;</span>
<span class="fc" id="L153">	private WorkRuleManager m_workruleManager = null;</span>
<span class="fc" id="L154">	private EmployeeFilter m_empFilterManager = null;</span>
<span class="fc" id="L155">	private DBConfigManager m_dbManager = null;</span>
	private ResourceBundle m_fs_bundle;
<span class="fc" id="L157">	private EmpWorkRuleManager m_empWorkRuleManager = null;</span>
<span class="fc" id="L158">	private FteRequirementsManager m_fteRequirementsManager = null;</span>
<span class="fc" id="L159">	private TrackingManager m_trackingManager = null;</span>
<span class="fc" id="L160">	private ActivityManager m_activityManager = null;</span>
<span class="fc" id="L161">	private FacadeCorbaFacadeManager m_facadeCorbaFacadeManager = null;</span>
	private BbmELearningBridgeInterface m_bbmELearningBridge;
	private BbmCoachingBridgeInterface m_bbmCoachingBridge;
	private ShiftSwapCalendarInfoManager m_shiftSwapManager;
<span class="fc" id="L165">	private LicenseManager m_licenseManager = null;</span>
<span class="fc" id="L166">	private ForecastTimeSeriesManager m_forecastManager = null;</span>
<span class="fc" id="L167">	private UserManager m_userManager = null;</span>
<span class="fc" id="L168">	private static final Category log = Log.initCategory(CalendarAppletRequestHandler.class.getName(), FsWebBundleKey.BUNDLE_NAME);</span>
	private static final int DEFAULT_CHUNK_SIZE = 50;
	private static final int OVERLAP_PRECEDENCE = 2;
	private static final int SWAP_PRECEDENCE = 100;
	private static final int DEFAULT_EMPLOYEE_CHUNK_SIZE = 100;
	private static final String CALENDAR_EMPLOYEE_CHUNK_SIZE = &quot;CalendarEmployeeChunkSize&quot;;

	private void processGetData(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="fc" id="L176">		String msgID = FsWebBundleKey.FS_CAL_REQHNDLR_UNKNOWN_REQUEST_TYPE;</span>
<span class="fc" id="L177">		Locale locale = context.getLocaleContext().getLanguageLocale();</span>
		try {
<span class="fc" id="L179">			String typeData = (String) appletRequest.get(PageKeys.GET_TYPE);</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">			if (PageKeys.GET_EMPLOYEE_NAMES.equals(typeData)) {</span>
<span class="fc" id="L181">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_EMPLOYEES;</span>
<span class="fc" id="L182">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L183">				Map hashEmployeeNames = this.getWorkResourceManager(context, appletResponse, locale).getWorkResourceNamesByIDs(employeeIDs);</span>
<span class="fc" id="L184">				addResponseData(hashEmployeeNames, appletResponse);</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">			} else if (FsKeys.GET_EMPLOYEE_BASIC.equals(typeData)) {</span>
<span class="fc" id="L186">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_EMPLOYEES;</span>
<span class="fc" id="L187">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L188">				Map hashEmployeeStartEnd = this.getWorkResourceManager(context, appletResponse, locale).getEmployeeStartEnd(employeeIDs);</span>
<span class="fc" id="L189">				addResponseData(hashEmployeeStartEnd, appletResponse);</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">			} else if (FsKeys.GET_EMPLOYEE_PROFICIENCY.equals(typeData)) {</span>
<span class="fc" id="L191">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_EMPLOYEES;</span>
<span class="fc" id="L192">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L193">				Map hashEmployeeProficiencies = null;</span>
<span class="pc bpc" id="L194" title="2 of 4 branches missed.">				if (employeeIDs != null &amp;&amp; employeeIDs.size()&gt;0) {</span>
<span class="fc" id="L195">					Date timeSpot = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L196">					hashEmployeeProficiencies = this.getWorkResourceManager(context, appletResponse, locale).getWorkResourceProficiency(employeeIDs, timeSpot);</span>
<span class="fc" id="L197">				} else {</span>
<span class="nc" id="L198">					hashEmployeeProficiencies = new HashMap();</span>
				}				
<span class="fc" id="L200">				addResponseData(hashEmployeeProficiencies, appletResponse);</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">			} else if (FsKeys.GET_CLASS_SESSIONS.equals(typeData)) {</span>
				//load class sessions from db
<span class="nc" id="L203">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_FLOATINGID_FORLESSONS;</span>
<span class="nc" id="L204">				Collection&lt;ID&gt; classIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EVENTTEMPLATE_ID);</span>
<span class="nc" id="L205">				Collection&lt;Collection&lt;CalendarEventAssignment&gt;&gt; sessions = this.getScheduleAccessManager(context, appletResponse, locale).getCalendarEventAssignmentsForCalendarEventTemplate(classIDs);</span>
<span class="nc" id="L206">				Iterator&lt;ID&gt; iClass = classIDs.iterator();</span>
<span class="nc" id="L207">				Iterator&lt;Collection&lt;CalendarEventAssignment&gt;&gt; iSessions = sessions.iterator();</span>
<span class="nc" id="L208">				Map&lt;ID, Collection&lt;CalendarEventAssignment&gt;&gt; mapClassSession = new HashMap&lt;ID, Collection&lt;CalendarEventAssignment&gt;&gt;(classIDs.size());</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">				while (iClass.hasNext()) {</span>
<span class="nc" id="L210">					mapClassSession.put(iClass.next(), iSessions.next());</span>
				}
<span class="nc" id="L212">				addResponseData(mapClassSession, appletResponse);</span>
				
<span class="pc bfc" id="L214" title="All 2 branches covered.">			} else if (PageKeys.GET_EVENTS.equals(typeData)) {</span>
<span class="fc" id="L215">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_EVENT_DATA;</span>
<span class="fc" id="L216">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L217">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L218">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L219">				Pair eventsAndTemplates = new Pair();</span>
<span class="fc" id="L220">				Collection collectionEvents = this.getScheduleAccessManager(context, appletResponse, locale).getEventsForWorkResources(employeeIDs, startDate, endDate);</span>
<span class="fc" id="L221">				Collection colletionTemplates = this.getScheduleAccessManager(context, appletResponse, locale).getEventTemplatesForWorkResourceIDs(employeeIDs, startDate, endDate);</span>
<span class="fc" id="L222">				eventsAndTemplates.setFirst(collectionEvents);</span>
<span class="fc" id="L223">				eventsAndTemplates.setSecond(colletionTemplates);</span>
<span class="fc" id="L224">				addResponseData(eventsAndTemplates, appletResponse);</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">			} else if (PageKeys.GET_PUBLISHING_PERIOD.equals(typeData)) {</span>
<span class="fc" id="L226">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_PUBLISHING_PERIOD;</span>
<span class="fc" id="L227">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L228">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L229">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L230">				Collection periods = null;</span>
<span class="fc" id="L231">				periods = this.getScheduleAccessManager(context, appletResponse, locale).getPublishedPeriods(employeeIDs, startDate, endDate);</span>
<span class="fc" id="L232">				addResponseData(periods, appletResponse);</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">			} else if (PageKeys.GET_SHIFTS.equals(typeData)) {</span>
<span class="fc" id="L234">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;</span>
<span class="fc" id="L235">				Map mapShifts = null;</span>
				//return all shifts
<span class="fc" id="L237">				mapShifts= ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context, appletResponse, locale).getAllShifts());</span>
<span class="fc" id="L238">				addResponseData(mapShifts, appletResponse);</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">			} else if (FsKeys.GET_SCREEN_TOGGLE_STATE.equals(typeData)) {</span>
<span class="nc" id="L240">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;</span>
				
				//the following screen toggler state key is from screen definition and web suite will pass to javascript
				//during init and don't keep in session. so applet can not get it. but since it is coming from screen
				//definition, it is ok to hard code here. but be aware of the key may not work if screen definition changed later.
<span class="nc" id="L245">				String screenTogglerStateKey = &quot;campaign_sp_people_selection?isDistributedCampaignEnabled=true-campaign_sp_people_summary&quot;;</span>
<span class="nc" id="L246">				Integer value = ScreenTogglerPC.getSessionState(context, screenTogglerStateKey);</span>
<span class="nc bnc" id="L247" title="All 4 branches missed.">				boolean isFullScreenCalendar = (value != null &amp;&amp; value.intValue()==0)?true:false;</span>
<span class="nc" id="L248">				addResponseData(Boolean.valueOf(isFullScreenCalendar), appletResponse);</span>
<span class="pc bfc" id="L249" title="All 2 branches covered.">			} else if (FsKeys.GET_EMPLOYEE_FILTERS.equals(typeData)) {</span>
<span class="fc" id="L250">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_ORGANIZATION_FILTER;</span>
<span class="fc" id="L251">				Collection filters = getEmployeeFilterManager(context, appletResponse, locale).getFiltersByUserID(context.getUser().getID());</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">				filters = filters == null? new ArrayList():filters;</span>
<span class="fc" id="L253">				ArrayList filterNames = new ArrayList();</span>
<span class="fc" id="L254">				Filter filter = null;</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">				for (Iterator i = filters.iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L256">					filter = (Filter)i.next();</span>
<span class="fc" id="L257">					filterNames.add(filter.getFilterName());</span>
				}
<span class="fc" id="L259">				addResponseData(filterNames, appletResponse);</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">			} else if (FsKeys.GET_SHIFT_IDS.equals(typeData)) {</span>
<span class="fc" id="L261">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;</span>
<span class="fc" id="L262">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L263">				Collection&lt;ID&gt; empIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L264">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L265">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L266">				Collection&lt;ID&gt; shiftIDsInOrder = null;</span>
				//return all shift ot extension that available for the current set of employee
				//in the specific time range	
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">				if (campaignID != null) {</span>
<span class="fc" id="L270">					shiftIDsInOrder= getCampaignManager(context, appletResponse, locale).getShift(campaignID, startDate, endDate);</span>
				} else {
<span class="nc" id="L272">					shiftIDsInOrder= getWorkRuleManager(context, appletResponse, locale).getShiftIDsOrderByName(empIDs, startDate, endDate);</span>
				}
<span class="fc" id="L274">				addResponseData(shiftIDsInOrder, appletResponse);</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">			} else if (PageKeys.GET_SHIFTOTEXTENSION.equals(typeData)) {</span>
<span class="fc" id="L276">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFTOTEXTENSION;</span>
<span class="fc" id="L277">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L278">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L279">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
				//angela: for org scope it should return the list of ot extension available for 
				//the current selection of employees in the current time range.
<span class="fc" id="L282">				Map mapShiftOTE = null;</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">				if (campaignID == null) {</span>
					//return all shift ot extension that available for the current set of employee
					//in the specific time range
<span class="fc" id="L286">					Collection&lt;ID&gt; empIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L287">					mapShiftOTE= ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context, appletResponse, locale).getShiftOTExtension(empIDs, startDate, endDate));</span>
<span class="fc" id="L288">				} else </span>
					//return shifts under the campaign only.
<span class="fc" id="L290">					mapShiftOTE = ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context, appletResponse, locale).getShiftOTExtension(new ScopeID(campaignID, Scope.CAMPAIGN_SCOPE), startDate, endDate)); //campaignID should be SID</span>
<span class="fc" id="L291">				addResponseData(mapShiftOTE, appletResponse);</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">			} else if (PageKeys.GET_SHIFT.equals(typeData)) {</span>
<span class="nc" id="L293">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT;</span>
<span class="nc" id="L294">				ID shiftID = (ID) appletRequest.get(PageKeys.SHIFT_ID);</span>
<span class="nc" id="L295">				Shift shift = this.getWorkRuleManager(context, appletResponse, locale).getShift(shiftID);</span>
<span class="nc" id="L296">				addResponseData(shift, appletResponse);</span>
<span class="pc bfc" id="L297" title="All 2 branches covered.">			} else if (PageKeys.GET_SCHEDULING_STATE.equals(typeData)) {</span>
<span class="fc" id="L298">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;</span>
<span class="fc" id="L299">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L300">				String modeChar = (String)appletRequest.get(FsKeys.MODE_CHAR);	</span>
<span class="fc" id="L301">				SchedulingState state = getCampaignManager(context, appletResponse, locale).getSchedulingState(spID, modeChar);</span>
<span class="fc" id="L302">				addResponseData(state, appletResponse);</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">			} else if (PageKeys.GET_SCHEDULING_SESSION.equals(typeData)) {</span>
<span class="fc" id="L304">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;</span>
<span class="fc" id="L305">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L306">				Collection&lt;SchedulingSession&gt; sessions = getCampaignManager(context, appletResponse, locale).getSPScheduleSession(spID);</span>
<span class="fc" id="L307">				addResponseData(sessions, appletResponse);</span>
<span class="pc bpc" id="L308" title="1 of 2 branches missed.">			} else if (PageKeys.GET_ACTIVITY.equals(typeData)) {</span>
<span class="nc" id="L309">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_ACTIVITY;</span>
<span class="nc" id="L310">				ID activityID = (ID) appletRequest.get(PageKeys.ACTIVITY_ID);</span>
<span class="nc" id="L311">				ActivityManager activityManager = getActivityManager(context, appletResponse, locale);</span>
<span class="nc" id="L312">				Activity activity = activityManager.findActivityById(activityID);</span>
<span class="nc" id="L313">				addResponseData(activity, appletResponse);</span>
<span class="pc bfc" id="L314" title="All 2 branches covered.">			} else if (PageKeys.GET_ACTIVITIES.equals(typeData)) {</span>
<span class="fc" id="L315">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_ACTIVITIES;</span>
<span class="fc" id="L316">				Collection&lt;ID&gt; activityID = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.ACTIVITY_IDS);</span>
<span class="fc" id="L317">				ActivityManager activityManager = getActivityManager(context, appletResponse, locale);</span>
<span class="fc" id="L318">				Collection&lt;Activity&gt; activities = activityManager.findActivities(activityID);</span>
<span class="fc" id="L319">				addResponseData(activities, appletResponse);</span>
<span class="fc bfc" id="L320" title="All 2 branches covered.">			} else if (PageKeys.GET_EVENT_ATTRIBUTES.equals(typeData)) {</span>
<span class="fc" id="L321">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_EVENTATTRIBUTE_DATA;</span>
<span class="fc" id="L322">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L323">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L324">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L325">				Map&lt;ID, Activity&gt; mapActivities = null;</span>
				//angela: in the current release, activity can not be created under campaign. 
<span class="fc" id="L327">				ActivityManager activityManager = getActivityManager(context, appletResponse, locale);</span>
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">				if (campaignID == null) {</span>
					//return all activities
<span class="nc" id="L330">					ActivityFilter activityOrganizationFilter = new ActivityFilter();</span>
<span class="nc" id="L331">					Collection&lt;Activity&gt; activities = activityManager.findActivities(activityOrganizationFilter);</span>
<span class="nc" id="L332">					mapActivities = ValueObjectUtil.getIDObjectMap(activities);</span>
<span class="nc" id="L333">				} else {</span>
					//return the activities created or inherited in the org that links to the campaign.
<span class="fc" id="L335">					Collection&lt;ID&gt; campaignOrgIDs = getCampaignManager(context, appletResponse, locale).getOrganizationsForCampaign(campaignID, startDate, endDate);</span>
<span class="fc" id="L336">					mapActivities = ValueObjectUtil.getIDObjectMap(activityManager.findOrganizationActivities(campaignOrgIDs, true));</span>
				}
<span class="fc" id="L338">				addResponseData(mapActivities, appletResponse);</span>
				
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">			}  else if (PageKeys.GET_REALTIME_STATS_SUPPORT_DATA.equals(typeData)) {</span>
<span class="nc" id="L341">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_QUEUEACTIVITY_DATA;</span>
<span class="nc" id="L342">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L343">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L344">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L345">				SchedulingPeriod sp = getCampaignManager(context, appletResponse, locale).getSchedulingPeriodByID(spID);</span>
<span class="nc" id="L346">				Campaign c = getCampaignManager(context, appletResponse, locale).getCampaignByID(sp.getCampaignID());</span>
<span class="nc" id="L347">				Collection&lt;SPQueue&gt; spQueues = getCampaignManager(context, appletResponse, locale).getSPQueuesBySPID(spID);</span>

				// Get a map (queue SID -&gt; PCA goal seconds) for each queue in the SP
<span class="nc" id="L350">				appletResponse.put(PageKeys.QUEUE_SERVICE_LEVEL_GOAL_SECONDS_MAP, getQueueServiceLevelGoalSecondsMap(spQueues, sp.getSkillBased()));</span>

				// Get shrinkage and modeling factors
<span class="nc" id="L353">				Pair&lt;float[], float[]&gt; shrinkageAndModelingFactors = getShrinkageAndModelingFactorsForSP(c, sp);</span>
<span class="nc" id="L354">				appletResponse.put(PageKeys.SP_SHRINKAGE, shrinkageAndModelingFactors.getFirst());</span>
<span class="nc" id="L355">				appletResponse.put(PageKeys.SP_MODELING_FACTORS, shrinkageAndModelingFactors.getSecond());</span>

				// For an unskilled SP we add raw (no min occupancy) FTE values to assist in
				// doing real-time service level calculations.
<span class="nc bnc" id="L359" title="All 2 branches missed.">				if (!sp.getSkillBased()) {</span>
<span class="nc" id="L360">					appletResponse.put(PageKeys.QUEUE_REQUIRED_FTE_NO_MIN_OCCUPANCY, getQueueRequiredFTEForRealTimeServiceLevelMap(</span>
<span class="nc" id="L361">							context, appletResponse, locale, c.getID(), spQueues, startDate, endDate, false, false));</span>

<span class="nc" id="L363">					appletResponse.put(WfmPageKeys.QUEUE_REQUIRED_FTE_WITH_MIN_OCCUPANCY, getQueueRequiredFTEForRealTimeServiceLevelMap(</span>
<span class="nc" id="L364">							context, appletResponse, locale, c.getID(), spQueues, startDate, endDate, true, false));</span>
				}
<span class="pc bfc" id="L366" title="All 2 branches covered.">			} else if (PageKeys.GET_ACTIVITY_QUEUES.equals(typeData)) {</span>
<span class="fc" id="L367">				msgID = getQueueActivitiesMaps(context, appletRequest, appletResponse, locale);</span>
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">			} else if (FsKeys.GET_CHILD_ACTIVITIES_QUEUES.equals(typeData)) {</span>
<span class="nc" id="L369">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_QUEUEACTIVITY_DATA;</span>
<span class="nc" id="L370">				Collection&lt;ID&gt; spIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
				
<span class="nc" id="L372">				ActivityManager activityManager = getActivityManager(context, appletResponse, locale);</span>
				//TODO AJP: Is this the proper scope for the activities?  I believe this is all undeleted activities
<span class="nc" id="L374">                Collection allActivityIDs = activityManager.findActivitiesIds(new ActivityFilter(ActivityFilter.FILTER_DELETED));</span>
<span class="nc" id="L375">				Map&lt;ID, Collection&lt;ID&gt;&gt; activityToMediaMap = activityManager.findMediaForActivities(allActivityIDs);</span>
				
<span class="nc" id="L377">				Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L378">				Map&lt;ID, ID&gt; queueToSkillMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L379">				Map&lt;ID, ArrayList&lt;ID&gt;&gt; mediaIdToQueueIDMap = new HashMap&lt;ID, ArrayList&lt;ID&gt;&gt;();</span>
<span class="nc" id="L380">				WorkloadManager wm = getWorkloadManager(context, appletResponse, locale);</span>
<span class="nc" id="L381">				Collection&lt;Queue&gt; qCollection = new ArrayList&lt;Queue&gt;();</span>
				
<span class="nc bnc" id="L383" title="All 2 branches missed.">				for(ID spID: spIDs){</span>
<span class="nc" id="L384">					qCollection.addAll(wm.getNonCombinedQueuesByMediaAndSP(null, spID));</span>
					//get a hashmap that links each individual queue in the SP to its skill. If a queue has no skill, it won't be in the map.
<span class="nc" id="L386">					queueToSkillMap.putAll(getCampaignManager(context, appletResponse, locale).getQueueIDToSkillMap(spID));</span>
<span class="nc" id="L387">				}</span>
				
<span class="nc" id="L389">				appletResponse.put(FsKeys.SKILL, queueToSkillMap);</span>
				
				//CRITICAL AJP: We need to Explicitly create IDs from the queue collection. 
				//	Do Not Call: HashMap&lt;ID, Queue&gt; mapQueue = ValueObjectUtil.getIDObjectMap(qCollection);
				//	I am encountering an odd Java issue when iterating through the keySet of a HashMap, which will be done in Jdmo.createInClause(...) 
<span class="nc bnc" id="L394" title="All 2 branches missed.">				for (Queue q : qCollection) {</span>
<span class="nc" id="L395">					queueIds.add(q.getID());</span>
<span class="nc" id="L396">					ArrayList&lt;ID&gt; queuesForMedia = mediaIdToQueueIDMap.get(q.getMediaID());</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">					if (queuesForMedia == null)</span>
<span class="nc" id="L398">						queuesForMedia = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L399">					queuesForMedia.add(q.getID());</span>
<span class="nc" id="L400">					mediaIdToQueueIDMap.put( q.getMediaID(), queuesForMedia);</span>
<span class="nc" id="L401">				}</span>
				
				//findAllActivitiesForQueues just returns queue hopping links.  It is a Map of Queue ID (key) and collection of Activity Ids (value)
				//We then add all activities that are indirectly mapped to the Queues through the media in &quot;Non-Queue Hopping&quot; scenarios.
<span class="nc" id="L405">				Map&lt;ID, ArrayList&lt;ID&gt;&gt; queueToActivityMap = activityManager.findActivitiesDirectlyMappedToQueuesInDB(queueIds);</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">				for (Map.Entry&lt;ID, Collection&lt;ID&gt;&gt; entry : activityToMediaMap.entrySet()) {</span>
<span class="nc" id="L407">					Activity activity = activityManager.findActivityById(entry.getKey());</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">					if (!activity.isQueueHopping()) {</span>
						//Get all queues with Media from entry.getValue()
						//Add this activity to that queueToActivityMap
<span class="nc bnc" id="L411" title="All 2 branches missed.">						for (ID mediaId : entry.getValue()) {</span>
<span class="nc" id="L412">							ArrayList&lt;ID&gt; queuesForMedia = mediaIdToQueueIDMap.get(mediaId);</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">							if (queuesForMedia != null) {</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">								for (ID queueId : queuesForMedia) {</span>
<span class="nc" id="L415">									ArrayList&lt;ID&gt; activityIds = queueToActivityMap.get(queueId);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">									if (activityIds == null) {</span>
<span class="nc" id="L417">										activityIds = new ArrayList&lt;ID&gt;();</span>
									}
<span class="nc" id="L419">									activityIds.add(entry.getKey());</span>
<span class="nc" id="L420">									queueToActivityMap.put(queueId, activityIds);</span>
<span class="nc" id="L421">								}</span>
							}
<span class="nc" id="L423">						}</span>
					}
<span class="nc" id="L425">				}</span>
<span class="nc" id="L426">                appletResponse.put(PageKeys.APPLET_DATA, queueToActivityMap);</span>
                
<span class="pc bfc" id="L428" title="All 2 branches covered.">			} else if (PageKeys.WORKRULES.equals(typeData)) {</span>
<span class="fc" id="L429">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L430">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L431">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L432">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L433">				Collection&lt;ID&gt; list = new ArrayList();</span>
<span class="fc" id="L434">				list.add(new ID(-3002));</span>
<span class="fc" id="L435">				list.addAll(((Collection&lt;ID&gt;)getWorkResourceManager(context, appletResponse, locale).getOrganizationsChildrenByIDs(list)));</span>
<span class="fc" id="L436">				Collection&lt;Organization&gt; allOrgs = getWorkResourceManager(context, appletResponse, locale).getOrganizationsByIDs(list);</span>
<span class="fc" id="L437">				appletResponse.put(PageKeys.ORGANIZATIONS, ValueObjectUtil.getIDObjectMap(allOrgs));</span>
<span class="fc" id="L438">				Map mapOrgHOOs = getWorkResourceManager(context, appletResponse, locale).getHOOPeriod(ValueObjectUtil.getIDFromObjects(allOrgs), startDate, endDate);</span>
<span class="fc" id="L439">				appletResponse.put(PageKeys.ORGANIZATIONHOOS, mapOrgHOOs);				</span>
				//load hasOpsLicense as well
<span class="fc" id="L441">				boolean hasOpsLicense = getLicenserManager(appletResponse, locale).isLicensed(LicenseKeys.APP_Operations);</span>
<span class="fc" id="L442">				appletResponse.put(FsKeys.HAS_OPS_LICENSE, Boolean.valueOf(hasOpsLicense));</span>
							
				//load hasPoolerLincese
<span class="fc" id="L445">				boolean hasPoolerLicense = getLicenserManager(appletResponse, locale).isLicensed(LicenseKeys.APP_CAMP_POOLING);</span>
<span class="fc" id="L446">				appletResponse.put(FsKeys.HAS_POOLER_LICENSE, Boolean.valueOf(hasPoolerLicense));</span>
				
<span class="fc" id="L448">				boolean hasMonthlyLicense = getLicenserManager(appletResponse, locale).isLicensed(LicenseKeys.APP_MONTHLY_FORECAST_AND_RULES);</span>
<span class="fc" id="L449">				appletResponse.put(FsKeys.HAS_MONTHLY_LICENSE, Boolean.valueOf(hasMonthlyLicense));</span>

<span class="fc" id="L451">				boolean hasAdvancedRMLicense = getLicenserManager(appletResponse, locale).isLicensed(LicenseKeys.APP_ADVANCED_RM);</span>
<span class="fc" id="L452">				appletResponse.put(FsKeys.HAS_ADVANCEDRM_LICENSE, Boolean.valueOf(hasAdvancedRMLicense));</span>
				
<span class="fc" id="L454">				appletResponse.put(FsKeys.IS_WHATIFMODE, context.isInWhatIfMode());</span>
				
<span class="fc" id="L456">				DBConfigManager configMgr = getDBManager(context, appletResponse, locale);</span>
<span class="pc bpc" id="L457" title="1 of 2 branches missed.">				appletResponse.put(FsKeys.IS_EXPORTABSENCETYPE, new Boolean(configMgr.getIntValue(&quot;EXPORTABSENCETYPE&quot;)==1)); //secret key.</span>
				
				//  Added key for enabling/disabling Employee filter
<span class="fc" id="L460">				appletResponse.put(FsKeys.EMPLOYEEFILTER_DISABLE, new Boolean (isEmployeeFilterBpconfigEnabled().toString()));</span>

<span class="fc" id="L462">				appletResponse.put(FsKeys.EMPLOYEE_CHUNK_SIZE, new Integer(getEmployeeChunkSize()));</span>

				//Get all employee &amp; phantom ID's liked to the scheduling period
<span class="pc bpc" id="L465" title="2 of 4 branches missed.">				if (campaignID != null &amp;&amp; spID != null) {</span>
<span class="fc" id="L466">					Campaign campaign = getCampaignManager(context, appletResponse, locale).getCampaignByID(campaignID);</span>
<span class="fc" id="L467">					List employeeIDs = getSpEmployeeIDs(context, spID, campaign, startDate, endDate, locale, appletResponse, msgID);</span>
<span class="fc" id="L468">					appletResponse.put(PageKeys.EMPLOYEE_IDS, employeeIDs);</span>
				}
<span class="fc bfc" id="L470" title="All 2 branches covered.">			} else if (FsKeys.IS_SIMPLIFIEDCALENDAR.equals(typeData)) {</span>
<span class="fc" id="L471">				String value = getDBManager(context, appletResponse, locale).getValue(FsKeys.IS_SIMPLIFIEDCALENDAR);</span>
<span class="pc bpc" id="L472" title="1 of 2 branches missed.">				appletResponse.put(FsKeys.IS_SIMPLIFIEDCALENDAR, value==null?false:value.equals(&quot;true&quot;));</span>
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">			} else if( PageKeys.GET_CAMPAIGNHOO_DATA.equals(typeData) ) {</span>
<span class="nc" id="L474">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGNHOOS_DATA;</span>
<span class="nc" id="L475">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L476">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L477">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
								
<span class="nc" id="L479">				Collection campaignHOOAssignments = getCampaignManager(context, appletResponse, locale).getCampaignHOOAssignments(campaignID, startDate, endDate);</span>
				
<span class="nc" id="L481">				HOOPeriod hooPeriod = getCampaignManager(context, appletResponse, locale).getHOOPeriod(campaignID, startDate, endDate);</span>
<span class="nc" id="L482">				appletResponse.put(PageKeys.CAMPAIGN_HOO_PERIOD, hooPeriod);</span>
				
<span class="pc bfc" id="L484" title="All 2 branches covered.">			} else if (FsKeys.STATUS_POLLING_INTERVAL_SECONDS.equals(typeData)) {</span>
<span class="fc" id="L485">				String rawValue = getDBManager(context, appletResponse, locale).getValue(FsKeys.STATUS_POLLING_INTERVAL_SECONDS);</span>
<span class="fc" id="L486">				int value = 5;</span>
				try {
<span class="nc" id="L488">					value = Integer.parseInt(rawValue);</span>
<span class="fc" id="L489">				} catch (NumberFormatException nfe) {</span>
<span class="fc" id="L490">					log.l7dDebug(&quot;STATUS_POLLING_INTERVAL_SECONDS could not be parsed '&quot; + rawValue + &quot;', defaulting to 5 seconds.&quot;);</span>
<span class="nc" id="L491">				}</span>
<span class="fc" id="L492">				appletResponse.put(FsKeys.STATUS_POLLING_INTERVAL_SECONDS, value);</span>
<span class="fc bfc" id="L493" title="All 2 branches covered.">			} else if (PageKeys.GET_CONFLICT_BACKGROUND_DATA.equals(typeData)) {</span>
<span class="fc" id="L494">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CONFLICTCHECKING_DATA;</span>
				// get all input parameters
<span class="fc" id="L496">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L497">				SchedulingPeriod sp = (SchedulingPeriod) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD);</span>
<span class="fc" id="L498">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L499">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L500">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
				// get all output parameters
				TimeZone campaignTimeZone;
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">				if (campaignID != null) {</span>
<span class="fc" id="L504">					Campaign campaign = getCampaignManager(context, appletResponse, locale).getCampaignByID(campaignID);</span>
<span class="fc" id="L505">					Collection campaignHOOAssignments = getCampaignManager(context, appletResponse, locale).getCampaignHOOAssignments(campaignID, startDate, endDate);</span>
<span class="fc" id="L506">					campaignTimeZone = campaign.getTimeZone();</span>
<span class="fc" id="L507">					HOOPeriod hooPeriod = getCampaignManager(context, appletResponse, locale).getHOOPeriod(campaignID, startDate, endDate);</span>
<span class="fc" id="L508">					appletResponse.put(PageKeys.CAMPAIGN_HOO_PERIOD, hooPeriod);</span>
				}

<span class="fc" id="L511">				Map workResourceCampaignAssignments = getCampaignManager(context, appletResponse, locale).getWorkResourceCampaignAssignments(employeeIDs, startDate, endDate);</span>

<span class="fc" id="L513">				Map empOrgAssignments = getEmpOrgAssignments(context, appletResponse, locale, employeeIDs, startDate, endDate);</span>

<span class="fc" id="L515">				Map mapEmpWorkPatternAssignments = getEmpWorkRuleManager(context, appletResponse, locale).getWorkPatternAssignments(employeeIDs, startDate, endDate);</span>
				//load workpattern used by those employees
<span class="fc" id="L517">				Collection colAssignments = null;</span>
<span class="fc" id="L518">				WorkResourceWorkPattern ww= null;</span>
<span class="fc" id="L519">				Set&lt;ID&gt; colWWSID = new HashSet&lt;ID&gt;();</span>
<span class="fc bfc" id="L520" title="All 2 branches covered.">				for (Iterator i = mapEmpWorkPatternAssignments.values().iterator(); i.hasNext();) {</span>
<span class="fc" id="L521">					colAssignments = (Collection)i.next();</span>
<span class="pc bpc" id="L522" title="2 of 4 branches missed.">					if (colAssignments != null &amp;&amp; !colAssignments.isEmpty()) {</span>
<span class="fc bfc" id="L523" title="All 2 branches covered.">						for (Iterator ix = colAssignments.iterator(); ix.hasNext(); ) {</span>
<span class="fc" id="L524">							ww= (WorkResourceWorkPattern)ix.next();</span>
<span class="fc" id="L525">							colWWSID.add(ww.getWorkPatternSID());</span>
						}
					}
				}
<span class="fc" id="L529">				Map mapWorkPatterns = new HashMap();</span>
<span class="fc bfc" id="L530" title="All 2 branches covered.">				if (!colWWSID.isEmpty())</span>
<span class="fc" id="L531">					mapWorkPatterns = ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context, appletResponse, locale).getShiftPatternsByIDs(colWWSID));</span>

<span class="fc" id="L533">				Map mapEmpRotationAssignments = getEmpWorkRuleManager(context, appletResponse, locale).getRotationAssignments(employeeIDs);</span>

<span class="fc" id="L535">				Map mapMinMaxHourAssignments = getEmpWorkRuleManager(context, appletResponse, locale).getMinMaxHourAssignments(employeeIDs, startDate, endDate);</span>
				
<span class="fc" id="L537">				Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L538">				cal.setTime(startDate);</span>
<span class="fc" id="L539">				int year = cal.get(Calendar.YEAR);</span>
<span class="fc" id="L540">				Map&lt;ID, List&lt;WorkResourceMonthlyMinMaxHour&gt;&gt; mapMonthlyMinMaxHourAssignments = getEmpWorkRuleManager(context, appletResponse, locale)</span>
<span class="fc" id="L541">						.getMonthlyMinMaxHourAssignments(employeeIDs, year);</span>
				
				// put all output parameters into the applet response @todo
<span class="fc" id="L544">				Map empWorkRuleAssignment = getEmpWorkRuleManager(context, appletResponse, locale).getComplexWorkRuleAssignments(employeeIDs);</span>
<span class="fc" id="L545">				colAssignments = null;</span>
<span class="fc" id="L546">				WorkResourceComplexWorkRule wc= null;</span>
<span class="fc" id="L547">				Set&lt;ID&gt; colCWSID = new HashSet&lt;ID&gt;();</span>
<span class="fc bfc" id="L548" title="All 2 branches covered.">				for (Iterator i = empWorkRuleAssignment.values().iterator(); i.hasNext();) {</span>
<span class="fc" id="L549">					colAssignments = (Collection)i.next();</span>
<span class="pc bpc" id="L550" title="2 of 4 branches missed.">					if (colAssignments != null &amp;&amp; !colAssignments.isEmpty()) {</span>
<span class="fc bfc" id="L551" title="All 2 branches covered.">						for (Iterator ix = colAssignments.iterator(); ix.hasNext(); ) {</span>
<span class="fc" id="L552">							wc= (WorkResourceComplexWorkRule)ix.next();</span>
<span class="fc" id="L553">							colCWSID.add(wc.getComplexWorkRuleID());</span>
						}
					}
				}
<span class="fc" id="L557">				Map mapWorkRules = new HashMap();</span>
<span class="fc bfc" id="L558" title="All 2 branches covered.">				if (!colCWSID.isEmpty()) {</span>
<span class="fc" id="L559">					mapWorkRules = ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context, appletResponse, locale).getComplexWorkRulesByIDs(colCWSID));</span>
				}
				
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">				appletResponse.put(PageKeys.EMPLOYEE_WORKRULE_ASSIGNMENTS, empWorkRuleAssignment==null?new HashMap():empWorkRuleAssignment);</span>
<span class="fc" id="L563">				appletResponse.put(PageKeys.WORKRULES, mapWorkRules);</span>
<span class="fc" id="L564">				appletResponse.put(PageKeys.EMPLOYEE_CAMPAIGN_ASSIGNMENTS, workResourceCampaignAssignments);</span>
<span class="fc" id="L565">				appletResponse.put(PageKeys.EMPLOYEE_ORGANIZATION_ASSIGNMENTS, empOrgAssignments);</span>
<span class="pc bpc" id="L566" title="1 of 2 branches missed.">				appletResponse.put(PageKeys.EMPLOYEE_WORKPATTERN_ASSIGNMENTS, mapEmpWorkPatternAssignments==null?new HashMap():mapEmpWorkPatternAssignments);</span>
<span class="fc" id="L567">				appletResponse.put(PageKeys.WORKPATTERNS, mapWorkPatterns);</span>
<span class="pc bpc" id="L568" title="1 of 2 branches missed.">				appletResponse.put(PageKeys.EMPLOYEE_ROTATION_ASSIGNMENTS, mapEmpRotationAssignments==null?new HashMap():mapEmpRotationAssignments);</span>
<span class="pc bpc" id="L569" title="1 of 2 branches missed.">				appletResponse.put(PageKeys.EMPLOYEE_MINMAXHOURS_ASSIGNMENTS, mapMinMaxHourAssignments==null?new HashMap():mapMinMaxHourAssignments);</span>
<span class="pc bpc" id="L570" title="1 of 2 branches missed.">				appletResponse.put(FsKeys.EMPLOYEE_MONTHLY_MINMAXHOURS_ASSIGNMENTS, mapMonthlyMinMaxHourAssignments == null ? new HashMap() : mapMonthlyMinMaxHourAssignments);</span>
				
				//load shift events
<span class="pc bpc" id="L573" title="1 of 2 branches missed.">				if (sp != null) {</span>
<span class="fc" id="L574">					appletResponse.put(PageKeys.SHIFTEVENTS, getWorkRuleManager(context, appletResponse, locale).getShiftEventsBySchedulingPeriod(sp));</span>
				} else {
<span class="nc" id="L576">					appletResponse.put(PageKeys.SHIFTEVENTS, getWorkRuleManager(context, appletResponse, locale).getShiftEvents(employeeIDs, startDate, endDate));</span>
				}
<span class="pc bpc" id="L578" title="1 of 2 branches missed.">			} else if (FsKeys.GET_SHIFT_SWAP_INFO.equals(typeData)) {</span>
<span class="nc" id="L579">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L580">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L581">				Collection&lt;ID&gt; employeeIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L582">				List&lt;ShiftSwapCalendarInfo&gt; shiftSwapCalendarInfos = getShiftSwapCalendarInfos(startDate, endDate, new ArrayList&lt;ID&gt;(employeeIDs));</span>
<span class="nc" id="L583">				appletResponse.put(FsKeys.GET_SHIFT_SWAP_INFO, shiftSwapCalendarInfos);</span>
<span class="pc bfc" id="L584" title="All 2 branches covered.">			} else if (PageKeys.GET_CAMPAIGNS.equals(typeData)) {</span>
<span class="fc" id="L585">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_DATA;</span>
<span class="fc" id="L586">				Collection&lt;Campaign&gt; campaigns = getCampaignManager(context, appletResponse, locale).getCampaigns();</span>
<span class="fc" id="L587">				Collection&lt;ID&gt; campaignIDs = ValueObjectUtil.getIDFromObjects(campaigns);</span>
<span class="fc" id="L588">				Map&lt;ID, Integer&gt; spsByCampaignID = getCampaignManager(context, appletResponse, locale).getCampaignSIDAttachedSchedulingPeriodCountMap(campaignIDs);</span>
				// Only return campaigns that have at least one attached SP.
<span class="fc" id="L590">				Collection&lt;Campaign&gt; filteredCampaigns = new ArrayList&lt;Campaign&gt;();</span>
<span class="fc bfc" id="L591" title="All 2 branches covered.">				for (Campaign c : campaigns) {</span>
<span class="fc" id="L592">					Integer spCount = spsByCampaignID.get(c.getID());</span>
<span class="pc bpc" id="L593" title="1 of 4 branches missed.">					if (spCount != null &amp;&amp; spCount &gt; 0) {</span>
<span class="fc" id="L594">						filteredCampaigns.add(c);</span>
					}
<span class="fc" id="L596">				}</span>
<span class="fc" id="L597">				appletResponse.put(PageKeys.CAMPAIGNS, filteredCampaigns);</span>

                //load verticalized strings map as well
<span class="fc" id="L600">                Map verticalizedStringMap = getVerticalizedStrings(context, appletRequest, appletResponse, locale);</span>
<span class="fc" id="L601">                appletResponse.put(PageKeys.VERTICALIZED_STRINGS, verticalizedStringMap);</span>

<span class="fc bfc" id="L603" title="All 2 branches covered.">			} else if (PageKeys.GET_CAMPAIGN_SCHEDULEPERIODS.equals(typeData)) {</span>
<span class="fc" id="L604">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_SCHEDULING_PERIODS;</span>
<span class="fc" id="L605">				Campaign campaign = (Campaign) appletRequest.get(PageKeys.CAMPAIGN);</span>
<span class="fc" id="L606">				Collection schedulingPeriods = getCampaignManager(context, appletResponse, locale).getSchedulingPeriods(campaign);</span>
<span class="fc" id="L607">				appletResponse.put(PageKeys.CAMPAIGN_SCHEDULINGPERIODS, schedulingPeriods);</span>
<span class="fc bfc" id="L608" title="All 2 branches covered.">			} else if (PageKeys.GET_CAMPAIGN_HOODATEPAIRS.equals(typeData)) {</span>
<span class="fc" id="L609">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_HOOS;</span>
<span class="fc" id="L610">				Campaign campaign = (Campaign) appletRequest.get(PageKeys.CAMPAIGN);</span>
<span class="fc" id="L611">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L612">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L613">				Collection hooDatePairs = null;</span>
<span class="pc bpc" id="L614" title="3 of 6 branches missed.">				if (campaign == null || startDate == null || endDate == null) {</span>
<span class="nc" id="L615">					hooDatePairs =  new ArrayList(0);</span>
				}
<span class="fc" id="L617">				ID campaignId = campaign.getID();</span>
<span class="fc" id="L618">				HOOPeriod hooPeriod = getCampaignManager(context, appletResponse, locale).getHOOPeriod(campaignId, startDate, endDate);</span>
<span class="fc" id="L619">				hooDatePairs = hooPeriod.getOpenPeriods(startDate, endDate);</span>
<span class="fc" id="L620">				appletResponse.put(PageKeys.CAMPAIGN_HOODATEPAIRS, hooDatePairs);</span>
				
<span class="fc bfc" id="L622" title="All 2 branches covered.">			} else if (PageKeys.GET_CAMPAIGN_SCHEDULEPERIOD.equals(typeData)) {</span>
<span class="fc" id="L623">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_SCHEDULING_PERIOD;</span>
<span class="fc" id="L624">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L625">				SchedulingPeriod schedulingPeriod = getCampaignManager(context, appletResponse, locale).getSchedulingPeriodByID(spID);</span>
<span class="fc" id="L626">				getScheduleAccessManager(context, appletResponse, locale).linkShiftAssignmentsToSchedulingPeriod(spID);</span>
<span class="fc" id="L627">				appletResponse.put(PageKeys.CAMPAIGN_SCHEDULINGPERIOD, schedulingPeriod);</span>
<span class="pc bpc" id="L628" title="1 of 2 branches missed.">			} else if (PageKeys.GET_CAMPAIGN_ORGANIZATIONS.equals(typeData)) {</span>
<span class="nc" id="L629">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_ORGANIZATIONS;</span>
				// get all input parameters
<span class="nc" id="L631">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L632">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L633">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L634">				Collection organizationsForCampaign = getCampaignManager(context, appletResponse, locale).getOrganizationsForCampaign(campaignID, startDate, endDate);</span>
<span class="nc" id="L635">				appletResponse.put(PageKeys.CAMPAIGN_ORG_LIST, organizationsForCampaign);</span>
<span class="pc bpc" id="L636" title="1 of 2 branches missed.">			} else if (PageKeys.GET_ORGFORIMPORT.equals(typeData)) {</span>
<span class="nc" id="L637">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_IMPORT_ORGANIZATIONS;</span>
				// get all input parameters
<span class="nc" id="L639">				ID orgID = (ID) appletRequest.get(PageKeys.ORG_ID);</span>
<span class="nc" id="L640">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L641">				boolean bImport = getFacadeCorbaFacadeManager(appletResponse, locale).isConfiguredForImport(orgID, campaignID);</span>
<span class="nc" id="L642">				Boolean bb = Boolean.valueOf(bImport);</span>
<span class="nc" id="L643">				appletResponse.put(PageKeys.ORGFORIMPORT, bb);</span>
<span class="pc bpc" id="L644" title="1 of 2 branches missed.">			} else if (PageKeys.GET_SP_ORGS.equals(typeData)) {</span>
<span class="nc" id="L645">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GET_SP_OGS;</span>
<span class="nc" id="L646">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L647">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L648">				Collection orgs = getCampaignManager(context, appletResponse, locale).getLinkedOrgsforSP(spID);</span>
<span class="nc" id="L649">				Collection importOrgs = new ArrayList();</span>
<span class="nc" id="L650">				Iterator orgIdIterator = orgs.iterator();</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">				while (orgIdIterator.hasNext()) {</span>
<span class="nc" id="L652">					ID orgID = (ID)orgIdIterator.next();</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">					if (getFacadeCorbaFacadeManager(appletResponse, locale).isConfiguredForImport(orgID, campaignID)){</span>
<span class="nc" id="L654">						importOrgs.add(orgID);</span>
					}
<span class="nc" id="L656">				}</span>
<span class="nc" id="L657">				addResponseData(importOrgs, appletResponse);</span>
<span class="pc bfc" id="L658" title="All 2 branches covered.">			}  else if (PageKeys.GET_TRAINING_LICENSE_INFO.equals(typeData)) {</span>
<span class="fc" id="L659">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_LEARNING_PRIVILEDGES;</span>
<span class="fc" id="L660">				boolean isLearningLicensed = this.getLicenserManager(appletResponse, locale).isLicensed(&quot;eLearningLessons&quot;);</span>
<span class="fc" id="L661">				boolean isCoachingLicensed = this.getLicenserManager(appletResponse, locale).isLicensed(&quot;Coaching&quot;);</span>
<span class="fc" id="L662">				appletResponse.put(PageKeys.LEARNING_LICENSE, isLearningLicensed);</span>
<span class="fc" id="L663">				appletResponse.put(PageKeys.COACHING_LICENSE, isCoachingLicensed);</span>
				
<span class="pc bpc" id="L665" title="1 of 2 branches missed.">			} else if (PageKeys.GET_LEARNINGASSIGNMENTS.equals(typeData)) {</span>
<span class="nc" id="L666">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_LEARNING_ASSIGNMENTS;</span>
<span class="nc" id="L667">				Collection employeeIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L668">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L669">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L670">				Collection collectionLearnings = null;</span>
<span class="nc" id="L671">				collectionLearnings = this.getLearningAssignmentManager(appletResponse, locale).getLearningAssignmentsForWorkResource(employeeIDs, startDate, endDate);</span>
<span class="nc" id="L672">				appletResponse.put(PageKeys.LEARNING_ASSIGNMENTS, collectionLearnings);</span>
<span class="pc bpc" id="L673" title="1 of 2 branches missed.">			} else if (PageKeys.GET_COACHINGASSIGNMENTS.equals(typeData)) {</span>
<span class="nc" id="L674">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_COACHING_ASSIGNMENTS;</span>
<span class="nc" id="L675">				Collection employeeIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L676">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L677">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L678">				Collection collectionCoachings = null;</span>
<span class="nc" id="L679">				collectionCoachings = this.getCoachingBridgeInterface(appletResponse, locale).getCoachingAssignmentsForWorkResource(employeeIDs, startDate, endDate);</span>
<span class="nc" id="L680">				appletResponse.put(PageKeys.COACHING_ASSIGNMENTS, collectionCoachings);</span>
<span class="pc bfc" id="L681" title="All 2 branches covered.">			} else if (PageKeys.CALENDAR_APPLET_GET_POOLER_IDS.equals(typeData)) { </span>
<span class="fc" id="L682">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_POOLERS;</span>
<span class="fc" id="L683">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L684">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L685">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L686">				Collection ids= null;</span>
<span class="fc" id="L687">				ids = this.getCampaignManager(context, appletResponse, locale).getSPPoolerAssignments(spID, startDate, endDate);</span>
<span class="fc" id="L688">				appletResponse.put(PageKeys.POOLER_IDS, ids);</span>
<span class="pc bpc" id="L689" title="1 of 2 branches missed.">			} else if (PageKeys.GET_FLOATINGIDS_FORLESSONS.equals(typeData)) {</span>
<span class="nc" id="L690">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_FLOATINGID_FORLESSONS;</span>
<span class="nc" id="L691">				Collection employeeIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L692">				Collection lessonIDs = (Collection) appletRequest.get(PageKeys.LESSON_IDS);</span>
<span class="nc" id="L693">				Map mapFloatingIDs = null;</span>
<span class="nc" id="L694">				mapFloatingIDs = this.getLearningAssignmentManager(appletResponse, locale).getFloatingEventIDsForLesson(employeeIDs, lessonIDs);</span>
<span class="nc" id="L695">				appletResponse.put(PageKeys.FLOATINGIDS_FORLESSONS, mapFloatingIDs);</span>
<span class="pc bpc" id="L696" title="1 of 2 branches missed.">			} else if (PageKeys.GET_FLOATINGIDS_FORCOACHINGS.equals(typeData)) {</span>
<span class="nc" id="L697">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_FLOATINGID_FORCOACHINGS;</span>
<span class="nc" id="L698">				Collection employeeIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L699">				Collection lessonIDs = (Collection) appletRequest.get(PageKeys.LESSON_IDS);</span>
<span class="nc" id="L700">				Map mapFloatingIDs = null;</span>
<span class="nc" id="L701">				mapFloatingIDs = this.getCoachingBridgeInterface(appletResponse, locale).getFloatingEventIDsForCoachingSession(employeeIDs, lessonIDs);</span>
<span class="nc" id="L702">				appletResponse.put(PageKeys.FLOATINGIDS_FORCOACHINGS, mapFloatingIDs);</span>
<span class="pc bpc" id="L703" title="1 of 2 branches missed.">			} else if (PageKeys.GET_CALEVENTS_FORTRAINING.equals(typeData)) {</span>
<span class="nc" id="L704">				Collection templateIDs = (Collection) appletRequest.get(PageKeys.LESSON_TEMPLATE_IDS);</span>
<span class="nc" id="L705">				Collection calEvents = null;</span>
<span class="nc" id="L706">				calEvents = this.getScheduleAccessManager(context, appletResponse, locale).getCalendarEventAssignmentsForCalendarEventTemplate(templateIDs);</span>
<span class="nc" id="L707">				appletResponse.put(PageKeys.CALEVENTS_FORTRAINING, calEvents);</span>
<span class="pc bpc" id="L708" title="1 of 2 branches missed.">			}  else if (PageAction.ACTION_CHANGE_LEARNING_ASSIGNMENT.equals(typeData)) {</span>
<span class="nc" id="L709">				msgID = FsWebBundleKey.FS_CAL_UPDATE_LEARNINGASSIGNMENT;</span>
<span class="nc" id="L710">				LearningAssignmentInt learn = (LearningAssignmentInt)  appletRequest.get(PageKeys.LEARNING_ASSIGNMENT);</span>
<span class="nc" id="L711">				Collection templateIDs = (Collection) appletRequest.get(PageKeys.LEARNING_FLOATING_IDS);</span>
<span class="nc" id="L712">				this.getLearningAssignmentManager(appletResponse, locale).saveLearningAssignment(learn, templateIDs);</span>

<span class="pc bpc" id="L714" title="1 of 2 branches missed.">			}  else if (PageAction.ACTION_CHANGE_COACHING_ASSIGNMENT.equals(typeData)) {</span>
<span class="nc" id="L715">				msgID = FsWebBundleKey.FS_CAL_UPDATE_COACHINGASSIGNMENT;</span>
<span class="nc" id="L716">				ID coachingID = (ID) appletRequest.get(FsKeys.COACHING_ID);</span>
<span class="nc" id="L717">				ID workResourceID = (ID) appletRequest.get(FsKeys.WORKRESOURCE_ID);</span>
<span class="nc" id="L718">				ID lessonID = (ID) appletRequest.get(FsKeys.LESSON_ID); </span>
<span class="nc" id="L719">				int	timeToScheduleThisWeek = (Integer) appletRequest.get(FsKeys.TIME_TO_SCHEDULE);</span>
<span class="nc" id="L720">				int maximumSessionLength = (Integer) appletRequest.get(FsKeys.MAX_SESSION_LENGTH);</span>

<span class="nc" id="L722">				Collection templateIDs = (Collection) appletRequest.get(PageKeys.LEARNING_FLOATING_IDS);</span>
<span class="nc" id="L723">				this.getCoachingBridgeInterface(appletResponse, locale).saveCoachingAssignment(coachingID,</span>
						workResourceID, lessonID, timeToScheduleThisWeek, maximumSessionLength, templateIDs);
<span class="pc bpc" id="L725" title="1 of 2 branches missed.">			} else if (PageKeys.GET_CAMPAIGN_FILTER.equals(typeData)) {</span>
<span class="nc" id="L726">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_FILTER;</span>
				// get all input parameters
<span class="nc" id="L728">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L729">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L730">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L731">				Collection colCampaigns = new LinkedList();</span>
<span class="nc" id="L732">				colCampaigns.add(campaignID);</span>
<span class="nc" id="L733">				ArrayList params = new ArrayList();</span>
<span class="nc" id="L734">				params.add(colCampaigns);	//filter expects nested collections</span>
<span class="nc" id="L735">				Filter filter = new Filter(</span>
						Filter.CAMPAIGNID,
						Filter.OPERATOR_IN,
						params);
<span class="nc" id="L739">				filter.setUserID(context.getUser().getID());</span>
<span class="nc" id="L740">				filter.setStartTime(startDate);</span>
<span class="nc" id="L741">				filter.setEndTime(endDate);</span>
<span class="nc" id="L742">				filter.setTimePeriodType(Filter.TIMEPERIODTYPE_TIMEWINDOW);</span>
				// get the full list of employee IDs and names - this is for use by CalendarViewCache
<span class="nc" id="L744">				String empFilterName = getEmployeeFilterName(context);</span>
<span class="nc" id="L745">				Collection employeeIDs = getEmployeeIDsByFilter(context, appletResponse, locale, context.getUser(), empFilterName, filter);</span>

<span class="nc" id="L747">				Boolean isShowPhantom = (Boolean)appletRequest.get(FsKeys.SHOW_PHANTOM);</span>
<span class="nc bnc" id="L748" title="All 4 branches missed.">				if (isShowPhantom != null &amp;&amp; isShowPhantom.booleanValue()) {</span>
<span class="nc" id="L749">					ID idSchedulingPeriod = (ID)appletRequest.get(FsKeys.SCHEDULING_PERIOD);</span>
<span class="nc" id="L750">					Collection phantoms = this.getScheduleAccessManager(context, appletResponse, locale).getPhantoms(idSchedulingPeriod);</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">					if (phantoms != null) {</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">						for (Iterator i = phantoms.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L753">							employeeIDs.add(((Phantom)i.next()).getID());</span>
						}
					}
				}

<span class="nc" id="L758">				appletResponse.put(PageKeys.EMPLOYEE_FILTER_ALL_IDS, employeeIDs);				</span>
<span class="pc bpc" id="L759" title="1 of 2 branches missed.">			} else if (PageKeys.GET_ORG.equals(typeData)) {</span>
<span class="nc" id="L760">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_ORGANIZATION;</span>
<span class="nc" id="L761">				ID orgID = (ID) appletRequest.get(PageKeys.ORG_ID);</span>
<span class="nc" id="L762">				Organization organization = getWorkResourceManager(context, appletResponse, locale).getOrganizationByID(orgID);</span>
<span class="nc" id="L763">				appletResponse.put(PageKeys.ORG, organization);</span>
<span class="pc bpc" id="L764" title="1 of 2 branches missed.">			} else if (PageKeys.GET_EMPLOYEE_ORGANIZATION.equals(typeData)) {</span>
<span class="nc" id="L765">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_EMPLOYEE_ORGANIZATION;</span>
<span class="nc" id="L766">				ID employeeID = (ID) appletRequest.get(PageKeys.EMPLOYEE_ID);</span>
<span class="nc" id="L767">				Date effectiveDate = (Date) appletRequest.get(PageKeys.EFFECTIVE_DATE);</span>
<span class="nc" id="L768">				List&lt;Pair&lt;ID, Date&gt;&gt; employeeIDDatePairs = Collections.singletonList(new Pair&lt;ID, Date&gt;(employeeID, effectiveDate));</span>
<span class="nc" id="L769">				ID orgID = (ID)getWorkResourceManager(context, appletResponse, locale).getEmployeeOrganizations(employeeIDDatePairs).iterator().next();</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">				Organization organization = (orgID == null) ? null : getWorkResourceManager(context, appletResponse, locale).getOrganizationByID(orgID);</span>
<span class="nc" id="L771">				appletResponse.put(PageKeys.ORG, organization);</span>
<span class="pc bpc" id="L772" title="1 of 2 branches missed.">			} else if (PageKeys.GET_ORG_FILTER.equals(typeData)) {</span>
<span class="nc" id="L773">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_ORGANIZATION_FILTER;</span>
<span class="nc" id="L774">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L775">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L776">				HashSet setOrgs = new HashSet(context.getUser().getAuthorizedScopes(PrivilegeKeys.FS_VIEWORGSCHEDULES));</span>

<span class="nc" id="L778">				ArrayList alParameters = new ArrayList();</span>
<span class="nc" id="L779">				Collection colOrgs = new LinkedList();</span>
<span class="nc" id="L780">				colOrgs.addAll(setOrgs);</span>
<span class="nc" id="L781">				alParameters.add(colOrgs);</span>
<span class="nc" id="L782">				Filter filter = new Filter(</span>
						Filter.ORGANIZATIONID,
						Filter.OPERATOR_IN,
						alParameters/*new ArrayList(setOrgs)*/);
<span class="nc" id="L786">				filter.setUserID(context.getUser().getID());</span>
<span class="nc" id="L787">				filter.setStartTime(startDate);</span>
<span class="nc" id="L788">				filter.setEndTime(endDate);</span>
<span class="nc" id="L789">				filter.setTimePeriodType(Filter.TIMEPERIODTYPE_TIMEWINDOW);</span>
<span class="nc" id="L790">				String str = Filter.filterToString(filter);</span>
<span class="nc" id="L791">				appletResponse.put(PageKeys.ORG_FILTER, str);</span>
				// get the full list of employee IDs and names - this is for use by CalendarViewCache
<span class="nc" id="L793">				String empFilterName = getEmployeeFilterName(context);</span>
<span class="nc" id="L794">				Collection employeeIDs = getEmployeeIDsByFilter(context, appletResponse, locale, context.getUser(), empFilterName, filter);</span>
<span class="nc" id="L795">				appletResponse.put(PageKeys.EMPLOYEE_FILTER_ALL_IDS, employeeIDs);</span>

				//pass filter to people selection pane
<span class="nc" id="L798">				context.setAttribute(RequestContext.SESSION_SCOPE, PageKeys.PRE_FILTER_KEY, str);</span>
<span class="pc bfc" id="L799" title="All 2 branches covered.">			} else if (PageKeys.GET_EMP_ORGASSIGNMENTS_AND_PERSONDATA.equals(typeData)) {</span>
<span class="fc" id="L800">					Collection&lt;ID&gt; employeeIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L801">					Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L802">					Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
					
<span class="fc" id="L804">					Collection&lt;PersonData&gt; workResources = getWorkResourceManager(context, appletResponse, locale).getPersonDataByIDs(employeeIDs, startDate);</span>
<span class="fc" id="L805">					appletResponse.put(PageKeys.EMPLOYEES, workResources);</span>

<span class="fc" id="L807">			        EmpWorkRuleManager empWorkRuleManager = getEmpWorkRuleManager(context, appletResponse, locale);</span>
<span class="fc" id="L808">					Map&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; hmTimeBank = empWorkRuleManager.getTimeBankAssignments(employeeIDs, startDate, endDate);</span>
<span class="fc" id="L809">					appletResponse.put(PageKeys.TIMEBANKS, hmTimeBank);</span>
	
<span class="fc" id="L811">					Map empOrgAssignments = getEmpOrgAssignments(context, appletResponse, locale, employeeIDs, startDate, endDate);</span>
<span class="fc" id="L812">					appletResponse.put(PageKeys.EMPLOYEE_ORGANIZATION_ASSIGNMENTS, empOrgAssignments);</span>
<span class="fc" id="L813">					Map organizations = getOrgIDMap(context, appletResponse, locale, empOrgAssignments.values());</span>
<span class="fc" id="L814">					appletResponse.put(PageKeys.ORGANIZATIONS, organizations);</span>

<span class="fc" id="L816">					Map&lt;ID, EmployeeName&gt; workResourceNames = this.getWorkResourceManager(context, appletResponse, locale)</span>
<span class="fc" id="L817">						.getEmployeeNamesByIDs(employeeIDs);</span>
<span class="fc" id="L818">					appletResponse.put(PageKeys.EMPLOYEE_NAMES, workResourceNames);</span>
<span class="pc bpc" id="L819" title="1 of 2 branches missed.">			} else if (PageKeys.GET_TIMEBANKS.equals(typeData)) {</span>
<span class="nc" id="L820">					Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L821">					Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L822">			        WorkRuleManager workRuleManager =  getWorkRuleManager(context, appletResponse, locale);</span>
					//Returns an ArrayList of TimeBank
<span class="nc" id="L824">					appletResponse.put(PageKeys.TIMEBANKS, workRuleManager.getAllTimeBanks());</span>
				
<span class="pc bfc" id="L826" title="All 2 branches covered.">			} else if (PageKeys.GET_EMPLOYEE_SKILLS.equals(typeData)) {</span>
<span class="fc" id="L827">					ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L828">					Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L829">					Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L830">					ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="pc bpc" id="L831" title="1 of 2 branches missed.">					Campaign campaign = campaignID==null?null : getCampaignManager(context, appletResponse, locale).getCampaignByID(campaignID);</span>
<span class="fc" id="L832">					List workResourceIDs = getSpEmployeeIDs(context, spID, campaign, startDate, endDate, locale, appletResponse, msgID);</span>
<span class="fc" id="L833">					SkillManager skillManager = getSkillManager(context, appletResponse, locale);</span>
			        
					//Returns a HashMap&lt;ID, ArrayList&lt;SkillAssignment&gt;&gt;
<span class="fc" id="L836">					Map empIDSkills = skillManager.getSkillsForWorkResources(workResourceIDs, adjustStartDateToAddAMinute(startDate), endDate);</span>
<span class="fc" id="L837">                    Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; hmSkillAssignments = skillManager.getSkillAssignments(workResourceIDs, adjustStartDateToAddAMinute(startDate), endDate);</span>
					
					//just in case there is phantom in sp
<span class="fc" id="L840">					workResourceIDs.removeAll(empIDSkills.keySet());</span>
					
<span class="fc bfc" id="L842" title="All 2 branches covered.">					if (!workResourceIDs.isEmpty()) {</span>
<span class="fc" id="L843">						Map empTempSkill = new HashMap();</span>
<span class="fc" id="L844">                        Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; hmTempSkillAssignments = new HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt;();</span>

<span class="fc" id="L846">                        ScheduleAccessManager saManager = getScheduleAccessManager(context, appletResponse, locale);</span>
<span class="fc" id="L847">						Collection phantoms = saManager.getPhantomsByIDs(workResourceIDs);</span>
<span class="fc" id="L848">						Phantom phantom = null;</span>
<span class="fc" id="L849">						ID empTemplateID = null;</span>
<span class="fc bfc" id="L850" title="All 2 branches covered.">						for (Iterator i = phantoms.iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L851">							phantom = (Phantom)i.next();</span>
<span class="fc" id="L852">							empTemplateID = phantom.getEmployeeTemplateID();</span>
<span class="fc" id="L853">							Collection skills = null;</span>
							
<span class="fc bfc" id="L855" title="All 2 branches covered.">							if (empTempSkill.keySet().contains(empTemplateID)) {</span>
<span class="fc" id="L856">								empIDSkills.put(phantom.getID(), empTempSkill.get(empTemplateID));</span>
<span class="fc" id="L857">                                hmSkillAssignments.put(phantom.getID(),hmTempSkillAssignments.get(empTemplateID));</span>
<span class="fc" id="L858">								continue;</span>
							}
							
<span class="fc" id="L861">							Collection assignments = skillManager.getSkillAssignmentsForTemplate(empTemplateID, startDate, endDate);</span>

<span class="fc" id="L863">							List skillIDs = new ArrayList();</span>
<span class="pc bpc" id="L864" title="1 of 2 branches missed.">							if (assignments != null) {</span>
<span class="fc" id="L865">								ID skillID = null;</span>
<span class="fc bfc" id="L866" title="All 2 branches covered.">								for (Iterator iSkill = assignments.iterator(); iSkill.hasNext(); ) {</span>
<span class="fc" id="L867">									skillID = ((SkillAssignment)iSkill.next()).getSkillID();</span>
<span class="fc" id="L868">									skillIDs.add(skillID);</span>
								}
							}
<span class="pc bpc" id="L871" title="1 of 2 branches missed.">							if (!skillIDs.isEmpty())</span>
<span class="fc" id="L872">								skills = skillManager.getSkillsByIDs(skillIDs);</span>

<span class="fc" id="L874">							empTempSkill.put(empTemplateID, skills); //cache locally to avoid load for another phantom again</span>
<span class="fc" id="L875">                            hmTempSkillAssignments.put(empTemplateID, assignments); //cache locally to avoid load for another phantom again</span>
<span class="fc" id="L876">							empIDSkills.put(phantom.getID(), skills);</span>
<span class="fc" id="L877">                            hmSkillAssignments.put(phantom.getID(), assignments);</span>
<span class="fc" id="L878">                        }</span>
					}
					
<span class="fc" id="L881">					appletResponse.put(PageKeys.EMPLOYEE_SKILLS, empIDSkills);</span>
<span class="fc" id="L882">					appletResponse.put(PageKeys.EMPLOYEE_SKILL_ASSIGNMENTS, hmSkillAssignments);</span>
				
<span class="fc bfc" id="L884" title="All 2 branches covered.">			} else if (PageKeys.GET_SP_SCHEDULINGPARAMETERS.equals(typeData)) {</span>
<span class="fc" id="L885">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SP_SCHEDULING_PARAMS;</span>
<span class="fc" id="L886">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L887">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L888">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L889">				Map parameters = getSPSchedulingParameters(context, appletResponse, locale, startDate, spID, campaignID);</span>
<span class="fc" id="L890">				appletResponse.put(PageKeys.SP_SCHEDULINGPARAMS, parameters);</span>
<span class="pc bpc" id="L891" title="1 of 2 branches missed.">			} else if (PageKeys.GET_SORTED_EMPLOYEEIDS.equals(typeData)) {</span>
<span class="nc" id="L892">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SORTED_EMPLOYEES;</span>
<span class="nc" id="L893">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L894">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L895">				Collection empIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L896">				Integer eventClassInt = (Integer) appletRequest.get(PageKeys.SORT_EVENT_CLASS);</span>
<span class="nc" id="L897">				String sortBy = (String) appletRequest.get(PageKeys.SORT_TYPE);</span>
<span class="nc" id="L898">				Integer sortDirInt = (Integer) appletRequest.get(PageKeys.SORT_DIRECTION);</span>
<span class="nc" id="L899">				TimeRange timeRange = new TimeRange(startDate, endDate);</span>
				//Collection sortedEmpIDs = getPeopleFacade().sortEmployeeIdsByEvents(empIDs, eventClassInt.intValue(), timeRange, sortBy, sortDirInt.intValue());
				//appletResponse.put(PageKeys.SORTED_EMPLOYEE_IDS, sortedEmpIDs);
<span class="nc" id="L902">				appletResponse.put(PageKeys.SORTED_EMPLOYEE_IDS, empIDs);</span>
<span class="pc bfc" id="L903" title="All 2 branches covered.">			} else if (PageKeys.GET_CAMPAIGN_QUEUES.equals(typeData)) {</span>
<span class="fc" id="L904">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CAMPAIGN_QUEUES;</span>
<span class="fc" id="L905">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L906">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L907">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L908">				Collection campaignQueueAssignments = getCampaignManager(context, appletResponse, locale).getCampaignQueueAssignments(campaignID, startDate, endDate);</span>
<span class="fc" id="L909">				List listQueueIDs = new ArrayList(campaignQueueAssignments.size());</span>
<span class="fc" id="L910">				Iterator itCampQueueAsmts = campaignQueueAssignments.iterator();</span>
<span class="fc bfc" id="L911" title="All 2 branches covered.">				while (itCampQueueAsmts.hasNext()) {</span>
<span class="fc" id="L912">					CampaignQueue nextCampQ = (CampaignQueue) itCampQueueAsmts.next();</span>
<span class="fc" id="L913">					ID nextQID = nextCampQ.getQueueID();</span>
<span class="fc" id="L914">					listQueueIDs.add(nextQID);</span>
<span class="fc" id="L915">				}</span>
<span class="fc" id="L916">				appletResponse.put(PageKeys.CAMPAIGN_QUEUEID_COLLECTION, listQueueIDs);</span>
<span class="fc" id="L917">				Collection queuesByIDs = getWorkloadManager(context, appletResponse, locale).getQueuesByIDs(listQueueIDs);</span>
<span class="fc" id="L918">				appletResponse.put(PageKeys.CAMPAIGN_QUEUE_COLLECTION, queuesByIDs);</span>
<span class="pc bpc" id="L919" title="1 of 2 branches missed.">			} else if (PageKeys.GET_RECALC_DIRTYSTATUS.equals(typeData)) {</span>
<span class="nc" id="L920">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_RECALC_DIRTY_STATUS;</span>
<span class="nc" id="L921">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L922">				Pair dirtyStatus = getCampaignManager(context, appletResponse, locale).getDirtyStatus(spID);</span>
<span class="nc" id="L923">				Date lastModifiedTime = (Date) dirtyStatus.getFirst();</span>
<span class="nc" id="L924">				Date lastRecalcTime = (Date) dirtyStatus.getSecond();</span>
<span class="nc" id="L925">				appletResponse.put(PageKeys.LAST_MODIFIED_TIME, lastModifiedTime);</span>
<span class="nc" id="L926">				appletResponse.put(PageKeys.LAST_RECALC_TIME, lastRecalcTime);</span>
<span class="pc bfc" id="L927" title="All 2 branches covered.">			} else if (PageKeys.GET_SERVICELEVEL_RIBBONS.equals(typeData)) {</span>
				
<span class="fc" id="L929">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_STATISTIC_RIBBONS;</span>
<span class="fc" id="L930">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L931">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L932">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L933">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
				//FIXME: Looks like this has become a catch-all for random
				// data queries.  Since when are verticalized strings part of ribbon data?
				//load verticalized strings map as well
<span class="fc" id="L937">				Map verticalizedStringMap = getVerticalizedStrings(context, appletRequest, appletResponse, locale);</span>
<span class="fc" id="L938">				appletResponse.put(PageKeys.VERTICALIZED_STRINGS, verticalizedStringMap);</span>
				
<span class="fc" id="L940">				getServiceLevelRibbons(context, locale, appletResponse, spID, campaignID, startDate, endDate, msgID);</span>
<span class="pc bpc" id="L941" title="1 of 2 branches missed.">			} else if (PageKeys.GET_FTE_CALCULATION_DATA.equals(typeData)) {</span>
<span class="nc" id="L942">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_FTECALC_DATA;</span>
<span class="nc" id="L943">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L944">				Boolean hasProjectQueue = (Boolean) appletRequest.get(PageKeys.HAS_PROJECT_QUEUE);</span>
<span class="nc" id="L945">				List&lt;ID&gt; workResIds = (List&lt;ID&gt;)appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L946">				Double defaultWage = (Double) appletRequest.get(PageKeys.DEFAULT_WAGE);</span>
<span class="nc" id="L947">				FTECalculator fteCalculator = getCampaignManager(context, appletResponse, locale).getFTECalculator(spID, </span>
<span class="nc" id="L948">					hasProjectQueue.booleanValue(), workResIds, defaultWage.doubleValue());</span>
<span class="nc" id="L949">				SP sp = getCampaignManager(context, appletResponse, locale).getRealSP(spID);</span>
<span class="nc" id="L950">				appletResponse.put(PageKeys.FTE_CALCULATION, new Pair(fteCalculator, sp));</span>
<span class="pc bpc" id="L951" title="1 of 2 branches missed.">			} else if (PageKeys.GET_WORKPATTERN.equals(typeData)) {</span>
<span class="nc" id="L952">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_WORKPATTERN_SETS;</span>
<span class="nc" id="L953">				Collection ids = (Collection) appletRequest.get(PageKeys.WORKPATTERN_IDS);</span>
<span class="nc" id="L954">				Collection wpSets = this.getWorkRuleManager(context, appletResponse, locale).getShiftPatternsByIDs(ids);</span>
<span class="nc" id="L955">				appletResponse.put(PageKeys.COLLECTION_WORKPATTERNS, wpSets);</span>
<span class="pc bpc" id="L956" title="1 of 2 branches missed.">			} else if (PageKeys.GET_EVENTTEMPLATE.equals(typeData)) {</span>
				//get all template defined for view employee in view period
<span class="nc" id="L958">				Collection employeeIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L959">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L960">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L961">				Collection templates = getScheduleAccessManager(context, appletResponse, locale)</span>
<span class="nc" id="L962">					.getEventTemplatesForWorkResourceIDs(employeeIDs, startDate, endDate);</span>
<span class="nc" id="L963">				appletResponse.put(PageKeys.EVENT_TEMPLATE, templates);</span>
<span class="pc bpc" id="L964" title="1 of 2 branches missed.">			} else if (PageKeys.GET_EVENTTEMPLATES.equals(typeData)) {</span>
<span class="nc" id="L965">				Collection eventTemplateIDs = (Collection) appletRequest.get(PageKeys.EVENTTEMPLATE_ID);</span>
<span class="nc" id="L966">				Collection calendarEventTemplates = getScheduleAccessManager(context, appletResponse, locale)</span>
<span class="nc" id="L967">					.getCalendarEventTemplatesByIDs(eventTemplateIDs);</span>
<span class="nc" id="L968">				appletResponse.put(PageKeys.EVENT_TEMPLATE, calendarEventTemplates);</span>
<span class="pc bfc" id="L969" title="All 2 branches covered.">			} else if (PageKeys.GET_BASEFORCAST_NOTSET_SPQUEUEIDS.equals(typeData)) {</span>
<span class="fc" id="L970">				ID spSID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L971">				Collection&lt;SPQueue&gt; spQueues = getCampaignManager(context, appletResponse, locale).getSPQueuesBySPID(spSID);</span>
<span class="fc" id="L972">				Collection notSetQueueSIDs = new ArrayList();</span>
<span class="pc bpc" id="L973" title="2 of 4 branches missed.">				if (spQueues != null &amp;&amp; !spQueues.isEmpty()) {</span>
<span class="fc" id="L974">					Collection&lt;ID&gt; spQueueIDs = getSPQueueIDsCouldHaveBaseForecast(spQueues); </span>
<span class="fc" id="L975">					Map map = getForecastManager(context, appletResponse, locale).isBaseForecastSet(spQueueIDs);</span>
<span class="fc" id="L976">					Map.Entry entry = null;</span>
<span class="fc bfc" id="L977" title="All 2 branches covered.">					for (Iterator i = map.entrySet().iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L978">						entry = (Map.Entry)i.next();</span>
<span class="fc bfc" id="L979" title="All 2 branches covered.">						if (!((Boolean)entry.getValue()).booleanValue())</span>
<span class="fc" id="L980">							notSetQueueSIDs.add(entry.getKey());</span>
					}
				}
<span class="fc" id="L983">				appletResponse.put(PageKeys.BASEFORCAST_NOTSET_SPQUEUEIDS, notSetQueueSIDs);				</span>
<span class="pc bpc" id="L984" title="1 of 2 branches missed.">			} else if (PageKeys.FS_SHIFT_DURATION_PICKER_CACHE_SHIFT_DURATION.equals(typeData)) {</span>
<span class="nc" id="L985">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;</span>

<span class="nc" id="L987">				String cmd = (String)appletRequest.get(PageKeys.FS_SHIFT_DURATION_PICKER_CACHE_SHIFT_DURATION);</span>

<span class="nc" id="L989">				String shiftDurationCache = processShiftDurationCommand(context, cmd);</span>
				// return the new cache to the caller
<span class="nc" id="L991">				appletResponse.put(</span>
						PageKeys.FS_SHIFT_DURATION_PICKER_CACHE_SHIFT_DURATION,
						shiftDurationCache);

<span class="pc bpc" id="L995" title="1 of 2 branches missed.">			} else if (PageKeys.FS_SHIFT_DURATION_PICKER_GET_SHIFT_DURATION.equals(typeData)) {</span>
<span class="nc" id="L996">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;</span>

<span class="nc" id="L998">				addShiftDurationCache(context, appletResponse);</span>
<span class="pc bpc" id="L999" title="1 of 2 branches missed.">			} else if (PageKeys.FS_SHIFT_DURATION_PICKER_GET_SHIFTS.equals(typeData)) {</span>
<span class="nc" id="L1000">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;</span>

<span class="nc" id="L1002">				ID orgId = (ID)appletRequest.get(</span>
						PageKeys.FS_SHIFT_DURATION_PICKER_SELECTED_ORG_ID);
<span class="nc" id="L1004">				ID payPolicyId = (ID)appletRequest.get(</span>
						PageKeys.FS_SHIFT_DURATION_PICKER_SELECTED_PAY_POLICY_ID);

<span class="pc bpc" id="L1007" title="1 of 2 branches missed.">			} else if (PageKeys.FS_SHIFT_DURATION_PICKER_GET_ORGS.equals(typeData)) {</span>
<span class="nc" id="L1008">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_PICKER_DATA;</span>

<span class="nc" id="L1010">				Collection orgs =  getWorkResourceManager(context, appletResponse, locale).getOrganizations(null);</span>
<span class="nc bnc" id="L1011" title="All 4 branches missed.">				if (orgs == null || orgs.size() == 0) {</span>
					// This is not expected
<span class="nc" id="L1013">					appletResponse.put(PageKeys.APPLET_ERROR, &quot;There are no organizations!?&quot;);</span>
				} else {
<span class="nc" id="L1015">					Organization root = Organization.buildOrganizationTree(orgs);</span>
<span class="nc bnc" id="L1016" title="All 2 branches missed.">					if (root != null) {</span>
<span class="nc" id="L1017">						appletResponse.put(</span>
								PageKeys.FS_SHIFT_DURATION_PICKER_ROOT_ORG,
								root);
<span class="nc" id="L1020">						HashMap payPolicies =</span>
<span class="nc" id="L1021">							getPayPolicyManager(appletResponse, locale).getManagedPayPolicyInOrg(root.getID());</span>
<span class="nc bnc" id="L1022" title="All 2 branches missed.">						if (payPolicies != null) {</span>
<span class="nc" id="L1023">							appletResponse.put(</span>
									PageKeys.FS_SHIFT_DURATION_PICKER_PAY_POLICIES,
									payPolicies);
						}

<span class="nc" id="L1028">						ID orgId = null;</span>
<span class="nc" id="L1029">						ID payPolicyId = null;</span>
<span class="nc" id="L1030">						String orgIdStr =</span>
<span class="nc" id="L1031">							context.getUserProperty(&quot;SHIFT_DURATION_SELECTED_ORG_ID&quot;);</span>
<span class="nc" id="L1032">						String payPolicyIdStr =</span>
<span class="nc" id="L1033">							context.getUserProperty(&quot;SHIFT_DURATION_SELECTED_PAY_POLICY_ID&quot;);</span>
<span class="nc bnc" id="L1034" title="All 2 branches missed.">						if (!StringUtil.isEmpty(orgIdStr))	{</span>
							// invalid orgId will be handled on the the client side.
<span class="nc" id="L1036">							orgId = new ID(orgIdStr);</span>
						}
<span class="nc bnc" id="L1038" title="All 2 branches missed.">						if (!StringUtil.isEmpty(payPolicyIdStr))  {</span>
<span class="nc" id="L1039">							payPolicyId = new ID(payPolicyIdStr);</span>
							// check for invalid pay policy id
<span class="nc bnc" id="L1041" title="All 2 branches missed.">							if (payPolicies == null ||</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">									!payPolicies.containsKey(payPolicyId)) {</span>
<span class="nc" id="L1043">								payPolicyId = null;</span>
<span class="nc" id="L1044">								payPolicyIdStr = &quot;&quot;;</span>
<span class="nc" id="L1045">								context.setUserProperty(&quot;SHIFT_DURATION_SELECTED_PAY_POLICY_ID&quot;, &quot;&quot;);</span>
							}
						}

<span class="nc" id="L1049">						appletResponse.put(</span>
								PageKeys.FS_SHIFT_DURATION_PICKER_SELECTED_PAY_POLICY_ID,
								payPolicyIdStr);

<span class="nc" id="L1053">						appletResponse.put(</span>
								PageKeys.FS_SHIFT_DURATION_PICKER_SELECTED_ORG_ID,
								orgIdStr);

						// this may not be necessary since a call to get
						// the shift cache will most likely have to made
						// prior to a call for this request data
<span class="nc" id="L1060">						appletResponse.put(PageKeys.FS_SHIFT_DURATION_PICKER_CACHE_SHIFT_DURATION,</span>
<span class="nc" id="L1061">								context.getUserProperty(&quot;SHIFT_DURATION_CACHE&quot;));</span>
					}
				}
<span class="pc bpc" id="L1064" title="1 of 2 branches missed.">			} else if (PageKeys.GET_CHILDREN_ORG_IDS.equals(typeData)) {</span>
<span class="nc" id="L1065">				msgID = FsWebBundleKey.FS_CAL_MSG_GETTING_ORGANIZATION;</span>
<span class="nc" id="L1066">				Collection orgIDs = (Collection) appletRequest.get(PageKeys.ORG_IDS);</span>
<span class="nc" id="L1067">				Collection parentsOrgIDs = null;</span>
<span class="nc" id="L1068">				parentsOrgIDs = this.getWorkResourceManager(context, appletResponse, locale).getOrganizationsChildrenByIDs(orgIDs);</span>
<span class="nc" id="L1069">				addResponseData(parentsOrgIDs, appletResponse);</span>
<span class="pc bfc" id="L1070" title="All 2 branches covered.">			} else if(PageKeys.GET_FILTER_ID_FROM_NAME.equals(typeData)) {</span>
				// get the full list of employee IDs and names - this is for use by CalendarViewCache
<span class="fc" id="L1072">				String empFilterName = getEmployeeFilterName(context);</span>
<span class="fc" id="L1073">				ID empFilterID = null;</span>
<span class="pc bpc" id="L1074" title="1 of 6 branches missed.">				if (empFilterName != null &amp;&amp; (empFilterName.equals(&quot;DEFAULT_ALL&quot;) || empFilterName.equals(&quot;DEFAULT_NONE&quot;))) {</span>
<span class="fc" id="L1075">					empFilterID = new ID(-1);</span>
				} else {
<span class="fc" id="L1077">					Filter filter = getEmployeeFilterManager(context, appletResponse, locale).getFilterByName(context.getUser().getID(), empFilterName);</span>
<span class="fc" id="L1078">					empFilterID = filter.getFilterID();</span>
				}
<span class="fc" id="L1080">				appletResponse.put(PageKeys.EMP_FILTER_ID, empFilterID);</span>
<span class="fc bfc" id="L1081" title="All 2 branches covered.">	        } else if (PageKeys.GET_IS_TIMEZONE_OVERRIDDEN.equals(typeData)) {</span>
<span class="fc" id="L1082">	        	msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_TIME_ZONE_OVERRIDE;</span>
<span class="fc" id="L1083">	        	isTimeZoneOverridden(context, appletResponse);</span>
<span class="pc bpc" id="L1084" title="1 of 2 branches missed.">	        } else if (PageAction.ACTION_TOGGLE_TIMEZONE_OVERRIDE.equals(typeData)) {</span>
<span class="nc" id="L1085">	        	msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_SETTING_TIME_ZONE_OVERRIDE;</span>
<span class="nc" id="L1086">	        	toggleTimeZoneOverride(context, appletResponse);</span>
<span class="fc bfc" id="L1087" title="All 2 branches covered.">			} else if (FsKeys.GET_CHILD_AND_SELF_ORGANIZATION_IDS.equals(typeData)) {</span>
<span class="fc" id="L1088">				Collection&lt;ID&gt; orgIds = (Collection&lt;ID&gt;)appletRequest.get(</span>
						FsKeys.ORGANIZATION_ID_COLLECTION_PARAM);
<span class="fc" id="L1090">				Collection&lt;ID&gt; childAndSelfOrgIDs = getChildAndSelfOrganizationIDs(context, appletResponse, orgIds);</span>
<span class="fc" id="L1091">				appletResponse.put(FsKeys.CHILD_AND_SELF_ORGANIZATION_IDS_RETVAL, childAndSelfOrgIDs);</span>
<span class="fc bfc" id="L1092" title="All 2 branches covered.">			} else if(PageKeys.GET_EMPLOYEES_SUB_CAMPAIGNS.equals(typeData)){</span>
				//msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SHIFT_DATA;
<span class="fc" id="L1094">				ID parentCampaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="fc" id="L1095">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L1096">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L1097">				Collection&lt;ID&gt; empIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>

<span class="fc" id="L1099">				Map&lt;ID, ID&gt; empSubCampaignID = new HashMap&lt;ID, ID&gt;(empIDs.size());</span>
<span class="pc bpc" id="L1100" title="1 of 2 branches missed.">				if (parentCampaignID != null) {</span>
<span class="fc" id="L1101">					Collection&lt;ID&gt; subCampaignIDs = getCampaignManager(context, appletResponse, locale).getSubCampaignIDs(parentCampaignID);</span>
<span class="fc" id="L1102">					Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; empCampaignWR = getCampaignManager(context, appletResponse, locale)</span>
<span class="fc" id="L1103">						.getWorkResourceCampaignAssignments(empIDs, startDate, endDate);</span>
<span class="fc bfc" id="L1104" title="All 2 branches covered.">					for(ID workResourceID: empCampaignWR.keySet()){</span>
<span class="fc" id="L1105">						List&lt;CampaignWorkResource&gt; campaignWR = empCampaignWR.get(workResourceID);</span>
						outerloop:
<span class="pc bpc" id="L1107" title="1 of 2 branches missed.">							for(ID subCampaignID : subCampaignIDs){</span>
<span class="fc bfc" id="L1108" title="All 2 branches covered.">								for(CampaignWorkResource cwr: campaignWR){</span>
<span class="fc bfc" id="L1109" title="All 2 branches covered.">									if( cwr.getCampaignID().equals(subCampaignID) ){</span>
<span class="fc" id="L1110">										empSubCampaignID.put(workResourceID,subCampaignID);</span>
<span class="fc" id="L1111">										break outerloop; </span>
									}
<span class="fc" id="L1113">								}</span>
<span class="fc" id="L1114">							}</span>
<span class="fc" id="L1115">					}</span>
				}
<span class="fc" id="L1117">				appletResponse.put(PageKeys.CAMPAIGNS, empSubCampaignID);</span>
			}
<span class="nc" id="L1119">		} catch (RuntimeException e) {</span>
<span class="nc" id="L1120">			handleUnexpectedError(context, appletResponse, locale, e, msgID, null, null);</span>
<span class="nc" id="L1121">		} catch (Exception e) {</span>
<span class="nc" id="L1122">			handleExpectedError(context, appletResponse, locale, e, msgID, null, null);</span>
<span class="pc" id="L1123">		}</span>
<span class="fc" id="L1124">	}</span>

	protected Collection&lt;ID&gt; getSPQueueIDsCouldHaveBaseForecast(
			Collection&lt;SPQueue&gt; spQueues) {
<span class="fc" id="L1128">		ArrayList spQueueIDs = new ArrayList(spQueues.size());</span>
<span class="fc bfc" id="L1129" title="All 2 branches covered.">		for (SPQueue spQ: spQueues) {</span>
<span class="pc bpc" id="L1130" title="1 of 2 branches missed.">			if (spQ.getMediaID().equals(Media.MEDIA_ID_PROJECT)) {</span>
<span class="nc" id="L1131">				continue;</span>
			}
<span class="fc" id="L1133">			spQueueIDs.add(spQ.getID());</span>
<span class="fc" id="L1134">		}</span>
<span class="fc" id="L1135">		return spQueueIDs;</span>
	}

	private List&lt;ShiftSwapCalendarInfo&gt; getShiftSwapCalendarInfos(Date start, Date end, List&lt;ID&gt; empIDs) throws Exception {
<span class="nc bnc" id="L1139" title="All 2 branches missed.">		if (m_shiftSwapManager == null) {</span>
<span class="nc" id="L1140">			m_shiftSwapManager = new ShiftSwapCalendarInfoManager();</span>
		}
<span class="nc" id="L1142">		return m_shiftSwapManager.getListApprovedShiftSwapCalendarInfo(start, end, empIDs);</span>
	}


	/**
	 * Get all the undeleted activities mapped to their Media.
	 * Get all Queues associated with the SP's Media.
	 * Get all the &quot;Queue Hopping&quot; activities that are directly mapped to the queue  
	 * Get all the &quot;Non Queue Hoping&quot; activities indirectly associated to the queue through the Activity's media
	 * Get the skillID for each queue.
	 * Get all queue Organization ID's mapped to their organization's color tolerance settings (from Organization Settings)
	 * @throws BbmCreateException 
	 */
	private String getQueueActivitiesMaps(RequestContext context,
			Map appletRequest, Map appletResponse, Locale locale)
			throws BbmFinderException, RemoteException, BbmEJBCreateException, BbmCreateException {
		String msgID;
<span class="fc" id="L1159">		msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_QUEUEACTIVITY_DATA;</span>
<span class="fc" id="L1160">		ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>

<span class="fc" id="L1162">		ActivityManager activityManager = getActivityManager(context, appletResponse, locale);</span>
		//TODO AJP: Is this the proper scope for the activities?  I believe this is all undeleted activities
<span class="fc" id="L1164">		Collection allActivityIDs = activityManager.findActivitiesIds(new ActivityFilter(ActivityFilter.FILTER_DELETED));</span>
<span class="fc" id="L1165">		Map&lt;ID, Collection&lt;ID&gt;&gt; activityToMediaMap = activityManager.findMediaForActivities(allActivityIDs);</span>
<span class="fc" id="L1166">		appletResponse.put(FsKeys.ACTIVITYTOMEDIA, activityToMediaMap);</span>
		
<span class="fc" id="L1168">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L1169">		Map&lt;ID, Media&gt; queueToMediaMap = new HashMap&lt;ID, Media&gt;();</span>
<span class="fc" id="L1170">		Map&lt;ID, ID&gt; queueToSkillMap = null;</span>
<span class="fc" id="L1171">		Map&lt;ID, ArrayList&lt;ID&gt;&gt; mediaIdToQueueIDMap = new HashMap&lt;ID, ArrayList&lt;ID&gt;&gt;();</span>
<span class="fc" id="L1172">		Map&lt;ID, ArrayList&lt;Integer&gt;&gt; orgIDToToleranceMap = new HashMap&lt;ID, ArrayList&lt;Integer&gt;&gt;();</span>
<span class="fc" id="L1173">		WorkloadManager wm = getWorkloadManager(context, appletResponse, locale);</span>
		
<span class="fc" id="L1175">		Collection&lt;Queue&gt; qCollection = wm.getNonCombinedQueuesByMediaAndSP(null, spID);</span>
		//CRITICAL AJP: We need to Explicitly create IDs from the queue collection. 
		//	I am encountering an odd Java issue when iterating through the keySet of a HashMap, which will be done in Jdmo.createInClause(...) 
<span class="fc bfc" id="L1178" title="All 2 branches covered.">		for (Queue q : qCollection) {</span>
<span class="fc" id="L1179">			queueIds.add(q.getID());</span>
<span class="fc" id="L1180">			queueToMediaMap.put( q.getID(), wm.getMediaByID(q.getMediaID()) );</span>
<span class="fc" id="L1181">			ArrayList&lt;ID&gt; queuesForMedia = mediaIdToQueueIDMap.get(q.getMediaID());</span>
<span class="fc bfc" id="L1182" title="All 2 branches covered.">			if (queuesForMedia == null)</span>
<span class="fc" id="L1183">				queuesForMedia = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L1184">			queuesForMedia.add(q.getID());</span>
<span class="fc" id="L1185">			mediaIdToQueueIDMap.put( q.getMediaID(), queuesForMedia);</span>
<span class="fc bfc" id="L1186" title="All 2 branches covered.">			if (!orgIDToToleranceMap.containsKey(q.getOrganizationID())) {</span>
<span class="fc" id="L1187">				orgIDToToleranceMap.put(q.getOrganizationID(), getQueueToleranceArrayForOrg(context, q.getOrganizationID()));</span>
			}
<span class="fc" id="L1189">		}</span>
<span class="fc" id="L1190">		appletResponse.put(FsKeys.MEDIA, queueToMediaMap);</span>
<span class="fc" id="L1191">		appletResponse.put(FsKeys.ORG_ID_TO_QUEUE_TOLERANCES, orgIDToToleranceMap);</span>
		
		//get a hashmap that links each individual queue in the SP to its skill. If a queue has no skill, it won't be in the map.
<span class="fc" id="L1194">		queueToSkillMap =  getCampaignManager(context, appletResponse, locale).getQueueIDToSkillMap(spID);</span>
<span class="pc bpc" id="L1195" title="1 of 2 branches missed.">		if (queueToSkillMap==null) {</span>
<span class="nc" id="L1196">			queueToSkillMap = new HashMap&lt;ID, ID&gt;();</span>
		}
<span class="fc" id="L1198">		appletResponse.put(FsKeys.SKILL, queueToSkillMap);</span>
						
		//Get a HashMap (queue SID -&gt; ServiceGoalsType) for each queue in the SP
<span class="fc" id="L1201">		Collection&lt;SPQueue&gt; spQueues = getCampaignManager(context, appletResponse, locale).getSPQueuesBySPID(spID);</span>
<span class="fc" id="L1202">		appletResponse.put(PageKeys.QUEUE_GOAL_MAP, getQueueGoalsMap(spQueues));</span>
		
		//findAllActivitiesForQueues just returns queue hopping links.  It is a Map of Queue ID (key) and collection of Activity Ids (value)
		//We then add all activities that are indirectly mapped to the Queues through the media in &quot;Non-Queue Hopping&quot; scenarios.
<span class="fc" id="L1206">		Map&lt;ID, ArrayList&lt;ID&gt;&gt; queueToActivityMap = activityManager.findActivitiesDirectlyMappedToQueuesInDB(queueIds);</span>
<span class="fc bfc" id="L1207" title="All 2 branches covered.">		for (Map.Entry&lt;ID, Collection&lt;ID&gt;&gt; entry : activityToMediaMap.entrySet()) {</span>
<span class="fc" id="L1208">			Activity activity = activityManager.findActivityById(entry.getKey());</span>
<span class="fc bfc" id="L1209" title="All 2 branches covered.">			if ( ! activity.isQueueHopping() ) {</span>
				//Get all queues with Media from entry.getValue()
				//Add this activity to that queueToActivityMap
<span class="fc bfc" id="L1212" title="All 2 branches covered.">				for (ID mediaId : entry.getValue()) {</span>
<span class="fc" id="L1213">					ArrayList&lt;ID&gt; queuesForMedia = mediaIdToQueueIDMap.get(mediaId);</span>
<span class="fc bfc" id="L1214" title="All 2 branches covered.">					if ( queuesForMedia != null ) {</span>
<span class="fc bfc" id="L1215" title="All 2 branches covered.">						for ( ID queueId : queuesForMedia) {</span>
<span class="fc" id="L1216">							ArrayList&lt;ID&gt; activityIds = queueToActivityMap.get(queueId);</span>
<span class="fc bfc" id="L1217" title="All 2 branches covered.">							if (activityIds == null) {</span>
<span class="fc" id="L1218">								activityIds = new ArrayList&lt;ID&gt;();</span>
							}
<span class="fc" id="L1220">							activityIds.add(entry.getKey());</span>
<span class="fc" id="L1221">							queueToActivityMap.put(queueId, activityIds);</span>
<span class="fc" id="L1222">						}</span>
					}
<span class="fc" id="L1224">				}</span>
			}
<span class="fc" id="L1226">		}</span>
<span class="fc" id="L1227">		appletResponse.put(PageKeys.APPLET_DATA, queueToActivityMap);</span>

		//get all activities with queues from the ActivityQueue table. These are needed when optimizing break placements in new shift assignments.
<span class="fc" id="L1230">		Map&lt;ID, Collection&lt;ID&gt;&gt; hmActivityQueues = (Map&lt;ID, Collection&lt;ID&gt;&gt;)activityManager.findQueueForActivities(allActivityIDs);</span>
<span class="fc" id="L1231">		appletResponse.put(PageKeys.ACTIVITY_QUEUES_ID, hmActivityQueues);</span>

		//Get all queues from hmActivityQueues as well as all queues for the SP. These are needed when optimizing break placements in new shift assignments.
<span class="fc" id="L1234">		Map&lt;ID, Queue&gt; relevantQueues = getRelevantQueues(spQueues, hmActivityQueues);</span>
<span class="fc" id="L1235">		appletResponse.put(PageKeys.RELEVANT_QUEUES_ID, relevantQueues);</span>
<span class="fc" id="L1236">		return msgID;</span>
	}

	
	/**
	 * Apply a skill start date adjustment so a time of say 22:00:00 in GMT will be adjusted to start at 22:01:00.
	 * This adjustment when applied to a skill that's being removed  from the emp's assignments
	 * ensures that this skill is no longer accounted for in the staffing count, when viewed for the SP week 
	 * starting at the new adjusted time of 22:01 soon after it was end-dated to end at 22:00.
	 * &lt;p&gt;
	 * See &lt;tt&gt;ESR4534014&lt;/tt&gt; details.
	 * 
	 * @param startDate
	 */
	protected Date adjustStartDateToAddAMinute(Date startDate) {
<span class="fc" id="L1251">		Calendar startCal = Calendar.getInstance();</span>
<span class="fc" id="L1252">		startCal.setTimeInMillis(startDate.getTime());</span>
<span class="fc" id="L1253">		startCal.add(Calendar.MINUTE, 1);</span>
<span class="fc" id="L1254">		return startCal.getTime();</span>
	}
	
	/**
	 * Given an organization ID, get the queue color tolerance for it settings from the Organization Settings page,
	 * @param orgID - The organization where the queue is defined.
	 * @return An ArrayList containing the four queue tolerance settings for any queue belonging to the specified org.
	 * The four integer values will be in the following order: 
	 *     [0] = CONTACT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE
	 *     [1] = CONTACT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE
	 *     [2] = PROJECT_QUEUE_ABOVE_REQUIREMENTS_TOLERANCE
	 *     [3] = PROJECT_QUEUE_BELOW_REQUIREMENTS_TOLERANCE 
	 * @throws RemoteException 
	 * @throws BbmCreateException 
	 * @throws BbmFinderException 
	 */
	 ArrayList&lt;Integer&gt; getQueueToleranceArrayForOrg(RequestContext context, ID orgID) throws BbmFinderException, BbmCreateException, RemoteException {
<span class="fc" id="L1271">		 ArrayList&lt;Integer&gt; tolerances = new  ArrayList&lt;Integer&gt;(4);		  </span>
<span class="fc" id="L1272">		 OrganizationSetting orgSettings = OrgCalendarOptionsMH.getSettings(context, orgID);</span>
<span class="fc" id="L1273">		 tolerances.add(new Integer(orgSettings.getContactAboveReqTolerance()));</span>
<span class="fc" id="L1274">		 tolerances.add(new Integer(orgSettings.getContactBelowReqTolerance()));</span>
<span class="fc" id="L1275">		 tolerances.add(new Integer(orgSettings.getProjectAboveReqTolerance()));</span>
<span class="fc" id="L1276">		 tolerances.add(new Integer(orgSettings.getProjectBelowReqTolerance()));</span>
<span class="fc" id="L1277">		 return tolerances;</span>
	 }

    /**
     * Get all queues from hmActivityQueues as well as all queues for the SP. These are needed when optimizing break placements in new shift assignments.
     */
    Map&lt;ID, Queue&gt; getRelevantQueues(Collection&lt;SPQueue&gt; spQueues, Map&lt;ID, Collection&lt;ID&gt;&gt; hmActivityQueues)
        throws BbmEJBCreateException, BbmFinderException, RemoteException {
<span class="fc" id="L1285">        Set&lt;ID&gt; queueIDs = new HashSet&lt;ID&gt;();</span>

<span class="fc bfc" id="L1287" title="All 2 branches covered.">        for (SPQueue spq : spQueues) {</span>
<span class="fc" id="L1288">            queueIDs.add(spq.getQueueID());</span>
<span class="fc" id="L1289">        }</span>

<span class="fc bfc" id="L1291" title="All 2 branches covered.">        for (ID activityID : hmActivityQueues.keySet()) {</span>
<span class="fc" id="L1292">            queueIDs.addAll(hmActivityQueues.get(activityID));</span>
<span class="fc" id="L1293">        }</span>

<span class="fc" id="L1295">        Map&lt;ID, Queue&gt; hmQueues = new HashMap&lt;ID, Queue&gt;();</span>

<span class="pc bpc" id="L1297" title="1 of 2 branches missed.">        if (queueIDs.size() &gt; 0) {</span>
<span class="fc" id="L1298">            Collection&lt;Queue&gt; queues = WfmManagerFactory.getWorkloadManager().getQueuesByIDs(queueIDs);</span>
<span class="pc bpc" id="L1299" title="2 of 4 branches missed.">            if (queues != null &amp;&amp; queues.size() &gt; 0) {</span>
<span class="fc bfc" id="L1300" title="All 2 branches covered.">                for (Queue queue : queues) {</span>
<span class="fc" id="L1301">                    hmQueues.put(queue.getID(), queue);</span>
<span class="fc" id="L1302">                }</span>
            }
        }

<span class="fc" id="L1306">        return hmQueues;</span>
    }
	
	/**
	 * Get a map (queue SID -&gt; ServiceGoalsType) for each queue in the SP.
	 * For an unskilled SP or a skilled SP with a single immediate-media queue,
	 * it stores the immediate media queue service goal type
	 * under both the queue ID and null for the combined queue.
	 */
	private Map&lt;ID, ServiceGoalsType&gt; getQueueGoalsMap(Collection&lt;SPQueue&gt; spQueues) {
<span class="fc" id="L1316">		Map&lt;ID, ServiceGoalsType&gt; queueGoalsMap = new HashMap&lt;ID, ServiceGoalsType&gt;();</span>
		
<span class="fc" id="L1318">		Set&lt;SPQueue&gt; immediateSPQueues = new HashSet&lt;SPQueue&gt;();</span>
<span class="fc bfc" id="L1319" title="All 2 branches covered.">		for ( SPQueue spQ : spQueues ) {</span>
<span class="fc" id="L1320">			queueGoalsMap.put(spQ.getQueueID(), ServiceGoalsType.get(MediaType.get(spQ.getMediaID()), spQ));</span>
<span class="fc bfc" id="L1321" title="All 2 branches covered.">			if (Media.isMediaImmediate(spQ.getMediaID())) {</span>
<span class="fc" id="L1322">				immediateSPQueues.add(spQ);</span>
			}
<span class="fc" id="L1324">		}</span>
<span class="fc bfc" id="L1325" title="All 2 branches covered.">		if ( immediateSPQueues.size() == 1 ) {</span>
<span class="fc" id="L1326">			SPQueue spQ = immediateSPQueues.iterator().next();</span>
<span class="fc" id="L1327">			queueGoalsMap.put(null, queueGoalsMap.get(spQ.getQueueID()));</span>
		}
		
<span class="fc" id="L1330">		return queueGoalsMap;</span>
	}

	/**
	 * Returns a map (queue SID -&gt; service level goal seconds) for each queue in the SP.
	 */
	private Map&lt;NullablePair&lt;ID, ID&gt;, Integer&gt; getQueueServiceLevelGoalSecondsMap(Collection&lt;SPQueue&gt; spQueues, boolean isSkillBased)
		throws BbmFinderException, RemoteException {
<span class="fc" id="L1338">		Map&lt;NullablePair&lt;ID, ID&gt;, Integer&gt; queueSLGoalSecondsMap = new HashMap&lt;NullablePair&lt;ID, ID&gt;, Integer&gt;();</span>

<span class="pc bpc" id="L1340" title="1 of 2 branches missed.">		if ( ! spQueues.isEmpty() ) {</span>
<span class="fc" id="L1341">			Set&lt;SPQueue&gt; immediateSPQueues = new HashSet&lt;SPQueue&gt;();</span>
<span class="fc bfc" id="L1342" title="All 2 branches covered.">			if ( isSkillBased ) {</span>
<span class="fc bfc" id="L1343" title="All 2 branches covered.">				for ( SPQueue spQ : spQueues ) {</span>
<span class="pc bpc" id="L1344" title="1 of 2 branches missed.">					if (spQ.getMediaID() != null) {</span>
<span class="fc" id="L1345">						queueSLGoalSecondsMap.put(new NullablePair&lt;ID, ID&gt;(spQ.getMediaID(), spQ.getQueueID()), spQ.getSlAnswerWaitingTime());</span>
<span class="fc bfc" id="L1346" title="All 2 branches covered.">						if (Media.isMediaImmediate(spQ.getMediaID())) {</span>
<span class="fc" id="L1347">							immediateSPQueues.add(spQ);</span>
						}
					}
<span class="fc" id="L1350">				}</span>
			} else {
				// For unskilled SPs, just store the media combined queue service levels
				// for any immediate media queues.
				// DHM: Normally unskilled just supports phone but I'm not sure how
				// RFS might deal with face-to-face.
<span class="fc" id="L1356">				ID spID = spQueues.iterator().next().getSpID();</span>
<span class="fc bfc" id="L1357" title="All 2 branches covered.">				for (SPQueue spQ : spQueues) {</span>
<span class="fc" id="L1358">					ID mediaID = spQ.getMediaID();</span>
<span class="pc bpc" id="L1359" title="2 of 4 branches missed.">					if (mediaID != null &amp;&amp; Media.isMediaImmediate(mediaID)) {</span>
<span class="fc" id="L1360">						NullablePair&lt;ID, ID&gt; mediaCombinedPair = new NullablePair&lt;ID, ID&gt;(mediaID, null);</span>
<span class="fc bfc" id="L1361" title="All 2 branches covered.">						if ( ! queueSLGoalSecondsMap.containsKey(mediaCombinedPair)) {</span>
<span class="fc" id="L1362">							SPQueue combinedSpQ = m_campaignManager.getCombinedSPQueue(spID, mediaID);</span>
<span class="fc" id="L1363">							queueSLGoalSecondsMap.put(mediaCombinedPair, combinedSpQ.getSlAnswerWaitingTime());</span>
						}
<span class="fc" id="L1365">						immediateSPQueues.add(spQ);</span>
					}
<span class="fc" id="L1367">				}</span>
			}
<span class="fc bfc" id="L1369" title="All 2 branches covered.">			if (immediateSPQueues.size() == 1) {</span>
<span class="fc" id="L1370">				SPQueue spQ = immediateSPQueues.iterator().next();</span>
<span class="fc bfc" id="L1371" title="All 2 branches covered.">				ID queueID = isSkillBased ? spQ.getQueueID() : null;</span>
				// Copy the only immediate media service goal to combined-combined.
<span class="fc" id="L1373">				queueSLGoalSecondsMap.put(new NullablePair&lt;ID, ID&gt;(null, null), queueSLGoalSecondsMap.get(new NullablePair&lt;ID, ID&gt;(spQ.getMediaID(), queueID)));</span>
			}
		}

<span class="fc" id="L1377">		return queueSLGoalSecondsMap;</span>
	}

	/**
	 * Returns a map from queue ID to FTE requirements calculated without regard for minimum
	 * occupancy.  If the user has manually defined FTE requirements for a queue then those
	 * requirements are returned for that queue.
	 * &lt;p/&gt;
	 * Note: This method should only be called for an unskilled SP.
	 * 
	 * @param context
	 * @param appletResponse
	 * @param locale
	 * @param spQueues
	 * @param startDate
	 * @param endDate
	 * @param useMinimumOccupancy if {@code false}, then the returned FTE level does not reflect
	 * minimum occupancy; if {@code true} then minimum occupancy is taken into account.  Only affects
	 * results for an unskilled SP with a PCA service goal type.
	 * @param useShrinkage If true, we compute the required FTE using the full formula, which includes reverse-compensating for shrinkage.
	 * @return
	 * @throws BbmFinderException
	 * @throws BbmTimeSeriesException
	 * @throws RemoteException
	 */
	private Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; getQueueRequiredFTEForRealTimeServiceLevelMap(
			RequestContext context,
			Map appletResponse,
			Locale locale,
			ID campaignID,
			Collection&lt;SPQueue&gt; spQueues,
			Date startDate,
			Date endDate,
			boolean useMinimumOccupancy,
			boolean useShrinkage)
			throws BbmFinderException, BbmTimeSeriesException, BbmEJBCreateException, RemoteException {
<span class="fc" id="L1413">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; queueMediaFTEMap = new HashMap&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt;();</span>
<span class="fc" id="L1414">		FteRequirementsManager fteReqtsMgr = getFteRequirementsManager(context, appletResponse, locale);</span>
<span class="fc bfc" id="L1415" title="All 2 branches covered.">		for (SPQueue spQueue : spQueues) {</span>
			// We are only interested in immediate media queues.
<span class="pc bpc" id="L1417" title="2 of 4 branches missed.">			if (spQueue.getMediaID() != null &amp;&amp; Media.isMediaImmediate(spQueue.getMediaID())) {</span>
<span class="fc" id="L1418">				ID queueID = spQueue.getQueueID();</span>
<span class="fc" id="L1419">				Collection&lt;RequiredTimeSeries&gt; fteForThisSpQueue = fteReqtsMgr.calculateFteRequirementsForSPQueues(</span>
<span class="fc" id="L1420">						Collections.singleton(spQueue.getID()), useMinimumOccupancy, useShrinkage);</span>
				RequireTraceCube fteRequirementsCube;
<span class="pc bpc" id="L1422" title="1 of 2 branches missed.">				if (fteForThisSpQueue.isEmpty()) {</span>
					// If the calculate method returned an empty list, it's because there were
					// manually defined FTE requirements for this queue.  We get those instead.
<span class="nc" id="L1425">					fteRequirementsCube = fteReqtsMgr.getFteRequirementsTraceCube(campaignID, queueID, spQueue.getMediaID(), startDate, endDate);</span>
				} else {
<span class="fc" id="L1427">					fteRequirementsCube = FteRequirementsTimeSeriesUtil.convertRequiredTimeSeriesToTraceCube(fteForThisSpQueue, queueID, startDate, endDate);</span>
				}
<span class="fc" id="L1429">				queueMediaFTEMap.put(new NullablePair&lt;ID, ID&gt;(spQueue.getMediaID(), queueID), fteRequirementsCube);</span>
			}
<span class="fc" id="L1431">		}</span>
		// Copy any non-combined queue data to the combined queue.
<span class="pc bpc" id="L1433" title="2 of 4 branches missed.">		if ( ! queueMediaFTEMap.containsKey(new NullablePair&lt;ID, ID&gt;(null, null)) &amp;&amp; ! queueMediaFTEMap.isEmpty()) {</span>
<span class="fc" id="L1434">			queueMediaFTEMap.put(new NullablePair&lt;ID, ID&gt;(null, null), queueMediaFTEMap.values().iterator().next());</span>
		}
<span class="fc" id="L1436">		return queueMediaFTEMap;</span>
	}

	private String getEmployeeFilterName(RequestContext context) {
<span class="fc" id="L1440">		String empFilterName = context.getUserProperty(PageKeys.EMP_FILTER);</span>
<span class="fc" id="L1441">		return empFilterName;</span>
	}

	private void addShiftDurationCache(RequestContext context, Map appletResponse)
	throws RemoteException,BbmFinderException, BbmEJBCreateException {
<span class="nc" id="L1446">		Locale locale = context.getLocaleContext().getLanguageLocale();</span>
<span class="nc" id="L1447">		String shiftDurationCache =</span>
<span class="nc" id="L1448">			context.getUserProperty(&quot;SHIFT_DURATION_CACHE&quot;);</span>
		// the format of this property is 'shiftId.duration.timeInMilliseconds,[...]'
<span class="nc bnc" id="L1450" title="All 2 branches missed.">		if (!StringUtil.isEmpty(shiftDurationCache)) {</span>
			// the format of the array is [shiftId, duration, timeInMilliseconds,...]
<span class="nc" id="L1452">			String data[] = StringUtil.parseStringToArray(shiftDurationCache,</span>
			&quot;.,&quot;);

			// the id can appear more than once in the list so
			// we use a hashset to make the results unique.
<span class="nc" id="L1457">			Set shiftIds = new HashSet(31);</span>
<span class="nc bnc" id="L1458" title="All 2 branches missed.">			for (int i = 0; i &lt; data.length; i += 3)</span>
<span class="nc" id="L1459">				shiftIds.add(new ID(data[i]));</span>

<span class="nc bnc" id="L1461" title="All 2 branches missed.">			if (shiftIds.size() != 0) {</span>
<span class="nc" id="L1462">				HashMap cacheShifts = ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context, appletResponse, locale).getShiftsByIDs(shiftIds));</span>
				// remove items from cache that are longer valid
<span class="nc" id="L1464">				Iterator itr = shiftIds.iterator();</span>
				// format of delete cmd is &quot;-shiftId.duration[,...]*&quot;
<span class="nc" id="L1466">				StringBuilder sb = new StringBuilder(1024);</span>
<span class="nc" id="L1467">				sb.append(&quot;-&quot;); // delete command</span>
<span class="nc" id="L1468">				boolean addComma = false;</span>
<span class="nc bnc" id="L1469" title="All 2 branches missed.">				while (itr.hasNext()) {</span>
<span class="nc" id="L1470">					Object id = itr.next();</span>
<span class="nc" id="L1471">					Shift shift = (Shift)cacheShifts.get(id);</span>
					// remove invalid ids
<span class="nc bnc" id="L1473" title="All 2 branches missed.">					if (shift == null) {</span>
<span class="nc" id="L1474">						String idStr = id.toString();</span>
<span class="nc bnc" id="L1475" title="All 2 branches missed.">						for (int i = 0; i &lt; data.length; i += 3) {</span>
<span class="nc bnc" id="L1476" title="All 2 branches missed.">							if (idStr.equals(data[i])) {</span>
<span class="nc bnc" id="L1477" title="All 2 branches missed.">								if (addComma)</span>
<span class="nc" id="L1478">									sb.append(',');</span>
<span class="nc" id="L1479">								sb.append(idStr);</span>
<span class="nc" id="L1480">								sb.append('.');</span>
<span class="nc" id="L1481">								sb.append(data[i+1]);</span>
<span class="nc" id="L1482">								addComma = true;</span>
							}
						}
					}
<span class="nc" id="L1486">				}</span>
<span class="nc bnc" id="L1487" title="All 2 branches missed.">				if (addComma) {</span>
<span class="nc" id="L1488">					shiftDurationCache = processShiftDurationCommand(context, sb.toString());</span>
				}
				
<span class="nc" id="L1491">				appletResponse.put(</span>
						PageKeys.FS_SHIFT_DURATION_PICKER_SHIFTS,
						cacheShifts);
			}
<span class="nc" id="L1495">			appletResponse.put(</span>
					PageKeys.FS_SHIFT_DURATION_PICKER_CACHE_SHIFT_DURATION,
					shiftDurationCache);
<span class="nc" id="L1498">		} else {</span>
<span class="nc" id="L1499">			appletResponse.put(</span>
					PageKeys.FS_SHIFT_DURATION_PICKER_CACHE_SHIFT_DURATION,
			&quot;&quot;);
		}
<span class="nc" id="L1503">	}</span>

	private StringBuilder createShiftDurationCache(StringBuilder sb, String data[]) {
		// create a new cache by removing the null items
<span class="nc bnc" id="L1507" title="All 2 branches missed.">		if (sb == null) {</span>
<span class="nc" id="L1508">			sb = new StringBuilder(1024);</span>
		}
<span class="nc bnc" id="L1510" title="All 2 branches missed.">		boolean addComma = sb.length() != 0;</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">		for (int i = 0; i &lt; data.length; i += 3) {</span>
<span class="nc bnc" id="L1512" title="All 2 branches missed.">			if (data[i] == null) {</span>
<span class="nc" id="L1513">				continue;</span>
			}
<span class="nc bnc" id="L1515" title="All 2 branches missed.">			if (addComma) {</span>
<span class="nc" id="L1516">				sb.append(&quot;,&quot;);</span>
			}
<span class="nc" id="L1518">			sb.append(data[i]);</span>
<span class="nc" id="L1519">			sb.append(&quot;.&quot;);</span>
<span class="nc" id="L1520">			sb.append(data[i+1]);</span>
<span class="nc" id="L1521">			sb.append(&quot;.&quot;);</span>
<span class="nc" id="L1522">			sb.append(data[i+2]);</span>
<span class="nc" id="L1523">			addComma = true;</span>
		}
<span class="nc" id="L1525">		return sb;</span>
	}

	private String trimShiftDurationCache(String shiftDurationCache) {
		// count the number of ',' in the string
<span class="nc" id="L1530">		int count = 0;</span>
<span class="nc" id="L1531">		int i = 0;</span>
<span class="nc" id="L1532">		int l = shiftDurationCache.length();</span>
<span class="nc bnc" id="L1533" title="All 4 branches missed.">		while (i &lt; l &amp;&amp; (i = shiftDurationCache.indexOf(',', i)) &gt; 0) {</span>
<span class="nc" id="L1534">			count++;</span>
<span class="nc" id="L1535">			i++;</span>
		}

		// make sure that there are only 20 items in the cache
<span class="nc bnc" id="L1539" title="All 2 branches missed.">		if (count &gt; 20) {</span>
<span class="nc" id="L1540">			String data[] = StringUtil.parseStringToArray(shiftDurationCache,</span>
			&quot;.,&quot;);
<span class="nc" id="L1542">			int size = count - 20;</span>
<span class="nc" id="L1543">			int delete[] = new int[size];</span>
			// figure which entries to remove
<span class="nc bnc" id="L1545" title="All 2 branches missed.">			for (i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L1546">				delete[i] = i*3;</span>
			}
			// find the entries that are least used
			// format of data is [shiftId, duration, millisecond,...]
<span class="nc bnc" id="L1550" title="All 2 branches missed.">			for (i = size*3; i &lt; data.length; i += 3) {</span>
<span class="nc" id="L1551">				int ii = i;</span>
<span class="nc bnc" id="L1552" title="All 2 branches missed.">				for (int j = 0; j &lt; size; j++) {</span>
<span class="nc" id="L1553">					if (Long.parseLong(data[ii+2]) &lt;</span>
<span class="nc bnc" id="L1554" title="All 2 branches missed.">							Long.parseLong(data[delete[j]+2])) {</span>
<span class="nc" id="L1555">						int tmp = delete[j];</span>
<span class="nc" id="L1556">						delete[j] = ii;</span>
<span class="nc" id="L1557">						ii = tmp;</span>
					}
				}
			}

			// mark the entry for deletion
<span class="nc bnc" id="L1563" title="All 2 branches missed.">			for (i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L1564">				data[ delete[i] ] = null;</span>
			}
			
<span class="nc" id="L1567">			shiftDurationCache = createShiftDurationCache(null, data).toString();</span>
		}
<span class="nc" id="L1569">		return shiftDurationCache;</span>
	}

	private String processShiftDurationCommand(RequestContext context, String cmd) {
		String shiftDurationCache;
<span class="nc" id="L1574">		shiftDurationCache = (String)context.getUserProperty(&quot;SHIFT_DURATION_CACHE&quot;);</span>
<span class="nc" id="L1575">		boolean changed = false;</span>
		// add shift-duration
<span class="nc bnc" id="L1577" title="All 2 branches missed.">		if (cmd.startsWith(&quot;+&quot;)) {</span>
<span class="nc bnc" id="L1578" title="All 2 branches missed.">			if (!StringUtil.isEmpty(shiftDurationCache))  {</span>
<span class="nc" id="L1579">				shiftDurationCache = trimShiftDurationCache(shiftDurationCache + &quot;,&quot; + cmd.substring(1));</span>
			} else {
<span class="nc" id="L1581">				shiftDurationCache = cmd.substring(1);</span>
			}
<span class="nc" id="L1583">			changed = true;</span>
		}
		// delete shift-duration
<span class="nc bnc" id="L1586" title="All 2 branches missed.">		else if (cmd.startsWith(&quot;-&quot;)) {</span>
<span class="nc bnc" id="L1587" title="All 2 branches missed.">			if (!StringUtil.isEmpty(shiftDurationCache)) {</span>
<span class="nc" id="L1588">				String data[] = StringUtil.parseStringToArray(shiftDurationCache,</span>
				&quot;.,&quot;);
				// format of delta is ['shiftId', 'duration', ...]
<span class="nc" id="L1591">				String delta[] = StringUtil.parseStringToArray(cmd.substring(1),</span>
				&quot;.,&quot;);
<span class="nc bnc" id="L1593" title="All 2 branches missed.">				for (int i = 0; i &lt; data.length; i += 3) {</span>
<span class="nc bnc" id="L1594" title="All 2 branches missed.">					for (int j = 0; j &lt; delta.length; j += 2) {</span>
						// if shift ids match
<span class="nc bnc" id="L1596" title="All 2 branches missed.">						if (data[i].equals(delta[j]) &amp;&amp;</span>
								// if shift duration match
<span class="nc bnc" id="L1598" title="All 2 branches missed.">								data[i+1].equals(delta[j+1])) {</span>
<span class="nc" id="L1599">							changed = true;</span>
							// remove the shift id
<span class="nc" id="L1601">							data[i] = null;</span>
						}
					}
				}
<span class="nc bnc" id="L1605" title="All 2 branches missed.">				if (changed) {</span>
<span class="nc" id="L1606">					shiftDurationCache = createShiftDurationCache(null, data).toString();</span>
				}
<span class="nc" id="L1608">			}</span>
		} else {
			// update shift-duration
<span class="nc bnc" id="L1611" title="All 2 branches missed.">			if (!StringUtil.isEmpty(shiftDurationCache)) {</span>
<span class="nc" id="L1612">				String data[] = StringUtil.parseStringToArray(shiftDurationCache,&quot;.,&quot;);</span>
<span class="nc" id="L1613">				String delta[] = StringUtil.parseStringToArray(cmd,&quot;.,&quot;);</span>
<span class="nc bnc" id="L1614" title="All 2 branches missed.">				for (int i = 0; i &lt; data.length; i += 3) {</span>
<span class="nc bnc" id="L1615" title="All 2 branches missed.">					for (int j = 0; j &lt; delta.length; j += 3) {</span>
<span class="nc bnc" id="L1616" title="All 2 branches missed.">						if (delta[j] == null) {</span>
<span class="nc" id="L1617">							continue;</span>
						}
						// if shift ids match
<span class="nc bnc" id="L1620" title="All 4 branches missed.">						if (data[i].equals(delta[j]) &amp;&amp; data[i+1].equals(delta[j+1])) {</span>
							// copy last used time stamp
<span class="nc" id="L1622">							data[i+2] = delta[j+2];</span>
<span class="nc" id="L1623">							delta[j] = null;</span>
						}
					}
				}
<span class="nc" id="L1627">				StringBuilder sb = createShiftDurationCache(null, data);</span>
				// allow updates to do implicit additions
<span class="nc" id="L1629">				createShiftDurationCache(sb, delta);</span>
<span class="nc" id="L1630">				shiftDurationCache = trimShiftDurationCache(sb.toString());</span>
<span class="nc" id="L1631">			} else {</span>
<span class="nc" id="L1632">				shiftDurationCache = cmd;</span>
			}
<span class="nc" id="L1634">			changed = true;</span>
		}
<span class="nc bnc" id="L1636" title="All 2 branches missed.">		if (changed) {</span>
<span class="nc" id="L1637">			context.setUserProperty(&quot;SHIFT_DURATION_CACHE&quot;, shiftDurationCache);</span>
		}
<span class="nc" id="L1639">		return shiftDurationCache;</span>
	}

<span class="fc" id="L1642">	public static final ID DEFAULT_ID = new ID(0);</span>
<span class="fc" id="L1643">	public static final Integer DEFAULT_INT = new Integer(0);</span>
<span class="fc" id="L1644">	public static final TimeOfDay DEFAULT_TIME = new TimeOfDay(0);</span>

<span class="fc" id="L1646">	public static class ShiftComparator implements Comparator {</span>
		public static final int NAME_SORT = 0;
		public static final int PAY_POLICY_SORT = 1;
		public static final int START_SORT = 2;
		public static final int DESC_SORT = 3;
		public static final int DURATION_SORT = 4;
		public static final int ORG_SORT = 5;

<span class="nc" id="L1654">		int m_sortType = NAME_SORT;</span>
<span class="nc" id="L1655">		public ShiftComparator(String column) {</span>
<span class="nc bnc" id="L1656" title="All 2 branches missed.">			if (StringUtil.isEmpty(column) ||</span>
<span class="nc bnc" id="L1657" title="All 2 branches missed.">					column.equalsIgnoreCase(&quot;NAME&quot;)) {</span>
<span class="nc" id="L1658">				m_sortType = NAME_SORT;</span>
			}
<span class="nc bnc" id="L1660" title="All 2 branches missed.">			else if (column.equalsIgnoreCase(&quot;START&quot;)) {</span>
<span class="nc" id="L1661">				m_sortType = START_SORT;</span>
			}
<span class="nc bnc" id="L1663" title="All 2 branches missed.">			else if (column.equalsIgnoreCase(&quot;DESC&quot;)) {</span>
<span class="nc" id="L1664">				m_sortType = DESC_SORT;</span>
			}
<span class="nc bnc" id="L1666" title="All 2 branches missed.">			else if (column.equalsIgnoreCase(&quot;DURATION&quot;)) {</span>
<span class="nc" id="L1667">				m_sortType = DURATION_SORT;</span>
			}
<span class="nc bnc" id="L1669" title="All 2 branches missed.">			else if (column.equalsIgnoreCase(&quot;PAY_POLICY&quot;)) {</span>
<span class="nc" id="L1670">				m_sortType = PAY_POLICY_SORT;</span>
			}
<span class="nc bnc" id="L1672" title="All 2 branches missed.">			else if (column.equalsIgnoreCase(&quot;ORG&quot;)) {</span>
<span class="nc" id="L1673">				m_sortType = ORG_SORT;</span>
			}
<span class="nc" id="L1675">		}</span>
		public TimeOfDay getMinTime(Collection times) {
<span class="nc" id="L1677">			Iterator itr = times.iterator();</span>
<span class="nc" id="L1678">			TimeOfDay t1 = DEFAULT_TIME;</span>
<span class="nc bnc" id="L1679" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L1680">				TimeOfDay t2 = (TimeOfDay)itr.next();</span>
<span class="nc bnc" id="L1681" title="All 4 branches missed.">				if (t1 == DEFAULT_TIME || t1.after(t2)) {</span>
<span class="nc" id="L1682">					t1 = t2;</span>
				}
<span class="nc" id="L1684">			}</span>
<span class="nc" id="L1685">			return t1;</span>
		}
		public Integer getMaxDuration(Collection durations) {
<span class="nc" id="L1688">			Iterator itr = durations.iterator();</span>
<span class="nc" id="L1689">			Integer t1 = DEFAULT_INT;</span>
<span class="nc bnc" id="L1690" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L1691">				Integer t2 = (Integer)itr.next();</span>
<span class="nc bnc" id="L1692" title="All 4 branches missed.">				if (t1 == DEFAULT_INT || t1.intValue() &lt; t2.intValue()) {</span>
<span class="nc" id="L1693">					t1 = t2;</span>
				}
<span class="nc" id="L1695">			}</span>
<span class="nc" id="L1696">			return t1;</span>
		}
		public int compare(Object o1, Object o2) {
<span class="nc" id="L1699">			Shift s1 = (Shift)o1;</span>
<span class="nc" id="L1700">			Shift s2 = (Shift)o2;</span>
<span class="nc bnc" id="L1701" title="All 3 branches missed.">			switch(m_sortType) {</span>

			case DESC_SORT:
<span class="nc" id="L1704">				String desc1 = s1.getDescription();</span>
<span class="nc" id="L1705">				String desc2 = s2.getDescription();</span>
<span class="nc bnc" id="L1706" title="All 2 branches missed.">				if (desc1 == null) {</span>
<span class="nc" id="L1707">					desc1 = &quot;&quot;;</span>
				}
<span class="nc bnc" id="L1709" title="All 2 branches missed.">				if (desc2 == null) {</span>
<span class="nc" id="L1710">					desc2 = &quot;&quot;;</span>
				}
<span class="nc" id="L1712">				return desc1.compareTo(desc2);</span>

			case ORG_SORT: 
				// should use org name ...
<span class="nc" id="L1716">				ID oid1 = s1.getOrganizationID();</span>
<span class="nc" id="L1717">				ID oid2 = s2.getOrganizationID();</span>
<span class="nc bnc" id="L1718" title="All 2 branches missed.">				if (oid1 == null) {</span>
<span class="nc" id="L1719">					oid1 = DEFAULT_ID;</span>
				}
<span class="nc bnc" id="L1721" title="All 2 branches missed.">				if (oid2 == null) {</span>
<span class="nc" id="L1722">					oid2 = DEFAULT_ID;</span>
				}
<span class="nc" id="L1724">				return oid1.compareTo(oid2);</span>
			}

<span class="nc" id="L1727">			return s1.getName().compareTo(s2.getName());</span>
		}
	}

	private Map&lt;ID, Boolean&gt; getEmpEditablesForEvent(Map appletResponse, Locale locale, Event eventToCheck, Date startDate, Date endDate, RequestContext context)
	throws BbmFinderException, RemoteException, BbmEJBCreateException {
<span class="fc" id="L1733">		return getEmpEditablesForEvents(appletResponse, locale, Collections.singletonList(eventToCheck), startDate, endDate, context);</span>
	}

	private Map&lt;ID, Boolean&gt; getEmpEditablesForEventTemplate(Map appletResponse, Locale locale, CalendarEventTemplate templateToCheck, RequestContext context)
	throws BbmFinderException, RemoteException, BbmEJBCreateException {
<span class="fc" id="L1738">		Collection&lt;ID&gt; cEmpIDs = templateToCheck.getWorkResourceIDs();</span>
		// @todo - TYLER you may need to do something smarter than null, null
<span class="fc" id="L1740">		return getEmpEditables(appletResponse, locale, cEmpIDs, null, null, context);</span>
	}

	private Map&lt;ID, Boolean&gt; getEmpEditablesForEvents(Map appletResponse, Locale locale, List&lt;Event&gt; eventsToCheck, Date startDate, Date endDate, RequestContext context)
	throws BbmFinderException, RemoteException, BbmEJBCreateException {
<span class="fc" id="L1745">		Set&lt;ID&gt; setEmpIDs = new HashSet&lt;ID&gt;(eventsToCheck.size());</span>
<span class="fc" id="L1746">		Iterator&lt;Event&gt; itEvents = eventsToCheck.iterator();</span>
<span class="fc bfc" id="L1747" title="All 2 branches covered.">		while (itEvents.hasNext()) {</span>
<span class="fc" id="L1748">			Event nextEvent = itEvents.next();</span>
<span class="fc" id="L1749">			setEmpIDs.addAll(nextEvent.getWorkResourceIDs());</span>
<span class="fc" id="L1750">		}</span>
<span class="fc" id="L1751">		return getEmpEditables(appletResponse, locale, setEmpIDs, startDate, endDate, context);</span>
	}

	private Map&lt;ID, Boolean&gt; getEmpEditables(Map appletResponse, Locale locale, Collection&lt;ID&gt; idsToCheck, Date startDate, Date endDate, RequestContext context)
	throws BbmFinderException, RemoteException, BbmEJBCreateException {
<span class="fc" id="L1756">		Collection authorizedOrgs = context.getUser().getAuthorizedScopes(PrivilegeKeys.FS_VIEWORGSCHEDULES);</span>
<span class="fc" id="L1757">		Map&lt;ID, Boolean&gt; empEditables = new HashMap&lt;ID, Boolean&gt;(idsToCheck.size());</span>
<span class="pc bpc" id="L1758" title="2 of 4 branches missed.">		if (authorizedOrgs == null || authorizedOrgs.isEmpty()) {</span>
<span class="nc" id="L1759">			Iterator&lt;ID&gt; itIDs = idsToCheck.iterator();</span>
<span class="nc bnc" id="L1760" title="All 2 branches missed.">			while (itIDs.hasNext()) {</span>
<span class="nc" id="L1761">				ID nextID = itIDs.next();</span>
<span class="nc" id="L1762">				empEditables.put(nextID, Boolean.FALSE);</span>
<span class="nc" id="L1763">			}</span>
<span class="nc" id="L1764">		} else {</span>
<span class="fc" id="L1765">			Map&lt;ID, Object&gt; employeesReportingOrgs = getWorkResourceManager(context, appletResponse, locale).getEmployeesReportingOrgs(idsToCheck, startDate, endDate);</span>
<span class="pc bpc" id="L1766" title="1 of 2 branches missed.">			if (employeesReportingOrgs.isEmpty()) {</span>
				//could be phantom, return phantomid-orgid map
<span class="nc" id="L1768">				employeesReportingOrgs = getScheduleAccessManager(context, appletResponse, locale).getPhantomsOrganizations(idsToCheck);</span>
			}
<span class="fc" id="L1770">			Iterator&lt;ID&gt; itIDs = idsToCheck.iterator();</span>
<span class="fc bfc" id="L1771" title="All 2 branches covered.">			while (itIDs.hasNext()) {</span>
<span class="fc" id="L1772">				ID nextID = itIDs.next();</span>
<span class="fc" id="L1773">				Object orgs = employeesReportingOrgs.get(nextID);</span>
<span class="fc" id="L1774">				Collection&lt;ID&gt; colOrgIDs = null;</span>
<span class="pc bpc" id="L1775" title="1 of 2 branches missed.">				if (orgs instanceof ID) {</span>
					//phantom
<span class="nc" id="L1777">					colOrgIDs = Collections.singleton((ID)orgs);</span>
				} else {
					//employee
<span class="fc" id="L1780">					colOrgIDs = (Collection&lt;ID&gt;)orgs;</span>
				}
<span class="fc" id="L1782">				boolean hasPermissions = false;</span>
<span class="pc bpc" id="L1783" title="2 of 4 branches missed.">				if (colOrgIDs != null &amp;&amp; !colOrgIDs.isEmpty()) {</span>
<span class="fc" id="L1784">					Iterator&lt;ID&gt; itEmpOrgIDs = colOrgIDs.iterator();</span>
<span class="fc bfc" id="L1785" title="All 2 branches covered.">					while (itEmpOrgIDs.hasNext()) {</span>
<span class="fc" id="L1786">						ID nextOrgID = itEmpOrgIDs.next();</span>
<span class="pc bpc" id="L1787" title="1 of 2 branches missed.">						if (authorizedOrgs.contains(nextOrgID)) {</span>
<span class="fc" id="L1788">							hasPermissions = true;</span>
						}
<span class="fc" id="L1790">					}</span>
				}
<span class="pc bpc" id="L1792" title="1 of 2 branches missed.">				if (!hasPermissions) {</span>
					//if no permission, check if it is pooler
					//check pooler assignment
<span class="nc" id="L1795">					Collection&lt;EmpPoolingRule&gt; rules = getEmpWorkRuleManager(context, appletResponse, locale).getPoolingRuleAssignments(nextID, startDate, endDate);</span>
<span class="nc bnc" id="L1796" title="All 2 branches missed.">					if( rules != null){</span>
<span class="nc bnc" id="L1797" title="All 2 branches missed.">						for (Iterator&lt;EmpPoolingRule&gt; iInner = rules.iterator(); iInner.hasNext();) {</span>
<span class="nc" id="L1798">							Iterator it = iInner.next().getSecondaryOgs().iterator();</span>
<span class="nc bnc" id="L1799" title="All 2 branches missed.">							while (it.hasNext()) {</span>
<span class="nc bnc" id="L1800" title="All 2 branches missed.">								if (authorizedOrgs.contains(it.next())) {</span>
<span class="nc" id="L1801">									hasPermissions = true;</span>
<span class="nc" id="L1802">									break;</span>
								}
							}
<span class="nc" id="L1805">						}</span>
					}
				}
<span class="fc" id="L1808">				empEditables.put(nextID, Boolean.valueOf(hasPermissions));</span>
<span class="fc" id="L1809">			}</span>
		}
<span class="fc" id="L1811">		return empEditables;</span>
	}

	private Collection&lt;ID&gt; getEmpIDsWithoutPermissionToEditEvent(Collection&lt;ID&gt; workResourceIDs, Map&lt;ID, Boolean&gt; mapEmpEditables) {
<span class="fc" id="L1815">		Iterator&lt;ID&gt; itWorkResourceIDs = workResourceIDs.iterator();</span>
<span class="fc" id="L1816">		Collection&lt;ID&gt; empIDsWithoutPermission = new ArrayList&lt;ID&gt;(workResourceIDs.size());</span>
<span class="fc bfc" id="L1817" title="All 2 branches covered.">		while (itWorkResourceIDs.hasNext()) {</span>
<span class="fc" id="L1818">			ID nextWRID = itWorkResourceIDs.next();</span>
<span class="fc" id="L1819">			Boolean empHasPermissions = mapEmpEditables.get(nextWRID);</span>
<span class="pc bpc" id="L1820" title="2 of 4 branches missed.">			if (empHasPermissions == null || !empHasPermissions.booleanValue()) {</span>
<span class="nc" id="L1821">				empIDsWithoutPermission.add(nextWRID);</span>
			}
<span class="fc" id="L1823">		}</span>
<span class="fc" id="L1824">		return empIDsWithoutPermission;</span>
	}

	private void processCustomRequest(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="fc" id="L1828">		String msgID = FsWebBundleKey.FS_CAL_REQHNDLR_UNKNOWN_REQUEST_TYPE;</span>
<span class="fc" id="L1829">		Locale locale = context.getLocaleContext().getLanguageLocale();</span>
<span class="fc" id="L1830">		Object[] params = null;</span>
		try {
<span class="fc bfc" id="L1832" title="All 2 branches covered.">			if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_SHIFT_ASSIGNMENT)) {</span>
<span class="fc" id="L1833">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_SHIFTASSIGNMENT;</span>
<span class="fc" id="L1834">				ShiftAssignment newAssignment = (ShiftAssignment) appletRequest.get(PageKeys.SHIFT_ASSIGNMENT);</span>
<span class="fc" id="L1835">				ID newShiftID = null;</span>
<span class="fc" id="L1836">				Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEvent(appletResponse, locale, newAssignment, newAssignment.getStartTime(), newAssignment.getEndTime(), context);</span>
<span class="fc" id="L1837">				Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(newAssignment.getWorkResourceIDs(), mapEmpEditables);</span>
<span class="pc bpc" id="L1838" title="2 of 4 branches missed.">				if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; !empIDsWithoutPermissionToEditEvent.isEmpty()) {</span>
<span class="nc" id="L1839">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_NO_PERMISSION_EMPLOYEE;</span>
<span class="nc" id="L1840">					handleExpectedError(context, appletResponse, msgID, params);</span>
<span class="nc" id="L1841">					return;</span>
				} else {
					//newAssignment.removeOTBeforeSave(); doesn't work, has defect
<span class="fc" id="L1844">					removeOTEventHolderBeforeSave(newAssignment);</span>
<span class="fc" id="L1845">					newShiftID = getScheduleAccessManager(context, appletResponse, locale).createShiftAssignment(newAssignment);</span>
				}
<span class="fc" id="L1847">				ShiftAssignment newSA = null;</span>
<span class="pc bpc" id="L1848" title="1 of 2 branches missed.">				if (newShiftID != null) {</span>
<span class="fc" id="L1849">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_RETRIEVING_SHIFTASSIGNMENT;</span>
<span class="fc" id="L1850">					newSA = getScheduleAccessManager(context, appletResponse, locale).getShiftAssignmentByID(newShiftID);</span>
<span class="fc" id="L1851">					appletResponse.put(PageKeys.NEW_SHIFT_ASSIGNMENT, newSA);</span>
				}
<span class="fc bfc" id="L1853" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_CALENDAR_EVENT_ASSIGNMENT)) {</span>
<span class="fc" id="L1854">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_CALENDAR_EVENT;</span>
<span class="fc" id="L1855">				CalendarEventAssignment newAssignment = (CalendarEventAssignment) appletRequest.get(PageKeys.CALENDAR_EVENT_ASSIGNMENT);</span>
<span class="fc" id="L1856">				ID newCalendarEventID = null;</span>
<span class="fc" id="L1857">				Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEvent(appletResponse, locale, newAssignment, newAssignment.getStartTime(), newAssignment.getEndTime(), context);</span>
<span class="fc" id="L1858">				Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(newAssignment.getWorkResourceIDs(), mapEmpEditables);</span>
<span class="pc bpc" id="L1859" title="2 of 4 branches missed.">				if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; !empIDsWithoutPermissionToEditEvent.isEmpty()) {</span>
<span class="nc" id="L1860">					params = new Object[] {new Integer(empIDsWithoutPermissionToEditEvent.size())};</span>
<span class="nc" id="L1861">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_NONECHANGED;</span>
<span class="nc" id="L1862">					handleExpectedError(context, appletResponse, msgID, params);</span>
<span class="nc" id="L1863">					return;</span>
				} else {
<span class="fc" id="L1865">					newCalendarEventID = getScheduleAccessManager(context, appletResponse, locale).createCalendarEventAssignment(newAssignment);</span>
				}
<span class="fc" id="L1867">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_RETRIEVING_CALENDAR_EVENT;</span>
<span class="fc" id="L1868">				CalendarEventAssignment newCE = null;</span>
<span class="pc bpc" id="L1869" title="1 of 2 branches missed.">				if (newCalendarEventID != null) {</span>
<span class="fc" id="L1870">					newCE = getScheduleAccessManager(context, appletResponse, locale).getCalendarEventAssignmentByID(newCalendarEventID);</span>
				}
<span class="fc" id="L1872">				appletResponse.put(PageKeys.NEW_CALENDAR_EVENT_ASSIGNMENT, newCE);</span>
<span class="pc bpc" id="L1873" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_CLASS_SESSION)) {</span>
<span class="nc" id="L1874">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_CLASS_SESSION;</span>
<span class="nc" id="L1875">				ID classID = (ID) appletRequest.get(PageKeys.EVENTTEMPLATE_ID);</span>
<span class="nc" id="L1876">				CalendarEvent session = (CalendarEvent)appletRequest.get(PageKeys.CLASS_SESSION_TO_CREATE);</span>
<span class="nc" id="L1877">				ID newSessionID = null;</span>
<span class="nc" id="L1878">				Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEvent(appletResponse, locale, session, session.getStartTime(), session.getEndTime(), context);</span>
<span class="nc" id="L1879">				Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(session.getWorkResourceIDs(), mapEmpEditables);</span>
<span class="nc bnc" id="L1880" title="All 4 branches missed.">				if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; !empIDsWithoutPermissionToEditEvent.isEmpty()) {</span>
<span class="nc" id="L1881">					params = new Object[] {new Integer(empIDsWithoutPermissionToEditEvent.size())};</span>
<span class="nc" id="L1882">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_NONECHANGED;</span>
<span class="nc" id="L1883">					handleExpectedError(context, appletResponse, msgID, params);</span>
<span class="nc" id="L1884">					return;</span>
				} else {
<span class="nc" id="L1886">					newSessionID = getScheduleAccessManager(context, appletResponse, locale).createClassSession(classID, session);</span>
				}
<span class="nc" id="L1888">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_RETRIEVING_CLASS_SESSION;</span>
<span class="nc" id="L1889">				CalendarEventAssignment newSession = null;</span>
<span class="nc bnc" id="L1890" title="All 2 branches missed.">				if (newSessionID != null) {</span>
<span class="nc" id="L1891">					newSession = getScheduleAccessManager(context, appletResponse, locale).getCalendarEventAssignmentByID(newSessionID);</span>
				}
<span class="nc" id="L1893">				appletResponse.put(PageKeys.NEW_CALENDAR_EVENT_ASSIGNMENT, newSession);</span>
<span class="pc bfc" id="L1894" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_GET_CALENDAR_EVENT_TEMPLATE_CONFLICTS)) {</span>
<span class="fc" id="L1895">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_CALENDAREVENT_CONFLICTS;</span>
<span class="fc" id="L1896">				CalendarEventTemplate eventTemplateToCreate = (CalendarEventTemplate) appletRequest.get(PageKeys.CALENDAR_EVENT_TEMPLATE);</span>
<span class="fc" id="L1897">				Collection conflicts = getScheduleAccessManager(context, appletResponse, locale).getConflictsForCalendarEventTemplate(eventTemplateToCreate);</span>
<span class="fc" id="L1898">				appletResponse.put(PageKeys.CALENDAR_EVENT_TEMPLATE_CONFLICTS, conflicts);</span>
<span class="fc bfc" id="L1899" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_CALENDAR_EVENT_TEMPLATE)) {</span>
<span class="fc" id="L1900">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_CALENDAREVENT_TEMPLATE;</span>
<span class="fc" id="L1901">				CalendarEventTemplate eventTemplateToCreate = (CalendarEventTemplate) appletRequest.get(PageKeys.CALENDAR_EVENT_TEMPLATE);</span>
<span class="fc" id="L1902">				Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEventTemplate(appletResponse, locale, eventTemplateToCreate, context);</span>
<span class="fc" id="L1903">				Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(eventTemplateToCreate.getWorkResourceIDs(), mapEmpEditables);</span>
<span class="pc bpc" id="L1904" title="2 of 4 branches missed.">				if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; !empIDsWithoutPermissionToEditEvent.isEmpty()) {</span>
<span class="nc" id="L1905">					params = new Object[] {new Integer(empIDsWithoutPermissionToEditEvent.size())};</span>
<span class="nc" id="L1906">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_NONECHANGED;</span>
<span class="nc" id="L1907">					handleExpectedError(context, appletResponse, msgID, params);</span>
				} else {
<span class="fc" id="L1909">					BbmScheduleConflictResolutions conflictResolutions = (BbmScheduleConflictResolutions) appletRequest.get(PageKeys.CALENDAR_EVENT_TEMPLATE_RESOLUTIONS);</span>
<span class="fc" id="L1910">					ID templateID = getScheduleAccessManager(context, appletResponse, locale).createEventTemplateWithInstances(eventTemplateToCreate, conflictResolutions);</span>
<span class="pc bpc" id="L1911" title="1 of 2 branches missed.">					if (templateID != null) {</span>
<span class="fc" id="L1912">						msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_RETRIEVING_CALENDAREVENT_TEMPLATE;</span>
<span class="fc" id="L1913">						CalendarEventTemplate createdTemplate = getScheduleAccessManager(context, appletResponse, locale).getCalendarEventTemplateByID(templateID);</span>
<span class="fc" id="L1914">						appletResponse.put(PageKeys.NEW_CALENDAR_EVENT_TEMPLATE, createdTemplate);</span>
					}
				}
<span class="fc bfc" id="L1917" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_SAVE_EVENT_CHANGES)) {</span>
<span class="fc" id="L1918">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_EVENTS;</span>
<span class="fc" id="L1919">				ID spID = (ID)appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="pc bpc" id="L1920" title="1 of 2 branches missed.">				if (spID != null){</span>
					//set shift assignment sp id and lock customized shift assignment
<span class="nc" id="L1922">					Collection idShiftToSetSPID = (Collection)appletRequest.get(PageKeys.EVENTS_TO_UPDATE_COLLECTION);</span>
<span class="nc" id="L1923">					Collection idShiftToLock = (Collection)appletRequest.get(PageKeys.LOCKUNLOCK_EVENT_MASK);</span>
<span class="nc" id="L1924">					getScheduleAccessManager(context, appletResponse, locale).setSPIDLockCustomizedShifts(spID, idShiftToSetSPID, idShiftToLock);</span>
<span class="nc" id="L1925">				} else {</span>
					//update events
<span class="fc" id="L1927">					Collection eventsToChange = (Collection) appletRequest.get(PageKeys.EVENTS_TO_UPDATE_COLLECTION);</span>
<span class="fc" id="L1928">					Iterator itEvents = eventsToChange.iterator();</span>
<span class="fc" id="L1929">					boolean someEventChangesSaved = false;</span>
<span class="fc" id="L1930">					Set setEmpsWithNoPermission = new HashSet();</span>
<span class="fc" id="L1931">					List changedEvents = new ArrayList(eventsToChange.size());</span>
<span class="fc bfc" id="L1932" title="All 2 branches covered.">					while (itEvents.hasNext()) {</span>
<span class="fc" id="L1933">						Event nextEventObj = (Event) itEvents.next();</span>
<span class="fc" id="L1934">						Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEvent(appletResponse, locale, nextEventObj, nextEventObj.getStartTime(), nextEventObj.getEndTime(), context);</span>
<span class="fc" id="L1935">						Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(nextEventObj.getWorkResourceIDs(), mapEmpEditables);</span>
<span class="pc bpc" id="L1936" title="2 of 4 branches missed.">						if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; empIDsWithoutPermissionToEditEvent.size() &gt; 0) {</span>
<span class="nc" id="L1937">							setEmpsWithNoPermission.addAll(empIDsWithoutPermissionToEditEvent);</span>
						} else {
<span class="fc bfc" id="L1939" title="All 2 branches covered.">							if (nextEventObj instanceof ShiftAssignment) {</span>
<span class="fc" id="L1940">								msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_SHIFTASSIGNMENT;</span>
<span class="fc" id="L1941">								ShiftAssignment shift = ((ShiftAssignment)nextEventObj);</span>
<span class="fc" id="L1942">								removeOTEventHolderBeforeSave(shift);</span>
<span class="fc" id="L1943">								shift.setUpdateUser(context.getUserName());</span>
<span class="fc" id="L1944">								getScheduleAccessManager(context, appletResponse, locale).updateShiftAssignment(shift);</span>
<span class="fc" id="L1945">								changedEvents.add(getScheduleAccessManager(context, appletResponse, locale).getShiftAssignmentByID(shift.getID()));</span>
<span class="fc" id="L1946">								someEventChangesSaved = true;</span>
<span class="pc bpc" id="L1947" title="1 of 2 branches missed.">							} else if (nextEventObj instanceof CalendarEventAssignment) {</span>
<span class="fc" id="L1948">								msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT;</span>
<span class="fc" id="L1949">								((CalendarEventAssignment) nextEventObj).setUpdateUser(context.getUserName());</span>
<span class="fc" id="L1950">								getScheduleAccessManager(context, appletResponse, locale).updateCalendarEventAssignment((CalendarEventAssignment) nextEventObj);</span>
<span class="fc" id="L1951">								changedEvents.add(getScheduleAccessManager(context, appletResponse, locale).getCalendarEventAssignmentByID(((CalendarEventAssignment) nextEventObj).getID()));</span>
<span class="fc" id="L1952">								someEventChangesSaved = true;</span>
							} else {
<span class="nc" id="L1954">								msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_UNKNOWNTYPE;</span>
<span class="nc" id="L1955">								handleExpectedError(context, appletResponse, msgID, params);</span>
<span class="nc" id="L1956">								return;</span>
							}
						}
<span class="fc" id="L1959">					}</span>
<span class="fc" id="L1960">					addResponseData(changedEvents, appletResponse);</span>
<span class="pc bpc" id="L1961" title="1 of 2 branches missed.">					if (!setEmpsWithNoPermission.isEmpty()) {</span>
<span class="nc" id="L1962">						params = new Object[] {new Integer(setEmpsWithNoPermission.size())};</span>
<span class="nc bnc" id="L1963" title="All 2 branches missed.">						if (someEventChangesSaved) {</span>
<span class="nc" id="L1964">							msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_SOMECHANGED;</span>
						} else {
<span class="nc" id="L1966">							msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_NONECHANGED;</span>
						}
<span class="nc" id="L1968">						handleExpectedError(context, appletResponse, msgID, params);</span>
<span class="nc" id="L1969">						return;</span>
					}
				}
<span class="pc bpc" id="L1972" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_RECURRING_EVENT_EXCEPTION)) {</span>
<span class="nc" id="L1973">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_EVENT_EXCEPTION;</span>
<span class="nc" id="L1974">				CalendarEventAssignment event = (CalendarEventAssignment)appletRequest.get(PageKeys.EVENT_TO_CREATE);</span>
<span class="nc" id="L1975">				CalendarEventAssignment recurringEventException = getScheduleAccessManager(context, appletResponse, locale).createRecurringEventException(</span>
<span class="nc" id="L1976">                        event.getEventTemplateID(), </span>
<span class="nc" id="L1977">                        event.getWorkResourceIDs(), </span>
<span class="nc" id="L1978">                        event.getStartTime());</span>
<span class="nc" id="L1979">				appletResponse.put(PageKeys.EVENT_TO_CREATE, recurringEventException);</span>
<span class="pc bpc" id="L1980" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_EVENT_EXCEPTION)) {</span>
<span class="nc" id="L1981">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_EVENT_EXCEPTION;</span>
<span class="nc" id="L1982">				EventTemplateExceptionCreateData exceptionCreateData = (EventTemplateExceptionCreateData) appletRequest.get(PageKeys.EVENT_TEMPLATE_EXCEPTION_CREATE_DATA);</span>
				//				conflictResolutionsForUpdate
<span class="nc" id="L1984">				CalendarEventTemplate template = exceptionCreateData.getTemplate();</span>
<span class="nc" id="L1985">				short templateType = template.getTemplateType();</span>
<span class="nc" id="L1986">				Date origStartDate = exceptionCreateData.getOrigStartDate();</span>
<span class="nc" id="L1987">				Date newStartDate = exceptionCreateData.getNewStartDate();</span>
<span class="nc" id="L1988">				int newDuration = exceptionCreateData.getNewDuration();</span>
<span class="nc" id="L1989">				boolean newLocked = exceptionCreateData.getNewLocked();</span>
<span class="nc" id="L1990">				Collection workResourceIDs = exceptionCreateData.getNewWorkResourceIDs();</span>
<span class="nc" id="L1991">				ID exceptionID = null;</span>
<span class="nc bnc" id="L1992" title="All 2 branches missed.">				if (templateType == CalendarEventTemplate.EVENT_TEMPLATE_RECURRING) {</span>
<span class="nc" id="L1993">					System.out.println(&quot;%%%%%  In CalendarAppletRequestHandler: template workresources count = &quot; + workResourceIDs.size());</span>
<span class="nc" id="L1994">					exceptionID = getScheduleAccessManager(context, appletResponse, locale).createRecurringEventExceptionAndUpdateCalendarEventAssignment(</span>
<span class="nc" id="L1995">							template.getID(), workResourceIDs, origStartDate,</span>
<span class="nc" id="L1996">							context.getUserName(), exceptionCreateData.getNewWorkResourceIDs(),</span>
<span class="nc" id="L1997">							exceptionCreateData.getExceptionEvent().getRemovedWorkResourceIDs(),</span>
<span class="nc" id="L1998">							exceptionCreateData.getTemplate().getWorkResourceIDs(), newStartDate,</span>
<span class="nc" id="L1999">							newDuration, newLocked, exceptionCreateData.getExceptionEvent());</span>
				}
<span class="nc bnc" id="L2001" title="All 2 branches missed.">				if (templateType == CalendarEventTemplate.EVENT_TEMPLATE_RECURRING_FLOATING) {</span>
<span class="nc" id="L2002">					Date floatingStart = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L2003">					Date floatingEnd = (Date) appletRequest.get(PageKeys.END_DATE);</span>
					//workResourceIDs = newFloat.getWorkResourceIDs();
<span class="nc" id="L2005">					workResourceIDs = exceptionCreateData.getTemplate().getWorkResourceIDs();</span>
<span class="nc" id="L2006">					FloatingEventTemplate floatTemplate = getScheduleAccessManager(context, appletResponse, locale).createRecurringFloatingEventException(template.getID(), workResourceIDs, newStartDate, newDuration, floatingStart, floatingEnd, exceptionCreateData.getNewLocked());</span>
<span class="nc bnc" id="L2007" title="All 2 branches missed.">					if (!exceptionCreateData.isCreateExceptionByLock()) { //if locking creates exception, then no attributes change, don't need to update the exception here.</span>
<span class="nc" id="L2008">						FloatingEventTemplate newFloat = (FloatingEventTemplate)exceptionCreateData.getExceptionTemplate();</span>
<span class="nc" id="L2009">						floatTemplate.setInstanceStart(newStartDate);</span>
<span class="nc" id="L2010">						floatTemplate.setActivityID(newFloat.getActivityID());</span>
<span class="nc" id="L2011">						floatTemplate.setDescription(newFloat.getDescription());</span>
<span class="nc" id="L2012">						Collection dayMap = newFloat.getDayMap();</span>
						/*					Pair pair = null;
						int ix = 1;
						for (Iterator i = dayMap.iterator(); i.hasNext(); ix++) {
							pair = (Pair)i.next();
							if (pair != null) {
								floatTemplate.setWindowDayStartOffset(ix, ((Integer)pair.getFirst()).intValue());
								floatTemplate.setWindowDayEndOffset(ix, ((Integer)pair.getSecond()).intValue());
							}
						} */
<span class="nc" id="L2022">						Collection newWorkResourceIDs = exceptionCreateData.getNewWorkResourceIDs();</span>
<span class="nc" id="L2023">						Iterator itOldWRIDs = exceptionCreateData.getTemplate().getWorkResourceIDs().iterator();</span>
<span class="nc bnc" id="L2024" title="All 2 branches missed.">						while (itOldWRIDs.hasNext()) {</span>
<span class="nc" id="L2025">							ID nextID = (ID) itOldWRIDs.next();</span>
<span class="nc bnc" id="L2026" title="All 2 branches missed.">							if (!newWorkResourceIDs.contains(nextID)) {</span>
<span class="nc" id="L2027">								floatTemplate.removeWorkResourceID(nextID);</span>
							}
<span class="nc" id="L2029">						}</span>
<span class="nc" id="L2030">						Iterator itNewWRIDs = newWorkResourceIDs.iterator();</span>
<span class="nc bnc" id="L2031" title="All 2 branches missed.">						while (itNewWRIDs.hasNext()) {</span>
<span class="nc" id="L2032">							ID nextID = (ID) itNewWRIDs.next();</span>
<span class="nc bnc" id="L2033" title="All 2 branches missed.">							if (!floatTemplate.getWorkResourceIDs().contains(nextID)) {</span>
<span class="nc" id="L2034">								floatTemplate.addWorkResourceID(nextID);</span>
							}
<span class="nc" id="L2036">						}</span>

<span class="nc bnc" id="L2038" title="All 2 branches missed.">						for (int ix=1;ix&lt;=7; ix++) {				</span>
<span class="nc" id="L2039">							floatTemplate.setWindowDayStartOffset(ix, newFloat.getWindowDayStartOffset(ix));</span>
<span class="nc" id="L2040">							floatTemplate.setWindowDayEndOffset(ix, newFloat.getWindowDayEndOffset(ix));</span>
						}

<span class="nc" id="L2043">						BbmScheduleConflictResolutions conflictResolutions = new BbmScheduleConflictResolutions();</span>
<span class="nc" id="L2044">						floatTemplate.setUpdateUser(context.getUserName());</span>
<span class="nc" id="L2045">						getScheduleAccessManager(context, appletResponse, locale).updateEventTemplateWithInstances(floatTemplate, conflictResolutions);</span>
					}
<span class="nc" id="L2047">					exceptionID = floatTemplate.getID();</span>
				}
<span class="nc" id="L2049">				appletResponse.put(PageKeys.NEW_EXCEPTION_ID, exceptionID);</span>
<span class="pc bpc" id="L2050" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_DELETE_TEMPLATE_EXCEPTION)) {</span>
<span class="nc" id="L2051">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_DELETING_CALENDAREVENT;</span>
<span class="nc" id="L2052">				CalendarEventTemplate template = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE);</span>
<span class="nc" id="L2053">				Date dateToDelete = (Date) appletRequest.get(PageKeys.EVENT_TEMPLATE_DATE_TO_DELETE);</span>
<span class="nc" id="L2054">				getScheduleAccessManager(context, appletResponse, locale).deleteRecurringEventInstance(template.getID(), template.getWorkResourceIDs(), dateToDelete);</span>
<span class="pc bpc" id="L2055" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UPDATE_EVENT_EXTENSIVE)) {</span>
<span class="nc" id="L2056">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT;</span>
				// delete the old event
<span class="nc" id="L2058">				CalendarEventAssignment eventToDelete = (CalendarEventAssignment) appletRequest.get(PageKeys.EVENT_TO_DELETE);</span>
<span class="nc" id="L2059">				ArrayList listOneEventID = new ArrayList(1);</span>
<span class="nc" id="L2060">				listOneEventID.add(eventToDelete.getID());</span>
<span class="nc" id="L2061">				getScheduleAccessManager(context, appletResponse, locale).deleteCalendarEventAssignments(listOneEventID);</span>
				// create the new event
<span class="nc" id="L2063">				CalendarEventAssignment eventToCreate = (CalendarEventAssignment) appletRequest.get(PageKeys.EVENT_TO_CREATE);</span>
<span class="nc" id="L2064">				ID eventID = getScheduleAccessManager(context, appletResponse, locale).createCalendarEventAssignment(eventToCreate);</span>
<span class="nc" id="L2065">				CalendarEventAssignment newlyCreated = getScheduleAccessManager(context, appletResponse, locale).getCalendarEventAssignmentByID(eventID);</span>
<span class="nc" id="L2066">				appletResponse.put(PageKeys.NEW_CALENDAR_EVENT_ASSIGNMENT, newlyCreated);</span>
<span class="pc bpc" id="L2067" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UPDATE_EVENT_TEMPLATE)) {</span>
<span class="nc" id="L2068">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT_TEMPLATE;</span>
<span class="nc" id="L2069">				CalendarEventTemplate templateToUpdate = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_UPDATE);</span>
<span class="nc" id="L2070">				BbmScheduleConflictResolutions conflictResolutionsForUpdate = (BbmScheduleConflictResolutions) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_UPDATE_RESOLUTIONS);</span>
<span class="nc" id="L2071">				getScheduleAccessManager(context, appletResponse, locale).updateEventTemplateWithInstances(templateToUpdate, conflictResolutionsForUpdate);</span>
<span class="pc bpc" id="L2072" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UPDATE_EVENT_TEMPLATE_EXTENSIVE)) {</span>
<span class="nc" id="L2073">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT_TEMPLATE;</span>
				// first delete template
<span class="nc" id="L2075">				CalendarEventTemplate templateToDelete = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_DELETE);</span>
<span class="nc" id="L2076">				getScheduleAccessManager(context, appletResponse, locale).deleteEventTemplateWithInstances(templateToDelete.getID());</span>
				// then create the new template
<span class="nc" id="L2078">				CalendarEventTemplate templateToCreate = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_CREATE);</span>
<span class="nc" id="L2079">				BbmScheduleConflictResolutions conflictResolutionsForCreate = (BbmScheduleConflictResolutions) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_CREATE_RESOLUTIONS);</span>
<span class="nc" id="L2080">				ID templateID = getScheduleAccessManager(context, appletResponse, locale).createEventTemplateWithInstances(templateToCreate, conflictResolutionsForCreate);</span>
<span class="nc bnc" id="L2081" title="All 2 branches missed.">				if (templateID != null) {</span>
<span class="nc" id="L2082">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_RETRIEVING_CALENDAREVENT_TEMPLATE;</span>
<span class="nc" id="L2083">					CalendarEventTemplate createdTemplate = getScheduleAccessManager(context, appletResponse, locale).getCalendarEventTemplateByID(templateID);</span>
<span class="nc" id="L2084">					appletResponse.put(PageKeys.NEW_CALENDAR_EVENT_TEMPLATE, createdTemplate);</span>
				}
<span class="pc bpc" id="L2086" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CHANGE_EVENT_TEMPLATE_TO_EVENT)) {</span>
<span class="nc" id="L2087">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT;</span>
				// delete the event template
<span class="nc" id="L2089">				CalendarEventTemplate templateToDelete = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_DELETE);</span>
<span class="nc" id="L2090">				getScheduleAccessManager(context, appletResponse, locale).deleteEventTemplateWithInstances(templateToDelete.getID());</span>
				// create the new event
<span class="nc" id="L2092">				CalendarEventAssignment eventToCreate = (CalendarEventAssignment) appletRequest.get(PageKeys.EVENT_TO_CREATE);</span>
<span class="nc bnc" id="L2093" title="All 2 branches missed.">				if (eventToCreate != null) {</span>
<span class="nc" id="L2094">					getScheduleAccessManager(context, appletResponse, locale).createCalendarEventAssignment(eventToCreate);</span>
				}
<span class="pc bpc" id="L2096" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CHANGE_EVENT_TO_EVENT_TEMPLATE)) {</span>
<span class="nc" id="L2097">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT;</span>
				// delete the event
<span class="nc" id="L2099">				CalendarEventAssignment eventToDelete = (CalendarEventAssignment) appletRequest.get(PageKeys.EVENT_TO_DELETE);</span>
<span class="nc" id="L2100">				getScheduleAccessManager(context, appletResponse, locale).deleteCalendarEventAssignments(Collections.singletonList(eventToDelete.getID()));</span>
				// create the new event template
<span class="nc" id="L2102">				CalendarEventTemplate templateToCreate = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_CREATE);</span>
<span class="nc" id="L2103">				BbmScheduleConflictResolutions conflictResolutionsForCreate = (BbmScheduleConflictResolutions) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_CREATE_RESOLUTIONS);</span>
<span class="nc" id="L2104">				getScheduleAccessManager(context, appletResponse, locale).createEventTemplateWithInstances(templateToCreate, conflictResolutionsForCreate);</span>
<span class="pc bpc" id="L2105" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_SPLIT_EVENT_TEMPLATE)) {</span>
<span class="nc" id="L2106">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT_TEMPLATE;</span>
<span class="nc" id="L2107">				CalendarEventTemplate templateToUpdate = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_UPDATE);</span>
<span class="nc" id="L2108">				BbmScheduleConflictResolutions conflictResolutionsForUpdate = (BbmScheduleConflictResolutions) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_UPDATE_RESOLUTIONS);</span>
				
				//the split template happens when &quot;From this point on&quot; is chosen when editing the template. one template is created and old template is shortened.
				//First we'll shorten the old template...
<span class="nc" id="L2112">				getScheduleAccessManager(context, appletResponse, locale).updateEventTemplateWithInstances(templateToUpdate, conflictResolutionsForUpdate);</span>
				
<span class="nc" id="L2114">				CalendarEventTemplate templateToCreate = (CalendarEventTemplate) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_CREATE);</span>
<span class="nc" id="L2115">				BbmScheduleConflictResolutions conflictResolutionsForCreate = (BbmScheduleConflictResolutions) appletRequest.get(PageKeys.EVENT_TEMPLATE_TO_CREATE_RESOLUTIONS);</span>
				//Then we'll create the new template...
<span class="nc" id="L2117">				ID templateID = getScheduleAccessManager(context, appletResponse, locale).createEventTemplateWithInstances(templateToCreate, conflictResolutionsForCreate);</span>
				
<span class="nc bnc" id="L2119" title="All 2 branches missed.">				if (templateID != null) {</span>
<span class="nc" id="L2120">					CalendarEventTemplate createdTemplate = getScheduleAccessManager(context, appletResponse, locale).getCalendarEventTemplateByID(templateID);</span>
<span class="nc" id="L2121">					appletResponse.put(PageKeys.NEW_CALENDAR_EVENT_TEMPLATE, createdTemplate);</span>
				}
<span class="pc bfc" id="L2123" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UPDATE_AND_DELETE_EVENTS)) {</span>
				// sort the events to delete into a collection of shift assignments and a collection of calendar event assignments
<span class="fc" id="L2125">				boolean someEventChangesSaved = false;</span>
<span class="fc" id="L2126">				Set&lt;ID&gt; setEmpsWithNoPermission = new HashSet&lt;ID&gt;();</span>
<span class="fc" id="L2127">				Collection&lt;Event&gt; eventsToDelete = (Collection&lt;Event&gt;) appletRequest.get(PageKeys.EVENTS_TO_DELETE_COLLECTION);</span>
<span class="fc" id="L2128">				Iterator&lt;Event&gt; itEventsToDelete = eventsToDelete.iterator();</span>
<span class="fc" id="L2129">				List&lt;ID&gt; arrayShiftIDsToDelete = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L2130">				List&lt;ID&gt; arrayCalendarEventIDsToDelete = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L2131" title="All 2 branches covered.">				while (itEventsToDelete.hasNext()) {</span>
<span class="fc" id="L2132">					Event nextEventToDelete = itEventsToDelete.next();</span>
<span class="fc" id="L2133">					Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEvent(appletResponse, locale, nextEventToDelete, nextEventToDelete.getStartTime(), nextEventToDelete.getEndTime(), context);</span>
<span class="fc" id="L2134">					Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(nextEventToDelete.getWorkResourceIDs(), mapEmpEditables);</span>
<span class="pc bpc" id="L2135" title="2 of 4 branches missed.">					if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; empIDsWithoutPermissionToEditEvent.size() &gt; 0) {</span>
<span class="nc" id="L2136">						setEmpsWithNoPermission.addAll(empIDsWithoutPermissionToEditEvent);</span>
					} else {
<span class="fc bfc" id="L2138" title="All 2 branches covered.">						if (nextEventToDelete instanceof ShiftAssignment) {</span>
<span class="fc" id="L2139">							arrayShiftIDsToDelete.add(nextEventToDelete.getID());</span>
<span class="pc bpc" id="L2140" title="1 of 2 branches missed.">						} else if (nextEventToDelete instanceof CalendarEventAssignment) {</span>
<span class="fc" id="L2141">							arrayCalendarEventIDsToDelete.add(nextEventToDelete.getID());</span>
						} else {
							// TYLER - we need to log and/or throw an exception here
<span class="nc" id="L2144">							msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_DELETING_UNKNOWNTYPE;</span>
<span class="nc" id="L2145">							appletResponse.put(PageKeys.APPLET_ERROR, &quot;Delete request made for unsupported event type &quot; + nextEventToDelete.getClass() + &quot;.&quot;);</span>
<span class="nc" id="L2146">							return;</span>
						}
					}
<span class="fc" id="L2149">				}</span>
				// delete the shift assignments and calendar events
<span class="fc bfc" id="L2151" title="All 2 branches covered.">				if (arrayShiftIDsToDelete.size() &gt; 0) {</span>
<span class="fc" id="L2152">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_DELETING_SHIFTASSIGNMENT;</span>
					//					  msgBackend = &quot;Exception caught deleting shift assignments.&quot;;
					//					  msgToUser = &quot;Shift assignments could not be deleted.&quot;;
<span class="fc" id="L2155">					getScheduleAccessManager(context, appletResponse, locale).deleteShiftAssignments(arrayShiftIDsToDelete);</span>
<span class="fc" id="L2156">					someEventChangesSaved = true;</span>
				}
<span class="fc bfc" id="L2158" title="All 2 branches covered.">				if (arrayCalendarEventIDsToDelete.size() &gt; 0) {</span>
<span class="fc" id="L2159">					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_DELETING_CALENDAREVENT;</span>
					//					  msgBackend = &quot;Exception caught deleting calendar event assignments.&quot;;
					//					  msgToUser = &quot;Calendar event assignments could not be deleted.&quot;;
<span class="fc" id="L2162">					getScheduleAccessManager(context, appletResponse, locale).deleteCalendarEventAssignments(arrayCalendarEventIDsToDelete);</span>
<span class="fc" id="L2163">					someEventChangesSaved = true;</span>
				}

<span class="fc" id="L2166">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_EVENTS;</span>
<span class="fc" id="L2167">				Collection&lt;Event&gt; eventsToChange = (Collection&lt;Event&gt;) appletRequest.get(PageKeys.EVENTS_TO_UPDATE_COLLECTION);</span>
<span class="pc bpc" id="L2168" title="1 of 2 branches missed.">				if(eventsToChange != null) {</span>
<span class="fc" id="L2169">					Iterator&lt;Event&gt; itEventsToUpdate = eventsToChange.iterator();</span>
<span class="fc" id="L2170">					List&lt;Event&gt; changedEvents = new ArrayList&lt;Event&gt;(eventsToChange.size());</span>
<span class="pc bpc" id="L2171" title="1 of 2 branches missed.">					while (itEventsToUpdate.hasNext()) {</span>
<span class="nc" id="L2172">						Event nextEventObj = itEventsToUpdate.next();</span>
<span class="nc" id="L2173">						Map&lt;ID, Boolean&gt; mapEmpEditables = getEmpEditablesForEvent(appletResponse, locale, nextEventObj, nextEventObj.getStartTime(), nextEventObj.getEndTime(), context);</span>
<span class="nc" id="L2174">						Collection&lt;ID&gt; empIDsWithoutPermissionToEditEvent = getEmpIDsWithoutPermissionToEditEvent(nextEventObj.getWorkResourceIDs(), mapEmpEditables);</span>
<span class="nc bnc" id="L2175" title="All 4 branches missed.">						if (empIDsWithoutPermissionToEditEvent != null &amp;&amp; empIDsWithoutPermissionToEditEvent.size() &gt; 0) {</span>
<span class="nc" id="L2176">							setEmpsWithNoPermission.addAll(empIDsWithoutPermissionToEditEvent);</span>
						} else {
<span class="nc bnc" id="L2178" title="All 2 branches missed.">							if (nextEventObj instanceof ShiftAssignment) {</span>
<span class="nc" id="L2179">								msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_SHIFTASSIGNMENT;</span>
								//							  msgBackend = &quot;Exception caught updating shift assignment.&quot;;
								//							  msgToUser = &quot;Shift assignment could not be updated.&quot;;
<span class="nc" id="L2182">								ShiftAssignment shift = ((ShiftAssignment)nextEventObj);</span>
								//shift.removeOTBeforeSave();doesn't work, has defect
<span class="nc" id="L2184">								removeOTEventHolderBeforeSave(shift);</span>
<span class="nc" id="L2185">								shift.setUpdateUser(context.getUserName());</span>
<span class="nc" id="L2186">								getScheduleAccessManager(context, appletResponse, locale).updateShiftAssignment(shift);</span>
<span class="nc" id="L2187">								changedEvents.add(getScheduleAccessManager(context, appletResponse, locale).getShiftAssignmentByID(shift.getID()));</span>
<span class="nc" id="L2188">								someEventChangesSaved = true;</span>
<span class="nc bnc" id="L2189" title="All 2 branches missed.">							} else if (nextEventObj instanceof CalendarEventAssignment) {</span>
<span class="nc" id="L2190">								msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_CALENDAREVENT;</span>
								//							  msgBackend = &quot;Exception caught updating calendar event assignment.&quot;;
								//							  msgToUser = &quot;Calendar event assignment could not be updated.&quot;;
<span class="nc" id="L2193">								((CalendarEventAssignment) nextEventObj).setUpdateUser(context.getUserName());</span>
<span class="nc" id="L2194">								getScheduleAccessManager(context, appletResponse, locale).updateCalendarEventAssignment((CalendarEventAssignment) nextEventObj);</span>
<span class="nc" id="L2195">								changedEvents.add(getScheduleAccessManager(context, appletResponse, locale).getCalendarEventAssignmentByID(((CalendarEventAssignment) nextEventObj).getID()));</span>
<span class="nc" id="L2196">								someEventChangesSaved = true;</span>
							} else {
								// TYLER - we need to log and/or throw an exception here
<span class="nc" id="L2199">								msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_UNKNOWNTYPE;</span>
<span class="nc" id="L2200">								handleExpectedError(context, appletResponse, msgID, params);</span>
<span class="nc" id="L2201">								return;</span>
							}
						}
<span class="nc" id="L2204">					}</span>
<span class="fc" id="L2205">					addResponseData(changedEvents, appletResponse);</span>
				}				
				// if there were events that could not be updated because of permissions, let the user know
<span class="pc bpc" id="L2208" title="1 of 2 branches missed.">				if (!setEmpsWithNoPermission.isEmpty()) {</span>
<span class="nc" id="L2209">					params = new Object[] {new Integer(setEmpsWithNoPermission.size())};</span>
<span class="nc bnc" id="L2210" title="All 2 branches missed.">					if (someEventChangesSaved) {</span>
<span class="nc" id="L2211">						msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_SOMECHANGED;</span>
					} else {
<span class="nc" id="L2213">						msgID = FsWebBundleKey.FS_CAL_REQHNDLR_NOPERMISSIONS_MULTIEMP_NONECHANGED;</span>
					}
<span class="nc" id="L2215">					handleExpectedError(context, appletResponse, msgID, params);</span>
				}
<span class="fc bfc" id="L2217" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_SAVE_SCHEDULINGPARAMS)) {</span>
<span class="fc" id="L2218">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_SAVING_SCHEDULINGPARAMS;</span>
<span class="fc" id="L2219">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L2220">				Map parameters = (Map) appletRequest.get(PageKeys.SP_SCHEDULINGPARAMS);</span>
<span class="fc" id="L2221">				String empIDs = (String) appletRequest.get(PageKeys.SP_SCHEDULINGPARAMS_EMPIDSTRING);</span>
<span class="pc bpc" id="L2222" title="1 of 2 branches missed.">				if (empIDs == null) {</span>
<span class="nc" id="L2223">					empIDs = &quot;&quot;;</span>
				}
<span class="fc" id="L2225">				getCampaignManager(context, appletResponse, locale).setSchedulingParameters(spID, parameters, empIDs);</span>
<span class="pc bpc" id="L2226" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_START_RECALC)) {</span>
<span class="nc" id="L2227">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REQUESTING_RECALC;</span>
<span class="nc" id="L2228">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L2229">				Boolean isEnableLQF = (Boolean)appletRequest.get(FsKeys.IS_ENABLE_LQF);</span>
<span class="nc" id="L2230">				Boolean isRecalcSubCampaign = (Boolean)appletRequest.get(FsKeys.IS_RECALC_SUB_CAMPAIGNS);</span>
				
				// recalcscheduling error code : 1 - success, 2 - adapter error , 4 - no adapter configured
<span class="nc" id="L2233">				int errorCode = getFacadeCorbaFacadeManager(appletResponse, locale).recalcScheduling(</span>
<span class="nc" id="L2234">						UserCacheManager.getInstance().getCachedUserName(context),</span>
<span class="nc" id="L2235">						getUserManager(context, appletResponse, locale).generateToken(UserCacheManager.getInstance().getCachedUserSeal(context)),</span>
<span class="nc" id="L2236">						context.isInWhatIfMode(),</span>
<span class="nc" id="L2237">						1, spID, isEnableLQF, isRecalcSubCampaign,null);</span>
<span class="nc" id="L2238">				appletResponse.put(PageKeys.CALENDAR_APPLET_GET_RECALC_SCHEDULING_ERROR_CODE, new Integer(errorCode));</span>
				//addResponseData(errorCode, appletResponse);
<span class="pc bfc" id="L2240" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_START_SCHEDULE)) {</span>
<span class="fc" id="L2241">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CLEARING_SCHEDULES;</span>
<span class="fc" id="L2242">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L2243">				Boolean isEnableLQF = (Boolean)appletRequest.get(FsKeys.IS_ENABLE_LQF);</span>
<span class="fc" id="L2244">				String modeChar = (String)appletRequest.get(FsKeys.MODE_CHAR);</span>
<span class="fc" id="L2245">				String[] deiParams = (String[])appletRequest.get(FsKeys.SCHEDULE_DEI_PARAMS);</span>
				// recalcscheduling error code : 1 - success, 2 - adapter error , 4 - no adapter configured
<span class="fc" id="L2247">				int errorCode = 1; </span>
<span class="pc bpc" id="L2248" title="1 of 2 branches missed.">				if (modeChar.equals(&quot;S&quot;)) //scheduling</span>
<span class="fc" id="L2249">					errorCode = getFacadeCorbaFacadeManager(appletResponse, locale).recalcScheduling(</span>
<span class="fc" id="L2250">							UserCacheManager.getInstance().getCachedUserName(context),</span>
<span class="fc" id="L2251">							getUserManager(context, appletResponse, locale).generateToken(UserCacheManager.getInstance().getCachedUserSeal(context)),</span>
<span class="fc" id="L2252">							context.isInWhatIfMode(),</span>
<span class="fc" id="L2253">							2, spID, isEnableLQF, false,deiParams);</span>
				else //analyzing
<span class="nc" id="L2255">					errorCode = getFacadeCorbaFacadeManager(appletResponse, locale).recalcScheduling(</span>
<span class="nc" id="L2256">							UserCacheManager.getInstance().getCachedUserName(context),</span>
<span class="nc" id="L2257">							getUserManager(context, appletResponse, locale).generateToken(UserCacheManager.getInstance().getCachedUserSeal(context)),</span>
<span class="nc" id="L2258">							context.isInWhatIfMode(),</span>
<span class="nc" id="L2259">							3, spID, isEnableLQF, false, deiParams);</span>
<span class="fc" id="L2260">				appletResponse.put(PageKeys.CALENDAR_APPLET_GET_RECALC_SCHEDULING_ERROR_CODE, new Integer(errorCode));</span>
				//addResponseData(errorCode, appletResponse);
<span class="fc bfc" id="L2262" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, FsKeys.ACTION_PUBLISH_COMPLETE)) {</span>
<span class="fc" id="L2263">				Collection workResourceIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L2264">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L2265">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L2266">				getScheduleAccessManager(context, appletResponse, locale).notifyPublishComplete(workResourceIDs, startDate, endDate, true);</span>
<span class="fc bfc" id="L2267" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_PUBLISH)) {</span>
<span class="fc" id="L2268">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_PUBLISHING_SCHEDULES;</span>
<span class="fc" id="L2269">				String publishingErrorMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_PUBLISHING_CHUNK;</span>
<span class="fc" id="L2270">				String someFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_PUBLISHING_SOME;</span>
<span class="fc" id="L2271">				String allFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_PUBLISHING_ALL;</span>
<span class="fc" id="L2272">				doPublish(context, locale, appletRequest, appletResponse, PUBLISH, publishingErrorMsgID, allFailedMsgID, someFailedMsgID);</span>
<span class="fc bfc" id="L2273" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UNPUBLISH)) {</span>
<span class="fc" id="L2274">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_SCHEDULES;</span>
<span class="fc" id="L2275">				String unpublishingErrorMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_CHUNK;</span>
<span class="fc" id="L2276">				String someFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_SOME;</span>
<span class="fc" id="L2277">				String allFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_ALL;</span>
<span class="fc" id="L2278">				doPublish(context, locale, appletRequest, appletResponse, UNPUBLISH, unpublishingErrorMsgID, allFailedMsgID, someFailedMsgID);</span>
<span class="fc bfc" id="L2279" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_REVERTTOPUBLISHED)) {</span>
<span class="fc" id="L2280">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_SCHEDULES;</span>
<span class="fc" id="L2281">				String revertToPublishErrorMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REVERTTOPUBLISHED_CHUNK;</span>
<span class="fc" id="L2282">				String someFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REVERTTOPUBLISHED_SOME;</span>
<span class="fc" id="L2283">				String allFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REVERTTOPUBLISHED_ALL;</span>
<span class="fc" id="L2284">				doPublish(context, locale, appletRequest, appletResponse, REVERT_TO_PUBLISHED, revertToPublishErrorMsgID, allFailedMsgID, someFailedMsgID);</span>
<span class="pc bpc" id="L2285" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_WORKPATTERNSET)) {</span>
				/*
				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_WORKPATTERNSET;
				String name = (String) appletRequest.get(PageKeys.WP_NAME);
				String description = (String) appletRequest.get(PageKeys.WP_DESCRIPTION);
				Collection employees = (Collection) appletRequest.get(PageKeys.WP_EMPLOYEES);
				LocalDate startDateLocal = (LocalDate) appletRequest.get(PageKeys.WP_LOCAL_STARTDATE);
				LocalDate endDateLocal = (LocalDate) appletRequest.get(PageKeys.WP_LOCAL_ENDDATE);
				boolean keepShiftWindows = ((Boolean) appletRequest.get(PageKeys.WP_KEEP_SHIFT_WINDOWS)).booleanValue();
				boolean keepShiftActivityWindows = ((Boolean) appletRequest.get(PageKeys.WP_KEEP_SHIFTACTIVITY_WINDOWS)).booleanValue();
				Locale locale = (Locale) appletRequest.get(PageKeys.WP_LOCALE);
				ID wpID = null;
				try {
					wpID = getShiftManager().createWPSet(name, description, employees, startDateLocal, endDateLocal, keepShiftWindows, keepShiftActivityWindows, locale);
				} catch (BbmCreateDuplicateKeyException e) {
					// duplicate name - just warn user
					msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_WORKPATTERNSET_DUPLICATE_NAME;
					log.l7dDebug(msgID, e);
					appletResponse.put(PageKeys.APPLET_ERROR, getFsBundle().getString(msgID));
					return;
				}
				appletResponse.put(PageKeys.WP_ID, wpID);*/
<span class="pc bpc" id="L2307" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UPDATE_WORKPATTERNSET)) {</span>
				/*msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UPDATING_WORKPATTERNSET;
				ID wpID = (ID) appletRequest.get(PageKeys.WP_ID);
				Collection employees = (Collection) appletRequest.get(PageKeys.WP_EMPLOYEES);
				LocalDate startDateLocal = (LocalDate) appletRequest.get(PageKeys.WP_LOCAL_STARTDATE);
				LocalDate endDateLocal = (LocalDate) appletRequest.get(PageKeys.WP_LOCAL_ENDDATE);
				boolean keepShiftWindows = ((Boolean) appletRequest.get(PageKeys.WP_KEEP_SHIFT_WINDOWS)).booleanValue();
				boolean keepShiftActivityWindows = ((Boolean) appletRequest.get(PageKeys.WP_KEEP_SHIFTACTIVITY_WINDOWS)).booleanValue();
				Locale locale = (Locale) appletRequest.get(PageKeys.WP_LOCALE);
				getShiftManager(appletResponse, locale).updateWPSet(wpID, employees, startDateLocal, endDateLocal, keepShiftWindows, keepShiftActivityWindows, locale);
				 */
<span class="pc bpc" id="L2318" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CLEAR_SCHEDULES)) {</span>
<span class="nc" id="L2319">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CLEARING_SCHEDULES;</span>
<span class="nc" id="L2320">				Collection&lt;ID&gt; employees = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L2321">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L2322">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L2323">				Collection&lt;ID&gt; spIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc bnc" id="L2324" title="All 2 branches missed.">				for( ID spID: spIDs)</span>
<span class="nc" id="L2325">					getScheduleAccessManager(context, appletResponse, locale).deleteShiftAssignments(employees, startDate, endDate, spID, false); //..., ID spID, boolean unlockedOnly, boolean byStartTime</span>
<span class="pc bpc" id="L2326" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_REMOVE_PROFILE_SCHEDULES)) {</span>
<span class="nc" id="L2327">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CLEARING_SCHEDULES;</span>
<span class="nc" id="L2328">				Collection&lt;ID&gt; phantomIDs = (Collection&lt;ID&gt;) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L2329">				getScheduleAccessManager(context, appletResponse, locale).deletePhantoms(phantomIDs);</span>
<span class="pc bpc" id="L2330" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_IMPORT_PROFILES)) {</span>
<span class="nc" id="L2331">				msgID = FsWebBundleKey.FS_CAL_IMPORT_OUTSOURCER;</span>
<span class="nc" id="L2332">				ID orgID = (ID) appletRequest.get(PageKeys.ORG_ID);</span>
<span class="nc" id="L2333">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L2334">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L2335">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L2336">				int ret = getFacadeCorbaFacadeManager(appletResponse, locale).importOutsourcerStaffingProfiles(orgID, campaignID, startDate, endDate);</span>

				//Boolean bb = Boolean.valueOf(bImport);
				//appletResponse.put(PageKeys.ORGFORIMPORT, bb);
<span class="nc" id="L2340">				Integer intRet = new Integer(ret);</span>
<span class="nc" id="L2341">				appletResponse.put(PageKeys.GET_IMPORT_RESULT, intRet);</span>
<span class="pc bfc" id="L2342" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_LOCK_MULTIPLE)) {</span>
<span class="fc" id="L2343">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_LOCKING_EVENTS;</span>
<span class="fc" id="L2344">				Integer eventMask = (Integer) appletRequest.get(PageKeys.LOCKUNLOCK_EVENT_MASK);</span>
<span class="fc" id="L2345">				Collection employees = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L2346">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L2347">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L2348">				getScheduleAccessManager(context, appletResponse, locale).lockEvents(eventMask.intValue(), employees, startDate, endDate);</span>
<span class="pc bpc" id="L2349" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_UNLOCK_MULTIPLE)) {</span>
<span class="nc" id="L2350">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNLOCKING_EVENTS;</span>
<span class="nc" id="L2351">				Integer eventMask = (Integer) appletRequest.get(PageKeys.LOCKUNLOCK_EVENT_MASK);</span>
<span class="nc" id="L2352">				Collection employees = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L2353">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L2354">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="nc" id="L2355">				getScheduleAccessManager(context, appletResponse, locale).unlockEvents(eventMask.intValue(), employees, startDate, endDate);</span>
				//} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_PHANTOM)) {
<span class="pc bpc" id="L2357" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CREATE_PHANTOM)) {</span>
<span class="nc" id="L2358">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATE_PHANTOM;</span>
<span class="nc" id="L2359">				Collection employees = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L2360">				Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="nc" id="L2361">				Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
				
<span class="nc" id="L2363">				ID campaignID = (ID) appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L2364">				List&lt;SchedulingPeriod&gt; sps = (List&lt;SchedulingPeriod&gt;)getCampaignManager(context, appletResponse, locale).getSchedulingPeriods(campaignID, startDate, endDate);</span>
				//in the period only one sp is expected
<span class="nc bnc" id="L2366" title="All 2 branches missed.">				if(sps.size()==1){</span>
<span class="nc" id="L2367">					Collection newPhantomIDs = getScheduleAccessManager(context, appletResponse, locale).createPhantoms(employees, ((SchedulingPeriod)sps.get(0)).getID(), startDate, endDate);</span>
<span class="nc bnc" id="L2368" title="All 2 branches missed.">					newPhantomIDs = newPhantomIDs instanceof ArrayList ?  newPhantomIDs : new ArrayList(newPhantomIDs); //need to make sure it's a list</span>
<span class="nc" id="L2369">					appletResponse.put(PageKeys.PHANTOM_IDS, newPhantomIDs);</span>
				}
<span class="pc bpc" id="L2371" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_SEND_SCHEDULE_REQUEST)) {</span>
<span class="nc" id="L2372">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REQUESTING_SCHEDULE;</span>
<span class="nc" id="L2373">				SchedulingRequest request = (SchedulingRequest) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULING_REQUEST);</span>
<span class="nc" id="L2374">				getCampaignManager(context, appletResponse, locale).makeSchedulingRequest(request);</span>
<span class="pc bfc" id="L2375" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_CLEAR_SCHEDULE_REQUEST_SESSION_AND_STATE)) {</span>
<span class="fc" id="L2376">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CLEARING_SCHEDULE_REQUEST;</span>
<span class="fc" id="L2377">				SchedulingRequest request = (SchedulingRequest) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULING_REQUEST);</span>
<span class="fc" id="L2378">				clearScheduleRequestSessionAndState(request, getCampaignManager(context, appletResponse, locale));</span>
<span class="pc bpc" id="L2379" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, PageKeys.DELETE_SCHEDULE_WARNINGS)) {</span>
<span class="nc" id="L2380">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;</span>
<span class="nc" id="L2381">				Collection warningIDs = (Collection) appletRequest.get(PageKeys.SCHEDULEWARNING_IDS);</span>
<span class="nc" id="L2382">				getCampaignManager(context, appletResponse, locale).clearSchedulingStateWarnings(warningIDs);</span>
<span class="pc bfc" id="L2383" title="All 2 branches covered.">			} else if(isAppletAction(appletRequest, PageKeys.CALENDAR_APPLET_GET__LOCALE_ID_FOR_DEI)) {</span>
<span class="fc" id="L2384">				String userLocale = (String) appletRequest.get(PageKeys.USER_LOCALE);</span>
<span class="fc" id="L2385">				String userRegLocale = (String) appletRequest.get(PageKeys.USER_REG_LOCALE);</span>
				//DBConfigManager configMgr = BbmManagerFactory.getDBConfigManager();
<span class="fc" id="L2387">				DBConfigManager configMgr = getDBManager(context, appletResponse, locale);</span>
<span class="fc" id="L2388">				String supportedLangKey = &quot;SupportedRegionalFormats&quot;;</span>
<span class="fc" id="L2389">				String supportedLangIDKey = &quot;SupportedRegionalFormatLocaleIDs&quot;;</span>
<span class="fc" id="L2390">				String supportedLangValue = configMgr.getValue(supportedLangKey);</span>
<span class="fc" id="L2391">				String supportedLangIDsValue = configMgr.getValue(supportedLangIDKey);</span>
<span class="fc" id="L2392">				Map localeMap = new HashMap(0);</span>
<span class="fc" id="L2393">				localeMap.put(supportedLangKey, supportedLangValue);</span>
<span class="fc" id="L2394">				localeMap.put(supportedLangIDKey, supportedLangIDsValue);</span>
<span class="fc" id="L2395">				String localeID = getLocaleID(userLocale, localeMap);</span>
<span class="fc" id="L2396">				String regLocaleID = getLocaleID(userRegLocale, localeMap);</span>
<span class="fc" id="L2397">				appletResponse.put(PageKeys.USER_LOCALE_ID, localeID);</span>
<span class="fc" id="L2398">				appletResponse.put(PageKeys.USER_REG_LOCALE_ID, regLocaleID);</span>
				//addResponseData(localeID, appletResponse);
<span class="fc" id="L2400">			}</span>

			// ================= text applet support starts =======================
<span class="pc bpc" id="L2403" title="1 of 2 branches missed.">			else if (isAppletAction(appletRequest, FsKeys.TEXTAPPLET_CALENDAR_REPUBLISH)) {</span>
				//GET SP ID FROM TEXT APPLET CALL, IT SHOULD BE SID OF SP
<span class="nc" id="L2405">				String str = (String)appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L2406">				ID spID = new ID(str);</span>
<span class="nc" id="L2407">				str = (String)appletRequest.get(FsKeys.TEXTAPPLET_CALENDAR_PUBLISH_ONLY);</span>
<span class="nc" id="L2408">				boolean doPublishOnly = new Boolean(str);</span>
				
<span class="nc bnc" id="L2410" title="All 2 branches missed.">				if (spID != null) {</span>
<span class="nc" id="L2411">					SchedulingPeriod sp = this.getCampaignManager(context, appletResponse, locale).getSchedulingPeriodByID(spID);</span>
					//get employee ids in this SP
<span class="nc" id="L2413">					Filter filter = Filter.createAllCurrentFilter(context.getUser().getID());</span>

<span class="nc" id="L2415">					List sortFlds = new ArrayList();</span>
<span class="nc" id="L2416">					sortFlds.add(NumberFactory.newInteger(Filter.LASTNAME));</span>
					
<span class="nc" id="L2418">					Collection employeeIDs =  getEmployeeFilterManager(context, appletResponse, locale)</span>
<span class="nc" id="L2419">							.getEmployeeIDs(filter, context.getUser(), sortFlds, true, 0, Integer.MAX_VALUE, false, spID);</span>
					
<span class="nc" id="L2421">					appletRequest.put(PageKeys.EMPLOYEE_IDS, employeeIDs);</span>
<span class="nc" id="L2422">					appletRequest.put(PageKeys.START_DATE, sp.getStartTime());</span>
<span class="nc" id="L2423">					appletRequest.put(PageKeys.END_DATE, sp.getEndTime());</span>
<span class="nc" id="L2424">					appletRequest.put(PageKeys.PUBLISH_TIMEOFF_ONLY, Boolean.FALSE);</span>
				}

				//un-publish for all
<span class="nc" id="L2428">				String unpublishingErrorMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_CHUNK;</span>
<span class="nc" id="L2429">				String someFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_SOME;</span>
<span class="nc" id="L2430">				String allFailedMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_UNPUBLISHING_ALL;</span>
<span class="nc bnc" id="L2431" title="All 2 branches missed.">				if(!doPublishOnly){</span>
<span class="nc" id="L2432">					doPublish(context, locale, appletRequest, appletResponse, UNPUBLISH, unpublishingErrorMsgID, allFailedMsgID, someFailedMsgID);</span>
				}
				//publish for all
<span class="nc" id="L2435">				String publishingErrorMsgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_PUBLISHING_CHUNK;</span>
<span class="nc" id="L2436">				doPublish(context, locale, appletRequest, appletResponse, PUBLISH, publishingErrorMsgID, allFailedMsgID, someFailedMsgID);				</span>
<span class="pc bpc" id="L2437" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, FsKeys.TEXTAPPLET_CALENDAR_UPDATEEMPSCHEDULE)) {</span>
				//get employee shifts in one sp and then save it without change
<span class="nc" id="L2439">				String str = (String)appletRequest.get(PageKeys.EMPLOYEE_IDS); //return single employee id</span>
<span class="nc" id="L2440">				ID empID = new ID(str);</span>
<span class="nc" id="L2441">				str = (String)appletRequest.get(PageKeys.START_DATE); //time in milliseconds</span>
<span class="nc" id="L2442">				Date start = TextAppletIO.convertToDate(str); </span>
<span class="nc" id="L2443">				str = (String)appletRequest.get(PageKeys.END_DATE); //time in milliseconds</span>
<span class="nc" id="L2444">				Date end = TextAppletIO.convertToDate(str); </span>

				//get shifts for employee 
<span class="nc" id="L2447">				Collection shifts = getScheduleAccessManager(context, appletResponse, locale).getEventsForWorkResourceByType(Event.EVENT_TYPE_SHIFT_ASSIGNMENT, empID, start, end);</span>

				//update shifts for employee
<span class="nc" id="L2450">				ShiftAssignment event = null;</span>
<span class="nc bnc" id="L2451" title="All 2 branches missed.">				for (Iterator i = shifts.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L2452">					event = (ShiftAssignment)i.next();</span>
<span class="nc" id="L2453">					event.setUpdateUser(context.getUserName());</span>
<span class="nc" id="L2454">					getScheduleAccessManager(context, appletResponse, locale).updateShiftAssignment(event);</span>
				}
<span class="pc bpc" id="L2456" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, FsKeys.TEXTAPPLET_CALENDAR_OPENCAMPAIGN)) {</span>
				//GET SP ID FROM TEXT APPLET CALL, IT SHOULD BE SID OF SP
<span class="nc" id="L2458">				String str = (String)appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L2459">				ID spID = new ID(str);</span>
				//get employee ids in this SP
<span class="nc" id="L2461">				Filter filter = Filter.createAllCurrentFilter(context.getUser().getID());</span>

<span class="nc" id="L2463">				List sortFlds = new ArrayList();</span>
<span class="nc" id="L2464">				sortFlds.add(NumberFactory.newInteger(Filter.LASTNAME));</span>
				
<span class="nc" id="L2466">				Collection employeeIDs =  getEmployeeFilterManager(context, appletResponse, locale)</span>
<span class="nc" id="L2467">						.getEmployeeIDs(filter, context.getUser(), sortFlds, true, 0, Integer.MAX_VALUE, false, spID);</span>
<span class="nc" id="L2468">				SchedulingPeriod sp = this.getCampaignManager(context, appletResponse, locale).getSchedulingPeriodByID(spID);</span>
				//basic data fetch 
<span class="nc" id="L2470">				loadBasicForCalendar(context, appletResponse, locale, sp, employeeIDs, sp.getStartTime(), sp.getEndTime());</span>

<span class="pc bpc" id="L2472" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, FsKeys.TEXTAPPLET_CALENDAR_OPENORG)) {</span>
<span class="nc" id="L2473">				String str = (String)appletRequest.get(PageKeys.EMP_FILTER);</span>
<span class="nc" id="L2474">				Filter filter = this.getEmployeeFilterManager(context, appletResponse, locale).getFilterByName(context.getUser().getID(), str);</span>
<span class="nc" id="L2475">				Collection employeeIDs = getEmployeeIDsByFilter(context, appletResponse, locale, context.getUser(), null, filter);</span>

<span class="nc" id="L2477">				str = (String)appletRequest.get(PageKeys.START_DATE); //time in milliseconds</span>
<span class="nc" id="L2478">				Date start = TextAppletIO.convertToDate(str); </span>
<span class="nc" id="L2479">				str = (String)appletRequest.get(PageKeys.END_DATE); //time in milliseconds</span>
<span class="nc" id="L2480">				Date end = TextAppletIO.convertToDate(str);</span>

				//basic data fetch
<span class="nc" id="L2483">				loadBasicForCalendar(context, appletResponse, locale, null, employeeIDs, start, end);</span>

<span class="pc bpc" id="L2485" title="1 of 2 branches missed.">			} else if (isAppletAction(appletRequest, FsKeys.TEXTAPPLET_CALENDAR_SCHEDULE)) {</span>
				//GET SP ID FROM TEXT APPLET CALL, IT SHOULD BE SID OF SP
<span class="nc" id="L2487">				String str = (String)appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L2488">				ID spID = new ID(str);</span>
				//call integration server to schedule
				//QC115821:Change implementation of performance API for calendar on the web to create a different dei file
<span class="nc" id="L2491">				String[] deiParams = new String[6];</span>
<span class="nc" id="L2492">				deiParams[0] = &quot;en_US&quot;; //default user locale</span>
<span class="nc" id="L2493">				deiParams[1] = &quot;1033&quot;; //default user locale id</span>
<span class="nc" id="L2494">				deiParams[2] = &quot;en_US&quot;; //default regional locale</span>
<span class="nc" id="L2495">				deiParams[3] = &quot;1033&quot;; //default regLocale id</span>
<span class="nc" id="L2496">				deiParams[4] = &quot;true&quot;; //ignoreInitialWarnings for text api</span>
<span class="nc" id="L2497">				deiParams[5] = &quot;true&quot;; //ignoreSecondaryWarnings for text api</span>
<span class="nc" id="L2498">				getFacadeCorbaFacadeManager(appletResponse, locale).recalcScheduling(</span>
<span class="nc" id="L2499">						UserCacheManager.getInstance().getCachedUserName(context),</span>
<span class="nc" id="L2500">						getUserManager(context, appletResponse, locale).generateToken(UserCacheManager.getInstance().getCachedUserSeal(context)),</span>
<span class="nc" id="L2501">						context.isInWhatIfMode(),</span>
						2, spID, false,false, deiParams);
				//wait till it is end
<span class="nc" id="L2504">				boolean isDone = false;</span>
				
<span class="nc" id="L2506">				String rawValue = getDBManager(context, appletResponse, locale).getValue(FsKeys.STATUS_POLLING_INTERVAL_SECONDS);</span>
<span class="nc" id="L2507">				int pollingInterval = 5;</span>
				try {
<span class="nc" id="L2509">					pollingInterval = Integer.parseInt(rawValue);</span>
<span class="nc" id="L2510">				} catch (NumberFormatException nfe) {</span>
<span class="nc" id="L2511">					log.l7dDebug(&quot;STATUS_POLLING_INTERVAL_SECONDS could not be parsed '&quot; + rawValue + &quot;', defaulting to 5 seconds.&quot;);</span>
<span class="nc" id="L2512">				}</span>
				
<span class="nc" id="L2514">				int progress = 0;</span>
<span class="nc" id="L2515">				int count = 0;</span>
<span class="nc bnc" id="L2516" title="All 2 branches missed.">				while (!isDone) {</span>
<span class="nc" id="L2517">					SchedulingState state = getCampaignManager(context, appletResponse, locale).getSchedulingState(spID, &quot;S&quot;);</span>
<span class="nc bnc" id="L2518" title="All 2 branches missed.">					if (state != null) {</span>
<span class="nc" id="L2519">						progress = state.getOverallStatus();</span>
<span class="nc bnc" id="L2520" title="All 2 branches missed.">						if (progress == 100) {</span>
							//show done button on process dialog
<span class="nc" id="L2522">							appletResponse.put(FsKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L2523">							return;</span>
						}
						
					} else {
						//count the number of times scheduling state is null
<span class="nc" id="L2528">						count++;</span>
					}
					
<span class="nc bnc" id="L2531" title="All 2 branches missed.">					if (count &lt; 40) {</span>
						try {
							//FIXME: We should never sleep on the server side!
<span class="nc" id="L2534">							Thread.sleep(pollingInterval*1000);</span>
<span class="nc" id="L2535">						} catch (Exception ex) {</span>
							//ignore
<span class="nc" id="L2537">						}</span>
					} else{
						//exit the loop when the scheduling state is null for 40 times
<span class="nc" id="L2540">						return;</span>
					}
<span class="nc" id="L2542">				}</span>
				
<span class="pc bpc" id="L2544" title="1 of 2 branches missed.">			} else if(isAppletAction(appletRequest, FsKeys.TEXTAPPLET_CALENDAR_SERVICELEVEL_RIBBONS)) { </span>
<span class="nc" id="L2545">				String str = (String)appletRequest.get(PageKeys.START_DATE);</span>
				//time in milliseconds
<span class="nc" id="L2547">				Date startDate = TextAppletIO.convertToDate(str);</span>
				
<span class="nc" id="L2549">				str = (String)appletRequest.get(PageKeys.END_DATE); </span>
				//time in milliseconds
<span class="nc" id="L2551">				Date endDate = TextAppletIO.convertToDate(str);</span>
				
<span class="nc" id="L2553">				str = (String)appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L2554">				ID spID = new ID(str);</span>
				
<span class="nc" id="L2556">				str = (String)appletRequest.get(PageKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L2557">				ID campaignID = new ID(str);</span>
<span class="nc" id="L2558">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_STATISTIC_RIBBONS;</span>
				
<span class="nc" id="L2560">				getServiceLevelRibbons(context, locale, appletResponse, spID, campaignID, startDate, endDate, msgID);</span>
<span class="pc bpc" id="L2561" title="1 of 2 branches missed.">			}else if (isAppletAction(appletRequest, PageAction.ACTION_SAVE_FTE_CALC_INPUTS)) {</span>
<span class="nc" id="L2562">				SP sp = (SP) appletRequest.get(PageKeys.SP_SCHEDULINGPARAMS);</span>
<span class="nc" id="L2563">				getCampaignManager(context, appletResponse, locale).updateRealSP(sp);</span>
<span class="pc bfc" id="L2564" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, FsKeys.CLEAR_SCHEDULE_STATE)) {</span>
<span class="fc" id="L2565">				msgID = FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;</span>
<span class="fc" id="L2566">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="fc" id="L2567">				String modeChar = (String)appletRequest.get(FsKeys.MODE_CHAR);	</span>
<span class="fc" id="L2568">				getCampaignManager(context, appletResponse, locale).clearSchedulingState(spID, modeChar);</span>
<span class="fc bfc" id="L2569" title="All 2 branches covered.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_SET_BASE_FORECAST)) {</span>
<span class="fc" id="L2570">				Collection spQueueSIDs = (Collection)appletRequest.get(PageKeys.SPQUEUE_SIDS);</span>
<span class="fc" id="L2571">				SchedulingPeriod sp = (SchedulingPeriod)appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD);</span>
<span class="fc" id="L2572">				String name = context.getLocalizer().i18n(ForecastingWebBundleKey.BUNDLE_NAME, ForecastingWebBundleKey.BASE_FORECAST_INSTANCE_NAME);</span>
<span class="fc" id="L2573">				getForecastManager(context, appletResponse, locale).saveActiveForecastAsBase(name, spQueueSIDs, sp);</span>
			}

<span class="nc" id="L2576">		} catch (RuntimeException e) {</span>
<span class="nc" id="L2577">			TimeZone tz = null;</span>
<span class="nc" id="L2578">			String sTZ = (String)appletRequest.get(FsKeys.EXPORTSCHED_VIEWTIMEZONE);</span>
<span class="nc bnc" id="L2579" title="All 2 branches missed.">			if (sTZ != null)</span>
<span class="nc" id="L2580">				tz = TimeZone.getTimeZone(sTZ);</span>
<span class="nc" id="L2581">			handleUnexpectedError(context, appletResponse, locale, e, msgID, params, tz);</span>
<span class="nc" id="L2582">		} catch (Exception e) {</span>
<span class="nc" id="L2583">			TimeZone tz = null;</span>
<span class="nc" id="L2584">			String sTZ = (String)appletRequest.get(FsKeys.EXPORTSCHED_VIEWTIMEZONE);</span>
<span class="nc bnc" id="L2585" title="All 2 branches missed.">			if (sTZ != null)</span>
<span class="nc" id="L2586">				tz = TimeZone.getTimeZone(sTZ);</span>
<span class="nc" id="L2587">			handleExpectedError(context, appletResponse, locale, e, msgID, params, tz);</span>
<span class="pc" id="L2588">		}</span>
<span class="fc" id="L2589">	}</span>

	/**
	 * Removes scheduling request, session, and state entries for the specified SP.  If any such
	 * entries are not found, that entry type is skipped silently and the rest are cleared.
	 */
	private void clearScheduleRequestSessionAndState(SchedulingRequest request, CampaignManager campaignManager)
			throws RemoteException {
		try {
<span class="fc" id="L2598">			campaignManager.clearSchedulingRequest(request);</span>
<span class="nc" id="L2599">		} catch (BbmRemoveException bre) {</span>
			// We don't care if there wasn't anything to clear.
<span class="fc" id="L2601">		}</span>
		
		try {
<span class="fc" id="L2604">			campaignManager.clearSPScheduleSession(request.getSPSID());</span>
<span class="nc" id="L2605">		} catch (BbmFinderException bfe) {</span>
			// We don't care if there wasn't anything to clear.
<span class="nc" id="L2607">		} catch (BbmRemoveException bre) {</span>
			// We don't care if there wasn't anything to clear.
<span class="pc" id="L2609">		}</span>
		
		try {
<span class="fc" id="L2612">			campaignManager.clearSchedulingState(request.getSPSID(), request.getMode());</span>
<span class="nc" id="L2613">		} catch (BbmRemoveException bre) {</span>
			// We don't care if there wasn't anything to clear.
<span class="fc" id="L2615">		}</span>
<span class="fc" id="L2616">	}</span>

	protected void convertToDefaultIO(Map appletRequest, AppletIO io) {
<span class="nc" id="L2619">		super.convertToDefaultIO(appletRequest, io);</span>
<span class="nc" id="L2620">	}</span>

	private void loadBasicForCalendar(RequestContext context, Map appletResponse, Locale locale, SchedulingPeriod sp, Collection empIDs, Date startDate, Date endDate) throws Exception {
		
<span class="nc" id="L2624">		getCampaignManager(context, appletResponse, locale).getCampaigns();</span>
<span class="nc" id="L2625">		Collection allOrgs = getWorkResourceManager(context, appletResponse, locale).getOrganizations(null);</span>

<span class="nc bnc" id="L2627" title="All 2 branches missed.">		if (sp == null) {</span>
			//load shifts
<span class="nc" id="L2629">			ValueObjectUtil.getIDObjectMap(getWorkRuleManager(context, appletResponse, locale).getShifts(empIDs, startDate, endDate));</span>
			//load activities
<span class="nc" id="L2631">			ActivityManager m_activityManager = getActivityManager(context, appletResponse, locale);</span>
<span class="nc" id="L2632">			ActivityFilter activityOrganizationFilter = new ActivityFilter();</span>
<span class="nc" id="L2633">			Collection activities = m_activityManager.findActivities(activityOrganizationFilter);</span>
			//shift ot
<span class="nc" id="L2635">			getWorkRuleManager(context, appletResponse, locale).getShiftOTExtension(empIDs, startDate, endDate);</span>
<span class="nc" id="L2636">		} else {</span>
<span class="nc" id="L2637">			getCampaignManager(context, appletResponse, locale).getShift(sp.getCampaignID(), startDate, endDate); //campaignID should be SID</span>
			
			//load activities
<span class="nc" id="L2640">			Collection campaignOrgIDs = getCampaignManager(context, appletResponse, locale).getOrganizationsForCampaign(sp.getCampaignID(), startDate, endDate);</span>
<span class="nc" id="L2641">			ValueObjectUtil.getIDObjectMap(getActivityManager(context, appletResponse, locale).findOrganizationActivities(campaignOrgIDs, true));</span>
			//load sps
<span class="nc" id="L2643">			Campaign campaign = getCampaignManager(context, appletResponse, locale).getCampaignByID(sp.getCampaignID());</span>
<span class="nc" id="L2644">			getCampaignManager(context, appletResponse, locale).getSchedulingPeriods(campaign);</span>
			//campaign hoo
<span class="nc" id="L2646">			getCampaignManager(context, appletResponse, locale).getCampaignHOOAssignments(sp.getCampaignID(), startDate, endDate);</span>
<span class="nc" id="L2647">			getCampaignManager(context, appletResponse, locale).getHOOPeriod(sp.getCampaignID(), startDate, endDate);</span>
			//shift ot
<span class="nc" id="L2649">			getWorkRuleManager(context, appletResponse, locale).getShiftOTExtension(new ScopeID(sp.getCampaignID(), Scope.CAMPAIGN_SCOPE), startDate, endDate);</span>
		}

<span class="nc" id="L2652">		getWorkResourceManager(context, appletResponse, locale).getWorkResourceNamesByIDs(empIDs);</span>
		//load conflick checking background data
<span class="nc" id="L2654">		Map mapEmpWorkPatternAssignments = getEmpWorkRuleManager(context, appletResponse, locale).getWorkPatternAssignments(empIDs, startDate, endDate);</span>
<span class="nc" id="L2655">		Collection colAssignments = null;</span>
<span class="nc" id="L2656">		WorkResourceWorkPattern ww= null;</span>
<span class="nc" id="L2657">		Set colWWSID = new HashSet();</span>
<span class="nc bnc" id="L2658" title="All 2 branches missed.">		for (Iterator i = mapEmpWorkPatternAssignments.values().iterator(); i.hasNext();) {</span>
<span class="nc" id="L2659">			colAssignments = (Collection)i.next();</span>
<span class="nc bnc" id="L2660" title="All 4 branches missed.">			if (colAssignments != null &amp;&amp; !colAssignments.isEmpty()) {</span>
<span class="nc bnc" id="L2661" title="All 2 branches missed.">				for (Iterator ix = colAssignments.iterator(); ix.hasNext(); ) {</span>
<span class="nc" id="L2662">					ww= (WorkResourceWorkPattern)ix.next();</span>
<span class="nc" id="L2663">					colWWSID.add(ww.getWorkPatternSID());</span>
				}
			}
		}
<span class="nc" id="L2667">		getWorkRuleManager(context, appletResponse, locale).getShiftPatternsByIDs(colWWSID);</span>
<span class="nc" id="L2668">		getEmpWorkRuleManager(context, appletResponse, locale).getMinMaxHourAssignments(empIDs, startDate, endDate);</span>
<span class="nc" id="L2669">	}</span>

	private static final int PUBLISH = -1;
	private static final int UNPUBLISH = -2;
	private static final int REVERT_TO_PUBLISHED = -3;
	private void doPublish(RequestContext context, Locale locale, Map appletRequest, Map appletResponse, int publishType, String publishingErrorMsgID, 
			String allFailedMsgID, String someFailedMsgID) throws BbmFinderException, RemoteException, BbmEJBCreateException {
<span class="fc" id="L2676">		String errorMsg = &quot;&quot;;</span>
<span class="fc" id="L2677">		Collection workResourceIDs = (Collection) appletRequest.get(PageKeys.EMPLOYEE_IDS);</span>
<span class="fc" id="L2678">		Date startDate = (Date) appletRequest.get(PageKeys.START_DATE);</span>
<span class="fc" id="L2679">		Date endDate = (Date) appletRequest.get(PageKeys.END_DATE);</span>
<span class="fc" id="L2680">		boolean isTimeOffOnly = ((Boolean)appletRequest.get(PageKeys.PUBLISH_TIMEOFF_ONLY)).booleanValue();</span>
		// @todo - check for permissions
		// get the chunk size - we now publish in chunks to avoid transaction timeouts
<span class="fc" id="L2683">		int chunkSize = getPublishingChunkSize();</span>
<span class="fc" id="L2684">		List listFailedIDs = new ArrayList();</span>
<span class="fc" id="L2685">		List listChunkIDs = new ArrayList(chunkSize);</span>
<span class="fc bfc" id="L2686" title="All 2 branches covered.">		for (Iterator it = workResourceIDs.iterator(); it.hasNext();) {</span>
<span class="fc bfc" id="L2687" title="All 2 branches covered.">			while (it.hasNext()) {</span>
<span class="fc" id="L2688">				listChunkIDs.add(it.next());</span>
<span class="pc bpc" id="L2689" title="1 of 2 branches missed.">				if (listChunkIDs.size() == chunkSize) {</span>
<span class="nc" id="L2690">					break;</span>
				}
			}
			try {
<span class="pc bpc" id="L2694" title="3 of 4 branches missed.">				switch (publishType) {</span>
				case PUBLISH:
<span class="pc bpc" id="L2696" title="1 of 2 branches missed.">					if (isTimeOffOnly) {</span>
<span class="nc" id="L2697">						getScheduleAccessManager(context, appletResponse, locale).publishTimeOffEvents(listChunkIDs, startDate, endDate);</span>
					} else {
<span class="fc" id="L2699">						getScheduleAccessManager(context, appletResponse, locale).publishScheduleInBatch(listChunkIDs, startDate, endDate, true);</span>
					}
<span class="fc" id="L2701">					break;</span>
				case UNPUBLISH:
<span class="nc bnc" id="L2703" title="All 2 branches missed.">					if (isTimeOffOnly) {</span>
<span class="nc" id="L2704">						getScheduleAccessManager(context, appletResponse, locale).unPublishTimeOffEvents(listChunkIDs, startDate, endDate);</span>
					} else {
<span class="nc" id="L2706">						getScheduleAccessManager(context, appletResponse, locale).unPublishSchedule(listChunkIDs, startDate, endDate);</span>
					}
<span class="nc" id="L2708">					break;</span>
				case REVERT_TO_PUBLISHED:
<span class="nc" id="L2710">					getScheduleAccessManager(context, appletResponse, locale).revertToPublishedSchedule(listChunkIDs, startDate, endDate);</span>
					break;
				}
<span class="fc" id="L2713">			} catch (BPException e) {</span>
<span class="fc" id="L2714">				listFailedIDs.addAll(listChunkIDs);</span>
<span class="fc" id="L2715">				log.l7dDebug(publishingErrorMsgID, e);</span>
<span class="fc" id="L2716">				errorMsg = e.getCoreException().getLocalizedMessage();</span>
<span class="fc" id="L2717">			}</span>
<span class="fc" id="L2718">			listChunkIDs.clear();</span>
		}
<span class="fc bfc" id="L2720" title="All 2 branches covered.">		if (!listFailedIDs.isEmpty()) {</span>
<span class="pc bpc" id="L2721" title="1 of 2 branches missed.">			if (listFailedIDs.size() == workResourceIDs.size()) {</span>
				// let the user know that all employees failed to publish
<span class="fc" id="L2723">				appletResponse.put(PageKeys.APPLET_ERROR, context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, allFailedMsgID) + &quot;\n&quot; + errorMsg);</span>
			} else {
				// let the user know that some employees failed to publish
<span class="nc" id="L2726">				StringBuffer strBuffEmps = new StringBuffer();</span>
<span class="nc" id="L2727">				Iterator itFailedEmpIDs = listFailedIDs.iterator();</span>
<span class="nc" id="L2728">				Map employeeNamesByIDs = getWorkResourceManager(context, appletResponse, locale).getEmployeeNamesByIDs(listFailedIDs);</span>
<span class="nc bnc" id="L2729" title="All 2 branches missed.">				while (itFailedEmpIDs.hasNext()) {</span>
<span class="nc bnc" id="L2730" title="All 2 branches missed.">					if (strBuffEmps.length() &gt; 0) {</span>
<span class="nc" id="L2731">						strBuffEmps.append(&quot;; &quot;);</span>
					}
<span class="nc" id="L2733">					ID nextID = (ID) itFailedEmpIDs.next();</span>
<span class="nc" id="L2734">					EmployeeName nextName = (EmployeeName) employeeNamesByIDs.get(nextID);</span>
<span class="nc" id="L2735">				}</span>
<span class="nc" id="L2736">				Object [] parameters = new Object[] {strBuffEmps};</span>
<span class="nc" id="L2737">				appletResponse.put(PageKeys.APPLET_ERROR, context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, someFailedMsgID, parameters) + &quot;\n&quot; + errorMsg);</span>
			}
		}
<span class="fc" id="L2740">	}</span>

	private int getPublishingChunkSize() {
		try {
<span class="fc" id="L2744">			int chunkSize = 0;</span>
<span class="pc bpc" id="L2745" title="1 of 2 branches missed.">			if (chunkSize &lt;= 0) {</span>
<span class="fc" id="L2746">				chunkSize = DEFAULT_CHUNK_SIZE;</span>
			}
<span class="fc" id="L2748">			return chunkSize;</span>
<span class="nc" id="L2749">		} catch (Exception e) {</span>
<span class="nc" id="L2750">			log.l7dDebug(FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_CREATING_SHIFTASSIGNMENT, e);</span>
			// we don't really want everything to fail just because we couldn't get the value from the database
<span class="nc" id="L2752">			return DEFAULT_CHUNK_SIZE;</span>
		}
	}

	/**
	 * Added Config key for enabling/disabling employee filter , Config key :DisableEmployeeFilter.
	 * The Filter Employees popup window displays when adding an absence. - ESR#4380762
	 * @throws BbmEJBCreateException
	 * @throws RemoteException
	 */
	 protected String isEmployeeFilterBpconfigEnabled() throws BbmEJBCreateException, RemoteException {
<span class="fc" id="L2763">		String disableEmployeeFilter = &quot;false&quot;;</span>
<span class="fc" id="L2764">		String EmployeeFilterVal = BbmManagerFactory.getDBConfigManager().getValue(&quot;DisableEmployeeFilter&quot;); </span>
<span class="pc bpc" id="L2765" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(EmployeeFilterVal) ) {</span>
<span class="nc" id="L2766">			 disableEmployeeFilter = EmployeeFilterVal;</span>
		} else {
<span class="fc" id="L2768">			disableEmployeeFilter=&quot;false&quot;;</span>
		}
<span class="fc" id="L2770">		return disableEmployeeFilter;</span>
	}

	/**
	 * Get the chunk size to use when loading employee schedules and PersonData.
	 * @throws BbmEJBCreateException
	 * @throws RemoteException
	 */
	protected int getEmployeeChunkSize() throws BbmEJBCreateException, RemoteException {
<span class="fc" id="L2779">		int chunkSize = DEFAULT_EMPLOYEE_CHUNK_SIZE;</span>
<span class="fc" id="L2780">		String val = BbmManagerFactory.getDBConfigManager().getValue(CALENDAR_EMPLOYEE_CHUNK_SIZE);</span>
<span class="pc bpc" id="L2781" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(val) ) {</span>
			try {
<span class="nc" id="L2783">				chunkSize = Integer.parseInt(val);</span>
<span class="nc" id="L2784">			} catch (NumberFormatException nfe) {</span>
				//do nothing
<span class="nc" id="L2786">			}</span>
		}
<span class="fc" id="L2788">		return chunkSize;</span>
	}

	private void handleExpectedError(RequestContext context, Map appletResponse, String msgID, Object[] params) {
<span class="nc" id="L2792">		log.l7dDebug(msgID, params);</span>
<span class="nc" id="L2793">		String message = context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, msgID, params);</span>
		
<span class="nc" id="L2795">		appletResponse.put(PageKeys.APPLET_ERROR, message);</span>
<span class="nc" id="L2796">	}</span>

	private void handleExpectedError(RequestContext context, Map appletResponse, Locale locale, Exception e, String msgID, Object[] params, TimeZone viewTimeZone) {
<span class="nc" id="L2799">		log.l7dDebug(msgID, e);</span>
<span class="nc" id="L2800">		String message = context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, msgID, params);</span>
		
<span class="nc" id="L2802">		String extraMessage = null;</span>
<span class="nc bnc" id="L2803" title="All 4 branches missed.">		if (e instanceof MultiUserException || e instanceof BbmObjectNotFoundException) {</span>
<span class="nc" id="L2804">			extraMessage = context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_MULTIUSER_EXTENSION);</span>
<span class="nc bnc" id="L2805" title="All 2 branches missed.">		} else if (e instanceof RemoteException) {</span>
<span class="nc" id="L2806">			extraMessage = context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_MULTIUSER_EXTENSION);</span>
<span class="nc bnc" id="L2807" title="All 2 branches missed.">		} else if (e instanceof BbmUpdateException) {</span>
<span class="nc" id="L2808">			Exception core = ((BbmUpdateException)e).getCoreException();</span>
<span class="nc bnc" id="L2809" title="All 2 branches missed.">			if (core != null)</span>
<span class="nc" id="L2810">				extraMessage = core.getLocalizedMessage();</span>
		} 
<span class="nc bnc" id="L2812" title="All 2 branches missed.">		if (extraMessage != null) {</span>
<span class="nc" id="L2813">			message += &quot; &quot; + extraMessage;</span>
		}

<span class="nc" id="L2816">		appletResponse.put(PageKeys.APPLET_ERROR, message);</span>
<span class="nc" id="L2817">		String [] exceptionMessages = getExceptionMessages(context, locale, e, viewTimeZone);</span>
<span class="nc" id="L2818">		AppletError appletError = new AppletError(e.getClass().getName(), exceptionMessages);</span>
<span class="nc" id="L2819">		appletResponse.put(PageKeys.APPLET_ERROR_OBJECT, appletError);</span>
<span class="nc" id="L2820">	}</span>

	private String[] getExceptionMessages(RequestContext context, Locale locale, Exception e, TimeZone viewTimeZone) {
<span class="nc" id="L2823">		String[] messages = null;</span>
		String nextMessage;
<span class="nc bnc" id="L2825" title="All 2 branches missed.">		if (e instanceof BbmScheduleConflictException) {</span>
<span class="nc" id="L2826">			Collection conflicts = ((BbmScheduleConflictException)e).getConflicts();</span>
<span class="nc" id="L2827">			messages = new String[conflicts.size()];</span>
<span class="nc" id="L2828">			int nextIndex = 0;</span>
<span class="nc" id="L2829">			Iterator itConflicts = conflicts.iterator();</span>

<span class="nc bnc" id="L2831" title="All 2 branches missed.">			while (itConflicts.hasNext()) {</span>
<span class="nc" id="L2832">				BbmScheduleConflict nextConflict = (BbmScheduleConflict) itConflicts.next();</span>
<span class="nc bnc" id="L2833" title="All 2 branches missed.">				messages[nextIndex++] = nextConflict.getLocalizedMessage(context.getLocalizer(), viewTimeZone==null?context.getViewingTimeZone():viewTimeZone);</span>
<span class="nc" id="L2834">			}</span>
<span class="nc bnc" id="L2835" title="All 2 branches missed.">		} else if (e instanceof BbmCreateException) {</span>
<span class="nc" id="L2836">			Exception core = ((BbmCreateException)e).getCoreException();</span>
<span class="nc bnc" id="L2837" title="All 2 branches missed.">			if (core != null) {</span>
<span class="nc" id="L2838">				nextMessage = core.getLocalizedMessage();</span>
<span class="nc" id="L2839">				messages = new String[]{nextMessage};</span>
			}
<span class="nc bnc" id="L2841" title="All 2 branches missed.">		} else if (e instanceof BPException) {</span>
<span class="nc" id="L2842">			nextMessage = ((BPException) e).getLocalizedMessage(locale);</span>
<span class="nc" id="L2843">			messages = new String[] {nextMessage};</span>
<span class="nc bnc" id="L2844" title="All 2 branches missed.">		} else if (e instanceof RemoteException) {</span>
<span class="nc" id="L2845">			nextMessage = ((RemoteException)e).getLocalizedMessage();</span>
<span class="nc" id="L2846">			messages = new String[]{nextMessage};</span>
		} else {
<span class="nc" id="L2848">			nextMessage = e.getLocalizedMessage();</span>
<span class="nc" id="L2849">			messages = new String[]{nextMessage};</span>
		}
<span class="nc" id="L2851">		return messages;</span>
	}

	private void handleUnexpectedError(RequestContext context, Map appletResponse, Locale locale, RuntimeException e, String msgID, Object[] params, TimeZone viewTimeZone) {
<span class="nc" id="L2855">		log.l7dError(msgID, e);</span>
		// DEBUG ONLY
<span class="nc" id="L2857">		String message = context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, msgID, params);</span>
		
<span class="nc" id="L2859">		appletResponse.put(PageKeys.APPLET_ERROR, message);</span>
<span class="nc" id="L2860">		String[] exceptionMessages = getExceptionMessages(context, locale, e, viewTimeZone);</span>
<span class="nc" id="L2861">		AppletError appletError = new AppletError(e.getClass().getName(), exceptionMessages);</span>
<span class="nc" id="L2862">		appletResponse.put(PageKeys.APPLET_ERROR_OBJECT, appletError);</span>
<span class="nc" id="L2863">	}</span>

	private CampaignManager getCampaignManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="fc bfc" id="L2866" title="All 2 branches covered.">		if (m_campaignManager == null) {</span>
<span class="fc" id="L2867">			m_campaignManager = WfmManagerFactory.getCampaignManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2869">		return m_campaignManager;</span>
	}

	private WorkRuleManager getWorkRuleManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="fc bfc" id="L2873" title="All 2 branches covered.">		if (m_workruleManager == null) {</span>
<span class="fc" id="L2874">			m_workruleManager = WfmManagerFactory.getWorkRuleManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2876">		return m_workruleManager;</span>
	}

	private ScheduleAccessManager getScheduleAccessManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="fc bfc" id="L2880" title="All 2 branches covered.">		if (m_scheduleAccessManager == null) {</span>
<span class="fc" id="L2881">			m_scheduleAccessManager = WfmManagerFactory.getScheduleAccessManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2883">		return m_scheduleAccessManager;</span>
	}

	private BbmELearningBridgeInterface getLearningAssignmentManager(Map appletResponse, Locale locale) 
			throws CoreEJBCreateException, CoreFinderException, RemoteException, ClassNotFoundException, InstantiationException, IllegalAccessException, BbmFinderException {
<span class="nc bnc" id="L2888" title="All 2 branches missed.">		if (m_bbmELearningBridge == null) {</span>
<span class="nc" id="L2889">			GCRManager gcrManager = CoreManagerFactory.getGCRManagerRemote(false);</span>
<span class="nc" id="L2890">			Collection entries = gcrManager.getGCREntryOfType(BbmELearningBridgeInterface.GCR_NAME);</span>
<span class="nc bnc" id="L2891" title="All 4 branches missed.">			if (entries == null || entries.isEmpty()){</span>
<span class="nc" id="L2892">				throw new BbmFinderException(FsWebBundleKey.FS_CAL_ERR_ERROR_GETTING_GCRMANAGER_BRIDGE_ENTRIES, new Object[]{BbmELearningBridgeInterface.GCR_NAME});</span>
			}
<span class="nc" id="L2894">			GCREntry entry = (GCREntry)entries.iterator().next();</span>
<span class="nc" id="L2895">			Class bridgeClass = Class.forName(entry.getHook());</span>
<span class="nc" id="L2896">			m_bbmELearningBridge = (BbmELearningBridgeInterface)bridgeClass.newInstance();			</span>
		}
<span class="nc" id="L2898">		return m_bbmELearningBridge;</span>
	}

	private WorkResourceManager getWorkResourceManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="fc bfc" id="L2902" title="All 2 branches covered.">		if (m_workResourceManager == null) {</span>
<span class="fc" id="L2903">			m_workResourceManager = BbmManagerFactory.getWorkResourceManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2905">		return m_workResourceManager;</span>
	}

	private SkillManager getSkillManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="pc bpc" id="L2909" title="1 of 2 branches missed.">		if (m_skillManager == null) {</span>
<span class="fc" id="L2910">			m_skillManager = WfmManagerFactory.getSkillManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2912">		return m_skillManager;</span>
	}
	
	private EmpWorkRuleManager getEmpWorkRuleManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="fc bfc" id="L2916" title="All 2 branches covered.">		if (m_empWorkRuleManager == null) {</span>
<span class="fc" id="L2917">			m_empWorkRuleManager = WfmManagerFactory.getEmpWorkRuleManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2919">		return m_empWorkRuleManager;</span>
	}

	private FacadeCorbaFacadeManager getFacadeCorbaFacadeManager(Map appletResponse, Locale locale) throws FacadeEJBCreateException {
<span class="pc bpc" id="L2923" title="1 of 2 branches missed.">		if (m_facadeCorbaFacadeManager == null) {</span>
<span class="fc" id="L2924">			m_facadeCorbaFacadeManager = FacadeManagerFactory.getFacadeCorbaFacadeManager();</span>
		}
<span class="fc" id="L2926">		return m_facadeCorbaFacadeManager;</span>
	}

	private PayPolicyManager getPayPolicyManager(Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="nc bnc" id="L2930" title="All 2 branches missed.">		if (m_payPolicyManager == null) {</span>
<span class="nc" id="L2931">			m_payPolicyManager = BbmManagerFactory.getPayPolicyManager();</span>
		}
<span class="nc" id="L2933">		return m_payPolicyManager;</span>
	}

	private WorkloadManager getWorkloadManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="fc bfc" id="L2937" title="All 2 branches covered.">		if (m_workloadManager == null) {</span>
<span class="fc" id="L2938">			m_workloadManager  = WfmManagerFactory.getWorkloadManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2940">		return m_workloadManager;</span>
	}

	private FteRequirementsManager getFteRequirementsManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="fc bfc" id="L2944" title="All 2 branches covered.">		if (m_fteRequirementsManager == null) {</span>
<span class="fc" id="L2945">			m_fteRequirementsManager = WfmManagerFactory.getFteRequirementsManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2947">		return m_fteRequirementsManager;		</span>
	}

	private TrackingManager getTrackingManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="pc bpc" id="L2951" title="1 of 2 branches missed.">		if (m_trackingManager == null) {</span>
<span class="fc" id="L2952">			m_trackingManager = WfmManagerFactory.getPulseTrackingManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2954">		return m_trackingManager;</span>
	}

	private ActivityManager getActivityManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="pc bpc" id="L2958" title="1 of 2 branches missed.">		if (m_activityManager == null) {</span>
<span class="fc" id="L2959">			m_activityManager = WfmManagerFactory.getActivityManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2961">		return m_activityManager;</span>
	}

	private UserManager getUserManager(RequestContext context, Map appletResponse, Locale locale) throws CoreEJBCreateException {
<span class="pc bpc" id="L2965" title="1 of 2 branches missed.">		if (m_userManager == null) {</span>
<span class="fc" id="L2966">			m_userManager = CoreManagerFactory.getUserManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2968">		return m_userManager;</span>
	}

	private ForecastTimeSeriesManager getForecastManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="pc bpc" id="L2972" title="1 of 2 branches missed.">		if (m_forecastManager == null) {</span>
<span class="fc" id="L2973">			m_forecastManager = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L2975">		return m_forecastManager;</span>
	}

	private Map&lt;ID, Organization&gt; getOrgIDMap(RequestContext context, Map appletResponse, Locale locale, Collection&lt;Collection&lt;WorkResourceAssignment&gt;&gt; wrkAssignments)
			throws RemoteException, BbmFinderException, BbmEJBCreateException {
<span class="fc" id="L2980">		Iterator&lt;Collection&lt;WorkResourceAssignment&gt;&gt; itOrgAssignmentCollections = wrkAssignments.iterator();</span>
<span class="fc" id="L2981">		Set setOrgIDs = new HashSet();</span>
<span class="fc bfc" id="L2982" title="All 2 branches covered.">		while (itOrgAssignmentCollections.hasNext()) {</span>
<span class="fc" id="L2983">			Collection&lt;WorkResourceAssignment&gt; nextOrgAssignmentCollection = itOrgAssignmentCollections.next();</span>
<span class="fc" id="L2984">			Iterator&lt;WorkResourceAssignment&gt; itOrgAssignments = nextOrgAssignmentCollection.iterator();</span>
<span class="fc bfc" id="L2985" title="All 2 branches covered.">			while (itOrgAssignments.hasNext()) {</span>
<span class="fc" id="L2986">				ID nextOrgID = itOrgAssignments.next().getOrganizationID();</span>
<span class="fc" id="L2987">				setOrgIDs.add(nextOrgID);</span>
<span class="fc" id="L2988">			}</span>
<span class="fc" id="L2989">		}</span>
<span class="fc" id="L2990">		Collection&lt;Organization&gt; orgs = this.getWorkResourceManager(context, appletResponse, locale).getOrganizationsByIDs(setOrgIDs);</span>
<span class="fc" id="L2991">		Iterator&lt;Organization&gt; itOrgs = orgs.iterator();</span>
<span class="fc" id="L2992">		Map&lt;ID, Organization&gt; mapOrgs = new HashMap(orgs.size());</span>
<span class="fc bfc" id="L2993" title="All 2 branches covered.">		while (itOrgs.hasNext()) {</span>
<span class="fc" id="L2994">			Organization nextOrg = (Organization) itOrgs.next();</span>
<span class="fc" id="L2995">			mapOrgs.put(nextOrg.getID(), nextOrg);</span>
<span class="fc" id="L2996">		}</span>
<span class="fc" id="L2997">		return mapOrgs;</span>
	}

	private EmployeeFilter getEmployeeFilterManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="pc bpc" id="L3001" title="1 of 2 branches missed.">		if (m_empFilterManager == null) {</span>
<span class="fc" id="L3002">			m_empFilterManager = BbmManagerFactory.getEmployeeFilter(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L3004">		return m_empFilterManager;</span>
	}

	private DBConfigManager getDBManager(RequestContext context, Map appletResponse, Locale locale) throws BbmEJBCreateException {
<span class="pc bpc" id="L3008" title="1 of 2 branches missed.">		if (m_dbManager == null) {</span>
<span class="fc" id="L3009">			m_dbManager = BbmManagerFactory.getDBConfigManager(context.isInWhatIfMode());</span>
		}
<span class="fc" id="L3011">		return m_dbManager;</span>
	}


	private LicenseManager getLicenserManager(Map appletResponse, Locale locale) throws CoreEJBCreateException {
<span class="fc bfc" id="L3016" title="All 2 branches covered.">		if (m_licenseManager == null) {</span>
<span class="fc" id="L3017">			m_licenseManager = CoreManagerFactory.getLicenseManager();</span>
		}
<span class="fc" id="L3019">		return m_licenseManager;</span>
	}


	private Collection&lt;ID&gt; getEmployeeIDsByFilter(RequestContext context, Map appletResponse, Locale locale, User user, String empFilterName, Filter filter) throws Exception {
<span class="nc" id="L3024">		Collection&lt;ID&gt; employeeIDs = null;</span>
<span class="nc bnc" id="L3025" title="All 4 branches missed.">		if (empFilterName != null &amp;&amp; empFilterName.length() &gt; 0) {</span>
<span class="nc" id="L3026">			employeeIDs = getEmployeeFilterManager(context, appletResponse, locale).getEmployeeIDs(user, empFilterName, filter, Filter.LASTNAME, true, 0, Integer.MAX_VALUE);</span>
		} else {
<span class="nc" id="L3028">			employeeIDs = getEmployeeFilterManager(context, appletResponse, locale).getEmployeeIDs(filter, user, Filter.LASTNAME, true, 0, Integer.MAX_VALUE);</span>
		}
<span class="nc" id="L3030">		return employeeIDs;</span>
	}

	private Map getEmpOrgAssignments(RequestContext context, Map appletResponse, Locale locale, Collection employeeIDs, Date startDate, Date endDate) throws Exception {
<span class="fc" id="L3034">		Map empOrgAssignments = new HashMap(employeeIDs.size());</span>
<span class="fc" id="L3035">		empOrgAssignments = getWorkResourceManager(context, appletResponse, locale).getValidWorkResourceAssignments(</span>
				employeeIDs, 
<span class="fc" id="L3037">				new LocalDate(startDate, TimeZone.getTimeZone(&quot;GMT&quot;)), </span>
<span class="fc" id="L3038">				new LocalDate(endDate, TimeZone.getTimeZone(&quot;GMT&quot;)), </span>
				false);

<span class="fc" id="L3041">		return empOrgAssignments;</span>
	}


	private Map getSPSchedulingParameters(RequestContext context, Map appletResponse, Locale locale, Date date, ID spID, ID campaignID) 
			throws BbmFinderException, BbmEJBCreateException, RemoteException {
<span class="fc" id="L3047">		Map parameters = null;</span>
<span class="fc" id="L3048">		parameters = getCampaignManager(context, appletResponse, locale).getSchedulingParameters(spID);</span>
<span class="pc bpc" id="L3049" title="2 of 4 branches missed.">		if (parameters == null || parameters.size() == 0) {</span>
<span class="nc" id="L3050">			ID mostRecentSPID = getCampaignManager(context, appletResponse, locale).getMostRecentSPWithParameters(date, campaignID);</span>
<span class="nc bnc" id="L3051" title="All 2 branches missed.">			if (mostRecentSPID == null) {</span>
<span class="nc" id="L3052">				return new HashMap();</span>
			}
<span class="nc" id="L3054">			parameters = getCampaignManager(context, appletResponse, locale).getSchedulingParameters(mostRecentSPID);</span>
		}
<span class="fc" id="L3056">		return parameters;</span>
	}

	/**
	 * This method does not query the database. We only return a list with a single queue (ID=-1) in it! 
	 * @param appletResponse
	 * @param locale
	 * @param campaignID
	 * @return
	 * @throws Exception
	 */
	private Collection getCombinedAllQueue(Map appletResponse, Locale locale, ID campaignID) throws Exception  {
<span class="nc" id="L3068">		ArrayList queuesInCampaign = new ArrayList(1);</span>
<span class="nc" id="L3069">		Queue queue = new Queue();</span>
<span class="nc" id="L3070">		queue.setID(new ID(-1));</span>
<span class="nc" id="L3071">		queue.setParentID(campaignID);</span>
<span class="nc" id="L3072">		queuesInCampaign.add(queue);</span>
		
<span class="nc" id="L3074">		return queuesInCampaign;</span>
	}

	protected void processAppletRequest(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="fc" id="L3078">		super.processAppletRequest(context, appletRequest, appletResponse);</span>
<span class="fc" id="L3079">		this.processGetData(context, appletRequest, appletResponse);</span>
<span class="fc" id="L3080">		this.processCustomRequest(context, appletRequest, appletResponse);</span>
<span class="fc" id="L3081">	}</span>

	/**
	 * It appears that this returns a map with NullablePair&lt;MediaId, QueueID&gt; for the key mapped to a trace Cube with:
	 * 		the Forecasted Schedule Value, 
	 * 		and Required values that are set to the FTE Differential values.
	 * 
	 * The key is (null, null) for the &quot;combined combined&quot; queue
	 * The key is (mediaId, null) for the &quot;combined&quot; media queue
	 * The key is (mediaId, queueId) for an individual queue
	 *
	 */
	private List&lt;Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt;&gt; getStatisticRibbons(RequestContext context, Map appletResponse, Locale locale, SchedulingPeriod sp,
			Collection&lt;SPQueue&gt; spQueues) throws BbmFinderException, BbmEJBCreateException, RemoteException, CoreEJBCreateException, BbmTimeSeriesException {
<span class="fc" id="L3095">		List&lt;Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt;&gt; listLineTypes = new ArrayList();</span>

<span class="fc" id="L3097">		WorkloadManager workloadManager = getWorkloadManager(context, appletResponse, locale);</span>
<span class="fc" id="L3098">		boolean hasAppMediaOutboundLicense = getLicenserManager(appletResponse, locale).isLicensed(LicenseKeys.APP_MEDIA_OUTBOUND);</span>

<span class="fc" id="L3100">		SPQueueTraceCubeData spQueueData = new SPQueueTraceCubeData(sp, spQueues, hasAppMediaOutboundLicense);</span>
<span class="fc" id="L3101">		Collection&lt;ID&gt; qIDs = ValueObjectUtil.getFieldObjectCol(SPQueueFieldInfo.SPQUEUE_QUEUEID, spQueues);</span>
<span class="fc" id="L3102">		spQueueData.init(workloadManager.getQueuesByIDs(qIDs));</span>
		
<span class="fc" id="L3104">		appletResponse.put(PageKeys.IS_SKILLED_SP, sp.getSkillBased());</span>

<span class="fc" id="L3106">		TrackingManager trackingManager = getTrackingManager(context, appletResponse, locale);</span>

<span class="fc bfc" id="L3108" title="All 2 branches covered.">		if (spQueueData.isComplexSP()) {</span>
<span class="fc" id="L3109">			populateTraceCubeForComplexSP(context, spQueueData, trackingManager);</span>
		} else {
<span class="fc" id="L3111">			populateTraceCubeForAllQs(spQueueData, trackingManager, workloadManager);</span>
		}
		
<span class="fc" id="L3114">		listLineTypes.add(spQueueData.getMapQueueRibbons());</span>
<span class="fc" id="L3115">		listLineTypes.add(spQueueData.getMapQueueRibbonsRequiredLine());</span>
<span class="fc bfc" id="L3116" title="All 2 branches covered.">		if (!spQueueData.getMapQueueRibbonsNoPhantomLine().isEmpty()) {</span>
<span class="fc" id="L3117">			listLineTypes.add(spQueueData.getMapQueueRibbonsNoPhantomLine());</span>
		}
		
<span class="fc" id="L3120">		return listLineTypes;</span>
	}

	private void populateTraceCubeForComplexSP(RequestContext context, SPQueueTraceCubeData spQueueData, 
			TrackingManager trackingMgr) throws BbmFinderException, RemoteException, BbmTimeSeriesException {
		//For Orange, only load selected Q instead of all Qs
<span class="fc" id="L3126">		String strQID = context.getUserProperty(PageKeys.FS_WEB_SELECTED_QUEUE);</span>
<span class="pc bpc" id="L3127" title="1 of 2 branches missed.">		ID selectedQID = StringUtil.isEmpty(strQID)? null : new ID(strQID);</span>
<span class="fc" id="L3128">		String strMediaID =  context.getUserProperty(PageKeys.FS_WEB_SELECTED_MEDIA);</span>
<span class="pc bpc" id="L3129" title="1 of 2 branches missed.">		ID selectedMediaID = StringUtil.isEmpty(strMediaID) ? null : new ID(strMediaID);</span>
<span class="fc" id="L3130">		SchedulingPeriod sp = spQueueData.getSp();</span>
<span class="fc" id="L3131">		Date adjustedEndDate = new Date(sp.getEndTime().getTime() - 60000);</span>
		
<span class="pc bpc" id="L3133" title="1 of 2 branches missed.">		if (selectedQID != null) {</span>
<span class="nc bnc" id="L3134" title="All 2 branches missed.">			if (!spQueueData.getIdQueueMap().containsKey(selectedQID)) {</span>
<span class="nc" id="L3135">				selectedQID = null;</span>
<span class="nc" id="L3136">				selectedMediaID = null;</span>
			}
		}
		
<span class="fc" id="L3140">		TrackingView tv = spQueueData.getTv();</span>
<span class="fc" id="L3141">		TrackingView tvNoPhantom = spQueueData.getTvNoPhantom();</span>

		//Get Combined Combined Queue
<span class="fc" id="L3144">		HashMap&lt;ID, TraceCube[]&gt; mapQueueCubes = null;</span>
<span class="fc" id="L3145">		HashMap&lt;ID, TraceCube[]&gt; mapQueueCubesNoPhantoms = null;</span>
		
<span class="pc bpc" id="L3147" title="2 of 4 branches missed.">		if (selectedMediaID == null &amp;&amp; selectedQID == null) { </span>
			//combine combine
<span class="fc" id="L3149">			mapQueueCubes = trackingMgr.getCombineTraceCubesByTrackingView(tv, sp.getCampaignID(), </span>
<span class="pc bpc" id="L3150" title="1 of 2 branches missed.">				sp.getSkillBased() ? null : Media.MEDIA_ID_PHONE, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc" id="L3151">			mapQueueCubesNoPhantoms = trackingMgr.getCombineTraceCubesByTrackingView(tvNoPhantom, sp.getCampaignID(),</span>
<span class="pc bpc" id="L3152" title="1 of 2 branches missed.">				sp.getSkillBased() ? null : Media.MEDIA_ID_PHONE, sp.getStartTime(), adjustedEndDate);</span>
		}
<span class="pc bpc" id="L3154" title="3 of 4 branches missed.">		if (selectedMediaID != null &amp;&amp; selectedQID == null) {</span>
<span class="nc" id="L3155">			mapQueueCubes = trackingMgr.getCombineTraceCubesByTrackingView(tv, sp.getCampaignID(), selectedMediaID, sp.getStartTime(),</span>
				adjustedEndDate);
<span class="nc" id="L3157">			mapQueueCubesNoPhantoms = trackingMgr.getCombineTraceCubesByTrackingView(tvNoPhantom, sp.getCampaignID(), selectedMediaID, </span>
<span class="nc" id="L3158">				sp.getStartTime(), adjustedEndDate);</span>
		}
<span class="pc bpc" id="L3160" title="2 of 4 branches missed.">		if (selectedMediaID == null &amp;&amp; selectedQID != null) {</span>
<span class="nc" id="L3161">			mapQueueCubes = trackingMgr.getTraceCubesByTrackingView(tv, sp.getCampaignID(), new ArrayList(Arrays.asList(selectedQID)),</span>
<span class="nc" id="L3162">				sp.getStartTime(), adjustedEndDate);</span>
<span class="nc" id="L3163">			mapQueueCubesNoPhantoms = trackingMgr.getTraceCubesByTrackingView(tvNoPhantom, sp.getCampaignID(), </span>
<span class="nc" id="L3164">				new ArrayList(Arrays.asList(selectedQID)), sp.getStartTime(), adjustedEndDate);</span>
<span class="nc" id="L3165">			Queue q = spQueueData.getIdQueueMap().get(selectedQID);</span>
<span class="nc" id="L3166">			selectedMediaID = q.getMediaID();</span>
		}
<span class="pc bpc" id="L3168" title="1 of 2 branches missed.">		if (mapQueueCubes != null) {</span>
<span class="fc bfc" id="L3169" title="All 2 branches covered.">			for (Map.Entry&lt;ID, TraceCube[]&gt; entry: mapQueueCubes.entrySet()) {</span>
<span class="fc" id="L3170">				Pair&lt;TraceCube, TraceCube&gt; consolidatedCube = getRibbonTraceCube(entry, tv, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc" id="L3171">				spQueueData.getMapQueueRibbons().put(new NullablePair&lt;ID, ID&gt;(selectedMediaID, selectedQID), consolidatedCube.getFirst());</span>
<span class="fc" id="L3172">				spQueueData.getMapQueueRibbonsRequiredLine().put(new NullablePair&lt;ID, ID&gt;(selectedMediaID, selectedQID), consolidatedCube.getSecond());</span>
<span class="fc" id="L3173">			}</span>
		}
<span class="pc bpc" id="L3175" title="1 of 2 branches missed.">		if (mapQueueCubesNoPhantoms != null) {</span>
<span class="fc bfc" id="L3176" title="All 2 branches covered.">			for (Map.Entry&lt;ID, TraceCube[]&gt; entry: mapQueueCubesNoPhantoms.entrySet()) {</span>
<span class="fc" id="L3177">				Pair&lt;TraceCube, TraceCube&gt; consolidatedCube = getRibbonTraceCube(entry, tvNoPhantom, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc bfc" id="L3178" title="All 2 branches covered.">				if (!isAllNullPredicedValues((AggrForecastedTraceCube)consolidatedCube.getFirst())) {</span>
<span class="fc" id="L3179">					spQueueData.getMapQueueRibbonsNoPhantomLine().put(new NullablePair&lt;ID, ID&gt;(null, null), consolidatedCube.getFirst());</span>
				}
<span class="fc" id="L3181">			}</span>
		}
<span class="fc" id="L3183">	}</span>
	private void populateTraceCubeForAllQs(SPQueueTraceCubeData spQueueData, TrackingManager trackingMgr, WorkloadManager workloadMgr)
		throws BbmFinderException, RemoteException, BbmTimeSeriesException, BbmEJBCreateException {

<span class="fc" id="L3187">		SchedulingPeriod sp = spQueueData.getSp();</span>
<span class="fc" id="L3188">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; mapQueueRibbons = spQueueData.getMapQueueRibbons();</span>
<span class="fc" id="L3189">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; mapQueueRibbonsRequiredLine = spQueueData.getMapQueueRibbonsRequiredLine();</span>
<span class="fc" id="L3190">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; mapQueueRibbonsNoPhantomLine = spQueueData.getMapQueueRibbonsNoPhantomLine();</span>
<span class="fc" id="L3191">		TrackingView tv = spQueueData.getTv();</span>
<span class="fc" id="L3192">		TrackingView tvNoPhantom = spQueueData.getTvNoPhantom();</span>
<span class="fc" id="L3193">		Date adjustedEndDate = new Date(sp.getEndTime().getTime() - 60000);</span>
		
		//Get Combined Combined Queue
<span class="fc" id="L3196">		Map&lt;ID, TraceCube[]&gt; combinedCube = trackingMgr.getCombineTraceCubesByTrackingView(tv,</span>
<span class="fc bfc" id="L3197" title="All 2 branches covered.">			sp.getCampaignID(), sp.getSkillBased() ? null : Media.MEDIA_ID_PHONE, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc" id="L3198">		Map.Entry&lt;ID, TraceCube[]&gt; entry = combinedCube.entrySet().iterator().next();</span>
<span class="fc" id="L3199">		Pair &lt;TraceCube, TraceCube&gt; consolidatedCube = getRibbonTraceCube(entry, tv, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc" id="L3200">		mapQueueRibbons.put(new NullablePair&lt;ID, ID&gt;(null, null), consolidatedCube.getFirst());</span>
<span class="fc" id="L3201">		mapQueueRibbonsRequiredLine.put(new NullablePair&lt;ID, ID&gt;(null, null), consolidatedCube.getSecond());</span>

		//Get Combined Combined Queue for No Phantoms
<span class="fc" id="L3204">		combinedCube = trackingMgr.getCombineTraceCubesByTrackingView(tvNoPhantom,</span>
<span class="fc bfc" id="L3205" title="All 2 branches covered.">			sp.getCampaignID(), sp.getSkillBased() ? null : Media.MEDIA_ID_PHONE, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc" id="L3206">		entry = combinedCube.entrySet().iterator().next();</span>
<span class="fc" id="L3207">		consolidatedCube = getRibbonTraceCube(entry, tvNoPhantom, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc bfc" id="L3208" title="All 2 branches covered.">		if (!isAllNullPredicedValues((AggrForecastedTraceCube)consolidatedCube.getFirst())) {</span>
<span class="fc" id="L3209">			mapQueueRibbonsNoPhantomLine.put(new NullablePair&lt;ID, ID&gt;(null, null), consolidatedCube.getFirst());</span>
		}

		//Get Combined Media Queues
<span class="fc bfc" id="L3213" title="All 2 branches covered.">		for (ID mediaId : spQueueData.getMediaIDCollection()) {</span>
<span class="fc" id="L3214">			Map&lt;ID, TraceCube[]&gt; combinedMediaCube = trackingMgr.getCombineTraceCubesByTrackingView(tv,</span>
<span class="fc" id="L3215">				sp.getCampaignID(),	mediaId, sp.getStartTime(),	adjustedEndDate);</span>
<span class="fc" id="L3216">			entry = combinedMediaCube.entrySet().iterator().next();</span>
<span class="fc" id="L3217">			consolidatedCube = getRibbonTraceCube(entry, tv, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc" id="L3218">			mapQueueRibbons.put(new NullablePair&lt;ID, ID&gt;(mediaId, null), consolidatedCube.getFirst());</span>
<span class="fc" id="L3219">			mapQueueRibbonsRequiredLine.put(new NullablePair&lt;ID, ID&gt;(mediaId, null), consolidatedCube.getSecond());</span>
<span class="fc" id="L3220">		}</span>

		//Get Combined Media Queues for No Phantoms
<span class="fc bfc" id="L3223" title="All 2 branches covered.">		for (ID mediaId : spQueueData.getMediaIDCollection()) {</span>
<span class="fc" id="L3224">			Map&lt;ID, TraceCube[]&gt; combinedMediaCube = trackingMgr.getCombineTraceCubesByTrackingView(tvNoPhantom,</span>
<span class="fc" id="L3225">				sp.getCampaignID(),	mediaId, sp.getStartTime(),	adjustedEndDate);</span>
<span class="fc" id="L3226">			entry = combinedMediaCube.entrySet().iterator().next();</span>
<span class="fc" id="L3227">			consolidatedCube = getRibbonTraceCube(entry, tvNoPhantom, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc bfc" id="L3228" title="All 2 branches covered.">			if (!isAllNullPredicedValues((AggrForecastedTraceCube)consolidatedCube.getFirst())) {</span>
<span class="fc" id="L3229">				mapQueueRibbonsNoPhantomLine.put(new NullablePair&lt;ID, ID&gt;(mediaId, null), consolidatedCube.getFirst());</span>
			}
<span class="fc" id="L3231">		}</span>

		//Get Each individual Queue
<span class="fc" id="L3234">		Map&lt;ID, TraceCube[]&gt; mapQueueCubes = trackingMgr.getTraceCubesByTrackingView(tv,</span>
<span class="fc" id="L3235">			sp.getCampaignID(), spQueueData.getQueueIDCollection(), sp.getStartTime(), adjustedEndDate);</span>
<span class="pc bpc" id="L3236" title="1 of 2 branches missed.">		if (mapQueueCubes != null) {</span>
<span class="fc bfc" id="L3237" title="All 2 branches covered.">			for (Iterator&lt;Map.Entry&lt;ID, TraceCube[]&gt;&gt; i = mapQueueCubes.entrySet().iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L3238">				entry = i.next();</span>
<span class="fc" id="L3239">				consolidatedCube = getRibbonTraceCube(entry, tv, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc" id="L3240">				Queue queue = workloadMgr.getQueueByID(entry.getKey());</span>
<span class="fc" id="L3241">				mapQueueRibbons.put(new NullablePair&lt;ID, ID&gt;(queue.getMediaID(), entry.getKey()), consolidatedCube.getFirst());</span>
<span class="fc" id="L3242">				mapQueueRibbonsRequiredLine.put(new NullablePair&lt;ID, ID&gt;(queue.getMediaID(), entry.getKey()), consolidatedCube.getSecond());</span>
<span class="fc" id="L3243">			}</span>
		}

		//Get Each individual Queue for No Phantoms
<span class="fc" id="L3247">		mapQueueCubes = trackingMgr.getTraceCubesByTrackingView(tvNoPhantom,</span>
<span class="fc" id="L3248">			sp.getCampaignID(), spQueueData.getQueueIDCollection(), sp.getStartTime(), adjustedEndDate);</span>
<span class="pc bpc" id="L3249" title="1 of 2 branches missed.">		if (mapQueueCubes != null) {</span>
<span class="fc bfc" id="L3250" title="All 2 branches covered.">			for (Iterator&lt;Map.Entry&lt;ID, TraceCube[]&gt;&gt; i = mapQueueCubes.entrySet().iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L3251">				entry = i.next();</span>
<span class="fc" id="L3252">				consolidatedCube = getRibbonTraceCube(entry, tvNoPhantom, sp.getStartTime(), adjustedEndDate);</span>
<span class="fc bfc" id="L3253" title="All 2 branches covered.">				if (!isAllNullPredicedValues((AggrForecastedTraceCube)consolidatedCube.getFirst())) {</span>
<span class="fc" id="L3254">					Queue queue = workloadMgr.getQueueByID(entry.getKey());</span>
<span class="fc" id="L3255">					mapQueueRibbonsNoPhantomLine.put(new NullablePair&lt;ID, ID&gt;(queue.getMediaID(), entry.getKey()), consolidatedCube.getFirst());</span>
<span class="fc" id="L3256">				}</span>
			}
		}
<span class="fc" id="L3259">	}</span>
	
	/**
	 * Checks to see if all of the trace values in the given AggrForecastedTraceCube are null.
	 * @param tc
	 */
	public boolean isAllNullPredicedValues(AggrForecastedTraceCube tc) {
<span class="pc bpc" id="L3266" title="1 of 2 branches missed.">		if (tc != null) {</span>
<span class="fc" id="L3267">			PredictTraceCube ptc = tc.getPredictTrace();</span>
<span class="pc bpc" id="L3268" title="1 of 2 branches missed.">			if (ptc != null) {</span>
<span class="fc" id="L3269">				return ptc.isAllNull();</span>
			}
		}
<span class="nc" id="L3272">		return true;</span>
	}
	
	/**
	 * Retrieve the consolidated TraceCube from sourceCubes
	 * 
	 * During consolidation it appears to set the Required values to the FTE Differential values???
	 * 
	 * @param entry
	 * @param tv
	 * @param startDate
	 * @param endDate
	 * @throws BbmTimeSeriesException
	 */
	private Pair&lt;TraceCube, TraceCube&gt; getRibbonTraceCube(Map.Entry&lt;ID, TraceCube[]&gt; entry, TrackingView tv, Date startDate, Date endDate)
		throws BbmTimeSeriesException {
<span class="fc" id="L3288">		TraceCube[] serverCubes = entry.getValue(); </span>
		//it has predict and forcast cubes, has to merge them together
<span class="fc" id="L3290">		TraceCube[] uiCubes = PulseUtil.createUICubes(tv, entry.getKey(), startDate, endDate);</span>
<span class="pc bpc" id="L3291" title="1 of 2 branches missed.">		if (uiCubes != null) {</span>
			// init the actual TraceCube
<span class="fc" id="L3293">			PulseUtil.initTraceCube(uiCubes[0]);					</span>
		}
<span class="fc" id="L3295">		PulseUtil.mergeTraceCubes(uiCubes, serverCubes);</span>
			
<span class="fc" id="L3297">		TraceCube forecastCube = uiCubes[1];</span>
<span class="fc" id="L3298">		TraceCube requiredCube = uiCubes[2];</span>
		
<span class="fc" id="L3300">		return new Pair(forecastCube, requiredCube);</span>
	}

	
	//to show a ot event on calendar, an event place holder will be created
	//but before updating shift, the event holder should be removed since ot is never
	//saved in format of shift event
	private void removeOTEventHolderBeforeSave(ShiftAssignment shift) {
<span class="fc" id="L3308">		Collection newEvents = shift.getCreatedChildObjects(ShiftAssignmentFields.CHILD_SHIFT_EVENT);</span>
<span class="pc bpc" id="L3309" title="1 of 4 branches missed.">		if (newEvents != null &amp;&amp; !newEvents.isEmpty()) {</span>
<span class="fc" id="L3310">			ShiftEventAssignment event =  null;</span>
<span class="fc bfc" id="L3311" title="All 2 branches covered.">			for (Iterator i = newEvents.iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L3312">				event = (ShiftEventAssignment)i.next();</span>
<span class="pc bpc" id="L3313" title="1 of 4 branches missed.">				if (event.getID() == null &amp;&amp; event.getShiftEventID() == null &amp;&amp;</span>
<span class="pc bpc" id="L3314" title="2 of 4 branches missed.">						(event.getOverlayPrecedence() == OVERLAP_PRECEDENCE || event.getOverlayPrecedence()== SWAP_PRECEDENCE)) {</span>
					//2 is for ote before and after place holder event
					//100 is for swap indicators
<span class="nc" id="L3317">					i.remove();</span>
				}

			}
		}

<span class="fc" id="L3323">		newEvents = shift.getUpdatedChildObjects(ShiftAssignmentFields.CHILD_SHIFT_EVENT);</span>
<span class="pc bpc" id="L3324" title="1 of 4 branches missed.">		if (newEvents != null &amp;&amp; !newEvents.isEmpty()) {</span>
<span class="fc" id="L3325">			ShiftEventAssignment event =  null;</span>
<span class="fc bfc" id="L3326" title="All 2 branches covered.">			for (Iterator i = newEvents.iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L3327">				event = (ShiftEventAssignment)i.next();</span>
<span class="pc bpc" id="L3328" title="1 of 4 branches missed.">				if (event.getID() == null &amp;&amp; event.getShiftEventID() == null &amp;&amp;</span>
<span class="pc bpc" id="L3329" title="3 of 4 branches missed.">						(event.getOverlayPrecedence()== OVERLAP_PRECEDENCE || event.getOverlayPrecedence() == SWAP_PRECEDENCE)) {</span>
					//2 is for ote before and after place holder event
					//100 is for swap indicators
<span class="fc" id="L3332">					i.remove();</span>
				}

			}
		}

<span class="fc" id="L3338">		Map childrenMap = shift.getChildObjectMap();</span>
<span class="pc bpc" id="L3339" title="1 of 2 branches missed.">		if (childrenMap != null){</span>
<span class="fc" id="L3340">			Object events = childrenMap.get(NumberFactory.newInteger(ShiftAssignmentFields.CHILD_SHIFT_EVENT));</span>
<span class="pc bpc" id="L3341" title="1 of 4 branches missed.">			if (events != null &amp;&amp; !((Map)events).isEmpty()) {</span>
<span class="fc" id="L3342">				Collection objs = ((Map) events).values();</span>
<span class="fc" id="L3343">				ShiftEventAssignment event =  null;</span>
<span class="fc bfc" id="L3344" title="All 2 branches covered.">				for (Iterator i = objs.iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L3345">					event = (ShiftEventAssignment)i.next();</span>
<span class="pc bpc" id="L3346" title="3 of 4 branches missed.">					if (event.getID() == null &amp;&amp; event.getShiftEventID() == null &amp;&amp;</span>
<span class="nc bnc" id="L3347" title="All 4 branches missed.">							(event.getOverlayPrecedence()== OVERLAP_PRECEDENCE || event.getOverlayPrecedence()== SWAP_PRECEDENCE)) {</span>
						//2 is for ote before and after place holder event
						//100 is for swap indicators
<span class="nc" id="L3350">						i.remove();</span>
					}

				}
			}
		}
<span class="fc" id="L3356">	}</span>


	/**
	 * Gets all of the verticalized strings needed by the Calendar applet.
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 * @param locale
	 * @return A HashMap of PulseKey -&gt; VerticalizedString. The PulseKey keys identify keys 
	 * in the PulseKeys class, while the VerticalizedString values are the verticalized/localized 
	 * strings. 
	 */
	private Map getVerticalizedStrings(RequestContext context, Map appletRequest, Map appletResponse, Locale locale) {
<span class="fc" id="L3370">		Map resultMap = new HashMap(10);</span>
<span class="fc" id="L3371">		VerticalizationManager vm = context.getSystemManagerFactory().getVerticalizationManager(); </span>

<span class="fc" id="L3373">		resultMap.put(PulseKeys.CONTACTVOLUME, </span>
<span class="fc" id="L3374">				vm.getVerticalizedString(context, VerticalizationWebBundleKey.BUNDLE_NAME, DefaultVerticalizationManager.CONTACTVOLUME));</span>
<span class="fc" id="L3375">		resultMap.put(PulseKeys.AVERAGEHANDLETIME, </span>
<span class="fc" id="L3376">				vm.getVerticalizedString(context, VerticalizationWebBundleKey.BUNDLE_NAME, DefaultVerticalizationManager.AVERAGEHANDLETIME));</span>
<span class="fc" id="L3377">		resultMap.put(PulseKeys.FILTERBOX_CAMPAIGN,</span>
<span class="fc" id="L3378">				vm.getVerticalizedString(context, BbmWebBundleKey.BUNDLE_NAME,  BbmWebBundleKey.FILTERBOX_CAMPAIGN) );</span>
<span class="fc" id="L3379">		resultMap.put(PulseKeys.CAMPAIGN_SP_SELECTOR_NO_CAMPAIGN_OPTION,</span>
<span class="fc" id="L3380">				vm.getVerticalizedString(context, BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.CAMPAIGN_SP_SELECTOR_NO_CAMPAIGN_OPTION) );</span>


<span class="fc" id="L3383">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_PROJECT,</span>
<span class="fc" id="L3384">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_PROJECT) );</span>

<span class="fc" id="L3386">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_PROJECT_FORECASTED,</span>
<span class="fc" id="L3387">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_PROJECT_FORECASTED) );</span>

<span class="fc" id="L3389">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_PROJECT_REQUIRED,</span>
<span class="fc" id="L3390">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_PROJECT_REQUIRED) );</span>


<span class="fc" id="L3393">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_FTE,</span>
<span class="fc" id="L3394">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_FTE) );</span>

<span class="fc" id="L3396">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_FTED,</span>
<span class="fc" id="L3397">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_FTED) );</span>


<span class="fc" id="L3400">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_FTE_FORECASTED,</span>
<span class="fc" id="L3401">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_FTE_FORECASTED) );</span>

<span class="fc" id="L3403">		resultMap.put(PulseKeys.FS_SERVICERIBBONS_FTE_REQUIRED,</span>
<span class="fc" id="L3404">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SERVICERIBBONS_FTE_REQUIRED) );</span>

<span class="fc" id="L3406">		resultMap.put(PulseKeys.FS_FTECALC_PROJECT_QUEUE_NAME,</span>
<span class="fc" id="L3407">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_FTECALC_PROJECT_QUEUE_NAME) );</span>

<span class="fc" id="L3409">		resultMap.put(PulseKeys.FS_CLEARSCHED_TYPE_PROJECT,</span>
<span class="fc" id="L3410">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_CLEARSCHED_TYPE_PROJECT) );</span>

<span class="fc" id="L3412">		resultMap.put(PulseKeys.FS_LOCKMULTI_PROJECTS,</span>
<span class="fc" id="L3413">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_LOCKMULTI_PROJECTS) );</span>

<span class="fc" id="L3415">		resultMap.put(BbmEjbBundleKey.FS_CAL_CONFLICTSGROUP_CAMPAIGNHOO,</span>
<span class="fc" id="L3416">				vm.getVerticalizedString(context, BbmEjbBundleKey.BUNDLE_NAME, BbmEjbBundleKey.FS_CAL_CONFLICTSGROUP_CAMPAIGNHOO) );</span>

<span class="fc" id="L3418">		resultMap.put(BbmEjbBundleKey.CAMPAIGN_HOO,</span>
<span class="fc" id="L3419">				vm.getVerticalizedString(context, BbmEjbBundleKey.BUNDLE_NAME, BbmEjbBundleKey.CAMPAIGN_HOO) );</span>


<span class="fc" id="L3422">		resultMap.put(FsWebBundleKey.FS_CAL_TOOLBAR_TOOLTIP_CAMPAIGNTIMEZONE,</span>
<span class="fc" id="L3423">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_CAL_TOOLBAR_TOOLTIP_CAMPAIGNTIMEZONE) );</span>


<span class="fc" id="L3426">		resultMap.put(BbmWebBundleKey.SubCampaign,</span>
<span class="fc" id="L3427">				vm.getVerticalizedString(context, BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.SubCampaign) );</span>


		// Added 11.2
		// Scheduler dialog
<span class="fc" id="L3432">		resultMap.put(FsWebBundleKey.FS_SCHEDPARAMS_ALG_SCHEDULEATLEAST,</span>
<span class="fc" id="L3433">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SCHEDPARAMS_ALG_SCHEDULEATLEAST) );</span>

<span class="fc" id="L3435">		resultMap.put(FsWebBundleKey.FS_SCHEDPARAMS_AGENTSTOSCHED,</span>
<span class="fc" id="L3436">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SCHEDPARAMS_AGENTSTOSCHED) );</span>

<span class="fc" id="L3438">		resultMap.put(FsWebBundleKey.FS_SCHEDPARAMS_AGENTPREF_TITLE,</span>
<span class="fc" id="L3439">				vm.getVerticalizedString(context, FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SCHEDPARAMS_AGENTPREF_TITLE) );</span>


<span class="fc" id="L3442">		return resultMap;</span>
	}

	/**
	 * Given a distributed parent SP, return the child SPIDs.
	 * @throws RemoteException 
	 * @throws BbmEJBCreateException 
	 * @throws BbmFinderException 
	 */
	private Set getChildSPIDs(RequestContext context, ID spID, Campaign campaign, Date startDate, Date endDate, 
			Locale locale, Map appletResponse, String msgID) throws BbmFinderException, BbmEJBCreateException, RemoteException {
<span class="fc" id="L3453">		Set childSPIDs = new HashSet();</span>

<span class="pc bpc" id="L3455" title="2 of 4 branches missed.">		if (campaign != null &amp;&amp; campaign.getIsDistributed()) {</span>
			//get the employees from the sub-campaigns					
<span class="fc" id="L3457">			Collection childCampaigns = getCampaignManager(context, appletResponse, locale).getSubCampaignIDs(campaign.getID());</span>
<span class="fc bfc" id="L3458" title="All 2 branches covered.">			for (Iterator it=childCampaigns.iterator(); it.hasNext();) {</span>
<span class="fc" id="L3459">				ID curCampaignID = (ID)it.next();</span>
<span class="fc" id="L3460">				Collection sps = getCampaignManager(context, appletResponse, locale).getSchedulingPeriods(curCampaignID, startDate, endDate);</span>
<span class="pc bpc" id="L3461" title="2 of 4 branches missed.">				if (sps != null &amp;&amp; sps.size()&gt;0) {</span>
<span class="pc bpc" id="L3462" title="1 of 2 branches missed.">					for (Iterator spit=sps.iterator(); spit.hasNext();) {</span>
<span class="fc" id="L3463">						ID curSpID = ((SchedulingPeriod)spit.next()).getID(); </span>
<span class="fc" id="L3464">						childSPIDs.add(curSpID);</span>
<span class="fc" id="L3465">						break; //there should only be a single SP per child campaign because of our date range.</span>
					}
				}
<span class="fc" id="L3468">			}</span>
		}
<span class="fc" id="L3470">		return childSPIDs;</span>
	}
	
	
	/**
	 * Get all the employee/phantom ID's assigned to an SP. If this is a parent 
	 * SP, we include all employees assigned to the children SP's.
	 * @throws Exception 
	 */
	private List getSpEmployeeIDs(RequestContext context, ID spID, Campaign campaign, Date startDate, Date endDate, 
			Locale locale, Map appletResponse, String msgID) throws Exception {
<span class="fc" id="L3481">		Set employeeIDs = new HashSet();</span>

<span class="fc" id="L3483">		boolean isDistributed = false;</span>
<span class="pc bpc" id="L3484" title="1 of 2 branches missed.">		if (campaign != null) {</span>
<span class="fc" id="L3485">			isDistributed = campaign.getIsDistributed();</span>
<span class="fc bfc" id="L3486" title="All 2 branches covered.">			if (isDistributed) {</span>
				//get the employees from the sub-campaigns					
<span class="fc" id="L3488">				Collection childCampaigns = getCampaignManager(context, appletResponse, locale).getSubCampaignIDs(campaign.getID());</span>
<span class="fc bfc" id="L3489" title="All 2 branches covered.">				for (Iterator it=childCampaigns.iterator(); it.hasNext();) {</span>
<span class="fc" id="L3490">					ID curCampaignID = (ID)it.next();</span>
<span class="fc" id="L3491">					Collection sps = getCampaignManager(context, appletResponse, locale).getSchedulingPeriods(curCampaignID, startDate, endDate);</span>
<span class="pc bpc" id="L3492" title="2 of 4 branches missed.">					if (sps != null &amp;&amp; sps.size()&gt;0) {</span>
<span class="pc bpc" id="L3493" title="1 of 2 branches missed.">						for (Iterator spit=sps.iterator(); spit.hasNext();) {</span>
<span class="fc" id="L3494">							ID curSpID = ((SchedulingPeriod)spit.next()).getID(); </span>
<span class="fc" id="L3495">							employeeIDs.addAll(getEmployeeIDsForSingleSP(context, curSpID, curCampaignID, startDate, endDate, locale, appletResponse, msgID));</span>
<span class="fc" id="L3496">							break; //there should only be a single SP per child campaign because of our date range.</span>
						}
					}
<span class="fc" id="L3499">				}</span>
			}
		}

<span class="fc bfc" id="L3503" title="All 2 branches covered.">		if (!isDistributed) {</span>
<span class="fc" id="L3504">			employeeIDs.addAll(getEmployeeIDsForSingleSP(context, spID, campaign.getID(), startDate, endDate, locale, appletResponse, msgID));</span>
		}

<span class="fc" id="L3507">		return new ArrayList(employeeIDs);</span>
	}

	/**
	 * Get all the employee/phantom ID's assigned to a single SP. If this is a parent 
	 * SP, we do not query its children.
	 */
	private Collection getEmployeeIDsForSingleSP(RequestContext context, ID spID, ID campaignID, Date startDate, Date endDate, 
			Locale locale, Map appletResponse, String msgID) throws Exception {
<span class="fc" id="L3516">		Collection employeeIDs = new ArrayList();</span>

<span class="fc" id="L3518">		Collection campWorkResources = getCampaignManager(context, appletResponse, locale).getCampaignWorkResourceAssignments(campaignID, startDate, endDate);</span>
<span class="fc" id="L3519">		Collection cPhantoms = getScheduleAccessManager(context, appletResponse, locale).getPhantoms(spID);</span>
<span class="pc bpc" id="L3520" title="1 of 2 branches missed.">		if (campWorkResources != null) {</span>
<span class="fc bfc" id="L3521" title="All 2 branches covered.">			for (Iterator it=campWorkResources.iterator(); it.hasNext();) {</span>
<span class="fc" id="L3522">				employeeIDs.add(((CampaignWorkResource)it.next()).getWorkResourceID());</span>
			}
		}
		
<span class="pc bpc" id="L3526" title="1 of 2 branches missed.">		if (cPhantoms != null) {</span>
<span class="fc bfc" id="L3527" title="All 2 branches covered.">			for (Iterator it=cPhantoms.iterator(); it.hasNext();) {</span>
<span class="fc" id="L3528">				employeeIDs.add(((Phantom)it.next()).getID());</span>
			}
		}

<span class="fc" id="L3532">		return employeeIDs;</span>
	}

	/**
	 * Check whether the specified SP is linked to any Dererred, Outbound, Project, or Immediate queues.
	 * @param context
	 * @param locale
	 * @param appletResponse
	 * @param spID
	 * @return an array of 3 Booleans: {bHasDeferredQueue, bHasOutboundQueuue, bHasProjectQueuue, bHasImmediateQueuue}
	 */
	private Boolean[] checkQueueTypes(RequestContext context, Locale locale, Map appletResponse, ID spID, ID campaignID, Date fromDate, Date toDate) throws Exception {

<span class="fc" id="L3545">		boolean spHasDeferredQueue = false;</span>
<span class="fc" id="L3546">		boolean spHasOutboundQueue = false;</span>
<span class="fc" id="L3547">		boolean spHasProjectQueue = false;</span>
<span class="fc" id="L3548">		boolean spHasImmediateQueue = false;</span>

		//Get the queues linked to the SP, and see if any of them are deferred or outbound
<span class="fc" id="L3551">		Collection campaignQueueAssignments = getCampaignManager(context, appletResponse, locale).getCampaignQueueAssignments(campaignID, fromDate, toDate); </span>
<span class="fc" id="L3552">		Iterator itCampQueueAsmts = campaignQueueAssignments.iterator();</span>
<span class="fc bfc" id="L3553" title="All 2 branches covered.">		while (itCampQueueAsmts.hasNext()) {</span>
<span class="fc" id="L3554">			CampaignQueue nextCampQ = (CampaignQueue) itCampQueueAsmts.next();</span>
<span class="fc" id="L3555">			ID nextQID = nextCampQ.getQueueID();</span>
<span class="fc" id="L3556">			Queue queue = getWorkloadManager(context, appletResponse, locale).getQueueByID(nextQID);</span>

<span class="fc bfc" id="L3558" title="All 2 branches covered.">			if (Media.isMediaDeferred(queue.getMediaID())) {</span>
<span class="fc" id="L3559">				spHasDeferredQueue = true;</span>
<span class="fc bfc" id="L3560" title="All 2 branches covered.">			} else if (Media.isMediaImmediate(queue.getMediaID())) {</span>
<span class="fc" id="L3561">				spHasImmediateQueue = true;</span>
<span class="pc bpc" id="L3562" title="1 of 2 branches missed.">			} else if (queue.getMediaID().equals(Media.MEDIA_ID_PHONE_OUTBOUND)) {</span>
<span class="fc" id="L3563">				spHasOutboundQueue = true;</span>
<span class="nc bnc" id="L3564" title="All 2 branches missed.">			} else if (queue.getMediaID().equals(Media.MEDIA_ID_PROJECT)) {</span>
<span class="nc" id="L3565">				spHasProjectQueue = true;				</span>
			}

<span class="pc bpc" id="L3568" title="3 of 8 branches missed.">			if (spHasDeferredQueue &amp;&amp; spHasOutboundQueue &amp;&amp; spHasProjectQueue &amp;&amp; spHasImmediateQueue) {</span>
<span class="nc" id="L3569">				break;</span>
			}
<span class="fc" id="L3571">		}</span>

<span class="fc" id="L3573">		return new Boolean[]{Boolean.valueOf(spHasDeferredQueue), Boolean.valueOf(spHasOutboundQueue), Boolean.valueOf(spHasProjectQueue), Boolean.valueOf(spHasImmediateQueue)};</span>
	}

	private void getServiceLevelRibbons(RequestContext context, Locale locale, Map appletResponse, ID spID, ID campaignID, Date startDate, 
			Date endDate, String msgID) throws Exception{
<span class="fc" id="L3578">		Collection&lt;SPQueue&gt; spQueues = getCampaignManager(context, appletResponse, locale).getSPQueuesBySPID(spID);</span>

		//Get the SP
<span class="fc" id="L3581">		SchedulingPeriod sp = getCampaignManager(context, appletResponse, locale).getSchedulingPeriodByID(spID);</span>

		// Get the campaign
<span class="fc" id="L3584">		Campaign c = getCampaignManager(context, appletResponse, locale).getCampaignByID(sp.getCampaignID());</span>

		//load TraceCubes
<span class="fc" id="L3587">		List&lt;Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt;&gt; traceCubes = getStatisticRibbons(context, appletResponse, locale, sp, spQueues);</span>
<span class="fc" id="L3588">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; forecastLine = traceCubes.get(0);</span>
<span class="fc" id="L3589">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; requiredLine = traceCubes.get(1);</span>
<span class="fc bfc" id="L3590" title="All 2 branches covered.">		Map&lt;NullablePair&lt;ID, ID&gt;, TraceCube&gt; noPhantomLine = traceCubes.size()&gt;2?traceCubes.get(2) : null;</span>
		
<span class="fc" id="L3592">		appletResponse.put(PageKeys.SERVICELEVEL_RIBBONS, forecastLine);</span>
<span class="fc" id="L3593">		appletResponse.put(PageKeys.RIBBONS_REQUIREDLINE, requiredLine);</span>
<span class="fc" id="L3594">		appletResponse.put(FsKeys.RIBBONS_NOPAHNTOMLINE, noPhantomLine);</span>

		//load hasOutboundLicense as well
<span class="fc" id="L3597">		boolean hasOutboundLicense = getLicenserManager(appletResponse, locale).isLicensed(LicenseKeys.APP_MEDIA_OUTBOUND);</span>
<span class="fc" id="L3598">		appletResponse.put(PageKeys.HAS_OUTBOUND_LICENSE, Boolean.valueOf(hasOutboundLicense));</span>
		
		//load hasRFSLicense as well
<span class="fc" id="L3601">		boolean hasRFSLicense = getLicenserManager(appletResponse, locale).isLicensed(LicenseKeys.APP_RFS);</span>
<span class="fc" id="L3602">		appletResponse.put(PageKeys.HAS_RFS_LICENSE, Boolean.valueOf(hasRFSLicense));</span>

		//check if the SP has a deferred/outbound queues as well
<span class="fc" id="L3605">		Boolean[] queueTypes = checkQueueTypes(context, locale, appletResponse, spID, campaignID, startDate, endDate);</span>
<span class="fc" id="L3606">		appletResponse.put(PageKeys.HAS_DEFERRED_QUEUE, queueTypes[0]);</span>
<span class="fc" id="L3607">		appletResponse.put(PageKeys.HAS_OUTBOUND_QUEUE, queueTypes[1]);</span>
<span class="fc" id="L3608">		appletResponse.put(PageKeys.HAS_PROJECT_QUEUE, queueTypes[2]);</span>
<span class="fc" id="L3609">		appletResponse.put(PageKeys.HAS_IMMEDIATE_QUEUE, queueTypes[3]);</span>

		//Get a map (queue SID -&gt; ServiceGoalsType) for each queue in the SP
<span class="fc" id="L3612">		appletResponse.put(PageKeys.QUEUE_GOAL_MAP, getQueueGoalsMap(spQueues));</span>

		// Get a map (queue SID -&gt; PCA goal seconds) for each queue in the SP
<span class="fc" id="L3615">		appletResponse.put(PageKeys.QUEUE_SERVICE_LEVEL_GOAL_SECONDS_MAP, getQueueServiceLevelGoalSecondsMap(spQueues, sp.getSkillBased()));</span>

		// Get shrinkage and modeling factors
<span class="fc" id="L3618">		Pair&lt;float[], float[]&gt; shrinkageAndModelingFactors = getShrinkageAndModelingFactorsForSP(c, sp);</span>
<span class="fc" id="L3619">		appletResponse.put(PageKeys.SP_SHRINKAGE, shrinkageAndModelingFactors.getFirst());</span>
<span class="fc" id="L3620">		appletResponse.put(PageKeys.SP_MODELING_FACTORS, shrinkageAndModelingFactors.getSecond());</span>

		// For an unskilled SP we add raw (no min occupancy) FTE values to assist in
		// doing real-time service level calculations.
<span class="fc bfc" id="L3624" title="All 2 branches covered.">		if (!sp.getSkillBased()) {</span>
<span class="fc" id="L3625">			appletResponse.put(PageKeys.QUEUE_REQUIRED_FTE_NO_MIN_OCCUPANCY, getQueueRequiredFTEForRealTimeServiceLevelMap(</span>
					context, appletResponse, locale, campaignID, spQueues, startDate, endDate, false, false));
<span class="fc" id="L3627">			appletResponse.put(WfmPageKeys.QUEUE_REQUIRED_FTE_WITH_MIN_OCCUPANCY, getQueueRequiredFTEForRealTimeServiceLevelMap(</span>
					context, appletResponse, locale, campaignID, spQueues, startDate, endDate, true, false));
		}

		//Get all employee &amp; phantom ID's liked to the scheduling period
<span class="pc bpc" id="L3632" title="1 of 2 branches missed.">		Campaign campaign = campaignID==null?null : getCampaignManager(context, appletResponse, locale).getCampaignByID(campaignID);</span>
<span class="fc" id="L3633">		List employeeIDs = getSpEmployeeIDs(context, spID, campaign, startDate, endDate, locale, appletResponse, msgID);</span>

		//Get all employee &amp; phantom proficiencies
<span class="fc" id="L3636">		List newEmpIDsList = new ArrayList(employeeIDs);</span>
<span class="fc" id="L3637">		Map hashEmployeeProficiencies = getWorkResourceManager(context, appletResponse, locale).getWorkResourceProficiency(newEmpIDsList, startDate);</span>
<span class="fc" id="L3638">		appletResponse.put(PageKeys.EMPLOYEE_PROFICIENCIES, hashEmployeeProficiencies);</span>

		//Get all employee &amp; phantom ChatSession counts
<span class="fc" id="L3641">		Map&lt;ID, Integer&gt; hashEmployeeChatSessions = getWorkResourceManager(context, appletResponse, locale).getNumberOfChatSessionsForEmployees(newEmpIDsList, false);</span>
<span class="fc" id="L3642">		appletResponse.put(FsKeys.EMPLOYEE_CHAT_SESSIONS, hashEmployeeChatSessions);</span>
		
		//if the SP is a child SP, includes its parent SP ID. If it's a parent SP, include its children SP ID's.
<span class="fc bfc" id="L3645" title="All 2 branches covered.">		if (campaign.getIsDistributed()) {</span>
			//This is a parent SP. Return its children SP ID's
<span class="fc" id="L3647">			appletResponse.put(PageKeys.CHILD_SPIDS, getChildSPIDs(context, spID, campaign, startDate, endDate, locale, appletResponse, msgID));</span>
<span class="pc bpc" id="L3648" title="1 of 2 branches missed.">		} else if (sp.getParentSPID() != null) {</span>
			//This is a child SP. Return its parent SP ID.
<span class="nc" id="L3650">			appletResponse.put(PageKeys.PARENT_SPID, getCampaignManager(context, appletResponse, locale).getParentSchedulingPeriodID(spID));	</span>
		}
<span class="fc" id="L3652">	}</span>
	
	private Pair&lt;float[], float[]&gt; getShrinkageAndModelingFactorsForSP(Campaign c, SchedulingPeriod sp)
			throws RemoteException, BbmException {
<span class="fc" id="L3656">		Collection&lt;SPShrinkage&gt; spShrinkage = m_campaignManager.getOrCreateSPShrinkageBySPID(sp.getID());</span>
<span class="fc" id="L3657">		TimeContext tc = TimeContextFactory.getTimeContext(c);</span>
		// Create arrays for shrinkage and modeling factor values
<span class="fc" id="L3659">		float[] shrinkage = FteRequirementsTimeSeriesUtil.getShrinkageValuesFromSPShrinkage(spShrinkage, sp, tc);</span>
<span class="fc" id="L3660">		float[] modelingFactors = FteRequirementsTimeSeriesUtil.getModelingFactorsFromSPShrinkage(spShrinkage, sp, tc);</span>
<span class="fc" id="L3661">		return new Pair&lt;float[], float[]&gt;(shrinkage, modelingFactors);</span>
	}


	private String getLocaleID(String locale, Map&lt;String,String&gt; localeMap)
	{
<span class="fc" id="L3667">		String localeID =  &quot;1033&quot;;</span>
<span class="pc bpc" id="L3668" title="1 of 2 branches missed.">		if(localeMap != null) {</span>
<span class="fc" id="L3669">			Map&lt;String,String&gt; langCodeMap = new HashMap(0);</span>

<span class="fc" id="L3671">			String langKey = &quot;SupportedRegionalFormats&quot;;</span>
<span class="fc" id="L3672">			String langCodeKey = &quot;SupportedRegionalFormatLocaleIDs&quot;;</span>

<span class="fc" id="L3674">			String langValue = localeMap.get(langKey);</span>
<span class="fc" id="L3675">			String langCodeValue = localeMap.get(langCodeKey);</span>

<span class="pc bpc" id="L3677" title="2 of 4 branches missed.">			if (langValue == null || langCodeValue == null) {</span>
				//should not, it is read from dbconfig table, but just in case here
<span class="nc" id="L3679">				return localeID; //default one</span>
			}
<span class="fc" id="L3681">			String[] langArray = langValue.split(&quot;,&quot;);</span>
<span class="fc" id="L3682">			String[] langCodeArray = langCodeValue.split(&quot;,&quot;);</span>

<span class="pc bpc" id="L3684" title="1 of 2 branches missed.">			for(int i =0; i&lt;langArray.length; i++ ){</span>
<span class="fc" id="L3685">				langCodeMap.put(langArray[i], langCodeArray[i]);</span>
<span class="pc bpc" id="L3686" title="1 of 2 branches missed.">				if(langArray[i].equals(locale)) {</span>
<span class="fc" id="L3687">					localeID = langCodeArray[i];</span>
<span class="fc" id="L3688">					break;</span>
				}
			}
		}

<span class="fc" id="L3693">		return localeID;</span>
	}

	/**
	 * Returns true if the viewing time zone is overridden (i.e. we are viewing
	 * data in the user's time zone defined in user prefs).  If it is not overridden,
	 * then we are viewing data in the campaign's time zone.
	 */
	protected void isTimeZoneOverridden(RequestContext context, Map appletResponse) {
<span class="fc" id="L3702">		appletResponse.put(PageKeys.IS_TIMEZONE_OVERRIDDEN_RETVAL,</span>
<span class="fc" id="L3703">				SelectionCacheUtil.isTimeZoneOverridden(context));</span>
<span class="fc" id="L3704">	}</span>
	
	/**
	 * Toggles the cached viewing time zone override between on/off states.
	 * If it is on, that means the user will be viewing data in their time
	 * zone (defined in user preferences).  If it is off, then the user will
	 * be viewing data in the selected campaign's time zone.
	 */
	protected void toggleTimeZoneOverride(RequestContext context, Map appletResponse) {
<span class="nc" id="L3713">		SelectionCacheUtil.toggleTimeZoneOverride(context);</span>
<span class="nc" id="L3714">	}</span>
	
	/**
	 * Returns the child organization IDs belonging to the given orgs.  The returned value
	 * also includes the IDs contained in the parameter parentOrgIDs.
	 */
	protected Collection&lt;ID&gt; getChildAndSelfOrganizationIDs(
			RequestContext context,
			Map appletResponse,
			Collection&lt;ID&gt; parentOrgIDs) throws RemoteException, BbmException {
<span class="fc" id="L3724">		return OrganizationModelHandler.getSelfAndChildOrganizationIDs(context, parentOrgIDs);</span>
	}
	
	
	private BbmCoachingBridgeInterface getCoachingBridgeInterface(Map appletResponse, Locale locale) 
			throws CoreEJBCreateException, CoreFinderException, RemoteException, ClassNotFoundException, InstantiationException, IllegalAccessException, BbmFinderException {
<span class="nc bnc" id="L3730" title="All 2 branches missed.">		if (m_bbmCoachingBridge == null) {</span>
			//get the implementation class of the BBM-Coaching bridge from the global code registry
<span class="nc" id="L3732">			GCRManager 	gcrManager 	= CoreManagerFactory.getGCRManagerRemote(false);</span>
<span class="nc" id="L3733">			Collection 	entries 	= gcrManager.getGCREntryOfType(BbmCoachingBridgeInterface.GCR_NAME);</span>
<span class="nc bnc" id="L3734" title="All 4 branches missed.">			if (entries == null || entries.isEmpty()) {</span>
<span class="nc" id="L3735">				throw new BbmFinderException(FsWebBundleKey.FS_CAL_ERR_ERROR_GETTING_GCRMANAGER_BRIDGE_ENTRIES, new Object[]{BbmCoachingBridgeInterface.GCR_NAME});</span>
			} 
			//should only have one entry if the customer has the license of coaching
<span class="nc" id="L3738">			GCREntry entry = (GCREntry)entries.iterator().next();</span>
<span class="nc" id="L3739">			Class bridgeClass = Class.forName(entry.getHook());</span>

<span class="nc" id="L3741">			m_bbmCoachingBridge = (BbmCoachingBridgeInterface)bridgeClass.newInstance();</span>
		}
<span class="nc" id="L3743">		return m_bbmCoachingBridge;</span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>