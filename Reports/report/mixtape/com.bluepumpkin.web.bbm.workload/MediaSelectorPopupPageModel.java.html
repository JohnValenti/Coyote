<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MediaSelectorPopupPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload</a> &gt; <span class="el_source">MediaSelectorPopupPageModel.java</span></div><h1>MediaSelectorPopupPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Iterator;
import java.util.Map;
import java.util.Map.Entry;
import java.util.ResourceBundle;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.core.setup.mediatypes.MediaTypesSetupPageModel;
import com.verint.web.wfm.keys.WfmJavaScriptFileID;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.licensing.ejb.LicenseManager;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultNodeData;
import com.witness.web.uif.pagecomponent.assignmentbox.AssignmentBoxPC;
import com.witness.web.uif.pagemodel.PopupWindowPM;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        Media Selector Popup Page Model
 * Description:  A page model for a media selector popup
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       Shimon Kakon
 * @version 1.0
 */

public class MediaSelectorPopupPageModel  extends PopupWindowPM {
	public static final String MEDIA_SELECTOR_POPUP_ACTION = &quot;POPUP_MEDIA_SELECTOR&quot;;
	public static final String MEDIA_SELECTOR_POPUP_URL = &quot;media_selector&quot;;
	public static final String MEDIA_SELECTOR_POPUP_SIZE_POSITION = &quot;400,450,ctr,ctr&quot;;
	protected ResourceBundle m_bbmBundle;
	private AssignmentBoxPC m_assignmentBox;
<span class="fc" id="L41">	private boolean m_isInitiated = false;</span>
	private ID[] m_assignedMediaIds;
	private Map m_allMediaMap;

	/**
	 * Constructor
	 */
	public MediaSelectorPopupPageModel(RequestContext context) {
<span class="fc" id="L49">		super(context);</span>
<span class="fc" id="L50">		m_bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L51">		setJSMediator(WfmJavaScriptFileID.MEDIATOR_MEDIA_SELECTOR);</span>
<span class="fc" id="L52">	}</span>

	 public void initForDisplay() {
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">		if (m_isInitializedForDisplay) return;</span>
		else {
<span class="fc" id="L57">			super.initForDisplay();</span>
<span class="fc" id="L58">			setName(&quot;MediaSelectorPopup&quot;);</span>
			//addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_POPUPDIALOG);

<span class="fc" id="L61">			initToolbar();</span>
<span class="fc" id="L62">			initTitle();</span>
<span class="fc" id="L63">			initAssignmentBox();</span>
		}
<span class="fc" id="L65">	 }</span>

	 /**
	 * Prepare toolbar for rendering
	 */
	protected void initToolbar() {
<span class="fc" id="L71">		String setLabel = i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SET);</span>

<span class="fc" id="L73">		String setBtnOnClickJS = &quot;window.pageMediator.handleSaveAction();&quot;;</span>
<span class="fc" id="L74">		m_toolbar.addJSTextButton(PageAction.SET, setLabel, true, setBtnOnClickJS);</span>

<span class="fc" id="L76">		m_toolbar.addCloseWindowTextButton(</span>
				PageAction.CANCEL,
<span class="fc" id="L78">				i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_CANCEL),</span>
				true);

<span class="fc" id="L81">	}</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static MediaSelectorPopupPageModel getInstance(RequestContext context) {
<span class="fc" id="L87">		MediaSelectorPopupPageModel model = (MediaSelectorPopupPageModel) context.getPageModel();</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">		if (model==null){</span>
<span class="fc" id="L89">			model = new MediaSelectorPopupPageModel(context);</span>
<span class="fc" id="L90">			model.extractParameters(context.getRequest());</span>
<span class="fc" id="L91">			context.setPageModel(model);</span>
		}
<span class="fc" id="L93">		model.populateModel();</span>
<span class="fc" id="L94">		return model;</span>
	}


	private void populateModel()
	{
<span class="fc bfc" id="L100" title="All 2 branches covered.">		if ( m_isInitiated )</span>
<span class="fc" id="L101">			return; else m_isInitiated = true;</span>
		try
		{
<span class="fc" id="L104">			m_allMediaMap = WorkloadModelHandler.getMediaMap(m_context);</span>

<span class="fc" id="L106">			LicenseManager licManager = CoreManagerFactory.getLicenseManager();</span>
<span class="pc bpc" id="L107" title="5 of 6 branches missed.">			if (!licManager.isLicensed(LicenseKeys.APP_MULTIMEDIA) &amp;&amp; m_allMediaMap!=null &amp;&amp; !m_allMediaMap.isEmpty())</span>
			{
				//Since the Multi-MEdia license is not installer, remove all media from map except for Phone.
<span class="nc bnc" id="L110" title="All 2 branches missed.">				for (Iterator it=m_allMediaMap.entrySet().iterator(); it.hasNext();)</span>
				{
<span class="nc" id="L112">					Entry entry = (Entry)it.next();</span>
<span class="nc" id="L113">					ID id = (ID)entry.getKey();</span>
<span class="nc bnc" id="L114" title="All 6 branches missed.">					if (!id.equals(Media.MEDIA_ID_PHONE) &amp;&amp; (!id.equals(Media.MEDIA_ID_OPERATIONS) || !MediaTypesSetupPageModel.hasAnyBackOfficeLicence()))</span>
<span class="nc" id="L115">						it.remove();</span>
<span class="nc" id="L116">				}</span>
			}
		}
<span class="nc" id="L119">		catch (Exception ex)</span>
		{
<span class="nc" id="L121">			handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L122">		}</span>
<span class="fc" id="L123">	}</span>

	private void initTitle(){
<span class="fc" id="L126">		m_contentTitlePC.setPageTitle(i18n(m_bbmBundle, BbmWebBundleKey.MEDIA_TITLE));</span>
<span class="fc" id="L127">	 }</span>

	 private void initAssignmentBox() {
<span class="fc" id="L130">		m_assignmentBox = new AssignmentBoxPC(m_context);</span>
<span class="fc" id="L131">		addChildComponent(m_assignmentBox);</span>
<span class="fc" id="L132">		m_assignmentBox.setName(getName() + &quot;_assignmentbox&quot;);</span>
<span class="fc" id="L133">		m_assignmentBox.setHeaderTitle(&quot;&quot;);</span>
<span class="fc" id="L134">		m_assignmentBox.setLeftTitle(i18n(m_bbmBundle, BbmWebBundleKey.MEDIA_LABEL_AVAILABLE));</span>
<span class="fc" id="L135">		m_assignmentBox.setRightTitle(i18n(m_bbmBundle, BbmWebBundleKey.MEDIA_LABEL_ASSIGNED));</span>
<span class="fc" id="L136">		m_assignmentBox.setItemCount(10);</span>

		// Get the assigned/available media nodes
<span class="pc bpc" id="L139" title="2 of 4 branches missed.">		if(m_allMediaMap == null || m_allMediaMap.isEmpty()) { //no media are define in the system</span>
			//setInitFailure(true);
<span class="nc" id="L141">			return;</span>
		}
<span class="fc" id="L143">		Collection allMediaIds = m_allMediaMap.keySet();</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">		int assignedMediaSize = (m_assignedMediaIds == null)? 0: m_assignedMediaIds.length;</span>
<span class="fc" id="L145">		int availableMediaSize = allMediaIds.size() - assignedMediaSize;</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">		if(availableMediaSize &lt; 0) availableMediaSize = 0;</span>
<span class="fc" id="L147">		ArrayList assignedMediaNodes = new ArrayList(assignedMediaSize);</span>
<span class="fc" id="L148">		ArrayList availableMediaNodes = new ArrayList(availableMediaSize);</span>
<span class="fc" id="L149">		Media media = null;</span>
<span class="fc" id="L150">		ID id = null;</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">		for(Iterator it =  allMediaIds.iterator(); it.hasNext();) {</span>
<span class="fc" id="L152">			id = (ID)it.next();</span>
<span class="fc" id="L153">			media = (Media)m_allMediaMap.get(id);</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">			if(isAssigned(id)) {</span>
<span class="nc" id="L155">				assignedMediaNodes.add(new DefaultNodeData(media.getId().toString(), media.getName(),</span>
<span class="nc" id="L156">					StringUtil.convertEmptyStringToNBSP(media.getDescription())));</span>
			}
			else {
<span class="fc" id="L159">				availableMediaNodes.add(new DefaultNodeData(media.getId().toString(), media.getName(),</span>
<span class="fc" id="L160">					StringUtil.convertEmptyStringToNBSP(media.getDescription())));</span>
			}
		}
<span class="fc" id="L163">		m_assignmentBox.getLeftListPC().setData(availableMediaNodes);</span>
<span class="fc" id="L164">		m_assignmentBox.getRightListPC().setData(assignedMediaNodes);</span>
<span class="fc" id="L165">	 }</span>


	public ID[] getMedia() {
<span class="nc" id="L169">		return m_assignedMediaIds;</span>
	}

	public void setMedia(String mediaString) {
<span class="nc bnc" id="L173" title="All 2 branches missed.">		if (!StringUtil.isEmpty(mediaString)) {</span>
<span class="nc" id="L174">			m_assignedMediaIds = StringUtil.parseIDString(mediaString, &quot;,&quot;);</span>
		} else {
<span class="nc" id="L176">			m_assignedMediaIds = new ID[]{};</span>
		}
<span class="nc" id="L178">	}</span>


	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="fc" id="L185">		return &quot;media_selector&quot;;</span>
	}

	public String getHtmlDisplay() {
<span class="fc" id="L189">		return m_assignmentBox.getHtmlDisplay();</span>
	}

	private boolean isAssigned(ID id){
<span class="pc bpc" id="L193" title="3 of 4 branches missed.">		if(m_assignedMediaIds == null || m_assignedMediaIds.length == 0) return false;</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">		for(short i = 0; i &lt; m_assignedMediaIds.length; i++) {</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">			if(id.equals(m_assignedMediaIds[i])) return true;</span>
		}
<span class="nc" id="L197">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>