<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AvailableTimeOffPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.setup.allocations</a> &gt; <span class="el_source">AvailableTimeOffPageModel.java</span></div><h1>AvailableTimeOffPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.setup.allocations;

import java.math.BigDecimal;
import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import weblogic.wsee.util.StringUtil;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.workresource.OrganizationScopeManagerProxy;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.l10n.RmSettingKey;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOIntervalCalendar;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.ejb.CalendarTimeOffDayFacade;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.CalendarTimeOffDay;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.ejb.rm.util.TORequestUtil;
import com.bluepumpkin.web.bbm.organization.OrgWorkpaneFormPageModel;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.keys.RmJavaScriptFileID;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.bluepumpkin.web.rm.requests.timeoff.TimeOffCalendarPC;
import com.bluepumpkin.web.rm.setup.allocations.interval.AvailableTimeOffIntervalCalendarPC;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.calendar.CalendarPC;
import com.witness.web.uif.pagecomponent.calendar.InputCalendarDayRenderer;
import com.witness.web.uif.pagecomponent.container.ListContainerPC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.WorkpaneFieldNames;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title          AvailableTimeOffPageModel
 * Description
 * Copyright      Copyright (c) 2002
 * Company        Blue Pumpkin Software, Inc
 * @author        Howard Mullings
 * @version       1.0
 */
public class AvailableTimeOffPageModel extends OrgWorkpaneFormPageModel implements ContainersInRowsPM {
	/**
	 *
	 */
	private static final long serialVersionUID = 1L;

	private static final String DAY_PROP_INPUT_VALUE = InputCalendarDayRenderer.DAY_PROP_INPUT_VALUE;
	private static final String DAY_PROP_CHKBOX_CHECKED = InputCalendarDayRenderer.DAY_PROP_CHKBOX_CHECKED;

<span class="fc" id="L77">	private static final Category log = Log.initCategory(AvailableTimeOffPageModel.class.getName());</span>

	public static final String POOL_ID_FN = &quot;poolID&quot;;
	public static final String POOL_NAME_FN = &quot;poolName&quot;;
	public static final String POOL_DESC_FN = &quot;poolDesc&quot;;

	//waitlist-related member variables
	protected static final String WL_SAVE_PRIORITY_FN = &quot;savePriorityDisabled&quot;;
	protected static final String WL_SCAN_ENABLED_FN = &quot;wlScanEnabled&quot;;
	protected static final String COLUMN = &quot;COLUMN&quot;;
	protected static final String ORDER = &quot;ORDER&quot;;
	protected static final String ALLOCATION_SESSION_KEY = &quot;allocationTypeSession&quot;;

	public static final String ALLOCATION_TYPE_FN = &quot;allocationType&quot;;

	private boolean m_savePriorityDisabled;
	private boolean m_wlScanEnabled;
	private final HtmlChoiceInput m_choiceInput;
<span class="fc" id="L95">	private boolean m_isEditMode = false;</span>

	private final ResourceBundle m_rmBundle;

	/**
	 * set the characteristics of the ListContainerPC
	 */
	private static final String ROW_NO_BOTTOM_CSS = &quot;formRowLightNoBorderBottom&quot;;

<span class="fc" id="L104">	private String m_ownerOrganizationHtml = &quot;&quot;;</span>
	private CalendarTimeOffDay m_timeOffDays[];
	private final CalendarPC m_calendarPC;
	private final FormInputPC m_formInputPC;
	private int m_month;
	private int m_year;

	private ID m_poolID; //The Time Off Pool ID which was selected in the Time Off Pool List page
	//private String m_poolName; //The Time Off Pool name which was selected in the Time Off Pool List page
<span class="fc" id="L113">	private TOPool m_pool = null; //The Time Off Pool which was selected in the Time Off Pool List page</span>

	private final ContainerList m_containerList; //holds the three main sections (containers) for the page

	private final FormTwoColumnPC m_poolDetailsPC; //first section is for time off pool name and description
	private final ListContainerPC m_waitlistTOContainerPC; //second section is for time off waitlist settings
	private final ListContainerPC m_availableTimeOffPC; //third section is for the Available Time Off Calendar

	private final ListContainerPC allocationTypeContainerPC; //has Advanced license
	private final AvailableTimeOffIntervalCalendarPC intervalAllocationPC;
<span class="fc" id="L123">	private boolean hasAdvancedRMLicense = false;</span>
<span class="fc" id="L124">	private String timeOffAllocationType = TimeOffCalendarPC.DAILY_ALLOCATION_DROPDOWN_VALUE;</span>

	//both the import popup and the blackout day range popup will only need to poolID parameter
	private static final String POPUP_POOL_DYNAMIC_PARAMS = WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN + &quot;,poolName&quot;;
	//@formatter:off
<span class="fc" id="L129">	private static final MessageFormat CAL_FORMAT = new MessageFormat</span>
	(
			&quot;&lt;table width=\&quot;100%\&quot; border=\&quot;0\&quot; cellpadding=\&quot;0\&quot; cellspacing=\&quot;5\&quot;&gt;\n&quot;+

			&quot;&lt;tr&gt;&lt;td&gt;\n&quot;+
			&quot;&lt;table width=\&quot;99%\&quot; border=\&quot;0\&quot; cellpadding=\&quot;0\&quot; cellspacing=\&quot;0\&quot; class=\&quot;fWrapper\&quot;&gt;\n&quot;+

			&quot;&lt;/table&gt;&quot;+
			&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;+

			&quot;&lt;tr&gt;&lt;td&gt;\n&quot;+
			&quot;&lt;table width=\&quot;99%\&quot; border=\&quot;0\&quot; cellpadding=\&quot;0\&quot; cellspacing=\&quot;5\&quot; class=\&quot;fWrapper\&quot;&gt;\n&quot;+
			&quot;&lt;tr&gt;\n&quot;+
			// legend
			&quot;\t&lt;td valign=\&quot;middle\&quot;&gt;{1}&lt;/td&gt;\n&quot;+
			// time off calendar
			&quot;\t&lt;td align=\&quot;left\&quot;&gt;{2}&lt;/td&gt;\n&quot;+
			&quot;&lt;/tr&gt;\n&quot;+
			&quot;&lt;/table&gt;&quot;+
			&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;+
			&quot;&lt;/table&gt;&quot;);
	//@formatter:on
	/**
	 * Constructor
	 */
	public AvailableTimeOffPageModel(RequestContext context) {
<span class="fc" id="L155">		super(context);</span>
<span class="fc" id="L156">		hasAdvancedRMLicense =LicenseUtil.isAdvancedRMLicense();</span>
<span class="fc" id="L157">		m_rmBundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>

		// Component specific required JavaScript Files
<span class="fc" id="L160">		addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE);</span>
<span class="fc" id="L161">		addRequiredJavaScriptFile(JavaScriptFileID.DIALOG_PICKERS);</span>
<span class="fc" id="L162">		addRequiredJavaScriptFile(RmJavaScriptFileID.WAITLIST_SETTINGS_JS);</span>
<span class="fc" id="L163">		setJSMediator(RmJavaScriptFileID.AVAILABLETIMEOFFMEDIATOR);</span>

<span class="fc" id="L165">		m_containerList = new ContainerList(this, 3);</span>

		//create the time off pool details container (for setting the name, description)
<span class="fc" id="L168">		m_poolDetailsPC = new FormTwoColumnPC(context);</span>

		//create the waitlist settings container
<span class="fc" id="L171">		m_waitlistTOContainerPC = new ListContainerPC(context);</span>
<span class="fc" id="L172">		m_choiceInput = new HtmlChoiceInput();</span>

		//create the Available Time Off Calendar container
<span class="fc" id="L175">		m_availableTimeOffPC = new ListContainerPC(context);</span>
<span class="fc" id="L176">		m_calendarPC = new CalendarPC(context, &quot;timeOffCalendarPC&quot;, CalendarPC.CALENDAR_TYPE_INPUT_CHKBOX);</span>
<span class="fc" id="L177">		m_calendarPC.setIsSubmitOnNavChange(true);</span>

<span class="fc" id="L179">		m_formInputPC = new FormInputPC(context);</span>

<span class="fc" id="L181">		allocationTypeContainerPC = new ListContainerPC(context);</span>
<span class="fc" id="L182">		intervalAllocationPC = new AvailableTimeOffIntervalCalendarPC(context, &quot;intervalAllocationPC&quot;);</span>

<span class="fc" id="L184">		addChildComponent(m_poolDetailsPC);</span>
<span class="fc" id="L185">		addChildComponent(m_formInputPC);</span>
<span class="fc" id="L186">		addChildComponent(m_availableTimeOffPC);</span>
<span class="fc" id="L187">		addChildComponent(m_calendarPC);</span>
<span class="fc" id="L188">		addChildComponent(m_waitlistTOContainerPC);</span>
		//if has license
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">		if (hasAdvancedRMLicense) {</span>
<span class="nc" id="L191">			addChildComponent(allocationTypeContainerPC);</span>
			// add the interval allocation PC here because we want the full life cycle of the PC
<span class="nc" id="L193">			addChildComponent(intervalAllocationPC);</span>
		}

<span class="fc" id="L196">		m_containerList.add(m_poolDetailsPC);</span>
<span class="fc" id="L197">		m_containerList.add(m_waitlistTOContainerPC);</span>
		//if has license
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">		if (hasAdvancedRMLicense) {</span>
<span class="nc" id="L200">			m_containerList.add(allocationTypeContainerPC);</span>
		}
<span class="fc" id="L202">		m_containerList.add(m_availableTimeOffPC);</span>

		//add set blackout day range
<span class="fc" id="L205">		addPopupArgs(RmPageAction.SET_BLACKOUT_RANGE_ACTION, &quot;set_blackout_day_range_pu&quot;, POPUP_POOL_DYNAMIC_PARAMS, null, &quot;510, 380, ctr, ctr&quot;, true, 1);</span>

		//add upload
<span class="fc" id="L208">		addPopupArgs(PageAction.IMPORT, &quot;available_time_off_import&quot;, POPUP_POOL_DYNAMIC_PARAMS, null, &quot;620,320, ctr, ctr&quot;, true, 1);</span>

<span class="fc" id="L210">		addJSVariableAsString(&quot;IS_NON_NEG_NUMERIC_MSG&quot;, i18n(m_rmBundle, RmWebBundleKey.TIMEOFF_CALENDAR_INVALID_HOURS));</span>
<span class="fc" id="L211">		addJSVariableAsString(&quot;ORG_RM_SETTINGS_TO_WAITLIST_ORDER_PREFIX&quot;, getNameKey(RmSettingKey.ORG_RM_SETTINGS_TO_WAITLIST_ORDER_PREFIX));</span>
<span class="fc" id="L212">		addJSVariableAsString(&quot;ORG_RM_SETTINGS_TO_WAITLIST_FEATURE_ENABLE&quot;, getNameKey(RmSettingKey.ORG_RM_SETTINGS_TO_WAITLIST_FEATURE_ENABLE));</span>
<span class="fc" id="L213">		addJSVariableAsString(&quot;ORG_RM_SETTINGS_TO_WAITLIST_SCAN_ENABLE&quot;, getNameKey(RmSettingKey.ORG_RM_SETTINGS_TO_WAITLIST_SCAN_ENABLE));</span>
<span class="fc" id="L214">		addJSVariable(&quot;DUPLICATE_SORT_COLUMN&quot;, m_rmBundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_WAITLIST_DUPLICATE_JS);</span>
<span class="fc" id="L215">		addJSVariableAsString(&quot;TIMEOFF_ALLOCATION_TYPE_CHANGE_ACTION&quot;, RmPageAction.TIMEOFF_ALLOCATION_TYPE_CHANGE_ACTION);</span>

<span class="fc" id="L217">		m_pool = new TOPool();</span>
<span class="fc" id="L218">	}</span>

	public AvailableTimeOffIntervalCalendarPC getIntervalAllocationPC() {
<span class="nc" id="L221">		return intervalAllocationPC;</span>
	}

	public void populateCalendar(CalendarPC calendarPC) throws Exception {
<span class="fc" id="L225">		InputCalendarDayRenderer calDRInput = (InputCalendarDayRenderer) calendarPC.getCalendarDayRenderer();</span>
<span class="fc" id="L226">		calDRInput.setFormInputPC(m_formInputPC, FormInputPC.TYPE_NUMERIC, 2);</span>

<span class="fc" id="L228">		ID orgId = getOrgID();</span>
<span class="fc" id="L229">		ID poolID = getPoolID();</span>

<span class="pc bpc" id="L231" title="4 of 6 branches missed.">		if (orgId != null &amp;&amp; (isAuthorizedToView() || isAuthorizedToConfigure())) {</span>
			// use the year previously selected or use the current year
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">			if (m_year == 0) {</span>
<span class="nc" id="L234">				Calendar c = calendarPC.extractNavigationControlDate();</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">				if (c == null) {</span>
<span class="nc" id="L236">					c = new GregorianCalendar();</span>
				}
<span class="nc" id="L238">				m_month = c.get(Calendar.MONTH);</span>
<span class="nc" id="L239">				m_year = c.get(Calendar.YEAR);</span>
			}

			// Retrieve Organization to use weekstart
<span class="fc" id="L243">			Organization org = OrganizationModelHandler.getOrganization(m_context, orgId);</span>
<span class="fc" id="L244">			calendarPC.setFirstDayOfWeek(org.getWeekStartDate());</span>

<span class="fc" id="L246">			CalendarTimeOffDay dataList[] = AvailableTimeOffModelHandler.getCalendarTimeOffDays(poolID, m_month, m_year);</span>

<span class="fc" id="L248">			calDRInput.setDefaultInputOnChangeJS(&quot;isNumeric(this);&quot;);</span>
<span class="fc" id="L249">			calDRInput.setIsChkboxEnabled(isAuthorizedToConfigure());</span>
<span class="fc" id="L250">			boolean enableInputs = false;</span>

<span class="fc" id="L252">			int l = dataList.length;</span>

			// setup data for the calendar pc input fields
<span class="fc bfc" id="L255" title="All 2 branches covered.">			for (int i = 0; i &lt; l; i++) {</span>
<span class="fc" id="L256">				CalendarTimeOffDay data = dataList[i];</span>
<span class="fc bfc" id="L257" title="All 2 branches covered.">				if (data != null) {</span>
<span class="fc" id="L258">					HashMap prop = new HashMap(13);</span>
<span class="fc" id="L259">					double availableHours = data.getAllocatedHours();</span>

					//Using double is not appropriate for decimal value. Big decimal does accurate
					//processing for decimals.
<span class="fc" id="L263">					BigDecimal availableHoursDecimal = new BigDecimal(availableHours);</span>
					//2 digit rounding is specified
<span class="fc" id="L265">					availableHoursDecimal = availableHoursDecimal.setScale(2, BigDecimal.ROUND_HALF_EVEN);</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">					if (availableHours &gt;= 0) {</span>
<span class="fc" id="L267">						prop.put(DAY_PROP_INPUT_VALUE, availableHoursDecimal.toString());</span>
					}

<span class="fc bfc" id="L270" title="All 2 branches covered.">					prop.put(DAY_PROP_CHKBOX_CHECKED, data.isBlackOutDay() ? &quot;true&quot; : &quot;false&quot;);</span>

<span class="fc" id="L272">					calendarPC.setCalendarDayProp(i + 1, prop);</span>
				}
			}

			// get a message that tells the user the name of the organization
			// that defines the allocated time off hours
			{
<span class="fc" id="L279">				String format = i18n(m_rmBundle, RmWebBundleKey.RM_ORG_REQUEST_TIMEOFF_OWNER_ORG_FORMAT);</span>
<span class="fc" id="L280">				m_ownerOrganizationHtml = MessageFormat.format(format, new Object[] { getOrganizationName(orgId) });</span>
				//getOrganizationName(ownerOrgId == null ? orgId : ownerOrgId) });
			}

			// Determine whether input is enabled
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">			if (isAuthorizedToConfigure()) {</span>
				//enableInputs = ownerOrgId == null || ownerOrgId.equals(orgId);
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">				enableInputs = (orgId != null); //GQ</span>
			}
<span class="fc" id="L289">			calDRInput.setIsTxtInputEnabled(enableInputs);</span>
<span class="fc" id="L290">			calDRInput.setIsTxtInputReactToChkbox(enableInputs);</span>
<span class="fc" id="L291">			addJSVariable(&quot;isDayValueEditable&quot;, String.valueOf(enableInputs));</span>
<span class="fc" id="L292">		} else {</span>
			// if there is no org selected then disable the calendar pc.
<span class="nc" id="L294">			calDRInput.setIsChkboxEnabled(false);</span>
<span class="nc" id="L295">			calDRInput.setIsTxtInputEnabled(false);</span>
		}
<span class="fc" id="L297">	}</span>

	public void populateIntervalCalendar() throws Exception {
<span class="nc" id="L300">		ID orgId = getOrgID();</span>
<span class="nc" id="L301">		ID poolID = getPoolID();</span>

<span class="nc bnc" id="L303" title="All 6 branches missed.">		if (orgId != null &amp;&amp; (isAuthorizedToView() || isAuthorizedToConfigure())) {</span>
<span class="nc" id="L304">			Organization org = OrganizationModelHandler.getOrganization(m_context, orgId);</span>

<span class="nc bnc" id="L306" title="All 2 branches missed.">			if (this.intervalAllocationPC.getTimeOffIntervalCalendar() == null) {</span>
				// load data
<span class="nc" id="L308">				CalendarTimeOffDayFacade ctodf = RmManagerFactory.getInstance().getTimeOffDayFacade();</span>
<span class="nc" id="L309">				TOIntervalCalendar timeOffIntervalCalendar = ctodf.getTOIntervalCalendarForAdmin(org, poolID, m_year, m_month);</span>
<span class="nc" id="L310">				intervalAllocationPC.setTimeOffIntervalCalendar(timeOffIntervalCalendar);</span>
			}
<span class="nc" id="L312">			intervalAllocationPC.isEditable(isAuthorizedToConfigure());</span>
<span class="nc" id="L313">		} else {</span>
<span class="nc" id="L314">			intervalAllocationPC.isEditable(false);</span>
		}
<span class="nc" id="L316">	}</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static AvailableTimeOffPageModel getInstance(RequestContext context) {
<span class="fc" id="L322">		return (AvailableTimeOffPageModel) getInstance(context, AvailableTimeOffPageModel.class);</span>
	}

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L327">		boolean success = super.extractParameters(request);</span>
		try {

<span class="fc" id="L330">			Calendar c = new GregorianCalendar(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="fc" id="L331">			c.set(c.get(Calendar.YEAR), c.get(Calendar.MONTH), c.getMinimum(Calendar.DAY_OF_MONTH), 0, 0, 0);</span>
<span class="fc" id="L332">			c.set(Calendar.MILLISECOND, 0);</span>

<span class="fc" id="L334">			Calendar cal = m_calendarPC.extractNavigationControlDate();</span>
<span class="fc bfc" id="L335" title="All 2 branches covered.">			if (cal != null) {</span>
<span class="fc" id="L336">				c.set(Calendar.YEAR, cal.get(Calendar.YEAR));</span>
<span class="fc" id="L337">				c.set(Calendar.MONTH, cal.get(Calendar.MONTH));</span>
			} else {
<span class="fc" id="L339">				cal = new GregorianCalendar(m_context.getViewingTimeZone());</span>
			}
			// This call should not be necessary. The calendar should
			// move automatically to the user modified date.
<span class="fc" id="L343">			m_calendarPC.setDate(cal.getTime());</span>

<span class="fc" id="L345">			m_month = c.get(Calendar.MONTH);</span>
<span class="fc" id="L346">			m_year = c.get(Calendar.YEAR);</span>

<span class="fc" id="L348">			InputCalendarDayRenderer calDRInput = (InputCalendarDayRenderer) m_calendarPC.getCalendarDayRenderer();</span>

<span class="fc" id="L350">			String hours[] = request.getParameterValues(calDRInput.getDefaultInputName());</span>
<span class="fc" id="L351">			m_timeOffDays = new CalendarTimeOffDay[31];</span>
<span class="fc" id="L352">			String chkValueFieldName = calDRInput.getDefaultChkboxName();</span>
<span class="fc" id="L353">			int minDayOfMonth = c.getMinimum(Calendar.DAY_OF_MONTH);</span>
<span class="fc" id="L354">			int offsetAdjustment = 0;</span>
<span class="fc" id="L355">			int count = 0;</span>
<span class="fc bfc" id="L356" title="All 2 branches covered.">			for (int i = 0; i &lt; 31; i++) {</span>
<span class="fc" id="L357">				String blackout = request.getParameter(chkValueFieldName + (i + 1));</span>
<span class="pc bpc" id="L358" title="1 of 4 branches missed.">				if (blackout != null &amp;&amp; blackout.trim().length() != 0) {</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">					if (m_timeOffDays[i] == null) {</span>
<span class="fc" id="L360">						m_timeOffDays[i] = new CalendarTimeOffDay();</span>
<span class="fc" id="L361">						c.set(Calendar.DAY_OF_MONTH, i + minDayOfMonth);</span>
<span class="fc" id="L362">						m_timeOffDays[i].setTimeOffDate(c.getTime());</span>
<span class="fc" id="L363">						count++;</span>
					}
<span class="fc" id="L365">					m_timeOffDays[i].setBlackOutDay(true);</span>
				}

<span class="fc" id="L368">				int j = i - offsetAdjustment;</span>
<span class="pc bpc" id="L369" title="2 of 8 branches missed.">				if (hours != null &amp;&amp; j &gt;= 0 &amp;&amp; j &lt; hours.length &amp;&amp; hours[j] != null) {</span>
<span class="fc" id="L370">					hours[j] = hours[j].trim();</span>
<span class="fc bfc" id="L371" title="All 2 branches covered.">					if (hours[j].length() != 0) {</span>
<span class="fc bfc" id="L372" title="All 2 branches covered.">						if (m_timeOffDays[i] == null) {</span>
<span class="fc" id="L373">							m_timeOffDays[i] = new CalendarTimeOffDay();</span>
						}
<span class="fc" id="L375">						c.set(Calendar.DAY_OF_MONTH, i + minDayOfMonth);</span>
<span class="fc" id="L376">						m_timeOffDays[i].setTimeOffDate(c.getTime());</span>
<span class="fc" id="L377">						double hour = FormInputPC.convertLocalizedRealNumber(hours[j], m_localizer);</span>
<span class="fc" id="L378">						m_timeOffDays[i].setAllocatedHours(hour);</span>
<span class="fc" id="L379">						count++;</span>
					}
				}
			}
			// if there are no time off data then the ejb will can't
			// determine which month we want to clear. To work around
			// this, we add an dummy entry.
<span class="pc bpc" id="L386" title="1 of 4 branches missed.">			if (count == 0 &amp;&amp; m_timeOffDays[0] == null) {</span>
<span class="fc" id="L387">				m_timeOffDays[0] = new CalendarTimeOffDay();</span>
<span class="fc" id="L388">				c.set(Calendar.DAY_OF_MONTH, minDayOfMonth);</span>
<span class="fc" id="L389">				m_timeOffDays[0].setTimeOffDate(c.getTime());</span>
<span class="fc" id="L390">				m_timeOffDays[0].setAllocatedHours(0.0);</span>
			}

<span class="fc" id="L393">			m_pool.setOrganizationId(getOrgID());</span>
<span class="nc" id="L394">		} catch (Exception e) {</span>
<span class="nc" id="L395">			log.l7dError(RmWebLogBundleKey.EXTRACT_PARAM_FAILED, e);</span>
<span class="fc" id="L396">		}</span>

<span class="fc" id="L398">		return success;</span>
	}

	/**
	 * Create Form Model
	 */
	@Override
	protected void createFormModel() {
		try {
<span class="pc bpc" id="L407" title="3 of 4 branches missed.">			if (!isAuthorizedToConfigure() &amp;&amp; isEditMode()) {</span>
				String key;
<span class="nc bnc" id="L409" title="All 2 branches missed.">				if (!isAuthorizedToView()) {</span>
<span class="nc" id="L410">					key = RmWebBundleKey.NOT_AUTHORIZED_TO_VIEW_SELECTED_POOL;</span>
				} else {
<span class="nc" id="L412">					key = RmWebBundleKey.NOT_AUTHORIZED_TO_CONFIG_SELECTED_POOL;</span>
				}

<span class="nc bnc" id="L415" title="All 2 branches missed.">				if (key != null) {</span>
<span class="nc" id="L416">					String msg = i18n(m_rmBundle, key);</span>
<span class="nc" id="L417">					addPageMessage(Message.RESPONSE_TYPE, msg);</span>
				}
			}

<span class="pc bpc" id="L421" title="3 of 4 branches missed.">			if (hasAdvancedRMLicense &amp;&amp; this.getAllocationType().equals(TimeOffCalendarPC.INTERVAL_ALLOCATION_DROPDOWN_VALUE)) {</span>
<span class="nc" id="L422">				populateIntervalCalendar();</span>
			} else {
<span class="fc" id="L424">				populateCalendar(m_calendarPC);</span>
			}

<span class="fc bfc" id="L427" title="All 2 branches covered.">			if (m_poolID == null) {</span>
				// if the user just created a new pool, the request handler would have set the ID here
<span class="fc" id="L429">				m_poolID = m_pool.getId();</span>
			}

<span class="fc bfc" id="L432" title="All 2 branches covered.">			if (m_poolID != null) {</span>
<span class="fc" id="L433">				m_pool = RmManagerFactory.getInstance().getTimeOffDayFacade().getTOPool(m_poolID);</span>
			}
<span class="nc" id="L435">		} catch (Exception ex) {</span>
<span class="nc" id="L436">			handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L437">		}</span>
<span class="fc" id="L438">	}</span>

	/**
	 * Initialize Form Display
	 */
	@Override
	protected void initForm() {
		//Initialize the Time Off Pool Details container
<span class="fc" id="L446">		m_poolDetailsPC.setTitle(i18n(m_rmBundle, RmWebBundleKey.RM_ORG_REQUEST_TIMEOFF_POOL_DETAILS_TITLE));</span>
<span class="fc" id="L447">		ID orgId = getOrgID();</span>
<span class="pc bpc" id="L448" title="4 of 6 branches missed.">		if (orgId == null || (!isAuthorizedToView() &amp;&amp; !isAuthorizedToConfigure())) {</span>
<span class="nc" id="L449">			return;</span>
		}
<span class="fc" id="L451">		m_poolDetailsPC.addRow(getOrganizationLabel(), getOrganizationName());</span>
<span class="fc" id="L452">		m_poolDetailsPC.addRow(i18n(m_rmBundle, RmWebBundleKey.TIME_OFF_POOL_NAME), HtmlUtil.makeTextInput(POOL_NAME_FN, 50, 50, HtmlUtil.escapeAttributeValue(getPoolName()), JSUtil.ON_CHANGE, isAuthorizedToConfigure()));</span>
<span class="fc" id="L453">		m_poolDetailsPC.addRow(i18n(m_rmBundle, RmWebBundleKey.TIME_OFF_POOL_DESCRIPTION), HtmlUtil.makeTextInput(POOL_DESC_FN, 50, 50,HtmlUtil.escapeAttributeValue(getPoolDesc()), JSUtil.ON_CHANGE, isAuthorizedToConfigure()));</span>

		//Initialize the waitlist settings container
<span class="fc" id="L456">		createTimeOffWaitlistForm();</span>
<span class="pc bpc" id="L457" title="1 of 2 branches missed.">		if(hasAdvancedRMLicense) {</span>
<span class="nc" id="L458">			createAllocationType();</span>
		}
<span class="fc" id="L460">		createTimeOffPC();</span>
<span class="fc" id="L461">	}</span>

	@Override
	public Collection getContainers() {
<span class="fc" id="L465">		return m_containerList;</span>
	}

	private void createAllocationType() {
<span class="nc" id="L469">		allocationTypeContainerPC.setTitle(i18n(RmWebBundleKey.TIMEOFF_POOL_ALLOCATION_TYPE));</span>
<span class="nc" id="L470">		allocationTypeContainerPC.addRowData(createAllocationDropdownList());</span>
<span class="nc" id="L471">		allocationTypeContainerPC.setWrapperCSSClass(&quot;fWrapper&quot;);</span>
<span class="nc" id="L472">	}</span>

	private void createTimeOffPC() {

<span class="pc bpc" id="L476" title="3 of 4 branches missed.">		if (hasAdvancedRMLicense &amp;&amp; getAllocationType().equals(TimeOffCalendarPC.INTERVAL_ALLOCATION_DROPDOWN_VALUE)) {</span>
<span class="nc" id="L477">			StringBuilder sb = new StringBuilder(i18n(RmWebBundleKey.TIMEOFF_POOL_INTERVAL_ALLOCATIONS));</span>
<span class="nc" id="L478">			sb.append(this.intervalAllocationPC.getHeader());</span>
<span class="nc" id="L479">			m_availableTimeOffPC.setTitle(sb.toString());</span>
			// addRowData will call addChildComponent, but we are already mid-life cycle so initForDisplay
			// won't be called.  We already added it as a child component, so just add the HTML here.
<span class="nc" id="L482">			m_availableTimeOffPC.addRowData(intervalAllocationPC.getHtmlDisplay());</span>
<span class="nc" id="L483">			m_availableTimeOffPC.setRowCSSClasses(ROW_NO_BOTTOM_CSS);</span>
<span class="nc" id="L484">			m_availableTimeOffPC.setLastRowType(ListContainerPC.LAST_ROW_NONE);</span>
<span class="nc" id="L485">		} else {</span>
			//Initialize the Calendar container
<span class="fc" id="L487">			m_availableTimeOffPC.setName(&quot;dailyTimeOffPC&quot;);</span>
<span class="fc" id="L488">			m_availableTimeOffPC.setLastRowType(ListContainerPC.LAST_ROW_NONE);</span>
			// The legend contains user visible strings.
<span class="fc" id="L490">			String imgName = i18nStaticFileUrl(m_rmBundle, RmWebBundleKey.RM_ORG_REQUEST_TIMEOFF_LEGEND_IMG);</span>
<span class="fc" id="L491">			String imageTag = &quot;&lt;IMG src=\&quot;&quot; + imgName + &quot;\&quot; name=\&quot;calendarImg\&quot;/&gt;&quot;;</span>
<span class="fc" id="L492">			Object[] calRow = new Object[] { m_ownerOrganizationHtml, imageTag, m_calendarPC };</span>
<span class="fc" id="L493">			m_availableTimeOffPC.setRowCSSClasses(ROW_NO_BOTTOM_CSS);</span>
<span class="fc" id="L494">			m_availableTimeOffPC.setTitle(getFormTitle());</span>
<span class="fc" id="L495">			m_availableTimeOffPC.addRowData(CAL_FORMAT.format(calRow));</span>
		}
<span class="fc" id="L497">	}</span>

	/**
	 * Creates the Time Off Waitlist Form
	 *
	 */
	private void createTimeOffWaitlistForm() {
<span class="pc bpc" id="L504" title="1 of 2 branches missed.">		boolean disabled = !isAuthorizedToConfigure();</span>
<span class="fc" id="L505">		m_wlScanEnabled = m_pool.isIsWaitlistscan();</span>
<span class="fc" id="L506">		boolean isWaitlistFeatureEnabled = TORequestUtil.isTOWaitlistFeatureEnabled();</span>
<span class="pc bpc" id="L507" title="2 of 6 branches missed.">		boolean isWlDisabled = (disabled || !isWaitlistFeatureEnabled || !m_pool.isWaitlistEnabled());</span>

<span class="fc" id="L509">		String title = i18n(m_rmBundle, RmWebBundleKey.ORG_RM_WAITLIST_SETTINGS);</span>
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">		if (!isWaitlistFeatureEnabled) {</span>
<span class="nc" id="L511">			disabled = true;</span>
		}
		//m_waitlistTOContainerPC.setWidth(&quot;99%&quot;);
<span class="fc" id="L514">		m_waitlistTOContainerPC.setWrapperCSSClass(&quot;fWrapper&quot;);</span>
		//m_waitlistTOContainerPC.setLastRowType(ListContainerPC.LAST_ROW_NONE);

<span class="fc" id="L517">		Pair[] wlPriorityorder = m_pool.getTOWaitlistPriortyOrderSettings();</span>

		{
<span class="fc" id="L520">			String nameKey = getNameKey(RmSettingKey.ORG_RM_SETTINGS_TO_WAITLIST_FEATURE_ENABLE);</span>
<span class="fc" id="L521">			String key = RmWebBundleKey.ORG_RM_SETTINGS_TO_WAITLIST_FEATURE_ENABLE;</span>
<span class="fc" id="L522">			boolean checked = m_pool.isWaitlistEnabled();</span>
<span class="fc" id="L523">			String checkbox = makeChoiceInput(nameKey, &quot;true&quot;, checked, disabled, true, JSUtil.ON_CHANGE + &quot;;disableWLFields();&quot;);</span>
<span class="fc" id="L524">			String label = i18n(m_rmBundle, key);</span>
<span class="fc" id="L525">			m_waitlistTOContainerPC.addRowData(checkbox + &quot; &quot; + label);</span>
		}

		{
<span class="fc" id="L529">			String nameKey = getNameKey(RmSettingKey.ORG_RM_SETTINGS_TO_WAITLIST_SCAN_ENABLE);</span>
<span class="fc" id="L530">			String key = RmWebBundleKey.ORG_RM_SETTINGS_TO_WAITLIST_SCAN_ENABLE;</span>
<span class="fc" id="L531">			boolean checked = m_wlScanEnabled;</span>
<span class="fc" id="L532">			String checkbox = makeChoiceInput(nameKey, &quot;true&quot;, checked, isWlDisabled, true);</span>
<span class="fc" id="L533">			String label = i18n(m_rmBundle, key);</span>
<span class="fc" id="L534">			m_waitlistTOContainerPC.addRowData(checkbox + &quot; &quot; + label);</span>
		}
		{
<span class="fc" id="L537">			String message = i18n(m_rmBundle, RmWebBundleKey.ORG_RM_WAITLIST_PRIORITIES);</span>
<span class="fc" id="L538">			m_waitlistTOContainerPC.addRowData(message);</span>
		}
		{
<span class="fc" id="L541">			Pair firstSort = null;</span>
<span class="pc bpc" id="L542" title="1 of 2 branches missed.">			if (wlPriorityorder != null) {</span>
<span class="fc" id="L543">				firstSort = wlPriorityorder[0];</span>
			}
<span class="fc" id="L545">			String nameKey = getNameKey(RmSettingKey.ORG_RM_SETTINGS_TO_WAITLIST_ORDER_PREFIX + &quot;0&quot;);</span>

<span class="fc bfc" id="L547" title="All 8 branches covered.">			m_waitlistTOContainerPC.addRowData(makeWLPriorityDropDown(nameKey + COLUMN, firstSort != null ? (String) firstSort.getFirst() : null, false, !isWlDisabled) + makeAscDescDropDown(nameKey + ORDER, firstSort != null ? (String) firstSort.getSecond() : null, false, !isWlDisabled) + HtmlUtil.NBSP + &quot;(&quot; + i18n(m_rmBundle, RmWebBundleKey.ORG_RM_WAITLIST_FIRST_PRIORITY) + &quot;)&quot;);</span>
		}

		{
<span class="fc" id="L551">			Pair secondSort = null;</span>
<span class="pc bpc" id="L552" title="1 of 2 branches missed.">			if (wlPriorityorder != null) {</span>
<span class="fc" id="L553">				secondSort = wlPriorityorder[1];</span>
			}
<span class="fc" id="L555">			String nameKey = getNameKey(RmSettingKey.ORG_RM_SETTINGS_TO_WAITLIST_ORDER_PREFIX + &quot;1&quot;);</span>

<span class="fc bfc" id="L557" title="All 8 branches covered.">			m_waitlistTOContainerPC.addRowData(makeWLPriorityDropDown(nameKey + COLUMN, secondSort != null ? (String) secondSort.getFirst() : null, true, !isWlDisabled) + makeAscDescDropDown(nameKey + ORDER, secondSort != null ? (String) secondSort.getSecond() : null, true, !isWlDisabled) + HtmlUtil.NBSP + &quot;(&quot; + i18n(m_rmBundle, RmWebBundleKey.ORG_RM_WAITLIST_SECOND_PRIORITY) + &quot;)&quot;);</span>
		}

		{
<span class="fc" id="L561">			Pair thirdSort = null;</span>
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">			if (wlPriorityorder != null) {</span>
<span class="fc" id="L563">				thirdSort = wlPriorityorder[2];</span>
			}
<span class="fc" id="L565">			String nameKey = getNameKey(RmSettingKey.ORG_RM_SETTINGS_TO_WAITLIST_ORDER_PREFIX + &quot;2&quot;);</span>

<span class="pc bpc" id="L567" title="2 of 8 branches missed.">			m_waitlistTOContainerPC.addRowData(makeWLPriorityDropDown(nameKey + COLUMN, thirdSort != null ? (String) thirdSort.getFirst() : null, true, !isWlDisabled) + makeAscDescDropDown(nameKey + ORDER, thirdSort != null ? (String) thirdSort.getSecond() : null, true, !isWlDisabled) + HtmlUtil.NBSP + &quot;(&quot; + i18n(m_rmBundle, RmWebBundleKey.ORG_RM_WAITLIST_THIRD_PRIORITY) + &quot;)&quot;);</span>
		}

		//add hidden input for waitlist enabled setting
<span class="fc" id="L571">		m_context.addGenericHTML(HtmlUtil.makeHiddenInput(WL_SAVE_PRIORITY_FN, disabled));</span>

		//add hidden field for db value of is auto scan enabled to trigger auto process accordingly
<span class="fc" id="L574">		m_context.addGenericHTML(HtmlUtil.makeHiddenInput(WL_SCAN_ENABLED_FN, m_wlScanEnabled));</span>

<span class="fc" id="L576">		m_waitlistTOContainerPC.setTitle(title);</span>

		// Add the Waitlist Form
		//addChildComponent(m_waitlistTOContainerPC);
<span class="fc" id="L580">	}</span>

	private String makeChoiceInput(String name, String value, boolean checked, boolean disabled, boolean isMultiSelect) {
<span class="fc" id="L583">		return makeChoiceInput(name, value, checked, disabled, isMultiSelect, JSUtil.ON_CHANGE);</span>
	}

	private String makeChoiceInput(String name, String value, boolean checked, boolean disabled, boolean isMultiSelect, String onClickJS) {
<span class="fc" id="L587">		m_choiceInput.reset();</span>
<span class="fc" id="L588">		m_choiceInput.setIsMultiSelect(isMultiSelect);</span>
<span class="fc" id="L589">		m_choiceInput.setInputName(name);</span>
<span class="fc" id="L590">		m_choiceInput.setValue(value);</span>
<span class="fc" id="L591">		m_choiceInput.setIsChecked(checked);</span>
<span class="fc" id="L592">		m_choiceInput.setIsDisabled(disabled);</span>
<span class="fc" id="L593">		m_choiceInput.setOnClickJS(onClickJS);</span>
<span class="fc" id="L594">		return m_choiceInput.getHtmlDisplay();</span>
	}

	/**
	 * Convert setting key name to form parameter name.
	 * Basically, form field names can't contain '/'. In addition,
	 * sometime the key name is used as the 'id' form attribute
	 * value.
	 *
	 * @param key - setting key name (with '/')
	 * @return String  form field name (with '/' replaced by '_')
	 */
	public static String getNameKey(String key) {
<span class="fc" id="L607">		return key.replace('/', '_');</span>
	}

	/**
	 * Create HTML for Drop down for View selection
	*/
	private String makeWLPriorityDropDown(String fieldName, String selValue, boolean isOptional, boolean isEnabled) {
<span class="fc" id="L614">		ArrayList options = new ArrayList();</span>
<span class="fc bfc" id="L615" title="All 2 branches covered.">		if (isOptional) {</span>
<span class="fc" id="L616">			options.add(new StringsPair(&quot;&quot;, &quot;&quot;));</span>
		}
<span class="fc" id="L618">		options.add(new StringsPair(String.valueOf(Request.SORT_TO_SENIORITY), m_localizer.i18n(m_common_bundle, UIFWebBundleKey.SENIORITY)));</span>
<span class="fc" id="L619">		options.add(new StringsPair(String.valueOf(Request.SORT_EMP_RANK), m_localizer.i18n(m_common_bundle, UIFWebBundleKey.RANK)));</span>
<span class="fc" id="L620">		options.add(new StringsPair(String.valueOf(Request.SORT_CREATED), m_localizer.i18n(m_common_bundle, UIFWebBundleKey.SUBMITTED)));</span>
<span class="fc" id="L621">		options.add(new StringsPair(String.valueOf(Request.SORT_TO_WAITLIST_PENDING_DAYS), m_localizer.i18n(m_rmBundle, RmWebBundleKey.SORT_TO_WAITLIST_PENDING_DAYS)));</span>
<span class="fc" id="L622">		options.add(new StringsPair(String.valueOf(Request.SORT_TO_WAITLIST_PENDING_DATE_TIME), m_localizer.i18n(m_rmBundle, RmWebBundleKey.SORT_TO_WAITLIST_PENDING_DATE_TIME)));</span>
<span class="fc" id="L623">		options.add(new StringsPair(String.valueOf(Request.SORT_TO_WAITLIST_TOCHOICE_REQ_LENGTH), m_localizer.i18n(m_common_bundle, UIFWebBundleKey.LENGTH)));</span>
<span class="fc" id="L624">		options.add(new StringsPair(String.valueOf(Request.SORT_TO_WAITLIST_TOCHOICE_ALLOCATION_HOURS), m_localizer.i18n(m_rmBundle, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_LABEL)));</span>

<span class="fc" id="L626">		String[] selVal = new String[1];</span>
<span class="fc bfc" id="L627" title="All 2 branches covered.">		if (selValue != null) {</span>
<span class="fc" id="L628">			selVal[0] = selValue;</span>
		} else {
<span class="fc" id="L630">			selVal[0] = &quot;&quot;;</span>
		}

<span class="fc" id="L633">		return HtmlUtil.makeSelectInput(fieldName, selVal, JSUtil.ON_CHANGE, options, false, isEnabled);</span>
	}

	/**
	 * Create HTML for Drop down for View selection
	 */
	private String makeAscDescDropDown(String fieldName, String selValue, boolean isOptional, boolean isEnabled) {
<span class="fc" id="L640">		ArrayList options = new ArrayList();</span>
<span class="fc bfc" id="L641" title="All 2 branches covered.">		if (isOptional) {</span>
<span class="fc" id="L642">			options.add(new StringsPair(&quot;&quot;, &quot;&quot;));</span>
		}
<span class="fc" id="L644">		options.add(new StringsPair(&quot;ASC&quot;, m_localizer.i18n(m_common_bundle, UIFWebBundleKey.ASCENDING)));</span>
<span class="fc" id="L645">		options.add(new StringsPair(&quot;DESC&quot;, m_localizer.i18n(m_common_bundle, UIFWebBundleKey.DESCENDING)));</span>

<span class="fc" id="L647">		String[] selVal = new String[1];</span>
<span class="fc bfc" id="L648" title="All 2 branches covered.">		if (selValue != null) {</span>
<span class="fc" id="L649">			selVal[0] = selValue;</span>
		} else {
<span class="fc" id="L651">			selVal[0] = &quot;&quot;;</span>
		}

<span class="fc" id="L654">		return HtmlUtil.makeSelectInput(fieldName, selVal, JSUtil.ON_CHANGE, options, false, isEnabled);</span>
	}

	public void setSavePriorityDisabled(boolean savePriorityDisabled) {
<span class="fc" id="L658">		m_savePriorityDisabled = savePriorityDisabled;</span>
<span class="fc" id="L659">	}</span>

	public boolean getSavePriorityDisabled() {
<span class="nc" id="L662">		return m_savePriorityDisabled;</span>
	}

	public void setWlScanEnabled(boolean wlScanEnabled) {
<span class="fc" id="L666">		m_wlScanEnabled = wlScanEnabled;</span>
<span class="fc" id="L667">	}</span>

	public boolean getWlScanEnabled() {
<span class="fc" id="L670">		return m_wlScanEnabled;</span>
	}

	/**
	 * Renders the TimeOffYear Form
	 * @return	ListContainerPC	Instance of ListContainerPC
	 */
	public ListContainerPC getTOWaitlistForm() {
<span class="nc" id="L678">		return m_waitlistTOContainerPC;</span>
	}

	/**
	 * Initialize Toolbar
	 * Adds the Delete and Revert button
	 */
	@Override
	protected void initToolbar() {
<span class="fc" id="L687">		String blackoutRangeLabel = i18n(m_rmBundle, RmWebBundleKey.RM_ORG_REQUEST_TIMEOFF_SET_BLACKOUT_DAY_RANGE);</span>
<span class="fc" id="L688">		String importLabel = i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_IMPORT);</span>
<span class="fc" id="L689">		String saveLabel = i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SAVE);</span>
<span class="fc" id="L690">		String clearLabel = i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_CLEAR);</span>
<span class="fc" id="L691">		String revertLabel = i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_RESET);</span>

<span class="fc" id="L693">		m_toolbar.setName(getName() + &quot;_toolbar&quot;);</span>
<span class="fc" id="L694">		boolean enableImport = false;</span>
<span class="pc bpc" id="L695" title="1 of 2 branches missed.">		if (isAuthorizedToConfigure()) {</span>
<span class="fc" id="L696">			ID orgId = getOrgID();</span>
<span class="pc bpc" id="L697" title="1 of 2 branches missed.">			enableImport = orgId != null;</span>
		}

<span class="fc" id="L700">		initIntervalToolbarButtons();</span>

<span class="pc bpc" id="L702" title="1 of 4 branches missed.">		m_toolbar.addPopupWindowTextButton(RmPageAction.SET_BLACKOUT_RANGE_ACTION, blackoutRangeLabel, isAuthorizedToConfigure() &amp;&amp; m_poolID != null);</span>

<span class="pc bpc" id="L704" title="1 of 4 branches missed.">		m_toolbar.addPopupWindowTextButton(PageAction.IMPORT, importLabel, enableImport &amp;&amp; m_poolID != null);</span>

<span class="pc bpc" id="L706" title="1 of 2 branches missed.">		String clearJS = isIntervalAllocationType() ? &quot;top.workpaneMediator.clearForm();&quot; : &quot;clearAllDayInput()&quot;;</span>
<span class="fc" id="L707">		m_toolbar.addJSTextButton(PageAction.CLEAR, clearLabel, isAuthorizedToConfigure(), clearJS);</span>

<span class="fc" id="L709">		m_toolbar.addResetTextButton(PageAction.RESET, revertLabel, isAuthorizedToConfigure());</span>

<span class="fc" id="L711">		m_toolbar.addValidateSubmitTextButton(PageAction.SAVE, saveLabel, isAuthorizedToConfigure());</span>

<span class="fc" id="L713">		m_toolbar.addConfirmSubmitTextButton(PageAction.CANCEL, i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_CANCEL), true);</span>
<span class="fc" id="L714">	}</span>

	private void initIntervalToolbarButtons() {
<span class="pc bpc" id="L717" title="1 of 2 branches missed.">		if (!isIntervalAllocationType()) {</span>
<span class="fc" id="L718">			return;</span>
		}
		// Interval action button (hidden because it is triggered by javascript).
<span class="nc" id="L721">		ToolbarTextButton createEditInterval = m_toolbar.addSubmitTextButton(RmPageAction.TOIC_INTERVAL_ACTION, &quot;&quot;,</span>
<span class="nc" id="L722">				isAuthorizedToConfigure());</span>
<span class="nc" id="L723">		createEditInterval.setAttribute(&quot;style&quot;, &quot;display:none&quot;);</span>
<span class="nc" id="L724">		createEditInterval.setAttribute(&quot;name&quot;, RmPageAction.TOIC_INTERVAL_ACTION);</span>

<span class="nc" id="L726">		String createIntervalJS = &quot;intervalAllocationPC.showCreateIntervalDialog();&quot;;</span>
<span class="nc" id="L727">		String createIntervalText = i18n(RmWebBundleKey.TIMEOFF_POOL_CREATE_INTERVAL);</span>
<span class="nc" id="L728">		m_toolbar.addJSTextButton(&quot;intervalAllocationPC&quot;, createIntervalText, isAuthorizedToConfigure(), createIntervalJS);</span>
<span class="nc" id="L729">	}</span>

	// required abstract method that is not needed.
	@Override
	protected void initFieldValidators() {
<span class="fc" id="L734">	}</span>

	/**
	 * Validates the Page Component
	 *
	 * NOTE: This method recurse through all sub-components
	 */
	@Override
	public boolean validate() {
<span class="fc" id="L743">		boolean success = super.validate();</span>

		//validate the pool name and description
<span class="pc bpc" id="L746" title="2 of 4 branches missed.">		if (m_pool.getName() == null || m_pool.getName().length() == 0) {</span>
<span class="nc" id="L747">			this.addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.TIME_OFF_POOL_MISSING_NAME, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L748">			success = false;</span>
		} else {
			try {
<span class="pc bpc" id="L751" title="2 of 4 branches missed.">				if (m_pool != null &amp;&amp; m_pool.getName() != null) {</span>
<span class="fc" id="L752">					m_pool.setName(m_pool.getName().trim());</span>
				}
<span class="fc" id="L754">				ID id = AvailableTimeOffModelHandler.getPoolIDForName(m_pool.getName());</span>
<span class="pc bpc" id="L755" title="1 of 4 branches missed.">				if (id != null &amp;&amp; !id.equals(m_poolID)) {</span>
<span class="nc" id="L756">					this.addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.TIME_OFF_POOL_DUPLICATE_NAME, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L757">					success = false;</span>
				}
<span class="nc" id="L759">			} catch (Exception e) {</span>
<span class="fc" id="L760">			}</span>
		}
<span class="fc" id="L762">		return success;</span>
	}

	public String getCalendarForm() {
<span class="nc" id="L766">		return &quot;&quot;;</span>
	}

	/**
	 * Return the form title
	 * @return form title
	 */
	@Override
	public String getFormTitle() {
<span class="fc" id="L775">		return i18n(m_rmBundle, RmWebBundleKey.RM_ORG_REQUEST_TIMEOFF_CALENDAR_PAGE_TITLE);</span>
	}

	/**
	 * Get entity name. Used for title.
	 */
	@Override
	protected String getTitleEntityType() {
<span class="fc" id="L783">		return i18n(m_rmBundle, RmWebBundleKey.RM_ORG_REQUEST_PROCESSING_AVAILABLETIMEOFF);</span>
	}

	/**
	 * Returns an entity name. Used for title.
	 */
	@Override
	protected String getEntityName() {
<span class="fc" id="L791">		return getPoolName();</span>
	}

	/**
	 * Return URL for HTML Form Action
	 */
	@Override
	public String getFormAction() {
<span class="fc" id="L799">		return &quot;request_processing_availableto&quot;;</span>
	}

	public CalendarTimeOffDay[] getCalendarTimeOffDays() {
<span class="fc" id="L803">		return m_timeOffDays;</span>
	}

	public int getMonth() {
<span class="nc" id="L807">		return m_month;</span>
	}

	public int getYear() {
<span class="nc" id="L811">		return m_year;</span>
	}

	@Override
	protected boolean isAuthorizedToView() {
<span class="pc bpc" id="L816" title="2 of 4 branches missed.">		return isValidSelectedOrg() &amp;&amp; m_context.getUser().isAuthorized(PrivilegeKeys.TOM_VIEWAVAILABLETIMEOFF, OrganizationScopeManagerProxy.getScopeID(getOrgID()));</span>
	}

	@Override
	protected boolean isAuthorizedToConfigure() {
<span class="pc bpc" id="L821" title="3 of 6 branches missed.">		return isValidSelectedOrg() &amp;&amp; isEditMode() &amp;&amp; m_context.getUser().isAuthorized(PrivilegeKeys.TOM_EDITAVAILABLETIMEOFF, OrganizationScopeManagerProxy.getScopeID(getOrgID()));</span>
	}

	/**
	 * Return true if the user pressed the &quot;Edit&quot; or &quot;Create&quot; button to get here.
	 * Return false if the user pressed the &quot;View&quot; button to get here.
	 */
	protected boolean isEditMode() {
<span class="pc bpc" id="L829" title="1 of 6 branches missed.">		return isAction(PageAction.EDIT) || isAction(PageAction.ADD) || m_isEditMode;</span>
	}

	/**
	 * Setter for pool ID. Automatically extracted when editing a pool from the list page.
	 * @param poolID
	 */
	public void setPerformActionOnID(ID poolID) {
<span class="fc" id="L837">		setPoolID(poolID);</span>
<span class="fc" id="L838">	}</span>

	/**
	 * Setter for pool ID. Automatically extracted from the hidden variable after creating a new pool.
	 * @param poolID
	 */
	public void setPoolID(String poolID) {
<span class="pc bpc" id="L845" title="2 of 4 branches missed.">		if (poolID != null &amp;&amp; poolID.length() &gt; 0) {</span>
<span class="fc" id="L846">			setPoolID(new ID(poolID));</span>
		}
<span class="fc" id="L848">	}</span>

	public void setPoolID(ID poolID) {
<span class="fc" id="L851">		super.setPerformActionOnID(poolID.toString()); //QC#78704</span>
<span class="fc" id="L852">		m_poolID = poolID;</span>
<span class="fc" id="L853">		m_pool.setId(poolID);</span>
<span class="fc" id="L854">	}</span>

	public ID getPoolID() {
<span class="fc" id="L857">		return m_poolID;</span>
	}

	public ID getOrgID() {
<span class="fc" id="L861">		return getSelectedIDObject();</span>
	}

	/**
	 * Setter for pool Name. Automatically extracted.
	 * @param poolName
	 */
	public void setPoolName(String poolName) {
<span class="fc" id="L869">		m_pool.setName(poolName);</span>
<span class="fc" id="L870">	}</span>

	/**
	 * Getter for pool Name.
	 * @return the time off pool name
	 */
	public String getPoolName() {
<span class="pc bpc" id="L877" title="1 of 2 branches missed.">		return m_pool == null ? &quot;&quot; : m_pool.getName();</span>
	}

	/**
	 * Getter for pool description.
	 * @return the time off pool description
	 */
	public String getPoolDesc() {
<span class="pc bpc" id="L885" title="1 of 2 branches missed.">		return m_pool == null ? &quot;&quot; : m_pool.getDescription();</span>
	}

	/**
	 * Setter for pool Description. Automatically extracted.
	 * @param poolDesc
	 */
	public void setPoolDesc(String poolDesc) {
<span class="fc" id="L893">		m_pool.setDescription(poolDesc);</span>
<span class="fc" id="L894">	}</span>

	/**
	 * Getter for the Time Off Pool.
	 * @return the time off pool.
	 */
	public TOPool getPool() {
<span class="fc" id="L901">		return m_pool;</span>
	}

	/*
	 * Return the Required HTML for this component.
	 */
	@Override
	public String getRequiredHTML() {
		//store poolID and poolName for the Import Dialog to read
<span class="fc bfc" id="L910" title="All 2 branches covered.">		return super.getRequiredHTML() + (m_poolID == null ? &quot;&quot; : HtmlUtil.makeHiddenInput(WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN, m_poolID) + HtmlUtil.makeHiddenInput(POOL_ID_FN, m_poolID)) +</span>

<span class="fc" id="L912">		HtmlUtil.makeHiddenInput(SELECTED_ID_FN, getSelectedID()) +</span>

<span class="pc bpc" id="L914" title="1 of 2 branches missed.">		HtmlUtil.makeHiddenInput(&quot;isEditMode&quot;, isEditMode() ? &quot;true&quot; : &quot;false&quot;);</span>
	}

	public void setIsEditMode(boolean isEditMode) {
<span class="fc" id="L918">		m_isEditMode = isEditMode;</span>
<span class="fc" id="L919">	}</span>

	@Override
	public void initForDisplay() {
<span class="pc bpc" id="L923" title="1 of 2 branches missed.">		if (m_isInitializedForDisplay)  {</span>
<span class="nc" id="L924">			return;</span>
		} else {
<span class="fc" id="L926">			super.initForDisplay();</span>
		}
<span class="fc" id="L928">	}</span>
	public String getAllocationType() {
<span class="fc" id="L930">		String allocationTypeSession = (String) m_context.getAttribute(RequestContext.SESSION_SCOPE, ALLOCATION_SESSION_KEY);</span>
<span class="pc bpc" id="L931" title="1 of 2 branches missed.">		return StringUtil.isEmpty(allocationTypeSession)? timeOffAllocationType:allocationTypeSession;</span>
	}

	public void setAllocationType(String type) {
<span class="nc" id="L935">		timeOffAllocationType = type;</span>
<span class="nc" id="L936">		m_context.setAttribute(RequestContext.SESSION_SCOPE, ALLOCATION_SESSION_KEY, type);</span>
<span class="nc" id="L937">	}</span>

	/**
	 * Gets whether interval allocation is enabled and selected.
	 */
	public boolean isIntervalAllocationType() {
<span class="fc" id="L943">		boolean isIntervalAllocation = getAllocationType().equals(TimeOffCalendarPC.INTERVAL_ALLOCATION_DROPDOWN_VALUE);</span>
<span class="pc bpc" id="L944" title="3 of 4 branches missed.">		return hasAdvancedRMLicense &amp;&amp; isIntervalAllocation;</span>
	}

	private String i18n(String key) {
<span class="nc" id="L948">		return i18n(m_rmBundle, key);</span>
	}

	/**
	 * Create HTML for Drop down for Allocation type selection if having Advance RM license
	 */
	@SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
	private String createAllocationDropdownList() {
<span class="nc" id="L956">		ArrayList options = new ArrayList();</span>
<span class="nc" id="L957">		options.add(new StringsPair(TimeOffCalendarPC.DAILY_ALLOCATION_DROPDOWN_VALUE, i18n(RmWebBundleKey.TIMEOFF_POOL_DAILY_ALLOCATIONS)));</span>
<span class="nc" id="L958">		options.add(new StringsPair(TimeOffCalendarPC.INTERVAL_ALLOCATION_DROPDOWN_VALUE, i18n(RmWebBundleKey.TIMEOFF_POOL_INTERVAL_ALLOCATIONS)));</span>
<span class="nc" id="L959">		String onChangeJS = &quot;return pageMediator.onAllocationTypeChange();&quot;;</span>
<span class="nc" id="L960">		return HtmlUtil.makeSelectInput(ALLOCATION_TYPE_FN, getAllocationType(), onChangeJS.toString(), options);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>