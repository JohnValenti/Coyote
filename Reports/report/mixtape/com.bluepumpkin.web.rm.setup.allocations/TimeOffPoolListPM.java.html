<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffPoolListPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.setup.allocations</a> &gt; <span class="el_source">TimeOffPoolListPM.java</span></div><h1>TimeOffPoolListPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.setup.allocations;

import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Iterator;
import java.util.ResourceBundle;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.workresource.OrganizationScopeManagerProxy;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrgWorkpaneListPageModel;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.bluepumpkin.web.bbm.people.PeopleMH;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;

public class TimeOffPoolListPM extends OrgWorkpaneListPageModel 
{
<span class="fc" id="L29">	private static final Category log = Log.initCategory(TimeOffPoolListPM.class.getName());</span>
	private Collection m_timeOffPoolList;
	private ResourceBundle m_rmBundle;
	
	public static final String NAME_SORT = &quot;NAME_SORT&quot;;
	public static final String DESC_SORT = &quot;DESC_SORT&quot;;
	public static final String OWNER_ORG_SORT = &quot;OWNER_ORG_SORT&quot;;

	/**
	 * Constructor
	 */
	public TimeOffPoolListPM(RequestContext context) 
	{
<span class="fc" id="L42">		super(context);</span>
<span class="fc" id="L43">		m_list.setIsZebra(true);</span>
<span class="fc" id="L44">		m_rmBundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L45">		setName(&quot;timeOffPoolList&quot;);</span>
<span class="fc" id="L46">	}</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) 
	{
<span class="fc" id="L53">		return getInstance(context, TimeOffPoolListPM.class);</span>
	}

	/**
	 * Loads all the Time Off Pool value objects for the selected Organization ID
	 *
	 * @return true if load was successful
	 */
	private boolean loadPools() 
	{
		try 
		{
<span class="fc" id="L65">			ID orgID =  getSelectedIDObject();</span>
<span class="fc" id="L66">			m_timeOffPoolList = PeopleMH.getTOPoolsForOrg(orgID, true);</span>
<span class="fc" id="L67">			return true;</span>
		} 
<span class="nc" id="L69">		catch (Exception ex) </span>
		{
<span class="nc" id="L71">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L72">			return false;</span>
		}
	}

	/**
	 * Initialize List
	 */
	protected void initList() 
	{
<span class="fc" id="L81">		super.initList();</span>

		// Setup Headers
<span class="fc" id="L84">		TableHeaderPC header = m_list.getHeader();</span>
<span class="fc" id="L85">		header.setSortable(true);</span>
<span class="fc" id="L86">		header.addColumnHeaderData(NAME_SORT,	i18n(m_bbmBundle, BbmWebBundleKey.PEOPLE_TIMEOFF_POOL_HEADER));</span>
<span class="fc" id="L87">		header.addColumnHeaderData(DESC_SORT,	i18n(m_bbmBundle, BbmWebBundleKey.ORG_EMPLOYEETYPE_DESC_LABEL));</span>
<span class="fc" id="L88">		header.addColumnHeaderData(OWNER_ORG_SORT,	i18n(m_bbmBundle, BbmWebBundleKey.LIST_HEADER_OWNER_ORG));</span>

		// Setup basic table property
<span class="fc" id="L91">		m_list.setIsAutoSortEnabled(true);</span>
<span class="fc" id="L92">		m_list.setMultiRowSelectable(false);</span>
<span class="fc" id="L93">	}</span>

	/**
	 * Initialize toolbar
	 */
	protected void initToolbar() 
	{
<span class="fc" id="L100">		String addLabel = i18n(m_bbmBundle, BbmWebBundleKey.TOOLBAR_CREATE);</span>
<span class="fc" id="L101">		String viewLabel = i18n(m_bbmBundle, BbmWebBundleKey.TOOLBAR_VIEW);</span>
<span class="fc" id="L102">		String editLabel = i18n(m_bbmBundle,BbmWebBundleKey.TOOLBAR_EDIT); //checkConfigurePrivilege(getSelectedIDObject())?BbmWebBundleKey.TOOLBAR_EDIT:BbmWebBundleKey.TOOLBAR_VIEW);</span>
<span class="fc" id="L103">		String delLabel = i18n(m_bbmBundle, BbmWebBundleKey.TOOLBAR_DELETE);</span>

		//useDefaultToolbar(false, addLabel, editLabel, delLabel);
		
		//ADD
<span class="fc" id="L108">		m_toolbar.addSubmitTextButton(PageAction.ADD, addLabel, isAddActionEnabled());</span>

		//VIEW
<span class="pc bpc" id="L111" title="2 of 4 branches missed.">		m_toolbar.addSubmitTextButton(PageAction.VIEW, viewLabel, isAuthorizedToView() &amp;&amp; getPoolID()!=null);</span>

		//EDIT
<span class="fc" id="L114">		ToolbarTextButton editBtn = m_toolbar.addSubmitTextButton(PageAction.EDIT, editLabel, isEditActionEnabled());</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">		if (m_isSingleItemEdit) editBtn.setListButtonItems(1, 1);</span>
		
		//DELETE
<span class="fc" id="L118">		m_toolbar.addDeleteTextButton(PageAction.DELETE, delLabel, isDeleteActionEnabled());</span>
		

<span class="fc" id="L121">	}</span>

	/**
	 * Create the list model
	 */
	protected void createListModel() 
	{
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">		if (!loadPools()) </span>
<span class="nc" id="L129">			return;</span>

<span class="fc" id="L131">		ArrayList listModel = new ArrayList();</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">		for(Iterator it = m_timeOffPoolList.iterator(); it.hasNext();) </span>
		{
<span class="fc" id="L134">			TOPool pool = (TOPool)it.next();</span>

			// Create the row data
<span class="fc" id="L137">			String rowID = pool.getID().toString();</span>
<span class="fc" id="L138">			DefaultMultiColumnNodeData row_data =  new DefaultMultiColumnNodeData(rowID);</span>
            
            //Add Pool Name column
<span class="fc" id="L141">			row_data.add(pool.getName());</span>
            
            //Add Description column
<span class="fc" id="L144">			row_data.add(pool.getDescription());</span>
            
            //Add Owner Organization column
<span class="fc" id="L147">            ID orgID = pool.getOrganizationId();</span>
<span class="fc" id="L148">			row_data.add(getOrganizationName(orgID));</span>

<span class="pc bpc" id="L150" title="1 of 2 branches missed.">			row_data.getNodeAttributes().put(IS_ADDABLE, isAddActionEnabled()?&quot;true&quot;:&quot;false&quot;);</span>
			
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">			row_data.getNodeAttributes().put(IS_EDITABLE, isPoolEditable(pool)?&quot;true&quot;:&quot;false&quot;);</span>

<span class="pc bpc" id="L154" title="1 of 2 branches missed.">			row_data.getNodeAttributes().put(IS_VIEWABLE, isAuthorizedToView(orgID)?&quot;true&quot;:&quot;false&quot;);</span>

<span class="pc bpc" id="L156" title="1 of 2 branches missed.">            if (!isPoolEditable(pool))</span>
<span class="nc" id="L157">                row_data.getNodeAttributes().put(IS_DELETEABLE, &quot;false&quot;);</span>

			// Add row data to list model
<span class="fc" id="L160">			listModel.add(row_data);</span>

			// Check if row should be selected, assuming only one should be selected
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">			if (OrganizationModelHandler.UNREASONABLE_ORG_ID.equals(m_selectedRowOrgID)) </span>
			{
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">				if(this.isRowSelected(pool.getID())) </span>
				{
<span class="nc" id="L167">					m_list.addSelectedRowID(rowID);</span>
<span class="nc" id="L168">					m_selectedRowOrgID = pool.getOrganizationId();</span>
				}
			}
<span class="fc" id="L171">		} //end for</span>

<span class="fc" id="L173">		m_list.setListModel(listModel);</span>
<span class="fc" id="L174">	}</span>

	/**
	 * Returns true if the list support sorting.
	 * This method should be override by derived classes who support sorting
	 */
	protected boolean isSortSupported() 
	{
<span class="fc" id="L182">		return true;</span>
	}


	/**
	 * Return the Selected Pool IDs
	 *
	public ID[] getSelectedPoolIDs() 
	{
		return m_performActionOnIDs;
	}
	*/
	
	public ID getPoolID()
	{
<span class="fc" id="L197">		String poolIDString = getPerformActionOnID();</span>
<span class="pc bpc" id="L198" title="2 of 4 branches missed.">		if (poolIDString==null || poolIDString.isEmpty())</span>
<span class="fc" id="L199">			return null;</span>
		
<span class="nc" id="L201">		return new ID(poolIDString);</span>
	}
	
	public ID getOrgID()
	{
<span class="nc" id="L206">		return getSelectedIDObject();</span>
	}
	
	/**
	 * Get entity name. Used for title.
	 */
	protected String getTitleEntityType() 
	{
<span class="fc" id="L214">		return i18n(m_rmBundle, RmWebBundleKey.RM_ORG_REQUEST_PROCESSING_TIMEOFFPOOLS_PAGE_TITLE);</span>
	}

	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() 
	{
<span class="fc" id="L222">		return &quot;request_processing_topoollist&quot;;</span>
	}
	
	protected boolean checkViewPrivilege(ID idObj)
	{
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">		return isValidSelectedOrg() &amp;&amp;</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">			m_context.getUser().isAuthorized(</span>
					PrivilegeKeys.TOM_VIEWAVAILABLETIMEOFF,
<span class="fc" id="L230">					OrganizationScopeManagerProxy.getScopeID(idObj));</span>
	}

	protected boolean checkConfigurePrivilege(ID idObj)
	{
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">		return isValidSelectedOrg() &amp;&amp;</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">			m_context.getUser().isAuthorized(</span>
					PrivilegeKeys.TOM_EDITAVAILABLETIMEOFF,
<span class="fc" id="L238">					OrganizationScopeManagerProxy.getScopeID(idObj));</span>
	}

	/**
	 * Check if user can view time off pools for the org selected in the selection pane.
	 */
	protected boolean isAuthorizedToView() 
	{
<span class="fc" id="L246">		return checkViewPrivilege(getSelectedIDObject());</span>
	}
	
	/**
	 * Return true if current user is authorized to view time off for the specified Org
	 */
	protected boolean isAuthorizedToView(ID orgID) 
	{
<span class="pc bpc" id="L254" title="2 of 4 branches missed.">		return isAuthorizedToView() &amp;&amp; checkViewPrivilege(orgID);</span>
	}

	/**
	 * Check if user can edit time off pools for the org selected in the selection pane.
	 * Since we use the same button for Edit/View, we return true if the user is has either 
	 * the VIEW or EDIT privilege.
	 */
	protected boolean isAuthorizedToConfigure() 
	{
<span class="nc" id="L264">		return checkConfigurePrivilege(getSelectedIDObject());</span>
	}
	
	/**
	 * Return true if current user is authorized to edit time off for the specified Org
	 * Since we use the same button for Edit/View, we return true if the user is has either 
	 * the VIEW or EDIT privilege.
	 */
	protected boolean isAuthorizedToConfigure(ID orgID) 
	{		
<span class="nc bnc" id="L274" title="All 4 branches missed.">		return isAuthorizedToConfigure() &amp;&amp; checkConfigurePrivilege(orgID);</span>
	}
    
    private boolean isPoolEditable(TOPool pool)
    {
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">        return checkConfigurePrivilege(pool.getOrganizationId()) &amp;&amp;</span>
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">        	   getSelectedIDObject().equals(pool.getOrganizationId());        </span>
    }
    
	protected boolean isAddActionEnabled() 
	{
<span class="pc bpc" id="L285" title="2 of 4 branches missed.">		return isDefaultButtonEnabled() &amp;&amp; checkConfigurePrivilege(getSelectedIDObject());</span>
	}

	protected boolean isDeleteActionEnabled() 
	{
<span class="pc bpc" id="L290" title="3 of 4 branches missed.">		return isSelectedItemActionsEnabled() &amp;&amp; checkConfigurePrivilege(getSelectedIDObject());</span>
		//return checkConfigurePrivilege(getSelectedIDObject());
	}
    
	/**
	 * Return localized message indicating that current user is not authorized
	 * to view activities in the selected Organization.
	 */
	protected String getNotAuthorizedToViewMsg() 
	{
<span class="nc" id="L300">		return MessageFormat.format(</span>
<span class="nc" id="L301">			i18n(m_bbmBundle, BbmWebBundleKey.NOT_AUTHORIZED_TO_VIEW_ENTITY_IN_SELECTED_ORG),</span>
<span class="nc" id="L302">			new Object[] { i18n(m_rmBundle, RmWebBundleKey.RM_ORG_REQUEST_PROCESSING_TIMEOFFPOOLS_PAGE_TITLE) } );</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>