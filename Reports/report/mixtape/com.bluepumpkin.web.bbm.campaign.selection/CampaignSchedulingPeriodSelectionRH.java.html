<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignSchedulingPeriodSelectionRH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.campaign.selection</a> &gt; <span class="el_source">CampaignSchedulingPeriodSelectionRH.java</span></div><h1>CampaignSchedulingPeriodSelectionRH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.campaign.selection;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.web.core.cache.SelectionCacheUtil;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.base.RequestHandler;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.system.RequestContext;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.PrintWriter;
import java.rmi.RemoteException;
import java.text.SimpleDateFormat;
import java.util.*;

/**
 * When a Scheduling Period or Campaign is selected from CampaignSchedulingPeriodSelectionPM,
 * it sets the selected ID on the page model.  We also need to additionally set these selected ids
 * in a session variable since some other selection panes will use them (and those selection panes happen
 * to be wired to use session variables).  This request handler retrieves these selected ids from the
 * selection mediator via an ajax call.
 */
<span class="fc" id="L36">public class CampaignSchedulingPeriodSelectionRH extends RequestHandler {</span>

    private static final String PARAM_CAMPAIGN_ID = &quot;campaignId&quot;;
    private static final String PARAM_START_DATE = &quot;startDate&quot;;
    private static final String PARAM_END_DATE = &quot;endDate&quot;;
    private static final String PARAM_PAGE_SIZE = &quot;ps&quot;;
    private static final String PARAM_PAGE_INDEX = &quot;pi&quot;;
    private static final String PARAM_KEY_ID = &quot;keyId&quot;;
    private static final String PARAM_KEY_SPIDS = &quot;spIds&quot;;

    private static final String ACTION_GET_CAMPAIGNS = &quot;GET_CAMPAIGNS&quot;;
    private static final String ACTION_GET_SCHEDULING_PERIODS = &quot;GET_SCHEDULING_PERIODS&quot;;
    private static final String ACTION_GET_CAMPAIGN_CHILDREN = &quot;GET_CAMPAIGN_CHILDREN&quot;;
    private static final String ACTION_GET_SELECTION_CONTEXT = &quot;GET_SELECTION_CONTEXT&quot;;
    private static final String ACTION_GET_CAMPAIGN = &quot;GET_CAMPAIGN&quot;;
    private static final String ACTION_GET_SCHEDULING_PERIOD_CAMPAIGNS = &quot;ACTION_GET_SCHEDULING_PERIOD_CAMPAIGNS&quot;;

    private static final String RESPONSE_KEY_CAMPAIGNS = &quot;campaigns&quot;;
    private static final String RESPONSE_KEY_SCHEDULING_PERIODS = &quot;schedulingPeriods&quot;;
    private static final String RESPONSE_KEY_SELECTED_CAMPAIGNS = &quot;selectedCampaigns&quot;;
    private static final String RESPONSE_KEY_SELECTED_SPS = &quot;selectedSchedulingPeriods&quot;;
    private static final String RESPONSE_KEY_DATA = &quot;data&quot;;

<span class="fc" id="L59">    public static String PARAM_IDS = &quot;ids&quot;;</span>

<span class="fc" id="L61">    private Localizer localizer = null;</span>
<span class="fc" id="L62">    private HttpServletRequest request = null;</span>
<span class="fc" id="L63">    private RequestContext m_context = null;</span>

    @Override
    public void processRequest(RequestContext context) throws Exception {
<span class="fc" id="L67">        JSONObject errorProcessingRequestMessage = new JSONObject();</span>
<span class="fc" id="L68">        HttpServletResponse response = context.getResponse();</span>
<span class="fc" id="L69">        request = context.getRequest();</span>
<span class="fc" id="L70">        localizer = context.getLocalizer();</span>
<span class="fc" id="L71">        m_context = context;</span>

        // define the action
<span class="fc" id="L74">        String action = request.getParameter(&quot;action&quot;);</span>

        // process according to the requested action
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">        if (action != null) {</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            if (action.equals(ACTION_GET_CAMPAIGNS)) {</span>
<span class="nc" id="L79">                int pageSize = Integer.parseInt(request.getParameter(PARAM_PAGE_SIZE));</span>
<span class="nc" id="L80">                int pageIndex = Integer.parseInt(request.getParameter(PARAM_PAGE_INDEX));</span>
<span class="nc" id="L81">                JSONObject result = new JSONObject();</span>
<span class="nc" id="L82">                result.put(RESPONSE_KEY_CAMPAIGNS, getCampaigns(pageSize, pageIndex));</span>
<span class="nc" id="L83">                sendBackData(response, result);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            } else if (action.equals(ACTION_GET_SCHEDULING_PERIODS)) {</span>
<span class="nc" id="L85">                int campaignId = Integer.parseInt(request.getParameter(PARAM_CAMPAIGN_ID));</span>
<span class="nc" id="L86">                Date startDate = null;</span>
<span class="nc" id="L87">				Date endDate = null;</span>

<span class="nc" id="L89">				String rawStartDate = request.getParameter(PARAM_START_DATE);</span>
<span class="nc" id="L90">				String rawEndDate = request.getParameter(PARAM_END_DATE);</span>

<span class="nc bnc" id="L92" title="All 4 branches missed.">				if (rawStartDate != null &amp;&amp; rawEndDate != null) {</span>
<span class="nc" id="L93">					SimpleDateFormat df = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L94">					startDate = df.parse(rawStartDate);</span>
<span class="nc" id="L95">					endDate = df.parse(rawEndDate);</span>
				}
				
<span class="nc" id="L98">                JSONObject result = new JSONObject();</span>

<span class="nc bnc" id="L100" title="All 4 branches missed.">                if (startDate != null &amp;&amp; endDate != null) {</span>
<span class="nc" id="L101">                    result.put(RESPONSE_KEY_SCHEDULING_PERIODS, getSchedulingPeriods(ID.fromInt(campaignId)));</span>
                } else {
<span class="nc" id="L103">                    result.put(RESPONSE_KEY_SCHEDULING_PERIODS, getSchedulingPeriodsInRange(ID.fromInt(campaignId), startDate, endDate));</span>
                }

<span class="nc" id="L106">                sendBackData(response, result);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            } else if (action.equals(ACTION_GET_SCHEDULING_PERIOD_CAMPAIGNS)) {</span>
<span class="nc" id="L108">                JSONObject result = new JSONObject();</span>
<span class="nc" id="L109">                String spIds = request.getParameter(PARAM_KEY_SPIDS);</span>
<span class="nc" id="L110">                List&lt;ID&gt; ids = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L111">                String[] spIdsTokened = spIds.split(&quot;,&quot;);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                for (int i = 0; i &lt; spIdsTokened.length; i++) {</span>
<span class="nc" id="L113">                    ids.add(new ID(spIdsTokened[i]));</span>
                }
<span class="nc" id="L115">                result.put(RESPONSE_KEY_DATA, getSchedulingPeriodCampaignIds(ids));</span>
<span class="nc" id="L116">                sendBackData(response, result);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">            } else if (action.equals(ACTION_GET_CAMPAIGN_CHILDREN)) {</span>
<span class="nc" id="L118">                int campaignId = Integer.parseInt(request.getParameter(PARAM_CAMPAIGN_ID));</span>
<span class="nc" id="L119">                Date startDate = null;</span>
<span class="nc" id="L120">				Date endDate = null;</span>

<span class="nc" id="L122">				String rawStartDate = request.getParameter(PARAM_START_DATE);</span>
<span class="nc" id="L123">				String rawEndDate = request.getParameter(PARAM_END_DATE);</span>

<span class="nc bnc" id="L125" title="All 4 branches missed.">				if (rawStartDate != null &amp;&amp; rawEndDate != null) {</span>
<span class="nc" id="L126">					SimpleDateFormat df = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L127">					startDate = df.parse(rawStartDate);</span>
<span class="nc" id="L128">					endDate = df.parse(rawEndDate);</span>
				}
				
<span class="nc" id="L131">                JSONObject result = new JSONObject();</span>
<span class="nc" id="L132">                result.put(RESPONSE_KEY_CAMPAIGNS, getSubCampaigns(ID.fromInt(campaignId)));</span>

<span class="nc bnc" id="L134" title="All 4 branches missed.">                if (startDate != null &amp;&amp; endDate != null) {</span>
<span class="nc" id="L135">                    result.put(RESPONSE_KEY_SCHEDULING_PERIODS, getSchedulingPeriodsInRange(ID.fromInt(campaignId), startDate, endDate));</span>
                } else {
<span class="nc" id="L137">                    result.put(RESPONSE_KEY_SCHEDULING_PERIODS, getSchedulingPeriods(ID.fromInt(campaignId)));</span>
                }

<span class="nc" id="L140">                sendBackData(response, result);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            } else if (action.equals(ACTION_GET_SELECTION_CONTEXT)) {</span>
<span class="nc" id="L142">                JSONObject result = new JSONObject();</span>
<span class="nc" id="L143">                String keyId = request.getParameter(PARAM_KEY_ID);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                if (keyId == null) {</span>
<span class="nc" id="L145">                    result.put(RESPONSE_KEY_SELECTED_CAMPAIGNS, SelectionCacheUtil.getCampaignID(context));</span>
<span class="nc" id="L146">                    result.put(RESPONSE_KEY_SELECTED_SPS, SelectionCacheUtil.getSchedulingPeriodID(context));</span>
                } else {
<span class="nc" id="L148">                    result.put(keyId, context.getUserProperty(keyId));</span>
                }
<span class="nc" id="L150">                sendBackData(response, result);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">            } else if (action.equals(ACTION_GET_CAMPAIGN)) {</span>
<span class="nc" id="L152">                int campaignId = Integer.parseInt(request.getParameter(PARAM_CAMPAIGN_ID));</span>
<span class="nc" id="L153">                sendBackData(response, getCampaign(ID.fromInt(campaignId)));</span>
<span class="nc" id="L154">            }</span>
        } else {
            // This is the current behavior (legacy of this request handler)
<span class="fc" id="L157">            String ids = context.getParameter(PARAM_IDS);</span>

<span class="fc" id="L159">            String campaignID = CampaignSchedulingPeriodSelectionUtil.extractIDs(ids,</span>
                    CampaignSchedulingPeriodSelectionUtil.CAMPAIGN_ID_PREFIX);
<span class="fc" id="L161">            String spID = CampaignSchedulingPeriodSelectionUtil.extractIDs(ids, CampaignSchedulingPeriodSelectionUtil.SP_ID_PREFIX);</span>
<span class="fc" id="L162">            SelectionCacheUtil.setCampaignID(context, new ID(campaignID));</span>
<span class="fc" id="L163">            SelectionCacheUtil.setSchedulingPeriodID(context, new ID(spID));</span>
<span class="fc" id="L164">            SelectionCacheUtil.setCampaignID(context, new ID(campaignID));</span>
<span class="fc" id="L165">            SelectionCacheUtil.setSchedulingPeriodID(context, new ID(spID));</span>
        }
<span class="fc" id="L167">    }</span>

    /**
     * A simple parameter validity checker that will return true if the param
     * isn't null, empty, or the string &quot;null&quot;.
     *
     * @param param a param to validate
     *              &lt;p/&gt;
     * @return true if the param isn't null, empty, or the string &quot;null&quot;,
     * otherwise return false
     */
    private boolean isValidParameter(String param) {
<span class="nc bnc" id="L179" title="All 6 branches missed.">        return !(param == null || &quot;&quot;.equals(param.trim()) || &quot;null&quot;.equals(param));</span>
    }

    private JSONArray getSubCampaigns(ID campaignId) throws JSONException, BbmEJBCreateException {
<span class="nc" id="L183">        JSONArray data = new JSONArray();</span>

<span class="nc" id="L185">        CampaignManager campaignMgr = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L186">        Collection&lt;ID&gt; ids = Collections.emptyList();</span>
        try {
<span class="nc" id="L188">            ids = campaignMgr.getSubCampaignIDs(campaignId);</span>

<span class="nc" id="L190">            Collection&lt;Campaign&gt; campaigns = campaignMgr.getCampaignsByIDs(ids);</span>
<span class="nc" id="L191">            Iterator&lt;Campaign&gt; it = campaigns.iterator();</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">            while (it.hasNext()) {</span>
<span class="nc" id="L193">                Campaign c = it.next();</span>
<span class="nc" id="L194">                JSONObject campaign = new JSONObject();</span>
<span class="nc" id="L195">                campaign.put(&quot;id&quot;, c.getID());</span>
<span class="nc" id="L196">                campaign.put(&quot;name&quot;, c.getName());</span>
<span class="nc" id="L197">                campaign.put(&quot;isDistributed&quot;, c.getIsDistributed());</span>
<span class="nc" id="L198">                campaign.put(&quot;timeZone&quot;, c.getTimeZone());</span>
<span class="nc" id="L199">                campaign.put(&quot;icon&quot;, m_context.getStaticFileUrl(c.getIcon()));</span>
<span class="nc" id="L200">                campaign.put(&quot;parentCampaignId&quot;, c.getParentCampaignID());</span>
<span class="nc" id="L201">                campaign.put(&quot;periodicityId&quot;, c.getPeriodicityID());</span>
<span class="nc" id="L202">                campaign.put(&quot;iconExpanded&quot;, ImageFileID.EXPAND_NODE_IMG);</span>
<span class="nc" id="L203">                campaign.put(&quot;iconCollapsed&quot;, ImageFileID.COLLAPSE_NODE_IMG);</span>
<span class="nc" id="L204">                campaign.put(&quot;schedulingPeriods&quot;, getSchedulingPeriods(c.getID()));</span>
<span class="nc" id="L205">                data.put(campaign);</span>
<span class="nc" id="L206">            }</span>
<span class="nc" id="L207">        } catch (Exception ex) {</span>
<span class="nc" id="L208">            m_log.error(ex);</span>
<span class="nc" id="L209">        }</span>

<span class="nc" id="L211">        return data;</span>
    }

    private JSONObject getCampaign(ID id) throws JSONException, BbmEJBCreateException, BbmFinderException, RemoteException {

<span class="nc" id="L216">        CampaignManager campaignMgr = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L217">        Campaign c = campaignMgr.getCampaignByID(id);</span>

<span class="nc" id="L219">        JSONObject result = new JSONObject();</span>
<span class="nc" id="L220">        result.put(&quot;id&quot;, c.getID());</span>
<span class="nc" id="L221">        result.put(&quot;name&quot;, c.getName());</span>
<span class="nc" id="L222">        result.put(&quot;isDistributed&quot;, c.getIsDistributed());</span>
<span class="nc" id="L223">        result.put(&quot;timeZone&quot;, c.getTimeZone());</span>
<span class="nc" id="L224">        result.put(&quot;icon&quot;, m_context.getStaticFileUrl(c.getIcon()));</span>
<span class="nc" id="L225">        result.put(&quot;parentCampaignId&quot;, c.getParentCampaignID());</span>
<span class="nc" id="L226">        result.put(&quot;periodicityId&quot;, c.getPeriodicityID());</span>
<span class="nc" id="L227">        result.put(&quot;iconExpanded&quot;, ImageFileID.EXPAND_NODE_IMG);</span>
<span class="nc" id="L228">        result.put(&quot;iconCollapsed&quot;, ImageFileID.COLLAPSE_NODE_IMG);</span>

<span class="nc" id="L230">        return result;</span>
    }

    private JSONArray getCampaigns(int pageSize, int pageIndex) throws JSONException, BbmEJBCreateException {
<span class="nc" id="L234">        JSONArray data = new JSONArray();</span>

<span class="nc" id="L236">        CampaignManager campaignMgr = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L237">        Collection&lt;Campaign&gt; campaigns = Collections.EMPTY_LIST;</span>
        try {
<span class="nc" id="L239">            campaigns = campaignMgr.getCampaigns(pageSize, pageIndex);</span>
<span class="nc" id="L240">            Iterator&lt;Campaign&gt; it = campaigns.iterator();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">            while (it.hasNext()) {</span>
<span class="nc" id="L242">                Campaign c = it.next();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                if (c.getParentCampaignID() == null) {</span>
<span class="nc" id="L244">                    JSONObject campaign = new JSONObject();</span>
<span class="nc" id="L245">                    campaign.put(&quot;id&quot;, c.getID());</span>
<span class="nc" id="L246">                    campaign.put(&quot;name&quot;, c.getName());</span>
<span class="nc" id="L247">                    campaign.put(&quot;isDistributed&quot;, c.getIsDistributed());</span>
<span class="nc" id="L248">                    campaign.put(&quot;timeZone&quot;, c.getTimeZone());</span>
<span class="nc" id="L249">                    campaign.put(&quot;icon&quot;, m_context.getStaticFileUrl(c.getIcon()));</span>
<span class="nc" id="L250">                    campaign.put(&quot;parentCampaignId&quot;, c.getParentCampaignID());</span>
<span class="nc" id="L251">                    campaign.put(&quot;periodicityId&quot;, c.getPeriodicityID());</span>
<span class="nc" id="L252">                    campaign.put(&quot;iconExpanded&quot;, ImageFileID.EXPAND_NODE_IMG);</span>
<span class="nc" id="L253">                    campaign.put(&quot;iconCollapsed&quot;, ImageFileID.COLLAPSE_NODE_IMG);</span>
<span class="nc" id="L254">                    data.put(campaign);</span>
                }
<span class="nc" id="L256">            }</span>
<span class="nc" id="L257">        } catch (Exception ex) {</span>
<span class="nc" id="L258">            m_log.error(ex);</span>
<span class="nc" id="L259">        }</span>

<span class="nc" id="L261">        return data;</span>
    }

    private JSONArray getSchedulingPeriodCampaignIds(Collection&lt;ID&gt; spIds) throws BbmEJBCreateException, BbmFinderException {
<span class="nc" id="L265">        JSONArray result = new JSONArray();</span>
<span class="nc" id="L266">        CampaignManager campaignMgr = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L267">        Collection&lt;SchedulingPeriod&gt; sps = Collections.EMPTY_LIST;</span>
        try {
<span class="nc" id="L269">            sps = campaignMgr.getSchedulingPeriodsByID(spIds);</span>
<span class="nc" id="L270">            Iterator&lt;SchedulingPeriod&gt; it = sps.iterator();</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">            while (it.hasNext()) {</span>
<span class="nc" id="L272">                SchedulingPeriod entry = it.next();</span>
<span class="nc" id="L273">                result.put(entry.getCampaignID());</span>
<span class="nc" id="L274">            }</span>
<span class="nc" id="L275">        } catch (Exception ex) {</span>
<span class="nc" id="L276">            m_log.error(ex);</span>
<span class="nc" id="L277">        }</span>

<span class="nc" id="L279">        return result;</span>
    }

    private JSONArray getSchedulingPeriodsInRange(ID campaignId, Date start, Date end) throws BbmEJBCreateException {
<span class="nc" id="L283">        JSONArray data = new JSONArray();</span>

<span class="nc" id="L285">        CampaignManager campaignMgr = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L286">        Collection&lt;SchedulingPeriod&gt; sps = Collections.emptyList();</span>

        try {
<span class="nc" id="L289">            sps = campaignMgr.getSchedulingPeriods(campaignId, start, end);</span>
<span class="nc" id="L290">            Iterator&lt;SchedulingPeriod&gt; it = sps.iterator();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">            while (it.hasNext()) {</span>
<span class="nc" id="L292">                SchedulingPeriod entry = it.next();</span>

<span class="nc" id="L294">                LocalDate endDate = new LocalDate(entry.getEndTimeLocal());</span>
<span class="nc" id="L295">                endDate.add(Calendar.DATE, -1);</span>
<span class="nc" id="L296">                String displayName = localizer.formatDate(entry.getStartTimeLocal(), RegionalFormatBundleKey.DATE_FORMAT) +</span>
<span class="nc" id="L297">                        &quot; - &quot; + localizer.formatDate(endDate, RegionalFormatBundleKey.DATE_FORMAT);</span>

<span class="nc" id="L299">                JSONObject sp = new JSONObject();</span>
<span class="nc" id="L300">                sp.put(&quot;id&quot;, entry.getID());</span>
<span class="nc" id="L301">                sp.put(&quot;campaignId&quot;, entry.getCampaignID().toInt());</span>
<span class="nc" id="L302">                sp.put(&quot;displayName&quot;, displayName);</span>
<span class="nc" id="L303">                sp.put(&quot;name&quot;, entry.getName());</span>
<span class="nc" id="L304">                sp.put(&quot;startTime&quot;, entry.getStartTime());</span>
<span class="nc" id="L305">                sp.put(&quot;endTime&quot;, entry.getEndTimeLocal());</span>
<span class="nc" id="L306">                sp.put(&quot;startTimeLocal&quot;, entry.getStartTimeLocal());</span>
<span class="nc" id="L307">                sp.put(&quot;endTimeLocal&quot;, entry.getEndTimeLocal());</span>
<span class="nc" id="L308">                sp.put(&quot;icon&quot;, m_context.getStaticFileUrl(entry.getIcon()));</span>
<span class="nc" id="L309">                data.put(sp);</span>
<span class="nc" id="L310">            }</span>
<span class="nc" id="L311">        } catch (Exception ex) {</span>
<span class="nc" id="L312">            m_log.error(ex);</span>
<span class="nc" id="L313">        }</span>

<span class="nc" id="L315">        return data;</span>
    }

    // This should be paginated for long lists but even for each week of the year and 3 years this would
    // only be 52*3 = 156 records so not that large.
    private JSONArray getSchedulingPeriods(ID campaignId) throws JSONException, BbmEJBCreateException {
<span class="nc" id="L321">        JSONArray data = new JSONArray();</span>

<span class="nc" id="L323">        CampaignManager campaignMgr = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L324">        Collection&lt;SchedulingPeriod&gt; sps = Collections.EMPTY_LIST;</span>

        try {
<span class="nc" id="L327">            sps = campaignMgr.getSchedulingPeriods(campaignId, null, null);</span>
<span class="nc" id="L328">            Iterator&lt;SchedulingPeriod&gt; it = sps.iterator();</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">            while (it.hasNext()) {</span>
<span class="nc" id="L330">                SchedulingPeriod entry = it.next();</span>

<span class="nc" id="L332">                LocalDate endDate = new LocalDate(entry.getEndTimeLocal());</span>
<span class="nc" id="L333">                endDate.add(Calendar.DATE, -1);</span>
<span class="nc" id="L334">                String displayName = localizer.formatDate(entry.getStartTimeLocal(), RegionalFormatBundleKey.DATE_FORMAT) +</span>
<span class="nc" id="L335">                        &quot; - &quot; + localizer.formatDate(endDate, RegionalFormatBundleKey.DATE_FORMAT);</span>

<span class="nc" id="L337">                JSONObject sp = new JSONObject();</span>
<span class="nc" id="L338">                sp.put(&quot;id&quot;, entry.getID());</span>
<span class="nc" id="L339">                sp.put(&quot;campaignId&quot;, entry.getCampaignID().toInt());</span>
<span class="nc" id="L340">                sp.put(&quot;displayName&quot;, displayName);</span>
<span class="nc" id="L341">                sp.put(&quot;name&quot;, entry.getName());</span>
<span class="nc" id="L342">                sp.put(&quot;startTime&quot;, entry.getStartTime());</span>
<span class="nc" id="L343">                sp.put(&quot;endTime&quot;, entry.getEndTimeLocal());</span>
<span class="nc" id="L344">                sp.put(&quot;startTimeLocal&quot;, entry.getStartTimeLocal());</span>
<span class="nc" id="L345">                sp.put(&quot;endTimeLocal&quot;, entry.getEndTimeLocal());</span>
<span class="nc" id="L346">                sp.put(&quot;icon&quot;, m_context.getStaticFileUrl(entry.getIcon()));</span>
<span class="nc" id="L347">                data.put(sp);</span>
<span class="nc" id="L348">            }</span>
<span class="nc" id="L349">        } catch (Exception ex) {</span>
<span class="nc" id="L350">            m_log.error(ex);</span>
<span class="nc" id="L351">        }</span>

<span class="nc" id="L353">        return data;</span>
    }

    /**
     * This method will pass a JSON response data back to the client.
     *
     * @param response a response object that will handle the data transaction
     * @param jsonData a response data payload
     *                 &lt;p/&gt;
     * @throws IOException
     */
    private synchronized void sendBackData(HttpServletResponse response,
                                           JSONObject jsonData)
            throws IOException // TODO: add relevant error handling
    {
        // Configure response for json response
<span class="nc" id="L369">        response.setContentType(&quot;text/json&quot;);</span>
<span class="nc" id="L370">        response.setCharacterEncoding(&quot;UTF-8&quot;);</span>
<span class="nc" id="L371">        response.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);</span>

        // Get the print writer object from response to write the required json object to the output stream
<span class="nc" id="L374">        PrintWriter out = null;</span>
        try {
<span class="nc" id="L376">            out = response.getWriter();</span>
<span class="nc" id="L377">            out.print(jsonData.toString());</span>
<span class="nc" id="L378">        } catch (Exception ex) {</span>
<span class="nc" id="L379">            m_log.error(ex);</span>
        } finally {
<span class="nc" id="L381">            out.close();</span>
<span class="nc" id="L382">        }</span>
<span class="nc" id="L383">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>