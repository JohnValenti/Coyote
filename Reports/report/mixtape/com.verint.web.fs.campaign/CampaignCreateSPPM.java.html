<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignCreateSPPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.campaign</a> &gt; <span class="el_source">CampaignCreateSPPM.java</span></div><h1>CampaignCreateSPPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.campaign;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.l10n.TimeZoneBundleKey;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOO;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriodUtil;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.campaign.selection.CampaignSchedulingPeriodSelectionUtil;
import com.bluepumpkin.web.bbm.campaign.sp.SchedulingPeriodUtil;
import com.bluepumpkin.web.bbm.hoo.Hoo;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.fs.keys.FsJavaScriptFileID;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.jsp.HtmlTable;
import com.witness.web.uif.jsp.HtmlTableCell;
import com.witness.web.uif.jsp.HtmlTableRow;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.TimePickerPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.SettingPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.HtmlBooleanCheckbox;
import com.witness.web.uif.util.html.HtmlChoiceInput;

import javax.servlet.http.HttpServletRequest;
import java.text.SimpleDateFormat;
import java.util.*;

import static com.verint.web.fs.campaign.CustomizeWeeksPopupPM.POPUP_ID;

@SuppressWarnings(&quot;serial&quot;)
public class CampaignCreateSPPM extends SettingPM {

  public static final String FORM_ACTION = &quot;campaign_customize_week_popup&quot;;
  private static final String CONFIRM_COPY_LOCKED_ONLY = &quot;CONFIRM_COPY_LOCKED_ONLY&quot;;
  public static final String CAMPAIGN_ID = &quot;campaignID&quot;;
  public static final String SELECTED_HOO_ID = &quot;selectedHooID&quot;;
  public static final String DAYBOUNDARY_IN_MUNITES = &quot;dayboundaryinminutes&quot;;

  public static final String CAMP_NAME_FN = &quot;campaignname&quot;;
  public static final String CAMP_WEEK_START_DAY_FN = &quot;campaignweekstartday&quot;;
  public static final String CAMP_TIMEZONE_ID_FN = &quot;campaigntimezoneid&quot;;
  public static final String CAMP_DAY_BOUNDARY_OFFSET_FN = &quot;campaigndayboundary&quot;;
  public static final String CAMP_NUMBEROFWEEKS_FN = &quot;campaignnumberofweeks&quot;;
  public static final String CAMP_SP_START_DATE_FN = &quot;campaignspstartdate&quot;;
  public static final String CAMP_SP_CREATE_PREV_PERIOD = &quot;campaigncreateprevperiod&quot;;
  public static final String CAMP_INIT_OPTIONS_FN = &quot;campaigninitoptions&quot;;
  public static final String CAMP_SP_CREATE_PREV_SECECT = CAMP_INIT_OPTIONS_FN + CAMP_SP_CREATE_PREV_PERIOD;
  public static final String CAMP_SP_CUSTOMIZE_IMAGE_FN = &quot;campaignspcustomizeimage&quot;;
  public static final String CAMP_SP_CUSTOMIZE_IMAGE_DISABLE_FN = &quot;campaignspcustomizeimagedisable&quot;;
  public static final String ON_CHANGE_SCRIPT = &quot;pageMediator.refreshPageWithAction('&quot; + PageAction.FORCE_REFRESH
      + &quot;', true);&quot;;

  private static final String CREATE_EMPTY = &quot;createempty&quot;;
  private static final String CREATE_USEPREVIOUS = &quot;createuseprevious&quot;;
  private static final String CREATE_FROM_SELECTED = &quot;createfromselected&quot;;
  private static final String CREATE_CUSTOMIZE = &quot;createcustomize&quot;;
  public static final String CAMP_INIT_CREATE_EMPLOYEEDATA_FN = &quot;CampaignCreateSPPM_createEmployeeDataFN&quot;;
  public static final String CAMP_INIT_CREATE_PROJECTDATA_FN = &quot;CampaignCreateSPPM_createProjectDataFN&quot;;

  private FormTwoColumnPC m_formPC;
  private FormInputPC m_formInputPC;
  private String m_selectedCampaignIDs;
  private String m_selectedSchedulingPeriodIDs;
  private ResourceBundle m_bundle;
  private TimePickerPC m_timePickerPC;
  private DatePickerPC m_datePickerPC;

  private Campaign m_campaign;
<span class="fc" id="L88">  private SchedulingPeriod m_SP = null;</span>

<span class="fc" id="L90">  private int selection = 0;</span>
<span class="fc" id="L91">  private int numberofWeeks = 1;</span>
<span class="fc" id="L92">  private boolean isClonable = false;</span>
<span class="fc" id="L93">  private boolean isCreateable = false;</span>
  private Locale m_languageLocale;
<span class="fc" id="L95">  private boolean copyEmployeedata = false;</span>
<span class="fc" id="L96">  private boolean copyProjectdata = true;</span>
  private HtmlBooleanCheckbox employeeCheckboxPC;
  private HtmlBooleanCheckbox projectCheckboxPC;

  // Monthly Campaign settings
  public static final String CAMP_MONTH_FN = &quot;month&quot;;
  public static final String CAMP_YEAR_FN = &quot;year&quot;;
<span class="fc" id="L103">  private int m_month = -1;</span>
<span class="fc" id="L104">  private int m_year = -1;</span>
<span class="fc" id="L105">  private boolean m_isLoaded = false;</span>

  public CampaignCreateSPPM(RequestContext context) {
<span class="fc" id="L108">    super(context);</span>

<span class="fc" id="L110">    m_languageLocale = m_context.getLocaleContext().getLanguageLocale();</span>
<span class="fc" id="L111">    m_bundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

<span class="fc" id="L113">    m_formPC = new FormTwoColumnPC(context);</span>
<span class="fc" id="L114">    addChildComponent(m_formPC);</span>

<span class="fc" id="L116">    m_SP = new SchedulingPeriod();</span>

    // Add Date Time Picker for Day Boundary
<span class="fc" id="L119">    m_timePickerPC = new TimePickerPC(context);</span>
<span class="fc" id="L120">    m_timePickerPC.setInputFieldName(CAMP_DAY_BOUNDARY_OFFSET_FN);</span>
<span class="fc" id="L121">    m_timePickerPC.setTimeInterval(15);</span>
<span class="fc" id="L122">    addChildComponent(m_timePickerPC);</span>

<span class="fc" id="L124">    m_formInputPC = new FormInputPC(context);</span>
<span class="fc" id="L125">    addChildComponent(m_formInputPC);</span>

<span class="fc" id="L127">    m_datePickerPC = new DatePickerPC(context, &quot;&quot;);</span>

<span class="fc" id="L129">    m_datePickerPC.reset();</span>
<span class="fc" id="L130">    m_datePickerPC.setDateInputFieldName(CAMP_SP_START_DATE_FN);</span>
<span class="fc" id="L131">    m_datePickerPC.setIsDateValueOptional(false);</span>
<span class="fc" id="L132">    m_datePickerPC.setIsControlEnabled(true);</span>
<span class="fc" id="L133">    addChildComponent(m_datePickerPC);</span>

<span class="fc" id="L135">    String formattedTitle = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_COPY_LOCKED_ONLY);</span>

<span class="fc" id="L137">    addJSVariableAsString(CONFIRM_COPY_LOCKED_ONLY, formattedTitle);</span>

<span class="fc" id="L139">    addPopupArgs(POPUP_ID, CustomizeWeeksPopupPM.FORM_ACTION, &quot;&quot;, CustomizeWeeksPopupPM.WEEK_NUMBERS + &quot;,&quot;</span>
        + CustomizeWeeksPopupPM.START_DATE + &quot;,&quot; + CustomizeWeeksPopupPM.CAMPAIGN_ID, &quot;550,440,ctr,ctr&quot;, true, 1);

<span class="fc" id="L142">    String labelImport = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_EMP_DATA);</span>
<span class="fc" id="L143">    employeeCheckboxPC = HtmlBooleanCheckbox.createInput(CAMP_INIT_CREATE_EMPLOYEEDATA_FN, labelImport, null, false, true);</span>

<span class="fc" id="L145">    String labelProjectImport = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_PROJECT_DATA);</span>
<span class="fc" id="L146">    projectCheckboxPC = HtmlBooleanCheckbox.createInput(CAMP_INIT_CREATE_PROJECTDATA_FN,</span>
        labelProjectImport, null, false, true);

<span class="fc" id="L149">    addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="fc" id="L150">    addRequiredJavaScriptFile(FsJavaScriptFileID.CAMPAIGN_SP_CREATE_UTIL);</span>
<span class="fc" id="L151">  }</span>

  public static CampaignCreateSPPM getInstance(RequestContext context) {
<span class="fc" id="L154">    return (CampaignCreateSPPM) getInstance(context, CampaignCreateSPPM.class);</span>
  }

  public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L158">    boolean success = super.extractParameters(request);</span>
    try {
<span class="fc" id="L160">      loadData();</span>
<span class="nc" id="L161">    } catch (Exception ex) {</span>
<span class="nc" id="L162">      handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L163">    }</span>

<span class="fc" id="L165">    String strMinutes = request.getParameter(DAYBOUNDARY_IN_MUNITES);</span>
<span class="fc" id="L166">    int minutes = Integer.parseInt(strMinutes);</span>

<span class="pc bpc" id="L168" title="1 of 2 branches missed.">    if (isWeeklyCampaign()) {</span>
<span class="fc" id="L169">      String strnumberofWeeks = request.getParameter(CAMP_NUMBEROFWEEKS_FN);</span>
<span class="fc" id="L170">      numberofWeeks = Integer.parseInt(strnumberofWeeks);</span>
    }

<span class="fc" id="L173">    Pair&lt;LocalDate, LocalDate&gt; spStartEnd = new Pair&lt;LocalDate, LocalDate&gt;();</span>
<span class="fc" id="L174">    determineSpStartAndEnd(minutes, m_campaign.getMonthStartDay(), numberofWeeks,</span>
<span class="fc" id="L175">        m_datePickerPC.getLocalDate(), spStartEnd);</span>

<span class="fc" id="L177">    m_SP.setStartTimeLocal(spStartEnd.getFirst());</span>
<span class="fc" id="L178">    m_SP.setEndTimeLocal(spStartEnd.getSecond());</span>

<span class="fc" id="L180">    LocalDate tempEnd = new LocalDate(spStartEnd.getSecond());</span>
<span class="fc" id="L181">    tempEnd.add(Calendar.DAY_OF_MONTH, -1);</span>
<span class="fc" id="L182">    String name =</span>
<span class="fc" id="L183">        m_localizer.formatDate(spStartEnd.getFirst(), RegionalFormatBundleKey.DATE_FORMAT)</span>
<span class="fc" id="L184">            + m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.CAMPAIGN_SP_NAME_LITERAL)</span>
<span class="fc" id="L185">            + m_localizer.formatDate(tempEnd, RegionalFormatBundleKey.DATE_FORMAT);</span>
<span class="fc" id="L186">    m_SP.setName(name);</span>

<span class="fc" id="L188">    String strBProcOpt = request.getParameter(CAMP_INIT_OPTIONS_FN);</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">    if (strBProcOpt != null) {</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">      if (strBProcOpt.equals(CREATE_EMPTY)) {</span>
<span class="fc" id="L191">        selection = 0;</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">      } else if (strBProcOpt.equals(CREATE_USEPREVIOUS)) {</span>
<span class="nc" id="L193">        selection = 1;</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">      } else if (strBProcOpt.equals(CREATE_FROM_SELECTED)) {</span>
<span class="nc" id="L195">        selection = 2;</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">      } else if (strBProcOpt.equals(CREATE_CUSTOMIZE)) {</span>
<span class="nc" id="L197">        selection = 3;</span>
      }
    }

<span class="fc" id="L201">    String strCopyEmployeeData = request.getParameter(CAMP_INIT_CREATE_EMPLOYEEDATA_FN);</span>
<span class="fc" id="L202">    copyEmployeedata = strCopyEmployeeData.equals(&quot;true&quot;);</span>

<span class="fc" id="L204">    String strCopyProjectData = request.getParameter(CAMP_INIT_CREATE_PROJECTDATA_FN);</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">    copyProjectdata = strCopyProjectData == null ? true : &quot;true&quot;.equals(strCopyProjectData);</span>

<span class="fc" id="L207">    return success;</span>
  }

  /**
   * Determine the SP's start and end LocalDates, and store in the spStartEnd parameter.
   *
   * @param minutes       - the minutes offset (day boundary) for the campaign
   * @param monthStartDay - Campaign start day
   * @param numWeeks      - number of weeks in the non-monthly SP. Not applicable to Monthly SP's.
   * @param datePickerVal - the current local date that the date picker is set to.
   * @param spStartEnd    - where we will store the SP's start and end LocalDates
   */
  public void determineSpStartAndEnd(int minutes, short monthStartDay, int numWeeks,
                                     LocalDate datePickerVal, Pair&lt;LocalDate, LocalDate&gt; spStartEnd) {
    LocalDate start;
    LocalDate end;

<span class="pc bpc" id="L224" title="1 of 2 branches missed.">    if (isWeeklyCampaign()) {</span>
      // Single-week or multi-week SP
<span class="fc" id="L226">      start = new LocalDate(datePickerVal);</span>
<span class="fc" id="L227">      start.add(Calendar.MINUTE, minutes);</span>
<span class="fc" id="L228">      end = new LocalDate(start);</span>
<span class="fc" id="L229">      end.add(Calendar.DAY_OF_MONTH, 7 * numWeeks);</span>
    } else {
      // Monthly SP
<span class="nc" id="L232">      Calendar cal = Calendar.getInstance(m_campaign.getTimeZone());</span>
<span class="nc" id="L233">      cal.set(m_year, m_month, monthStartDay, 0, minutes, 0);</span>
<span class="nc" id="L234">      start = new LocalDate(cal);</span>
<span class="nc" id="L235">      cal.add(Calendar.MONTH, 1);</span>
<span class="nc" id="L236">      end = new LocalDate(cal);</span>
    }
<span class="fc" id="L238">    spStartEnd.setFirst(start);</span>
<span class="fc" id="L239">    spStartEnd.setSecond(end);</span>
<span class="fc" id="L240">  }</span>

  public int getSelection() {
<span class="fc" id="L243">    return selection;</span>
  }

  public boolean getIsCopyEmployeeData() {
<span class="fc" id="L247">    return copyEmployeedata;</span>
  }

  public boolean getIsCopyProjectData() {
<span class="fc" id="L251">    return copyProjectdata;</span>
  }

  @Override
  protected void initContentTitle() {
<span class="fc" id="L256">    super.initContentTitle();</span>
<span class="fc" id="L257">    m_contentTitlePC.setPageTitle(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.CAMPAIGN_CREATE_SP));</span>
<span class="fc" id="L258">  }</span>

  protected boolean isDeleteActionEnabled() {
    // TODO Auto-generated method stub
<span class="nc" id="L262">    return false;</span>
  }

  protected void initToolbar() {
<span class="fc" id="L266">    ToolbarTextButton saveAndApply = null;</span>
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">    if (selection != 0) {</span>
<span class="nc" id="L268">      saveAndApply =</span>
<span class="nc" id="L269">          m_toolbar.addSubmitTextButton(PageAction.SP_CREATE, i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SAVE),</span>
              isClonable);
    } else {
<span class="fc" id="L272">      saveAndApply =</span>
<span class="fc" id="L273">          m_toolbar.addSubmitTextButton(PageAction.SP_CREATE, i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SAVE),</span>
              isCreateable);
    }

<span class="fc" id="L277">    StringBuilder conditionJS = new StringBuilder();</span>
<span class="fc" id="L278">    conditionJS.append(&quot;var ck = jQuery('#&quot;).append(employeeCheckboxPC.getInputID()).append(&quot;')[0];\n&quot;);</span>
<span class="fc" id="L279">    conditionJS.append(&quot;if (ck.disabled == false) {confirm( CONFIRM_COPY_LOCKED_ONLY )} else{true;}&quot;);</span>

<span class="fc" id="L281">    saveAndApply.setConditionJS(conditionJS.toString());</span>

<span class="fc" id="L283">    m_toolbar.addConfirmSubmitTextButton(PageAction.CANCEL, i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_CANCEL), true);</span>
<span class="fc" id="L284">  }</span>

  protected void initForm() {
<span class="fc" id="L287">    setForm(m_formPC);</span>
<span class="fc" id="L288">    m_formPC.setTitle(getFormTitle());</span>

<span class="fc" id="L290">    Date date = new Date();</span>
<span class="fc" id="L291">    int weekNumber = 1;</span>
<span class="pc bpc" id="L292" title="1 of 4 branches missed.">    if (null != getPageAction() &amp;&amp; (PageAction.FORCE_REFRESH.equals(getPageAction()))</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">        || (PageAction.SP_CREATE.equals(getPageAction()))) {</span>

<span class="fc" id="L295">      this.extractParameters(m_context.getRequest());</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">      if (isWeeklyCampaign()) {</span>
        // Weekly campaign
<span class="fc" id="L298">        LocalDate localdate = m_datePickerPC.getLocalDate();</span>
<span class="fc" id="L299">        date = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(localdate, m_campaign.getTimeZone());</span>
<span class="fc" id="L300">        String strWeekNumber = m_context.getParameter(CAMP_NUMBEROFWEEKS_FN);</span>
<span class="fc" id="L301">        weekNumber = Integer.parseInt(strWeekNumber);</span>
<span class="fc" id="L302">      } else {</span>
        // Monthly campaign
<span class="nc" id="L304">        String strMonth = m_context.getParameter(CAMP_MONTH_FN);</span>
<span class="nc" id="L305">        int month = Integer.parseInt(strMonth);</span>
<span class="nc" id="L306">        String strYear = m_context.getParameter(CAMP_YEAR_FN);</span>
<span class="nc" id="L307">        int year = Integer.parseInt(strYear);</span>
<span class="nc" id="L308">        int monthStartDay = m_campaign.getMonthStartDay();</span>
<span class="nc" id="L309">        LocalDate localdate = new LocalDate(year, month, monthStartDay, 0, 0, 0);</span>
<span class="nc" id="L310">        date = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(localdate, m_campaign.getTimeZone());</span>
<span class="nc" id="L311">      }</span>
    } else {
      LocalDate start;
      LocalDate end;
<span class="fc" id="L315">      int weekStart = getWeekStart();</span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">      if (isWeeklyCampaign()) {</span>
        // Weekly campaign
<span class="fc" id="L318">        date = getDateForWeekStart(date, weekStart);</span>
<span class="fc" id="L319">        start = TimePeriodUtil.convertToLocalDateInTimeZone(date, m_campaign.getTimeZone());</span>
<span class="fc" id="L320">        int minutes = weekStart % 1440;</span>
<span class="fc" id="L321">        start.add(Calendar.MINUTE, minutes);</span>
<span class="fc" id="L322">        end = new LocalDate(start);</span>
<span class="fc" id="L323">        end.add(Calendar.DAY_OF_MONTH, 7 * weekNumber);</span>
<span class="fc" id="L324">      } else {</span>
        // Monthly campaign
<span class="nc" id="L326">        int monthStartDay = m_campaign.getMonthStartDay();</span>
<span class="nc" id="L327">        date = getDateForMonthStart(date, monthStartDay);</span>
<span class="nc" id="L328">        start = TimePeriodUtil.convertToLocalDateInTimeZone(date, m_campaign.getTimeZone());</span>
<span class="nc" id="L329">        int minutes = weekStart % 1440;</span>
<span class="nc" id="L330">        start.add(Calendar.MINUTE, minutes);</span>
<span class="nc" id="L331">        end = new LocalDate(start);</span>
<span class="nc" id="L332">        end.add(Calendar.MONTH, 1);</span>
      }

<span class="fc" id="L335">      m_SP.setStartTimeLocal(start);</span>
<span class="fc" id="L336">      m_SP.setEndTimeLocal(end);</span>
    }

<span class="pc bpc" id="L339" title="1 of 2 branches missed.">    if (m_isAddMode) {</span>
<span class="fc" id="L340">      String campName = m_campaign.getName();</span>
<span class="fc" id="L341">      m_formPC.addRow(getCampaignNameLabel(), campName);</span>

<span class="fc" id="L343">      ResourceBundle rs = m_localizer.getBundle(TimeZoneBundleKey.TIMEZONE_BUNDLE, m_languageLocale);</span>
<span class="fc" id="L344">      String timezoneName = i18n(rs, m_campaign.getTimeZone().getID());</span>
<span class="fc" id="L345">      m_formPC.addRow(getTimezoneLabel(), timezoneName);</span>

<span class="fc" id="L347">      String dayboundary = m_campaign.getDayBoundary(m_localizer);</span>
<span class="fc" id="L348">      m_formPC.addRow(getDayBoundaryOffsetLabel(), dayboundary);</span>

<span class="pc bpc" id="L350" title="1 of 2 branches missed.">      if (isWeeklyCampaign()) {</span>
        // Weekly periodicity needs to show the Number of Weeks selector and Start Date picker
<span class="fc" id="L352">        ArrayList&lt;StringsPair&gt; colWPs = new ArrayList&lt;StringsPair&gt;(6);</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">        for (int i = 1; i &lt;= 6; i++) {</span>
<span class="fc" id="L354">          colWPs.add(new StringsPair(Integer.toString(i), Integer.toString(i)));</span>
        }

<span class="fc" id="L357">        m_formPC.addRow(getNumberOfWeeksLabel(), HtmlUtil.makeSelectInput(CAMP_NUMBEROFWEEKS_FN,</span>
<span class="fc" id="L358">            Integer.toString(weekNumber), ON_CHANGE_SCRIPT, colWPs));</span>

<span class="fc" id="L360">        int weekStart = getWeekStart();</span>
<span class="fc" id="L361">        date = getDateForWeekStart(date, weekStart);</span>

<span class="fc" id="L363">        m_datePickerPC.setFirstDayOfWeek(SchedulingPeriodUtil.getWeekStartDay(weekStart));</span>
        try {
<span class="fc" id="L365">          m_datePickerPC.setDisabledDays(getDisabledDays(weekStart / 1440));</span>
<span class="nc" id="L366">        } catch (Exception ex) {</span>
<span class="nc" id="L367">          ex.printStackTrace();</span>
<span class="fc" id="L368">        }</span>
<span class="fc" id="L369">        LocalDate localdate = TimePeriodUtil.convertToLocalDateInTimeZone(date, m_campaign.getTimeZone());</span>
<span class="fc" id="L370">        m_datePickerPC.setDate(localdate);</span>
<span class="fc" id="L371">        m_datePickerPC.setOnChangeJS(ON_CHANGE_SCRIPT);</span>
<span class="fc" id="L372">        m_formPC.addRow(getSPStartDateLabel(), m_datePickerPC.getHtmlDisplay());</span>
<span class="fc" id="L373">      } else {</span>
<span class="nc" id="L374">        LocalDate localdate = TimePeriodUtil.convertToLocalDateInTimeZone(date, m_campaign.getTimeZone());</span>
<span class="nc" id="L375">        SimpleDateFormat sdf = m_context.getLocalizer().getDateInputFormatter(m_context.getViewingTimeZone());</span>
<span class="nc" id="L376">        String localdateStr = sdf.format(localdate.getTime(m_campaign.getTimeZone()));</span>
        // set the start date hidden field to the start of the selected month, Ex: &quot;10/11/2015&quot;
<span class="nc" id="L378">        String startDateHiddenField = HtmlUtil.makeHiddenInput(CAMP_SP_START_DATE_FN, localdateStr);</span>
        // set the num weeks hidden field to -1 which indicates a Monthly SP
<span class="nc" id="L380">        String numWeeksHiddenField = HtmlUtil.makeHiddenInput(CAMP_NUMBEROFWEEKS_FN, &quot;-1&quot;);</span>

        // Monthly periodicity needs to show the Month and Year selectors, and hidden fields for num weeks, start
        // date
<span class="nc" id="L384">        String curRow =</span>
<span class="nc" id="L385">            getMonthElement(ON_CHANGE_SCRIPT) + &quot; &amp;nbsp; &quot; + getYearElement(ON_CHANGE_SCRIPT) + &quot; &amp;nbsp; &quot; + &quot;(&quot;</span>
<span class="nc" id="L386">                + getSPNameInRegionalFormat(m_SP) + &quot;)&quot; + &quot; &amp;nbsp; &quot; + numWeeksHiddenField + &quot; &amp;nbsp; &quot;</span>
                + startDateHiddenField;
<span class="nc" id="L388">        m_formPC.addRow(getMonthLabel(), curRow);</span>
      }

<span class="fc" id="L391">      m_formPC.addRow(i18n(m_bundle, FsWebBundleKey.SCHEDULINGPERIOD_INITOPTIONS),</span>
<span class="fc" id="L392">          getInitOpts(CAMP_INIT_OPTIONS_FN, weekNumber, date));</span>
    }
<span class="fc" id="L394">  }</span>

  /**
   * @param date
   * @param weekStart
   * @return
   */
  private Date getDateForWeekStart(Date date, int weekStart) {
<span class="fc" id="L402">    int weekStartDay = SchedulingPeriodUtil.getWeekStartDay(weekStart);</span>
<span class="fc" id="L403">    Calendar cal = Calendar.getInstance(m_campaign.getTimeZone(), m_locale);</span>
<span class="fc" id="L404">    cal.setTime(date);</span>
<span class="fc" id="L405">    cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="fc" id="L406">    cal.set(Calendar.MINUTE, 0);</span>
<span class="fc" id="L407">    cal.set(Calendar.SECOND, 0);</span>
<span class="fc" id="L408">    cal.set(Calendar.MILLISECOND, 0);</span>
<span class="fc bfc" id="L409" title="All 2 branches covered.">    while (cal.get(Calendar.DAY_OF_WEEK) != weekStartDay) {</span>
<span class="fc" id="L410">      cal.add(Calendar.DATE, -1);</span>
    }
<span class="fc" id="L412">    date = cal.getTime();</span>
<span class="fc" id="L413">    return date;</span>
  }

  private Date getDateForMonthStart(Date date, int monthStartDay) {
<span class="nc" id="L417">    Calendar cal = Calendar.getInstance(m_campaign.getTimeZone(), m_locale);</span>
<span class="nc" id="L418">    cal.setTime(date);</span>
<span class="nc" id="L419">    cal.set(Calendar.DAY_OF_MONTH, monthStartDay);</span>
<span class="nc" id="L420">    cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L421">    cal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L422">    cal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L423">    cal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L424">    date = cal.getTime();</span>
<span class="nc" id="L425">    return date;</span>
  }

  /**
   * @return getWeekStart is returned as minute offset from 12AM Sunday
   */
  public int getWeekStart() {
<span class="fc" id="L432">    return m_campaign.getWeekStart();</span>
  }

  /**
   * Get the day of week ordinal (1..7) for the given weekOffset minutes.
   *
   * @param weekStart - the week start offset minutes
   * @return the day of week ordinal corresponding to the offset.
   */
  public int getWeekStartDay() {
<span class="nc" id="L442">    return SchedulingPeriodUtil.getWeekStartDay(getWeekStart());</span>
  }

  boolean isEnableElements() {
<span class="nc" id="L446">    return m_isAddMode;</span>
  }

  /**
   * Return an integer representing the month of the year that was chosen for this Monthly SP.
   */
  public int getMonth() {
<span class="nc" id="L453">    return m_month;</span>
  }

  /**
   * Set an integer representing the month of the year for this Monthly SP.
   */
  public void setMonth(int month) {
<span class="nc" id="L460">    m_month = month;</span>
<span class="nc" id="L461">  }</span>

  /**
   * Return an integer representing the Year that was chosen for this Monthly SP.
   */
  public int getYear() {
<span class="nc" id="L467">    return m_year;</span>
  }

  /**
   * Set an integer representing the Year for this Monthly SP.
   */
  public void setYear(int year) {
<span class="nc" id="L474">    m_year = year;</span>
<span class="nc" id="L475">  }</span>

  /**
   * Get a drop down selector containing the months of the year in edit mode, or a static month name string in read-only
   * mode.
   *
   * @param onChangeJS
   */
  public String getMonthElement(String onChangeJS) {
<span class="nc" id="L484">    Calendar cal = Calendar.getInstance(m_campaign.getTimeZone(), m_locale);</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">    int selectedMonth = m_month == -1 ? cal.get(Calendar.MONTH) : m_month;</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">    if (isEnableElements()) {</span>
<span class="nc" id="L487">      return SchedulingPeriodUtil.getMonthDropDown(CAMP_MONTH_FN, selectedMonth, onChangeJS, m_localizer);</span>
    } else {
<span class="nc" id="L489">      return m_localizer.getMonthNames(true)[selectedMonth]</span>
<span class="nc" id="L490">          + HtmlUtil.makeHiddenInput(CAMP_MONTH_FN, Integer.toString(selectedMonth));</span>
    }
  }

  /**
   * Get a drop down selector containing the years, or a static year value string in read-only mode.
   *
   * @param onChangeJS
   */
  public String getYearElement(String onChangeJS) {
<span class="nc" id="L500">    Calendar cal = Calendar.getInstance(m_campaign.getTimeZone(), m_locale);</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">    int selectedYear = m_year == -1 ? cal.get(Calendar.YEAR) : m_year;</span>

<span class="nc bnc" id="L503" title="All 2 branches missed.">    if (isEnableElements()) {</span>
<span class="nc" id="L504">      return SchedulingPeriodUtil.getYearDropDown(CAMP_YEAR_FN, selectedYear, onChangeJS, m_localizer);</span>
    } else {
<span class="nc" id="L506">      return Integer.toString(selectedYear) + HtmlUtil.makeHiddenInput(CAMP_YEAR_FN, Integer.toString(selectedYear));</span>
    }
  }

  private int[] getDisabledDays(int theOnlyEnabledDay) {
<span class="fc" id="L511">    int[] disabledDays = new int[6];</span>
<span class="fc" id="L512">    int index = 0;</span>
<span class="pc bpc" id="L513" title="1 of 2 branches missed.">    if (theOnlyEnabledDay != Hoo.MONDAY) {</span>
<span class="nc" id="L514">      disabledDays[index++] = Calendar.MONDAY;</span>
    }
<span class="pc bpc" id="L516" title="1 of 2 branches missed.">    if (theOnlyEnabledDay != Hoo.TUESDAY) {</span>
<span class="fc" id="L517">      disabledDays[index++] = Calendar.TUESDAY;</span>
    }
<span class="pc bpc" id="L519" title="1 of 2 branches missed.">    if (theOnlyEnabledDay != Hoo.WEDNESDAY) {</span>
<span class="fc" id="L520">      disabledDays[index++] = Calendar.WEDNESDAY;</span>
    }
<span class="pc bpc" id="L522" title="1 of 2 branches missed.">    if (theOnlyEnabledDay != Hoo.THURSDAY) {</span>
<span class="fc" id="L523">      disabledDays[index++] = Calendar.THURSDAY;</span>
    }
<span class="pc bpc" id="L525" title="1 of 2 branches missed.">    if (theOnlyEnabledDay != Hoo.FRIDAY) {</span>
<span class="fc" id="L526">      disabledDays[index++] = Calendar.FRIDAY;</span>
    }
<span class="pc bpc" id="L528" title="1 of 2 branches missed.">    if (theOnlyEnabledDay != Hoo.SATURDAY) {</span>
<span class="fc" id="L529">      disabledDays[index++] = Calendar.SATURDAY;</span>
    }
<span class="pc bpc" id="L531" title="1 of 2 branches missed.">    if (theOnlyEnabledDay != Hoo.SUNDAY) {</span>
<span class="fc" id="L532">      disabledDays[index++] = Calendar.SUNDAY;</span>
    }
<span class="fc" id="L534">    return disabledDays;</span>
  }

  protected void loadData() throws Exception {
<span class="fc bfc" id="L538" title="All 2 branches covered.">    if (!m_isLoaded) {</span>
<span class="pc bpc" id="L539" title="1 of 2 branches missed.">      if (isSPSelected()) {</span>
<span class="nc" id="L540">        Collection&lt;ID&gt; spIDs = getSelectedSchedulingPeriodIDs();</span>
<span class="nc" id="L541">        CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L542">        SchedulingPeriod sp = camManager.getSchedulingPeriodByID(spIDs.iterator().next());</span>
<span class="nc" id="L543">        ID campID = sp.getCampaignID();</span>
<span class="nc" id="L544">        m_campaign = camManager.getCampaignByID(campID);</span>
<span class="nc" id="L545">        m_SP.setCampaignID(campID);</span>
<span class="pc bpc" id="L546" title="1 of 2 branches missed.">      } else if (isCampaignSelected()) {</span>
<span class="fc" id="L547">        Collection&lt;ID&gt; campIDs = getSelectedCampaignIDs();</span>
<span class="fc" id="L548">        CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L549">        ID campID = campIDs.iterator().next();</span>
<span class="fc" id="L550">        m_campaign = camManager.getCampaignByID(campID);</span>
<span class="fc" id="L551">        m_SP.setCampaignID(campID);</span>
      }
<span class="fc" id="L553">      m_isLoaded = true;</span>
    }
<span class="fc" id="L555">  }</span>

  public String getFormTitle() {
<span class="pc bpc" id="L558" title="3 of 4 branches missed.">    if (!hasSelectedID() &amp;&amp; !m_isAddMode) {</span>
<span class="nc" id="L559">      return &quot;&quot;;</span>
    } else {
<span class="fc" id="L561">      return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_CREATE_SP);</span>
    }
  }

  public boolean isCampaignSelected() {
<span class="pc bpc" id="L566" title="1 of 2 branches missed.">    return getSelectedCampaignIDs().size() &gt; 0;</span>
  }

  public boolean isSPSelected() {
<span class="pc bpc" id="L570" title="1 of 2 branches missed.">    return getSelectedSchedulingPeriodIDs().size() &gt; 0;</span>
  }

  /**
   * Return the DropDown display of supported Time Zones with the current selected Time Zone choosen
   */
  public String getTimezoneDropDown(String onChangeJS) {
<span class="nc" id="L577">    String timezoneID = getTimezoneID();</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">    String selectedTimezoneID = (timezoneID != null) ? timezoneID : &quot;&quot;;</span>

<span class="nc bnc" id="L580" title="All 2 branches missed.">    if (m_isAddMode) {</span>
<span class="nc" id="L581">      return HtmlUtil.getTimeZoneDropDown(CAMP_TIMEZONE_ID_FN, selectedTimezoneID, onChangeJS, m_localizer);</span>
    } else {
<span class="nc" id="L583">      return m_localizer.formatTimeZone(selectedTimezoneID)</span>
<span class="nc" id="L584">          + HtmlUtil.makeHiddenInput(CAMP_TIMEZONE_ID_FN, selectedTimezoneID);</span>
    }
  }

  public String getDaysOfWeekDropDown(String onChangeJS) {
<span class="nc" id="L589">    int selectedDay = 1;</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">    if (m_isAddMode) {</span>
<span class="nc" id="L591">      return HtmlUtil.getDayOfWeekDropDown(CAMP_WEEK_START_DAY_FN, selectedDay, onChangeJS, false, m_localizer);</span>
    } else {
<span class="nc" id="L593">      return m_localizer.getWeekdayNames(true)[selectedDay]</span>
<span class="nc" id="L594">          + HtmlUtil.makeHiddenInput(CAMP_WEEK_START_DAY_FN, Integer.toString(selectedDay));</span>
    }
  }

  /**
   * Return the Organization Time Zone ID
   */
  public String getTimezoneID() {
<span class="nc" id="L602">    TimeZone timezone = TimeZone.getDefault();</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">    return (timezone != null) ? timezone.getID() : &quot;&quot;;</span>
  }

  /**
   * Return the TimeZone from the timezoneId
   */
  public TimeZone getTimeZone() {
<span class="nc" id="L610">    return TimeZone.getTimeZone(getTimezoneID());</span>
  }

  /**
   * Return the localized Timezone label
   */
  public String getTimezoneLabel() {
<span class="fc" id="L617">    return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_TIMEZONE);</span>
  }

  /**
   * Return the localized Week Start Day label
   */
  public String getWeekStartDayLabel() {
<span class="nc" id="L624">    return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_WEEK_START_DAY);</span>
  }

  public String getCampaignNameLabel() {
<span class="fc" id="L628">    return i18n(m_bundle, FsWebBundleKey.FS_CAMPAIGN);</span>
  }

  public String getNumberOfWeeksLabel() {
<span class="fc" id="L632">    return i18n(m_bundle, FsWebBundleKey.SCHEDULINGPERIOD_NUMBEROFWEEKS);</span>
  }

  public String getSPStartDateLabel() {
<span class="fc" id="L636">    return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_START_DATE);</span>
  }

  /**
   * Return the localized Day Boundary Offset label
   */
  public String getDayBoundaryOffsetLabel() {
<span class="fc" id="L643">    return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_DAY_BOUNDARY_OFFSET);</span>
  }

  public String getDescriptionLabel() {
<span class="nc" id="L647">    return i18n(m_bundle, FsWebBundleKey.SCHEDULINGPERIOD_DESC);</span>
  }

  public String getMonthLabel() {
<span class="nc" id="L651">    return i18n(m_bundle, FsWebBundleKey.MONTH);</span>
  }

  // Getters and Setters

  // Overriding this so that cached IDs are set properly
  public void setSelectedID(String ids) {
<span class="fc" id="L658">    super.setSelectedID(ids);</span>
<span class="fc" id="L659">    setSelectedCampaignIDs(CampaignSchedulingPeriodSelectionUtil.extractIDs(getSelectedID(),</span>
        CampaignSchedulingPeriodSelectionUtil.CAMPAIGN_ID_PREFIX));
<span class="fc" id="L661">    setSelectedSchedulingPeriodIDs(CampaignSchedulingPeriodSelectionUtil.extractIDs(getSelectedID(),</span>
        CampaignSchedulingPeriodSelectionUtil.SP_ID_PREFIX));
<span class="fc" id="L663">  }</span>

  public Collection&lt;ID&gt; getSelectedCampaignIDs() {
<span class="fc" id="L666">    return StringUtil.parseIDStringToCollection(m_selectedCampaignIDs);</span>
  }

  public void setSelectedCampaignIDs(String selectedCampaignIDs) {
<span class="fc" id="L670">    m_selectedCampaignIDs = selectedCampaignIDs;</span>
<span class="fc" id="L671">  }</span>

  public Collection&lt;ID&gt; getSelectedSchedulingPeriodIDs() {
<span class="fc" id="L674">    return StringUtil.parseIDStringToCollection(m_selectedSchedulingPeriodIDs);</span>
  }

  public void setSelectedSchedulingPeriodIDs(String selectedSchedulingPeriodIDs) {
<span class="fc" id="L678">    m_selectedSchedulingPeriodIDs = selectedSchedulingPeriodIDs;</span>
<span class="fc" id="L679">  }</span>

  /**
   * Return Day Boundary Offset Time UI
   */
  public String getDayBoundaryOffsetTimeUI(String onChange) {
<span class="nc" id="L685">    int weekstart = getWeekStart();</span>
<span class="nc" id="L686">    int offset = weekstart % (1440);</span>
<span class="nc" id="L687">    m_timePickerPC.setTime(offset * 60); // seconds</span>
<span class="nc" id="L688">    m_timePickerPC.setOnChangeJS(onChange);</span>
<span class="nc" id="L689">    m_timePickerPC.setIsControlEnabled(m_isAddMode);</span>
<span class="nc" id="L690">    return m_timePickerPC.getHtmlDisplay();</span>
  }

  /**
   * Get the HTML row of radio button options for Initialization Options. The options are: - Create as empty - Copy data
   * from previous week(s) (not supported for Monthly campaigns) - Copy data from select period (not supported for Monthly
   * campaigns) - Customize week selection
   */
  private String getInitOpts(String fieldName, int weekNumber, Date curDate) {
<span class="fc" id="L699">    ArrayList&lt;StringsPair&gt; colWPs = null;</span>
<span class="fc" id="L700">    String strID = null;</span>

<span class="fc" id="L702">    boolean isPreviousWeeksEnabled = false;</span>
<span class="fc" id="L703">    boolean isSelectPeriodEnabled = false;</span>
    try {
<span class="fc" id="L705">      ArrayList&lt;SchedulingPeriod&gt; sps =</span>
<span class="fc" id="L706">          (ArrayList&lt;SchedulingPeriod&gt;) CampaignModelHandler.getSchedulingPeriods(m_context, m_campaign.getID(),</span>
              null, null);

<span class="fc" id="L709">      isCreateable = isDateandWeekNumberLegit(sps);</span>
<span class="pc bpc" id="L710" title="3 of 4 branches missed.">      isClonable = sps.size() &gt; 0 &amp;&amp; isCreateable;</span>
<span class="fc" id="L711">      isPreviousWeeksEnabled = isPreviousWeeksLegit(m_campaign);</span>
<span class="fc" id="L712">      isSelectPeriodEnabled = isSelectPeriodLegit(m_campaign);</span>
<span class="fc" id="L713">      colWPs = new ArrayList&lt;StringsPair&gt;(sps.size());</span>
<span class="fc" id="L714">      int count = 0;</span>
<span class="pc bpc" id="L715" title="1 of 2 branches missed.">      for (int i = sps.size() - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L716">        SchedulingPeriod sp = sps.get(i);</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">        if (getSPWeeks(sp) == numberofWeeks) {</span>
<span class="nc" id="L718">          colWPs.add(new StringsPair(sp.getID().toString(), getSPNameInRegionalFormat(sp)));</span>
<span class="nc" id="L719">          count++;</span>
        }
      }

<span class="pc bpc" id="L723" title="1 of 2 branches missed.">      if (count &gt; 0) {</span>
<span class="nc" id="L724">        strID = colWPs.get(0).getKey();</span>
      }
<span class="nc" id="L726">    } catch (BbmException e) {</span>
<span class="nc" id="L727">      handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L728">    } catch (Exception e) {</span>
<span class="nc" id="L729">      handleUnableToLoadDataError(log, e);</span>
<span class="pc" id="L730">    }</span>

<span class="fc" id="L732">    StringBuilder copyEmployeeDataEnableJS = getCopyEmployeeDataEnableJS();</span>
<span class="fc" id="L733">    StringBuilder selectedPeriodJS = new StringBuilder();</span>

<span class="fc" id="L735">    HtmlTable table = new HtmlTable(&quot;0&quot;, &quot;0&quot;, &quot;0&quot;);</span>
<span class="fc" id="L736">    HtmlTableRow row = new HtmlTableRow();</span>
<span class="fc" id="L737">    row.setAttribute(&quot;nowrap&quot;);</span>
<span class="fc" id="L738">    HtmlTableCell cell = new HtmlTableCell();</span>
<span class="fc" id="L739">    cell.setAttribute(&quot;nowrap&quot;);</span>
<span class="fc" id="L740">    cell.setAttribute(&quot;class&quot;, &quot;fTPCell&quot;);</span>
<span class="fc" id="L741">    TableRowCell trc = new TableRowCell(table, row, cell);</span>

    // Row 1 - Create as empty
<span class="fc" id="L744">    addRow1ToTable(fieldName, trc, selectedPeriodJS);</span>

<span class="pc bpc" id="L746" title="1 of 2 branches missed.">    if (isWeeklyCampaign()) {</span>
      // Row 2 - Copy data from previous week(s)
<span class="fc" id="L748">      addRow2ToTable(fieldName, trc, isPreviousWeeksEnabled, selectedPeriodJS, copyEmployeeDataEnableJS);</span>

      // Row 3 - Copy data from select period
<span class="fc" id="L751">      addRow3ToTable(fieldName, trc, colWPs, strID, isSelectPeriodEnabled, copyEmployeeDataEnableJS);</span>
    }

    // Row 4 - Customize week selection
<span class="fc" id="L755">    addRow4ToTable(fieldName, trc, selectedPeriodJS, copyEmployeeDataEnableJS);</span>

    //add the &quot;Copy employee Min/Max hours, skill, and work pattern assignments&quot; checkbox
<span class="fc" id="L758">    addCopyEmployeeDataRowToTable(trc, isPreviousWeeksEnabled, isSelectPeriodEnabled);</span>

    //add the &quot;Copy Project Queue Requirements and Outbound Call Lists to partial weeks&quot; checkbox for Monthly SP's
<span class="fc" id="L761">    addCopyProjectDataRowToTable(trc);</span>

<span class="fc" id="L763">    return table.toString();</span>
  }

  /**
   * A simple container class to hold an HTML table, row, and cell.
   */
  class TableRowCell {
    HtmlTable table;
    HtmlTableRow row;
    HtmlTableCell cell;

<span class="fc" id="L774">    public TableRowCell(HtmlTable t, HtmlTableRow r, HtmlTableCell c) {</span>
<span class="fc" id="L775">      table = t;</span>
<span class="fc" id="L776">      row = r;</span>
<span class="fc" id="L777">      cell = c;</span>
<span class="fc" id="L778">    }</span>
  }

  /**
   * Row 1 - Create as empty
   *
   * @param fieldName
   * @param labelEmpty
   * @param table
   * @param row
   * @param cell
   * @param copyEmployeeDataDisableJS
   * @param copyProjectDataDisableJS
   */
  protected void addRow1ToTable(String fieldName, TableRowCell trc, StringBuilder selectedPeriodJS) {
<span class="fc" id="L793">    String labelEmpty = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_EMPTY);</span>
<span class="fc" id="L794">    StringBuilder copyEmployeeDataDisableJS = getCopyEmployeeDataDisableJS();</span>
<span class="fc" id="L795">    StringBuilder copyProjectDataDisableJS = getCopyProjectDataDisableJS();</span>

<span class="fc" id="L797">    selectedPeriodJS.append(&quot;dd_disable('&quot;).append(fieldName + CAMP_SP_CREATE_PREV_PERIOD).append(&quot;', 0, true);\n&quot;);</span>

<span class="pc bpc" id="L799" title="2 of 4 branches missed.">    trc.cell.setInnerHtml(HtmlChoiceInput.makeRadioInput(fieldName, CREATE_EMPTY, labelEmpty, selection == 0 ? true : false,</span>
<span class="fc" id="L800">        !isCreateable, selectedPeriodJS.toString() + copyEmployeeDataDisableJS.toString() +</span>
<span class="fc" id="L801">            copyProjectDataDisableJS.toString()));</span>
<span class="fc" id="L802">    trc.row.add(trc.cell.toString());</span>
<span class="fc" id="L803">    trc.table.add(trc.row.toString());</span>
<span class="fc" id="L804">    trc.row.clear();</span>
<span class="fc" id="L805">  }</span>

  /**
   * @return Javascript to disable checkbox for copying Project &amp; Outbound Call List data
   */
  protected StringBuilder getCopyProjectDataDisableJS() {
<span class="fc" id="L811">    StringBuilder copyProjectDataDisableJS = new StringBuilder();</span>
<span class="pc bpc" id="L812" title="1 of 2 branches missed.">    if (isMonthlyCampaign()) {</span>
      // disable checkbox for copying Project data (used when &quot;Create as Empty&quot; radio button is clicked)
<span class="nc" id="L814">      copyProjectDataDisableJS.append(&quot;jQuery('#&quot;).append(projectCheckboxPC.getInputID()).</span>
<span class="nc" id="L815">          append(&quot;').prop('disabled', true);\n&quot;);</span>
    }
<span class="fc" id="L817">    return copyProjectDataDisableJS;</span>
  }

  /**
   * @return Javascript to enable checkbox for copying Project &amp; Outbound Call List data
   */
  protected StringBuilder getCopyProjectDataEnableJS() {
<span class="fc" id="L824">    StringBuilder copyProjectDataEnableJS = new StringBuilder();</span>
<span class="pc bpc" id="L825" title="1 of 2 branches missed.">    if (isMonthlyCampaign()) {</span>
      //enable JS
<span class="nc" id="L827">      copyProjectDataEnableJS.append(&quot;var var2;\n&quot;);</span>
<span class="nc" id="L828">      copyProjectDataEnableJS.append(&quot;var2 = jQuery('#&quot;).append(projectCheckboxPC.getInputID()).append(&quot;')[0];\n&quot;);</span>
<span class="nc" id="L829">      copyProjectDataEnableJS.append(&quot;var2.disabled = false;\n&quot;);</span>
    }
<span class="fc" id="L831">    return copyProjectDataEnableJS;</span>
  }

  /**
   * @return Javascript to disable checkbox for copying employee data (used when &quot;Create as Empty&quot; radio button is clicked)
   */
  protected StringBuilder getCopyEmployeeDataDisableJS() {
<span class="fc" id="L838">    StringBuilder copyEmployeeDataDisableJS = new StringBuilder();</span>
<span class="pc bpc" id="L839" title="1 of 2 branches missed.">    if (isMonthlyCampaign()) {</span>
<span class="nc" id="L840">      copyEmployeeDataDisableJS.append(&quot;jQuery('#&quot;).append(employeeCheckboxPC.getInputID()).</span>
<span class="nc" id="L841">          append(&quot;').prop('disabled', true);\n&quot;);</span>
    }
<span class="fc" id="L843">    return copyEmployeeDataDisableJS;</span>
  }

  /**
   * @return Javascript to enable checkbox for copying employee data
   */
  protected StringBuilder getCopyEmployeeDataEnableJS() {
<span class="fc" id="L850">    StringBuilder copyEmployeeDataEnableJS = new StringBuilder();</span>
<span class="fc" id="L851">    copyEmployeeDataEnableJS.append(&quot;var var1;\n&quot;);</span>
<span class="fc" id="L852">    copyEmployeeDataEnableJS.append(&quot;var1 = jQuery('#&quot;).append(employeeCheckboxPC.getInputID()).append(&quot;')[0];\n&quot;);</span>
<span class="fc" id="L853">    copyEmployeeDataEnableJS.append(&quot;var1.disabled = false;\n&quot;);</span>
<span class="fc" id="L854">    return copyEmployeeDataEnableJS;</span>
  }

  /**
   * @param table
   * @param row
   * @param cell
   */
  protected void addCopyProjectDataRowToTable(TableRowCell trc) {
<span class="pc bpc" id="L863" title="1 of 2 branches missed.">    if (isMonthlyCampaign()) {</span>
<span class="nc" id="L864">      trc.row.clear();</span>
<span class="nc bnc" id="L865" title="All 4 branches missed.">      boolean isEnabled = selection == 3 &amp;&amp; isClonable;</span>
<span class="nc bnc" id="L866" title="All 2 branches missed.">      projectCheckboxPC.setIsDisabled(!isEnabled);</span>
<span class="nc" id="L867">      trc.cell.setInnerHtml(projectCheckboxPC.getHtmlDisplay());</span>
<span class="nc" id="L868">      trc.row.add(trc.cell.toString());</span>
<span class="nc" id="L869">      trc.table.add(trc.row.toString());</span>
    }
<span class="fc" id="L871">  }</span>

  /**
   * @param table
   * @param row
   * @param cell
   * @param isPreviousWeeksEnabled
   * @param isSelectPeriodEnabled
   */
  protected void addCopyEmployeeDataRowToTable(TableRowCell trc, boolean isPreviousWeeksEnabled,
                                               boolean isSelectPeriodEnabled) {
<span class="pc bpc" id="L882" title="13 of 16 branches missed.">    boolean isEnabled =</span>
        (selection == 1 &amp;&amp; isClonable &amp;&amp; isPreviousWeeksEnabled)
            || (selection == 2 &amp;&amp; isClonable &amp;&amp; isSelectPeriodEnabled) || (selection == 3 &amp;&amp; isClonable);

<span class="pc bpc" id="L886" title="1 of 2 branches missed.">    employeeCheckboxPC.setIsDisabled(!isEnabled);</span>
<span class="fc" id="L887">    trc.cell.setInnerHtml(employeeCheckboxPC.getHtmlDisplay());</span>
<span class="fc" id="L888">    trc.row.add(trc.cell.toString());</span>
<span class="fc" id="L889">    trc.table.add(trc.row.toString());</span>
<span class="fc" id="L890">  }</span>

  /**
   * Row 4 - Customize week selection
   *
   * @param fieldName
   * @param labelCustomize
   * @param table
   * @param row
   * @param cell
   * @param selectedPeriodJS
   * @param copyEmployeeDataEnableJS
   * @param copyProjectDataEnableJS
   */
  protected void addRow4ToTable(String fieldName, TableRowCell trc, StringBuilder selectedPeriodJS,
                                StringBuilder copyEmployeeDataEnableJS) {
<span class="fc" id="L906">    String labelCustomize = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_CUSTOMIZED);</span>
<span class="fc" id="L907">    StringBuilder editIconHtml = new StringBuilder();</span>

<span class="pc bpc" id="L909" title="1 of 2 branches missed.">    if (isClonable) {</span>
<span class="nc" id="L910">      editIconHtml</span>
<span class="nc" id="L911">          .append(HtmlUtil.imageTag(ImageFileID.EDIT, ImageFileID.EDIT_WIDTH, ImageFileID.EDIT_HEIGHT,</span>
<span class="nc" id="L912">              m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.EDIT), false))</span>
<span class="nc" id="L913">          .append(&quot; onClick=\&quot;&quot;)</span>
<span class="nc" id="L914">          .append(&quot;var var1;\n var1 = DOM2.getElementById('&quot;)</span>
<span class="nc" id="L915">          .append(fieldName)</span>
<span class="nc" id="L916">          .append(&quot;_&quot;)</span>
<span class="nc" id="L917">          .append(CREATE_CUSTOMIZE)</span>
<span class="nc" id="L918">          .append(&quot;_0&quot;)</span>
<span class="nc" id="L919">          .append(&quot;')\n;&quot;)</span>
<span class="nc" id="L920">          .append(&quot;var1.click();&quot;)</span>
<span class="nc" id="L921">          .append(&quot;this.&quot; + CustomizeWeeksPopupPM.WEEK_NUMBERS)</span>
<span class="nc" id="L922">          .append(&quot;=&quot;)</span>
<span class="nc" id="L923">          .append(&quot;pageMediator.getValue('&quot; + CAMP_NUMBEROFWEEKS_FN + &quot;');&quot;)</span>
<span class="nc" id="L924">          .append(&quot;this.&quot; + CustomizeWeeksPopupPM.START_DATE)</span>
<span class="nc" id="L925">          .append(&quot;=&quot;)</span>
<span class="nc" id="L926">          .append(&quot;pageMediator.getValue('&quot; + CAMP_SP_START_DATE_FN + &quot;');&quot;)</span>
<span class="nc" id="L927">          .append(&quot;this.&quot; + CustomizeWeeksPopupPM.CAMPAIGN_ID)</span>
<span class="nc" id="L928">          .append(&quot;=&quot;)</span>
<span class="nc" id="L929">          .append(&quot;pageMediator.getValue('&quot; + CAMPAIGN_ID + &quot;');&quot;)</span>

<span class="nc" id="L931">          .append(&quot;bindCustomWeekFields('&quot; + CustomizeWeeksPopupPM.WEEK_NUMBERS + &quot;','&quot; + CAMP_NUMBEROFWEEKS_FN</span>
              + &quot;','&quot; + CustomizeWeeksPopupPM.START_DATE + &quot;','&quot; + CAMP_SP_START_DATE_FN + &quot;','&quot;
              + CustomizeWeeksPopupPM.CAMPAIGN_ID + &quot;','&quot; + CAMPAIGN_ID + &quot;');&quot;)

<span class="nc" id="L935">          .append(m_toolbar.getName()).append(&quot;.onSelect('&quot;).append(CustomizeWeeksPopupPM.POPUP_ID)</span>
<span class="nc" id="L936">          .append(&quot;',this);\&quot; &quot;).append(&quot;actionType=\&quot;POPUP_WINDOW_TYPE\&quot;&quot;).append(&quot;&gt;&quot;);</span>
    } else {
<span class="fc" id="L938">      editIconHtml.append(HtmlUtil.imageTag(ImageFileID.EDIT, ImageFileID.EDIT_WIDTH, ImageFileID.EDIT_HEIGHT,</span>
<span class="fc" id="L939">          m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.EDIT), true));</span>
    }

<span class="fc" id="L942">    StringBuilder copyProjectDataEnableJS = getCopyProjectDataEnableJS();</span>
<span class="pc bpc" id="L943" title="2 of 4 branches missed.">    trc.cell.setInnerHtml(HtmlChoiceInput.makeRadioInput(fieldName, CREATE_CUSTOMIZE, labelCustomize, selection == 3 ? true</span>
<span class="fc" id="L944">        : false, !isClonable, selectedPeriodJS.toString() + copyEmployeeDataEnableJS.toString()</span>
<span class="fc" id="L945">        + copyProjectDataEnableJS.toString())</span>
<span class="fc" id="L946">        + editIconHtml.toString());</span>
<span class="fc" id="L947">    trc.row.add(trc.cell.toString());</span>
<span class="fc" id="L948">    trc.table.add(trc.row.toString());</span>
<span class="fc" id="L949">    trc.row.clear();</span>
<span class="fc" id="L950">  }</span>

  /**
   * Row 3 - Copy data from select period
   *
   * @param fieldName
   * @param labelSelected
   * @param table
   * @param row
   * @param cell
   * @param colWPs
   * @param strID
   * @param isSelectPeriodEnabled
   * @param copyEmployeeDataEnableJS
   */
  protected void addRow3ToTable(String fieldName, TableRowCell trc, List&lt;StringsPair&gt; colWPs,
                                String strID, boolean isSelectPeriodEnabled, StringBuilder copyEmployeeDataEnableJS) {
<span class="fc" id="L967">    String labelSelected = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_SELECTED);</span>
<span class="fc" id="L968">    String[] defaultVal = new String[]{strID};</span>
<span class="fc" id="L969">    StringBuilder selectedPeriodJSCheck = new StringBuilder();</span>
<span class="fc" id="L970">    selectedPeriodJSCheck.append(&quot;dd_disable('&quot;).append(fieldName + CAMP_SP_CREATE_PREV_PERIOD)</span>
<span class="fc" id="L971">        .append(&quot;', 0, false);&quot;);</span>

<span class="pc bpc" id="L973" title="4 of 6 branches missed.">    trc.cell.setInnerHtml(HtmlChoiceInput.makeRadioInput(fieldName, CREATE_FROM_SELECTED, labelSelected, selection == 2</span>
<span class="fc" id="L974">        ? true : false, !isClonable || !isSelectPeriodEnabled, selectedPeriodJSCheck.toString()</span>
<span class="fc" id="L975">        + copyEmployeeDataEnableJS.toString())</span>
        + HtmlUtil.NBSP
<span class="fc" id="L977">        + HtmlUtil.makeSelectInput(fieldName + CAMP_SP_CREATE_PREV_PERIOD, defaultVal, null, colWPs, false,</span>
        false));
<span class="fc" id="L979">    trc.row.add(trc.cell.toString());</span>
<span class="fc" id="L980">    trc.table.add(trc.row.toString());</span>
<span class="fc" id="L981">    trc.row.clear();</span>
<span class="fc" id="L982">  }</span>

  /**
   * Row 2 - Copy data from previous week(s).
   * check if previous week is enabled
   *
   * @param fieldName
   * @param labelPrevWeek
   * @param table
   * @param row
   * @param cell
   * @param isPreviousWeeksEnabled
   * @param selectedPeriodJS
   * @param copyEmployeeDataEnableJS
   */
  protected void addRow2ToTable(String fieldName, TableRowCell trc, boolean isPreviousWeeksEnabled,
                                StringBuilder selectedPeriodJS, StringBuilder copyEmployeeDataEnableJS) {
<span class="fc" id="L999">    String labelPrevWeek = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_PREV_WEEK);</span>
<span class="pc bpc" id="L1000" title="4 of 6 branches missed.">    trc.cell.setInnerHtml(HtmlChoiceInput.makeRadioInput(fieldName, CREATE_USEPREVIOUS, labelPrevWeek, selection == 1</span>
<span class="fc" id="L1001">        ? true : false, !isClonable || !isPreviousWeeksEnabled, selectedPeriodJS.toString()</span>
<span class="fc" id="L1002">        + copyEmployeeDataEnableJS.toString()));</span>
<span class="fc" id="L1003">    trc.row.add(trc.cell.toString());</span>
<span class="fc" id="L1004">    trc.table.add(trc.row.toString());</span>
<span class="fc" id="L1005">    trc.row.clear();</span>
<span class="fc" id="L1006">  }</span>

  public SchedulingPeriod getSchedulingPeriod() {
<span class="fc" id="L1009">    return m_SP;</span>
  }

  private int getSPWeeks(SchedulingPeriod sp) {
<span class="nc" id="L1013">    Date spStartDate = sp.getStartTime();</span>
<span class="nc" id="L1014">    Date spEndDate = sp.getEndTime();</span>
<span class="nc" id="L1015">    int ret = (int) ((spEndDate.getTime() - spStartDate.getTime() + 24 * 60 * 60 * 1000) / (24 * 60 * 60 * 1000 * 7));</span>
<span class="nc" id="L1016">    return ret;</span>
  }

  private boolean isDateandWeekNumberLegit(Collection&lt;SchedulingPeriod&gt; sps) {
<span class="fc" id="L1020">    boolean ret = true;</span>
<span class="fc" id="L1021">    LocalDate spStartLocal = m_SP.getStartTimeLocal();</span>
<span class="fc" id="L1022">    LocalDate spEndLocal = m_SP.getEndTimeLocal();</span>

<span class="fc" id="L1024">    Date spStart = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(spStartLocal, m_campaign.getTimeZone());</span>
<span class="fc" id="L1025">    Date spEnd = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(spEndLocal, m_campaign.getTimeZone());</span>

<span class="pc bpc" id="L1027" title="1 of 2 branches missed.">    for (SchedulingPeriod sp : sps) {</span>
<span class="nc" id="L1028">      Date start = sp.getStartTime();</span>
<span class="nc" id="L1029">      Date end = sp.getEndTime();</span>
<span class="nc bnc" id="L1030" title="All 4 branches missed.">      if ((spStart.getTime() &gt;= start.getTime() &amp;&amp; spStart.getTime() &lt; end.getTime())</span>
<span class="nc bnc" id="L1031" title="All 4 branches missed.">          || (spEnd.getTime() &gt; start.getTime() &amp;&amp; spEnd.getTime() &lt;= end.getTime())) {</span>
<span class="nc" id="L1032">        ret = false;</span>
<span class="nc" id="L1033">        break;</span>
      }
<span class="nc" id="L1035">    }</span>
<span class="fc" id="L1036">    return ret;</span>
  }

  private boolean isPreviousWeeksLegit(Campaign campaign) {
<span class="fc" id="L1040">    boolean ret = false;</span>
<span class="fc" id="L1041">    LocalDate spStartLocal = m_SP.getStartTimeLocal();</span>
<span class="fc" id="L1042">    LocalDate spEndLocal = m_SP.getEndTimeLocal();</span>

<span class="fc" id="L1044">    int numberofweeks =</span>
<span class="fc" id="L1045">        ((TimeZoneUtil.numberOfDays(spStartLocal.getTime(), spEndLocal.getTime(), campaign.getTimeZone()) + 1) / 7);</span>
<span class="fc" id="L1046">    spStartLocal.add(Calendar.DAY_OF_YEAR, -numberofweeks * 7);</span>
<span class="fc" id="L1047">    spEndLocal.add(Calendar.DAY_OF_YEAR, -numberofweeks * 7);</span>
<span class="fc" id="L1048">    Date spStart = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(spStartLocal, m_campaign.getTimeZone());</span>
<span class="fc" id="L1049">    Date spEnd = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(spEndLocal, m_campaign.getTimeZone());</span>
    try {
<span class="fc" id="L1051">      CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
      // This method seems to include all the sphoos form one SP,
      // regardless that hoo is within the time period.
<span class="fc" id="L1054">      Collection&lt;CampaignHOO&gt; hoos = camManager.getCampaignHOOAssignments(m_SP.getParentID(), spStart, spEnd, false);</span>
<span class="fc" id="L1055">      ArrayList&lt;CampaignHOO&gt; newhoos = new ArrayList&lt;CampaignHOO&gt;();</span>
<span class="pc bpc" id="L1056" title="1 of 2 branches missed.">      for (CampaignHOO campaignhoo : hoos) {</span>
<span class="nc" id="L1057">        Date end = campaignhoo.getEndTime();</span>
<span class="nc" id="L1058">        Date start = campaignhoo.getStartTime();</span>
<span class="nc bnc" id="L1059" title="All 4 branches missed.">        if (end.getTime() &lt;= spEnd.getTime() &amp;&amp; start.getTime() &gt;= spStart.getTime()) {</span>
<span class="nc" id="L1060">          newhoos.add(campaignhoo);</span>
        }
<span class="nc" id="L1062">      }</span>

<span class="pc bpc" id="L1064" title="1 of 2 branches missed.">      if (newhoos.size() == numberofweeks) {</span>
<span class="nc" id="L1065">        ret = true;</span>
      }
<span class="nc" id="L1067">    } catch (Exception e) {</span>
<span class="nc" id="L1068">      handleUnableToLoadDataError(log, e);</span>
<span class="fc" id="L1069">    }</span>
<span class="fc" id="L1070">    return ret;</span>
  }

  private boolean isSelectPeriodLegit(Campaign campaign) {
<span class="fc" id="L1074">    boolean ret = false;</span>
<span class="fc" id="L1075">    LocalDate spStartLocal = m_SP.getStartTimeLocal();</span>
<span class="fc" id="L1076">    LocalDate spEndLocal = m_SP.getEndTimeLocal();</span>
<span class="fc" id="L1077">    Date spStart = spStartLocal.getTime();</span>
<span class="fc" id="L1078">    Date spEnd = spEndLocal.getTime();</span>
<span class="fc" id="L1079">    int numberofweeks = ((TimeZoneUtil.numberOfDays(spStart, spEnd, campaign.getTimeZone()) + 1) / 7);</span>
    try {
<span class="fc" id="L1081">      CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L1082">      Collection&lt;Campaign&gt; campColls = new ArrayList&lt;Campaign&gt;();</span>
<span class="fc" id="L1083">      campColls.add(campaign);</span>
<span class="fc" id="L1084">      Collection&lt;SchedulingPeriod&gt; sps = camManager.getSchedulingPeriods(campColls);</span>
<span class="pc bpc" id="L1085" title="1 of 2 branches missed.">      for (SchedulingPeriod sp : sps) {</span>
<span class="nc" id="L1086">        int weeks = (TimeZoneUtil.numberOfDays(sp.getStartTime(), sp.getEndTime(), campaign.getTimeZone()) + 1) / 7;</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">        if (weeks == numberofweeks) {</span>
<span class="nc" id="L1088">          ret = true;</span>
<span class="nc" id="L1089">          break;</span>
        }
<span class="nc" id="L1091">      }</span>
<span class="nc" id="L1092">    } catch (Exception e) {</span>
<span class="nc" id="L1093">      handleUnableToLoadDataError(log, e);</span>
<span class="fc" id="L1094">    }</span>
<span class="fc" id="L1095">    return ret;</span>
  }

  public String getRequiredHTML() {
<span class="fc" id="L1099">    return super.getRequiredHTML() + HtmlUtil.makeHiddenInput(SELECTED_HOO_ID, &quot;&quot;)</span>
<span class="fc" id="L1100">        + HtmlUtil.makeHiddenInput(CAMPAIGN_ID, m_campaign.getID())</span>
<span class="fc" id="L1101">        + HtmlUtil.makeHiddenInput(DAYBOUNDARY_IN_MUNITES, getWeekStart() % 1440);</span>
  }

  private String getSPNameInRegionalFormat(SchedulingPeriod sp) {
<span class="nc" id="L1105">    LocalDate endDate = new LocalDate(sp.getEndTimeLocal());</span>
<span class="nc" id="L1106">    endDate.add(Calendar.DATE, -1);</span>

<span class="nc" id="L1108">    return m_localizer.formatDate(sp.getStartTimeLocal(), RegionalFormatBundleKey.DATE_FORMAT) + &quot; - &quot;</span>
<span class="nc" id="L1109">        + m_localizer.formatDate(endDate, RegionalFormatBundleKey.DATE_FORMAT);</span>
  }

  public boolean isWeeklyCampaign() {
<span class="pc bpc" id="L1113" title="1 of 2 branches missed.">    if (m_campaign == null) {</span>
<span class="nc" id="L1114">      return true;</span>
    }
<span class="fc" id="L1116">    return SchedulingPeriodUtil.isWeeklyCampaign(m_campaign);</span>
  }

  public boolean isMonthlyCampaign() {
<span class="pc bpc" id="L1120" title="1 of 2 branches missed.">    if (m_campaign == null) {</span>
<span class="nc" id="L1121">      return false;</span>
    }
<span class="fc" id="L1123">    return SchedulingPeriodUtil.isMonthlyCampaign(m_campaign);</span>
  }

  public void setCampaign(Campaign camp) {
<span class="nc" id="L1127">    m_campaign = camp;</span>
<span class="nc" id="L1128">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>