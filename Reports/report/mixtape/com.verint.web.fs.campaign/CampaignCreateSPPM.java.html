<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignCreateSPPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.campaign</a> &gt; <span class="el_source">CampaignCreateSPPM.java</span></div><h1>CampaignCreateSPPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.campaign;

import static com.verint.web.fs.campaign.CustomizeWeeksPopupPM.POPUP_ID;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.Locale;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.l10n.TimeZoneBundleKey;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOO;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriodUtil;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.campaign.selection.CampaignSchedulingPeriodSelectionUtil;
import com.bluepumpkin.web.bbm.hoo.Hoo;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.campaign.sp.SchedulingPeriodUtil;
import com.bluepumpkin.web.fs.keys.FsJavaScriptFileID;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.jsp.HtmlTable;
import com.witness.web.uif.jsp.HtmlTableCell;
import com.witness.web.uif.jsp.HtmlTableRow;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.TimePickerPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.SettingPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.HtmlBooleanCheckbox;
import com.witness.web.uif.util.html.HtmlChoiceInput;

@SuppressWarnings(&quot;serial&quot;)
public class CampaignCreateSPPM extends SettingPM {

	public static final String FORM_ACTION = &quot;campaign_customize_week_popup&quot;;
	private static final String CONFIRM_COPY_LOCKED_ONLY = &quot;CONFIRM_COPY_LOCKED_ONLY&quot;;
	public static final String CAMPAIGN_ID = &quot;campaignID&quot;;
	public static final String SELECTED_HOO_ID = &quot;selectedHooID&quot;;
	public static final String DAYBOUNDARY_IN_MUNITES = &quot;dayboundaryinminutes&quot;;

	public static final String CAMP_NAME_FN = &quot;campaignname&quot;;
	public static final String CAMP_WEEK_START_DAY_FN = &quot;campaignweekstartday&quot;;
	public static final String CAMP_TIMEZONE_ID_FN = &quot;campaigntimezoneid&quot;;
	public static final String CAMP_DAY_BOUNDARY_OFFSET_FN = &quot;campaigndayboundary&quot;;
	public static final String CAMP_NUMBEROFWEEKS_FN = &quot;campaignnumberofweeks&quot;;
	public static final String CAMP_SP_START_DATE_FN = &quot;campaignspstartdate&quot;;
	public static final String CAMP_SP_CREATE_PREV_PERIOD = &quot;campaigncreateprevperiod&quot;;
	public static final String CAMP_INIT_OPTIONS_FN = &quot;campaigninitoptions&quot;;
	public static final String CAMP_SP_CREATE_PREV_SECECT = CAMP_INIT_OPTIONS_FN + CAMP_SP_CREATE_PREV_PERIOD;
	public static final String CAMP_SP_CUSTOMIZE_IMAGE_FN = &quot;campaignspcustomizeimage&quot;;
	public static final String CAMP_SP_CUSTOMIZE_IMAGE_DISABLE_FN = &quot;campaignspcustomizeimagedisable&quot;;
	public static final String ON_CHANGE_SCRIPT = &quot;pageMediator.refreshPageWithAction('&quot; + PageAction.FORCE_REFRESH
			+ &quot;', true);&quot;;

	private static final String CREATE_EMPTY = &quot;createempty&quot;;
	private static final String CREATE_USEPREVIOUS = &quot;createuseprevious&quot;;
	private static final String CREATE_FROM_SELECTED = &quot;createfromselected&quot;;
	private static final String CREATE_CUSTOMIZE = &quot;createcustomize&quot;;
	public static final String CAMP_INIT_CREATE_EMPLOYEEDATA_FN = &quot;CampaignCreateSPPM_createEmployeeDataFN&quot;;
	public static final String CAMP_INIT_CREATE_PROJECTDATA_FN = &quot;CampaignCreateSPPM_createProjectDataFN&quot;;	

	private FormTwoColumnPC m_formPC;
	private FormInputPC m_formInputPC;
	private String m_selectedCampaignIDs;
	private String m_selectedSchedulingPeriodIDs;
	private ResourceBundle m_bundle;
	private TimePickerPC m_timePickerPC;
	private DatePickerPC m_datePickerPC;

	private Campaign m_campaign;
<span class="fc" id="L96">	private SchedulingPeriod m_SP = null;</span>

<span class="fc" id="L98">	private int selection = 0;</span>
<span class="fc" id="L99">	private int numberofWeeks = 1;</span>
<span class="fc" id="L100">	private boolean isClonable = false;</span>
<span class="fc" id="L101">	private boolean isCreateable = false;</span>
	private Locale m_languageLocale;
<span class="fc" id="L103">	private boolean copyEmployeedata = false;</span>
<span class="fc" id="L104">	private boolean copyProjectdata = true;</span>
	private HtmlBooleanCheckbox employeeCheckboxPC;
	private HtmlBooleanCheckbox projectCheckboxPC;

	// Monthly Campaign settings
	public static final String CAMP_MONTH_FN = &quot;month&quot;;
	public static final String CAMP_YEAR_FN = &quot;year&quot;;
<span class="fc" id="L111">	private int m_month = -1;</span>
<span class="fc" id="L112">	private int m_year = -1;</span>
<span class="fc" id="L113">	private boolean m_isLoaded = false;</span>

	public CampaignCreateSPPM(RequestContext context) {
<span class="fc" id="L116">		super(context);</span>

<span class="fc" id="L118">		m_languageLocale = m_context.getLocaleContext().getLanguageLocale();</span>
<span class="fc" id="L119">		m_bundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

<span class="fc" id="L121">		m_formPC = new FormTwoColumnPC(context);</span>
<span class="fc" id="L122">		addChildComponent(m_formPC);</span>

<span class="fc" id="L124">		m_SP = new SchedulingPeriod();</span>

		// Add Date Time Picker for Day Boundary
<span class="fc" id="L127">		m_timePickerPC = new TimePickerPC(context);</span>
<span class="fc" id="L128">		m_timePickerPC.setInputFieldName(CAMP_DAY_BOUNDARY_OFFSET_FN);</span>
<span class="fc" id="L129">		m_timePickerPC.setTimeInterval(15);</span>
<span class="fc" id="L130">		addChildComponent(m_timePickerPC);</span>

<span class="fc" id="L132">		m_formInputPC = new FormInputPC(context);</span>
<span class="fc" id="L133">		addChildComponent(m_formInputPC);</span>

<span class="fc" id="L135">		m_datePickerPC = new DatePickerPC(context, &quot;&quot;);</span>

<span class="fc" id="L137">		m_datePickerPC.reset();</span>
<span class="fc" id="L138">		m_datePickerPC.setDateInputFieldName(CAMP_SP_START_DATE_FN);</span>
<span class="fc" id="L139">		m_datePickerPC.setIsDateValueOptional(false);</span>
<span class="fc" id="L140">		m_datePickerPC.setIsControlEnabled(true);</span>
<span class="fc" id="L141">		addChildComponent(m_datePickerPC);</span>

<span class="fc" id="L143">		String formattedTitle = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_COPY_LOCKED_ONLY);</span>

<span class="fc" id="L145">		addJSVariableAsString(CONFIRM_COPY_LOCKED_ONLY, formattedTitle);</span>

<span class="fc" id="L147">		addPopupArgs(POPUP_ID, CustomizeWeeksPopupPM.FORM_ACTION, &quot;&quot;, CustomizeWeeksPopupPM.WEEK_NUMBERS + &quot;,&quot;</span>
				+ CustomizeWeeksPopupPM.START_DATE + &quot;,&quot; + CustomizeWeeksPopupPM.CAMPAIGN_ID, &quot;550,440,ctr,ctr&quot;, true, 1);

<span class="fc" id="L150">		String labelImport = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_EMP_DATA);</span>
<span class="fc" id="L151">		employeeCheckboxPC = HtmlBooleanCheckbox.createInput(CAMP_INIT_CREATE_EMPLOYEEDATA_FN, labelImport, null, false, true);</span>

<span class="fc" id="L153">		String labelProjectImport = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_PROJECT_DATA);</span>
<span class="fc" id="L154">		projectCheckboxPC = HtmlBooleanCheckbox.createInput(CAMP_INIT_CREATE_PROJECTDATA_FN, </span>
				labelProjectImport, null, false, true);

<span class="fc" id="L157">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="fc" id="L158">		addRequiredJavaScriptFile(FsJavaScriptFileID.CAMPAIGN_SP_CREATE_UTIL);</span>
<span class="fc" id="L159">	}</span>

	public static CampaignCreateSPPM getInstance(RequestContext context) {
<span class="fc" id="L162">		return (CampaignCreateSPPM) getInstance(context, CampaignCreateSPPM.class);</span>
	}

	public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L166">		boolean success = super.extractParameters(request);</span>
		try {
<span class="fc" id="L168">			loadData();</span>
<span class="nc" id="L169">		} catch (Exception ex) {</span>
<span class="nc" id="L170">			handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L171">		}</span>

<span class="fc" id="L173">		String strMinutes = request.getParameter(DAYBOUNDARY_IN_MUNITES);</span>
<span class="fc" id="L174">		int minutes = Integer.parseInt(strMinutes);</span>

<span class="pc bpc" id="L176" title="1 of 2 branches missed.">		if (isWeeklyCampaign()) {</span>
<span class="fc" id="L177">			String strnumberofWeeks = request.getParameter(CAMP_NUMBEROFWEEKS_FN);</span>
<span class="fc" id="L178">			numberofWeeks = Integer.parseInt(strnumberofWeeks);</span>
		}

<span class="fc" id="L181">		Pair&lt;LocalDate, LocalDate&gt; spStartEnd = new Pair&lt;LocalDate, LocalDate&gt;();</span>
<span class="fc" id="L182">		determineSpStartAndEnd(minutes, m_campaign.getMonthStartDay(), numberofWeeks,</span>
<span class="fc" id="L183">				m_datePickerPC.getLocalDate(), spStartEnd);</span>

<span class="fc" id="L185">		m_SP.setStartTimeLocal(spStartEnd.getFirst());</span>
<span class="fc" id="L186">		m_SP.setEndTimeLocal(spStartEnd.getSecond());</span>

<span class="fc" id="L188">		LocalDate tempEnd = new LocalDate(spStartEnd.getSecond());</span>
<span class="fc" id="L189">		tempEnd.add(Calendar.DAY_OF_MONTH, -1);</span>
<span class="fc" id="L190">		String name =</span>
<span class="fc" id="L191">				m_localizer.formatDate(spStartEnd.getFirst(), RegionalFormatBundleKey.DATE_FORMAT)</span>
<span class="fc" id="L192">						+ m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.CAMPAIGN_SP_NAME_LITERAL)</span>
<span class="fc" id="L193">						+ m_localizer.formatDate(tempEnd, RegionalFormatBundleKey.DATE_FORMAT);</span>
<span class="fc" id="L194">		m_SP.setName(name);</span>

<span class="fc" id="L196">		String strBProcOpt = request.getParameter(CAMP_INIT_OPTIONS_FN);</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">		if (strBProcOpt != null) {</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">			if (strBProcOpt.equals(CREATE_EMPTY))</span>
<span class="fc" id="L199">				selection = 0;</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">			else if (strBProcOpt.equals(CREATE_USEPREVIOUS))</span>
<span class="fc" id="L201">				selection = 1;</span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">			else if (strBProcOpt.equals(CREATE_FROM_SELECTED))</span>
<span class="fc" id="L203">				selection = 2;</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">			else if (strBProcOpt.equals(CREATE_CUSTOMIZE))</span>
<span class="nc" id="L205">				selection = 3;</span>
		}

<span class="fc" id="L208">		String strCopyEmployeeData = request.getParameter(CAMP_INIT_CREATE_EMPLOYEEDATA_FN);</span>
<span class="fc" id="L209">		copyEmployeedata = strCopyEmployeeData.equals(&quot;true&quot;);</span>

<span class="fc" id="L211">		String strCopyProjectData = request.getParameter(CAMP_INIT_CREATE_PROJECTDATA_FN);</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">		copyProjectdata = strCopyProjectData == null ? true : &quot;true&quot;.equals(strCopyProjectData);</span>

<span class="fc" id="L214">		return success;</span>
	}

	/**
	 * Determine the SP's start and end LocalDates, and store in the spStartEnd parameter.
	 * @param minutes - the minutes offset (day boundary) for the campaign
	 * @param monthStartDay - Campaign start day
	 * @param numWeeks - number of weeks in the non-monthly SP. Not applicable to Monthly SP's.
	 * @param datePickerVal - the current local date that the date picker is set to.
	 * @param spStartEnd - where we will store the SP's start and end LocalDates
	 */
	public void determineSpStartAndEnd(int minutes, short monthStartDay, int numWeeks, 
			LocalDate datePickerVal, Pair&lt;LocalDate, LocalDate&gt; spStartEnd) {
		LocalDate start;
		LocalDate end;
		
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">		if (isWeeklyCampaign()) {</span>
			// Single-week or multi-week SP
<span class="fc" id="L232">			start  = new LocalDate(datePickerVal);</span>
<span class="fc" id="L233">			start.add(Calendar.MINUTE, minutes);</span>
<span class="fc" id="L234">			end = new LocalDate(start);</span>
<span class="fc" id="L235">			end.add(Calendar.DAY_OF_MONTH, 7 * numWeeks);</span>
		} else {
			// Monthly SP
<span class="nc" id="L238">			Calendar cal = Calendar.getInstance(m_campaign.getTimeZone());</span>
<span class="nc" id="L239">			cal.set(m_year, m_month, monthStartDay, 0, minutes, 0);</span>
<span class="nc" id="L240">			start = new LocalDate(cal);</span>
<span class="nc" id="L241">			cal.add(Calendar.MONTH, 1);</span>
<span class="nc" id="L242">			end = new LocalDate(cal);</span>
		}
<span class="fc" id="L244">		spStartEnd.setFirst(start);</span>
<span class="fc" id="L245">		spStartEnd.setSecond(end);</span>
<span class="fc" id="L246">	}</span>

	public int getSelection() {
<span class="fc" id="L249">		return selection;</span>
	}

	public boolean getIsCopyEmployeeData() {
<span class="fc" id="L253">		return copyEmployeedata;</span>
	}
	
	public boolean getIsCopyProjectData() {
<span class="fc" id="L257">		return copyProjectdata;</span>
	}

	@Override
	protected void initContentTitle() {
<span class="fc" id="L262">		super.initContentTitle();</span>
<span class="fc" id="L263">		m_contentTitlePC.setPageTitle(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.CAMPAIGN_CREATE_SP));</span>
<span class="fc" id="L264">	}</span>

	protected boolean isDeleteActionEnabled() {
		// TODO Auto-generated method stub
<span class="nc" id="L268">		return false;</span>
	}

	protected void initToolbar() {
<span class="fc" id="L272">		ToolbarTextButton saveAndApply = null;</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">		if (selection != 0) {</span>
<span class="nc" id="L274">			saveAndApply =</span>
<span class="nc" id="L275">					m_toolbar.addSubmitTextButton(PageAction.SP_CREATE, i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SAVE),</span>
							isClonable);
		} else {
<span class="fc" id="L278">			saveAndApply =</span>
<span class="fc" id="L279">					m_toolbar.addSubmitTextButton(PageAction.SP_CREATE, i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SAVE),</span>
							isCreateable);
		}

<span class="fc" id="L283">		StringBuilder conditionJS = new StringBuilder();</span>
<span class="fc" id="L284">		conditionJS.append(&quot;var ck = jQuery('#&quot;).append(employeeCheckboxPC.getInputID()).append(&quot;')[0];\n&quot;);</span>
<span class="fc" id="L285">		conditionJS.append(&quot;if (ck.disabled == false) {confirm( CONFIRM_COPY_LOCKED_ONLY )} else{true;}&quot;);</span>

<span class="fc" id="L287">		saveAndApply.setConditionJS(conditionJS.toString());</span>

<span class="fc" id="L289">		m_toolbar.addConfirmSubmitTextButton(PageAction.CANCEL, i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_CANCEL), true);</span>
<span class="fc" id="L290">	}</span>

	protected void initForm() {
<span class="fc" id="L293">		setForm(m_formPC);</span>
<span class="fc" id="L294">		m_formPC.setTitle(getFormTitle());</span>

<span class="fc" id="L296">		Date date = new Date();</span>
<span class="fc" id="L297">		int weekNumber = 1;</span>
<span class="pc bpc" id="L298" title="1 of 4 branches missed.">		if (null != getPageAction() &amp;&amp; (PageAction.FORCE_REFRESH.equals(getPageAction()))</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">				|| (PageAction.SP_CREATE.equals(getPageAction()))) {</span>

<span class="fc" id="L301">			this.extractParameters(m_context.getRequest());</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">			if (isWeeklyCampaign()) {</span>
				// Weekly campaign
<span class="fc" id="L304">				LocalDate localdate = m_datePickerPC.getLocalDate();</span>
<span class="fc" id="L305">				date = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(localdate, m_campaign.getTimeZone());</span>
<span class="fc" id="L306">				String strWeekNumber = m_context.getParameter(CAMP_NUMBEROFWEEKS_FN);</span>
<span class="fc" id="L307">				weekNumber = Integer.parseInt(strWeekNumber);</span>
<span class="fc" id="L308">			} else {</span>
				// Monthly campaign
<span class="nc" id="L310">				String strMonth = m_context.getParameter(CAMP_MONTH_FN);</span>
<span class="nc" id="L311">				int month = Integer.parseInt(strMonth);</span>
<span class="nc" id="L312">				String strYear = m_context.getParameter(CAMP_YEAR_FN);</span>
<span class="nc" id="L313">				int year = Integer.parseInt(strYear);</span>
<span class="nc" id="L314">				int monthStartDay = m_campaign.getMonthStartDay();</span>
<span class="nc" id="L315">				LocalDate localdate = new LocalDate(year, month, monthStartDay, 0, 0, 0);</span>
<span class="nc" id="L316">				date = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(localdate, m_campaign.getTimeZone());</span>
<span class="nc" id="L317">			}</span>
		} else {
			LocalDate start;
			LocalDate end;
<span class="fc" id="L321">			int weekStart = getWeekStart();</span>
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">			if (isWeeklyCampaign()) {</span>
				// Weekly campaign
<span class="fc" id="L324">				date = getDateForWeekStart(date, weekStart);</span>
<span class="fc" id="L325">				start = TimePeriodUtil.convertToLocalDateInTimeZone(date, m_campaign.getTimeZone());</span>
<span class="fc" id="L326">				int minutes = weekStart % 1440;</span>
<span class="fc" id="L327">				start.add(Calendar.MINUTE, minutes);</span>
<span class="fc" id="L328">				end = new LocalDate(start);</span>
<span class="fc" id="L329">				end.add(Calendar.DAY_OF_MONTH, 7 * weekNumber);</span>
<span class="fc" id="L330">			} else {</span>
				// Monthly campaign
<span class="nc" id="L332">				int monthStartDay = m_campaign.getMonthStartDay();</span>
<span class="nc" id="L333">				date = getDateForMonthStart(date, monthStartDay);</span>
<span class="nc" id="L334">				start = TimePeriodUtil.convertToLocalDateInTimeZone(date, m_campaign.getTimeZone());</span>
<span class="nc" id="L335">				int minutes = weekStart % 1440;</span>
<span class="nc" id="L336">				start.add(Calendar.MINUTE, minutes);</span>
<span class="nc" id="L337">				end = new LocalDate(start);</span>
<span class="nc" id="L338">				end.add(Calendar.MONTH, 1);</span>
			}

<span class="fc" id="L341">			m_SP.setStartTimeLocal(start);</span>
<span class="fc" id="L342">			m_SP.setEndTimeLocal(end);</span>
		}

<span class="pc bpc" id="L345" title="1 of 2 branches missed.">		if (m_isAddMode) {</span>
<span class="fc" id="L346">			String campName = m_campaign.getName();</span>
<span class="fc" id="L347">			m_formPC.addRow(getCampaignNameLabel(), campName);</span>

<span class="fc" id="L349">			ResourceBundle rs = m_localizer.getBundle(TimeZoneBundleKey.TIMEZONE_BUNDLE, m_languageLocale);</span>
<span class="fc" id="L350">			String timezoneName = i18n(rs, m_campaign.getTimeZone().getID());</span>
<span class="fc" id="L351">			m_formPC.addRow(getTimezoneLabel(), timezoneName);</span>

<span class="fc" id="L353">			String dayboundary = m_campaign.getDayBoundary(m_localizer);</span>
<span class="fc" id="L354">			m_formPC.addRow(getDayBoundaryOffsetLabel(), dayboundary);</span>

<span class="pc bpc" id="L356" title="1 of 2 branches missed.">			if (isWeeklyCampaign()) {</span>
				// Weekly periodicity needs to show the Number of Weeks selector and Start Date picker
<span class="fc" id="L358">				ArrayList&lt;StringsPair&gt; colWPs = new ArrayList&lt;StringsPair&gt;(6);</span>
<span class="fc bfc" id="L359" title="All 2 branches covered.">				for (int i = 1; i &lt;= 6; i++) {</span>
<span class="fc" id="L360">					colWPs.add(new StringsPair(Integer.toString(i), Integer.toString(i)));</span>
				}

<span class="fc" id="L363">				m_formPC.addRow(getNumberOfWeeksLabel(), HtmlUtil.makeSelectInput(CAMP_NUMBEROFWEEKS_FN,</span>
<span class="fc" id="L364">						Integer.toString(weekNumber), ON_CHANGE_SCRIPT, colWPs));</span>

<span class="fc" id="L366">				int weekStart = getWeekStart();</span>
<span class="fc" id="L367">				date = getDateForWeekStart(date, weekStart);</span>

<span class="fc" id="L369">				m_datePickerPC.setFirstDayOfWeek(SchedulingPeriodUtil.getWeekStartDay(weekStart));</span>
				try {
<span class="fc" id="L371">					m_datePickerPC.setDisabledDays(getDisabledDays(weekStart / 1440));</span>
<span class="nc" id="L372">				} catch (Exception ex) {</span>
<span class="nc" id="L373">					ex.printStackTrace();</span>
<span class="fc" id="L374">				}</span>
<span class="fc" id="L375">				LocalDate localdate = TimePeriodUtil.convertToLocalDateInTimeZone(date, m_campaign.getTimeZone());</span>
<span class="fc" id="L376">				m_datePickerPC.setDate(localdate);</span>
<span class="fc" id="L377">				m_datePickerPC.setOnChangeJS(ON_CHANGE_SCRIPT);</span>
<span class="fc" id="L378">				m_formPC.addRow(getSPStartDateLabel(), m_datePickerPC.getHtmlDisplay());</span>
<span class="fc" id="L379">			} else {</span>
<span class="nc" id="L380">				LocalDate localdate = TimePeriodUtil.convertToLocalDateInTimeZone(date, m_campaign.getTimeZone());</span>
<span class="nc" id="L381">				SimpleDateFormat sdf = m_context.getLocalizer().getDateInputFormatter(m_context.getViewingTimeZone());</span>
<span class="nc" id="L382">				String localdateStr = sdf.format(localdate.getTime(m_campaign.getTimeZone()));</span>
				// set the start date hidden field to the start of the selected month, Ex: &quot;10/11/2015&quot;
<span class="nc" id="L384">				String startDateHiddenField = HtmlUtil.makeHiddenInput(CAMP_SP_START_DATE_FN, localdateStr);</span>
				// set the num weeks hidden field to -1 which indicates a Monthly SP
<span class="nc" id="L386">				String numWeeksHiddenField = HtmlUtil.makeHiddenInput(CAMP_NUMBEROFWEEKS_FN, &quot;-1&quot;);</span>

				// Monthly periodicity needs to show the Month and Year selectors, and hidden fields for num weeks, start
				// date
<span class="nc" id="L390">				String curRow =</span>
<span class="nc" id="L391">						getMonthElement(ON_CHANGE_SCRIPT) + &quot; &amp;nbsp; &quot; + getYearElement(ON_CHANGE_SCRIPT) + &quot; &amp;nbsp; &quot; + &quot;(&quot;</span>
<span class="nc" id="L392">								+ getSPNameInRegionalFormat(m_SP) + &quot;)&quot; + &quot; &amp;nbsp; &quot; + numWeeksHiddenField + &quot; &amp;nbsp; &quot;</span>
								+ startDateHiddenField;
<span class="nc" id="L394">				m_formPC.addRow(getMonthLabel(), curRow);</span>
			}

<span class="fc" id="L397">			m_formPC.addRow(i18n(m_bundle, FsWebBundleKey.SCHEDULINGPERIOD_INITOPTIONS),</span>
<span class="fc" id="L398">					getInitOpts(CAMP_INIT_OPTIONS_FN, weekNumber, date));</span>
		}
<span class="fc" id="L400">	}</span>

	/**
	 * @param date
	 * @param weekStart
	 * @return
	 */
	private Date getDateForWeekStart(Date date, int weekStart) {
<span class="fc" id="L408">		int weekStartDay = SchedulingPeriodUtil.getWeekStartDay(weekStart);</span>
<span class="fc" id="L409">		Calendar cal = Calendar.getInstance(m_campaign.getTimeZone(), m_locale);</span>
<span class="fc" id="L410">		cal.setTime(date);</span>
<span class="fc" id="L411">		cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="fc" id="L412">		cal.set(Calendar.MINUTE, 0);</span>
<span class="fc" id="L413">		cal.set(Calendar.SECOND, 0);</span>
<span class="fc" id="L414">		cal.set(Calendar.MILLISECOND, 0);</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">		while (cal.get(Calendar.DAY_OF_WEEK) != weekStartDay) {</span>
<span class="fc" id="L416">			cal.add(Calendar.DATE, -1);</span>
		}
<span class="fc" id="L418">		date = cal.getTime();</span>
<span class="fc" id="L419">		return date;</span>
	}

	private Date getDateForMonthStart(Date date, int monthStartDay) {
<span class="nc" id="L423">		Calendar cal = Calendar.getInstance(m_campaign.getTimeZone(), m_locale);</span>
<span class="nc" id="L424">		cal.setTime(date);</span>
<span class="nc" id="L425">		cal.set(Calendar.DAY_OF_MONTH, monthStartDay);</span>
<span class="nc" id="L426">		cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L427">		cal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L428">		cal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L429">		cal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L430">		date = cal.getTime();</span>
<span class="nc" id="L431">		return date;</span>
	}

	/**
	 * @return getWeekStart is returned as minute offset from 12AM Sunday
	 */
	public int getWeekStart() {
<span class="fc" id="L438">		return m_campaign.getWeekStart();</span>
	}

	/**
	 * Get the day of week ordinal (1..7) for the given weekOffset minutes.
	 * @param weekStart - the week start offset minutes
	 * @return the day of week ordinal corresponding to the offset.
	 */
	public int getWeekStartDay() {
<span class="nc" id="L447">		return SchedulingPeriodUtil.getWeekStartDay(getWeekStart());</span>
	}

	boolean isEnableElements() {
<span class="nc" id="L451">		return m_isAddMode;</span>
	}

	/**
	 * Return an integer representing the month of the year that was chosen for this Monthly SP.
	 */
	public int getMonth() {
<span class="nc" id="L458">		return m_month;</span>
	}

	/**
	 * Set an integer representing the month of the year for this Monthly SP.
	 */
	public void setMonth(int month) {
<span class="nc" id="L465">		m_month = month;</span>
<span class="nc" id="L466">	}</span>

	/**
	 * Return an integer representing the Year that was chosen for this Monthly SP.
	 */
	public int getYear() {
<span class="nc" id="L472">		return m_year;</span>
	}

	/**
	 * Set an integer representing the Year for this Monthly SP.
	 */
	public void setYear(int year) {
<span class="nc" id="L479">		m_year = year;</span>
<span class="nc" id="L480">	}</span>

	/**
	 * Get a drop down selector containing the months of the year in edit mode, or a static month name string in read-only
	 * mode.
	 * @param onChangeJS
	 */
	public String getMonthElement(String onChangeJS) {
<span class="nc" id="L488">		Calendar cal = Calendar.getInstance(m_campaign.getTimeZone(), m_locale);</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">		int selectedMonth = m_month == -1 ? cal.get(Calendar.MONTH) : m_month;</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">		if (isEnableElements()) {</span>
<span class="nc" id="L491">			return SchedulingPeriodUtil.getMonthDropDown(CAMP_MONTH_FN, selectedMonth, onChangeJS, m_localizer);</span>
		} else {
<span class="nc" id="L493">			return m_localizer.getMonthNames(true)[selectedMonth]</span>
<span class="nc" id="L494">					+ HtmlUtil.makeHiddenInput(CAMP_MONTH_FN, Integer.toString(selectedMonth));</span>
		}
	}

	/**
	 * Get a drop down selector containing the years, or a static year value string in read-only mode.
	 * @param onChangeJS
	 */
	public String getYearElement(String onChangeJS) {
<span class="nc" id="L503">		Calendar cal = Calendar.getInstance(m_campaign.getTimeZone(), m_locale);</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">		int selectedYear = m_year == -1 ? cal.get(Calendar.YEAR) : m_year;</span>

<span class="nc bnc" id="L506" title="All 2 branches missed.">		if (isEnableElements()) {</span>
<span class="nc" id="L507">			return SchedulingPeriodUtil.getYearDropDown(CAMP_YEAR_FN, selectedYear, onChangeJS, m_localizer);</span>
		} else {
<span class="nc" id="L509">			return Integer.toString(selectedYear) + HtmlUtil.makeHiddenInput(CAMP_YEAR_FN, Integer.toString(selectedYear));</span>
		}
	}

	private int[] getDisabledDays(int theOnlyEnabledDay) {
<span class="fc" id="L514">		int[] disabledDays = new int[6];</span>
<span class="fc" id="L515">		int index = 0;</span>
<span class="fc bfc" id="L516" title="All 2 branches covered.">		if (theOnlyEnabledDay != Hoo.MONDAY)</span>
<span class="fc" id="L517">			disabledDays[index++] = Calendar.MONDAY;</span>
<span class="fc bfc" id="L518" title="All 2 branches covered.">		if (theOnlyEnabledDay != Hoo.TUESDAY)</span>
<span class="fc" id="L519">			disabledDays[index++] = Calendar.TUESDAY;</span>
<span class="pc bpc" id="L520" title="1 of 2 branches missed.">		if (theOnlyEnabledDay != Hoo.WEDNESDAY)</span>
<span class="fc" id="L521">			disabledDays[index++] = Calendar.WEDNESDAY;</span>
<span class="pc bpc" id="L522" title="1 of 2 branches missed.">		if (theOnlyEnabledDay != Hoo.THURSDAY)</span>
<span class="fc" id="L523">			disabledDays[index++] = Calendar.THURSDAY;</span>
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">		if (theOnlyEnabledDay != Hoo.FRIDAY)</span>
<span class="fc" id="L525">			disabledDays[index++] = Calendar.FRIDAY;</span>
<span class="pc bpc" id="L526" title="1 of 2 branches missed.">		if (theOnlyEnabledDay != Hoo.SATURDAY)</span>
<span class="fc" id="L527">			disabledDays[index++] = Calendar.SATURDAY;</span>
<span class="fc bfc" id="L528" title="All 2 branches covered.">		if (theOnlyEnabledDay != Hoo.SUNDAY)</span>
<span class="fc" id="L529">			disabledDays[index++] = Calendar.SUNDAY;</span>
<span class="fc" id="L530">		return disabledDays;</span>
	}

	protected void loadData() throws Exception {
<span class="fc bfc" id="L534" title="All 2 branches covered.">		if (!m_isLoaded) {</span>
<span class="fc bfc" id="L535" title="All 2 branches covered.">			if (isSPSelected()) {</span>
<span class="fc" id="L536">				Collection&lt;ID&gt; spIDs = getSelectedSchedulingPeriodIDs();</span>
<span class="fc" id="L537">				CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L538">				SchedulingPeriod sp = camManager.getSchedulingPeriodByID(spIDs.iterator().next());</span>
<span class="fc" id="L539">				ID campID = sp.getCampaignID();</span>
<span class="fc" id="L540">				m_campaign = camManager.getCampaignByID(campID);</span>
<span class="fc" id="L541">				m_SP.setCampaignID(campID);</span>
<span class="fc bfc" id="L542" title="All 2 branches covered.">			} else if (isCampaignSelected()) {</span>
<span class="fc" id="L543">				Collection&lt;ID&gt; campIDs = getSelectedCampaignIDs();</span>
<span class="fc" id="L544">				CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L545">				ID campID = campIDs.iterator().next();</span>
<span class="fc" id="L546">				m_campaign = camManager.getCampaignByID(campID);</span>
<span class="fc" id="L547">				m_SP.setCampaignID(campID);</span>
			}
<span class="fc" id="L549">			m_isLoaded = true;</span>
		}
<span class="fc" id="L551">	}</span>

	public String getFormTitle() {
<span class="pc bpc" id="L554" title="1 of 4 branches missed.">		if (!hasSelectedID() &amp;&amp; !m_isAddMode) {</span>
<span class="nc" id="L555">			return &quot;&quot;;</span>
		} else {
<span class="fc" id="L557">			return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_CREATE_SP);</span>
		}
	}

	public boolean isCampaignSelected() {
<span class="fc bfc" id="L562" title="All 2 branches covered.">		return getSelectedCampaignIDs().size() &gt; 0;</span>
	}

	public boolean isSPSelected() {
<span class="fc bfc" id="L566" title="All 2 branches covered.">		return getSelectedSchedulingPeriodIDs().size() &gt; 0;</span>
	}

	/**
	 * Return the DropDown display of supported Time Zones with the current selected Time Zone choosen
	 */
	public String getTimezoneDropDown(String onChangeJS) {
<span class="nc" id="L573">		String timezoneID = getTimezoneID();</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">		String selectedTimezoneID = (timezoneID != null) ? timezoneID : &quot;&quot;;</span>

<span class="nc bnc" id="L576" title="All 2 branches missed.">		if (m_isAddMode) {</span>
<span class="nc" id="L577">			return HtmlUtil.getTimeZoneDropDown(CAMP_TIMEZONE_ID_FN, selectedTimezoneID, onChangeJS, m_localizer);</span>
		} else {
<span class="nc" id="L579">			return m_localizer.formatTimeZone(selectedTimezoneID)</span>
<span class="nc" id="L580">					+ HtmlUtil.makeHiddenInput(CAMP_TIMEZONE_ID_FN, selectedTimezoneID);</span>
		}
	}

	public String getDaysOfWeekDropDown(String onChangeJS) {
<span class="nc" id="L585">		int selectedDay = 1;</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">		if (m_isAddMode) {</span>
<span class="nc" id="L587">			return HtmlUtil.getDayOfWeekDropDown(CAMP_WEEK_START_DAY_FN, selectedDay, onChangeJS, false, m_localizer);</span>
		} else {
<span class="nc" id="L589">			return m_localizer.getWeekdayNames(true)[selectedDay]</span>
<span class="nc" id="L590">					+ HtmlUtil.makeHiddenInput(CAMP_WEEK_START_DAY_FN, Integer.toString(selectedDay));</span>
		}
	}

	/**
	 * Return the Organization Time Zone ID
	 */
	public String getTimezoneID() {
<span class="nc" id="L598">		TimeZone timezone = TimeZone.getDefault();</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">		return (timezone != null) ? timezone.getID() : &quot;&quot;;</span>
	}

	/**
	 * Return the TimeZone from the timezoneId
	 */
	public TimeZone getTimeZone() {
<span class="nc" id="L606">		return TimeZone.getTimeZone(getTimezoneID());</span>
	}

	/**
	 * Return the localized Timezone label
	 */
	public String getTimezoneLabel() {
<span class="fc" id="L613">		return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_TIMEZONE);</span>
	}

	/**
	 * Return the localized Week Start Day label
	 */
	public String getWeekStartDayLabel() {
<span class="nc" id="L620">		return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_WEEK_START_DAY);</span>
	}

	public String getCampaignNameLabel() {
<span class="fc" id="L624">		return i18n(m_bundle, FsWebBundleKey.FS_CAMPAIGN);</span>
	}

	public String getNumberOfWeeksLabel() {
<span class="fc" id="L628">		return i18n(m_bundle, FsWebBundleKey.SCHEDULINGPERIOD_NUMBEROFWEEKS);</span>
	}

	public String getSPStartDateLabel() {
<span class="fc" id="L632">		return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_START_DATE);</span>
	}

	/**
	 * Return the localized Day Boundary Offset label
	 */
	public String getDayBoundaryOffsetLabel() {
<span class="fc" id="L639">		return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_DAY_BOUNDARY_OFFSET);</span>
	}

	public String getDescriptionLabel() {
<span class="nc" id="L643">		return i18n(m_bundle, FsWebBundleKey.SCHEDULINGPERIOD_DESC);</span>
	}

	public String getMonthLabel() {
<span class="nc" id="L647">		return i18n(m_bundle, FsWebBundleKey.MONTH);</span>
	}

	// Getters and Setters

	// Overriding this so that cached IDs are set properly
	public void setSelectedID(String ids) {
<span class="fc" id="L654">		super.setSelectedID(ids);</span>
<span class="fc" id="L655">		setSelectedCampaignIDs(CampaignSchedulingPeriodSelectionUtil.extractIDs(getSelectedID(),</span>
				CampaignSchedulingPeriodSelectionUtil.CAMPAIGN_ID_PREFIX));
<span class="fc" id="L657">		setSelectedSchedulingPeriodIDs(CampaignSchedulingPeriodSelectionUtil.extractIDs(getSelectedID(),</span>
				CampaignSchedulingPeriodSelectionUtil.SP_ID_PREFIX));
<span class="fc" id="L659">	}</span>

	public Collection&lt;ID&gt; getSelectedCampaignIDs() {
<span class="fc" id="L662">		return StringUtil.parseIDStringToCollection(m_selectedCampaignIDs);</span>
	}

	public void setSelectedCampaignIDs(String selectedCampaignIDs) {
<span class="fc" id="L666">		m_selectedCampaignIDs = selectedCampaignIDs;</span>
<span class="fc" id="L667">	}</span>

	public Collection&lt;ID&gt; getSelectedSchedulingPeriodIDs() {
<span class="fc" id="L670">		return StringUtil.parseIDStringToCollection(m_selectedSchedulingPeriodIDs);</span>
	}

	public void setSelectedSchedulingPeriodIDs(String selectedSchedulingPeriodIDs) {
<span class="fc" id="L674">		m_selectedSchedulingPeriodIDs = selectedSchedulingPeriodIDs;</span>
<span class="fc" id="L675">	}</span>

	/**
	 * Return Day Boundary Offset Time UI
	 */
	public String getDayBoundaryOffsetTimeUI(String onChange) {
<span class="nc" id="L681">		int weekstart = getWeekStart();</span>
<span class="nc" id="L682">		int offset = weekstart % (1440);</span>
<span class="nc" id="L683">		m_timePickerPC.setTime(offset * 60); // seconds</span>
<span class="nc" id="L684">		m_timePickerPC.setOnChangeJS(onChange);</span>
<span class="nc" id="L685">		m_timePickerPC.setIsControlEnabled(m_isAddMode);</span>
<span class="nc" id="L686">		return m_timePickerPC.getHtmlDisplay();</span>
	}

	/**
	 * Get the HTML row of radio button options for Initialization Options. The options are: - Create as empty - Copy data
	 * from previous week(s) (not supported for Monthly campaigns) - Copy data from select period (not supported for Monthly
	 * campaigns) - Customize week selection
	 */
	private String getInitOpts(String fieldName, int weekNumber, Date curDate) {
<span class="fc" id="L695">		ArrayList&lt;StringsPair&gt; colWPs = null;</span>
<span class="fc" id="L696">		String strID = null;</span>

<span class="fc" id="L698">		boolean isPreviousWeeksEnabled = false;</span>
<span class="fc" id="L699">		boolean isSelectPeriodEnabled = false;</span>
		try {
<span class="fc" id="L701">			ArrayList&lt;SchedulingPeriod&gt; sps =</span>
<span class="fc" id="L702">					(ArrayList&lt;SchedulingPeriod&gt;) CampaignModelHandler.getSchedulingPeriods(m_context, m_campaign.getID(),</span>
							null, null);

<span class="fc" id="L705">			isCreateable = isDateandWeekNumberLegit(sps);</span>
<span class="fc bfc" id="L706" title="All 4 branches covered.">			isClonable = sps.size() &gt; 0 &amp;&amp; isCreateable;</span>
<span class="fc" id="L707">			isPreviousWeeksEnabled = isPreviousWeeksLegit(m_campaign);</span>
<span class="fc" id="L708">			isSelectPeriodEnabled = isSelectPeriodLegit(m_campaign);</span>
<span class="fc" id="L709">			colWPs = new ArrayList&lt;StringsPair&gt;(sps.size());</span>
<span class="fc" id="L710">			int count = 0;</span>
<span class="fc bfc" id="L711" title="All 2 branches covered.">			for (int i = sps.size() - 1; i &gt;= 0; i--) {</span>
<span class="fc" id="L712">				SchedulingPeriod sp = sps.get(i);</span>
<span class="fc bfc" id="L713" title="All 2 branches covered.">				if (getSPWeeks(sp) == numberofWeeks) {</span>
<span class="fc" id="L714">					colWPs.add(new StringsPair(sp.getID().toString(), getSPNameInRegionalFormat(sp)));</span>
<span class="fc" id="L715">					count++;</span>
				}
			}

<span class="fc bfc" id="L719" title="All 2 branches covered.">			if (count &gt; 0)</span>
<span class="fc" id="L720">				strID = colWPs.get(0).getKey();</span>
<span class="nc" id="L721">		} catch (BbmException e) {</span>
<span class="nc" id="L722">			handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L723">		} catch (Exception e) {</span>
<span class="nc" id="L724">			handleUnableToLoadDataError(log, e);</span>
<span class="pc" id="L725">		}</span>

<span class="fc" id="L727">		StringBuilder copyEmployeeDataEnableJS = getCopyEmployeeDataEnableJS();</span>
<span class="fc" id="L728">		StringBuilder selectedPeriodJS = new StringBuilder();</span>

<span class="fc" id="L730">		HtmlTable table = new HtmlTable(&quot;0&quot;, &quot;0&quot;, &quot;0&quot;);</span>
<span class="fc" id="L731">		HtmlTableRow row = new HtmlTableRow();</span>
<span class="fc" id="L732">		row.setAttribute(&quot;nowrap&quot;);</span>
<span class="fc" id="L733">		HtmlTableCell cell = new HtmlTableCell();</span>
<span class="fc" id="L734">		cell.setAttribute(&quot;nowrap&quot;);</span>
<span class="fc" id="L735">		cell.setAttribute(&quot;class&quot;, &quot;fTPCell&quot;);</span>
<span class="fc" id="L736">		TableRowCell trc = new TableRowCell(table, row, cell);</span>

		// Row 1 - Create as empty
<span class="fc" id="L739">		addRow1ToTable(fieldName, trc, selectedPeriodJS);</span>

<span class="pc bpc" id="L741" title="1 of 2 branches missed.">		if (isWeeklyCampaign()) {</span>
			// Row 2 - Copy data from previous week(s)
<span class="fc" id="L743">			addRow2ToTable(fieldName, trc, isPreviousWeeksEnabled, selectedPeriodJS, copyEmployeeDataEnableJS);</span>

			// Row 3 - Copy data from select period
<span class="fc" id="L746">			addRow3ToTable(fieldName, trc, colWPs, strID, isSelectPeriodEnabled, copyEmployeeDataEnableJS);</span>
		}

		// Row 4 - Customize week selection
<span class="fc" id="L750">		addRow4ToTable(fieldName, trc, selectedPeriodJS, copyEmployeeDataEnableJS);</span>

		//add the &quot;Copy employee Min/Max hours, skill, and work pattern assignments&quot; checkbox
<span class="fc" id="L753">		addCopyEmployeeDataRowToTable(trc, isPreviousWeeksEnabled, isSelectPeriodEnabled);</span>

		//add the &quot;Copy Project Queue Requirements and Outbound Call Lists to partial weeks&quot; checkbox for Monthly SP's
<span class="fc" id="L756">		addCopyProjectDataRowToTable(trc);</span>

<span class="fc" id="L758">		return table.toString();</span>
	}
	
	/**
	 * A simple container class to hold an HTML table, row, and cell.
	 */
	class TableRowCell {
		HtmlTable table;
		HtmlTableRow row;
		HtmlTableCell cell;

<span class="fc" id="L769">		public TableRowCell(HtmlTable t, HtmlTableRow r, HtmlTableCell c) {</span>
<span class="fc" id="L770">			table = t;</span>
<span class="fc" id="L771">			row = r;</span>
<span class="fc" id="L772">			cell = c;</span>
<span class="fc" id="L773">		}</span>
	}

	/**
	 * Row 1 - Create as empty
	 * @param fieldName
	 * @param labelEmpty
	 * @param table
	 * @param row
	 * @param cell
	 * @param copyEmployeeDataDisableJS
	 * @param copyProjectDataDisableJS
	 */
	protected void addRow1ToTable(String fieldName, TableRowCell trc, StringBuilder selectedPeriodJS) {
<span class="fc" id="L787">		String labelEmpty = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_EMPTY);</span>
<span class="fc" id="L788">		StringBuilder copyEmployeeDataDisableJS = getCopyEmployeeDataDisableJS();</span>
<span class="fc" id="L789">		StringBuilder copyProjectDataDisableJS = getCopyProjectDataDisableJS();</span>

<span class="fc" id="L791">		selectedPeriodJS.append(&quot;dd_disable('&quot;).append(fieldName + CAMP_SP_CREATE_PREV_PERIOD).append(&quot;', 0, true);\n&quot;);</span>

<span class="pc bpc" id="L793" title="1 of 4 branches missed.">		trc.cell.setInnerHtml(HtmlChoiceInput.makeRadioInput(fieldName, CREATE_EMPTY, labelEmpty, selection == 0 ? true : false,</span>
<span class="fc" id="L794">				!isCreateable, selectedPeriodJS.toString() + copyEmployeeDataDisableJS.toString() + </span>
<span class="fc" id="L795">					copyProjectDataDisableJS.toString()));</span>
<span class="fc" id="L796">		trc.row.add(trc.cell.toString());</span>
<span class="fc" id="L797">		trc.table.add(trc.row.toString());</span>
<span class="fc" id="L798">		trc.row.clear();</span>
<span class="fc" id="L799">	}</span>

	/**
	 * @return Javascript to disable checkbox for copying Project &amp; Outbound Call List data
	 */
	protected StringBuilder getCopyProjectDataDisableJS() {
<span class="fc" id="L805">		StringBuilder copyProjectDataDisableJS = new StringBuilder();</span>
<span class="pc bpc" id="L806" title="1 of 2 branches missed.">		if (isMonthlyCampaign()) {</span>
			// disable checkbox for copying Project data (used when &quot;Create as Empty&quot; radio button is clicked)
<span class="nc" id="L808">			copyProjectDataDisableJS.append(&quot;jQuery('#&quot;).append(projectCheckboxPC.getInputID()).</span>
<span class="nc" id="L809">					append(&quot;').prop('disabled', true);\n&quot;);</span>
		}
<span class="fc" id="L811">		return copyProjectDataDisableJS;</span>
	}

	/**
	 * @return Javascript to enable checkbox for copying Project &amp; Outbound Call List data
	 */
	protected StringBuilder getCopyProjectDataEnableJS() {
<span class="fc" id="L818">		StringBuilder copyProjectDataEnableJS = new StringBuilder();</span>
<span class="pc bpc" id="L819" title="1 of 2 branches missed.">		if (isMonthlyCampaign()) {</span>
			//enable JS
<span class="nc" id="L821">			copyProjectDataEnableJS.append(&quot;var var2;\n&quot;);</span>
<span class="nc" id="L822">			copyProjectDataEnableJS.append(&quot;var2 = jQuery('#&quot;).append(projectCheckboxPC.getInputID()).append(&quot;')[0];\n&quot;);</span>
<span class="nc" id="L823">			copyProjectDataEnableJS.append(&quot;var2.disabled = false;\n&quot;);</span>
		}
<span class="fc" id="L825">		return copyProjectDataEnableJS;</span>
	}

	/**
	 * @return Javascript to disable checkbox for copying employee data (used when &quot;Create as Empty&quot; radio button is clicked)
	 */
	protected StringBuilder getCopyEmployeeDataDisableJS() {
<span class="fc" id="L832">		StringBuilder copyEmployeeDataDisableJS = new StringBuilder();</span>
<span class="pc bpc" id="L833" title="1 of 2 branches missed.">		if (isMonthlyCampaign()) {</span>
<span class="nc" id="L834">			copyEmployeeDataDisableJS.append(&quot;jQuery('#&quot;).append(employeeCheckboxPC.getInputID()).</span>
<span class="nc" id="L835">					append(&quot;').prop('disabled', true);\n&quot;);</span>
		}
<span class="fc" id="L837">		return copyEmployeeDataDisableJS;</span>
	}

	/**
	 * @return Javascript to enable checkbox for copying employee data
	 */
	protected StringBuilder getCopyEmployeeDataEnableJS() {
<span class="fc" id="L844">		StringBuilder copyEmployeeDataEnableJS = new StringBuilder();</span>
<span class="fc" id="L845">		copyEmployeeDataEnableJS.append(&quot;var var1;\n&quot;);</span>
<span class="fc" id="L846">		copyEmployeeDataEnableJS.append(&quot;var1 = jQuery('#&quot;).append(employeeCheckboxPC.getInputID()).append(&quot;')[0];\n&quot;);</span>
<span class="fc" id="L847">		copyEmployeeDataEnableJS.append(&quot;var1.disabled = false;\n&quot;);</span>
<span class="fc" id="L848">		return copyEmployeeDataEnableJS;</span>
	}

	/**
	 * @param table
	 * @param row
	 * @param cell
	 */
	protected void addCopyProjectDataRowToTable(TableRowCell trc) {
<span class="pc bpc" id="L857" title="1 of 2 branches missed.">		if (isMonthlyCampaign()) {</span>
<span class="nc" id="L858">			trc.row.clear();</span>
<span class="nc bnc" id="L859" title="All 4 branches missed.">			boolean isEnabled = selection == 3 &amp;&amp; isClonable;</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">			projectCheckboxPC.setIsDisabled(!isEnabled);</span>
<span class="nc" id="L861">			trc.cell.setInnerHtml(projectCheckboxPC.getHtmlDisplay());</span>
<span class="nc" id="L862">			trc.row.add(trc.cell.toString());</span>
<span class="nc" id="L863">			trc.table.add(trc.row.toString());</span>
		}
<span class="fc" id="L865">	}</span>

	/**
	 * @param table
	 * @param row
	 * @param cell
	 * @param isPreviousWeeksEnabled
	 * @param isSelectPeriodEnabled
	 */
	protected void addCopyEmployeeDataRowToTable(TableRowCell trc, boolean isPreviousWeeksEnabled, 
			boolean isSelectPeriodEnabled) {
<span class="pc bpc" id="L876" title="13 of 16 branches missed.">		boolean isEnabled =</span>
				(selection == 1 &amp;&amp; isClonable &amp;&amp; isPreviousWeeksEnabled)
						|| (selection == 2 &amp;&amp; isClonable &amp;&amp; isSelectPeriodEnabled) || (selection == 3 &amp;&amp; isClonable);

<span class="pc bpc" id="L880" title="1 of 2 branches missed.">		employeeCheckboxPC.setIsDisabled(!isEnabled);</span>
<span class="fc" id="L881">		trc.cell.setInnerHtml(employeeCheckboxPC.getHtmlDisplay());</span>
<span class="fc" id="L882">		trc.row.add(trc.cell.toString());</span>
<span class="fc" id="L883">		trc.table.add(trc.row.toString());</span>
<span class="fc" id="L884">	}</span>

	/**
	 * Row 4 - Customize week selection
	 * @param fieldName
	 * @param labelCustomize
	 * @param table
	 * @param row
	 * @param cell
	 * @param selectedPeriodJS
	 * @param copyEmployeeDataEnableJS
	 * @param copyProjectDataEnableJS
	 */
	protected void addRow4ToTable(String fieldName, TableRowCell trc, StringBuilder selectedPeriodJS, 
			StringBuilder copyEmployeeDataEnableJS) {
<span class="fc" id="L899">		String labelCustomize = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_CUSTOMIZED);</span>
<span class="fc" id="L900">		StringBuilder editIconHtml = new StringBuilder();</span>

<span class="fc bfc" id="L902" title="All 2 branches covered.">		if (isClonable) {</span>
<span class="fc" id="L903">			editIconHtml</span>
<span class="fc" id="L904">					.append(HtmlUtil.imageTag(ImageFileID.EDIT, ImageFileID.EDIT_WIDTH, ImageFileID.EDIT_HEIGHT,</span>
<span class="fc" id="L905">							m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.EDIT), false))</span>
<span class="fc" id="L906">					.append(&quot; onClick=\&quot;&quot;)</span>
<span class="fc" id="L907">					.append(&quot;var var1;\n var1 = DOM2.getElementById('&quot;)</span>
<span class="fc" id="L908">					.append(fieldName)</span>
<span class="fc" id="L909">					.append(&quot;_&quot;)</span>
<span class="fc" id="L910">					.append(CREATE_CUSTOMIZE)</span>
<span class="fc" id="L911">					.append(&quot;_0&quot;)</span>
<span class="fc" id="L912">					.append(&quot;')\n;&quot;)</span>
<span class="fc" id="L913">					.append(&quot;var1.click();&quot;)</span>
<span class="fc" id="L914">					.append(&quot;this.&quot; + CustomizeWeeksPopupPM.WEEK_NUMBERS)</span>
<span class="fc" id="L915">					.append(&quot;=&quot;)</span>
<span class="fc" id="L916">					.append(&quot;pageMediator.getValue('&quot; + CAMP_NUMBEROFWEEKS_FN + &quot;');&quot;)</span>
<span class="fc" id="L917">					.append(&quot;this.&quot; + CustomizeWeeksPopupPM.START_DATE)</span>
<span class="fc" id="L918">					.append(&quot;=&quot;)</span>
<span class="fc" id="L919">					.append(&quot;pageMediator.getValue('&quot; + CAMP_SP_START_DATE_FN + &quot;');&quot;)</span>
<span class="fc" id="L920">					.append(&quot;this.&quot; + CustomizeWeeksPopupPM.CAMPAIGN_ID)</span>
<span class="fc" id="L921">					.append(&quot;=&quot;)</span>
<span class="fc" id="L922">					.append(&quot;pageMediator.getValue('&quot; + CAMPAIGN_ID + &quot;');&quot;)</span>

<span class="fc" id="L924">					.append(&quot;bindCustomWeekFields('&quot; + CustomizeWeeksPopupPM.WEEK_NUMBERS + &quot;','&quot; + CAMP_NUMBEROFWEEKS_FN</span>
							+ &quot;','&quot; + CustomizeWeeksPopupPM.START_DATE + &quot;','&quot; + CAMP_SP_START_DATE_FN + &quot;','&quot;
							+ CustomizeWeeksPopupPM.CAMPAIGN_ID + &quot;','&quot; + CAMPAIGN_ID + &quot;');&quot;)

<span class="fc" id="L928">					.append(m_toolbar.getName()).append(&quot;.onSelect('&quot;).append(CustomizeWeeksPopupPM.POPUP_ID)</span>
<span class="fc" id="L929">					.append(&quot;',this);\&quot; &quot;).append(&quot;actionType=\&quot;POPUP_WINDOW_TYPE\&quot;&quot;).append(&quot;&gt;&quot;);</span>
		} else {
<span class="fc" id="L931">			editIconHtml.append(HtmlUtil.imageTag(ImageFileID.EDIT, ImageFileID.EDIT_WIDTH, ImageFileID.EDIT_HEIGHT,</span>
<span class="fc" id="L932">					m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.EDIT), true));</span>
		}

<span class="fc" id="L935">		StringBuilder copyProjectDataEnableJS = getCopyProjectDataEnableJS();</span>
<span class="pc bpc" id="L936" title="1 of 4 branches missed.">		trc.cell.setInnerHtml(HtmlChoiceInput.makeRadioInput(fieldName, CREATE_CUSTOMIZE, labelCustomize, selection == 3 ? true</span>
<span class="fc" id="L937">				: false, !isClonable, selectedPeriodJS.toString() + copyEmployeeDataEnableJS.toString() </span>
<span class="fc" id="L938">						+ copyProjectDataEnableJS.toString())</span>
<span class="fc" id="L939">								+ editIconHtml.toString());</span>
<span class="fc" id="L940">		trc.row.add(trc.cell.toString());</span>
<span class="fc" id="L941">		trc.table.add(trc.row.toString());</span>
<span class="fc" id="L942">		trc.row.clear();</span>
<span class="fc" id="L943">	}</span>

	/**
	 * Row 3 - Copy data from select period
	 * @param fieldName
	 * @param labelSelected
	 * @param table
	 * @param row
	 * @param cell
	 * @param colWPs
	 * @param strID
	 * @param isSelectPeriodEnabled
	 * @param copyEmployeeDataEnableJS
	 */
	protected void addRow3ToTable(String fieldName, TableRowCell trc, List&lt;StringsPair&gt; colWPs, 
			String strID, boolean isSelectPeriodEnabled, StringBuilder copyEmployeeDataEnableJS) {
<span class="fc" id="L959">		String labelSelected = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_SELECTED);</span>
<span class="fc" id="L960">		String[] defaultVal = new String[] { strID };</span>
<span class="fc" id="L961">		StringBuilder selectedPeriodJSCheck = new StringBuilder();</span>
<span class="fc" id="L962">		selectedPeriodJSCheck.append(&quot;dd_disable('&quot;).append(fieldName + CAMP_SP_CREATE_PREV_PERIOD)</span>
<span class="fc" id="L963">				.append(&quot;', 0, false);&quot;);</span>

<span class="pc bpc" id="L965" title="1 of 6 branches missed.">		trc.cell.setInnerHtml(HtmlChoiceInput.makeRadioInput(fieldName, CREATE_FROM_SELECTED, labelSelected, selection == 2</span>
<span class="fc" id="L966">				? true : false, !isClonable || !isSelectPeriodEnabled, selectedPeriodJSCheck.toString()</span>
<span class="fc" id="L967">				+ copyEmployeeDataEnableJS.toString())</span>
				+ HtmlUtil.NBSP
<span class="fc" id="L969">				+ HtmlUtil.makeSelectInput(fieldName + CAMP_SP_CREATE_PREV_PERIOD, defaultVal, null, colWPs, false,</span>
						false));
<span class="fc" id="L971">		trc.row.add(trc.cell.toString());</span>
<span class="fc" id="L972">		trc.table.add(trc.row.toString());</span>
<span class="fc" id="L973">		trc.row.clear();</span>
<span class="fc" id="L974">	}</span>

	/**
	 * Row 2 - Copy data from previous week(s).
	 * check if previous week is enabled
	 * @param fieldName
	 * @param labelPrevWeek
	 * @param table
	 * @param row
	 * @param cell
	 * @param isPreviousWeeksEnabled
	 * @param selectedPeriodJS
	 * @param copyEmployeeDataEnableJS
	 */
	protected void addRow2ToTable(String fieldName, TableRowCell trc, boolean isPreviousWeeksEnabled, 
			StringBuilder selectedPeriodJS, StringBuilder copyEmployeeDataEnableJS) {
<span class="fc" id="L990">		String labelPrevWeek = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_PREV_WEEK);</span>
<span class="pc bpc" id="L991" title="1 of 6 branches missed.">		trc.cell.setInnerHtml(HtmlChoiceInput.makeRadioInput(fieldName, CREATE_USEPREVIOUS, labelPrevWeek, selection == 1</span>
<span class="fc" id="L992">				? true : false, !isClonable || !isPreviousWeeksEnabled, selectedPeriodJS.toString()</span>
<span class="fc" id="L993">				+ copyEmployeeDataEnableJS.toString()));</span>
<span class="fc" id="L994">		trc.row.add(trc.cell.toString());</span>
<span class="fc" id="L995">		trc.table.add(trc.row.toString());</span>
<span class="fc" id="L996">		trc.row.clear();</span>
<span class="fc" id="L997">	}</span>

	public SchedulingPeriod getSchedulingPeriod() {
<span class="fc" id="L1000">		return m_SP;</span>
	}

	private int getSPWeeks(SchedulingPeriod sp) {
<span class="fc" id="L1004">		Date spStartDate = sp.getStartTime();</span>
<span class="fc" id="L1005">		Date spEndDate = sp.getEndTime();</span>
<span class="fc" id="L1006">		int ret = (int) ((spEndDate.getTime() - spStartDate.getTime() + 24 * 60 * 60 * 1000) / (24 * 60 * 60 * 1000 * 7));</span>
<span class="fc" id="L1007">		return ret;</span>
	}

	private boolean isDateandWeekNumberLegit(Collection&lt;SchedulingPeriod&gt; sps) {
<span class="fc" id="L1011">		boolean ret = true;</span>
<span class="fc" id="L1012">		LocalDate spStartLocal = m_SP.getStartTimeLocal();</span>
<span class="fc" id="L1013">		LocalDate spEndLocal = m_SP.getEndTimeLocal();</span>

<span class="fc" id="L1015">		Date spStart = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(spStartLocal, m_campaign.getTimeZone());</span>
<span class="fc" id="L1016">		Date spEnd = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(spEndLocal, m_campaign.getTimeZone());</span>

<span class="fc bfc" id="L1018" title="All 2 branches covered.">		for (SchedulingPeriod sp : sps) {</span>
<span class="fc" id="L1019">			Date start = sp.getStartTime();</span>
<span class="fc" id="L1020">			Date end = sp.getEndTime();</span>
<span class="fc bfc" id="L1021" title="All 4 branches covered.">			if ((spStart.getTime() &gt;= start.getTime() &amp;&amp; spStart.getTime() &lt; end.getTime())</span>
<span class="pc bpc" id="L1022" title="1 of 4 branches missed.">					|| (spEnd.getTime() &gt; start.getTime() &amp;&amp; spEnd.getTime() &lt;= end.getTime())) {</span>
<span class="fc" id="L1023">				ret = false;</span>
<span class="fc" id="L1024">				break;</span>
			}
<span class="fc" id="L1026">		}</span>
<span class="fc" id="L1027">		return ret;</span>
	}

	private boolean isPreviousWeeksLegit(Campaign campaign) {
<span class="fc" id="L1031">		boolean ret = false;</span>
<span class="fc" id="L1032">		LocalDate spStartLocal = m_SP.getStartTimeLocal();</span>
<span class="fc" id="L1033">		LocalDate spEndLocal = m_SP.getEndTimeLocal();</span>

<span class="fc" id="L1035">		int numberofweeks =</span>
<span class="fc" id="L1036">				((TimeZoneUtil.numberOfDays(spStartLocal.getTime(), spEndLocal.getTime(), campaign.getTimeZone()) + 1) / 7);</span>
<span class="fc" id="L1037">		spStartLocal.add(Calendar.DAY_OF_YEAR, -numberofweeks * 7);</span>
<span class="fc" id="L1038">		spEndLocal.add(Calendar.DAY_OF_YEAR, -numberofweeks * 7);</span>
<span class="fc" id="L1039">		Date spStart = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(spStartLocal, m_campaign.getTimeZone());</span>
<span class="fc" id="L1040">		Date spEnd = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(spEndLocal, m_campaign.getTimeZone());</span>
		try {
<span class="fc" id="L1042">			CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
			// This method seems to include all the sphoos form one SP,
			// regardless that hoo is within the time period.
<span class="fc" id="L1045">			Collection&lt;CampaignHOO&gt; hoos = camManager.getCampaignHOOAssignments(m_SP.getParentID(), spStart, spEnd, false);</span>
<span class="fc" id="L1046">			ArrayList&lt;CampaignHOO&gt; newhoos = new ArrayList&lt;CampaignHOO&gt;();</span>
<span class="fc bfc" id="L1047" title="All 2 branches covered.">			for (CampaignHOO campaignhoo : hoos) {</span>
<span class="fc" id="L1048">				Date end = campaignhoo.getEndTime();</span>
<span class="fc" id="L1049">				Date start = campaignhoo.getStartTime();</span>
<span class="pc bpc" id="L1050" title="2 of 4 branches missed.">				if (end.getTime() &lt;= spEnd.getTime() &amp;&amp; start.getTime() &gt;= spStart.getTime()) {</span>
<span class="fc" id="L1051">					newhoos.add(campaignhoo);</span>
				}
<span class="fc" id="L1053">			}</span>

<span class="fc bfc" id="L1055" title="All 2 branches covered.">			if (newhoos.size() == numberofweeks) {</span>
<span class="fc" id="L1056">				ret = true;</span>
			}
<span class="nc" id="L1058">		} catch (Exception e) {</span>
<span class="nc" id="L1059">			handleUnableToLoadDataError(log, e);</span>
<span class="fc" id="L1060">		}</span>
<span class="fc" id="L1061">		return ret;</span>
	}

	private boolean isSelectPeriodLegit(Campaign campaign) {
<span class="fc" id="L1065">		boolean ret = false;</span>
<span class="fc" id="L1066">		LocalDate spStartLocal = m_SP.getStartTimeLocal();</span>
<span class="fc" id="L1067">		LocalDate spEndLocal = m_SP.getEndTimeLocal();</span>
<span class="fc" id="L1068">		Date spStart = spStartLocal.getTime();</span>
<span class="fc" id="L1069">		Date spEnd = spEndLocal.getTime();</span>
<span class="fc" id="L1070">		int numberofweeks = ((TimeZoneUtil.numberOfDays(spStart, spEnd, campaign.getTimeZone()) + 1) / 7);</span>
		try {
<span class="fc" id="L1072">			CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L1073">			Collection&lt;Campaign&gt; campColls = new ArrayList&lt;Campaign&gt;();</span>
<span class="fc" id="L1074">			campColls.add(campaign);</span>
<span class="fc" id="L1075">			Collection&lt;SchedulingPeriod&gt; sps = camManager.getSchedulingPeriods(campColls);</span>
<span class="fc bfc" id="L1076" title="All 2 branches covered.">			for (SchedulingPeriod sp : sps) {</span>
<span class="fc" id="L1077">				int weeks = (TimeZoneUtil.numberOfDays(sp.getStartTime(), sp.getEndTime(), campaign.getTimeZone()) + 1) / 7;</span>
<span class="fc bfc" id="L1078" title="All 2 branches covered.">				if (weeks == numberofweeks) {</span>
<span class="fc" id="L1079">					ret = true;</span>
<span class="fc" id="L1080">					break;</span>
				}
<span class="fc" id="L1082">			}</span>
<span class="nc" id="L1083">		} catch (Exception e) {</span>
<span class="nc" id="L1084">			handleUnableToLoadDataError(log, e);</span>
<span class="fc" id="L1085">		}</span>
<span class="fc" id="L1086">		return ret;</span>
	}

	public String getRequiredHTML() {
<span class="fc" id="L1090">		return super.getRequiredHTML() + HtmlUtil.makeHiddenInput(SELECTED_HOO_ID, &quot;&quot;)</span>
<span class="fc" id="L1091">				+ HtmlUtil.makeHiddenInput(CAMPAIGN_ID, m_campaign.getID())</span>
<span class="fc" id="L1092">				+ HtmlUtil.makeHiddenInput(DAYBOUNDARY_IN_MUNITES, getWeekStart() % 1440);</span>
	}

	private String getSPNameInRegionalFormat(SchedulingPeriod sp) {
<span class="fc" id="L1096">		LocalDate endDate = new LocalDate(sp.getEndTimeLocal());</span>
<span class="fc" id="L1097">		endDate.add(Calendar.DATE, -1);</span>

<span class="fc" id="L1099">		return m_localizer.formatDate(sp.getStartTimeLocal(), RegionalFormatBundleKey.DATE_FORMAT) + &quot; - &quot;</span>
<span class="fc" id="L1100">				+ m_localizer.formatDate(endDate, RegionalFormatBundleKey.DATE_FORMAT);</span>
	}

	public boolean isWeeklyCampaign() {
<span class="pc bpc" id="L1104" title="1 of 2 branches missed.">		if (m_campaign == null) {</span>
<span class="nc" id="L1105">			return true;</span>
		}
<span class="fc" id="L1107">		return SchedulingPeriodUtil.isWeeklyCampaign(m_campaign);</span>
	}

	public boolean isMonthlyCampaign() {
<span class="pc bpc" id="L1111" title="1 of 2 branches missed.">		if (m_campaign == null) {</span>
<span class="nc" id="L1112">			return false;</span>
		}
<span class="fc" id="L1114">		return SchedulingPeriodUtil.isMonthlyCampaign(m_campaign);</span>
	}
	
	public void setCampaign(Campaign camp) {
<span class="nc" id="L1118">		m_campaign = camp;</span>
<span class="nc" id="L1119">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>