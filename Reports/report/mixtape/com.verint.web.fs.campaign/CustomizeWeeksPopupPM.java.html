<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CustomizeWeeksPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.campaign</a> &gt; <span class="el_source">CustomizeWeeksPopupPM.java</span></div><h1>CustomizeWeeksPopupPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.campaign;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOO;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.campaign.sp.SchedulingPeriodUtil;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.PopupWindowPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;

import javax.servlet.http.HttpServletRequest;
import java.rmi.RemoteException;
import java.text.SimpleDateFormat;
import java.util.*;

import static com.verint.web.fs.campaign.CampaignSPSettingsRequestHandler.getDaysOfWeekWithin;

@SuppressWarnings(&quot;serial&quot;)
public class CustomizeWeeksPopupPM extends PopupWindowPM {
	public static final String FORM_ACTION = &quot;campaign_customize_week_popup&quot;;
	public static final String POPUP_ID = &quot;POPUP_CUSTOMIZE_WEEKS&quot;;
	public static final String POPUP_ARGS = &quot;weekNumbers, startDate, campaingID&quot;;
	public static final String WEEK_NUMBERS = &quot;weekNumbers&quot;;
	public static final String START_DATE = &quot;startDate&quot;;
	public static final String CAMPAIGN_ID = &quot;campaignID&quot;;
	public static final String WEEKSELECTOR_FN = &quot;weekselector&quot;;
	public static final String EMPTY_LABEL = &quot;            &quot;;
	public static final String CUR_WEEK_NUMBERS = &quot;curWeekNumbers&quot;;

	private FormTwoColumnPC m_formInputPC;
	private int weekNumbers;
	private Date startDate;
	private ID campaignID;
	private Campaign campaign;

	public CustomizeWeeksPopupPM(RequestContext context) {
<span class="nc" id="L52">		super(context);</span>
		// TODO Auto-generated constructor stub
<span class="nc" id="L54">		m_formInputPC = new FormTwoColumnPC(context);</span>

<span class="nc" id="L56">		addChildComponent(m_formInputPC);</span>

<span class="nc" id="L58">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="nc" id="L59">	}</span>

	public static CustomizeWeeksPopupPM getInstance(RequestContext context) {
<span class="nc" id="L62">		return (CustomizeWeeksPopupPM) getInstance(context, CustomizeWeeksPopupPM.class);</span>
	}

	protected void initializeModel() {
<span class="nc bnc" id="L66" title="All 2 branches missed.">		if (m_isInitialized) {</span>
<span class="nc" id="L67">			return;</span>
		} else {
<span class="nc" id="L69">			m_isInitialized = true;</span>
		}
		try {
<span class="nc" id="L72">			initContentTitle();</span>
<span class="nc" id="L73">			initForm();</span>
<span class="nc" id="L74">			ToolbarTextButton addButton =</span>
<span class="nc" id="L75">					m_toolbar.createCloseWindowButton(&quot;customizeWeekSelection&quot;,</span>
<span class="nc" id="L76">							m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_SET), true);</span>
<span class="nc" id="L77">			addButton.setCustomJS(&quot;setSelectedIDs()&quot;);</span>
<span class="nc" id="L78">			m_toolbar.addToolbarElement(addButton);</span>
<span class="nc" id="L79">			m_toolbar.addCloseWindowTextButton(&quot;cancel&quot;,</span>
<span class="nc" id="L80">					m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_CANCEL), true);</span>
<span class="nc" id="L81">		} catch (Exception ex) {</span>
<span class="nc" id="L82">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L83">		}</span>
<span class="nc" id="L84">	}</span>

	protected void initUtilityPane() {
<span class="nc" id="L87">		getUtilityPane().setIsHelpEnabled(false);</span>
<span class="nc" id="L88">	}</span>

	protected void initContentTitle() {
<span class="nc" id="L91">		m_contentTitlePC.setPageTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
				FsWebBundleKey.CAMPAIGN_SP_CUSTOMIZE_WEEK_SELECTION));
<span class="nc" id="L93">	}</span>

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L97">		boolean result = super.extractParameters(request);</span>
<span class="nc" id="L98">		SimpleDateFormat sdf = m_context.getLocalizer().getDateInputFormatter(m_context.getViewingTimeZone());</span>
<span class="nc" id="L99">		String strWeekNumbers = request.getParameter(WEEK_NUMBERS);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">		if (strWeekNumbers != null) {</span>
<span class="nc" id="L101">			weekNumbers = Integer.parseInt(strWeekNumbers);</span>
		}
<span class="nc" id="L103">		String sdate = request.getParameter(START_DATE);</span>
<span class="nc bnc" id="L104" title="All 4 branches missed.">		if (sdate != null &amp;&amp; !sdate.isEmpty()) {</span>
			try {
<span class="nc" id="L106">				startDate = sdf.parse(sdate);</span>
<span class="nc" id="L107">			} catch (Exception e) {</span>
<span class="nc" id="L108">				handleExtractParamException(&quot;extractParameters&quot;, START_DATE, sdate, e);</span>
<span class="nc" id="L109">			}</span>
		}

<span class="nc" id="L112">		String strID = request.getParameter(CAMPAIGN_ID);</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">		if (!StringUtil.isEmptyOrWhiteSpace(strID)) {</span>
<span class="nc" id="L115">			campaignID = ID.fromInt(Integer.parseInt(strID));</span>
			try {
<span class="nc" id="L117">				CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L118">				campaign = camManager.getCampaignByID(campaignID);</span>
<span class="nc" id="L119">			} catch (Exception e) {</span>
<span class="nc" id="L120">				handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L121">			}</span>
		}

<span class="nc" id="L124">		return result;</span>
	}

	protected void initForm() throws BbmException, RemoteException {
<span class="nc" id="L128">		Calendar cal = Calendar.getInstance(campaign.getTimeZone(), m_locale);</span>
<span class="nc" id="L129">		cal.setTime(startDate);</span>
<span class="nc" id="L130">		cal.add(Calendar.YEAR, -10);</span>
<span class="nc" id="L131">		Date spstartDate = cal.getTime();</span>
<span class="nc" id="L132">		cal.add(Calendar.YEAR, 20);</span>
<span class="nc" id="L133">		Date spendDate = cal.getTime();</span>
		// end of workaround

<span class="nc" id="L136">		ArrayList&lt;CampaignHOO&gt; hoos = new ArrayList&lt;&gt;(CampaignModelHandler.getCampaignHOOAssignments(m_context, campaignID,</span>
			spstartDate, spendDate, false));

<span class="nc" id="L139">		ArrayList&lt;StringsPair&gt; colHOOStrings = new ArrayList&lt;StringsPair&gt;();</span>
<span class="nc" id="L140">		ArrayList&lt;Pair&lt;LocalDate, LocalDate&gt;&gt; colHOODates = new ArrayList&lt;Pair&lt;LocalDate, LocalDate&gt;&gt;();</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">		for (int i = hoos.size() - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L142">			CampaignHOO hoo = hoos.get(i);</span>
<span class="nc" id="L143">			LocalDate start = new LocalDate(hoo.getStartTimeLocal());</span>
<span class="nc" id="L144">			LocalDate end = new LocalDate(hoo.getEndTimeLocal());</span>
<span class="nc" id="L145">			end.add(Calendar.DAY_OF_YEAR, -1);</span>
<span class="nc" id="L146">			colHOODates.add(new Pair&lt;&gt;(start, end));</span>
<span class="nc" id="L147">			boolean isPartial = SchedulingPeriodUtil.isPartialWeek(start, end);</span>
<span class="nc" id="L148">			String hooName =</span>
<span class="nc" id="L149">					m_localizer.formatDate(start, RegionalFormatBundleKey.DATE_FORMAT) + &quot; - &quot;</span>
<span class="nc" id="L150">							+ m_localizer.formatDate(end, RegionalFormatBundleKey.DATE_FORMAT)</span>
<span class="nc" id="L151">							+ getPartialLabel(isPartial);</span>
<span class="nc" id="L152">			colHOOStrings.add(new StringsPair(hoo.getID().toString(), hooName));</span>
		}

<span class="nc" id="L155">		String strID = &quot;-1&quot;;</span>
<span class="nc" id="L156">		String[] defaultVal = new String[] { strID };</span>
<span class="nc" id="L157">		LocalDate start = new LocalDate(startDate, m_context.getViewingTimeZone());</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">		if (SchedulingPeriodUtil.isWeeklyCampaign(campaign)) {</span>
<span class="nc" id="L160">			addRowsForWeeklySP(colHOOStrings, defaultVal, start);</span>
		} else {
<span class="nc" id="L162">			addRowsForMonthlySP(colHOOStrings, colHOODates, defaultVal, start);</span>
		}
<span class="nc" id="L164">	}</span>

	/**
	 * Get the &quot;(partial)&quot; label to indicate a partial week, or a spacer if it's not a partial week.
	 * @param isPartial - Whether it's a partial week or not.
	 * @return the appropriate partial string label for the isPartial parameter..
	 */
	private String getPartialLabel(boolean isPartial) {
<span class="nc" id="L172">		String label = &quot;&quot;;</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">		if (SchedulingPeriodUtil.isMonthlyCampaign(campaign)) {</span>
<span class="nc" id="L174">			String partialStr = getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PARTIAL);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">			label = (isPartial ? &quot; &quot; + partialStr : EMPTY_LABEL);</span>
		}
<span class="nc" id="L177">		return label;</span>
	}

	/**
	 * Add a row for each week in a Weekly SP.
	 * @param colHOOStrings - the weeks available for cloning, which will be put in a dropdown in each row
	 * @param defaultVal - the selected value in the colHOOs dropdown
	 * @param start - the start localDate of the Monthly SP
	 */
	private void addRowsForWeeklySP(ArrayList&lt;StringsPair&gt; colHOOStrings, String[] defaultVal, LocalDate start) {
		// this is a weekly SP (single week or multi week)
<span class="nc bnc" id="L188" title="All 2 branches missed.">		for (int i = 0; i &lt; weekNumbers; i++) {</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">			if (i != 0) {</span>
<span class="nc" id="L190">				start.add(Calendar.DATE, 7);</span>
			}
<span class="nc" id="L192">			m_formInputPC.addRow(m_localizer.formatDate(start, RegionalFormatBundleKey.DATE_FORMAT),</span>
<span class="nc" id="L193">					HtmlUtil.makeSelectInput(WEEKSELECTOR_FN + &quot;_&quot; + i, defaultVal, null, colHOOStrings, false, true));</span>
		}
<span class="nc" id="L195">	}</span>

	/**
	 * Add a row for each week in a Monthly SP.
	 * @param colHOOStrings - the week date strings available for cloning, which will be put in a dropdown in each row.
	 * @param colHOODates - the week local date strings available for cloning.
	 * @param defaultVal - the selected value in the colHOOs dropdown
	 * @param spStartDate - the start localDate of the Monthly SP
	 * @throws RemoteException
	 * @throws BbmCreateException
	 */
	private void addRowsForMonthlySP(List&lt;StringsPair&gt; colHOOStrings, List&lt;Pair&lt;LocalDate, LocalDate&gt;&gt; colHOODates,
			String[] defaultVal, LocalDate spStartDate)
			throws BbmCreateException, RemoteException {
<span class="nc" id="L209">		int weekStartDay = SchedulingPeriodUtil.getWeekStartDay(campaign.getWeekStart());</span>
<span class="nc" id="L210">		List&lt;Pair&lt;LocalDate, LocalDate&gt;&gt; localDates = SchedulingPeriodUtil.getWeeksForMonthlySP(spStartDate, weekStartDay);</span>
<span class="nc" id="L211">		int rowNum = 0;</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">		for (Pair&lt;LocalDate, LocalDate&gt; datePair : localDates) {</span>
<span class="nc" id="L213">			LocalDate start = datePair.getFirst();</span>
<span class="nc" id="L214">			LocalDate end = datePair.getSecond();</span>
<span class="nc" id="L215">			List&lt;StringsPair&gt; colHOOStringsFiltered = getFilteredHOOStrings(colHOOStrings, colHOODates, start, end);</span>
<span class="nc" id="L216">			addMonthlyRow(colHOOStringsFiltered, defaultVal, start, end, rowNum++, SchedulingPeriodUtil.isPartialWeek(start, end));</span>
<span class="nc" id="L217">		}</span>

		// store the number of rows because the onClick for the Set button will need this to
		// iterate through the rows to read the selected values.
<span class="nc" id="L221">		setWeekNumbers(rowNum);</span>
<span class="nc" id="L222">	}</span>

	/**
	 * Determine the set of daysOfWeek between start, end, and filter out any HOO's from colHOOStrings that
	 * do not include at least the same days of week.
	 * @param colHOOStrings - the week date strings available for cloning, which will be put in a dropdown in each row.
	 * @param colHOODates - the week local date strings available for cloning.
	 * @param start - the start localDate of one week in the Monthly SP
	 * @param end - the end localDate  of one week in the Monthly SP
	 * @return the filtered set of HOO strings the are cloneable to the SP week between start, end.
	 */
	protected List&lt;StringsPair&gt; getFilteredHOOStrings(List&lt;StringsPair&gt; colHOOStrings,
			List&lt;Pair&lt;LocalDate, LocalDate&gt;&gt; colHOODates, LocalDate start, LocalDate end) {
<span class="nc" id="L235">		Set&lt;Integer&gt; daysOfWeekInTarget = getDaysOfWeekWithin(start, end);</span>
<span class="nc" id="L236">		List&lt;StringsPair&gt; colHOOStringsFiltered = new ArrayList&lt;StringsPair&gt;();</span>
<span class="nc" id="L237">		int i = 0;</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">		for (Pair&lt;LocalDate, LocalDate&gt; curDatePair : colHOODates) {</span>
<span class="nc" id="L239">			Set&lt;Integer&gt; daysOfWeekInSource = getDaysOfWeekWithin(curDatePair.getFirst(), curDatePair.getSecond());</span>

<span class="nc bnc" id="L241" title="All 2 branches missed.">			if (daysOfWeekInSource.containsAll(daysOfWeekInTarget)) {</span>
<span class="nc" id="L242">				StringsPair curStringPair = colHOOStrings.get(i);</span>
<span class="nc" id="L243">				colHOOStringsFiltered.add(curStringPair);</span>
			}
<span class="nc" id="L245">			i++;</span>
<span class="nc" id="L246">		}</span>
<span class="nc" id="L247">		return colHOOStringsFiltered;</span>
	}

	/**
	 * Add a row for one week of a Monthly SP.
	 * @param colHOOStrings - the weeks available for cloning, which will be put in a dropdown in this row.
	 * @param defaultVal - the selected value in the colHOOs dropdown
	 * @param start - the start localDate of one week in Monthly SP
	 * @param end - the end localDate  of one week in Monthly SP
	 * @param rowNum - the row number (0 is the first row, etc).
	 * @param isPartial - Is this a partial week?
	 */
	private void addMonthlyRow(List&lt;StringsPair&gt; colHOOStrings, String[] defaultVal, LocalDate start, LocalDate end,
			int rowNum, boolean isPartial) {
<span class="nc" id="L261">		String startStr = m_localizer.formatDate(start, RegionalFormatBundleKey.DATE_FORMAT);</span>
<span class="nc" id="L262">		String endStr = m_localizer.formatDate(end, RegionalFormatBundleKey.DATE_FORMAT);</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">		String rowHeader =</span>
<span class="nc" id="L264">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, isPartial ? CoreWebBundleKey.PARTIAL_WEEK_OF_X_TO_Y</span>
						: CoreWebBundleKey.WEEK_OF_X_TO_Y, startStr, endStr);

<span class="nc" id="L267">		m_formInputPC.addRow(rowHeader,</span>
<span class="nc" id="L268">				HtmlUtil.makeSelectInput(WEEKSELECTOR_FN + &quot;_&quot; + rowNum, defaultVal, null, colHOOStrings, false, true));</span>
<span class="nc" id="L269">	}</span>

	public String getHtmlDisplay() {
<span class="nc" id="L272">		return m_formInputPC.getHtmlDisplay();</span>
	}

	public void setWeekNumbers(int val) {
<span class="nc" id="L276">		this.weekNumbers = val;</span>
<span class="nc" id="L277">	}</span>

	public void setStartDate(String sdate) {
<span class="nc" id="L280">		SimpleDateFormat sdf = m_context.getLocalizer().getDateInputFormatter(m_context.getViewingTimeZone());</span>

<span class="nc bnc" id="L282" title="All 2 branches missed.">		if (sdate != null) {</span>
			try {
<span class="nc" id="L284">				startDate = sdf.parse(sdate);</span>
<span class="nc" id="L285">			} catch (Exception e) {</span>
<span class="nc" id="L286">				handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L287">			}</span>
		}
<span class="nc" id="L289">	}</span>

	public String getCustomJavaScript() {
<span class="nc" id="L292">		String str =</span>
				&quot;function setSelectedIDs() { \n&quot; + &quot; var idsString = ''; \n&quot; + &quot; var weekNumber = DOM2.getElementById('&quot;
						+ CUR_WEEK_NUMBERS + &quot;').value \n&quot; + &quot; for (var i=0; i&lt;weekNumber; i++) { \n&quot;
						+ &quot;     var id = DOM2.getElementById('&quot; + WEEKSELECTOR_FN + &quot;'+'_' + i).value \n&quot;
						+ &quot;     idsString += id; \n&quot; + &quot;     if (i &lt; weekNumber-1) {&quot; + &quot;         idsString += ','&quot;
						+ &quot;     } \n&quot; + &quot; } \n&quot;

						+ &quot; var IDsField = window.opener.oFormMain.selectedHooID; \n&quot; + &quot; if (IDsField) { \n&quot;
						+ &quot;     IDsField.value = idsString; \n&quot; + &quot; } \n&quot;
						+ &quot; window.opener.pageMediator.setPageDirty(true); \n&quot; + &quot; window.close(); \n&quot; + &quot;\n }\n\n&quot;;

<span class="nc" id="L303">		return super.getCustomJavaScript() + &quot; &quot; + str;</span>
	}

	public String getRequiredHTML() {
<span class="nc" id="L307">		return super.getRequiredHTML() + HtmlUtil.makeHiddenInput(CUR_WEEK_NUMBERS, weekNumbers);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>