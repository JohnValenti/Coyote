<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CustomizeWeeksPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.campaign</a> &gt; <span class="el_source">CustomizeWeeksPopupPM.java</span></div><h1>CustomizeWeeksPopupPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.campaign;

import java.rmi.RemoteException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOO;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.bbm.campaign.sp.SchedulingPeriodUtil;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.PopupWindowPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;

@SuppressWarnings(&quot;serial&quot;)
public class CustomizeWeeksPopupPM extends PopupWindowPM {
	public static final String FORM_ACTION = &quot;campaign_customize_week_popup&quot;;
	public static final String POPUP_ID = &quot;POPUP_CUSTOMIZE_WEEKS&quot;;
	public static final String POPUP_ARGS = &quot;weekNumbers, startDate, campaingID&quot;;
	public static final String WEEK_NUMBERS = &quot;weekNumbers&quot;;
	public static final String START_DATE = &quot;startDate&quot;;
	public static final String CAMPAIGN_ID = &quot;campaignID&quot;;
	public static final String WEEKSELECTOR_FN = &quot;weekselector&quot;;
	public static final String EMPTY_LABEL = &quot;            &quot;;
	public static final String CUR_WEEK_NUMBERS = &quot;curWeekNumbers&quot;;

	private FormTwoColumnPC m_formInputPC;
	private int weekNumbers;
	private Date startDate;
	private ID campaignID;
	private Campaign campaign;

	public CustomizeWeeksPopupPM(RequestContext context) {
<span class="nc" id="L56">		super(context);</span>
		// TODO Auto-generated constructor stub
<span class="nc" id="L58">		m_formInputPC = new FormTwoColumnPC(context);</span>

<span class="nc" id="L60">		addChildComponent(m_formInputPC);</span>

<span class="nc" id="L62">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="nc" id="L63">	}</span>

	public static CustomizeWeeksPopupPM getInstance(RequestContext context) {
<span class="nc" id="L66">		return (CustomizeWeeksPopupPM) getInstance(context, CustomizeWeeksPopupPM.class);</span>
	}

	protected void initializeModel() {
<span class="nc bnc" id="L70" title="All 2 branches missed.">		if (m_isInitialized) {</span>
<span class="nc" id="L71">			return;</span>
		} else {
<span class="nc" id="L73">			m_isInitialized = true;</span>
		}
		try {
<span class="nc" id="L76">			initContentTitle();</span>
<span class="nc" id="L77">			initForm();</span>
<span class="nc" id="L78">			ToolbarTextButton addButton =</span>
<span class="nc" id="L79">					m_toolbar.createCloseWindowButton(&quot;customizeWeekSelection&quot;,</span>
<span class="nc" id="L80">							m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_SET), true);</span>
<span class="nc" id="L81">			addButton.setCustomJS(&quot;setSelectedIDs()&quot;);</span>
<span class="nc" id="L82">			m_toolbar.addToolbarElement(addButton);</span>
<span class="nc" id="L83">			m_toolbar.addCloseWindowTextButton(&quot;cancel&quot;,</span>
<span class="nc" id="L84">					m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_CANCEL), true);</span>
<span class="nc" id="L85">		} catch (Exception ex) {</span>
<span class="nc" id="L86">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L87">		}</span>
<span class="nc" id="L88">	}</span>

	protected void initUtilityPane() {
<span class="nc" id="L91">		getUtilityPane().setIsHelpEnabled(false);</span>
<span class="nc" id="L92">	}</span>

	protected void initContentTitle() {
<span class="nc" id="L95">		m_contentTitlePC.setPageTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
				FsWebBundleKey.CAMPAIGN_SP_CUSTOMIZE_WEEK_SELECTION));
<span class="nc" id="L97">	}</span>

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L101">		boolean result = super.extractParameters(request);</span>
<span class="nc" id="L102">		SimpleDateFormat sdf = m_context.getLocalizer().getDateInputFormatter(m_context.getViewingTimeZone());</span>
<span class="nc" id="L103">		String strWeekNumbers = request.getParameter(WEEK_NUMBERS);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (strWeekNumbers != null) {</span>
<span class="nc" id="L105">			weekNumbers = Integer.parseInt(strWeekNumbers);</span>
		}
<span class="nc" id="L107">		String sdate = request.getParameter(START_DATE);</span>
<span class="nc bnc" id="L108" title="All 4 branches missed.">		if (sdate != null &amp;&amp; !sdate.isEmpty()) {</span>
			try {
<span class="nc" id="L110">				startDate = sdf.parse(sdate);</span>
<span class="nc" id="L111">			} catch (Exception e) {</span>
<span class="nc" id="L112">				handleExtractParamException(&quot;extractParameters&quot;, START_DATE, sdate, e);</span>
<span class="nc" id="L113">			}</span>
		}

<span class="nc" id="L116">		String strID = request.getParameter(CAMPAIGN_ID);</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (!StringUtil.isEmptyOrWhiteSpace(strID)) {</span>
<span class="nc" id="L119">			campaignID = ID.fromInt(Integer.parseInt(strID));</span>
			try {
<span class="nc" id="L121">				CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L122">				campaign = camManager.getCampaignByID(campaignID);</span>
<span class="nc" id="L123">			} catch (Exception e) {</span>
<span class="nc" id="L124">				handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L125">			}</span>
		}

<span class="nc" id="L128">		return result;</span>
	}

	protected void initForm() throws BbmException, RemoteException {
<span class="nc" id="L132">		Calendar cal = Calendar.getInstance(campaign.getTimeZone(), m_locale);</span>
<span class="nc" id="L133">		cal.setTime(startDate);</span>
<span class="nc" id="L134">		cal.add(Calendar.YEAR, -10);</span>
<span class="nc" id="L135">		Date spstartDate = cal.getTime();</span>
<span class="nc" id="L136">		cal.add(Calendar.YEAR, 20);</span>
<span class="nc" id="L137">		Date spendDate = cal.getTime();</span>
		// end of workaround

<span class="nc" id="L140">		ArrayList&lt;CampaignHOO&gt; hoos = new ArrayList&lt;CampaignHOO&gt;(CampaignModelHandler.getCampaignHOOAssignments(m_context, campaignID,</span>
			spstartDate, spendDate, false));

<span class="nc" id="L143">		ArrayList&lt;StringsPair&gt; colHOOStrings = new ArrayList&lt;StringsPair&gt;();</span>
<span class="nc" id="L144">		ArrayList&lt;Pair&lt;LocalDate, LocalDate&gt;&gt; colHOODates = new ArrayList&lt;Pair&lt;LocalDate, LocalDate&gt;&gt;();</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">		for (int i = hoos.size() - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L146">			CampaignHOO hoo = hoos.get(i);</span>
<span class="nc" id="L147">			LocalDate start = new LocalDate(hoo.getStartTimeLocal());</span>
<span class="nc" id="L148">			LocalDate end = new LocalDate(hoo.getEndTimeLocal());</span>
<span class="nc" id="L149">			end.add(Calendar.DAY_OF_YEAR, -1);</span>
<span class="nc" id="L150">			colHOODates.add(new Pair&lt;LocalDate, LocalDate&gt;(start, end));</span>
<span class="nc" id="L151">			boolean isPartial = SchedulingPeriodUtil.isPartialWeek(start, end);</span>
<span class="nc" id="L152">			String hooName =</span>
<span class="nc" id="L153">					m_localizer.formatDate(start, RegionalFormatBundleKey.DATE_FORMAT) + &quot; - &quot;</span>
<span class="nc" id="L154">							+ m_localizer.formatDate(end, RegionalFormatBundleKey.DATE_FORMAT)</span>
<span class="nc" id="L155">							+ getPartialLabel(isPartial);</span>
<span class="nc" id="L156">			colHOOStrings.add(new StringsPair(hoo.getID().toString(), hooName));</span>
		}

<span class="nc" id="L159">		String strID = &quot;-1&quot;;</span>
<span class="nc" id="L160">		String[] defaultVal = new String[] { strID };</span>
<span class="nc" id="L161">		LocalDate start = new LocalDate(startDate, m_context.getViewingTimeZone());</span>

<span class="nc bnc" id="L163" title="All 2 branches missed.">		if (SchedulingPeriodUtil.isWeeklyCampaign(campaign)) {</span>
<span class="nc" id="L164">			addRowsForWeeklySP(colHOOStrings, defaultVal, start);</span>
		} else {
<span class="nc" id="L166">			addRowsForMonthlySP(colHOOStrings, colHOODates, defaultVal, start);</span>
		}
<span class="nc" id="L168">	}</span>

	/**
	 * Get the &quot;(partial)&quot; label to indicate a partial week, or a spacer if it's not a partial week.
	 * @param isPartial - Whether it's a partial week or not.
	 * @return the appropriate partial string label for the isPartial parameter..
	 */
	private String getPartialLabel(boolean isPartial) {
<span class="nc" id="L176">		String label = &quot;&quot;;</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">		if (SchedulingPeriodUtil.isMonthlyCampaign(campaign)) {</span>
<span class="nc" id="L178">			String partialStr = getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PARTIAL);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">			label = (isPartial ? &quot; &quot; + partialStr : EMPTY_LABEL);</span>
		}
<span class="nc" id="L181">		return label;</span>
	}

	/**
	 * Add a row for each week in a Weekly SP.
	 * @param colHOOStrings - the weeks available for cloning, which will be put in a dropdown in each row
	 * @param defaultVal - the selected value in the colHOOs dropdown
	 * @param start - the start localDate of the Monthly SP
	 */
	private void addRowsForWeeklySP(ArrayList&lt;StringsPair&gt; colHOOStrings, String[] defaultVal, LocalDate start) {
		// this is a weekly SP (single week or multi week)
<span class="nc bnc" id="L192" title="All 2 branches missed.">		for (int i = 0; i &lt; weekNumbers; i++) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">			if (i != 0) {</span>
<span class="nc" id="L194">				start.add(Calendar.DATE, 7);</span>
			}
<span class="nc" id="L196">			m_formInputPC.addRow(m_localizer.formatDate(start, RegionalFormatBundleKey.DATE_FORMAT),</span>
<span class="nc" id="L197">					HtmlUtil.makeSelectInput(WEEKSELECTOR_FN + &quot;_&quot; + i, defaultVal, null, colHOOStrings, false, true));</span>
		}
<span class="nc" id="L199">	}</span>

	/**
	 * Add a row for each week in a Monthly SP.
	 * @param colHOOStrings - the week date strings available for cloning, which will be put in a dropdown in each row.
	 * @param colHOODates - the week local date strings available for cloning.
	 * @param defaultVal - the selected value in the colHOOs dropdown
	 * @param spStartDate - the start localDate of the Monthly SP
	 * @throws RemoteException
	 * @throws BbmCreateException
	 */
	private void addRowsForMonthlySP(List&lt;StringsPair&gt; colHOOStrings, List&lt;Pair&lt;LocalDate, LocalDate&gt;&gt; colHOODates,
			String[] defaultVal, LocalDate spStartDate)
			throws BbmCreateException, RemoteException {
<span class="nc" id="L213">		int weekStartDay = SchedulingPeriodUtil.getWeekStartDay(campaign.getWeekStart());</span>
<span class="nc" id="L214">		List&lt;Pair&lt;LocalDate, LocalDate&gt;&gt; localDates = SchedulingPeriodUtil.getWeeksForMonthlySP(spStartDate, weekStartDay);</span>
<span class="nc" id="L215">		int rowNum = 0;</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">		for (Pair&lt;LocalDate, LocalDate&gt; datePair : localDates) {</span>
<span class="nc" id="L217">			LocalDate start = datePair.getFirst();</span>
<span class="nc" id="L218">			LocalDate end = datePair.getSecond();</span>
<span class="nc" id="L219">			List&lt;StringsPair&gt; colHOOStringsFiltered = getFilteredHOOStrings(colHOOStrings, colHOODates, start, end);</span>
<span class="nc" id="L220">			addMonthlyRow(colHOOStringsFiltered, defaultVal, start, end, rowNum++, SchedulingPeriodUtil.isPartialWeek(start, end));</span>
<span class="nc" id="L221">		}</span>

		// store the number of rows because the onClick for the Set button will need this to
		// iterate through the rows to read the selected values.
<span class="nc" id="L225">		setWeekNumbers(rowNum);</span>
<span class="nc" id="L226">	}</span>

	/**
	 * Determine the set of daysOfWeek between start, end, and filter out any HOO's from colHOOStrings that
	 * do not include at least the same days of week.
	 * @param colHOOStrings - the week date strings available for cloning, which will be put in a dropdown in each row.
	 * @param colHOODates - the week local date strings available for cloning.
	 * @param start - the start localDate of one week in the Monthly SP
	 * @param end - the end localDate  of one week in the Monthly SP
	 * @return the filtered set of HOO strings the are cloneable to the SP week between start, end.
	 */
	protected List&lt;StringsPair&gt; getFilteredHOOStrings(List&lt;StringsPair&gt; colHOOStrings,
			List&lt;Pair&lt;LocalDate, LocalDate&gt;&gt; colHOODates, LocalDate start, LocalDate end) {
<span class="nc" id="L239">		Set&lt;Integer&gt; daysOfWeekInTarget = getDaysOfWeekWithin(start, end);</span>
<span class="nc" id="L240">		List&lt;StringsPair&gt; colHOOStringsFiltered = new ArrayList&lt;StringsPair&gt;();</span>
<span class="nc" id="L241">		int i = 0;</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">		for (Pair&lt;LocalDate, LocalDate&gt; curDatePair : colHOODates) {</span>
<span class="nc" id="L243">			Set&lt;Integer&gt; daysOfWeekInSource = getDaysOfWeekWithin(curDatePair.getFirst(), curDatePair.getSecond());</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">			if (daysOfWeekInSource.containsAll(daysOfWeekInTarget)) {</span>
<span class="nc" id="L246">				StringsPair curStringPair = colHOOStrings.get(i);</span>
<span class="nc" id="L247">				colHOOStringsFiltered.add(curStringPair);</span>
			}
<span class="nc" id="L249">			i++;</span>
<span class="nc" id="L250">		}</span>
<span class="nc" id="L251">		return colHOOStringsFiltered;</span>
	}

	/**
	 * Given a date range, returns all of the Calendar day of week ordinals in that range.
	 * @param start - start of range (inclusive)
	 * @param end - end of range (inclusive)
	 * @return a set such as {Calendar.SATURDAY, SUNDAY, MONDAY}
	 */
	protected Set&lt;Integer&gt; getDaysOfWeekWithin(LocalDate start, LocalDate end) {
<span class="nc" id="L261">		int startDayOfWeek = start.get(Calendar.DAY_OF_WEEK);</span>
<span class="nc" id="L262">		int endDayOfWeek = end.get(Calendar.DAY_OF_WEEK);</span>
<span class="nc" id="L263">		int curDayOfWeek = startDayOfWeek;</span>
<span class="nc" id="L264">		Set&lt;Integer&gt; daysOfWeekSet = new HashSet&lt;Integer&gt;();</span>

<span class="nc bnc" id="L266" title="All 2 branches missed.">		while (curDayOfWeek != endDayOfWeek) {</span>
<span class="nc" id="L267">			daysOfWeekSet.add(Integer.valueOf(curDayOfWeek));</span>
<span class="nc" id="L268">			curDayOfWeek ++;</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">			if (curDayOfWeek == 8) {</span>
<span class="nc" id="L270">				curDayOfWeek = 1;</span>
			}
		}
<span class="nc" id="L273">		daysOfWeekSet.add(Integer.valueOf(curDayOfWeek));</span>
<span class="nc" id="L274">		return daysOfWeekSet;</span>
	}

	/**
	 * Add a row for one week of a Monthly SP.
	 * @param colHOOStrings - the weeks available for cloning, which will be put in a dropdown in this row.
	 * @param defaultVal - the selected value in the colHOOs dropdown
	 * @param start - the start localDate of one week in Monthly SP
	 * @param end - the end localDate  of one week in Monthly SP
	 * @param rowNum - the row number (0 is the first row, etc).
	 * @param isPartial - Is this a partial week?
	 */
	private void addMonthlyRow(List&lt;StringsPair&gt; colHOOStrings, String[] defaultVal, LocalDate start, LocalDate end,
			int rowNum, boolean isPartial) {
<span class="nc" id="L288">		String startStr = m_localizer.formatDate(start, RegionalFormatBundleKey.DATE_FORMAT);</span>
<span class="nc" id="L289">		String endStr = m_localizer.formatDate(end, RegionalFormatBundleKey.DATE_FORMAT);</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">		String rowHeader =</span>
<span class="nc" id="L291">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, isPartial ? CoreWebBundleKey.PARTIAL_WEEK_OF_X_TO_Y</span>
						: CoreWebBundleKey.WEEK_OF_X_TO_Y, startStr, endStr);

<span class="nc" id="L294">		m_formInputPC.addRow(rowHeader,</span>
<span class="nc" id="L295">				HtmlUtil.makeSelectInput(WEEKSELECTOR_FN + &quot;_&quot; + rowNum, defaultVal, null, colHOOStrings, false, true));</span>
<span class="nc" id="L296">	}</span>

	public String getHtmlDisplay() {
<span class="nc" id="L299">		return m_formInputPC.getHtmlDisplay();</span>
	}

	public void setWeekNumbers(int val) {
<span class="nc" id="L303">		this.weekNumbers = val;</span>
<span class="nc" id="L304">	}</span>

	public void setStartDate(String sdate) {
<span class="nc" id="L307">		SimpleDateFormat sdf = m_context.getLocalizer().getDateInputFormatter(m_context.getViewingTimeZone());</span>

<span class="nc bnc" id="L309" title="All 2 branches missed.">		if (sdate != null) {</span>
			try {
<span class="nc" id="L311">				startDate = sdf.parse(sdate);</span>
<span class="nc" id="L312">			} catch (Exception e) {</span>
<span class="nc" id="L313">				handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L314">			}</span>
		}
<span class="nc" id="L316">	}</span>

	public String getCustomJavaScript() {
<span class="nc" id="L319">		String str =</span>
				&quot;function setSelectedIDs() { \n&quot; + &quot; var idsString = ''; \n&quot; + &quot; var weekNumber = DOM2.getElementById('&quot;
						+ CUR_WEEK_NUMBERS + &quot;').value \n&quot; + &quot; for (var i=0; i&lt;weekNumber; i++) { \n&quot;
						+ &quot;     var id = DOM2.getElementById('&quot; + WEEKSELECTOR_FN + &quot;'+'_' + i).value \n&quot;
						+ &quot;     idsString += id; \n&quot; + &quot;     if (i &lt; weekNumber-1) {&quot; + &quot;         idsString += ','&quot;
						+ &quot;     } \n&quot; + &quot; } \n&quot;

						+ &quot; var IDsField = window.opener.oFormMain.selectedHooID; \n&quot; + &quot; if (IDsField) { \n&quot;
						+ &quot;     IDsField.value = idsString; \n&quot; + &quot; } \n&quot;
						+ &quot; window.opener.pageMediator.setPageDirty(true); \n&quot; + &quot; window.close(); \n&quot; + &quot;\n }\n\n&quot;;

<span class="nc" id="L330">		return super.getCustomJavaScript() + &quot; &quot; + str;</span>
	}

	public String getRequiredHTML() {
<span class="nc" id="L334">		return super.getRequiredHTML() + HtmlUtil.makeHiddenInput(CUR_WEEK_NUMBERS, weekNumbers);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>