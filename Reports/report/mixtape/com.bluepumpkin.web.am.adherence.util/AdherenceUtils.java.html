<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AdherenceUtils.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.am.adherence.util</a> &gt; <span class="el_source">AdherenceUtils.java</span></div><h1>AdherenceUtils.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.am.adherence.util;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.ejb.bbm.rtaamanager.model.EmployeeData;
import com.bluepumpkin.ejb.bbm.rtaamanager.model.RTAAData;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.RTAAException;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.SimpleEvent;
import com.bluepumpkin.web.am.adherence.testing.AdherenceEvent;

/**
 * Created by Tyler Morse.
 * Copyright 2003 Blue Pumpkin Software.  All rights reserved.
 * Date: Jun 25, 2003
 * Time: 4:24:16 PM
 */
<span class="nc" id="L30">public class AdherenceUtils {</span>
	/**
	 * @param range1
	 * @param range2
	 * @return true if the ranges overlap
	 */
	public static boolean timeRangeOverlaps(TimeRange range1, TimeRange range2) {
<span class="nc" id="L37">		return dateRangesOverlap(range1.getStartDate(), range1.getEndDate(), range2.getStartDate(), range2.getEndDate());</span>
	}

	/**
	 *
	 * @param start1 start of the first date range
	 * @param end1 end of the first date range
	 * @param start2 start of the second date range
	 * @param end2 end of the second date range
	 * @return true if the date ranges overlap
	 */
	public static boolean dateRangesOverlap(Date start1, Date end1, Date start2, Date end2) {
<span class="nc bnc" id="L49" title="All 8 branches missed.">		return (end2 == null || start1.before(end2)) &amp;&amp; (end1 == null || start2.before(end1));</span>
	}

	/**
	 * returns true if the two collections contain exactly the same elements
	 * @param collection1
	 * @param collection2
	 * @return
	 */
	public static boolean areCollectionsEqual(Collection collection1, Collection collection2) {
<span class="nc bnc" id="L59" title="All 4 branches missed.">		if (collection1 == null || collection2 == null) {</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">			return collection1 == collection2;</span>
		}
<span class="nc bnc" id="L62" title="All 4 branches missed.">		return (collection1.size() == collection2.size() &amp;&amp; collection1.containsAll(collection2));</span>
	}

	/**
	 * returns true if the two collections contain exactly the same elements in exactly the same order
	 * @param collection1
	 * @param collection2
	 * @return
	 */
	public static boolean areCollectionsEqualSorted(Collection collection1, Collection collection2) {
<span class="nc bnc" id="L72" title="All 2 branches missed.">		if (!areCollectionsEqual(collection1, collection2)) {</span>
<span class="nc" id="L73">			return false;</span>
<span class="nc bnc" id="L74" title="All 6 branches missed.">		} else if (areCollectionsEqual(collection1, collection2) &amp;&amp; collection1 == null &amp;&amp; collection2 == null) {</span>
<span class="nc" id="L75">			return true;</span>
		}
<span class="nc" id="L77">		Iterator itCol1 = collection1.iterator();</span>
<span class="nc" id="L78">		Iterator itCol2 = collection2.iterator();</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">		while (itCol1.hasNext()) {</span>
<span class="nc" id="L80">			Object nextObj1 = itCol1.next();</span>
<span class="nc" id="L81">			Object nextObj2 = itCol2.next();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">			if (!nextObj1.equals(nextObj2)) {</span>
<span class="nc" id="L83">				return false;</span>
			}
<span class="nc" id="L85">		}</span>
<span class="nc" id="L86">		return true;</span>
	}

	// debugging routines
	public static String dumpRTAAData(RTAAData data) {
<span class="nc" id="L91">		StringBuffer sb = new StringBuffer(8192);</span>

<span class="nc" id="L93">		sb.append(&quot;****************** RTAAData received **************\n&quot;);</span>
<span class="nc" id="L94">		sb.append(&quot;&gt;&gt; TS = &quot;).append(data.getTimestamp()).append(&quot;\n&quot;);</span>

<span class="nc" id="L96">		sb.append(&quot;&gt;&gt; Employee IDs = &quot;);</span>
		
<span class="nc bnc" id="L98" title="All 2 branches missed.">		for (Iterator idIter = data.getEmployeeIDs().iterator(); idIter.hasNext();) {</span>
<span class="nc" id="L99">			ID empID = (ID)idIter.next();</span>
<span class="nc" id="L100">			sb.append(empID + &quot;:&quot;);</span>
<span class="nc" id="L101">		}</span>
<span class="nc" id="L102">		sb.append(&quot;\n&quot;);</span>

<span class="nc" id="L104">		sb.append(&quot;&gt;&gt; Employee Data = \n&quot;);</span>
<span class="nc" id="L105">		for (Iterator itEmployeeData = data.getEmployeeData().iterator();</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">			 itEmployeeData.hasNext();</span>
			 ) {
<span class="nc" id="L108">			EmployeeData ed = (EmployeeData) itEmployeeData.next();</span>
<span class="nc" id="L109">            sb.append(&quot;&gt;&gt;&gt;&gt; Employee ID= &quot; + ed.getEmployeeID() + &quot; &lt;&lt;&lt;&lt;&lt;&lt;&lt;\n&quot;);</span>
<span class="nc" id="L110">			sb.append(&quot;&gt;&gt;&gt;&gt; ScheduledEvents &lt;&lt;&lt;&lt;&lt;&lt;&lt;\n&quot;);</span>
<span class="nc" id="L111">			sb.append(dumpEventList(ed.getPlannedEvents()));</span>

<span class="nc" id="L113">			sb.append(&quot;&gt;&gt;&gt;&gt;&gt; ActualEvents &lt;&lt;&lt;&lt;&lt;&lt;&lt;\n&quot;);</span>
<span class="nc" id="L114">			sb.append(dumpEventList(ed.getActualEvents()));</span>

<span class="nc" id="L116">			sb.append(&quot;&gt;&gt;&gt;&gt;&gt; ExceptionEvents &lt;&lt;&lt;&lt;&lt;&lt;&lt;\n&quot;);</span>
<span class="nc" id="L117">			sb.append(dumpEventList(ed.getAdheranceViolations()));</span>
<span class="nc" id="L118">		}</span>

<span class="nc" id="L120">		sb.append(&quot;&gt;&gt; Activities = \n&quot;);</span>
<span class="nc" id="L121">		HashMap activities = data.getActivities();</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">		for (Iterator actIter = activities.values().iterator(); actIter.hasNext();) {</span>
<span class="nc" id="L124">			Activity act = (Activity)actIter.next();</span>
<span class="nc" id="L125">			sb.append(&quot;Activity::&quot;);</span>
<span class="nc" id="L126">			sb.append(act.getID());</span>
<span class="nc" id="L127">			sb.append(&quot;:&quot;);</span>
<span class="nc" id="L128">			sb.append(act.getName());</span>
<span class="nc" id="L129">			sb.append(&quot;:&quot;);</span>
<span class="nc" id="L130">			sb.append(act.getAdherenceTolerance());</span>
<span class="nc" id="L131">			sb.append(&quot;:&quot;);</span>
<span class="nc" id="L132">			sb.append(act.getColorCode());</span>
<span class="nc" id="L133">			sb.append(&quot;\n&quot;);</span>
<span class="nc" id="L134">		}</span>
<span class="nc" id="L135">		return sb.toString();</span>
	}

	static public String dumpEventList(Collection list) {
<span class="nc" id="L139">		StringBuffer sb = new StringBuffer(4096);</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">		for (Iterator eventIter = list.iterator(); eventIter.hasNext();) {</span>
<span class="nc" id="L142">			Object obj = eventIter.next();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">			if (obj instanceof AdherenceEvent) {</span>
<span class="nc" id="L144">				AdherenceEvent event = (AdherenceEvent)obj;</span>
<span class="nc" id="L145">				sb.append(&quot;    ST=&quot;);</span>
<span class="nc" id="L146">				sb.append(event.getStartTime());</span>
<span class="nc" id="L147">				sb.append(&quot; ET=&quot;);</span>
<span class="nc" id="L148">				sb.append(event.getEndTime());</span>
<span class="nc" id="L149">				sb.append(&quot; Act=&quot;);</span>
<span class="nc" id="L150">				sb.append(event.getActivityID());</span>
<span class="nc" id="L151">				sb.append(&quot; TS=&quot;);</span>
<span class="nc" id="L152">				sb.append(event.getTimestamp());</span>
<span class="nc" id="L153">				sb.append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">			} else if (obj instanceof RTAAException) {</span>
<span class="nc" id="L155">				RTAAException event = (RTAAException)obj;</span>
<span class="nc" id="L156">				sb.append(&quot;    ST=&quot;);</span>
<span class="nc" id="L157">				sb.append(event.getStartTime()); </span>
<span class="nc" id="L158">				sb.append(&quot; ET=&quot;);</span>
<span class="nc" id="L159">				sb.append(event.getEndTime());</span>
<span class="nc" id="L160">				sb.append(&quot; Act=&quot;);</span>
<span class="nc" id="L161">				sb.append(event.getPlannedActivityID());</span>
<span class="nc" id="L162">				sb.append(&quot; Del=&quot;);</span>
<span class="nc" id="L163">				sb.append(event.isDeleted());</span>
<span class="nc" id="L164">				sb.append(&quot; Auth=&quot;);</span>
<span class="nc" id="L165">				sb.append(event.isApproved());</span>
<span class="nc" id="L166">				sb.append(&quot; Approve=&quot;);</span>
<span class="nc" id="L167">				sb.append(event.getApproveBy());</span>
<span class="nc" id="L168">				sb.append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">			} else if (obj instanceof SimpleEvent) {</span>
<span class="nc" id="L170">				SimpleEvent event = (SimpleEvent)obj;</span>
<span class="nc" id="L171">				sb.append(&quot;    ST=&quot;);</span>
<span class="nc" id="L172">				sb.append(event.getStartTime());</span>
<span class="nc" id="L173">				sb.append(&quot; ET=&quot;); </span>
<span class="nc" id="L174">				sb.append(event.getEndTime());</span>
<span class="nc" id="L175">				sb.append(&quot; Act=&quot;);</span>
<span class="nc" id="L176">				sb.append(event.getActivityID());</span>
<span class="nc" id="L177">				sb.append(&quot;\n&quot;);</span>
			}
<span class="nc" id="L179">		}</span>
<span class="nc" id="L180">		return sb.toString();</span>
	}

	/**
	 *  Dumps a collection of timerange objects to the console.
	 *  Mainly used for debugging purposes
	 *
	 *  @param timeranges  A collection of time ranges.
	 */
	static public void dumpTimeRanges(Collection timeranges) {
<span class="nc" id="L190">		System.out.println(&quot;Dumping a collection of timeranges&quot;);</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">		for (Iterator iter = timeranges.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L192">			TimeRange tr = (TimeRange)iter.next();</span>
<span class="nc" id="L193">			System.out.println(&quot;Start Date: &quot; + tr.getStartDate() + &quot;;End Date: &quot; + tr.getEndDate());</span>
<span class="nc" id="L194">		}</span>
<span class="nc" id="L195">	}</span>

	public static int getNumAdherenceChanges(RTAAData adherenceChanges) {
<span class="nc" id="L198">		int eventCount = 0;</span>
<span class="nc" id="L199">		Iterator itED = adherenceChanges.getEmployeeData().iterator();</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">		while (itED.hasNext()) {</span>
<span class="nc" id="L201">			EmployeeData nextED = (EmployeeData) itED.next();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">			eventCount += nextED.getPlannedEvents() == null ? 0 : nextED.getPlannedEvents().size();</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">			eventCount += nextED.getActualEvents() == null ? 0 : nextED.getActualEvents().size();</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">			eventCount += nextED.getAdheranceViolations() == null ? 0 : nextED.getAdheranceViolations().size();</span>
<span class="nc" id="L205">		}</span>
<span class="nc" id="L206">		return eventCount;</span>
	}

<span class="nc" id="L209">	public static SimpleDateFormat _timestampFormat = new SimpleDateFormat(&quot;EEE, MMM dd K:mm:ss.SSS&quot;);</span>
	public static String formatTimeOnlyTimestamp(Date timestamp) {
<span class="nc bnc" id="L211" title="All 2 branches missed.">		return timestamp == null ? &quot;null&quot; :_timestampFormat.format(timestamp);</span>
	}

<span class="nc" id="L214">	public static class ExceptionComparator implements Comparator {</span>
		public int compare(Object o1, Object o2) {
<span class="nc" id="L216">			return ((RTAAException) o1).getStartTime().compareTo(((RTAAException) o2).getStartTime());</span>
		}
	}

<span class="nc" id="L220">	public static class EventComparator implements Comparator {</span>
		public int compare(Object o1, Object o2) {
<span class="nc" id="L222">			return ((SimpleEvent) o1).getStartTime().compareTo(((SimpleEvent) o2).getStartTime());</span>
		}
	}

<span class="nc" id="L226">	public static class TimeRangeComparator implements Comparator {</span>
		public int compare(Object o1, Object o2) {
<span class="nc" id="L228">			return ((TimeRange) o1).getStartDate().compareTo(((TimeRange) o2).getStartDate());</span>
		}
	}

	public static Collection sortExceptionList(Collection listExceptions) {
<span class="nc" id="L233">		return sortList(listExceptions, new AdherenceUtils.ExceptionComparator());</span>
	}

	public static Collection sortEventList(Collection listEvents) {
<span class="nc" id="L237">		return sortList(listEvents, new AdherenceUtils.EventComparator());</span>
	}

	public static Collection sortTimeRangeList(Collection listTimeRanges) {
<span class="nc" id="L241">		return sortList(listTimeRanges, new AdherenceUtils.TimeRangeComparator());</span>
	}

	public static Collection sortList(Collection originalList, Comparator comparator) {
<span class="nc" id="L245">		Object[] sortingArray = originalList.toArray();</span>
<span class="nc" id="L246">		Arrays.sort(sortingArray, comparator);</span>
<span class="nc" id="L247">		return Arrays.asList(sortingArray);</span>
	}

	public static ArrayList flattenInteractionsColl(ArrayList interactionsColl) {
		//algorithm to flatten out the calls on a timeline
		//get an array of all the start and end times
<span class="nc" id="L253">		List dateList = new ArrayList();</span>

<span class="nc bnc" id="L255" title="All 2 branches missed.">		for (int i = 0; i &lt; interactionsColl.size(); i++) {</span>
<span class="nc" id="L256">			AgentContact contact = (AgentContact) interactionsColl.get(i);</span>
<span class="nc" id="L257">			dateList.add(contact.getStartTime());</span>
<span class="nc" id="L258">			dateList.add(contact.getEndTime());</span>
		}

		//now sort the dates
<span class="nc" id="L262">		Object[] sortingArray = dateList.toArray();</span>
<span class="nc" id="L263">		Arrays.sort(sortingArray);</span>
<span class="nc" id="L264">		dateList = Arrays.asList(sortingArray);</span>
<span class="nc" id="L265">		ArrayList newEventColl = new ArrayList();</span>
		//now iterate thru the datelist and fit the appropriate evebnt in it
<span class="nc bnc" id="L267" title="All 2 branches missed.">		for (int i = 0; i &lt; dateList.size() - 1; i++) {</span>
<span class="nc" id="L268">			AgentContact newContact = null;</span>
<span class="nc" id="L269">			ArrayList overLappingContactIDs = new ArrayList();</span>
<span class="nc" id="L270">			ArrayList overLappingRecordedContactIDs = new ArrayList();</span>
<span class="nc" id="L271">			Date start = (Date) dateList.get(i);</span>
<span class="nc" id="L272">			Date end = (Date) dateList.get(i + 1);</span>
			//iterate thru contact list to find any
<span class="nc bnc" id="L274" title="All 2 branches missed.">			for (int j = 0; j &lt; interactionsColl.size(); j++) {</span>
<span class="nc" id="L275">				AgentContact contact = (AgentContact) interactionsColl.get(j);</span>
<span class="nc" id="L276">				boolean fallsWithinFlag = fallsWithin(contact, start, end);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">				if (fallsWithinFlag) {</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">					if (newContact == null){</span>
<span class="nc" id="L279">						newContact = new AgentContact();</span>
<span class="nc" id="L280">						newContact.setEmployeeID(new ID(contact.getBalanceAgentID()));</span>
<span class="nc" id="L281">						newContact.setStartTime(start);</span>
<span class="nc" id="L282">						newContact.setEndTime(end);</span>
					}
					//add id to overlapping call list depending on record status
<span class="nc bnc" id="L285" title="All 2 branches missed.">					if (contact.isRecorded())</span>
<span class="nc" id="L286">						overLappingRecordedContactIDs.add(contact.getCallID());</span>
					else
<span class="nc" id="L288">						overLappingContactIDs.add(contact.getCallID());</span>
				}
			}
<span class="nc bnc" id="L291" title="All 2 branches missed.">			if (newContact != null){</span>
<span class="nc" id="L292">				newContact.setOverlappingContactIDs(overLappingContactIDs);</span>
<span class="nc" id="L293">				newContact.setOverlappingRecordedContactIDs(overLappingRecordedContactIDs);</span>
<span class="nc" id="L294">				newEventColl.add(newContact);</span>
			}
		}

<span class="nc" id="L298">		return newEventColl;</span>
	}
	
	public static java.util.Date toDateObj(String date, String format, TimeZone tz){
<span class="nc" id="L302">		java.util.Date dateToReturn = null;</span>
		try{
<span class="nc" id="L304">			SimpleDateFormat dateFormat = new SimpleDateFormat( format);</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">			if (tz != null)</span>
<span class="nc" id="L306">				dateFormat.setTimeZone(tz);</span>
<span class="nc" id="L307">			dateToReturn = dateFormat.parse(date);</span>
		}
<span class="nc" id="L309">		catch(ParseException pe){</span>
<span class="nc" id="L310">		}</span>
<span class="nc" id="L311">		return dateToReturn;</span>
	}

	private static boolean fallsWithin(AgentContact contact, Date start, Date end){
<span class="nc bnc" id="L315" title="All 2 branches missed.">		if (contact.getStartTime().equals(start) ||</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">				contact.getEndTime().equals(end) ||</span>
<span class="nc bnc" id="L317" title="All 4 branches missed.">				(start.before(contact.getStartTime()) &amp;&amp; contact.getStartTime().before(end)) ||</span>
<span class="nc bnc" id="L318" title="All 4 branches missed.">				(start.before(contact.getEndTime()) &amp;&amp; contact.getEndTime().before(end)) ||</span>
<span class="nc bnc" id="L319" title="All 4 branches missed.">				(contact.getStartTime().before(start) &amp;&amp; contact.getEndTime().after(end)))</span>
<span class="nc" id="L320">                    return true;</span>

<span class="nc" id="L322">        return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>