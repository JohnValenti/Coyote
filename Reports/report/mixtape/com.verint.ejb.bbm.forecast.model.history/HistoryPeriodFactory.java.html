<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>HistoryPeriodFactory.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.ejb.bbm.forecast.model.history</a> &gt; <span class="el_source">HistoryPeriodFactory.java</span></div><h1>HistoryPeriodFactory.java</h1><pre class="source lang-java linenums">/*
 * ï¿½ 2011-2012 Verint Systems, Inc.
 */
package com.verint.ejb.bbm.forecast.model.history;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;

import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.TimeContext;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.verint.ejb.bbm.forecast.ProfileComponentUtil;
import com.verint.ejb.bbm.forecast.model.ProfileComponent;
import com.verint.ejb.bbm.forecast.model.ProfileComponent.Type;
import com.bluepumpkin.ejb.bbm.time.TimeInterval;
import com.bluepumpkin.ejb.bbm.time.TimeIntervalAtTime;
import com.bluepumpkin.ejb.bbm.time.TimeUnits;

/**
 * HistoryPeriodFactory creates ProfileEntryHistoryPeriods.
 * There is currently only one method, which creates a ProfileEntryHistoryPeriod
 * from a ProfileComponent.
 */
public class HistoryPeriodFactory {
<span class="nc" id="L27">	private HistoryPeriodFactory() {}</span>
	
	/**
	 * Creates and returns a ProfileEntryHistoryPeriod based on the configuration of the given ProfileComponent.
	 */
	public static ProfileEntryHistoryPeriod createHistoryPeriodFromProfileComponent(ProfileComponent component,
			Date spWeekStartDate, TimeContext timeContext) {

<span class="nc bnc" id="L35" title="All 2 branches missed.">		if (component.isMonthly()) {</span>
<span class="nc" id="L36">			return createMonthlyHistoryPeriod(component, spWeekStartDate, timeContext);</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">		} else if (component.isCustomWeek()) {</span>
<span class="nc" id="L38">			return createCustomWeekHistoryPeriod(component, spWeekStartDate, timeContext);</span>
		} else {
			//Weekly period
<span class="nc" id="L41">			return createWeeklyHistoryPeriod(component, spWeekStartDate, timeContext);</span>
		}
	}

	private static MonthlyHistoryPeriod createMonthlyHistoryPeriod(ProfileComponent component, Date spWeekStartDate,
			TimeContext timeContext) {
<span class="nc" id="L47">		List&lt;TimeIntervalAtTime&gt; daysInPeriod = new ArrayList&lt;TimeIntervalAtTime&gt;();</span>
<span class="nc" id="L48">		TimeInterval dayInterval = new TimeInterval(TimeUnits.Day, 1, timeContext);</span>

<span class="nc bnc" id="L50" title="All 3 branches missed.">		switch(component.getType()) {</span>
			case Absolute:
<span class="nc bnc" id="L52" title="All 2 branches missed.">				for (Date customDate : component.getCustomDates()) {</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">					if (customDate == null) {</span>
<span class="nc" id="L54">						daysInPeriod.add(null);</span>
					} else {
						//Shift the date from day boundary GMT (which is how it is stored in the DB) to
						//day boundary of the timeContext's time zone
<span class="nc" id="L58">						LocalDate ld = new LocalDate(customDate, TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L59">						daysInPeriod.add(new TimeIntervalAtTime(ld.getTime(timeContext.getTimeZone()), dayInterval));</span>
					}
<span class="nc" id="L61">				}</span>
<span class="nc" id="L62">				return new MonthlyHistoryPeriod(daysInPeriod, spWeekStartDate,</span>
<span class="nc" id="L63">						component.getMonth(), component.getYear(), timeContext);</span>
			case Relative:
				//First calculate the date representing the number of months back from the SP week,
				//then find the days in the history period for that month
<span class="nc" id="L67">				Calendar c = Calendar.getInstance(timeContext.getTimeZone());</span>
<span class="nc" id="L68">				c.setTime(spWeekStartDate);</span>
<span class="nc" id="L69">				c.add(Calendar.MONTH, -ProfileComponentUtil.getRelativeOffset(component));</span>

<span class="nc" id="L71">				daysInPeriod = ProfileEntryHistoryPeriodUtil.getDayIntervalsForMonthHistoryPeriod(spWeekStartDate,</span>
<span class="nc" id="L72">						c.get(Calendar.MONTH) + 1, c.get(Calendar.YEAR), timeContext);</span>
<span class="nc" id="L73">				return new MonthlyHistoryPeriod(daysInPeriod, spWeekStartDate,</span>
<span class="nc" id="L74">						c.get(Calendar.MONTH) + 1, c.get(Calendar.YEAR), timeContext);</span>
			default:
<span class="nc" id="L76">				return null;</span>
		}
	}

	private static CustomWeekHistoryPeriod createCustomWeekHistoryPeriod(ProfileComponent component, Date spWeekStartDate,
			TimeContext timeContext) {
<span class="nc" id="L82">		List&lt;TimeIntervalAtTime&gt; daysInPeriod = new ArrayList&lt;TimeIntervalAtTime&gt;();</span>
<span class="nc" id="L83">		TimeInterval dayInterval = new TimeInterval(TimeUnits.Day, 1, timeContext);</span>

<span class="nc bnc" id="L85" title="All 2 branches missed.">		for (Date customDate : component.getCustomDates()) {</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">			if (customDate == null) {</span>
<span class="nc" id="L87">				daysInPeriod.add(null);</span>
			} else {
				//Shift the date from midnight GMT (which is how it is stored in the DB) to
				//the day boundary of the timeContext's time zone
<span class="nc" id="L91">				LocalDate ld = new LocalDate(customDate, TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L92">				ld.add(Calendar.MINUTE, timeContext.getDayBoundary());</span>
<span class="nc" id="L93">				daysInPeriod.add(new TimeIntervalAtTime(ld.getTime(timeContext.getTimeZone()), dayInterval));</span>
			}
<span class="nc" id="L95">		}</span>
<span class="nc" id="L96">		return new CustomWeekHistoryPeriod(daysInPeriod, spWeekStartDate, timeContext);</span>
	}

	private static WeeklyHistoryPeriod createWeeklyHistoryPeriod(ProfileComponent component, Date spWeekStartDate,
			TimeContext timeContext) {
<span class="nc" id="L101">		Calendar historyStartDate = getHistoryStartDateForWeeklyPeriod(component, spWeekStartDate, timeContext);</span>
<span class="nc" id="L102">		List&lt;TimeIntervalAtTime&gt; daysInPeriod = getDaysInPeriodForWeeklyHistory(historyStartDate, timeContext);</span>
<span class="nc" id="L103">		return new WeeklyHistoryPeriod(daysInPeriod, spWeekStartDate, timeContext);</span>
	}

	private static TimeInterval getDayInterval(TimeContext timeContext) {
<span class="nc" id="L107">		return new TimeInterval(TimeUnits.Day, 1, timeContext);</span>
	}

	private static Calendar getHistoryStartDateForWeeklyPeriod(ProfileComponent component, Date spWeekStartDate,
			TimeContext timeContext) {
<span class="nc" id="L112">		Date fullSpWeekStartDate = ProfileComponentUtil.findNearestStartOfWeekDateBehindSelectedDate(spWeekStartDate,</span>
				timeContext);
<span class="nc" id="L114">		Date historyWeekStartDate = ProfileComponentUtil.getDate(component, timeContext, fullSpWeekStartDate);</span>
<span class="nc" id="L115">		Calendar historyDate = Calendar.getInstance(timeContext.getTimeZone());</span>
<span class="nc" id="L116">		historyDate.setTime(historyWeekStartDate);</span>
		//Absolute profile components store the time component of their date fields at midnight.  This
		//needs to be adjusted to the day boundary of the campaign.
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (component.getType().equals(Type.Absolute)) {</span>
<span class="nc" id="L120">			historyDate.add(Calendar.MINUTE, timeContext.getDayBoundary());</span>

			//Special case where the history week begins on the first hour of a fall DST transition time
			//period.  Because SPs that begin on or in the middle of a fall DST transition DO NOT include
			//the first 1AM hour, they are pushed forward so that they begin on or after the 2nd 1AM hour.
			//Example:  SP day boundary is 1AM Sunday.  This SP starts on the 2nd (repeated) 1AM hour (in other
			//words, 08:00 GMT for a campaign set to the Pacific Time Zone).
			//Because of this, we need to make sure the history week also starts on or after the 2nd 1AM hour if it also
			//begins on a fall DST transition.
<span class="nc" id="L129">			Calendar dstTest = (Calendar)historyDate.clone();</span>
<span class="nc" id="L130">			dstTest.add(Calendar.MILLISECOND, timeContext.getTimeZone().getDSTSavings());</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">			if (timeContext.getTimeZone().inDaylightTime(historyDate.getTime())</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">					&amp;&amp; !timeContext.getTimeZone().inDaylightTime(dstTest.getTime())) {</span>
<span class="nc" id="L133">				historyDate.add(Calendar.MILLISECOND, timeContext.getTimeZone().getDSTSavings());</span>
			}
		}

<span class="nc" id="L137">		return historyDate;</span>
	}

	private static List&lt;TimeIntervalAtTime&gt; getDaysInPeriodForWeeklyHistory(Calendar historyStartDate,
			TimeContext timeContext) {
<span class="nc" id="L142">		List&lt;TimeIntervalAtTime&gt; daysInPeriod = new ArrayList&lt;TimeIntervalAtTime&gt;();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">		for (int i = 0; i &lt; 7; i++) {</span>
<span class="nc" id="L144">			daysInPeriod.add(new TimeIntervalAtTime(historyStartDate.getTime(), getDayInterval(timeContext)));</span>
<span class="nc" id="L145">			historyStartDate.add(Calendar.DATE, 1);</span>
		}
<span class="nc" id="L147">		return daysInPeriod;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>