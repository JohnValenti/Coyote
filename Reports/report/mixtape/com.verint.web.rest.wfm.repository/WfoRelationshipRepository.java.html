<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WfoRelationshipRepository.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.rest.wfm.repository</a> &gt; <span class="el_source">WfoRelationshipRepository.java</span></div><h1>WfoRelationshipRepository.java</h1><pre class="source lang-java linenums">package com.verint.web.rest.wfm.repository;


import com.verint.web.rest.wfm.entity.Entity;
import com.verint.web.rest.wfm.entity.RelatedEntityNotLoadedByDefault;
import com.verint.web.rest.wfm.exception.EntityNoSuchFieldException;
import com.verint.web.rest.wfm.util.IdUtil;
import io.katharsis.queryParams.QueryParams;
import io.katharsis.repository.annotations.*;
import io.katharsis.utils.PropertyUtils;
import org.slf4j.Logger;

import javax.ws.rs.container.ContainerRequestContext;
import java.io.Serializable;
import java.lang.reflect.Field;
import java.util.Collection;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;

/**
 * This class represents a JSON-API endpoint.  A relationship repository handles the actions that deal with relationships
 * between a parent entity and a child entity linked to the parent.
 *
 *
 * @param &lt;Tid&gt; - The type of the primary ID of the parent entity handled by this repository.
 * @param &lt;Uid&gt; - The type of the primary ID of the child entity handled by this repository.
 * @param &lt;T&gt; - The type of the parent Entity handled by this repository.
 * @param &lt;U&gt; - The type of the child Entity handled by this repository.
 */
<span class="nc" id="L31">public abstract class WfoRelationshipRepository&lt;Tid extends Serializable,</span>
		Uid extends Serializable, T extends Entity&lt;Tid&gt;, U extends Entity&lt;Uid&gt;&gt; {

	public abstract WfoResourceRepository&lt;Tid, T&gt; getParentRepository();
	public abstract WfoResourceRepository&lt;Uid, U&gt; getChildRepository();

	protected abstract Logger logger();

	/**
	 * Used in cases where the entity contains by default the ID(s) of the related child entities,
	 * but not the entities themselves.  In this case, we use this field to tell the repository where
	 * to grab the IDs so that we can look them up via their respective repositories.
	 */
	private String relatedFieldName;

	@JsonApiSetRelation
	public void setRelation(T parentEntity, Uid childId, String fieldName, ContainerRequestContext requestContext) {
		try {

<span class="nc bnc" id="L50" title="All 2 branches missed.">			if (isEntityLoadedByDefault(parentEntity, fieldName)) {</span>
<span class="nc" id="L51">				U childEntity = getChildRepository().findOne(childId, null, requestContext);</span>
<span class="nc" id="L52">				PropertyUtils.setProperty(parentEntity, fieldName, childEntity);</span>
<span class="nc" id="L53">			} else {</span>
<span class="nc" id="L54">				PropertyUtils.setProperty(parentEntity, getFieldNameForLookup(parentEntity, fieldName), childId);</span>
			}
<span class="nc" id="L56">		} catch (NoSuchFieldException e) {</span>
<span class="nc" id="L57">			throw handleNoSuchFieldException(parentEntity.getClass().getSimpleName(), fieldName,</span>
<span class="nc" id="L58">					IdUtil.toString(parentEntity.getID()), e);</span>
<span class="nc" id="L59">		}</span>
<span class="nc" id="L60">		getParentRepository().save(parentEntity, requestContext);</span>
<span class="nc" id="L61">	}</span>

	@JsonApiSetRelations
	public void setRelations(T parentEntity, Iterable&lt;Uid&gt; childIds, String fieldName,
			ContainerRequestContext requestContext) {
		try {
<span class="nc bnc" id="L67" title="All 2 branches missed.">			if (isEntityLoadedByDefault(parentEntity, fieldName)) {</span>
<span class="nc" id="L68">				Iterable&lt;U&gt; seas = getChildRepository().findAll(childIds, null, requestContext);</span>
<span class="nc" id="L69">				PropertyUtils.setProperty(parentEntity, fieldName, seas);</span>
<span class="nc" id="L70">			} else {</span>
<span class="nc" id="L71">				PropertyUtils.setProperty(parentEntity, getFieldNameForLookup(parentEntity, fieldName), childIds);</span>
			}
<span class="nc" id="L73">		} catch (NoSuchFieldException e) {</span>
<span class="nc" id="L74">			throw handleNoSuchFieldException(parentEntity.getClass().getSimpleName(), fieldName,</span>
<span class="nc" id="L75">					IdUtil.toString(parentEntity.getID()), e);</span>
<span class="nc" id="L76">		}</span>
<span class="nc" id="L77">		getParentRepository().save(parentEntity, requestContext);</span>
<span class="nc" id="L78">	}</span>

	@JsonApiAddRelations
	public void addRelations(T parentEntity, Iterable&lt;Uid&gt; childIds, String fieldName,
			ContainerRequestContext requestContext) {
		try {
<span class="nc bnc" id="L84" title="All 2 branches missed.">			if (isEntityLoadedByDefault(parentEntity, fieldName)) {</span>
<span class="nc" id="L85">				List&lt;U&gt; newChildEntityList = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L86">				Iterable&lt;U&gt; entitiesToAdd = getChildRepository().findAll(childIds, null, requestContext);</span>

<span class="nc" id="L88">				Iterable&lt;U&gt; childEntities = (Iterable&lt;U&gt;)PropertyUtils.getProperty(parentEntity, fieldName);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">				if (childEntities != null) {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">					for (U childEntity : childEntities) {</span>
<span class="nc" id="L91">						Uid childEntityID = childEntity.getID();</span>
<span class="nc" id="L92">						boolean isP = false;</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">						for (U entityToAdd : entitiesToAdd) {</span>
<span class="nc" id="L94">							Uid entityID = entityToAdd.getID();</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">							if (entityID.equals(childEntityID)) {</span>
<span class="nc" id="L96">								isP = true;</span>
<span class="nc" id="L97">								break;</span>
							}
<span class="nc" id="L99">						}</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">						if (!isP) {</span>
<span class="nc" id="L101">							newChildEntityList.add(childEntity);</span>
						}
<span class="nc" id="L103">					}</span>
				}
<span class="nc" id="L105">				PropertyUtils.setProperty(parentEntity, fieldName, newChildEntityList);</span>
<span class="nc" id="L106">			} else {</span>
<span class="nc" id="L107">				List&lt;Uid&gt; newChildEntityIdList = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L108">				Iterable&lt;Uid&gt; childEntityIds = (Iterable&lt;Uid&gt;)PropertyUtils.getProperty(parentEntity,</span>
<span class="nc" id="L109">						getFieldNameForLookup(parentEntity, fieldName));</span>
<span class="nc" id="L110">				childIds.forEach(newChildEntityIdList::add);</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">				if (childEntityIds != null) {</span>
<span class="nc" id="L113">					childEntityIds.forEach(newChildEntityIdList::add);</span>
				}
<span class="nc" id="L115">				PropertyUtils.setProperty(parentEntity, fieldName, newChildEntityIdList);</span>
			}
<span class="nc" id="L117">		} catch (NoSuchFieldException e) {</span>
<span class="nc" id="L118">			throw handleNoSuchFieldException(parentEntity.getClass().getSimpleName(), fieldName,</span>
<span class="nc" id="L119">					IdUtil.toString(parentEntity.getID()), e);</span>
<span class="nc" id="L120">		}</span>
<span class="nc" id="L121">		getParentRepository().save(parentEntity, requestContext);</span>
<span class="nc" id="L122">	}</span>

	@JsonApiRemoveRelations
	public void removeRelations(T parentEntity, Iterable&lt;Uid&gt; childIds, String fieldName,
			ContainerRequestContext requestContext) {
		try {
<span class="nc bnc" id="L128" title="All 2 branches missed.">			if (isEntityLoadedByDefault(parentEntity, fieldName)) {</span>
<span class="nc" id="L129">				Iterable&lt;U&gt; childEntities = (Iterable&lt;U&gt;)PropertyUtils.getProperty(parentEntity, fieldName);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">				if (childEntities != null) {</span>
<span class="nc" id="L131">					Iterator&lt;U&gt; iterator = childEntities.iterator();</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">					while (iterator.hasNext()) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">						for (Uid childIdToRemove : childIds) {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">							if (iterator.next().getID().equals(childIdToRemove)) {</span>
<span class="nc" id="L135">								iterator.remove();</span>
<span class="nc" id="L136">								break;</span>
							}
<span class="nc" id="L138">						}</span>
					}
<span class="nc" id="L140">					List&lt;U&gt; newChildList = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L141">					childEntities.forEach(newChildList::add);</span>

<span class="nc" id="L143">					PropertyUtils.setProperty(parentEntity, fieldName, newChildList);</span>
<span class="nc" id="L144">					getParentRepository().save(parentEntity, requestContext);</span>
				}
<span class="nc" id="L146">			} else {</span>
<span class="nc" id="L147">				Collection&lt;Uid&gt; childEntityIds = (Collection&lt;Uid&gt;)PropertyUtils.getProperty(parentEntity,</span>
<span class="nc" id="L148">						getFieldNameForLookup(parentEntity, fieldName));</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">				if (childEntityIds != null) {</span>
<span class="nc" id="L150">					Iterator&lt;Uid&gt; iterator = childEntityIds.iterator();</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">					while (iterator.hasNext()) {</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">						for (Uid childIdToRemove : childIds) {</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">							if (iterator.next().equals(childIdToRemove)) {</span>
<span class="nc" id="L154">								iterator.remove();</span>
<span class="nc" id="L155">								break;</span>
							}
<span class="nc" id="L157">						}</span>
					}
<span class="nc" id="L159">					List&lt;Uid&gt; newChildIdList = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L160">					childEntityIds.forEach(newChildIdList::add);</span>

<span class="nc" id="L162">					PropertyUtils.setProperty(parentEntity, getFieldNameForLookup(parentEntity, fieldName), newChildIdList);</span>
<span class="nc" id="L163">					getParentRepository().save(parentEntity, requestContext);</span>
				}
			}

<span class="nc" id="L167">		} catch (NoSuchFieldException e) {</span>
<span class="nc" id="L168">			throw handleNoSuchFieldException(parentEntity.getClass().getSimpleName(), fieldName,</span>
<span class="nc" id="L169">					IdUtil.toString(parentEntity.getID()), e);</span>
<span class="nc" id="L170">		}</span>
<span class="nc" id="L171">	}</span>

	@JsonApiFindOneTarget
	public U findOneTarget(Tid parentId, String fieldName, QueryParams requestParams,
			ContainerRequestContext requestContext) {
<span class="nc" id="L176">		T parentEntity = getParentRepository().findOne(parentId, requestParams, requestContext);</span>
		try {
<span class="nc" id="L178">			return getChild(parentEntity, fieldName, requestParams, requestContext);</span>
<span class="nc" id="L179">		} catch (NoSuchFieldException e) {</span>
<span class="nc" id="L180">			throw handleNoSuchFieldException(parentEntity.getClass().getSimpleName(), fieldName,</span>
<span class="nc" id="L181">					IdUtil.toString(parentEntity.getID()), e);</span>
		}
	}

	@JsonApiFindManyTargets
	public Iterable&lt;U&gt; findManyTargets(Tid parentId, String fieldName, QueryParams requestParams,
			ContainerRequestContext requestContext) {
<span class="nc" id="L188">		T parentEntity = getParentRepository().findOne(parentId, requestParams, requestContext);</span>
		try {
<span class="nc" id="L190">			return getChildren(parentEntity, fieldName, requestParams, requestContext);</span>
<span class="nc" id="L191">		} catch (NoSuchFieldException e) {</span>
<span class="nc" id="L192">			throw handleNoSuchFieldException(parentEntity.getClass().getSimpleName(), fieldName,</span>
<span class="nc" id="L193">					IdUtil.toString(parentEntity.getID()), e);</span>
		}
	}

	/**
	 * Returns a single child entity linked to the given parentEntity.  If the child object is contained
	 * on the parent entity by default, this will be returned.  Otherwise, the ID of the child object will be used
	 * and sent to the child's resource WfoResourceRepository for lookup.
	 */
	protected U getChild(T parentEntity, String fieldName, QueryParams requestParams,
			ContainerRequestContext requestContext) throws NoSuchFieldException {
<span class="nc" id="L204">		String fieldLookupName = getFieldNameForLookup(parentEntity, fieldName);</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">		if (fieldName.equals(fieldLookupName)) {</span>
<span class="nc" id="L207">			return (U) PropertyUtils.getProperty(parentEntity, fieldName);</span>
		} else {
<span class="nc" id="L209">			return getChildRepository().findOne((Uid) PropertyUtils.getProperty(parentEntity, fieldLookupName),</span>
					requestParams, requestContext);
		}
	}

	/**
	 * Returns an Iterable of child entities linked to the given parentEntity.  If the child objects are contained
	 * on the parent entity by default, these will be returned.  Otherwise, the IDs of the child objects will be used
	 * and sent to the child's resource WfoResourceRepository for lookup.
	 */
	protected Iterable&lt;U&gt; getChildren(T parentEntity, String fieldName, QueryParams requestParams,
			ContainerRequestContext requestContext)
			throws NoSuchFieldException {
<span class="nc" id="L222">		String fieldLookupName = getFieldNameForLookup(parentEntity, fieldName);</span>

<span class="nc bnc" id="L224" title="All 2 branches missed.">		if (fieldName.equals(fieldLookupName)) {</span>
<span class="nc" id="L225">			return (Iterable&lt;U&gt;) PropertyUtils.getProperty(parentEntity, fieldName);</span>
		} else {
<span class="nc" id="L227">			return getChildRepository().findAll((Iterable&lt;Uid&gt;) PropertyUtils.getProperty(parentEntity, fieldLookupName),</span>
					requestParams, requestContext);
		}
	}

	/**
	 * If the parent entity contains only the ID (or IDs) of the child object by default,
	 * then we need to look up the related ID field so we can grab the child entity ID and use that to load
	 * the full child entity.
	 * @param parentEntity - The entity
	 * @param fieldName - The name of the field on the parent entity corresponding to the full child entity object
	 * @return - If fieldName is annotated with {@link com.verint.web.rest.wfm.entity.RelatedEntityNotLoadedByDefault},
	 * then returns the ID field corresponding to this fieldName.  Otherwise, returns fieldName.
	 * @throws NoSuchFieldException
	 */
	private String getFieldNameForLookup(T parentEntity, String fieldName) throws NoSuchFieldException {
<span class="nc bnc" id="L243" title="All 2 branches missed.">		if (relatedFieldName == null) {</span>
<span class="nc" id="L244">			Field field = parentEntity.getClass().getDeclaredField(fieldName);</span>
<span class="nc" id="L245">			RelatedEntityNotLoadedByDefault annotation = field.getDeclaredAnnotation(RelatedEntityNotLoadedByDefault.class);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">			if (annotation == null) {</span>
<span class="nc" id="L247">				relatedFieldName = fieldName;</span>
			} else {
<span class="nc" id="L249">				relatedFieldName = annotation.relatedIdFieldName();</span>
			}
		}

<span class="nc" id="L253">		return relatedFieldName;</span>
	}

	private boolean isEntityLoadedByDefault(T parentEntity, String fieldName) throws NoSuchFieldException {
<span class="nc" id="L257">		return fieldName.equals(getFieldNameForLookup(parentEntity, fieldName));</span>
	}

	protected EntityNoSuchFieldException handleNoSuchFieldException(String entityName, String fieldName, String id,
			NoSuchFieldException e) {
<span class="nc" id="L262">		logger().error(&quot;NoSuchFieldException was thrown for entity: &quot; + entityName + &quot; with ID: &quot; + id +</span>
				&quot; for fieldName: &quot; + fieldName, e);
<span class="nc" id="L264">		return new EntityNoSuchFieldException(entityName, fieldName, id);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>