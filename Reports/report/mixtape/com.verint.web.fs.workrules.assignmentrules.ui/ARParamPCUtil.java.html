<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ARParamPCUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignmentrules.ui</a> &gt; <span class="el_source">ARParamPCUtil.java</span></div><h1>ARParamPCUtil.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignmentrules.ui;

import com.bluepumpkin.common.base.BPException;
import com.bluepumpkin.common.datatypes.*;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftSortField;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler.ActivitySelectionProperty;
import com.bluepumpkin.web.core.pagecomponent.DropDownSelectionPC;
import com.verint.web.fs.widgets.ActivitySelectorDDPC;
import com.verint.web.fs.widgets.IntegerDropDownSelection;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.verint.web.fs.workrules.assignmentrules.*;
import com.verint.web.fs.workrules.assignmentrules.question.DefaultQuestionDataProvider;
import com.verint.web.fs.workrules.assignmentrules.question.Question;
import com.verint.web.fs.workrules.assignmentrules.question.QuestionFactory;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.TimePickerPC;
import com.witness.web.uif.system.RequestContext;

import javax.servlet.http.HttpServletRequest;
import java.rmi.RemoteException;
import java.util.*;

/**
 * This class helps deal with PageComponents representing parameter values.
 * &lt;p&gt;
 * It has utility functions for getting a PageComponent representing a parameter
 * and also for getting a submitted parameter value from the request.
 */
<span class="nc" id="L44">public class ARParamPCUtil {</span>
	/**
	 * Retrieves a PageComponent used to provide the value for a response parameter
	 *
	 * @param context
	 * @param orgID
	 * @param question
	 * @param response
	 * @param param
	 * @return
	 * @throws BbmException
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static PageComponent getPageComponent(RequestContext context, ID orgID, Question question,
			Response response, ResponseParam param) throws BbmException {
		try {
<span class="pc bpc" id="L60" title="2 of 7 branches missed.">			switch (param.getParameterType()) {</span>
				case Integer:
<span class="fc" id="L62">					Integer min = 0;</span>
<span class="fc" id="L63">					Integer max = 10000;</span>
<span class="fc" id="L64">					Iterator&lt;ResponseParamConstraint&gt; iter = param.getConstraints().iterator();</span>
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">					if (iter.hasNext()) {</span>
<span class="fc" id="L66">						IntegerConstraint constraint = (IntegerConstraint) iter.next();</span>
<span class="fc" id="L67">						min = constraint.getMinVal();</span>
<span class="fc" id="L68">						max = constraint.getMaxVal();</span>
					}
<span class="fc" id="L70">					long spread = ((long) max) - min;</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">					if (spread &lt;= 100) {</span>
<span class="fc" id="L72">						IntegerDropDownSelection pc = new IntegerDropDownSelection(context, getName(response, param), min, max);</span>
<span class="fc" id="L73">						pc.setSelectedID(&quot;&quot; + param.getValue());</span>
<span class="fc" id="L74">						return pc;</span>
					} else {
						@SuppressWarnings(&quot;serial&quot;)
<span class="fc" id="L77">						FormInputPC integerInput = new FormInputPC(context) {</span>
							/**
							 * Overridden to disallow the extract params to overwrite the value with a null.
							 */
							@Override
							public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L83">								String oldVal = getInputValue();</span>
<span class="fc" id="L84">								boolean retVal = super.extractParameters(request);</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">								if (getInputValue() == null) {</span>
<span class="fc" id="L86">									setInputValue(oldVal);</span>
								}
<span class="fc" id="L88">								return retVal;</span>
							}

						};
<span class="fc" id="L92">						integerInput.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L93">						integerInput.setName(getName(response, param));</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">						integerInput.reset(getName(response, param) + &quot;__inputVal&quot;, param.getValue() == null ? &quot;1&quot; : param</span>
<span class="fc" id="L95">								.getValue()</span>
<span class="fc" id="L96">								.toString(), FormInputPC.TYPE_INTEGER, true);</span>
<span class="fc" id="L97">						integerInput.setLowerLimit(min);</span>
<span class="fc" id="L98">						integerInput.setUpperLimit(max);</span>
<span class="fc" id="L99">						return integerInput;</span>
					}
				case DayOfWeek:
<span class="fc" id="L102">					DropDownSelectionPC&lt;DayOfWeek&gt; dowPC = new DropDownSelectionPC&lt;DayOfWeek&gt;(context, getName(response, param));</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">					for (DayOfWeek dow : DayOfWeek.values()) {</span>
<span class="fc" id="L104">						addDayOfWeekDDOption(context.getLocalizer(), dowPC, dow);</span>
					}
<span class="fc" id="L106">					dowPC.setSelectedID(&quot;&quot; + param.getValue());</span>
<span class="fc" id="L107">					return dowPC;</span>
				case Shift: {
					@SuppressWarnings(&quot;rawtypes&quot;)
<span class="fc" id="L110">					LinkedHashMap&lt;DBSortField, Comparator&gt; sortComparators = new LinkedHashMap&lt;DBSortField, Comparator&gt;();</span>
<span class="fc" id="L111">					sortComparators.put(ShiftSortField.NAME, null);</span>
<span class="fc" id="L112">					Map&lt;ID, String&gt; shiftData = WorkRulesModelHandler.getShiftIDNameListByOrg(context, orgID);</span>
<span class="fc" id="L113">					shiftData = ValueObjectUtil.sortByValue(shiftData);</span>
<span class="fc" id="L114">					DropDownSelectionPC&lt;Shift&gt; shiftPC = new DropDownSelectionPC&lt;Shift&gt;(context, getName(response, param));</span>
<span class="fc" id="L115">					ID selectedID = null;</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">					if (param.getValue() != null) {</span>
<span class="fc" id="L117">						selectedID = ((Shift) param.getValue()).getID();</span>
					}
<span class="fc bfc" id="L119" title="All 2 branches covered.">					for (Map.Entry&lt;ID,String&gt; shiftIDName : shiftData.entrySet()) {</span>
<span class="fc" id="L120">						shiftPC.addOption(shiftIDName.getKey().toString(), shiftIDName.getValue(), null, shiftIDName.getKey().equals(selectedID));</span>
<span class="fc" id="L121">					}</span>
<span class="fc" id="L122">					return shiftPC;</span>
				}
				case Activities: {
<span class="fc" id="L125">					Collection&lt;Activity&gt; activities =</span>
<span class="fc" id="L126">							ActivityModelHandler.getActivitiesByActivitySelectionType(context, ActivitySelectionProperty.UsedInShiftEvent,</span>
<span class="fc" id="L127">									Collections.singletonList(orgID));</span>
<span class="fc" id="L128">					ActivitySelectorDDPC activityPC = new ActivitySelectorDDPC(</span>
							context,
<span class="fc" id="L130">							getName(response, param),</span>
							activities);
<span class="fc" id="L132">					activityPC.setMultiSelect(true);</span>
<span class="fc" id="L133">					HashSet&lt;String&gt; selectedIDs = new HashSet&lt;String&gt;();</span>
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">					if (param.getValue() != null) {</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">						for (Activity activity : (List&lt;Activity&gt;) param.getValue()) {</span>
<span class="fc" id="L136">							selectedIDs.add(activity.getID().toString());</span>
<span class="fc" id="L137">						}</span>
					}
<span class="fc" id="L139">					activityPC.setSelectedIDs(selectedIDs);</span>
<span class="fc" id="L140">					return activityPC;</span>
				}
				case Date: {
<span class="fc" id="L143">					DatePickerPC datePicker = new DatePickerPC(context, getName(response, param) + &quot;__INPUT_FN&quot;) {</span>
						/**
						 * Perform Extract parameter
						 */
						public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L148">							LocalDate initial = super.getLocalDate();</span>
<span class="fc" id="L149">							boolean isSuccess = super.extractParameters(request);</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">							if (getLocalDate() == null) {</span>
<span class="fc" id="L151">								setDate(initial);</span>
							}
<span class="fc" id="L153">							return isSuccess;</span>
						}
					};

					// Normally, we would probably pick the org time zone, but in the case of Assignment Rules start dates, it is stored in the database in a weird way.
					// The &quot;day of the year&quot; is stored as a DATETIME as midnight in the GMT time zone.
<span class="fc" id="L159">					datePicker.setTimeZone(TimeZoneUtil.GMT_TIMEZONE);</span>

<span class="fc" id="L161">					LocalDate val = (LocalDate) param.getValue();</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">					if (val != null) {</span>
<span class="fc" id="L163">						datePicker.setDate(val);</span>
					}
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">					if (param.getConstraints().size() &gt; 0) {</span>
<span class="fc" id="L166">						DayOfWeekConstraint dowC = (DayOfWeekConstraint) param.getConstraints().iterator().next();</span>
<span class="fc" id="L167">						datePicker.setFirstDayOfWeek(dowC.getDayOfWeek().getCalendarConstant());</span>
<span class="fc" id="L168">						List&lt;Integer&gt; disabledDays = new ArrayList&lt;Integer&gt;();</span>
<span class="fc" id="L169">						disabledDays.add(Calendar.SUNDAY);</span>
<span class="fc" id="L170">						disabledDays.add(Calendar.MONDAY);</span>
<span class="fc" id="L171">						disabledDays.add(Calendar.TUESDAY);</span>
<span class="fc" id="L172">						disabledDays.add(Calendar.WEDNESDAY);</span>
<span class="fc" id="L173">						disabledDays.add(Calendar.THURSDAY);</span>
<span class="fc" id="L174">						disabledDays.add(Calendar.FRIDAY);</span>
<span class="fc" id="L175">						disabledDays.add(Calendar.SATURDAY);</span>
<span class="fc" id="L176">						disabledDays.remove(Integer.valueOf(dowC.getDayOfWeek().getCalendarConstant()));</span>
<span class="fc" id="L177">						int[] disabledDaysArr = new int[disabledDays.size()];</span>
<span class="fc" id="L178">						int index = 0;</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">						for (int dayConstant : disabledDays) {</span>
<span class="fc" id="L180">							disabledDaysArr[index++] = dayConstant;</span>
<span class="fc" id="L181">						}</span>
<span class="fc" id="L182">						datePicker.setDisabledDays(disabledDaysArr);</span>
					}
<span class="fc" id="L184">					return datePicker;</span>
				}
				case TimeOfDay: {
<span class="nc" id="L187">					TimePickerPC timePicker = new TimePickerPC(context, getName(response, param) + &quot;__INPUT_FN&quot;, false);</span>
<span class="nc" id="L188">					TimeOfDay val = (TimeOfDay) param.getValue();</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">					if (val != null) {</span>
<span class="nc" id="L190">						timePicker.setTime(0, val.getMinutesSinceMindnight(), 0);</span>
					}
<span class="nc" id="L192">					return timePicker;</span>
				}
				default:
<span class="nc" id="L195">					throw new IllegalArgumentException(&quot;Unexpected response param type of &quot; + param.getParameterType());</span>
			}
<span class="nc" id="L197">		} catch (RemoteException e) {</span>
<span class="nc" id="L198">			throw new BbmException(e);</span>
		}
	}

	/**
	 * Retrives the parameter value from the HttpServletRequest contained in the given request context.
	 *
	 * @param context
	 * @param orgID
	 * @param question
	 * @param response
	 * @param param
	 * @return Object representing the value of the parameter. The type is specified in the ResponseParamType enum. The ResponseParamType is retrieved through the ResponseParam.getParameterType method
	 * @throws BbmException
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static Object getParameterValue(RequestContext context, ID orgID, Question question, Response response,
			ResponseParam param) throws BbmException {
<span class="fc" id="L216">		PageComponent pc = getPageComponent(context, orgID, question, response, param);</span>
<span class="fc" id="L217">		pc.extractParameters(context.getRequest());</span>
<span class="pc bpc" id="L218" title="2 of 7 branches missed.">		switch (param.getParameterType()) {</span>
			case Integer:
<span class="fc bfc" id="L220" title="All 2 branches covered.">				if (pc instanceof IntegerDropDownSelection) {</span>
<span class="fc" id="L221">					return ((IntegerDropDownSelection) pc).getSelection();</span>
				} else {
					// pc instanceof FormInputPC
<span class="fc" id="L224">					String inputVal = ((FormInputPC) pc).getInputValue();</span>
<span class="pc bpc" id="L225" title="2 of 4 branches missed.">					if (!StringUtil.isEmpty(inputVal) &amp;&amp; !&quot;null&quot;.equals(inputVal)) {</span>
<span class="fc" id="L226">						return Integer.parseInt(inputVal);</span>
					} else {
<span class="nc" id="L228">						return 0;</span>
					}
				}
			case DayOfWeek:
<span class="fc" id="L232">				return ((DropDownSelectionPC&lt;DayOfWeek&gt;) pc).getSelection();</span>
			case Shift:
<span class="fc" id="L234">				Collection&lt;String&gt; selectedIDs = ((DropDownSelectionPC&lt;Shift&gt;) pc).getSelectedIDs();</span>
<span class="pc bpc" id="L235" title="1 of 4 branches missed.">				if ( selectedIDs == null || selectedIDs.isEmpty()) {</span>
<span class="fc" id="L236">					return null;</span>
				}
<span class="fc" id="L238">				return WorkRulesModelHandler.getShift(context, ID.fromIntStr(selectedIDs.iterator().next()));</span>
			case Activities:
<span class="fc" id="L240">				return ((ActivitySelectorDDPC) pc).getSelections();</span>
			case Date:
<span class="fc" id="L242">				LocalDate date = ((DatePickerPC) pc).getLocalDate();</span>
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">				if (date != null) {</span>
<span class="fc" id="L244">					date.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="fc" id="L245">					date.set(Calendar.MINUTE, 0);</span>
<span class="fc" id="L246">					date.set(Calendar.SECOND, 0);</span>
<span class="fc" id="L247">					date.set(Calendar.MILLISECOND, 0);</span>
				}
<span class="fc" id="L249">				return date;</span>
			case TimeOfDay:
<span class="nc" id="L251">				return new TimeOfDay(((TimePickerPC) pc).getTimeInMinutes());</span>
			default:
<span class="nc" id="L253">				throw new IllegalArgumentException(&quot;Unexpected response param type of &quot; + param.getParameterType());</span>
		}
	}

	private static void addDayOfWeekDDOption(Localizer localizer, DropDownSelectionPC&lt;DayOfWeek&gt; dowPC, DayOfWeek dow) {
<span class="fc bfc" id="L258" title="All 2 branches covered.">		if (dow == DayOfWeek.Sunday) {</span>
<span class="fc" id="L259">			dowPC.addOption(</span>
<span class="fc" id="L260">					DayOfWeek.Sunday.name(),</span>
<span class="fc" id="L261">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.SUNDAY),</span>
					DayOfWeek.Sunday,
					false);
		}
<span class="fc bfc" id="L265" title="All 2 branches covered.">		if (dow == DayOfWeek.Monday) {</span>
<span class="fc" id="L266">			dowPC.addOption(</span>
<span class="fc" id="L267">					DayOfWeek.Monday.name(),</span>
<span class="fc" id="L268">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.MONDAY),</span>
					DayOfWeek.Monday,
					false);
		}
<span class="fc bfc" id="L272" title="All 2 branches covered.">		if (dow == DayOfWeek.Tuesday) {</span>
<span class="fc" id="L273">			dowPC.addOption(</span>
<span class="fc" id="L274">					DayOfWeek.Tuesday.name(),</span>
<span class="fc" id="L275">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.TUESDAY),</span>
					DayOfWeek.Tuesday,
					false);
		}
<span class="fc bfc" id="L279" title="All 2 branches covered.">		if (dow == DayOfWeek.Wednesday) {</span>
<span class="fc" id="L280">			dowPC.addOption(</span>
<span class="fc" id="L281">					DayOfWeek.Wednesday.name(),</span>
<span class="fc" id="L282">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.WEDNESDAY),</span>
					DayOfWeek.Wednesday,
					false);
		}
<span class="fc bfc" id="L286" title="All 2 branches covered.">		if (dow == DayOfWeek.Thursday) {</span>
<span class="fc" id="L287">			dowPC.addOption(</span>
<span class="fc" id="L288">					DayOfWeek.Thursday.name(),</span>
<span class="fc" id="L289">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.THURSDAY),</span>
					DayOfWeek.Thursday,
					false);
		}
<span class="fc bfc" id="L293" title="All 2 branches covered.">		if (dow == DayOfWeek.Friday) {</span>
<span class="fc" id="L294">			dowPC.addOption(</span>
<span class="fc" id="L295">					DayOfWeek.Friday.name(),</span>
<span class="fc" id="L296">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.FRIDAY),</span>
					DayOfWeek.Friday,
					false);
		}
<span class="fc bfc" id="L300" title="All 2 branches covered.">		if (dow == DayOfWeek.Saturday) {</span>
<span class="fc" id="L301">			dowPC.addOption(</span>
<span class="fc" id="L302">					DayOfWeek.Saturday.name(),</span>
<span class="fc" id="L303">					localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.SATURDAY),</span>
					DayOfWeek.Saturday,
					false);
		}
<span class="fc" id="L307">	}</span>

	private static String getName(Response response, ResponseParam param) {
<span class="fc" id="L310">		int count = -1;</span>
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">		for (ResponseParam r : response.getResponseParameters()) {</span>
<span class="fc" id="L312">			count++;</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">			if (r == param) {</span>
<span class="fc" id="L314">				break;</span>
			}
<span class="fc" id="L316">		}</span>
<span class="fc" id="L317">		response.getResponseParameters().indexOf(param);</span>
<span class="fc" id="L318">		return response.getQuestionType().name() + &quot;_&quot; + response.getResponseType().toString() + &quot;_&quot;</span>
<span class="fc" id="L319">				+ param.getParameterType().name() + &quot;_&quot; + count;</span>
	}

	/**
	 * Returns the localized value of the response parameter.  In the form page, the response parameters
	 * are generally rendered as page components (input fields, date pickers, etc.) but on the list page
	 * the string representations of these values are concatenated with the responses to build a
	 * sentence-like description of the work rule.
	 */
	public static String getLocalizedParameterValue(Localizer localizer, ResponseParam param) {
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">		if (param.getValue() == null) {</span>
<span class="nc" id="L330">			return &quot;&quot;;</span>
		}
<span class="pc bpc" id="L332" title="5 of 7 branches missed.">		switch (param.getParameterType()) {</span>
			case Integer:
<span class="fc" id="L334">				return localizer.formatNumber((Integer) param.getValue(), 0);</span>
			case DayOfWeek:
<span class="nc" id="L336">				return localizer.getWeekdayName((DayOfWeek) param.getValue(), true);</span>
			case Shift: {
<span class="nc" id="L338">				return ((Shift) param.getValue()).getName();</span>
			}
			case Activities: {
<span class="nc" id="L341">				StringBuffer activityList = new StringBuffer();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">				for (Activity activity : (List&lt;Activity&gt;) param.getValue()) {</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">					if (activityList.length() &gt; 0) {</span>
<span class="nc" id="L344">						activityList.append(&quot;, &quot;);</span>
					}
<span class="nc" id="L346">					activityList.append(activity.getName());</span>
<span class="nc" id="L347">				}</span>
<span class="nc" id="L348">				return activityList.toString();</span>
			}
			case Date: {
<span class="fc" id="L351">				return localizer.formatDate((LocalDate) param.getValue(), RegionalFormatBundleKey.MEDIUM_DATE_FORMAT);</span>
			}
			case TimeOfDay: {
<span class="nc" id="L354">				return localizer.formatTimeInMins(((TimeOfDay) param.getValue()).getMinutesSinceMindnight());</span>
			}
			default:
<span class="nc" id="L357">				throw new IllegalArgumentException(&quot;Unexpected response param type of &quot; + param.getParameterType());</span>
		}
	}

	/**
	 * Builds a sentence-like description for each of the given assignment rules and returns these descriptions in a map
	 * (this map is keyed on assignment rule ID).
	 */
	public static Map&lt;ID, String&gt; buildAssignmentRuleDescriptions(RequestContext context, Map&lt;ID, Organization&gt; orgMap,
			Collection&lt;ComplexWorkRule&gt; assignmentRules) throws BPException {

<span class="fc" id="L368">		HashMap&lt;ID, String&gt; retVal = new HashMap&lt;ID, String&gt;();</span>

		//Go through each rule and build the description for it
<span class="fc" id="L371">		Map&lt;ID, Map&lt;ID, String&gt;&gt; shiftIDMap = new HashMap&lt;ID, Map&lt;ID, String&gt;&gt;();</span>
		Map&lt;ID, String&gt; shiftIDMapPerOrg;
		ID orgID;
<span class="fc bfc" id="L374" title="All 2 branches covered.">		for (ComplexWorkRule cwr : assignmentRules) {</span>
<span class="fc" id="L375">			orgID = cwr.getOrganizationID();</span>
<span class="fc" id="L376">			shiftIDMapPerOrg = shiftIDMap.get(orgID);</span>
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">			if (shiftIDMapPerOrg == null) {</span>
<span class="fc" id="L378">				Map&lt;ID, String&gt; shiftIDNames = WorkRulesModelHandler.getShiftIDNameListByOrg(context, orgID);</span>
<span class="fc" id="L379">				shiftIDMap.put(orgID, shiftIDNames);</span>
			}
<span class="fc" id="L381">			DefaultQuestionDataProvider provider = new DefaultQuestionDataProvider(context, orgMap.get(orgID), cwr, shiftIDMapPerOrg);</span>
<span class="fc" id="L382">			StringBuffer description = new StringBuffer();</span>

			//For each rule, go through each question and build the description from the response/response parameters.
<span class="fc" id="L385">			Question question = QuestionFactory.getNextQuestion(provider);</span>
<span class="fc" id="L386">			int questionCount = 0;</span>
<span class="pc bpc" id="L387" title="1 of 4 branches missed.">			while (question != null &amp;&amp; question.getInitialAnswer() != null) {</span>
<span class="fc bfc" id="L388" title="All 2 branches covered.">				if (description.length() &gt; 0) {</span>
<span class="fc" id="L389">					description.append(&quot; &quot;);</span>
				}
<span class="fc" id="L391">				provider.setAnswer(question.getQuestionType(), question.getInitialAnswer());</span>


<span class="fc" id="L394">				QuestionI18N i18n = QuestionI18NFactory.getI18NInfo(question.getQuestionType());</span>

<span class="fc" id="L396">				Response answerToSelect = question.getInitialAnswer();</span>
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">				for (Response response : question.getResponses()) {</span>
					// Get the values of the response parameters for the answer
<span class="fc bfc" id="L399" title="All 2 branches covered.">					if (response.equals(answerToSelect)) {</span>
<span class="fc" id="L400">						List&lt;String&gt; paramValues = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L401" title="All 2 branches covered.">						for (ResponseParam param : response.getResponseParameters()) {</span>
<span class="fc" id="L402">							paramValues.add(ARParamPCUtil.getLocalizedParameterValue(context.getLocalizer(), param));</span>
<span class="fc" id="L403">						}</span>
<span class="fc" id="L404">						description.append(i18n.getResponseText(context.getLocalizer(), response, paramValues.toArray()));</span>
<span class="fc" id="L405">						break;</span>
					}
<span class="fc" id="L407">				}</span>

<span class="fc" id="L409">				question = QuestionFactory.getNextQuestion(provider);</span>
<span class="pc bpc" id="L410" title="1 of 2 branches missed.">				if (questionCount++ &gt;= 100) {</span>
<span class="nc" id="L411">					throw new IllegalStateException(&quot;Infinite Loop detected determining Assignment Rules questions&quot;);</span>
				}
<span class="fc" id="L413">			}</span>

<span class="fc" id="L415">			retVal.put(cwr.getID(), description.toString());</span>
<span class="fc" id="L416">		}</span>
<span class="fc" id="L417">		return retVal;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>