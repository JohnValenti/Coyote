<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityRepository.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.rest.wfm.resource.activity</a> &gt; <span class="el_source">ActivityRepository.java</span></div><h1>ActivityRepository.java</h1><pre class="source lang-java linenums">package com.verint.web.rest.wfm.resource.activity;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityValidationException;
import com.bluepumpkin.ejb.bbm.base.*;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.google.common.collect.Sets;
import com.verint.web.rest.wfm.exception.EntityDeleteException;
import com.verint.web.rest.wfm.repository.RepositoryLogger;
import com.verint.web.rest.wfm.repository.ValidateJsonApiFilterParams;
import com.verint.web.rest.wfm.repository.WfoResourceRepository;
import com.verint.web.rest.wfm.util.IdUtil;
import com.witness.ejb.bbm.delete.DeleteException;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.ejb.core.security.model.User;
import io.katharsis.queryParams.QueryParams;
import io.katharsis.repository.annotations.JsonApiResourceRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import javax.ws.rs.container.ContainerRequestContext;
import java.rmi.RemoteException;
import java.util.Collection;
import java.util.Collections;
import java.util.Set;
import java.util.stream.Collectors;
import java.util.stream.Stream;


@JsonApiResourceRepository(ActivityEntity.class)
<span class="nc" id="L38">public class ActivityRepository extends WfoResourceRepository&lt;Integer, ActivityEntity&gt; {</span>

<span class="nc" id="L40">	private final static Logger log = LoggerFactory.getLogger(ActivityRepository.class.getName());</span>
	private final static String USE_ACTIVITY_SCOPE_FILTER_KEY = &quot;useActivityScope&quot;;

	@Inject
	private ActivityManager am;

	@Inject
	private WorkResourceManager wrm;

<span class="nc" id="L49">	private final static String ENTITY_NAME = ActivityEntity.class.getSimpleName();</span>

	final static String RESOURCE_NAME = &quot;activities&quot;;

	@Override
	protected Logger logger() {
<span class="nc" id="L55">		return log;</span>
	}

	@Override
	@RepositoryLogger
	public &lt;T extends ActivityEntity&gt; T save(T entity, ContainerRequestContext requestContext) {
		try {
<span class="nc" id="L62">			Activity activity = ActivityMapper.INSTANCE.entityToActivity(entity);</span>
			//Create new shift assignment if ID is null
<span class="nc bnc" id="L64" title="All 2 branches missed.">			if (activity.getID() == null) {</span>
<span class="nc" id="L65">				ID newId = am.createActivity(activity);</span>
<span class="nc" id="L66">				entity.setID(newId.toInt());</span>
				//Otherwise, update existing assignment
<span class="nc" id="L68">			} else {</span>
<span class="nc" id="L69">				am.updateActivity(activity);</span>
			}
<span class="nc" id="L71">			return entity;</span>
<span class="nc" id="L72">		} catch (RemoteException e) {</span>
<span class="nc" id="L73">			throw handleRemoteException(ENTITY_NAME, Integer.toString(entity.getID()), e);</span>
<span class="nc" id="L74">		} catch (BbmCreateDuplicateKeyException e) {</span>
<span class="nc" id="L75">			throw handleBbmCreateDuplicateKeyException(entity, e);</span>
<span class="nc" id="L76">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L77">			throw handleBbmCreateException(entity, e);</span>
<span class="nc" id="L78">		} catch (ActivityValidationException e) {</span>
<span class="nc" id="L79">			logger().error(&quot;ActivityValidationException was thrown: &quot;, e);</span>
<span class="nc" id="L80">			throw new EntityActivityValidationException(ENTITY_NAME, Integer.toString(entity.getID()), e);</span>
<span class="nc" id="L81">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L82">			throw handleBbmUpdateException(entity, e);</span>
<span class="nc" id="L83">		} catch (MultiUserException e) {</span>
<span class="nc" id="L84">			throw handleMultiUserException(ENTITY_NAME, Integer.toString(entity.getID()), e);</span>
		}
	}

	@Override
	@RepositoryLogger
	@ValidateJsonApiFilterParams
	public ActivityEntity findOne(Integer id, QueryParams requestParams, ContainerRequestContext requestContext) {
		try {
<span class="nc" id="L93">			Activity activity = am.findActivityById(ID.fromInt(id));</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">			if (activity == null) {</span>
<span class="nc" id="L95">				return null;</span>
			}
<span class="nc" id="L97">			return ActivityMapper.INSTANCE.activityToEntity(activity);</span>
<span class="nc" id="L98">		} catch (RemoteException e) {</span>
<span class="nc" id="L99">			throw handleRemoteException(ENTITY_NAME, Integer.toString(id), e);</span>
<span class="nc" id="L100">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L101">			throw handleBbmObjectNotFoundException(ENTITY_NAME, Integer.toString(id), e);</span>
<span class="nc" id="L102">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L103">			throw handleBbmFinderException(ENTITY_NAME, Integer.toString(id), e);</span>
		}
	}

	@Override
	@RepositoryLogger
	@ValidateJsonApiFilterParams
	public Iterable&lt;ActivityEntity&gt; findAll(QueryParams queryParams, ContainerRequestContext requestContext) {
		try {
<span class="nc" id="L112">			Collection&lt;Activity&gt; activities = am.getAllActivities();</span>
<span class="nc" id="L113">			Collection&lt;ActivityEntity&gt; activityEntities = ActivityMapper.INSTANCE.activitiesToEntities(activities);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">			if (isFilterByActivityScopeActive()) {</span>
<span class="nc" id="L115">				return filterActivitiesWithScheduleEditPermissionsForCurrentUser(activityEntities, requestContext);</span>
			}
<span class="nc" id="L117">			return activityEntities;</span>
<span class="nc" id="L118">		} catch (RemoteException e) {</span>
<span class="nc" id="L119">			throw handleRemoteException(ENTITY_NAME, ALL_IDS, e);</span>
<span class="nc" id="L120">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L121">			throw handleBbmFinderException(ENTITY_NAME, ALL_IDS, e);</span>
		}
	}

	@Override
	@RepositoryLogger
	@ValidateJsonApiFilterParams
	public Iterable&lt;ActivityEntity&gt; findAll(Iterable&lt;Integer&gt; ids, QueryParams queryParams,
			ContainerRequestContext requestContext) {
		try {
<span class="nc" id="L131">			Collection&lt;Activity&gt; activities = am.findActivities(IdUtil.fromInt(ids));</span>
<span class="nc" id="L132">			Collection&lt;ActivityEntity&gt; activityEntities = ActivityMapper.INSTANCE.activitiesToEntities(activities);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">			if (isFilterByActivityScopeActive()) {</span>
<span class="nc" id="L134">				activityEntities = filterActivitiesWithScheduleEditPermissionsForCurrentUser(activityEntities, requestContext);</span>
			}
<span class="nc" id="L136">			return activityEntities;</span>
<span class="nc" id="L137">		} catch (RemoteException e) {</span>
<span class="nc" id="L138">			throw handleRemoteException(ENTITY_NAME, null, e);</span>
<span class="nc" id="L139">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L140">			throw handleBbmFinderException(ENTITY_NAME, null, e);</span>
		}
	}

	@Override
	@RepositoryLogger
	public void delete(Integer id, ContainerRequestContext requestContext) {
		try {
<span class="nc" id="L148">			am.deleteActivity(ID.fromInt(id));</span>
<span class="nc" id="L149">		} catch (RemoteException e) {</span>
<span class="nc" id="L150">			throw handleRemoteException(ENTITY_NAME, Integer.toString(id), e);</span>
<span class="nc" id="L151">		} catch (DeleteException e) {</span>
<span class="nc" id="L152">			logger().error(&quot;ActivityRepository.delete: An error occurred deleting Activity with ID &quot; + id, e);</span>
<span class="nc" id="L153">			throw new EntityDeleteException(ENTITY_NAME, Integer.toString(id), e);</span>
<span class="nc" id="L154">		}</span>
<span class="nc" id="L155">	}</span>

	@Override
	protected String getResourceName() {
<span class="nc" id="L159">		return RESOURCE_NAME;</span>
	}

	@Override
	protected Set&lt;String&gt; getValidFilterParamKeys() {
<span class="nc" id="L164">		return Sets.newHashSet(USE_ACTIVITY_SCOPE_FILTER_KEY);</span>
	}

	private boolean isFilterByActivityScopeActive() {
<span class="nc" id="L168">		Set&lt;String&gt; useActivityScopeStr = getFilterParam(USE_ACTIVITY_SCOPE_FILTER_KEY);</span>
<span class="nc bnc" id="L169" title="All 4 branches missed.">		if (useActivityScopeStr != null &amp;&amp; !useActivityScopeStr.isEmpty()) {</span>
<span class="nc" id="L170">			return Boolean.parseBoolean(useActivityScopeStr.iterator().next());</span>
		}

<span class="nc" id="L173">		return false;</span>
	}

	/**
	 * Returns a subset of filtered activities that contain only the activities for which the user has schedule
	 * edit permissions.
	 *
	 * This initial set of activities is filtered in two ways:
	 * 1 - Activities in the user's activity scope are included.  Activities are in the user's scope if the user has
	 * activity scope for them.
	 * 2 - The activity belongs to an Organization which is in the user's scope.
	 */
	public Collection&lt;ActivityEntity&gt; filterActivitiesWithScheduleEditPermissionsForCurrentUser(
			Collection&lt;ActivityEntity&gt; activitiesToFilter, ContainerRequestContext context)
			throws RemoteException, BbmFinderException {
		//TODO: uncomment when porting to 15.2
//		try {
//			if (activitiesToFilter != null &amp;&amp; !activitiesToFilter.isEmpty()) {
//				User currentUser = getCurrentUser(context);
//				Collection&lt;ID&gt; authorizedActivityIds =
//						currentUser.getAuthorizedScopes(PrivilegeKeys.FS_MODIFYCALENDAR_ID, Scope.ACTIVITY_SCOPE);
//
//				if (authorizedActivityIds != null &amp;&amp; !authorizedActivityIds.isEmpty()) {
//					Collection&lt;ID&gt; scopedOrgIDs = wrm.getAllOrgIDsInUserScopePlusAncestors(currentUser, true);
//
//					Stream&lt;ActivityEntity&gt; entityStream = activitiesToFilter.stream();
//
//					//If scoped activity IDs is a single size with value &quot;-1&quot;, that means that have &quot;All Activity&quot; scope and
//					//we should not use the collection of authorizedActivityIds for filtering.
//					if (!(authorizedActivityIds.size() == 1 &amp;&amp;
//							authorizedActivityIds.iterator().next().equals(ID.fromInt(-1)))) {
//						entityStream = entityStream
//								.filter(a -&gt; authorizedActivityIds.contains(ID.fromInt(a.getOrganizationID())));
//					}
//
//					return entityStream
//							.filter(a -&gt; scopedOrgIDs.contains(ID.fromInt(a.getOrganizationID()))
//									|| a.getOrganizationID() == Organization.ROOT_ORG_ID)
//							.collect(Collectors.toList());
//				}
//			}

<span class="nc" id="L215">			return Collections.emptyList();</span>
//		} catch (BbmException ex) {
//			throw new BbmFinderException(ex);
//		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>