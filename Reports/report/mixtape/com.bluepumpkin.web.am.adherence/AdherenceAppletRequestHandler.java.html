<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AdherenceAppletRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.am.adherence</a> &gt; <span class="el_source">AdherenceAppletRequestHandler.java</span></div><h1>AdherenceAppletRequestHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.am.adherence;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.StringTokenizer;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.rtaamanager.model.RTAAData;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.RTAAException;
import com.bluepumpkin.ejb.bpx.balance.model.Interaction;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.am.Log;
import com.bluepumpkin.web.am.adherence.keys.AdherenceKeys;
import com.bluepumpkin.web.am.adherence.util.AgentContact;
import com.bluepumpkin.web.am.l10n.AmWebBundleKey;
import com.bluepumpkin.web.am.l10n.AmWebLogBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.core.applet.AppletIO;
import com.bluepumpkin.web.core.applet.AppletRH;
import com.bluepumpkin.web.core.applet.TextAppletIO;
import com.bluepumpkin.web.core.keys.PageKeys;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:		 AdherenceAppletRequestHandler
 * Description:	 Handle requests from the adherence page
 * Copyright:	 Copyright (c) 2003
 * Company:		 Blue Pumpkin Software, Inc
 * @author		 Alvin Cham
 * @version 1.0
 */

<span class="nc" id="L48">public class AdherenceAppletRequestHandler extends AppletRH {</span>
<span class="fc" id="L49">	private static final Category cat = Log.initCategory(AdherenceAppletRequestHandler.class.getName());</span>

	/**
	 *  Overrides the base class to fetch the initial user preferences
	 *  variables that the adherence applet needs.
	 */
	protected Map getInitUserProperties(RequestContext context) {
<span class="nc" id="L56">		ArrayList properties = new ArrayList(7);</span>

<span class="nc" id="L58">		properties.add(&quot;DAYDETAIL_DATE&quot;);</span>
<span class="nc" id="L59">		properties.add(AdherenceKeys.ADHERENCE_LAST_VIEWED_SORT);</span>
<span class="nc" id="L60">		properties.add(AdherenceKeys.ADHERENCE_LAST_VIEWED_PAGENUM);</span>
<span class="nc" id="L61">		properties.add(AdherenceKeys.ADHERENCE_LAST_VIEWED_PAGESIZE);</span>
<span class="nc" id="L62">		properties.add(AdherenceKeys.ADHERENCE_LAST_VIEWED_TOTALSIZE);</span>
<span class="nc" id="L63">		properties.add(UserPreferenceKeys.USER_ADHERENCE_AUTO_REFRESH);</span>
<span class="nc" id="L64">		properties.add(UserPreferenceKeys.USER_ADHERENCE_COLLAPSED_VIEW);</span>

<span class="nc" id="L66">		Map map = new HashMap(2);</span>

<span class="nc" id="L68">		map.put(PageKeys.PROPERTY_KEYS_COLLECTION, properties);</span>

<span class="nc" id="L70">		Map resultMap = getUserProperties(context, map);</span>

<span class="nc bnc" id="L72" title="All 2 branches missed.">		if (!isAdherenceLicensed()) {</span>
			// forces no auto-refresh, if it doesn't ahve adherence license.
<span class="nc" id="L74">			resultMap.put(UserPreferenceKeys.USER_ADHERENCE_AUTO_REFRESH,</span>
					UserPreferenceKeys.NO_AUTO_REFRESH);
		}

        //get actuals display names
<span class="nc" id="L79">		Pair actualsNamepair = AdherenceHelper.getActualDisplayNames(context);</span>
<span class="nc" id="L80">		resultMap.put(AdherenceKeys.ACTUALS_PRIMARY_DISPLAY_NAME, actualsNamepair.getFirst());</span>
<span class="nc" id="L81">		resultMap.put(AdherenceKeys.ACTUALS_SECONDARY_DISPLAY_NAME, actualsNamepair.getSecond());</span>
        
   	    //Changed for QA59182 -Out Of Memory Error thrown when Selecting All or More Records in the request management and in Adherence
		//Adding this constant pagination parameter as user properties
		try
        {
<span class="nc" id="L87">			String pageIDSizeFetched = BbmManagerFactory.getDBConfigManager().getValue(ConfigKey.AM_PAGE_ID_SIZE_LIMIT);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">			if ( pageIDSizeFetched != null )</span>
            {
<span class="nc" id="L90">					resultMap.put(AdherenceKeys.ADHERENCE_LIMITING_PAGESIZE,</span>
						pageIDSizeFetched);			
			}
		}
<span class="nc" id="L94">        catch(Exception Ex)</span>
        {//ignore the exception
<span class="nc" id="L96">		}</span>

<span class="nc" id="L98">		return resultMap;</span>
	}

	/**
	 * Process Applet Request - to be overrided by derived classes
	 * @param context - The Request Context
	 * @param appletRequest - Map containing Applet Request Information
	 * @param appletResponse - Map containing Response to be send to Applet
	 */
	protected void processAppletRequest(RequestContext context, Map appletRequest, Map appletResponse) {
        
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (isAppletAction(appletRequest, PageAction.APPLET_INIT)) {</span>
<span class="nc" id="L110">            Collection commands = (Collection)appletRequest.get(PageKeys.APPLET_COMMANDS);</span>
<span class="nc" id="L111">            HashMap mapProperties = new HashMap(commands.size() * 2);</span>
<span class="nc" id="L112">            HashMap views = null;</span>
<span class="nc" id="L113">            Map userProps = null;</span>
            
<span class="nc bnc" id="L115" title="All 2 branches missed.">            for (Iterator iter = commands.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L116">                String command = (String) iter.next();</span>

<span class="nc" id="L118">                Object obj = null;</span>

                //Common applet init info
<span class="nc bnc" id="L121" title="All 2 branches missed.">				if (command.equals(GET_LOCALE_CONTEXT)) {</span>
<span class="nc" id="L122">					obj = context.getLocaleContext();</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                } else if (command.equals(PageAction.GET_USER_PRIVELEGES)) {</span>
<span class="nc" id="L124">                    obj = getUser(context);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                } else if (command.equals(PageAction.GET_USER_PROPERTIES)) {</span>
<span class="nc" id="L126">                    obj = userProps = getInitUserProperties(context);</span>
                }
                
                //Adherence-specific applet init info
<span class="nc bnc" id="L130" title="All 2 branches missed.">                else if (command.equals(AdherenceKeys.CHECK_ULTRA_LICENSE)) {</span>
<span class="nc" id="L131">                    obj = checkUltraLicense(context, appletResponse, false);</span>
                } 
<span class="nc bnc" id="L133" title="All 2 branches missed.">                else if (command.equals(AdherenceKeys.CHECK_BALANCE_LICENSE)) {</span>
<span class="nc" id="L134">                    obj = checkBalanceLicense(context, appletResponse, false);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                } else if (command.equals(AdherenceKeys.CHECK_IS_NOT_SHOW_ONEMINUTE_EXCEPTION)) {</span>
<span class="nc" id="L136">                	obj = checkIsNotShow1MinuteException(context, appletResponse);</span>
                } 

<span class="nc bnc" id="L139" title="All 2 branches missed.">                if (obj != null)</span>
<span class="nc" id="L140">                    mapProperties.put(command + PageKeys.APPLET_RESPONSE, obj);</span>
<span class="nc" id="L141">            }</span>
            
<span class="nc" id="L143">            addResponseData(mapProperties, appletResponse);</span>
<span class="nc" id="L144">        }       </span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        else if (isAppletAction(appletRequest, AdherenceKeys.GET_ADHERENCE_DATA)) {</span>
<span class="nc" id="L146">			getAdherenceData(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.GET_VIEWABLE_EMPLOYEES)) {</span>
<span class="nc" id="L148">			getViewableEmployees(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.AUTHORIZE_EXCEPTIONS)) {</span>
<span class="nc" id="L150">			authorizeException(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.UNAUTHORIZE_EXCEPTIONS)) {</span>
<span class="nc" id="L152">			unauthorizeException(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.MASS_AUTHORIZE_EXCEPTIONS)) {</span>
<span class="nc" id="L154">			massAuthorizeExceptions(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.GROUP_AUTHORIZE_EXCEPTIONS)) {</span>
<span class="nc" id="L156">			groupAuthorizeExceptions(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.GET_EMPLOYEE_NAMES)) {</span>
<span class="nc" id="L158">			getEmployeeNames(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.GET_USER_FILTER_NAMES)) {</span>
<span class="nc" id="L160">			getUserFilterNames(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.GET_ACTIVITY_MAPPINGS)) {</span>
<span class="nc" id="L162">			getActivityMappings(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.GET_EMPLOYEE_IDS)) {</span>
<span class="nc" id="L164">			getEmployeeIDs(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.LOAD_INTERACTIONS)) {</span>
<span class="nc" id="L166">			loadInteractions(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.START_RECORDING)) {</span>
<span class="nc" id="L168">			startRecording(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.STOP_RECORDING)) {</span>
<span class="nc" id="L170">			stopRecording(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.GET_PLAYBACK_URL)) {</span>
<span class="nc" id="L172">			getPlaybackURL(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">		} else if (isAppletAction(appletRequest, AdherenceKeys.GET_LIVE_MONITOR_URL)) {</span>
<span class="nc" id="L174">			getLiveMonitorURL(context, appletRequest, appletResponse);</span>
		} else {
<span class="nc" id="L176">			super.processAppletRequest(context, appletRequest, appletResponse);</span>
		}
<span class="nc" id="L178">	}</span>

	/**
	 *	Because this request handler also handles client requests sent as clear text.  We
	 *	need to convert text parameters into JAVA objects.
	 */
	protected void convertToDefaultIO(Map appletRequest, AppletIO io) {
<span class="nc bnc" id="L185" title="All 2 branches missed.">		if (io.equals(TextAppletIO.getInstance())) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">			if (isAppletAction(appletRequest, AdherenceKeys.GET_ADHERENCE_DATA)) {</span>
<span class="nc" id="L187">				String empIDs = (String)appletRequest.get(AdherenceKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L188">				appletRequest.put(AdherenceKeys.EMPLOYEE_IDS,</span>
<span class="nc" id="L189">						convertToIDs(TextAppletIO.convertToCollection(empIDs)));</span>
<span class="nc" id="L190">				String startDate = (String)appletRequest.get(AdherenceKeys.START_DATE);</span>
<span class="nc" id="L191">				appletRequest.put(AdherenceKeys.START_DATE, TextAppletIO.convertToDate(startDate));</span>
<span class="nc" id="L192">				String endDate = (String)appletRequest.get(AdherenceKeys.END_DATE);</span>
<span class="nc" id="L193">				appletRequest.put(AdherenceKeys.END_DATE, TextAppletIO.convertToDate(endDate));</span>
<span class="nc" id="L194">				String timestamp = (String)appletRequest.get(AdherenceKeys.LAST_TIMESTAMP);</span>
<span class="nc" id="L195">				appletRequest.put(AdherenceKeys.LAST_TIMESTAMP, TextAppletIO.convertToDate(timestamp));</span>
<span class="nc" id="L196">				String pageNum = (String)appletRequest.get(AdherenceKeys.PAGE_NUM);</span>
<span class="nc" id="L197">				appletRequest.put(AdherenceKeys.PAGE_NUM, TextAppletIO.convertToInteger(pageNum));</span>
<span class="nc" id="L198">				String pageSize = (String)appletRequest.get(AdherenceKeys.PAGE_SIZE);</span>
<span class="nc" id="L199">				appletRequest.put(AdherenceKeys.PAGE_SIZE, TextAppletIO.convertToInteger(pageSize));</span>
<span class="nc" id="L200">				String sortKey = (String)appletRequest.get(AdherenceKeys.SORT_KEY);</span>
<span class="nc" id="L201">				appletRequest.put(AdherenceKeys.SORT_KEY, TextAppletIO.convertToInteger(sortKey));</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, AdherenceKeys.GET_VIEWABLE_EMPLOYEES)) {</span>
<span class="nc" id="L203">				String empIDs = (String)appletRequest.get(AdherenceKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L204">				appletRequest.put(AdherenceKeys.EMPLOYEE_IDS,</span>
<span class="nc" id="L205">						convertToIDs(TextAppletIO.convertToCollection(empIDs)));</span>
<span class="nc" id="L206">				String startDate = (String)appletRequest.get(AdherenceKeys.START_DATE);</span>
<span class="nc" id="L207">				appletRequest.put(AdherenceKeys.START_DATE, TextAppletIO.convertToDate(startDate));</span>
<span class="nc" id="L208">				String endDate = (String)appletRequest.get(AdherenceKeys.END_DATE);</span>
<span class="nc" id="L209">				appletRequest.put(AdherenceKeys.END_DATE, TextAppletIO.convertToDate(endDate));</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, AdherenceKeys.AUTHORIZE_EXCEPTIONS) ||</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">					isAppletAction(appletRequest, AdherenceKeys.UNAUTHORIZE_EXCEPTIONS)) {</span>
<span class="nc" id="L212">				String exceptions = (String)appletRequest.get(AdherenceKeys.EXCEPTIONS);</span>
<span class="nc" id="L213">				appletRequest.put(AdherenceKeys.EXCEPTIONS,</span>
<span class="nc" id="L214">						convertToExceptions(TextAppletIO.convertToCollection(exceptions)));</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, AdherenceKeys.MASS_AUTHORIZE_EXCEPTIONS)) {</span>
<span class="nc" id="L216">				String id = (String)appletRequest.get(AdherenceKeys.EMPLOYEE_ID);</span>
<span class="nc" id="L217">				appletRequest.put(AdherenceKeys.EMPLOYEE_ID, convertToID(id));</span>
<span class="nc" id="L218">				String timeRangeStart = (String)appletRequest.get(AdherenceKeys.TIMERANGES_TO_APPROVE);</span>
<span class="nc" id="L219">				appletRequest.put(AdherenceKeys.TIMERANGES_TO_APPROVE,</span>
<span class="nc" id="L220">						convertToTimeRange(TextAppletIO.convertToCollection(timeRangeStart)));</span>
<span class="nc" id="L221">				String timeRangeEnd = (String)appletRequest.get(AdherenceKeys.TIMERANGES_TO_UNAPPROVE);</span>
<span class="nc" id="L222">				appletRequest.put(AdherenceKeys.TIMERANGES_TO_UNAPPROVE,</span>
<span class="nc" id="L223">						convertToTimeRange(TextAppletIO.convertToCollection(timeRangeEnd)));</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, AdherenceKeys.GROUP_AUTHORIZE_EXCEPTIONS)) {</span>
<span class="nc" id="L225">				String empIDs = (String)appletRequest.get(AdherenceKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L226">				appletRequest.put(AdherenceKeys.EMPLOYEE_IDS,</span>
<span class="nc" id="L227">						convertToIDs(TextAppletIO.convertToCollection(empIDs)));</span>
<span class="nc" id="L228">				String filterName = (String)appletRequest.get(AdherenceKeys.FILTER_NAME);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">				if (filterName.equals(&quot;null&quot;))</span>
<span class="nc" id="L230">					appletRequest.put(AdherenceKeys.FILTER_NAME, null);</span>
<span class="nc" id="L231">				String startDate = (String)appletRequest.get(AdherenceKeys.START_DATE);</span>
<span class="nc" id="L232">				appletRequest.put(AdherenceKeys.START_DATE, TextAppletIO.convertToDate(startDate));</span>
<span class="nc" id="L233">				String endDate = (String)appletRequest.get(AdherenceKeys.END_DATE);</span>
<span class="nc" id="L234">				appletRequest.put(AdherenceKeys.END_DATE, TextAppletIO.convertToDate(endDate));</span>
<span class="nc" id="L235">				String authorized = (String)appletRequest.get(AdherenceKeys.AUTHORIZED);</span>
<span class="nc" id="L236">				appletRequest.put(AdherenceKeys.AUTHORIZED, TextAppletIO.convertToBoolean(authorized));</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, AdherenceKeys.GET_EMPLOYEE_NAMES)) {</span>
<span class="nc" id="L238">				String empIDs = (String)appletRequest.get(AdherenceKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L239">				appletRequest.put(AdherenceKeys.EMPLOYEE_IDS,</span>
<span class="nc" id="L240">						convertToIDs(TextAppletIO.convertToCollection(empIDs)));</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, AdherenceKeys.GET_USER_FILTER_NAMES)) {</span>
<span class="nc" id="L242">				String id = (String)appletRequest.get(AdherenceKeys.USER_ID);</span>
<span class="nc" id="L243">				appletRequest.put(AdherenceKeys.USER_ID, convertToID(id));</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, AdherenceKeys.GET_ACTIVITY_MAPPINGS)) {</span>
<span class="nc" id="L245">				String ids = (String)appletRequest.get(AdherenceKeys.ACTIVITY_IDS);</span>
<span class="nc" id="L246">				appletRequest.put(AdherenceKeys.ACTIVITY_IDS,</span>
<span class="nc" id="L247">						convertToIDs(TextAppletIO.convertToCollection(ids)));</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, AdherenceKeys.GET_EMPLOYEE_IDS)) {</span>
				// do nothing
<span class="nc bnc" id="L250" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, AdherenceKeys.LOAD_INTERACTIONS)) {</span>
<span class="nc" id="L251">				String empIDs = (String)appletRequest.get(AdherenceKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L252">				appletRequest.put(AdherenceKeys.EMPLOYEE_IDS,</span>
<span class="nc" id="L253">						convertToIDs(TextAppletIO.convertToCollection(empIDs)));</span>
<span class="nc" id="L254">				String startDate = (String)appletRequest.get(AdherenceKeys.START_DATE);</span>
<span class="nc" id="L255">				appletRequest.put(AdherenceKeys.START_DATE, TextAppletIO.convertToDate(startDate));</span>
<span class="nc" id="L256">				String endDate = (String)appletRequest.get(AdherenceKeys.END_DATE);</span>
<span class="nc" id="L257">				appletRequest.put(AdherenceKeys.END_DATE, TextAppletIO.convertToDate(endDate));</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, AdherenceKeys.START_RECORDING)) {</span>
<span class="nc" id="L259">				String id = (String)appletRequest.get(AdherenceKeys.EMPLOYEE_ID);</span>
<span class="nc" id="L260">				appletRequest.put(AdherenceKeys.EMPLOYEE_ID, convertToID(id));</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, AdherenceKeys.STOP_RECORDING)) {</span>
<span class="nc" id="L262">				String id = (String)appletRequest.get(AdherenceKeys.EMPLOYEE_ID);</span>
<span class="nc" id="L263">				appletRequest.put(AdherenceKeys.EMPLOYEE_ID, convertToID(id));</span>
<span class="nc" id="L264">			} else {</span>
<span class="nc" id="L265">				super.convertToDefaultIO(appletRequest, io);</span>
			}
		} else {
<span class="nc" id="L268">			super.convertToDefaultIO(appletRequest, io);</span>
		}
<span class="nc" id="L270">	}</span>

	private ID convertToID(String id) {
<span class="nc" id="L273">		return new ID(id);</span>
	}


	private Collection convertToIDs(Collection c) {
<span class="nc" id="L278">		Collection ret = new ArrayList(c.size());</span>

<span class="nc bnc" id="L280" title="All 2 branches missed.">		for (Iterator iter = c.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L281">			String item = (String)iter.next();</span>
<span class="nc" id="L282">			ret.add(convertToID((item)));</span>
<span class="nc" id="L283">		}</span>
<span class="nc" id="L284">		return ret;</span>
	}

	private Collection convertToExceptions(Collection c) {
<span class="nc" id="L288">		Collection ret = new ArrayList(c.size());</span>

<span class="nc bnc" id="L290" title="All 2 branches missed.">		for (Iterator iter = c.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L291">			String item = (String)iter.next();</span>

<span class="nc" id="L293">			StringTokenizer exception = new StringTokenizer(item, &quot;:&quot;);</span>
<span class="nc" id="L294">			String empID = exception.nextToken();</span>
<span class="nc" id="L295">			String startTime = exception.nextToken();</span>
<span class="nc" id="L296">			String endTime = exception.nextToken();</span>

<span class="nc" id="L298">			ret.add(new RTAAException(convertToID(empID),</span>
<span class="nc" id="L299">					TextAppletIO.convertToDate(startTime),</span>
<span class="nc" id="L300">					TextAppletIO.convertToDate(endTime),</span>
					null,
					false,
					false));
<span class="nc" id="L304">		}</span>
<span class="nc" id="L305">		return ret;</span>
	}

	private Collection convertToTimeRange(Collection c) {
<span class="nc" id="L309">		Collection ret = new ArrayList(c.size());</span>

<span class="nc bnc" id="L311" title="All 2 branches missed.">		for (Iterator iter = c.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L312">			String item = (String)iter.next();</span>

<span class="nc" id="L314">			StringTokenizer tr = new StringTokenizer(item, &quot;:&quot;);</span>
<span class="nc" id="L315">			String startTime = tr.nextToken();</span>
<span class="nc" id="L316">			String endTime = tr.nextToken();</span>

<span class="nc" id="L318">			ret.add(new TimeRange(TextAppletIO.convertToDate(startTime),</span>
<span class="nc" id="L319">					TextAppletIO.convertToDate(endTime)));</span>
<span class="nc" id="L320">		}</span>
<span class="nc" id="L321">		return ret;</span>
	}

	private void getAdherenceData(RequestContext context, Map appletRequest, Map appletResponse) 
	{
		try 
		{
<span class="nc" id="L328">			Collection employeeIDs = (Collection)appletRequest.get(AdherenceKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L329">			Date start = (Date)appletRequest.get(AdherenceKeys.START_DATE);</span>
<span class="nc" id="L330">			Date end = (Date)appletRequest.get(AdherenceKeys.END_DATE);</span>
<span class="nc" id="L331">			Date timestamp = (Date)appletRequest.get(AdherenceKeys.LAST_TIMESTAMP);</span>
<span class="nc" id="L332">			int pageNum = ((Integer)appletRequest.get(AdherenceKeys.PAGE_NUM)).intValue();</span>
<span class="nc" id="L333">			int pageSize = ((Integer)appletRequest.get(AdherenceKeys.PAGE_SIZE)).intValue();</span>
<span class="nc" id="L334">			int sortKey = ((Integer)appletRequest.get(AdherenceKeys.SORT_KEY)).intValue();</span>

<span class="nc" id="L336">			context.setUserProperty(AdherenceKeys.ADHERENCE_LAST_VIEWED_SORT, String.valueOf(sortKey));</span>
<span class="nc" id="L337">			RTAAData data = AdherenceEJBInvoker.getAdherenceData(context, employeeIDs, </span>
<span class="nc" id="L338">					start, end, sortKey, pageNum, pageSize, timestamp, AdherenceHelper.showUnavailable(context));</span>
			
			//send back collection where first item is RTAA data, 
			//Collection items depends on the request type:
			//if timestamp is not null, it is auto- refresh: requires adherence data + recoded employeed list
			//if timestamp is null, it is a full refresh, requires adherence data + recoded employeed list + privileges
			//first item in the list is RTAA data
			//second item is employees being recorded list
			//third item is privileges
<span class="nc" id="L347">			HashMap allData = new HashMap(3);</span>

			// fill in the authorization privileges, only for the full-refresh case.
<span class="nc bnc" id="L350" title="All 2 branches missed.">			if (timestamp == null) </span>
			{
<span class="nc" id="L352">				Collection privs = AdherenceEJBInvoker.getAuthPrivs(context, context.getUser(), data.getEmployeeIDs(), start, end);</span>
<span class="nc" id="L353">				data.setAuthPrivs(privs);</span>
			}

			//add RTAAData (Real-Time Agent Adherence)
<span class="nc" id="L357">			allData.put(AdherenceKeys.ADHERENCE_DATA, data);</span>
            
			//add collection of employees who are being recorded by this user
<span class="nc" id="L360">			Collection empsBeingRecordedByUser = AdherenceEJBInvoker.getEmployeesBeingRecordedByUser(context.getUser().getID());</span>
<span class="nc" id="L361">			allData.put(AdherenceKeys.EMPS_RECORDED, empsBeingRecordedByUser);</span>

			//fill in additional info, only for the full-refresh case.
<span class="nc bnc" id="L364" title="All 2 branches missed.">			if (timestamp == null) </span>
			{
<span class="nc" id="L366">				Collection qmAgents = new HashSet();</span>
<span class="nc bnc" id="L367" title="All 4 branches missed.">				boolean hasBothLicences = checkBalanceLicense(context, appletResponse, false) &amp;&amp; checkUltraLicense(context, appletResponse, false);</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">				if (hasBothLicences)</span>
				{
<span class="nc" id="L370">					qmAgents = AdherenceEJBInvoker.getAgentsWithQMDataSource(data.getEmployeeIDs());</span>
<span class="nc" id="L371">					allData.put(AdherenceKeys.AGENT_QM_DATASOURCE_FLAGS, qmAgents);</span>
				}
				
				//add privilege map for Interactions
<span class="nc" id="L375">				HashMap privs = AdherenceEJBInvoker.getInteractionPrivs(context, context.getUser(), data.getEmployeeIDs(), start, end, qmAgents);</span>
<span class="nc" id="L376">				allData.put(AdherenceKeys.INTERACTION_PRIVS, privs);</span>
			}

			//get time tracking events
<span class="nc" id="L380">			HashMap trackingEvents = AdherenceEJBInvoker.getTimeTrackingEvents(data.getEmployeeIDs(), start, end, context.getViewingTimeZone());</span>
<span class="nc" id="L381">			allData.put(AdherenceKeys.TRACKING_EVENTS, trackingEvents);</span>

			//get the activity names for desktop monitoring
<span class="nc" id="L384">			allData.put(AdherenceKeys.TRACKING_ACTIVITY_MAP, AdherenceHelper.getActivityMap(context, trackingEvents));</span>

<span class="nc" id="L386">			appletResponse.put(AdherenceKeys.RTAA_DATA, allData);</span>
		} 
<span class="nc" id="L388">		catch (Exception ex) </span>
		{
<span class="nc" id="L390">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L391">		}</span>
<span class="nc" id="L392">	}</span>
	
	private void getEmployeeIDs(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L396">			System.out.println(&quot;Getting employeeIDs&quot;);</span>
<span class="nc" id="L397">			appletResponse.put(AdherenceKeys.EMPLOYEE_IDS, null);</span>
<span class="nc" id="L398">		} catch (Exception ex) {</span>
<span class="nc" id="L399">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L400">		}</span>
<span class="nc" id="L401">	}</span>

	private void getEmployeeNames(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L405">			Collection employeeIDs = (Collection)appletRequest.get(AdherenceKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L406">			appletResponse.put(AdherenceKeys.EMPLOYEE_NAMES, AdherenceEJBInvoker.getEmployeeNames(context, employeeIDs));</span>
<span class="nc" id="L407">		} catch (Exception ex) {</span>
<span class="nc" id="L408">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L409">		}</span>
<span class="nc" id="L410">	}</span>

	private void getUserFilterNames(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L414">			ID userID = (ID)appletRequest.get(AdherenceKeys.USER_ID);</span>
<span class="nc" id="L415">			appletResponse.put(AdherenceKeys.USER_FILTER_NAMES, AdherenceEJBInvoker.getUserFilterNames(context, userID));</span>
<span class="nc" id="L416">		} catch (Exception ex) {</span>
<span class="nc" id="L417">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L418">		}</span>
<span class="nc" id="L419">	}</span>

	private void getActivityMappings(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L423">			Collection activityIDs = (Collection)appletRequest.get(AdherenceKeys.ACTIVITY_IDS);</span>
<span class="nc" id="L424">			Collection scopedOrgIDs = OrganizationModelHandler.getAllOrgIDsInUserScopePlusAncestors(context, context.getUser(), true);</span>
<span class="nc" id="L425">			appletResponse.put(AdherenceKeys.ACTIVITY_MAPPINGS, AdherenceEJBInvoker.getActivityMappings(context, activityIDs,scopedOrgIDs));</span>
<span class="nc" id="L426">		} catch (Exception ex) {</span>
<span class="nc" id="L427">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L428">		}</span>
<span class="nc" id="L429">	}</span>

	private void authorizeException(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L433">			Collection exceptions = (Collection)appletRequest.get(AdherenceKeys.EXCEPTIONS);</span>
<span class="nc" id="L434">			String comment = (String) appletRequest.get(AdherenceKeys.EXCEPTION_COMMENT);</span>
<span class="nc" id="L435">			AdherenceEJBInvoker.authorizeExceptions(exceptions, comment);</span>
<span class="nc" id="L436">		} catch (Exception ex) {</span>
<span class="nc" id="L437">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L438">		}</span>
<span class="nc" id="L439">	}</span>

	private void unauthorizeException(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L443">			Collection exceptions = (Collection)appletRequest.get(AdherenceKeys.EXCEPTIONS);</span>
<span class="nc" id="L444">			AdherenceEJBInvoker.unauthorizeExceptions(exceptions);</span>
<span class="nc" id="L445">		} catch (Exception ex) {</span>
<span class="nc" id="L446">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L447">		}</span>
<span class="nc" id="L448">	}</span>

	/**
	 * Get the URL for the &quot;Load Interactions&quot; button.
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void loadInteractions(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L457">		ArrayList list = new ArrayList();</span>
		try {
<span class="nc" id="L459">			ArrayList empIDs = (ArrayList)appletRequest.get(AdherenceKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L460">			Date start = (Date)appletRequest.get(AdherenceKeys.START_DATE);</span>
<span class="nc" id="L461">			Date end = (Date)appletRequest.get(AdherenceKeys.END_DATE);</span>

			//fetch from wrapper
<span class="nc" id="L464">			HashMap interactionData = AdherenceEJBInvoker.getInteractionsData(context, empIDs, start, end);</span>
<span class="nc" id="L465">			list.add(0, &quot;none&quot;);</span>
<span class="nc" id="L466">			list.add(1, interactionData);</span>
<span class="nc" id="L467">		} catch (Exception ex) {</span>
			//notifyError(context, appletResponse, ex);
<span class="nc" id="L469">			list.clear();</span>
<span class="nc" id="L470">			list.add(0, ex.getLocalizedMessage());</span>
<span class="nc" id="L471">		}</span>
<span class="nc" id="L472">		appletResponse.put(AdherenceKeys.INTERACTIONS_DATA, list);</span>
<span class="nc" id="L473">	}</span>

	/**
	 * Get the URL for the &quot;Playback&quot; button.
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void getPlaybackURL(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L482">		String[] playbackURL = new String[]{&quot;&quot;,&quot;&quot;};</span>
		try {
<span class="nc" id="L484">			AgentContact contact = (AgentContact)appletRequest.get(AdherenceKeys.AGENT_CONTACT);</span>
<span class="nc" id="L485">			String callID = contact.getCallID();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">			if (StringUtil.isEmpty(callID))//get from overlapping</span>
<span class="nc" id="L487">				callID = (String)contact.getOverlappingRecordedContactIDs().get(0);</span>
<span class="nc" id="L488">			Interaction interaction = new Interaction(contact.getStartTime(), contact.getEndTime(),</span>
<span class="nc" id="L489">					contact.isRecorded(), callID, contact.getContactName(),</span>
<span class="nc" id="L490">					contact.getBalanceAgentID(), contact.getMedia(), contact.isRecordedByWFM(),</span>
<span class="nc" id="L491">					contact.isPrimaryRecording(), false, contact.getDataSourceID());</span>
<span class="nc" id="L492">			interaction.setEmpID(contact.getEmployeeID());</span>
<span class="nc" id="L493">			playbackURL[0] = AdherenceEJBInvoker.getPlaybackURL(interaction);</span>
<span class="nc" id="L494">			playbackURL[1] = &quot;none&quot;;</span>
<span class="nc" id="L495">		} catch (Exception ex) {</span>
<span class="nc" id="L496">			playbackURL[0] = &quot;&quot;;</span>
<span class="nc" id="L497">			playbackURL[1] = ex.getLocalizedMessage();</span>
<span class="nc" id="L498">		}</span>
<span class="nc" id="L499">		appletResponse.put(AdherenceKeys.PLAYBACK_URL, playbackURL);</span>
<span class="nc" id="L500">	}</span>
	
	
	/** GQ TBD
	 * Get the URL for the &quot;Monitor&quot; button.
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void getLiveMonitorURL(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L510">		String[] liveMonitorURL = new String[2];</span>
		try {
<span class="nc" id="L512">			ID empID = (ID)appletRequest.get(AdherenceKeys.EMPLOYEE_ID);</span>
<span class="nc" id="L513">			liveMonitorURL[0] = AdherenceEJBInvoker.getLiveMonitorURL(empID);</span>
<span class="nc" id="L514">			liveMonitorURL[1] = &quot;none&quot;;</span>
<span class="nc" id="L515">		} catch (Exception ex) {</span>
<span class="nc" id="L516">			liveMonitorURL[0] = &quot;&quot;;</span>
<span class="nc" id="L517">			liveMonitorURL[1] = ex.getLocalizedMessage();;</span>
<span class="nc" id="L518">		}</span>
<span class="nc" id="L519">		appletResponse.put(AdherenceKeys.LIVE_MONITOR_URL, liveMonitorURL);</span>
<span class="nc" id="L520">	}</span>

	/** GQ TBD
	 * Get the URL for the &quot;Start Recording&quot; button.
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void startRecording(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L529">		String error = null;</span>
		try {
<span class="nc" id="L531">			ID empID = (ID)appletRequest.get(AdherenceKeys.EMPLOYEE_ID);</span>

<span class="nc" id="L533">			AdherenceEJBInvoker.startRecording(empID, context.getUser().getID());</span>
<span class="nc" id="L534">		} catch (Exception ex) {</span>
			//notifyError(context, appletResponse, ex);
<span class="nc" id="L536">			error = ex.getLocalizedMessage();</span>
<span class="nc" id="L537">		}</span>
<span class="nc" id="L538">		appletResponse.put(AdherenceKeys.START_RECORDING_ERROR, error);</span>
<span class="nc" id="L539">	}</span>

	/**
	 * Get the URL for the &quot;Stop Recording&quot; button.
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void stopRecording(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L548">		String error = null;</span>
		try {
<span class="nc" id="L550">			ID empID = (ID)appletRequest.get(AdherenceKeys.EMPLOYEE_ID);</span>

<span class="nc" id="L552">			AdherenceEJBInvoker.stopRecording(empID, context.getUser().getID());</span>
<span class="nc" id="L553">		} catch (Exception ex) {</span>
<span class="nc" id="L554">			error = ex.getLocalizedMessage();</span>
<span class="nc" id="L555">		}</span>
<span class="nc" id="L556">		appletResponse.put(AdherenceKeys.STOP_RECORDING_ERROR, error);</span>
<span class="nc" id="L557">	}</span>
	
	
	
	private void massAuthorizeExceptions(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L563">			ID empID = (ID)appletRequest.get(AdherenceKeys.EMPLOYEE_ID);</span>
<span class="nc" id="L564">			Collection timeRangesToAuthorize = (Collection)appletRequest.get(AdherenceKeys.TIMERANGES_TO_APPROVE);</span>
<span class="nc" id="L565">			Collection timeRangesToUnauthorize = (Collection)appletRequest.get(AdherenceKeys.TIMERANGES_TO_UNAPPROVE);</span>
<span class="nc" id="L566">			Collection comments = (Collection) appletRequest.get(AdherenceKeys.EXCEPTION_COMMENT_COLL);</span>
<span class="nc" id="L567">			AdherenceEJBInvoker.massAuthorizeExceptions(empID, timeRangesToAuthorize, timeRangesToUnauthorize, comments);</span>
<span class="nc" id="L568">		} catch (Exception ex) {</span>
<span class="nc" id="L569">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L570">		}</span>
<span class="nc" id="L571">	}</span>

	private void getViewableEmployees(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L575">			Collection empIDs = (Collection)appletRequest.get(AdherenceKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L576">			Date start = (Date)appletRequest.get(AdherenceKeys.START_DATE);</span>
<span class="nc" id="L577">			Date end = (Date)appletRequest.get(AdherenceKeys.END_DATE);</span>

<span class="nc" id="L579">			Collection filterIDs = AdherenceEJBInvoker.getViewableEmployees(context, context.getUser(), empIDs, start, end);</span>
<span class="nc" id="L580">			appletResponse.put(AdherenceKeys.EMPLOYEE_IDS, filterIDs);</span>
<span class="nc" id="L581">		} catch (Exception ex) {</span>
<span class="nc" id="L582">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L583">		}</span>
<span class="nc" id="L584">	}</span>

	private void groupAuthorizeExceptions(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L588">			Collection empIDs = (Collection)appletRequest.get(AdherenceKeys.EMPLOYEE_IDS);</span>
<span class="nc" id="L589">			String filterName = (String)appletRequest.get(AdherenceKeys.FILTER_NAME);</span>
<span class="nc" id="L590">			Date start = (Date)appletRequest.get(AdherenceKeys.START_DATE);</span>
<span class="nc" id="L591">			Date end = (Date)appletRequest.get(AdherenceKeys.END_DATE);</span>
<span class="nc" id="L592">			boolean authorized = ((Boolean)appletRequest.get(AdherenceKeys.AUTHORIZED)).booleanValue();</span>
<span class="nc" id="L593">			String comment = (String) appletRequest.get(AdherenceKeys.EXCEPTION_COMMENT);</span>

<span class="nc" id="L595">			AdherenceEJBInvoker.groupAuthorizeExceptions(context,</span>
					empIDs,
					filterName,
					start,
					end,
					authorized,
					comment);
<span class="nc" id="L602">		} catch (Exception ex) {</span>
<span class="nc" id="L603">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L604">		}</span>
<span class="nc" id="L605">	}</span>

	private void notifyError(RequestContext context, Map appletResponse, Exception ex) {
<span class="nc" id="L608">		cat.l7dError(AmWebLogBundleKey.MSG_ERROR_UNABLETOLOADDATA, ex);</span>
<span class="nc" id="L609">		context.addPageMessage(new Message(Message.ERROR_TYPE, AmWebBundleKey.MSG_ERROR_UNABLETOLOADDATA, AmWebBundleKey.BUNDLE_NAME));</span>
<span class="nc" id="L610">		notifyClientOfError(appletResponse);</span>
<span class="nc" id="L611">	}</span>

	public static boolean isAdherenceLicensed() {
<span class="nc" id="L614">		boolean hasLicense = false;</span>
		try {
<span class="nc bnc" id="L616" title="All 2 branches missed.">			hasLicense = CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_ADHERENCE_EXPRESS) ||</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">                CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_ADHERENCE);</span>
<span class="nc" id="L618">		} catch (Exception ex){}</span>
<span class="nc" id="L619">		return hasLicense;</span>
	}
    
    /**
     * Tells us whether or not the application is licensed for ULTRA (QM10 or QM11). 
     * @param storeResult Do you want to store the result in the response?
     * @return true if ULTRA license is present, false if not, and null if error.
     */
    private Boolean checkUltraLicense(RequestContext context, Map appletResponse, boolean storeResult)
    {
<span class="nc" id="L629">        Boolean hasLicense = null;</span>
        try 
        {
<span class="nc bnc" id="L632" title="All 2 branches missed.">            hasLicense = new Boolean(CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_ULTRA) ||</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">            		CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_ULTRA_V11));</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">            if (storeResult)</span>
<span class="nc" id="L635">                appletResponse.put(AdherenceKeys.CHECK_ULTRA_LICENSE, hasLicense);</span>
        } 
<span class="nc" id="L637">        catch (Exception ex) </span>
        {
<span class="nc" id="L639">            notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L640">        }</span>
<span class="nc" id="L641">        return hasLicense;</span>
    }
    
    /**
     * Tells us whether or not the application is licensed for Balance (QM78). 
     * @param storeResult Do you want to store the result in the response?
     * @return true if BALANCE license is present, false if not, and null if error.
     */
    private Boolean checkBalanceLicense(RequestContext context, Map appletResponse, boolean storeResult)
    {
<span class="nc" id="L651">        Boolean hasLicense = null;</span>
        try 
        {
<span class="nc" id="L654">            hasLicense = new Boolean(CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_QM));</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">            if (storeResult)</span>
<span class="nc" id="L656">                appletResponse.put(AdherenceKeys.CHECK_BALANCE_LICENSE, hasLicense);</span>
        } 
<span class="nc" id="L658">        catch (Exception ex) </span>
        {
<span class="nc" id="L660">            notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L661">        }</span>
<span class="nc" id="L662">        return hasLicense;</span>
    }    
    
<span class="fc" id="L665">    private static String ADHERE_APPLET_NOT_SHOW_1MINUTE_EXCEPTION = &quot;adherence/applet/NoShow1minuteException&quot;;</span>
    private Boolean checkIsNotShow1MinuteException(RequestContext context, Map appletResponse)
    {
<span class="nc" id="L668">        Boolean isNotShow = false; //default is showing</span>
        try 
        {
<span class="nc" id="L671">        	isNotShow = new Boolean(BbmManagerFactory.getDBConfigManager().getValue(ADHERE_APPLET_NOT_SHOW_1MINUTE_EXCEPTION));</span>
        } 
<span class="nc" id="L673">        catch (Exception ex) </span>
        {
<span class="nc" id="L675">            notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L676">        }</span>
<span class="nc" id="L677">        return isNotShow;</span>
    } 
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>