<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffRequestUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.timeoff</a> &gt; <span class="el_source">TimeOffRequestUtil.java</span></div><h1>TimeOffRequestUtil.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.timeoff;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.DateTimeUtil;
import com.bluepumpkin.common.util.NumberFactory;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.rm.base.RmRuntimeException;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDay;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.TimeOffIntervalAllocationUtil;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.ejb.TimeOffIntervalAllocationManager;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.FlexRequestMakeup;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.ejb.rm.util.TORequestUtil;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestUtil;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagecomponent.table.GenericHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title: TimeOffRequestUtil Description: Time Off Request Util class Copyright: Copyright (c) 2002 Company: Blue Pumpkin
 * Software, Inc
 * @author David Su, dsu
 * @version 1.0
 *
 *          Created on November 8, 2002, 3:25 PM
 */
public final class TimeOffRequestUtil {
	private static final String TO_CHOICE_ID_FN = &quot;tOChoiceID&quot;;
	private static final int TIME_INTERVAL = 15; //Default
	private static final int STRING_CAPACITY = 100;
	/** Creates a new instance of TimeOffRequestUtil */
<span class="nc" id="L65">	private TimeOffRequestUtil() {</span>
<span class="nc" id="L66">	}</span>

	/**
	 * Add Time Off Workflow not Active Message
	 */
	public static void addTONotActiveMsg(PageModel model) {
<span class="nc" id="L72">		model.addPageMessage(Message.INFO_TYPE, RmWebBundleKey.TIMEOFF_WORKFLOW_NOT_ACTIVE, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L73">	}</span>

	/**
	 * Add Flex Time not Active Message
	 */
	public static void addFTNotActiveMsg(PageModel model) {
<span class="nc" id="L79">		model.addPageMessage(Message.INFO_TYPE, RmWebBundleKey.FLEXTIME_WORKFLOW_NOT_ACTIVE, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L80">	}</span>

	/**
	 * Initialize Time Off Choice List Container
	 */
	@SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
	public static void initTimeOffChoiceListPC(RequestContext context, MultiColListPC choiceListPC, TORequest request, ID selectedID,
			ResourceBundle coreBundle, ResourceBundle rmBundle, TimeOffChoiceListPCConfig config) {
<span class="fc" id="L88">		choiceListPC.setIsRowNumberEnabled(true);</span>
<span class="fc" id="L89">		choiceListPC.setHeightInPixels(150);</span>

<span class="fc" id="L91">		Localizer localizer = context.getLocalizer();</span>
<span class="fc" id="L92">		TimeZone viewingTZ = context.getViewingTimeZone();</span>

		// Init Header
<span class="fc" id="L95">		TableHeaderPC headerPC = choiceListPC.getHeader();</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">		if (config.getIsSelectable()) {</span>
<span class="nc" id="L97">			headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(coreBundle, UIFWebBundleKey.SELECTED));</span>
		}

<span class="fc" id="L100">		headerPC.setIsRowNumberEnabled(config.getIsRowNumberEnabled());</span>
<span class="fc" id="L101">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, config.getTimeOffChoiceLabelBundleKey()));</span>
<span class="fc" id="L102">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(coreBundle, UIFWebBundleKey.LENGTH));</span>
<span class="fc" id="L103">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_LABEL));</span>

<span class="pc bpc" id="L105" title="1 of 2 branches missed.">		if (config.getIsShowAlert()) {</span>
<span class="fc" id="L106">			headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_CHOICES_ALERTS));</span>
		}

		// Populate List Model
<span class="fc" id="L110">		Collection&lt;TOChoice&gt; choiceList = request.getRequestChoiceList();</span>
<span class="fc" id="L111">		List listModel = Collections.emptyList();</span>

<span class="pc bpc" id="L113" title="1 of 2 branches missed.">		if (!choiceList.isEmpty()) {</span>
<span class="fc" id="L114">			listModel = new ArrayList(choiceList.size());</span>
<span class="fc" id="L115">			boolean isSelectedChoice = false;</span>
<span class="fc" id="L116">			boolean assignSelectedChoice = false;</span>
			// Maintain a counter to add a label to the radio box to indicate number of the choice
<span class="fc" id="L118">			int choiceNum = 1;</span>
<span class="fc" id="L119">			String hdnLbl = &quot;&quot;;</span>
<span class="fc" id="L120">			TOChoice firstChoice = request.getFirstTOChoice();</span>
<span class="fc" id="L121">			boolean isFirsChoiceViolateSpecialRules  = isChoiceViolatedSpecialRules(firstChoice);</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">			for (Iterator&lt;TOChoice&gt; it = choiceList.iterator(); it.hasNext();) {</span>
<span class="fc" id="L123">				TOChoice choice = it.next();</span>
<span class="fc" id="L124">				hdnLbl = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_CHOICE_NUMBERED_MF,</span>
<span class="fc" id="L125">						new Object[] { NumberFactory.newInteger(choiceNum++) });</span>

<span class="pc bpc" id="L127" title="2 of 4 branches missed.">				if(choice.equals(firstChoice) &amp;&amp;isFirsChoiceViolateSpecialRules ){</span>
					//Always disabled the choice violate special rules
<span class="nc bnc" id="L129" title="All 2 branches missed.">					MultiColumnNodeData node = createChoiceNode(context, localizer, viewingTZ, choice, selectedID, !isFirsChoiceViolateSpecialRules, true, config,</span>
<span class="nc" id="L130">						rmBundle, request.isApproved(), hdnLbl);</span>
<span class="nc" id="L131">					listModel.add(node);</span>
<span class="nc" id="L132">				}</span>
				else {
<span class="pc bpc" id="L134" title="3 of 6 branches missed.">					boolean isDisabled = isChoiceViolatedSpecialRules(choice)? true:config.getIsShowSelectedInfo()&amp;&amp;!config.getIsSelectable();</span>
					//Will assign the first choice without special rule violation
<span class="pc bpc" id="L136" title="2 of 4 branches missed.">					if(!assignSelectedChoice &amp;&amp; !isDisabled) {</span>
<span class="nc" id="L137">						isSelectedChoice = true;</span>
<span class="nc" id="L138">						assignSelectedChoice = true;</span>
					}

<span class="fc" id="L141">					MultiColumnNodeData node = createChoiceNode(context, localizer, viewingTZ, choice, selectedID, isSelectedChoice,isDisabled,config,</span>
<span class="fc" id="L142">							rmBundle, request.isApproved(), hdnLbl);</span>
<span class="fc" id="L143">					listModel.add(node);</span>
				}
				//When assigning isSelectedChoice already, next other choices should not be selected choice
<span class="pc bpc" id="L146" title="3 of 4 branches missed.">				if(isSelectedChoice &amp;&amp; assignSelectedChoice) {</span>
<span class="nc" id="L147">					isSelectedChoice = false;</span>
				}
<span class="fc" id="L149">			}</span>
		}
<span class="fc" id="L151">		choiceListPC.setIsRowNumberEnabled(config.getIsRowNumberEnabled());</span>
<span class="fc" id="L152">		choiceListPC.setListModel(listModel);</span>
<span class="fc" id="L153">	}</span>
	private static boolean isChoiceViolatedSpecialRules(TOChoice choice){
<span class="fc" id="L155">		boolean result = false;</span>
<span class="fc" id="L156">		Collection&lt;ValidationResult&gt; listValidator = choice.getValidationResults(true);</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">		for (Iterator&lt;ValidationResult&gt; vIter = listValidator.iterator(); vIter.hasNext();) {</span>
<span class="fc" id="L158">			ValidationResult vResult = vIter.next();</span>
<span class="fc" id="L159">			result = TORequestUtil.checkHasSomeSpecificHardRulesViolated(vResult);</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">			if (result) {</span>
<span class="nc" id="L161">				break;</span>
			}
<span class="fc" id="L163">		}</span>
<span class="fc" id="L164">		return result;</span>
	}

	/**
	 * Create Time Off Choice Node
	 */
	private static MultiColumnNodeData createChoiceNode(RequestContext context, Localizer localizer, TimeZone tz, TOChoice choice,
			ID selectedID, boolean isFirstChoice, boolean isDisabled, TimeOffChoiceListPCConfig config, ResourceBundle rmBundle, boolean isApproved,
			String hiddenLabel) {
<span class="fc" id="L173">		Date startDate = choice.getStartDate();</span>
<span class="fc" id="L174">		Date endDate = choice.getEndDate();</span>

<span class="fc" id="L176">		DefaultMultiColumnNodeData node = new DefaultMultiColumnNodeData();</span>
<span class="fc" id="L177">		HtmlChoiceInput choiceInput = null;</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">		if (config.getIsShowSelectedInfo()) {</span>
<span class="fc" id="L179">			ID choiceID = choice.getID();</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">			boolean isChecked = (selectedID == null) ? isFirstChoice : choiceID.equals(selectedID);</span>
<span class="fc" id="L181">			choiceInput = HtmlChoiceInput</span>
<span class="fc" id="L182">					.newInstance(TO_CHOICE_ID_FN, choiceID.toString(), hiddenLabel, isChecked, JSUtil.ON_CHANGE, false);</span>
<span class="fc" id="L183">			choiceInput.setIsHiddenLabel(true);// Indicates this label is not for display but just for 508 compliance</span>
<span class="fc" id="L184">			choiceInput.setIsDisabled(isDisabled);</span>
<span class="pc bpc" id="L185" title="1 of 4 branches missed.">			if (isChecked &amp;&amp; isDisabled) {</span>
<span class="fc" id="L186">				choiceInput.setIsValueSubmittedWhenDisabled(true);</span>
			}
		}

<span class="fc" id="L190">		StringBuilder timePeriodSB = new StringBuilder(STRING_CAPACITY);</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">		if (choiceInput != null) {</span>
<span class="fc" id="L192">			timePeriodSB.append(choiceInput);</span>
		}
<span class="fc" id="L194">		timePeriodSB.append(RequestUtil.getDateDisplay(context, startDate)).append(&quot; - &quot;)</span>
<span class="fc" id="L195">				.append(RequestUtil.getDateDisplay(context, endDate));</span>
<span class="fc" id="L196">		node.add(timePeriodSB, CSSUtil.STYLE_NOWRAP);</span>

<span class="fc" id="L198">		String[] choiceLenAndAlerts = getTimeOffChoiceLenAndAlerts(choice, localizer, tz, rmBundle, isApproved,</span>
<span class="fc" id="L199">				config.getIsEnforceCustomTimeOffHoursFormat());</span>
		// if not show alert, remove the alert data that is the last item in the 3 item array.
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">		if (!config.getIsShowAlert()) {</span>
<span class="nc" id="L202">			choiceLenAndAlerts = new String[] { choiceLenAndAlerts[0], choiceLenAndAlerts[1] };</span>
		}

<span class="fc bfc" id="L205" title="All 2 branches covered.">		for (String data : choiceLenAndAlerts) {</span>
<span class="fc" id="L206">			node.add(data);</span>
		}

<span class="fc" id="L209">		return node;</span>
	}


	private static String getHoursAccountedForTOChoiceHtml(TOChoice choice, Localizer localizer, boolean isApproved,
			boolean enforceCustomTimeOffHoursFormat) {
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">		TOHoursPerDay hoursPerDay = choice == null ? null : choice.getHoursPerDay();</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">		long scheduledMins = hoursPerDay == null ? 0 : hoursPerDay.getTotalMinutesFromScheduled();</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">		long defaultMins = hoursPerDay == null ? 0 : hoursPerDay.getTotalMinutesFromDefaulted();</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">		boolean hasScheduledMins = scheduledMins &gt; 0;</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">		boolean hasDefaultMins = defaultMins &gt; 0;</span>
<span class="fc" id="L220">		String acountedLen = getHoursAccountedForTOChoice(choice, localizer, isApproved, enforceCustomTimeOffHoursFormat);</span>
<span class="fc" id="L221">		long accountedMinutes = (long) (choice.getLength() * 60);</span>

<span class="pc bpc" id="L223" title="1 of 6 branches missed.">		if (accountedMinutes &lt;= 0 || (!hasScheduledMins &amp;&amp; !hasDefaultMins)) {</span>
			// No tooltip or tooltip icon if both scheduled and default minutes are zero
<span class="fc" id="L225">			return acountedLen;</span>
		}

<span class="fc" id="L228">		String scheduleHoursTooltip = &quot;&quot;;</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">		if (hasScheduledMins) {</span>
<span class="fc" id="L230">			scheduleHoursTooltip = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_TOOLTIP_SCHEDULED,</span>
<span class="fc" id="L231">					TimeOffRequestUtil.formatDurationInMinutes(localizer, scheduledMins, enforceCustomTimeOffHoursFormat));</span>
		}

<span class="fc" id="L234">		String defaultHoursTooltip = &quot;&quot;;</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">		if (hasDefaultMins) {</span>
<span class="fc" id="L236">			defaultHoursTooltip = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_TOOLTIP_DEFAULT,</span>
<span class="fc" id="L237">					TimeOffRequestUtil.formatDurationInMinutes(localizer, defaultMins, enforceCustomTimeOffHoursFormat));</span>
		}

<span class="pc bpc" id="L240" title="1 of 4 branches missed.">		String tooltip = String.format(&quot;%s%s%s&quot;,</span>
		// these comments are to keep the eclipse buggy formatter happy
				scheduleHoursTooltip,
				// add a &lt;br&gt; if we have both scheduled and default minutes
				hasScheduledMins &amp;&amp; hasDefaultMins ? &quot;&lt;br&gt;&quot; : &quot;&quot;,
				// default hours
				defaultHoursTooltip);

<span class="fc" id="L248">		tooltip = appendReferenceScheduleHours(choice, tooltip, localizer);</span>
<span class="fc" id="L249">		String alertIcon = HtmlUtil.imageTag(ImageFileID.TOOLTIP_BUTTON, tooltip);</span>
<span class="fc" id="L250">		return String.format(&quot;%s %s&quot;, acountedLen, alertIcon);</span>
	}

	private static String appendReferenceScheduleHours(TOChoice choice, String tooltip, Localizer localizer) {
<span class="fc" id="L254">		ID refScheduleId = choice.getReferenceScheduleID();</span>
<span class="pc bpc" id="L255" title="3 of 4 branches missed.">		if (refScheduleId == null || refScheduleId.toInt() &lt; 0) {</span>
<span class="fc" id="L256">			return tooltip;</span>
		}

		try {
<span class="nc" id="L260">			TimeOffIntervalAllocationManager mgr = TimeOffIntervalAllocationUtil.getMgr();</span>
<span class="nc" id="L261">			Map&lt;Integer, Pair&lt;Integer, Integer&gt;&gt; refSchedules = mgr.getRefrenceSchedulesByDayOfWeek(choice);</span>
<span class="nc" id="L262">			return appendReferenceScheduleHours(tooltip, localizer, refSchedules);</span>

<span class="nc" id="L264">		} catch (Exception e) {</span>
<span class="nc" id="L265">			throw new RmRuntimeException(&quot;Could not get TimeOffInterval manager for reference schedule tooltip data&quot;, e);</span>
		}

	}

	static String appendReferenceScheduleHours(String tooltip, Localizer localizer, Map&lt;Integer, Pair&lt;Integer, Integer&gt;&gt; refSchedules) {

<span class="nc bnc" id="L272" title="All 2 branches missed.">		if (refSchedules.isEmpty()) {</span>
<span class="nc" id="L273">			return tooltip;</span>
		}

<span class="nc" id="L276">		String[] dowNames = localizer.getWeekdayNames(false);</span>
<span class="nc" id="L277">		StringBuilder refScheduleTooltip = new StringBuilder(&quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L278">		String header = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_TOOLTIP_REF_SCHEDULE_HEADER);</span>
<span class="nc" id="L279">		refScheduleTooltip.append(header + &quot;&lt;table&gt;&quot;);</span>

<span class="nc bnc" id="L281" title="All 2 branches missed.">		for (Map.Entry&lt;Integer, Pair&lt;Integer, Integer&gt;&gt; entry : refSchedules.entrySet()) {</span>
<span class="nc" id="L282">			int dow = entry.getKey();</span>
<span class="nc" id="L283">			Pair&lt;Integer, Integer&gt; startAndDuration = entry.getValue();</span>
<span class="nc" id="L284">			int start = startAndDuration.getFirst();</span>
<span class="nc" id="L285">			int end = start + startAndDuration.getSecond();</span>
<span class="nc" id="L286">			String dayText = String.format(&quot;&lt;tr&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;-&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt; &lt;/tr&gt;&quot;, dowNames[dow],</span>
<span class="nc" id="L287">					localizer.formatTimeInMins(start), localizer.formatTimeInMins(end));</span>
<span class="nc" id="L288">			refScheduleTooltip.append(dayText);</span>
<span class="nc" id="L289">		}</span>

<span class="nc" id="L291">		refScheduleTooltip.append(&quot;&lt;/table&gt;&quot;);</span>
<span class="nc" id="L292">		return tooltip + refScheduleTooltip;</span>
	}

	public static String[] getTimeOffChoiceLenAndAlerts(TOChoice choice, Localizer localizer, TimeZone tz, ResourceBundle rmBundle,
			boolean isApproved, boolean enforceCustomTimeOffHoursFormat) {

<span class="fc" id="L298">		return getTimeOffChoiceLenAndAlertsWithPrintAccountedHours( choice,  localizer,  tz,  rmBundle, isApproved, true, true);</span>
	}
	/**
	 * Returns a list with 3 elements: Time Of Choice Length, hours accounted, and Alerts
	 */
	public static String[] getTimeOffChoiceLenAndAlertsWithPrintAccountedHours(TOChoice choice, Localizer localizer, TimeZone tz, ResourceBundle rmBundle,
			boolean isApproved, boolean enforceCustomTimeOffHoursFormat, boolean printAccountedHours) {
<span class="fc" id="L305">		String[] result = new String[3];</span>
<span class="fc" id="L306">		int counter = 0;</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">		if (choice == null) {</span>
<span class="fc" id="L308">			result[counter] = null;</span>
<span class="fc" id="L309">			counter++;</span>
<span class="fc" id="L310">			result[counter] = null;</span>
<span class="fc" id="L311">			counter++;</span>
<span class="fc" id="L312">			result[counter] = null;</span>
		} else {
			// length
<span class="fc" id="L315">			String len = getTOChoiceLen(choice, localizer, rmBundle);</span>
			// Waitlist ICON
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">			if (choice.isWaitlist()) {</span>
<span class="nc" id="L318">				String imgSrc = ImageFileID.STATUS_WAITLIST;</span>
<span class="nc" id="L319">				String imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.STATUS_WAITLIST);</span>
<span class="nc" id="L320">				String waitlistIconHtmlStr = HtmlUtil.imageTag(imgSrc, imgAlt);</span>
<span class="nc" id="L321">				len = waitlistIconHtmlStr + &quot;&amp;nbsp;&quot; + len;</span>
			}
<span class="fc" id="L323">			result[counter] = len;</span>
<span class="fc" id="L324">			counter++;</span>

			// hours accounted

			// If there is an invalid choice in the setup dialog, we do not want to print anything since there
			// may be a valid choice which here is printed as 0.00--misleading. Compromise by not outputting anything.
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">			if ( printAccountedHours ) {</span>
<span class="fc" id="L331">				String accountedHoursHtml = TimeOffRequestUtil.getHoursAccountedForTOChoiceHtml(choice, localizer, isApproved,</span>
						enforceCustomTimeOffHoursFormat);
<span class="fc" id="L333">				result[counter] = accountedHoursHtml;</span>
			}

<span class="fc" id="L336">			counter++;</span>
<span class="fc" id="L337">			Collection&lt;ValidationResult&gt; valResults = choice.getValidationResults(true);</span>
<span class="fc" id="L338">			String alertInfo = RequestUtil.createAlertIconsWithMsg(valResults, localizer, tz);</span>
<span class="fc" id="L339">			result[counter] = alertInfo;</span>
		}
<span class="fc" id="L341">		return result;</span>
	}

	/**
	 * Return the resource bundle Key to localize Debit Type
	 */
	public static String getDebitTypeRBKey(String debitType) {
<span class="fc" id="L348">		String result = debitType;</span>

<span class="fc bfc" id="L350" title="All 2 branches covered.">		if (TORequest.DEBITTYPE_DEBIT.equals(debitType)) {</span>
<span class="fc" id="L351">			result = RmWebBundleKey.TIMEOFF_DEBITTYPE_DEBIT;</span>
<span class="fc bfc" id="L352" title="All 2 branches covered.">		} else if (TORequest.DEBITTYPE_DEBIT_ONLY_IF.equals(debitType)) {</span>
<span class="fc" id="L353">			result = RmWebBundleKey.TIMEOFF_DEBITTYPE_DEBIT_ONLY_IF;</span>
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">		} else if (TORequest.DEBITTYPE_DONT_DEBIT.equals(debitType)) {</span>
<span class="fc" id="L355">			result = RmWebBundleKey.TIMEOFF_DEBITTYPE_DONT_DEBIT;</span>
		}

<span class="fc" id="L358">		return result;</span>
	}

	/**
	 * Add Time Off Choice Header
	 *
	 * @param coreBundle - The Core Resource Bundle
	 * @param rmBundle - The Request Management Resource Bundle
	 * @param headerPC - The Header to add data to
	 * @param isMy - pass true for the &quot;My Requests&quot; page, false for the &quot;Employee Requests&quot; page
	 */
	public static void addTOChoiceHeader(ResourceBundle coreBundle, ResourceBundle rmBundle, Localizer localizer, TableHeaderPC headerPC,
			boolean isMy) {
<span class="nc bnc" id="L371" title="All 2 branches missed.">		if (isMy) {</span>
<span class="nc" id="L372">			addHeaderData(headerPC, coreBundle, localizer, UIFWebBundleKey.START_DATE, true);</span>
<span class="nc" id="L373">			addHeaderData(headerPC, coreBundle, localizer, UIFWebBundleKey.END_DATE, true);</span>
		}

<span class="nc" id="L376">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(coreBundle, UIFWebBundleKey.LENGTH), false);</span>
<span class="nc" id="L377">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_LABEL), false);</span>
<span class="nc" id="L378">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_CHOICES_ALERTS), false);</span>
<span class="nc" id="L379">	}</span>

	/**
	 * Add Flex Time Request-specific Column Headers to the list page
	 *
	 * @param coreBundle - The Core Resource Bundle
	 * @param rmBundle - The Request Management Resource Bundle
	 * @param headerPC - The Header to add data to
	 * @param isMy - pass true for the &quot;My Requests&quot; page, false for the &quot;Employee Requests&quot; page
	 */
	public static void addFTChoiceHeader(ResourceBundle rmBundle, Localizer localizer, TableHeaderPC headerPC, boolean isMy) {
<span class="nc bnc" id="L390" title="All 2 branches missed.">		if (isMy) {</span>
<span class="nc" id="L391">			addHeaderData(headerPC, rmBundle, localizer, RmWebBundleKey.TIMEOFF_START_DATE_LABEL, true);</span>
<span class="nc" id="L392">			addHeaderData(headerPC, rmBundle, localizer, RmWebBundleKey.TIMEOFF_END_DATE_LABEL, true);</span>
		}

<span class="nc" id="L395">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_LENGTH_LABEL), false);</span>
<span class="nc" id="L396">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_LABEL), false);</span>

<span class="nc bnc" id="L398" title="All 2 branches missed.">		if (isMy) {</span>
<span class="nc" id="L399">			addHeaderData(headerPC, rmBundle, localizer, RmWebBundleKey.MAKEUP_START_DATE_LABEL, true);</span>
<span class="nc" id="L400">			addHeaderData(headerPC, rmBundle, localizer, RmWebBundleKey.MAKEUP_END_DATE_LABEL, true);</span>
		}
<span class="nc" id="L402">	}</span>

	/**
	 * Convinience Method to add Header Data
	 */
	protected static void addHeaderData(TableHeaderPC header, ResourceBundle bundle, Localizer localizer, String rbKey, boolean isSortable) {
<span class="nc" id="L408">		GenericHeaderData hdrData = header.addColumnHeaderData(rbKey, localizer.i18n(bundle, rbKey), isSortable);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">		if (hdrData.getSortable()) {</span>
<span class="nc" id="L410">			String displayName = hdrData.getDisplayName();</span>
<span class="nc" id="L411">			hdrData.setDisplayName(displayName);</span>
		}
<span class="nc" id="L413">	}</span>

	/**
	 * Add TimeOff Choice Info to Multi Column Node Data
	 */
	public static void addTOChoiceInfo(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			ResourceBundle rmBundle, boolean isForTimeOff) {
<span class="nc" id="L420">		addTOChoiceInfo(request, context, rowData, rmBundle, false, true, false,isForTimeOff);</span>
<span class="nc" id="L421">	}</span>
	/**
	 * Add Flex Time Off Choice Info to Multi Column Node Data
	 */
	public static void addTOChoiceInfo(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			ResourceBundle rmBundle) {
<span class="nc" id="L427">		addTOChoiceInfo(request, context, rowData, rmBundle,false);</span>
<span class="nc" id="L428">	}</span>

	/**
	 * Add time off / flex time choice column data to a single request row.
	 * @param request
	 * @param context
	 * @param rowData
	 * @param rmBundle
	 * @param incStartEnd - should we include start date/end date column data?
	 * @param incAlerts - should we include the Choice Alerts column data?
	 * @param enforceCustomTimeOffHoursFormat
	 * @param isForTimeOff- true : for TimeOff, false: Flex time
	 */
	public static void addTOChoiceInfo(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			ResourceBundle rmBundle, boolean incStartEnd, boolean incAlerts, boolean enforceCustomTimeOffHoursFormat, boolean isForTimeOff) {
<span class="nc bnc" id="L443" title="All 2 branches missed.">		boolean align = request.getRequestChoiceList().size() &gt; 1 ? true : false;</span>
<span class="nc" id="L444">		ID approvedChoiceId = request.getApprovedChoiceID();</span>
<span class="nc" id="L445">		boolean approvedStatus = request.isApproved();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">		if (incStartEnd) {</span>
<span class="nc" id="L447">			addStartOrEndDateData(request, context, rowData, true,isForTimeOff);</span>
<span class="nc" id="L448">			addStartOrEndDateData(request, context, rowData, false,isForTimeOff);</span>
		}
<span class="nc" id="L450">		StringBuilder timePeriodLenSB = new StringBuilder(STRING_CAPACITY);</span>
<span class="nc" id="L451">		StringBuilder hoursAccountedSB = new StringBuilder(STRING_CAPACITY);</span>
<span class="nc" id="L452">		StringBuilder timePeriodAlertsSB = new StringBuilder(STRING_CAPACITY);</span>

<span class="nc" id="L454">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L455">		int numberOfChoice= request.getRequestChoiceList().size();</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">		for (Iterator&lt;TOChoice&gt; it = request.getRequestChoiceList().iterator(); it.hasNext();) {</span>
<span class="nc" id="L457">			TOChoice toChoice = it.next();</span>
<span class="nc bnc" id="L458" title="All 8 branches missed.">			boolean isBoldText = numberOfChoice&gt;1 &amp;&amp; isForTimeOff&amp;&amp;approvedStatus&amp;&amp;makeApprovedChoiceBeBold(approvedChoiceId, toChoice.getID());</span>
<span class="nc" id="L459">			appendTimePeriodLen(toChoice, localizer, timePeriodLenSB, rmBundle, align, isBoldText);</span>
<span class="nc" id="L460">			appendHoursAccounted(toChoice, localizer, hoursAccountedSB, approvedStatus, enforceCustomTimeOffHoursFormat, align,</span>
					isBoldText);
<span class="nc bnc" id="L462" title="All 2 branches missed.">			if (incAlerts) {</span>
<span class="nc" id="L463">				appendTimeAlertsPeriod(toChoice, localizer, timePeriodAlertsSB, align);</span>
			}
<span class="nc" id="L465">		}</span>

<span class="nc" id="L467">		rowData.add(timePeriodLenSB);</span>
<span class="nc" id="L468">		rowData.add(hoursAccountedSB);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">		if (incAlerts) {</span>
<span class="nc" id="L470">			rowData.add(timePeriodAlertsSB);</span>
		}
<span class="nc" id="L472">	}</span>
	/**
	 * Add flex time choice column data to a single request row.
	 * @param request
	 * @param context
	 * @param rowData
	 * @param rmBundle
	 * @param incStartEnd - should we include start date/end date column data?
	 * @param incAlerts - should we include the Choice Alerts column data?
	 * @param enforceCustomTimeOffHoursFormat
	 */
	public static void addTOChoiceInfo(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			ResourceBundle rmBundle, boolean incStartEnd, boolean incAlerts, boolean enforceCustomTimeOffHoursFormat){
<span class="nc" id="L485">		addTOChoiceInfo(request,context,rowData,rmBundle,incStartEnd,incAlerts,enforceCustomTimeOffHoursFormat,false);</span>
<span class="nc" id="L486">	}</span>
	/**
	 * With new group action &quot;Approve Time Off Choice without violation&quot; for Advanced RM License,
	 * Any choice of a TO request can be approved.It is not a first choice as before.
	 * Therefore, we need to make the approved Choice as bold as indicator for manager to know
	 * */
	private static boolean makeApprovedChoiceBeBold(ID approvedChoiceId, ID choiceID) {
<span class="nc" id="L493">		boolean result = LicenseUtil.isAdvancedRMLicense();</span>
<span class="nc bnc" id="L494" title="All 6 branches missed.">		result = result &amp;&amp; approvedChoiceId != null &amp;&amp; approvedChoiceId.equals(choiceID) ? true : false;</span>
<span class="nc" id="L495">		return result;</span>
	}

	/**
	 * Add Flex Request Makeup column data to a single request row.
	 * @param request
	 * @param context
	 * @param rowData
	 * @param rmBundle
	 */
	public static void addMakeupInfo(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData, ResourceBundle rmBundle) {
<span class="nc" id="L506">		addMakeupStartOrEndDateData(request, context, rowData, true);</span>
<span class="nc" id="L507">		addMakeupStartOrEndDateData(request, context, rowData, false);</span>
<span class="nc" id="L508">	}</span>

	/**
	 * Append Makeup Start Dates or Makeup End Dates of all Flex Time Makeups for one request to row_data
	 */
	public static void addMakeupStartOrEndDateData(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			boolean isStart) {
<span class="nc" id="L515">		StringBuilder timePeriodSB = new StringBuilder(STRING_CAPACITY);</span>
<span class="nc" id="L516">		Calendar cal = Calendar.getInstance(context.getViewingTimeZone());</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">		boolean align = request.getFlexRequestMakeupList().size() &gt; 1 ? true : false;</span>

<span class="nc bnc" id="L519" title="All 2 branches missed.">		for (FlexRequestMakeup makeup : request.getFlexRequestMakeupList()) {</span>
<span class="nc" id="L520">			Date startTime = null;</span>
<span class="nc" id="L521">			Date endTime = null;</span>

<span class="nc bnc" id="L523" title="All 2 branches missed.">			if (makeup.getExtBeforeActivityID() != null) {</span>
<span class="nc" id="L524">				cal.setTime(makeup.getShiftStartTime());</span>
<span class="nc" id="L525">				cal.add(Calendar.MINUTE, -(makeup.getExtBeforeGap() + makeup.getExtBeforeDuration()));</span>
<span class="nc" id="L526">				startTime = cal.getTime();</span>
<span class="nc" id="L527">				cal.add(Calendar.MINUTE, makeup.getExtBeforeDuration());</span>
<span class="nc" id="L528">				endTime = cal.getTime();</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">				appendTimePeriodDate(isStart ? startTime : endTime, context, timePeriodSB, align);</span>
			}

<span class="nc bnc" id="L532" title="All 2 branches missed.">			if (makeup.getExtAfterActivityID() != null) {</span>
<span class="nc" id="L533">				cal.setTime(makeup.getShiftEndTime());</span>
<span class="nc" id="L534">				cal.add(Calendar.MINUTE, (makeup.getExtAfterGap()));</span>
<span class="nc" id="L535">				startTime = cal.getTime();</span>
<span class="nc" id="L536">				cal.add(Calendar.MINUTE, (makeup.getExtAfterDuration()));</span>
<span class="nc" id="L537">				endTime = cal.getTime();</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">				appendTimePeriodDate(isStart ? startTime : endTime, context, timePeriodSB, align);</span>
			}
<span class="nc" id="L540">		}</span>
<span class="nc" id="L541">		rowData.add(timePeriodSB);</span>
<span class="nc" id="L542">	}</span>

	/**
	 * Append Makeup Activity of all Flex Time Makeups for one request to row_data
	 */
	public static void addMakeupActivityData(TORequest request, RequestContext context, DefaultMultiColumnNodeData row_data,
			Map&lt;ID, String&gt; activityId2Name) {
<span class="nc" id="L549">		StringBuilder buf = new StringBuilder(STRING_CAPACITY);</span>
<span class="nc" id="L550">		Calendar cal = Calendar.getInstance(context.getViewingTimeZone());</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">		boolean align = request.getFlexRequestMakeupList().size() &gt; 1 ? true : false;</span>

<span class="nc bnc" id="L553" title="All 2 branches missed.">		for (FlexRequestMakeup makeup : request.getFlexRequestMakeupList()) {</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">			if (makeup.getExtBeforeActivityID() != null) {</span>
<span class="nc" id="L555">				append(buf, activityId2Name.get(makeup.getExtBeforeActivityID()), align);</span>
			}

<span class="nc bnc" id="L558" title="All 2 branches missed.">			if (makeup.getExtAfterActivityID() != null) {</span>
<span class="nc" id="L559">				append(buf, activityId2Name.get(makeup.getExtAfterActivityID()), align);</span>
			}
<span class="nc" id="L561">		}</span>
<span class="nc" id="L562">		row_data.add(buf);</span>
<span class="nc" id="L563">	}</span>

	/**
	 * Append Start Dates or End Dates of all Time Off Choices for one request to rowData
	 */
	public static void addStartOrEndDateData(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			boolean isStart, boolean isForTimeOff) {
<span class="nc" id="L570">		StringBuilder timePeriodSB = new StringBuilder(STRING_CAPACITY);</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">		boolean align = request.getRequestChoiceList().size() &gt; 1 ? true : false;</span>
<span class="nc" id="L572">		ID approvedChoiceId = request.getApprovedChoiceID();</span>
<span class="nc" id="L573">		boolean approvedStatus = request.isApproved();</span>
<span class="nc" id="L574">		int numberOfChoice= request.getRequestChoiceList().size();</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">		for (Iterator&lt;TOChoice&gt; it = request.getRequestChoiceList().iterator(); it.hasNext();) {</span>
<span class="nc" id="L576">			TOChoice toChoice = it.next();</span>
<span class="nc bnc" id="L577" title="All 8 branches missed.">			boolean isBoldText =numberOfChoice&gt;1&amp;&amp; isForTimeOff &amp;&amp; approvedStatus &amp;&amp; makeApprovedChoiceBeBold(approvedChoiceId, toChoice.getID());</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">			if (isStart) {</span>
<span class="nc" id="L579">				appendTimePeriodDate(toChoice.getStartDate(), context, timePeriodSB, align, isBoldText);</span>
			} else {
<span class="nc" id="L581">				appendTimePeriodDate(toChoice.getEndDate(), context, timePeriodSB, align, isBoldText);</span>
			}
<span class="nc" id="L583">		}</span>

<span class="nc" id="L585">		rowData.add(timePeriodSB);</span>
<span class="nc" id="L586">	}</span>
	/**
	 * Append Start Dates or End Dates of Flex Time Choice for one request to rowData
	 */
	public static void addStartOrEndDateData(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			boolean isStart) {
<span class="nc" id="L592">		addStartOrEndDateData(request,context,rowData,isStart,false);</span>
<span class="nc" id="L593">	}</span>

	/**
	 * Append Time Off Period of the specified Time Off Choice to StringBuffer
	 */
	private static void appendTimePeriodDate(Date date, RequestContext context, StringBuilder sb, boolean align) {
<span class="nc" id="L599">		appendTimePeriodDate(date, context, sb, align, false);</span>
<span class="nc" id="L600">	}</span>

	private static void appendTimePeriodDate(Date date, RequestContext context, StringBuilder sb, boolean align, boolean isBold) {
<span class="nc" id="L603">		String dateDisplay = RequestUtil.getDateDisplay(context, date);</span>
<span class="nc" id="L604">		append(sb, dateDisplay, align, isBold);</span>
<span class="nc" id="L605">	}</span>

	/**
	 * Append Time Off Period Length of the specified Time Off Choice to StringBuffer
	 */

	private static void appendTimePeriodLen(TOChoice choice, Localizer localizer, StringBuilder sb, ResourceBundle rmBundle, boolean align,
			boolean isBold) {
<span class="nc" id="L613">		append(sb, getTOChoiceLen(choice, localizer, rmBundle), align, isBold);</span>
<span class="nc" id="L614">	}</span>

	/**
	 * Append hours accounted of the specified Time Off Choice to StringBuffer
	 */

	private static void appendHoursAccounted(TOChoice choice, Localizer localizer, StringBuilder sb, boolean isApproved,
			boolean enforceCustomTimeOffHoursFormat, boolean align, boolean isBold) {
<span class="nc" id="L622">		append(sb, getHoursAccountedForTOChoice(choice, localizer, isApproved, enforceCustomTimeOffHoursFormat), align, isBold);</span>
<span class="nc" id="L623">	}</span>

	/**
	 * Return Formatted Time Off Choice Length
	 */
	public static String getTOChoiceLen(TOChoice choice, Localizer localizer, ResourceBundle rmBundle) {
<span class="pc bpc" id="L629" title="3 of 4 branches missed.">		if (choice.getStartDate() == null &amp;&amp; choice.getEndDate() == null) {</span>
<span class="nc" id="L630">			return &quot;&quot;;</span>
		}
<span class="fc" id="L632">		long minuteLen = (choice.getEndDate().getTime() - choice.getStartDate().getTime()) / (1000 * 60);</span>
<span class="fc" id="L633">		return getLengthStrFromMinutes(minuteLen, localizer, rmBundle);</span>
	}

	public static String getLengthStrFromMinutes(long minuteLen, Localizer localizer, ResourceBundle rmBundle) {
		// get string days, hours, minutes

<span class="fc" id="L639">		StringBuffer lengthBuf = new StringBuffer(256);</span>
<span class="fc" id="L640">		long days = minuteLen / (24 * 60);</span>

<span class="fc bfc" id="L642" title="All 2 branches covered.">		if (days != 0) {</span>
<span class="pc bpc" id="L643" title="1 of 2 branches missed.">			if (days &gt;= 7) {</span>
<span class="nc" id="L644">				lengthBuf.append(days / 7 + &quot; &quot; + localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_WEEKS) + &quot; &quot;);</span>
			}
<span class="pc bpc" id="L646" title="1 of 2 branches missed.">			if (days % 7 &gt;= 1) {</span>
<span class="fc" id="L647">				lengthBuf.append(Math.abs(days % 7) + &quot; &quot; + localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_DAYS) + &quot; &quot;);</span>
			}
		}
<span class="fc bfc" id="L650" title="All 2 branches covered.">		if (minuteLen % (24 * 60) != 0) {</span>
			// get hours
<span class="fc" id="L652">			long hours = Math.abs((minuteLen - days * 24 * 60) / 60);</span>
<span class="fc" id="L653">			lengthBuf.append(hours + &quot; &quot; + localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_HOURS) + &quot; &quot;);</span>
<span class="fc" id="L654">			long minutes = minuteLen - (hours * 60 + days * 24 * 60);</span>
<span class="pc bpc" id="L655" title="1 of 2 branches missed.">			if (minutes &gt; 0) {</span>
<span class="nc" id="L656">				lengthBuf.append(minutes + &quot; &quot; + localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_MINUTES));</span>
			}
		}

<span class="fc" id="L660">		return lengthBuf.toString();</span>
	}

	/**
	 * Return Formatted hours accounted for Time Off Choice Length
	 */

	public static String getHoursAccountedForTOChoice(TOChoice choice, Localizer localizer, boolean isApproved,
			boolean enforceCustomTimeOffHoursFormat) {
<span class="pc bpc" id="L669" title="1 of 4 branches missed.">		if (enforceCustomTimeOffHoursFormat || enabledCustomTimeOffHoursFormat()) {</span>
<span class="fc bfc" id="L670" title="All 2 branches covered.">			return getMinutesDisplay(localizer, (long) (choice.getLength() * 60))</span>
<span class="fc" id="L671">					+ (isApproved ? &quot; ( &quot; + getMinutesDisplay(localizer, choice.getHoursPerDay().getOriginalMinutes()) + &quot; )&quot; : &quot;&quot;);</span>
		} else {
<span class="fc bfc" id="L673" title="All 2 branches covered.">			return localizer.formatNumber(choice.getLength(), 2)</span>
<span class="fc" id="L674">					+ (isApproved ? &quot; ( &quot; + localizer.formatNumber(choice.getHoursPerDay().getOriginalMinutes() / 60f, 2) + &quot; )&quot; : &quot;&quot;);</span>
		}
	}

	/**
	 * Display as HH:MM from the minutes while padding hours and minutes to two chars. Number of minutes should be divisible
	 * by 15. This doesn't handle negative durations yet. If you only need a simple duration with no padding use
	 * localizer.formatDurationInMins(mins). Ex: 90 minutes will show: 1:30
	 */
	public static String getMinutesDisplay(Localizer localizer, long minutes) {
<span class="pc bpc" id="L684" title="1 of 2 branches missed.">		if (minutes &lt; 0) {</span>
<span class="nc" id="L685">			throw new IllegalArgumentException(String.format(&quot;Negative minutes ('%d') is not supported.&quot;, minutes));</span>
		}
<span class="fc" id="L687">		String durationSeparator = localizer.i18n(RegionalFormatBundleKey.BUNDLE_NAME, RegionalFormatBundleKey.DURATION_SEPARATOR);</span>
<span class="fc" id="L688">		int hours = new Double(Math.floor((double) minutes / 60)).intValue();</span>
<span class="fc" id="L689">		long remainingMins = minutes - (hours * 60);</span>

<span class="fc" id="L691">		return String.format(&quot;%02d%s%02d&quot;, hours, durationSeparator, remainingMins);</span>
	}

	private static String formatDurationInMinutes(Localizer localizer, long minutes, boolean enforceCustomTimeOffHoursFormat) {
<span class="pc bpc" id="L695" title="1 of 4 branches missed.">		if (enforceCustomTimeOffHoursFormat || enabledCustomTimeOffHoursFormat()) {</span>
<span class="fc" id="L696">			return getMinutesDisplay(localizer, minutes);</span>
		}
<span class="fc" id="L698">		return localizer.formatNumber(minutes / 60f, 2);</span>
	}

	/**
	 * Append Time Off Period Alerts of the specified Time Off Choice to StringBuffer
	 */
	private static void appendTimeAlertsPeriod(TOChoice choice, Localizer localizer, StringBuilder sb, boolean align) {
<span class="nc" id="L705">		Collection&lt;ValidationResult&gt; valResults = choice.getValidationResults(true);</span>
<span class="nc" id="L706">		String alertIcons = RequestUtil.createAlertIcons(valResults, localizer);</span>
<span class="nc" id="L707">		append(sb, alertIcons, align);</span>
<span class="nc" id="L708">	}</span>

	/**
	 * Append Content to String Buffer
	 */
	private static void append(StringBuilder sb, String content, boolean align) {
<span class="nc" id="L714">		append(sb, content, align, false);</span>
<span class="nc" id="L715">	}</span>

	/**
	 * Append Content to String Buffer
	 */
	private static void append(StringBuilder sb, String content, boolean align, boolean isBold) {
<span class="nc bnc" id="L721" title="All 2 branches missed.">		if (sb.length() != 0) {</span>
<span class="nc" id="L722">			sb.append(&quot;&lt;br&gt;&quot;);</span>
		}
<span class="nc bnc" id="L724" title="All 2 branches missed.">		if (isBold) {</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">			if (align) {</span>
<span class="nc" id="L726">				sb.append(&quot;&lt;span style=\&quot;display:inline-block;font-weight: bold;height:20px;\&quot;&gt;&lt;nobr&gt;&quot;).append(content)</span>
<span class="nc" id="L727">						.append(&quot;&lt;/nobr&gt;&lt;/span&gt;&quot;);</span>
			} else {
<span class="nc" id="L729">				sb.append(&quot;&lt;span style=\&quot;font-weight: bold;\&quot;&gt;&lt;nobr&gt;&quot;).append(content).append(&quot;&lt;/nobr&gt;&lt;/span&gt;&quot;);</span>
			}
		} else {
<span class="nc bnc" id="L732" title="All 2 branches missed.">			if (align) {</span>
<span class="nc" id="L733">				sb.append(&quot;&lt;span style=\&quot;display:inline-block;height:20px;\&quot;&gt;&lt;nobr&gt;&quot;).append(content).append(&quot;&lt;/nobr&gt;&lt;/span&gt;&quot;);</span>
			} else {
<span class="nc" id="L735">				sb.append(&quot;&lt;nobr&gt;&quot;).append(content).append(&quot;&lt;/nobr&gt;&quot;);</span>
			}
		}
<span class="nc" id="L738">	}</span>

	public static boolean enabledCustomTimeOffHoursFormat() {

<span class="fc" id="L742">		boolean result = false;</span>
		try {
<span class="fc" id="L744">			String dbVal = BbmManagerFactory.getDBConfigManager().getValue(ConfigKey.RM_CUSTOM_TIMEOFF_HOURS_FORMAT);</span>
<span class="pc bpc" id="L745" title="1 of 2 branches missed.">			if (!StringUtil.isEmpty(dbVal)) {</span>
<span class="nc" id="L746">				result = Boolean.parseBoolean(dbVal);</span>
			}
<span class="nc" id="L748">		} catch (Exception ex) {</span>
			// ignoring any exception caught.
<span class="fc" id="L750">		}</span>

<span class="fc" id="L752">		return result;</span>
	}

	public static Date roundToNearestInterval(Date date) {
<span class="nc" id="L756">		Date result = null;</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">		if (date != null) {</span>
<span class="nc" id="L758">			Calendar aCal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L759">			aCal.setTime(date);</span>
<span class="nc" id="L760">			int min = aCal.get(Calendar.MINUTE);</span>
<span class="nc" id="L761">			int remainder = min % TIME_INTERVAL;</span>

<span class="nc bnc" id="L763" title="All 2 branches missed.">			if (remainder == 0) {</span>
<span class="nc" id="L764">				result = date;</span>
			} else {
<span class="nc bnc" id="L766" title="All 2 branches missed.">				int diff = (remainder &gt; (TIME_INTERVAL / 2)) ? (TIME_INTERVAL - remainder) : (0 - remainder);</span>
<span class="nc" id="L767">				min += diff;</span>
<span class="nc" id="L768">				aCal.set(Calendar.MINUTE, min);</span>
<span class="nc" id="L769">				result = aCal.getTime();</span>
			}
		}
<span class="nc" id="L772">		return result;</span>
	}

	public static Date roundToNearestInterval(TimeZone tz, Date date, int timeInterval) {
<span class="fc" id="L776">		Date result = null;</span>
<span class="pc bpc" id="L777" title="1 of 2 branches missed.">		if (date != null) {</span>
<span class="pc bpc" id="L778" title="1 of 2 branches missed.">			if (timeInterval == 1) {</span>
<span class="nc" id="L779">				result = date;</span>
<span class="pc bpc" id="L780" title="1 of 2 branches missed.">			} else if (timeInterval &lt;= 60) {</span>
<span class="fc" id="L781">				Calendar aCal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="fc" id="L782">				aCal.setTime(date);</span>
<span class="fc" id="L783">				int min = aCal.get(Calendar.MINUTE);</span>
<span class="fc" id="L784">				int remainder = min % timeInterval;</span>
<span class="pc bpc" id="L785" title="1 of 2 branches missed.">				if (remainder == 0) {</span>
<span class="fc" id="L786">					result = date;</span>
				} else {
<span class="nc bnc" id="L788" title="All 2 branches missed.">					int diff = (remainder &gt; (timeInterval / 2)) ? (timeInterval - remainder) : (0 - remainder);</span>
<span class="nc" id="L789">					min += diff;</span>
<span class="nc" id="L790">					aCal.set(Calendar.MINUTE, min);</span>
<span class="nc" id="L791">					result = aCal.getTime();</span>
				}
<span class="fc" id="L793">			}</span>
			//for day, time Interval =1440
			else {
<span class="nc" id="L796">				Calendar cal = Calendar.getInstance(tz);</span>
<span class="nc" id="L797">				cal.setTimeInMillis(date.getTime());</span>
<span class="nc" id="L798">				int hourOfDay = cal.get(Calendar.HOUR_OF_DAY);</span>
<span class="nc" id="L799">				int min = cal.get(Calendar.MINUTE);</span>
				//Get next day if this is PM time
<span class="nc bnc" id="L801" title="All 6 branches missed.">				if (hourOfDay &gt; 12 || (hourOfDay == 12 &amp;&amp; min &gt; 0)) {</span>
<span class="nc" id="L802">					LocalDate lDate = new LocalDate(date, tz);</span>
<span class="nc" id="L803">					result = DateTimeUtil.getNextLocalDateStart(lDate).getTime(tz);</span>
<span class="nc" id="L804">				} else {</span>
<span class="nc" id="L805">					result = DateTimeUtil.getDayStart(date, tz);</span>
				}

			}
		}
<span class="fc" id="L810">		return result;</span>
	}

	public static String getRoundedMsg(Localizer localizer, int timeInterval) {
		String msg;
<span class="pc bpc" id="L815" title="1 of 2 branches missed.">		if (timeInterval &gt; 60) {</span>
<span class="nc" id="L816">			msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_CHOICES_ROUNDING_DAY_MSG);</span>
<span class="pc bpc" id="L817" title="1 of 2 branches missed.">		} else if (timeInterval == 60) {</span>
<span class="nc" id="L818">			msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_CHOICES_ROUNDING_HOUR_MSG);</span>
		} else {
<span class="fc" id="L820">			msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_CHOICES_ROUNDING_MSG, new Object[] { timeInterval });</span>
		}

<span class="fc" id="L823">		return msg;</span>
	}

<span class="fc" id="L826">	public static class TimeOffChoiceListPCConfig {</span>
<span class="fc" id="L827">		private boolean isShowSelectedInfo = false;</span>
<span class="fc" id="L828">		private boolean isSelectable = false;</span>
<span class="fc" id="L829">		private boolean isShowAlert = false;</span>
<span class="fc" id="L830">		private boolean isEnforceCustomTimeOffHoursFormat = false;</span>
<span class="fc" id="L831">		private boolean isRowNumberEnabled = true;</span>
<span class="fc" id="L832">		private String timeOffChoiceLabelBundleKey = RmWebBundleKey.TIMEOFF_CHOICES;</span>

		public boolean getIsShowSelectedInfo() {
<span class="fc" id="L835">			return this.isShowSelectedInfo;</span>
		}

		public TimeOffChoiceListPCConfig setIsShowSelectedInfo(boolean isShowSelectedInfo) {
<span class="fc" id="L839">			this.isShowSelectedInfo = isShowSelectedInfo;</span>
<span class="fc" id="L840">			return this;</span>
		}

		public boolean getIsSelectable() {
<span class="fc" id="L844">			return this.isSelectable;</span>
		}

		public TimeOffChoiceListPCConfig setIsSelectable(boolean isSelectable) {
<span class="fc" id="L848">			this.isSelectable = isSelectable;</span>
<span class="fc" id="L849">			return this;</span>
		}

		public boolean getIsShowAlert() {
<span class="fc" id="L853">			return this.isShowAlert;</span>
		}

		public TimeOffChoiceListPCConfig setIsShowAlert(boolean isShowAlert) {
<span class="fc" id="L857">			this.isShowAlert = isShowAlert;</span>
<span class="fc" id="L858">			return this;</span>
		}

		public boolean getIsEnforceCustomTimeOffHoursFormat() {
<span class="fc" id="L862">			return this.isEnforceCustomTimeOffHoursFormat;</span>
		}

		public TimeOffChoiceListPCConfig setIsEnforceCustomTimeOffHoursFormat(boolean isEnforceCustomTimeOffHoursFormat) {
<span class="nc" id="L866">			this.isEnforceCustomTimeOffHoursFormat = isEnforceCustomTimeOffHoursFormat;</span>
<span class="nc" id="L867">			return this;</span>
		}

		public boolean getIsRowNumberEnabled() {
<span class="fc" id="L871">			return this.isRowNumberEnabled;</span>
		}

		public TimeOffChoiceListPCConfig setIsRowNumberEnabled(boolean isRowNumberEnabled) {
<span class="nc" id="L875">			this.isRowNumberEnabled = isRowNumberEnabled;</span>
<span class="nc" id="L876">			return this;</span>
		}

		public String getTimeOffChoiceLabelBundleKey() {
<span class="fc" id="L880">			return this.timeOffChoiceLabelBundleKey;</span>
		}

		public TimeOffChoiceListPCConfig setTimeOffChoiceLabelBundleKey(String timeOffChoiceLabelBundleKey) {
<span class="nc" id="L884">			this.timeOffChoiceLabelBundleKey = timeOffChoiceLabelBundleKey;</span>
<span class="nc" id="L885">			return this;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>