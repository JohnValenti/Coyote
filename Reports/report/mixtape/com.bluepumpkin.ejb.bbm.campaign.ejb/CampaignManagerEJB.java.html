<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.campaign.ejb</a> &gt; <span class="el_source">CampaignManagerEJB.java</span></div><h1>CampaignManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.campaign.ejb;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.PaginationPair;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoDuplicateKeyException;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.localization.LocaleContext;
import com.bluepumpkin.common.localization.LocalizationManager;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.CollectionUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.am.ops.gcr.LSGInfoExtractor;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.ActivitySPResourceConstraint;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.activity.model.EventUtils;
import com.bluepumpkin.ejb.bbm.base.*;
import com.bluepumpkin.ejb.bbm.campaign.model.*;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.dao.MapUtil;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.ObjectType;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.SystemType;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriodUtil;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.BbmScheduleConflictException;
import com.bluepumpkin.ejb.bbm.timeseries.ejb.TimeSeriesManager;
import com.bluepumpkin.ejb.bbm.timeseries.model.RequireTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.util.MonthlySPUtil;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.vo.HOOPeriod;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.QueueDAO;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTemplate;
import com.bluepumpkin.ejb.bbm.workresource.model.Phantom;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.verint.ejb.bbm.forecast.ejb.ForecastTimeSeriesManager;
import com.verint.ejb.bbm.forecast.model.ForecastProfileProject;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.gcr.ejb.GCRManager;
import com.witness.ejb.core.gcr.model.GCREntry;

import javax.naming.Context;
import javax.naming.InitialContext;
import java.rmi.RemoteException;
import java.text.MessageFormat;
import java.util.*;

<span class="fc" id="L66">public class CampaignManagerEJB extends SessionEJBBase {</span>

    /**
     *
     */
    private static final long serialVersionUID = 1L;

<span class="fc" id="L73">    private static Category m_cat = Log.initCategory(CampaignManagerEJB.class.getName());</span>

    private WorkResourceManager m_workResourceManager;
    private WorkloadManager m_workloadManager;
    private ScheduleAccessManager m_scheduleAccessManager;
    private ForecastTimeSeriesManager forecastTimeSeriesManager;
    private CampaignManager campaignManager;
<span class="fc" id="L80">    private boolean isWhatIf = false;</span>

    @Override
    public void onEjbCreate() {
        try {
            // First query environment to get WIF setting from DD
<span class="fc" id="L86">            Context initialContext = new InitialContext();</span>
<span class="fc" id="L87">            Boolean wif = (Boolean) initialContext.lookup(&quot;java:comp/env/WIF&quot;);</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">            if (wif != null) {</span>
<span class="fc" id="L89">                isWhatIf = wif.booleanValue();</span>
            }

<span class="fc" id="L92">            m_workloadManager = WfmManagerFactory.getWorkloadManager(isWhatIf);</span>
<span class="fc" id="L93">            m_workResourceManager = BbmManagerFactory.getWorkResourceManager(isWhatIf);</span>
<span class="fc" id="L94">            m_scheduleAccessManager = WfmManagerFactory.getScheduleAccessManager(isWhatIf);</span>
<span class="fc" id="L95">            forecastTimeSeriesManager = WfmManagerFactory.getForecastTimeSeriesManager(isWhatIf);</span>
<span class="fc" id="L96">            campaignManager = WfmManagerFactory.getCampaignManager(isWhatIf);</span>
<span class="nc" id="L97">        } catch (Exception e) {</span>
<span class="nc" id="L98">            handleException(&quot;onEjbCreate&quot;, e, false);</span>
<span class="fc" id="L99">        }</span>
<span class="fc" id="L100">    }</span>

    /**
     * override the base class to provide the appropriate logging category
     */
    @Override
    protected Category getCategory() {
<span class="fc" id="L107">        return m_cat;</span>
    }

    {
<span class="fc" id="L111">        super.init(CampaignManagerEJB.class.getName());</span>
<span class="fc" id="L112">    }</span>

    /**
     * get campaign object given its SID
     */
    public Campaign getCampaignByID(ID id) throws BbmObjectNotFoundException, BbmFinderException {
<span class="fc" id="L118">        methodStart(&quot;getCampaignByID&quot;, id);</span>
<span class="fc" id="L119">        CampaignDAO dao = new CampaignDAO();</span>
        try {
<span class="fc" id="L121">            ArrayList&lt;ID&gt; aIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L122">            aIDs.add(id);</span>
<span class="fc" id="L123">            Collection&lt;Campaign&gt; cpgCol = dao.getCampaign(aIDs, false);</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">            if (cpgCol.isEmpty()) {</span>
<span class="fc" id="L125">                return null;</span>
            }
<span class="fc" id="L127">            return cpgCol.iterator().next();</span>
<span class="nc" id="L128">        } catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L129">            handleException(e, false);</span>
            // no rollback, since finder not support transaction
<span class="nc" id="L131">            throw e;</span>
<span class="nc" id="L132">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L133">            handleException(e, false);</span>
<span class="nc" id="L134">            throw e;</span>
        } finally {
<span class="pc" id="L136">            dao.cleanUp();</span>
<span class="pc" id="L137">            methodFinish();</span>
        }
    }

    public ID getCampaignIDByName(String name) throws BbmFinderException {
<span class="nc" id="L142">        methodStart(&quot;getQueueIDByName&quot;, name);</span>
        try {
<span class="nc" id="L144">            return CampaignDAO.getCampaignIDByName(name);</span>
<span class="nc" id="L145">        } catch (JdmoException e) {</span>
<span class="nc" id="L146">            handleException(e, false);</span>
<span class="nc" id="L147">            throw new BbmFinderException(e);</span>
        } finally {
<span class="nc" id="L149">            methodFinish();</span>
        }
    }

    /**
     * get campaign object given the combined queue id
     */
    public Campaign getCampaignByCombinedQueueID(ID idCombinedQueue) throws BbmObjectNotFoundException, BbmFinderException {
<span class="nc" id="L157">        methodStart(&quot;getCampaignByCombinedQueueID&quot;, idCombinedQueue);</span>
<span class="nc" id="L158">        CampaignDAO dao = new CampaignDAO();</span>
        try {
<span class="nc" id="L160">            return dao.getCampaignByCombinedQueueID(idCombinedQueue);</span>
<span class="nc" id="L161">        } catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L162">            handleException(e, false);</span>
            // no rollback, since finder not support transaction
<span class="nc" id="L164">            throw e;</span>
<span class="nc" id="L165">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L166">            handleException(e, false);</span>
<span class="nc" id="L167">            throw e;</span>
        } finally {
<span class="nc" id="L169">            dao.cleanUp();</span>
<span class="nc" id="L170">            methodFinish();</span>
        }
    }

    /**
     * get campaigns given their SIDs
     */
    public Collection&lt;Campaign&gt; getCampaignsByIDs(Collection&lt;ID&gt; campaignSIDs) throws BbmFinderException {
<span class="fc" id="L178">        methodStart(&quot;getCampaignByIDs&quot;, campaignSIDs);</span>
<span class="fc" id="L179">        CampaignDAO dao = new CampaignDAO();</span>
        try {
<span class="fc" id="L181">            return dao.getCampaign(campaignSIDs, false);</span>
<span class="nc" id="L182">        } catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L183">            handleException(e, false);</span>
            // no rollback, since finder not support transaction
<span class="nc" id="L185">            throw e;</span>
<span class="nc" id="L186">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L187">            handleException(e, false);</span>
<span class="nc" id="L188">            throw e;</span>
        } finally {
<span class="pc" id="L190">            dao.cleanUp();</span>
<span class="pc" id="L191">            methodFinish();</span>
        }
    }

    public Map&lt;ID, Integer&gt; getCampaignSIDAttachedSchedulingPeriodCountMap(Collection&lt;ID&gt; campaignSIDs)
            throws BbmFinderException {
<span class="fc" id="L197">        methodStart(&quot;getCampaignIDAttachedSchedulingPeriodCountMap&quot;, campaignSIDs);</span>
<span class="fc" id="L198">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="fc" id="L200">            return dao.getCampaignIDAttachedSchedulingPeriodCountMap(campaignSIDs);</span>
<span class="nc" id="L201">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L202">            handleException(e, false);</span>
<span class="nc" id="L203">            throw e;</span>
        } finally {
<span class="pc" id="L205">            dao.cleanUp();</span>
<span class="pc" id="L206">            methodFinish();</span>
        }
    }

    public Map&lt;ID, ActivitySPResourceConstraint&gt; getActivitySPResourceConstraintMap(ID schedulingPeriodSID)
            throws BbmFinderException {
<span class="nc" id="L212">        methodStart(&quot;getActivitySPResourceConstraintsBySP&quot;, schedulingPeriodSID);</span>
<span class="nc" id="L213">        ActivitySPResourceConstraintDAO dao = new ActivitySPResourceConstraintDAO();</span>
        try {
<span class="nc" id="L215">            List&lt;ActivitySPResourceConstraint&gt; constraints = dao.getActivitySPResourceConstraintsBySP(schedulingPeriodSID);</span>
<span class="nc" id="L216">            Map&lt;ID, ActivitySPResourceConstraint&gt; results = new HashMap&lt;ID, ActivitySPResourceConstraint&gt;();</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">            for (ActivitySPResourceConstraint constraint : constraints) {</span>
<span class="nc" id="L218">                results.put(constraint.getActivityID(), constraint);</span>
<span class="nc" id="L219">            }</span>
<span class="nc" id="L220">            return results;</span>

<span class="nc" id="L222">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L223">            handleException(e, false);</span>
<span class="nc" id="L224">            throw e;</span>
        } finally {
<span class="nc" id="L226">            dao.cleanUp();</span>
<span class="nc" id="L227">            methodFinish();</span>
        }
    }

    public Collection&lt;ID&gt; createActivitySPResourceConstraints(
            List&lt;ActivitySPResourceConstraint&gt; newActivitySPResourceConstraints) throws BbmCreateException,
            BbmCreateDuplicateKeyException {
<span class="nc" id="L234">        methodStart(&quot;createActivitySPResourceConstraints&quot;, newActivitySPResourceConstraints);</span>
<span class="nc" id="L235">        ActivitySPResourceConstraintDAO dao = new ActivitySPResourceConstraintDAO();</span>
        try {
<span class="nc" id="L237">            return dao.createObjects(newActivitySPResourceConstraints);</span>
<span class="nc" id="L238">        } catch (BbmCreateException e) {</span>
            // log and rollback transaction
<span class="nc" id="L240">            handleException(e);</span>
<span class="nc" id="L241">            throw e;</span>
        } finally {
<span class="nc" id="L243">            dao.cleanUp();</span>
<span class="nc" id="L244">            methodFinish();</span>
        }
    }

    public void updateActivitySPResourceConstraints(List&lt;ActivitySPResourceConstraint&gt; activitySPResourceConstraints)
            throws BbmUpdateException, MultiUserException {
<span class="nc" id="L250">        methodStart(&quot;updateActivitySPResourceConstraints&quot;, activitySPResourceConstraints);</span>
<span class="nc" id="L251">        ActivitySPResourceConstraintDAO dao = new ActivitySPResourceConstraintDAO();</span>
        try {
<span class="nc" id="L253">            dao.updateObjects(activitySPResourceConstraints);</span>
<span class="nc" id="L254">        } catch (BbmUpdateException e) {</span>
<span class="nc" id="L255">            handleException(e);</span>
<span class="nc" id="L256">            throw e;</span>
<span class="nc" id="L257">        } catch (MultiUserException e) {</span>
<span class="nc" id="L258">            handleException(e);</span>
<span class="nc" id="L259">            throw e;</span>
        } finally {
<span class="nc" id="L261">            dao.cleanUp();</span>
<span class="nc" id="L262">            methodFinish();</span>
<span class="nc" id="L263">        }</span>
<span class="nc" id="L264">    }</span>

    /**
     * get all campaigns
     */
    public Collection&lt;Campaign&gt; getCampaigns() throws BbmFinderException {
<span class="fc" id="L270">        methodStart(&quot;getCampaigns&quot;);</span>
<span class="fc" id="L271">        CampaignDAO dao = new CampaignDAO();</span>
        try {
<span class="fc" id="L273">            return dao.getCampaign(null, false);</span>
<span class="nc" id="L274">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L275">            handleException(e, false);</span>
<span class="nc" id="L276">            throw e;</span>
        } finally {
<span class="pc" id="L278">            dao.cleanUp();</span>
<span class="pc" id="L279">            methodFinish();</span>
        }
    }

    public Collection&lt;Campaign&gt; getCampaigns(int pageSize, int pageIndex) throws BbmFinderException {
<span class="nc" id="L284">        methodStart(&quot;getCampaigns&quot;);</span>
<span class="nc" id="L285">        CampaignDAO dao = new CampaignDAO();</span>
        try {
<span class="nc" id="L287">            return dao.getCampaigns(pageSize, pageIndex);</span>
<span class="nc" id="L288">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L289">            handleException(e, false);</span>
<span class="nc" id="L290">            throw e;</span>
        } finally {
<span class="nc" id="L292">            dao.cleanUp();</span>
<span class="nc" id="L293">            methodFinish();</span>
        }
    }

    /**
     * insert a campaign object into database
     */
    public ID createCampaign(Campaign objValue) throws BbmCreateException, BbmCreateDuplicateKeyException {
<span class="fc" id="L301">        methodStart(&quot;createCampaign&quot;);</span>
<span class="fc" id="L302">        CampaignDAO dao = new CampaignDAO();</span>
        try {
<span class="fc" id="L304">            return dao.createCampaign(objValue);</span>
<span class="nc" id="L305">        } catch (JdmoDuplicateKeyException e) {</span>
            // log but don't rollback transaction
<span class="nc" id="L307">            handleException(e, false);</span>
<span class="nc" id="L308">            throw new BbmCreateDuplicateKeyException(e);</span>
<span class="nc" id="L309">        } catch (JdmoException e) {</span>
            // log but don't rollback transaction
<span class="nc" id="L311">            handleException(e, false);</span>
<span class="nc" id="L312">            throw new BbmCreateException(e);</span>
        } finally {
<span class="pc" id="L314">            dao.cleanUp();</span>
<span class="pc" id="L315">            methodFinish();</span>
        }
    }

    public ID createCampaign(Campaign campaign, SystemType externalSystemType) throws BbmCreateException,
            BbmCreateDuplicateKeyException {

<span class="nc" id="L322">        methodStart(&quot;createCampaign&quot;);</span>
        try {
<span class="nc" id="L324">            ID campaignSID = createCampaign(campaign);</span>
<span class="nc" id="L325">            campaign.setID(campaignSID);</span>
<span class="nc" id="L326">            boolean insert = true;</span>
<span class="nc" id="L327">            MapUtil.setWfoToExternalID(externalSystemType, ObjectType.Campaign, campaign.getID(), campaign.getExternalID(),</span>
                    new Jdmo(true), insert);
<span class="nc" id="L329">            return campaignSID;</span>
<span class="nc" id="L330">        } catch (BbmCreateException e) {</span>
            // log and rollback transaction
<span class="nc" id="L332">            handleException(e);</span>
<span class="nc" id="L333">            throw e;</span>
<span class="nc" id="L334">        } catch (JdmoException e) {</span>
            // log and rollback transaction
<span class="nc" id="L336">            handleException(e);</span>
<span class="nc" id="L337">            throw new BbmCreateException(e);</span>
        } finally {
<span class="nc" id="L339">            methodFinish();</span>
        }

    }

    /**
     * Warning: Identity based on SID not ID
     */
    public void updateCampaigns(Collection&lt;Campaign&gt; campaignCol) throws BbmUpdateException {
<span class="nc" id="L348">        methodStart(&quot;updateCampaigns&quot;);</span>
<span class="nc" id="L349">        CampaignDAO dao = new CampaignDAO();</span>
        try {
<span class="nc" id="L351">            dao.updateCampaigns(campaignCol);</span>
<span class="nc" id="L352">        } catch (BbmUpdateException e) {</span>
<span class="nc" id="L353">            handleException(e);</span>
<span class="nc" id="L354">            throw e;</span>
        } finally {
<span class="nc" id="L356">            dao.cleanUp();</span>
<span class="nc" id="L357">            methodFinish();</span>
<span class="nc" id="L358">        }</span>
<span class="nc" id="L359">    }</span>

    public void matchCampaignWithExternalID(Campaign objValue, SystemType externalSystemType, ID campaignExternalID)
            throws RemoteException, BbmUpdateException {
<span class="nc" id="L363">        methodStart(&quot;matchCampaignWithExternalID&quot;, objValue, externalSystemType, campaignExternalID);</span>

        // validate
<span class="nc bnc" id="L366" title="All 2 branches missed.">        if (externalSystemType == null) {</span>
<span class="nc" id="L367">            throw new BbmUpdateException(&quot;externalSystemType is null&quot;);</span>
        }
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (campaignExternalID == null) {</span>
<span class="nc" id="L370">            throw new BbmUpdateException(&quot;externalSourceId is null&quot;);</span>
        }
<span class="nc bnc" id="L372" title="All 4 branches missed.">        if (campaignExternalID.isInt() &amp;&amp; !externalSystemType.isExtIdAnInt) {</span>
<span class="nc" id="L373">            throw new BbmUpdateException(&quot;For this external system, externalSourceId must be a string not an integer&quot;);</span>
        }
<span class="nc bnc" id="L375" title="All 4 branches missed.">        if (!campaignExternalID.isInt() &amp;&amp; externalSystemType.isExtIdAnInt) {</span>
<span class="nc" id="L376">            throw new BbmUpdateException(&quot;For this external system, externalSourceId must be an integer not a string&quot;);</span>
        }

        // match external id for campaign
        try {
<span class="nc" id="L381">            boolean insert = true;</span>
<span class="nc" id="L382">            MapUtil.setWfoToExternalID(externalSystemType, ObjectType.Campaign, objValue.getID(), campaignExternalID,</span>
                    new Jdmo(true), insert);
<span class="nc" id="L384">        } catch (JdmoException e) {</span>
<span class="nc" id="L385">            handleException(e);</span>
<span class="nc" id="L386">            throw new BbmUpdateException(e);</span>
        } finally {
<span class="nc" id="L388">            methodFinish();</span>
<span class="nc" id="L389">        }</span>

<span class="nc" id="L391">    }</span>

    /**
     * get an given campaign's organization assignments
     *
     * @return a collection of CampaignOrg objects which hold the assignment
     * information
     * @idCampaign campaign id
     * @dtStart, @dtEnd: the time period, null date means a open period
     */
    public Collection&lt;CampaignOrg&gt; getCampaignOrgAssignments(ID idCampaign, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L402">        methodStart(&quot;getCampaignOrgAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L403">        CampaignOrgDAO dao = new CampaignOrgDAO();</span>
        try {
<span class="fc" id="L405">            return dao.getCampaignOrgAssignments(idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L406">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L407">            handleException(e, false);</span>
<span class="nc" id="L408">            throw e;</span>
        } finally {
<span class="pc" id="L410">            dao.cleanUp();</span>
<span class="pc" id="L411">            methodFinish();</span>
        }
    }

    /**
     * get campaign org assignment given its id
     */
    public CampaignOrg getCampaignOrgAssignmentByID(ID idAssignment) throws BbmObjectNotFoundException, BbmFinderException {
<span class="nc" id="L419">        methodStart(&quot;getCampaignOrgAssignmentByID&quot;, idAssignment);</span>
<span class="nc" id="L420">        CampaignOrgDAO dao = new CampaignOrgDAO();</span>
        try {
<span class="nc" id="L422">            return dao.getCampaignOrgAssignmentByID(idAssignment);</span>
<span class="nc" id="L423">        } catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L424">            handleException(e, false);</span>
<span class="nc" id="L425">            throw e;</span>
<span class="nc" id="L426">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L427">            handleException(e, false);</span>
<span class="nc" id="L428">            throw e;</span>
        } finally {
<span class="nc" id="L430">            dao.cleanUp();</span>
<span class="nc" id="L431">            methodFinish();</span>
        }
    }

    /**
     * Given a collection of orgIDs, return all campaign IDs linked to any of
     * those orgs, for any time period.
     */
    public Collection&lt;ID&gt; getAllCampaignIDsLinkedToOrgs(Collection orgIDs) throws BbmFinderException {
<span class="fc" id="L440">        methodStart(&quot;getAllCampaignIDsLinkedToOrgs&quot;, orgIDs);</span>
<span class="fc" id="L441">        CampaignOrgDAO dao = new CampaignOrgDAO();</span>
        try {
<span class="fc" id="L443">            return dao.getAllCampaignIDsLinkedToOrgs(orgIDs);</span>
<span class="nc" id="L444">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L445">            handleException(e, false);</span>
<span class="nc" id="L446">            throw e;</span>
        } finally {
<span class="pc" id="L448">            dao.cleanUp();</span>
<span class="pc" id="L449">            methodFinish();</span>
        }
    }

    /**
     * create a list of campaign organization assignments
     *
     * @return a list of ids of the created objects, if failed in creation of
     * any object, raise exception
     */
    public Collection&lt;ID&gt; createCampaignOrgAssignments(Collection&lt;CampaignOrg&gt; colAssignments) throws BbmCreateException {
<span class="nc" id="L460">        methodStart(&quot;createCampaignOrgAssignments&quot;, colAssignments);</span>
<span class="nc" id="L461">        ArrayList&lt;ID&gt; arrResult = new ArrayList&lt;ID&gt;();</span>

<span class="nc" id="L463">        CampaignOrgDAO dao = new CampaignOrgDAO();</span>
        try {
<span class="nc" id="L465">            Iterator&lt;CampaignOrg&gt; it = colAssignments.iterator();</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">            while (it.hasNext()) {</span>
<span class="nc" id="L467">                arrResult.add(dao.createCampaignOrgAssignment(it.next()));</span>
            }
<span class="nc" id="L469">        } catch (BbmCreateException e) {</span>
<span class="nc" id="L470">            handleException(e);</span>
<span class="nc" id="L471">            throw e;</span>
        } finally {
<span class="nc" id="L473">            dao.cleanUp();</span>
<span class="nc" id="L474">            methodFinish();</span>
<span class="nc" id="L475">        }</span>

<span class="nc" id="L477">        return arrResult;</span>
    }

    /**
     * return a list of skill Names associated with a spqueue
     */
    public Collection&lt;String&gt; getSkillNamesMappedToQueue(ID idQueue, ID spID) throws BbmFinderException {
<span class="nc" id="L484">        methodStart(&quot;getSkillNamesMappedToQueue&quot;);</span>
<span class="nc" id="L485">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="nc" id="L487">            return dao.getSkillNamesMappedToQueue(idQueue, spID);</span>
        } finally {
<span class="nc" id="L489">            dao.cleanUp();</span>
<span class="nc" id="L490">            methodFinish();</span>
        }
    }

    /**
     * Given an SP ID, return a Map that maps each queue SID to its skill SID.
     * If the SP has a queue that is not linked to a skill, then the queue is
     * not included in the map. We assume that an SP queue can only be linked to
     * a single skill.
     *
     * @param spID - the SID of the scheduling period.
     * @return A Map that maps each queue SID to its skill SID.
     * @throws BbmFinderException TODO: change this to return Map&lt;ID, ID&gt; not HashMap&lt;ID, ID&gt;
     */
    public HashMap&lt;ID, ID&gt; getQueueIDToSkillMap(ID spID) throws BbmFinderException {
<span class="fc" id="L505">        methodStart(&quot;getQueueIDToSkillMap&quot;);</span>
<span class="fc" id="L506">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {

<span class="fc" id="L509">            Map&lt;ID, ID&gt; queueIDToSkillMap = dao.getQueueIDToSkillMap(spID);</span>
<span class="fc" id="L510">            return new HashMap&lt;ID, ID&gt;(queueIDToSkillMap); // TODo remove when</span>
            // signature changed
        } finally {
<span class="pc" id="L513">            dao.cleanUp();</span>
<span class="pc" id="L514">            methodFinish();</span>
        }
    }

    /**
     * save a campaign's organization assignment
     */
    public void updateCampaignOrgAssignment(CampaignOrg objValue) throws MultiUserException, BbmUpdateException {
<span class="nc" id="L522">        methodStart(&quot;updateCampaignOrgAssignment&quot;, objValue);</span>
<span class="nc" id="L523">        CampaignOrgDAO dao = new CampaignOrgDAO();</span>
        try {
<span class="nc" id="L525">            dao.updateCampaignOrgAssignment(objValue);</span>
<span class="nc" id="L526">        } catch (MultiUserException e) {</span>
<span class="nc" id="L527">            handleException(e);</span>
<span class="nc" id="L528">            throw e;</span>
<span class="nc" id="L529">        } catch (BbmUpdateException e) {</span>
<span class="nc" id="L530">            handleException(e);</span>
<span class="nc" id="L531">            throw e;</span>
        } finally {
<span class="nc" id="L533">            dao.cleanUp();</span>
<span class="nc" id="L534">            methodFinish();</span>
<span class="nc" id="L535">        }</span>
<span class="nc" id="L536">    }</span>

    /**
     * delete a campaign's organization assignments given the assignment ids
     */
    public void deleteCampaignOrgAssignments(Collection&lt;ID&gt; colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L542">        methodStart(&quot;deleteCampaignOrgAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L543">        CampaignOrgDAO dao = new CampaignOrgDAO();</span>
        try {
<span class="nc" id="L545">            dao.deleteCampaignOrgAssignments(colIDAssignments);</span>
<span class="nc" id="L546">        } catch (BbmRemoveException e) {</span>
<span class="nc" id="L547">            handleException(e);</span>
<span class="nc" id="L548">            throw e;</span>
        } finally {
<span class="nc" id="L550">            dao.cleanUp();</span>
<span class="nc" id="L551">            methodFinish();</span>
<span class="nc" id="L552">        }</span>
<span class="nc" id="L553">    }</span>

    /**
     * Because each scheduling period has a choice of biz rule, we need to
     * implement this method piecewise Only scheduling periods
     *
     * @return a collection of CampaignWorkResource objects which hold the
     * assignment information including start and end dates
     */
    public Collection&lt;CampaignWorkResource&gt; getCampaignWorkResourceAssignments(ID campaignID, Date startDate, Date endDate)
            throws BbmFinderException {
<span class="fc" id="L564">        methodStart(&quot;getCampaignWorkResourceAssignments&quot;, campaignID, startDate, endDate);</span>

        try {
            // break down the campaign into its scheduling periods
<span class="fc" id="L568">            Collection&lt;SchedulingPeriod&gt; schedulingPeriods = getSchedulingPeriods(campaignID, startDate, endDate);</span>

            // for each scheduling period find resources based on that period's
            // biz rule
<span class="fc" id="L572">            Collection&lt;CampaignWorkResource&gt; result = new ArrayList&lt;CampaignWorkResource&gt;();</span>
<span class="fc bfc" id="L573" title="All 2 branches covered.">            for (SchedulingPeriod schedulingPeriod : schedulingPeriods) {</span>
<span class="fc" id="L574">                result.addAll(getCampaignWorkResourceAssignments(schedulingPeriod));</span>
<span class="fc" id="L575">            }</span>

<span class="fc" id="L577">            return result;</span>
<span class="nc" id="L578">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L579">            handleException(e, false);</span>
<span class="nc" id="L580">            throw e;</span>
        } finally {
<span class="pc" id="L582">            methodFinish();</span>
        }
    }

    public Collection&lt;CampaignWorkResource&gt; getCampaignWorkResourceAssignments(SchedulingPeriod schedulingPeriod)
            throws BbmFinderException {
<span class="fc" id="L588">        methodStart(&quot;getCampaignWorkResourceAssignments&quot;, schedulingPeriod);</span>

<span class="fc" id="L590">        CampaignWorkResourceDAO dao = null;</span>
        try {
<span class="fc" id="L592">            dao = new CampaignWorkResourceDAO();</span>
<span class="fc" id="L593">            Collection&lt;CampaignWorkResource&gt; schedulingPeriodResources = new ArrayList&lt;CampaignWorkResource&gt;();</span>

<span class="fc bfc" id="L595" title="All 2 branches covered.">            if (schedulingPeriod.isUsingAllEmployees()) {</span>
<span class="fc" id="L596">                schedulingPeriodResources = dao.getCampaignWorkResourceAssignmentsByLinkedOrganizations(schedulingPeriod);</span>
            } else {
<span class="fc" id="L598">                schedulingPeriodResources = dao.getCampaignWorkResourceAssignmentsByLinkedEmployees(schedulingPeriod);</span>
            }
<span class="fc" id="L600">            return schedulingPeriodResources;</span>
<span class="nc" id="L601">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L602">            handleException(e, false);</span>
<span class="nc" id="L603">            throw e;</span>
        } finally {
<span class="pc bpc" id="L605" title="3 of 4 branches missed.">            if (dao != null) {</span>
<span class="pc" id="L606">                dao.cleanUp();</span>
            }
<span class="pc" id="L608">            methodFinish();</span>
        }
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public Collection&lt;ID&gt; getWorkResourceIDsBySchedulingPeriod(SchedulingPeriod schedulingPeriod) throws BbmFinderException {
<span class="fc" id="L614">        methodStart(&quot;getWorkResourceIDs&quot;, schedulingPeriod);</span>
        try {

<span class="fc" id="L617">            Collection&lt;CampaignWorkResource&gt; campaignWorkResources = getCampaignWorkResourceAssignments(schedulingPeriod);</span>

            // Extract employee ids from collection
<span class="fc" id="L620">            List&lt;ID&gt; workResourceIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L621" title="All 2 branches covered.">            for (CampaignWorkResource campaignWorkResource : campaignWorkResources) {</span>
<span class="fc" id="L622">                workResourceIDs.add(campaignWorkResource.getWorkResourceID());</span>
<span class="fc" id="L623">            }</span>
<span class="fc" id="L624">            return workResourceIDs;</span>
<span class="nc" id="L625">        } catch (Exception e) {</span>
<span class="nc" id="L626">            handleException(e, false);</span>
<span class="nc" id="L627">            throw new BbmFinderException(e);</span>
        } finally {
<span class="pc" id="L629">            methodFinish();</span>
        }
    }

    /**
     * get the pooler assignments for the given set of Scheduling Periods.
     *
     * @return a collection of work resource IDs which are poolers at any of the
     * given scheduling periods.
     * @spIDs a collection of IDs of scheduling periods for which we want to
     * retrieve the pooling assignments.
     */
    public Collection&lt;ID&gt; getSPPoolerAssignments(Collection&lt;ID&gt; spIDs) throws BbmFinderException {
<span class="fc" id="L642">        methodStart(&quot;getSPPoolerAssignments&quot;, spIDs);</span>
<span class="fc" id="L643">        CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
        try {
<span class="fc" id="L645">            return dao.getSPPoolerAssignments(spIDs);</span>
<span class="nc" id="L646">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L647">            handleException(e, false);</span>
<span class="nc" id="L648">            throw e;</span>
        } finally {
<span class="pc" id="L650">            dao.cleanUp();</span>
<span class="pc" id="L651">            methodFinish();</span>
        }
    }

    /**
     * get the pooler assignments for the given Scheduling Period between the
     * given date range.
     *
     * @return a collection of work resource IDs which are poolers at the given
     * scheduling period during the given time frame.
     * @spID sp id
     * @dtStart, @dtEnd: the time period, null date means a open period
     */
    public Collection&lt;ID&gt; getSPPoolerAssignments(ID spID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L665">        methodStart(&quot;getSPPoolerAssignments&quot;, spID, dtStart, dtEnd);</span>
<span class="fc" id="L666">        CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
        try {
<span class="fc" id="L668">            return dao.getSPPoolerAssignments(spID, dtStart, dtEnd);</span>
<span class="nc" id="L669">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L670">            handleException(e, false);</span>
<span class="nc" id="L671">            throw e;</span>
        } finally {
<span class="pc" id="L673">            dao.cleanUp();</span>
<span class="pc" id="L674">            methodFinish();</span>
        }
    }

    /**
     * For a collection of work resource ids (usually employee ids) and a date
     * range, return a map of work resource ids to the campaigns they are
     * assigned to. Different logic based on weather constituent scheduling
     * period.isUsingAllEmployees() is true or false
     *
     * @param startDate null treated as unlimited
     * @param endDate   null treated as unlimited
     */
    public Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; getWorkResourceCampaignAssignments(Collection&lt;ID&gt; workResourceIDs,
                                                                                  Date startDate, Date endDate) throws BbmFinderException {
<span class="fc" id="L689">        methodStart(&quot;getWorkResourceCampaignAssignments&quot;, workResourceIDs, startDate, endDate);</span>

<span class="fc" id="L691">        CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
        try {
<span class="fc" id="L693">            Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; manualAssignmentMap = dao</span>
<span class="fc" id="L694">                    .getCampaignWorkResourceAssignmentsByLinkedEmployees(workResourceIDs, startDate, endDate);</span>
<span class="fc" id="L695">            Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; byOrganizationAssignmentMap = dao</span>
<span class="fc" id="L696">                    .getCampaignWorkResourceAssignmentsByLinkedOrganizations(workResourceIDs, startDate, endDate);</span>

<span class="fc" id="L698">            return CollectionUtil.mergeIdCollectionMaps(manualAssignmentMap, byOrganizationAssignmentMap);</span>
<span class="nc" id="L699">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L700">            handleException(e, false);</span>
<span class="nc" id="L701">            throw e;</span>
        } finally {
<span class="pc" id="L703">            dao.cleanUp();</span>
<span class="pc" id="L704">            methodFinish();</span>
        }
    }

    /**
     * For one work resource id and a date range, return a list of campaigns
     * they are assigned to. Special case of multiple work resource ids.
     *
     * @param startDate null treated as unlimited
     * @param endDate   null treated as unlimited
     * @return A list of CampaignWorkResource objects which hold the assignment
     * information
     */
    public List&lt;CampaignWorkResource&gt; getWorkResourceCampaignAssignments(ID workResourceID, Date startDate, Date endDate)
            throws BbmFinderException {
<span class="fc" id="L719">        methodStart(&quot;getWorkResourceCampaignAssignments&quot;, workResourceID, startDate, endDate);</span>
        try {
<span class="fc" id="L721">            return getWorkResourceCampaignAssignments(</span>
<span class="fc" id="L722">                    Arrays.asList(workResourceID), startDate, endDate).get(workResourceID);</span>
        } finally {
<span class="pc" id="L724">            methodFinish();</span>
        }
    }

    /**
     * get a given campaign's queue assignments
     *
     * @return a collection of CampaignQueue objects which hold the assignment
     * information
     * @idCampaign campaign id
     * @dtStart, @dtEnd: the time period, null date means a open period
     */
    public Collection&lt;CampaignQueue&gt; getCampaignQueueAssignments(ID idCampaign, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L737">        methodStart(&quot;getCampaignQueueAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L738">        CampaignQueueDAO dao = new CampaignQueueDAO();</span>
        try {
<span class="fc" id="L740">            return dao.getCampaignQueueAssignments(idCampaign, null, dtStart, dtEnd, false);</span>
<span class="nc" id="L741">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L742">            handleException(e, false);</span>
<span class="nc" id="L743">            throw e;</span>
        } finally {
<span class="pc" id="L745">            dao.cleanUp();</span>
<span class="pc" id="L746">            methodFinish();</span>
        }
    }

    /**
     * The Campaign Queue concept is old , this method is being added only to support existing Staffing Calculator.
     * Now the Queues are linked to SP's instead of Campaigns.
     * This method returns a Map of CampaignID -&gt;List of Queues linked to that campaign
     *
     * @param campaignIDs - List of Campaign ID's for which you want to fetch the Queue Assignments
     * @param dtStart     - Duration start Date
     * @param dtEnd       - Duration End Date
     * @return Map&lt;ID,Collection &lt;CampaignQueue&gt;&gt; - Map of CampaignID -&gt;List of Queues linked to that Campaign
     * @throws BbmFinderException
     */
    public Map&lt;ID, Collection&lt;CampaignQueue&gt;&gt; getQueueAssignmentsForGivenCampaignIDs(Collection&lt;ID&gt; campaignIDs, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L762">        methodStart(&quot;getCampaignQueueAssignments&quot;, campaignIDs, dtStart, dtEnd);</span>
<span class="nc" id="L763">        CampaignQueueDAO dao = new CampaignQueueDAO();</span>
        try {
<span class="nc" id="L765">            return dao.getQueueAssignmentsForGivenCampaignIDs(campaignIDs, dtStart, dtEnd);</span>
<span class="nc" id="L766">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L767">            handleException(e, false);</span>
<span class="nc" id="L768">            throw e;</span>
        } finally {
<span class="nc" id="L770">            dao.cleanUp();</span>
<span class="nc" id="L771">            methodFinish();</span>
        }
    }

    public Collection&lt;CampaignQueue&gt; getCampaignQueueAssignmentsAndCombinedQueues(ID idCampaign, Date dtStart, Date dtEnd)
            throws BbmFinderException {
<span class="fc" id="L777">        methodStart(&quot;getCampaignQueueAssignmentsAndCombinedQueues&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L778">        CampaignQueueDAO dao = new CampaignQueueDAO();</span>
        try {
<span class="fc" id="L780">            return dao.getCampaignQueueAssignments(idCampaign, null, dtStart, dtEnd, true);</span>
<span class="nc" id="L781">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L782">            handleException(e, false);</span>
<span class="nc" id="L783">            throw e;</span>
        } finally {
<span class="pc" id="L785">            dao.cleanUp();</span>
<span class="pc" id="L786">            methodFinish();</span>
        }
    }

    public Collection&lt;CampaignQueue&gt; getCampaignQueueAndLinkedSubQueueAssignments(ID idCampaign, Date dtStart, Date dtEnd)
            throws BbmFinderException {
<span class="fc" id="L792">        methodStart(&quot;getCampaignQueueAndLinkedSubQueueAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L793">        CampaignQueueDAO dao = new CampaignQueueDAO();</span>
        try {
<span class="fc" id="L795">            return dao.getCampaignQueueAndLinkedSubQueueAssignments(idCampaign, null, dtStart, dtEnd);</span>
<span class="nc" id="L796">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L797">            handleException(e, false);</span>
<span class="nc" id="L798">            throw e;</span>
        } finally {
<span class="pc" id="L800">            dao.cleanUp();</span>
<span class="pc" id="L801">            methodFinish();</span>
        }
    }

    public Collection&lt;CampaignQueue&gt; getQueueCampaignAssignments(ID idQueue, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L806">        methodStart(&quot;getQueueCampaignAssignments&quot;, idQueue, dtStart, dtEnd);</span>
<span class="fc" id="L807">        CampaignQueueDAO dao = new CampaignQueueDAO();</span>
        try {
<span class="fc" id="L809">            return dao.getQueueCampaignAssignments(idQueue, dtStart, dtEnd);</span>
<span class="nc" id="L810">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L811">            handleException(e, false);</span>
<span class="nc" id="L812">            throw e;</span>
        } finally {
<span class="pc" id="L814">            dao.cleanUp();</span>
<span class="pc" id="L815">            methodFinish();</span>
        }
    }

    public Collection&lt;ID&gt; getSubCampaignIDs(ID idCampaign) throws BbmFinderException {
<span class="fc" id="L820">        methodStart(&quot;getSubCampaignIDs&quot;, idCampaign);</span>
<span class="fc" id="L821">        CampaignDAO dao = new CampaignDAO();</span>
        try {
<span class="fc" id="L823">            return dao.getSubCampaignIDs(idCampaign);</span>
<span class="nc" id="L824">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L825">            handleException(e, false);</span>
<span class="nc" id="L826">            throw e;</span>
        } finally {
<span class="pc" id="L828">            dao.cleanUp();</span>
<span class="pc" id="L829">            methodFinish();</span>
        }
    }

    public Collection getCampaignQueueAssignments(ID idCampaign, ID idMedia, Date dtStart, Date dtEnd)
            throws BbmFinderException {
<span class="fc" id="L835">        methodStart(&quot;getCampaignQueueAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L836">        CampaignQueueDAO dao = new CampaignQueueDAO();</span>
        try {
<span class="fc" id="L838">            return dao.getCampaignQueueAssignments(idCampaign, idMedia, dtStart, dtEnd, false);</span>
<span class="nc" id="L839">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L840">            handleException(e, false);</span>
<span class="nc" id="L841">            throw e;</span>
        } finally {
<span class="pc" id="L843">            dao.cleanUp();</span>
<span class="pc" id="L844">            methodFinish();</span>
        }
    }

    /**
     * get a given campaign's hours's of operation (HOO)
     *
     * @param idCampaign      : campaign id
     * @param dtStart         :
     * @param dtEnd           : the time period, null date means a open period
     * @param includeSubCamps : true if you want to include SPHOO's from sub-campaigns as
     *                        well.
     * @return a collection of CampaignHOO objects which hold the assignment
     * information
     */
    public Collection&lt;CampaignHOO&gt; getCampaignHOOAssignments(ID idCampaign, Date dtStart, Date dtEnd, boolean includeSubCamps)
            throws BbmFinderException {
<span class="fc" id="L861">        methodStart(&quot;getCampaignHOOAssignments&quot;, idCampaign, dtStart, dtEnd, includeSubCamps);</span>
<span class="fc" id="L862">        CampaignHOODAO dao = new CampaignHOODAO();</span>
        try {
<span class="fc" id="L864">            return dao.getCampaignHOOAssignments(idCampaign, dtStart, dtEnd, includeSubCamps);</span>
<span class="nc" id="L865">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L866">            handleException(e, false);</span>
<span class="nc" id="L867">            throw e;</span>
        } finally {
<span class="pc" id="L869">            dao.cleanUp();</span>
<span class="pc" id="L870">            methodFinish();</span>
        }
    }

    /**
     * get a given campaign's hours's of operation (HOO)
     *
     * @return a collection of CampaignHOO objects which hold the assignment
     * information
     * @idCampaign campaign id
     * @dtStart, @dtEnd: the time period, null date means a open period
     */
    public Collection&lt;CampaignHOO&gt; getCampaignHOOAssignments(ID idCampaign, Date dtStart, Date dtEnd)
            throws BbmFinderException {
<span class="fc" id="L884">        methodStart(&quot;getCampaignHOOAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L885">        CampaignHOODAO dao = new CampaignHOODAO();</span>
        try {
<span class="fc" id="L887">            return dao.getCampaignHOOAssignments(idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L888">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L889">            handleException(e, false);</span>
<span class="nc" id="L890">            throw e;</span>
        } finally {
<span class="pc" id="L892">            dao.cleanUp();</span>
<span class="pc" id="L893">            methodFinish();</span>
        }
    }

    /**
     * get a given campaign's hours's of operation (HOO)
     *
     * @return a collection of CampaignHOO objects which hold the assignment
     * information
     * @idCampaign campaign id
     * @dtStart, @dtEnd: the time period, null date means a open period
     */
    public List&lt;CampaignHOO&gt; getCampaignHOOAssignmentsBySP(ID idSP) throws BbmFinderException {
<span class="fc" id="L906">        methodStart(&quot;getCampaignHOOAssignmentsBySP&quot;, idSP);</span>
<span class="fc" id="L907">        CampaignHOODAO dao = new CampaignHOODAO();</span>
        try {
<span class="fc" id="L909">            return dao.getCampaignHOOAssignmentsBySP(idSP);</span>
<span class="nc" id="L910">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L911">            handleException(e, false);</span>
<span class="nc" id="L912">            throw e;</span>
        } finally {
<span class="pc" id="L914">            dao.cleanUp();</span>
<span class="pc" id="L915">            methodFinish();</span>
        }
    }

    /**
     * fetch a collection of HOO for the given campaign and using campaign TZ to
     * prepare the HOOPeriod object. HOOPeriod differ from HOO since it is not a
     * template but a daily definition of HOO in the given period.
     */
    public HOOPeriod getHOOPeriod(ID idCampaign, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L925">        methodStart(&quot;getHOOPeriod&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L926">        CampaignHOODAO dao = new CampaignHOODAO();</span>
        try {
<span class="fc" id="L928">            return dao.getHOOPeriod(idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L929">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L930">            handleException(e, false);</span>
<span class="nc" id="L931">            throw e;</span>
        } finally {
<span class="pc" id="L933">            dao.cleanUp();</span>
<span class="pc" id="L934">            methodFinish();</span>
        }
    }

    /**
     * create a campaign's HOO assignment
     */
    public ID createCampaignHOOAssignment(CampaignHOO objValue) throws BbmCreateException {
<span class="fc" id="L942">        methodStart(&quot;createCampaignHOOAssignment&quot;, objValue);</span>
<span class="fc" id="L943">        CampaignHOODAO dao = new CampaignHOODAO();</span>
        try {
<span class="fc" id="L945">            return dao.createCampaignHOOAssignment(objValue);</span>
<span class="nc" id="L946">        } catch (BbmCreateException e) {</span>
<span class="nc" id="L947">            handleException(e);</span>
<span class="nc" id="L948">            throw e;</span>
        } finally {
<span class="pc" id="L950">            dao.cleanUp();</span>
<span class="pc" id="L951">            methodFinish();</span>
        }
    }

    /**
     * save a campaign's HOO assignment
     */
    public void updateCampaignHOOAssignment(CampaignHOO objValue) throws BbmUpdateException {
<span class="fc" id="L959">        methodStart(&quot;updateCampaignHOOAssignment&quot;, objValue);</span>
<span class="fc" id="L960">        CampaignHOODAO dao = new CampaignHOODAO();</span>
        try {
<span class="fc" id="L962">            dao.updateCampaignHOOAssignment(objValue);</span>
<span class="nc" id="L963">        } catch (BbmUpdateException e) {</span>
<span class="nc" id="L964">            handleException(e);</span>
<span class="nc" id="L965">            throw e;</span>
        } finally {
<span class="pc" id="L967">            dao.cleanUp();</span>
<span class="pc" id="L968">            methodFinish();</span>
<span class="fc" id="L969">        }</span>
<span class="fc" id="L970">    }</span>

    /**
     * delete a campaign's HOO assignments given the assignment ids
     */
    public void deleteCampaignHOOAssignments(Collection colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L976">        methodStart(&quot;deleteCampaignHOOAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L977">        CampaignHOODAO dao = new CampaignHOODAO();</span>
        try {
<span class="nc" id="L979">            dao.deleteCampaignHOOAssignments(colIDAssignments);</span>
<span class="nc" id="L980">        } catch (BbmRemoveException e) {</span>
<span class="nc" id="L981">            handleException(e);</span>
<span class="nc" id="L982">            throw e;</span>
        } finally {
<span class="nc" id="L984">            dao.cleanUp();</span>
<span class="nc" id="L985">            methodFinish();</span>
<span class="nc" id="L986">        }</span>
<span class="nc" id="L987">    }</span>

    /**
     * return a hashmap of (idCampaign, idName)
     */
    public HashMap getCampaignNamesByIDs(Collection colCampaignIDs) throws BbmFinderException {
<span class="nc" id="L993">        methodStart(&quot;getCampaignNamesByIDs&quot;, colCampaignIDs);</span>
        try {
<span class="nc" id="L995">            return CampaignDAO.getCampaignNamesByIDs(colCampaignIDs);</span>
<span class="nc" id="L996">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L997">            handleException(e, false);</span>
<span class="nc" id="L998">            throw e;</span>
        } finally {
<span class="nc" id="L1000">            methodFinish();</span>
        }
    }

    /**
     * Creates a scheduling period
     *
     * @return ID of the created scheduling period
     * @objValue the scheduling period value object
     */
    public ID createSchedulingPeriod(SchedulingPeriod objValue) throws BbmCreateException {
<span class="fc" id="L1011">        methodStart(&quot;createSchedulingPeriod&quot;, objValue);</span>
<span class="fc" id="L1012">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="fc" id="L1014">            return dao.createSchedulingPeriod(objValue);</span>
<span class="nc" id="L1015">        } catch (BbmCreateException e) {</span>
<span class="nc" id="L1016">            handleException(e, false);</span>
<span class="nc" id="L1017">            throw e;</span>
<span class="nc" id="L1018">        } catch (Exception e) {</span>
<span class="nc" id="L1019">            handleException(e);</span>
<span class="nc" id="L1020">            throw new BbmCreateException(e);</span>
        } finally {
<span class="pc bpc" id="L1022" title="3 of 4 branches missed.">            if (dao != null) {</span>
<span class="pc" id="L1023">                dao.cleanUp();</span>
            }
<span class="pc" id="L1025">            methodFinish();</span>
        }
    }

    /**
     * Updates a collection of scheduling periods
     *
     * @return void
     * @colObjValues the scheduling period collection of value objects
     */
    public void updateSchedulingPeriods(Collection&lt;SchedulingPeriod&gt; colObjValues) throws BbmUpdateException,
            MultiUserException {
<span class="fc" id="L1037">        methodStart(&quot;updateSchedulingPeriods&quot;);</span>
<span class="fc" id="L1038">        SchedulingPeriodDAO dao = null;</span>
        try {
<span class="fc" id="L1040">            dao = new SchedulingPeriodDAO();</span>
<span class="fc" id="L1041">            dao.updateSchedulingPeriods(colObjValues);</span>
<span class="nc" id="L1042">        } catch (BbmUpdateException e) {</span>
<span class="nc" id="L1043">            handleException(e, false);</span>
<span class="nc" id="L1044">            throw e;</span>
<span class="nc" id="L1045">        } catch (Exception e) {</span>
<span class="nc" id="L1046">            handleException(e);</span>
<span class="nc" id="L1047">            throw new BbmUpdateException(e);</span>
        } finally {
<span class="pc bpc" id="L1049" title="3 of 4 branches missed.">            if (dao != null) {</span>
<span class="pc" id="L1050">                dao.cleanUp();</span>
            }
<span class="pc" id="L1052">            methodFinish();</span>
<span class="fc" id="L1053">        }</span>
<span class="fc" id="L1054">    }</span>

    /**
     * Deletes a collection of scheduling periods
     *
     * @return void
     * @colIDs collection of ids of scheduling periods to be deleted
     */
    public void deleteSchedulingPeriods(Collection&lt;ID&gt; colIDs) throws BbmRemoveException, MultiUserException {
<span class="nc" id="L1063">        methodStart(&quot;deleteSchedulingPeriods&quot;);</span>
<span class="nc" id="L1064">        SchedulingPeriodDAO dao = null;</span>
        try {
<span class="nc" id="L1066">            dao = new SchedulingPeriodDAO();</span>
<span class="nc" id="L1067">            dao.deleteSchedulingPeriods(colIDs);</span>
<span class="nc" id="L1068">        } catch (BbmRemoveException e) {</span>
<span class="nc" id="L1069">            handleException(e, false);</span>
<span class="nc" id="L1070">            throw e;</span>
<span class="nc" id="L1071">        } catch (Exception e) {</span>
<span class="nc" id="L1072">            handleException(e);</span>
<span class="nc" id="L1073">            throw new BbmRemoveException(e);</span>
        } finally {
<span class="nc bnc" id="L1075" title="All 4 branches missed.">            if (dao != null) {</span>
<span class="nc" id="L1076">                dao.cleanUp();</span>
            }
<span class="nc" id="L1078">            methodFinish();</span>
<span class="nc" id="L1079">        }</span>
<span class="nc" id="L1080">    }</span>

    /**
     * get scheduling periods for a campaign
     *
     * @return a collection of SchedulingPeriod objects which hold the
     * assignment information
     * @idCampaign campaign id
     * @dtStart, @dtEnd: the time period, null date means a open period
     */
    public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, Date dtStart, Date dtEnd)
            throws BbmFinderException {
<span class="fc" id="L1092">        methodStart(&quot;getSchedulingPeriods&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L1093">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="fc" id="L1095">            return dao.getSchedulingPeriods(idCampaign, dtStart, dtEnd, null, null);</span>
<span class="nc" id="L1096">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1097">            handleException(e, false);</span>
<span class="nc" id="L1098">            throw e;</span>
        } finally {
<span class="pc bpc" id="L1100" title="3 of 4 branches missed.">            if (dao != null) {</span>
<span class="pc" id="L1101">                dao.cleanUp();</span>
            }
<span class="pc" id="L1103">            methodFinish();</span>
        }
    }

    /**
     * get scheduling periods for a campaign and linked to a org
     *
     * @return a collection of SchedulingPeriod objects which hold the
     * assignment information
     * @idCampaign campaign id
     * @idOrg organization id
     * @dtStart, @dtEnd: the time period, null date means a open period
     */
    public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, ID idOrg, Date dtStart, Date dtEnd)
            throws BbmFinderException {
<span class="nc" id="L1118">        methodStart(&quot;getSchedulingPeriods&quot;, idCampaign, idOrg, dtStart, dtEnd);</span>
<span class="nc" id="L1119">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="nc" id="L1121">            return dao.getSchedulingPeriods(idCampaign, idOrg, dtStart, dtEnd, null, null);</span>
<span class="nc" id="L1122">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1123">            handleException(e, false);</span>
<span class="nc" id="L1124">            throw e;</span>
        } finally {
<span class="nc bnc" id="L1126" title="All 4 branches missed.">            if (dao != null) {</span>
<span class="nc" id="L1127">                dao.cleanUp();</span>
            }
<span class="nc" id="L1129">            methodFinish();</span>
        }
    }

    /**
     * get a campaign workresource assignment object by id
     */
    public CampaignWorkResource getCampaignWorkResourceAssignmentByID(ID idAssignment) throws BbmFinderException {
<span class="nc" id="L1137">        methodStart(&quot;getCampaignWorkResourceAssignmentByID&quot;, idAssignment);</span>
<span class="nc" id="L1138">        CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
        try {
<span class="nc" id="L1140">            return dao.getCampaignWorkResourceAssignmentByID(idAssignment);</span>
<span class="nc" id="L1141">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1142">            handleException(e, false);</span>
<span class="nc" id="L1143">            throw e;</span>
        } finally {
<span class="nc" id="L1145">            dao.cleanUp();</span>
<span class="nc" id="L1146">            methodFinish();</span>
        }
    }

    /**
     * get campaign workresource assignments given their ids
     */
    public Collection getCampaignWorkResourceAssignmentsByIDs(Collection colAssignmentIDs) throws BbmFinderException {
<span class="nc" id="L1154">        methodStart(&quot;getCampaignWorkResourceAssignmentsByIDs&quot;, colAssignmentIDs);</span>
<span class="nc" id="L1155">        CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
        try {
<span class="nc" id="L1157">            return dao.getCampaignWorkResourceAssignmentsByIDs(colAssignmentIDs);</span>
<span class="nc" id="L1158">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1159">            handleException(e, false);</span>
<span class="nc" id="L1160">            throw e;</span>
        } finally {
<span class="nc" id="L1162">            dao.cleanUp();</span>
<span class="nc" id="L1163">            methodFinish();</span>
        }
    }

    /**
     * get a campaignHOO object by id
     */
    public CampaignHOO getCampaignHOOAssignmentByID(ID idAssignment) throws BbmFinderException {
<span class="nc" id="L1171">        methodStart(&quot;getCampaignHOOAssignmentByID&quot;, idAssignment);</span>
<span class="nc" id="L1172">        CampaignHOODAO dao = new CampaignHOODAO();</span>
        try {
<span class="nc" id="L1174">            return dao.getCampaignHOOAssignmentByID(idAssignment);</span>
<span class="nc" id="L1175">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1176">            handleException(e, false);</span>
<span class="nc" id="L1177">            throw e;</span>
        } finally {
<span class="nc" id="L1179">            dao.cleanUp();</span>
<span class="nc" id="L1180">            methodFinish();</span>
        }
    }

    /**
     * Returns the SchedulingPeriod matching the given ID.  This Scheduling Period will have its
     * local start and end times set.
     *
     * @param idSP - The integer ID of the scheduling period.
     * @return The Scheduling Period object matching the given ID.
     * @throws BbmFinderException
     * @throws BbmObjectNotFoundException
     * @throws RemoteException
     */
    public SchedulingPeriod getSchedulingPeriodByID(ID idSP) throws BbmFinderException, BbmObjectNotFoundException {
<span class="fc" id="L1195">        methodStart(&quot;getSchedulingPeriodByID&quot;, idSP);</span>
<span class="fc" id="L1196">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="fc" id="L1198">            Collection&lt;SchedulingPeriod&gt; schedulingPeriods = dao.getSchedulingPeriods(null, null, null, idSP, null);</span>
<span class="pc bpc" id="L1199" title="1 of 2 branches missed.">            if (schedulingPeriods.isEmpty()) {</span>
<span class="nc" id="L1200">                return null;</span>
            }
<span class="fc" id="L1202">            SchedulingPeriod sp = schedulingPeriods.iterator().next();</span>

<span class="fc" id="L1204">            Campaign campaign = this.getCampaignByID(sp.getCampaignID());</span>
<span class="fc" id="L1205">            TimeZone tz = campaign.getTimeZone();</span>
<span class="fc" id="L1206">            sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), tz));</span>
<span class="fc" id="L1207">            sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), tz));</span>

<span class="fc" id="L1209">            return sp;</span>
<span class="nc" id="L1210">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1211">            handleException(e, false);</span>
<span class="nc" id="L1212">            throw e;</span>
        } finally {
<span class="pc bpc" id="L1214" title="5 of 6 branches missed.">            if (dao != null) {</span>
<span class="pc" id="L1215">                dao.cleanUp();</span>
            }
<span class="pc" id="L1217">            methodFinish();</span>
        }
    }

    /**
     * get scheduling period by id
     */
    public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByID(Collection&lt;ID&gt; cSP) throws BbmFinderException, BbmObjectNotFoundException {
<span class="fc" id="L1225">        methodStart(&quot;getSchedulingPeriodsByID&quot;, cSP);</span>
<span class="fc" id="L1226">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="fc" id="L1228">            return dao.getSchedulingPeriods(null, null, null, null, cSP);</span>
<span class="nc" id="L1229">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1230">            handleException(e, false);</span>
<span class="nc" id="L1231">            throw e;</span>
        } finally {
<span class="pc bpc" id="L1233" title="3 of 4 branches missed.">            if (dao != null) {</span>
<span class="pc" id="L1234">                dao.cleanUp();</span>
            }
<span class="pc" id="L1236">            methodFinish();</span>
        }
    }

    /**
     * create campaign HOO based on its linked organization HOO.
     * &lt;p&gt;
     * 1. do not create any campaignHOO if the campaign already has an hours of
     * operation. 2. set campaign HOO to be the same as the organization HOO if
     * they have the same time zone.
     *
     * @return the campaignHOO ID if created successfully
     */
    public ID createCampaignHOOFromOrg(ID idCampaign, ID idOrg) throws BbmCreateException {
<span class="nc" id="L1250">        methodStart(&quot;createCampaignHOOFromOrg&quot;, idCampaign, idOrg);</span>
<span class="nc" id="L1251">        CampaignHOODAO dao = new CampaignHOODAO();</span>
        try {
<span class="nc" id="L1253">            return dao.createCampaignHOOFromOrg(idCampaign, idOrg);</span>
<span class="nc" id="L1254">        } catch (Exception e) {</span>
<span class="nc" id="L1255">            handleException(e);</span>
<span class="nc" id="L1256">            throw new BbmCreateException(e);</span>
        } finally {
<span class="nc" id="L1258">            dao.cleanUp();</span>
<span class="nc" id="L1259">            methodFinish();</span>
        }
    }

    public Map getSchedulingParameters(ID idSchedulingPeriod) throws BbmFinderException {
<span class="fc" id="L1264">        methodStart(&quot;getSchedulingParameters&quot;, idSchedulingPeriod);</span>
        try {
<span class="fc" id="L1266">            return new SPParamDAO().getSchedulingParameters(idSchedulingPeriod);</span>
<span class="nc" id="L1267">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1268">            handleException(e);</span>
<span class="nc" id="L1269">            throw e;</span>
        } finally {
<span class="pc" id="L1271">            methodFinish();</span>
        }
    }

    public void setSchedulingParameters(ID idSchedulingPeriod, Map mParameters, String sEmployees) throws BbmCreateException {
<span class="fc" id="L1276">        methodStart(&quot;setSchedulingParameters&quot;, idSchedulingPeriod, mParameters, sEmployees);</span>
        try {
<span class="fc" id="L1278">            new SPParamDAO().setSchedulingParameters(idSchedulingPeriod, mParameters, sEmployees);</span>
<span class="nc" id="L1279">        } catch (BbmCreateException e) {</span>
<span class="nc" id="L1280">            handleException(e);</span>
<span class="nc" id="L1281">            throw e;</span>
        } finally {
<span class="pc" id="L1283">            methodFinish();</span>
<span class="fc" id="L1284">        }</span>
<span class="fc" id="L1285">    }</span>

    public ID getMostRecentSPWithParameters(Date dtStart, ID idCampaign) throws BbmFinderException {
<span class="nc" id="L1288">        methodStart(&quot;getMostRecentSPWithParameters&quot;, dtStart, idCampaign);</span>
        try {
<span class="nc" id="L1290">            return new SPParamDAO().getMostRecentSPWithParameters(dtStart, idCampaign);</span>
<span class="nc" id="L1291">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1292">            handleException(e);</span>
<span class="nc" id="L1293">            throw e;</span>
        } finally {
<span class="nc" id="L1295">            methodFinish();</span>
        }
    }

    public Pair getDirtyStatus(ID idSchedulingPeriod) throws BbmFinderException {
<span class="nc" id="L1300">        methodStart(&quot;getDirtyStatus&quot;, idSchedulingPeriod);</span>
        try {
<span class="nc" id="L1302">            return new SPParamDAO().getDirtyStatus(idSchedulingPeriod);</span>
<span class="nc" id="L1303">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1304">            handleException(e);</span>
<span class="nc" id="L1305">            throw e;</span>
        } finally {
<span class="nc" id="L1307">            methodFinish();</span>
        }
    }

    public Collection&lt;SchedulingPeriod&gt; getCommonSchedulingPeriods(ID campaignID, Collection&lt;ID&gt; employeeIDs, Date date, int nNumberToGet) throws BbmFinderException {

<span class="nc" id="L1313">        methodStart(&quot;getCommonSchedulingPeriods&quot;, campaignID, date);</span>
<span class="nc" id="L1314">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="nc" id="L1316">            Collection&lt;SchedulingPeriod&gt; schedulingPeriods = dao.getCommonSchedulingPeriods(campaignID, employeeIDs, date, nNumberToGet);</span>
<span class="nc" id="L1317">            return convertSchedulingPeriodDatesToCampaignTZ(campaignID, schedulingPeriods);</span>

<span class="nc" id="L1319">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1320">            handleException(e);</span>
<span class="nc" id="L1321">            throw e;</span>
        } finally {
<span class="nc bnc" id="L1323" title="All 4 branches missed.">            if (dao != null) {</span>
<span class="nc" id="L1324">                dao.cleanUp();</span>
            }
<span class="nc" id="L1326">            methodFinish();</span>
        }

    }

    public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, Date dtDate, int nNumberToGet, int eTimeFrame)
            throws BbmFinderException {
<span class="fc" id="L1333">        methodStart(&quot;getSchedulingPeriods&quot;, idCampaign, dtDate);</span>
<span class="fc" id="L1334">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="fc" id="L1336">            Collection&lt;SchedulingPeriod&gt; schedulingPeriods = dao.getSchedulingPeriods(idCampaign, dtDate, nNumberToGet,</span>
                    eTimeFrame);

            // Configure the local time for the campaign time zone.
<span class="fc" id="L1340">            return convertSchedulingPeriodDatesToCampaignTZ(idCampaign, schedulingPeriods);</span>
<span class="nc" id="L1341">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1342">            handleException(e);</span>
<span class="nc" id="L1343">            throw e;</span>
        } finally {
<span class="pc bpc" id="L1345" title="3 of 4 branches missed.">            if (dao != null) {</span>
<span class="pc" id="L1346">                dao.cleanUp();</span>
            }
<span class="pc" id="L1348">            methodFinish();</span>
        }
    }

    private Collection&lt;SchedulingPeriod&gt; convertSchedulingPeriodDatesToCampaignTZ(ID idCampaign, Collection&lt;SchedulingPeriod&gt; schedulingPeriods) throws BbmObjectNotFoundException, BbmFinderException {
<span class="fc" id="L1353">        Campaign campaign = this.getCampaignByID(idCampaign);</span>
<span class="fc" id="L1354">        TimeZone tz = campaign.getTimeZone();</span>
<span class="fc bfc" id="L1355" title="All 2 branches covered.">        for (SchedulingPeriod sp : schedulingPeriods) {</span>
<span class="fc" id="L1356">            sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), tz));</span>
<span class="fc" id="L1357">            sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), tz));</span>
<span class="fc" id="L1358">        }</span>
<span class="fc" id="L1359">        return schedulingPeriods;</span>
    }

    /**
     * Gets the SP object from the SP table (as opposed to the getSP() method,
     * which gets a SchedulingPeriod object).
     *
     * @param spID - The SP ID
     * @return An SP object.
     * @throws BbmFinderException
     */
    public SP getRealSP(ID spID) throws BbmFinderException {
<span class="nc" id="L1371">        methodStart(&quot;getRealSP&quot;);</span>
        try {
<span class="nc" id="L1373">            return SPDAO.getSPByID(spID);</span>
<span class="nc" id="L1374">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1375">            handleException(e);</span>
<span class="nc" id="L1376">            throw e;</span>
        } finally {
<span class="nc" id="L1378">            methodFinish();</span>
        }
    }

    /**
     * Update the SP object from the SP table (as opposed to the
     * SchedulingPeriod object). We only update the following fields for now:
     * FTESHIFTS, FTEWORKHOURS, FTEPAIDHOURS, FTEPHONEHOURS, FTEWAGE.
     *
     * @param sp - The SP
     * @return An SP object.
     * @throws BbmFinderException
     */
    public void updateRealSP(SP sp) throws BbmUpdateException {
<span class="nc" id="L1392">        methodStart(&quot;updateRealSP&quot;);</span>
        try {
<span class="nc" id="L1394">            SPDAO.updateRealSP(sp);</span>
<span class="nc" id="L1395">        } catch (BbmUpdateException e) {</span>
<span class="nc" id="L1396">            handleException(e, false);</span>
<span class="nc" id="L1397">            throw e;</span>
<span class="nc" id="L1398">        } catch (Exception e) {</span>
<span class="nc" id="L1399">            handleException(e);</span>
<span class="nc" id="L1400">            throw new BbmUpdateException(e);</span>
        } finally {
<span class="nc" id="L1402">            methodFinish();</span>
<span class="nc" id="L1403">        }</span>
<span class="nc" id="L1404">    }</span>

    /**
     * Get a SchedulingPeriod object given the SP ID.
     *
     * @param spID - The SP ID
     * @return A SchedulingPeriod object.
     * @throws BbmFinderException
     */
    public SchedulingPeriod getSP(ID spID) throws BbmFinderException {
<span class="fc" id="L1414">        methodStart(&quot;getSP&quot;);</span>
<span class="fc" id="L1415">        SchedulingPeriodDAO dao = null;</span>
        try {
<span class="fc" id="L1417">            dao = new SchedulingPeriodDAO();</span>
<span class="fc" id="L1418">            return dao.getSchedulingPeriodByID(spID);</span>
<span class="nc" id="L1419">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1420">            handleException(e);</span>
<span class="nc" id="L1421">            throw e;</span>
        } finally {
<span class="pc" id="L1423">            methodFinish();</span>
<span class="pc bpc" id="L1424" title="3 of 4 branches missed.">            if (dao != null) {</span>
<span class="pc" id="L1425">                dao.cleanUp();</span>
            }
        }
    }

    /**
     * Creates a sp queue
     *
     * @return ID of the created sp queue
     * @objValue the sp queue value object
     */
    public ID createSPQueue(SPQueue objValue) throws BbmCreateException, BbmTimePeriodOverlapException {
<span class="fc" id="L1437">        methodStart(&quot;createSPQueue&quot;);</span>
<span class="fc" id="L1438">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="fc" id="L1440">            return dao.createSPQueue(objValue);</span>
<span class="nc" id="L1441">        } catch (BbmCreateException e) {</span>
<span class="nc" id="L1442">            handleException(e);</span>
<span class="nc" id="L1443">            throw e;</span>
<span class="nc" id="L1444">        } catch (BbmTimePeriodOverlapException e) {</span>
<span class="nc" id="L1445">            handleException(e);</span>
<span class="nc" id="L1446">            throw e;</span>
        } finally {
<span class="pc" id="L1448">            dao.cleanUp();</span>
<span class="pc" id="L1449">            methodFinish();</span>
        }
    }

    /**
     * Updates an sp queue
     *
     * @throws MultiUserException
     * @objValue the sp queue value object
     */
    public void updateSPQueue(SPQueue objValue) throws BbmUpdateException, MultiUserException {
<span class="fc" id="L1460">        methodStart(&quot;updateSPQueue&quot;);</span>
<span class="fc" id="L1461">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="fc" id="L1463">            dao.updateObject(objValue);</span>
<span class="fc bfc" id="L1464" title="All 2 branches covered.">            if (objValue.IsSkillsUpdated()) {</span>
<span class="fc" id="L1465">                dao.linkSkillsToSPQueue(objValue.getID(), objValue.getSkills());</span>
            }
<span class="nc" id="L1467">        } catch (BbmUpdateException e) {</span>
<span class="nc" id="L1468">            handleException(e);</span>
<span class="nc" id="L1469">            throw e;</span>
<span class="nc" id="L1470">        } catch (BbmCreateException e) {</span>
<span class="nc" id="L1471">            handleException(e);</span>
<span class="nc" id="L1472">            throw new BbmUpdateException(e);</span>
        } finally {
<span class="pc" id="L1474">            dao.cleanUp();</span>
<span class="pc" id="L1475">            methodFinish();</span>
<span class="fc" id="L1476">        }</span>
<span class="fc" id="L1477">    }</span>

    /**
     * Updates the given collection of spqueues, and the skills associated to
     * them (spqueueskills).
     */
    public void updateSPQueues(Collection&lt;SPQueue&gt; spQueues) throws BbmUpdateException, MultiUserException {
<span class="nc" id="L1484">        methodStart(&quot;updateSPQueues&quot;);</span>
<span class="nc" id="L1485">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="nc" id="L1487">            dao.updateObjects(spQueues);</span>
<span class="nc" id="L1488">            Map&lt;ID, Collection&lt;ID&gt;&gt; spQueueSkillMap = new HashMap&lt;ID, Collection&lt;ID&gt;&gt;();</span>
<span class="nc bnc" id="L1489" title="All 2 branches missed.">            for (SPQueue spQueue : spQueues) {</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">                if (spQueue.IsSkillsUpdated()) {</span>
<span class="nc" id="L1491">                    spQueueSkillMap.put(spQueue.getDEID(), spQueue.getSkills());</span>
                }
<span class="nc" id="L1493">            }</span>
<span class="nc bnc" id="L1494" title="All 2 branches missed.">            if (!spQueueSkillMap.isEmpty()) {</span>
<span class="nc" id="L1495">                dao.linkSkillsToSPQueues(spQueueSkillMap);</span>
            }
<span class="nc" id="L1497">        } catch (BbmUpdateException e) {</span>
<span class="nc" id="L1498">            handleException(e);</span>
<span class="nc" id="L1499">            throw e;</span>
<span class="nc" id="L1500">        } catch (BbmCreateException e) {</span>
<span class="nc" id="L1501">            handleException(e);</span>
<span class="nc" id="L1502">            throw new BbmUpdateException(e);</span>
        } finally {
<span class="nc" id="L1504">            dao.cleanUp();</span>
<span class="nc" id="L1505">            methodFinish();</span>
<span class="nc" id="L1506">        }</span>
<span class="nc" id="L1507">    }</span>

    /**
     * Creates the SPQueues. This method is specifically written to optimize
     * the bulk push from the Branch Forecasting. This only reads the following
     * fields of the SPqueue while creating the spqueues- spid, queueid, media
     * id, service level type, patience, sl anwer waiting time.
     */
    public SPQueueIDMap createSPQueuesWithLimitedFields(Collection&lt;SPQueue&gt; spQueues) throws BbmCreateException {
<span class="nc" id="L1516">        methodStart(&quot;createSPQueuesWithLimitedFields&quot;, spQueues);</span>
<span class="nc" id="L1517">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="nc" id="L1519">            return dao.createSPQueuesWithLimitedFields(spQueues);</span>
<span class="nc" id="L1520">        } catch (JdmoException e) {</span>
<span class="nc" id="L1521">            handleException(e);</span>
<span class="nc" id="L1522">            throw new BbmCreateException(e);</span>
        } finally {
<span class="nc" id="L1524">            dao.cleanUp();</span>
<span class="nc" id="L1525">            methodFinish();</span>
        }
    }

    /**
     * Updates the SPQueues. This method is specifically written to optimize
     * the bulk push from the Branch Forecasting. This only reads the following
     * fields of the SPqueue while updating the spqueues- spid, queueid, media
     * id, service level type, patience, sl anwer waiting time.
     */
    public void updateSPQueuesWithLimitedFields(Collection&lt;SPQueue&gt; spQueues) throws BbmUpdateException {
<span class="nc" id="L1536">        methodStart(&quot;updateSPQueuesWithLimitedFields&quot;, spQueues);</span>
<span class="nc" id="L1537">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="nc" id="L1539">            dao.updateSPQueuesWithLimitedFields(spQueues);</span>
<span class="nc" id="L1540">        } catch (JdmoException e) {</span>
<span class="nc" id="L1541">            handleException(e);</span>
<span class="nc" id="L1542">            throw new BbmUpdateException(e);</span>
        } finally {
<span class="nc" id="L1544">            dao.cleanUp();</span>
<span class="nc" id="L1545">            methodFinish();</span>
<span class="nc" id="L1546">        }</span>
<span class="nc" id="L1547">    }</span>

    /**
     * Deleted a sp queue
     *
     * @spQueueID the ID of the sp queue to delete
     */
    public void deleteSPQueue(ID spQueueID) throws BbmRemoveException {
<span class="nc" id="L1555">        methodStart(&quot;deleteSPQueue&quot;);</span>
<span class="nc" id="L1556">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="nc" id="L1558">            dao.deleteSPQueue(spQueueID);</span>
<span class="nc" id="L1559">        } catch (BbmRemoveException e) {</span>
<span class="nc" id="L1560">            handleException(e);</span>
<span class="nc" id="L1561">            throw e;</span>
        } finally {
<span class="nc" id="L1563">            dao.cleanUp();</span>
<span class="nc" id="L1564">            methodFinish();</span>
<span class="nc" id="L1565">        }</span>
<span class="nc" id="L1566">    }</span>

    public Collection&lt;SPQueue&gt; getSPQueues(Collection&lt;ID&gt; spQueueIDs) throws BbmFinderException {
<span class="nc" id="L1569">        methodStart(&quot;getSPQueues&quot;);</span>
<span class="nc" id="L1570">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="nc" id="L1572">            return dao.getObjectsByIDs(spQueueIDs);</span>
<span class="nc" id="L1573">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1574">            handleException(e);</span>
<span class="nc" id="L1575">            throw e;</span>
        } finally {
<span class="nc" id="L1577">            dao.cleanUp();</span>
<span class="nc" id="L1578">            methodFinish();</span>
        }
    }

    public SPQueue getSPQueue(ID spQueueID) throws BbmFinderException {
<span class="fc" id="L1583">        methodStart(&quot;getSPQueue&quot;);</span>
<span class="fc" id="L1584">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="fc" id="L1586">            return dao.getSPQueue(spQueueID);</span>
<span class="nc" id="L1587">        } catch (JdmoException e) {</span>
<span class="nc" id="L1588">            handleException(e);</span>
<span class="nc" id="L1589">            throw new BbmFinderException(e);</span>
<span class="nc" id="L1590">        } catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L1591">            handleException(e);</span>
<span class="nc" id="L1592">            throw e;</span>
<span class="nc" id="L1593">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1594">            handleException(e);</span>
<span class="nc" id="L1595">            throw e;</span>
        } finally {
<span class="pc" id="L1597">            dao.cleanUp();</span>
<span class="pc" id="L1598">            methodFinish();</span>
        }
    }

    public SPQueue getSPQueue(ID spID, ID queueID) throws BbmFinderException {
<span class="fc" id="L1603">        methodStart(&quot;getSPQueue&quot;);</span>
<span class="fc" id="L1604">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="fc" id="L1606">            ID id = SPQueueDAO.getSPQueueID(spID, queueID);</span>
<span class="fc" id="L1607">            return dao.getSPQueue(id);</span>
<span class="nc" id="L1608">        } catch (JdmoException e) {</span>
<span class="nc" id="L1609">            handleException(e);</span>
<span class="nc" id="L1610">            throw new BbmFinderException(e);</span>
        } finally {
<span class="pc" id="L1612">            dao.cleanUp();</span>
<span class="pc" id="L1613">            methodFinish();</span>
        }
    }

    // SpQueueIDs are SIDs
    public Collection&lt;SPQueue&gt; getSPQueuesByIDs(Collection&lt;ID&gt; spQueueIDs) throws BbmFinderException {
<span class="fc" id="L1619">        methodStart(&quot;getSPQueuesByIDs&quot;);</span>
<span class="fc" id="L1620">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="fc" id="L1622">            return dao.getSPQueuesByIDs(spQueueIDs);</span>
        } finally {
<span class="pc" id="L1624">            dao.cleanUp();</span>
<span class="pc" id="L1625">            methodFinish();</span>
        }
    }

    public SPQueue getCombinedSPQueue(ID spID, ID mediaID) throws BbmFinderException {
<span class="fc" id="L1630">        methodStart(&quot;getCombinedSPQueue&quot;, spID, mediaID);</span>
<span class="fc" id="L1631">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="fc" id="L1633">            return dao.getCombinedSPQueue(spID, mediaID);</span>
<span class="nc" id="L1634">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1635">            handleException(e);</span>
<span class="nc" id="L1636">            throw e;</span>
        } finally {
<span class="pc" id="L1638">            dao.cleanUp();</span>
<span class="pc" id="L1639">            methodFinish();</span>
        }
    }

    /**
     * Returns a list of combined SPQueues associated to (i.e. having the same
     * SP and media ID of) the given list of spQueues.
     */
    public Collection&lt;SPQueue&gt; getCombinedSPQueues(Collection&lt;SPQueue&gt; spQueues) throws BbmFinderException {
<span class="nc" id="L1648">        methodStart(&quot;getCombinedSPQueues&quot;, spQueues);</span>
<span class="nc" id="L1649">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="nc" id="L1651">            return dao.getCombinedSPQueues(spQueues);</span>
<span class="nc" id="L1652">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1653">            handleException(e);</span>
<span class="nc" id="L1654">            throw e;</span>
        } finally {
<span class="nc" id="L1656">            dao.cleanUp();</span>
<span class="nc" id="L1657">            methodFinish();</span>
        }
    }

    /**
     * @deprecated
     */
    @Deprecated
    public Collection&lt;SPQueue&gt; getSPQueuesBySPIDs(Collection&lt;ID&gt; SPIDs) throws BbmFinderException {
<span class="fc" id="L1666">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="fc" id="L1668">            return dao.getSPQueuesBySPIDs(SPIDs);</span>
<span class="nc" id="L1669">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1670">            handleException(e);</span>
<span class="nc" id="L1671">            throw e;</span>
<span class="nc" id="L1672">        } catch (Exception e) {</span>
<span class="nc" id="L1673">            handleException(e);</span>
<span class="nc" id="L1674">            throw new BbmFinderException(e);</span>
        } finally {
<span class="pc" id="L1676">            dao.cleanUp();</span>
<span class="pc" id="L1677">            methodFinish();</span>
        }
    }

    public Collection&lt;SPQueue&gt; getSPQueuesBySPIDsFixed(Collection&lt;ID&gt; SPSIDs) throws BbmFinderException {
<span class="fc" id="L1682">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="fc" id="L1684">            return dao.getSPQueuesBySPIDsFixed(SPSIDs);</span>
<span class="nc" id="L1685">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1686">            handleException(e);</span>
<span class="nc" id="L1687">            throw e;</span>
<span class="nc" id="L1688">        } catch (Exception e) {</span>
<span class="nc" id="L1689">            handleException(e);</span>
<span class="nc" id="L1690">            throw new BbmFinderException(e);</span>
        } finally {
<span class="pc" id="L1692">            dao.cleanUp();</span>
<span class="pc" id="L1693">            methodFinish();</span>
        }
    }

    /**
     * Returns a paginated set of SPQueues for the given scheduling period. The
     * returned value includes the following: a chunk of SPQueue value objects,
     * representing the sp queues on the first viewed page, and a sorted list of
     * SPQueue IDs that are sorted by the given sort fields in the comparators
     * map.
     */
    public PaginationPair&lt;SPQueue&gt; getPaginatedSPQueuesForSchedulingPeriod(ID spID, boolean isAscendingSort, int pageIDSize,
                                                                           int pageIndex, LinkedHashMap&lt;DBSortField, Comparator&gt; comparators, Collection&lt;ID&gt; filteredIDs)
            throws BbmFinderException {
<span class="fc" id="L1707">        methodStart(&quot;getPaginatedSPQueuesForSchedulingPeriod&quot;, spID, isAscendingSort, pageIDSize, pageIndex, comparators);</span>
<span class="fc" id="L1708">        SPQueueDAO spqDAO = new SPQueueDAO();</span>

        try {
<span class="fc" id="L1711">            return spqDAO.getCompletePaginationDataSetForSchedulingPeriod(spID, isAscendingSort, pageIDSize, pageIndex,</span>
                    comparators, filteredIDs);
<span class="nc" id="L1713">        } catch (BbmFinderException ex) {</span>
<span class="nc" id="L1714">            handleException(ex);</span>
<span class="nc" id="L1715">            throw ex;</span>
        } finally {
<span class="pc" id="L1717">            spqDAO.cleanUp();</span>
<span class="pc" id="L1718">            methodFinish();</span>
        }
    }

    /*
     * Returns the non-combined SPQueues belonging to the given SP with the
     * specified media ID. If a null media ID is specified, it will return all
     * non-combined SPQueues in belonging to the SP.
     */
    public Collection&lt;SPQueue&gt; getNonCombinedSPQueuesByMediaAndSP(ID spID, ID mediaID) throws BbmFinderException {
<span class="fc" id="L1728">        methodStart(&quot;getNonCombinedSPQueuesByMediaAndSP&quot;, spID, mediaID);</span>
<span class="fc" id="L1729">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="fc" id="L1731">            return dao.getNonCombinedSPQueuesByMediaAndSP(spID, mediaID);</span>
<span class="nc" id="L1732">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1733">            handleException(e);</span>
<span class="nc" id="L1734">            throw e;</span>
        } finally {
<span class="pc" id="L1736">            dao.cleanUp();</span>
<span class="pc" id="L1737">            methodFinish();</span>
        }
    }

    /**
     * Deleted collection of campaigns
     *
     * @colCampaignIDs the IDs of the campaigns to delete
     */
    public void deleteCampaigns(Collection&lt;ID&gt; colCampaignIDs) throws BbmRemoveException {
<span class="fc" id="L1747">        methodStart(&quot;deleteCampaigns&quot;);</span>
        try {
<span class="fc" id="L1749">            CampaignDAO.deleteCampaigns(colCampaignIDs);</span>
<span class="nc" id="L1750">        } catch (BbmRemoveException e) {</span>
<span class="nc" id="L1751">            handleException(e);</span>
<span class="nc" id="L1752">            throw e;</span>
        } finally {
<span class="pc" id="L1754">            methodFinish();</span>
<span class="fc" id="L1755">        }</span>
<span class="fc" id="L1756">    }</span>

	public void deleteAllCampaigns() throws BbmRemoveException {
<span class="nc" id="L1759">		methodStart(&quot;deleteAllCampaigns&quot;);</span>
		try {
<span class="nc" id="L1761">			CampaignDAO.deleteAllCampaigns();</span>
<span class="nc" id="L1762">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1763">			handleException(e);</span>
<span class="nc" id="L1764">			throw e;</span>
		} finally {
<span class="nc" id="L1766">			methodFinish();</span>
<span class="nc" id="L1767">		}</span>
<span class="nc" id="L1768">	}</span>

    public void unlinkWorkResourcesToSchedulingPeriod(ID spID, ID SPDEID, Collection wkrsIDs) throws BbmRemoveException {
<span class="nc" id="L1771">        methodStart(&quot;unlinkWorkResourcesToSchedulingPeriod&quot;, spID, SPDEID, wkrsIDs);</span>
<span class="nc" id="L1772">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="nc" id="L1774">            dao.unlinkWorkResourcesToSchedulingPeriod(spID, SPDEID, wkrsIDs);</span>
<span class="nc" id="L1775">        } catch (BbmRemoveException e) {</span>
<span class="nc" id="L1776">            handleException(e, false);</span>
<span class="nc" id="L1777">            throw e;</span>
        } finally {
<span class="nc bnc" id="L1779" title="All 4 branches missed.">            if (dao != null) {</span>
<span class="nc" id="L1780">                dao.cleanUp();</span>
            }
<span class="nc" id="L1782">            methodFinish();</span>
<span class="nc" id="L1783">        }</span>
<span class="nc" id="L1784">    }</span>

    public void linkWorkResourcesToSchedulingPeriod(ID spID, Collection wkrsIDs) throws BbmCreateException {
<span class="fc" id="L1787">        methodStart(&quot;linkWorkResourcesToSchedulingPeriod&quot;, spID, wkrsIDs);</span>
<span class="fc" id="L1788">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="fc" id="L1790">            dao.linkWorkResourcesToSchedulingPeriod(spID, wkrsIDs);</span>
<span class="fc" id="L1791">        } catch (BbmCreateException e) {</span>
<span class="fc" id="L1792">            handleException(e, false);</span>
<span class="fc" id="L1793">            throw e;</span>
        } finally {
<span class="pc bpc" id="L1795" title="2 of 4 branches missed.">            if (dao != null) {</span>
<span class="fc" id="L1796">                dao.cleanUp();</span>
            }
<span class="fc" id="L1798">            methodFinish();</span>
<span class="fc" id="L1799">        }</span>
<span class="fc" id="L1800">    }</span>

    /**
     * get parent scheduling period by id
     */
    public ID getParentSchedulingPeriodID(ID idSubSP) throws BbmFinderException {
<span class="fc" id="L1806">        methodStart(&quot;getParentSchedulingPeriodByID&quot;, idSubSP);</span>
<span class="fc" id="L1807">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="fc" id="L1809">            return dao.getParentSchedulingPeriodID(idSubSP);</span>
<span class="nc" id="L1810">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1811">            handleException(e, false);</span>
<span class="nc" id="L1812">            throw e;</span>
        } finally {
<span class="pc bpc" id="L1814" title="3 of 4 branches missed.">            if (dao != null) {</span>
<span class="pc" id="L1815">                dao.cleanUp();</span>
            }
<span class="pc" id="L1817">            methodFinish();</span>
        }
    }

    // this API will returns all the shift ID defined for this campaign or
    // inherited from the org linked to campaign
    public Collection&lt;ID&gt; getShift(ID campaignSID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L1824">        methodStart(&quot;getShift&quot;, campaignSID, dtStart, dtEnd);</span>
<span class="fc" id="L1825">        Jdmo dmo = new Jdmo();</span>
        try {
<span class="fc" id="L1827">            HashSet&lt;ID&gt; shifts = new HashSet&lt;ID&gt;();</span>
            // first find the shifts inherited from orgs that links to this
            // campaign and the shifts defined for this
            // campaign
<span class="fc" id="L1831">            shifts.addAll(getShiftForCampaign(dmo, campaignSID, dtStart, dtEnd));</span>
            // for distributed campaign, if the current campaign is parent, it
            // can access all the shifts defined for the
            // children
<span class="fc" id="L1835">            StringBuilder sb = new StringBuilder(100);</span>
<span class="fc" id="L1836">            sb.append(&quot;select sid from campaign where parentcampaignid in (select id from campaign where sid =&quot;)</span>
<span class="fc" id="L1837">                    .append(campaignSID).append(&quot;)&quot;);</span>
<span class="fc" id="L1838">            JdmoRowset rs = dmo.createRowset(sb.toString());</span>
<span class="fc" id="L1839">            ArrayList&lt;ID&gt; relatedSID = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L1840" title="All 2 branches covered.">            while (rs.next()) {</span>
<span class="fc" id="L1841">                relatedSID.add(rs.getID(1)); // all children</span>
            }

            // for distributed campaign, if it is child, it can access all the
            // shifts defined for its parent
<span class="fc" id="L1846">            Campaign current = this.getCampaignByID(campaignSID);</span>
<span class="pc bpc" id="L1847" title="1 of 2 branches missed.">            if (current.getParentID() != null) {</span>
<span class="nc" id="L1848">                relatedSID.add(current.getParentID());</span>
            }

<span class="fc bfc" id="L1851" title="All 2 branches covered.">            for (Iterator&lt;ID&gt; i = relatedSID.iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L1852">                shifts.addAll(getShiftForCampaign(dmo, i.next(), dtStart, dtEnd));</span>
            }

            // remove predefined SHIFT_OFF fromt the list
            ID shiftID;
<span class="fc bfc" id="L1857" title="All 2 branches covered.">            for (Iterator&lt;ID&gt; i = shifts.iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L1858">                shiftID = i.next();</span>
<span class="fc bfc" id="L1859" title="All 2 branches covered.">                if (shiftID.toInt() == 1) {</span>
<span class="fc" id="L1860">                    i.remove();</span>
                }
            }
<span class="fc" id="L1863">            return new ArrayList&lt;ID&gt;(shifts);</span>
<span class="nc" id="L1864">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1865">            handleException(e, false);</span>
<span class="nc" id="L1866">            throw e;</span>
<span class="nc" id="L1867">        } catch (Exception e) {</span>
<span class="nc" id="L1868">            handleException(e, false);</span>
<span class="nc" id="L1869">            throw new BbmFinderException(e);</span>
        } finally {
<span class="pc" id="L1871">            dmo.cleanUp();</span>
<span class="pc" id="L1872">            methodFinish();</span>
        }
    }

    private Collection&lt;ID&gt; getShiftForCampaign(Jdmo dmo, ID campaignSID, Date dtStart, Date dtEnd) throws Exception {
<span class="fc" id="L1877">        Collection orgIDs = getCampaignOrgs(dmo, campaignSID, dtStart, dtEnd);</span>
<span class="fc" id="L1878">        orgIDs.addAll(m_workResourceManager.getOrganizationsParentsByIDs(orgIDs));</span>

<span class="fc" id="L1880">        StringBuilder sbWhere = new StringBuilder(200);</span>
<span class="fc" id="L1881">        sbWhere.append(&quot;( CAMPAIGNID IN (SELECT ID FROM CAMPAIGN WHERE SID = &quot;).append(campaignSID).append(&quot;)&quot;);</span>
<span class="pc bpc" id="L1882" title="1 of 2 branches missed.">        if (!orgIDs.isEmpty()) {</span>
<span class="fc" id="L1883">            sbWhere.append(&quot; OR ORGANIZATIONID IN &quot;).append(dmo.createInClause(new HashSet(orgIDs)));</span>
        }
<span class="fc" id="L1885">        sbWhere.append(&quot;)&quot;);</span>
        // fix QC60132, not return deleted shifts
<span class="fc" id="L1887">        sbWhere.append(&quot; AND DELETEONDATE IS NULL order by name&quot;);</span>

<span class="fc" id="L1889">        JdmoRowset rs = dmo.createRowset(&quot;select sid from shift where &quot; + sbWhere.toString());</span>
<span class="fc" id="L1890">        Collection&lt;ID&gt; shiftIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L1891" title="All 2 branches covered.">        while (rs.next()) {</span>
<span class="fc" id="L1892">            shiftIDs.add(rs.getID(1));</span>
        }
<span class="fc" id="L1894">        return shiftIDs;</span>
    }

    public Collection&lt;ID&gt; getOrganizationsForCampaign(ID campaignSID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L1898">        methodStart(&quot;getOrganizationsForCampaign&quot;, campaignSID, dtStart, dtEnd);</span>
<span class="fc" id="L1899">        Jdmo dmo = new Jdmo();</span>
        try {
<span class="fc" id="L1901">            return getCampaignOrgs(dmo, campaignSID, dtStart, dtEnd);</span>
<span class="nc" id="L1902">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1903">            handleException(e, false);</span>
<span class="nc" id="L1904">            throw e;</span>
        } finally {
<span class="pc" id="L1906">            dmo.cleanUp();</span>
<span class="pc" id="L1907">            methodFinish();</span>
        }
    }

    private Collection&lt;ID&gt; getCampaignOrgs(Jdmo dmo, ID campaignSID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L1912">        CampaignOrgDAO dao = new CampaignOrgDAO(dmo);</span>
<span class="fc" id="L1913">        Campaign campaign = getCampaignByID(campaignSID);</span>
<span class="fc" id="L1914">        Collection&lt;CampaignOrg&gt; campOrgs = dao.getCampaignOrgAssignments(campaignSID, dtStart, dtEnd,</span>
<span class="fc" id="L1915">                campaign.getIsDistributed());</span>
<span class="fc" id="L1916">        ArrayList&lt;ID&gt; orgIDs = new ArrayList&lt;ID&gt;();</span>
        CampaignOrg assignment;
<span class="fc bfc" id="L1918" title="All 2 branches covered.">        for (Iterator&lt;CampaignOrg&gt; i = campOrgs.iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L1919">            assignment = i.next();</span>
<span class="fc" id="L1920">            orgIDs.add(assignment.getOrganizationID());</span>
        }
<span class="fc" id="L1922">        return orgIDs;</span>
    }

    /**
     * this API is created by angela in v11, to retrieve all the SPs for a
     * campaign.
     *
     * @param campaign
     * @return
     * @throws BbmFinderException
     */
    public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(Campaign campaign) throws BbmFinderException {
<span class="fc" id="L1934">        methodStart(&quot;getSchedulingPeriods&quot;);</span>
<span class="fc" id="L1935">        SchedulingPeriodDAO dao = null;</span>
        try {
<span class="fc" id="L1937">            dao = new SchedulingPeriodDAO();</span>
<span class="fc" id="L1938">            return dao.getSchedulingPeriods(campaign);</span>
<span class="nc" id="L1939">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1940">            handleException(e);</span>
<span class="nc" id="L1941">            throw e;</span>
        } finally {
<span class="pc bpc" id="L1943" title="3 of 4 branches missed.">            if (dao != null) {</span>
<span class="pc" id="L1944">                dao.cleanUp();</span>
            }
<span class="pc" id="L1946">            methodFinish();</span>
        }
    }

    /**
     * getFTECalculator for the specified collection of employees/phantoms and
     * events in the SP.
     *
     * @param idSP            - The SP SID.
     * @param hasProjectQueue - Is there a Project queue linked to the SP?
     * @param wrIds           - the selected employee/phantom ID's. Only these will be
     *                        considered for the FTE calculations. If you pass null here, we
     *                        will assume all emploees/phantoms/events in the entire SP.
     * @param defaultWage     - The default wage to use when the employee's wage is $0.0,
     *                        for calculating the &quot;Total Scheduled Cost&quot;.
     */
    public FTECalculator getFTECalculator(ID idSP, boolean hasProjectQueue, Collection&lt;ID&gt; wrIds, double defaultWage)
            throws BbmFinderException {
<span class="nc" id="L1964">        methodStart(&quot;getFTECalculator&quot;, idSP, wrIds);</span>
        try {
<span class="nc" id="L1966">            ScheduleAccessManager mScheduleAccess = WfmManagerFactory.getScheduleAccessManager(isWhatIf);</span>
<span class="nc" id="L1967">            ActivityManager mActivity = WfmManagerFactory.getActivityManager(isWhatIf);</span>
<span class="nc" id="L1968">            TimeSeriesManager mTimeSeries = WfmManagerFactory.getTimeSeriesManager(isWhatIf);</span>
<span class="nc" id="L1969">            WorkloadManager mWorkLoad = WfmManagerFactory.getWorkloadManager(isWhatIf);</span>
<span class="nc" id="L1970">            ForecastTimeSeriesManager mForcastTimeSeries = WfmManagerFactory.getForecastTimeSeriesManager(isWhatIf);</span>

<span class="nc" id="L1972">            SchedulingPeriod pPeriod = getSchedulingPeriodByID(idSP);</span>
<span class="nc" id="L1973">            Date dtStart = pPeriod.getStartTime();</span>
<span class="nc" id="L1974">            Date dtEnd = pPeriod.getEndTime();</span>

<span class="nc" id="L1976">            ID campaignID = pPeriod.getCampaignID();</span>
<span class="nc" id="L1977">            Campaign pCampaign = getCampaignByID(campaignID);</span>
<span class="nc" id="L1978">            TimeZone pTZ = pCampaign.getTimeZone();</span>

<span class="nc" id="L1980">            Collection&lt;CampaignHOO&gt; cHOOs = getCampaignHOOAssignments(pPeriod.getID(), dtStart, dtEnd);</span>

<span class="nc" id="L1982">            Collection&lt;CampaignWorkResource&gt; cWorkResourceAssignments = getCampaignWorkResourceAssignments(campaignID,</span>
                    dtStart, dtEnd);
<span class="nc" id="L1984">            TreeSet cEmployeeIDs = new TreeSet();</span>
<span class="nc bnc" id="L1985" title="All 2 branches missed.">            for (Iterator j = cWorkResourceAssignments.iterator(); j.hasNext(); ) {</span>
<span class="nc" id="L1986">                CampaignWorkResource cAssignment = (CampaignWorkResource) j.next();</span>

                // retain only the Employees that are in workResIds
<span class="nc bnc" id="L1989" title="All 4 branches missed.">                if (wrIds == null || wrIds.contains(cAssignment.getWorkResourceID())) {</span>
<span class="nc" id="L1990">                    cEmployeeIDs.add(cAssignment.getWorkResourceID());</span>
                }
<span class="nc" id="L1992">            }</span>
<span class="nc" id="L1993">            Collection cEmployees = m_workResourceManager.getEmployeesByIDs(cEmployeeIDs, dtStart,</span>
                    Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);

<span class="nc" id="L1996">            Collection cPhantoms = mScheduleAccess.getPhantoms(idSP);</span>

            // retain only the Phantoms that are in workResIds
<span class="nc" id="L1999">            Collection cPhantomsRetained = new ArrayList(cPhantoms.size());</span>
<span class="nc bnc" id="L2000" title="All 2 branches missed.">            for (Iterator pIt = cPhantoms.iterator(); pIt.hasNext(); ) {</span>
<span class="nc" id="L2001">                Phantom phantom = (Phantom) pIt.next();</span>
<span class="nc bnc" id="L2002" title="All 4 branches missed.">                if (wrIds == null || wrIds.contains(phantom.getID())) {</span>
<span class="nc" id="L2003">                    cPhantomsRetained.add(phantom);</span>
                }
<span class="nc" id="L2005">            }</span>

<span class="nc" id="L2007">            ArrayList aWorkResourceIDs = new ArrayList(cEmployeeIDs);</span>

<span class="nc" id="L2009">            Collection cEmpTemplates = new ArrayList(cPhantomsRetained.size()); // the</span>
            // employee
            // templates
            // for
            // the
            // Phantoms

<span class="nc" id="L2016">            LinkedHashMap hPhantomsIdsToEmpTemplateIDs = new LinkedHashMap(cPhantomsRetained.size()); // ordered</span>
            // map
            // of
            // phantomID to
            // EmployeeTemplateID

<span class="nc" id="L2022">            HashSet empTemplatesSet = new HashSet(); // temporary Set for</span>
            // keeping track of
            // employee templates
            // added to
            // cEmpTemplates

<span class="nc" id="L2028">            Iterator phantomIt = cPhantomsRetained.iterator();</span>
<span class="nc bnc" id="L2029" title="All 2 branches missed.">            while (phantomIt.hasNext()) {</span>
<span class="nc" id="L2030">                Phantom phantom = (Phantom) phantomIt.next();</span>
<span class="nc" id="L2031">                aWorkResourceIDs.add(phantom.getID()); // aWorkResourceIDs</span>
                // contains employeeIDs
                // followed by
                // phantomIDs
<span class="nc" id="L2035">                EmployeeTemplate empTemplate = m_scheduleAccessManager.getEmployeeTemplateByID(phantom</span>
<span class="nc" id="L2036">                        .getEmployeeTemplateID());</span>
<span class="nc" id="L2037">                cEmpTemplates.add(empTemplate);</span>
<span class="nc" id="L2038">                empTemplatesSet.add(empTemplate);</span>
<span class="nc" id="L2039">                hPhantomsIdsToEmpTemplateIDs.put(phantom.getID(), phantom.getEmployeeTemplateID());</span>
<span class="nc" id="L2040">            }</span>

            // Get any remaining Staffing Profiles linked to this SP that have
            // not been scheduled.
<span class="nc" id="L2044">            Collection allEmpTemplatesInSP = m_scheduleAccessManager.getEmployeeTemplatesInSP(idSP);</span>
<span class="nc bnc" id="L2045" title="All 2 branches missed.">            for (Iterator spTempIt = allEmpTemplatesInSP.iterator(); spTempIt.hasNext(); ) {</span>
<span class="nc" id="L2046">                EmployeeTemplate et = (EmployeeTemplate) spTempIt.next();</span>
<span class="nc bnc" id="L2047" title="All 2 branches missed.">                if (!empTemplatesSet.contains(et)) {</span>
<span class="nc" id="L2048">                    cEmpTemplates.add(et);</span>
<span class="nc" id="L2049">                    empTemplatesSet.add(et);</span>
                }
<span class="nc" id="L2051">            }</span>

            Collection cSchedules;
<span class="nc" id="L2054">            cSchedules = mScheduleAccess.getEventsForWorkResources(aWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L2055">            Map&lt;ID, Collection&lt;Event&gt;&gt; wrIdsToEventsMap = new HashMap&lt;ID, Collection&lt;Event&gt;&gt;();</span>
<span class="nc" id="L2056">            Iterator scheduleIt = cSchedules.iterator();</span>
<span class="nc bnc" id="L2057" title="All 2 branches missed.">            for (Iterator it = aWorkResourceIDs.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2058">                ID id = (ID) it.next();</span>
<span class="nc" id="L2059">                Collection schedulesForCurEmp = (Collection) scheduleIt.next();</span>
<span class="nc" id="L2060">                wrIdsToEventsMap.put(id, schedulesForCurEmp);</span>
<span class="nc" id="L2061">            }</span>

            // get the set of Activity ID's from the schedules.

<span class="nc" id="L2065">            TreeSet activityIdSet = new TreeSet();</span>
<span class="nc bnc" id="L2066" title="All 2 branches missed.">            for (Iterator schedIt = cSchedules.iterator(); schedIt.hasNext(); ) {</span>
<span class="nc" id="L2067">                Collection cAssignments = (Collection) schedIt.next();</span>
<span class="nc bnc" id="L2068" title="All 2 branches missed.">                if (cAssignments != null) {</span>
                    // flatten the Event collection first.
<span class="nc" id="L2070">                    Collection colFlattenedEvents = EventUtils.convertEventsToTimelineForSingleEmployee(cAssignments, null,</span>
                            null, null, true);

<span class="nc bnc" id="L2073" title="All 2 branches missed.">                    for (Iterator assignmentIt = colFlattenedEvents.iterator(); assignmentIt.hasNext(); ) {</span>
<span class="nc" id="L2074">                        Event pEvent = (Event) assignmentIt.next();</span>
<span class="nc" id="L2075">                        activityIdSet.add(pEvent.getActivityID());</span>

<span class="nc bnc" id="L2077" title="All 2 branches missed.">                        for (Iterator childEventIt = pEvent.getChildren().iterator(); childEventIt.hasNext(); ) {</span>
<span class="nc" id="L2078">                            pEvent = (Event) childEventIt.next();</span>
<span class="nc" id="L2079">                            activityIdSet.add(pEvent.getActivityID());</span>
                        }
<span class="nc" id="L2081">                    }</span>
                }
<span class="nc" id="L2083">            }</span>

            // retrieve the ActivityMedia's and ActivityQueue's
<span class="nc" id="L2086">            Map mActivityMedias = mActivity.findMediaForActivities(activityIdSet);</span>
<span class="nc" id="L2087">            Map mActivityQueues = mActivity.findQueueForActivities(activityIdSet);</span>

            // Get required TraceCube for the combined queue
<span class="nc" id="L2090">            short[] types = {Trace.FTE};</span>
<span class="nc" id="L2091">            TraceCube tRequirements = new RequireTraceCube(null, dtStart, dtEnd, types);</span>
<span class="nc bnc" id="L2092" title="All 2 branches missed.">            ID mediaID = pPeriod.getSkillBased() ? null : Media.MEDIA_ID_PHONE;</span>
<span class="nc" id="L2093">            Collection cubeCol = mTimeSeries.getRawCombinedQueuesTimeSeries(tRequirements, campaignID, mediaID, dtStart,</span>
                    dtEnd);
<span class="nc bnc" id="L2095" title="All 2 branches missed.">            if (cubeCol != null) {</span>
<span class="nc bnc" id="L2096" title="All 2 branches missed.">                for (Iterator it = cubeCol.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2097">                    tRequirements = (TraceCube) it.next();</span>
                }
            }

            // Get the data for Project Statistics
<span class="nc" id="L2102">            Collection&lt;ForecastProfileProject&gt; forecastProfileProjects = null;</span>
<span class="nc" id="L2103">            Map projectQueueIdNameMap = null; // a map of project queue DEID to</span>
            // queue name
<span class="nc" id="L2105">            Map projectQueueIdSIDMap = null; // a map of project queue DEID to</span>
            // SID
<span class="nc bnc" id="L2107" title="All 2 branches missed.">            if (hasProjectQueue) {</span>
                // Get the SPQueue ID's.
<span class="nc" id="L2109">                ArrayList spQueueIDs = null;</span>
<span class="nc" id="L2110">                Collection spQueues = getNonCombinedSPQueuesByMediaAndSP(idSP, Media.MEDIA_ID_PROJECT);</span>
<span class="nc bnc" id="L2111" title="All 4 branches missed.">                if (spQueues != null &amp;&amp; !spQueues.isEmpty()) {</span>
<span class="nc" id="L2112">                    spQueueIDs = new ArrayList(spQueues.size());</span>
<span class="nc bnc" id="L2113" title="All 2 branches missed.">                    for (Iterator spqIt = spQueues.iterator(); spqIt.hasNext(); ) {</span>
<span class="nc" id="L2114">                        spQueueIDs.add(((SPQueue) spqIt.next()).getID());</span>
                    }
                }

<span class="nc bnc" id="L2118" title="All 4 branches missed.">                if (spQueueIDs != null &amp;&amp; spQueueIDs.size() &gt; 0) {</span>
                    // Get the ForecastProfileProject's for these SPQueueIDs
<span class="nc" id="L2120">                    forecastProfileProjects = mForcastTimeSeries.getActiveProjects(spQueueIDs);</span>

                    // Get the project queue names
<span class="nc bnc" id="L2123" title="All 4 branches missed.">                    if (forecastProfileProjects != null &amp;&amp; forecastProfileProjects.size() &gt; 0) {</span>
<span class="nc" id="L2124">                        HashSet queueDEIDs = new HashSet();</span>

<span class="nc bnc" id="L2126" title="All 2 branches missed.">                        for (Iterator projectIt = forecastProfileProjects.iterator(); projectIt.hasNext(); ) {</span>
<span class="nc" id="L2127">                            ForecastProfileProject project = (ForecastProfileProject) projectIt.next();</span>
<span class="nc" id="L2128">                            queueDEIDs.add(project.getQueueID());</span>
<span class="nc" id="L2129">                        }</span>

                        // Get a Pair: a map of project queue DEID to queue
                        // name, and a map of project queue DEID to
                        // SID.
<span class="nc" id="L2134">                        Pair queueMapPair = mWorkLoad.getQueueNameSIDMapsByDEIDs(queueDEIDs);</span>
<span class="nc" id="L2135">                        projectQueueIdNameMap = (Map) queueMapPair.getFirst();</span>
<span class="nc" id="L2136">                        projectQueueIdSIDMap = (Map) queueMapPair.getSecond();</span>

                    }
                }
            }

<span class="nc" id="L2142">            LinkedHashMap hEmployeeIDsToWages = new LinkedHashMap(cEmployees.size());</span>
<span class="nc bnc" id="L2143" title="All 2 branches missed.">            for (Iterator it = cEmployees.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2144">                Employee emp = (Employee) it.next();</span>
<span class="nc" id="L2145">                hEmployeeIDsToWages.put(emp.getID(), emp.getWage());</span>
<span class="nc" id="L2146">            }</span>

<span class="nc" id="L2148">            return new FTECalculator(hEmployeeIDsToWages, hPhantomsIdsToEmpTemplateIDs,</span>
                    cEmpTemplates, tRequirements, mActivityMedias, dtStart, dtEnd, pTZ, forecastProfileProjects, projectQueueIdNameMap,
                    projectQueueIdSIDMap, mActivityQueues, idSP, wrIdsToEventsMap, defaultWage);

<span class="nc" id="L2152">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2153">            handleException(e);</span>
<span class="nc" id="L2154">            throw e;</span>
<span class="nc" id="L2155">        } catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L2156">            handleException(e);</span>
<span class="nc" id="L2157">            throw new BbmFinderException(e);</span>
<span class="nc" id="L2158">        } catch (RemoteException e) {</span>
<span class="nc" id="L2159">            handleException(e);</span>
<span class="nc" id="L2160">            throw new BbmFinderException(e);</span>
<span class="nc" id="L2161">        } catch (BbmTimeSeriesException e) {</span>
<span class="nc" id="L2162">            handleException(e);</span>
<span class="nc" id="L2163">            throw new BbmFinderException(e);</span>
<span class="nc" id="L2164">        } catch (JdmoException e) {</span>
<span class="nc" id="L2165">            handleException(e);</span>
<span class="nc" id="L2166">            throw new BbmFinderException(e);</span>
        } finally {
<span class="nc" id="L2168">            methodFinish();</span>
        }
    }

    /**
     * Returns a collection of SchedulingPeriods associated with the campaigns
     *
     * @param campaigns
     * @return schedulingPeriods
     * @throws BbmFinderException
     */
    public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(Collection&lt;Campaign&gt; campaigns) throws BbmFinderException {
<span class="fc" id="L2180">        methodStart(&quot;getSchedulingPeriods&quot;);</span>
<span class="fc" id="L2181">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="fc" id="L2183">            return dao.getSchedulingPeriods(campaigns);</span>
<span class="nc" id="L2184">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2185">            handleException(e, false);</span>
<span class="nc" id="L2186">            throw e;</span>
        } finally {
<span class="pc" id="L2188">            dao.cleanUp();</span>
<span class="pc" id="L2189">            methodFinish();</span>
        }
    }

    public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByCampaignID(ID campaignSID) throws BbmFinderException {
<span class="nc" id="L2194">        methodStart(&quot;getSchedulingPeriodsByCampaignID&quot;);</span>
<span class="nc" id="L2195">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="nc" id="L2197">            return dao.getSchedulingPeriods(campaignSID);</span>
<span class="nc" id="L2198">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2199">            handleException(e, false);</span>
<span class="nc" id="L2200">            throw e;</span>
        } finally {
<span class="nc" id="L2202">            dao.cleanUp();</span>
<span class="nc" id="L2203">            methodFinish();</span>
        }
    }

    public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByCampaignIDs(Collection&lt;ID&gt; campaignIDs, Date minDate,
                                                                          Date maxDate) throws BbmFinderException {
<span class="nc" id="L2209">        methodStart(&quot;getSchedulingPeriodsByCampaignIDs&quot;);</span>
<span class="nc" id="L2210">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="nc" id="L2212">            return dao.getSchedulingPeriodsByCampaignIDs(campaignIDs, minDate, maxDate);</span>
<span class="nc" id="L2213">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2214">            handleException(e, false);</span>
<span class="nc" id="L2215">            throw e;</span>
        } finally {
<span class="nc" id="L2217">            dao.cleanUp();</span>
<span class="nc" id="L2218">            methodFinish();</span>
        }
    }

    public Collection&lt;CampaignHOO&gt; getCampaignHOOsByCampaignIDs(Collection&lt;ID&gt; campaignIDs, Date minDate, Date maxDate)
            throws BbmFinderException {
<span class="nc" id="L2224">        methodStart(&quot;getCampaignHOOs&quot;);</span>
<span class="nc" id="L2225">        CampaignHOODAO dao = new CampaignHOODAO();</span>
        try {
<span class="nc" id="L2227">            return dao.getCampaignHOOsByCampaignIDs(campaignIDs, minDate, maxDate);</span>
<span class="nc" id="L2228">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2229">            handleException(e, false);</span>
<span class="nc" id="L2230">            throw e;</span>
        } finally {
<span class="nc" id="L2232">            dao.cleanUp();</span>
<span class="nc" id="L2233">            methodFinish();</span>
        }
    }

    /**
     * Returns shrinkage and modeling factor data for the specified scheduling
     * period. If no such data exist, then entries are created for hourly data,
     * initialized to all zeros.
     *
     * @param spID
     * @return
     * @throws BbmCreateException
     * @throws BbmFinderException
     */
    public Collection&lt;SPShrinkage&gt; getOrCreateSPShrinkageBySPID(ID spID) throws BbmCreateException, BbmFinderException {
<span class="fc" id="L2248">        methodStart(&quot;getOrCreateSPShrinkageBySPID&quot;, spID);</span>
<span class="fc" id="L2249">        SPShrinkageDAO dao = new SPShrinkageDAO();</span>
        try {
<span class="fc" id="L2251">            String loginUserName = m_sessionContext.getCallerPrincipal().getName();</span>
<span class="fc" id="L2252">            return dao.getOrCreateShrinkageBySPID(spID, loginUserName);</span>
<span class="nc" id="L2253">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2254">            handleException(e, false);</span>
<span class="nc" id="L2255">            throw e;</span>
<span class="nc" id="L2256">        } catch (BbmCreateException bce) {</span>
<span class="nc" id="L2257">            handleException(bce);</span>
<span class="nc" id="L2258">            throw bce;</span>
        } finally {
<span class="pc" id="L2260">            dao.cleanUp();</span>
<span class="pc" id="L2261">            methodFinish();</span>
        }
    }

    /**
     * Updates the database with the specified collection of SPShrinkage
     * records. It is assumed that each record represents an already-created row
     * in the database.
     * &lt;p&gt;
     * TODO: Once SPShrinkage is updated, FTE Requirements should be calculated
     * for the affected SPQueues. This needs to occur in a separate transaction
     * since FTE reqs are calc'd asynchronously via a JMS queue. Right now, the
     * call to calculate FTE Requirements after shrinkage is done manually in
     * the client but this should be moved to this method.
     *
     * @param spShrinkageCol
     * @throws BbmCreateException
     * @throws BbmUpdateException
     * @throws MultiUserException
     */
    public void updateSPShrinkage(Collection&lt;SPShrinkage&gt; spShrinkageCol) throws BbmUpdateException, MultiUserException {
<span class="fc" id="L2282">        methodStart(&quot;updateSPShrinkage&quot;, spShrinkageCol);</span>
<span class="fc" id="L2283">        SPShrinkageDAO dao = new SPShrinkageDAO();</span>
<span class="fc" id="L2284">        SPQueueDAO spQueueDAO = new SPQueueDAO();</span>
        try {
<span class="fc" id="L2286">            dao.updateObjects(spShrinkageCol);</span>
<span class="nc" id="L2287">        } catch (MultiUserException mue) {</span>
<span class="nc" id="L2288">            handleException(mue);</span>
<span class="nc" id="L2289">            throw new BbmUpdateException(mue);</span>
<span class="nc" id="L2290">        } catch (BbmUpdateException bue) {</span>
<span class="nc" id="L2291">            handleException(bue);</span>
<span class="nc" id="L2292">            throw bue;</span>
        } finally {
<span class="pc" id="L2294">            dao.cleanUp();</span>
<span class="pc" id="L2295">            spQueueDAO.cleanUp();</span>
<span class="pc" id="L2296">            methodFinish();</span>
<span class="fc" id="L2297">        }</span>
<span class="fc" id="L2298">    }</span>

    /**
     * Returns all of the SPQueues associated to the Scheduling Periods in the
     * collection of SPShrinkage value objects
     *
     * @param spShrinkageCol
     * @return
     * @throws BbmFinderException
     */
    public Collection&lt;SPQueue&gt; getSPQueuesFromSPShrinkage(Collection&lt;SPShrinkage&gt; spShrinkageCol) throws BbmFinderException {
<span class="fc" id="L2309">        methodStart(&quot;getSPQueueIDsFromSPShrinkage&quot;, spShrinkageCol);</span>
<span class="fc" id="L2310">        SPQueueDAO spQueueDAO = new SPQueueDAO();</span>
        try {
            // First retrieve the Scheduling Period IDs from the SPShrinkage
            // objects
<span class="fc" id="L2314">            Collection&lt;ID&gt; spIDs = new HashSet&lt;ID&gt;();</span>
<span class="fc bfc" id="L2315" title="All 2 branches covered.">            for (SPShrinkage spShrinkage : spShrinkageCol) {</span>
<span class="fc" id="L2316">                spIDs.add(spShrinkage.getSPID());</span>
<span class="fc" id="L2317">            }</span>
            // Then return the SPQueues belonging to those Scheduling periods.
<span class="fc" id="L2319">            return new HashSet&lt;SPQueue&gt;(spQueueDAO.getSPQueuesBySPIDs(spIDs));</span>
        } finally {
<span class="pc" id="L2321">            spQueueDAO.cleanUp();</span>
<span class="pc" id="L2322">            methodFinish();</span>
        }
    }

    public SchedulingState getSchedulingState(ID spSID, String modeChar) throws BbmFinderException {
<span class="fc" id="L2327">        methodStart(&quot;getSchedulingState&quot;, spSID);</span>
<span class="fc" id="L2328">        SchedulingStateDAO dao = new SchedulingStateDAO();</span>
        try {
<span class="fc" id="L2330">            String mode = &quot; and MODE='&quot; + modeChar + &quot;'&quot;;</span>
<span class="fc" id="L2331">            Collection col = dao.getObjects(&quot;SPID=&quot; + spSID + mode);</span>
<span class="pc bpc" id="L2332" title="1 of 4 branches missed.">            if (col != null &amp;&amp; !col.isEmpty()) {</span>
<span class="fc" id="L2333">                return (SchedulingState) col.iterator().next();</span>
            }
<span class="fc" id="L2335">            return null; // should never happen!</span>
<span class="nc" id="L2336">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2337">            handleException(e, false);</span>
<span class="nc" id="L2338">            throw e;</span>
        } finally {
<span class="pc" id="L2340">            dao.cleanUp();</span>
<span class="pc" id="L2341">            methodFinish();</span>
        }
    }

    public Map&lt;ID, Date&gt; getAllSchedulingStateLastUpdatedTimes()
            throws BbmFinderException {
<span class="fc" id="L2347">        methodStart(&quot;getAllSchedulingStateLastUpdatedTimes&quot;);</span>
<span class="fc" id="L2348">        SchedulingStateDAO dao = new SchedulingStateDAO();</span>

        try {
<span class="fc" id="L2351">            return dao.getTimeLastUpdatedBySPs();</span>
        } finally {
<span class="pc" id="L2353">            dao.cleanUp();</span>
<span class="pc" id="L2354">            methodFinish();</span>
        }
    }

    public Date getSchedulingStateLastUpdatedTime(ID spId, String mode)
            throws BbmFinderException {
<span class="fc" id="L2360">        methodStart(&quot;getSchedulingStateLastUpdatedTime&quot;);</span>
<span class="fc" id="L2361">        SchedulingStateDAO dao = new SchedulingStateDAO();</span>

        try {
<span class="fc" id="L2364">            return dao.getTimeLastUpdated(spId, mode);</span>
        } finally {
<span class="pc" id="L2366">            dao.cleanUp();</span>
<span class="pc" id="L2367">            methodFinish();</span>
        }
    }

    public void clearSchedulingState(ID spSID, String modeChar) throws BbmRemoveException {
<span class="fc" id="L2372">        methodStart(&quot;clearSchedulingState&quot;, spSID);</span>
<span class="fc" id="L2373">        SchedulingStateDAO dao = new SchedulingStateDAO();</span>
        try {
<span class="fc" id="L2375">            String mode = &quot;and MODE='&quot; + modeChar + &quot;'&quot;;</span>
<span class="fc" id="L2376">            dao.deleteObjects(&quot;select id from SPSCHEDSTATE where spid =&quot; + spSID.toString() + mode);</span>
<span class="nc" id="L2377">        } catch (BbmRemoveException e) {</span>
<span class="nc" id="L2378">            handleException(e, false);</span>
<span class="nc" id="L2379">            throw e;</span>
        } finally {
<span class="pc" id="L2381">            dao.cleanUp();</span>
<span class="pc" id="L2382">            methodFinish();</span>
<span class="fc" id="L2383">        }</span>
<span class="fc" id="L2384">    }</span>

    public void clearSchedulingStateWarnings(Collection ids) throws BbmFinderException {
<span class="nc" id="L2387">        methodStart(&quot;clearSchedulingStateWarnings&quot;, ids);</span>
<span class="nc" id="L2388">        SchedulingStateDAO dao = new SchedulingStateDAO();</span>
        try {
<span class="nc" id="L2390">            dao.deleteWarnings(ids);</span>
<span class="nc" id="L2391">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2392">            handleException(e, false);</span>
<span class="nc" id="L2393">            throw e;</span>
        } finally {
<span class="nc" id="L2395">            dao.cleanUp();</span>
<span class="nc" id="L2396">            methodFinish();</span>
<span class="nc" id="L2397">        }</span>
<span class="nc" id="L2398">    }</span>

    // cancel - 1; stop and save - 1, continue - 2
    public void makeSchedulingRequest(SchedulingRequest request) throws BbmCreateException {
<span class="nc" id="L2402">        methodStart(&quot;makeSchedulingRequest&quot;, request);</span>
<span class="nc" id="L2403">        Jdmo dmo = new Jdmo();</span>
        try {
<span class="nc" id="L2405">            dmo.execute(&quot;insert into SPSCHEDREQUEST (REQUEST, SPID, MODE) values (&quot; + request.getRequest() + &quot;, &quot;</span>
<span class="nc" id="L2406">                    + request.getSPSID() + &quot;, '&quot; + request.getMode() + &quot;')&quot;);</span>
<span class="nc" id="L2407">        } catch (JdmoException e) {</span>
<span class="nc" id="L2408">            handleException(e, false);</span>
<span class="nc" id="L2409">            throw new BbmCreateException(e);</span>
        } finally {
<span class="nc" id="L2411">            dmo.cleanUp();</span>
<span class="nc" id="L2412">            methodFinish();</span>
<span class="nc" id="L2413">        }</span>
<span class="nc" id="L2414">    }</span>

    /**
     * Clears any scheduling request for the given SPID and mode. Only use if
     * you have reason to believe the FS client has died without removing the
     * request entry.
     */
    public void clearSchedulingRequest(SchedulingRequest request) throws BbmRemoveException {
<span class="fc" id="L2422">        methodStart(&quot;makeSchedulingRequest&quot;, request);</span>
<span class="fc" id="L2423">        Jdmo dmo = new Jdmo();</span>
        try {
<span class="fc" id="L2425">            dmo.execute(&quot;delete from SPSCHEDREQUEST where SPID = &quot; + request.getSPSID() + &quot; and MODE = '&quot;</span>
<span class="fc" id="L2426">                    + request.getMode() + &quot;'&quot;);</span>
<span class="nc" id="L2427">        } catch (JdmoException e) {</span>
<span class="nc" id="L2428">            handleException(e, false);</span>
<span class="nc" id="L2429">            throw new BbmRemoveException(e);</span>
        } finally {
<span class="pc" id="L2431">            dmo.cleanUp();</span>
<span class="pc" id="L2432">            methodFinish();</span>
<span class="fc" id="L2433">        }</span>
<span class="fc" id="L2434">    }</span>

    public Collection getSPScheduleSession(ID spSID) throws BbmFinderException, RemoteException {
<span class="fc" id="L2437">        methodStart(&quot;getSPScheduleSession&quot;, spSID);</span>
<span class="fc" id="L2438">        Jdmo dmo = new Jdmo();</span>
        try {
<span class="fc" id="L2440">            SchedulingPeriod sp = this.getSchedulingPeriodByID(spSID);</span>
<span class="fc" id="L2441">            Date start = TimeZoneUtil.previousWeek(sp.getStartTime());</span>
<span class="fc" id="L2442">            Date end = TimeZoneUtil.addWeek(sp.getEndTime());</span>
<span class="fc" id="L2443">            Collection sps = this.getSchedulingPeriods(sp.getCampaignID(), start, end);</span>
<span class="fc" id="L2444">            ArrayList sessions = new ArrayList(3);</span>
<span class="pc bpc" id="L2445" title="2 of 4 branches missed.">            if (sps != null &amp;&amp; !sps.isEmpty()) {</span>
<span class="fc" id="L2446">                HashMap spIDMap = ValueObjectUtil.getIDObjectMap(sps);</span>
<span class="fc" id="L2447">                StringBuilder sb = new StringBuilder(200);</span>
<span class="fc" id="L2448">                sb.append(&quot;select username, sp.sid from bpsession, sp where sp.id = bpsession.spid and useraction ='scheduling' and SP.SID in &quot;);</span>
<span class="fc" id="L2449">                sb.append(dmo.createInClause(spIDMap.keySet()));</span>
<span class="fc" id="L2450">                JdmoRowset rs = dmo.createRowset(sb.toString());</span>
                SchedulingSession session;
                ID spID;
<span class="fc bfc" id="L2453" title="All 2 branches covered.">                while (rs.next()) {</span>
<span class="fc" id="L2454">                    session = new SchedulingSession();</span>
<span class="fc" id="L2455">                    session.setUserName(rs.getString(1));</span>
<span class="fc" id="L2456">                    spID = rs.getID(2);</span>
<span class="fc" id="L2457">                    session.setSchedulingPeriod((SchedulingPeriod) spIDMap.get(spID));</span>
<span class="fc" id="L2458">                    sessions.add(session);</span>
                }
            }
<span class="fc" id="L2461">            return sessions;</span>
<span class="nc" id="L2462">        } catch (JdmoException e) {</span>
<span class="nc" id="L2463">            handleException(e, false);</span>
<span class="nc" id="L2464">            throw new BbmFinderException(e);</span>
        } finally {
<span class="pc" id="L2466">            dmo.cleanUp();</span>
<span class="pc" id="L2467">            methodFinish();</span>
        }
    }

    /**
     * Removes any scheduling BPSESSION entry for the specified SPID. Only use
     * if you have reason to believe the FS client has died without removing the
     * session entry.
     */
    public void clearSPScheduleSession(ID spSID) throws BbmFinderException, BbmRemoveException, RemoteException {
<span class="fc" id="L2477">        methodStart(&quot;clearSPScheduleSession&quot;, spSID);</span>
<span class="fc" id="L2478">        Jdmo dmo = new Jdmo();</span>
        try {
<span class="fc" id="L2480">            SchedulingPeriod sp = this.getSchedulingPeriodByID(spSID);</span>
<span class="pc bpc" id="L2481" title="1 of 2 branches missed.">            if (sp != null) {</span>
                // Not good that we have to use DEID
<span class="fc" id="L2483">                dmo.execute(&quot;delete from bpsession where useraction = 'scheduling' and SPID = '&quot; + sp.getDEID() + &quot;'&quot;);</span>
            }
<span class="nc" id="L2485">        } catch (JdmoException e) {</span>
<span class="nc" id="L2486">            handleException(e, false);</span>
<span class="nc" id="L2487">            throw new BbmRemoveException(e);</span>
        } finally {
<span class="pc" id="L2489">            dmo.cleanUp();</span>
<span class="pc" id="L2490">            methodFinish();</span>
<span class="fc" id="L2491">        }</span>
<span class="fc" id="L2492">    }</span>

    public Collection&lt;SPQueue&gt; getSPQueuesBySPID(ID SPID) throws BbmObjectNotFoundException, BbmFinderException {
<span class="fc" id="L2495">        methodStart(&quot;getSPQueuesBySPID&quot;);</span>
<span class="fc" id="L2496">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="fc" id="L2498">            return dao.getSPQueuesBySPID(SPID);</span>
<span class="nc" id="L2499">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2500">            handleException(e, false);</span>
<span class="nc" id="L2501">            throw e;</span>
        } finally {
<span class="pc" id="L2503">            dao.cleanUp();</span>
<span class="pc" id="L2504">            methodFinish();</span>
        }
    }

    /**
     * Returns the TimeZone associated with the specified SPQueue ID.
     *
     * @param spQueueID
     * @return
     * @throws BbmObjectNotFoundException
     * @throws BbmFinderException
     */
    private TimeZone getTimeZoneBySPQueueID(ID spQueueID) throws BbmFinderException {
<span class="fc" id="L2517">        SPQueue spqueue = getSPQueue(spQueueID);</span>
<span class="fc" id="L2518">        SchedulingPeriod sp = getSP(spqueue.getSpID());</span>
<span class="fc" id="L2519">        return getTimeZoneByCampaignID(sp.getCampaignID());</span>
    }

    public Collection&lt;ID&gt; getLinkedOrgsforSP(ID schedID) throws BbmFinderException {
<span class="fc" id="L2523">        methodStart(&quot;getLinkedOrgsforSP&quot;, schedID);</span>
<span class="fc" id="L2524">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="fc" id="L2526">            return (dao.getLinkedOrgsforSP(schedID));</span>
<span class="nc" id="L2527">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2528">            handleException(e, false);</span>
<span class="nc" id="L2529">            throw e;</span>
        } finally {
<span class="pc" id="L2531">            dao.cleanUp();</span>
<span class="pc" id="L2532">            methodFinish();</span>
        }
    }

    public TimeZone getTimeZoneByCampaignID(ID campaignID) throws BbmFinderException {
<span class="fc" id="L2537">        methodStart(&quot;getTimeZoneByCampaignID&quot;, campaignID);</span>
<span class="fc" id="L2538">        CampaignDAO dao = new CampaignDAO();</span>
        try {
<span class="fc" id="L2540">            return (dao.getTimeZoneByCampaignID(campaignID));</span>
<span class="nc" id="L2541">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2542">            handleException(e, false);</span>
<span class="nc" id="L2543">            throw e;</span>
        } finally {
<span class="pc" id="L2545">            dao.cleanUp();</span>
<span class="pc" id="L2546">            methodFinish();</span>
        }
    }

    /**
     * Returns a map from child SPQueue ID to child campaign time zone for all
     * children of the specified parent SPQueue ID.
     *
     * @param parentSPQueueID
     * @return
     * @throws BbmFinderException
     * @throws RemoteException
     */
    public Map&lt;ID, TimeZone&gt; getChildSPQueueTimeZonesByParentSPQueueID(ID parentSPQueueID) throws BbmFinderException,
            RemoteException {

<span class="fc" id="L2562">        Map&lt;ID, TimeZone&gt; timeZoneMap = new HashMap&lt;ID, TimeZone&gt;();</span>
<span class="fc" id="L2563">        Collection&lt;SPQueue&gt; childSPQueues = getChildSpQueuesOfDistributedSpQueue(parentSPQueueID);</span>
<span class="fc bfc" id="L2564" title="All 2 branches covered.">        for (SPQueue childSPQueue : childSPQueues) {</span>
<span class="fc" id="L2565">            timeZoneMap.put(childSPQueue.getID(), getTimeZoneBySPQueueID(childSPQueue.getID()));</span>
<span class="fc" id="L2566">        }</span>
<span class="fc" id="L2567">        return timeZoneMap;</span>
    }

    /**
     * Clones the given Scheduling Period.  The cloning operation is performed in a series of steps:
     * - The CLONESP stored procedure is executed for the target SP.  This procedure is quite extensive and is
     * responsible for copying a large set of data including but not limited to: absolute/manually modified forecast
     * profiles, service goals, spqueues, shrinkage, and hours of operation.
     * - Employee min/max hours, skills, and work pattern assignments are copied to the new scheduling period (if
     * this option was checked)
     * - If this SP is part of a distributed campaign, then the above steps are performed again for each additional
     * sub/child campaign
     * - If the source SP contained a forecast profile with relative history weeks, then the forecasts and FTE requirements
     * will be calculated for the new SP based on the relative dates for the new SP.  This step is also performed for the
     * sub/child SPs in the case of a distributed campaign.
     *
     * @param newSP           - Essentially an empty SP, but it needs to have the time interval set to match the date range of the
     *                        target SP.
     * @param spHOOs          - The hours of the operation of the source SP, which will be cloned to the new SP.
     * @param copyFlags       - A set of boolean arguments to indicate whether or not certain types of data are to be cloned.
     * @param bIgnoreWarnings - If false, will throw a BbmConflictException if any conflicts are detected before the
     *                        stored procedure is executed (see SchedulingPeriodDAO.CloneSP method)
     * @param localeCtx       - Used to create a localized description for the newly cloned SP, e.g.
     *                        &quot;This scheduling period is cloned from 01/04/2016To02/03/2016.&quot;
     * @return - The ID of the newly cloned SP.
     */
    public ID cloneSchedulingPeriod(SchedulingPeriod newSP, Collection&lt;CampaignHOO&gt; spHOOs, CloneSPOptions copyFlags,
                                    boolean bIgnoreWarnings, LocaleContext localeCtx) throws JdmoException, BbmException, RemoteException {

<span class="fc" id="L2596">        ClonedSchedulingPeriodResult clonedSps =</span>
<span class="fc" id="L2597">                campaignManager.cloneBaseDataForSchedulingPeriod(newSP, spHOOs, copyFlags, bIgnoreWarnings, localeCtx);</span>

<span class="fc" id="L2599">        cloneForecastDataForSchedulingPeriods(clonedSps);</span>

<span class="fc" id="L2601">        return clonedSps.getClonedSchedulingPeriod().getID();</span>
    }

    /**
     * Clones the forecast data for the newly created scheduling periods.  This is mainly to support forecasts
     * with relative profiles, which are not supported by the CLONESP stored procedure and need to be handled
     * by the EJB due to their complexity.
     *
     * @param clonedSps - A ClonedSchedulingPeriodResult containing the newly cloned SP as well as its children
     *                  if it belongs to a distributed campaign.
     */
    private void cloneForecastDataForSchedulingPeriods(ClonedSchedulingPeriodResult clonedSps)
            throws JdmoException, BbmException, RemoteException {

        //We currently only clone the forecast data for the parent scheduling period in a distributed campaign.
        //We don't currently clone the Forecast Allocation Time series, and because that needs to be set manually
        //it doesn't make sense to clone the forecast data for the child SPs.
<span class="fc" id="L2618">        forecastTimeSeriesManager.recalculateForecastDataForClonedSp(clonedSps.getClonedSchedulingPeriod());</span>
<span class="fc" id="L2619">    }</span>

    /**
     * This method is NOT intended to be executed by client code.  If you are a client, you should use
     * CampaignManager.cloneSchedulingPeriod instead.
     * &lt;p&gt;
     * This method has a &quot;RequiresNew&quot; attribute set to ensure that it runs in its own transaction.  This is done
     * so that post clone operations can be performed asynchronously but still utilize the persisted objects created
     * during the clone operation.
     *
     * @param newSP           - Essentially an empty SP, but it needs to have the time interval set to match the date range of the
     *                        target SP.
     * @param spHOOs          - The hours of the operation of the source SP, which will be cloned to the new SP.
     * @param copyFlags       - A set of boolean arguments to indicate whether or not certain types of data are to be cloned.
     * @param bIgnoreWarnings - If false, will throw a BbmConflictException if any conflicts are detected before the
     *                        stored procedure is executed (see SchedulingPeriodDAO.CloneSP method)
     * @param localeCtx       - Used to create a localized description for the newly cloned SP, e.g.
     *                        &quot;This scheduling period is cloned from 01/04/2016To02/03/2016.&quot;
     * @return A ClonedSchedulingPeriodResult containing the newly cloned SP and Child SP (for distributed) objects.
     */
    public ClonedSchedulingPeriodResult cloneBaseDataForSchedulingPeriod(SchedulingPeriod newSP,
                                                                         Collection&lt;CampaignHOO&gt; spHOOs, CloneSPOptions copyFlags, boolean bIgnoreWarnings, LocaleContext localeCtx)
            throws JdmoException, BbmException, RemoteException {

<span class="fc" id="L2643">        methodStart(&quot;cloneSchedulingPeriod&quot;, newSP, spHOOs, copyFlags, bIgnoreWarnings, localeCtx);</span>
        ID idTargetSP;
<span class="fc" id="L2645">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
<span class="fc" id="L2646">        CampaignDAO camDao = new CampaignDAO();</span>
<span class="fc" id="L2647">        CampaignHOODAO camHOODao = new CampaignHOODAO();</span>
<span class="fc" id="L2648">        SchedulingPeriod sp = null;</span>
<span class="fc" id="L2649">        List&lt;SchedulingPeriod&gt; childSps = new ArrayList&lt;SchedulingPeriod&gt;();</span>
        try {
<span class="fc" id="L2651">            ID campaignID = newSP.getCampaignID();</span>
<span class="fc" id="L2652">            TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(campaignID);</span>
<span class="fc" id="L2653">            boolean bCopyAssignments = copyFlags.isCopyAssignments();</span>
<span class="fc" id="L2654">            idTargetSP = dao.CloneSP(tz, newSP, spHOOs, copyFlags, bIgnoreWarnings);</span>

<span class="fc" id="L2656">            Campaign campaign = camDao.getCampaignByID(newSP.getCampaignID(), false);</span>
<span class="fc" id="L2657">            String strSPname = copyShiftAssignmentsAndEffectiveDates(dao, campaign, newSP, spHOOs, bCopyAssignments, tz,</span>
                    idTargetSP);

<span class="fc" id="L2660">            sp = dao.getSchedulingPeriodByID(idTargetSP);</span>

            // Set description: This scheduling period is cloned from &lt;date&gt; to &lt;date&gt;
<span class="fc" id="L2663">            Localizer localizer = LocalizationManager.getInstance().getLocalizer(localeCtx);</span>
<span class="fc" id="L2664">            String messageTemplate = localizer.i18n(BbmEjbBundleKey.BUNDLE, BbmEjbBundleKey.SCHEDULINGPERIOD_CLONED_DESC);</span>
<span class="fc" id="L2665">            Object[] args = new Object[]{strSPname};</span>
<span class="fc" id="L2666">            String descStr = MessageFormat.format(messageTemplate, args);</span>
<span class="fc" id="L2667">            sp.setDescription(descStr);</span>

<span class="fc" id="L2669">            dao.updateSchedulingPeriods(Collections.singleton(sp));</span>

<span class="fc" id="L2671">            Collection&lt;ID&gt; subIDs = camDao.getSubCampaignIDs(campaignID);</span>
<span class="fc bfc" id="L2672" title="All 2 branches covered.">            for (ID subID : subIDs) {</span>
<span class="fc" id="L2673">                SchedulingPeriod subSP = new SchedulingPeriod();</span>
<span class="fc" id="L2674">                subSP.setCampaignID(subID);</span>
<span class="fc" id="L2675">                subSP.setName(sp.getName());</span>
<span class="fc" id="L2676">                subSP.setStartTimeLocal(newSP.getStartTimeLocal());</span>
<span class="fc" id="L2677">                subSP.setEndTimeLocal(newSP.getEndTimeLocal());</span>
<span class="fc" id="L2678">                childSps.add(subSP);</span>

<span class="fc" id="L2680">                TimeZone subtz = CampaignDAO.getTimeZoneByCampaignID(subID);</span>

<span class="fc" id="L2682">                Collection&lt;CampaignHOO&gt; subSPHOOs = new ArrayList&lt;CampaignHOO&gt;();</span>
<span class="fc bfc" id="L2683" title="All 2 branches covered.">                for (CampaignHOO spHOO : spHOOs) {</span>
<span class="fc" id="L2684">                    LocalDate ld1 = new LocalDate(spHOO.getStartTime(), tz);</span>
<span class="fc" id="L2685">                    Date d1 = ld1.getTime(tz);</span>
<span class="fc" id="L2686">                    Collection&lt;CampaignHOO&gt; subHOOs = camHOODao.getCampaignHOOAssignments(subID, spHOO.getStartTime(),</span>
<span class="fc" id="L2687">                            spHOO.getEndTime());</span>
<span class="fc bfc" id="L2688" title="All 2 branches covered.">                    for (CampaignHOO spHOO2 : subHOOs) {</span>
<span class="fc" id="L2689">                        LocalDate ld2 = new LocalDate(spHOO2.getStartTime(), subtz);</span>
<span class="fc" id="L2690">                        Date d2 = ld2.getTime(subtz);</span>

<span class="pc bpc" id="L2692" title="1 of 2 branches missed.">                        if (d1.equals(d2)) {</span>
<span class="fc" id="L2693">                            subSPHOOs.add(spHOO2);</span>
                        }
<span class="fc" id="L2695">                    }</span>
<span class="fc" id="L2696">                }</span>
                // new construct the hoos
<span class="pc bpc" id="L2698" title="1 of 2 branches missed.">                if (subSPHOOs.size() == 0) {</span>
<span class="nc" id="L2699">                    continue;</span>
                }

<span class="fc" id="L2702">                ID targetSubSPID = dao.CloneSP(subtz, subSP, subSPHOOs, copyFlags, bIgnoreWarnings);</span>

                SchedulingPeriod subSP2;
<span class="fc" id="L2705">                String strSubSPname = copyShiftAssignmentsAndEffectiveDates(dao, campaign, subSP, subSPHOOs,</span>
                        bCopyAssignments, tz, targetSubSPID);

<span class="fc" id="L2708">                subSP2 = dao.getSchedulingPeriodByID(targetSubSPID);</span>

<span class="fc" id="L2710">                Object[] argsSub = new Object[]{strSubSPname};</span>
<span class="fc" id="L2711">                String descSubStr = MessageFormat.format(messageTemplate, argsSub);</span>
<span class="fc" id="L2712">                subSP2.setDescription(descSubStr);</span>
<span class="fc" id="L2713">                subSP2.setParentSPID(sp.getDEID());</span>
<span class="fc" id="L2714">                dao.updateSchedulingPeriods(Collections.singleton(subSP2));</span>
<span class="fc" id="L2715">            }</span>
<span class="nc" id="L2716">        } catch (JdmoException e) {</span>
<span class="nc" id="L2717">            handleException(e);</span>
<span class="nc" id="L2718">            throw e;</span>
<span class="nc" id="L2719">        } catch (MultiUserException e) {</span>
            // Don't need to re-throw exception because this is for
            // updating SP Description after clone SP
<span class="nc" id="L2722">            handleException(e);</span>
<span class="nc" id="L2723">        } catch (BbmUpdateException e) {</span>
            // Don't need to re-throw exception because this is for
            // updating SP Description after clone SP
<span class="nc" id="L2726">            handleException(e);</span>
<span class="nc" id="L2727">        } catch (RemoteException e) {</span>
<span class="nc" id="L2728">            handleException(e);</span>
<span class="nc" id="L2729">            throw e;</span>
<span class="nc" id="L2730">        } catch (BbmException e) {</span>
<span class="nc" id="L2731">            handleException(e);</span>
<span class="nc" id="L2732">            throw e;</span>
        } finally {
<span class="pc" id="L2734">            dao.cleanUp();</span>
<span class="pc" id="L2735">            camDao.cleanUp();</span>
<span class="pc" id="L2736">            camHOODao.cleanUp();</span>
<span class="pc" id="L2737">            methodFinish();</span>
<span class="pc" id="L2738">        }</span>
<span class="fc" id="L2739">        return new ClonedSchedulingPeriodResult(sp, childSps);</span>
    }

    private String copyShiftAssignmentsAndEffectiveDates(SchedulingPeriodDAO dao, Campaign campaign, SchedulingPeriod newSP,
                                                         Collection&lt;CampaignHOO&gt; spHOOs, boolean bCopyAssignments, TimeZone tz, ID idTargetSP)
            throws BbmFinderException, RemoteException, BbmScheduleConflictException {

<span class="fc" id="L2746">        boolean bClearDestinationSP = false;</span>
<span class="fc" id="L2747">        LocalDate startLD = new LocalDate(newSP.getEndTimeLocal());</span>
<span class="fc" id="L2748">        LocalDate endLD = new LocalDate(newSP.getEndTimeLocal());</span>
        Date targetWeekStart, sourceWeekStart;
        ID idSourceSP;
<span class="fc" id="L2751">        ArrayList&lt;CampaignHOO&gt; CampHOOAL = new ArrayList&lt;CampaignHOO&gt;(spHOOs);</span>
<span class="fc" id="L2752">        ListIterator&lt;CampaignHOO&gt; litr = CampHOOAL.listIterator(CampHOOAL.size());</span>
<span class="fc" id="L2753">        ArrayList&lt;ID&gt; spIds = new ArrayList();</span>
<span class="fc" id="L2754">        StringBuilder strSPname = new StringBuilder();</span>
        SchedulingPeriod sp;

<span class="fc" id="L2757">        Date startGMTDt = newSP.getStartTime();</span>
<span class="fc" id="L2758">        Calendar currentDate = Calendar.getInstance(tz);</span>
<span class="fc" id="L2759">        currentDate.setTime(newSP.getEndTime());</span>

<span class="fc bfc" id="L2761" title="All 2 branches covered.">        while (litr.hasPrevious()) {</span>
<span class="fc" id="L2762">            CampaignHOO spHOO = litr.previous();</span>
<span class="fc" id="L2763">            endLD = new LocalDate(startLD);</span>

<span class="pc bpc" id="L2765" title="1 of 2 branches missed.">            if (campaign.isMonthly()) {</span>
                // some weeks of monthly SPs may have less than 7 days
<span class="nc" id="L2767">                int numOfDaysToStartWeek = MonthlySPUtil.getNumOfDaysToWeekStartDate(tz, currentDate.getTime(), MonthlySPUtil.getWeekStartDay(campaign.getWeekStart()), startGMTDt);</span>
<span class="nc" id="L2768">                currentDate.add(Calendar.DATE, -numOfDaysToStartWeek);</span>
<span class="nc" id="L2769">                startLD.add(Calendar.DATE, -numOfDaysToStartWeek);</span>
<span class="nc" id="L2770">            } else {</span>
<span class="fc" id="L2771">                startLD.add(Calendar.DATE, -7);</span>
            }

<span class="fc" id="L2774">            targetWeekStart = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(startLD, tz);</span>
<span class="fc" id="L2775">            sourceWeekStart = spHOO.getStartTime();</span>
<span class="fc" id="L2776">            idSourceSP = spHOO.getSPID();</span>

<span class="fc bfc" id="L2778" title="All 2 branches covered.">            if (spIds.isEmpty()) {</span>
<span class="fc" id="L2779">                spIds.add(idSourceSP);</span>
<span class="fc" id="L2780">                sp = dao.getSchedulingPeriodByID(idSourceSP);</span>
<span class="fc" id="L2781">                strSPname.append(sp.getName());</span>
<span class="pc bpc" id="L2782" title="1 of 2 branches missed.">            } else if (!spIds.contains(idSourceSP)) {</span>
                // check for duplicate sp id
<span class="nc" id="L2784">                spIds.add(idSourceSP);</span>
<span class="nc" id="L2785">                sp = dao.getSchedulingPeriodByID(idSourceSP);</span>
<span class="nc" id="L2786">                strSPname.append(&quot;, &quot;).append(sp.getName());</span>
            }

<span class="fc" id="L2789">            m_scheduleAccessManager.copyShiftAssignments(idSourceSP, sourceWeekStart, idTargetSP, targetWeekStart, bClearDestinationSP);</span>
<span class="fc bfc" id="L2790" title="All 2 branches covered.">            if (bCopyAssignments) {</span>
<span class="fc" id="L2791">                m_scheduleAccessManager.copyEffectiveDates(idSourceSP, sourceWeekStart, idTargetSP, targetWeekStart);</span>
            }
<span class="fc" id="L2793">            endLD = startLD;</span>
<span class="fc" id="L2794">        }</span>

<span class="fc" id="L2796">        return strSPname.toString();</span>
    }

    /**
     * &lt;B&gt;createSPEmpTemplate&lt;/B&gt;
     * &lt;p&gt;
     * creates given SPEmpTemplate in db, and sets it's id
     * &lt;p&gt;
     *
     * @param spEmpTemp : SPEmpTemplate to create
     * @return SPEmpTemplate id
     */
    public ID createSPEmpTemplate(SPEmpTemplate spEmpTemp) throws BbmCreateException {
<span class="fc" id="L2809">        methodStart(&quot;createSPEmpTemplate&quot;, spEmpTemp);</span>
<span class="fc" id="L2810">        SPEmpTemplateDAO spEmpTemplateDao = null;</span>
<span class="fc" id="L2811">        Jdmo dmo = new Jdmo();</span>
        try {
<span class="fc" id="L2813">            spEmpTemplateDao = new SPEmpTemplateDAO();</span>
<span class="fc" id="L2814">            spEmpTemp.setDEID(new ID(DAOUtil.getDEID(dmo)));</span>
<span class="fc" id="L2815">            spEmpTemplateDao.setIDs(spEmpTemp);</span>
<span class="fc" id="L2816">            ID spEmpTempID = spEmpTemplateDao.createObject(spEmpTemp);</span>
<span class="fc" id="L2817">            spEmpTemp.setDEID(spEmpTempID);</span>
            // find SID and return
<span class="fc" id="L2819">            ID createdID = spEmpTempID;</span>
<span class="fc" id="L2820">            String stmt = &quot;SELECT SID FROM SPEMPTEMPLATE WHERE ID ='&quot; + spEmpTempID + &quot;'&quot;;</span>
<span class="fc" id="L2821">            JdmoRowset rs = dmo.createRowset(stmt);</span>
<span class="pc bpc" id="L2822" title="1 of 2 branches missed.">            if (rs.next()) {</span>
<span class="fc" id="L2823">                createdID = rs.getID(1);</span>
            }
<span class="fc" id="L2825">            rs.close();</span>
<span class="fc" id="L2826">            return createdID;</span>
<span class="nc" id="L2827">        } catch (BbmCreateException e) {</span>
<span class="nc" id="L2828">            handleException(e, true);</span>
<span class="nc" id="L2829">            throw e;</span>
<span class="nc" id="L2830">        } catch (JdmoException e) {</span>
<span class="nc" id="L2831">            handleException(e, true);</span>
<span class="nc" id="L2832">            throw new BbmCreateException(e);</span>
        } finally {
<span class="pc bpc" id="L2834" title="3 of 4 branches missed.">            if (spEmpTemplateDao != null) {</span>
<span class="pc" id="L2835">                spEmpTemplateDao.cleanUp();</span>
            }
<span class="pc" id="L2837">            dmo.cleanUp();</span>
<span class="pc" id="L2838">            methodFinish();</span>
        }
    }

    /**
     * &lt;B&gt;updateSPEmpTemplate&lt;/B&gt;
     * &lt;p&gt;
     * creates given SPEmpTemplate in db, and sets it's id
     * &lt;p&gt;
     *
     * @param colSPEmpTemplateIDs : list of SPEmpTemplate to create
     * @return SPEmpTemplate id
     */
    public void updateSPEmpTemplate(Collection&lt;SPEmpTemplate&gt; colSPEmpTemplateIDs) throws BbmUpdateException,
            MultiUserException {
<span class="fc" id="L2853">        methodStart(&quot;updateSPEmpTemplate&quot;);</span>
<span class="fc" id="L2854">        SPEmpTemplateDAO spEmpTemplateDao = null;</span>
        try {
<span class="fc bfc" id="L2856" title="All 2 branches covered.">            for (SPEmpTemplate spEmpTemp : colSPEmpTemplateIDs) {</span>
                // spEmpTemp.validate();
<span class="fc" id="L2858">                spEmpTemplateDao = new SPEmpTemplateDAO();</span>
<span class="fc" id="L2859">                spEmpTemplateDao.setIDs(spEmpTemp);</span>
<span class="fc" id="L2860">                spEmpTemplateDao.updateObject(spEmpTemp);</span>
                // if (cacheUsed()) {
                // m_ActivityCache.put(activity.getID(), activity);
                // }
<span class="fc" id="L2864">            }</span>
<span class="nc" id="L2865">        } catch (BbmCreateException e) {</span>
<span class="nc" id="L2866">            handleException(e, true);</span>
<span class="nc" id="L2867">            throw new BbmUpdateException(e);</span>
<span class="nc" id="L2868">        } catch (BbmUpdateException e) {</span>
<span class="nc" id="L2869">            handleException(e, true);</span>
<span class="nc" id="L2870">            throw e;</span>
<span class="nc" id="L2871">        } catch (MultiUserException e) {</span>
<span class="nc" id="L2872">            handleException(e, true);</span>
<span class="nc" id="L2873">            throw e;</span>
        } finally {
<span class="pc bpc" id="L2875" title="3 of 4 branches missed.">            if (spEmpTemplateDao != null) {</span>
<span class="pc" id="L2876">                spEmpTemplateDao.cleanUp();</span>
            }
<span class="pc" id="L2878">            methodFinish();</span>
<span class="fc" id="L2879">        }</span>
<span class="fc" id="L2880">    }</span>

    public void deleteSPEmpTemplate(Collection&lt;ID&gt; colSPEmpTemplateIDs) throws BbmRemoveException {
<span class="nc" id="L2883">        methodStart(&quot;deleteSPEmpTemplate&quot;);</span>
<span class="nc bnc" id="L2884" title="All 4 branches missed.">        if (colSPEmpTemplateIDs == null || colSPEmpTemplateIDs.isEmpty()) {</span>
<span class="nc" id="L2885">            return;</span>
        }
<span class="nc" id="L2887">        Jdmo dmo = new Jdmo();</span>
        try {
<span class="nc" id="L2889">            String where = &quot;select ID from SPEMPTEMPLATE where SID in &quot; + dmo.createInClause(colSPEmpTemplateIDs);</span>
<span class="nc" id="L2890">            DAOUtil.deleteObjects(dmo, &quot;SPEMPTEMPLATE&quot;, where);</span>
<span class="nc" id="L2891">            DAOUtil.deleteObjects(dmo, &quot;SPEMPTEMPLATE&quot;, colSPEmpTemplateIDs);</span>

<span class="nc" id="L2893">        } catch (Exception ex) {</span>
<span class="nc" id="L2894">            throw new BbmRemoveException(ex);</span>
        } finally {
<span class="nc" id="L2896">            dmo.cleanUp();</span>
<span class="nc" id="L2897">        }</span>
<span class="nc" id="L2898">    }</span>

    /**
     * Get the SPEmpTemplates that belong to this scheduling period
     *
     * @param spid
     * @return
     * @throws BbmFinderException
     */
    private Collection getSPEmpTemplatesBySPID(ID spid) throws BbmFinderException {
<span class="fc" id="L2908">        methodStart(&quot;getSPEmpTemplatesBySP&quot;);</span>
<span class="fc" id="L2909">        SPEmpTemplateDAO dao = new SPEmpTemplateDAO();</span>
        try {
<span class="fc" id="L2911">            return dao.getSPEmpTemplatesBySP(spid);</span>
<span class="nc" id="L2912">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2913">            handleException(e);</span>
<span class="nc" id="L2914">            throw e;</span>
        } finally {
<span class="pc" id="L2916">            dao.cleanUp();</span>
<span class="pc" id="L2917">            methodFinish();</span>
        }
    }

    public Collection getSPEmpTemplatesBySP(ID spid) throws BbmFinderException {
<span class="fc" id="L2922">        methodStart(&quot;getSPEmpTemplatesBySP&quot;);</span>
<span class="fc" id="L2923">        SPEmpTemplateDAO dao = new SPEmpTemplateDAO();</span>
<span class="fc" id="L2924">        SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO();</span>
<span class="fc" id="L2925">        Collection&lt;SPEmpTemplate&gt; spEmpTemplate = new ArrayList&lt;SPEmpTemplate&gt;();</span>
<span class="fc" id="L2926">        SchedulingPeriod childSp = spDAO.getSchedulingPeriodByID(spid);</span>
<span class="fc" id="L2927">        ID parentSPID = DAOUtil.mapIDToSID(childSp.getParentSPID(), spDAO.getFieldInfo());// childSp.getParentSPID();</span>

        try {
<span class="pc bpc" id="L2930" title="1 of 2 branches missed.">            if (parentSPID == null) {</span>
                // cur SP is parent, add from Sub SP
<span class="fc" id="L2932">                Collection&lt;ID&gt; subSPIDs = getSubSPIDsFromParentSPID(spid);</span>
<span class="fc" id="L2933">                long nNumSPs = subSPIDs.size();</span>
<span class="fc bfc" id="L2934" title="All 2 branches covered.">                for (Iterator it = subSPIDs.iterator(); it.hasNext(); ) {</span>
<span class="fc" id="L2935">                    ID subID = (ID) it.next();</span>
<span class="fc" id="L2936">                    spEmpTemplate.addAll(getSPEmpTemplatesBySPID(subID));</span>
<span class="fc" id="L2937">                }</span>

                // add from current SP
<span class="fc" id="L2940">                spEmpTemplate.addAll(getSPEmpTemplatesBySPID(spid));</span>
<span class="fc" id="L2941">            } else {</span>
                // cur SP is child, add from parent SP
<span class="nc bnc" id="L2943" title="All 2 branches missed.">                if (parentSPID != null) {</span>
                    // parentSPID is a DEID, however getSPEmpTemplatesBySPID
                    // expects an SID. It would be
                    // ideal to have the parent SP ID set automatically with an
                    // SID, but I'm not sure what
                    // the ramifications of doing so would be to the other areas
                    // in the code that reference
                    // SchedulingPeriodDAO.getSchedulingPeriodByID()
<span class="nc" id="L2951">                    ID parentSPSID = DAOUtil.mapIDToSID(parentSPID, new SchedulingPeriodFieldInfo());</span>
<span class="nc" id="L2952">                    spEmpTemplate.addAll(getSPEmpTemplatesBySPID(parentSPSID));</span>
                }

                // add from sub sp if any?
<span class="nc" id="L2956">                Collection&lt;ID&gt; subSPIDs = getSubSPIDsFromParentSPID(spid);</span>
<span class="nc" id="L2957">                long nNumSPs = subSPIDs.size();</span>
<span class="nc bnc" id="L2958" title="All 2 branches missed.">                for (Iterator it = subSPIDs.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2959">                    ID subID = (ID) it.next();</span>
<span class="nc bnc" id="L2960" title="All 2 branches missed.">                    if (subID != spid) {</span>
<span class="nc" id="L2961">                        spEmpTemplate.addAll(getSPEmpTemplatesBySPID(subID));</span>
                    }
<span class="nc" id="L2963">                }</span>
                // add from current SP
<span class="nc" id="L2965">                spEmpTemplate.addAll(getSPEmpTemplatesBySPID(spid));</span>

            }
<span class="fc" id="L2968">            return spEmpTemplate;</span>
<span class="nc" id="L2969">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L2970">            handleException(e);</span>
<span class="nc" id="L2971">            throw e;</span>
        } finally {
<span class="pc" id="L2973">            dao.cleanUp();</span>
<span class="pc" id="L2974">            spDAO.cleanUp();</span>
<span class="pc" id="L2975">            methodFinish();</span>
        }
    }

    /**
     * Returns the child scheduling period IDs of the SP having the specified
     * numeric or alphanumeric ID.
     *
     * @param parentSPID the ID of the parent SP--may be SID or DEID (numeric or
     *                   alphanumeric)
     * @return a collection of IDs of the child SPs
     * @throws JdmoException
     * @throws BbmFinderException if the specified ID cannot be mapped to a DEID
     */
    public Collection&lt;ID&gt; getSubSPIDsFromParentSPID(ID parentSPID) throws BbmFinderException {
<span class="fc" id="L2990">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="fc" id="L2992">            return dao.getSubSPIDsFromParentSPID(parentSPID);</span>
<span class="nc" id="L2993">        } catch (BbmFinderException bfe) {</span>
<span class="nc" id="L2994">            handleException(bfe);</span>
<span class="nc" id="L2995">            throw bfe;</span>
<span class="nc" id="L2996">        } catch (Exception e) {</span>
<span class="nc" id="L2997">            handleException(e);</span>
<span class="nc" id="L2998">            throw new BbmFinderException(e);</span>
        } finally {
<span class="pc" id="L3000">            dao.cleanUp();</span>
        }
    }

    /**
     * Returns a map whose keys are SPQueue IDs and whose values are the
     * corresponding SPQueues. The map will contain all the SPQueues associated
     * with the specified campaign, collection of queues, and time range.
     * &lt;p/&gt;
     * Returns an empty map if {@code campaignID} is {@code null}.
     *
     * @param campaignID
     * @param queueIDs
     * @param start
     * @param end
     * @return
     * @throws RemoteException
     * @throws BbmFinderException
     */
    public Map&lt;ID, SPQueue&gt; getIDToSPQueueMapping(ID campaignID, Collection&lt;? extends ID&gt; queueIDs, Date start, Date end)
            throws RemoteException, BbmFinderException {
<span class="fc" id="L3021">        methodStart(&quot;getIDToSPQueueMapping&quot;, campaignID, queueIDs, start, end);</span>
<span class="fc" id="L3022">        Map&lt;ID, SPQueue&gt; idToSPQueueMapping = new HashMap&lt;ID, SPQueue&gt;();</span>
<span class="fc" id="L3023">        Jdmo dmo = new Jdmo();</span>
        try {
<span class="pc bpc" id="L3025" title="1 of 2 branches missed.">            if (campaignID != null) {</span>
<span class="fc" id="L3026">                SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO(dmo);</span>
<span class="fc" id="L3027">                Collection&lt;SchedulingPeriod&gt; colSP = spDAO.getSchedulingPeriods(campaignID, start, end, null, null);</span>
<span class="fc" id="L3028">                SPQueueDAO dao = new SPQueueDAO(dmo);</span>
<span class="fc" id="L3029">                Collection&lt;SPQueue&gt; colSPQs = dao.getSPQueuesBySPIDsFixed(ValueObjectUtil.getIDFromObjects(colSP));</span>
<span class="fc bfc" id="L3030" title="All 2 branches covered.">                for (SPQueue spQ : colSPQs) {</span>
<span class="fc bfc" id="L3031" title="All 2 branches covered.">                    if (queueIDs.contains(spQ.getQueueID())) {</span>
<span class="fc" id="L3032">                        idToSPQueueMapping.put(spQ.getID(), spQ);</span>
                    }
<span class="fc" id="L3034">                }</span>
            }
<span class="nc" id="L3036">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L3037">            handleException(e, false);</span>
<span class="nc" id="L3038">            throw e;</span>
        } finally {
<span class="pc bpc" id="L3040" title="3 of 4 branches missed.">            if (dmo != null)</span>
<span class="pc" id="L3041">                dmo.cleanUp();</span>
<span class="pc" id="L3042">            methodFinish();</span>
<span class="fc" id="L3043">        }</span>
<span class="fc" id="L3044">        return idToSPQueueMapping;</span>
    }

    /**
     * Returns a map whose keys are SPQueue IDs and whose values are the
     * corresponding SPQueues. The map will contain all the SPQueues associated
     * with the specified campaign, queue, and time range.
     * &lt;p/&gt;
     * Returns an empty map if {@code campaignID} is {@code null} or if the
     * queue ID does not share any SPQueues with the specified campaign.
     *
     * @param campaignID
     * @param queueID
     * @param start
     * @param end
     * @return
     * @throws RemoteException
     * @throws BbmFinderException
     */
    public Map&lt;ID, SPQueue&gt; getIDToSPQueueMapping(ID campaignID, ID queueID, Date start, Date end) throws RemoteException,
            BbmFinderException {
<span class="nc" id="L3065">        return getIDToSPQueueMapping(campaignID, new ArrayList(Arrays.asList(queueID)), start, end);</span>
    }

    /**
     * Returns a list of all the child SpQueues of the parent distributed
     * SpQueue.
     *
     * @param distributedSpQueueId
     * @return
     * @throws BbmFinderException
     * @throws RemoteException
     */
    public Collection&lt;SPQueue&gt; getChildSpQueuesOfDistributedSpQueue(ID distributedSpQueueId) throws BbmFinderException,
            RemoteException {
<span class="fc" id="L3079">        Collection&lt;SPQueue&gt; childSpQueues = new ArrayList&lt;SPQueue&gt;();</span>
<span class="fc" id="L3080">        SPQueue spq = getSPQueue(distributedSpQueueId);</span>
<span class="pc bpc" id="L3081" title="1 of 2 branches missed.">        boolean isCombined = spq.getQueueID() == null;</span>
<span class="fc" id="L3082">        Collection&lt;ID&gt; childQueueIds = null;</span>
<span class="pc bpc" id="L3083" title="1 of 2 branches missed.">        if (!isCombined) {</span>
<span class="fc" id="L3084">            childQueueIds = m_workloadManager.getSubQueues(Collections.singleton(spq.getQueueID()));</span>
        }
<span class="fc" id="L3086">        Collection&lt;ID&gt; childSpIds = getSubSPIDsFromParentSPID(spq.getSpID());</span>
<span class="fc" id="L3087">        Collection&lt;SPQueue&gt; candidateSpQueues = getSPQueuesBySPIDs(childSpIds);</span>
<span class="fc bfc" id="L3088" title="All 2 branches covered.">        for (SPQueue spQueue : candidateSpQueues) {</span>
            // We handle combined single media but not combined-combined
<span class="pc bpc" id="L3090" title="6 of 8 branches missed.">            if ((isCombined &amp;&amp; spQueue.getQueueID() == null &amp;&amp; spQueue.getMediaID() != null)</span>
<span class="fc bfc" id="L3091" title="All 2 branches covered.">                    || ((!isCombined) &amp;&amp; childQueueIds.contains(spQueue.getQueueID()))) {</span>
<span class="fc" id="L3092">                childSpQueues.add(spQueue);</span>
            }
<span class="fc" id="L3094">        }</span>
<span class="fc" id="L3095">        return childSpQueues;</span>
    }

    /**
     * If the queue associated with {@code childSpQueueId} is deferred or
     * immediate and a child queue of a parent distributed queue, then this
     * method returns the parent SPQueue. Otherwise it returns {@code null}.
     * {@code childSpQueueId} may be associated either with a single or combined
     * queue.
     *
     * @param childSpQueueId
     * @throws BbmFinderException
     * @throws RemoteException
     */
    public SPQueue getDistributedParentSpQueue(ID childSpQueueId) throws BbmFinderException, RemoteException {
<span class="fc" id="L3110">        SPQueueDAO spqDao = new SPQueueDAO();</span>
<span class="fc" id="L3111">        SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO();</span>
        try {
<span class="fc" id="L3113">            SPQueue childSpQueue = spqDao.getObjectByID(childSpQueueId);</span>
            // Only process immediate and deferred queues
<span class="pc bpc" id="L3115" title="1 of 4 branches missed.">            if (Media.isMediaImmediate(childSpQueue.getMediaID()) || Media.isMediaDeferred(childSpQueue.getMediaID())) {</span>

<span class="fc" id="L3117">                SchedulingPeriod childSp = spDAO.getSchedulingPeriodByID(childSpQueue.getSpID());</span>
<span class="fc" id="L3118">                Campaign campaign = getCampaignByID(childSp.getCampaignID());</span>
<span class="fc" id="L3119">                ID parentCampaignID = campaign.getParentCampaignID();</span>
                // Only process if the current campaign has a parent...
<span class="pc bpc" id="L3121" title="1 of 2 branches missed.">                if (parentCampaignID != null) {</span>
<span class="nc" id="L3122">                    Campaign parentCampaign = getCampaignByID(parentCampaignID);</span>
                    // ... and the parent is distributed
<span class="nc bnc" id="L3124" title="All 2 branches missed.">                    if (parentCampaign.getIsDistributed()) {</span>
<span class="nc bnc" id="L3125" title="All 2 branches missed.">                        if (childSpQueue.getQueueID() == null) {</span>
                            // combined queue
<span class="nc" id="L3127">                            return getCombinedSPQueue(childSp.getParentID(), childSpQueue.getMediaID());</span>
                        } else {
                            // single queue
<span class="nc" id="L3130">                            QueueDAO queueDao = new QueueDAO(); // Doesn't need</span>
                            // cleanup call.
<span class="nc" id="L3132">                            Queue queue = queueDao.getObjects(Collections.singleton(childSpQueue.getQueueID())).iterator()</span>
<span class="nc" id="L3133">                                    .next();</span>
<span class="nc" id="L3134">                            ID parentQueueId = queue.getParentID();</span>
<span class="nc" id="L3135">                            return getSPQueue(DAOUtil.mapIDToSID(childSp.getParentSPID(), spDAO.getFieldInfo()),</span>
                                    parentQueueId);
                        }
                    }
                }
            }
<span class="nc" id="L3141">        } catch (BbmFinderException bfe) {</span>
<span class="nc" id="L3142">            handleException(bfe);</span>
<span class="nc" id="L3143">            throw bfe;</span>
<span class="nc" id="L3144">        } catch (Exception e) {</span>
<span class="nc" id="L3145">            handleException(&quot;getDistributedParentSpQueue&quot;, e, false);</span>
<span class="nc" id="L3146">            throw new BbmFinderException(e);</span>
        } finally {
<span class="pc" id="L3148">            spqDao.cleanUp();</span>
<span class="pc" id="L3149">            spDAO.cleanUp();</span>
<span class="fc" id="L3150">        }</span>
<span class="fc" id="L3151">        return null;</span>
    }

    /**
     * Returns a map of Scheduling Period IDs to their associated campaign's
     * name.
     *
     * @param spIDs - The scheduling period IDs for which we'd like to look up
     *              their associated campaign's name.
     * @throws BbmFinderException
     */
    public Map&lt;ID, String&gt; getCampaignNamesLinkedToSPs(Collection&lt;ID&gt; spIDs) throws RemoteException, BbmFinderException {
<span class="fc" id="L3163">        methodStart(&quot;getCampaignNamesLinkedToSPs&quot;, spIDs);</span>
<span class="fc" id="L3164">        CampaignDAO dao = new CampaignDAO();</span>
        try {
<span class="fc" id="L3166">            return dao.getCampaignNamesLinkedToSPs(spIDs);</span>
        } finally {
<span class="pc" id="L3168">            dao.cleanUp();</span>
<span class="pc" id="L3169">            methodFinish();</span>
        }
    }

    public void unlinkEmployeeShiftAssignments(Employee emp) throws BbmFinderException, BbmRemoveException {
<span class="nc" id="L3174">        methodStart(&quot;unlinkEmployeeShiftAssignments&quot;);</span>

<span class="nc" id="L3176">        SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
        try {
<span class="nc" id="L3178">            dao.unlinkShiftAssignmentToSP(emp.getID(), emp.getOrgChangedDate());</span>
        } finally {
<span class="nc" id="L3180">            dao.cleanUp();</span>
<span class="nc" id="L3181">            methodFinish();</span>
<span class="nc" id="L3182">        }</span>
<span class="nc" id="L3183">    }</span>

    /**
     * get an given organization's campaign assignments
     *
     * @param idOrg   organization id
     * @param dtStart
     * @param dtEnd   the time period, null date means a open period
     * @return a collection of CampaignOrg objects which hold the assignment
     * information
     */
    public Collection getOrgCampaignAssignments(ID idOrg, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L3195">        methodStart(&quot;getOrgCampaignAssignments&quot;, idOrg, dtStart, dtEnd);</span>
<span class="fc" id="L3196">        CampaignOrgDAO dao = new CampaignOrgDAO();</span>
        try {
<span class="fc" id="L3198">            return dao.getOrgCampaignAssignments(idOrg, dtStart, dtEnd);</span>
<span class="nc" id="L3199">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L3200">            handleException(e, false);</span>
<span class="nc" id="L3201">            throw e;</span>
        } finally {
<span class="pc" id="L3203">            dao.cleanUp();</span>
<span class="pc" id="L3204">            methodFinish();</span>
        }
    }

    public Collection&lt;SPQueue&gt; getSPQueuesByQueues(Collection&lt;Queue&gt; queues) throws BbmFinderException {
<span class="nc" id="L3209">        methodStart(&quot;getSPQueuesByQueues&quot;);</span>
<span class="nc" id="L3210">        SPQueueDAO dao = new SPQueueDAO();</span>
        try {
<span class="nc" id="L3212">            return dao.getSPQueuesByQueues(queues);</span>
        } finally {
<span class="nc" id="L3214">            dao.cleanUp();</span>
<span class="nc" id="L3215">            methodFinish();</span>
        }
    }

    public void cloneLSGTemplateForNewSP(ID idTargetSP, Collection&lt;CampaignHOO&gt; spHOOs) throws BbmCreateException {
<span class="pc bpc" id="L3220" title="3 of 6 branches missed.">        if (idTargetSP == null || spHOOs == null || spHOOs.isEmpty()) {</span>
<span class="nc" id="L3221">            return;</span>
        }
<span class="fc" id="L3223">        SPQueueDAO dao = null;</span>
<span class="fc" id="L3224">        SchedulingPeriodDAO spDao = null;</span>
        try {
<span class="fc" id="L3226">            dao = new SPQueueDAO();</span>
<span class="fc" id="L3227">            spDao = new SchedulingPeriodDAO();</span>
<span class="fc" id="L3228">            Collection&lt;SPQueue&gt; spQueues = dao.getSPQueuesBySPID(idTargetSP);</span>
<span class="fc" id="L3229">            Set&lt;ID&gt; previousSPIDs = new HashSet&lt;ID&gt;();</span>

<span class="fc bfc" id="L3231" title="All 2 branches covered.">            for (CampaignHOO campaignHOO : spHOOs) {</span>
<span class="fc bfc" id="L3232" title="All 2 branches covered.">                if (!previousSPIDs.contains(campaignHOO.getSPID())) {</span>
<span class="fc" id="L3233">                    previousSPIDs.add(campaignHOO.getSPID());</span>
                }
<span class="fc" id="L3235">            }</span>

<span class="fc" id="L3237">            List&lt;SchedulingPeriod&gt; sortedPreviousSPs = new ArrayList&lt;SchedulingPeriod&gt;(spDao.getObjectsByIDs(previousSPIDs));</span>
<span class="fc" id="L3238">            Collections.sort(sortedPreviousSPs, new Comparator&lt;SchedulingPeriod&gt;() {</span>
                @Override
                public int compare(SchedulingPeriod o1, SchedulingPeriod o2) {
<span class="nc" id="L3241">                    return o2.getStartTime().compareTo(o1.getStartTime());</span>
                }
            });
<span class="fc" id="L3244">            Map&lt;ID, ID&gt; queueIDToSPQueues = new HashMap&lt;ID, ID&gt;();</span>

<span class="pc bpc" id="L3246" title="1 of 2 branches missed.">            for (SchedulingPeriod sortedPreviousSP : sortedPreviousSPs) {</span>
<span class="fc" id="L3247">                Collection&lt;SPQueue&gt; spQueuesTemp = dao.getSPQueuesBySPID(sortedPreviousSP.getID());</span>
<span class="pc bpc" id="L3248" title="1 of 2 branches missed.">                for (SPQueue oQueue : spQueuesTemp) {</span>
<span class="pc bpc" id="L3249" title="1 of 2 branches missed.">                    if (!queueIDToSPQueues.containsKey(oQueue.getQueueID())) {</span>
<span class="fc" id="L3250">                        queueIDToSPQueues.put(oQueue.getQueueID(), oQueue.getDEID());</span>
                    }
<span class="pc bpc" id="L3252" title="1 of 2 branches missed.">                    if (queueIDToSPQueues.size() == spQueues.size()) {</span>
<span class="fc" id="L3253">                        break;</span>
                    }
<span class="nc" id="L3255">                }</span>
<span class="pc bpc" id="L3256" title="1 of 2 branches missed.">                if (queueIDToSPQueues.size() == spQueues.size()) {</span>
<span class="fc" id="L3257">                    break;</span>
                }
<span class="nc" id="L3259">            }</span>

<span class="fc" id="L3261">            Map&lt;ID, ID&gt; previousSPQueueIdToNewSPQueueID = new HashMap&lt;ID, ID&gt;();</span>
<span class="fc bfc" id="L3262" title="All 2 branches covered.">            for (SPQueue spQueue : spQueues) {</span>
<span class="fc" id="L3263">                ID oldSPQueueID = queueIDToSPQueues.get(spQueue.getQueueID());</span>
<span class="pc bpc" id="L3264" title="1 of 2 branches missed.">                if (oldSPQueueID != null) {</span>
<span class="fc" id="L3265">                    previousSPQueueIdToNewSPQueueID.put(oldSPQueueID, spQueue.getDEID());</span>
                }
<span class="fc" id="L3267">            }</span>
<span class="fc" id="L3268">            getLSInfoExtractor().cloneLsgTemplateFromCurrentSPQueueIDToClonedSPQueueID(previousSPQueueIdToNewSPQueueID);</span>
<span class="nc" id="L3269">        } catch (Exception e) {</span>
<span class="nc" id="L3270">            throw new BbmCreateException(e);</span>
        } finally {
<span class="pc bpc" id="L3272" title="3 of 4 branches missed.">            if (dao != null) {</span>
<span class="pc" id="L3273">                dao.cleanUp();</span>
            }
<span class="pc bpc" id="L3275" title="3 of 4 branches missed.">            if (spDao != null) {</span>
<span class="pc" id="L3276">                spDao.cleanUp();</span>
            }
        }
<span class="fc" id="L3279">    }</span>

    private LSGInfoExtractor getLSInfoExtractor() throws Exception {
<span class="fc" id="L3282">        final GCRManager m_gcrManager = CoreManagerFactory.getGCRManagerRemote(isWhatIf);</span>
<span class="fc" id="L3283">        final String gcrType = &quot;OPERATIONS_LSG_MANAGER&quot;;</span>
<span class="fc" id="L3284">        final Collection entries = m_gcrManager.getGCREntryOfType(gcrType);</span>
<span class="fc" id="L3285">        final Class clazz = Class.forName(((GCREntry) (entries.iterator().next())).getHook());</span>
<span class="fc" id="L3286">        return (LSGInfoExtractor) clazz.newInstance();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>