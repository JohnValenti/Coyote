<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SPQueueDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.campaign.ejb</a> &gt; <span class="el_source">SPQueueDAO.java</span></div><h1>SPQueueDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.campaign.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  DAO object to serialize SP Queue object
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 *
 * @author Shirley Sasson
 * @version 1.0
 */

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.PaginationPair;
import com.bluepumpkin.common.jdmo.*;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.*;
import com.bluepumpkin.ejb.bbm.campaign.model.*;
import com.bluepumpkin.ejb.bbm.config.ejb.DBConfigManager;
import com.bluepumpkin.ejb.bbm.dao.DAOBaseWithAutoIDMapping;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.skill.model.SkillFieldInfo;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workload.model.MediaFieldInfo;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.QueueFieldInfo;
import com.bluepumpkin.ejb.bbm.workload.model.QueueType;
import com.bluepumpkin.ejb.bbm.workresource.model.OrganizationFieldInfo;

import java.rmi.RemoteException;
import java.util.*;

public class SPQueueDAO extends DAOBaseWithAutoIDMapping&lt;SPQueue&gt; {
<span class="fc" id="L40">	private static FieldInfo m_fieldInfo = new SPQueueFieldInfo();</span>
	private static final boolean USE_PATIENCE_IN_UNSKILLED_ASA_CALCS;
	private static final String PROC_CREATEUPDATESPQUEUE_LIMITED_FIELDS = &quot;BP_BF_CREATEORUPDATESPQUEUES&quot;;

<span class="fc" id="L44">	private static final QueueFieldInfo qfi = new QueueFieldInfo();</span>
<span class="fc" id="L45">	private static final OrganizationFieldInfo ofi = new OrganizationFieldInfo();</span>
<span class="fc" id="L46">	private static final MediaFieldInfo mfi = new MediaFieldInfo();</span>

<span class="fc" id="L48">	private final String queueNameSortFieldKey = qfi.getTableName() + &quot;_&quot; + qfi.getFieldName(QueueFieldInfo.QUEUE_NAME);</span>
<span class="fc" id="L49">	private final String queueDescriptionSortFieldKey = qfi.getTableName() + &quot;_&quot;</span>
<span class="fc" id="L50">			+ qfi.getFieldName(QueueFieldInfo.QUEUE_DESCRIPTION);</span>
<span class="fc" id="L51">	private final String organizationSortFieldKey = qfi.getTableName() + &quot;_&quot;</span>
<span class="fc" id="L52">			+ qfi.getFieldName(QueueFieldInfo.QUEUE_ORGANIZATIONNAME);</span>
<span class="fc" id="L53">	private final String mediaSortFieldKey = qfi.getTableName() + &quot;_&quot; + qfi.getFieldName(QueueFieldInfo.QUEUE_MEDIANAME);</span>
<span class="fc" id="L54">	private final String queueTypeSortFieldKey = qfi.getTableName() + &quot;_&quot; + qfi.getFieldName(QueueFieldInfo.QUEUE_TYPE);</span>

	static {
<span class="fc" id="L57">		boolean usePatience = false;</span>
		try {
<span class="fc" id="L59">			DBConfigManager bpConfigManager = BbmManagerFactory.getDBConfigManager();</span>
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">			usePatience = (bpConfigManager.getIntValue(&quot;IsNewErlangC&quot;) == 1);</span>
<span class="nc" id="L61">		} catch (BbmEJBCreateException bece) {</span>
<span class="nc" id="L62">			bece.printStackTrace();</span>
<span class="nc" id="L63">		} catch (RemoteException re) {</span>
<span class="nc" id="L64">			re.printStackTrace();</span>
		} finally {
<span class="pc" id="L66">			USE_PATIENCE_IN_UNSKILLED_ASA_CALCS = usePatience;</span>
<span class="pc" id="L67">		}</span>
<span class="fc" id="L68">	}</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="fc" id="L72">		return m_fieldInfo;</span>
	}

	/**
	 * default constructor
	 */
	public SPQueueDAO() {
<span class="fc" id="L79">		super();</span>
<span class="fc" id="L80">	}</span>

	public SPQueueDAO(Jdmo dmo) {
<span class="fc" id="L83">		super(dmo);</span>
<span class="fc" id="L84">	}</span>

	@Override
	protected Map&lt;Integer, ? extends FieldInfo&gt; getForeignKeyFieldInfo() {
<span class="fc" id="L88">		Map&lt;Integer, FieldInfo&gt; retVal = new HashMap&lt;Integer, FieldInfo&gt;();</span>
<span class="fc" id="L89">		retVal.put(SPQueueFieldInfo.SPQUEUE_SPID, new SchedulingPeriodFieldInfo());</span>
<span class="fc" id="L90">		retVal.put(SPQueueFieldInfo.SPQUEUE_QUEUEID, new QueueFieldInfo());</span>
<span class="fc" id="L91">		retVal.put(SPQueueFieldInfo.SPQUEUE_MEDIAID, new MediaFieldInfo());</span>
<span class="fc" id="L92">		return retVal;</span>
	}

	@Override
	protected SPQueue createValueObject() {
<span class="fc" id="L97">		SPQueue spq = new SPQueue();</span>
<span class="fc" id="L98">		spq.setIsPatienceUsedinUnskilledASACalcs(USE_PATIENCE_IN_UNSKILLED_ASA_CALCS);</span>
<span class="fc" id="L99">		return spq;</span>
	}

	public ID createSPQueue(SPQueue objValue) throws BbmCreateException, BbmTimePeriodOverlapException {
<span class="fc" id="L103">		Jdmo jdmo = new Jdmo();</span>
		try {
			// get the sp de id from sid
<span class="fc" id="L106">			ID spID = null;</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">			if (objValue.getSpID() != null) {</span>
<span class="fc" id="L108">				spID = DAOUtil.mapIDToDEID(objValue.getSpID(), new SchedulingPeriodFieldInfo());</span>
			}

			// get the queue de id
<span class="fc" id="L112">			ID queueID = null;</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">			if (objValue.getQueueID() != null) {</span>
<span class="fc" id="L114">				queueID = DAOUtil.mapIDToDEID(objValue.getQueueID(), new QueueFieldInfo());</span>
			}

			// Check if this queue is used in another campaign for the same
			// dates
<span class="fc" id="L119">			String queueChkStmt = &quot;Select distinct campaign.name from SPQUEUE, SP SP1, SP SP2, CAMPAIGN &quot;</span>
					+ &quot;where SP1.CAMPAIGNID = CAMPAIGN.ID and SPQUEUE.SPID = SP1.ID and &quot;
					+ &quot;((SP2.FROMDATE &gt;=  SP1.FROMDATE and SP2.FROMDATE &lt; SP1.TODATE) &quot;
					+ &quot;or (SP2.TODATE &gt;  SP1.FROMDATE and SP2.TODATE &lt;= SP1.TODATE) &quot;
					+ &quot;or (SP2.FROMDATE &lt;= SP1.FROMDATE and SP2.TODATE &gt;= SP1.TODATE )) &quot;
					+ &quot;and spqueue.queueid = ? and sp2.id = ?&quot;;
<span class="fc" id="L125">			JdmoQuery jq1Chk = jdmo.createQuery(queueChkStmt, Jdmo.PARAM_QUERY);</span>
<span class="fc" id="L126">			jq1Chk.setParID(1, queueID);</span>
<span class="fc" id="L127">			jq1Chk.setParID(2, spID);</span>
<span class="fc" id="L128">			JdmoRowset rsChk = jdmo.createRowset(jq1Chk, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">			if (rsChk.next()) {</span>
<span class="nc" id="L130">				String cpName = rsChk.getString(1);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">				while (rsChk.next()) {</span>
<span class="nc" id="L132">					cpName = cpName + &quot;, &quot; + rsChk.getString(1);</span>
				}
<span class="nc" id="L134">				Object[] args = new Object[1];</span>
<span class="nc" id="L135">				args[0] = cpName;</span>
<span class="nc" id="L136">				throw (new BbmTimePeriodOverlapException(BbmEjbBundleKey.BUNDLE_NAME,</span>
						BbmEjbBundleKey.INVALID_QUEUE_TO_SP_LINKING, args));
			}
<span class="fc" id="L139">			rsChk.close();</span>

			// get the media de id of the underlying queue
<span class="fc" id="L142">			StringBuffer pStmt = new StringBuffer(&quot;select MEDIAID from QUEUE where ID = ?&quot;);</span>
<span class="fc" id="L143">			JdmoQuery jq1 = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="fc" id="L144">			jq1.setParString(1, queueID.toString());</span>
<span class="fc" id="L145">			JdmoRowset rs = jdmo.createRowset(jq1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="fc" id="L146">			ID mediaID = null;</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">			if (rs.next()) {</span>
<span class="fc" id="L148">				mediaID = rs.getID(1);</span>
			}
<span class="fc" id="L150">			rs.close();</span>

<span class="pc bpc" id="L152" title="1 of 2 branches missed.">			if (queueID != null) {</span>
				// Check if entry for this media in database for this spid
<span class="fc" id="L154">				String stmt = &quot;select SID from SPQUEUE where SPID= '&quot; + spID.toString() + &quot;' AND MEDIAID = '&quot;</span>
<span class="fc" id="L155">						+ mediaID.toString() + &quot;'&quot;;</span>
<span class="fc" id="L156">				JdmoRowset rs2 = jdmo.createRowset(stmt);</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">				if (!rs2.next()) { // no media entry exists so create one.</span>
					// Create the first spqueue with a null
					// media and null queue.
<span class="fc" id="L160">					SPQueue spqObj = new SPQueue();</span>
<span class="fc" id="L161">					spqObj.setSpID(spID);</span>
<span class="fc" id="L162">					spqObj.setQueueID(null);</span>
<span class="fc" id="L163">					spqObj.setMediaID(mediaID);</span>
<span class="fc" id="L164">					createSPQueueDB(spqObj, spID, null, mediaID);</span>
				}
<span class="fc" id="L166">				rs2.close();</span>
			}
<span class="fc" id="L168">			ID spqueueID = (createSPQueueDB(objValue, spID, queueID, mediaID));</span>

			// create parent spqueue if necessary
			// first check if there is a parent sp
<span class="fc" id="L172">			SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO();</span>
<span class="fc" id="L173">			ArrayList&lt;ID&gt; spids = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L174">			spids.add(objValue.getSpID());</span>
<span class="fc" id="L175">			Collection&lt;SchedulingPeriod&gt; sps = spDAO.getObjectsByIDs(spids);</span>
<span class="fc" id="L176">			SchedulingPeriod sp = sps.iterator().next();</span>
<span class="fc" id="L177">			ID parentSPID = sp.getParentSPID();</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">			if (parentSPID != null) {</span>
<span class="nc" id="L179">				String parentqueue = &quot;SELECT COUNT(*) NUMQ FROM SPQUEUE &quot; + &quot;WHERE SPID = '&quot; + parentSPID</span>
						+ &quot;' AND QUEUEID IN (select parentqueueid from queue where id = '&quot; + queueID + &quot;')&quot;;
<span class="nc" id="L181">				JdmoRowset parentRow = m_dmo.createRowset(parentqueue);</span>
<span class="nc" id="L182">				int count = 0;</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">				if (parentRow.next()) {</span>
<span class="nc" id="L184">					count = parentRow.getInt(&quot;NUMQ&quot;);</span>
				}
<span class="nc" id="L186">				parentRow.close();</span>

<span class="nc bnc" id="L188" title="All 2 branches missed.">				if (count == 0) {</span>
					// find the parent queue
<span class="nc" id="L190">					String parentqueueid = &quot;select parentqueueid from queue where id = '&quot; + queueID + &quot;'&quot;;</span>
<span class="nc" id="L191">					parentRow = m_dmo.createRowset(parentqueueid);</span>
<span class="nc" id="L192">					ID parentQueueID = null;</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">					if (parentRow.next()) {</span>
<span class="nc" id="L194">						parentQueueID = parentRow.getID(&quot;parentqueueid&quot;);</span>
					}
<span class="nc" id="L196">					parentRow.close();</span>

<span class="nc" id="L198">					SPQueue spqObj = new SPQueue();</span>
<span class="nc" id="L199">					spqObj.setSpID(parentSPID);</span>
<span class="nc" id="L200">					spqObj.setQueueID(parentQueueID);</span>
<span class="nc" id="L201">					spqObj.setMediaID(mediaID);</span>
<span class="nc" id="L202">					createSPQueueDB(spqObj, parentSPID, parentQueueID, mediaID);</span>

<span class="nc" id="L204">					String parentstmt = &quot;select SID from SPQUEUE where SPID= '&quot; + parentSPID + &quot;' AND MEDIAID = '&quot;</span>
<span class="nc" id="L205">							+ mediaID.toString() + &quot;'&quot; + &quot; AND QUEUEID IS NULL&quot;;</span>
<span class="nc" id="L206">					JdmoRowset parentrs2 = jdmo.createRowset(parentstmt);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">					if (!parentrs2.next()) { // no media entry exists so create</span>
						// one.
						// Create the first spqueue with
						// a null media and null queue.
<span class="nc" id="L211">						SPQueue spqParentCombined = new SPQueue();</span>
<span class="nc" id="L212">						spqParentCombined.setSpID(parentSPID);</span>
<span class="nc" id="L213">						spqParentCombined.setQueueID(null);</span>
<span class="nc" id="L214">						spqParentCombined.setMediaID(mediaID);</span>
<span class="nc" id="L215">						createSPQueueDB(spqParentCombined, parentSPID, null, mediaID);</span>
					}
<span class="nc" id="L217">					parentrs2.close();</span>
				}
			}

<span class="fc" id="L221">			return spqueueID;</span>
<span class="nc" id="L222">		} catch (BbmTimePeriodOverlapException e) {</span>
<span class="nc" id="L223">			throw e;</span>
<span class="nc" id="L224">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L225">			throw e;</span>
<span class="nc" id="L226">		} catch (JdmoException e) {</span>
<span class="nc" id="L227">			throw new BbmCreateException(e);</span>
<span class="nc" id="L228">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L229">			throw new BbmCreateException(e);</span>
		} finally {
<span class="pc" id="L231">			jdmo.cleanUp();</span>
		}
	}

	public ID createSPQueueDB(SPQueue objValue, ID spID, ID queueID, ID mediaID) throws BbmCreateException {
<span class="fc" id="L236">		Jdmo jdmo = new Jdmo();</span>
		try {
			// get ID from DE
<span class="fc" id="L239">			String idStr = DAOUtil.getDEID(jdmo);</span>

			String spIDstr, queueIDstr, mediaStr;
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">			if (spID != null) {</span>
<span class="fc" id="L243">				spIDstr = JdmoUtil.asSqlLiteral(spID.toString());</span>
			} else {
<span class="nc" id="L245">				spIDstr = &quot;null&quot;;</span>
			}
<span class="fc bfc" id="L247" title="All 2 branches covered.">			if (queueID != null) {</span>
<span class="fc" id="L248">				queueIDstr = JdmoUtil.asSqlLiteral(queueID.toString());</span>
			} else {
<span class="fc" id="L250">				queueIDstr = &quot;null&quot;;</span>
			}
<span class="fc bfc" id="L252" title="All 2 branches covered.">			if (mediaID != null) {</span>
<span class="fc" id="L253">				mediaStr = JdmoUtil.asSqlLiteral(mediaID.toString());</span>
			} else {
<span class="fc" id="L255">				mediaStr = &quot;null&quot;;</span>
			}
<span class="fc" id="L257">			String pStmt1 = &quot;insert into SPQUEUE (ID, SPID, QUEUEID, MEDIAID, SERVICELEVELGOALTYPE, PATIENCE, MAXABANDONSPERCENT, SLANSWERWAITINGTIME, STARTINGBACKLOG, ACTUALORWORKINGHOUR, OVERLOADTHRESHOLD1, OVERLOADTHRESHOLD2, INTERIMBACKLOG, QUEUEPRIORITYGROUP, QPGTHRESHOLD, CREATED) values (&quot;</span>
<span class="fc" id="L258">					+ JdmoUtil.asSqlLiteral(idStr)</span>
					+ &quot;, &quot;
					+ spIDstr
					+ &quot;, &quot;
					+ queueIDstr
					+ &quot;, &quot;
					+ mediaStr
					+ &quot;, &quot;
<span class="fc" id="L266">					+ JdmoUtil.formatBool(objValue.getServiceLevelGoalType())</span>
					+ &quot;, &quot;
<span class="fc" id="L268">					+ new Integer(objValue.getPatience())</span>
					+ &quot;, &quot;
<span class="fc" id="L270">					+ new Float(objValue.getMaxAbandonsPercent())</span>
					+ &quot;, &quot;
<span class="fc" id="L272">					+ new Integer(objValue.getSlAnswerWaitingTime())</span>
					+ &quot;, &quot;
<span class="fc" id="L274">					+ new Float(objValue.getStartingBacklog())</span>
					+ &quot;, &quot;
<span class="fc" id="L276">					+ JdmoUtil.formatBool(objValue.getActualOrWorkingHour())</span>
					+ &quot;, &quot;
<span class="fc" id="L278">					+ new Integer(objValue.getOverloadThreshold1())</span>
					+ &quot;, &quot;
<span class="fc" id="L280">					+ new Integer(objValue.getOverloadThreshold2())</span>
					+ &quot;, &quot;
					+

<span class="fc" id="L284">					new Float(objValue.getInterimBacklog())</span>
					+ &quot;, &quot;
<span class="fc" id="L286">					+ new Integer(objValue.getQueuePriorityGroup())</span>
					+ &quot;, &quot;
<span class="fc" id="L288">					+ new Integer(objValue.getQPGThreshold()) + &quot;,&quot; + JdmoUtil.asSqlLiteral(new Date()) + &quot;)&quot;;</span>
<span class="fc" id="L289">			jdmo.executeCommand(pStmt1);</span>

<span class="fc" id="L291">			StringBuffer pStmt = new StringBuffer(&quot;select SID from SPQUEUE where ID=?&quot;);</span>
<span class="fc" id="L292">			JdmoQuery jq1 = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="fc" id="L293">			jq1.setParString(1, idStr);</span>
<span class="fc" id="L294">			JdmoRowset rs = jdmo.createRowset(jq1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="fc" id="L296">			ID spQueueID = null;</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">			if (rs.next()) {</span>
<span class="fc" id="L298">				spQueueID = rs.getID(1);</span>
			}
<span class="fc" id="L300">			rs.close();</span>
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">			if (objValue.IsSkillsUpdated()) {</span>
<span class="nc" id="L302">				linkSkillsToSPQueue(spQueueID, objValue.getSkills());</span>
			}
<span class="fc" id="L304">			return spQueueID;</span>
<span class="nc" id="L305">		} catch (JdmoException e) {</span>
<span class="nc" id="L306">			throw new BbmCreateException(e);</span>
<span class="nc" id="L307">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L308">			throw e;</span>
		} finally {
<span class="pc" id="L310">			jdmo.cleanUp();</span>
		}
	}

	public void updateSPQueue(SPQueue objValue) throws BbmUpdateException {
<span class="nc" id="L315">		Jdmo jdmo = new Jdmo();</span>
		try {
			String deleteDate, backlogDeleteDate;
<span class="nc bnc" id="L318" title="All 2 branches missed.">			if (objValue.getDeleteOnDate() != null) {</span>
<span class="nc" id="L319">				deleteDate = JdmoUtil.asSqlLiteral(objValue.getDeleteOnDate());</span>
			} else {
<span class="nc" id="L321">				deleteDate = &quot;null&quot;;</span>
			}

<span class="nc bnc" id="L324" title="All 2 branches missed.">			if (objValue.getInterimBacklogDate() != null) {</span>
<span class="nc" id="L325">				backlogDeleteDate = JdmoUtil.asSqlLiteral(objValue.getInterimBacklogDate());</span>
			} else {
<span class="nc" id="L327">				backlogDeleteDate = &quot;null&quot;;</span>
			}

<span class="nc" id="L330">			String pStmt1 = &quot;update SPQUEUE SET SERVICELEVELGOALTYPE = &quot;</span>
<span class="nc" id="L331">					+ JdmoUtil.formatBool(objValue.getServiceLevelGoalType()) + &quot;, PATIENCE = &quot;</span>
<span class="nc" id="L332">					+ new Integer(objValue.getPatience()) + &quot;, MAXABANDONSPERCENT = &quot;</span>
<span class="nc" id="L333">					+ new Float(objValue.getMaxAbandonsPercent()) + &quot;, SLANSWERWAITINGTIME = &quot;</span>
<span class="nc" id="L334">					+ new Integer(objValue.getSlAnswerWaitingTime()) + &quot;, STARTINGBACKLOG = &quot;</span>
<span class="nc" id="L335">					+ new Float(objValue.getStartingBacklog()) + &quot;, ACTUALORWORKINGHOUR = &quot;</span>
<span class="nc" id="L336">					+ JdmoUtil.formatBool(objValue.getActualOrWorkingHour()) + &quot;, DELETEONDATE = &quot; + deleteDate</span>
<span class="nc" id="L337">					+ &quot;, OVERLOADTHRESHOLD1 = &quot; + new Integer(objValue.getOverloadThreshold1()) + &quot;, OVERLOADTHRESHOLD2 = &quot;</span>
<span class="nc" id="L338">					+ new Integer(objValue.getOverloadThreshold2()) + &quot;, INTERIMBACKLOG = &quot;</span>
<span class="nc" id="L339">					+ new Float(objValue.getInterimBacklog()) + &quot;, INTERIMBACKLOGDATE = &quot; + backlogDeleteDate</span>
<span class="nc" id="L340">					+ &quot;, QUEUEPRIORITYGROUP = &quot; + new Integer(objValue.getQueuePriorityGroup()) + &quot;, QPGTHRESHOLD = &quot;</span>
<span class="nc" id="L341">					+ new Integer(objValue.getQPGThreshold()) + &quot;, MODIFIED = &quot; + JdmoUtil.asSqlLiteral(new Date())</span>
<span class="nc" id="L342">					+ &quot;  where SID = &quot; + JdmoUtil.asSqlLiteral(objValue.getID());</span>
<span class="nc" id="L343">			jdmo.executeCommand(pStmt1);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">			if (objValue.IsSkillsUpdated()) {</span>
<span class="nc" id="L345">				linkSkillsToSPQueue(objValue.getID(), objValue.getSkills());</span>
			}
<span class="nc" id="L347">		} catch (JdmoException e) {</span>
<span class="nc" id="L348">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L349">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L350">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L352">			jdmo.cleanUp();</span>
<span class="nc" id="L353">		}</span>
<span class="nc" id="L354">	}</span>

	/**
	 * Creates the list of the spqueues. This method is specifically written for
	 * Branch Forecasting uses cases where only a few fields are updates. Only
	 * the SPID, QueueID, Media Id, service goal type, patience, sl answering
	 * time and the first skill are used.
	 */
	public SPQueueIDMap createSPQueuesWithLimitedFields(Collection&lt;SPQueue&gt; spqueues) throws JdmoException {
<span class="nc" id="L363">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L365">			return new SPQueueIDMap(createOrUpdateSPQueuesWithLimitedFields(jdmo, spqueues));</span>
		} finally {
<span class="nc" id="L367">			jdmo.cleanUp();</span>
		}
	}
	
	/**
	 * Updates the list of the spqueues. This method is specifically written for
	 * Branch Forecasting uses cases where only a few fields are updates. Only
	 * the SPID, QueueID, Media Id, service goal type, patience, sl answering
	 * time and the first skill are used.
	 */
	public void updateSPQueuesWithLimitedFields(Collection&lt;SPQueue&gt; spqueues) throws JdmoException {
<span class="nc" id="L378">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L380">			createOrUpdateSPQueuesWithLimitedFields(jdmo, spqueues);</span>
		} finally {
<span class="nc" id="L382">			jdmo.cleanUp();</span>
<span class="nc" id="L383">		}</span>
<span class="nc" id="L384">	}</span>
	
	private JdmoRowset createOrUpdateSPQueuesWithLimitedFields(Jdmo jdmo, Collection&lt;SPQueue&gt; spqueues) throws JdmoException {
<span class="nc" id="L387">		JdmoQuery jQuery = jdmo.createQuery(PROC_CREATEUPDATESPQUEUE_LIMITED_FIELDS, Jdmo.STORPROC_QUERY);</span>
<span class="nc" id="L388">		jQuery.setParString(1, buildSPQueueDataForBulkUpdate(spqueues));</span>
<span class="nc" id="L389">		return jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
	}

	/**
	 * Builds the String in the format needed to call teh stored procedure to do
	 * bulk update of limited fields of SPQueue. Only the SPID, QueueID, Media
	 * Id, service goal type, patience, sl answering time and the first skill
	 * are used.
	 */
	String buildSPQueueDataForBulkUpdate(Collection&lt;SPQueue&gt; spqueues) {
<span class="nc" id="L399">		Map&lt;ID, String&gt; mediaStringIdbySID = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L400">		String seperator = &quot;,&quot;;</span>
<span class="nc" id="L401">		String rootStart = &quot;&lt;SPQ&gt;&quot;;</span>
<span class="nc" id="L402">		String elementStart = &quot;&lt;S&gt;&quot;;</span>
<span class="nc" id="L403">		String rootEnd = &quot;&lt;/SPQ&gt;&quot;;</span>
<span class="nc" id="L404">		String elementEnd = &quot;&lt;/S&gt;&quot;;</span>
<span class="nc" id="L405">		StringBuilder spqStringBuilder = new StringBuilder();</span>
<span class="nc" id="L406">		spqStringBuilder.append(rootStart);</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">		for (SPQueue spq : spqueues) {</span>
<span class="nc" id="L408">			spqStringBuilder.append(elementStart);</span>
<span class="nc" id="L409">			spqStringBuilder.append(spq.getSpID());</span>
<span class="nc" id="L410">			spqStringBuilder.append(seperator);</span>
<span class="nc" id="L411">			spqStringBuilder.append(spq.getQueueID());</span>
<span class="nc" id="L412">			spqStringBuilder.append(seperator);</span>
<span class="nc" id="L413">			String media = mediaStringIdbySID.get(spq.getMediaID());</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">			if (media == null) {</span>
<span class="nc" id="L415">				media = Media.convertMediaIdToString(spq.getMediaID());</span>
<span class="nc" id="L416">				mediaStringIdbySID.put(spq.getMediaID(), media);</span>
			}
<span class="nc" id="L418">			spqStringBuilder.append(media);</span>
<span class="nc" id="L419">			spqStringBuilder.append(seperator);</span>
<span class="nc" id="L420">			spqStringBuilder.append(JdmoUtil.formatBool(spq.getServiceLevelGoalType()));</span>
<span class="nc" id="L421">			spqStringBuilder.append(seperator);</span>
<span class="nc" id="L422">			spqStringBuilder.append(spq.getPatience());</span>
<span class="nc" id="L423">			spqStringBuilder.append(seperator);</span>
<span class="nc" id="L424">			spqStringBuilder.append(spq.getSlAnswerWaitingTime());</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">			if (spq.getSkills().size() &gt; 0) {</span>
<span class="nc" id="L426">				spqStringBuilder.append(seperator);</span>
<span class="nc" id="L427">				spqStringBuilder.append(spq.getSkills().iterator().next());</span>
			}
<span class="nc" id="L429">			spqStringBuilder.append(elementEnd);</span>
<span class="nc" id="L430">		}</span>
<span class="nc" id="L431">		spqStringBuilder.append(rootEnd);</span>
<span class="nc" id="L432">		return spqStringBuilder.toString();</span>
	}

	/**
	 * Returns the SPQueue object
	 *
	 * @param spQueueID
	 * @return
	 * @throws BbmFinderException
	 * @throws JdmoException
	 */
	public SPQueue getSPQueue(ID spQueueID) throws BbmFinderException, BbmObjectNotFoundException, JdmoException {
<span class="fc" id="L444">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="fc" id="L446">			SPQueue spq = dao.getObjectByID(spQueueID);</span>
<span class="fc" id="L447">			ID sidSPID = DAOUtil.mapIDToSID(spq.getSpID(), new SchedulingPeriodFieldInfo());</span>
<span class="fc" id="L448">			spq.setSpID(sidSPID);</span>
<span class="fc" id="L449">			ID sidMediaID = DAOUtil.mapIDToSID(spq.getMediaID(), new MediaFieldInfo());</span>
<span class="fc" id="L450">			spq.setDEMediaID(spq.getMediaID());</span>
<span class="fc" id="L451">			spq.setMediaID(sidMediaID);</span>
<span class="fc" id="L452">			spq.setSkillsFromDB(getSkillIDsForSPQueue(spQueueID));</span>
<span class="fc" id="L453">			return spq;</span>

<span class="nc" id="L455">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L456">			throw e;</span>
<span class="nc" id="L457">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L458">			throw e;</span>
		} finally {
<span class="pc" id="L460">			dao.cleanUp();</span>
		}
	}

	/**
	 * Returns the SID field of the SPQueue (legacy)
	 *
	 * @param spID
	 * @param queueID
	 * @return
	 * @throws JdmoException
	 */
	public static ID getSPQueueID(ID spID, ID queueID) throws JdmoException {
<span class="fc" id="L473">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="fc" id="L475">			StringBuffer pStmt = new StringBuffer();</span>
<span class="fc" id="L476">			pStmt.append(&quot;select SPQUEUE.SID from SPQUEUE, SP, QUEUE &quot;);</span>
<span class="fc" id="L477">			pStmt.append(&quot;where SPQUEUE.SPID=SP.ID&quot;);</span>
<span class="fc" id="L478">			pStmt.append(&quot; and  SPQUEUE.QUEUEID=QUEUE.ID&quot;);</span>
<span class="fc" id="L479">			pStmt.append(&quot; and  QUEUE.SID=?&quot;);</span>
<span class="fc" id="L480">			pStmt.append(&quot; and  SP.SID=?&quot;);</span>

<span class="fc" id="L482">			JdmoQuery jq = dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="fc" id="L483">			jq.setParID(1, queueID);</span>
<span class="fc" id="L484">			jq.setParID(2, spID);</span>
<span class="fc" id="L485">			JdmoRowset rs = dmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="fc" id="L486">			ID spQueueID = null;</span>
<span class="pc bpc" id="L487" title="1 of 2 branches missed.">			if (rs.next()) {</span>
<span class="fc" id="L488">				spQueueID = new ID(rs.getInt(1));</span>
			}
<span class="fc" id="L490">			rs.close();</span>
<span class="fc" id="L491">			return spQueueID;</span>
		} finally {
<span class="pc" id="L493">			dmo.cleanUp();</span>
		}
	}

	/*
	 * Returns the actual ID field of the SPQueue (getSPqueueID was already
	 * take)
	 */
	public static boolean hasSPQueues(ID spID) throws JdmoException {
<span class="nc" id="L502">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L504">			StringBuffer pStmt = new StringBuffer();</span>
<span class="nc" id="L505">			pStmt.append(&quot;select SPQUEUE.SID from SPQUEUE, SP &quot;);</span>
<span class="nc" id="L506">			pStmt.append(&quot; where SPQUEUE.SPID=SP.ID &quot;);</span>
<span class="nc" id="L507">			pStmt.append(&quot; and  SP.SID=?&quot;);</span>

<span class="nc" id="L509">			JdmoQuery jq = dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L510">			jq.setParID(1, spID);</span>
<span class="nc" id="L511">			JdmoRowset rs = dmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L512">			ID spQueueID = null;</span>
<span class="nc" id="L513">			boolean bHasSpQueue = false;</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L515">				bHasSpQueue = true;</span>
			}
<span class="nc" id="L517">			rs.close();</span>
<span class="nc" id="L518">			return bHasSpQueue;</span>
		} finally {
<span class="nc" id="L520">			dmo.cleanUp();</span>
		}
	}

	/*
	 * Returns the actual ID field of the SPQueue (getSPqueueID was already
	 * take)
	 */
	public static ID getSPQueueStringID(ID spID, ID queueID) throws JdmoException {
<span class="nc" id="L529">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L531">			StringBuffer pStmt = new StringBuffer();</span>
<span class="nc" id="L532">			pStmt.append(&quot;select SPQUEUE.SID from SPQUEUE, SP, QUEUE &quot;);</span>
<span class="nc" id="L533">			pStmt.append(&quot;where SPQUEUE.SPID=SP.ID&quot;);</span>
<span class="nc" id="L534">			pStmt.append(&quot; and  SPQUEUE.QUEUEID=QUEUE.ID&quot;);</span>
<span class="nc" id="L535">			pStmt.append(&quot; and  QUEUE.SID=?&quot;);</span>
<span class="nc" id="L536">			pStmt.append(&quot; and  SP.SID=?&quot;);</span>

<span class="nc" id="L538">			JdmoQuery jq = dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L539">			jq.setParID(1, queueID);</span>
<span class="nc" id="L540">			jq.setParID(2, spID);</span>
<span class="nc" id="L541">			JdmoRowset rs = dmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L542">			ID spQueueID = null;</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L544">				spQueueID = new ID(rs.getString(1));</span>
			}
<span class="nc" id="L546">			rs.close();</span>
<span class="nc" id="L547">			return spQueueID;</span>
		} finally {
<span class="nc" id="L549">			dmo.cleanUp();</span>
		}
	}

	/**
	 * Returns whether patience is to be used in ASA calculations for unskilled
	 * SPs instead of abandons.
	 */
	public static boolean isPatienceUsedInUnskilledASACalcs() {
<span class="nc" id="L558">		return USE_PATIENCE_IN_UNSKILLED_ASA_CALCS;</span>
	}

	/*
	 * public static void deleteSPQueue(ID spQueueId) throws JdmoException { if
	 * (spQueueId == null) return; Jdmo jdmo = new Jdmo(); try { Object[] param
	 * = new Object[1]; param[0] = spQueueId; // remove skills attached to
	 * spqueue jdmo.executePCommand(
	 * &quot;delete from SPQUEUESKILL where SPQUEUEID = (SELECT ID FROM SPQUEUE WHERE SID=?)&quot;
	 * , param); // remove spqueue
	 * jdmo.executePCommand(&quot;delete from SPQUEUE where SID=?&quot;, param); } finally
	 * { jdmo.cleanUp(); } }
	 */
	// Deletes spqueue and the skills attached to the spqueue
	public void deleteSPQueue(ID spQueueId) throws BbmRemoveException {
<span class="nc" id="L573">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L575">			String query = &quot;select id, SPID, MEDIAID from SPQUEUE where sid = &quot; + spQueueId.toString();</span>
<span class="nc" id="L576">			JdmoRowset r = m_dmo.createRowset(query);</span>
<span class="nc" id="L577">			ID SPID = null;</span>
<span class="nc" id="L578">			ID MediaID = null;</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L580">				SPID = r.getID(&quot;SPID&quot;);</span>
<span class="nc" id="L581">				MediaID = r.getID(&quot;MEDIAID&quot;);</span>
				break;
			}

			// delete parent queue in case this is a child queue
			// first check if there are other child queue has the same parent
<span class="nc" id="L587">			String subQueues = &quot;select count(*) as count from spqueue, Queue, sp where SPQUEUE.QUEUEID = QUEUE.ID AND SPQUEUE.SPID = SP.ID &quot;</span>
					+ &quot;AND parentqueueid in (&quot;
					+ &quot;select parentqueueid from QUEUE, SPQUEUE &quot;
					+ &quot;where SPQUEUE.QUEUEID = QUEUE.ID AND SPQUEUE.SID = &quot;
					+ spQueueId
					+ &quot;) AND SP.PARENTSPID in (&quot;
					+ &quot; select SP.PARENTSPID from SP, SPQUEUE &quot;
					+ &quot;where SPQUEUE.SPID = SP.ID AND SPQUEUE.SID = &quot;
					+ spQueueId + &quot;)&quot;;
<span class="nc" id="L596">			JdmoRowset subRow = m_dmo.createRowset(subQueues);</span>
<span class="nc" id="L597">			int count = 0;</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">			if (subRow.next()) {</span>
<span class="nc" id="L599">				count = subRow.getInt(&quot;count&quot;);</span>
			}
<span class="nc" id="L601">			subRow.close();</span>

			// there are no other queues, delete the parent
<span class="nc bnc" id="L604" title="All 2 branches missed.">			if (count == 1) {</span>
<span class="nc" id="L605">				String whereParent = &quot;select spqueue.ID ID from spqueue, Queue, sp where SPQUEUE.QUEUEID = QUEUE.ID AND SPQUEUE.SPID = SP.ID &quot;</span>
						+ &quot;AND queueid in (&quot;
						+ &quot;select parentqueueid from QUEUE, SPQUEUE &quot;
						+ &quot;where SPQUEUE.QUEUEID = QUEUE.ID AND SPQUEUE.SID = &quot;
						+ spQueueId
						+ &quot;) AND SP.ID in (&quot;
						+ &quot; select SP.PARENTSPID from SP, SPQUEUE &quot;
						+ &quot;where SPQUEUE.SPID = SP.ID AND SPQUEUE.SID = &quot;
						+ spQueueId + &quot;)&quot;;
<span class="nc" id="L614">				DAOUtil.deleteObjects(dmo, &quot;SPQUEUE&quot;, whereParent);</span>
			}

<span class="nc" id="L617">			String where = &quot;select id from SPQUEUE where sid = &quot; + spQueueId.toString();</span>
<span class="nc" id="L618">			DAOUtil.deleteObjects(dmo, &quot;SPQUEUE&quot;, where);</span>
<span class="nc" id="L619">			deleteAllSkillsForSPQueue(spQueueId);</span>

<span class="nc bnc" id="L621" title="All 4 branches missed.">			if (SPID != null &amp;&amp; MediaID != null) {</span>
<span class="nc" id="L622">				Collection&lt;SPQueue&gt; spQueues = null;</span>
				try {
<span class="nc" id="L624">					spQueues = getNonCombinedSPQueuesByMediaAndSP(SPID, MediaID);</span>
<span class="nc" id="L625">				} catch (BbmFinderException ex) {</span>

<span class="nc" id="L627">				}</span>
<span class="nc bnc" id="L628" title="All 4 branches missed.">				if (spQueues != null &amp;&amp; spQueues.size() == 0) {</span>
<span class="nc" id="L629">					where = &quot;select id from SPQUEUE where QUEUEID is NULL AND SPID = '&quot; + SPID.toString()</span>
<span class="nc" id="L630">							+ &quot;' AND MediaID = '&quot; + MediaID.toString() + &quot;'&quot;;</span>
<span class="nc" id="L631">					DAOUtil.deleteObjects(dmo, &quot;SPQUEUE&quot;, where);</span>
				}
			}

<span class="nc" id="L635">		} catch (JdmoException ex) {</span>
<span class="nc" id="L636">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc" id="L638">			dmo.cleanUp();</span>
<span class="nc" id="L639">		}</span>
<span class="nc" id="L640">	}</span>

	/**
	 * Returns all SPQueues that are associated with scheduling periods for the specified campaign, date range, and queues
	 * Note that combined queues are not returned. Only SPQueues with non-null queue IDs are returned
	 * @param campaignID - Consider only SP that are associated with this campaign
	 * @param queueIDs - Consider only SPQueues that have this queue. The collection should not contain nulls
	 * @param start - Date range start (inclusive)
	 * @param end - Date range end (exclusive)
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;SPQueue&gt; getSPQueues(ID campaignID, Collection&lt;? extends ID&gt; queueIDs, Date start, Date end)
			throws BbmFinderException {
<span class="nc bnc" id="L654" title="All 8 branches missed.">		if (queueIDs == null || queueIDs.isEmpty() || start == null || end == null) {</span>
<span class="nc" id="L655">			return Collections.emptyList();</span>
		}

		try {
<span class="nc" id="L659">			List&lt;ID&gt; sqpIDs = getSPQueueIDs(campaignID, queueIDs, start, end);</span>
<span class="nc" id="L660">			return getSPQueuesByIDs(sqpIDs);</span>
<span class="nc" id="L661">		} catch (JdmoException e) {</span>
<span class="nc" id="L662">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L664">			m_dmo.cleanUp();</span>
		}
	}

	private List&lt;ID&gt; getSPQueueIDs(ID campaignID, Collection&lt;? extends ID&gt; queueIDs, Date start, Date end) throws JdmoException {

<span class="nc" id="L670">		String sql = &quot;select  SPQ.SID from CAMPAIGN C &quot; +</span>
				&quot;inner join SP on SP.CAMPAIGNID = C.ID &quot; +
				&quot;inner join SPQUEUE SPQ on SPQ.SPID = SP.ID &quot; +
				&quot;inner join QUEUE Q on Q.ID = SPQ.QUEUEID &quot; +
				&quot;where &quot; +
<span class="nc" id="L675">				&quot;	C.SID = ? and fromdate &lt; ? and todate &gt; ? and Q.SID in &quot; + m_dmo.createInClause(queueIDs);</span>

<span class="nc" id="L677">		JdmoQuery query = m_dmo.createQuery(sql, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L678">		query.setParID(1, campaignID);</span>
<span class="nc" id="L679">		query.setParTimestamp(2, TimeZoneUtil.toTimestamp(end));</span>
<span class="nc" id="L680">		query.setParTimestamp(3, TimeZoneUtil.toTimestamp(start));</span>
		
<span class="nc" id="L682">		JdmoRowset r = m_dmo.createRowset(query, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="nc" id="L684">		List&lt;ID&gt; sqpIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">		while (r.next()) {</span>
<span class="nc" id="L686">			sqpIDs.add(r.getID(1));</span>
		}

<span class="nc" id="L689">		return sqpIDs;</span>
	}

	public Collection&lt;SPQueue&gt; getSPQueuesBySPID(ID SPSID) throws BbmObjectNotFoundException, BbmFinderException {
<span class="fc" id="L693">		return getSPQueuesBySPIDsFixed(Arrays.asList(SPSID));</span>
	}

	/**
	 * Returns all non-combined SPQueues linked to the given Scheduling Periods.  For combined SPQueues in an SP, please
	 * use {@link SPQueueDAO#getCombinedSPQueue(ID, ID)}
	 */
	public Collection&lt;SPQueue&gt; getSPQueuesBySPIDsFixed(Collection&lt;ID&gt; SpSIDs) throws BbmObjectNotFoundException,
			BbmFinderException {

		// Use a map to avoid dupes (two objects with the same id are the same)
<span class="fc" id="L704">		Map&lt;ID, SPQueue&gt; hSPQueues = new HashMap&lt;ID, SPQueue&gt;();</span>
<span class="fc" id="L705">		JdmoRowset r = null;</span>
		try {
<span class="fc" id="L707">			String query = &quot;SELECT spq.ID, spq.SID, spq.SPID, spq.QUEUEID, spq.MEDIAID, spq.SERVICELEVELGOALTYPE, &quot;</span>
					+ &quot;spq.PATIENCE, spq.MAXABANDONSPERCENT, spq.SLANSWERWAITINGTIME, spq.STARTINGBACKLOG, &quot;
					+ &quot;spq.ACTUALORWORKINGHOUR, spq.DELETEONDATE, spq.OVERLOADTHRESHOLD1, spq.OVERLOADTHRESHOLD2, &quot;
					+ &quot;spq.ISQUALITYGOALPERCENTAGE, spq.QUALITYGOALREQUIREMENT, spq.MINIMUMQUALITYSCORE, spq.CONNECTGOAL, &quot;
					+ &quot;SPQ.FTETHRESHOLDOVER,SPQ.FTETHRESHOLDOVERPERCENT,SPQ.FTETHRESHOLDUNDER,SPQ.FTETHRESHOLDUNDERPERCENT,SPQ.LEASTTIMEINTERVAL, &quot;
					+ &quot;s.SID SpSID, m.SID MediaSID, q.SID QueueSID from SP s, SPQUEUE spq, MEDIA m, QUEUE q &quot;
<span class="fc" id="L713">					+ &quot;WHERE s.sid in &quot; + getDMO().createInClause(SpSIDs) + &quot; AND &quot;</span>
					+ &quot;spq.spid = s.id and spq.mediaid = m.id and spq.queueid = q.id&quot;;
<span class="fc" id="L715">			r = m_dmo.createRowset(query);</span>
<span class="fc bfc" id="L716" title="All 2 branches covered.">			while (r.next()) {</span>

<span class="fc" id="L718">				ID DEid = r.getID(&quot;ID&quot;);</span>
<span class="fc" id="L719">				ID theID = r.getID(&quot;SID&quot;);</span>
<span class="fc" id="L720">				ID spSID = r.getID(&quot;SpSID&quot;);</span>
<span class="fc" id="L721">				ID DEMediaID = r.getID(&quot;MEDIAID&quot;);</span>
<span class="fc" id="L722">				ID theMediaID = r.getID(&quot;MediaSID&quot;);</span>
<span class="fc" id="L723">				ID DEQueueID = r.getID(&quot;QueueID&quot;);</span>
<span class="fc" id="L724">				ID theQueueID = r.getID(&quot;QueueSID&quot;);</span>
<span class="fc" id="L725">				int patience = r.getInt(&quot;PATIENCE&quot;);</span>
<span class="fc" id="L726">				float maxAbandonsPercent = r.getFloat(&quot;MAXABANDONSPERCENT&quot;);</span>
<span class="fc" id="L727">				int SLAnswerWaitingTime = r.getInt(&quot;SLANSWERWAITINGTIME&quot;);</span>
<span class="fc" id="L728">				float startingBackLog = r.getFloat(&quot;STARTINGBACKLOG&quot;);</span>
<span class="fc" id="L729">				boolean actualOrWorkingHour = r.getBoolean(&quot;ACTUALORWORKINGHOUR&quot;);</span>
<span class="fc" id="L730">				Date deleteOnDate = r.getTimestamp(&quot;DELETEONDATE&quot;);</span>
<span class="fc" id="L731">				int overloadThreshold1 = r.getInt(&quot;OVERLOADTHRESHOLD1&quot;);</span>
<span class="fc" id="L732">				int overloadThreshold2 = r.getInt(&quot;OVERLOADTHRESHOLD2&quot;);</span>
<span class="fc" id="L733">				boolean isQualityGoalPercentage = r.getBoolean(&quot;ISQUALITYGOALPERCENTAGE&quot;);</span>
<span class="fc" id="L734">				int qualityGoalRequirement = r.getInt(&quot;QUALITYGOALREQUIREMENT&quot;);</span>
<span class="fc" id="L735">				int minimumQualityScore = r.getInt(&quot;MINIMUMQUALITYSCORE&quot;);</span>
<span class="fc" id="L736">				int connectGoal = r.getInt(&quot;CONNECTGOAL&quot;);</span>

<span class="fc" id="L738">				SPQueue pSPQueue = new SPQueue();</span>
<span class="fc" id="L739">				pSPQueue.setIsPatienceUsedinUnskilledASACalcs(USE_PATIENCE_IN_UNSKILLED_ASA_CALCS);</span>
<span class="fc" id="L740">				pSPQueue.setID(theID);</span>
<span class="fc" id="L741">				pSPQueue.setFieldValue(SPQueueFieldInfo.SPQUEUE_ID, DEid);</span>
<span class="fc" id="L742">				pSPQueue.setSpID(spSID);</span>
<span class="fc" id="L743">				pSPQueue.setQueueID(theQueueID);</span>
<span class="fc" id="L744">				pSPQueue.setDEQueueID(DEQueueID);</span>
<span class="fc" id="L745">				pSPQueue.setMediaID(theMediaID);</span>
<span class="fc" id="L746">				pSPQueue.setDEMediaID(DEMediaID);</span>
<span class="fc" id="L747">				pSPQueue.setPatience(patience);</span>
<span class="fc" id="L748">				pSPQueue.setMaxAbandonsPercent(maxAbandonsPercent);</span>
<span class="fc" id="L749">				pSPQueue.setServiceLevelGoalType(r.getBoolean(&quot;SERVICELEVELGOALTYPE&quot;));</span>
<span class="fc" id="L750">				pSPQueue.setSlAnswerWaitingTime(SLAnswerWaitingTime);</span>
<span class="fc" id="L751">				pSPQueue.setStartingBacklog(startingBackLog);</span>
<span class="fc" id="L752">				pSPQueue.setActualOrWorkingHour(actualOrWorkingHour);</span>
<span class="fc" id="L753">				pSPQueue.setDeleteOnDate(deleteOnDate);</span>
<span class="fc" id="L754">				pSPQueue.setOverloadThreshold1(overloadThreshold1);</span>
<span class="fc" id="L755">				pSPQueue.setOverloadThreshold2(overloadThreshold2);</span>
<span class="fc" id="L756">				pSPQueue.setIsQualityGoalPercentage(isQualityGoalPercentage);</span>
<span class="fc" id="L757">				pSPQueue.setQualityGoalRequirement(qualityGoalRequirement);</span>
<span class="fc" id="L758">				pSPQueue.setMinimumQualityScore(minimumQualityScore);</span>
<span class="fc" id="L759">				pSPQueue.setConnectGoal(connectGoal);</span>
<span class="fc" id="L760">				pSPQueue.setFTEThresholdOver(r.getInt(&quot;FTETHRESHOLDOVER&quot;));</span>
<span class="fc" id="L761">				pSPQueue.setFTEThresholdOverPercentage(r.getBoolean(&quot;FTETHRESHOLDOVERPERCENT&quot;));</span>
<span class="fc" id="L762">				pSPQueue.setFTEThresholdUnder(r.getInt(&quot;FTETHRESHOLDUNDER&quot;));</span>
<span class="fc" id="L763">				pSPQueue.setFTEThresholdUnderPercentage(r.getBoolean(&quot;FTETHRESHOLDUNDERPERCENT&quot;));</span>
<span class="fc" id="L764">				pSPQueue.setLeastTimeInterval(r.getInt(&quot;LEASTTIMEINTERVAL&quot;));</span>
<span class="fc" id="L765">				hSPQueues.put(theID, pSPQueue);</span>
<span class="fc" id="L766">			}</span>
			//load the skills for all the spqueues together rathen than make a call for each of them. 
			// This nearly triples the performance of this method for a get of few hundred SPQueues.
<span class="fc" id="L769">			loadSkillIDsIntoSPQueues(hSPQueues.values());</span>
			
<span class="fc" id="L771">			return new ArrayList&lt;SPQueue&gt;(hSPQueues.values());</span>

<span class="nc" id="L773">		} catch (JdmoException e) {</span>
<span class="nc" id="L774">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L776">			try {</span>
<span class="pc" id="L777">				r.close();</span>
<span class="nc" id="L778">			} catch (JdmoException e) {</span>
<span class="pc" id="L779">			}</span>
<span class="pc" id="L780">			m_dmo.cleanUp();</span>

		}
	}

	/**
	 * Persists the skills of each of the given spqueues (creates records in the
	 * spqueueskill table).
	 *
	 * @param spQueueSkillIDMap SPQueue ID (DEID) -&gt; Colleciton of linked skill IDs associated
	 *                          to the spqueue (DEIDs)
	 */
	protected void linkSkillsToSPQueues(Map&lt;ID, Collection&lt;ID&gt;&gt; spQueueSkillIDMap) throws BbmCreateException {
		try {
<span class="nc bnc" id="L794" title="All 4 branches missed.">			if (spQueueSkillIDMap == null || spQueueSkillIDMap.isEmpty()) {</span>
<span class="nc" id="L795">				return;</span>
			}
<span class="nc" id="L797">			deleteAllSkillsForSPQueues(spQueueSkillIDMap.keySet());</span>
<span class="nc" id="L798">			HashMap&lt;String, ID&gt; columnValueMap = new HashMap&lt;String, ID&gt;();</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">			for (ID spQueueID : spQueueSkillIDMap.keySet()) {// TODO: map IDs to</span>
				// DEIDs?
<span class="nc bnc" id="L801" title="All 2 branches missed.">				for (ID skillID : spQueueSkillIDMap.get(spQueueID)) {</span>
<span class="nc" id="L802">					columnValueMap.put(&quot;SKILLID&quot;, skillID);</span>
<span class="nc" id="L803">					columnValueMap.put(&quot;SPQUEUEID&quot;, spQueueID);</span>
<span class="nc" id="L804">					getDMO().addBatchInsert(&quot;SPQUEUESKILL&quot;, columnValueMap);</span>
<span class="nc" id="L805">					columnValueMap.clear();</span>
<span class="nc" id="L806">				}</span>
<span class="nc" id="L807">			}</span>
<span class="nc" id="L808">			getDMO().executeBatch();</span>
<span class="nc" id="L809">		} catch (JdmoException ex) {</span>
<span class="nc" id="L810">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L811">		} catch (BbmRemoveException ex) {</span>
<span class="nc" id="L812">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L813">		}</span>
<span class="nc" id="L814">	}</span>

	public void linkSkillsToSPQueue(ID spQueueID, Collection&lt;ID&gt; colSkillIDs) throws BbmCreateException {
<span class="fc" id="L817">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="fc" id="L819">			deleteAllSkillsForSPQueue(spQueueID);</span>
<span class="pc bpc" id="L820" title="1 of 4 branches missed.">			if (colSkillIDs == null || colSkillIDs.size() &lt; 1) {</span>
<span class="fc" id="L821">				return;</span>
			}
<span class="fc bfc" id="L823" title="All 2 branches covered.">			for (ID skillID : colSkillIDs) {</span>
<span class="fc" id="L824">				linkSkillToSPQueue(spQueueID, skillID);</span>
<span class="fc" id="L825">			}</span>
<span class="nc" id="L826">		} catch (BbmCreateException ex) {</span>
<span class="nc" id="L827">			throw ex;</span>
<span class="nc" id="L828">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L829">			throw new BbmCreateException(e);</span>
		} finally {
<span class="pc" id="L831">			jdmo.cleanUp();</span>
<span class="fc" id="L832">		}</span>
<span class="fc" id="L833">	}</span>

	private void linkSkillToSPQueue(ID spQueueID, ID skillID) throws BbmCreateException {
<span class="fc" id="L836">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="fc" id="L838">			String idStr = DAOUtil.getDEID(jdmo);</span>
<span class="fc" id="L839">			ID skillDEID = DAOUtil.mapIDToDEID(skillID, new SkillFieldInfo());</span>
<span class="fc" id="L840">			ID spqueueDEID = DAOUtil.mapIDToDEID(spQueueID, new SPQueueFieldInfo());</span>
<span class="fc" id="L841">			ID createdID = new ID(idStr);</span>
<span class="fc" id="L842">			String strCreate = &quot;INSERT into SPQUEUESKILL (ID, SKILLID, SPQUEUEID) values ('&quot; + createdID + &quot;', '&quot;</span>
					+ skillDEID + &quot;', '&quot; + spqueueDEID + &quot;')&quot;;
<span class="fc" id="L844">			jdmo.executeCommand(strCreate);</span>
<span class="nc" id="L845">		} catch (JdmoException ex) {</span>
<span class="nc" id="L846">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L847">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L848">			throw new BbmCreateException(e);</span>
		} finally {
<span class="pc" id="L850">			jdmo.cleanUp();</span>
<span class="fc" id="L851">		}</span>
<span class="fc" id="L852">	}</span>

	/**
	 * Removes all of the skills associated to each of the given SP Queues.
	 *
	 * @param spQueueIDs - The IDs of the spqueues from which we want to clear the
	 *                   linked skills (DEIDs)
	 */
	private void deleteAllSkillsForSPQueues(Collection&lt;ID&gt; spQueueIDs) throws BbmRemoveException {
<span class="nc" id="L861">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L863">			String where = &quot;select ID from SPQUEUESKILL where SPQUEUEID IN &quot; + getDMO().createInClause(spQueueIDs);</span>
<span class="nc" id="L864">			DAOUtil.deleteObjects(dmo, &quot;SPQUEUESKILL&quot;, where);</span>
<span class="nc" id="L865">		} catch (JdmoException ex) {</span>
<span class="nc" id="L866">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc" id="L868">			dmo.cleanUp();</span>
<span class="nc" id="L869">		}</span>
<span class="nc" id="L870">	}</span>

	private void deleteAllSkillsForSPQueue(ID spQueueID) throws BbmRemoveException {
<span class="fc" id="L873">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="fc" id="L875">			String where = &quot;select ID from SPQUEUESKILL where SPQUEUEID = (SELECT ID from SPQUEUE WHERE SID = &quot; + spQueueID</span>
					+ &quot;)&quot;;
<span class="fc" id="L877">			DAOUtil.deleteObjects(dmo, &quot;SPQUEUESKILL&quot;, where);</span>
<span class="nc" id="L878">		} catch (JdmoException ex) {</span>
<span class="nc" id="L879">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="pc" id="L881">			dmo.cleanUp();</span>
<span class="fc" id="L882">		}</span>
<span class="fc" id="L883">	}</span>

	/**
	 * Returns a list of combined SPQueues associated to (i.e. having the same
	 * SP and media ID of) the given list of spQueues.
	 */
	public Collection&lt;SPQueue&gt; getCombinedSPQueues(Collection&lt;SPQueue&gt; spQueues) throws BbmFinderException {
<span class="nc" id="L890">		HashSet&lt;ID&gt; mediaIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L891">		HashSet&lt;ID&gt; spIDs = new HashSet&lt;ID&gt;();</span>
		try {
<span class="nc bnc" id="L893" title="All 2 branches missed.">			for (SPQueue spQueue : spQueues) {</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">				if (spQueue.getSpID() != null) {</span>
<span class="nc" id="L895">					spIDs.add(spQueue.getSpID());</span>
				}
<span class="nc bnc" id="L897" title="All 2 branches missed.">				if (spQueue.getMediaID() != null) {</span>
<span class="nc" id="L898">					mediaIDs.add(spQueue.getMediaID());</span>
				}
<span class="nc" id="L900">			}</span>
<span class="nc" id="L901">			Map&lt;ID, ID&gt; mediaIDMap = DAOUtil.mapIDsToDEIDs(mediaIDs, new MediaFieldInfo());</span>
<span class="nc" id="L902">			Map&lt;ID, ID&gt; spIDMap = DAOUtil.mapIDsToDEIDs(spIDs, new SchedulingPeriodFieldInfo());</span>
<span class="nc" id="L903">			return getObjects(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_SPID) + &quot; IN &quot;</span>
<span class="nc" id="L904">					+ getDMO().createInClause(spIDMap.values()) + &quot; AND &quot;</span>
<span class="nc" id="L905">					+ getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID) + &quot; IS NULL AND &quot;</span>
<span class="nc" id="L906">					+ getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_MEDIAID) + &quot; IN &quot;</span>
<span class="nc" id="L907">					+ getDMO().createInClause(mediaIDMap.values()));</span>
<span class="nc" id="L908">		} catch (JdmoException e) {</span>
<span class="nc" id="L909">			throw new BbmFinderException(e);</span>
		}
	}

	/*
	 * Returns the combined SPQueue object given a scheduling period ID and a
	 * media ID
	 */
	public SPQueue getCombinedSPQueue(ID spID, ID mediaID) throws BbmFinderException {
<span class="fc" id="L918">		spID = DAOUtil.mapIDToDEID(spID, new SchedulingPeriodFieldInfo());</span>
<span class="fc" id="L919">		mediaID = DAOUtil.mapIDToDEID(mediaID, new MediaFieldInfo());</span>

<span class="fc" id="L921">		Collection&lt;SPQueue&gt; spQueues = getObjects(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_MEDIAID)</span>
<span class="fc" id="L922">				+ JdmoUtil.getEqualityOperator(mediaID, true) + JdmoUtil.asSqlLiteral(mediaID) + &quot; AND &quot;</span>
<span class="fc" id="L923">				+ getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_SPID) + &quot; = &quot; + JdmoUtil.asSqlLiteral(spID) + &quot; AND &quot;</span>
<span class="fc" id="L924">				+ getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID) + &quot; IS NULL&quot;);</span>
<span class="pc bpc" id="L925" title="1 of 4 branches missed.">		if (spQueues != null &amp;&amp; spQueues.size() &gt; 0) {</span>
<span class="fc" id="L926">			return spQueues.iterator().next();</span>
		}
<span class="fc" id="L928">		return null;</span>
	}

	/*
	 * Returns the non-combined SPQueues belonging to the given SP with the
	 * specified media ID. If a null media ID is specified, it will return all
	 * non-combined SPQueues in belonging to the SP.
	 */
	public Collection&lt;SPQueue&gt; getNonCombinedSPQueuesByMediaAndSP(ID spID, ID mediaID) throws BbmFinderException {

<span class="nc" id="L938">		spID = DAOUtil.mapIDToDEID(spID, new SchedulingPeriodFieldInfo());</span>
<span class="nc" id="L939">		mediaID = DAOUtil.mapIDToDEID(mediaID, new MediaFieldInfo());</span>
<span class="nc" id="L940">		StringBuffer query = new StringBuffer();</span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">		if (mediaID != null) {</span>
<span class="nc" id="L942">			query.append(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_MEDIAID)).append(&quot; = &quot;)</span>
<span class="nc" id="L943">					.append(JdmoUtil.asSqlLiteral(mediaID)).append(&quot; AND &quot;);</span>
		}
<span class="nc" id="L945">		query.append(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_SPID)).append(&quot; = &quot;)</span>
<span class="nc" id="L946">				.append(JdmoUtil.asSqlLiteral(spID)).append(&quot; AND &quot;)</span>
<span class="nc" id="L947">				.append(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID)).append(&quot; IS NOT NULL&quot;);</span>
<span class="nc" id="L948">		return getObjects(query.toString());</span>
	}

	// This returns a collection of SP Queues given their sids
	public Collection&lt;SPQueue&gt; getSPQueuesByIDs(Collection&lt;? extends ID&gt; spQueueIDs) throws BbmFinderException {
<span class="fc" id="L953">		return getObjectsByIDs(spQueueIDs);</span>
	}

	/**
	 * Returns a collection of SPQueues corresponding to the Scheduling Periods
	 * having the specified SIDs.
	 *
	 * @Deprecated this works very differently from getSPQueuesBySPID()and is
	 * probably no good The main difference that I can see is that
	 * getSPQueuesBySPID (and consequently getSPQueuesBySPIDsFixed)
	 * is that these other methods will load the associated skill
	 * IDs as part of the SPQueue value objects, whereas this method
	 * does not.
	 */
	@Deprecated
	public Collection&lt;SPQueue&gt; getSPQueuesBySPIDs(Collection&lt;? extends ID&gt; spIDs) throws BbmFinderException {
<span class="fc" id="L969">		SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO();</span>
		try {
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L972">			Collection&lt;SchedulingPeriod&gt; sps = spDAO.getObjectsByIDs(spIDs);</span>
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L974">			Collection&lt;ID&gt; spDEIDs = ValueObjectUtil.getFieldObjectCol(SchedulingPeriodFieldInfo.SP_DEID, sps);</span>
<span class="fc" id="L975">			return super.getObjects(&quot;SPID IN &quot; + getDMO().createInClause(spDEIDs));</span>
<span class="nc" id="L976">		} catch (JdmoException e) {</span>
<span class="nc" id="L977">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L979">			spDAO.cleanUp();</span>
		}
	}

	/**
	 * Returns a map containing the skill IDs linked to the given SPQueue IDs.
	 * Key - spQueueID, Value - Collection of Skill IDs linked to the SPQueue.
	 */
	private HashMap&lt;ID, Collection&lt;ID&gt;&gt; getSkillIDsForSPQueues(Collection&lt;ID&gt; spQueueIDs) throws BbmFinderException {
<span class="pc bpc" id="L988" title="1 of 2 branches missed.">		if (spQueueIDs == null) {</span>
<span class="nc" id="L989">			return new HashMap&lt;ID, Collection&lt;ID&gt;&gt;();</span>
		}

<span class="fc" id="L992">		Jdmo jdmo = new Jdmo();</span>
<span class="fc" id="L993">		HashMap&lt;ID, Collection&lt;ID&gt;&gt; result = new HashMap&lt;ID, Collection&lt;ID&gt;&gt;();</span>
<span class="fc" id="L994">		JdmoRowset rs = null;</span>
		try {
<span class="fc" id="L996">			StringBuffer pStmt = new StringBuffer();</span>
<span class="fc" id="L997">			pStmt.append(&quot; select spq.SID SPQUEUEID, s.SID SKILLID from &quot;);</span>
<span class="fc" id="L998">			pStmt.append(&quot; SPQUEUESKILL q,SKILL s,SPQUEUE spq &quot;);</span>
<span class="fc" id="L999">			pStmt.append(&quot; where q.SKILLID=s.ID and &quot;);</span>
<span class="fc" id="L1000">			pStmt.append(&quot; q.SPQUEUEID=spq.id and &quot;);</span>
<span class="fc" id="L1001">			pStmt.append(&quot; spq.sid IN &quot;);</span>
<span class="fc" id="L1002">			pStmt.append(jdmo.createInClause(spQueueIDs));</span>

<span class="fc" id="L1004">			JdmoQuery jq1 = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="fc" id="L1005">			rs = jdmo.createRowset(jq1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="fc bfc" id="L1007" title="All 2 branches covered.">			while (rs.next()) {</span>
<span class="fc" id="L1008">				ID skillID = rs.getID(&quot;SKILLID&quot;);</span>
<span class="fc" id="L1009">				ID spQueueID = rs.getID(&quot;SPQUEUEID&quot;);</span>
<span class="pc bpc" id="L1010" title="1 of 2 branches missed.">				if (result.containsKey(spQueueID) == false) {</span>
<span class="fc" id="L1011">					result.put(spQueueID, new HashSet&lt;ID&gt;());</span>
				}
<span class="fc" id="L1013">				result.get(spQueueID).add(skillID);</span>
<span class="fc" id="L1014">			}</span>
<span class="fc" id="L1015">			return result;</span>
<span class="nc" id="L1016">		} catch (Exception ex) {</span>
<span class="nc" id="L1017">			throw new BbmFinderException(ex);</span>
		} finally {
<span class="nc" id="L1019">			try {</span>
<span class="pc" id="L1020">				rs.close();</span>
<span class="nc" id="L1021">			} catch (JdmoException e) {</span>
<span class="pc" id="L1022">			}</span>
<span class="pc" id="L1023">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Returns a collection of skill IDs linked to the given SPQueue.
	 */
	private Collection&lt;ID&gt; getSkillIDsForSPQueue(ID spQueueID) throws BbmFinderException {
<span class="fc" id="L1031">		HashMap&lt;ID, Collection&lt;ID&gt;&gt; result = getSkillIDsForSPQueues(Collections.singleton(spQueueID));</span>
<span class="pc bpc" id="L1032" title="2 of 6 branches missed.">		if (result == null || result.containsKey(spQueueID) == false || result.get(spQueueID) == null) {</span>
<span class="fc" id="L1033">			return Collections.emptyList();</span>
		}
<span class="fc" id="L1035">		return result.get(spQueueID);</span>
	}

	/**
	 * Loads the skill IDs that are linked to the given SPQueues and stores the
	 * associated skill IDs on the related SPQueue value objects. These can
	 * later be retrieved from the SPQueue via SPQueue.getSkills()
	 */
	private void loadSkillIDsIntoSPQueues(Collection&lt;SPQueue&gt; spQueues) throws BbmFinderException {
<span class="fc" id="L1044">		Collection&lt;ID&gt; spQueueIDs = ValueObjectUtil.getIDFromObjects(spQueues);</span>
<span class="fc" id="L1045">		HashMap&lt;ID, Collection&lt;ID&gt;&gt; spQueueSkillIDMap = getSkillIDsForSPQueues(spQueueIDs);</span>
<span class="fc bfc" id="L1046" title="All 2 branches covered.">		for (SPQueue spQueue : spQueues) {</span>
<span class="fc" id="L1047">			Collection&lt;ID&gt; skillIDs = spQueueSkillIDMap.get(spQueue.getID());</span>
<span class="fc bfc" id="L1048" title="All 2 branches covered.">			if (skillIDs != null) {</span>
<span class="fc" id="L1049">				spQueue.setSkillsFromDB(skillIDs);</span>
			} else {
<span class="fc" id="L1051">				spQueue.setSkillsFromDB(new ArrayList&lt;ID&gt;());</span>
			}
<span class="fc" id="L1053">		}</span>
<span class="fc" id="L1054">	}</span>

	public Collection&lt;String&gt; getSkillNamesMappedToQueue(ID idQueue, ID spID) throws BbmFinderException {

<span class="nc bnc" id="L1058" title="All 4 branches missed.">		if (idQueue == null || spID == null) {</span>
<span class="nc" id="L1059">			return new ArrayList&lt;String&gt;();</span>
		}
<span class="nc" id="L1061">		List&lt;String&gt; retVal = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L1063">		ID deSPID = DAOUtil.mapIDToDEID(spID, new SchedulingPeriodFieldInfo());</span>
<span class="nc" id="L1064">		ID deIDQueue = DAOUtil.mapIDToDEID(idQueue, new QueueFieldInfo());</span>
<span class="nc" id="L1065">		JdmoRowset r = null;</span>
		try {
<span class="nc" id="L1067">			String query = &quot;Select distinct s.NAME &quot; + &quot;from SKILL s, SPQUEUESKILL sqs, SPQUEUE spq &quot;</span>
<span class="nc" id="L1068">					+ &quot;where queueid in (select id from queue where parentqueueid = &quot; + JdmoUtil.asSqlLiteral(deIDQueue)</span>
					+ &quot;)&quot; + &quot; and sqs.SPQUEUEID = spq.ID and sqs.SKILLID = s.ID and s.DELETEONDATE IS NULL&quot;
<span class="nc" id="L1070">					+ &quot; and spid in (select id from sp where parentspid = &quot; + JdmoUtil.asSqlLiteral(deSPID) + &quot;)&quot;;</span>

<span class="nc" id="L1072">			r = m_dmo.createRowset(query);</span>

<span class="nc bnc" id="L1074" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L1075">				String name = r.getString(&quot;NAME&quot;);</span>
<span class="nc" id="L1076">				retVal.add(name);</span>
<span class="nc" id="L1077">			}</span>
<span class="nc" id="L1078">			return retVal;</span>

<span class="nc" id="L1080">		} catch (JdmoException e) {</span>
<span class="nc" id="L1081">			e.printStackTrace();</span>
<span class="nc" id="L1082">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1084">			try {</span>
<span class="nc" id="L1085">				r.close();</span>
<span class="nc" id="L1086">			} catch (JdmoException e) {</span>
<span class="nc" id="L1087">			}</span>
<span class="nc" id="L1088">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * Given an SP ID, return a Map that maps each queue SID to its skill SID.
	 * If the SP has a queue that is not linked to a skill, then the queue is
	 * not included in the map. We assume that an SP queue can only be linked to
	 * a single skill.
	 *
	 * @param spID - the SID of the scheduling period.
	 * @return A Map that maps each queue SID to its skill SID.
	 * @throws BbmFinderException
	 */
	public Map&lt;ID, ID&gt; getQueueIDToSkillMap(ID spID) throws BbmFinderException {
<span class="pc bpc" id="L1103" title="1 of 2 branches missed.">		if (spID == null) {</span>
<span class="nc" id="L1104">			return new HashMap&lt;ID, ID&gt;();</span>
		}

<span class="fc" id="L1107">		Map&lt;ID, ID&gt; result = new HashMap&lt;ID, ID&gt;();</span>

<span class="fc" id="L1109">		String query = &quot;select Q.SID QSID, S.SID SSID &quot; + &quot;from SPQUEUESKILL SPQS &quot;</span>
				+ &quot;join SPQUEUE SPQ on SPQ.ID = SPQS.SPQUEUEID &quot; + &quot;join QUEUE Q on Q.ID = SPQ.QUEUEID &quot;
				+ &quot;join SKILL S on S.ID = SPQS.SKILLID &quot; + &quot;join SP on SP.SID=&quot; + spID + &quot; &quot; + &quot;where SPQ.SPID=SP.ID&quot;;
<span class="fc" id="L1112">		JdmoRowset r = null;</span>
		try {
<span class="fc" id="L1114">			r = m_dmo.createRowset(query);</span>
<span class="fc bfc" id="L1115" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L1116">				ID queueID = r.getID(&quot;QSID&quot;);</span>
<span class="fc" id="L1117">				ID skillID = r.getID(&quot;SSID&quot;);</span>
<span class="fc" id="L1118">				result.put(queueID, skillID);</span>
<span class="fc" id="L1119">			}</span>

<span class="fc" id="L1121">			r.close();</span>
<span class="fc" id="L1122">			return result;</span>
<span class="nc" id="L1123">		} catch (JdmoException e) {</span>
<span class="nc" id="L1124">			e.printStackTrace();</span>
<span class="nc" id="L1125">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1127">			try {</span>
<span class="pc" id="L1128">				r.close();</span>
<span class="nc" id="L1129">			} catch (JdmoException e) {</span>
<span class="pc" id="L1130">			}</span>
<span class="pc" id="L1131">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * Returns a collection of SPQueues associated with the given Queues
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public Collection&lt;SPQueue&gt; getSPQueuesByQueues(Collection&lt;Queue&gt; queues) throws BbmFinderException {
<span class="nc" id="L1140">		SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO();</span>
<span class="nc" id="L1141">		QueueFieldInfo queueFieldInfo = new QueueFieldInfo();</span>
		try {
<span class="nc" id="L1143">			Collection&lt;ID&gt; queueSIDs = ValueObjectUtil.getFieldObjectCol(QueueFieldInfo.QUEUE_SID, queues);</span>
<span class="nc" id="L1144">			Collection&lt;ID&gt; queueDEIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L1145" title="All 2 branches missed.">			for (ID sid : queueSIDs) {</span>
<span class="nc" id="L1146">				queueDEIDs.add(DAOUtil.mapIDToDEID(sid, queueFieldInfo));</span>
<span class="nc" id="L1147">			}</span>
<span class="nc" id="L1148">			return super.getObjects(&quot;QUEUEID IN &quot; + getDMO().createInClause(queueDEIDs));</span>
<span class="nc" id="L1149">		} catch (JdmoException e) {</span>
<span class="nc" id="L1150">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1152">			spDAO.cleanUp();</span>
		}
	}

	/**
	 * Returns a complete list of IDs and the first chunk of data to be
	 * displayed. Does not return combined SPQueues.
	 */
	public PaginationPair&lt;SPQueue&gt; getCompletePaginationDataSetForSchedulingPeriod(ID spID, boolean isAscendingSort,
			int pageIDSize, int pageIndex, LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap, Collection&lt;ID&gt; filteredIDs)
			throws BbmFinderException {
<span class="fc" id="L1163">		StringBuffer whereClause = new StringBuffer();</span>
<span class="fc" id="L1164">		whereClause.append(&quot; A.SPID IN (SELECT ID FROM SP WHERE SID = &quot; + spID + &quot;) AND A.QUEUEID IS NOT NULL&quot;);</span>
<span class="fc" id="L1165">		return super.getCompletePaginationDataSet(whereClause.toString(), isAscendingSort, pageIDSize, pageIndex,</span>
				sortFieldMap, filteredIDs);
	}

	@Override
	protected void buildSortQuery(List&lt;DBSortField&gt; sortFields, StringBuffer selectQuery, StringBuffer fromQuery,
			StringBuffer whereQuery, StringBuffer groupByQuery, StringBuffer orderByQuery) {
<span class="fc bfc" id="L1172" title="All 2 branches covered.">		for (DBSortField sortField : sortFields) {</span>
<span class="pc bpc" id="L1173" title="5 of 7 branches missed.">			switch ((SPQueueSortField) sortField) {</span>
				case ID:
<span class="fc" id="L1175">					orderByQuery.append(getFieldInfo().getIDFieldName());</span>
<span class="fc" id="L1176">					break;</span>
				case QUEUE_NAME:
<span class="fc" id="L1178">					selectQuery.append(generateSimpleSortClauseForLinkedForeignTable(qfi, &quot;B&quot;,</span>
<span class="fc" id="L1179">							qfi.getFieldName(QueueFieldInfo.QUEUE_ID), qfi.getFieldName(QueueFieldInfo.QUEUE_NAME),</span>
<span class="fc" id="L1180">							getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID)));</span>
<span class="fc" id="L1181">					orderByQuery.append(queueNameSortFieldKey);</span>
<span class="fc" id="L1182">					break;</span>
				case DESCRIPTION:
<span class="nc" id="L1184">					selectQuery.append(generateSimpleSortClauseForLinkedForeignTable(qfi, &quot;C&quot;,</span>
<span class="nc" id="L1185">							qfi.getFieldName(QueueFieldInfo.QUEUE_ID), qfi.getFieldName(QueueFieldInfo.QUEUE_DESCRIPTION),</span>
<span class="nc" id="L1186">							getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID)));</span>
<span class="nc" id="L1187">					orderByQuery.append(queueDescriptionSortFieldKey);</span>
<span class="nc" id="L1188">					break;</span>
				case ORGANIZATION:
<span class="nc" id="L1190">					selectQuery.append(&quot;, (SELECT D.&quot;).append(ofi.getFieldName(OrganizationFieldInfo.ORGANIZATION_NAME))</span>
<span class="nc" id="L1191">							.append(&quot; FROM &quot;).append(ofi.getTableName()).append(&quot; D WHERE D.&quot;).append(ofi.getIDFieldName())</span>
<span class="nc" id="L1192">							.append(&quot; = (SELECT E.&quot;).append(qfi.getFieldName(QueueFieldInfo.QUEUE_ORGANIZATIONID))</span>
<span class="nc" id="L1193">							.append(&quot; FROM &quot;).append(qfi.getTableName()).append(&quot; E WHERE E.&quot;)</span>
<span class="nc" id="L1194">							.append(qfi.getFieldName(QueueFieldInfo.QUEUE_ID)).append(&quot; = A.&quot;)</span>
<span class="nc" id="L1195">							.append(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID)).append(&quot;)) AS &quot;)</span>
<span class="nc" id="L1196">							.append(organizationSortFieldKey);</span>
<span class="nc" id="L1197">					orderByQuery.append(organizationSortFieldKey);</span>
<span class="nc" id="L1198">					break;</span>
				case MEDIA:
<span class="nc" id="L1200">					selectQuery.append(&quot;, (SELECT F.&quot;).append(mfi.getFieldName(MediaFieldInfo.MEDIA_NAME)).append(&quot; FROM &quot;)</span>
<span class="nc" id="L1201">							.append(mfi.getTableName()).append(&quot; F WHERE F.&quot;)</span>
<span class="nc" id="L1202">							.append(mfi.getFieldName(MediaFieldInfo.MEDIA_STRID)).append(&quot; = (SELECT G.&quot;)</span>
<span class="nc" id="L1203">							.append(qfi.getFieldName(QueueFieldInfo.QUEUE_MEDIAID)).append(&quot; FROM &quot;).append(qfi.getTableName())</span>
<span class="nc" id="L1204">							.append(&quot; G WHERE G.&quot;).append(qfi.getFieldName(QueueFieldInfo.QUEUE_ID)).append(&quot; = A.&quot;)</span>
<span class="nc" id="L1205">							.append(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID)).append(&quot;)) AS &quot;)</span>
<span class="nc" id="L1206">							.append(mediaSortFieldKey);</span>
<span class="nc" id="L1207">					orderByQuery.append(mediaSortFieldKey);</span>
<span class="nc" id="L1208">					break;</span>
				case TYPE:
<span class="nc" id="L1210">					selectQuery.append(generateSimpleSortClauseForLinkedForeignTable(qfi, &quot;F&quot;,</span>
<span class="nc" id="L1211">							qfi.getFieldName(QueueFieldInfo.QUEUE_ID), qfi.getFieldName(QueueFieldInfo.QUEUE_TYPE),</span>
<span class="nc" id="L1212">							getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID)));</span>
<span class="nc" id="L1213">					orderByQuery.append(queueTypeSortFieldKey);</span>
<span class="nc" id="L1214">					break;</span>
				default:
					break;
			}
<span class="fc" id="L1218">		}</span>
<span class="fc" id="L1219">	}</span>

	@Override
	protected Object getPaginationDataFieldValue(JdmoRowset rowData, DBSortField sortField) throws JdmoException {
<span class="nc" id="L1223">		SPQueueSortField spqSortField = (SPQueueSortField) sortField;</span>
<span class="nc bnc" id="L1224" title="All 6 branches missed.">		switch (spqSortField) {</span>
			case QUEUE_NAME:
<span class="nc" id="L1226">				return rowData.getString(queueNameSortFieldKey);</span>
			case DESCRIPTION:
<span class="nc" id="L1228">				return rowData.getString(queueDescriptionSortFieldKey);</span>
			case ORGANIZATION:
<span class="nc" id="L1230">				return rowData.getString(organizationSortFieldKey);</span>
			case MEDIA:
<span class="nc" id="L1232">				return rowData.getString(mediaSortFieldKey);</span>
			case TYPE:
<span class="nc" id="L1234">				return QueueType.fromInt(rowData.getInt(queueTypeSortFieldKey));</span>
			default:
<span class="nc" id="L1236">				return null;</span>
		}
	}

	/**
	 * The following object retrieval methods are overriden from
	 * DAOBaseWithAutoIDMapping: getObjectsByParentID, getObjectsByParentIDs,
	 * getObjectsByParentIDs, getObjectByID, getObjects, getObjectsByIDs, and
	 * getObjectsGivenFullSqlQueryStr. These are overridden because a lot of
	 * client code expects a collection of associated skill IDs to be included
	 * as part of the SPQueue value object. TODO: The best approach here would
	 * be to refactor SPQueueDAO to extend from RichObjectDAO, and load the
	 * skills in automatically (rather than the skill IDs). However, this would
	 * require changing/testing a lot of client code which was outside the scope
	 * of this bugfix.
	 */
	@Override
	public Collection&lt;SPQueue&gt; getObjectsByParentID(ID idParent) throws BbmFinderException {
<span class="nc" id="L1254">		Collection&lt;SPQueue&gt; retVal = super.getObjectsByParentID(idParent);</span>
<span class="nc" id="L1255">		Collection&lt;ID&gt; spQueueIDs = ValueObjectUtil.getIDFromObjects(retVal);</span>
<span class="nc" id="L1256">		HashMap&lt;ID, Collection&lt;ID&gt;&gt; spQueueSkillIDMap = getSkillIDsForSPQueues(spQueueIDs);</span>
<span class="nc bnc" id="L1257" title="All 2 branches missed.">		for (SPQueue spQueue : retVal) {</span>
<span class="nc" id="L1258">			Collection&lt;ID&gt; skillIDs = spQueueSkillIDMap.get(spQueue.getID());</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">			if (skillIDs != null) {</span>
<span class="nc" id="L1260">				spQueue.setSkillsFromDB(skillIDs);</span>
			} else {
<span class="nc" id="L1262">				spQueue.setSkillsFromDB(new ArrayList&lt;ID&gt;());</span>
			}
<span class="nc" id="L1264">		}</span>
<span class="nc" id="L1265">		return retVal;</span>
	}

	@Override
	public Collection&lt;SPQueue&gt; getObjectsByParentIDs(Collection arrParentIDs, String parentIDsInClause)
			throws BbmFinderException {
<span class="nc" id="L1271">		Collection&lt;SPQueue&gt; retVal = super.getObjectsByParentIDs(arrParentIDs, parentIDsInClause);</span>
<span class="nc" id="L1272">		loadSkillIDsIntoSPQueues(retVal);</span>
<span class="nc" id="L1273">		return retVal;</span>
	}

	@Override
	public Collection&lt;SPQueue&gt; getObjectsByParentIDs(Collection arrParentIDs) throws BbmFinderException {
<span class="nc" id="L1278">		Collection&lt;SPQueue&gt; retVal = super.getObjectsByParentIDs(arrParentIDs);</span>
<span class="nc" id="L1279">		loadSkillIDsIntoSPQueues(retVal);</span>
<span class="nc" id="L1280">		return retVal;</span>
	}

	@Override
	public SPQueue getObjectByID(ID id) throws BbmObjectNotFoundException, BbmFinderException {
<span class="fc" id="L1285">		SPQueue spQueue = super.getObjectByID(id);</span>
<span class="fc" id="L1286">		loadSkillIDsIntoSPQueues(Collections.singleton(spQueue));</span>
<span class="fc" id="L1287">		return super.getObjectByID(id);</span>
	}

	@Override
	public Collection&lt;SPQueue&gt; getObjects(String strWhere, String strAfterWhere) throws BbmFinderException {
<span class="nc" id="L1292">		Collection&lt;SPQueue&gt; retVal = super.getObjects(strWhere, strAfterWhere);</span>
<span class="nc" id="L1293">		loadSkillIDsIntoSPQueues(retVal);</span>
<span class="nc" id="L1294">		return retVal;</span>
	}

	@Override
	public Collection&lt;SPQueue&gt; getObjects(String strWhere) throws BbmFinderException {
<span class="fc" id="L1299">		Collection&lt;SPQueue&gt; retVal = super.getObjects(strWhere);</span>
<span class="fc" id="L1300">		loadSkillIDsIntoSPQueues(retVal);</span>
<span class="fc" id="L1301">		return retVal;</span>
	}

	@Override
	public Collection&lt;SPQueue&gt; getObjectsByIDs(Collection&lt;? extends ID&gt; arrIDs) throws BbmFinderException {
<span class="fc" id="L1306">		Collection&lt;SPQueue&gt; retVal = super.getObjectsByIDs(arrIDs);</span>
<span class="fc" id="L1307">		loadSkillIDsIntoSPQueues(retVal);</span>
<span class="fc" id="L1308">		return retVal;</span>
	}

	@Override
	public Collection&lt;SPQueue&gt; getObjectsGivenFullSqlQueryStr(String fullSqlQuery) throws BbmFinderException {
<span class="fc" id="L1313">		Collection&lt;SPQueue&gt; retVal = super.getObjectsGivenFullSqlQueryStr(fullSqlQuery);</span>
<span class="fc" id="L1314">		loadSkillIDsIntoSPQueues(retVal);</span>
<span class="fc" id="L1315">		return retVal;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>