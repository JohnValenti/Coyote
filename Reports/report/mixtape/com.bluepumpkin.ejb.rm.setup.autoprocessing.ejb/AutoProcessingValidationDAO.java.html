<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AutoProcessingValidationDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.setup.autoprocessing.ejb</a> &gt; <span class="el_source">AutoProcessingValidationDAO.java</span></div><h1>AutoProcessingValidationDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.setup.autoprocessing.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.setup.autoprocessing.model.AutoProcessingRule;
import com.bluepumpkin.ejb.rm.setup.autoprocessing.model.AutoProcessingValidation;
import com.bluepumpkin.ejb.rm.setup.autoprocessing.model.AutoProcessingValidationFieldInfo;
import com.bluepumpkin.ejb.rm.setup.validation.model.ValidationRule;

/**
 * Title:        AutoProcessingValidationDAO
 * Description:  DAO class for AutoProcessingValidation
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc.
 * @author       Howard Mullings
 * @version      1.0
 */

public class AutoProcessingValidationDAO extends DAOBase {

    private Map m_validationRules;

<span class="fc" id="L39">    private static Category m_cat =</span>
<span class="fc" id="L40">        Log.initCategory( AutoProcessingValidationDAO.class.getName());</span>

    protected Category getCategory() {
<span class="nc" id="L43">        return m_cat;</span>
    }

<span class="fc" id="L46">    private static FieldInfo m_fieldInfo = new AutoProcessingValidationFieldInfo();</span>

<span class="fc" id="L48">    protected FieldInfo getFieldInfo() { return m_fieldInfo; }</span>

    public AutoProcessingValidationDAO() {
<span class="nc" id="L51">       super();</span>
<span class="nc" id="L52">    }</span>

    public AutoProcessingValidationDAO(Jdmo dmo) {
<span class="fc" id="L55">       super(dmo);</span>
<span class="fc" id="L56">    }</span>

    protected ValueObjectBase createValueObject()
    {
<span class="fc" id="L60">       return (new AutoProcessingValidation());</span>
    }

    public void createObjects(AutoProcessingRule rule)
        throws Exception {

<span class="fc" id="L66">        Collection list = rule.getAutoProcessingValidations();</span>
<span class="pc bpc" id="L67" title="2 of 4 branches missed.">        if (list != null &amp;&amp; list.size() != 0)</span>
        {
<span class="fc" id="L69">            ID pAutoProcessingRuleID = rule.getID();</span>
<span class="fc" id="L70">            Iterator itr = list.iterator();</span>

<span class="fc bfc" id="L72" title="All 2 branches covered.">            while (itr.hasNext()) {</span>
                AutoProcessingValidation val;
<span class="fc" id="L74">                val = (AutoProcessingValidation) itr.next();</span>
<span class="fc" id="L75">                val.setAutoProcessingRuleID(pAutoProcessingRuleID);</span>
                ID id;
//              try {
<span class="fc" id="L78">                    id = getValidationRuleID(val);</span>
//              }
//              c_atch (Exception e) {
//                  t_hrow new BbmCreateException(e);
//              }
//                if (id == null) {
//                    t_hrow new BbmCreateException(&quot;missing validation rule id: &quot;+val);
//                }
<span class="fc" id="L86">                createObject(val);</span>
<span class="fc" id="L87">            }</span>
        }
<span class="fc" id="L89">    }</span>

    public void updateObjects(AutoProcessingRule rule)
        throws Exception {

//      try
//      {
<span class="nc" id="L96">            ID autoProcessingRuleId = rule.getID();</span>
<span class="nc" id="L97">            Collection newList = rule.getAutoProcessingValidations();</span>
            // compute valiation rule id in the new list because they are
            // optional (as far as the client is concerned).
<span class="nc bnc" id="L100" title="All 2 branches missed.">            if (newList.size() != 0) {</span>
<span class="nc" id="L101">                Iterator itr = newList.iterator();</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">                while (itr.hasNext()) {</span>
                    AutoProcessingValidation val;
<span class="nc" id="L104">                    val = (AutoProcessingValidation) itr.next();</span>
                    Object key;
//                  try {
<span class="nc" id="L107">                        key = getValidationRuleID(val);</span>
//                  }
//                  c_atch (Exception e) {
//                      t_hrow new BbmUpdateException(e);
//                  }
//                    if (key == null) {
//                        t_hrow new BbmUpdateException(&quot;missing validation rule id: &quot;+val);
//                    }
<span class="nc" id="L115">                }</span>
            }

<span class="nc" id="L118">            Collection oldList = findByAutoProcessingId(autoProcessingRuleId);</span>
<span class="nc" id="L119">            HashMap newSet[] = getHashMap(newList);</span>
<span class="nc" id="L120">            HashMap oldSet[] = getHashMap(oldList);</span>

            // 1. remove the items which are in both lists since there is no change
<span class="nc bnc" id="L123" title="All 4 branches missed.">            if (oldList.size() != 0 &amp;&amp; newList.size() != 0) {</span>
<span class="nc" id="L124">                Iterator itr = (new ArrayList(newList)).iterator();</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                while (itr.hasNext()) {</span>
                    AutoProcessingValidation val;
<span class="nc" id="L127">                    val = (AutoProcessingValidation) itr.next();</span>
<span class="nc" id="L128">                    int idx = val.getApprovalFlag();</span>
<span class="nc" id="L129">                    Object key= val.getValidationRuleID();</span>
                    Object newObj;
                    Object oldObj;
<span class="nc bnc" id="L132" title="All 2 branches missed.">                    if ((newObj = newSet[idx].get(key)) != null &amp;&amp;</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                        (oldObj = oldSet[idx].get(key)) != null) {</span>
<span class="nc" id="L134">                        newList.remove(newObj);</span>
<span class="nc" id="L135">                        oldList.remove(oldObj);</span>
                    }
<span class="nc" id="L137">                }</span>
            }
            // 2. insert the items only in the new list
<span class="nc bnc" id="L140" title="All 2 branches missed.">            if (newList.size() != 0) {</span>
<span class="nc" id="L141">                Iterator itr = newList.iterator();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                while (itr.hasNext()) {</span>
                    AutoProcessingValidation val;
<span class="nc" id="L144">                    val = (AutoProcessingValidation) itr.next();</span>
<span class="nc" id="L145">                    val.setAutoProcessingRuleID(rule.getID());</span>
<span class="nc" id="L146">                    val.setID(null);</span>
<span class="nc" id="L147">                    createObject(val);</span>
<span class="nc" id="L148">                }</span>
            }
            // 3. delete the items only in the old list
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if (oldList.size() != 0) {</span>
<span class="nc" id="L152">                Iterator itr = oldList.iterator();</span>
<span class="nc" id="L153">                Collection ids = new ArrayList(oldList.size());</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                while (itr.hasNext()) {</span>
                    AutoProcessingValidation val;
<span class="nc" id="L156">                    val = (AutoProcessingValidation) itr.next();</span>
<span class="nc" id="L157">                    ids.add(val.getID());</span>
<span class="nc" id="L158">                }</span>
<span class="nc" id="L159">                deleteObjects(ids);</span>
            }
//      }
//      c_atch (Exception e) {
//          m_cat.error(rule, e);
//          t_hrow new BbmUpdateException(e);
//      }
<span class="nc" id="L166">    }</span>

    public void deleteByAutoProcessingRuleID(ID pAutoProcessingRuleID)
    throws Exception {
//      try {
            StringBuffer lStmt;
<span class="fc" id="L172">            lStmt = new StringBuffer( &quot; DELETE AUTOPROCESSINGVALIDATION &quot;);</span>
<span class="fc" id="L173">            lStmt.append(&quot; WHERE AUTOPROCESSINGRULEID = ?&quot;);</span>
<span class="fc" id="L174">            Object[] parm = new Object[1];</span>
<span class="fc" id="L175">            parm[0] = pAutoProcessingRuleID;</span>

<span class="fc" id="L177">            m_dmo.executePCommand(lStmt.toString(), parm);</span>
//      }
//      c_atch ( Exception e ) {
//          m_cat.error(pAutoProcessingRuleID, e);
//          t_hrow new BbmRemoveException(e);
//      }
<span class="fc" id="L183">    }</span>

    public Collection findByAutoProcessingId(ID autoProcessingRuleId)
    throws Exception
    {
<span class="fc" id="L188">        Collection autoProcessingRuleIds = new ArrayList(1);</span>
<span class="fc" id="L189">        autoProcessingRuleIds.add(autoProcessingRuleId);</span>
<span class="fc" id="L190">        Map map = findByAutoProcessingIds(autoProcessingRuleIds);</span>
<span class="fc" id="L191">        Collection results = null;</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">        if (map != null) {</span>
<span class="fc" id="L193">            results = (Collection)map.get(autoProcessingRuleId);</span>
        }
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">        if (results == null) {</span>
<span class="nc" id="L196">            results = Collections.EMPTY_LIST;</span>
        }
<span class="fc" id="L198">        return results;</span>
    }

    /**
     * Returns a map of APRuleID to a collection of validation rules (as {@link AutoProcessingValidation AutoProcessingValidation} objects)
     * associated with the autoProcessing rule.
     *
     * @param autoProcessingRuleIds
     * @return
     * @throws BbmFinderException
     */
    public Map findByAutoProcessingIds(Collection autoProcessingRuleIds)
    throws Exception
    {
        //Get all Applied Auto Processing Rule For the Organizationid
<span class="fc" id="L213">        Map results = new HashMap(31);</span>

<span class="fc" id="L215">        StringBuffer strQuery = getSelectStatement();</span>
<span class="fc" id="L216">        strQuery.append(&quot;, B.BUNDLEKEY, B.VALIDATOR &quot;);</span>
//      try {
<span class="fc" id="L218">            strQuery.append(&quot; FROM AUTOPROCESSINGVALIDATION A, VALIDATIONRULE B &quot;);</span>
<span class="fc" id="L219">            strQuery.append(&quot; WHERE A.VALIDATIONRULEID = B.ID &quot;);</span>
<span class="fc" id="L220">            strQuery.append(&quot; AND A.AUTOPROCESSINGRULEID IN &quot;);</span>

<span class="fc" id="L222">            strQuery.append(m_dmo.createInClause(autoProcessingRuleIds));</span>

<span class="fc" id="L224">            strQuery.append(&quot; ORDER BY AUTOPROCESSINGRULEID &quot;);</span>

<span class="fc" id="L226">            JdmoQuery jQuery1 = m_dmo.createQuery(strQuery.toString(), Jdmo.PARAM_QUERY);</span>

<span class="fc" id="L228">            JdmoRowset rs = m_dmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="fc bfc" id="L230" title="All 2 branches covered.">            while (rs.next()) {</span>
<span class="fc" id="L231">                AutoProcessingValidation vo =</span>
<span class="fc" id="L232">                    (AutoProcessingValidation) readObjectFromDB(rs);</span>
<span class="fc" id="L233">                vo.setBundleKey(rs.getString(&quot;BUNDLEKEY&quot;));</span>
<span class="fc" id="L234">                vo.setValidator(rs.getString(&quot;VALIDATOR&quot;));</span>

<span class="fc" id="L236">                ArrayList al = (ArrayList)results.get(vo.getAutoProcessingRuleID());</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">                if (al == null) {</span>
<span class="fc" id="L238">                    results.put(vo.getAutoProcessingRuleID(),</span>
                                al = new ArrayList(5));
                }
<span class="fc" id="L241">                al.add(vo);</span>
<span class="fc" id="L242">            }</span>

<span class="fc" id="L244">            rs.close();</span>
//        }
//        c_atch(Exception e) {
//          m_cat.error(autoProcessingRuleIds, e);
//            t_hrow new BbmFinderException(e);
//        }

<span class="fc" id="L251">        return results;</span>
    }

    /**
     * Separate approval and denial validation rules into arrays.
     * Represent validations as a map from validation rule id to validation obj.
     */
    private HashMap[] getHashMap(Collection list) {
<span class="nc" id="L259">        HashMap[] results = new HashMap[] { new HashMap(31), new HashMap(31),new HashMap(31) };</span>
<span class="nc" id="L260">        Iterator itr = list.iterator();</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">        while (itr.hasNext()) {</span>
            AutoProcessingValidation val;
<span class="nc" id="L263">            val = (AutoProcessingValidation) itr.next();</span>
<span class="nc" id="L264">            results[val.getApprovalFlag()].put(val.getValidationRuleID(),</span>
                                                  val);
<span class="nc" id="L266">        }</span>
<span class="nc" id="L267">        return results;</span>
    }


    private Map getValidationRules() throws Exception {
<span class="fc bfc" id="L272" title="All 2 branches covered.">        if (m_validationRules != null) {</span>
<span class="fc" id="L273">            return m_validationRules;</span>
        }
<span class="fc" id="L275">        m_validationRules = new HashMap(31);</span>

        Collection results;
<span class="fc" id="L278">        results = RmManagerFactory.getInstance().</span>
<span class="fc" id="L279">                    getValidationRuleManager().</span>
<span class="fc" id="L280">                    getValidationRules();</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        if (results != null) {</span>
<span class="fc" id="L282">            Iterator itr = results.iterator();</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">            while (itr.hasNext()) {</span>
<span class="fc" id="L284">                ValidationRule vr = (ValidationRule)itr.next();</span>
<span class="fc" id="L285">                m_validationRules.put(vr.getKey(), vr.getID());</span>
<span class="fc" id="L286">            }</span>
        }
<span class="fc" id="L288">        return m_validationRules;</span>
    }

    private ID getValidationRuleID(String bundleKey) throws Exception {
<span class="fc" id="L292">        Map map = getValidationRules();</span>
<span class="fc" id="L293">        return (ID)map.get(bundleKey);</span>
    }

    private ID getValidationRuleID(AutoProcessingValidation val) throws Exception {
<span class="fc" id="L297">        ID id = val.getValidationRuleID();</span>
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">        if (id == null) {</span>
<span class="fc" id="L299">            String bundleKey =  val.getBundleKey();</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">            if (bundleKey != null) {</span>
<span class="fc" id="L301">                val.setValidationRuleId(id = getValidationRuleID(bundleKey));</span>
            }
        }
<span class="fc" id="L304">        return id;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>