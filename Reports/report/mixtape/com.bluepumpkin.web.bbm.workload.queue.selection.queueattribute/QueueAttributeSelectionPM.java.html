<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueAttributeSelectionPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute</a> &gt; <span class="el_source">QueueAttributeSelectionPM.java</span></div><h1>QueueAttributeSelectionPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.Set;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.QueueSelection;
import com.bluepumpkin.ejb.bbm.workload.model.queueattribute.QueueAttributeFilter;
import com.bluepumpkin.ejb.bbm.workload.model.queueattribute.QueueAttributeFilterMedia;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.workload.WorkloadModelHandler;
import com.bluepumpkin.web.bbm.workload.queue.selection.QueueFilterBoxPC;
import com.bluepumpkin.web.bbm.workload.queue.selection.QueueFilterUtil;
import com.bluepumpkin.web.bbm.workload.queue.selection.QueueSelectionPC;
import com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute.filter.QueueAttributeFilterModelHandler;
import com.witness.web.uif.pagecomponent.tree.MultiColInputTreePC;
import com.witness.web.uif.pagecomponent.tree.util.TreeModelBuilder;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.SelectionpaneTreePM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.config.Screen;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.SortUtil;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title:
 * Description:
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author		Sankar Nair
 * @version 1.0
 */
public class QueueAttributeSelectionPM extends SelectionpaneTreePM {
	private static final String QUEUE_SELECTION_IDS_KEY = &quot;QUEUE_SELECTION_IDS_KEY&quot;;
	private static final String IS_CAMPAIGN_MODE_FN = &quot;isCampaignMode&quot;;
	private static final String LAST_CAMPAIGN_ID_FN = &quot;lastCampaignID&quot;;
	private static final String IS_INFO_SUBMITTED_FROM_SELF_FN = &quot;isInfoSubmittedFromSelf&quot;;

<span class="nc" id="L51">	private ID m_campaignID = null;</span>
<span class="nc" id="L52">	private ID m_lastCampaignID = null;</span>
<span class="nc" id="L53">	private ID m_organizationID = null;</span>
<span class="nc" id="L54">	private ID m_queueAttributeID = null;</span>
	
	/**
	 * Campaign mode means that the campaign selector will be used.
	 * It does not mean that a campaign has been selected. Use
	 * m_campaignID for that.
	 */
<span class="nc" id="L61">	private boolean m_isCampaignMode = false;</span>
	
<span class="nc" id="L63">	private boolean m_isNewCampaignSelected = false;</span>
<span class="nc" id="L64">	private boolean m_isInfoSubmittedFromSelf = false;</span>
	private QueueAttributeFilterBoxPC m_queueFilterBoxPC;

	/**
	 * Constructor
	 */
	public QueueAttributeSelectionPM(RequestContext context) {
<span class="nc" id="L71">		super(context, new QueueSelectionPC(context));</span>

		// Initialize Filter Box
<span class="nc" id="L74">		m_queueFilterBoxPC = new QueueAttributeFilterBoxPC(m_context);</span>
<span class="nc" id="L75">		addChildComponent(m_queueFilterBoxPC);</span>
<span class="nc" id="L76">		m_filterBoxPC = m_queueFilterBoxPC;</span>
<span class="nc" id="L77">		m_filterBoxPC.setUseWrapper(true);</span>

<span class="nc" id="L79">		initIDFromCache();</span>
<span class="nc" id="L80">	}</span>

	/**
	 * Return an instance of the model that is ready for rendering
	 */
	public static PageModel getInstance(RequestContext context) {
<span class="nc" id="L86">		return getInstance(context, QueueAttributeSelectionPM.class);</span>
	}

	protected void preLoadData() throws Exception 
	{
<span class="nc bnc" id="L91" title="All 2 branches missed.">		if (m_isCampaignMode) </span>
		{
            //System.out.println(&quot;\nQueueSelectionPM.preLoadData() starting...&quot;);
            
			//Needs to be synchronized because the work frame (PulseAppletPC) and the queue  
			//selection frame (this class) both load at the same time.
<span class="nc" id="L97">			synchronized (m_context.getRequest().getSession())</span>
			{		
                //System.out.println(&quot;\nQueueSelectionPM.preLoadData() entered synchronized block&quot;);
<span class="nc" id="L100">                QueueFilterUtil.storeDEToPulseParams(m_context, getContextID());</span>
				
                
                //We can continue to use the complete mediaMap. The queue retrieval already accounts
                //the media selection. So even if all the mediaMap is used, the effectivel queues appearing
                //will be as per the queue attribute filter media selection.
<span class="nc" id="L106">				Map mediaMap = WorkloadModelHandler.getMediaMap(m_context);</span>
				
<span class="nc" id="L108">				Collection mediaList = SortUtil.sortBasicVO(mediaMap.values(), m_localizer);</span>
<span class="nc" id="L109">				m_queueFilterBoxPC.init(mediaList);</span>
	
<span class="nc" id="L111">				m_campaignID = m_queueFilterBoxPC.getCampaignID();</span>
				
				//ID mediaID = m_queueFilterBoxPC.getMediaID();
				//m_organizationID = m_queueFilterBoxPC.getOrganizationID();
				
<span class="nc" id="L116">				m_queueAttributeID = m_queueFilterBoxPC.getQueueAttributeFilterID();</span>
				//System.out.println(&quot;\n\t\tSelected Queue Attrib Filter ID &quot; + m_queueAttributeID);
				
				//if(m_queueFilterBoxPC.isCampaignSelected())
					//m_organizationID = null;
				//if(m_queueFilterBoxPC.isOrganizationSelected())
					//m_campaignID = null;

<span class="nc" id="L124">				Date startDate=null, endDate=null;</span>
<span class="nc" id="L125">				m_isNewCampaignSelected = isNewCampaignSelected(m_lastCampaignID, m_campaignID, m_isInfoSubmittedFromSelf);</span>
				
//				Collection&lt;ID&gt; spID = null;
				//If coming from DE, we need to use the stored dates rather than get the current SP.
<span class="nc" id="L129">				boolean isUseStoredDates = QueueFilterUtil.retrieveUseSavedDatesForOneTimeUse(m_context);</span>
<span class="nc bnc" id="L130" title="All 4 branches missed.">				if (m_campaignID!=null &amp;&amp; !isUseStoredDates) </span>
				{		
<span class="nc" id="L132">					SchedulingPeriod sp = null;</span>
<span class="nc bnc" id="L133" title="All 4 branches missed.">					if (m_isNewCampaignSelected &amp;&amp; m_isInfoSubmittedFromSelf)</span>
					{
<span class="nc" id="L135">						sp = CampaignModelHandler.getMostCurrentSP(m_context, m_campaignID);</span>
					}
					else
					{
						//The first time pulse loads, we get the spID from the USERPROFILE table, which is shared among all F&amp;S On The Web modules.
<span class="nc" id="L140">						ID spID = QueueFilterUtil.retrieveSchedulingPeriodID(m_context);</span>
<span class="nc" id="L141">						sp = CampaignModelHandler.getSchedPeriod(m_context, spID);</span>
					}
					
<span class="nc bnc" id="L144" title="All 2 branches missed.">					if (sp!=null) </span>
					{
<span class="nc" id="L146">						startDate = sp.getStartTime();</span>
<span class="nc" id="L147">						endDate = sp.getEndTime();</span>
<span class="nc" id="L148">						QueueFilterUtil.storeTimePeriodStart(m_context, startDate);</span>
<span class="nc" id="L149">						QueueFilterUtil.storeTimePeriodEnd(m_context, endDate);</span>
<span class="nc" id="L150">						m_campaignID = sp.getCampaignID(); //just in case</span>
					}
<span class="nc" id="L152">				} </span>
				else 
				{
<span class="nc" id="L155">					startDate = QueueFilterUtil.retrieveTimePeriodStart(m_context);</span>
<span class="nc" id="L156">					endDate = QueueFilterUtil.retrieveTimePeriodEnd(m_context);</span>
				}
	/*
				if(spID == null &amp;&amp; m_campaignID != null &amp;&amp; !new ID(0).equals(m_campaignID)) {
					spID = new ArrayList&lt;ID&gt;();
					Collection&lt;SchedulingPeriod&gt; spCol = CampaignModelHandler.getSchedulingPeriods(m_context, m_campaignID, startDate, endDate);
					if(spCol != null &amp;&amp; spCol.size() &gt; 0) {
						Iterator&lt;SchedulingPeriod&gt; iter = spCol.iterator();
						while(iter.hasNext()) {
							spID.add(iter.next().getID());
						}
					}
				}
		*/		
<span class="nc" id="L170">				QueueSelectionPC queuePC = (QueueSelectionPC)m_treePC;</span>
				
				
				//System.out.println(&quot;Going to retrieve Queue List - Campaign &quot; + m_campaignID + &quot;; org &quot; + m_organizationID + &quot;; media &quot; + mediaMap.size());
<span class="nc" id="L174">				queuePC.setCampaignModeData(m_campaignID, startDate, endDate, mediaMap, m_queueAttributeID, true, true, true);</span>
				
				//queuePC.setCampaignModeData(m_campaignID, m_organizationID,
						//Checking whether the user has selected Org and also whether he has permission to view org
//						m_queueFilterBoxPC.isOrganizationSelected(), 
//						startDate, endDate, mediaMap, true, true, true);
<span class="nc" id="L180">			}//synchronized</span>
            //System.out.println(&quot;\nQueueSelectionPM.preLoadData() complete&quot;);
        } 
		else 
		{
			// do not use Filter box if not in campaign mode
<span class="nc" id="L186">			removeChildComponent(m_queueFilterBoxPC);</span>
<span class="nc" id="L187">			m_filterBoxPC=null;</span>
		}
<span class="nc" id="L189">	}</span>

	private static boolean isNewCampaignSelected(ID lastCampaignID, ID currentCampaignID, boolean isInfoSubmittedFromSelf) {
<span class="nc bnc" id="L192" title="All 2 branches missed.">		boolean result = currentCampaignID!=null;</span>

		// if Page Refreshed then need to make sure that last and current selected campaign is not the same
<span class="nc bnc" id="L195" title="All 4 branches missed.">		if (isInfoSubmittedFromSelf &amp;&amp; currentCampaignID!=null) {</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">			result = !currentCampaignID.equals(lastCampaignID);</span>
		}

<span class="nc" id="L199">		return result;</span>
	}

	protected void initScreenParam() throws Exception {
<span class="nc" id="L203">		Screen screen = m_context.getScreen();</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">		if (screen==null) return;</span>

<span class="nc" id="L206">		String isCampaignMode = screen.getParameterValue(IS_CAMPAIGN_MODE_FN);</span>
<span class="nc" id="L207">		setIsCampaignMode( &quot;true&quot;.equals(isCampaignMode) );</span>
<span class="nc" id="L208">	}</span>

	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc bnc" id="L214" title="All 2 branches missed.">		return m_isCampaignMode ? &quot;queue_campaign_selection&quot; : &quot;queue_selection&quot;;</span>
	}

	public void setIsCampaignMode(boolean bValue) {
<span class="nc" id="L218">		m_isCampaignMode = bValue;</span>
<span class="nc" id="L219">	}</span>

	public void setLastCampaignID(ID campaignID) {
<span class="nc" id="L222">		m_lastCampaignID = campaignID;</span>
<span class="nc" id="L223">	}</span>

	/**
	 * Return Required HTML
	 */
	public String getRequiredHTML() {
<span class="nc" id="L229">		return super.getRequiredHTML() +</span>
<span class="nc" id="L230">				HtmlUtil.makeHiddenInput(IS_CAMPAIGN_MODE_FN, m_isCampaignMode) +</span>
<span class="nc" id="L231">				HtmlUtil.makeHiddenInput(LAST_CAMPAIGN_ID_FN, m_campaignID) +</span>
<span class="nc" id="L232">				HtmlUtil.makeHiddenInput(IS_INFO_SUBMITTED_FROM_SELF_FN, true); </span>
				
	}

	////////////////////////////////////////////////////////////////////////////////
	// Code to handle ID Selection Caching
	////////////////////////////////////////////////////////////////////////////////
	protected String[] getPreSelectedRows() {
        //System.out.println(&quot;\nQueueSelectionPM.getPreSelectedRows() starting...&quot;);
        
<span class="nc" id="L242">		String[] result = null;</span>
		
		// Reset Selected ID if switching from Campaign to All Queues so that we dont preselect same combined queues
<span class="nc bnc" id="L245" title="All 4 branches missed.">		boolean isSwitchedToAllQueuesFromCamp = (m_campaignID==null &amp;&amp; m_lastCampaignID!=null);</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">		if (m_isCampaignMode &amp;&amp; isSwitchedToAllQueuesFromCamp) {</span>
<span class="nc" id="L247">			m_selectedID=null;</span>
		}

		// Convert selected IDs to queue IDS. m_selectedID is of the form: &quot;46_-1_94,46_-1_95&quot;
<span class="nc bnc" id="L251" title="All 2 branches missed.">		if (!StringUtil.isEmpty(m_selectedID)) {</span>
<span class="nc" id="L252">			Collection queueIDs = StringUtil.parseStringToCollection(m_selectedID, QueueSelection.ITEM_DELIM);</span>
<span class="nc" id="L253">			Set uIDSet = new HashSet(queueIDs); //ex: {&quot;46_-1_94&quot; , &quot;46_-1_95&quot;}</span>
<span class="nc" id="L254">			result = TreeModelBuilder.getSelectedRowIndex(m_treePC, uIDSet);</span>
		}

		// By Default Select Root Node and refresh Workpane if New Campaign is selected
<span class="nc bnc" id="L258" title="All 4 branches missed.">		boolean hasSelectedNode = result!=null &amp;&amp; result.length&gt;0;</span>
<span class="nc" id="L259">		boolean isAutoRefreshWorkpane = false;</span>
		
		//In campaign mode, always select root node if no node is selected
<span class="nc bnc" id="L262" title="All 8 branches missed.">		if (m_isCampaignMode &amp;&amp; (m_campaignID != null) &amp;&amp; !hasSelectedNode &amp;&amp; !m_treePC.isTreeEmpty())  </span>
		{
<span class="nc bnc" id="L264" title="All 2 branches missed.">			if (!isPulseSelectionNoDefault())</span>
			{
<span class="nc" id="L266">	            result = MultiColInputTreePC.PRE_SELECT_ROOT;</span>
				
				//We may need to update m_selectedID to reflect the new selection
				//m_selectedID = QueueSelection.createCombinedID(m_campaignID, m_queueFilterBoxPC.getMediaID(), null);
			}
<span class="nc bnc" id="L271" title="All 2 branches missed.">			if (m_isNewCampaignSelected)</span>
<span class="nc" id="L272">				isAutoRefreshWorkpane = true;</span>
		}
		
		// Refresh Workpane if there is something selected or if new campaign does not have any queues associated.
<span class="nc bnc" id="L276" title="All 6 branches missed.">		boolean isNewCampaignWithoutQueues = m_isCampaignMode &amp;&amp; m_isNewCampaignSelected &amp;&amp; m_treePC.isTreeEmpty();</span>
		
<span class="nc bnc" id="L278" title="All 6 branches missed.">		if (isAutoRefreshWorkpane || isNewCampaignWithoutQueues || !hasSelectedNode) </span>
		{
			//We may need to update m_selectedID to reflect the new selection
			//m_selectedID = QueueSelection.createCombinedID(m_campaignID, m_queueFilterBoxPC.getMediaID(), getQueueID());
			
            //System.out.println(&quot;\nQueueSelectionPM.getPreSelectedRows() calling setRefreshWorkpane(true)&quot;);
<span class="nc" id="L284">			setRefreshWorkpane(true);</span>
		}
        //System.out.println(&quot;\nQueueSelectionPM.getPreSelectedRows() complete&quot;);
<span class="nc" id="L287">		return result;</span>
	}
	
	/**
	 * Medco has hundreds of queues, and each time Pulse loads, or user changes campaigns, Pulse
	 * automatically selects the combined queue, which takes a long time to get from the backend 
	 * because it combines all of the queues together dynamically. To improve performance, we 
	 * added a BPCONFIG setting which allows Medco to configure Pulse so that it does not select
	 * any queue by default when switching campaigns, (or when switching SP/date range when no 
	 * queue had been previously selected). Once the user selects a queue, if he then changes the 
	 * SP/date range and the new SP/date range includes the selected queue, then that queue 
	 * continues to be selected. However, when switching campaigns, we always de-select any 
	 * queues selection.
	 * This method tells us whether Pulse is configured to show no queue by default.   
	 * @return whether Pulse is configured to show no queue by default.
	 */
	synchronized public boolean isPulseSelectionNoDefault()
	{
<span class="nc" id="L305">		boolean isEnabled = false;</span>
       try 
       {
<span class="nc" id="L308">	        isEnabled = BbmManagerFactory.getDBConfigManager().getBooleanValue(ConfigKey.PULSE_DEFAULT_SELECT_NO_QUEUE);</span>
       } 
<span class="nc" id="L310">       catch (Exception ex) </span>
       {
<span class="nc" id="L312">    	   handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L313">       }</span>
<span class="nc" id="L314">       return isEnabled;</span>
	}
	
	private void initIDFromCache() {
		try {
<span class="nc" id="L319">			initScreenParam();</span>
<span class="nc" id="L320">		} catch(Exception ex) {</span>
<span class="nc" id="L321">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L322">		}</span>

		// Initialize Selected IDs from Session and Indicate to Framework that IDs are cached
		// Disabled caching since we want the top node to be selected each time it is refreshed
		/*
		setIsIDSelectionCached(m_isCampaignMode);
		if (m_isCampaignMode) {
			String selectedIDs = getCachedSelectedID();
			setSelectedID(selectedIDs);
		}*/
<span class="nc" id="L332">	}</span>

	/**
	 * Return Key that is used for caching Selected ID
	 */
	public String getCacheSelectedIDKey() {
<span class="nc" id="L338">		return QUEUE_SELECTION_IDS_KEY;</span>
	}


	/**
	 * Specify whether the information is submitted from itself
	 */
	public void setIsInfoSubmittedFromSelf(boolean bValue) {
<span class="nc" id="L346">		m_isInfoSubmittedFromSelf = bValue;</span>
<span class="nc" id="L347">	}</span>
	
	/**
	 * Return the JavaScript init code required by Page model.
	 * Default behavior is to retrieve sub-component JavaScript Init code
	 * Override parent class in order to set the selectedID form
	 * element with the currently selected row in the tree. This is needed
	 * because Pulse pre-selects a row in the table when the user changes the
	 * campaign selection and the selection pane reloads. Ideally, we would just 
	 * set m_selectedID ourselves in this page model, but we don't know which ID
	 * will be selected by our QueueSelectionPC. So calling 
	 * SelectionMediator.updateSelectedIDsWithTreeSelection() will take care of 
	 * setting the element with the tree selection when the page finishes loading.
	 */
	public String getJavaScriptInitCode() {
<span class="nc" id="L362">		StringBuffer jsInitCode = new StringBuffer(512);</span>

		// Add sub-component JavaScript code first
<span class="nc" id="L365">		jsInitCode.append(super.getJavaScriptInitCode()).append(&quot;\n&quot;);</span>

		// Need to have selectionMediator Mediator Ref
<span class="nc" id="L368">		String mediatorRef = getPageMediatorRef();</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">		if (!JSUtil.SELECTION_MEDIATOR_REF.equals(mediatorRef)) {</span>
<span class="nc" id="L370">			jsInitCode.append(JSUtil.SELECTION_MEDIATOR_REF).append(&quot; = &quot;)</span>
<span class="nc" id="L371">					.append(mediatorRef).append(&quot;; \n&quot;);</span>
		}

		// Associate Mediator Mediator\n&quot;
<span class="nc" id="L375">		jsInitCode.append(associateAppMediatorParent());</span>

		// Determine if Workpane should be refreshed
<span class="nc bnc" id="L378" title="All 2 branches missed.">		if (isRefreshWorkpane()) </span>
		{
<span class="nc" id="L380">			jsInitCode.append(JSUtil.SELECTION_MEDIATOR_REF).append(&quot;.updateSelectedIDsWithTreeSelection();\n&quot;);</span>
<span class="nc" id="L381">			jsInitCode.append(JSUtil.SELECTION_MEDIATOR_REF).append(&quot;.raiseBroadcastID();\n\n&quot;);</span>
		}
		
<span class="nc" id="L384">		appendJSToJSMain(JSUtil.RAISE_ON_LOAD_EVENTS);</span>
<span class="nc" id="L385">		return jsInitCode.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>