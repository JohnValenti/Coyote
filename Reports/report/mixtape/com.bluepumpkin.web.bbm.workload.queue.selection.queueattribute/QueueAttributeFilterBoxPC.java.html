<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueAttributeFilterBoxPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute</a> &gt; <span class="el_source">QueueAttributeFilterBoxPC.java</span></div><h1>QueueAttributeFilterBoxPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute;

import java.rmi.RemoteException;
import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.CoreEJBCreateException;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationUtil;
import com.bluepumpkin.web.bbm.workload.queue.selection.QueueFilterUtil;
import com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute.filter.QueueAttributeFilterPickerPC;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.jsp.HtmlTable;
import com.witness.web.uif.jsp.HtmlTableCell;
import com.witness.web.uif.jsp.HtmlTableRow;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.pagecomponent.filterbox.FilterBoxPC;
import com.witness.web.uif.pagecomponent.list.ListBoxPC;
import com.witness.web.uif.pagecomponent.list.OptionData;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.SortUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title:
 * Description:
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author		Sankar Nair
 * @version 1.0
 */
public class QueueAttributeFilterBoxPC extends FilterBoxPC {
	private static final String ORGANIZATION_SELECTED = &quot;ORGANIZATION_SELECTED&quot;;
	private static final String CAMPAIGN_SELECTED = &quot;CAMPAIGN_SELECTED&quot;;
<span class="nc" id="L53">	private static final ID BLANK_ID = new ID(0);</span>
	private static final String FILTER_NAME = &quot;queueFilter&quot;;
	private static final String MEDIA_ID_FN = &quot;mediaID&quot;;
	private static final String ORGANIZATION_ID_FN = &quot;organizationID&quot;;
	private static final short LIST_FILTER_MAX_WIDTH = (short)125;
	private static final String OUTER_TABLE_WIDTH = &quot;305&quot;;
	
<span class="nc" id="L60">	private String m_tempCampaignID = null;</span>

<span class="nc" id="L62">	private Collection m_mediaFilterList = Collections.EMPTY_LIST;</span>
	private ListBoxPC m_mediaListbox;
<span class="nc" id="L64">	private Collection m_organizationFilterList = Collections.EMPTY_LIST;</span>
	private ListBoxPC m_OrganizationListBox;
	private QueueAttributeFilterPickerPC m_queueAttribPicker;
	private ID m_queueAttribFilterID;
	private ResourceBundle m_bbmBundle;
	private ID m_mediaID;
	private ID m_organizationID;
	private String m_orgCampSelection;

<span class="nc" id="L73">	private Boolean m_isCampaignPermitted = null;</span>
	
	public QueueAttributeFilterBoxPC(RequestContext context) {
<span class="nc" id="L76">		super(context);</span>
<span class="nc" id="L77">		setName(FILTER_NAME);</span>

		
<span class="nc" id="L80">		m_bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
		
<span class="nc" id="L82">		m_OrganizationListBox = new ListBoxPC(context);</span>

<span class="nc" id="L84">		m_mediaListbox = new ListBoxPC(context);</span>
		
<span class="nc" id="L86">		m_queueAttribPicker = new QueueAttributeFilterPickerPC(context);</span>
<span class="nc" id="L87">		addSiblingComponent(m_queueAttribPicker);</span>

<span class="nc" id="L89">		setIsActionOptionsEnabled(false);</span>
<span class="nc" id="L90">	}</span>

	/**
	 * Initialize Component For Display
	 */
	public void initForDisplay() {
<span class="nc bnc" id="L96" title="All 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L97">			return;</span>
		} else {   		
<span class="nc" id="L99">			super.initForDisplay();</span>

<span class="nc" id="L101">			String header=verticalize(m_bbmBundle, BbmWebBundleKey.FILTERBOX_CAMPAIGN);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">			if(!isCampaignPermitted()) {</span>
<span class="nc" id="L103">				header = &quot;&quot;;</span>
			}
			
<span class="nc" id="L106">			setHeader(header);</span>
<span class="nc" id="L107">			initQueueAttributeProperties();</span>
		}
<span class="nc" id="L109">	}</span>

	private void initQueueAttributeProperties() {
<span class="nc" id="L112">		m_queueAttribPicker.setName(getName() + &quot;_queueAttribListBox&quot;);</span>
<span class="nc" id="L113">		m_queueAttribPicker.initFilter(true);</span>
		
<span class="nc" id="L115">		m_queueAttribPicker.getListbox().getWrapper().setAttribute(&quot;colspan&quot;, &quot;2&quot;);//Wrapper is an HtmlTableCell</span>
<span class="nc" id="L116">		m_queueAttribPicker.getListbox().getSelect().setAttribute(&quot;width&quot;, &quot;86px&quot;);//set a longer width, override the default m_filterWidth</span>
<span class="nc" id="L117">		m_queueAttribPicker.getListbox().setMaxDisplayWidth(LIST_FILTER_MAX_WIDTH);</span>
		
<span class="nc" id="L119">		m_queueAttribPicker.getListbox().getSelect().setAttribute(&quot;width&quot;, LIST_FILTER_MAX_WIDTH + &quot;px&quot;);</span>
		
<span class="nc" id="L121">	}</span>
	
	/**
	 * Initialize Media List Properties
	 */
	private void initMediaListProperties() {
<span class="nc" id="L127">		m_mediaListbox.setName(getName() + &quot;_mediaListbox&quot;);</span>
<span class="nc" id="L128">		m_mediaListbox.setMaxDisplayWidth(getListBoxDisplayMaxWidth());</span>
<span class="nc" id="L129">		m_mediaListbox.setHtmlName(MEDIA_ID_FN);</span>
<span class="nc" id="L130">		m_mediaListbox.getSelect().setAttribute(&quot;width&quot;, m_filterWidth + &quot;px&quot;);</span>
<span class="nc" id="L131">		m_mediaListbox.setOptions(m_mediaFilterList);</span>
<span class="nc" id="L132">	}</span>
	
	
	/**
	 * Initialize Organization List Properties
	 */
	private void initOrganizationListProperties() {
<span class="nc" id="L139">		m_OrganizationListBox.setName(getName() + &quot;_organizationListbox&quot;);</span>
<span class="nc" id="L140">		m_OrganizationListBox.setMaxDisplayWidth(getListBoxDisplayMaxWidth());</span>
<span class="nc" id="L141">		m_OrganizationListBox.setHtmlName(ORGANIZATION_ID_FN);</span>
<span class="nc" id="L142">		m_OrganizationListBox.getSelect().setAttribute(&quot;width&quot;, m_filterWidth + &quot;px&quot;);</span>
<span class="nc" id="L143">		Iterator iter = m_organizationFilterList.iterator();</span>
		
		//The below code is added to avoid the growth in width of Org picker
		//when any sub orgs are picked.
		//This is the current indentation used in TreeModelBuilder class to
		//as the indentation between an organization and sub organization.
		//The below logic will replace this two space with a single space thus 
		//saving space - Sankar 
<span class="nc" id="L151">		String indent = HtmlUtil.DD_OPTION_INDENT + HtmlUtil.DD_OPTION_INDENT;</span>
<span class="nc" id="L152">		int indexTemp = -1;</span>
<span class="nc" id="L153">		int index = 0;</span>
<span class="nc" id="L154">		int length = 0;</span>
<span class="nc" id="L155">		StringBuffer newString = null;</span>
		
		
<span class="nc bnc" id="L158" title="All 2 branches missed.">		while(iter.hasNext()) {</span>
<span class="nc" id="L159">			Object value = iter.next();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">			if( value instanceof OptionData) {</span>
<span class="nc" id="L161">				OptionData data = (OptionData)value;</span>
<span class="nc" id="L162">				String sValue = data.getValue();</span>
<span class="nc" id="L163">				newString = new StringBuffer(&quot;&quot;);</span>
				
<span class="nc" id="L165">				indexTemp = -1;</span>
<span class="nc" id="L166">				index = 0;</span>
<span class="nc" id="L167">				length = 0;</span>
				
<span class="nc bnc" id="L169" title="All 2 branches missed.">				while(index != -1) {</span>
<span class="nc" id="L170">					index = sValue.indexOf(indent, index + length);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">					if(index != -1) {</span>
<span class="nc" id="L172">						newString.append(HtmlUtil.DD_OPTION_INDENT);</span>
					}
					
<span class="nc" id="L175">					length = indent.length();</span>
					//End of string reached
<span class="nc bnc" id="L177" title="All 2 branches missed.">					if(index == -1) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">						if(indexTemp == -1)</span>
<span class="nc" id="L179">							newString.append(sValue);</span>
						else
<span class="nc" id="L181">							newString.append(sValue.substring(indexTemp + length));</span>
					}
<span class="nc" id="L183">					indexTemp = index;</span>
				}
<span class="nc" id="L185">				data.setValue(newString.toString());</span>
			}			
<span class="nc" id="L187">		}</span>
		
<span class="nc" id="L189">		m_OrganizationListBox.setOptions(m_organizationFilterList);</span>
		
<span class="nc" id="L191">	}</span>

	protected short getListBoxDisplayMaxWidth() {
<span class="nc" id="L194">		return LIST_FILTER_MAX_WIDTH;</span>
	}

	/**
	 * Initialize Component
	 *
	 * @param mediaList Media ID used to initialize Component.
	 *   if valud is not null, it will be used as the only media Option
	 */
	public void init(Collection mediaList) throws Exception {
<span class="nc" id="L204">		initFilterDD();</span>
		//initFilterDD_Organizations();
		//initMediaDD(mediaList);
<span class="nc" id="L207">	}</span>

	public void setMediaID(ID id) {
<span class="nc bnc" id="L210" title="All 2 branches missed.">		if (BLANK_ID.equals(id)) id=null;</span>
<span class="nc" id="L211">		m_mediaID=id;</span>
<span class="nc" id="L212">	}</span>

	public ID getMediaID() {
<span class="nc" id="L215">		return m_mediaID;</span>
	}

	public void setQueueAttributeFilterID(ID id) {
<span class="nc bnc" id="L219" title="All 2 branches missed.">		if(BLANK_ID.equals(id)) id = null;</span>
<span class="nc" id="L220">		m_queueAttribFilterID = id;</span>
<span class="nc" id="L221">	}</span>
	
	public ID getQueueAttributeFilterID() {
		//System.out.println(&quot;Selected Filter Name &quot; + m_queueAttribPicker.getSelectedFilterName());
<span class="nc bnc" id="L225" title="All 2 branches missed.">		if(m_context.getUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER) == null)</span>
<span class="nc" id="L226">			return BLANK_ID;</span>
<span class="nc" id="L227">		return new ID(m_context.getUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER));</span>
	}
	
	public ID getCampaignID() {
		//isCampaignSelected();
<span class="nc" id="L232">		return QueueFilterUtil.retrieveCampaignID(m_context);</span>
	}
	
	
	public void setOrganizationID(ID id) {
<span class="nc bnc" id="L237" title="All 4 branches missed.">		if (id == null || BLANK_ID.equals(id)) {</span>
<span class="nc" id="L238">			id=null;</span>
<span class="nc" id="L239">			OrganizationUtil.setSelectedOrganizationID(m_context, &quot;&quot;);</span>
		} else {
<span class="nc" id="L241">			OrganizationUtil.setSelectedOrganizationID(m_context, id.toString());</span>
		}
<span class="nc" id="L243">		m_organizationID = id;</span>
<span class="nc" id="L244">	}</span>

	public ID getOrganizationID() {
<span class="nc" id="L247">		String orgID = OrganizationUtil.getSelectedOrganizationID(m_context);</span>
<span class="nc bnc" id="L248" title="All 4 branches missed.">		if(orgID == null || orgID.trim().length() &lt; 1)</span>
<span class="nc" id="L249">			m_organizationID = null;</span>
		else
<span class="nc" id="L251">			m_organizationID = new ID(orgID);</span>

<span class="nc" id="L253">		return m_organizationID;</span>
	}
	
	public void setOrgCampSelection(String selection) {
<span class="nc bnc" id="L257" title="All 4 branches missed.">		if(selection == null || selection.trim().length() == 0)</span>
<span class="nc" id="L258">			return;</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">		if(selection.equals(CAMPAIGN_SELECTED))</span>
<span class="nc" id="L260">			restoreCampaigID();</span>
		else
<span class="nc" id="L262">			backupCampaignID();</span>
<span class="nc" id="L263">		m_orgCampSelection = selection;</span>
<span class="nc" id="L264">	}</span>

	public String getOrgCampSelection() {
<span class="nc" id="L267">		return m_orgCampSelection;</span>
	}
	
	private void backupCampaignID() {
<span class="nc" id="L271">		m_tempCampaignID = QueueFilterUtil.getSelectedCampaignID(m_context);</span>
<span class="nc bnc" id="L272" title="All 4 branches missed.">		if(m_tempCampaignID != null &amp;&amp; m_tempCampaignID.trim().length() &gt; 0) {</span>
<span class="nc" id="L273">			m_context.setUserProperty(&quot;TEMP_CAMPAIGN_ID&quot;, m_tempCampaignID);</span>
		}
<span class="nc" id="L275">		QueueFilterUtil.setSelectedCampaignID(m_context, &quot;&quot;);</span>

<span class="nc" id="L277">	}</span>
	
	private void restoreCampaigID() {
<span class="nc" id="L280">		m_tempCampaignID = m_context.getUserProperty(&quot;TEMP_CAMPAIGN_ID&quot;);</span>
<span class="nc bnc" id="L281" title="All 4 branches missed.">		if(m_tempCampaignID != null &amp;&amp; m_tempCampaignID.trim().length() &gt; 0){</span>
<span class="nc" id="L282">			QueueFilterUtil.setSelectedCampaignID(m_context, m_tempCampaignID);</span>
<span class="nc" id="L283">			m_context.setUserProperty(&quot;TEMP_CAMPAIGN_ID&quot;, &quot;&quot;);</span>
<span class="nc" id="L284">			m_tempCampaignID = null;</span>
		}
<span class="nc" id="L286">	}</span>
	
	public boolean isOrganizationSelected() {
		//Initial Loading - Set campaign selected by default, if no permission, fall back to Org as default
<span class="nc bnc" id="L290" title="All 4 branches missed.">		if(m_orgCampSelection == null || m_orgCampSelection.trim().length() &lt; 1) {</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">			if(isCampaignPermitted()) {</span>
<span class="nc" id="L292">				setOrgCampSelection(CAMPAIGN_SELECTED);</span>
<span class="nc" id="L293">				return false;</span>
			}
<span class="nc bnc" id="L295" title="All 2 branches missed.">			if(isOrganizationPermitted()) {</span>
<span class="nc" id="L296">				setOrgCampSelection(ORGANIZATION_SELECTED);</span>
<span class="nc" id="L297">				return true;</span>
			}
<span class="nc" id="L299">			return false;</span>
		}
<span class="nc bnc" id="L301" title="All 4 branches missed.">		return m_orgCampSelection.equals(ORGANIZATION_SELECTED) &amp;&amp; isOrganizationPermitted();</span>
	}
	

	public boolean isCampaignSelected() {
		
		//Initial Loading - Set campaign selected by default		
<span class="nc bnc" id="L308" title="All 4 branches missed.">		if(m_orgCampSelection == null || m_orgCampSelection.trim().length() &lt; 1) {</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">			if(isCampaignPermitted()) {</span>
<span class="nc" id="L310">				setOrgCampSelection(CAMPAIGN_SELECTED);</span>
<span class="nc" id="L311">				return true;</span>
			}
<span class="nc" id="L313">			return false;</span>
		}
		
<span class="nc bnc" id="L316" title="All 4 branches missed.">		return  m_orgCampSelection.equals(CAMPAIGN_SELECTED) &amp;&amp; isCampaignPermitted();</span>
	}
	
	/**
	 * Create Media Display with Hidden Field
	 */
	private Object getMediaUI() {
		//return m_mediaListbox;
<span class="nc" id="L324">		return m_queueAttribPicker;</span>
	}

	/**
	 * Create Top Row
	 */
	protected HtmlTableRow createTopRow() {
<span class="nc bnc" id="L331" title="All 2 branches missed.">		if(!isCampaignPermitted()) {</span>
<span class="nc" id="L332">			return createSpacerRow();</span>
		}
		
<span class="nc" id="L335">		ArrayList rowcells = new ArrayList();</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">		if (m_isFullDisplayMode) {</span>
<span class="nc" id="L337">			HtmlTableCell cell = createLabelCell(getHeader());</span>
<span class="nc" id="L338">			rowcells.add(cell);</span>
		}
		
<span class="nc bnc" id="L341" title="All 2 branches missed.">		if(isOrganizationPermitted()) {</span>
<span class="nc" id="L342">			String label = i18n(m_bbmBundle, BbmWebBundleKey.FILTERBOX_ORGANIZATION);</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">			if(isCampaignPermitted())</span>
<span class="nc" id="L344">				label = HtmlChoiceInput.makeRadioInput(&quot;orgCampSelection&quot;, ORGANIZATION_SELECTED, isOrganizationSelected(), </span>
						JSUtil.REFRESH_PAGE) + label;
<span class="nc" id="L346">			HtmlTableCell cell = new HtmlTableCell(label + &quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L347">			cell.setHeight(&quot;18&quot;);</span>
<span class="nc" id="L348">			cell.setStyleClass(&quot;headerText&quot;);</span>
<span class="nc" id="L349">			cell.setStyle(&quot;white-space:nowrap;&quot;);</span>
<span class="nc" id="L350">			rowcells.add(cell);</span>
		}
		
<span class="nc" id="L353">		return new HtmlTableRow(rowcells);</span>
	}
	
	/**
	 * Create Second Row
	 */
	protected HtmlTableRow createSpacerRow() {
<span class="nc" id="L360">		ListBoxPC listBox = null;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">		if (isCampaignSelected()) {</span>
<span class="nc" id="L362">			listBox = m_listbox;</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">		} else if (isOrganizationSelected()) {</span>
<span class="nc" id="L364">			listBox = m_OrganizationListBox;</span>
		}
<span class="nc" id="L366">		List rowcells = new ArrayList();</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">		if (listBox != null) {</span>
			//Wrapper is an HtmlTableCell
<span class="nc" id="L369">			listBox.getWrapper().setAttribute(&quot;colspan&quot;, &quot;3&quot;);</span>
			//set a longer width, override the default m_filterWidth
<span class="nc" id="L371">			listBox.getSelect().setAttribute(&quot;width&quot;, LIST_FILTER_MAX_WIDTH + &quot;px&quot;);</span>
			//INPUT width 241px + 14px Button
<span class="nc" id="L373">			listBox.setMaxDisplayWidth(LIST_FILTER_MAX_WIDTH);</span>
<span class="nc" id="L374">			rowcells.add(createLabelCell(getHeader()).toString() + listBox.toString());</span>
		}
<span class="nc" id="L376">		return new HtmlTableRow(rowcells);</span>
	}
	
	private boolean isOrganizationPermitted() {
<span class="nc" id="L380">		return false;</span>
	}
	
	private boolean isCampaignPermitted() {
<span class="nc bnc" id="L384" title="All 2 branches missed.">		if(m_isCampaignPermitted == null)</span>
<span class="nc" id="L385">			m_isCampaignPermitted = new Boolean(isLicensed(LicenseKeys.APP_FS));</span>
<span class="nc" id="L386">		return m_isCampaignPermitted.booleanValue();</span>
	}

	/**
	 * Return Bottom Row : Media UI
	 */
	public HtmlTableRow createBottomRow() {
<span class="nc" id="L393">		Object rowData = getMediaUI();</span>
		//((FilterBoxPC)rowData).setGenerateWrapper(false);

<span class="nc" id="L396">		Object[] args = new Object[1];</span>
<span class="nc" id="L397">	    args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="nc" id="L398">	    String label = MessageFormat.format( m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_ATTRIBUTE_FILTER_PICKER_CAPTION), args);</span>
<span class="nc" id="L399">	    label+=&quot;:&quot;;</span>
<span class="nc" id="L400">		m_queueAttribPicker.setHeader(label);</span>
<span class="nc" id="L401">		m_queueAttribPicker.setIsFullDisplayMode(true);</span>
<span class="nc" id="L402">		m_queueAttribPicker.setDisplayLabels(true);</span>
		
<span class="nc" id="L404">		ArrayList rowcells = new ArrayList();</span>
<span class="nc" id="L405">		rowcells.add(createLabelCell(m_queueAttribPicker.getHeader()).toString() + m_queueAttribPicker.toString());</span>
<span class="nc" id="L406">		return new HtmlTableRow(rowcells);</span>
	}

	/**
	 * Extract Parameter
	 */
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L413">		boolean success = super.extractParameters(request);</span>

		// Cache Campaign ID
<span class="nc" id="L416">		String sTmpID = getSelectedFilterName();</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">		if (!StringUtil.isEmpty(sTmpID)) {</span>

			// If One Time Use ID is available then use it instead of extracted value
			// Used by Workpane Refreshing Selection Pane
<span class="nc" id="L421">			ID camID = QueueFilterUtil.retrieveCampaignIDForOneTimeUse(m_context);</span>

<span class="nc bnc" id="L423" title="All 2 branches missed.">			if (camID!=null) sTmpID = camID.toString();</span>

<span class="nc bnc" id="L425" title="All 2 branches missed.">			if (BLANK_ID.toString().equals(sTmpID)) {</span>
				// User Blank Campaign (All Queues Selected)
<span class="nc" id="L427">				QueueFilterUtil.storeCampaignID(m_context, null);</span>
			} else {
<span class="nc" id="L429">				QueueFilterUtil.storeCampaignID(m_context, new ID(sTmpID));</span>
			}
		}

<span class="nc" id="L433">		return success;</span>
	}

	//////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	//////////////////////////////////////////////////////////////////////////////
	private void addBlankOption(List filters, String display, boolean isSelected) {
<span class="nc" id="L440">		OptionData data = new OptionData(display, BLANK_ID.toString(), isSelected);</span>
<span class="nc" id="L441">		filters.add(data);</span>
<span class="nc" id="L442">	}</span>

	/**
	 * init Filter Drown Down of Organizations
	 */
	private void initFilterDD_Organizations() throws Exception {
<span class="nc" id="L448">		ArrayList filters = new ArrayList();</span>
		
		// Create Organization List
<span class="nc" id="L451">		Collection orgList = OrganizationModelHandler.getAllOrgsInUserScope(m_context, m_context.getUser());</span>

		// Retrieve Selected Organization ID
<span class="nc" id="L454">		ID orgID = getOrganizationID();</span>

		
		// Add All Queues Option
<span class="nc bnc" id="L458" title="All 2 branches missed.">		if (m_context.getUser().isAuthorized(PrivilegeKeys.FS_VIEWALLQUEUEHISTORY_ID))</span>
		{
      // verticalise queue
<span class="nc" id="L461">      Object[] args = new Object[1];</span>
<span class="nc" id="L462">      args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="nc" id="L463">      String formattedTitle = MessageFormat.format( m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.ALL_QUEUES), args);</span>

<span class="nc" id="L465">      addBlankOption(filters, formattedTitle, false);</span>
<span class="nc" id="L466">			filters.add( FILTER_OPTION_DIVIDER );</span>
<span class="nc" id="L467">		}</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">		else if (orgID == null)</span>
		{
			//User cannot see the 'All Queues' selection, and there is no cached campaign,
			//so we will just choose the first campaign for him.
<span class="nc bnc" id="L472" title="All 2 branches missed.">			if (orgList != null)</span>
			{
<span class="nc" id="L474">				orgList = SortUtil.sortBasicVO(orgList, m_localizer);</span>
<span class="nc" id="L475">				Organization org = null;</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">				for (Iterator it = orgList.iterator(); it.hasNext();)</span>
				{
<span class="nc" id="L478">					org = (Organization) it.next();</span>
					break;
				}

<span class="nc bnc" id="L482" title="All 2 branches missed.">				if (org != null)</span>
<span class="nc" id="L483">					orgID = org.getID();</span>
			}
		}

<span class="nc bnc" id="L487" title="All 2 branches missed.">		String selectedID = orgID==null?null:orgID.toString();</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">		if(orgList != null) {</span>
<span class="nc" id="L489">			Collection optionList = CampaignModelHandler.createDropDownValueList(orgList, selectedID, m_localizer, false);</span>
<span class="nc" id="L490">			filters.addAll(optionList);</span>
		}
				

		//initFilterWithOptions(filters);
<span class="nc" id="L495">		m_organizationFilterList = filters;</span>
<span class="nc" id="L496">	}</span>

	
	/**
	 * init Filter Drown Down of Campaigns
	 */
	private void initFilterDD() throws Exception {
<span class="nc bnc" id="L503" title="All 2 branches missed.">		if(!isCampaignSelected()) {</span>
<span class="nc" id="L504">			backupCampaignID();</span>
<span class="nc" id="L505">			return;</span>
		}
		
<span class="nc" id="L508">		ArrayList filters = new ArrayList();</span>
		
		// Create Campaign List
<span class="nc" id="L511">		Collection campList = CampaignModelHandler.getCampaignsForUser(m_context, m_context.getUser());</span>

		// Retrieve Selected campaign ID
<span class="nc" id="L514">		ID camID = getCampaignID();</span>
		
		// Add All Queues Option
<span class="nc bnc" id="L517" title="All 2 branches missed.">		if (m_context.getUser().isAuthorized(PrivilegeKeys.FS_VIEWALLQUEUEHISTORY_ID))</span>
		{
	      // verticalise queue
<span class="nc" id="L520">	      Object[] args = new Object[1];</span>
<span class="nc" id="L521">	      args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="nc" id="L522">	      String formattedTitle = MessageFormat.format( m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.ALL_QUEUES), args);</span>

<span class="nc" id="L524">	      addBlankOption(filters, formattedTitle, false);</span>
<span class="nc" id="L525">				filters.add( FILTER_OPTION_DIVIDER );</span>
<span class="nc" id="L526">		}</span>
		else {
			/*
			 *If the user do not have privilege to see all orgs, we still add an option to 
			 *enable no campaign selection. This is mainly to let the user select
			 *and view queues of an org using Queue Attribute Filter. When this option
			 *is selected and no filter option is selected, the queue selection would show queues
			 *of all the campaigns in which the user has permission. - Sankar 
			 */
			
<span class="nc" id="L536">			String formattedTitle=verticalize(m_bbmBundle, BbmWebBundleKey.QUEUE_ATTRIBUTE_NO_CAMPAIGN);</span>
<span class="nc" id="L537">			addBlankOption(filters, formattedTitle, false);</span>
<span class="nc" id="L538">			filters.add( FILTER_OPTION_DIVIDER );</span>

		}
		/*
		 * Removing the below case as we are adding No Campaign option even if the user don't 
		 * have the privilege to see all Organization
		else if (camID == null)
		{
			//User cannot see the 'All Queues' selection, and there is no cached campaign,
			//so we will just choose the first campaign for him.
			if (campList != null)
			{
				campList = SortUtil.sortBasicVO(campList, m_localizer);
				Campaign camp = null;
				for (Iterator it = campList.iterator(); it.hasNext();)
				{
					camp = (Campaign) it.next();
					break;
				}

				if (camp != null)
					camID = camp.getID();
				
				CampaignUtil.setSelectedCampaignID(m_context, camID==null?null:camID.toString());
			}
		}*/

<span class="nc bnc" id="L565" title="All 2 branches missed.">		String selectedID = camID==null?null:camID.toString();</span>

<span class="nc" id="L567">		Collection optionList = CampaignModelHandler.createDropDownValueList(campList, selectedID, m_localizer, false);</span>
<span class="nc" id="L568">		filters.addAll(optionList);</span>

<span class="nc" id="L570">		initFilterWithOptions(filters);</span>
<span class="nc" id="L571">	}</span>
	/**
	 * Initialize the Media Drop Down
	 */
	private void initMediaDD(Collection mediaList) throws Exception {    
<span class="nc bnc" id="L576" title="All 4 branches missed.">		if (mediaList!=null &amp;&amp; !mediaList.isEmpty()) {</span>
<span class="nc" id="L577">			ID selectedID = getMediaID();</span>
<span class="nc" id="L578">			ArrayList filters = new ArrayList(mediaList.size() + 1);</span>
<span class="nc" id="L579">			addBlankOption(filters, &quot;&quot;, false);</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">			for (Iterator it = mediaList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L581">				Media media = (Media)it.next();</span>
<span class="nc" id="L582">				ID mediaID = media.getID();</span>
<span class="nc" id="L583">				boolean isSelected = mediaID.equals(selectedID);</span>
<span class="nc" id="L584">				OptionData data = new OptionData(media.getName(), mediaID.toString(), isSelected);</span>
<span class="nc" id="L585">				filters.add(data);</span>
<span class="nc" id="L586">			}</span>
<span class="nc" id="L587">			m_mediaFilterList = filters;</span>
		}
<span class="nc" id="L589">	}</span>
	
	/**
	 * Return Html Display
	 * Sankar Nair - Overriding this function to ensure that
	 * the alignment of selector pane is matching to Pulse applet 
	 * when both the Campaign picker and Org picker are shown. 
	 */
	public String getHtmlDisplay() {
		// initialize the filters in the listbox
<span class="nc" id="L599">		m_listbox.setOptions(getFilters());</span>

<span class="nc" id="L601">		HtmlTable outer_table = new HtmlTable(&quot;0&quot;, &quot;0&quot;, &quot;0&quot;);</span>
<span class="nc" id="L602">		outer_table.setWidth(OUTER_TABLE_WIDTH);</span>
		//outer_table.add( createTopRow() );
<span class="nc" id="L604">		outer_table.add( createSpacerRow());</span>
		
		// Show bottom is it is in Full Display Mode
<span class="nc bnc" id="L607" title="All 2 branches missed.">		if (m_isFullDisplayMode) {</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">			if (m_isBottomRowEnabled)	outer_table.add( createBottomRow() );</span>
<span class="nc" id="L609">			else outer_table.add( createEmptyBottomRow() );</span>
		}

		//Length specified in the FilterBoxPC class
<span class="nc" id="L613">		String height = &quot;12&quot;;</span>
		//Checking whether both the Org picker and Campaign picker are going to be displayed.
<span class="nc bnc" id="L615" title="All 4 branches missed.">		if(isCampaignPermitted() &amp;&amp; isOrganizationPermitted())</span>
<span class="nc" id="L616">			height = &quot;2&quot;;</span>
		
		// Generate HTML output
<span class="nc" id="L619">		StringBuffer buff = new StringBuffer(1024);</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">		if (useWrapper()) {</span>
<span class="nc" id="L621">			buff.append(&quot;\n&lt;div style=\&quot;margin-top:&quot;);</span>
<span class="nc" id="L622">			buff.append(height);</span>
<span class="nc" id="L623">			buff.append(&quot;px; margin-bottom:7px;\&quot;&gt;&quot;);</span>
		}
		
		

<span class="nc" id="L628">		buff.append(outer_table);</span>
<span class="nc" id="L629">		buff.append(HtmlUtil.makeHiddenInput(getName(), &quot;&quot;));</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">		if (useWrapper()) buff.append(&quot;\n&lt;/div&gt;&quot;);</span>

<span class="nc" id="L632">		return buff.toString();</span>
	}
	
	private boolean isLicensed(String license) {
		//LicenseKeys.APP_FS;
		//LicenseKeys.APP_Operations
<span class="nc bnc" id="L638" title="All 4 branches missed.">		if(license == null || license.trim().length() &lt; 1)</span>
<span class="nc" id="L639">			return false;</span>
		try {
<span class="nc" id="L641">			return CoreManagerFactory.getLicenseManager().isLicensed(license);</span>
<span class="nc" id="L642">		} catch (CoreEJBCreateException e) {</span>
<span class="nc" id="L643">		} catch (RemoteException e) {</span>
<span class="nc" id="L644">		}</span>
<span class="nc" id="L645">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>