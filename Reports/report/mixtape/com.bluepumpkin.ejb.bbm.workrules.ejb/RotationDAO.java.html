<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RotationDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.workrules.ejb</a> &gt; <span class="el_source">RotationDAO.java</span></div><h1>RotationDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.workrules.ejb;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Comparator;
import java.util.Date;
import java.util.LinkedHashMap;
import java.util.LinkedList;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.PaginationPair;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.localization.LocaleContext;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.dao.ManyToOneDependentRelationship;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.WorkUnitDAO;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.WorkUnitShiftPatternDAO;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkUnitFieldInfo;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.OrganizationFieldInfo;
import com.bluepumpkin.ejb.bbm.workrules.model.CalendarPeriodFieldInfo;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRuleFieldInfo;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRuleFieldInfo.Column;
import com.bluepumpkin.ejb.bbm.workrules.model.Rotation;
import com.bluepumpkin.ejb.bbm.workrules.model.RotationSortField;
import com.witness.ejb.bbm.copy.ejb.CopyDAO;

public class RotationDAO extends WorkRuleBaseDAO&lt;Rotation&gt; {
	private CalendarPeriodDAO calendarPeriodDAO;

	private static final String weeksFieldName = &quot;WEEKS&quot;;
	private static final String alignmentDateFieldName = &quot;ALIGNMENTDATE&quot;;

	public RotationDAO() {
<span class="fc" id="L43">		super();</span>
<span class="fc" id="L44">	}</span>

	public RotationDAO(Jdmo dmo) {
<span class="fc" id="L47">		super(dmo);</span>
<span class="fc" id="L48">	}</span>

	@Override
	protected void buildDBRelationships() {
<span class="fc" id="L52">		new WorkUnitShiftPatternDAO(m_dmo);</span>
<span class="fc" id="L53">		new ShiftPatternDAO(m_dmo);</span>
<span class="fc" id="L54">		calendarPeriodDAO = new CalendarPeriodDAO(m_dmo);</span>

<span class="fc" id="L56">		addRelationship(new ManyToOneDependentRelationship(this,</span>
<span class="fc" id="L57">				new WorkUnitDAO(getDMO()), Column.WorkUnitID.getIndex(),</span>
				WorkUnitFieldInfo.WORKUNIT_ID,
				Rotation.ROTATION_WORKUNIT_RELATIONSHIP_KEY));
<span class="fc" id="L60">		addRelationship(new ManyToOneDependentRelationship(this,</span>
<span class="fc" id="L61">				calendarPeriodDAO, getFieldInfo().getFieldIndexByName(</span>
<span class="fc" id="L62">						&quot;CALENDARPERIODID&quot;), calendarPeriodDAO.getFieldInfo()</span>
<span class="fc" id="L63">						.getFieldIndexByName(&quot;ID&quot;),</span>
				Rotation.CALENDAR_PERIOD_RELATIONSHIP_KEY));
<span class="fc" id="L65">	}</span>

	@Override
	protected Rotation createValueObject() {
<span class="fc" id="L69">		return new Rotation();</span>
	}

	public Collection&lt;Rotation&gt; getObjects(String where)
			throws BbmFinderException {
		// DAOBase calls this method with a where string containing an
		// &quot;ORDER BY&quot; clause from its getObjectsByParentIDsInternal method.
		// As a work around, put the where parameter after the getWhereClause()
<span class="fc" id="L77">		return super.getObjects(getWhereClause() + &quot; AND &quot; + where);</span>
	}

	@Override
	protected String getWhereClause() {
<span class="fc" id="L82">		return &quot;WORKUNITCOUNTCONSTRAINT = 6&quot;;</span>
	}

	public void copyToOrg(Collection&lt;ID&gt; rotationIDs, Organization org,
			LocaleContext localeContext) throws BbmCreateException {
<span class="nc" id="L87">		CopyDAO copyDAO = new CopyDAO();</span>
		try {
<span class="nc" id="L89">			Collection&lt;Rotation&gt; rotationsToCopy = getObjectsByIDs(rotationIDs);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">			for (Rotation r : rotationsToCopy) {</span>
<span class="nc" id="L91">				r.setName(copyDAO.getNewNameForCopiedValueObjectWithLengthLimitation(r.getName(),</span>
<span class="nc" id="L92">						getFieldInfo().getTableName(), localeContext, ComplexWorkRuleFieldInfo.NAME_MAX_LENGTH));</span>
<span class="nc" id="L93">				r.setOrganizationID(org.getID());</span>

<span class="nc" id="L95">				alignRuleAlignmentDateWithOrgStart(org.getWeekStartDay().getCalendarConstant(), r);</span>

<span class="nc" id="L97">				r.setFieldValue(Column.ID.getIndex(), (Object) null);</span>
<span class="nc" id="L98">				r.setFieldValue(Column.SID.getIndex(), (Object) null);</span>
<span class="nc" id="L99">				r.setFieldValue(Column.CreatedBy.getIndex(),</span>
<span class="nc" id="L100">						getCallerPrincipal());</span>
<span class="nc" id="L101">				r.setFieldValue(Column.CreatedOn.getIndex(), new Date());</span>
<span class="nc" id="L102">				r.setFieldValue(Column.ModifiedOn.getIndex(), (Object) null);</span>
<span class="nc" id="L103">				r.setFieldValue(Column.ModifiedBy.getIndex(), (Object) null);</span>
<span class="nc" id="L104">			}</span>

<span class="nc" id="L106">			createObjects(rotationsToCopy);</span>
<span class="nc" id="L107">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L108">			throw new BbmCreateException(e);</span>
<span class="nc" id="L109">		}</span>
<span class="nc" id="L110">	}</span>

	private void alignRuleAlignmentDateWithOrgStart(int orgWeekStart, Rotation r) {
<span class="nc" id="L113">		LocalDate alignmentDate = r.getAlignmentDate(); </span>
		//r.getAlignmentDate() will return a brand new calendar that has not been evaluated yet.
		//to make the calendar understand we are interested in the specific week whenever set week start.
		//we have to force calendar to evaluate, any get method will do, here we use get week_of_year.
<span class="nc" id="L117">		alignmentDate.get(Calendar.WEEK_OF_YEAR);</span>
<span class="nc" id="L118">		alignmentDate.set(Calendar.DAY_OF_WEEK, orgWeekStart);</span>
<span class="nc" id="L119">		r.setAlignmentDate(alignmentDate);</span>
<span class="nc" id="L120">	}</span>

	@Override
	protected Object getPaginationDataFieldValue(JdmoRowset rowData,
			DBSortField sortField) throws JdmoException {
<span class="nc" id="L125">		RotationSortField rsf = (RotationSortField) sortField;</span>
<span class="pc bnc" id="L126" title="All 6 branches missed.">		switch (rsf) {</span>
		case ID:
<span class="nc" id="L128">			return rowData.getObject(Column.ID.getFieldInfoEntry()</span>
<span class="nc" id="L129">					.getFieldName());</span>
		case Name:
<span class="nc" id="L131">			return rowData.getObject(Column.Name.getFieldInfoEntry()</span>
<span class="nc" id="L132">					.getFieldName());</span>
		case Organization:
<span class="nc" id="L134">			OrganizationFieldInfo ofi = new OrganizationFieldInfo();</span>
<span class="nc" id="L135">			return rowData.getObject(ofi</span>
<span class="nc" id="L136">					.getFieldName(OrganizationFieldInfo.ORGANIZATION_NAME));</span>
		case Weeks:
<span class="nc" id="L138">			return rowData.getObject(weeksFieldName);</span>
		case AlignmentDate:
<span class="nc" id="L140">			return rowData.getObject(alignmentDateFieldName);</span>
		default:
			break;
		}
<span class="nc" id="L144">		return null;</span>
	}

	@Override
	protected void buildSortQuery(List&lt;DBSortField&gt; sortFields,
			StringBuffer selectClause, StringBuffer fromClause,
			StringBuffer whereClause, StringBuffer groupByClause,
			StringBuffer orderByClause) {
<span class="fc" id="L152">		CalendarPeriodFieldInfo cpfi = new CalendarPeriodFieldInfo();</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">		for (DBSortField sf : sortFields) {</span>
<span class="fc" id="L154">			RotationSortField sortField = (RotationSortField) sf;</span>
<span class="pc bpc" id="L155" title="5 of 6 branches missed.">			switch (sortField) {</span>
			case ID:
<span class="fc" id="L157">				orderByClause.append(Column.ID.getFieldInfoEntry()</span>
<span class="fc" id="L158">						.getFieldName());</span>
<span class="fc" id="L159">				break;</span>
			case Name:
<span class="nc" id="L161">				String columnName = Column.Name.getFieldInfoEntry()</span>
<span class="nc" id="L162">						.getFieldName();</span>
<span class="nc" id="L163">				selectClause.append(&quot;, A.&quot;).append(columnName);</span>
<span class="nc" id="L164">				orderByClause.append(columnName);</span>
<span class="nc" id="L165">				break;</span>
			case Organization:
<span class="nc" id="L167">				OrganizationFieldInfo ofi = new OrganizationFieldInfo();</span>
<span class="nc" id="L168">				selectClause</span>
<span class="nc" id="L169">						.append(&quot;, E.&quot;)</span>
<span class="nc" id="L170">						.append(ofi</span>
<span class="nc" id="L171">								.getFieldName(OrganizationFieldInfo.ORGANIZATION_NAME));</span>
<span class="nc" id="L172">				fromClause.append(&quot;, &quot;).append(ofi.getTableName())</span>
<span class="nc" id="L173">						.append(&quot; E &quot;);</span>

<span class="nc bnc" id="L175" title="All 2 branches missed.">				if (whereClause.length() == 0) {</span>
<span class="nc" id="L176">					whereClause.append(&quot; WHERE &quot;);</span>
				} else {
<span class="nc" id="L178">					whereClause.append(&quot; AND &quot;);</span>
				}
<span class="nc" id="L180">				whereClause</span>
<span class="nc" id="L181">						.append(&quot;A.&quot;)</span>
<span class="nc" id="L182">						.append(Column.OrganizationID.getFieldInfoEntry()</span>
<span class="nc" id="L183">								.getFieldName()).append(&quot;=E.&quot;)</span>
<span class="nc" id="L184">						.append(ofi.getIDFieldName());</span>

<span class="nc" id="L186">				orderByClause</span>
<span class="nc" id="L187">						.append(&quot;E.&quot;)</span>
<span class="nc" id="L188">						.append(ofi</span>
<span class="nc" id="L189">								.getFieldName(OrganizationFieldInfo.ORGANIZATION_NAME));</span>
<span class="nc" id="L190">				break;</span>
			case AlignmentDate:
<span class="nc" id="L192">				selectClause</span>
<span class="nc" id="L193">						.append(&quot;, (SELECT E.&quot;)</span>
<span class="nc" id="L194">						.append(cpfi</span>
<span class="nc" id="L195">								.getFieldName(CalendarPeriodFieldInfo.CALENDARPERIOD_ALIGNMENTDATE))</span>
<span class="nc" id="L196">						.append(&quot; FROM &quot;)</span>
<span class="nc" id="L197">						.append(cpfi.getTableName())</span>
<span class="nc" id="L198">						.append(&quot; E&quot;)</span>
<span class="nc" id="L199">						.append(&quot; WHERE E.&quot;)</span>
<span class="nc" id="L200">						.append(cpfi.getIDFieldName())</span>
<span class="nc" id="L201">						.append(&quot; = A.&quot;)</span>
<span class="nc" id="L202">						.append(Column.CalendarPeriodID.getFieldInfoEntry()</span>
<span class="nc" id="L203">								.getFieldName()).append(&quot;) AS &quot;)</span>
<span class="nc" id="L204">						.append(alignmentDateFieldName);</span>
<span class="nc" id="L205">				orderByClause.append(alignmentDateFieldName);</span>
<span class="nc" id="L206">				break;</span>
			case Weeks:
<span class="nc" id="L208">				selectClause</span>
<span class="nc" id="L209">						.append(&quot;, (SELECT E.&quot;)</span>
<span class="nc" id="L210">						.append(cpfi</span>
<span class="nc" id="L211">								.getFieldName(CalendarPeriodFieldInfo.CALENDARPERIOD_UNITCOUNT))</span>
<span class="nc" id="L212">						.append(&quot; FROM &quot;)</span>
<span class="nc" id="L213">						.append(cpfi.getTableName())</span>
<span class="nc" id="L214">						.append(&quot; E&quot;)</span>
<span class="nc" id="L215">						.append(&quot; WHERE E.&quot;)</span>
<span class="nc" id="L216">						.append(cpfi.getIDFieldName())</span>
<span class="nc" id="L217">						.append(&quot; = A.&quot;)</span>
<span class="nc" id="L218">						.append(Column.CalendarPeriodID.getFieldInfoEntry()</span>
<span class="nc" id="L219">								.getFieldName()).append(&quot;) AS &quot;)</span>
<span class="nc" id="L220">						.append(weeksFieldName);</span>
<span class="nc" id="L221">				orderByClause.append(weeksFieldName);</span>
<span class="nc" id="L222">				break;</span>
			default:
				break;
			}
<span class="fc" id="L226">		}</span>

<span class="pc bpc" id="L228" title="1 of 2 branches missed.">		if (whereClause.length() &gt; 0) {</span>
<span class="fc" id="L229">			int insertIdx = 0;</span>
<span class="fc" id="L230">			String whereClauseStr = whereClause.toString();</span>
<span class="fc" id="L231">			String whereClauseStrTrimmed = whereClauseStr.trim();</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">			if (whereClauseStrTrimmed.length() &gt; 6</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">					&amp;&amp; &quot;WHERE &quot;.equalsIgnoreCase(whereClauseStrTrimmed</span>
<span class="fc" id="L234">							.substring(0, 6))) {</span>
<span class="fc" id="L235">				insertIdx = whereClauseStr.toLowerCase().indexOf(&quot;where &quot;) + 6;</span>
			}
<span class="fc" id="L237">			whereClause.insert(insertIdx, &quot;(&quot;);</span>
<span class="fc" id="L238">			whereClause.append(&quot;) AND &quot;);</span>
		}
<span class="fc" id="L240">		whereClause.append(getWhereClause());</span>
<span class="fc" id="L241">	}</span>

	public PaginationPair&lt;Rotation&gt; getRotationsForOrgAndAncestors(
			ID selectedOrgID, int pageSize, int pageIndex,
			LinkedHashMap&lt;RotationSortField, Comparator&gt; sortFields,
			boolean isAscending, String filterByName) throws BbmFinderException {
<span class="fc" id="L247">		StringBuffer whereClause = new StringBuffer();</span>
<span class="fc" id="L248">		whereClause</span>
<span class="fc" id="L249">				.append(&quot;ORGANIZATIONID IN (SELECT ID from FN_TF_CF_getParentOrgsIncludingChild(&quot;)</span>
<span class="fc" id="L250">				.append(JdmoUtil.asSqlLiteral(selectedOrgID)).append(&quot;) )&quot;);</span>
<span class="pc bpc" id="L251" title="3 of 4 branches missed.">		if (filterByName != null &amp;&amp; filterByName.length() &gt; 0) {</span>
<span class="nc" id="L252">			whereClause.append(&quot; AND A.NAME LIKE '%&quot;)</span>
<span class="nc" id="L253">					.append(filterByName.replaceAll(&quot;'&quot;, &quot;''&quot;)).append(&quot;%'&quot;);</span>
		}

<span class="fc" id="L256">		return super.getCompletePaginationDataSet(whereClause.toString(),</span>
				isAscending, pageSize, pageIndex,
				new LinkedHashMap&lt;DBSortField, Comparator&gt;(sortFields),
				new LinkedList&lt;ID&gt;());
	}

	/**
	 * Returns a list of the rotation rule names by shift pattern ids
	 * 
	 * @param ids
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;String&gt; getRotationRulesNameByShiftPatternIDs(
			Collection&lt;ID&gt; ids) throws BbmFinderException {
<span class="fc" id="L271">		ArrayList&lt;String&gt; rotationName = new ArrayList&lt;String&gt;();</span>
<span class="pc bpc" id="L272" title="2 of 4 branches missed.">		if (ids == null || ids.size() &lt;= 0) {</span>
<span class="nc" id="L273">			return rotationName;</span>
		}
<span class="fc" id="L275">		JdmoRowset rs = null;</span>

		try {
<span class="fc" id="L278">			StringBuffer strSQL = new StringBuffer();</span>
<span class="fc" id="L279">			strSQL.append(</span>
					&quot;SELECT DISTINCT CWR.NAME AS NAME FROM COMPLEXWORKRULE CWR INNER JOIN WORKUNIT WU ON CWR.WORKUNITID = WU.ID &quot;)
<span class="fc" id="L281">					.append(&quot; INNER JOIN WORKUNITSHIFTPATTERN WUSP on WU.ID =  WUSP.WORKUNITID INNER JOIN SHIFTPATTERN SP ON WUSP.SHIFTPATTERNID = SP.ID &quot;)</span>
<span class="fc" id="L282">					.append(&quot; WHERE WORKUNITCOUNTCONSTRAINT = 6 AND SP.SID IN &quot;)</span>
<span class="fc" id="L283">					.append(m_dmo.createInClause(ids))</span>
<span class="fc" id="L284">					.append(&quot; ORDER BY NAME ASC &quot;);</span>

<span class="fc" id="L286">			rs = m_dmo.createRowset(new String(strSQL));</span>

<span class="pc bpc" id="L288" title="1 of 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L289">				rotationName.add(rs.getString(&quot;NAME&quot;));</span>
			}
<span class="nc" id="L291">		} catch (JdmoException e) {</span>
<span class="nc" id="L292">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L294">			try {</span>
<span class="pc bpc" id="L295" title="3 of 4 branches missed.">				if (rs != null) {</span>
<span class="pc" id="L296">					rs.close();</span>
				}
<span class="nc" id="L298">			} catch (JdmoException e) {</span>
<span class="nc" id="L299">				throw new BbmFinderException(e);</span>
<span class="pc" id="L300">			}</span>
		}
<span class="fc" id="L302">		return rotationName;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>