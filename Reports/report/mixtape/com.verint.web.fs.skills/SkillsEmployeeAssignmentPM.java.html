<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SkillsEmployeeAssignmentPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.skills</a> &gt; <span class="el_source">SkillsEmployeeAssignmentPM.java</span></div><h1>SkillsEmployeeAssignmentPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.skills;

import java.rmi.RemoteException;
import java.text.NumberFormat;
import java.text.ParseException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.Set;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.DayOfWeek;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.ArrayUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.people.ejb.PeopleFacade;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.skill.SkillModelHandler;
import com.bluepumpkin.web.core.pagecomponent.time.TimePeriodSelectorController;
import com.bluepumpkin.web.core.pagecomponent.time.TimePeriodSelectorPC;
import com.bluepumpkin.web.core.pagecomponent.time.TimePeriodSelectorWeekController;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.l10n.FsWebLogBundleKey;
import com.verint.web.fs.employee.assignment.WfmEmployeeAssignmentPM;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.CacheUtil;
import com.witness.web.uif.util.js.JSDateTimeUtil;
import com.witness.web.uif.util.js.JSValidatorUtil;
import com.witness.web.uif.validator.InRangeFieldValidator;

public class SkillsEmployeeAssignmentPM extends WfmEmployeeAssignmentPM {
	private static final long serialVersionUID = 1L;

<span class="fc" id="L68">	protected boolean isByOrg = true;</span>
	protected final ResourceBundle m_bundle;
	protected SchedulingPeriod selectedSP;
	protected Campaign selectedCampaign;

	//key = employee ID
<span class="fc" id="L74">	private Map&lt;ID, Employee&gt; employeeMap = new HashMap&lt;ID, Employee&gt;();</span>
	//key = employee ID, value = collection of skill assignments
	private Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; skillAssignmentMap;
	private boolean didTimePeriodChange;
	private String m_proficiency;
	private Map&lt;ID, Integer&gt; m_chatSessionMap;
<span class="fc" id="L80">	private boolean isViewPeriodValidForAllEmployees = true;</span>

	private SkillsInlineEditListPC pc_skill;
	private TimePeriodSelectorPC pc_timePeriod;
	private FormInputPC employeeProficiencyPC;
	private FormInputPC employeeChatPC;
	//We need to get the added/removed skill assignments when the pc_skill component
	//extracts its params so we can determine whether or not to disable employeeChatPC
	private Collection&lt;SkillAssignment&gt; addedSkillAssignments;
	private Collection&lt;SkillAssignment&gt; removedSkillAssignments;

	private static final String PROFICIENCY_FN = &quot;proficiencyFN&quot;;
	public static final String NUM_CHAT_FN = &quot;skillsAssignmentNumChatFN&quot;;

	public static final String EMPLOYEE_ID_LIST_CONTEXT_KEY = &quot;com.verint.web.fs.skills.employeeIDs&quot;;

	private Map&lt;ID, List&lt;Integer&gt;&gt; authorizedViewFields;		// Authorized fields for viewing
	private Map&lt;ID, List&lt;Integer&gt;&gt; authorizedEditFields;		// Authorized fields for editing

	public SkillsEmployeeAssignmentPM(RequestContext context) {
<span class="fc" id="L100">		super(context, PageModel.FRAMED_MODEL);</span>
<span class="fc" id="L101">		m_bundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L102">		didTimePeriodChange = SkillsEmployeeAssignmentRH.didTimePeriodChange(context);</span>

<span class="fc" id="L104">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="fc" id="L105">		addJSVariable(JSDateTimeUtil.getDateFormatJSVariables(m_localizer));</span>

		//We need to add these JS variables for the field validators to work properly
<span class="fc" id="L108">		JSValidatorUtil.addVDJSVars(this);</span>
<span class="fc" id="L109">	}</span>

	public static SkillsEmployeeAssignmentPM getInstance(RequestContext context) {
<span class="fc" id="L112">		return (SkillsEmployeeAssignmentPM) PageModel.getInstance(context, SkillsEmployeeAssignmentPM.class);</span>
	}

	@Override
	protected void initForm() {
<span class="fc" id="L117">		initContextDateFieldNames(START_DATE_FN, END_DATE_FN);</span>

		// moved out of the if block so dates are available even if no employees are selected,
		// to avoid null pointed exception
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">		if (pc_timePeriod != null &amp;&amp;</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">			pc_timePeriod.getSelectedDateRange() != null &amp;&amp;</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">			pc_timePeriod.getSelectedDateRange().getFirst() != null &amp;&amp;</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">			pc_timePeriod.getSelectedDateRange().getSecond() != null) {</span>
<span class="fc" id="L125">			viewStartDate = pc_timePeriod.getSelectedDateRange().getFirst();</span>
<span class="fc" id="L126">			viewEndDate = pc_timePeriod.getSelectedDateRange().getSecond();</span>
		}

<span class="pc bpc" id="L129" title="1 of 2 branches missed.">		if (getSelectedIDSize() &gt; 0) {</span>
			//Setting list of employeeIDs in context for the associated popup window (the list may be too large
			//  to use as a query string param)
<span class="fc" id="L132">			CacheUtil.setCachedValue(m_context, CacheUtil.CACHE_MODE_SESSION, EMPLOYEE_ID_LIST_CONTEXT_KEY,</span>
<span class="fc" id="L133">					StringUtil.createDelimitedString(getSelectedIDs(), StringUtil.DELIM));</span>

<span class="fc bfc" id="L135" title="All 2 branches covered.">			if (getSelectedIDSize() &gt; 1) setIsMultiObjEditEnabled(true);</span>

			try {
				//Loading this data here instead of loadData because we need the date range from the date selector
<span class="fc" id="L139">				employeeMap = EmployeeModelHandler.getEmployeeMap(m_context, getSelectedIDsAsCollection(), viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>

<span class="fc" id="L141">				initializeSecureFieldMetaData();  // Initialize the data required to determine if fields are viewable/editable.</span>

<span class="pc bpc" id="L143" title="1 of 2 branches missed.">				if (isEditable() == false) {</span>
<span class="nc" id="L144">					addPageMessage(Message.WARNING_TYPE,</span>
							FsWebBundleKey.FS_SKILLS_NOT_ALL_EMPLOYEES_EDITABLE, FsWebBundleKey.BUNDLE_NAME);
				}

<span class="fc" id="L148">				ArrayList&lt;String&gt; invalidEmployeeNames = new ArrayList&lt;String&gt;();</span>
				//Check to see if all employees start/end dates overlap with the view period.  If not, display
				// a message to the user and do not render the page.
<span class="fc bfc" id="L151" title="All 2 branches covered.">				for (Employee emp : employeeMap.values()) {</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">					if (emp.getStartTimeLocal().after(viewEndDate) ||</span>
<span class="pc bpc" id="L153" title="1 of 4 branches missed.">							(emp.getEndTimeLocal() != null &amp;&amp; emp.getEndTimeLocal().before(viewStartDate))) {</span>
<span class="nc" id="L154">						isViewPeriodValidForAllEmployees = false;</span>
<span class="nc" id="L155">						invalidEmployeeNames.add(m_localizer.formatName(emp));</span>
					}
<span class="fc" id="L157">				}</span>

<span class="pc bpc" id="L159" title="1 of 2 branches missed.">				if (isViewPeriodValidForAllEmployees) {</span>
<span class="fc" id="L160">					loadSkills();</span>

<span class="fc bfc" id="L162" title="All 2 branches covered.">					for (ID employeeID : getSelectedIDsAsCollection()) {</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">						if (skillAssignmentMap.keySet().contains(employeeID) == false) {</span>
<span class="fc" id="L164">							Set&lt;SkillAssignment&gt; set = Collections.emptySet();</span>
<span class="fc" id="L165">							skillAssignmentMap.put(employeeID, set);</span>
						}
<span class="fc" id="L167">					}</span>
<span class="fc" id="L168">					m_proficiency = SkillsAssignmentMH.getProficiencyForEmployees(m_context, getSelectedIDsAsCollection(),</span>
<span class="fc" id="L169">							viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
<span class="fc" id="L170">					m_chatSessionMap = SkillsAssignmentMH.getNumberOfChatSessionsForEmployees(m_context, getSelectedIDsAsCollection(), true);</span>
				} else {
<span class="nc" id="L172">					StringBuffer namesStr = new StringBuffer();</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">					for (String empName : invalidEmployeeNames) {</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">						if(!StringUtil.isEmpty(namesStr.toString()))</span>
<span class="nc" id="L175">							namesStr.append(&quot;; &quot;);</span>
<span class="nc" id="L176">						namesStr.append(empName);</span>
<span class="nc" id="L177">					}</span>
<span class="nc" id="L178">					addPageMessage(Message.ERROR_TYPE, FsWebBundleKey.FS_VIEW_DATE_OUT_OF_RANGE_FOR_EMP_WORK_RULE_ASSIGNMENT,</span>
<span class="nc" id="L179">							FsWebBundleKey.BUNDLE_NAME, new String[] {namesStr.toString()});</span>
				}

<span class="pc bpc" id="L182" title="1 of 2 branches missed.">				if (isViewPeriodValidForAllEmployees) {</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">					if (selectedSP != null) {</span>
<span class="nc" id="L184">						pc_skill = new SkillsInlineEditListPC(m_context, &quot;skillTable&quot;,</span>
<span class="nc" id="L185">								skillAssignmentMap, viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc" id="L186">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), selectedSP, selectedCampaign, didTimePeriodChange,</span>
<span class="nc" id="L187">								getSelectedIDsAsCollection(), this, getOnSkillRemovedJS(), isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY),</span>
<span class="nc" id="L188">								isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>
					} else {
<span class="fc" id="L190">						pc_skill = new SkillsInlineEditListPC(m_context, &quot;skillTable&quot;,</span>
<span class="fc" id="L191">								skillAssignmentMap, viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="fc" id="L192">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), null, null,</span>
<span class="fc" id="L193">								didTimePeriodChange, getSelectedIDsAsCollection(), this, getOnSkillRemovedJS(),</span>
<span class="fc" id="L194">								isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY), isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>
					}
<span class="fc" id="L196">					addedSkillAssignments = pc_skill.getAddedSkillAssignments();</span>
<span class="fc" id="L197">					removedSkillAssignments = pc_skill.getRemovedSkillAssignments(skillAssignmentMap);</span>

					//Add proficiency/number of chat sessions form
<span class="fc" id="L200">					FormTwoColumnPC m_formPC = new FormTwoColumnPC(m_context);</span>
<span class="fc" id="L201">					m_formPC.setName(&quot;proficiencyChatForm&quot;);</span>
<span class="fc" id="L202">					m_formPC.setIsBorderEnabled(true);</span>

<span class="fc" id="L204">					employeeProficiencyPC = new FormInputPC(m_context);</span>
<span class="fc" id="L205">					employeeProficiencyPC.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L206">					employeeProficiencyPC.setInputFN(PROFICIENCY_FN);</span>
<span class="fc" id="L207">					employeeProficiencyPC.setIsReadOnly(false);</span>
<span class="fc" id="L208">					employeeProficiencyPC.setIsRequired(false);</span>
<span class="fc" id="L209">					employeeProficiencyPC.setInputFieldDesc(FsWebBundleKey.EMPLOYEE_PROFICIENCY, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L210">					employeeProficiencyPC.setSize(5);</span>
<span class="fc" id="L211">					employeeProficiencyPC.initForDisplay();</span>

<span class="pc bpc" id="L213" title="2 of 4 branches missed.">					employeeProficiencyPC.setEnabled(isEditable() &amp;&amp; isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>
<span class="fc" id="L214">					employeeProficiencyPC.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>

<span class="fc" id="L216">					employeeProficiencyPC.extractParameters(m_context.getRequest());</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">					if (StringUtil.isEmpty(employeeProficiencyPC.getInputValue())) {</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">						if (MULTI_VALUE_DATA.equals(m_proficiency)) employeeProficiencyPC.setInputValue(m_proficiency);</span>
						else {
<span class="fc" id="L220">							NumberFormat formatter = NumberFormat.getInstance(m_localizer.getLocaleContext().getRegionalFormatLocale());</span>
<span class="fc" id="L221">							formatter.setMaximumFractionDigits(1);</span>
<span class="fc" id="L222">							double proficiency = Double.parseDouble(m_proficiency); // This value is with decimal always it seems.</span>
<span class="fc" id="L223">							employeeProficiencyPC.setInputValue(formatter.format(proficiency));</span>
						}
					}

<span class="pc bpc" id="L227" title="1 of 2 branches missed.">					if (isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY)) {</span>
<span class="fc" id="L228">						String title_proficiency = m_localizer.i18n(</span>
								FsWebBundleKey.BUNDLE_NAME,
								FsWebBundleKey.EMPLOYEE_PROFICIENCY);
<span class="fc" id="L231">						m_formPC.addRow(title_proficiency, employeeProficiencyPC.getHtmlDisplay());</span>
<span class="fc" id="L232">						m_formPC.addChildComponent(employeeProficiencyPC);</span>
<span class="fc" id="L233">						InRangeFieldValidator empProfValidator = new InRangeFieldValidator(this, PROFICIENCY_FN,</span>
								FsWebBundleKey.EMPLOYEE_PROFICIENCY, FsWebBundleKey.BUNDLE_NAME, 0.00, 9.9);
<span class="fc" id="L235">						empProfValidator.setValidateClientSideOnly(true);</span>
<span class="fc" id="L236">						addValidator(empProfValidator);</span>
					}

<span class="fc" id="L239">					employeeChatPC = new FormInputPC(m_context);</span>
<span class="fc" id="L240">					employeeChatPC.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L241">					employeeChatPC.setInputFN(NUM_CHAT_FN);</span>
<span class="fc" id="L242">					employeeChatPC.setIsRequired(false);</span>
<span class="fc" id="L243">					employeeChatPC.setInputFieldDesc(FsWebBundleKey.EMPLOYEE_NUM_CHAT, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L244">					employeeChatPC.setSize(5);</span>
<span class="fc" id="L245">					employeeChatPC.initForDisplay();</span>
<span class="fc" id="L246">					employeeChatPC.extractParameters(m_context.getRequest());</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">					if (isNumberOfChatSessionsDisabled()) {</span>
<span class="fc" id="L248">						employeeChatPC.setIsReadOnly(true);</span>
<span class="fc" id="L249">						employeeChatPC.setEnabled(false);</span>
					}
<span class="fc bfc" id="L251" title="All 2 branches covered.">					if (StringUtil.isEmpty(employeeChatPC.getInputValue())) {</span>
<span class="fc" id="L252">						employeeChatPC.setInputValue(getNumberOfChatSessionsForEmployees(m_chatSessionMap,</span>
								employeeMap, m_localizer));
					}

					// If overall editability is disabled, it trumps any enabled setting prior to this.
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">					if(!isEditable()) employeeChatPC.setEnabled(false);</span>

<span class="fc" id="L259">					InRangeFieldValidator empChatValidator = new InRangeFieldValidator(this,</span>
							NUM_CHAT_FN, FsWebBundleKey.EMPLOYEE_NUM_CHAT, FsWebBundleKey.BUNDLE_NAME, 1, 99);
<span class="fc" id="L261">					empChatValidator.setValidateClientSideOnly(true);</span>
<span class="fc" id="L262">					addValidator(empChatValidator);</span>
<span class="fc" id="L263">					String title_numchat = m_localizer.i18n(</span>
							FsWebBundleKey.BUNDLE_NAME,
							FsWebBundleKey.EMPLOYEE_NUM_CHAT);
<span class="fc" id="L266">					m_formPC.addRow(title_numchat, employeeChatPC.getHtmlDisplay());</span>
<span class="fc" id="L267">					m_formPC.addChildComponent(employeeChatPC);</span>
<span class="fc" id="L268">					addForm(m_formPC);</span>

					//Skill Assignment Container
<span class="fc" id="L271">					CollapsibleContainerPC skillAssignmentContainer = new CollapsibleContainerPC(m_context);</span>
<span class="fc" id="L272">					skillAssignmentContainer.setName(&quot;skillAssignmentContainer&quot;);</span>
<span class="fc" id="L273">					skillAssignmentContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
							FsWebBundleKey.SKILLASSIGNED));
<span class="fc" id="L275">					skillAssignmentContainer.setIsBorderEnabled(true);</span>
<span class="fc" id="L276">					pc_skill.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="fc" id="L277">					pc_skill.setIsInnerTable(true);</span>
<span class="fc" id="L278">					pc_skill.setIsBorderEnabled(false);</span>
<span class="fc" id="L279">					pc_skill.setIsCancelSelectEventPropagation(false);</span>
<span class="fc" id="L280">					pc_skill.setPreRowRemoveJS(getPreSkillRemovedJS());</span>
<span class="fc" id="L281">					pc_skill.setOnRowAddJS(getOnRowAddJS());</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">					if(!isEditable()) {</span>
<span class="nc" id="L283">						pc_skill.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L284">						pc_skill.setEnabled(false);</span>
					}

<span class="fc" id="L287">					skillAssignmentContainer.addComponent(pc_skill);</span>
<span class="fc" id="L288">					addChildComponent(skillAssignmentContainer);</span>
<span class="fc" id="L289">					addForm(skillAssignmentContainer);</span>
				}
<span class="nc" id="L291">			} catch (Exception e) {</span>
<span class="nc" id="L292">				handleUnableToLoadDataError(log, e);</span>
<span class="pc" id="L293">			}</span>
		} else {
<span class="nc" id="L295">			addPageMessage(Message.INSTRUCTION_TYPE, getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
					BbmWebBundleKey.SELECT_EMPLOYEE));
		}
<span class="fc" id="L298">	}</span>

	protected void initContentTitle() {
<span class="fc" id="L301">		super.initContentTitle();</span>

<span class="fc" id="L303">		m_contentTitlePC.setPageTitle(i18n(m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME),</span>
				BbmWebBundleKey.PEOPLE_SKILLS_LIST_PAGE_TITLE));
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">		if (getSelectedIDSize() &gt; 0) {</span>
			try {

<span class="fc bfc" id="L308" title="All 2 branches covered.">				if (isMultiEdit()) {</span>
<span class="fc" id="L309">					m_contentTitlePC.setItemName(m_localizer.i18n(m_bundle, FsWebBundleKey.N_PEOPLE, getSelectedIDSize()));</span>
				}
				else {
<span class="fc" id="L312">					Employee emp = EmployeeModelHandler.getEmployeeByID(getRequestContext(), getSelectedIDObject());</span>
<span class="fc" id="L313">					m_contentTitlePC.setItemName(m_localizer.formatName(emp.getPerson()));</span>
				}
<span class="nc" id="L315">			} catch (Exception ex) {</span>
<span class="nc" id="L316">				handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L317">			}</span>
		}
<span class="fc" id="L319">		TimePeriodSelectorController controller = getTimePeriodSelectorController();</span>
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">		if (controller != null) {</span>
<span class="fc" id="L321">			pc_timePeriod = new TimePeriodSelectorPC(m_context, controller);</span>

<span class="fc" id="L323">			EmployeeAssignmentPMUtil.storeSelectedDateRangeInSession(pc_timePeriod, m_context);</span>

<span class="fc" id="L325">			this.addChildComponent(pc_timePeriod);</span>
<span class="fc" id="L326">			m_contentTitlePC.setActiveComponent(pc_timePeriod);</span>
		}
<span class="fc" id="L328">	}</span>

	protected TimePeriodSelectorController getTimePeriodSelectorController() {
<span class="fc" id="L331">		Integer weekStart = null;</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">		if (getSelectedIDSize() &gt; 0) {</span>
			try {
				//Determine the week start day based on the selected employees.  If all the selected
				// employees' orgs have the same week start day, it will use that day.  Otherwise, it will
				// use the week start day of the root organization.
<span class="fc" id="L337">				PeopleFacade pf = BbmManagerFactory.getPeopleFacade();</span>
<span class="fc" id="L338">				HashMap&lt;ID, Integer&gt; empWeekStarts =</span>
<span class="fc" id="L339">						pf.getEmployeeWeekStarts(getSelectedIDsAsCollection(), new Date());</span>
<span class="fc bfc" id="L340" title="All 2 branches covered.">				for (Integer empWeekStart : empWeekStarts.values()) {</span>
<span class="fc bfc" id="L341" title="All 2 branches covered.">					if (weekStart == null) weekStart = empWeekStart;</span>
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">					else if (weekStart.equals(empWeekStart) == false) {</span>
<span class="nc" id="L343">						WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L344">						weekStart = (int)wrm.getOrganizationByID(Organization.ROOT_ORG_ID_OBJ).getWeekStartDate();</span>
<span class="nc" id="L345">						break;</span>
					}
<span class="fc" id="L347">				}</span>
<span class="nc" id="L348">			} catch (Exception e) {</span>
<span class="nc" id="L349">				log.warn(m_localizer.i18n(FsWebLogBundleKey.BUNDLE_NAME, FsWebLogBundleKey.COULD_NOT_GET_WEEK_START_FOR_EMP, getSelectedIDObject()), e);</span>
<span class="fc" id="L350">			}</span>
		}
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">		if (weekStart == null) weekStart = 1;		//Default of 1 (sunday), but this shouldn't matter since we only set it here if there are no employees selected</span>
<span class="fc" id="L353">		DayOfWeek dow = DayOfWeek.from0SundayCount(weekStart-1); // Org week start is a 1=sunday based number.</span>
<span class="fc" id="L354">		return new TimePeriodSelectorWeekController(dow, m_context);</span>
	}

	protected boolean isMultiEdit() {
<span class="fc bfc" id="L358" title="All 2 branches covered.">		return getSelectedIDSize() &gt; 1;</span>
	}

	private boolean isEditable() {
<span class="fc bfc" id="L362" title="All 2 branches covered.">		for(Employee emp : employeeMap.values()) {</span>
<span class="fc" id="L363">			ScopeID scopeID = new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE);</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">			if(!m_context.getUser().isAuthorized(PrivilegeKeys.CORE_MODIFYPEOPLE, scopeID)) return false;</span>
<span class="fc" id="L365">		}</span>

<span class="pc bpc" id="L367" title="1 of 2 branches missed.">		if(employeeMap.size() == 0) return false;</span>
<span class="fc" id="L368">		return true;</span>
	}

	protected void initToolbar() {
<span class="fc" id="L372">		m_toolbar.addValidateSubmitTextButton(PageAction.SAVE,</span>
<span class="pc bpc" id="L373" title="2 of 4 branches missed.">				i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SAVE), !m_initFailure &amp;&amp; isEditable());</span>
<span class="fc" id="L374">		m_toolbar.addResetTextButton(PageAction.RESET,</span>
<span class="fc" id="L375">				i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_RESET), isEditable());</span>
<span class="fc" id="L376">	}</span>

	protected void loadSkills() throws BbmException, RemoteException {
<span class="pc bpc" id="L379" title="3 of 4 branches missed.">		if (selectedSP != null &amp;&amp; selectedCampaign != null) {</span>
<span class="nc" id="L380">			skillAssignmentMap = getEmpSkillAssignments(</span>
<span class="nc" id="L381">					viewStartDate.getTime(selectedCampaign.getTimeZone()),</span>
<span class="nc" id="L382">					viewEndDate.getTime(selectedCampaign.getTimeZone()));</span>
		} else {
<span class="fc" id="L384">			skillAssignmentMap = getEmpSkillAssignments(</span>
<span class="fc" id="L385">					viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="fc" id="L386">					viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
		}

		//We need to retrieve the skills in a separate call
		//TODO: This should really be a ValueObjectRich so it can be done in the back end but
		// I was unaware of how this would impact the FS client.
		// (These assignments also already extend DAOEffectivity which makes things more difficult)
<span class="fc" id="L393">		HashSet&lt;SkillAssignment&gt; assignments = new HashSet&lt;SkillAssignment&gt;();</span>
<span class="fc bfc" id="L394" title="All 2 branches covered.">		for (ID employeeID : skillAssignmentMap.keySet()) {</span>
			//We only want to display the earliest skill assignment within the view period if the employee
			//  has multiple skill assignments for the same skill in the view period
<span class="fc" id="L397">			HashMap&lt;ID, SkillAssignment&gt; filteredAssignmentMap = new HashMap&lt;ID, SkillAssignment&gt;();</span>

<span class="fc bfc" id="L399" title="All 2 branches covered.">			for (SkillAssignment assignment : skillAssignmentMap.get(employeeID)) {</span>
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">				if (isSkillAssignmentCurrent(assignment)) {</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">					if (assignment.getStartTime() != null) {</span>
<span class="fc" id="L402">						assignment.setLocalStartTime(new LocalDate(assignment.getStartTime(),</span>
<span class="fc" id="L403">								employeeMap.get(employeeID).getTimeZone(assignment.getStartTime())));</span>
					}
<span class="fc bfc" id="L405" title="All 2 branches covered.">					if (assignment.getEndTime() != null) {</span>
<span class="fc" id="L406">						assignment.setLocalEndTime(new LocalDate(assignment.getEndTime(),</span>
<span class="fc" id="L407">								employeeMap.get(employeeID).getTimeZone(assignment.getEndTime())));</span>
					}
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">					if (filteredAssignmentMap.get(assignment.getSkillID()) == null) {</span>
<span class="fc" id="L410">						filteredAssignmentMap.put(assignment.getSkillID(), assignment);</span>
					} else {
<span class="nc" id="L412">						SkillAssignment otherAssignment = filteredAssignmentMap.get(assignment.getSkillID());</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">						if (assignment.getStartTime().before(otherAssignment.getStartTime())) {</span>
<span class="nc" id="L414">							filteredAssignmentMap.put(assignment.getSkillID(), assignment);</span>
						}
					}
				}
<span class="fc" id="L418">			}</span>
<span class="fc" id="L419">			ArrayList&lt;SkillAssignment&gt; filteredAssignments = new ArrayList&lt;SkillAssignment&gt;(filteredAssignmentMap.values());</span>
<span class="fc" id="L420">			skillAssignmentMap.put(employeeID, filteredAssignments);</span>
<span class="fc" id="L421">			assignments.addAll(filteredAssignments);</span>
<span class="fc" id="L422">		}</span>
<span class="fc" id="L423">		ArrayList&lt;ID&gt; skillIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L424" title="All 2 branches covered.">		for (SkillAssignment assignment : assignments) {</span>
<span class="fc" id="L425">			skillIDs.add(assignment.getSkillID());</span>
<span class="fc" id="L426">		}</span>
<span class="fc bfc" id="L427" title="All 2 branches covered.">		if (!skillIDs.isEmpty()) {</span>
<span class="fc" id="L428">			Collection&lt;Skill&gt; tempSkills = SkillModelHandler.getSkillsByIDs(skillIDs);</span>
<span class="fc bfc" id="L429" title="All 2 branches covered.">			for (ID employeeID : skillAssignmentMap.keySet()) {</span>
<span class="fc bfc" id="L430" title="All 2 branches covered.">				for (SkillAssignment assignment : skillAssignmentMap.get(employeeID)) {</span>
<span class="pc bpc" id="L431" title="1 of 2 branches missed.">					for (Skill skill : tempSkills) {</span>
<span class="fc bfc" id="L432" title="All 2 branches covered.">						if (skill.getID().equals(assignment.getSkillID())) {</span>
<span class="fc" id="L433">							assignment.setSkill(skill);</span>
<span class="fc" id="L434">							break;</span>
						}
<span class="fc" id="L436">					}</span>
<span class="fc" id="L437">				}</span>
<span class="fc" id="L438">			}</span>
		}
<span class="fc" id="L440">	}</span>

	protected Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; getEmpSkillAssignments(Date start, Date end) throws BbmFinderException {
<span class="fc" id="L443">		return SkillsAssignmentMH.getSkillAssignmentsForEmployees(m_context,</span>
<span class="fc" id="L444">				getSelectedIDsAsCollection(), start,</span>
				end);
	}	
	
	public void saveSkillsAssignments() throws BbmException, RemoteException {
<span class="pc bpc" id="L449" title="1 of 2 branches missed.">		if (pc_skill.save(employeeMap)) {</span>
			//On successful save, we need to refresh the work pattern map for the workPatternPC so that
			//merged assignments will be displayed
<span class="fc" id="L452">			loadSkills();</span>
<span class="fc" id="L453">			pc_skill.refreshSkillAssignmentMap(skillAssignmentMap);</span>
		}
<span class="fc" id="L455">	}</span>

	public void saveEmployeeProficiency() throws BbmException, MultiUserException, RemoteException {
		try {
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">			if (!StringUtil.isEmpty(employeeProficiencyPC.getInputValue()) &amp;&amp;</span>
<span class="pc bpc" id="L460" title="1 of 2 branches missed.">					!employeeProficiencyPC.getInputValue().equals(MULTI_VALUE_DATA)) {</span>
<span class="pc bpc" id="L461" title="1 of 2 branches missed.">				if(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY)) {</span>
<span class="fc" id="L462">					SkillsAssignmentMH.saveEmployeeProficiency(m_context, getSelectedIDsAsCollection(),</span>
<span class="fc" id="L463">							viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="fc" id="L464">							NumberFormat.getInstance(m_localizer.getLocaleContext().getRegionalFormatLocale()).parse(employeeProficiencyPC.getInputValue()).doubleValue());</span>
				}
			}
<span class="nc" id="L467">		} catch (ParseException e) {</span>
<span class="nc" id="L468">			throw new BbmException(e);</span>
<span class="fc" id="L469">		}</span>
<span class="fc" id="L470">	}</span>

	/**
	 * Saves employee chat sessions only if all selected employees have an assigned chat skill for the
	 * current view period.
	 */
	public void saveEmployeeChatSessions() throws BbmException, RemoteException {
<span class="fc bfc" id="L477" title="All 2 branches covered.">		if (isNumberOfChatSessionsDisabled()) return;		//Don't save chat sessions if the field is disabled (i.e. aren't valid for the given view period)</span>
<span class="pc bpc" id="L478" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(employeeChatPC.getInputValue()) &amp;&amp;</span>
<span class="pc bpc" id="L479" title="1 of 2 branches missed.">				!employeeChatPC.getInputValue().equals(MULTI_VALUE_DATA)) {</span>
<span class="fc" id="L480">			SkillsAssignmentMH.saveNumberOfChatSessionsForEmployees(m_context, getSelectedIDsAsCollection(),</span>
<span class="fc" id="L481">					Integer.parseInt(employeeChatPC.getInputValue()));</span>
		}
<span class="fc" id="L483">	}</span>

	public static String getOnRowAddJS() {
<span class="fc" id="L486">		StringBuffer js = new StringBuffer();</span>
<span class="fc" id="L487">		js.append(&quot;var $generalProficiencyInput = jQuery('input[name=&quot; + PROFICIENCY_FN + &quot;]');&quot;);</span>
<span class="fc" id="L488">		js.append(&quot;var rowAdded = skillTable.getRowByUID(id);&quot;);</span>
<span class="fc" id="L489">		js.append(&quot;var proficiencyId = skillTable.getRowAttribute(rowAdded, 'proficiencyFN');&quot;);</span>
<span class="fc" id="L490">		js.append(&quot;var num = $generalProficiencyInput.val();&quot;);</span>
<span class="fc" id="L491">		js.append(&quot;jQuery('input[name=' + proficiencyId + ']').val(num.toFixed ? num.toFixed(1) : num);&quot;);</span>
<span class="fc" id="L492">		return js.toString();</span>
	}

	public static String getOnChatSkillAddedJS(String numChatSessionsValue) {
<span class="fc" id="L496">		StringBuffer js = new StringBuffer();</span>
<span class="fc" id="L497">		js.append(&quot;var empAssignmentNumChatSessionsInputElement = jQuery('input[name=&quot; + NUM_CHAT_FN + &quot;]');&quot;);</span>
<span class="fc" id="L498">		js.append(&quot;empAssignmentNumChatSessionsInputElement.removeClass('&quot; + FormInputPC.INPUT_TEXT_READ_ONLY_STYLE + &quot;');&quot;);</span>
<span class="fc" id="L499">		js.append(&quot;empAssignmentNumChatSessionsInputElement.addClass('&quot; + FormInputPC.DEFAULT_STYLE + &quot;');&quot;);</span>
<span class="fc" id="L500">		js.append(&quot;empAssignmentNumChatSessionsInputElement.removeAttr('readOnly');&quot;);</span>
<span class="fc" id="L501">		js.append(&quot;empAssignmentNumChatSessionsInputElement.val('&quot; + numChatSessionsValue + &quot;');&quot;);</span>
<span class="fc" id="L502">		return js.toString();</span>
	}

	private static String getOnSkillRemovedJS() {
<span class="fc" id="L506">		StringBuffer js = new StringBuffer();</span>
<span class="fc" id="L507">		js.append(&quot;var chatSkillRows = skillTable.getRowCountWithAttribute('isCommonChatSkill');&quot;);</span>
<span class="fc" id="L508">		js.append(&quot;if (chatSkillRows == 0) {&quot;);</span>
<span class="fc" id="L509">		js.append(&quot;var empAssignmentNumChatSessionsInputElement = jQuery('input[name=&quot; + NUM_CHAT_FN + &quot;]');&quot;);</span>
<span class="fc" id="L510">		js.append(&quot;empAssignmentNumChatSessionsInputElement.removeClass('&quot; + FormInputPC.DEFAULT_STYLE + &quot;');&quot;);</span>
<span class="fc" id="L511">		js.append(&quot;empAssignmentNumChatSessionsInputElement.addClass('&quot; + FormInputPC.INPUT_TEXT_READ_ONLY_STYLE + &quot;');&quot;);</span>
<span class="fc" id="L512">		js.append(&quot;empAssignmentNumChatSessionsInputElement.attr('readOnly', 'true');&quot;);</span>
<span class="fc" id="L513">		js.append(&quot;}&quot;);</span>
<span class="fc" id="L514">		return js.toString();</span>
	}

	private static String getPreSkillRemovedJS() {
<span class="fc" id="L518">		StringBuffer js = new StringBuffer();</span>
<span class="fc" id="L519">		js.append(&quot;var rowToRemove = skillTable.getRowByUID(id);&quot;);</span>
<span class="fc" id="L520">		js.append(&quot;removeValidators(skillTable.getRowAttribute(rowToRemove, 'priorityFN'));&quot;);</span>
<span class="fc" id="L521">		js.append(&quot;removeValidators(skillTable.getRowAttribute(rowToRemove, 'proficiencyFN'));&quot;);</span>
<span class="fc" id="L522">		return js.toString();</span>
	}

	/**
	 * Returns true if any of the selected employees do not have any chat skills assigned for the current view period.
	 */
	private boolean isNumberOfChatSessionsDisabled() {
		//Return true if any of the added assignments are chat skills
<span class="pc bpc" id="L530" title="1 of 2 branches missed.">		if (addedSkillAssignments != null) {</span>
<span class="fc bfc" id="L531" title="All 2 branches covered.">			for (SkillAssignment addedAssignment : addedSkillAssignments) {</span>
<span class="fc bfc" id="L532" title="All 2 branches covered.">				if (addedAssignment.getSkill().getMediaID().equals(Media.MEDIA_ID_CHAT)) {</span>
<span class="fc" id="L533">					return false;</span>
				}
<span class="fc" id="L535">			}</span>
		}
<span class="pc bpc" id="L537" title="1 of 2 branches missed.">		if (removedSkillAssignments == null) removedSkillAssignments = new ArrayList&lt;SkillAssignment&gt;();</span>
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">		for (Collection&lt;SkillAssignment&gt; employeeAssignments : skillAssignmentMap.values()) {</span>
<span class="fc" id="L539">			boolean employeeHasChatSkill = false;</span>
<span class="fc bfc" id="L540" title="All 2 branches covered.">			for (SkillAssignment assignment : employeeAssignments) {</span>
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">				if (assignment.getSkill().getMediaID().equals(Media.MEDIA_ID_CHAT) &amp;&amp;</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">						removedSkillAssignments.contains(assignment) == false) {</span>
<span class="nc" id="L543">					employeeHasChatSkill = true;</span>
<span class="nc" id="L544">					break;</span>
				}
<span class="fc" id="L546">			}</span>
<span class="pc bpc" id="L547" title="1 of 2 branches missed.">			if (employeeHasChatSkill == false) return true;</span>
<span class="nc" id="L548">		}</span>

<span class="nc" id="L550">		return false;</span>
	}

	/**
	 * Returns a string representation of the number of chat sessions assigned to all selected employees.
	 * If employees do not have any chat sessions assigned, they will be treated as though they have 1 chat session
	 * assigned.  If the selected employees do not all have the same number of assigned chat sessions, then
	 * an asterisk &quot;*&quot; representing multi-value will be returned.
	 */
	public static String getNumberOfChatSessionsForEmployees(Map&lt;ID, Integer&gt; chatSessionMap, Map&lt;ID, Employee&gt; employeeMap,
															 Localizer localizer) {
<span class="pc bpc" id="L561" title="2 of 4 branches missed.">		if (chatSessionMap == null || chatSessionMap.size() == 0) return localizer.formatNumber(1);</span>
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">		if (chatSessionMap.size() != employeeMap.size()) return MULTI_VALUE_DATA;</span>
<span class="fc" id="L563">		int numberOfChatSessions = chatSessionMap.values().iterator().next();</span>
<span class="fc bfc" id="L564" title="All 2 branches covered.">		for (Integer empChatSessions : chatSessionMap.values()) {</span>
<span class="pc bpc" id="L565" title="1 of 2 branches missed.">			if (numberOfChatSessions != empChatSessions) {</span>
<span class="nc" id="L566">				return MULTI_VALUE_DATA;</span>
			}
<span class="fc" id="L568">		}</span>

<span class="fc" id="L570">		return localizer.formatNumber(numberOfChatSessions);</span>
	}

	/**
	 * Determines if the current skill assignment is &quot;current&quot;, in other words it applies to the current
	 * view period.  This is true if the start date of the assignment lies before or at the view period start date
	 * and the assignment end date is either null or lies after the view period start date.  Skill assignments are also
	 * current if they lie between the view start and end dates.
	 */
	private boolean isSkillAssignmentCurrent(SkillAssignment assignment) {
<span class="pc bpc" id="L580" title="1 of 2 branches missed.">		if (selectedCampaign == null) {</span>
			TimeZone empTimeZone;
<span class="fc" id="L582">			Employee emp = employeeMap.get(assignment.getWorkResourceID());</span>
			//Determine time zone of employee at record start
<span class="pc bpc" id="L584" title="1 of 2 branches missed.">			if (emp.getStartTime().after(assignment.getStartTime())) {</span>
<span class="nc" id="L585">				empTimeZone = emp.getTimeZone(emp.getStartTime());</span>
			} else {
<span class="fc" id="L587">				empTimeZone = emp.getTimeZone(assignment.getStartTime());</span>
			}
<span class="fc" id="L589">			LocalDate localEffectiveStart = new LocalDate(assignment.getStartTime(), empTimeZone);</span>
<span class="fc" id="L590">			LocalDate localEffectiveEnd = null;</span>
			//Determine time zone of employee at record end
<span class="fc bfc" id="L592" title="All 2 branches covered.">			if (assignment.getEndTime() != null) {</span>
<span class="pc bpc" id="L593" title="2 of 4 branches missed.">				if (emp.getEndTime() == null || emp.getEndTime().after(assignment.getEndTime())) {</span>
<span class="nc" id="L594">					empTimeZone = emp.getTimeZone(assignment.getEndTime());</span>
				} else {
<span class="fc" id="L596">					empTimeZone = emp.getTimeZone(emp.getEndTime());</span>
				}
<span class="fc" id="L598">				localEffectiveEnd = new LocalDate(assignment.getEndTime(), empTimeZone);</span>
			}
<span class="pc bpc" id="L600" title="3 of 6 branches missed.">			return ((localEffectiveStart.before(viewStartDate) || localEffectiveStart.equals(viewStartDate))</span>
<span class="pc bpc" id="L601" title="1 of 2 branches missed.">					&amp;&amp; (localEffectiveEnd == null || localEffectiveEnd.after(viewStartDate))) ||</span>
<span class="pc bnc" id="L602" title="All 4 branches missed.">					(localEffectiveStart.after(viewStartDate) &amp;&amp; localEffectiveStart.before(viewEndDate));</span>
		} else {
<span class="nc" id="L604">			Date absoluteViewStartDate = viewStartDate.getTime(selectedCampaign.getTimeZone());</span>
<span class="nc" id="L605">			Date absoluteViewEndDate = viewEndDate.getTime(selectedCampaign.getTimeZone());</span>
<span class="nc bnc" id="L606" title="All 4 branches missed.">			return ((assignment.getStartTime().before(absoluteViewStartDate) || assignment.getStartTime().equals(absoluteViewStartDate))</span>
<span class="nc bnc" id="L607" title="All 4 branches missed.">					&amp;&amp; (assignment.getEndTime() == null || assignment.getEndTime().after(absoluteViewStartDate))) ||</span>
<span class="nc bnc" id="L608" title="All 4 branches missed.">					(assignment.getStartTime().after(absoluteViewStartDate) &amp;&amp; assignment.getStartTime().before(absoluteViewEndDate));</span>
		}
	}

	/**
	 * Initializes the secure field meta data for use in determining viewability/editability of certain fields.
	 */
	private void initializeSecureFieldMetaData() {
<span class="fc" id="L616">		authorizedViewFields = new HashMap&lt;ID, List&lt;Integer&gt;&gt;();</span>
<span class="fc" id="L617">		authorizedEditFields = new HashMap&lt;ID, List&lt;Integer&gt;&gt;();</span>

<span class="fc bfc" id="L619" title="All 2 branches covered.">		for(Employee emp : employeeMap.values()) {</span>
<span class="fc" id="L620">			int[] viewableFields =</span>
<span class="fc" id="L621">				m_context.getUser().getAuthorizedFields(</span>
						PrivilegeKeys.CORE_VIEWSECUREFIELD,
<span class="fc" id="L623">						new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE));</span>
<span class="pc bpc" id="L624" title="1 of 2 branches missed.">			if(viewableFields == null) viewableFields = new int[0];</span>

<span class="fc" id="L626">			int[] editableFields =</span>
<span class="fc" id="L627">				m_context.getUser().getAuthorizedFields(</span>
						PrivilegeKeys.CORE_EDITSECUREFIELD,
<span class="fc" id="L629">						new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE));</span>
<span class="pc bpc" id="L630" title="1 of 2 branches missed.">			if(editableFields == null) editableFields = new int[0];</span>

<span class="fc" id="L632">		 	authorizedViewFields.put(emp.getID(), ArrayUtil.asList(viewableFields));</span>
<span class="fc" id="L633">		 	authorizedEditFields.put(emp.getID(), ArrayUtil.asList(editableFields));</span>
<span class="fc" id="L634">		}</span>
<span class="fc" id="L635">	}</span>

	/**
	 * Returns whether a field is EDITABLE based on the current user and employees/scope selected.
	 * @param secureFieldInfoId Secure field info {@link com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo SecureFieldInfo}
	 * @return boolean
	 */
	private boolean isFieldEditable(int secureFieldInfoId) {
		// If the field is not viewable then we don't even need to check
		// further for editability.
<span class="pc bpc" id="L645" title="1 of 2 branches missed.">		if(!isFieldViewable(secureFieldInfoId)) return false;</span>

<span class="fc bfc" id="L647" title="All 2 branches covered.">		for(Employee emp : employeeMap.values()) {</span>
			// Just looking for any employee in the selection that doesn't permit EDITING
			// because we can't permit more access than the lowest permitted or actions
			// can be taken that shouldn't be allowed for some of the employees.
<span class="pc bpc" id="L651" title="1 of 2 branches missed.">			if(authorizedEditFields.containsKey(emp.getID())) {</span>
<span class="pc bpc" id="L652" title="1 of 2 branches missed.">				if(!authorizedEditFields.get(emp.getID()).contains(secureFieldInfoId)) {</span>
					// This field is not EDITABLE for this employee and scope so
					// we cannot permit the field to be EDITABLE for the selected
					// employees.
<span class="nc" id="L656">					return false;</span>
				}
			} // If the employee doesn't have any secured field information let's assume they can be accessed.
<span class="fc" id="L659">		}</span>
<span class="fc" id="L660">		return true;</span>
	}

	/**
	 * Returns whether a field is VIEWABLE based on the current user and employees/scope selected.
	 * @param secureFieldInfoId Secure field info {@link com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo SecureFieldInfo}
	 * @return boolean
	 */
	private boolean isFieldViewable(int secureFieldInfoId) {
<span class="fc bfc" id="L669" title="All 2 branches covered.">		for(Employee emp : employeeMap.values()) {</span>
			// Just looking for any employee in the selection that doesn't permit VIEWING
			// because we can't permit more access than the lowest permitted or actions
			// can be taken that shouldn't be allowed for some of the employees.
<span class="pc bpc" id="L673" title="1 of 2 branches missed.">			if(authorizedViewFields.containsKey(emp.getID())) {</span>
<span class="pc bpc" id="L674" title="1 of 2 branches missed.">				if(!authorizedViewFields.get(emp.getID()).contains(secureFieldInfoId)) {</span>
					// This field is not VIEWABLE for this employee and scope so
					// we cannot permit the field to be VIEWABLE for the selected
					// employees.
<span class="nc" id="L678">					return false;</span>
				}
			} // If the employee doesn't have any secured field information let's assume they can be accessed.
<span class="fc" id="L681">		}</span>
<span class="fc" id="L682">		return true;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>