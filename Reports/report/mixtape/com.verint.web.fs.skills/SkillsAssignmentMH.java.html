<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SkillsAssignmentMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.skills</a> &gt; <span class="el_source">SkillsAssignmentMH.java</span></div><h1>SkillsAssignmentMH.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.skills;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.skill.ejb.SkillManager;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.system.RequestContext;

<span class="nc" id="L26">public class SkillsAssignmentMH {</span>
	private static final String MULTI_VALUE_DATA = &quot;*&quot;;
	
	public static HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; getSkillAssignmentsForEmployees(RequestContext context, Collection&lt;ID&gt; employeeIDs,
			Date startDate, Date endDate) throws BbmFinderException 
	{
		try {
<span class="fc" id="L33">			SkillManager sm = WfmManagerFactory.getSkillManager(context.isInWhatIfMode());</span>
<span class="fc" id="L34">			return sm.getSkillAssignments(employeeIDs, startDate, endDate);</span>
<span class="nc" id="L35">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L36">			throw e;</span>
<span class="nc" id="L37">		} catch (Exception e) {</span>
<span class="nc" id="L38">			throw new BbmFinderException(e);</span>
		}		
	}

	public static Collection&lt;SkillAssignment&gt; getSkillAssignmentsForEmployee(RequestContext context, ID employeeID,
			Date startDate, Date endDate) throws BbmFinderException 
	{
		try {
<span class="nc" id="L46">			HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; skillAssignmentMap = getSkillAssignmentsForEmployees(context,</span>
<span class="nc" id="L47">					Collections.singleton(employeeID), startDate, endDate);</span>
<span class="nc bnc" id="L48" title="All 4 branches missed.">			if (skillAssignmentMap == null || skillAssignmentMap.get(employeeID) == null) return new ArrayList&lt;SkillAssignment&gt;();</span>
<span class="nc" id="L49">			return skillAssignmentMap.get(employeeID);</span>
<span class="nc" id="L50">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L51">			throw e;</span>
<span class="nc" id="L52">		} catch (Exception e) {</span>
<span class="nc" id="L53">			throw new BbmFinderException(e);</span>
		}		
	}
	
	/**
	 * This method will delete the skill assignments in assignmentsToDelete, and will
	 * create new assignments for the assignments in assignmentsToCreate.
	 */
	public static void saveSkillAssignments(RequestContext context,
			Collection&lt;SkillAssignment&gt; assignmentsToDelete,
			Collection&lt;SkillAssignment&gt; assignmentsToCreate) throws BbmException {
		try {
<span class="pc bpc" id="L65" title="3 of 6 branches missed.">			if ((assignmentsToDelete != null &amp;&amp; assignmentsToDelete.isEmpty() == false) ||</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">					(assignmentsToCreate != null &amp;&amp; assignmentsToCreate.isEmpty() == false)) {</span>
<span class="fc" id="L67">				SkillManager sm = WfmManagerFactory.getSkillManager(context.isInWhatIfMode());</span>
				
				//Batch the save operation for each employee to avoid a transaction timeout when editing
				//large sets of employees
<span class="fc" id="L71">				Set&lt;ID&gt; employeeIDs = new HashSet&lt;ID&gt;();</span>
<span class="fc" id="L72">				Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; assignmentsToDeleteByEmp = </span>
						new HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt;();
<span class="fc" id="L74">				HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; assignmentsToCreateByEmp = </span>
						new HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt;();
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">				for (SkillAssignment assignment : assignmentsToDelete) {</span>
<span class="nc bnc" id="L77" title="All 4 branches missed.">					if (assignment != null &amp;&amp; assignment.getWorkResourceID() != null) {</span>
<span class="nc" id="L78">						employeeIDs.add(assignment.getWorkResourceID());</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">						if (assignmentsToDeleteByEmp.get(assignment.getWorkResourceID()) == null) {</span>
<span class="nc" id="L80">							assignmentsToDeleteByEmp.put(assignment.getWorkResourceID(), new ArrayList&lt;SkillAssignment&gt;());</span>
						}
<span class="nc" id="L82">						assignmentsToDeleteByEmp.get(assignment.getWorkResourceID()).add(assignment);</span>
					}
<span class="nc" id="L84">				}</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">				for (SkillAssignment assignment : assignmentsToCreate) {</span>
<span class="pc bpc" id="L86" title="2 of 4 branches missed.">					if (assignment != null &amp;&amp; assignment.getWorkResourceID() != null) {</span>
<span class="fc" id="L87">						employeeIDs.add(assignment.getWorkResourceID());</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">						if (assignmentsToCreateByEmp.get(assignment.getWorkResourceID()) == null) {</span>
<span class="fc" id="L89">							assignmentsToCreateByEmp.put(assignment.getWorkResourceID(), new ArrayList&lt;SkillAssignment&gt;());</span>
						}
<span class="fc" id="L91">						assignmentsToCreateByEmp.get(assignment.getWorkResourceID()).add(assignment);</span>
					}
<span class="fc" id="L93">				}</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">				for (ID employeeID : employeeIDs) {</span>
<span class="fc" id="L95">					Collection&lt;SkillAssignment&gt; empAssignmentsToDelete = assignmentsToDeleteByEmp.get(employeeID);</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">					if (empAssignmentsToDelete == null) empAssignmentsToDelete = new ArrayList&lt;SkillAssignment&gt;();</span>
<span class="fc" id="L97">					Collection&lt;SkillAssignment&gt; empAssignmentsToCreate = assignmentsToCreateByEmp.get(employeeID);</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">					if (empAssignmentsToCreate == null) empAssignmentsToCreate = new ArrayList&lt;SkillAssignment&gt;();</span>
					
<span class="fc" id="L100">					sm.saveSkillAssignments(empAssignmentsToDelete, empAssignmentsToCreate);</span>
<span class="fc" id="L101">				}</span>
			}
<span class="nc" id="L103">		} catch (Exception e) {</span>
<span class="nc" id="L104">			throw new BbmException(e);</span>
<span class="fc" id="L105">		}</span>
<span class="fc" id="L106">	}</span>
	
	/**
	 * Returns a list of skills that are able to be assigned to the given employees during the given date range.
	 */
	public static Collection&lt;Skill&gt; getEmployeeSkills(RequestContext context, Collection&lt;ID&gt; employeeIDs,
			Date viewStartDate, Date viewEndDate) throws BbmException
	{
<span class="pc bpc" id="L114" title="2 of 4 branches missed.">		if (employeeIDs == null || employeeIDs.isEmpty())</span>
<span class="nc" id="L115">			return Collections.emptyList();</span>
		try {
<span class="fc" id="L117">			return WfmManagerFactory.getSkillManager(context.isInWhatIfMode()).getAvailableSkillsForEmployees(</span>
					employeeIDs, viewStartDate, viewEndDate);
<span class="nc" id="L119">		} catch (RemoteException ex) {</span>
<span class="nc" id="L120">			throw new BbmException(ex);</span>
		}
	}
	
	/**
	 * Returns a string representation of the proficiency value (actually a double value) for the given employees.
	 * If the employees do not all have the same proficiency, an &quot;*&quot; is returned to represent multi-value data.
	 */
	public static String getProficiencyForEmployees(RequestContext context, Collection&lt;ID&gt; colEmpID, Date asOfDate)
			throws RemoteException, BbmException {
<span class="pc bpc" id="L130" title="2 of 4 branches missed.">		if (colEmpID == null || colEmpID.isEmpty())</span>
<span class="nc" id="L131">			return null;</span>
<span class="fc" id="L132">		int prof = 0;</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">		if (colEmpID.size() &gt; 1) {</span>
			// multiple employees
<span class="fc" id="L135">			Collection&lt;Employee&gt; colEmp = getEmployeesByIDs(context, colEmpID, asOfDate);</span>
<span class="pc bpc" id="L136" title="2 of 4 branches missed.">			if (colEmp == null || colEmp.isEmpty())</span>
<span class="nc" id="L137">				return null;</span>
		
<span class="fc" id="L139">			prof = ((Employee) colEmp.iterator().next()).getProficiency();</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">			for (Employee emp : colEmp) {</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">				if (emp.getProficiency() != prof)</span>
<span class="nc" id="L142">					return MULTI_VALUE_DATA;</span>
<span class="fc" id="L143">			}</span>
<span class="fc" id="L144">		} else {</span>
			// single emp
<span class="fc" id="L146">			Employee emp = getEmployeeByID(context, colEmpID.iterator().next(), asOfDate);</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">			if (emp == null)</span>
<span class="nc" id="L148">				return null;</span>
<span class="fc" id="L149">			prof = emp.getProficiency();</span>
		}
<span class="fc" id="L151">		Double d = prof / 10.0;</span>
<span class="fc" id="L152">		return Double.toString(d);</span>
	}
	
	/**
	 * Returns a map of employee IDs with the number of chat sessions for each ID.  The map will only
	 * contain entries for employees that have chat skills assigned, unless includeEmployeesWithoutChatSkills is true,
	 * in which case it will return the number of chat sessions for all given employees.  If none of the given employee IDs
	 * have chat skills assigned (and includeEmployeesWithoutChatSkills is false), returns an empty map.
	 */
	public static Map&lt;ID, Integer&gt; getNumberOfChatSessionsForEmployees(RequestContext context,
			Collection&lt;ID&gt; employeeIDs, boolean includeEmployeesWithoutChatSkills) throws BbmException, RemoteException {
<span class="fc" id="L163">		Map&lt;ID, Integer&gt; retVal = getWorkResourceManager(context).getNumberOfChatSessionsForEmployees(employeeIDs,</span>
				includeEmployeesWithoutChatSkills);
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">		if (includeEmployeesWithoutChatSkills) {</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">			for (ID empID : employeeIDs) {</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">				if (retVal.get(empID) == null) retVal.put(empID, 1);</span>
<span class="fc" id="L168">			}</span>
		}
<span class="fc" id="L170">		return retVal;</span>
	}
	
	public static void saveNumberOfChatSessionsForEmployees(RequestContext context, Collection&lt;ID&gt; employeeIDs,
			int numChatSessions) throws BbmException, RemoteException {
<span class="fc" id="L175">		getWorkResourceManager(context).createOrUpdateNumChatSessions(employeeIDs, numChatSessions, context.getUserName());</span>
<span class="fc" id="L176">	}</span>
	
	public static void saveEmployeeProficiency(RequestContext context, Collection&lt;ID&gt; employeeIDs, Date asOfDate,
			double proficiency) throws BbmException, MultiUserException, RemoteException {
<span class="fc" id="L180">		Collection&lt;Employee&gt; colEmp = getEmployeesByIDs(context, employeeIDs, asOfDate);</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">		for (Employee employee : colEmp) {</span>
<span class="fc" id="L182">			employee.setProficiency((int)(proficiency * 10));		//Proficiency is stored as an int in the DB, even though it is a double value.</span>
<span class="fc" id="L183">		}</span>
<span class="fc" id="L184">		getWorkResourceManager(context).updateEmployees(colEmp);</span>
<span class="fc" id="L185">	}</span>
	
	/**
	 * Retrieve the Work Resource Manager EJB remote interface
	 */
	private static WorkResourceManager getWorkResourceManager(
			RequestContext context) throws BbmException {
<span class="fc" id="L192">		return BbmManagerFactory.getWorkResourceManager(context</span>
<span class="fc" id="L193">				.isInWhatIfMode());</span>
	}
	
	private static Collection&lt;Employee&gt; getEmployeesByIDs(RequestContext context,
			Collection&lt;ID&gt; colEmpID, Date asOfDate) throws RemoteException, BbmException {
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">		if (colEmpID == null)</span>
<span class="nc" id="L199">			return null;</span>
<span class="fc" id="L200">		return getWorkResourceManager(context).getEmployeesByIDs(colEmpID,</span>
				asOfDate, Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);
	}

	private static Employee getEmployeeByID(RequestContext context, ID empID, Date asOfDate)
			throws RemoteException, BbmException {
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">		if (empID == null)</span>
<span class="nc" id="L207">			return null;</span>
<span class="fc" id="L208">		return getWorkResourceManager(context).getEmployeeByID(empID, asOfDate,</span>
				Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>