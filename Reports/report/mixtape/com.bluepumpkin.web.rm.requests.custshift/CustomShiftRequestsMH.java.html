<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CustomShiftRequestsMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.custshift</a> &gt; <span class="el_source">CustomShiftRequestsMH.java</span></div><h1>CustomShiftRequestsMH.java</h1><pre class="source lang-java linenums">/**
 * Title:        CustomShiftRequestsMH
 * Description:  Model Handler for Custom Shift Requests
 * Copyright:    Copyright (c) 2011
 * Company:      Verint Systems, Inc.
 * @author       Gonzalo Quintanar
 */
package com.bluepumpkin.web.rm.requests.custshift;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.ResourceBundle;
import java.util.Set;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.util.PersonNameUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.activity.model.EventUtils;
import com.bluepumpkin.ejb.bbm.activity.model.SimpleEvent;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignWorkResource;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.EmpWorkRuleManager;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftEventAssignment;
import com.bluepumpkin.ejb.bbm.timeseries.ejb.TimeSeriesManager;
import com.bluepumpkin.ejb.bbm.timeseries.model.NetStaffingCube;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftEvent;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftOTExtension;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.facade.base.FacadeException;
import com.bluepumpkin.ejb.rm.base.RmBaseException;
import com.bluepumpkin.ejb.rm.base.RmException;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.custshift.ejb.CustShiftReqMgr;
import com.bluepumpkin.ejb.rm.requests.custshift.model.CustShiftReq;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.system.RequestContext;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;

<span class="nc" id="L77">public class CustomShiftRequestsMH extends RequestsMH {</span>

	protected static CustShiftReqMgr getCSRequestManager() throws BbmCreateException {
<span class="nc" id="L80">		return m_managerFactory.getCustShiftReqMgr();</span>
	}

	protected static ScheduleAccessManager getScheduleAccessManager(RequestContext context)
			throws BbmEJBCreateException {
<span class="nc" id="L85">		return WfmManagerFactory.getScheduleAccessManager(context.isInWhatIfMode());</span>
	}

	/**
	 * Approve Custom Shift Request
	 *
	 * @param requestID
	 *            The ID of the Request
	 * @param toChoiceID
	 *            not used
	 * @param requestVersion
	 *            The Request Value Object version
	 * @param comment
	 *            The comment associated with the action
	 */
	public static void approveCSRequest(ID requestID, ID toChoiceID, String requestVersion, String comment)
			throws RemoteException, MultiUserException, RmHardValidationException, BbmCreateException, RmException {
<span class="nc" id="L102">		getCSRequestManager().approveRequestByID(requestID, toChoiceID, requestVersion, comment);</span>
<span class="nc" id="L103">	}</span>

	/**
	 * Tentativeley Approve Custom Shift Request
	 *
	 * @param requestID
	 *            The ID of the Request
	 * @param toChoiceID
	 *            not used
	 * @param requestVersion
	 *            The Request Value Object version
	 * @param comment
	 *            The comment associated with the action
	 */
	public static void tentativelyApproveCSRequest(ID requestID, ID toChoiceID, String requestVersion, String comment)
			throws MultiUserException, BbmCreateException, RmHardValidationException, RemoteException, RmException {
<span class="nc" id="L119">		getCSRequestManager().approveRequestTentativelyByID(requestID, toChoiceID, requestVersion, comment);</span>
<span class="nc" id="L120">	}</span>

	/**
	 * Deny Custom Shift Request
	 *
	 * @param requestID
	 *            The ID of the Request
	 * @param requestVersion
	 *            The Request Value Object version
	 * @param comment
	 *            The comment associated with the action
	 */
	public static void denyCSRequest(ID requestID, String requestVersion, String comment) throws MultiUserException,
			BbmCreateException, RmHardValidationException, RemoteException, RmException {
<span class="nc" id="L134">		getCSRequestManager().denyRequestByID(requestID, requestVersion, comment);</span>
<span class="nc" id="L135">	}</span>

	/**
	 * Create TimeOff Request
	 *
	 * @param request
	 *            The Request Object to be created
	 * @param comment
	 *            The Comment associated with the Request
	 */
	public static ID createCSRequest(CustShiftReq request, String comment) throws Exception {
<span class="nc" id="L146">		return getCSRequestManager().createRequest(request, comment);</span>
	}

	/**
	 * Update TimeOff Request
	 *
	 * @param request
	 *            The Request Object to be created
	 * @param comment
	 *            The Comment associated with the Request
	 */
	public static void updateCSRequest(CustShiftReq request, String comment) throws BbmUpdateException,
			MultiUserException, BbmCreateException, RmHardValidationException, RemoteException {
<span class="nc" id="L159">		getCSRequestManager().updateRequest(request, comment);</span>
<span class="nc" id="L160">	}</span>

	/**
	 * Return Custom Shift Request for specified ID
	 *
	 * @param requestID
	 *            The Custom Shift Request ID
	 */
	public static CustShiftReq getCSRequest(ID requestID) throws BbmFinderException, BbmCreateException,
			RemoteException, RmHardValidationException {
<span class="nc" id="L170">		return (CustShiftReq) getCSRequestManager().getRequestByID(requestID, true, true,</span>
				CustShiftReq.DL_BASIC | CustShiftReq.DL_AUDIT_TRAIL);
	}

	/**
	 * Return All Custom Shift Requests For an Employee
	 */
	public static Collection getRequestsByEmployee(ID empID, boolean incExpired) throws RemoteException, BbmException,
			RmHardValidationException {
<span class="nc" id="L179">		return getCSRequestManager().getRequestsByEmployee(empID, incExpired, true,</span>
				CustShiftReq.DL_BASIC | CustShiftReq.DL_AUDIT_TRAIL);
	}

	/**
	 * Return Custom Shift Detail Data for Agent
	 *
	 * @param fromDate
	 *            - the start of the day that we are getting data for
	 * @param toDate
	 *            - the end of the day that we are getting data for
	 * @param ribbonStartDate
	 *            - If the user made a selection in his Net Staffing Ribbon, the
	 *            start of that range.
	 * @param ribbonEndDate
	 *            - If the user made a selection in his Net Staffing Ribbon, the
	 *            end of that range.
	 * @param isRibbonApplicable
	 *            - true if we are in ribbon mode and we should filter the
	 *            activities accordingly.
	 */
	public static CSDetailData getCSDetailData(RequestContext context, ID empID, CustShiftReq request, Date fromDate,
			Date toDate, Date ribbonStartDate, Date ribbonEndDate, boolean isRibbonApplicable, ResourceBundle bundle,
			TimeZone tz) throws Exception {
<span class="nc" id="L203">		ID orgID = getEmpOrgID(context, empID);</span>
<span class="nc" id="L204">		OrganizationSetting orgSetting = getOrgSetting(orgID);</span>

<span class="nc" id="L206">		CSDetailData data = new CSDetailData(empID, request, orgSetting, Collections.emptyList());</span>

<span class="nc" id="L208">		populateCSDetailData(data, context, empID, fromDate, toDate, ribbonStartDate, ribbonEndDate,</span>
				isRibbonApplicable, bundle, tz, true);

<span class="nc" id="L211">		return data;</span>
	}

	/**
	 * Return Custom Shift Detail Data for Manager
	 *
	 * @param fromDate
	 *            - the start of the day that we are getting data for
	 * @param toDate
	 *            - the end of the day that we are getting data for
	 * @param ribbonStartDate
	 *            - If the user made a selection in his Net Staffing Ribbon, the
	 *            start of that range.
	 * @param ribbonEndDate
	 *            - If the user made a selection in his Net Staffing Ribbon, the
	 *            end of that range.
	 * @param isRibbonApplicable
	 *            - true if we are in ribbon mode and we should filter the
	 *            activities accordingly.
	 */
	public static CSDetailData getCSDetailDataForManager(RequestContext context, User user, ID inputEmpID,
			boolean isNewRequest, CustShiftReq request, Date fromDate, Date toDate, Date ribbonStartDate,
			Date ribbonEndDate, boolean isRibbonApplicable, ResourceBundle bundle, TimeZone tz) throws RemoteException,
			BbmException, FacadeException, RmHardValidationException, RmBaseException {
		try {
<span class="nc" id="L236">			ID empID = new ID(inputEmpID);</span>
<span class="nc bnc" id="L237" title="All 4 branches missed.">			if (empID == null &amp;&amp; request != null) {</span>
<span class="nc" id="L238">				empID = request.getEmployeeID();</span>
			}

<span class="nc" id="L241">			Collection empNameList = Collections.emptyList();</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">			if (isNewRequest) {</span>
<span class="nc" id="L243">				Collection orgIDs = user.getAuthorizedScopes(PrivilegeKeys.CS_MODIFYREQUESTSFOREMPLOYEE,</span>
						Organization.SCOPE_TYPE);
<span class="nc" id="L245">				empNameList = EmployeeModelHandler.getEmployeeNamesForOrgs(context, orgIDs, null);</span>

<span class="nc bnc" id="L247" title="All 4 branches missed.">				if (empID == null &amp;&amp; !empNameList.isEmpty()) {</span>
					// Create sorted list
<span class="nc" id="L249">					List sortedENames = new ArrayList(empNameList);</span>
<span class="nc" id="L250">					PersonNameUtil.sort(sortedENames, true, context.getLocaleContext());</span>
<span class="nc" id="L251">					EmployeeName eName = (EmployeeName) sortedENames.iterator().next();</span>
<span class="nc" id="L252">					empID = eName.getID();</span>
				}
<span class="nc" id="L254">			} else {</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">				if (request != null) {</span>
<span class="nc" id="L256">					List ids = new ArrayList(1);</span>
<span class="nc" id="L257">					ids.add(request.getEmployeeID());</span>
<span class="nc" id="L258">					HashMap eNameMap = EmployeeModelHandler.getEmployeeNamesByIDs(context, ids);</span>
<span class="nc" id="L259">					empNameList = eNameMap.values();</span>
				}
			}

<span class="nc bnc" id="L263" title="All 4 branches missed.">			if (isNewRequest &amp;&amp; empNameList.isEmpty()) {</span>
				// No Agents under manager's supervision
<span class="nc" id="L265">				return new CSDetailData(empID, request, null, Collections.emptyList());</span>
			} else {
<span class="nc" id="L267">				ID managerOrgID = getEmpOrgID(context, context.getUser().getEmployeeID());</span>
<span class="nc" id="L268">				OrganizationSetting orgSetting = getOrgSetting(managerOrgID); // we</span>
																				// use
																				// the
																				// manager's
																				// orgID
																				// to
																				// get
																				// org
																				// settings.
																				// This
																				// is
																				// also
																				// how
																				// TO
																				// requests
																				// work.

<span class="nc" id="L285">				CSDetailData data = new CSDetailData(empID, request, orgSetting, empNameList);</span>

<span class="nc" id="L287">				populateCSDetailData(data, context, empID, fromDate, toDate, ribbonStartDate, ribbonEndDate,</span>
						isRibbonApplicable, bundle, tz, true);

<span class="nc" id="L290">				return data;</span>
			}
<span class="nc" id="L292">        } catch (RmBaseException e) {</span>
<span class="nc" id="L293">        	throw e;</span>
<span class="nc" id="L294">		} catch (Exception e) {</span>
<span class="nc" id="L295">			return null;</span>
		}
	}

	/**
	 * Return Custom Shift Detail Data for the View Deatils dialog, which
	 * doesn't need the orgSettings, or the lists of shifte, activities,
	 * extBeforeTypes, extBeforeActivities, extAfterTypes, extAfterActivities.
	 */
	public static CSDetailData getCSDetailDataForDetailsDialog(RequestContext context, ID empID, CustShiftReq request,
			Date fromDate, Date toDate, ResourceBundle bundle, TimeZone tz) throws Exception {
		// ID orgID = getEmpOrgID(context, empID);
<span class="nc" id="L307">		CSDetailData data = new CSDetailData(empID, request, null, Collections.EMPTY_LIST);</span>
<span class="nc" id="L308">		populateCSDetailData(data, context, empID, fromDate, toDate, null, null, false, bundle, tz, false);</span>
<span class="nc" id="L309">		return data;</span>
	}

	/**
	 * Return Custom Shift Detail Data for the View Deatils dialog, which
	 * doesn't need the orgSettings, or the lists of shifts, activities,
	 * extBeforeTypes, extBeforeActivities, extAfterTypes, extAfterActivities.
	 * Instead, we return a CSObjectData object, populated from the ID's from
	 * the CustShiftReq parameter.
	 */
	public static CSObjectData getCSObjectDataForDetailsDialog(RequestContext context, CustShiftReq request)
			throws Exception {
<span class="nc" id="L321">		CSObjectData data = new CSObjectData();</span>

<span class="nc" id="L323">		WorkRuleManager workRuleManager = WfmManagerFactory.getWorkRuleManager(context.isInWhatIfMode());</span>

<span class="nc bnc" id="L325" title="All 2 branches missed.">		if (request.getShiftID() != null) {</span>
<span class="nc" id="L326">			ID shiftID = request.getShiftID();</span>
<span class="nc" id="L327">			data._shift = workRuleManager.getShift(shiftID);</span>
		}

<span class="nc bnc" id="L330" title="All 2 branches missed.">		if (request.getActivityID() != null) {</span>
<span class="nc" id="L331">			ID activityID = request.getActivityID();</span>
<span class="nc" id="L332">			data._activity = ActivityModelHandler.getActivityByID(context, activityID);</span>
		}

<span class="nc bnc" id="L335" title="All 2 branches missed.">		if (request.getExtBeforeID() != null) {</span>
<span class="nc" id="L336">			ID extID = request.getExtBeforeID();</span>
<span class="nc" id="L337">			Collection&lt;ShiftOTExtension&gt; exts = workRuleManager.getShiftOTExtensionsByIDs(Collections</span>
<span class="nc" id="L338">					.singletonList(extID));</span>
<span class="nc bnc" id="L339" title="All 4 branches missed.">			if (exts != null &amp;&amp; !exts.isEmpty()) {</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">				for (ShiftOTExtension item : exts) {</span>
<span class="nc" id="L341">					data._extBeforeType = item;</span>
<span class="nc" id="L342">				}</span>
			}
		}

<span class="nc bnc" id="L346" title="All 2 branches missed.">		if (request.getExtBeforeActivityID() != null) {</span>
<span class="nc" id="L347">			ID activityID = request.getExtBeforeActivityID();</span>
<span class="nc" id="L348">			data._extBeforeActivity = ActivityModelHandler.getActivityByID(context, activityID);</span>
		}

<span class="nc bnc" id="L351" title="All 2 branches missed.">		if (request.getExtAfterID() != null) {</span>
<span class="nc" id="L352">			ID extID = request.getExtAfterID();</span>
<span class="nc" id="L353">			Collection&lt;ShiftOTExtension&gt; exts = workRuleManager.getShiftOTExtensionsByIDs(Collections</span>
<span class="nc" id="L354">					.singletonList(extID));</span>
<span class="nc bnc" id="L355" title="All 4 branches missed.">			if (exts != null &amp;&amp; !exts.isEmpty()) {</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">				for (ShiftOTExtension item : exts) {</span>
<span class="nc" id="L357">					data._extAfterType = item;</span>
<span class="nc" id="L358">				}</span>
			}
		}

<span class="nc bnc" id="L362" title="All 2 branches missed.">		if (request.getExtAfterActivityID() != null) {</span>
<span class="nc" id="L363">			ID activityID = request.getExtAfterActivityID();</span>
<span class="nc" id="L364">			data._extAfterActivity = ActivityModelHandler.getActivityByID(context, activityID);</span>
		}

<span class="nc" id="L367">		return data;</span>
	}

	/**
	 * Set the shift/activity/extension/extActivity lists, and the
	 * ShiftAssignment, in the provided CSDetailData.
	 *
	 * @param data
	 * @param context
	 * @param empID
	 * @param orgID
	 * @param orgSetting
	 * @param fromDate
	 *            - the start of the Date range used to get the employee's work
	 *            pattern, etc.
	 * @param toDate
	 *            - the end of the Date range used to get the employee's work
	 *            pattern, etc.
	 * @param ribbonStartDate
	 *            - If the user made a selection in his Net Staffing Ribbon, the
	 *            start of that range.
	 * @param ribbonEndDate
	 *            - If the user made a selection in his Net Staffing Ribbon, the
	 *            end of that range.
	 * @param isRibbonApplicable
	 *            - true if we are in ribbon mode and we should filter the
	 *            activities accordingly.
	 * @param getFullData
	 *            - If true, we return the full set of data. If false, we return
	 *            only the data needed by the &quot;View Details&quot; dialog, which
	 *            doesn't need the lists of Shifts, Activities, etc.
	 */
	public static void populateCSDetailData(CSDetailData data, RequestContext context, ID empID, Date fromDate,
			Date toDate, Date ribbonStartDate, Date ribbonEndDate, boolean isRibbonApplicable, ResourceBundle bundle,
			TimeZone tz, boolean getFullData) throws Exception {
<span class="nc" id="L402">		data._shifts = new HashSet&lt;Shift&gt;();</span>
<span class="nc" id="L403">		data._activities = new HashSet&lt;Activity&gt;();</span>
<span class="nc" id="L404">		data._extBeforeTypes = new HashSet&lt;ShiftOTExtension&gt;();</span>
<span class="nc" id="L405">		data._extBeforeActivities = new HashSet&lt;Activity&gt;();</span>
<span class="nc" id="L406">		data._extAfterTypes = new HashSet&lt;ShiftOTExtension&gt;();</span>
<span class="nc" id="L407">		data._extAfterActivities = new HashSet&lt;Activity&gt;();</span>
<span class="nc" id="L408">		data._mostDeficientActivity1 = null;</span>
<span class="nc" id="L409">		data._mostDeficientActivity2 = null;</span>

<span class="nc bnc" id="L411" title="All 2 branches missed.">		if (getFullData) {</span>
<span class="nc" id="L412">			addSPIDToCSDetailData(data, context, bundle, tz, fromDate, toDate);</span>
		}

<span class="nc bnc" id="L415" title="All 4 branches missed.">		if ((data._spID != null) || !getFullData) {</span>
<span class="nc" id="L416">			WorkRuleManager workRuleManager = WfmManagerFactory.getWorkRuleManager(context.isInWhatIfMode());</span>
<span class="nc" id="L417">			EmpWorkRuleManager empWorkRuleManager = WfmManagerFactory.getEmpWorkRuleManager(context.isInWhatIfMode());</span>

			// For now, we're just getting the ShiftAssignments. May need time
			// off events later.
<span class="nc" id="L421">			Collection scheduleEvents = getScheduleAccessManager(context).getPublishedEventsForWorkResourceByType(</span>
					Event.EVENT_TYPE_SHIFT_ASSIGNMENT, empID, fromDate, toDate);

			// ========== massage event id here to pass validation later
			// ========= start
<span class="nc" id="L426">			Collection unpubEvents = getScheduleAccessManager(context).getEventsForWorkResourceByType(</span>
					Event.EVENT_TYPE_SHIFT_ASSIGNMENT, empID, fromDate, toDate);

<span class="nc" id="L429">            ShiftAssignment pubShift = null;</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">            if (isRibbonApplicable) {</span>
<span class="nc" id="L431">            	pubShift = getShiftAssignment(scheduleEvents, fromDate, toDate, ribbonStartDate, ribbonEndDate);</span>
            } else {
<span class="nc" id="L433">            	pubShift = getShiftAssignment(scheduleEvents, fromDate, toDate);</span>
            }
<span class="nc bnc" id="L435" title="All 2 branches missed.">			if (pubShift != null) {</span>
<span class="nc" id="L436">            	ShiftAssignment unpubShift = null;</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">            	if (isRibbonApplicable) {</span>
<span class="nc" id="L438">            		unpubShift = getShiftAssignment(unpubEvents, fromDate, toDate, ribbonStartDate, ribbonEndDate);</span>
            	} else {
<span class="nc" id="L440">            		unpubShift = getShiftAssignment(unpubEvents, fromDate, toDate);</span>
            	}
<span class="nc bnc" id="L442" title="All 2 branches missed.">				pubShift.setID(unpubShift == null ? null : unpubShift.getID());</span>

<span class="nc" id="L444">				ID pubShiftSpId = pubShift.getCampaignID();</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">				if (pubShiftSpId != null) {</span>
					// QC 144420: Shift request update changes the campaign of
					// the original shift
<span class="nc" id="L448">					data._spID = pubShiftSpId;</span>
				}

			}
			// ========== massage event id here to pass validation later
			// ========= end
<span class="nc bnc" id="L454" title="All 2 branches missed.">			if (getFullData) {</span>
				// addNoneExtensionOptionsToCSDetailData(data, context, bundle);
<span class="nc" id="L456">				Collection activitiesWithMedia = ActivityModelHandler.getActivitiesWithMedia(context);</span>
				// Get the employee's work pattern
<span class="nc" id="L458">				HashMap shiftPatterns = ValidationUtil.getEmpWorkPatterns(empWorkRuleManager, workRuleManager, empID,</span>
						fromDate, toDate); // tbd: should I pass only fromDate,fromDate?

				// Iterate through all the workPatterns and get the
				// shifts/activities/etc for each
<span class="nc bnc" id="L463" title="All 2 branches missed.">				if (!shiftPatterns.isEmpty()) {</span>
<span class="nc" id="L464">					Collection&lt;ID&gt; activityIDs = new HashSet&lt;ID&gt;();</span>
					Collection&lt;Activity&gt; activities;
<span class="nc" id="L466">					ArrayList&lt;ID&gt; extBeforeActivityIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L467">					ArrayList&lt;ID&gt; extAfterActivityIDs = new ArrayList&lt;ID&gt;();</span>

					// Get all of the shifts from the workPattern
					// (SHIFTPATTERNSHIFT)
<span class="nc bnc" id="L471" title="All 2 branches missed.">					for (Iterator it = shiftPatterns.values().iterator(); it.hasNext();) {</span>
<span class="nc" id="L472">						ShiftPattern shiftPattern = (ShiftPattern) it.next();</span>

<span class="nc bnc" id="L474" title="All 2 branches missed.">						for (Shift shift : shiftPattern.getShiftPatternShiftAttributes().keySet()) {</span>

<span class="nc" id="L476">							Collection&lt;ID&gt; curShiftActivityIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L477">							getActivityIdsFromShiftEvents(activitiesWithMedia, curShiftActivityIDs, shift);</span>

							// must check activityID for null to exclude the &quot;Possible Days Off&quot; shift
<span class="nc bnc" id="L480" title="All 4 branches missed.">							if (shift.getActivityID() != null &amp;&amp; verifyForMedia(activitiesWithMedia, shift.getActivityID())) {</span>
<span class="nc" id="L481">								curShiftActivityIDs.add(shift.getActivityID());</span>
							}

<span class="nc bnc" id="L484" title="All 2 branches missed.">							if (!curShiftActivityIDs.isEmpty()) {</span>
<span class="nc" id="L485">								data._shifts.add(shift);</span>
							}

<span class="nc" id="L488">							activityIDs.addAll(curShiftActivityIDs);</span>
<span class="nc" id="L489">						}</span>
<span class="nc" id="L490">					}</span>

					// Get all of the activities for the shifts
<span class="nc" id="L493">					getActivityObjectsFromIdsAndAddToData(data, context, activityIDs);</span>

					// Get all of the Extensions Before/After for the
					// workPattern
<span class="nc" id="L497">					HashMap&lt;ShiftOTExtension, Set&lt;ShiftPattern.StartTime&gt;&gt; shiftOTExtensions = getOTExtensionsFromSelectedShiftPatterns(</span>
<span class="nc" id="L498">							shiftPatterns.values(), fromDate);</span>

<span class="nc bnc" id="L500" title="All 2 branches missed.">					for (Iterator it = shiftOTExtensions.entrySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L501">						Entry&lt;ShiftOTExtension, Set&lt;ShiftPattern.StartTime&gt;&gt; entry = (Entry&lt;ShiftOTExtension, Set&lt;ShiftPattern.StartTime&gt;&gt;) it</span>
<span class="nc" id="L502">								.next();</span>
<span class="nc" id="L503">						ShiftOTExtension shiftOTExtension = entry.getKey();</span>
<span class="nc" id="L504">						Set&lt;ShiftPattern.StartTime&gt; startTimes = entry.getValue();</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">						for (ShiftPattern.StartTime startTime : startTimes) {</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">							if (startTime.equals(ShiftPattern.StartTime.StartOfShift)</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">									|| startTime.equals(ShiftPattern.StartTime.StartOrEndOfShift)) {</span>
								// Get all of the OT Extensions Before Shift
								// from the workPattern
								// (SHIFTPATTERNOTEXTENSION.OTEXTSTARTTIMES=0||2)
<span class="nc" id="L511">								data._extBeforeTypes.add(shiftOTExtension);</span>
<span class="nc bnc" id="L512" title="All 4 branches missed.">								if (shiftOTExtension.getActivityID() != null &amp;&amp; verifyForMedia(activitiesWithMedia, shiftOTExtension.getActivityID())) {</span>
<span class="nc" id="L513">									extBeforeActivityIDs.add(shiftOTExtension.getActivityID());</span>
								}
							}

<span class="nc bnc" id="L517" title="All 2 branches missed.">							if (startTime.equals(ShiftPattern.StartTime.EndOfShift)</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">									|| startTime.equals(ShiftPattern.StartTime.StartOrEndOfShift)) {</span>
								// Get all of the OT Extensions Before Shift
								// from the workPattern
								// (SHIFTPATTERNOTEXTENSION.OTEXTSTARTTIMES=1||2)
<span class="nc" id="L522">								data._extAfterTypes.add(shiftOTExtension);</span>
<span class="nc bnc" id="L523" title="All 4 branches missed.">								if (shiftOTExtension.getActivityID() != null &amp;&amp; verifyForMedia(activitiesWithMedia, shiftOTExtension.getActivityID())) {</span>
<span class="nc" id="L524">									extAfterActivityIDs.add(shiftOTExtension.getActivityID());</span>
								}
							}
<span class="nc" id="L527">						}</span>
<span class="nc" id="L528">					}</span>

					// Get all of the activities from the extBeforeTypes
<span class="nc bnc" id="L531" title="All 2 branches missed.">					if (extBeforeActivityIDs.size() &gt; 0) {</span>
<span class="nc" id="L532">						activities = ActivityModelHandler.getActivitiesByIDs(context, extBeforeActivityIDs);</span>
<span class="nc" id="L533">						data._extBeforeActivities.addAll(activities);</span>
					}

					// Get all of the activities from the extAfterTypes
<span class="nc bnc" id="L537" title="All 2 branches missed.">					if (extAfterActivityIDs.size() &gt; 0) {</span>
<span class="nc" id="L538">						activities = ActivityModelHandler.getActivitiesByIDs(context, extAfterActivityIDs);</span>
<span class="nc" id="L539">						data._extAfterActivities.addAll(activities);</span>
					}

<span class="nc" id="L542">					mergeActivities(empID, fromDate, toDate, ribbonStartDate, ribbonEndDate, isRibbonApplicable,</span>
							pubShift, data, context, tz);
				}

<span class="nc" id="L546">				addNoneExtensionOptionsToCSDetailData(data, context, bundle);</span>
			}

<span class="nc" id="L549">			addShiftAssignmentToCSDetailData(data, pubShift, context, bundle, tz);</span>

<span class="nc" id="L551">			addGapDurationsToCSDetailData(data, scheduleEvents);</span>
		}
<span class="nc" id="L553">	}</span>

	/**
	 * Given a collection of activity ID's, get the Activity value objects and add them to data._activities.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	protected static void getActivityObjectsFromIdsAndAddToData(CSDetailData data, RequestContext context,
			Collection&lt;ID&gt; activityIDs) throws RemoteException, BbmException {
		Collection&lt;Activity&gt; activities;
<span class="nc bnc" id="L562" title="All 2 branches missed.">		if (activityIDs.size() &gt; 0) {</span>
<span class="nc" id="L563">			activities = ActivityModelHandler.getActivitiesByIDs(context, activityIDs);</span>
<span class="nc" id="L564">			data._activities.addAll(activities);</span>
		}
<span class="nc" id="L566">	}</span>

	/**
	 * Add the shift template's shift events' activities to activityIDs list if they have media associated with them.
	 */
	private static void getActivityIdsFromShiftEvents(Collection activitiesWithMedia, Collection&lt;ID&gt; activityIDs,
			Shift shift) throws Exception {
<span class="nc" id="L573">		Collection&lt;ShiftEvent&gt; shiftEvents = shift.getShiftEvents();</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">		for (ShiftEvent se : shiftEvents) {</span>
<span class="nc" id="L575">			ID seActID = se.getActivityID();</span>
<span class="nc bnc" id="L576" title="All 4 branches missed.">			if (seActID != null &amp;&amp; verifyForMedia(activitiesWithMedia, seActID)) {</span>
<span class="nc" id="L577">				activityIDs.add(seActID);</span>
			}
<span class="nc" id="L579">		}</span>
<span class="nc" id="L580">	}</span>

	/**
	 * We will merge all activities collections (Shift/ExtBefore/extAfter)
	 * together. But when in Net Staffing Ribbon mode, we will keep only those
	 * with a net staffing deficiency.
	 *
	 * @param empID
	 *            - The employee ID whose Custom Shift Request dialog will be
	 *            shown.
	 * @param fromDate
	 *            - the start of the Date range used to get the employee's work
	 *            pattern, etc.
	 * @param toDate
	 *            - the end of the Date range used to get the employee's work
	 *            pattern, etc.
	 * @param ribbonStartDate
	 *            - If the user made a selection in his Net Staffing Ribbon, the
	 *            start of that range.
	 * @param ribbonEndDate
	 *            - If the user made a selection in his Net Staffing Ribbon, the
	 *            end of that range.
	 * @param isRibbonApplicable
	 *            - true if we are in ribbon mode and we should filter the
	 *            activities accordingly.
	 * @param sa
	 *            - The employee's ShiftAssignment between fromDate and toDate.
	 * @param data
	 *            - We will update the _activities, _extBeforeActivities, and
	 *            _extAfterActivities collections.
	 * @param context
	 *            - RequestContext.
	 * @throws BbmEJBCreateException
	 * @throws RemoteException
	 * @throws BbmFinderException
	 */
	private static void mergeActivities(ID empID, Date fromDate, Date toDate, Date ribbonStartDate, Date ribbonEndDate,
			boolean isRibbonApplicable, ShiftAssignment sa, CSDetailData data, RequestContext context, TimeZone tz)
			throws BbmEJBCreateException, BbmFinderException, RemoteException, BbmException, Exception {
<span class="nc bnc" id="L619" title="All 2 branches missed.">		if (isRibbonApplicable) { // (ribbonStartDate != null) &amp;&amp;</span>
								// !(ribbonStartDate.before(fromDate) ||ribbonStartDate.after(toDate)))
			// If user has a scheduled shift, then break the ribbon up into a
			// range before the shift and a range after the shift.
			// ShiftAssignment sa = getShiftAssignment(scheduleEvents);

			// The ribbon selection time range. If the ribbon selection includes
			// time before the
			// scheduled shift and time after, then this is the range for the
			// selected time before the shift only.
<span class="nc" id="L629">			Date ribbonStartDate1 = ribbonStartDate;</span>
<span class="nc" id="L630">			Date ribbonEndDate1 = ribbonEndDate;</span>

			// If the ribbon selection includes time before the scheduled shift
			// and time after, then this is the
			// range for the selected time before the shift only. Otherwise,
			// this range will remain null.
<span class="nc" id="L636">			Date ribbonStartDate2 = null;</span>
<span class="nc" id="L637">			Date ribbonEndDate2 = null;</span>

<span class="nc bnc" id="L639" title="All 2 branches missed.">			if (sa != null) {</span>
<span class="nc" id="L640">				TimeRange mainShiftTimeRange = getMainShiftTimeRange(sa, tz);</span>
<span class="nc" id="L641">				Date mainShiftStartTime = mainShiftTimeRange.getStartDate();</span>
<span class="nc" id="L642">				Date mainShiftEndTime = mainShiftTimeRange.getEndDate();</span>

				// case 1: selection starts before shift, and ends before shift
				// case 2: selection starts during shift, and ends during shift
				// (not allowed because that would be a VTO request).
<span class="nc bnc" id="L647" title="All 4 branches missed.">				if ((ribbonStartDate.before(mainShiftStartTime) &amp;&amp; !ribbonEndDate.after(mainShiftStartTime))</span>
<span class="nc bnc" id="L648" title="All 4 branches missed.">						|| (!ribbonStartDate.before(mainShiftStartTime) &amp;&amp; !ribbonEndDate.after(mainShiftEndTime))) {</span>
					// the ribbonStartDate1, ribbonEndDate1 range is already
					// correct and is the only range we need.
				}

				// case 3: selection starts after shift, and ends after shift
<span class="nc bnc" id="L654" title="All 4 branches missed.">				else if (!ribbonStartDate.before(mainShiftEndTime) &amp;&amp; ribbonEndDate.after(mainShiftEndTime)) {</span>
<span class="nc" id="L655">					ribbonStartDate2 = ribbonStartDate;</span>
<span class="nc" id="L656">					ribbonEndDate2 = ribbonEndDate;</span>
<span class="nc" id="L657">					ribbonStartDate1 = null;</span>
<span class="nc" id="L658">					ribbonEndDate1 = null;</span>
				}

				// case 4: selection starts before shift, and ends during shift
<span class="nc bnc" id="L662" title="All 4 branches missed.">				else if (ribbonStartDate.before(mainShiftStartTime) &amp;&amp; !ribbonEndDate.after(mainShiftEndTime)) {</span>
					// cut off ribbonEndDate1 at the shift start
<span class="nc" id="L664">					ribbonEndDate1 = mainShiftStartTime;</span>
				}

				// case 5: selection starts before shift, and ends after shift
<span class="nc bnc" id="L668" title="All 4 branches missed.">				else if (ribbonStartDate.before(mainShiftStartTime) &amp;&amp; ribbonEndDate.after(mainShiftEndTime)) {</span>
<span class="nc" id="L669">					ribbonEndDate1 = mainShiftStartTime;</span>
<span class="nc" id="L670">					ribbonStartDate2 = mainShiftEndTime;</span>
<span class="nc" id="L671">					ribbonEndDate2 = ribbonEndDate;</span>
				}

				// case 6: selection starts during shift, and ends after shift
<span class="nc bnc" id="L675" title="All 4 branches missed.">				else if (ribbonStartDate.before(mainShiftEndTime) &amp;&amp; ribbonEndDate.after(mainShiftEndTime)) {</span>
<span class="nc" id="L676">					ribbonStartDate2 = mainShiftEndTime;</span>
<span class="nc" id="L677">					ribbonEndDate2 = ribbonEndDate;</span>
<span class="nc" id="L678">					ribbonStartDate1 = null;</span>
<span class="nc" id="L679">					ribbonEndDate1 = null;</span>
				}
			}

			// Get net staffing cube for the original ribbon selection range
<span class="nc" id="L684">			TimeSeriesManager timeSeriesManager = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L685">			NetStaffingCube nsCube = timeSeriesManager.getNetStaffing(empID, ribbonStartDate, ribbonEndDate);</span>

<span class="nc" id="L687">			Collection allDeficientActivities1 = new HashSet();</span>
<span class="nc" id="L688">			Collection allDeficientActivities2 = new HashSet();</span>
<span class="nc" id="L689">			Activity mostDeficientActivity1 = null;</span>
<span class="nc" id="L690">			Activity mostDeficientActivity2 = null;</span>

			// read the first set of deficient activities
<span class="nc bnc" id="L693" title="All 2 branches missed.">			if (ribbonStartDate1 != null) {</span>
<span class="nc" id="L694">				HashMap deficiencyMap = getDeficientActivitiesFromNetStaffingCube(nsCube, empID, fromDate, toDate,</span>
						ribbonStartDate1, ribbonEndDate1, data, context);

<span class="nc" id="L697">				allDeficientActivities1 = (Collection) deficiencyMap.get(&quot;allDeficientActivities&quot;);</span>
<span class="nc" id="L698">				mostDeficientActivity1 = (Activity) deficiencyMap.get(&quot;mostDeficientActivity&quot;);</span>
			}

			// read the second set of deficient activities
<span class="nc bnc" id="L702" title="All 2 branches missed.">			if (ribbonStartDate2 != null) {</span>
<span class="nc" id="L703">				HashMap deficiencyMap = getDeficientActivitiesFromNetStaffingCube(nsCube, empID, fromDate, toDate,</span>
						ribbonStartDate2, ribbonEndDate2, data, context);

<span class="nc" id="L706">				allDeficientActivities2 = (Collection) deficiencyMap.get(&quot;allDeficientActivities&quot;);</span>
<span class="nc" id="L707">				mostDeficientActivity2 = (Activity) deficiencyMap.get(&quot;mostDeficientActivity&quot;);</span>
			}

<span class="nc" id="L710">			allDeficientActivities1.addAll(allDeficientActivities2);</span>
<span class="nc" id="L711">			data._activities = allDeficientActivities1;</span>
<span class="nc" id="L712">			data._extBeforeActivities = cloneCollection(allDeficientActivities1);</span>
<span class="nc" id="L713">			data._extAfterActivities = cloneCollection(allDeficientActivities1);</span>
<span class="nc" id="L714">			data._mostDeficientActivity1 = mostDeficientActivity1;</span>
<span class="nc" id="L715">			data._mostDeficientActivity2 = mostDeficientActivity2;</span>
<span class="nc" id="L716">		} else {</span>
			// Just merge all the activities together, so all Activity dropdowns
			// will have the same options.
<span class="nc" id="L719">			data._activities.addAll(data._extBeforeActivities);</span>
<span class="nc" id="L720">			data._activities.addAll(data._extAfterActivities);</span>
<span class="nc" id="L721">			data._extBeforeActivities.addAll(data._activities);</span>
<span class="nc" id="L722">			data._extAfterActivities.addAll(data._activities);</span>
		}

		// as a convenience to the dialog, we'll always set the
		// _mostDeficientActivity2 so the extAfter dropdown can easily access
		// it.
		// if (data._mostDeficientActivity1 == null &amp;&amp;
		// data._mostDeficientActivity2 != null)
		// data._mostDeficientActivity1 = data._mostDeficientActivity2;
<span class="nc" id="L731">	}</span>

	/**
	 * Return an HashMap with only two entries:
	 * &quot;allDeficientActivities&quot;-&gt;Collection &quot;mostDeficientActivity&quot; -&gt; Activity
	 */
	private static HashMap getDeficientActivitiesFromNetStaffingCube(NetStaffingCube nsCube, ID empID, Date fromDate,
			Date toDate, Date ribbonStartDate, Date ribbonEndDate, CSDetailData data, RequestContext context)
			throws RemoteException, BbmException {
<span class="nc" id="L740">		HashMap resultMap = new HashMap(2);</span>

<span class="nc bnc" id="L742" title="All 6 branches missed.">		if ((ribbonStartDate != null) &amp;&amp; !(ribbonStartDate.before(fromDate) || ribbonStartDate.after(toDate))) {</span>
			// get the net staffing aggregation for each SPQueue, for the ribbon
			// selection

			// end date should be non-inclusive
<span class="nc" id="L747">			ribbonEndDate = new Date(ribbonEndDate.getTime() - 1);</span>
<span class="nc" id="L748">			Map&lt;SPQueue, Double&gt; spqAggMap = nsCube.getNetStaffingForDateRange(ribbonStartDate, ribbonEndDate);</span>
<span class="nc" id="L749">			List&lt;ID&gt; spIDs = CustomShiftRequestsMH.getListOfSPIDSFromSpqAggMap(spqAggMap);</span>
<span class="nc" id="L750">			CampaignManager campaignManager = WfmManagerFactory.getCampaignManager(context.isInWhatIfMode());</span>
<span class="nc" id="L751">			Collection&lt;SchedulingPeriod&gt; schedulingPeriodLst = campaignManager.getSchedulingPeriodsByID(spIDs);</span>
<span class="nc" id="L752">			Map&lt;ID, Boolean&gt; spSkillMap = CustomShiftRequestsMH.getSpIsSkilledMap(schedulingPeriodLst);</span>



			// find the deficient SPQueues, and keep track of the most deficient one

			// the SPQueue with the lowest Net Staffing value
<span class="nc" id="L759">			SPQueue mostDeficientSPQueue = null;</span>
			
			// the lowest Net Staffing value of all SPQueues
<span class="nc" id="L762">			Double mostDeficientNS = 0.0;</span>
			
			// all of the activities linked to the all of the deficient SPQueues
<span class="nc" id="L765">			Set&lt;ID&gt; allDeficientActivityIDs = new HashSet&lt;ID&gt;();</span>
			
			// all of the activities linked to the most deficient SPQueue
<span class="nc" id="L768">			Collection mostDeficientActivityIDs = null;</span>

			// create a collection of all activities from the agent's
			// workPatterns
<span class="nc" id="L772">			HashSet allElligibleActivities = new HashSet();</span>
<span class="nc" id="L773">			allElligibleActivities.addAll(data.getActivities());</span>
<span class="nc" id="L774">			allElligibleActivities.addAll(data.getExtBeforeActivities());</span>
<span class="nc" id="L775">			allElligibleActivities.addAll(data.getExtAfterActivities());</span>
<span class="nc" id="L776">			HashSet allElligibleActivityIDs = convertActivitiesToIDs(allElligibleActivities);</span>
<span class="nc" id="L777">			ActivityManager activityManager = WfmManagerFactory.getActivityManager(context.isInWhatIfMode());</span>
<span class="nc" id="L778">			Map&lt;ID, Collection&lt;ID&gt;&gt; mediaIdToActivityIdMap = null;</span>

			// find the deficient activities for each spq
<span class="nc bnc" id="L781" title="All 2 branches missed.">			for (Iterator&lt;Entry&lt;SPQueue, Double&gt;&gt; it = spqAggMap.entrySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L782">				Entry&lt;SPQueue, Double&gt; entry = it.next();</span>
<span class="nc" id="L783">				SPQueue spq = entry.getKey();</span>
<span class="nc" id="L784">				ID spqQueueID = spq.getQueueID();</span>
<span class="nc" id="L785">				double ns = entry.getValue().doubleValue();</span>

				//A combined SPQueue will have a null queueID. We only care about non-combined queues.
<span class="nc bnc" id="L788" title="All 4 branches missed.">				if (isNonCombinedQueueWithNetStaffingDeficiency(spqQueueID, ns) || !isSPSkilled(spSkillMap, spq.getSpID())) {</span>
					//find the activity ID's linked to this SPQueue
<span class="nc" id="L790">					Collection&lt;ID&gt; activitiesForCurSPQueue = null;</span>

					//- Each Queue has a Media. So use ACTIVITYMEDIA to get the QueueID-&gt;ActivityList mappings.
<span class="nc bnc" id="L793" title="All 4 branches missed.">					if(mediaIdToActivityIdMap == null || !mediaIdToActivityIdMap.containsKey(spq.getMediaID())) {</span>
<span class="nc" id="L794">						mediaIdToActivityIdMap = activityManager.findActivitiesForMedia(</span>
<span class="nc" id="L795">								Collections.singletonList(spq.getMediaID()));</span>
					}
<span class="nc" id="L797">					activitiesForCurSPQueue = mediaIdToActivityIdMap.get(spq.getMediaID());</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">					if (isSPSkilled(spSkillMap, spq.getSpID())){</span>
<span class="nc" id="L799">						Map activityIDsToHopQueueIDs = activityManager.findQueueForActivities(activitiesForCurSPQueue);</span>
<span class="nc" id="L800">						filterOutQueueHoppingActivitiesThatAreNotLinkedToThisQueue(spqQueueID, activitiesForCurSPQueue,</span>
							activityIDsToHopQueueIDs);
					}

<span class="nc bnc" id="L804" title="All 4 branches missed.">					if (activitiesForCurSPQueue != null &amp;&amp; !activitiesForCurSPQueue.isEmpty()) {</span>
						//remove all of the deficient activities that the agent is not elligible for
<span class="nc" id="L806">						activitiesForCurSPQueue.retainAll(allElligibleActivityIDs);</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">						if (!activitiesForCurSPQueue.isEmpty()) {</span>
<span class="nc" id="L808">							allDeficientActivityIDs.addAll(activitiesForCurSPQueue);</span>

							//store the most deficient
<span class="nc bnc" id="L811" title="All 4 branches missed.">							if ((mostDeficientSPQueue == null) || (ns &lt; mostDeficientNS)) {</span>
<span class="nc" id="L812">								mostDeficientSPQueue = spq;</span>
<span class="nc" id="L813">								mostDeficientNS = ns;</span>
<span class="nc" id="L814">								mostDeficientActivityIDs = activitiesForCurSPQueue;</span>
							}
						}
					}
				}
<span class="nc" id="L819">			}</span>

<span class="nc" id="L821">			Collection allDeficientActivities = ActivityModelHandler.getActivitiesByIDs(context, allDeficientActivityIDs);</span>

			//use only these deficient activities for the request dialog. All Activity dropdowns will have the same options.
<span class="nc" id="L824">			resultMap.put(&quot;allDeficientActivities&quot;, allDeficientActivities);</span>

			//determine which deficient activity should be set in the Custom Shift Request dialog by default
<span class="nc bnc" id="L827" title="All 4 branches missed.">			if (mostDeficientActivityIDs != null &amp;&amp; !mostDeficientActivityIDs.isEmpty()) {</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">				for (Iterator mostDefIt = mostDeficientActivityIDs.iterator(); mostDefIt.hasNext();) {</span>
<span class="nc" id="L829">					resultMap.put(&quot;mostDeficientActivity&quot;, ActivityModelHandler.getActivityByID(context, (ID)mostDefIt.next()));</span>
					//just get the first one
					break;
				}
			}
		}

<span class="nc" id="L836">		return resultMap;</span>
	}

	private static Boolean isSPSkilled(Map&lt;ID, Boolean&gt; spSkillMap, ID spID) {
<span class="nc" id="L840">		return spSkillMap.get(spID);</span>
	}

	protected static Map&lt;ID, Boolean&gt; getSpIsSkilledMap(Collection&lt;SchedulingPeriod&gt; collSchedulingPeriod) throws
			BbmEJBCreateException, BbmFinderException, RemoteException {

<span class="nc" id="L846">		HashMap&lt;ID, Boolean&gt; spSkillMap = new HashMap&lt;ID, Boolean&gt;();</span>
<span class="nc bnc" id="L847" title="All 4 branches missed.">		if (collSchedulingPeriod != null &amp;&amp; !collSchedulingPeriod.isEmpty()) {</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">			for (SchedulingPeriod sp : collSchedulingPeriod) {</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">				spSkillMap.put(sp.getID(), sp.getSkillBased() ? Boolean.TRUE : Boolean.FALSE);</span>
<span class="nc" id="L850">			}</span>
		}

<span class="nc" id="L853">		return spSkillMap;</span>
	}

	protected static List&lt;ID&gt; getListOfSPIDSFromSpqAggMap(Map&lt;SPQueue, Double&gt; spqAggMap) {
<span class="nc" id="L857">		List&lt;ID&gt; spIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L858" title="All 4 branches missed.">		if (spqAggMap != null &amp;&amp; !spqAggMap.isEmpty()) {</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">			for (Entry&lt;SPQueue, Double&gt; spqAggMapEntry : spqAggMap.entrySet()) {</span>
<span class="nc" id="L860">				spIDs.add(spqAggMapEntry.getKey().getSpID());</span>
<span class="nc" id="L861">			}</span>
		}
<span class="nc" id="L863">		return spIDs;</span>
	}

	protected static CampaignManager getCampaignManager(boolean isWhatIf) throws BbmEJBCreateException{
<span class="nc" id="L867">		return WfmManagerFactory.getCampaignManager(isWhatIf);</span>
	}

	protected static void filterOutQueueHoppingActivitiesThatAreNotLinkedToThisQueue(ID spqQueueID,
																								 Collection&lt;ID&gt; activitiesForCurSPQueue, Map activityIDsToHopQueueIDs) {
<span class="nc bnc" id="L872" title="All 2 branches missed.">		if (activityIDsToHopQueueIDs != null) {</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">			for (Iterator itHoppers = activityIDsToHopQueueIDs.keySet().iterator(); itHoppers.hasNext();) {</span>
<span class="nc" id="L874">				ID curActivityID = (ID)itHoppers.next();</span>
<span class="nc" id="L875">				Collection curQueueIDs = (Collection)activityIDsToHopQueueIDs.get(curActivityID);</span>
<span class="nc bnc" id="L876" title="All 4 branches missed.">				if (curQueueIDs != null &amp;&amp; !curQueueIDs.isEmpty() ) {</span>
<span class="nc" id="L877">					boolean matchedCurSPQ = false;</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">					for (Iterator itHoppedQueues = curQueueIDs.iterator(); itHoppedQueues.hasNext();) {</span>
<span class="nc" id="L879">						ID curQueueID = (ID)itHoppedQueues.next();</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">						if (curQueueID.equals(spqQueueID)) {</span>
<span class="nc" id="L881">							matchedCurSPQ = true;</span>
<span class="nc" id="L882">							break;</span>
						}
<span class="nc" id="L884">					}</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">					if (!matchedCurSPQ) {</span>
<span class="nc" id="L886">						activitiesForCurSPQueue.remove(curActivityID);</span>
					}
				}
<span class="nc" id="L889">			}</span>
		}
<span class="nc" id="L891">	}</span>

	protected static boolean isNonCombinedQueueWithNetStaffingDeficiency(ID spqQueueID, double ns) {
<span class="nc bnc" id="L894" title="All 6 branches missed.">		return ns &lt; 0 &amp;&amp; ns &gt; Trace.TRACEINCOMP &amp;&amp; spqQueueID != null;</span>
	}


	private static HashSet cloneCollection(Collection items) {
<span class="nc bnc" id="L899" title="All 2 branches missed.">		if (items != null) {</span>
<span class="nc" id="L900">			HashSet result = new HashSet(items.size());</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">			for (Iterator it = items.iterator(); it.hasNext();) {</span>
<span class="nc" id="L902">				result.add(it.next());</span>
			}
<span class="nc" id="L904">			return result;</span>
		}
<span class="nc" id="L906">		return null;</span>
	}

	private static HashSet convertActivitiesToIDs(HashSet activities) {
<span class="nc" id="L910">		HashSet ids = new HashSet(activities.size());</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">		for (Iterator it = activities.iterator(); it.hasNext();) {</span>
<span class="nc" id="L912">			ids.add(((Activity) it.next()).getID());</span>
		}

<span class="nc" id="L915">		return ids;</span>
	}
	/**
	 * Add the Scheduling Period to the CSDetailData. _schedulingPeriod
	 */
	private static void addSPIDToCSDetailData(CSDetailData data, RequestContext context, ResourceBundle bundle,
			TimeZone tz, Date fromDate, Date toDate) throws Exception {
<span class="nc" id="L922">		CampaignManager campaignManager = WfmManagerFactory.getCampaignManager(context.isInWhatIfMode());</span>

<span class="nc" id="L924">		Collection assignments = campaignManager.getWorkResourceCampaignAssignments(data.getEmpID(), fromDate, toDate);</span>
<span class="nc bnc" id="L925" title="All 4 branches missed.">		if (assignments != null &amp;&amp; assignments.size() &gt; 0) {</span>
<span class="nc" id="L926">			data.spIDMap = new HashMap&lt;ID,Pair&lt;Date,Date&gt;&gt;();</span>

<span class="nc bnc" id="L928" title="All 2 branches missed.">			for (Iterator it = assignments.iterator(); it.hasNext();) {</span>
<span class="nc" id="L929">				CampaignWorkResource assignment = (CampaignWorkResource) it.next();</span>
<span class="nc bnc" id="L930" title="All 4 branches missed.">				if (assignment != null &amp;&amp; assignment.getSPID() != null) {</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">					if(data._spID == null) {</span>
<span class="nc" id="L932">						data._spID = assignment.getSPID();</span>
					}
<span class="nc" id="L934">					Pair&lt;Date,Date&gt; datePair = new Pair&lt;Date,Date&gt;();</span>
<span class="nc" id="L935">					datePair.setFirst(assignment.getStartTime());</span>
<span class="nc" id="L936">					datePair.setSecond(assignment.getEndTime());</span>
<span class="nc" id="L937">					data.spIDMap.put(assignment.getSPID(),datePair);</span>

					/*
					 * TBD: what if he's in more than 1 SP? How do we know which
					 * to choose? Not sure if it even matters, but we can
					 * either: (1) we may need to base it on which Shift the
					 * user selects. or, (2) just choose the first one, or (3)
					 * If coming from the ribbon, base it on the neediest queue.
					 * (4) If a shift change request, which shift he is
					 * currently scheduled for.
					 */
				}
<span class="nc" id="L949">			}</span>
<span class="nc" id="L950">			return;</span>
		}
<span class="nc" id="L952">	}</span>

	/**
	 * Get the scheduled ShiftAssignment (if any) from a Collection of scheduled
	 * events. We get the first one that starts within the specified date range.
	 *
	 * @param scheduleEvents
	 *            A collection of events, one or more of which could be a
	 *            ShiftAssignment, or other event types.
	 * @param fromDate
	 *            - The start of the day that the scheduleEvents intersect.
	 * @param toDate
	 *            - The end of the day that the scheduleEvents intersect.
	 */
	private static ShiftAssignment getShiftAssignment(Collection scheduleEvents, Date fromDate, Date toDate)
			throws Exception {
<span class="nc bnc" id="L968" title="All 2 branches missed.">		for (Iterator it = scheduleEvents.iterator(); it.hasNext();) {</span>
<span class="nc" id="L969">			Object obj = it.next();</span>
<span class="nc bnc" id="L970" title="All 4 branches missed.">			if (obj != null &amp;&amp; obj instanceof ShiftAssignment) {</span>
<span class="nc" id="L971">				Date eventStart = ((ShiftAssignment) obj).getStartTime();</span>
<span class="nc bnc" id="L972" title="All 4 branches missed.">				if (!eventStart.before(fromDate) &amp;&amp; eventStart.before(toDate)) {</span>
<span class="nc" id="L973">					return (ShiftAssignment) obj;</span>
				}
			}
<span class="nc" id="L976">		}</span>
<span class="nc" id="L977">		return null;</span>
	}

    private static ShiftAssignment getShiftAssignment(Collection scheduleEvents, Date fromDate, Date toDate,
			Date ribbonStartDate, Date ribbonEndDate) throws Exception {
		
<span class="nc" id="L983">		List&lt;ShiftAssignment&gt; shiftAssignments = (List&lt;ShiftAssignment&gt;) scheduleEvents;</span>

<span class="nc" id="L985">	    ShiftAssignment rtnSa = null;</span>
<span class="nc" id="L986">	    int shiftAssnsSize = shiftAssignments.size();</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">	    if (shiftAssnsSize == 1) {</span>
<span class="nc" id="L988">	    	rtnSa = getShiftAssignmentForSingleSA(fromDate, toDate, ribbonStartDate, shiftAssignments);</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">	    } else if (shiftAssnsSize == 2) {</span>
<span class="nc" id="L990">	    	rtnSa = getClosestShiftToRibbonDrag(shiftAssignments, ribbonStartDate, ribbonEndDate);</span>
	    }

<span class="nc" id="L993">	    return rtnSa;</span>
	}

	protected static ShiftAssignment getShiftAssignmentForSingleSA(Date fromDate, Date toDate, Date ribbonStartDate,
			List&lt;ShiftAssignment&gt; shiftAssignments) {
<span class="nc" id="L998">		long FOURHRS = 4 * 60 * 60 * 1000;</span>
<span class="nc" id="L999">		ShiftAssignment rtnSa = null;</span>

<span class="nc" id="L1001">		ShiftAssignment sa = shiftAssignments.get(0);</span>
<span class="nc" id="L1002">		Date eventEnd = sa.getEndTime();</span>
<span class="nc" id="L1003">		Date eventStart = sa.getStartTime();</span>
<span class="nc bnc" id="L1004" title="All 4 branches missed.">		if (!eventStart.before(fromDate) &amp;&amp; eventStart.before(toDate)) {</span>
			// in this case the ShiftAssignment begins on this day - always use it.
<span class="nc" id="L1006">			rtnSa = sa;</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">		} else if (ribbonStartDate.before(eventEnd)) {</span>
			// the ShiftAssignment started on the previous day and crossed the day boundary
			// the start mouse click overlaps with the shift. Use this shift.
<span class="nc" id="L1010">			rtnSa = sa;</span>
		} else {
			// the ShiftAssignment started on the previous day and crossed the day boundary
			// the start mouse click is not before the end of the ShiftAssignment
			// use this shift to create an ot extension if it's within 4 hours of the ribbon start
			// otherwise return null and the code will create a New Shift Request
<span class="nc" id="L1016">			long msBetweenEndOfShiftAndStartOfRibbon = ribbonStartDate.getTime() - eventEnd.getTime();</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">			rtnSa = (msBetweenEndOfShiftAndStartOfRibbon &lt; FOURHRS) ? sa : null;</span>
		}

<span class="nc" id="L1020">		return rtnSa;</span>
	}

	protected static ShiftAssignment getClosestShiftToRibbonDrag(List&lt;ShiftAssignment&gt; shiftAssignments,
			Date ribbonStartDate, Date ribbonEndDate) throws Exception {
<span class="nc" id="L1025">		ShiftAssignment sa1 = shiftAssignments.get(0);</span>
<span class="nc" id="L1026">		ShiftAssignment sa2 = shiftAssignments.get(1);</span>
<span class="nc bnc" id="L1027" title="All 2 branches missed.">		if (sa1 == null) {</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">			return sa2 != null ? sa2 : null;</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">		} else if (sa2 == null) {</span>
<span class="nc" id="L1030">			return sa1;</span>
		}
<span class="nc" id="L1032">		Date sa1StartTime = sa1.getStartTime();</span>
<span class="nc" id="L1033">		Date sa2StartTime = sa2.getStartTime();</span>
<span class="nc" id="L1034">		ShiftAssignment firstShift = sa1;</span>
<span class="nc" id="L1035">		ShiftAssignment secondShift = sa2;</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">		if (sa2StartTime.before(sa1StartTime)) {</span>
<span class="nc" id="L1037">			firstShift = sa2;</span>
<span class="nc" id="L1038">			secondShift = sa1;</span>
		}

<span class="nc" id="L1041">		long ONEDAY = 1000 * 60 * 60 * 24;</span>
<span class="nc" id="L1042">		long msFromSa1ToStartOfRibbon = ONEDAY;</span>
<span class="nc" id="L1043">		long msFromSa2ToEndOfRibbon = ONEDAY;</span>
<span class="nc bnc" id="L1044" title="All 4 branches missed.">		if (!ribbonStartDate.after(firstShift.getEndTime()) &amp;&amp; !ribbonEndDate.before(secondShift.getStartTime())) {</span>
			// ribbon overlaps and/or adjoins both shifts
<span class="nc" id="L1046">			throw new RmBaseException(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.CSR_ERROR_RIBBON_OVERLAPS_BOTH_SHIFTS, null);</span>
		}
<span class="nc bnc" id="L1048" title="All 2 branches missed.">		if (ribbonStartDate.before(firstShift.getEndTime())) {</span>
			// start of mouse drag overlaps with the first shift. Use it.
<span class="nc" id="L1050">			msFromSa1ToStartOfRibbon = -1;</span>
		} else {
<span class="nc" id="L1052">	    	msFromSa1ToStartOfRibbon = ribbonStartDate.getTime() - firstShift.getEndTime().getTime();</span>
		}
<span class="nc bnc" id="L1054" title="All 2 branches missed.">		if (ribbonEndDate.after(secondShift.getStartTime())) {</span>
			// end of mouse drag overlaps with the second shift. Use it.
<span class="nc" id="L1056">			msFromSa2ToEndOfRibbon = -1;</span>
		} else {
<span class="nc" id="L1058">			msFromSa2ToEndOfRibbon = secondShift.getStartTime().getTime() - ribbonEndDate.getTime();</span>
		}
<span class="nc" id="L1060">		long shortestDistance = Math.min(msFromSa1ToStartOfRibbon, msFromSa2ToEndOfRibbon);</span>
		// if shifts are equidistant, return sa2, otherwise return closest shift
<span class="nc bnc" id="L1062" title="All 2 branches missed.">		return (shortestDistance == msFromSa2ToEndOfRibbon) ? secondShift : firstShift;</span>
	}

	public static TimeRange getMainShiftTimeRange(ShiftAssignment sa, TimeZone tz) {
<span class="nc bnc" id="L1066" title="All 2 branches missed.">		if (sa != null) {</span>
			// Get the main shift start time (excluding the gap before shift)
<span class="nc" id="L1068">			Calendar cal = Calendar.getInstance(tz);</span>
<span class="nc" id="L1069">			cal.setTime(sa.getStartTime());</span>
<span class="nc" id="L1070">			cal.add(Calendar.MINUTE, sa.getExtensionBefore());</span>
<span class="nc" id="L1071">			Date mainShiftStartTime = cal.getTime();</span>

			// Get the main shift end time (excluding the gap after shift)
<span class="nc" id="L1074">			cal.setTime(sa.getEndTime());</span>
<span class="nc" id="L1075">			cal.add(Calendar.MINUTE, -sa.getExtensionAfter());</span>
<span class="nc" id="L1076">			Date mainShiftEndTime = cal.getTime();</span>

<span class="nc" id="L1078">			return new TimeRange(mainShiftStartTime, mainShiftEndTime);</span>
		}

<span class="nc" id="L1081">		return null;</span>
	}

	/**
	 * Add the scheduled ShiftAssignment to the CSDetailData.
	 */
	private static void addShiftAssignmentToCSDetailData(CSDetailData data, ShiftAssignment sa, // Collection
																								// scheduleEvents,
			RequestContext context, ResourceBundle bundle, TimeZone tz) throws Exception {
		// Note: It's possible that the employee's ShiftAssignment specifies a
		// Shift,
		// Activity, extension, etc., that isn't found in any of his work
		// patterns on that date.
		// This could be due to a &quot;&lt;custom shift&gt;&quot; assignment, or a change in
		// work pattern definition
		// after the schedule was created.
		// Either way, we still need to get these objects and add them to the
		// lists.
		// ShiftAssignment sa = getShiftAssignment(scheduleEvents);
<span class="nc bnc" id="L1100" title="All 2 branches missed.">		if (sa != null) {</span>
<span class="nc" id="L1101">			addShiftAssignmentObjectsToCSDetailData(sa, data, context, bundle, tz);</span>
<span class="nc" id="L1102">			clearInvalidExtensions(data);</span>
		}
<span class="nc" id="L1104">	}</span>

	private static boolean verifyForMedia(Collection activitiesWithMedia, ID activityID) throws Exception {
<span class="nc bnc" id="L1107" title="All 2 branches missed.">		for (Iterator iterator = activitiesWithMedia.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L1108">	        ID actID = (ID) iterator.next();</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">	        if(actID.equals(activityID)) {</span>
<span class="nc" id="L1110">	        	return true;</span>
	        }
<span class="nc" id="L1112">	    }</span>
<span class="nc" id="L1113">		return false;</span>
	}

	/**
	 * Get the ShiftAssignment, Shift, Activity, extBefore, extBeforeActivity,
	 * extAfter, extAfterActivity from the currently scheduled ShiftAssignment
	 * (if any) and add them to our sets.
	 *
	 * @param data
	 */
	private static void addShiftAssignmentObjectsToCSDetailData(ShiftAssignment shiftAssignment, CSDetailData data,
			RequestContext context, ResourceBundle bundle, TimeZone tz) throws Exception {
<span class="nc" id="L1125">		WorkRuleManager workRuleManager = WfmManagerFactory.getWorkRuleManager(context.isInWhatIfMode());</span>

<span class="nc" id="L1127">		data._shiftAssignment = shiftAssignment;</span>
<span class="nc" id="L1128">		ID shiftID = data._shiftAssignment.getShiftID();</span>
<span class="nc" id="L1129">		ID mainActivityID = data._shiftAssignment.getActivityID();</span>
<span class="nc" id="L1130">		ID extBeforeID = data._shiftAssignment.getOTExtensionBeforeID();</span>
<span class="nc" id="L1131">		ID extBeforeActivityID = data._shiftAssignment.getOTExtensionBeforeActivityID();</span>
<span class="nc" id="L1132">		ID extAfterID = data._shiftAssignment.getOTExtensionAfterID();</span>
<span class="nc" id="L1133">		ID extAfterActivityID = data._shiftAssignment.getOTExtensionAfterActivityID();</span>
<span class="nc" id="L1134">		Collection&lt;ID&gt; mainActivityIdsToGet = new ArrayList&lt;ID&gt;();</span>

<span class="nc" id="L1136">		Collection&lt;ShiftEventAssignment&gt; shiftAssignmentList = data._shiftAssignment.getChildren();</span>
<span class="nc" id="L1137">		Collection activitiesWithMedia = ActivityModelHandler.getActivitiesWithMedia(context);</span>
		// Scenario where a shift comprises multiple shift events and each shift event can have a diff activity associated
<span class="nc bnc" id="L1139" title="All 2 branches missed.">			for(ShiftEventAssignment seAssignment: shiftAssignmentList) {</span>
<span class="nc" id="L1140">				ID curActivityID = seAssignment.getActivityID();</span>
<span class="nc bnc" id="L1141" title="All 4 branches missed.">				if (curActivityID != null &amp;&amp; verifyForMedia(activitiesWithMedia, curActivityID)) {</span>
<span class="nc" id="L1142">					mainActivityIdsToGet.add(curActivityID);</span>
				}
<span class="nc" id="L1144">			}</span>

<span class="nc bnc" id="L1146" title="All 2 branches missed.">		if (shiftID != null) {</span>
<span class="nc" id="L1147">			Shift shift = workRuleManager.getShift(shiftID);</span>
			// must check activityID for null to exclude the &quot;Possible Days Off&quot; shift
<span class="nc bnc" id="L1149" title="All 4 branches missed.">			if (shift != null &amp;&amp; shift.getActivityID() != null) {</span>
<span class="nc" id="L1150">				data._shifts.add(shift);</span>
			}
<span class="nc" id="L1152">		} else {</span>
			// Special case: there is a ShiftAssignment with no ShiftID. This
			// must be a &quot;&lt;custom shift&gt;&quot;,
			// so we should add a custom shift to the list.
<span class="nc" id="L1156">			Shift shift = new Shift();</span>
<span class="nc" id="L1157">			shift.setID(CustomShiftRequestFormPopupPM.CUSTOM_ID);</span>
<span class="nc" id="L1158">			shift.setName(&quot;&amp;lt;&quot; + context.getLocalizer().i18n(bundle, RmWebBundleKey.CSR_CUSTOM_SHIFT) + &quot;&amp;gt;&quot;);</span>
<span class="nc" id="L1159">			shift.setActivityID(mainActivityID);</span>
<span class="nc" id="L1160">			data._shifts.add(shift);</span>
		}

<span class="nc bnc" id="L1163" title="All 2 branches missed.">		if (mainActivityID != null) {</span>
<span class="nc" id="L1164">			mainActivityIdsToGet.add(mainActivityID);</span>
		}
<span class="nc" id="L1166">		getActivityObjectsFromIdsAndAddToData(data, context, mainActivityIdsToGet);</span>

<span class="nc bnc" id="L1168" title="All 2 branches missed.">		if (extBeforeID != null) {</span>
<span class="nc" id="L1169">			Collection&lt;ShiftOTExtension&gt; exts = workRuleManager.getShiftOTExtensionsByIDs(Collections.singletonList(extBeforeID));</span>
<span class="nc bnc" id="L1170" title="All 4 branches missed.">			if (exts != null &amp;&amp; exts.size() &gt; 0) {</span>
<span class="nc" id="L1171">				data._extBeforeTypes.addAll(exts);</span>
			}
		}

<span class="nc bnc" id="L1175" title="All 2 branches missed.">		if (extBeforeActivityID != null) {</span>
<span class="nc" id="L1176">			Activity activity = ActivityModelHandler.getActivityByID(context, extBeforeActivityID);</span>
<span class="nc bnc" id="L1177" title="All 2 branches missed.">			if (activity != null) {</span>
<span class="nc" id="L1178">				data._extBeforeActivities.add(activity);</span>
			}

<span class="nc bnc" id="L1181" title="All 4 branches missed.">			if (extBeforeID == null &amp;&amp; data._shiftAssignment.getExtensionBefore() &gt; 0) {</span>
				// Special case: there is a extension assignment with no
				// extBeforeID. This must be a &quot;&lt;Custom Extension&gt;&quot;,
				// so we should add a custom extension to the list.
<span class="nc" id="L1185">				ShiftOTExtension ext = new ShiftOTExtension();</span>
<span class="nc" id="L1186">				ext.setID(CustomShiftRequestFormPopupPM.CUSTOM_ID);</span>
<span class="nc" id="L1187">				ext.setName(&quot;&amp;lt;&quot; + context.getLocalizer().i18n(bundle, RmWebBundleKey.CSR_CUSTOM_EXTENSION) + &quot;&amp;gt;&quot;);</span>
<span class="nc" id="L1188">				ext.setActivityID(extBeforeActivityID);</span>
<span class="nc" id="L1189">				data._extBeforeTypes.add(ext);</span>
			}
		}

<span class="nc bnc" id="L1193" title="All 2 branches missed.">		if (extAfterID != null) {</span>
<span class="nc" id="L1194">			Collection&lt;ShiftOTExtension&gt; exts = workRuleManager.getShiftOTExtensionsByIDs(Collections.singletonList(extAfterID));</span>
<span class="nc bnc" id="L1195" title="All 4 branches missed.">			if (exts != null &amp;&amp; exts.size() &gt; 0) {</span>
<span class="nc" id="L1196">				data._extAfterTypes.addAll(exts);</span>
			}
		}

<span class="nc bnc" id="L1200" title="All 2 branches missed.">		if (extAfterActivityID != null) {</span>
<span class="nc" id="L1201">			Activity activity = ActivityModelHandler.getActivityByID(context, extAfterActivityID);</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">			if (activity != null) {</span>
<span class="nc" id="L1203">				data._extAfterActivities.add(activity);</span>
			}

<span class="nc bnc" id="L1206" title="All 4 branches missed.">			if (extAfterID == null &amp;&amp; data._shiftAssignment.getExtensionAfter() &gt; 0) {</span>
				// Special case: there is a extension assignment with no
				// extAfterID. This must be a &quot;&lt;Custom Extension&gt;&quot;,
				// so we should add a custom extension to the list.
<span class="nc" id="L1210">				ShiftOTExtension ext = new ShiftOTExtension();</span>
<span class="nc" id="L1211">				ext.setID(CustomShiftRequestFormPopupPM.CUSTOM_ID);</span>
<span class="nc" id="L1212">				ext.setName(&quot;&amp;lt;&quot; + context.getLocalizer().i18n(bundle, RmWebBundleKey.CSR_CUSTOM_EXTENSION) + &quot;&amp;gt;&quot;);</span>
<span class="nc" id="L1213">				ext.setActivityID(extAfterActivityID);</span>
<span class="nc" id="L1214">				data._extAfterTypes.add(ext);</span>
			}
		}

<span class="nc" id="L1218">		TimeRange mainShiftTimeRange = getMainShiftTimeRange(data._shiftAssignment, tz);</span>
<span class="nc" id="L1219">		data._mainShiftStartTime = mainShiftTimeRange.getStartDate();</span>
<span class="nc" id="L1220">		data._mainShiftEndTime = mainShiftTimeRange.getEndDate();</span>
<span class="nc" id="L1221">	}</span>

	/**
	 * For some reason, it's possible to have a shift assignment that has an
	 * extension activity with no duration. In this case, we will clear out the
	 * extension and activity to prevent validation errors when the user tries
	 * to save a Shift Change request.
	 */
	private static void clearInvalidExtensions(CSDetailData data) throws Exception {
<span class="nc" id="L1230">		ShiftAssignment sa = data._shiftAssignment;</span>

<span class="nc bnc" id="L1232" title="All 4 branches missed.">		if (sa.getOTExtensionBeforeActivityID() == null || sa.getExtensionBefore() == 0) {</span>
<span class="nc" id="L1233">			sa.setOTExtensionBeforeID(null);</span>
<span class="nc" id="L1234">			sa.setOTExtensionBeforeActivityID(null);</span>
<span class="nc" id="L1235">			sa.setExtensionBefore(0);</span>
		}

<span class="nc bnc" id="L1238" title="All 4 branches missed.">		if (sa.getOTExtensionAfterActivityID() == null || sa.getExtensionAfter() == 0) {</span>
<span class="nc" id="L1239">			sa.setOTExtensionAfterID(null);</span>
<span class="nc" id="L1240">			sa.setOTExtensionAfterActivityID(null);</span>
<span class="nc" id="L1241">			sa.setExtensionAfter(0);</span>
		}
<span class="nc" id="L1243">	}</span>

	/**
	 * After having computed the _mainShiftStartTime and _mainShiftEndTime, we
	 * can use it to determine the gap durations, and add the gap durations to
	 * the CSDetailData.
	 */
	private static void addGapDurationsToCSDetailData(CSDetailData data, Collection scheduleEvents) {
<span class="nc bnc" id="L1251" title="All 2 branches missed.">		if (data._shiftAssignment != null) {</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">			boolean hasExtBefore = (data._shiftAssignment.getExtensionBefore() &gt; 0);</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">			boolean hasExtAfter = (data._shiftAssignment.getExtensionAfter() &gt; 0);</span>

<span class="nc bnc" id="L1255" title="All 4 branches missed.">			if (hasExtBefore || hasExtAfter) {</span>
<span class="nc" id="L1256">				Date earliestGapAfterDate = null; // the earliest found Gap that</span>
													// occurs after the shift is
													// the &quot;After Shift&quot; Gap
													// that we want.
<span class="nc" id="L1260">				Date latestGapBeforeDate = null; // the latest found Gap that</span>
													// occurs before the shift
													// is the &quot;Before Shift&quot; Gap
													// that we want.

<span class="nc" id="L1265">				scheduleEvents = EventUtils.convertEventsToTimelineForSingleEmployee(scheduleEvents); // flatten</span>
																										// the
																										// schedule
																										// events

<span class="nc bnc" id="L1270" title="All 2 branches missed.">				for (Iterator it = scheduleEvents.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1271">					Object obj = it.next();</span>
<span class="nc bnc" id="L1272" title="All 4 branches missed.">					if (obj != null &amp;&amp; obj instanceof SimpleEvent) {</span>
<span class="nc" id="L1273">						SimpleEvent event = (SimpleEvent) obj;</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">						if (event.getActivityID().equals(Activity.ACTIVITY_SHIFT_OVERTIME_GAP)) {</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">							if (event.getStartTime().after(data._mainShiftStartTime)) {</span>
								// This can only be an &quot;After Shift&quot; Gap, but we
								// must exclude any Gaps that are for the next
								// day's shift.
<span class="nc bnc" id="L1279" title="All 2 branches missed.">								if (hasExtAfter) {</span>
<span class="nc bnc" id="L1280" title="All 2 branches missed.">									if ((earliestGapAfterDate == null)</span>
<span class="nc bnc" id="L1281" title="All 2 branches missed.">											|| (event.getStartTime().before(earliestGapAfterDate))) {</span>
<span class="nc" id="L1282">										earliestGapAfterDate = event.getStartTime();</span>
<span class="nc" id="L1283">										data._gapAfterDuration = event.getDuration();</span>
									}
								}
							} else {
								// This can only be a &quot;Before Shift&quot; Gap, but we
								// must exclude any Gaps that are for the
								// previous day's shift.
<span class="nc bnc" id="L1290" title="All 2 branches missed.">								if (hasExtBefore) {</span>
<span class="nc bnc" id="L1291" title="All 2 branches missed.">									if ((latestGapBeforeDate == null)</span>
<span class="nc bnc" id="L1292" title="All 2 branches missed.">											|| (event.getStartTime().after(latestGapBeforeDate))) {</span>
<span class="nc" id="L1293">										latestGapBeforeDate = event.getStartTime();</span>
<span class="nc" id="L1294">										data._gapBeforeDuration = event.getDuration();</span>
									}
								}
							}
						}
					}
<span class="nc" id="L1300">				}</span>
			}
		}
<span class="nc" id="L1303">	}</span>

	/**
	 * Add the &quot;&lt;None&gt;&quot; extension types and extension activities to our
	 * collections, since they should always be in the drop-downs.
	 *
	 * @param data
	 */
	private static void addNoneExtensionOptionsToCSDetailData(CSDetailData data, RequestContext context,
			ResourceBundle bundle) throws Exception {
<span class="nc" id="L1313">		String none = &quot;&amp;lt;&quot; + context.getLocalizer().i18n(bundle, RmWebBundleKey.CSR_NONE) + &quot;&amp;gt;&quot;;</span>

		// Always add &quot;&lt;None&gt;&quot; extension options, which allow user to remove
		// extensions from a request.
<span class="nc" id="L1317">		ShiftOTExtension ext = new ShiftOTExtension();</span>
<span class="nc" id="L1318">		ext.setID(CustomShiftRequestFormPopupPM.NONE_ID);</span>
<span class="nc" id="L1319">		ext.setName(none);</span>
<span class="nc" id="L1320">		data._extBeforeTypes.add(ext);</span>
<span class="nc" id="L1321">		data._extAfterTypes.add(ext);</span>

		// Always add &quot;&lt;None&gt;&quot; extension activity options.
<span class="nc" id="L1324">		Activity activity = new Activity();</span>
<span class="nc" id="L1325">		activity.setID(CustomShiftRequestFormPopupPM.NONE_ID);</span>
<span class="nc" id="L1326">		activity.setName(none);</span>
<span class="nc" id="L1327">		data._extBeforeActivities.add(activity);</span>
<span class="nc" id="L1328">		data._extAfterActivities.add(activity);</span>
<span class="nc" id="L1329">	}</span>

	/**
	 * Returns a map of all OT Extensions belonging to the selected shift
	 * patterns.
	 *
	 * @return
	 */
	private static HashMap&lt;ShiftOTExtension, Set&lt;ShiftPattern.StartTime&gt;&gt; getOTExtensionsFromSelectedShiftPatterns(
			Collection&lt;ShiftPattern&gt; shiftPatterns, Date asOfDate) {
<span class="nc" id="L1339">		HashMap&lt;ShiftOTExtension, Set&lt;ShiftPattern.StartTime&gt;&gt; retVal = new HashMap&lt;ShiftOTExtension, Set&lt;ShiftPattern.StartTime&gt;&gt;();</span>
<span class="nc" id="L1340">		HashMap&lt;ShiftOTExtension, HashSet&lt;ShiftPattern&gt;&gt; otExtensionAssignments = new HashMap&lt;ShiftOTExtension, HashSet&lt;ShiftPattern&gt;&gt;();</span>
<span class="nc bnc" id="L1341" title="All 2 branches missed.">		for (ShiftPattern sp : shiftPatterns) {</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">			for (ShiftOTExtension sote : sp.getOTExtensionStartTimes().keySet()) {</span>
				// Filter out objects that have been deleted in the past
<span class="nc bnc" id="L1344" title="All 4 branches missed.">				if (sote.getDeleteOnDate() != null &amp;&amp; sote.getDeleteOnDate().before(asOfDate)) {</span>
<span class="nc" id="L1345">					continue;</span>
				}

<span class="nc" id="L1348">				Set&lt;ShiftPattern.StartTime&gt; startTimes = retVal.get(sote);</span>
<span class="nc bnc" id="L1349" title="All 2 branches missed.">				if (startTimes == null) {</span>
<span class="nc" id="L1350">					startTimes = new HashSet&lt;ShiftPattern.StartTime&gt;();</span>
<span class="nc" id="L1351">					retVal.put(sote, startTimes);</span>
				}

<span class="nc" id="L1354">				startTimes.add(sp.getOTExtensionStartTime(sote));</span>
<span class="nc" id="L1355">				HashSet&lt;ShiftPattern&gt; col = otExtensionAssignments.get(sote);</span>
<span class="nc bnc" id="L1356" title="All 2 branches missed.">				if (col == null) {</span>
<span class="nc" id="L1357">					col = new HashSet&lt;ShiftPattern&gt;();</span>
<span class="nc" id="L1358">					otExtensionAssignments.put(sote, col);</span>
				}
<span class="nc" id="L1360">				col.add(sp);</span>
<span class="nc" id="L1361">			}</span>
<span class="nc" id="L1362">		}</span>

<span class="nc" id="L1364">		return retVal;</span>
	}

	public static Pair acceptWithdrawOfApprovedRequest(RequestContext context, ID requestID, String comment)
			throws Exception {
<span class="nc" id="L1369">		CustShiftReq request = getCSRequest(requestID);</span>

<span class="nc" id="L1371">		Pair pair = new Pair(new Boolean(&quot;true&quot;), null);</span>
		// Pair pair =
		// getCSRequestManager().isEligibleForRequestWithdrawOfApprovedRequest(request);

<span class="nc bnc" id="L1375" title="All 2 branches missed.">		if (((Boolean) pair.getFirst()).booleanValue()) {</span>
<span class="nc" id="L1376">			getCSRequestManager().acceptWithdrawOfApprovedRequest(request, comment);</span>
		}
<span class="nc" id="L1378">		return pair;</span>
	}

	public static void rejectWithdrawOfApprovedRequest(RequestContext context, ID requestID, String comment)
			throws Exception {
<span class="nc" id="L1383">		getCSRequestManager().rejectWithdrawOfApprovedRequest(getCSRequest(requestID), comment);</span>
<span class="nc" id="L1384">	}</span>

	public static Pair cancelWithdrawOfApprovedRequest(RequestContext context, ID requestID, String comment)
			throws Exception {
<span class="nc" id="L1388">		CustShiftReq request = getCSRequest(requestID);</span>
<span class="nc" id="L1389">		Pair pair = new Pair(new Boolean(&quot;true&quot;), null);</span>
		// Pair pair =
		// getCSRequestManager().isEligibleForRequestWithdrawOfApprovedRequest(request);

<span class="nc bnc" id="L1393" title="All 2 branches missed.">		if (((Boolean) pair.getFirst()).booleanValue()) {</span>
<span class="nc" id="L1394">			getCSRequestManager().cancelWithdrawOfApprovedRequest(request, comment);</span>
		}
<span class="nc" id="L1396">		return pair;</span>
	}

	public static Pair&lt;Boolean, String&gt; requestWithdrawOfApprovedRequest(ID requestID, String requestType, String requestVersion,
			String requestStatus, String comment) throws Exception {
<span class="nc" id="L1401">		Pair&lt;Boolean, String&gt; pair = new Pair&lt;Boolean, String&gt;(new Boolean(&quot;true&quot;), &quot;&quot;);</span>
<span class="nc" id="L1402">		CustShiftReq request = getCSRequest(requestID);</span>

		// if request is approved then invoke the approved TO Withdraw process
<span class="nc bnc" id="L1405" title="All 2 branches missed.">		if (request.getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
			// pair =
			// getCSRequestManager().isEligibleForRequestWithdrawOfApprovedRequest(request);
<span class="nc bnc" id="L1408" title="All 2 branches missed.">			if ((pair.getFirst()).booleanValue()) {</span>
<span class="nc" id="L1409">				getCSRequestManager().requestWithdrawOfApprovedRequest(request, comment);</span>
			}
		} else {
<span class="nc" id="L1412">			RequestsMH.changeRequestStatus(requestID, requestType, requestVersion, requestStatus, comment);</span>
		}
<span class="nc" id="L1414">		return pair;</span>
	}

	/*****************************************************************************
	 * Inner Classes used to package data for the Custom Shift Request dailog
	 ****************************************************************************/

	/**
	 * This class stores data for the Custom Shift Request dialog.
	 */
	public static class CSDetailData {
		private final ID _empID;
		private final CustShiftReq _csRequest;
		private final OrganizationSetting _orgSetting;
<span class="nc" id="L1428">		private Collection _empNameList = Collections.EMPTY_LIST;</span>
<span class="nc" id="L1429">		private ShiftAssignment _shiftAssignment = null;</span>
<span class="nc" id="L1430">		private int _gapBeforeDuration = 0;</span>
<span class="nc" id="L1431">		private int _gapAfterDuration = 0;</span>
		private Date _mainShiftStartTime; // the main shift start time
											// (excluding the gap before shift)
		private Date _mainShiftEndTime; // the main shift end time (excluding
										// the gap after shift)
		// private Date _completeShiftStartTime; //the complete shift start time
		// (including the gap before shift)
		// private Date _completeShiftEndTime; //the complete shift end time
		// (including the gap after shift)
		private ID _spID; // the employee's scheduling period ID (if any) on the
							// selected day
		private Map&lt;ID,Pair&lt;Date,Date&gt;&gt; spIDMap;
<span class="nc" id="L1443">		private Collection&lt;Shift&gt; _shifts = null;</span>
<span class="nc" id="L1444">		private Collection&lt;Activity&gt; _activities = null;</span>
<span class="nc" id="L1445">		private Collection&lt;ShiftOTExtension&gt; _extBeforeTypes = null;</span>
<span class="nc" id="L1446">		private Collection&lt;Activity&gt; _extBeforeActivities = null;</span>
<span class="nc" id="L1447">		private Collection&lt;ShiftOTExtension&gt; _extAfterTypes = null;</span>
<span class="nc" id="L1448">		private Collection&lt;Activity&gt; _extAfterActivities = null;</span>

		/**
		 * If we came from the Net Staffing Ribbon, then this will store the
		 * activity with the lowest Net Staffing value during the ribbon
		 * selection time range. If the ribbon selection includes time before
		 * the scheduled shift and time after, then this is the deficient
		 * activity for the selected time before the shift only.
		 */
<span class="nc" id="L1457">		private Activity _mostDeficientActivity1 = null;</span>

		/**
		 * If we came from the Net Staffing Ribbon, then this will store the
		 * activity with the lowest Net Staffing value during the ribbon
		 * selection time range. If the ribbon selection includes time before
		 * the scheduled shift and time after, then this is the deficient
		 * activity for the selected time after the shift only.
		 */
<span class="nc" id="L1466">		private Activity _mostDeficientActivity2 = null;</span>

<span class="nc" id="L1468">		public CSDetailData(ID empID, CustShiftReq request, OrganizationSetting orgSetting, Collection empNameList) {</span>
<span class="nc" id="L1469">			_empID = empID;</span>
<span class="nc" id="L1470">			_csRequest = request;</span>
<span class="nc" id="L1471">			_orgSetting = orgSetting;</span>
<span class="nc" id="L1472">			_empNameList = empNameList;</span>
<span class="nc" id="L1473">		}</span>

		public ID getEmpID() {
<span class="nc" id="L1476">			return _empID;</span>
		}

		public CustShiftReq getCSRequest() {
<span class="nc" id="L1480">			return _csRequest;</span>
		}

		public OrganizationSetting getOrgSetting() {
<span class="nc" id="L1484">			return _orgSetting;</span>
		}

		public Collection getEmployeeNames() {
<span class="nc" id="L1488">			return _empNameList;</span>
		}

		public ShiftAssignment getShiftAssignment() {
<span class="nc" id="L1492">			return _shiftAssignment;</span>
		}

		public int getGapBeforeDuration() {
<span class="nc" id="L1496">			return _gapBeforeDuration;</span>
		}

		public int getGapAfterDuration() {
<span class="nc" id="L1500">			return _gapAfterDuration;</span>
		}

		public Date getMainShiftStartTime() {
<span class="nc" id="L1504">			return _mainShiftStartTime;</span>
		}

		public Date getMainShiftEndTime() {
<span class="nc" id="L1508">			return _mainShiftEndTime;</span>
		}

		// public Date getCompleteShiftStartTime() { return
		// _completeShiftStartTime; }
		// public Date getCompleteShiftEndTime() { return _completeShiftEndTime;
		// }
		public ID getSPID() {
<span class="nc" id="L1516">			return _spID;</span>
		}

		/**
		 * Its usefull when the Shift Request change is spanning across multiple SP's
		 * @return Map of SP ID and its start-end date pair
		 */
<span class="nc" id="L1523">		public Map&lt;ID,Pair&lt;Date,Date&gt;&gt; getSPIDMap() { return spIDMap; }</span>
		
		public Collection&lt;Shift&gt; getShifts() {
<span class="nc" id="L1526">			return _shifts;</span>
		}

		public Collection&lt;Activity&gt; getActivities() {
<span class="nc" id="L1530">			return _activities;</span>
		}

		public Collection&lt;ShiftOTExtension&gt; getExtBeforeTypes() {
<span class="nc" id="L1534">			return _extBeforeTypes;</span>
		}

		public Collection&lt;Activity&gt; getExtBeforeActivities() {
<span class="nc" id="L1538">			return _extBeforeActivities;</span>
		}

		public Collection&lt;ShiftOTExtension&gt; getExtAfterTypes() {
<span class="nc" id="L1542">			return _extAfterTypes;</span>
		}

		public Collection&lt;Activity&gt; getExtAfterActivities() {
<span class="nc" id="L1546">			return _extAfterActivities;</span>
		}

		public Activity getMostDeficientActivity1() {
<span class="nc" id="L1550">			return _mostDeficientActivity1;</span>
		}

		public Activity getMostDeficientActivity2() {
<span class="nc" id="L1554">			return _mostDeficientActivity2;</span>
		}
	}

	/**
	 * This class stores data for the Custom Shift View Details dialog.
	 */
<span class="nc" id="L1561">	public static class CSObjectData {</span>
		private Shift _shift;
		private Activity _activity;
		private ShiftOTExtension _extBeforeType;
		private Activity _extBeforeActivity;
		private ShiftOTExtension _extAfterType;
		private Activity _extAfterActivity;

<span class="nc" id="L1569">		public CSObjectData() {</span>
<span class="nc" id="L1570">		}</span>

		public Shift getShift() {
<span class="nc" id="L1573">			return _shift;</span>
		}

		public Activity getActivity() {
<span class="nc" id="L1577">			return _activity;</span>
		}

		public ShiftOTExtension getExtBeforeType() {
<span class="nc" id="L1581">			return _extBeforeType;</span>
		}

		public Activity getExtBeforeActivity() {
<span class="nc" id="L1585">			return _extBeforeActivity;</span>
		}

		public ShiftOTExtension getExtAfterType() {
<span class="nc" id="L1589">			return _extAfterType;</span>
		}

		public Activity getExtAfterActivity() {
<span class="nc" id="L1593">			return _extAfterActivity;</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>