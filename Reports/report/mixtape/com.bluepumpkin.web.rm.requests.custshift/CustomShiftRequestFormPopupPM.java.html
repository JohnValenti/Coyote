<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CustomShiftRequestFormPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.custshift</a> &gt; <span class="el_source">CustomShiftRequestFormPopupPM.java</span></div><h1>CustomShiftRequestFormPopupPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.custshift;

import java.util.*;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.util.PersonNameUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftOTExtension;
import com.bluepumpkin.ejb.rm.base.RmBaseException;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.custshift.model.CustShiftReq;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.keys.RmJavaScriptFileID;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestFormPopupPM;
import com.bluepumpkin.web.rm.requests.RequestUtil;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.container.Collapsible2ColFormPC;
import com.witness.web.uif.pagecomponent.container.MultiColCollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.message.MessagePC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.DurationSpinnerPC;
import com.witness.web.uif.pagecomponent.picker.time.TimePickerPC;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title: CustomShiftRequestFormPopupPM Description: Custom Shift Request Form
 * allows user to request a New Shift or a Shift Change. Copyright: Copyright
 * (c) 2011 Company: Verint Systems, Inc.
 *
 * @author Gonzalo Quintanar
 */

public class CustomShiftRequestFormPopupPM extends RequestFormPopupPM implements ContainersInRowsPM {
	private static final int TIME_INTERVAL = 15;

	// field name constants
	private static final String REQUESTED_FOR_FN = &quot;requestedFor&quot;;
	private static final String REQUEST_STATUS_FN = &quot;requestStatus&quot;;
	private static final String RELOAD_ACTION_FN = &quot;reloadAction&quot;;
	private static final String REQUEST_SUB_TYPE = &quot;requestSubType&quot;;

	private static final String SHIFT_START_DATE = &quot;shiftStartDate&quot;;
	private static final String SHIFT_START_TIME = &quot;shiftStartTime&quot;;
	private static final String SHIFTID = &quot;shiftID&quot;;
	private static final String ACTIVITYID = &quot;activityID&quot;;
	private static final String OVERTIME = &quot;overtime&quot;;
	private static final String EXT_BEFORE_ID = &quot;extBeforeID&quot;;
	private static final String EXT_BEFORE_ACTIVITY_ID = &quot;extBeforeActivityID&quot;;
	private static final String EXT_BEFORE_DURATION = &quot;extBeforeDuration&quot;;
	private static final String EXT_BEFORE_GAP = &quot;extBeforeGap&quot;;
	private static final String EXT_BEFORE_OVERTIME = &quot;extBeforeOvertime&quot;;
	private static final String EXT_AFTER_ID = &quot;extAfterID&quot;;
	private static final String EXT_AFTER_ACTIVITY_ID = &quot;extAfterActivityID&quot;;
	private static final String EXT_AFTER_DURATION = &quot;extAfterDuration&quot;;
	private static final String EXT_AFTER_GAP = &quot;extAfterGap&quot;;
	private static final String EXT_AFTER_OVERTIME = &quot;extAfterOvertime&quot;;

	// field value constants

	// indicates form was refreshed due to a date change
	public static final String RELOAD_ACTION_DATE = &quot;DATE&quot;;

	// indicates form was refreshed due to a time change
	public static final String RELOAD_ACTION_TIME = &quot;TIME&quot;;

	// indicates form was refreshed due to an employee selection change
	public static final String RELOAD_ACTION_EMPLOYEE = &quot;EMPLOYEE&quot;;

	// indicates form was refreshed due to a shift selection change
	public static final String RELOAD_ACTION_SHIFT = &quot;SHIFT&quot;;

	// indicates form was refreshed due to an Extension Before Type selection
	// change
	public static final String RELOAD_ACTION_EXT_BEFORE = &quot;EXT_BEFORE&quot;;

	// indicates form was refreshed due to an Extension After Type selection
	// change
	public static final String RELOAD_ACTION_EXT_AFTER = &quot;EXT_AFTER&quot;;

	// could be a validation error, or the request was saved successfully
	public static final String RELOAD_ACTION_SAVE = &quot;SAVE&quot;;

	// indicates form has just loaded due to a user selection in the Net
	// Staffing ribbon (schedule page).
	public static final String RELOAD_ACTION_RIBBON = &quot;RIBBON&quot;;

	// indicates form has just loaded due to editing/creating new request from
	// My Requests/Agent Requests page.
	public static final String RELOAD_ACTION_NONE = &quot;&quot;;

	// JavaScript Constants
	private static final String JS_FUNC_RELOAD_WITH_ACTION = &quot;reloadWithAction&quot;;
	private static final String JS_FUNC_TOGGLE_SHIFT_OT = &quot;toggleShiftOTCheckbox(this); &quot; + JSUtil.ON_CHANGE;

	// Other constants
<span class="fc" id="L120">	public static final ID CUSTOM_ID = new ID(-1);</span>
<span class="fc" id="L121">	public static final ID NONE_ID = new ID(-2);</span>
	private static final int NO_MINUTES_IN_HOUR = 60;

	// Member variables
	protected CustShiftReq m_customShiftRequest;
<span class="nc" id="L126">	private Collection m_empNames = Collections.EMPTY_LIST;</span>

	// When the form reloads due to a user change in date, time, etc, we store
	// the type here (Ex: &quot;DATE&quot;, &quot;TIME&quot;).
<span class="nc" id="L130">	private String m_reloadAction = RELOAD_ACTION_NONE;</span>

	// the employee's scheduling period ID (if any) on the selected day
	protected ID m_spID;

	/**
	 * To Handle cases where the Shift Change request is overlapping multiple SP's
	 */
	private Map&lt;ID,Pair&lt;Date,Date&gt;&gt; spIDMap;

	// Request Management Settings per organization
	protected OrganizationSetting m_orgSetting;
<span class="nc" id="L142">	protected boolean m_allowNewShifts = true;</span>
<span class="nc" id="L143">	protected boolean m_allowShiftChanges = true;</span>
<span class="nc" id="L144">	protected boolean m_allowRegularShifts = true;</span>
<span class="nc" id="L145">	protected boolean m_allowOTShifts = true;</span>
<span class="nc" id="L146">	protected boolean m_allowRegularExtBeforeShifts = true;</span>
<span class="nc" id="L147">	protected boolean m_allowRegularExtAfterShifts = true;</span>
<span class="nc" id="L148">	protected boolean m_allowOTExtBeforeShifts = true;</span>
<span class="nc" id="L149">	protected boolean m_allowOTExtAfterShifts = true;</span>

	// These variables store information about the employee's scheduled shift
	// assignment (if any) on the selected day

	// the employee's scheduled shift assignment (if any) on the selected day
<span class="nc" id="L155">	protected ShiftAssignment m_shiftAssignment = null;</span>
	// the employee's scheduled main shift start time (excluding the gap before
	// shift)
	protected Date m_saMainShiftStartTime;
	// the employee's scheduled main shift end time (excluding the gap after
	// shift)
	protected Date m_saMainShiftEndTime;
	// the employee's scheduled OT Before gap duration (if any) on the selected
	// day
<span class="nc" id="L164">	protected int m_saGapBeforeDuration = 0;</span>
	// the employee's scheduled OT After gap duration (if any) on the selected
	// day
<span class="nc" id="L167">	protected int m_saGapAfterDuration = 0;</span>

	// These variables will be used to populate the dropdown selectors on the
	// form
<span class="nc" id="L171">	protected List&lt;Shift&gt; m_shifts = Collections.emptyList();</span>
<span class="nc" id="L172">	protected List&lt;Activity&gt; m_activities = Collections.emptyList();</span>
<span class="nc" id="L173">	protected List&lt;ShiftOTExtension&gt; m_extBeforeTypes = Collections.emptyList();</span>
<span class="nc" id="L174">	protected List&lt;Activity&gt; m_extBeforeActivities = Collections.emptyList();</span>
<span class="nc" id="L175">	protected List&lt;ShiftOTExtension&gt; m_extAfterTypes = Collections.emptyList();</span>
<span class="nc" id="L176">	protected List&lt;Activity&gt; m_extAfterActivities = Collections.emptyList();</span>

	// these variables will be used to store the details of the form's current
	// selections
<span class="nc" id="L180">	protected Shift m_shift = null;</span>
<span class="nc" id="L181">	private ShiftOTExtension m_extBeforeType = null;</span>
<span class="nc" id="L182">	private ShiftOTExtension m_extAfterType = null;</span>

	// variables for the duration spinners
	DurationSpinnerPC gapBeforeDurationPC;
	DurationSpinnerPC gapAfterDurationPC;

	// These variables store whether or not the user expanded/collapsed the four
	// collapsible containers in the dialog.
	// If null, that means we will determine the appropriate state ourselves. If
	// not null, we will keep the user's states.
<span class="nc" id="L192">	private String m_shiftSectionCollapsed = null;</span>
<span class="nc" id="L193">	private String m_extBeforeSectionCollapsed = null;</span>
<span class="nc" id="L194">	private String m_extAfterSectionCollapsed = null;</span>
<span class="nc" id="L195">	private String m_alertsSectionCollapsed = null;</span>

	// Container Page Components
	private final ContainerList m_containerList;
	private Collapsible2ColFormPC m_shiftContainerPC;

	private Collapsible2ColFormPC m_extBeforeContainerPC;
	private Collapsible2ColFormPC m_extAfterContainerPC;

	// Page Components
	protected DatePickerPC m_datePickerPC;
	protected TimePickerPC m_timePickerPC;

<span class="nc" id="L208">	private boolean m_isAuthorized = true;</span>
<span class="nc" id="L209">	private boolean m_isRequestSaved = false;</span>

	// From the Net Staffing Ribbon Selection
	private Date m_ribbonStartDate;
	private Date m_ribbonEndDate;
<span class="nc" id="L214">	private boolean m_selectedDayIncludesRibbonSelection = false;</span>
<span class="nc" id="L215">	private boolean m_selectedAgentIsForRibbonSelection = false;</span>
<span class="nc" id="L216">	private ID m_origReuestedFor = null; // the agent whose net staffing ribbon</span>
	// was selected, if any.

<span class="nc" id="L219">	private boolean m_selectedDateIsForSavedRequest = false;</span>

	/**
	 * If we came from the Net Staffing Ribbon, then this will store the
	 * activity with the lowest Net Staffing value during the ribbon selection
	 * time range. If the ribbon selection includes time before the scheduled
	 * shift and time after, then this is the deficient activity for the
	 * selected time before the shift only.
	 */
<span class="nc" id="L228">	protected Activity m_mostDeficientActivity1 = null;</span>

	/**
	 * If we came from the Net Staffing Ribbon, then this will store the
	 * activity with the lowest Net Staffing value during the ribbon selection
	 * time range. If the ribbon selection includes time before the scheduled
	 * shift and time after, then this is the deficient activity for the
	 * selected time after the shift only.
	 */
<span class="nc" id="L237">	protected Activity m_mostDeficientActivity2 = null;</span>
	/* 6 variables and logic added for Language Line ESR
	 * Before: When drawing extension from Net Staffing ,either the drawn duration equals or not equals to closet shift extension,
	 *  there is always an information message &quot;The closest matching shift extension to your selection is shown below&quot;
	 * After change: When drawing extension from Net Staffing , if the drawn duration equals to closet shift extension,
	 * it shows the current message &quot;The closest matching shift extension to your selection is shown below&quot;.
	 * if the drawn duration  does not equals to closest shift extension, the warning message displays
	 * &quot;Your shift extension was changed from x hours to y hours to match the closest shift extension rule&quot;
	 * */
<span class="nc" id="L246">	boolean beforeDurationMatchShiftDuration= false;</span>
<span class="nc" id="L247">	boolean afterDurationMatchShiftDuration= false;</span>
<span class="nc" id="L248">	boolean highlightBeforeDuration= false;</span>
<span class="nc" id="L249">	boolean highlightAfterDuration= false;</span>
<span class="nc" id="L250">	String strDesiredDuration =&quot;&quot;;</span>
<span class="nc" id="L251">	String strShiftDuration= &quot;&quot;;</span>

	/**
	 * Constructor
	 */
	public CustomShiftRequestFormPopupPM(RequestContext context) {
<span class="nc" id="L257">		super(context, RmKeys.RH_CUSTSHIFT_FORM);</span>

<span class="nc" id="L259">		m_containerList = new ContainerList(this, 3);</span>
<span class="nc" id="L260">		setCustomShiftRequest(new CustShiftReq(CustShiftReq.DL_BASIC | CustShiftReq.DL_AUDIT_TRAIL));</span>
<span class="nc" id="L261">		initDateAndTimePickers();</span>

<span class="nc" id="L263">		gapBeforeDurationPC = new DurationSpinnerPC(m_context, EXT_BEFORE_GAP);</span>
<span class="nc" id="L264">		this.addChildComponent(gapBeforeDurationPC);</span>
<span class="nc" id="L265">		gapAfterDurationPC = new DurationSpinnerPC(m_context, EXT_AFTER_GAP);</span>
<span class="nc" id="L266">		this.addChildComponent(gapAfterDurationPC);</span>

<span class="nc" id="L268">		addRequiredJavaScriptFile(RmJavaScriptFileID.CUSTOM_SHIFT_REQUEST_DIALOG_JS);</span>
<span class="nc" id="L269">		addJSVariableAsString(&quot;INVALID_COMBINATION_FOR_EXT_BEFORE&quot;,</span>
<span class="nc" id="L270">				i18n(m_bundle, RmWebBundleKey.INVALID_COMBINATION_FOR_EXT_BEFORE));</span>
<span class="nc" id="L271">		addJSVariableAsString(&quot;INVALID_COMBINATION_FOR_EXT_AFTER&quot;,</span>
<span class="nc" id="L272">				i18n(m_bundle, RmWebBundleKey.INVALID_COMBINATION_FOR_EXT_AFTER));</span>
<span class="nc" id="L273">		addJSVariableAsString(&quot;ZERO_DURATION_VALUE&quot;, CustomShiftUtil.getDurationString(m_localizer, 0));</span>

<span class="nc" id="L275">		String none = &quot;&lt;&quot; + context.getLocalizer().i18n(m_bundle, RmWebBundleKey.CSR_NONE) + &quot;&gt;&quot;;</span>
<span class="nc" id="L276">		addJSVariableAsString(&quot;NONE_VALUE&quot;, none);</span>
<span class="nc" id="L277">	}</span>

	/**
	 * Return an instance of the model that is ready for rendering
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L283">		return getInstance(context, CustomShiftRequestFormPopupPM.class);</span>
	}

	/**
	 * Extract the parameter values from the request.
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L291">		boolean success = super.extractParameters(request);</span>

		// QC 45654: Save button doesn't resubmit after request has been denied
<span class="nc bnc" id="L294" title="All 2 branches missed.">		if (m_customShiftRequest.getRequestStatus().equals(RequestAuditTrail.STATUS_DENIED)) {</span>
<span class="nc" id="L295">			m_customShiftRequest.setRequestStatus(RequestAuditTrail.STATUS_PENDING);</span>
		}

		// Store the gaps from the request. These could be overridden later when
		// initializeModel() is called.
<span class="nc" id="L300">		setExtBeforeGap(gapBeforeDurationPC.getDuration().getDurationInMinutes());</span>
<span class="nc" id="L301">		setExtAfterGap(gapAfterDurationPC.getDuration().getDurationInMinutes());</span>

<span class="nc" id="L303">		return success;</span>
	}

	protected void storeCSDataInMemberVars(CustomShiftRequestsMH.CSDetailData csData) throws Exception {
<span class="nc" id="L307">		m_empNames = csData.getEmployeeNames();</span>
<span class="nc" id="L308">		m_orgSetting = csData.getOrgSetting();</span>
<span class="nc" id="L309">		m_empID = csData.getEmpID();</span>
<span class="nc" id="L310">		m_shiftAssignment = csData.getShiftAssignment();</span>
<span class="nc" id="L311">		m_saGapBeforeDuration = csData.getGapBeforeDuration();</span>
<span class="nc" id="L312">		m_saGapAfterDuration = csData.getGapAfterDuration();</span>
<span class="nc" id="L313">		m_saMainShiftStartTime = csData.getMainShiftStartTime();</span>
<span class="nc" id="L314">		m_saMainShiftEndTime = csData.getMainShiftEndTime();</span>
<span class="nc" id="L315">		m_spID = csData.getSPID();</span>
<span class="nc" id="L316">		spIDMap = csData.getSPIDMap();</span>

<span class="nc" id="L318">		m_shifts = new ArrayList&lt;Shift&gt;(csData.getShifts());</span>
<span class="nc" id="L319">		m_activities = new ArrayList&lt;Activity&gt;(csData.getActivities());</span>
<span class="nc" id="L320">		m_extBeforeTypes = new ArrayList(csData.getExtBeforeTypes());</span>
<span class="nc" id="L321">		m_extBeforeActivities = new ArrayList(csData.getExtBeforeActivities());</span>
<span class="nc" id="L322">		m_extAfterTypes = new ArrayList(csData.getExtAfterTypes());</span>
<span class="nc" id="L323">		m_extAfterActivities = new ArrayList(csData.getExtAfterActivities());</span>
<span class="nc" id="L324">		m_mostDeficientActivity1 = csData.getMostDeficientActivity1();</span>
<span class="nc" id="L325">		m_mostDeficientActivity2 = csData.getMostDeficientActivity2();</span>

<span class="nc bnc" id="L327" title="All 2 branches missed.">		if (m_orgSetting != null) {</span>
<span class="nc" id="L328">			readOrgSettings();</span>
<span class="nc" id="L329">			setDatePickerWeekStarts(new ID(m_orgSetting.getCurrentOrgId()));</span>
		}
<span class="nc" id="L331">	}</span>

	/**
	 * Read the RM settings for the organization and store settings in our
	 * boolean member variables.
	 */
	protected void readOrgSettings() {
		// The two main settings. If both of these are disabled, nothing is
		// editable in the dialog.

		// allow new shift requests
<span class="nc" id="L342">		m_allowNewShifts = m_orgSetting.getEnableCustomShiftRequests();</span>
		// allow shift change requests
<span class="nc" id="L344">		m_allowShiftChanges = m_orgSetting.getAllowShiftChangeRequests();</span>

<span class="nc" id="L346">		m_allowRegularShifts = m_orgSetting.getAllowEntireRegularShift();</span>
<span class="nc" id="L347">		m_allowOTShifts = m_orgSetting.getAllowEntireOTShift();</span>
<span class="nc" id="L348">		m_allowRegularExtBeforeShifts = m_orgSetting.getAllowRegularExtensionBeforeShift();</span>
<span class="nc" id="L349">		m_allowRegularExtAfterShifts = m_orgSetting.getAllowRegularExtensionAfterShift();</span>
<span class="nc" id="L350">		m_allowOTExtBeforeShifts = m_orgSetting.getAllowOTBeforeShift();</span>
<span class="nc" id="L351">		m_allowOTExtAfterShifts = m_orgSetting.getAllowOTAfterShift();</span>

<span class="nc bnc" id="L353" title="All 4 branches missed.">		if (!m_allowRegularShifts &amp;&amp; !m_allowOTShifts) {</span>
<span class="nc" id="L354">			m_allowNewShifts = false;</span>
		}

<span class="nc bnc" id="L357" title="All 12 branches missed.">		if (!m_allowRegularShifts &amp;&amp; !m_allowOTShifts &amp;&amp; !m_allowRegularExtBeforeShifts &amp;&amp; !m_allowRegularExtAfterShifts</span>
				&amp;&amp; !m_allowOTExtBeforeShifts &amp;&amp; !m_allowOTExtAfterShifts) {
<span class="nc" id="L359">			m_allowShiftChanges = false;</span>
		}
<span class="nc" id="L361">	}</span>

	public void setInitialized(boolean isInitialized) {
<span class="nc" id="L364">		m_isInitialized = isInitialized;</span>
<span class="nc" id="L365">	}</span>

	/**
	 * Initialize Model with Data. This method is called AFTER
	 * extractParameters().
	 */
	@Override
	protected void initializeModel() {
<span class="nc bnc" id="L373" title="All 2 branches missed.">		if (m_isInitialized) {</span>
<span class="nc" id="L374">			return;</span>
		} else {
<span class="nc" id="L376">			m_isInitialized = true;</span>
		}

<span class="nc" id="L379">		boolean sumtingWong = false;</span>
		try {
<span class="nc" id="L381">			ID empID = getRequestedFor();</span>

<span class="nc" id="L383">			CustomShiftRequestsMH.CSDetailData csData = null;</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">			CustShiftReq existingRequest = (getRequestID() == null) ? null</span>
<span class="nc" id="L385">					: CustomShiftRequestsMH.getCSRequest(getRequestID());</span>

			// make sure request has not been deleted
<span class="nc bnc" id="L388" title="All 4 branches missed.">			if (existingRequest == null &amp;&amp; !isNew()) {</span>
<span class="nc" id="L389">				sumtingWong = true;</span>
<span class="nc" id="L390">				addPageMessage(Message.ERROR_TYPE, i18n(m_bundle, RmWebBundleKey.REQUEST_NOT_FOUND_ERROR));</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">			} else if (!getCanCreateCustomShiftRequest(m_context, isManagerMode())) {</span>
<span class="nc" id="L392">				sumtingWong = true;</span>
<span class="nc" id="L393">				m_isAuthorized = false;</span>
<span class="nc" id="L394">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_UNAUTHORIZED_TO_CREATE_CS_REQUEST,</span>
						RmWebBundleKey.BUNDLE_NAME);
			} else {
				// the first time the dialog loads, we get day range from the
				// existingRequest (if any). After, get it from date picker.
<span class="nc" id="L399">				boolean getFromToDatesFromExistingRequest = false;</span>
<span class="nc bnc" id="L400" title="All 4 branches missed.">				if (existingRequest != null &amp;&amp; m_reloadAction.equals(RELOAD_ACTION_NONE)) {</span>
					// CustomShiftUtil.setShiftStartTimeInExistingRequest(existingRequest,
					// m_view_tz);
<span class="nc" id="L403">					getFromToDatesFromExistingRequest = true;</span>
				}

<span class="nc bnc" id="L406" title="All 2 branches missed.">				Pair entireDayDates = getFromToDates(getFromToDatesFromExistingRequest ? existingRequest : null);</span>
<span class="nc" id="L407">				Date dayStart = (Date) entireDayDates.getFirst();</span>
<span class="nc" id="L408">				Date dayEnd = (Date) entireDayDates.getSecond();</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">				m_selectedDayIncludesRibbonSelection = m_ribbonStartDate != null</span>
<span class="nc bnc" id="L410" title="All 4 branches missed.">						&amp;&amp; !(m_ribbonStartDate.before(dayStart) || m_ribbonStartDate.after(dayEnd));</span>
<span class="nc bnc" id="L411" title="All 4 branches missed.">				m_selectedAgentIsForRibbonSelection = m_ribbonStartDate != null &amp;&amp; getRequestedFor() != null</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">						&amp;&amp; getRequestedFor().equals(getOrigRequestedFor());</span>
<span class="nc bnc" id="L413" title="All 4 branches missed.">				m_selectedDateIsForSavedRequest = existingRequest != null &amp;&amp; existingRequest.getShiftStartTime() != null</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">						&amp;&amp; !(existingRequest.getShiftStartTime().before(dayStart)</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">								|| existingRequest.getShiftStartTime().after(dayEnd));</span>

<span class="nc bnc" id="L417" title="All 2 branches missed.">				if (isManagerMode()) {</span>
<span class="nc" id="L418">					csData = CustomShiftRequestsMH.getCSDetailDataForManager(m_context, m_context.getUser(), empID,</span>
<span class="nc" id="L419">							isNew(), existingRequest, dayStart, dayEnd, m_ribbonStartDate, m_ribbonEndDate,</span>
<span class="nc" id="L420">							isRibbonApplicable(), m_bundle, m_view_tz);</span>
				} else {
<span class="nc" id="L422">					csData = CustomShiftRequestsMH.getCSDetailData(m_context, empID, existingRequest, dayStart, dayEnd,</span>
<span class="nc" id="L423">							m_ribbonStartDate, m_ribbonEndDate, isRibbonApplicable(), m_bundle, m_view_tz);</span>
				}

<span class="nc" id="L426">				storeCSDataInMemberVars(csData);</span>

				// if this is the first time showing the dialog, or if the
				// dialog was reloaded due to a change in
				// date/employee selection, then we need to clear the extracted
				// form values and get the request details anew.
				// (This is not needed for the Revert action, which is a
				// JavaScript-only action)
<span class="nc bnc" id="L434" title="All 4 branches missed.">				if (m_reloadAction.equals(RELOAD_ACTION_NONE) || m_reloadAction.equals(RELOAD_ACTION_DATE)</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">						|| m_reloadAction.equals(RELOAD_ACTION_EMPLOYEE)</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">						|| m_reloadAction.equals(RELOAD_ACTION_RIBBON)) {</span>
					// First clear the extracted form values
<span class="nc" id="L438">					resetCustomShiftRequest();</span>

<span class="nc" id="L440">					if (// (!isNew() &amp;&amp;</span>
					// !m_reloadAction.equals(RELOAD_ACTION_DATE) &amp;&amp;
					// !m_reloadAction.equals(RELOAD_ACTION_EMPLOYEE)) ||
<span class="nc bnc" id="L443" title="All 2 branches missed.">					isRequestDefaultMode()) {</span>
						// User is editing an existing request (this is the
						// first time dialog is opened)

<span class="nc" id="L447">						m_isAuthorized = RequestUtil.isAuthToUpdate(m_context, existingRequest);</span>

						// Try to keep extracted value in case of error
<span class="nc bnc" id="L450" title="All 2 branches missed.">						if (hasError()) {</span>
<span class="nc" id="L451">							m_customShiftRequest.setAuditTrailList(existingRequest.getAuditTrail());</span>
						} else {
<span class="nc bnc" id="L453" title="All 4 branches missed.">							if (existingRequest != null &amp;&amp; isShiftChangeRequest()) {</span>
								// Since Shift Change requests only store
								// deltas, we get the shift assignment, then
								// merge the deltas into it.
<span class="nc" id="L457">								CustomShiftUtil.convertShiftAssignmentToRequest(m_shiftAssignment, m_customShiftRequest,</span>
										m_saMainShiftStartTime, m_saMainShiftEndTime, m_saGapBeforeDuration,
										m_saGapAfterDuration, true);
<span class="nc" id="L460">								CustomShiftUtil.mergeExistingRequestDeltasIntoRequest(existingRequest,</span>
										m_customShiftRequest);
<span class="nc" id="L462">								setCustomShiftRequest(m_customShiftRequest);</span>
							} else {
								// New Shift requests store all the data, so we
								// can use it as-is.
<span class="nc" id="L466">								setCustomShiftRequest(existingRequest);</span>
							}
						}
					} else {
						// User is either creating a new request (Shift
						// Change/New Shift), or
						// he is editing an existing request (Shift Change/New
						// Shift) and has changed the date from the original
						// request.
						// If there is a shift on this day, then we must get the
						// details and pre-fill the form (m_customShiftRequest)
						// with this shift information.
<span class="nc bnc" id="L478" title="All 2 branches missed.">						if (isShiftChangeRequest()) {</span>
<span class="nc" id="L479">							CustomShiftUtil.convertShiftAssignmentToRequest(m_shiftAssignment, m_customShiftRequest,</span>
									m_saMainShiftStartTime, m_saMainShiftEndTime, m_saGapBeforeDuration,
									m_saGapAfterDuration, true);
						}

<span class="nc bnc" id="L484" title="All 2 branches missed.">						if (isRibbonDefaultMode()) {</span>
<span class="nc" id="L485">							optimizeRequestForRibbonSelection();</span>
						}
					}

<span class="nc" id="L489">					setStartTimePickerBasedOnRequest();</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">				} else if (isShiftChangeRequest()) {</span>
					// The Gap duration spinners do not submit their values when
					// they are readonly. Because of this,
					// we must reload their original values rather than use
					// their extracted values which aren't available.
<span class="nc bnc" id="L495" title="All 2 branches missed.">					if (!isExtBeforeEditable()) {</span>
<span class="nc" id="L496">						m_customShiftRequest.setExtBeforeGap(m_saGapBeforeDuration);</span>
					}
<span class="nc bnc" id="L498" title="All 2 branches missed.">					if (!isExtAfterEditable()) {</span>
<span class="nc" id="L499">						m_customShiftRequest.setExtAfterGap(m_saGapAfterDuration);</span>
					}
				}

<span class="nc bnc" id="L503" title="All 4 branches missed.">				if (m_isAuthorized &amp;&amp; existingRequest != null) {</span>
<span class="nc" id="L504">					m_valResults = existingRequest.getValidationResults(true);</span>
				}

<span class="nc" id="L507">				determineCollapsedSections(existingRequest);</span>

				// make sure m_customShiftRequest contains the existingRequest's
				// general request data
<span class="nc" id="L511">				synchRequestWithExistingRequest(existingRequest);</span>

				// We know that m_customShiftRequest now has the right values.
				// They were originally read from extractParameters(), but
				// they could have been overridden above. We also know that we
				// have populated the lists of objects for the day. Now we
				// must get the objects that we need from the lists.
<span class="nc" id="L518">				setCurrentObjects();</span>
<span class="nc" id="L519">				setRequestStartEndBasedOnShiftAndDatePicker();</span>
			}
<span class="nc" id="L521">		} catch (RmBaseException ex) {</span>
<span class="nc" id="L522">			log.l7dError(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L523">			addPageMessage(Message.ERROR_TYPE, ex);</span>
<span class="nc" id="L524">			sumtingWong = true;</span>
<span class="nc" id="L525">		} catch (Exception ex) {</span>
<span class="nc" id="L526">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L527">			sumtingWong = true;</span>
		} finally {
<span class="nc" id="L529">			initContentTitle();</span>

<span class="nc bnc" id="L531" title="All 8 branches missed.">			if (!sumtingWong) {</span>
<span class="nc" id="L532">				initContent();</span>
			} else {
<span class="nc" id="L534">				handleError();</span>
			}
<span class="nc" id="L536">		}</span>
<span class="nc" id="L537">	}</span>

	protected void handleError() {
<span class="nc" id="L540">		initToolbar(false);</span>
<span class="nc" id="L541">		setCollapsedSections(true, true, true, true);</span>
<span class="nc" id="L542">	}</span>

	/**
	 * Optimize the m_customShiftRequest for the user's ribbon selection. In
	 * other words, we will find the best matching shift and extensions for the
	 * ribbon selection, and set them in our m_customShiftRequest member
	 * variable.
	 */
	protected void optimizeRequestForRibbonSelection() {
<span class="nc bnc" id="L551" title="All 4 branches missed.">		if (m_mostDeficientActivity1 == null &amp;&amp; m_mostDeficientActivity2 == null) {</span>
<span class="nc" id="L552">			return; // nothing to optimize</span>
		} else {
<span class="nc" id="L554">			boolean showNoMatchWarning = false;</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">			if (isNewShiftRequest()) {</span>
				// we will try to find the main Shift that best matches the
				// ribbon interval (we won't try to find an Extension)

<span class="nc bnc" id="L559" title="All 2 branches missed.">				if (!isShiftOptimizable()) {</span>
<span class="nc" id="L560">					showNoMatchWarning = true;</span>
				} else {
<span class="nc" id="L562">					int desiredDuration = (int) ((m_ribbonEndDate.getTime() - m_ribbonStartDate.getTime()) / 1000.0</span>
							/ 60.0);
					// iterate through the available shifts and find one with a
					// length closest to the ribbon range
<span class="nc" id="L566">					Shift closestShift = null;</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">					for (Iterator it = m_shifts.iterator(); it.hasNext();) {</span>
<span class="nc" id="L568">						Shift shift = (Shift) it.next();</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">						if (closestShift == null || (Math.abs(shift.getDuration() - desiredDuration) &lt; Math</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">								.abs(closestShift.getDuration() - desiredDuration))) {</span>
<span class="nc" id="L571">							closestShift = shift;</span>
						}
<span class="nc" id="L573">					}</span>

<span class="nc bnc" id="L575" title="All 2 branches missed.">					if (closestShift != null) {</span>
<span class="nc" id="L576">						m_customShiftRequest.setShiftID(closestShift.getID());</span>
<span class="nc" id="L577">						m_customShiftRequest.setActivityID(m_mostDeficientActivity1.getID());</span>
<span class="nc" id="L578">						m_customShiftRequest.setShiftStartTime(m_ribbonStartDate);</span>
						// &quot;The closest matching shift to your net staffing
						// selection has been pre-selected.&quot;
<span class="nc" id="L581">						addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_CLOSEST_MATCH_SELECTED,</span>
								RmWebBundleKey.BUNDLE_NAME);
					} else {
<span class="nc" id="L584">						showNoMatchWarning = true;</span>
					}
<span class="nc" id="L586">				}</span>
			} else // shift change request
			{
				// we will try to find the Extension that best matches the
				// ribbon interval (we won't try to modify the main Shift)

<span class="nc bnc" id="L592" title="All 4 branches missed.">				if (!isExtBeforeOptimizable() &amp;&amp; !isExtAfterOptimizable()) {</span>
<span class="nc" id="L593">					showNoMatchWarning = true;</span>
				} else {
<span class="nc" id="L595">					boolean foundOptimalBefore = false;</span>
<span class="nc" id="L596">					boolean foundOptimalAfter = false;</span>
<span class="nc" id="L597">					long desiredDuration = 0;</span>
<span class="nc" id="L598">					ShiftOTExtension closestExt = null;</span>
<span class="nc bnc" id="L599" title="All 4 branches missed.">					if (m_mostDeficientActivity1 != null &amp;&amp; isExtBeforeOptimizable()</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">							&amp;&amp; m_ribbonStartDate.before(m_shiftAssignment.getStartTime())) {</span>
<span class="nc" id="L601">						Date desiredStartDateBefore = m_ribbonStartDate;</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">						Date desiredEndDateBefore = m_ribbonEndDate.before(m_shiftAssignment.getStartTime())</span>
<span class="nc" id="L603">								? m_ribbonEndDate : m_shiftAssignment.getStartTime();</span>
<span class="nc" id="L604">						desiredDuration = (int) ((desiredEndDateBefore.getTime()</span>
<span class="nc" id="L605">								- desiredStartDateBefore.getTime()) / 1000.0 / 60.0);</span>
						// iterate through the available extBefore's and find
						// one with a length closest to the ribbon range

<span class="nc bnc" id="L609" title="All 2 branches missed.">						for (Iterator it = m_extBeforeTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L610">							ShiftOTExtension ext = (ShiftOTExtension) it.next();</span>
<span class="nc bnc" id="L611" title="All 4 branches missed.">							if ((!ext.getID().equals(NONE_ID))</span>
<span class="nc" id="L612">									&amp;&amp; (closestExt == null || (Math.abs(ext.getDuration() - desiredDuration) &lt; Math</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">											.abs(closestExt.getDuration() - desiredDuration)))) {</span>
<span class="nc" id="L614">								closestExt = ext;</span>
							}
<span class="nc bnc" id="L616" title="All 4 branches missed.">							if(!beforeDurationMatchShiftDuration&amp;&amp;ext.getDuration()==desiredDuration){</span>
<span class="nc" id="L617">								beforeDurationMatchShiftDuration= true;</span>
							}
<span class="nc" id="L619">						}</span>

<span class="nc bnc" id="L621" title="All 4 branches missed.">						if (closestExt != null &amp;&amp; areDurationsClose(desiredDuration, closestExt.getDuration())) {</span>
<span class="nc" id="L622">							long desiredGapBefore = 0;</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">							if (desiredEndDateBefore.before(m_shiftAssignment.getStartTime())) {</span>
<span class="nc" id="L624">								desiredGapBefore = m_shiftAssignment.getStartTime().getTime()</span>
<span class="nc" id="L625">										- desiredEndDateBefore.getTime();</span>
							}

<span class="nc" id="L628">							m_customShiftRequest.setExtBeforeID(closestExt.getID());</span>
<span class="nc" id="L629">							m_customShiftRequest.setExtBeforeDuration(closestExt.getDuration());</span>
<span class="nc" id="L630">							m_customShiftRequest.setExtBeforeActivityID(m_mostDeficientActivity1.getID());</span>
<span class="nc" id="L631">							m_customShiftRequest.setExtBeforeGap((int) (desiredGapBefore / 1000.0 / 60.0));</span>
<span class="nc" id="L632">							foundOptimalBefore = true;</span>
						}
					}

<span class="nc bnc" id="L636" title="All 4 branches missed.">					if (m_mostDeficientActivity2 != null &amp;&amp; isExtAfterOptimizable()</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">							&amp;&amp; m_ribbonEndDate.after(m_shiftAssignment.getEndTime())) {</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">						Date desiredStartDateAfter = m_ribbonStartDate.after(m_shiftAssignment.getEndTime())</span>
<span class="nc" id="L639">								? m_ribbonStartDate : m_shiftAssignment.getEndTime();</span>
<span class="nc" id="L640">						Date desiredEndDateAfter = m_ribbonEndDate;</span>
<span class="nc" id="L641">						desiredDuration = (int) ((desiredEndDateAfter.getTime() - desiredStartDateAfter.getTime())</span>
								/ 1000.0 / 60.0);



						// iterate through the available extAfter's and find one
						// with a length closest to the ribbon range
<span class="nc bnc" id="L648" title="All 2 branches missed.">						for (Iterator it = m_extAfterTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L649">							ShiftOTExtension ext = (ShiftOTExtension) it.next();</span>
<span class="nc bnc" id="L650" title="All 4 branches missed.">							if ((!ext.getID().equals(NONE_ID))</span>
<span class="nc" id="L651">									&amp;&amp; (closestExt == null || (Math.abs(ext.getDuration() - desiredDuration) &lt; Math</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">											.abs(closestExt.getDuration() - desiredDuration)))) {</span>
<span class="nc" id="L653">								closestExt = ext;</span>
							}
<span class="nc bnc" id="L655" title="All 4 branches missed.">							if(!afterDurationMatchShiftDuration&amp;&amp;ext.getDuration()==desiredDuration){</span>
<span class="nc" id="L656">								afterDurationMatchShiftDuration= true;</span>
							}
<span class="nc" id="L658">						}</span>

<span class="nc bnc" id="L660" title="All 4 branches missed.">						if (closestExt != null &amp;&amp; areDurationsClose(desiredDuration, closestExt.getDuration())) {</span>
<span class="nc" id="L661">							long desiredGapAfter = 0;</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">							if (desiredStartDateAfter.after(m_shiftAssignment.getEndTime())) {</span>
<span class="nc" id="L663">								desiredGapAfter = desiredStartDateAfter.getTime()</span>
<span class="nc" id="L664">										- m_shiftAssignment.getEndTime().getTime();</span>
							}

<span class="nc" id="L667">							m_customShiftRequest.setExtAfterID(closestExt.getID());</span>
<span class="nc" id="L668">							m_customShiftRequest.setExtAfterDuration(closestExt.getDuration());</span>
<span class="nc" id="L669">							m_customShiftRequest.setExtAfterActivityID(m_mostDeficientActivity2.getID());</span>
<span class="nc" id="L670">							m_customShiftRequest.setExtAfterGap((int) (desiredGapAfter / 1000.0 / 60.0));</span>
<span class="nc" id="L671">							foundOptimalAfter = true;</span>
						}
					}
<span class="nc bnc" id="L674" title="All 2 branches missed.">					if (beforeDurationMatchShiftDuration) {</span>
						// &quot;The closest matching extensions to your net staffing
						// selection are shown below.&quot;
<span class="nc" id="L677">						addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_ADDED_EXTENSIONS,</span>
								RmWebBundleKey.BUNDLE_NAME);

<span class="nc bnc" id="L680" title="All 2 branches missed.">					} else if (afterDurationMatchShiftDuration) {</span>
						// &quot;The closest matching extension to your net staffing
						// selection is shown below.&quot;
<span class="nc" id="L683">						addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_ADDED_EXTENSION,</span>
								RmWebBundleKey.BUNDLE_NAME);
<span class="nc bnc" id="L685" title="All 4 branches missed.">					} else if(foundOptimalBefore||foundOptimalAfter) {</span>
						//if the Before or After duration drawn on Net Staffing does not with Shift Duration, it shows warning message
						 // And highlight the shift duration and add a warning icon next to duration
<span class="nc" id="L688">						strDesiredDuration= CustomShiftUtil.getDurationString(m_context.getLocalizer(),(int)desiredDuration);</span>
<span class="nc" id="L689">						strShiftDuration= CustomShiftUtil.getDurationString(m_context.getLocalizer(),closestExt.getDuration());</span>
<span class="nc" id="L690">						addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.CSR_WARNING_ADDED_EXTENSION_DETAIL,</span>
								RmWebBundleKey.BUNDLE_NAME,new String[] { strDesiredDuration, strShiftDuration});
<span class="nc" id="L692">						highlightBeforeDuration =foundOptimalBefore;</span>
<span class="nc" id="L693">						highlightAfterDuration =foundOptimalAfter;</span>
					} else {
<span class="nc" id="L695">						showNoMatchWarning = true;</span>
					}
				}
			}

<span class="nc bnc" id="L700" title="All 4 branches missed.">			if (!nothingIsEditable() &amp;&amp; showNoMatchWarning) {</span>
				// &quot;A best match for your net staffing selection could not be
				// automatically determined.&quot;
<span class="nc" id="L703">				addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.CSR_WARNING_BEST_MATCH_NOT_FOUND,</span>
						RmWebBundleKey.BUNDLE_NAME);
			}
		}
<span class="nc" id="L707">	}</span>

	/**
	 * Determines whether the first duration is at least half of the second
	 * duration.
	 */
	private static boolean areDurationsClose(long d1, long d2) {
<span class="nc" id="L714">		return true; // d1 &gt;= ((double)(d2 / 2.0));</span>
	}

	/**
	 * Initialize Model with Data. No UI components should be initialized here
	 * except for any required to initialize data values properly. This method
	 * is called AFTER extractParameters() in the Request Handler for when the
	 * Save button is clicked.
	 */
	protected void initializeModelForSaving() throws Exception {
<span class="nc" id="L724">		ID empID = getRequestedFor();</span>

<span class="nc" id="L726">		CustomShiftRequestsMH.CSDetailData csData = null;</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">		CustShiftReq existingRequest = (getRequestID() == null) ? null</span>
<span class="nc" id="L728">				: CustomShiftRequestsMH.getCSRequest(getRequestID());</span>

		{
<span class="nc" id="L731">			Pair entireDayDates = getFromToDates(null);</span>
<span class="nc" id="L732">			Date dayStart = (Date) entireDayDates.getFirst();</span>
<span class="nc" id="L733">			Date dayEnd = (Date) entireDayDates.getSecond();</span>

<span class="nc bnc" id="L735" title="All 2 branches missed.">			if (isManagerMode()) {</span>
<span class="nc" id="L736">				csData = CustomShiftRequestsMH.getCSDetailDataForManager(m_context, m_context.getUser(), empID, isNew(),</span>
						existingRequest, dayStart, dayEnd, m_ribbonStartDate, m_ribbonEndDate, false, m_bundle,
						m_view_tz);
			} else {
<span class="nc" id="L740">				csData = CustomShiftRequestsMH.getCSDetailData(m_context, empID, existingRequest, dayStart, dayEnd,</span>
						m_ribbonStartDate, m_ribbonEndDate, false, m_bundle, m_view_tz);
			}

<span class="nc" id="L744">			storeCSDataInMemberVars(csData);</span>

<span class="nc" id="L746">			afterLoadCSDataIninitializeModelForSaving();</span>

			// The Gap duration spinners do not submit their values when they
			// are readonly. Because of this,
			// we must reload their original values rather than use their
			// extracted values which aren't available.
<span class="nc bnc" id="L752" title="All 2 branches missed.">			if (!isExtBeforeEditable()) {</span>
<span class="nc" id="L753">				m_customShiftRequest.setExtBeforeGap(m_saGapBeforeDuration);</span>
			}
<span class="nc bnc" id="L755" title="All 2 branches missed.">			if (!isExtAfterEditable()) {</span>
<span class="nc" id="L756">				m_customShiftRequest.setExtAfterGap(m_saGapAfterDuration);</span>
			}

			// make sure m_customShiftRequest contains the existingRequest's
			// general request data
<span class="nc" id="L761">			synchRequestWithExistingRequest(existingRequest);</span>

			// We know that m_customShiftRequest now has the right values. They
			// were originally read from extractParameters(), but
			// they could have been overridden above. We also know that we have
			// populated the lists of objects for the day. Now we
			// must get the objects that we need from the lists.
<span class="nc" id="L768">			setCurrentObjects();</span>
<span class="nc" id="L769">			setRequestStartEndBasedOnShiftAndDatePicker();</span>
			// m_customShiftRequest.setSubType(determineRequestSubType());
		}
<span class="nc" id="L772">	}</span>

	/**
	 * Method used for extra logic for REST services. This is required because certain logic needs to happen after csData is loaded
	 * but before synchRequestWithExistingRequest and setCurrentObjects.
	 */
	protected void afterLoadCSDataIninitializeModelForSaving() throws Exception { // NOSONAR

<span class="nc" id="L780">	}</span>

	/**
	 * If we are editing an existing CustShiftReq, we need to use it as our
	 * member variable, since it contains the general request information from
	 * the db (such as expirationDate) that was not included in our extracted
	 * params. This extra info is required when saving the request.
	 */
	public void synchRequestWithExistingRequest(CustShiftReq existingRequest) {
<span class="nc bnc" id="L789" title="All 2 branches missed.">		if (existingRequest != null) {</span>
<span class="nc" id="L790">			existingRequest.setShiftID(m_customShiftRequest.getShiftID());</span>
<span class="nc" id="L791">			existingRequest.setActivityID(m_customShiftRequest.getActivityID());</span>
<span class="nc" id="L792">			existingRequest.setShiftStartTime(m_customShiftRequest.getShiftStartTime());</span>
<span class="nc" id="L793">			existingRequest.setShiftEndTime(m_customShiftRequest.getShiftEndTime());</span>
<span class="nc" id="L794">			existingRequest.setIsOT(m_customShiftRequest.isOT());</span>
<span class="nc" id="L795">			existingRequest.setExtBeforeID(m_customShiftRequest.getExtBeforeID());</span>
<span class="nc" id="L796">			existingRequest.setExtBeforeActivityID(m_customShiftRequest.getExtBeforeActivityID());</span>
<span class="nc" id="L797">			existingRequest.setExtBeforeIsOT(m_customShiftRequest.getExtBeforeIsOT());</span>
<span class="nc" id="L798">			existingRequest.setExtBeforeGap(m_customShiftRequest.getExtBeforeGap());</span>
<span class="nc" id="L799">			existingRequest.setExtAfterID(m_customShiftRequest.getExtAfterID());</span>
<span class="nc" id="L800">			existingRequest.setExtAfterActivityID(m_customShiftRequest.getExtAfterActivityID());</span>
<span class="nc" id="L801">			existingRequest.setExtAfterIsOT(m_customShiftRequest.getExtAfterIsOT());</span>
<span class="nc" id="L802">			existingRequest.setExtAfterGap(m_customShiftRequest.getExtAfterGap());</span>
<span class="nc" id="L803">			existingRequest.setExtBeforeDuration(m_customShiftRequest.getExtBeforeDuration());</span>
<span class="nc" id="L804">			existingRequest.setExtAfterDuration(m_customShiftRequest.getExtAfterDuration());</span>
<span class="nc" id="L805">			existingRequest.setShiftAssignmentID(m_customShiftRequest.getShiftAssignmentID());</span>

<span class="nc" id="L807">			setCustomShiftRequest(existingRequest);</span>
		}
<span class="nc" id="L809">	}</span>

	/**
	 * Reset the m_customShiftRequest so that all extracted params are wiped-out
	 * except startDate.
	 */
	private void resetCustomShiftRequest() {
<span class="nc" id="L816">		m_customShiftRequest.setShiftID(null);</span>
<span class="nc" id="L817">		m_customShiftRequest.setActivityID(null);</span>

<span class="nc" id="L819">		m_customShiftRequest.setShiftStartTime(m_datePickerPC.getDate());</span>
<span class="nc" id="L820">		m_customShiftRequest.setShiftEndTime(m_datePickerPC.getDate());</span>

<span class="nc" id="L822">		m_customShiftRequest.setIsOT(false);</span>

<span class="nc" id="L824">		m_customShiftRequest.setExtBeforeID(null);</span>
<span class="nc" id="L825">		m_customShiftRequest.setExtBeforeActivityID(null);</span>
<span class="nc" id="L826">		m_customShiftRequest.setExtBeforeIsOT(false);</span>
<span class="nc" id="L827">		m_customShiftRequest.setExtBeforeGap(0);</span>

<span class="nc" id="L829">		m_customShiftRequest.setExtAfterID(null);</span>
<span class="nc" id="L830">		m_customShiftRequest.setExtAfterActivityID(null);</span>
<span class="nc" id="L831">		m_customShiftRequest.setExtAfterIsOT(false);</span>
<span class="nc" id="L832">		m_customShiftRequest.setExtAfterGap(0);</span>

<span class="nc" id="L834">		m_customShiftRequest.setExtBeforeDuration(0);</span>
<span class="nc" id="L835">		m_customShiftRequest.setExtAfterDuration(0);</span>
<span class="nc" id="L836">		m_customShiftRequest.setShiftAssignmentID(null);</span>

<span class="nc" id="L838">	}</span>

	/**
	 * Return true if the currently selected day contains a shift assignment for
	 * the employee. If so, this means that any Custom Shift request on this day
	 * must be a Shift Change request rather than a New Shift request.
	 */
	public boolean isShiftChangeRequest() {
<span class="nc bnc" id="L846" title="All 2 branches missed.">		return (m_shiftAssignment != null);</span>
	}

	/**
	 * Return true if the currently selected day does NOT contain a shift
	 * assignment for the employee. This means that any Custom Shift request on
	 * this day must be a New Shift request rather than a Shift Change request.
	 */
	public boolean isNewShiftRequest() {
<span class="nc bnc" id="L855" title="All 2 branches missed.">		return (m_shiftAssignment == null);</span>
	}

	public ShiftAssignment getShiftAssignment() {
<span class="nc" id="L859">		return m_shiftAssignment;</span>
	}

	/**
	 * Use the ID's set in the m_customShiftRequest, and the lists of objects
	 * (Shifts, Activities, etc) for the selected day to set the current object
	 * member variables (m_shift, etc).
	 */
	private void setCurrentObjects() {
<span class="nc bnc" id="L868" title="All 2 branches missed.">		if (m_customShiftRequest != null) {</span>
<span class="nc bnc" id="L869" title="All 4 branches missed.">			if (m_customShiftRequest.getShiftID() != null &amp;&amp; m_shifts != null) {</span>
<span class="nc bnc" id="L870" title="All 2 branches missed.">				for (Iterator it = m_shifts.iterator(); it.hasNext();) {</span>
<span class="nc" id="L871">					Shift shift = (Shift) it.next();</span>
<span class="nc bnc" id="L872" title="All 2 branches missed.">					if (shift.getID().equals(m_customShiftRequest.getShiftID())) {</span>
<span class="nc" id="L873">						m_shift = shift;</span>

<span class="nc bnc" id="L875" title="All 2 branches missed.">						if (m_reloadAction.equals(RELOAD_ACTION_SHIFT)) {</span>
							// The page was reloaded due to the user changing
							// the Shift selection. We must update the default
							// selected activity accordingly.
<span class="nc bnc" id="L879" title="All 4 branches missed.">							if (m_selectedDayIncludesRibbonSelection &amp;&amp; m_mostDeficientActivity1 != null) {</span>
<span class="nc" id="L880">								m_customShiftRequest.setActivityID(m_mostDeficientActivity1.getID());</span>
							} else {
<span class="nc" id="L882">								m_customShiftRequest.setActivityID(m_shift.getActivityID());</span>
							}
						}
						break;
					}
<span class="nc" id="L887">				}</span>
			}

<span class="nc bnc" id="L890" title="All 4 branches missed.">			if (m_customShiftRequest.getShiftID() == null &amp;&amp; m_shifts != null) {</span>
				// since no shift is selected, we'll select the first one by
				// default, and store the Shift and activityID
<span class="nc bnc" id="L893" title="All 2 branches missed.">				for (Iterator it = m_shifts.iterator(); it.hasNext();) {</span>
<span class="nc" id="L894">					m_shift = (Shift) it.next();</span>
<span class="nc" id="L895">					m_customShiftRequest.setShiftID(m_shift.getID());</span>
<span class="nc" id="L896">					ID activityID = m_shift.getActivityID();</span>
<span class="nc bnc" id="L897" title="All 4 branches missed.">					if (activityID != null &amp;&amp; m_activities != null) {</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">						for (Iterator actIt = m_activities.iterator(); actIt.hasNext();) {</span>
<span class="nc" id="L899">							Activity activity = (Activity) actIt.next();</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">							if (activity.getID().equals(activityID)) {</span>
<span class="nc" id="L901">								m_customShiftRequest.setActivityID(activityID);</span>
<span class="nc" id="L902">								break;</span>
							}
<span class="nc" id="L904">						}</span>
					}
					break; // we only want the first one
				}
			}

<span class="nc bnc" id="L910" title="All 4 branches missed.">			if (m_customShiftRequest.getExtBeforeID() != null &amp;&amp; m_extBeforeTypes != null) {</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">				for (Iterator it = m_extBeforeTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L912">					ShiftOTExtension ext = (ShiftOTExtension) it.next();</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">					if (ext.getID().equals(m_customShiftRequest.getExtBeforeID())) {</span>
<span class="nc" id="L914">						m_extBeforeType = ext;</span>

						// If the selected extension is the one originally
						// assigned, get the duration/activity from the
						// ShiftAssignment,
						// since it may be a custom duration/activity.
						// Otherwise, get the duration/activity from the
						// selected extension's template.
<span class="nc bnc" id="L922" title="All 2 branches missed.">						ID assignedExtID = (m_shiftAssignment == null) ? null</span>
<span class="nc" id="L923">								: m_shiftAssignment.getOTExtensionBeforeID();</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">						assignedExtID = (assignedExtID == null) ? CUSTOM_ID : assignedExtID;</span>
<span class="nc bnc" id="L925" title="All 4 branches missed.">						if (m_shiftAssignment != null &amp;&amp; ext.getID().equals(assignedExtID)) {</span>
<span class="nc" id="L926">							m_customShiftRequest.setExtBeforeDuration(</span>
<span class="nc" id="L927">									m_shiftAssignment.getExtensionBefore() - m_saGapBeforeDuration);</span>
							// only update activity when changing extType,
							// otherwise, keep extracted value
<span class="nc bnc" id="L930" title="All 2 branches missed.">							if (m_reloadAction.equals(RELOAD_ACTION_EXT_BEFORE)) {</span>
<span class="nc bnc" id="L931" title="All 4 branches missed.">								if (m_selectedDayIncludesRibbonSelection &amp;&amp; m_mostDeficientActivity1 != null) {</span>
<span class="nc" id="L932">									m_customShiftRequest.setExtBeforeActivityID(m_mostDeficientActivity1.getID());</span>
								} else {
<span class="nc" id="L934">									m_customShiftRequest</span>
<span class="nc" id="L935">											.setExtBeforeActivityID(m_shiftAssignment.getOTExtensionBeforeActivityID());</span>
								}
							}
						} else {
<span class="nc" id="L939">							m_customShiftRequest.setExtBeforeDuration(m_extBeforeType.getDuration());</span>
							// only update activity when changing extType,
							// otherwise, keep extracted value
<span class="nc bnc" id="L942" title="All 2 branches missed.">							if (m_reloadAction.equals(RELOAD_ACTION_EXT_BEFORE)) {</span>
<span class="nc bnc" id="L943" title="All 4 branches missed.">								if (m_selectedDayIncludesRibbonSelection &amp;&amp; m_mostDeficientActivity1 != null</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">										&amp;&amp; !ext.getID().equals(NONE_ID)) {</span>
<span class="nc" id="L945">									m_customShiftRequest.setExtBeforeActivityID(m_mostDeficientActivity1.getID());</span>
								} else {
<span class="nc" id="L947">									m_customShiftRequest.setExtBeforeActivityID(m_extBeforeType.getActivityID());</span>
								}
							}
						}

						break;
					}
<span class="nc" id="L954">				}</span>
			}

<span class="nc bnc" id="L957" title="All 4 branches missed.">			if (m_customShiftRequest.getExtAfterID() != null &amp;&amp; m_extAfterTypes != null) {</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">				for (Iterator it = m_extAfterTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L959">					ShiftOTExtension ext = (ShiftOTExtension) it.next();</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">					if (ext.getID().equals(m_customShiftRequest.getExtAfterID())) {</span>
<span class="nc" id="L961">						m_extAfterType = ext;</span>

						// If the selected extension is the one originally
						// assigned, get the duration/activity from the
						// ShiftAssignment,
						// since it may be a custom duration/activity.
						// Otherwise, get the duration/activity from the
						// selected extension's template.

<span class="nc bnc" id="L970" title="All 2 branches missed.">						Activity mostDeficientActivity = isNewShiftRequest() ? m_mostDeficientActivity1</span>
								: m_mostDeficientActivity2;

<span class="nc bnc" id="L973" title="All 2 branches missed.">						ID assignedExtID = (m_shiftAssignment == null) ? null</span>
<span class="nc" id="L974">								: m_shiftAssignment.getOTExtensionAfterID();</span>
<span class="nc bnc" id="L975" title="All 2 branches missed.">						assignedExtID = (assignedExtID == null) ? CUSTOM_ID : assignedExtID;</span>
<span class="nc bnc" id="L976" title="All 4 branches missed.">						if (m_shiftAssignment != null &amp;&amp; ext.getID().equals(assignedExtID)) {</span>
<span class="nc" id="L977">							m_customShiftRequest</span>
<span class="nc" id="L978">									.setExtAfterDuration(m_shiftAssignment.getExtensionAfter() - m_saGapAfterDuration);</span>
							// only update activity when changing extType,
							// otherwise, keep extracted value
<span class="nc bnc" id="L981" title="All 2 branches missed.">							if (m_reloadAction.equals(RELOAD_ACTION_EXT_AFTER)) {</span>
<span class="nc bnc" id="L982" title="All 4 branches missed.">								if (m_selectedDayIncludesRibbonSelection &amp;&amp; mostDeficientActivity != null) {</span>
<span class="nc" id="L983">									m_customShiftRequest.setExtAfterActivityID(mostDeficientActivity.getID());</span>
								} else {
<span class="nc" id="L985">									m_customShiftRequest</span>
<span class="nc" id="L986">											.setExtAfterActivityID(m_shiftAssignment.getOTExtensionAfterActivityID());</span>
								}
							}
						} else {
<span class="nc" id="L990">							m_customShiftRequest.setExtAfterDuration(m_extAfterType.getDuration());</span>
							// only update activity when changing extType,
							// otherwise, keep extracted value
<span class="nc bnc" id="L993" title="All 2 branches missed.">							if (m_reloadAction.equals(RELOAD_ACTION_EXT_AFTER)) {</span>
<span class="nc bnc" id="L994" title="All 4 branches missed.">								if (m_selectedDayIncludesRibbonSelection &amp;&amp; mostDeficientActivity != null</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">										&amp;&amp; !ext.getID().equals(NONE_ID)) {</span>
<span class="nc" id="L996">									m_customShiftRequest.setExtAfterActivityID(mostDeficientActivity.getID());</span>
								} else {
<span class="nc" id="L998">									m_customShiftRequest.setExtAfterActivityID(m_extAfterType.getActivityID());</span>
								}
							}
						}

						break;
					}
<span class="nc" id="L1005">				}</span>
			}
		}
<span class="nc" id="L1008">	}</span>

	/**
	 * Calculates the ShiftAssignment's duration, not counting the extensions.
	 * If there is no ShiftAssignment for the employee on the selected
	 * startDate, then we just return 0.
	 */
	protected int getShiftAssignmentDurationMinusExtensions() {
<span class="nc bnc" id="L1016" title="All 2 branches missed.">		if (m_shiftAssignment != null) {</span>
<span class="nc" id="L1017">			return (int) ((m_saMainShiftEndTime.getTime() - m_saMainShiftStartTime.getTime())</span>
					/ ShiftAssignment.MILLIS_IN_ONE_MIN);
		}

<span class="nc" id="L1021">		return 0;</span>
	}

	protected void setRequestStartEndBasedOnShiftAndDatePicker() {
<span class="nc bnc" id="L1025" title="All 2 branches missed.">		if (m_shift != null) // Even the &quot;&lt;Custom Shift&gt;&quot; has a Shift object</span>
		// representation
		{
			// set the shift start/end in the request object
<span class="nc" id="L1029">			Calendar cal = Calendar.getInstance(m_view_tz);</span>
<span class="nc bnc" id="L1030" title="All 6 branches missed.">			if (isRibbonMode() &amp;&amp; m_reloadAction.equals(RELOAD_ACTION_RIBBON) &amp;&amp; m_saMainShiftStartTime != null) {</span>
<span class="nc" id="L1031">				cal.setTime(m_saMainShiftStartTime);</span>
<span class="nc" id="L1032">				m_datePickerPC.setDate(cal.getTime());</span>
			} else {
<span class="nc" id="L1034">				cal.setTime(m_datePickerPC.getDate());</span>
			}
<span class="nc" id="L1036">			cal.set(Calendar.HOUR_OF_DAY, m_timePickerPC.getTimeInMinutes() / NO_MINUTES_IN_HOUR);</span>
<span class="nc" id="L1037">			cal.set(Calendar.MINUTE, m_timePickerPC.getTimeInMinutes() % NO_MINUTES_IN_HOUR);</span>
<span class="nc" id="L1038">			m_customShiftRequest.setShiftStartTime(cal.getTime());</span>

			int duration;
<span class="nc bnc" id="L1041" title="All 2 branches missed.">			ID assignedShiftID = (m_shiftAssignment == null) ? new ID(&quot;xxx&quot;)</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">					: (m_shiftAssignment.getShiftID() == null ? CUSTOM_ID : m_shiftAssignment.getShiftID());</span>

<span class="nc bnc" id="L1044" title="All 4 branches missed.">			if ((m_shiftAssignment != null) &amp;&amp; (assignedShiftID.equals(m_shift.getID()))) {</span>
				// ShiftAssignment takes precedence over Shift template when the
				// originally assigned Shift is selected
<span class="nc" id="L1047">				duration = getShiftAssignmentDurationMinusExtensions();</span>
			} else {
<span class="nc" id="L1049">				duration = m_shift.getDuration(); // get the duration from the</span>
				// currently selected Shift
				// template
			}

<span class="nc" id="L1054">			cal.add(Calendar.MINUTE, duration);</span>
<span class="nc" id="L1055">			m_customShiftRequest.setShiftEndTime(cal.getTime());</span>
		}

		// make sure the shift start/end are set
<span class="nc bnc" id="L1059" title="All 2 branches missed.">		if (m_customShiftRequest.getShiftStartTime() == null) {</span>
<span class="nc" id="L1060">			m_customShiftRequest.setShiftStartTime(m_datePickerPC.getDate());</span>
		}

<span class="nc bnc" id="L1063" title="All 2 branches missed.">		if (m_customShiftRequest.getShiftEndTime() == null) {</span>
<span class="nc" id="L1064">			m_customShiftRequest.setShiftEndTime(m_datePickerPC.getDate());</span>
		}
<span class="nc" id="L1066">	}</span>

	protected void setStartTimePickerBasedOnRequest() {
<span class="nc" id="L1069">		Calendar cal = Calendar.getInstance(m_view_tz);</span>
<span class="nc" id="L1070">		cal.setTime(m_customShiftRequest.getShiftStartTime());</span>
<span class="nc" id="L1071">		int hours = cal.get(Calendar.HOUR_OF_DAY);</span>
<span class="nc" id="L1072">		int minutes = cal.get(Calendar.MINUTE);</span>
<span class="nc" id="L1073">		m_timePickerPC.setTime((hours * 60 + minutes) * 60); // set the number</span>
		// of seconds since
		// midnight
<span class="nc" id="L1076">	}</span>

	/**
	 * Reset a TimePickerPC page component
	 */
	private void resetTimePickerPC(TimePickerPC picker, String name) {
<span class="nc" id="L1082">		picker.reset();</span>
<span class="nc" id="L1083">		picker.setTimeInterval(TIME_INTERVAL);</span>
		// m_timePickerPC.setIsInputValueOptional(true);
<span class="nc" id="L1085">		picker.setOnChangeJS(reloadWithAction(RELOAD_ACTION_TIME));</span>
<span class="nc" id="L1086">		picker.setInputFieldName(name);</span>
<span class="nc" id="L1087">		picker.setTitle(i18n(m_bundle, RmWebBundleKey.CSR_START_TIME));</span>
<span class="nc" id="L1088">	}</span>

	/**
	 * Create and add Date Range Picker as Child Component
	 */
	private void initDateAndTimePickers() {
<span class="nc" id="L1094">		Calendar cal = Calendar.getInstance(m_view_tz);</span>
<span class="nc" id="L1095">		cal.add(Calendar.DATE, -1); // yesterday's date</span>

<span class="nc" id="L1097">		m_datePickerPC = new DatePickerPC(m_context, SHIFT_START_DATE, m_view_tz, false);</span>
		// PSR for American Airline: with Advanced RM license, allow to request
		// a customer shift which could even happen in the past
<span class="nc bnc" id="L1100" title="All 2 branches missed.">		if(!LicenseUtil.isAdvancedRMLicense()) {</span>
<span class="nc" id="L1101">			m_datePickerPC.setLowerLimit(cal.getTime()); // lower limit is yesterday</span>
		}

		// to allow user to extend
		// shift that crosses day
		// boundary into today.
<span class="nc" id="L1107">		m_datePickerPC.setIsTimeEnabled(false);</span>

		// set upper date limit to 12/31/2078
<span class="nc" id="L1110">		cal.set(2078, 11, 31, 23, 59, 59);</span>
<span class="nc" id="L1111">		m_datePickerPC.setUpperLimit(cal.getTime());</span>
<span class="nc" id="L1112">		m_datePickerPC.setOnChangeJS(reloadWithAction(RELOAD_ACTION_DATE));</span>
<span class="nc" id="L1113">		addChildComponent(m_datePickerPC);</span>

<span class="nc" id="L1115">		m_timePickerPC = new TimePickerPC(m_context);</span>
<span class="nc" id="L1116">		resetTimePickerPC(m_timePickerPC, SHIFT_START_TIME);</span>
<span class="nc" id="L1117">		addChildComponent(m_timePickerPC);</span>
<span class="nc" id="L1118">	}</span>

	/**
	 * Get a Pair of Dates, where the first one is the start of the currently
	 * selected day, and the second one is the end of the currently selected
	 * day. This range does NOT take the selected startTime into consideration.
	 * Like the schedule view pages, this range is NOT aligned with org day
	 * boundary.
	 *
	 * @param existingRequest
	 *            - if null, we will get the current day set in the
	 *            m_datePickerPC. If not null, we will get the day from the
	 *            existingRequest. However, if we are in RIBBON mode, we
	 *            determine the date from m_ribbonStartDate.
	 */
	public Pair getFromToDates(CustShiftReq existingRequest) {
		Date date;

<span class="nc bnc" id="L1136" title="All 4 branches missed.">		if ((isRibbonMode()) &amp;&amp; (m_reloadAction.equals(RELOAD_ACTION_RIBBON))) {</span>
<span class="nc" id="L1137">			date = m_ribbonStartDate; // first time from ribbon selection</span>
<span class="nc bnc" id="L1138" title="All 2 branches missed.">		} else if (existingRequest == null) {</span>
<span class="nc" id="L1139">			date = m_datePickerPC.getDate();</span>
		} else {
<span class="nc" id="L1141">			date = existingRequest.getShiftStartTime(); // getShiftStartTimeFromExistingRequest(existingRequest);</span>
		}

<span class="nc" id="L1144">		Pair dates = CustomShiftUtil.getFullDayRange(date, m_view_tz);</span>
<span class="nc" id="L1145">		m_datePickerPC.setDate((Date) dates.getFirst());</span>
<span class="nc" id="L1146">		return dates;</span>
	}

	/**
	 *
	 * @param existingRequest
	 * @param sa
	 *            - the ShiftAssignment (if any) on this day
	 * @return
	 *
	 * 		public static Date
	 *         getShiftStartTimeFromExistingRequest(CustShiftReq
	 *         existingRequest) //, ShiftAssignment sa) { Date date = null; if
	 *         (existingRequest.getShiftStartTime() != null) { //This is either
	 *         a New Shift request, or a Shift Change request where something in
	 *         the main shift //has changed (either strartTime or ShiftID).
	 *         Either way, the shiftStartTime is known. date =
	 *         existingRequest.getShiftStartTime(); } else if
	 *         (existingRequest.getExtBeforeID() != null) { //This is a Shift
	 *         Change request where they are adding a new extension before. //we
	 *         need to add the extBefore duration+gap to the startTime to get
	 *         the shiftStartTime date = existingRequest.getStartTime(); //this
	 *         should never be null since it is the &quot;delta&quot; start time ... }
	 *         else if (existingRequest.getExtAfterID() != null) { //This is a
	 *         Shift Change request where they are only adding a new extension
	 *         after. //We need to get the ShiftAssignment.getStartTime() date.
	 *         }
	 *
	 *         return date; }
	 */

	/**
	 * Set first day of week using org week start
	 */
	private void setDatePickerWeekStarts(ID orgID) throws Exception {
<span class="nc" id="L1181">		Organization org = OrganizationModelHandler.getOrganization(m_context, orgID);</span>

<span class="nc" id="L1183">		m_datePickerPC.setFirstDayOfWeek(org.getWeekStartDate());</span>

<span class="nc" id="L1185">		Calendar startCal = Calendar.getInstance(m_view_tz);</span>

		/*
		 * set the default time to use organization day boundary int
		 * dayBoundaryOffset = org.getDayBoundaryOffset(); startCal.setTime(new
		 * Date()); startCal.set(Calendar.HOUR_OF_DAY, dayBoundaryOffset/60);
		 * startCal.set(Calendar.MINUTE, dayBoundaryOffset%60); if
		 * (startCal.getTime().before(new Date())) startCal.add(Calendar.DATE,
		 * 1);
		 */
<span class="nc" id="L1195">		CustomShiftUtil.setTimeToMidnight(startCal);</span>

<span class="nc" id="L1197">		m_datePickerPC.setDefaultDisplayDate(startCal.getTime(), m_view_tz);</span>
<span class="nc bnc" id="L1198" title="All 2 branches missed.">		if (m_datePickerPC.getDate() == null) {</span>
<span class="nc" id="L1199">			m_datePickerPC.setDate(startCal.getTime());</span>
		}
<span class="nc" id="L1201">	}</span>

	/**
	 * Disable Date Picker to Read Only
	 */
	private void disableDatePickerPC() {
<span class="nc" id="L1207">		m_datePickerPC.setIsPickerEnabled(false);</span>
<span class="nc" id="L1208">		m_datePickerPC.setInputType(DatePickerPC.INPUT_TYPE_READONLY);</span>
<span class="nc" id="L1209">	}</span>

	/**
	 * Disable Time Picker to Read Only
	 */
	private void disableTimePickerPC() {
<span class="nc" id="L1215">		m_timePickerPC.setIsPickerEnabled(false);</span>
<span class="nc" id="L1216">		m_timePickerPC.setInputType(DatePickerPC.INPUT_TYPE_READONLY);</span>
<span class="nc" id="L1217">	}</span>

	/**
	 * Prepare content title for rendering
	 */
	protected void initContentTitle() {
<span class="nc bnc" id="L1223" title="All 2 branches missed.">		String rbKey = isNew() ? RmWebBundleKey.CREATE_NEW_REQUEST : RmWebBundleKey.EDIT_REQUEST;</span>
<span class="nc" id="L1224">		String pageTitle = i18n(m_bundle, rbKey);</span>

<span class="nc" id="L1226">		String itemName = i18n(m_bundle, RmWebBundleKey.REQUEST_TYPE_CUSTOM_SHIFT);</span>
<span class="nc" id="L1227">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="nc" id="L1228">		m_contentTitlePC.setItemName(itemName);</span>
<span class="nc" id="L1229">	}</span>

	/**
	 * Initialize Content
	 */
	private void initContent() {
<span class="nc bnc" id="L1235" title="All 2 branches missed.">		if (m_isRequestSaved) {</span>
<span class="nc" id="L1236">			RequestUtil.addSavedRequestMsg(m_customShiftRequest, this);</span>
		}

<span class="nc bnc" id="L1239" title="All 4 branches missed.">		if (isManagerMode() &amp;&amp; m_empNames.isEmpty()) {</span>
<span class="nc" id="L1240">			String[] args = new String[1];</span>
<span class="nc" id="L1241">			args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context,</span>
					DefaultVerticalizationManager.WORKERS);

<span class="nc" id="L1244">			addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.CSR_WARNING_NO_PRIV_FOR_REQ_CREATION,</span>
					RmWebBundleKey.BUNDLE_NAME, args);
<span class="nc" id="L1246">			handleError();</span>
<span class="nc" id="L1247">		} else {</span>
<span class="nc" id="L1248">			boolean enableToolbar = initContentAnalyzeState();</span>

<span class="nc bnc" id="L1250" title="All 2 branches missed.">			if (m_isAuthorized) {</span>
<span class="nc" id="L1251">				initMainList();</span>
<span class="nc" id="L1252">				initExtBeforeList();</span>
<span class="nc" id="L1253">				initExtAfterList();</span>
<span class="nc" id="L1254">				initAlertList();</span>
			}

<span class="nc bnc" id="L1257" title="All 2 branches missed.">			if (enableToolbar) {</span>
<span class="nc" id="L1258">				initToolbar(true);</span>
			} else {
<span class="nc" id="L1260">				addCancelButton();</span>
			}
		}
<span class="nc" id="L1263">	}</span>

	/**
	 * Goes over the various configurations and settings for the form and sets page messages.
	 * This was abstracted out of initContent so it could be shared by the REST services until we have time to refactor this logic.
	 *
	 * @return
	 *         Returns whether the toolbar should be enabled/it can be saved.
	 */
	protected boolean initContentAnalyzeState() {
<span class="nc" id="L1273">		boolean enableToolbar = true;</span>

<span class="nc bnc" id="L1275" title="All 4 branches missed.">		if (!m_allowShiftChanges &amp;&amp; !m_allowNewShifts) {</span>
<span class="nc" id="L1276">			addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.CSR_CUSTOM_SHIFT_NOT_ENABLED,</span>
					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1278">			enableToolbar = false;</span>
<span class="nc bnc" id="L1279" title="All 2 branches missed.">		} else if (m_spID == null) {</span>
<span class="nc" id="L1280">			addPageMessage(Message.WARNING_TYPE,</span>
<span class="nc bnc" id="L1281" title="All 2 branches missed.">					isManagerMode() ? RmWebBundleKey.CSR_WARNING_NO_SCHEDULING_PERIOD</span>
							: RmWebBundleKey.CSR_WARNING_NO_SCHEDULING_PERIOD_FOR_AGENT,
					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1284">			enableToolbar = false;</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">		} else if (m_shifts.isEmpty()) {</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">			addPageMessage(Message.WARNING_TYPE, isManagerMode() ? RmWebBundleKey.CSR_WARNING_NO_SHIFTS</span>
					: RmWebBundleKey.CSR_WARNING_NO_SHIFTS_FOR_AGENT, RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1288">			enableToolbar = false;</span>
<span class="nc bnc" id="L1289" title="All 4 branches missed.">		} else if (isNewShiftRequest() &amp;&amp; !m_allowNewShifts) {</span>
<span class="nc" id="L1290">			addPageMessage(Message.WARNING_TYPE,</span>
<span class="nc bnc" id="L1291" title="All 2 branches missed.">					(isManagerMode() ? RmWebBundleKey.CSR_WARNING_NEW_SHIFTS_NOT_ALLOWED</span>
							: RmWebBundleKey.CSR_WARNING_NEW_SHIFTS_NOT_ALLOWED_FOR_AGENT),
					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1294">			enableToolbar = false;</span>
<span class="nc bnc" id="L1295" title="All 4 branches missed.">		} else if (isShiftChangeRequest() &amp;&amp; !m_allowShiftChanges) {</span>
<span class="nc" id="L1296">			addPageMessage(Message.WARNING_TYPE,</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">					(isManagerMode() ? RmWebBundleKey.CSR_WARNING_SHIFT_CHANGES_NOT_ALLOWED</span>
							: RmWebBundleKey.CSR_WARNING_SHIFT_CHANGES_NOT_ALLOWED_FOR_AGENT),
					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1300">			enableToolbar = false;</span>
<span class="nc bnc" id="L1301" title="All 4 branches missed.">		} else if (nothingIsEditableDueToNoDeficientActivities() &amp;&amp; (m_reloadAction != RELOAD_ACTION_SAVE)) { // QC94735</span>
<span class="nc bnc" id="L1302" title="All 2 branches missed.">			if (isNewShiftRequest()) {</span>
<span class="nc" id="L1303">				addPageMessage(Message.WARNING_TYPE,</span>
						RmWebBundleKey.CSR_WARNING_NO_DEFICIENT_ACTIVITIES_FOR_NEW_SHIFT,
						RmWebBundleKey.BUNDLE_NAME);
				// Empty out the list of shifts. The activities list will
				// already be empty. The extensions lists will already be
				// set to None.
<span class="nc" id="L1309">				m_shifts.clear();</span>
			} else {
<span class="nc" id="L1311">				addPageMessage(Message.WARNING_TYPE,</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">						isManagerMode() ? RmWebBundleKey.CSR_WARNING_NO_DEFICIENT_ACTIVITIES_FOR_SHIFT_CHANGE</span>
								: RmWebBundleKey.CSR_WARNING_NO_DEFICIENT_ACTIVITIES_FOR_SHIFT_CHANGE_FOR_AGENT,
						RmWebBundleKey.BUNDLE_NAME);
			}
<span class="nc" id="L1316">			enableToolbar = false;</span>
<span class="nc bnc" id="L1317" title="All 4 branches missed.">		} else if (nothingIsEditable() &amp;&amp; (m_reloadAction != RELOAD_ACTION_SAVE)) { // QC94735</span>
<span class="nc" id="L1318">			addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.CSR_WARNING_NOTHING_EDITABLE,</span>
					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1320">			enableToolbar = false;</span>
<span class="nc bnc" id="L1321" title="All 4 branches missed.">		} else if (!isExtBeforeEditable() &amp;&amp; isExtAfterEditable()) {</span>
<span class="nc bnc" id="L1322" title="All 2 branches missed.">			if (!isShiftEditable()) {</span>
<span class="nc" id="L1323">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_EXT_AFTER_EDITABLE,</span>
						RmWebBundleKey.BUNDLE_NAME);
			} else {
<span class="nc" id="L1326">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_SHIFT_AND_EXT_AFTER_EDITABLE,</span>
						RmWebBundleKey.BUNDLE_NAME);
			}
<span class="nc bnc" id="L1329" title="All 4 branches missed.">		} else if (isExtBeforeEditable() &amp;&amp; !isExtAfterEditable()) {</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">			if (!isShiftEditable()) {</span>
<span class="nc" id="L1331">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_EXT_BEFORE_EDITABLE,</span>
						RmWebBundleKey.BUNDLE_NAME);
			} else {
<span class="nc" id="L1334">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_SHIFT_AND_EXT_BEFORE_EDITABLE,</span>
						RmWebBundleKey.BUNDLE_NAME);
			}
		}

<span class="nc bnc" id="L1339" title="All 2 branches missed.">		if (!m_isAuthorized) {</span>
<span class="nc" id="L1340">			addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_UNAUTHORIZED_TO_CREATE_CS_REQUEST,</span>
					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1342">			enableToolbar = false;</span>
		}

<span class="nc" id="L1345">		return enableToolbar;</span>
	}

	/**
	 * Return Employee Name Drop Down
	 */
	private String createEmpNameDD() {
<span class="nc bnc" id="L1352" title="All 2 branches missed.">		if (m_empNames.isEmpty()) {</span>
<span class="nc" id="L1353">			return &quot;&quot;;</span>
		}

<span class="nc" id="L1356">		ID selectedID = getRequestedFor();</span>

		// If there is only a single employee name or request has Escalated
		// Status, then just return it as text
<span class="nc bnc" id="L1360" title="All 4 branches missed.">		if (m_empNames.size() == 1 || isEscalatedRequest()) {</span>
<span class="nc" id="L1361">			EmployeeName eName = findEmpNameByID(selectedID);</span>
<span class="nc" id="L1362">			return m_localizer.formatName(eName) + HtmlUtil.makeHiddenInput(REQUESTED_FOR_FN, eName.getID().toString());</span>
		}

		// Create Employee Name Drop Down
<span class="nc" id="L1366">		List sortedENames = new ArrayList(m_empNames);</span>
<span class="nc" id="L1367">		PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>
<span class="nc" id="L1368">		int listSize = sortedENames.size();</span>
<span class="nc" id="L1369">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1370" title="All 2 branches missed.">		for (Iterator it = sortedENames.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1371">			EmployeeName eName = (EmployeeName) it.next();</span>
<span class="nc" id="L1372">			String id = eName.getID().toString();</span>
<span class="nc" id="L1373">			String display = m_localizer.formatName(eName);</span>
<span class="nc" id="L1374">			StringsPair option = new StringsPair(id, display);</span>
<span class="nc" id="L1375">			options.add(option);</span>
<span class="nc" id="L1376">		}</span>

<span class="nc bnc" id="L1378" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot; : selectedID.toString();</span>
<span class="nc" id="L1379">		return HtmlUtil.makeSelectInput(REQUESTED_FOR_FN, selectedValue, reloadWithAction(RELOAD_ACTION_EMPLOYEE),</span>
				options, false);
	}

	/**
	 * Return Shift Drop Down
	 */
	private String createShiftDD() {
<span class="nc" id="L1387">		ID selectedID = getShiftID();</span>

<span class="nc" id="L1389">		CustomShiftUtil.sort(m_shifts, true, m_localeContext);</span>
<span class="nc" id="L1390">		int listSize = m_shifts.size();</span>
<span class="nc" id="L1391">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1392" title="All 2 branches missed.">		for (Iterator it = m_shifts.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1393">			Shift shift = (Shift) it.next();</span>
<span class="nc" id="L1394">			StringsPair option = new StringsPair(shift.getID().toString(), shift.getName());</span>
<span class="nc" id="L1395">			options.add(option);</span>
<span class="nc" id="L1396">		}</span>

<span class="nc bnc" id="L1398" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot; : selectedID.toString();</span>
<span class="nc" id="L1399">		return HtmlUtil.makeSelectInput(SHIFTID, new String[] { selectedValue }, reloadWithAction(RELOAD_ACTION_SHIFT),</span>
<span class="nc" id="L1400">				options, false, isShiftEditable());</span>
	}

	/**
	 * Return Activity Drop Down
	 */
	private String createActivityDD() {
<span class="nc" id="L1407">		ID selectedID = getActivityID();</span>

<span class="nc" id="L1409">		CustomShiftUtil.sort(m_activities, true, m_localeContext);</span>
<span class="nc" id="L1410">		int listSize = m_activities.size();</span>
<span class="nc" id="L1411">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">		for (Iterator it = m_activities.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1413">			Activity activity = (Activity) it.next();</span>
<span class="nc" id="L1414">			StringsPair option = new StringsPair(activity.getID().toString(), activity.getName());</span>
<span class="nc" id="L1415">			options.add(option);</span>
<span class="nc" id="L1416">		}</span>

<span class="nc bnc" id="L1418" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot; : selectedID.toString();</span>

<span class="nc" id="L1420">		return HtmlUtil.makeSelectInput(ACTIVITYID, new String[] { selectedValue }, JSUtil.ON_CHANGE, options, false,</span>
<span class="nc" id="L1421">				isActivityEditable());</span>
	}

	/**
	 * Return Extension Before Type Drop Down. Do we need to enforce MINGAP,
	 * MAXGAP? This would only be enforced when his current gap duration is not
	 * customized to break the template rules. If it is customized, then we
	 * should disable Gap validation?
	 *
	 * Regardless, we probably need a JavaScript map of
	 * shiftOTExtensionID-&gt;[ActivityID, Duration, MinGap?, MaxGap?]. This would
	 * be used to update Activity, Duration whenever shiftOTExtension selection
	 * changes. The user could then override the default Activity.
	 */
	private String createExtBeforeTypeDD() {
<span class="nc" id="L1436">		ID selectedID = getExtBeforeID();</span>

<span class="nc" id="L1438">		CustomShiftUtil.sort(m_extBeforeTypes, true, m_localeContext);</span>
<span class="nc" id="L1439">		int listSize = m_extBeforeTypes.size();</span>
<span class="nc" id="L1440">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1441" title="All 2 branches missed.">		for (Iterator it = m_extBeforeTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1442">			ShiftOTExtension ext = (ShiftOTExtension) it.next();</span>
<span class="nc" id="L1443">			StringsPair option = new StringsPair(ext.getID().toString(), ext.getName());</span>
<span class="nc" id="L1444">			options.add(option);</span>
<span class="nc" id="L1445">		}</span>

<span class="nc bnc" id="L1447" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot; : selectedID.toString();</span>

<span class="nc bnc" id="L1449" title="All 2 branches missed.">		addJSVariable(&quot;saHasExtBefore&quot;, doesShiftAssignmentHaveAnExtBefore() ? &quot;true&quot; : &quot;false&quot;); // this</span>
		// is
		// for
		// javascript
		// validation
<span class="nc bnc" id="L1454" title="All 2 branches missed.">		addJSVariable(&quot;isExtBeforeEnablable&quot;, isExtBeforeEnablable() ? &quot;true&quot; : &quot;false&quot;);</span>

<span class="nc" id="L1456">		return HtmlUtil.makeSelectInput(EXT_BEFORE_ID, new String[] { selectedValue },</span>
<span class="nc" id="L1457">				reloadWithAction(RELOAD_ACTION_EXT_BEFORE), options, false, isExtBeforeEditable());</span>
	}

	/**
	 * Return Extension Before Activity Drop Down
	 */
	private String createExtBeforeActivityDD() {
<span class="nc" id="L1464">		ID selectedID = getExtBeforeActivityID();</span>

<span class="nc" id="L1466">		CustomShiftUtil.sort(m_extBeforeActivities, true, m_localeContext);</span>
<span class="nc" id="L1467">		int listSize = m_extBeforeActivities.size();</span>
<span class="nc" id="L1468">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1469" title="All 2 branches missed.">		for (Iterator it = m_extBeforeActivities.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1470">			Activity act = (Activity) it.next();</span>
<span class="nc" id="L1471">			StringsPair option = new StringsPair(act.getID().toString(), act.getName());</span>
<span class="nc" id="L1472">			options.add(option);</span>
<span class="nc" id="L1473">		}</span>

<span class="nc bnc" id="L1475" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? NONE_ID.toString() : selectedID.toString();</span>

<span class="nc" id="L1477">		return HtmlUtil.makeSelectInput(EXT_BEFORE_ACTIVITY_ID, new String[] { selectedValue }, JSUtil.ON_CHANGE,</span>
<span class="nc" id="L1478">				options, false, isExtBeforeEditableAndNotSetToNone());</span>
	}

	private boolean isExtBeforeEditableAndNotSetToNone() {
<span class="nc bnc" id="L1482" title="All 4 branches missed.">		return isExtBeforeEditable() &amp;&amp; !isExtBeforeSetToNone();</span>
	}

	private boolean isExtBeforeSetToNone() {
<span class="nc bnc" id="L1486" title="All 4 branches missed.">		return m_customShiftRequest.getExtBeforeID() == null || m_customShiftRequest.getExtBeforeID().equals(NONE_ID);</span>
	}

	private boolean isExtAfterEditableAndNotSetToNone() {
<span class="nc bnc" id="L1490" title="All 4 branches missed.">		return isExtAfterEditable() &amp;&amp; !isExtAfterSetToNone();</span>
	}

	private boolean isExtAfterSetToNone() {
<span class="nc bnc" id="L1494" title="All 4 branches missed.">		return m_customShiftRequest.getExtAfterID() == null || m_customShiftRequest.getExtAfterID().equals(NONE_ID);</span>
	}

	/**
	 * Return Extension After Type Drop Down
	 */
	private String createExtAfterTypeDD() {
<span class="nc" id="L1501">		ID selectedID = getExtAfterID();</span>

<span class="nc" id="L1503">		CustomShiftUtil.sort(m_extAfterTypes, true, m_localeContext);</span>
<span class="nc" id="L1504">		int listSize = m_extAfterTypes.size();</span>
<span class="nc" id="L1505">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1506" title="All 2 branches missed.">		for (Iterator it = m_extAfterTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1507">			ShiftOTExtension ext = (ShiftOTExtension) it.next();</span>
<span class="nc" id="L1508">			StringsPair option = new StringsPair(ext.getID().toString(), ext.getName());</span>
<span class="nc" id="L1509">			options.add(option);</span>
<span class="nc" id="L1510">		}</span>

<span class="nc bnc" id="L1512" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot; : selectedID.toString();</span>

<span class="nc bnc" id="L1514" title="All 2 branches missed.">		addJSVariable(&quot;saHasExtAfter&quot;, doesShiftAssignmentHaveAnExtAfter() ? &quot;true&quot; : &quot;false&quot;); // this</span>
		// is
		// for
		// javascript
		// validation
<span class="nc bnc" id="L1519" title="All 2 branches missed.">		addJSVariable(&quot;isExtAfterEnablable&quot;, isExtAfterEnablable() ? &quot;true&quot; : &quot;false&quot;);</span>

<span class="nc" id="L1521">		return HtmlUtil.makeSelectInput(EXT_AFTER_ID, new String[] { selectedValue },</span>
<span class="nc" id="L1522">				reloadWithAction(RELOAD_ACTION_EXT_AFTER), options, false, isExtAfterEditable());</span>
	}

	/**
	 * Return Extension After Activity Drop Down
	 */
	private String createExtAfterActivityDD() {
<span class="nc" id="L1529">		ID selectedID = getExtAfterActivityID();</span>

<span class="nc" id="L1531">		CustomShiftUtil.sort(m_extAfterActivities, true, m_localeContext);</span>
<span class="nc" id="L1532">		int listSize = m_extAfterActivities.size();</span>
<span class="nc" id="L1533">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1534" title="All 2 branches missed.">		for (Iterator it = m_extAfterActivities.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1535">			Activity act = (Activity) it.next();</span>
<span class="nc" id="L1536">			StringsPair option = new StringsPair(act.getID().toString(), act.getName());</span>
<span class="nc" id="L1537">			options.add(option);</span>
<span class="nc" id="L1538">		}</span>

<span class="nc bnc" id="L1540" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? NONE_ID.toString() : selectedID.toString();</span>

<span class="nc" id="L1542">		return HtmlUtil.makeSelectInput(EXT_AFTER_ACTIVITY_ID, new String[] { selectedValue }, JSUtil.ON_CHANGE,</span>
<span class="nc" id="L1543">				options, false, isExtAfterEditableAndNotSetToNone());</span>
	}

	protected boolean doesShiftAssignmentHaveAnExtBefore() {
<span class="nc bnc" id="L1547" title="All 4 branches missed.">		return m_shiftAssignment != null &amp;&amp; m_shiftAssignment.getExtensionBefore() &gt; 0</span>
<span class="nc bnc" id="L1548" title="All 2 branches missed.">				&amp;&amp; m_shiftAssignment.getOTExtensionBeforeActivityID() != null;</span>
	}

	protected boolean doesShiftAssignmentHaveAnExtAfter() {
<span class="nc bnc" id="L1552" title="All 4 branches missed.">		return m_shiftAssignment != null &amp;&amp; m_shiftAssignment.getExtensionAfter() &gt; 0</span>
<span class="nc bnc" id="L1553" title="All 2 branches missed.">				&amp;&amp; m_shiftAssignment.getOTExtensionAfterActivityID() != null;</span>
	}

	/**
	 * Create Comment History Page Component
	 */
	private MessagePC createCommentHistoryPC() {
<span class="nc" id="L1560">		MessagePC msgPC = RequestUtil.createCmntMsgPC(m_context, &quot;510px&quot;, &quot;50px&quot;, &quot;&quot;);</span>
<span class="nc" id="L1561">		Collection msgs = RequestUtil.getCommentsAsMessages(m_customShiftRequest);</span>
<span class="nc" id="L1562">		msgPC.addMessage(msgs);</span>
<span class="nc" id="L1563">		return msgPC;</span>
	}

	/**
	 * Initialize Main list container
	 */
	private void initMainList() {
<span class="nc" id="L1570">		m_shiftContainerPC = new Collapsible2ColFormPC(m_context);</span>
<span class="nc" id="L1571">		m_shiftContainerPC.setTitle(i18n(m_bundle, RmWebBundleKey.SHIFTTYPE_SHIFT));</span>
<span class="nc" id="L1572">		m_shiftContainerPC.setName(RmWebBundleKey.SHIFTTYPE_SHIFT);</span>
<span class="nc" id="L1573">		m_shiftContainerPC.setCollapsed(getShiftSectionCollapsed());</span>
<span class="nc" id="L1574">		m_shiftContainerPC.setTableSummary(i18n(m_bundle, RmWebBundleKey.SHIFT_DETAILS_TABLE));</span>

<span class="nc bnc" id="L1576" title="All 2 branches missed.">		if (isManagerMode()) {</span>
<span class="nc" id="L1577">			String empNameLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.EMPLOYEE_NAME_LABEL),</span>
					REQUESTED_FOR_FN);
<span class="nc" id="L1579">			m_shiftContainerPC.addRow(empNameLabel, createEmpNameDD());</span>
		}

		// Add the Start Date row
<span class="nc" id="L1583">		createAndAddDatePickerRow();</span>

		// Add the Start Time row
<span class="nc" id="L1586">		createAndAddTimePickerRow();</span>

		// Add the Shift selector row
<span class="nc" id="L1589">		String shiftLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.RM_SA_FILTER_SHIFT), SHIFTID);</span>
<span class="nc" id="L1590">		m_shiftContainerPC.addRow(shiftLabel, createShiftDD());</span>

		// Add the Duration row
<span class="nc" id="L1593">		m_shiftContainerPC.addRow(i18n(m_bundle, RmWebBundleKey.CSR_DURATION),</span>
<span class="nc" id="L1594">				CustomShiftUtil.getDurationString(m_customShiftRequest, m_localizer));</span>

		// Add the End Date row
<span class="nc" id="L1597">		m_shiftContainerPC.addRow(i18n(m_bundle, RmWebBundleKey.CSR_END_DATE),</span>
<span class="nc" id="L1598">				CustomShiftUtil.getShiftEndDateString(m_customShiftRequest, m_localizer, m_view_tz));</span>

		// Add the Activity selector row
<span class="nc" id="L1601">		String activityLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.RM_SA_FILTER_ACTIVITY), ACTIVITYID);</span>
<span class="nc" id="L1602">		m_shiftContainerPC.addRow(activityLabel, createActivityDD());</span>

		// Add the OT/Regular shift checkbox row
<span class="nc" id="L1605">		createAndAddOvertimeRow();</span>

		// Add the Comment History row
<span class="nc bnc" id="L1608" title="All 2 branches missed.">		if (!isNew()) {</span>
<span class="nc" id="L1609">			m_shiftContainerPC.addRow(i18n(m_common_bundle, UIFWebBundleKey.COMMENT_HISTORY), createCommentHistoryPC());</span>
		}

		// Add the Comment row
<span class="nc" id="L1613">		String commentUI = RequestUtil.createCommentUI(COMMENT_FN, getComment(), 100, 3, this, nothingIsEditable(),</span>
<span class="nc" id="L1614">				i18n(m_common_bundle, UIFWebBundleKey.ADD_COMMENT));</span>
<span class="nc" id="L1615">		m_shiftContainerPC.addRow(i18n(m_common_bundle, UIFWebBundleKey.ADD_COMMENT), commentUI);</span>

<span class="nc" id="L1617">		m_containerList.add(m_shiftContainerPC);</span>
<span class="nc" id="L1618">	}</span>

	/**
	 * Initialize the Extension Before list container
	 */
	private void initExtBeforeList() {
<span class="nc" id="L1624">		String firstTitle = i18n(m_bundle, RmWebBundleKey.CSR_EXTENSION_BEFORE_SHIFT);</span>
		// String secondTitle = i18n(m_bundle,
		// RmWebBundleKey.CSR_EXTENSION_AFTER_SHIFT);
<span class="nc" id="L1627">		m_extBeforeContainerPC = new Collapsible2ColFormPC(m_context);</span>
<span class="nc" id="L1628">		m_extBeforeContainerPC.setTitle(firstTitle);</span>
<span class="nc" id="L1629">		m_extBeforeContainerPC.setName(RmWebBundleKey.CSR_EXTENSION_BEFORE_SHIFT);</span>
<span class="nc" id="L1630">		m_extBeforeContainerPC.setCollapsed(getExtBeforeSectionCollapsed());</span>
<span class="nc" id="L1631">		m_extBeforeContainerPC.setTableSummary(i18n(m_bundle, RmWebBundleKey.EXTENSION_BEFORE_SHIFT_TABLE));</span>

		// Before Type selector
<span class="nc" id="L1634">		String typeLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.CSR_TYPE), EXT_BEFORE_ID);</span>
<span class="nc" id="L1635">		m_extBeforeContainerPC.addRow(typeLabel, createExtBeforeTypeDD());</span>

		// Before Activity selector
<span class="nc" id="L1638">		String activityLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.RM_SA_FILTER_ACTIVITY),</span>
				EXT_BEFORE_ACTIVITY_ID);
<span class="nc" id="L1640">		m_extBeforeContainerPC.addRow(activityLabel, createExtBeforeActivityDD());</span>

		// Before Duration string
<span class="nc" id="L1643">		m_extBeforeContainerPC.addRow(m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_DURATION),</span>
<span class="nc" id="L1644">				getExtBeforeDurationString());</span>

		// Before Gap spinner
<span class="nc bnc" id="L1647" title="All 2 branches missed.">		int gapBeforeMins = isExtBeforeSetToNone() ? 0 : m_customShiftRequest.getExtBeforeGap();</span>
<span class="nc" id="L1648">		gapBeforeDurationPC.setMinutesIncrement(1);</span>
<span class="nc" id="L1649">		gapBeforeDurationPC.setValue(Duration.fromMinutes(gapBeforeMins));</span>
<span class="nc" id="L1650">		gapBeforeDurationPC.setEnabled(isExtBeforeEditableAndNotSetToNone());</span>
<span class="nc" id="L1651">		m_extBeforeContainerPC.addRow(m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_GAP), gapBeforeDurationPC);</span>

		// Before OT Checkbox
<span class="nc" id="L1654">		StringBuffer sb1 = new StringBuffer(100);</span>
<span class="nc bnc" id="L1655" title="All 2 branches missed.">		boolean isDisabled = !isExtBeforeOTEditable();</span>
<span class="nc" id="L1656">		boolean isChecked = isExtBeforeOTChecked();</span>
<span class="nc" id="L1657">		String label = i18n(m_bundle, RmWebBundleKey.ORG_RM_FILING_RULE_OVERTIME);</span>
<span class="nc" id="L1658">		HtmlChoiceInput checkbox1 = new HtmlChoiceInput();</span>
<span class="nc" id="L1659">		sb1.append(</span>
<span class="nc" id="L1660">				getChkBoxInput(checkbox1, EXT_BEFORE_OVERTIME, &quot;true&quot;, label, isChecked, isDisabled, JSUtil.ON_CHANGE));</span>
<span class="nc" id="L1661">		m_extBeforeContainerPC.addRow(label, sb1.toString());</span>

<span class="nc" id="L1663">		m_containerList.add(m_extBeforeContainerPC);</span>
<span class="nc" id="L1664">	}</span>

	/**
	 * Initialize the Extension After list container
	 */
	private void initExtAfterList() {
<span class="nc" id="L1670">		String firstTitle = i18n(m_bundle, RmWebBundleKey.CSR_EXTENSION_AFTER_SHIFT);</span>
<span class="nc" id="L1671">		m_extAfterContainerPC = new Collapsible2ColFormPC(m_context);</span>
<span class="nc" id="L1672">		m_extAfterContainerPC.setTitle(firstTitle);</span>
<span class="nc" id="L1673">		m_extAfterContainerPC.setName(RmWebBundleKey.CSR_EXTENSION_AFTER_SHIFT);</span>
<span class="nc" id="L1674">		m_extAfterContainerPC.setCollapsed(getExtAfterSectionCollapsed());</span>
<span class="nc" id="L1675">		m_extAfterContainerPC.setTableSummary(i18n(m_bundle, RmWebBundleKey.EXTENSION_AFTER_SHIFT_TABLE));</span>

		// After Type selector
<span class="nc" id="L1678">		String typeLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.CSR_TYPE), EXT_AFTER_ID);</span>
<span class="nc" id="L1679">		m_extAfterContainerPC.addRow(typeLabel, createExtAfterTypeDD());</span>

		// After Activity selector
<span class="nc" id="L1682">		String activityLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.RM_SA_FILTER_ACTIVITY),</span>
				EXT_AFTER_ACTIVITY_ID);
<span class="nc" id="L1684">		m_extAfterContainerPC.addRow(activityLabel, createExtAfterActivityDD());</span>

		// After Duration string
<span class="nc" id="L1687">		m_extAfterContainerPC.addRow(m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_DURATION),</span>
<span class="nc" id="L1688">				getExtAfterDurationString());</span>

		// After Gap spinner
<span class="nc bnc" id="L1691" title="All 2 branches missed.">		int gapAfterMins = isExtAfterSetToNone() ? 0 : m_customShiftRequest.getExtAfterGap();</span>
<span class="nc" id="L1692">		gapAfterDurationPC.setMinutesIncrement(1);</span>
<span class="nc" id="L1693">		gapAfterDurationPC.setValue(Duration.fromMinutes(gapAfterMins));</span>
<span class="nc" id="L1694">		gapAfterDurationPC.setEnabled(isExtAfterEditableAndNotSetToNone());</span>
<span class="nc" id="L1695">		m_extAfterContainerPC.addRow(m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_GAP), gapAfterDurationPC);</span>

		// After OT Checkbox
<span class="nc" id="L1698">		StringBuffer sb1 = new StringBuffer(100);</span>
<span class="nc bnc" id="L1699" title="All 2 branches missed.">		boolean isDisabled = !isExtAfterOTEditable();</span>
<span class="nc" id="L1700">		boolean isChecked = isExtAfterOTChecked();</span>
<span class="nc" id="L1701">		HtmlChoiceInput checkbox1 = new HtmlChoiceInput();</span>
<span class="nc" id="L1702">		String labelLocalized = i18n(m_bundle, RmWebBundleKey.ORG_RM_FILING_RULE_OVERTIME);</span>
<span class="nc" id="L1703">		sb1.append(getChkBoxInput(checkbox1, EXT_AFTER_OVERTIME, &quot;true&quot;, labelLocalized, isChecked, isDisabled,</span>
				JSUtil.ON_CHANGE));
<span class="nc" id="L1705">		m_extAfterContainerPC.addRow(labelLocalized, sb1.toString());</span>

<span class="nc" id="L1707">		m_containerList.add(m_extAfterContainerPC);</span>
<span class="nc" id="L1708">	}</span>

	/**
	 * Return the ext before duration string, wrapped in a span, such as
	 * &quot;&lt;span id='extBeforeDuration'&gt;8:30&lt;/span&gt;&quot;.
	 * If the drawn duration does not match with the defined extension rule, there is an warning icon next to duration
	 */
	private String getExtBeforeDurationString() {
<span class="nc" id="L1716">		String hhmm = CustomShiftUtil.getExtBeforeDurationString(m_customShiftRequest, m_localizer);</span>
<span class="nc" id="L1717">		String durationDisplay=&quot;&lt;span id='&quot; + EXT_BEFORE_DURATION + &quot;'&gt;&quot; + hhmm + &quot;&lt;/span&gt;&quot;;</span>
<span class="nc bnc" id="L1718" title="All 2 branches missed.">		if(highlightBeforeDuration){</span>
<span class="nc" id="L1719">			String imgSrc=ImageFileID.ALERT_YELLOW;</span>
<span class="nc" id="L1720">			String imgAlt= m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_WARNING_ADDED_EXTENSION_DETAIL,new Object[] { strDesiredDuration, strShiftDuration} );</span>
<span class="nc" id="L1721">			durationDisplay=&quot;&lt;span id='&quot; + EXT_BEFORE_DURATION + &quot;' style=\&quot;color:orange\&quot;&gt;&quot; + hhmm + &quot;&lt;/span&gt;&lt;span class=\&quot;itemAlert\&quot;&gt;&quot; + HtmlUtil.imageTag(imgSrc, imgAlt) + &quot;&lt;/span&gt;&quot;;</span>
<span class="nc" id="L1722">			highlightBeforeDuration= false;</span>
		}
<span class="nc" id="L1724">		return durationDisplay;</span>
	}

	/**
	 * Return the ext after duration string, wrapped in a span, such as
	 * &quot;&lt;span id='extAfterDuration'&gt;8:30&lt;/span&gt;&quot;.
	 * If the drawn duration does not match with the defined extension rule, there is an warning icon next to duration
	 */
	private String getExtAfterDurationString() {
<span class="nc" id="L1733">		String hhmm = CustomShiftUtil.getExtAfterDurationString(m_customShiftRequest, m_localizer);</span>
<span class="nc" id="L1734">		String durationDisplay=&quot;&lt;span id='&quot; + EXT_AFTER_DURATION + &quot;'&gt;&quot; + hhmm + &quot;&lt;/span&gt;&quot;;</span>
<span class="nc bnc" id="L1735" title="All 2 branches missed.">		if(highlightAfterDuration){</span>
<span class="nc" id="L1736">			String imgSrc=ImageFileID.ALERT_YELLOW;</span>
<span class="nc" id="L1737">			String imgAlt= m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_WARNING_ADDED_EXTENSION_DETAIL,new Object[] { strDesiredDuration, strShiftDuration} );</span>
<span class="nc" id="L1738">			durationDisplay=&quot;&lt;span id='&quot; + EXT_AFTER_DURATION + &quot;' style=\&quot;color:orange\&quot;&gt;&quot; + hhmm + &quot;&lt;/span&gt;&lt;span class=\&quot;itemAlert\&quot;&gt;&quot; + HtmlUtil.imageTag(imgSrc, imgAlt) + &quot;&lt;/span&gt;&quot;;</span>
<span class="nc" id="L1739">			highlightAfterDuration= false;</span>
		}
<span class="nc" id="L1741">		return durationDisplay;</span>

	}

	/**
	 * Return true if User is authorized to waitlist a Request.
	 */
	protected boolean isAuthToWaitlist() {
<span class="nc" id="L1749">		return m_context.getUser().isAuthorized(PrivilegeKeys.TOM_ADDREQUESTTOWAITLIST_ID);</span>
	}

	private String getChkBoxInput(HtmlChoiceInput checkbox, String name, String value, String label, boolean isChecked,
			boolean isDisabled, String onClickJS) {
<span class="nc" id="L1754">		checkbox.reset();</span>
<span class="nc" id="L1755">		checkbox.setIsValueSubmittedWhenDisabled(true);</span>
<span class="nc" id="L1756">		checkbox.setIsMultiSelect(true);</span>
<span class="nc" id="L1757">		checkbox.setInputName(name);</span>
<span class="nc" id="L1758">		checkbox.setValue(value);</span>
<span class="nc" id="L1759">		checkbox.setLabel(label);</span>
<span class="nc" id="L1760">		checkbox.setIsChecked(isChecked);</span>
<span class="nc" id="L1761">		checkbox.setIsDisabled(isDisabled);</span>
<span class="nc" id="L1762">		checkbox.setOnClickJS(onClickJS);</span>
<span class="nc" id="L1763">		checkbox.setIsHiddenLabel(true);</span>
<span class="nc" id="L1764">		return checkbox.getHtmlDisplay();</span>
	}

	/**
	 * Create the OT checkbox row.
	 *
	 * @return The HTML for the OT checkbox row.
	 */
	private void createAndAddOvertimeRow() {
<span class="nc" id="L1773">		String checkboxLabel = i18n(m_bundle, RmWebBundleKey.ORG_RM_ENTIRE_SHIFT_OVERTIME);</span>
<span class="nc" id="L1774">		StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L1775">		HtmlChoiceInput checkbox = new HtmlChoiceInput();</span>
<span class="nc bnc" id="L1776" title="All 2 branches missed.">		sb.append(getChkBoxInput(checkbox, OVERTIME, &quot;true&quot;, checkboxLabel, isOvertimeChecked(), !isOvertimeEditable(),</span>
				JS_FUNC_TOGGLE_SHIFT_OT));
<span class="nc" id="L1778">		m_shiftContainerPC.addRow(checkboxLabel, sb.toString());</span>
<span class="nc" id="L1779">	}</span>

	/**
	 * Returns true if the main shift's Overtime checkbox should be editable or
	 * not.
	 */
	protected boolean isOvertimeEditable() {
<span class="nc bnc" id="L1786" title="All 4 branches missed.">		boolean isEditable = isNewShiftRequest() &amp;&amp; isShiftEditable();</span>

<span class="nc bnc" id="L1788" title="All 2 branches missed.">		if (isNewShiftRequest()) {</span>
<span class="nc bnc" id="L1789" title="All 4 branches missed.">			if (!m_allowRegularShifts || !m_allowOTShifts) {</span>
<span class="nc" id="L1790">				isEditable = false;</span>
			}
		}

<span class="nc" id="L1794">		return isEditable;</span>
	}

	/**
	 * Returns true if the main shift's Overtime checkbox should be checked or
	 * not.
	 */
	protected boolean isOvertimeChecked() {
<span class="nc" id="L1802">		boolean isChecked = m_customShiftRequest.isOT();</span>

		// Check org setting allowances. we only care about new shifts because
		// shift changes do not allow editing of OT, so we leave those as they
		// are.
<span class="nc bnc" id="L1807" title="All 2 branches missed.">		if (isNewShiftRequest()) {</span>
<span class="nc bnc" id="L1808" title="All 4 branches missed.">			if (!m_allowOTShifts || !m_allowNewShifts) {</span>
				// only non-OT shifts are allowed for new shifts
<span class="nc" id="L1810">				isChecked = false;</span>
<span class="nc bnc" id="L1811" title="All 2 branches missed.">			} else if (!m_allowRegularShifts) {</span>
				// only OT shifts are allowed for new shifts
<span class="nc" id="L1813">				isChecked = true;</span>
			}
		}

<span class="nc" id="L1817">		m_customShiftRequest.setIsOT(isChecked); // Should we move this code</span>
		// somewhere outside of this UI
		// component code?
<span class="nc" id="L1820">		return isChecked;</span>
	}

	private boolean isExtBeforeOTEditable() {
<span class="nc bnc" id="L1824" title="All 4 branches missed.">		boolean isEnabled = isExtBeforeEditableAndNotSetToNone() &amp;&amp; !getOvertime();</span>

<span class="nc bnc" id="L1826" title="All 4 branches missed.">		if (m_allowOTExtBeforeShifts &amp;&amp; !m_allowRegularExtBeforeShifts) {</span>
			// we must disable and check it if we only allowOTExtBeforeShifts
<span class="nc" id="L1828">			isEnabled = false;</span>
<span class="nc bnc" id="L1829" title="All 4 branches missed.">		} else if (!m_allowOTExtBeforeShifts &amp;&amp; m_allowRegularExtBeforeShifts) {</span>
			// we must disable and uncheck it if we only
			// allowRegularExtBeforeShifts
<span class="nc" id="L1832">			isEnabled = false;</span>
		}

<span class="nc" id="L1835">		return isEnabled;</span>
	}

	private boolean isExtBeforeOTChecked() {
<span class="nc bnc" id="L1839" title="All 4 branches missed.">		if (isShiftChangeRequest() &amp;&amp; CustomShiftUtil.saHasExtBefore(m_shiftAssignment)) {</span>
<span class="nc" id="L1840">			return m_customShiftRequest.getExtBeforeIsOT();</span>
		}

<span class="nc bnc" id="L1843" title="All 6 branches missed.">		boolean isChecked = !isExtBeforeSetToNone() &amp;&amp; (m_customShiftRequest.getExtBeforeIsOT() || getOvertime());</span>

<span class="nc bnc" id="L1845" title="All 4 branches missed.">		if (m_allowOTExtBeforeShifts &amp;&amp; !m_allowRegularExtBeforeShifts) {</span>
			// we must disable and check it if we only allowOTExtBeforeShifts
<span class="nc" id="L1847">			isChecked = true;</span>
<span class="nc bnc" id="L1848" title="All 4 branches missed.">		} else if (!m_allowOTExtBeforeShifts &amp;&amp; m_allowRegularExtBeforeShifts) {</span>
			// we must disable and uncheck it if we only
			// allowRegularExtBeforeShifts
<span class="nc" id="L1851">			isChecked = false; // What happens if this is inconsistent with</span>
			// m_customShiftRequest.getExtBeforeIsOT() ||
			// getOvertime() ?
		}

<span class="nc" id="L1856">		m_customShiftRequest.setExtBeforeIsOT(isChecked); // Should we move this</span>
		// code somewhere
		// outside of this UI
		// component code?

<span class="nc" id="L1861">		return isChecked;</span>
	}

	private boolean isExtAfterOTChecked() {
<span class="nc bnc" id="L1865" title="All 4 branches missed.">		if (isShiftChangeRequest() &amp;&amp; CustomShiftUtil.saHasExtAfter(m_shiftAssignment)) {</span>
<span class="nc" id="L1866">			return m_customShiftRequest.getExtAfterIsOT();</span>
		}

<span class="nc bnc" id="L1869" title="All 6 branches missed.">		boolean isChecked = !isExtAfterSetToNone() &amp;&amp; (m_customShiftRequest.getExtAfterIsOT() || getOvertime());</span>

<span class="nc bnc" id="L1871" title="All 4 branches missed.">		if (m_allowOTExtAfterShifts &amp;&amp; !m_allowRegularExtAfterShifts) {</span>
			// we must disable and check it if we only allowOTExtAfterShifts
<span class="nc" id="L1873">			isChecked = true;</span>
<span class="nc bnc" id="L1874" title="All 4 branches missed.">		} else if (!m_allowOTExtAfterShifts &amp;&amp; m_allowRegularExtAfterShifts) {</span>
			// we must disable and uncheck it if we only
			// allowRegularExtAfterShifts
<span class="nc" id="L1877">			isChecked = false; // What happens if this is inconsistent with</span>
			// m_customShiftRequest.getExtAfterIsOT() ||
			// getOvertime() ?
		}

<span class="nc" id="L1882">		m_customShiftRequest.setExtAfterIsOT(isChecked); // Should we move this</span>
		// code somewhere
		// outside of this UI
		// component code?

<span class="nc" id="L1887">		return isChecked;</span>
	}

	private boolean isExtAfterOTEditable() {
<span class="nc bnc" id="L1891" title="All 4 branches missed.">		boolean isEnabled = isExtAfterEditableAndNotSetToNone() &amp;&amp; !getOvertime();</span>

		// we must disable and check it if we only allowOTExtAfterShifts
<span class="nc bnc" id="L1894" title="All 4 branches missed.">		if (m_allowOTExtAfterShifts &amp;&amp; !m_allowRegularExtAfterShifts) {</span>
<span class="nc" id="L1895">			isEnabled = false;</span>
		}

		// we must disable and uncheck it if we only allowRegularExtAfterShifts
<span class="nc bnc" id="L1899" title="All 4 branches missed.">		if (!m_allowOTExtAfterShifts &amp;&amp; m_allowRegularExtAfterShifts) {</span>
<span class="nc" id="L1900">			isEnabled = false;</span>
		}

<span class="nc" id="L1903">		return isEnabled;</span>
	}

	/**
	 * Create the date picker row.
	 *
	 * @return The HTML for the start date row.
	 */
	private void createAndAddDatePickerRow() {
<span class="nc" id="L1912">		String label = i18n(m_bundle, RmWebBundleKey.CSR_START_DATE);</span>

		String description;
<span class="nc bnc" id="L1915" title="All 2 branches missed.">		if (nothingIsEditable()) {</span>
<span class="nc" id="L1916">			description = m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_SELECT_A_DIFFERENT_DATE);</span>
		} else {
<span class="nc bnc" id="L1918" title="All 2 branches missed.">			description = (m_shiftAssignment == null) ? m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_REQUEST_NEW_SHIFT)</span>
<span class="nc bnc" id="L1919" title="All 2 branches missed.">					: (isManagerMode() ? m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_REQUEST_SHIFT_CHANGE)</span>
<span class="nc" id="L1920">							: m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_REQUEST_SHIFT_CHANGE_FOR_AGENT));</span>
		}

<span class="nc" id="L1923">		m_shiftContainerPC.addRow(label, m_datePickerPC + &quot; &amp;nbsp; &quot; + description);</span>
<span class="nc" id="L1924">	}</span>

	/**
	 * Create the time picker row.
	 *
	 * @return The HTML for the start time row.
	 */
	private void createAndAddTimePickerRow() {
<span class="nc bnc" id="L1932" title="All 2 branches missed.">		if (!isShiftEditable()) {</span>
<span class="nc" id="L1933">			disableTimePickerPC();</span>
		}

<span class="nc" id="L1936">		String label = i18n(m_bundle, RmWebBundleKey.CSR_START_TIME);</span>
<span class="nc" id="L1937">		m_shiftContainerPC.addRow(label, m_timePickerPC);</span>
<span class="nc" id="L1938">	}</span>

	/**
	 * Return List of Containers NOTE: Items in the Collection will be treated
	 * either as Page Components or just a basic Object.
	 */
	@Override
	public Collection getContainers() {
<span class="nc" id="L1946">		return m_containerList;</span>
	}

	/**
	 * Create the collapsible Alert List PC. Overrides parent class.
	 */
	@Override
	protected MultiColCollapsibleContainerPC createAlertsList() {
<span class="nc" id="L1954">		MultiColCollapsibleContainerPC listPC = super.createAlertsList();</span>
<span class="nc" id="L1955">		listPC.getMultiColListPC().setRowSelectable(false);</span>
<span class="nc" id="L1956">		listPC.setCollapsed(getAlertsSectionCollapsed());</span>
<span class="nc" id="L1957">		m_containerList.add(listPC);</span>
<span class="nc" id="L1958">		return listPC;</span>
	}

	@Override
	protected boolean isSaveButtonEnabled() {
<span class="nc" id="L1963">		return RequestUtil.isRequestFormSaveBtnEnabled(m_request);</span>
	}

	/**
	 * Validate Data to be valid
	 */
	@Override
	public boolean validate() {
<span class="nc" id="L1971">		boolean success = super.validate();</span>
<span class="nc" id="L1972">		return success;</span>
	}

	/**
	 * Specify Employee which Request is for
	 */
	public void setRequestedFor(ID empID) {
<span class="nc" id="L1979">		m_customShiftRequest.setEmployeeID(empID);</span>
<span class="nc" id="L1980">	}</span>

	/**
	 * Return Employee which Request is for
	 */
	public ID getRequestedFor() {
<span class="nc" id="L1986">		ID id = m_customShiftRequest.getEmployeeID();</span>

<span class="nc bnc" id="L1988" title="All 4 branches missed.">		if (!isManagerMode() &amp;&amp; id == null) {</span>
<span class="nc" id="L1989">			id = m_context.getUser().getEmployeeID();</span>
		}

<span class="nc" id="L1992">		return id;</span>
	}

	/**
	 * Specify Employee which Request was originally for, used when coming from
	 * the net staffing ribbon.
	 */
	public void setOrigRequestedFor(ID empID) {
<span class="nc" id="L2000">		m_origReuestedFor = empID;</span>
<span class="nc" id="L2001">	}</span>

	/**
	 * Return Employee which Request was originally for, used when coming from
	 * the net staffing ribbon.
	 */
	public ID getOrigRequestedFor() {
<span class="nc bnc" id="L2008" title="All 2 branches missed.">		return m_origReuestedFor == null ? getRequestedFor() : m_origReuestedFor;</span>
	}

	/**
	 * Set the Custom Shift Request to be used
	 */
	public void setCustomShiftRequest(CustShiftReq request) {
<span class="nc" id="L2015">		m_customShiftRequest = request;</span>
<span class="nc" id="L2016">		m_request = request;</span>
<span class="nc" id="L2017">	}</span>

	/**
	 * Return the Custom Shift Request
	 */
	public CustShiftReq getCustShiftRequest() {
<span class="nc" id="L2023">		return m_customShiftRequest;</span>
	}

	/**
	 * Set Main Shift ID
	 */
	public void setShiftID(ID id) {
<span class="nc" id="L2030">		m_customShiftRequest.setShiftID(id);</span>
<span class="nc" id="L2031">	}</span>

	/**
	 * Return Main Shift ID
	 */
	public ID getShiftID() {
<span class="nc" id="L2037">		return m_customShiftRequest.getShiftID();</span>
	}

	/**
	 * Set Main Activity ID
	 */
	public void setActivityID(String type) {
<span class="nc" id="L2044">		m_customShiftRequest.setActivityID(new ID(type));</span>
<span class="nc" id="L2045">	}</span>

	/**
	 * Return Main Activity ID
	 */
	public ID getActivityID() {
<span class="nc" id="L2051">		return m_customShiftRequest.getActivityID();</span>
	}

	/**
	 * Set Request Status
	 */
	public void setRequestStatus(String status) {
<span class="nc" id="L2058">		m_customShiftRequest.setRequestStatus(status);</span>
<span class="nc" id="L2059">	}</span>

	/**
	 * Return Request Status
	 */
	public String getRequestStatus() {
<span class="nc" id="L2065">		return m_customShiftRequest.getRequestStatus();</span>
	}

	/**
	 * Set Reload Action
	 */
	public void setReloadAction(String action) {
<span class="nc" id="L2072">		m_reloadAction = action;</span>
<span class="nc" id="L2073">	}</span>

	/**
	 * Get Reload Action
	 */
	public String getReloadAction() {
<span class="nc" id="L2079">		return m_reloadAction;</span>
	}

	/**
	 * Determine the Request Sub Type. - Regular New Shift: Request for a new
	 * (non-OT) shift. It may have Regular extensions only. - Regular Shift
	 * Change: Request for an extension before or after the shift or change in
	 * shift. No OT Shift/Extensions allowed. - Overtime New Shift: Request for
	 * a new OT shift (any extensions will be OT) - Overtime Shift Change:
	 * Request for an OT extension before or after the (OT or Regular) shift, or
	 * other change in an OT shift
	 */
	protected int determineRequestSubType(CustShiftReq request) {
<span class="nc bnc" id="L2092" title="All 6 branches missed.">		if (request.isOT() || request.getExtBeforeIsOT() || request.getExtAfterIsOT()) {</span>
<span class="nc bnc" id="L2093" title="All 2 branches missed.">			if (isShiftChangeRequest()) {</span>
<span class="nc" id="L2094">				return CustShiftReq.REQUEST_SUB_TYPE_OT_SHIFT_CHANGE.toInt();</span>
			} else {
<span class="nc" id="L2096">				return CustShiftReq.REQUEST_SUB_TYPE_OT_NEW_SHIFT.toInt();</span>
			}
		} else {
<span class="nc bnc" id="L2099" title="All 2 branches missed.">			if (isShiftChangeRequest()) {</span>
<span class="nc" id="L2100">				return CustShiftReq.REQUEST_SUB_TYPE_REG_SHIFT_CHANGE.toInt();</span>
			} else {
<span class="nc" id="L2102">				return CustShiftReq.REQUEST_SUB_TYPE_REG_NEW_SHIFT.toInt();</span>
			}
		}
	}

	/**
	 * Set Overtime checkbox setting for main shift
	 */
	public void setOvertime(boolean isOT) {
<span class="nc" id="L2111">		m_customShiftRequest.setIsOT(isOT);</span>

<span class="nc bnc" id="L2113" title="All 2 branches missed.">		if (isOT) {</span>
			// Whenever the main shift is for OT, the extensions must also be.
<span class="nc" id="L2115">			setExtBeforeOvertime(true);</span>
<span class="nc" id="L2116">			setExtAfterOvertime(true);</span>
		}
<span class="nc" id="L2118">	}</span>

	/**
	 * Return Overtime checkbox setting for main shift
	 */
	public boolean getOvertime() {
<span class="nc" id="L2124">		return m_customShiftRequest.isOT();</span>
	}

	/**
	 * Set Overtime Before checkbox setting
	 */
	public void setExtBeforeOvertime(boolean isOT) {
<span class="nc" id="L2131">		m_customShiftRequest.setExtBeforeIsOT(isOT);</span>
<span class="nc" id="L2132">	}</span>

	/**
	 * Return Overtime Before checkbox setting
	 */
	public boolean getExtBeforeOvertime() {
<span class="nc" id="L2138">		return m_customShiftRequest.getExtBeforeIsOT();</span>
	}

	/**
	 * Set Overtime After checkbox setting
	 */
	public void setExtAfterOvertime(boolean isOT) {
<span class="nc" id="L2145">		m_customShiftRequest.setExtAfterIsOT(isOT);</span>
<span class="nc" id="L2146">	}</span>

	/**
	 * Return Overtime After checkbox setting
	 */
	public boolean getExtAfterOvertime() {
<span class="nc" id="L2152">		return m_customShiftRequest.getExtAfterIsOT();</span>
	}

	/**
	 * Set Gap Before duration setting
	 */
	public void setExtBeforeGap(int gap) {
<span class="nc" id="L2159">		m_customShiftRequest.setExtBeforeGap(gap);</span>
<span class="nc" id="L2160">	}</span>

	/**
	 * Return Gap Before duration setting
	 */
	public int getExtBeforeGap() {
<span class="nc" id="L2166">		return m_customShiftRequest.getExtBeforeGap();</span>
	}

	/**
	 * Set Gap After duration setting
	 */
	public void setExtAfterGap(int gap) {
<span class="nc" id="L2173">		m_customShiftRequest.setExtAfterGap(gap);</span>
<span class="nc" id="L2174">	}</span>

	/**
	 * Return Gap After duration setting
	 */
	public int getExtAfterGap() {
<span class="nc" id="L2180">		return m_customShiftRequest.getExtAfterGap();</span>
	}

	/**
	 * Set the ID of the Extension before the shift
	 */
	public void setExtBeforeID(ID id) {
<span class="nc" id="L2187">		m_customShiftRequest.setExtBeforeID(id);</span>
<span class="nc" id="L2188">	}</span>

	/**
	 * Get the ID of the Extension before the shift
	 */
	public ID getExtBeforeID() {
<span class="nc" id="L2194">		return m_customShiftRequest.getExtBeforeID();</span>
	}

	/**
	 * Set the ID of the Extension after the shift
	 */
	public void setExtAfterID(ID id) {
<span class="nc" id="L2201">		m_customShiftRequest.setExtAfterID(id);</span>
<span class="nc" id="L2202">	}</span>

	/**
	 * Get the ID of the Extension after the shift
	 */
	public ID getExtAfterID() {
<span class="nc" id="L2208">		return m_customShiftRequest.getExtAfterID();</span>
	}

	/**
	 * Set the activityID of the Extension before the shift
	 */
	public void setExtBeforeActivityID(ID id) {
<span class="nc" id="L2215">		m_customShiftRequest.setExtBeforeActivityID(id);</span>
<span class="nc" id="L2216">	}</span>

	/**
	 * Get the activityID of the Extension before the shift
	 */
	public ID getExtBeforeActivityID() {
<span class="nc" id="L2222">		return m_customShiftRequest.getExtBeforeActivityID();</span>
	}

	/**
	 * Set the activityID of the Extension after the shift
	 */
	public void setExtAfterActivityID(ID id) {
<span class="nc" id="L2229">		m_customShiftRequest.setExtAfterActivityID(id);</span>
<span class="nc" id="L2230">	}</span>

	/**
	 * Get the activityID of the Extension after the shift
	 */
	public ID getExtAfterActivityID() {
<span class="nc" id="L2236">		return m_customShiftRequest.getExtAfterActivityID();</span>
	}

	/**
	 * Set the date at which the user's selection starts on the graph schedule
	 * view's Net Staffing ribbon.
	 *
	 * @param date
	 */
	public void setRibbonStartDate(String date) {
<span class="nc" id="L2246">		m_ribbonStartDate = new Date(Long.parseLong(date));</span>
<span class="nc" id="L2247">	}</span>

	/**
	 * Get the date at which the user's selection starts on the graph schedule
	 * view's Net Staffing ribbon.
	 */
	public Date getRibbonStartDate() {
<span class="nc" id="L2254">		return m_ribbonStartDate;</span>
	}

	/**
	 * Set the date at which the user's selection ends on the graph schedule
	 * view's Net Staffing ribbon.
	 *
	 * @param date
	 */
	public void setRibbonEndDate(String date) {
<span class="nc" id="L2264">		m_ribbonEndDate = new Date(Long.parseLong(date));</span>
<span class="nc" id="L2265">	}</span>

	/**
	 * Get the date at which the user's selection ends on the graph schedule
	 * view's Net Staffing ribbon.
	 */
	public Date getRibbonEndDate() {
<span class="nc" id="L2272">		return m_ribbonEndDate;</span>
	}

	/**
	 * Return true if Request is Escalated
	 */
	private boolean isEscalatedRequest() {
<span class="nc" id="L2279">		return RequestAuditTrail.STATUS_ESCALATED.equals(getRequestStatus());</span>
	}

	/**
	 * Set whether or not the Shift section is collapsed.
	 *
	 * @param collapsed
	 *            - &quot;true&quot; if it is collapsed, &quot;false&quot; if it is expanded.
	 */
	public void setShiftSectionCollapsed(String collapsed) {
<span class="nc" id="L2289">		m_shiftSectionCollapsed = collapsed;</span>
<span class="nc" id="L2290">	}</span>

	/**
	 * Set whether or not the Extension Before Shift section is collapsed.
	 *
	 * @param collapsed
	 *            - &quot;true&quot; if it is collapsed, &quot;false&quot; if it is expanded.
	 */
	public void setExtBeforeSectionCollapsed(String collapsed) {
<span class="nc" id="L2299">		m_extBeforeSectionCollapsed = collapsed;</span>
<span class="nc" id="L2300">	}</span>

	/**
	 * Set whether or not the Extension After Shift section is collapsed.
	 *
	 * @param collapsed
	 *            - &quot;true&quot; if it is collapsed, &quot;false&quot; if it is expanded.
	 */
	public void setExtAfterSectionCollapsed(String collapsed) {
<span class="nc" id="L2309">		m_extAfterSectionCollapsed = collapsed;</span>
<span class="nc" id="L2310">	}</span>

	/**
	 * Set whether or not the Alerts section is collapsed.
	 *
	 * @param collapsed
	 *            - &quot;true&quot; if it is collapsed, &quot;false&quot; if it is expanded.
	 */
	public void setAlertsSectionCollapsed(String collapsed) {
<span class="nc" id="L2319">		m_alertsSectionCollapsed = collapsed;</span>
<span class="nc" id="L2320">	}</span>

	public boolean getShiftSectionCollapsed() {
<span class="nc bnc" id="L2323" title="All 4 branches missed.">		if (m_shiftSectionCollapsed == null || m_shiftSectionCollapsed.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L2324">			return false;</span>
		}
<span class="nc" id="L2326">		return true;</span>
	}

	public boolean getExtBeforeSectionCollapsed() {
<span class="nc bnc" id="L2330" title="All 4 branches missed.">		if (m_extBeforeSectionCollapsed == null || m_extBeforeSectionCollapsed.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L2331">			return false;</span>
		}
<span class="nc" id="L2333">		return true;</span>
	}

	public boolean getExtAfterSectionCollapsed() {
<span class="nc bnc" id="L2337" title="All 4 branches missed.">		if (m_extAfterSectionCollapsed == null || m_extAfterSectionCollapsed.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L2338">			return false;</span>
		}
<span class="nc" id="L2340">		return true;</span>
	}

	public boolean getAlertsSectionCollapsed() {
<span class="nc bnc" id="L2344" title="All 4 branches missed.">		if (m_alertsSectionCollapsed == null || m_alertsSectionCollapsed.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L2345">			return false;</span>
		}
<span class="nc" id="L2347">		return true;</span>
	}

	/**
	 * Determines the collapsed state of each of the four main sections of the
	 * dialog (Shift, extBefore, extAfter, and Alerts). We will determine the
	 * state based on the user's net staffing selection (when coming from the
	 * ribbon), or the saved request object (when viewing a saved request), or
	 * the user's schedule (if user changed Date or Agent selection, or the
	 * dialog was just opened). If the dialog was refreshed due to the agent
	 * making other changes (time, shift, extension), we will keep the previous
	 * state of collapsed sections.
	 *
	 * @param existingRequest
	 *            - If we are editing a saved request, this should contain the
	 *            request from the db.
	 */
	public void determineCollapsedSections(CustShiftReq existingRequest) {
<span class="nc bnc" id="L2365" title="All 2 branches missed.">		if (isRibbonDefaultMode()) {</span>
			// as a default, show the Shift section only
<span class="nc" id="L2367">			setCollapsedSections(false, true, true, true);</span>
<span class="nc bnc" id="L2368" title="All 2 branches missed.">			if (isShiftChangeRequest()) {</span>
<span class="nc bnc" id="L2369" title="All 4 branches missed.">				if (isExtBeforeOptimizable() &amp;&amp; isExtAfterOptimizable()) {</span>
<span class="nc bnc" id="L2370" title="All 2 branches missed.">					if (m_ribbonStartDate.before(m_shiftAssignment.getStartTime())</span>
<span class="nc bnc" id="L2371" title="All 2 branches missed.">							&amp;&amp; m_ribbonEndDate.after(m_shiftAssignment.getEndTime())) {</span>
<span class="nc" id="L2372">						setCollapsedSections(true, false, false, true);</span>
<span class="nc bnc" id="L2373" title="All 2 branches missed.">					} else if (m_ribbonStartDate.before(m_shiftAssignment.getStartTime())) {</span>
<span class="nc" id="L2374">						setCollapsedSections(true, false, true, true);</span>
<span class="nc bnc" id="L2375" title="All 2 branches missed.">					} else if (m_ribbonEndDate.after(m_shiftAssignment.getEndTime())) {</span>
<span class="nc" id="L2376">						setCollapsedSections(true, true, false, true);</span>
					}
<span class="nc bnc" id="L2378" title="All 4 branches missed.">				} else if (isExtBeforeOptimizable() || isExtAfterOptimizable()) {</span>
<span class="nc bnc" id="L2379" title="All 4 branches missed.">					setCollapsedSections(true, !isExtBeforeOptimizable(), !isExtAfterOptimizable(), true);</span>
				}
			}
<span class="nc bnc" id="L2382" title="All 4 branches missed.">		} else if (m_reloadAction.equals(RELOAD_ACTION_EMPLOYEE) || m_reloadAction.equals(RELOAD_ACTION_DATE)</span>
<span class="nc bnc" id="L2383" title="All 2 branches missed.">				|| m_reloadAction.equals(RELOAD_ACTION_NONE)) {</span>
<span class="nc bnc" id="L2384" title="All 2 branches missed.">			if (isRequestDefaultMode()) {</span>
				// expand all sections that have been requested, plus Alerts (if
				// any)
<span class="nc bnc" id="L2387" title="All 4 branches missed.">				setCollapsedSections(existingRequest.getShiftID() == null, existingRequest.getExtBeforeID() == null,</span>
<span class="nc bnc" id="L2388" title="All 4 branches missed.">						existingRequest.getExtAfterID() == null, !hasValidationAlert());</span>
<span class="nc bnc" id="L2389" title="All 2 branches missed.">			} else if (isNewShiftRequest()) {</span>
				// as a default, show the Shift section only
<span class="nc" id="L2391">				setCollapsedSections(false, true, true, true);</span>
			} else { // shift change request
<span class="nc bnc" id="L2393" title="All 4 branches missed.">				if (isShiftEditable() || nothingIsEditable()) {</span>
					// as a default, show the Shift section only
<span class="nc" id="L2395">					setCollapsedSections(false, true, true, true);</span>
				} else {
					// Expand the Shift section, and any editable extension.
					// The reason why we expand the Shift section is because the
					// user won't have any other way of knowing
					// what the shift is or what needs to be done. Contrast this
					// with what happens when coming from the ribbon.
					// In that case, the user already knows what the shift looks
					// like, since he just saw it in the schedule view.
<span class="nc bnc" id="L2404" title="All 4 branches missed.">					setCollapsedSections(false, !isExtBeforeEditable(), !isExtAfterEditable(), true);</span>
				}
			}

<span class="nc bnc" id="L2408" title="All 4 branches missed.">			if (m_reloadAction.equals(RELOAD_ACTION_EMPLOYEE) || m_reloadAction.equals(RELOAD_ACTION_DATE)) {</span>
<span class="nc" id="L2409">				m_shiftSectionCollapsed = &quot;false&quot;; // expand the Shift section</span>
				// since it was previously
				// expanded
			}

<span class="nc bnc" id="L2414" title="All 2 branches missed.">		} else if (m_reloadAction.equals(RELOAD_ACTION_SAVE)) {</span>
<span class="nc bnc" id="L2415" title="All 2 branches missed.">			m_alertsSectionCollapsed = hasValidationAlert() ? &quot;false&quot; : &quot;true&quot;;</span>
		}
<span class="nc" id="L2417">	}</span>

	/**
	 * Returns true if there are one or more validation rule alerts for the
	 * saved request, false otherwise.
	 */
	public boolean hasValidationAlert() {
<span class="nc bnc" id="L2424" title="All 2 branches missed.">		return !m_valResults.isEmpty();</span>
	}

	public void setCollapsedSections(boolean shiftCollapsed, boolean extBeforeCollapsed, boolean extAfterCollapsed,
			boolean alertsCollapsed) {
<span class="nc bnc" id="L2429" title="All 2 branches missed.">		m_shiftSectionCollapsed = shiftCollapsed ? &quot;true&quot; : &quot;false&quot;;</span>
<span class="nc bnc" id="L2430" title="All 2 branches missed.">		m_extBeforeSectionCollapsed = extBeforeCollapsed ? &quot;true&quot; : &quot;false&quot;;</span>
<span class="nc bnc" id="L2431" title="All 2 branches missed.">		m_extAfterSectionCollapsed = extAfterCollapsed ? &quot;true&quot; : &quot;false&quot;;</span>
<span class="nc bnc" id="L2432" title="All 2 branches missed.">		m_alertsSectionCollapsed = alertsCollapsed ? &quot;true&quot; : &quot;false&quot;;</span>
<span class="nc" id="L2433">	}</span>

	/**
	 * Return the JavaScript init code required to initialize this component
	 */
	@Override
	public String getJavaScriptInitCode() {
<span class="nc bnc" id="L2440" title="All 2 branches missed.">		if (m_customShiftRequest.getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L2441">			setIsRefreshOpenerOnClose(true);</span>
		}

<span class="nc" id="L2444">		return super.getJavaScriptInitCode();</span>
	}

	/**
	 * Return Required Html
	 */
	@Override
	public String getRequiredHTML() {
<span class="nc" id="L2452">		StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L2453">		sb.append(super.getRequiredHTML());</span>

<span class="nc bnc" id="L2455" title="All 2 branches missed.">		if (!isManagerMode()) {</span>
<span class="nc" id="L2456">			ID empID = m_context.getUser().getEmployeeID();</span>
<span class="nc" id="L2457">			String requestFor = HtmlUtil.makeHiddenInput(REQUESTED_FOR_FN, empID.toString());</span>
<span class="nc" id="L2458">			sb.append(requestFor);</span>
		}

<span class="nc" id="L2461">		String requestStatus = HtmlUtil.makeHiddenInput(REQUEST_STATUS_FN, m_customShiftRequest.getRequestStatus());</span>
<span class="nc" id="L2462">		sb.append(requestStatus);</span>

<span class="nc" id="L2464">		String reloadAction = HtmlUtil.makeHiddenInput(RELOAD_ACTION_FN, m_reloadAction);</span>
<span class="nc" id="L2465">		sb.append(reloadAction);</span>

<span class="nc bnc" id="L2467" title="All 2 branches missed.">		if (isRibbonMode()) {</span>
<span class="nc" id="L2468">			sb.append(HtmlUtil.makeHiddenInput(&quot;ribbonStartDate&quot;, (&quot;&quot; + m_ribbonStartDate.getTime())));</span>
<span class="nc" id="L2469">			sb.append(HtmlUtil.makeHiddenInput(&quot;ribbonEndDate&quot;, (&quot;&quot; + m_ribbonEndDate.getTime())));</span>
<span class="nc" id="L2470">			sb.append(HtmlUtil.makeHiddenInput(&quot;origRequestedFor&quot;, getOrigRequestedFor()));</span>
		}

<span class="nc" id="L2473">		sb.append(HtmlUtil.makeHiddenInput(&quot;shiftSectionCollapsed&quot;, m_shiftSectionCollapsed));</span>
<span class="nc" id="L2474">		sb.append(HtmlUtil.makeHiddenInput(&quot;extBeforeSectionCollapsed&quot;, m_extBeforeSectionCollapsed));</span>
<span class="nc" id="L2475">		sb.append(HtmlUtil.makeHiddenInput(&quot;extAfterSectionCollapsed&quot;, m_extAfterSectionCollapsed));</span>
<span class="nc" id="L2476">		sb.append(HtmlUtil.makeHiddenInput(&quot;alertsSectionCollapsed&quot;, m_alertsSectionCollapsed));</span>

<span class="nc" id="L2478">		return sb.toString();</span>
	}

	/**
	 * Overrides the one in RequestFormPopupPM.
	 */
	@Override
	public void setSavedRequestID(ID requsetID) {
<span class="nc" id="L2486">		m_isRequestSaved = true;</span>
<span class="nc" id="L2487">		super.setSavedRequestID(requsetID);</span>

<span class="nc bnc" id="L2489" title="All 2 branches missed.">		if (isRibbonMode()) {</span>
<span class="nc" id="L2490">			setIsRefreshOpenerOnClose(false);</span>
		}
<span class="nc" id="L2492">	}</span>

	/**
	 * Returns true if this request dialog was originally launched from a net
	 * staffing ribbon selection.
	 *
	 * @return
	 */
	public boolean isRibbonMode() {
<span class="nc bnc" id="L2501" title="All 2 branches missed.">		return (m_ribbonStartDate != null);</span>
	}

	/**
	 * Returns true if this request dialog was originally launched from a net
	 * staffing ribbon selection, AND the selected user and selected date are
	 * the same ones that were selected in the net staffing ribbon. If so, that
	 * means that we will filter the activity dropdowns by keeping only those
	 * with a net staffing deficiency (as well as any the user is currently
	 * scheduled for). We will NOT change the values currently selected in the
	 * dropdowns to the ribbon defaults.
	 */
	public boolean isRibbonApplicable() {
<span class="nc bnc" id="L2514" title="All 6 branches missed.">		return isRibbonMode() &amp;&amp; m_selectedDayIncludesRibbonSelection &amp;&amp; m_selectedAgentIsForRibbonSelection;</span>
	}

	/**
	 * Returns true if this request dialog was originally launched from a net
	 * staffing ribbon selection, AND the selected user and selected date are
	 * the same ones that were selected in the net staffing ribbon, AND either
	 * the dialog was just launched from the ribbon, of the user just changed
	 * the employee/date selection back to the original values for the ribbon
	 * selection. If so, that means that we will filter the activity dropdowns
	 * by keeping only those with a net staffing deficiency (as well as any the
	 * user is currently scheduled for). In addition, we will set the
	 * shift/extension/activity dropdowns with the default to best match the
	 * ribbon selection (including selecting the most deficient activity).
	 */
	public boolean isRibbonDefaultMode() {
<span class="nc bnc" id="L2530" title="All 4 branches missed.">		return m_selectedDayIncludesRibbonSelection &amp;&amp; m_selectedAgentIsForRibbonSelection</span>
<span class="nc bnc" id="L2531" title="All 4 branches missed.">				&amp;&amp; (m_reloadAction.equals(RELOAD_ACTION_EMPLOYEE) || m_reloadAction.equals(RELOAD_ACTION_DATE)</span>
<span class="nc bnc" id="L2532" title="All 2 branches missed.">						|| m_reloadAction.equals(RELOAD_ACTION_RIBBON));</span>
	}

	/**
	 * Returns true if the user is editing an existing request, and the popup
	 * has just launched, or the user has just changed the date back to the
	 * original date for the request. In this case, we should reload the saved
	 * request settings rather than reset the form.
	 */
	public boolean isRequestDefaultMode() {
<span class="nc bnc" id="L2542" title="All 4 branches missed.">		return !isNew() &amp;&amp; m_selectedDateIsForSavedRequest</span>
<span class="nc bnc" id="L2543" title="All 4 branches missed.">				&amp;&amp; (m_reloadAction.equals(RELOAD_ACTION_DATE) || m_reloadAction.equals(RELOAD_ACTION_NONE));</span>
	}

	/**
	 * Return Employee Name By ID or the First One
	 */
	private EmployeeName findEmpNameByID(ID empID) {
<span class="nc" id="L2550">		EmployeeName eName = null;</span>

<span class="nc bnc" id="L2552" title="All 2 branches missed.">		for (Iterator it = m_empNames.iterator(); it.hasNext();) {</span>
<span class="nc" id="L2553">			EmployeeName tmpEName = (EmployeeName) it.next();</span>
			// Keep track of First Employee Name
<span class="nc bnc" id="L2555" title="All 2 branches missed.">			if (eName == null) {</span>
<span class="nc" id="L2556">				eName = tmpEName;</span>
			}

<span class="nc bnc" id="L2559" title="All 2 branches missed.">			if (tmpEName.getID().equals(empID)) {</span>
<span class="nc" id="L2560">				eName = tmpEName;</span>
<span class="nc" id="L2561">				break;</span>
			}
<span class="nc" id="L2563">		}</span>

<span class="nc" id="L2565">		return eName;</span>
	}

	private String reloadWithAction(String reloadAction) {
<span class="nc" id="L2569">		return JS_FUNC_RELOAD_WITH_ACTION + &quot;('&quot; + reloadAction + &quot;');&quot;;</span>
	}

	/**
	 * Prepare the request for saving to the database.
	 *
	 * @param request
	 *            - The request object. We will modify it as necessary.
	 */
	protected void prepareRequestForSaving(CustShiftReq request) {
<span class="nc" id="L2579">		request.setSPID(m_spID);</span>
<span class="nc" id="L2580">		request.setSubmittedOn(new Date());</span>

		// Replace NONE_ID or CUSTOM_ID with null ( custom shifts have SHIFT ID
		// =null in shift assignment)
<span class="nc bnc" id="L2584" title="All 2 branches missed.">		if (request.getShiftID() != null</span>
<span class="nc bnc" id="L2585" title="All 4 branches missed.">				&amp;&amp; (request.getShiftID().equals(NONE_ID) || request.getShiftID().equals(CUSTOM_ID))) {</span>
<span class="nc" id="L2586">			request.setShiftID(null);</span>
		}
<span class="nc bnc" id="L2588" title="All 4 branches missed.">		if (request.getExtBeforeID() != null &amp;&amp; request.getExtBeforeID().equals(NONE_ID)) {</span>
<span class="nc" id="L2589">			request.setExtBeforeID(null);</span>
		}

<span class="nc bnc" id="L2592" title="All 4 branches missed.">		if (request.getExtBeforeActivityID() != null &amp;&amp; request.getExtBeforeActivityID().equals(NONE_ID)) {</span>
<span class="nc" id="L2593">			request.setExtBeforeActivityID(null);</span>
		}

<span class="nc bnc" id="L2596" title="All 4 branches missed.">		if (request.getExtAfterActivityID() != null &amp;&amp; request.getExtAfterActivityID().equals(NONE_ID)) {</span>
<span class="nc" id="L2597">			request.setExtAfterActivityID(null);</span>
		}

<span class="nc bnc" id="L2600" title="All 4 branches missed.">		if (request.getExtAfterID() != null &amp;&amp; request.getExtAfterID().equals(NONE_ID)) {</span>
<span class="nc" id="L2601">			request.setExtAfterID(null);</span>
		}

<span class="nc" id="L2604">		keepOnlyRequestDeltas(request);</span>

<span class="nc" id="L2606">		ID spID = findSPIdPostAdjustingRequestDates(request.getStartTime(), request.getEndTime());</span>
<span class="nc bnc" id="L2607" title="All 2 branches missed.">		if(spID != null){</span>
<span class="nc" id="L2608">			request.setSPID(spID);</span>
		}else{
<span class="nc" id="L2610">			request.setSPID(m_spID);</span>
		}

<span class="nc" id="L2613">		request.setExpirationDate(request.getStartTime());</span>

<span class="nc bnc" id="L2615" title="All 2 branches missed.">		request.setHashCodeForUndrlyngShift(m_shiftAssignment == null ? null : m_shiftAssignment.hashCode() + &quot;&quot;);</span>

<span class="nc bnc" id="L2617" title="All 2 branches missed.">		request.setShiftAssignmentID(m_shiftAssignment == null ? null : m_shiftAssignment.getID());</span>
<span class="nc" id="L2618">	}</span>

	/**
	 * This method finds the SP to which this request belongs to after the deltas have been adjusted for the request
	 * @param startTime
	 * @param endTime
	 * @return
	 */
	protected ID findSPIdPostAdjustingRequestDates(Date startTime,Date endTime) {
<span class="nc" id="L2627">		TimeRange spTimeRange = null;</span>
<span class="nc" id="L2628">		ID matchSPId = null;</span>

<span class="nc bnc" id="L2630" title="All 4 branches missed.">		if(spIDMap != null &amp;&amp; !spIDMap.isEmpty()){</span>

<span class="nc" id="L2632">			Iterator it = spIDMap.entrySet().iterator();</span>
<span class="nc bnc" id="L2633" title="All 2 branches missed.">			while (it.hasNext()) {</span>
<span class="nc" id="L2634">				Map.Entry&lt;ID,Pair&lt;Date,Date&gt;&gt; mapEntry = (Map.Entry&lt;ID,Pair&lt;Date,Date&gt;&gt;)it.next();</span>
<span class="nc" id="L2635">				spTimeRange = new TimeRange(mapEntry.getValue().getFirst(),mapEntry.getValue().getSecond());</span>

<span class="nc bnc" id="L2637" title="All 2 branches missed.">				if(spTimeRange.includes(startTime)){</span>
<span class="nc" id="L2638">					matchSPId = mapEntry.getKey();</span>
<span class="nc" id="L2639">					break;</span>
				}
<span class="nc" id="L2641">			}</span>
			//As the CUSTOM Shift Request table has 1 to 1 mapping to SPID , we return only one SPID.
		}

<span class="nc" id="L2645">		return matchSPId;</span>
	}

	/**
	 * If we are saving a new/existing &quot;New Shift&quot; request, keep everything in
	 * the request object. If we are saving a new/existing &quot;Shift Change&quot;
	 * request, keep only the differences (deltas) between the request object
	 * and the ShiftAssignment. Either way, the request start and end time will
	 * be set so that they cover only the changed intervals (shift change
	 * request), or the entire shift+extensions (new shift request).
	 *
	 * @param request
	 *            - The request object. We will modify it if necessary so as to
	 *            keep only the &quot;delta&quot; data.
	 */
	protected void keepOnlyRequestDeltas(CustShiftReq request) {
<span class="nc" id="L2661">		boolean changedSomethingForShift = true; // this is always true for New</span>
		// Shift requests

<span class="nc bnc" id="L2664" title="All 2 branches missed.">		if (isShiftChangeRequest()) {</span>
<span class="nc bnc" id="L2665" title="All 2 branches missed.">			boolean changedShift = !areValuesEqual(request.getShiftID(), m_shiftAssignment.getShiftID());</span>
<span class="nc bnc" id="L2666" title="All 2 branches missed.">			boolean changedShiftStart = !areValuesEqual(request.getShiftStartTime(), m_saMainShiftStartTime);</span>
<span class="nc bnc" id="L2667" title="All 2 branches missed.">			boolean changedShiftEnd = !areValuesEqual(request.getShiftEndTime(), m_saMainShiftEndTime);</span>
<span class="nc bnc" id="L2668" title="All 6 branches missed.">			changedSomethingForShift = changedShift || changedShiftStart || changedShiftEnd;</span>

<span class="nc bnc" id="L2670" title="All 2 branches missed.">			if (!changedSomethingForShift) {</span>
<span class="nc" id="L2671">				request.setShiftID(null);</span>
<span class="nc" id="L2672">				request.setActivityID(null);</span>
			}

			// the following field can never be changed, but we still set it to
			// null to make it clear
<span class="nc bnc" id="L2677" title="All 2 branches missed.">			if (areValuesEqual(request.getExtBeforeID(), m_shiftAssignment.getOTExtensionBeforeID())) {</span>
<span class="nc" id="L2678">				request.setExtBeforeID(null);</span>
			}

			// the following field can never be changed, but we still set it to
			// null to make it clear
<span class="nc bnc" id="L2683" title="All 2 branches missed.">			if (areValuesEqual(request.getExtBeforeActivityID(), m_shiftAssignment.getOTExtensionBeforeActivityID())) {</span>
<span class="nc" id="L2684">				request.setExtBeforeActivityID(null);</span>
			}

			// the following field can never be changed, but we still set it to
			// null to make it clear
<span class="nc bnc" id="L2689" title="All 2 branches missed.">			if (areValuesEqual(request.getExtAfterID(), m_shiftAssignment.getOTExtensionAfterID())) {</span>
<span class="nc" id="L2690">				request.setExtAfterID(null);</span>
			}

			// the following field can never be changed, but we still set it to
			// null to make it clear
<span class="nc bnc" id="L2695" title="All 2 branches missed.">			if (areValuesEqual(request.getExtAfterActivityID(), m_shiftAssignment.getOTExtensionAfterActivityID())) {</span>
<span class="nc" id="L2696">				request.setExtAfterActivityID(null);</span>
			}

			// Since we now only store the deltas, this shouldn't be needed,
			// since you cannot change durations.
<span class="nc bnc" id="L2701" title="All 2 branches missed.">			if (areValuesEqual(request.getExtBeforeDuration(),</span>
<span class="nc" id="L2702">					new ID(m_shiftAssignment.getExtensionBefore() - m_saGapBeforeDuration))) {</span>
<span class="nc" id="L2703">				request.setExtBeforeDuration(0); // null);</span>
			}

<span class="nc bnc" id="L2706" title="All 2 branches missed.">			if (areValuesEqual(request.getExtAfterDuration(),</span>
<span class="nc" id="L2707">					new ID(m_shiftAssignment.getExtensionAfter() - m_saGapAfterDuration))) {</span>
<span class="nc" id="L2708">				request.setExtAfterDuration(0); // null);</span>
			}
		}

<span class="nc bnc" id="L2712" title="All 2 branches missed.">		if (request.getExtBeforeID() == null) {</span>
<span class="nc" id="L2713">			request.setExtBeforeIsOT(false);</span>
<span class="nc" id="L2714">			request.setExtBeforeGap(0);</span>
<span class="nc" id="L2715">			request.setExtBeforeDuration(0);</span>
<span class="nc" id="L2716">			request.setExtBeforeActivityID(null);</span>
		}

<span class="nc bnc" id="L2719" title="All 2 branches missed.">		if (request.getExtAfterID() == null) {</span>
<span class="nc" id="L2720">			request.setExtAfterIsOT(false);</span>
<span class="nc" id="L2721">			request.setExtAfterGap(0);</span>
<span class="nc" id="L2722">			request.setExtAfterDuration(0);</span>
<span class="nc" id="L2723">			request.setExtAfterActivityID(null);</span>
		}

		// this will make sure value in db is not null since the getter cannot
		// return null
<span class="nc" id="L2728">		request.setExtBeforeIsOT(request.getExtBeforeIsOT());</span>
<span class="nc" id="L2729">		request.setExtAfterIsOT(request.getExtAfterIsOT());</span>

		// set request subtype
<span class="nc" id="L2732">		request.setSubType(determineRequestSubType(request));</span>

		// the request start and end time should cover only the changed
		// intervals
<span class="nc" id="L2736">		Calendar cal = Calendar.getInstance(m_view_tz);</span>
<span class="nc" id="L2737">		Date beforeStartTime = null, shiftStartTime = null, afterStartTime = null;</span>
<span class="nc" id="L2738">		Date beforeEndTime = null, shiftEndTime = null, afterEndTime = null;</span>

<span class="nc bnc" id="L2740" title="All 2 branches missed.">		if (request.getExtBeforeID() != null) {</span>
			// an extension before shift is being added. Use its start time as
			// the request start time.
<span class="nc" id="L2743">			cal.setTime(m_customShiftRequest.getShiftStartTime());</span>

<span class="nc bnc" id="L2745" title="All 2 branches missed.">			if (m_extBeforeType != null) {</span>
				// subtract ext before from main shift start
				// time
<span class="nc" id="L2748">				cal.add(Calendar.MINUTE, -(m_extBeforeType.getDuration() + getExtBeforeGap()));</span>
			}

<span class="nc" id="L2751">			beforeStartTime = cal.getTime();</span>
<span class="nc" id="L2752">			beforeEndTime = m_customShiftRequest.getShiftStartTime();</span>
		}

<span class="nc bnc" id="L2755" title="All 2 branches missed.">		if (changedSomethingForShift) {</span>
			// something in the shift is being changed. Use its start time as
			// the request start time.
<span class="nc" id="L2758">			shiftStartTime = m_customShiftRequest.getShiftStartTime();</span>
<span class="nc" id="L2759">			shiftEndTime = m_customShiftRequest.getShiftEndTime();</span>
		}

<span class="nc bnc" id="L2762" title="All 2 branches missed.">		if (request.getExtAfterID() != null) {</span>
			// an extension after shift is being added. Use its end time as the
			// request end time.
<span class="nc" id="L2765">			afterStartTime = m_customShiftRequest.getShiftEndTime();</span>
<span class="nc" id="L2766">			cal.setTime(m_customShiftRequest.getShiftEndTime());</span>

<span class="nc bnc" id="L2768" title="All 2 branches missed.">			if (m_extAfterType != null) {</span>
				// add ext after to main shift end time
<span class="nc" id="L2770">				cal.add(Calendar.MINUTE, (m_extAfterType.getDuration() + getExtAfterGap()));</span>
			}

<span class="nc" id="L2773">			afterEndTime = cal.getTime();</span>
		}

		// Finally, set the delta starttime and endtime for the entire request
<span class="nc" id="L2777">		request.setStartTime(minOfThreeDates(beforeStartTime, shiftStartTime, afterStartTime));</span>
<span class="nc" id="L2778">		request.setEndTime(maxOfThreeDates(beforeEndTime, shiftEndTime, afterEndTime));</span>
<span class="nc" id="L2779">	}</span>

	/**
	 * Return the minimum non-null Date.
	 */

	protected Date minOfThreeDates(Date d1, Date d2, Date d3) {
<span class="nc" id="L2786">		return minOfTwoDates(minOfTwoDates(d1, d2), d3);</span>
	}

	/**
	 * Return the minimum non-null Date.
	 */
	protected Date minOfTwoDates(Date d1, Date d2) {
<span class="nc bnc" id="L2793" title="All 4 branches missed.">		if (d1 == null &amp;&amp; d2 == null) {</span>
<span class="nc" id="L2794">			return null;</span>
		}

<span class="nc bnc" id="L2797" title="All 2 branches missed.">		if (d1 == null) {</span>
<span class="nc" id="L2798">			return d2;</span>
		}

<span class="nc bnc" id="L2801" title="All 2 branches missed.">		if (d2 == null) {</span>
<span class="nc" id="L2802">			return d1;</span>
		}

<span class="nc bnc" id="L2805" title="All 2 branches missed.">		if (d1.before(d2)) {</span>
<span class="nc" id="L2806">			return d1;</span>
		}

<span class="nc" id="L2809">		return d2;</span>
	}

	/**
	 * Return the maximum non-null Date.
	 */

	protected Date maxOfThreeDates(Date d1, Date d2, Date d3) {
<span class="nc" id="L2817">		return maxOfTwoDates(maxOfTwoDates(d1, d2), d3);</span>
	}

	/**
	 * Return the maximum non-null Date.
	 */
	protected Date maxOfTwoDates(Date d1, Date d2) {
<span class="nc bnc" id="L2824" title="All 4 branches missed.">		if (d1 == null &amp;&amp; d2 == null) {</span>
<span class="nc" id="L2825">			return null;</span>
		}

<span class="nc bnc" id="L2828" title="All 2 branches missed.">		if (d1 == null) {</span>
<span class="nc" id="L2829">			return d2;</span>
		}

<span class="nc bnc" id="L2832" title="All 2 branches missed.">		if (d2 == null) {</span>
<span class="nc" id="L2833">			return d1;</span>
		}

<span class="nc bnc" id="L2836" title="All 2 branches missed.">		if (d1.after(d2)) {</span>
<span class="nc" id="L2837">			return d1;</span>
		}

<span class="nc" id="L2840">		return d2;</span>
	}

	protected boolean isNull(Object o1) {
<span class="nc bnc" id="L2844" title="All 6 branches missed.">		return o1 == null || o1.equals(NONE_ID) || o1.equals(CUSTOM_ID);</span>
	}

	protected boolean areValuesEqual(Object o1, Object o2) {
<span class="nc bnc" id="L2848" title="All 4 branches missed.">		if (isNull(o1) &amp;&amp; isNull(o2)) {</span>
<span class="nc" id="L2849">			return true;</span>
		}

<span class="nc bnc" id="L2852" title="All 4 branches missed.">		if (isNull(o1) || isNull(o2)) {</span>
<span class="nc" id="L2853">			return false;</span>
		}

<span class="nc" id="L2856">		return o1.equals(o2);</span>
	}

	/**
	 * Return the Custom Shift Request
	 */
	public CustShiftReq getCustShiftRequestForSaving() throws Exception {
		// we need to clone the CustShiftReq because we are going to modify it
		// for saving,
		// but we still need the original object for when the page reloads.
<span class="nc" id="L2866">		CustShiftReq requestForSaving = (CustShiftReq) m_customShiftRequest.clone();</span>
<span class="nc" id="L2867">		prepareRequestForSaving(requestForSaving);</span>

<span class="nc bnc" id="L2869" title="All 2 branches missed.">		if (!validateRequestIsDifferentThanShiftAssignment(requestForSaving)</span>
<span class="nc bnc" id="L2870" title="All 2 branches missed.">				|| !validateRequestStart(requestForSaving)) {</span>
<span class="nc" id="L2871">			return null;</span>
		}

<span class="nc" id="L2874">		return requestForSaving;</span>
	}

	/**
	 * Validation for saving a request: Return true if request is different than
	 * what is already scheduled, false if they are the same. If false, then the
	 * request should not be allowed.
	 */
	protected boolean validateRequestIsDifferentThanShiftAssignment(CustShiftReq requestForSaving) {
<span class="nc bnc" id="L2883" title="All 4 branches missed.">		if (requestForSaving.getStartTime() != null &amp;&amp; requestForSaving.getEndTime() != null) {</span>
<span class="nc" id="L2884">			return true;</span>
		}

<span class="nc bnc" id="L2887" title="All 2 branches missed.">		if (isManagerMode()) {</span>
<span class="nc" id="L2888">			addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.CSR_ERROR_NO_CHANGE, RmWebBundleKey.BUNDLE_NAME);</span>
		} else {
<span class="nc" id="L2890">			addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.CSR_ERROR_NO_CHANGE_FOR_AGENT,</span>
					RmWebBundleKey.BUNDLE_NAME);
		}

<span class="nc bnc" id="L2894" title="All 2 branches missed.">		if (!isNew()) {</span>
<span class="nc" id="L2895">			addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_ERROR_YOU_CAN_WITHDRAW_REQUEST,</span>
					RmWebBundleKey.BUNDLE_NAME);
		}

<span class="nc" id="L2899">		return false;</span>
	}

	private boolean validateRequestStart(CustShiftReq requestForSaving) {
<span class="nc bnc" id="L2903" title="All 2 branches missed.">		if (LicenseUtil.isAdvancedRMLicense()) {</span>
			//With advanced license requests are allowed to start in the past
<span class="nc" id="L2905">			return true;</span>
		}

<span class="nc bnc" id="L2908" title="All 2 branches missed.">		return validateRequestIsInTheFuture(requestForSaving)</span>
<span class="nc bnc" id="L2909" title="All 2 branches missed.">				&amp;&amp; validateRequestShiftStartTimeNotAfterExistingShiftStartTime(requestForSaving);</span>
	}

	/**
	 * Validation for saving a request: Return true if request starts in the
	 * future, false if it starts in the past. If false, then the request should
	 * not be allowed.
	 */
	private boolean validateRequestIsInTheFuture(CustShiftReq requestForSaving) {
<span class="nc bnc" id="L2918" title="All 2 branches missed.">		if (requestForSaving.getStartTime().after(new Date())) {</span>
<span class="nc" id="L2919">			return true;</span>
		}

<span class="nc" id="L2922">		addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.CSR_ERROR_EXPIRED, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L2923">		return false;</span>
	}

	/**
	 * Do not allow the shift change request to change the start time of a shift that starts in the past 
	 */
	boolean validateRequestShiftStartTimeNotAfterExistingShiftStartTime(CustShiftReq requestForSaving) {
<span class="nc" id="L2930">		Date curTime = new Date();</span>
<span class="nc bnc" id="L2931" title="All 4 branches missed.">		if (m_shiftAssignment != null &amp;&amp; m_shiftAssignment.getStartTime().before(curTime) &amp;&amp;</span>
<span class="nc bnc" id="L2932" title="All 2 branches missed.">				!requestForSaving.getShiftStartTime().equals(m_shiftAssignment.getStartTime())) {</span>
<span class="nc" id="L2933">			addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.CSR_INVALID_CHANGED_SHIFT_START, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L2934">			return false;</span>
		}

<span class="nc" id="L2937">		return true;</span>
	}

	/**
	 * Returns true if the main Shift dropdown and Start Time Picker should be
	 * editable.
	 */
	protected boolean isShiftEditable() {
<span class="nc bnc" id="L2945" title="All 2 branches missed.">		return !nothingIsEditableWithoutAskingComponents()</span>
<span class="nc bnc" id="L2946" title="All 4 branches missed.">				&amp;&amp; (isNewShiftRequest() || (!CustomShiftUtil.saHasExtBefore(m_shiftAssignment)</span>
<span class="nc bnc" id="L2947" title="All 10 branches missed.">						&amp;&amp; !CustomShiftUtil.saHasExtAfter(m_shiftAssignment)))</span>
				&amp;&amp; (m_allowNewShifts || m_allowShiftChanges) &amp;&amp; (m_allowRegularShifts || m_allowOTShifts);
	}

	/**
	 * Returns true if the main shift should be optimized for the user's net
	 * staffing ribbon selection.
	 */
	protected boolean isShiftOptimizable() {
<span class="nc bnc" id="L2956" title="All 4 branches missed.">		return (m_ribbonStartDate != null) &amp;&amp; isShiftEditable();</span>
	}

	/**
	 * Returns true if the main Activity dropdown should be editable.
	 */
	protected boolean isActivityEditable() {
		// cannot change activity when making a &quot;Shift Change&quot; request
<span class="nc bnc" id="L2964" title="All 4 branches missed.">		return !nothingIsEditableWithoutAskingComponents() &amp;&amp; isNewShiftRequest();</span>
	}

	/**
	 * Returns true if the extension before the shift should be editable.
	 */
	protected boolean isExtBeforeEditable() {
<span class="nc bnc" id="L2971" title="All 2 branches missed.">		return !nothingIsEditableWithoutAskingComponents()</span>
<span class="nc bnc" id="L2972" title="All 8 branches missed.">				&amp;&amp; (isNewShiftRequest() || !CustomShiftUtil.saHasExtBefore(m_shiftAssignment))</span>
				&amp;&amp; (m_allowRegularExtBeforeShifts || m_allowOTExtBeforeShifts) &amp;&amp;
				// new shift requests must have a shift, so we make sure they
				// can request a shift, else we disable whole page.
<span class="nc bnc" id="L2976" title="All 10 branches missed.">				(isNewShiftRequest() ? m_allowNewShifts &amp;&amp; (m_allowRegularShifts || m_allowOTShifts)</span>
						: m_allowShiftChanges)
				&amp;&amp;
				// Adding/changing extensions to the request should not be
				// allowed when the main shift is marked as Overtime.
<span class="nc bnc" id="L2981" title="All 2 branches missed.">				!isOvertimeChecked();</span>
	}

	/**
	 * Returns true if the extension before the shift should be enablable (able
	 * to be enabled) from JavaScript, by unchecking the main shift's IsOT
	 * setting.
	 */
	protected boolean isExtBeforeEnablable() {
<span class="nc bnc" id="L2990" title="All 2 branches missed.">		return !nothingIsEditableWithoutAskingComponents()</span>
<span class="nc bnc" id="L2991" title="All 8 branches missed.">				&amp;&amp; (isNewShiftRequest() || !CustomShiftUtil.saHasExtBefore(m_shiftAssignment))</span>
				&amp;&amp; (m_allowRegularExtBeforeShifts || m_allowOTExtBeforeShifts) &amp;&amp;
				// new shift requests must have a shift, so we make sure they
				// can request a shift, else we disable whole page.
<span class="nc bnc" id="L2995" title="All 10 branches missed.">				(isNewShiftRequest() ? m_allowNewShifts &amp;&amp; (m_allowRegularShifts || m_allowOTShifts)</span>
						: m_allowShiftChanges);
	}

	/**
	 * Returns true if the extension before the shift should be optimized for
	 * the user's net staffing ribbon selection.
	 */
	protected boolean isExtBeforeOptimizable() {
<span class="nc bnc" id="L3004" title="All 4 branches missed.">		return (m_ribbonStartDate != null) &amp;&amp; isExtBeforeEditable()</span>
<span class="nc bnc" id="L3005" title="All 2 branches missed.">				&amp;&amp; !CustomShiftUtil.saHasExtBefore(m_shiftAssignment);</span>
	}

	/**
	 * Returns true if the extension after the shift should be editable.
	 */
	protected boolean isExtAfterEditable() {
<span class="nc bnc" id="L3012" title="All 2 branches missed.">		return !nothingIsEditableWithoutAskingComponents()</span>
<span class="nc bnc" id="L3013" title="All 8 branches missed.">				&amp;&amp; (isNewShiftRequest() || !CustomShiftUtil.saHasExtAfter(m_shiftAssignment))</span>
				&amp;&amp; (m_allowRegularExtAfterShifts || m_allowOTExtAfterShifts) &amp;&amp;
				// new shift requests must have a shift, so we make sure they
				// can request a shift, else we disable whole page.
<span class="nc bnc" id="L3017" title="All 10 branches missed.">				(isNewShiftRequest() ? m_allowNewShifts &amp;&amp; (m_allowRegularShifts || m_allowOTShifts)</span>
						: m_allowShiftChanges)
				&amp;&amp;
				// Adding/changing extensions to the request should not be
				// allowed when the main shift is marked as Overtime.
<span class="nc bnc" id="L3022" title="All 2 branches missed.">				!isOvertimeChecked();</span>
	}

	/**
	 * Returns true if the extension after the shift should be enablable (able
	 * to be enabled) from JavaScript, by unchecking the main shift's IsOT
	 * setting.
	 */
	protected boolean isExtAfterEnablable() {
<span class="nc bnc" id="L3031" title="All 2 branches missed.">		return !nothingIsEditableWithoutAskingComponents()</span>
<span class="nc bnc" id="L3032" title="All 8 branches missed.">				&amp;&amp; (isNewShiftRequest() || !CustomShiftUtil.saHasExtAfter(m_shiftAssignment))</span>
				&amp;&amp; (m_allowRegularExtAfterShifts || m_allowOTExtAfterShifts) &amp;&amp;
				// new shift requests must have a shift, so we make sure they
				// can request a shift, else we disable whole page.
<span class="nc bnc" id="L3036" title="All 10 branches missed.">				(isNewShiftRequest() ? m_allowNewShifts &amp;&amp; (m_allowRegularShifts || m_allowOTShifts)</span>
						: m_allowShiftChanges);
	}

	/**
	 * Returns true if the extension After the shift should be optimized for the
	 * user's net staffing ribbon selection.
	 */
	protected boolean isExtAfterOptimizable() {
<span class="nc bnc" id="L3045" title="All 6 branches missed.">		return (m_ribbonStartDate != null) &amp;&amp; isExtAfterEditable() &amp;&amp; !CustomShiftUtil.saHasExtAfter(m_shiftAssignment);</span>
	}

	/**
	 * Returns true if the shift, extension before, and extension after are NOT
	 * editable.
	 */
	protected boolean nothingIsEditable() {
<span class="nc bnc" id="L3053" title="All 4 branches missed.">		return nothingIsEditableDueToNoData() || nothingIsEditableDueToOrgSettings()</span>
<span class="nc bnc" id="L3054" title="All 4 branches missed.">				|| nothingIsEditableAccordingToComponents() || nothingIsEditableDueToNoDeficientActivities();</span>
	}

	/**
	 * Returns true if the shift, extension before, and extension after are NOT
	 * editable due to either No data, Org settings, or No deficient activities.
	 */
	protected boolean nothingIsEditableWithoutAskingComponents() {
<span class="nc bnc" id="L3062" title="All 4 branches missed.">		return nothingIsEditableDueToNoData() || nothingIsEditableDueToOrgSettings()</span>
<span class="nc bnc" id="L3063" title="All 2 branches missed.">				|| nothingIsEditableDueToNoDeficientActivities();</span>
	}

	/**
	 * Returns true if the shift, extension before, and extension after are NOT
	 * editable.
	 */
	protected boolean nothingIsEditableAccordingToComponents() {
<span class="nc bnc" id="L3071" title="All 6 branches missed.">		return (!isShiftEditable() &amp;&amp; !isExtBeforeEditable() &amp;&amp; !isExtAfterEditable());</span>
	}

	/**
	 * Returns true if the shift, extension before, and extension after are NOT
	 * editable due to the fact that the user is not eligible for any Shifts on
	 * the selected day.
	 */
	protected boolean nothingIsEditableDueToNoData() {
<span class="nc bnc" id="L3080" title="All 6 branches missed.">		return m_spID == null || m_shifts == null || m_shifts.isEmpty();</span>
	}

	/**
	 * Returns true if nothing is editable due to the fact that we're in
	 * optimize ribbon mode, yet there are no deficient activities.
	 *
	 * @return
	 */
	protected boolean nothingIsEditableDueToNoDeficientActivities() {
<span class="nc bnc" id="L3090" title="All 6 branches missed.">		return (isRibbonApplicable() &amp;&amp; m_mostDeficientActivity1 == null &amp;&amp; m_mostDeficientActivity2 == null);</span>
	}

	/**
	 * Returns true if the shift, extension before, and extension after are NOT
	 * editable due to the fact that the organization's RM Settings (Custom
	 * Shift Requests section) are disabled.
	 */
	protected boolean nothingIsEditableDueToOrgSettings() {
<span class="nc bnc" id="L3099" title="All 8 branches missed.">		return (isNewShiftRequest() &amp;&amp; !m_allowNewShifts) || (isShiftChangeRequest() &amp;&amp; !m_allowShiftChanges)</span>
<span class="nc bnc" id="L3100" title="All 6 branches missed.">				|| (isNewShiftRequest() &amp;&amp; !m_allowRegularShifts &amp;&amp; !m_allowOTShifts)</span>
<span class="nc bnc" id="L3101" title="All 4 branches missed.">				|| (isShiftChangeRequest() &amp;&amp; !CustomShiftUtil.saHasExtBefore(m_shiftAssignment)</span>
<span class="nc bnc" id="L3102" title="All 4 branches missed.">						&amp;&amp; CustomShiftUtil.saHasExtAfter(m_shiftAssignment) &amp;&amp; doesNotAllowExtensionsBefore())</span>
<span class="nc bnc" id="L3103" title="All 4 branches missed.">				|| (isShiftChangeRequest() &amp;&amp; CustomShiftUtil.saHasExtBefore(m_shiftAssignment)</span>
<span class="nc bnc" id="L3104" title="All 4 branches missed.">						&amp;&amp; !CustomShiftUtil.saHasExtAfter(m_shiftAssignment) &amp;&amp; doesNotAllowExtensionsAfter());</span>
	}

	private boolean doesNotAllowAnyExtensions() {
<span class="nc bnc" id="L3108" title="All 8 branches missed.">		return (!m_allowRegularExtBeforeShifts &amp;&amp; !m_allowRegularExtAfterShifts &amp;&amp; !m_allowOTExtBeforeShifts</span>
				&amp;&amp; !m_allowOTExtAfterShifts);
	}

	private boolean doesNotAllowExtensionsBefore() {
<span class="nc bnc" id="L3113" title="All 4 branches missed.">		return (!m_allowRegularExtBeforeShifts &amp;&amp; !m_allowOTExtBeforeShifts);</span>
	}

	private boolean doesNotAllowExtensionsAfter() {
<span class="nc bnc" id="L3117" title="All 4 branches missed.">		return (!m_allowRegularExtAfterShifts &amp;&amp; !m_allowOTExtAfterShifts);</span>
	}

	/**
	 * Determine whether this user has the privilege to create a custom shift
	 * request.
	 *
	 * @param isManagerPage
	 *            - pass true if the is the manager page (Tracking\Schedules).
	 *            Pass false for the agent page (My Home\My Schedule).
	 */
	public static boolean getCanCreateCustomShiftRequest(RequestContext context, boolean isManagerPage) {
<span class="nc" id="L3129">		boolean returnValue = false;</span>

<span class="nc bnc" id="L3131" title="All 2 branches missed.">		if (isManagerPage) {</span>
<span class="nc" id="L3132">			returnValue = context.getUser().isAuthorized(PrivilegeKeys.CS_MODIFYREQUESTSFOREMPLOYEE);</span>
		} else {
<span class="nc" id="L3134">			returnValue = context.getUser().isAuthorized(PrivilegeKeys.CS_MODIFYPERSONALREQUESTS);</span>
		}

<span class="nc" id="L3137">		log.debug(&quot; getCanCreateCustomShiftRequest boolFlag=&quot; + returnValue);</span>
<span class="nc" id="L3138">		return returnValue;</span>
	}

	void setShiftAssignmentForTest(ShiftAssignment sa) {
<span class="nc" id="L3142">		m_shiftAssignment = sa;</span>
<span class="nc" id="L3143">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>