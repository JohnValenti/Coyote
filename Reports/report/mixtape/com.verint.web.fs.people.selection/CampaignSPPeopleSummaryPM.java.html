<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignSPPeopleSummaryPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.people.selection</a> &gt; <span class="el_source">CampaignSPPeopleSummaryPM.java</span></div><h1>CampaignSPPeopleSummaryPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.people.selection;

import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.employeefilter.model.Filter;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.employee.EmployeeListModelHandler;
import com.bluepumpkin.web.bbm.employee.EmployeeListPageModel;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.keys.BbmJavaScriptFileID;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.people.filter.PeopleFilterParams;
import com.bluepumpkin.web.bbm.people.profile.ProfilePageModel;
import com.bluepumpkin.web.bbm.people.profile.OptimizationPeopleProfile.OptProfileAddToSPPopUpMH;
import com.bluepumpkin.web.bbm.workload.queue.selection.QueueFilterUtil;
import com.bluepumpkin.web.core.cache.SelectionCacheUtil;
import com.bluepumpkin.web.fs.keys.FsJavaScriptFileID;
import com.verint.web.fs.workrules.assignment.CampaignSPPeopleFilterBoxPC;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.filterbox.FilterBoxPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;

@SuppressWarnings(&quot;serial&quot;)
public class CampaignSPPeopleSummaryPM extends EmployeeListPageModel {
	
	protected SchedulingPeriod selectedSchedulingPeriod;
	private static final String CONFIRM_REMOVE_EMP_FROM_SP = &quot;CONFIRM_REMOVE_EMP_FROM_SP&quot;;

	public CampaignSPPeopleSummaryPM(RequestContext context) {
<span class="nc" id="L39">		super(context);</span>
<span class="nc" id="L40">		getCampaignSPPeopleFilterBoxPC().setHasNoCampaignMode(true);</span>
		
<span class="nc" id="L42">		addRequiredJavaScriptFile(BbmJavaScriptFileID.MEDIATOR_PEOPLE_SUMMARY);</span>
<span class="nc" id="L43">		setJSMediator(FsJavaScriptFileID.MEDIATOR_CAMPAIGN_SP_PEOPLE_SUMMARY);</span>
		
<span class="nc" id="L45">		Object[] args = new Object[1];</span>
<span class="nc" id="L46">	    args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.WORKER);</span>
<span class="nc" id="L47">	    String formattedTitle = MessageFormat.format( m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.OPT_PROFILE_REMOVE_EMP_WARNING), args);	    </span>
<span class="nc" id="L48">		addJSVariableAsString(CONFIRM_REMOVE_EMP_FROM_SP, formattedTitle);</span>
<span class="nc" id="L49">	}</span>
	
	public static CampaignSPPeopleSummaryPM getInstance(RequestContext context) {
<span class="nc" id="L52">		return (CampaignSPPeopleSummaryPM)getInstance(context, CampaignSPPeopleSummaryPM.class);</span>
	}

	protected FilterBoxPC getPeopleFilterBoxPC() {
<span class="nc" id="L56">		return getCampaignSPPeopleFilterBoxPC();</span>
	}
	
	public String getFormAction() {
<span class="nc" id="L60">		return &quot;campaign_sp_people_summary&quot;;</span>
	}
	
	/**
	 * Return current Selected Filter
	 */
	protected PeopleFilterParams getFilterParams() {
<span class="nc" id="L67">		return getCampaignSPPeopleFilterBoxPC().getFilterParams();</span>
	}
	
	protected void initFilter() throws Exception {
<span class="nc" id="L71">		getCampaignSPPeopleFilterBoxPC().initFilter();</span>
<span class="nc" id="L72">	}</span>
	
	protected void initActiveComponents() {
		// List Config
<span class="nc" id="L76">		m_contentTitlePC.addActiveComponent(</span>
<span class="nc" id="L77">				m_lcSelectorPC.getLabel(),</span>
<span class="nc" id="L78">				m_lcSelectorPC.getControl(), true);		</span>
<span class="nc" id="L79">	}</span>
	
	/**
	 * Initialize Toolbar
	 */
	protected void initToolbar() {
<span class="nc" id="L85">		m_toolbar.setName(TOOLBAR_NAME);</span>

<span class="nc" id="L87">		m_toolbar.addTextButton(&quot;SELECT_ALL&quot;,	i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SELECT_ALL), true);</span>
<span class="nc" id="L88">		m_toolbar.addTextButton(&quot;SELECT_NONE&quot;,i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SELECT_NONE), true);</span>
		
<span class="nc bnc" id="L90" title="All 2 branches missed.">		if (SelectionCacheUtil.isNoCampaignMode(getRequestContext()) == false) {</span>
<span class="nc" id="L91">			Object[] args = new Object[1];</span>
<span class="nc" id="L92">		    args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context,</span>
		    		DefaultVerticalizationManager.WORKER);
<span class="nc" id="L94">		    String formattedTitle = MessageFormat.format( m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
		    		BbmWebBundleKey.OPTIMIZATION_PEOPLE_POFILE_ADD_EMP_TO_SP), args);
		    
<span class="nc" id="L97">		    boolean createEnabled = m_context.getUser().isAuthorized(PrivilegeKeys.FS_CREATECAMPAIGN);</span>
<span class="nc" id="L98">			boolean configEnabled = m_context.getUser().isAuthorized(PrivilegeKeys.FS_CONFIGURECAMPAIGN);</span>
<span class="nc bnc" id="L99" title="All 4 branches missed.">			boolean editEnabled = createEnabled || configEnabled;</span>
		    
<span class="nc" id="L101">		    addPopupArgs(ProfilePageModel.OPT_POPUP_ID, ProfilePageModel.OPT_POPUP_FORM_ACTION, &quot;&quot;,</span>
		    		ProfilePageModel.OPT_POPUP_ARGS, &quot;1000,600,ctr,ctr&quot;, true, 1);

<span class="nc bnc" id="L104" title="All 4 branches missed.">		    ToolbarTextButton addEmployeeToSPButton = m_toolbar.createPopupWindowButton(ProfilePageModel.OPT_POPUP_ID,</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">		    				formattedTitle, editEnabled &amp;&amp; selectedSchedulingPeriod != null  &amp;&amp; !selectedSchedulingPeriod.isUsingAllEmployees());</span>

<span class="nc" id="L107">    		m_toolbar.addToolbarElement(addEmployeeToSPButton);</span>
		    		
<span class="nc" id="L109">		    formattedTitle = MessageFormat.format( m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
		    		BbmWebBundleKey.OPTIMIZATION_PEOPLE_POFILE_REMOVE_EMP_TO_SP), args);
<span class="nc bnc" id="L111" title="All 4 branches missed.">			m_toolbar.addConfirmSubmitTextButton(&quot;REMOVE_EMP_FROM_SP&quot;,</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">					formattedTitle, editEnabled &amp;&amp; m_totalEmpCount &gt; 0 &amp;&amp; !selectedSchedulingPeriod.isUsingAllEmployees(), CONFIRM_REMOVE_EMP_FROM_SP);</span>
		}

		// enable pagination
<span class="nc" id="L116">		enableToolbarPagination();</span>
<span class="nc" id="L117">	}</span>
	
	protected void loadData() throws Exception {
<span class="nc" id="L120">		m_lcSelectorPC.init();</span>
<span class="nc" id="L121">		initFilter();</span>
		
<span class="nc" id="L123">		ID schedulingPeriodId = QueueFilterUtil.retrieveSchedulingPeriodID(m_context);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">		if(schedulingPeriodId != null)</span>
<span class="nc" id="L125">			selectedSchedulingPeriod = CampaignModelHandler.getSchedulingPeriodByID(m_context, schedulingPeriodId);</span>

<span class="nc" id="L127">		boolean showWhoIsIn = EmployeeModelHandler.isWhoIsInShown(m_context);</span>
<span class="nc" id="L128">		setShowWhoIsIn(showWhoIsIn);</span>

		// Reset Edit Index to 0 if Action is not Page Navigation
<span class="nc bnc" id="L131" title="All 2 branches missed.">		if (!isPaginationNavPressed()) setEditIndex(0);</span>

		// Code to Enable Pagination
<span class="nc" id="L134">		int editIndex = getEditIndex();</span>
<span class="nc" id="L135">		int pageIDSize = getPageIDSize();</span>
		EmployeeListModelHandler.EmployeeCollection employeeCollection;
	
<span class="nc bnc" id="L138" title="All 2 branches missed.">		if (QueueFilterUtil.retrieveSchedulingPeriodID(m_context) != null) {</span>
<span class="nc" id="L139">			employeeCollection = EmployeeListModelHandler.getEmployeeCollection(m_context, getFilterParams(),</span>
<span class="nc" id="L140">					getCampaignSPPreFilter(m_context), getSortFieldID(), isAscendingSort(), showWhoIsIn,</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">					getEndDate(m_context), editIndex, (selectedSchedulingPeriod!=null?selectedSchedulingPeriod.getID():null),</span>
<span class="nc" id="L142">					pageIDSize, showPoolers());</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">		} else if (SelectionCacheUtil.isNoCampaignMode(getRequestContext())) {</span>
<span class="nc" id="L144">			employeeCollection = EmployeeListModelHandler.getEmployeeCollection(m_context, getFilterParams(),</span>
<span class="nc" id="L145">					null, getSortFieldID(), isAscendingSort(), showWhoIsIn,</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">					getStartDate(m_context), getEndDate(m_context), editIndex, </span>
<span class="nc" id="L147">					(selectedSchedulingPeriod!=null?selectedSchedulingPeriod.getID():null),</span>
					pageIDSize, false);
		} else {
<span class="nc" id="L150">			employeeCollection = new EmployeeListModelHandler.EmployeeCollection(Collections.EMPTY_LIST, Collections.EMPTY_LIST, false, 0);</span>
		}

		@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L154">		Collection&lt;ID&gt; availIDs = employeeCollection.getAvailEmpIDs();</span>
<span class="nc" id="L155">		m_employeeList = employeeCollection.getPageEmployees();</span>
<span class="nc" id="L156">		m_totalEmpCount = availIDs.size();</span>

<span class="nc bnc" id="L158" title="All 2 branches missed.">		if (isPaginationNavPressed()) {</span>
<span class="nc" id="L159">			setPaginationIDs(availIDs);</span>
		} else {
<span class="nc" id="L161">			initPaginationIDs(availIDs);</span>
		}

<span class="nc" id="L164">		m_bInSlaveMode = m_context.getConfigManager().isInSlaveMode();</span>
<span class="nc bnc" id="L165" title="All 4 branches missed.">		setCanAdd(employeeCollection.isAddEnabled() &amp;&amp; !m_bInSlaveMode);</span>
<span class="nc" id="L166">	}</span>
	
	/**
	 * A filter is created and then converted to a meaningless string, succeeding in removing all 
	 * meaning from the subsequent code that uses this filter and making it almost impossible 
	 * for that code to be debugged by any normal person. Cheers! 
	 * 
	 * If we have a campaign/sp selected, we will create a &quot;pre-filter&quot; which will be used
	 * to filter only the employees that have been assigned to the selected SP.
	 * 
	 * Based on SchedulingPeriod.isUsingAllEmployees, employees will be selected based on either sp direct
	 * link to employees for via organization link to employees
	 */
	public String getCampaignSPPreFilter(RequestContext context) throws Exception {
<span class="nc" id="L180">		ID schedulingPeriodID = SelectionCacheUtil.getSchedulingPeriodID(getRequestContext());</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">		if (schedulingPeriodID != null) {</span>
			// Create a &quot;pre-filter&quot; to retrieve employee IDs for the selected SP.
			// EmployeeModelHandler will (in a way that is completely impossible to decipher or debug) deserialize this 
			// pre-filter and use it to query the employee IDs we need.
			
<span class="nc" id="L186">			SchedulingPeriod schedulingPeriod = CampaignModelHandler.getSchedulingPeriodByID(</span>
					context, schedulingPeriodID);
			
			Filter filter;
<span class="nc bnc" id="L190" title="All 2 branches missed.">			if (!schedulingPeriod.isUsingAllEmployees()) {</span>
<span class="nc" id="L191">				ArrayList&lt;Collection&lt;?&gt;&gt; filterParams = new ArrayList&lt;Collection&lt;?&gt;&gt;();</span>
				// Filter constructor expects params to be a collection of collections
<span class="nc" id="L193">				filterParams.add(Collections.singletonList(SelectionCacheUtil.getCampaignID(context)));</span>
<span class="nc" id="L194">				filter = new Filter(</span>
					Filter.CAMPAIGNID, Filter.OPERATOR_IN, filterParams);
<span class="nc" id="L196">			} else {</span>
<span class="nc" id="L197">				ArrayList&lt;Collection&lt;?&gt;&gt; filterParams = new ArrayList&lt;Collection&lt;?&gt;&gt;();</span>
				
<span class="nc" id="L199">				Collection&lt;ID&gt; organizationIDs = CampaignModelHandler.getLinkedOrgsforSP(context, schedulingPeriodID);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">				if (organizationIDs == null){</span>
<span class="nc" id="L201">					organizationIDs = new ArrayList&lt;ID&gt;();</span>
				}
				
				// Filter constructor expects params to be a collection of collections
<span class="nc" id="L205">				filterParams.add(organizationIDs);</span>
<span class="nc" id="L206">				filter = new Filter(Filter.ORGANIZATIONID, Filter.OPERATOR_IN, filterParams);</span>
			}
			
<span class="nc" id="L209">			filter.setUserID(context.getUser().getID());</span>
<span class="nc" id="L210">			filter.setStartTime(getStartDate(context));</span>
<span class="nc" id="L211">			filter.setEndTime(getEndDate(context));</span>
<span class="nc" id="L212">			filter.setTimePeriodType(Filter.TIMEPERIODTYPE_TIMEWINDOW);</span>
<span class="nc" id="L213">			return Filter.filterToString(filter);</span>
		} else {
<span class="nc" id="L215">			return null;</span>
		}
	}
	
	protected Date getStartDate(RequestContext context) throws Exception {
		//If there is no scheduling period handed in, then we are in &quot;no campaign&quot; mode and we pull the start date from the start date param
<span class="nc bnc" id="L221" title="All 2 branches missed.">		if (SelectionCacheUtil.getSchedulingPeriodID(context) == null) {</span>
<span class="nc" id="L222">			return SelectionCacheUtil.getStartDate(context);</span>
		}
<span class="nc bnc" id="L224" title="All 2 branches missed.">		else if (selectedSchedulingPeriod == null) selectedSchedulingPeriod = CampaignModelHandler.getSchedulingPeriodByID(</span>
<span class="nc" id="L225">				context, QueueFilterUtil.retrieveSchedulingPeriodID(context));</span>
<span class="nc" id="L226">		return selectedSchedulingPeriod.getStartTime();</span>
	}
	
	protected Date getEndDate(RequestContext context) throws Exception {
		//If there is no scheduling period handed in, then we are in &quot;no campaign&quot; mode and we pull the end date from the end date param
<span class="nc bnc" id="L231" title="All 2 branches missed.">		if (SelectionCacheUtil.getSchedulingPeriodID(context) == null) {</span>
<span class="nc" id="L232">			return SelectionCacheUtil.getEndDate(context);</span>
		}
<span class="nc bnc" id="L234" title="All 2 branches missed.">		else if (selectedSchedulingPeriod == null) {</span>
<span class="nc" id="L235">			selectedSchedulingPeriod = CampaignModelHandler.getSchedulingPeriodByID(</span>
<span class="nc" id="L236">				context, QueueFilterUtil.retrieveSchedulingPeriodID(context));</span>
		}
<span class="nc" id="L238">		return selectedSchedulingPeriod.getEndTime();</span>
	}
	
	/**
	 * CampaignSPPeopleFilterBoxPC contains a Campaign dropdown, SP dropdown, person filter, and find employee input field.
	 */
	protected CampaignSPPeopleFilterBoxPC getCampaignSPPeopleFilterBoxPC() {
<span class="nc bnc" id="L245" title="All 2 branches missed.">		if (m_peopleFilterBox == null) {</span>
<span class="nc" id="L246">			m_peopleFilterBox = new CampaignSPPeopleFilterBoxPC(m_context, &quot;campaignSPPeopleFilterBoxPC&quot;);</span>
		}
<span class="nc" id="L248">		return (CampaignSPPeopleFilterBoxPC)m_peopleFilterBox;</span>
	}
	
	/**
	 * Called from CampaignSPPeopleSummaryRH when the user clicks the button to unlink selected employees from the selected SP.
	 */
	public void removeSelectedEmployeesFromSchedulingPeriod() throws Exception {
<span class="nc" id="L255">		SchedulingPeriod sp = CampaignModelHandler.getSchedulingPeriodByID(</span>
<span class="nc" id="L256">				m_context, QueueFilterUtil.retrieveSchedulingPeriodID(m_context));</span>
		
<span class="nc bnc" id="L258" title="All 2 branches missed.">		if(sp != null){</span>
<span class="nc" id="L259">			OptProfileAddToSPPopUpMH.removeEmployeesFromSP(m_context, sp.getID(), sp.getDEID(), m_preselectedEmployeeIDs);</span>
		}
<span class="nc" id="L261">		clearCachedSelectedID();</span>
<span class="nc" id="L262">		setSelectedID(null);	</span>
<span class="nc" id="L263">	}</span>
	
	/**
	 * 
	 * @return
	 */
	protected boolean showPoolers() {
<span class="nc" id="L270">		return true;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>