<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityAMUsage.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.activity</a> &gt; <span class="el_source">ActivityAMUsage.java</span></div><h1>ActivityAMUsage.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.activity;

import java.util.*;
import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityProperties;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.localization.Localizer;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.*;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.*;
import com.witness.web.uif.validator.*;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;

/**
 * Title:        ActivityAMUsage
 * Description:  A collapsable container for the Activity's AM usage attributes
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       Shimon Kakon
 * @version 1.0
 */

public class ActivityAMUsage extends ActivityUsage {

	public static final int MAX_DURATION_DEFAULT_MIN = -1;
	private static final int TOLERANCE_DEFAULT_MIN = 5;
	private static final boolean WHOS_IN_STATE_DEFAULT = false; //in

<span class="fc" id="L34">	private ArrayList m_whosInStateStringPair = null;</span>
	private FormInputPC m_fiPC;

	public ActivityAMUsage(RequestContext context, ResourceBundle bundle, Activity activity, ActivityProperties activityProperties) {
<span class="fc" id="L38">		super(context, bundle, activity, activityProperties);</span>

<span class="fc" id="L40">		m_fiPC = new FormInputPC(m_context);</span>
<span class="fc" id="L41">		addChildComponent(m_fiPC);</span>
<span class="fc" id="L42">	}</span>

	public boolean extractParameters(HttpServletRequest request) {
		// if duration value is not set, the default is -1, which means unlimited
<span class="fc" id="L46">		String strDuration = request.getParameter(ActivityFields.MAX_DURATION_FN);</span>
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">		int duration = StringUtil.isEmpty(strDuration)</span>
<span class="pc" id="L48">				? MAX_DURATION_DEFAULT_MIN : Integer.parseInt(strDuration);</span>
<span class="fc" id="L49">		setMaxDurationThreshold(duration);</span>

		// in/out is an options list backed by a boolean value, so &quot;true&quot;/&quot;false&quot;
		// needs to be converted to boolean true/false
<span class="fc" id="L53">		String boolValue = (String)request.getParameter(ActivityFields.OUT_FN);</span>
<span class="fc bfc" id="L54" title="All 4 branches covered.">		setOut((boolValue != null &amp;&amp; boolValue.equals(&quot;true&quot;))? true: false);</span>
		
		//set tolerance
<span class="fc" id="L57">		strDuration = request.getParameter(ActivityFields.TOLERANCE_FN);</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">		duration = StringUtil.isEmpty(strDuration)</span>
<span class="fc" id="L59">				? TOLERANCE_DEFAULT_MIN : Integer.parseInt(strDuration);</span>
<span class="fc" id="L60">		setTolerance(duration);</span>
		
<span class="fc" id="L62">		return true;</span>
	}

	public void initForDisplay() {
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">		if (m_isInitializedForDisplay) return;</span>
		else {
<span class="fc" id="L68">			super.initForDisplay();</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">			if(m_visible) {</span>
<span class="fc" id="L70">				setTitle(i18n(m_bundle, BbmWebBundleKey.ACTIVITY_TITLE_AM_USAGE));</span>
<span class="fc" id="L71">				setName(&quot;amUsage&quot;);</span>
<span class="fc" id="L72">				m_whosInStateStringPair = new ArrayList(2);</span>
<span class="fc" id="L73">				m_whosInStateStringPair.add(new StringsPair(&quot;false&quot;, m_localizer.i18n(m_bundle, BbmWebBundleKey.ACTIVITY_WHOSIN_STATE_IN)));</span>
<span class="fc" id="L74">				m_whosInStateStringPair.add(new StringsPair(&quot;true&quot;, m_localizer.i18n(m_bundle, BbmWebBundleKey.ACTIVITY_WHOSIN_STATE_OUT)));</span>
			}
		}
<span class="fc" id="L77">	}</span>

	protected void initFields() {
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">		if(m_visible) {</span>
<span class="fc" id="L81">			m_fields = new StringBuffer(512);</span>
<span class="fc" id="L82">			int i = 0;</span>
			// Tolerance
<span class="pc bpc" id="L84" title="3 of 4 branches missed.">			switch (m_displayMap[ActivityFields.TOLERANCE]) {</span>
				case ActivityFields.EDITABLE:
<span class="fc" id="L86">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_FORM_TOLERANCE, i++));</span>
<span class="fc" id="L87">					addComponent(HtmlUtil.makeTextInput(ActivityFields.TOLERANCE_FN, 5, 5, getToleranceString(), JSUtil.ON_CHANGE));</span>
<span class="fc" id="L88">					addValidator(new IsNonNegativeIntegerFieldValidator(this, ActivityFields.TOLERANCE_FN,</span>
						BbmWebBundleKey.ACTIVITY_LABEL_FORM_TOLERANCE, BbmWebBundleKey.BUNDLE_NAME));
<span class="fc" id="L90">					break;</span>
				case ActivityFields.DISPLAYABLE:
<span class="nc" id="L92">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_FORM_TOLERANCE, i++));</span>
<span class="nc" id="L93">					addComponent(getToleranceString());</span>
				case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L95">					addHiddenField(ActivityFields.TOLERANCE);</span>
<span class="nc" id="L96">					break;</span>
			default:
<span class="nc" id="L98">				throw new IllegalStateException();</span>
			}

			// Max Duration
<span class="pc bpc" id="L102" title="3 of 4 branches missed.">			switch (m_displayMap[ActivityFields.MAX_DURATION]) {</span>
				case ActivityFields.EDITABLE:
<span class="fc" id="L104">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_FORM_MAXTHRESHOLD, i++));</span>
<span class="fc" id="L105">					addComponent(getMaxDurationCombo());</span>
<span class="fc" id="L106">					addValidator(new IsNonNegativeIntegerFieldValidator(this, ActivityFields.MAX_DURATION_FN,</span>
						BbmWebBundleKey.ACTIVITY_LABEL_LIST_MAXTHRESHOLD, BbmWebBundleKey.BUNDLE_NAME));
<span class="fc" id="L108">					break;</span>
				case ActivityFields.DISPLAYABLE:
<span class="nc" id="L110">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_FORM_MAXTHRESHOLD, i++));</span>
<span class="nc" id="L111">					addComponent(getMaxDurationString());</span>
				case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L113">					addHiddenField(ActivityFields.MAX_DURATION);</span>
<span class="nc" id="L114">					break;</span>
			default:
<span class="nc" id="L116">				throw new IllegalStateException();</span>
			}

			// Who's in state
<span class="pc bpc" id="L120" title="3 of 4 branches missed.">			switch (m_displayMap[ActivityFields.OUT]) {</span>
				case ActivityFields.EDITABLE:
<span class="fc" id="L122">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_WHOSIN, i++));</span>
<span class="fc" id="L123">					addComponent(HtmlUtil.makeSelectInput(ActivityFields.OUT_FN, String.valueOf(m_activity.isOut()),</span>
						JSUtil.ON_CHANGE,	m_whosInStateStringPair));
<span class="fc" id="L125">					break;</span>
				case ActivityFields.DISPLAYABLE:
<span class="nc" id="L127">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_WHOSIN, i++));</span>
<span class="nc" id="L128">					addComponent(ActivityAMUsage.getWhosInStateDisplay(m_activity.isOut(), m_bundle, m_localizer));</span>
				case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L130">					addHiddenField(ActivityFields.OUT);</span>
					break;
			}

<span class="fc" id="L134">		}</span>
		else { // container is invisible
<span class="nc" id="L136">			addHiddenField(ActivityFields.TOLERANCE);</span>
<span class="nc" id="L137">			addHiddenField(ActivityFields.MAX_DURATION);</span>
<span class="nc" id="L138">			addHiddenField(ActivityFields.OUT);</span>
		}

<span class="fc" id="L141">	}</span>

	public void setTolerance(int tolerance) {
<span class="fc" id="L144">		m_activity.setAdherenceTolerance(tolerance);</span>
<span class="fc" id="L145">	}</span>

	public void setMaxDurationThreshold(int duration) {
<span class="fc" id="L148">		m_activity.setMaxDurationThreshold(duration);</span>
<span class="fc" id="L149">	}</span>

	private String getToleranceString() {
<span class="fc" id="L152">		return Integer.toString(m_activity.getAdherenceTolerance());</span>
	}

	private String getMaxDurationString() {
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">		return isDurationUnlimited() ?&quot;&quot; : Integer.toString(m_activity.getMaxDurationThreshold());</span>
	}

	public void setOut(boolean out) {
<span class="fc" id="L160">		m_activity.setOut(out);</span>
<span class="fc" id="L161">	}</span>

	private boolean isDurationUnlimited() {
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">		return m_activity.getMaxDurationThreshold() == MAX_DURATION_DEFAULT_MIN;</span>
	}

	/** creates a checkbox/label textinput/label combination for max duration */
	public String getMaxDurationCombo() {
<span class="fc" id="L169">		boolean unlimited = isDurationUnlimited();</span>

<span class="fc" id="L171">		StringBuffer sb = new StringBuffer(512);</span>
		// checkbox/label                                                              ti
<span class="fc" id="L173">		sb.append(HtmlChoiceInput.makeChkBoxInput(ActivityFields.MAX_DURATION_CHKBOX_FN,</span>
<span class="fc" id="L174">										String.valueOf(unlimited),</span>
<span class="fc" id="L175">										i18n(m_bundle, BbmWebBundleKey.ACTIVITY_LABEL_UNLIMITED),</span>
										unlimited, ACTIVITY_FIELD_ON_CHANGE));
		// textinput/label
<span class="fc" id="L178">		sb.append(HtmlUtil.makeSpacerHtml(8, 1));</span>

		// Use a FieldInputPC because it supports the setMiscAttributes method,
		// which is used to set the onKeyUp event handler. onChange does not
		// take effect until the *next* event. 		
<span class="fc" id="L183">		m_fiPC.reset();</span>
<span class="fc" id="L184">		m_fiPC.setIsRequired(false);</span>
<span class="fc" id="L185">		m_fiPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="fc" id="L186">		m_fiPC.setInputValue(getMaxDurationString());</span>
<span class="fc" id="L187">		m_fiPC.setInputFN(ActivityFields.MAX_DURATION_FN);</span>
<span class="fc" id="L188">		m_fiPC.setIsReadOnly(unlimited);</span>
<span class="fc" id="L189">		m_fiPC.setSize(5);</span>
<span class="fc" id="L190">		m_fiPC.setMiscAttributes(&quot;onKeyUp=&quot; + ACTIVITY_FIELD_ON_CHANGE);</span>
<span class="fc" id="L191">		m_fiPC.initForDisplay();</span>
<span class="fc" id="L192">		sb.append(m_fiPC.getHtmlDisplay());</span>
		
<span class="fc" id="L194">		sb.append(HtmlUtil.makeSpacerHtml(4, 1));</span>
<span class="fc" id="L195">		sb.append(i18n(m_bundle, BbmWebBundleKey.ACTIVITY_LABEL_MINUTES));</span>
<span class="fc" id="L196">		return sb.toString();</span>
	}

	public void setDefaultValues() {
<span class="fc" id="L200">		m_activity.setAdherenceTolerance(TOLERANCE_DEFAULT_MIN);</span>
<span class="fc" id="L201">		m_activity.setMaxDurationThreshold(MAX_DURATION_DEFAULT_MIN);</span>
<span class="fc" id="L202">		m_activity.setOut(WHOS_IN_STATE_DEFAULT);</span>
<span class="fc" id="L203">	}</span>

	private void addHiddenField(short field) {
<span class="nc bnc" id="L206" title="All 4 branches missed.">		switch(field) {</span>
			case ActivityFields.MAX_DURATION:
<span class="nc" id="L208">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.MAX_DURATION_FN, getMaxDurationString()));</span>
<span class="nc" id="L209">				break;</span>
			case ActivityFields.TOLERANCE:
<span class="nc" id="L211">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.TOLERANCE_FN, getToleranceString()));</span>
<span class="nc" id="L212">				break;</span>
			case ActivityFields.OUT:
<span class="nc" id="L214">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.OUT_FN, String.valueOf(m_activity.isOut()) ));</span>
				break;
		}
<span class="nc" id="L217">		m_hiddenFields.append(&quot;\n&quot;);</span>
<span class="nc" id="L218">	}</span>

	public static String getWhosInStateDisplay(boolean out, ResourceBundle bbmWebBundle, Localizer localizer) {
<span class="fc bfc" id="L221" title="All 2 branches covered.">		if(out) {</span>
<span class="fc" id="L222">			return localizer.i18n(bbmWebBundle, BbmWebBundleKey.ACTIVITY_WHOSIN_STATE_OUT);</span>
		}
		else {
<span class="fc" id="L225">			return localizer.i18n(bbmWebBundle, BbmWebBundleKey.ACTIVITY_WHOSIN_STATE_IN);</span>
		}
	}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>