<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityRMUsage.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.activity</a> &gt; <span class="el_source">ActivityRMUsage.java</span></div><h1>ActivityRMUsage.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.activity;

import java.util.ArrayList;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategory;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityProperties;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TOAccrualCalculator;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title: ActivityRMUsage Description: A collapsable container for the Activity's Request Management usage attributes Copyright:
 * Copyright (c) 2002 Company: Blue Pumpkin Software, Inc
 *
 * @author Shimon Kakon
 * @version 1.0
 */
public class ActivityRMUsage extends ActivityUsage {

	private ActivityCategory m_activityType;

	public ActivityRMUsage(RequestContext context, ResourceBundle bundle, Activity activity, ActivityProperties activityProperties) {
<span class="fc" id="L33">		super(context, bundle, activity, activityProperties);</span>
<span class="fc" id="L34">	}</span>

	@Override
	public boolean extractParameters(HttpServletRequest request) {
		// Requestable
<span class="fc" id="L39">		String boolValue = request.getParameter(ActivityFields.REQUESTABLE_FN);</span>
<span class="pc bpc" id="L40" title="1 of 2 branches missed.">		m_activity.setRequestable((!StringUtil.isEmpty(boolValue)) ? true : false);</span>

<span class="fc" id="L42">		boolValue = request.getParameter(ActivityFields.USE_DAILY_TOPOOL_FN);</span>
<span class="pc bpc" id="L43" title="1 of 2 branches missed.">		activityProperties.setUseDailyTOPool((!StringUtil.isEmpty(boolValue)) ? true : false);</span>

<span class="fc" id="L45">		boolValue = request.getParameter(ActivityFields.USE_INTERVAL_TOPOOL_FN);</span>
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">		activityProperties.setUseIntervalTOPool((!StringUtil.isEmpty(boolValue)) ? true : false);</span>

<span class="fc" id="L48">		boolValue = request.getParameter(ActivityFields.USE_ADVANCED_VTO_OPTIONS_FN);</span>
<span class="pc bpc" id="L49" title="1 of 2 branches missed.">		activityProperties.setUseAdvancedVTOOptions((!StringUtil.isEmpty(boolValue)) ? true : false);</span>

<span class="fc" id="L51">		boolValue = request.getParameter(ActivityFields.USE_REQUIRED_PAY_PERIOD_HOURS_FN);</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">		activityProperties.setUseRequiredPayPeriodHours((!StringUtil.isEmpty(boolValue)) ? true : false);</span>

<span class="fc" id="L54">		String flex = request.getParameter(ActivityFields.TIMEOFF_WITH_FLEX_FN);</span>
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">		activityProperties.setTimeoffWithFlex(!StringUtil.isEmpty(flex) ? Integer.valueOf(flex).intValue() : ActivityProperties.TIME_OFF_TIME);</span>
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">		if (isActivityTypeWithAllotment()) {// sync activity fields with its category</span>
<span class="nc" id="L57">			m_activity.setTimeoffWithAllotment(true);</span>
<span class="nc" id="L58">			m_activity.setTOAccrualSchedule(getActivityType().getTOAccrualSchedule());</span>
<span class="nc" id="L59">			m_activity.setTOAccrualPolicy(getActivityType().getTOAccrualPolicy());</span>
		} else {
			// Allotment
<span class="fc" id="L62">			boolValue = request.getParameter(ActivityFields.TIMEOFF_WITH_ALLOTMENT_FN);</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">			m_activity.setTimeoffWithAllotment((!StringUtil.isEmpty(boolValue)) ? true : false);</span>
			// Accrual Schedule
<span class="fc" id="L65">			String value = request.getParameter(ActivityFields.TIMEOFF_ACCRUAL_SCHEDULE_FN);</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">			if (!StringUtil.isEmpty(value)) {</span>
				try {
<span class="fc" id="L68">					m_activity.setTOAccrualSchedule(Integer.valueOf(value).intValue());</span>
<span class="nc" id="L69">				} catch (NumberFormatException e) {</span>
<span class="fc" id="L70">				}</span>
			}
			// Accrual Policy
<span class="fc" id="L73">			value = request.getParameter(ActivityFields.TIMEOFF_ACCRUAL_POLICY_FN);</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">			if (!StringUtil.isEmpty(value)) {</span>
				try {
<span class="fc" id="L76">					m_activity.setTOAccrualPolicy(Integer.valueOf(value).intValue());</span>
<span class="nc" id="L77">				} catch (NumberFormatException e) {</span>
<span class="fc" id="L78">				}</span>
			}
		}
<span class="fc" id="L81">		return true;</span>
	}

	@Override
	public void initForDisplay() {
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L87">			return;</span>
		} else {
<span class="fc" id="L89">			super.initForDisplay();</span>
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">			if (m_visible) {</span>
<span class="fc" id="L91">				setTitle(i18n(m_bundle, BbmWebBundleKey.ACTIVITY_TITLE_RM_USAGE));</span>
<span class="fc" id="L92">				setName(&quot;rmUsage&quot;);</span>
			}
		}
<span class="fc" id="L95">	}</span>

	@Override
	protected void initFields() {
<span class="fc" id="L99">		boolean hasRMAdvanceLicense = LicenseUtil.isAdvancedRMLicense();</span>
<span class="fc" id="L100">		boolean hasLicense = TOAccrualCalculator.hasLicenseForAccrual();</span>

<span class="pc bpc" id="L102" title="1 of 2 branches missed.">		if (isActivityTypeWithAllotment()) {// sync activity fields with its category</span>
<span class="nc" id="L103">			m_activity.setTimeoffWithAllotment(true);</span>
<span class="nc" id="L104">			m_activity.setTOAccrualSchedule(getActivityType().getTOAccrualSchedule());</span>
<span class="nc" id="L105">			m_activity.setTOAccrualPolicy(getActivityType().getTOAccrualPolicy());</span>
		}

<span class="pc bpc" id="L108" title="1 of 2 branches missed.">		if (m_visible) {</span>
<span class="fc" id="L109">			m_fields = new StringBuffer(512);</span>
<span class="fc" id="L110">			int i = 0;</span>
			// Request-able
<span class="pc bpc" id="L112" title="3 of 4 branches missed.">			switch (m_displayMap[ActivityFields.REQUESTABLE]) {</span>
				case ActivityFields.EDITABLE:
<span class="fc" id="L114">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_REQUESTABLE, i++));</span>
<span class="fc" id="L115">					addComponent(HtmlChoiceInput.makeChkBoxInput(ActivityFields.REQUESTABLE_FN, &quot;true&quot;, &quot;&quot;,</span>
<span class="fc" id="L116">							m_activity.isRequestable(), isFieldDisabled(ActivityFields.REQUESTABLE), ACTIVITY_FIELD_ON_CHANGE));</span>
<span class="fc" id="L117">					break;</span>
				case ActivityFields.DISPLAYABLE:
<span class="nc" id="L119">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_REQUESTABLE, i++));</span>
<span class="nc" id="L120">					addComponent(m_localizer.formatYesNo(m_activity.isRequestable()));</span>
<span class="nc" id="L121">					addHiddenField(ActivityFields.REQUESTABLE);</span>
<span class="nc" id="L122">					break;</span>
				case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L124">					addHiddenField(ActivityFields.REQUESTABLE);</span>
<span class="nc" id="L125">					break;</span>
				default:
<span class="nc" id="L127">					throw new IllegalStateException();</span>
			}

			// Add Daily &amp; Hourly controls if RMAdvanced License is present
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">			if (hasRMAdvanceLicense) {</span>
				// Daily Time off Pool
<span class="pc bpc" id="L133" title="3 of 4 branches missed.">				switch (m_displayMap[ActivityFields.USE_DAILY_TOPOOL]) {</span>
					case ActivityFields.EDITABLE:
<span class="fc" id="L135">						m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_USE_DAILY_TOPOOL, i++));</span>
<span class="fc" id="L136">						addComponent(HtmlChoiceInput.makeChkBoxInput(ActivityFields.USE_DAILY_TOPOOL_FN, &quot;true&quot;, &quot;&quot;,</span>
<span class="fc" id="L137">								activityProperties.isUseDailyTOPool(), isFieldDisabled(ActivityFields.USE_DAILY_TOPOOL), JSUtil.ON_CHANGE));</span>
<span class="fc" id="L138">						break;</span>
					case ActivityFields.DISPLAYABLE:
<span class="nc" id="L140">						m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_USE_DAILY_TOPOOL, i++));</span>
<span class="nc" id="L141">						addComponent(m_localizer.formatYesNo(activityProperties.isUseDailyTOPool()));</span>
<span class="nc" id="L142">						addHiddenField(ActivityFields.USE_DAILY_TOPOOL);</span>
<span class="nc" id="L143">						break;</span>
					case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L145">						addHiddenField(ActivityFields.USE_DAILY_TOPOOL);</span>
<span class="nc" id="L146">						break;</span>
					default:
<span class="nc" id="L148">						throw new IllegalStateException();</span>
				}

				// Hourly Time off Pool
<span class="pc bpc" id="L152" title="3 of 4 branches missed.">				switch (m_displayMap[ActivityFields.USE_INTERVAL_TOPOOL]) {</span>
					case ActivityFields.EDITABLE:
<span class="fc" id="L154">						m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_USE_INTERVAL_TOPOOL, i++));</span>
<span class="fc" id="L155">						addComponent(HtmlChoiceInput.makeChkBoxInput(ActivityFields.USE_INTERVAL_TOPOOL_FN, &quot;true&quot;, &quot;&quot;,</span>
<span class="fc" id="L156">								activityProperties.isUseIntervalTOPool(), isFieldDisabled(ActivityFields.USE_INTERVAL_TOPOOL), ACTIVITY_FIELD_ON_CHANGE));</span>
<span class="fc" id="L157">						break;</span>
					case ActivityFields.DISPLAYABLE:
<span class="nc" id="L159">						m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_USE_INTERVAL_TOPOOL, i++));</span>
<span class="nc" id="L160">						addComponent(m_localizer.formatYesNo(activityProperties.isUseIntervalTOPool()));</span>
<span class="nc" id="L161">						addHiddenField(ActivityFields.USE_INTERVAL_TOPOOL);</span>
<span class="nc" id="L162">						break;</span>
					case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L164">						addHiddenField(ActivityFields.USE_INTERVAL_TOPOOL);</span>
<span class="nc" id="L165">						break;</span>
					default:
<span class="nc" id="L167">						throw new IllegalStateException();</span>
				}

				// Hourly Time off Pool VTO
<span class="pc bpc" id="L171" title="3 of 4 branches missed.">				switch (m_displayMap[ActivityFields.USE_ADVANCED_VTO_OPTIONS]) {</span>
					case ActivityFields.EDITABLE:
<span class="fc" id="L173">						m_fields.append(addToTemplate(addTooltip(BbmWebBundleKey.ACTIVITY_LABEL_USE_ADVANCED_VTO_OPTIONS, BbmWebBundleKey.ACTIVITY_LABEL_USE_ADVANCED_VTO_OPTIONS_EXPLAINED), i++,</span>
								false, false, null));
<span class="fc" id="L175">						addComponent(HtmlChoiceInput.makeChkBoxInput(ActivityFields.USE_ADVANCED_VTO_OPTIONS_FN, &quot;true&quot;, &quot;&quot;,</span>
<span class="fc" id="L176">								activityProperties.isUseAdvancedVTOOptions(), isFieldDisabled(ActivityFields.USE_ADVANCED_VTO_OPTIONS), JSUtil.ON_CHANGE));</span>
<span class="fc" id="L177">						break;</span>
					case ActivityFields.DISPLAYABLE:
<span class="nc" id="L179">						m_fields.append(addToTemplate(addTooltip(BbmWebBundleKey.ACTIVITY_LABEL_USE_ADVANCED_VTO_OPTIONS, BbmWebBundleKey.ACTIVITY_LABEL_USE_ADVANCED_VTO_OPTIONS_EXPLAINED), i++,</span>
								false, false, null));
<span class="nc" id="L181">						addComponent(m_localizer.formatYesNo(activityProperties.isUseAdvancedVTOOptions()));</span>
<span class="nc" id="L182">						addHiddenField(ActivityFields.USE_ADVANCED_VTO_OPTIONS);</span>
<span class="nc" id="L183">						break;</span>
					case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L185">						addHiddenField(ActivityFields.USE_ADVANCED_VTO_OPTIONS);</span>
<span class="nc" id="L186">						break;</span>
					default:
<span class="nc" id="L188">						throw new IllegalStateException();</span>
				}
			} else {
<span class="nc" id="L191">				addHiddenField(ActivityFields.USE_DAILY_TOPOOL);</span>
<span class="nc" id="L192">				addHiddenField(ActivityFields.USE_INTERVAL_TOPOOL);</span>
<span class="nc" id="L193">				addHiddenField(ActivityFields.USE_ADVANCED_VTO_OPTIONS);</span>
			}

						
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">			if (hasRMAdvanceLicense) {</span>
				// Flex Time
<span class="pc bpc" id="L199" title="3 of 4 branches missed.">				switch (m_displayMap[ActivityFields.TIMEOFF_WITH_FLEX]) {</span>
					case ActivityFields.EDITABLE:
<span class="fc" id="L201">						m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF_WITH_FLEX, i++));</span>
<span class="fc" id="L202">						addComponent(HtmlChoiceInput.makeChkBoxInput(ActivityFields.TIMEOFF_WITH_FLEX_FN, &quot;1&quot;, &quot;&quot;,</span>
<span class="fc" id="L203">								isTimeoffWithFlex(m_activity), isFieldDisabled(ActivityFields.TIMEOFF_WITH_FLEX), JSUtil.ON_CHANGE));</span>
<span class="fc" id="L204">						break;</span>
					case ActivityFields.DISPLAYABLE:
<span class="nc" id="L206">						m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF_WITH_FLEX, i++));</span>
<span class="nc" id="L207">						addComponent(m_localizer.formatYesNo(isTimeoffWithFlex(m_activity)));</span>
<span class="nc" id="L208">						addHiddenField(ActivityFields.TIMEOFF_WITH_FLEX);</span>
<span class="nc" id="L209">						break;</span>
					case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L211">						addHiddenField(ActivityFields.TIMEOFF_WITH_FLEX);</span>
<span class="nc" id="L212">						break;</span>
					default:
<span class="nc" id="L214">						throw new IllegalStateException();</span>
				}
				
			
				// Required Pay Period Hours
<span class="pc bpc" id="L219" title="3 of 4 branches missed.">				switch (m_displayMap[ActivityFields.USE_REQUIRED_PAY_PERIOD_HOURS]) {</span>
				case ActivityFields.EDITABLE://NOSONAR
<span class="fc" id="L221">					m_fields.append(addToTemplate(</span>
							BbmWebBundleKey.ACTIVITY_LABEL_REQUIRED_PAY_PERIOD_HOURS_BALANCE,
							i++));
<span class="fc" id="L224">					addComponent(HtmlChoiceInput</span>
<span class="fc" id="L225">							.makeChkBoxInput(</span>
									ActivityFields.USE_REQUIRED_PAY_PERIOD_HOURS_FN,
									&quot;true&quot;,
									&quot;&quot;,
									activityProperties
<span class="fc" id="L230">											.getUseRequiredPayPeriodHours(),</span>
<span class="fc" id="L231">									isFieldDisabled(ActivityFields.USE_REQUIRED_PAY_PERIOD_HOURS),</span>
									JSUtil.ON_CHANGE));
<span class="fc" id="L233">					break;</span>

				case ActivityFields.DISPLAYABLE://NOSONAR
<span class="nc" id="L236">					m_fields.append(addToTemplate(</span>
							BbmWebBundleKey.ACTIVITY_LABEL_REQUIRED_PAY_PERIOD_HOURS_BALANCE,
							i++));//NOSONAR
<span class="nc" id="L239">					addComponent(m_localizer.formatYesNo(activityProperties</span>
<span class="nc" id="L240">							.getUseRequiredPayPeriodHours()));</span>
<span class="nc" id="L241">					addHiddenField(ActivityFields.USE_REQUIRED_PAY_PERIOD_HOURS);</span>
<span class="nc" id="L242">					break;</span>
				case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L244">					addHiddenField(ActivityFields.USE_REQUIRED_PAY_PERIOD_HOURS);</span>
<span class="nc" id="L245">					break;</span>
				default:
<span class="nc" id="L247">					throw new IllegalStateException();</span>
				}
			} else {
<span class="nc" id="L250">				addHiddenField(ActivityFields.USE_REQUIRED_PAY_PERIOD_HOURS);</span>
			}

			// Allotment
			String bundleKeyALLOTMENT;
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">			if (!hasLicense)</span>
<span class="nc" id="L256">				bundleKeyALLOTMENT = BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF_WITH_ALLOTMENT;</span>
			else
<span class="fc" id="L258">				bundleKeyALLOTMENT = BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF_WITH_ACCRUAL;</span>

<span class="pc bpc" id="L260" title="3 of 4 branches missed.">			switch (m_displayMap[ActivityFields.TIMEOFF_WITH_ALLOTMENT]) {</span>
			case ActivityFields.EDITABLE:
<span class="fc" id="L262">				m_fields.append(addToTemplate(bundleKeyALLOTMENT, i++));</span>
<span class="fc" id="L263">				addComponent(HtmlChoiceInput.makeChkBoxInput(</span>
						ActivityFields.TIMEOFF_WITH_ALLOTMENT_FN, &quot;true&quot;, &quot;&quot;,
<span class="fc" id="L265">						m_activity.isTimeoffWithAllotment(),</span>
<span class="fc" id="L266">						isFieldDisabled(ActivityFields.TIMEOFF_WITH_ALLOTMENT),</span>
						JSUtil.ON_CHANGE));
<span class="fc" id="L268">				break;</span>
			case ActivityFields.DISPLAYABLE:
<span class="nc" id="L270">				m_fields.append(addToTemplate(bundleKeyALLOTMENT, i++));</span>
<span class="nc" id="L271">				addComponent(m_localizer.formatYesNo(m_activity</span>
<span class="nc" id="L272">						.isTimeoffWithAllotment()));</span>
<span class="nc" id="L273">				addHiddenField(ActivityFields.TIMEOFF_WITH_ALLOTMENT);</span>
<span class="nc" id="L274">				break;</span>
			case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L276">				addHiddenField(ActivityFields.TIMEOFF_WITH_ALLOTMENT);</span>
<span class="nc" id="L277">				break;</span>
			default:
<span class="nc" id="L279">				throw new IllegalStateException();</span>
			}

			// Accrual Schedule, if no Accrual License, NON_DISPLAYABLE
<span class="pc bpc" id="L283" title="4 of 6 branches missed.">			switch (!hasLicense ? ActivityFields.NON_DISPLAYABLE : m_displayMap[ActivityFields.TIMEOFF_ACCRUAL_SCHEDULE]) {</span>
				case ActivityFields.EDITABLE:
<span class="fc" id="L285">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF_ACCRUAL_SCHEDULE, i++));</span>
<span class="fc" id="L286">					ArrayList options = new ArrayList();</span>
<span class="fc" id="L287">					options.add(new StringsPair(String.valueOf(Activity.TO_ACCRUAL_SCHEDULE_DAILY), ActivityModelHandler</span>
<span class="fc" id="L288">							.getAccrualScheduleStr(m_localizer, Activity.TO_ACCRUAL_SCHEDULE_DAILY)));</span>
<span class="fc" id="L289">					options.add(new StringsPair(String.valueOf(Activity.TO_ACCRUAL_SCHEDULE_WEEKLY), ActivityModelHandler</span>
<span class="fc" id="L290">							.getAccrualScheduleStr(m_localizer, Activity.TO_ACCRUAL_SCHEDULE_WEEKLY)));</span>
<span class="fc" id="L291">					options.add(new StringsPair(String.valueOf(Activity.TO_ACCRUAL_SCHEDULE_SEMI_MONTHLY), ActivityModelHandler</span>
<span class="fc" id="L292">							.getAccrualScheduleStr(m_localizer, Activity.TO_ACCRUAL_SCHEDULE_SEMI_MONTHLY)));</span>
<span class="fc" id="L293">					options.add(new StringsPair(String.valueOf(Activity.TO_ACCRUAL_SCHEDULE_MONTHLY), ActivityModelHandler</span>
<span class="fc" id="L294">							.getAccrualScheduleStr(m_localizer, Activity.TO_ACCRUAL_SCHEDULE_MONTHLY)));</span>
<span class="fc" id="L295">					options.add(new StringsPair(String.valueOf(Activity.TO_ACCRUAL_SCHEDULE_YEARLY), ActivityModelHandler</span>
<span class="fc" id="L296">							.getAccrualScheduleStr(m_localizer, Activity.TO_ACCRUAL_SCHEDULE_YEARLY)));</span>
<span class="fc" id="L297">					addComponent(HtmlUtil.makeSelectInput(ActivityFields.TIMEOFF_ACCRUAL_SCHEDULE_FN,</span>
<span class="fc" id="L298">							new String[] { String.valueOf(m_activity.getTOAccrualSchedule()) }, JSUtil.ON_CHANGE, options, false,</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">							!isFieldDisabled(ActivityFields.TIMEOFF_ACCRUAL_SCHEDULE)));</span>
<span class="fc" id="L300">					break;</span>
				case ActivityFields.DISPLAYABLE:
<span class="nc" id="L302">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF_ACCRUAL_SCHEDULE, i++));</span>
<span class="nc" id="L303">					addComponent(ActivityModelHandler.getAccrualScheduleStr(m_localizer, m_activity.getTOAccrualSchedule()));</span>
<span class="nc" id="L304">					addHiddenField(ActivityFields.TIMEOFF_ACCRUAL_SCHEDULE);</span>
<span class="nc" id="L305">					break;</span>
				case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L307">					addHiddenField(ActivityFields.TIMEOFF_ACCRUAL_SCHEDULE);</span>
<span class="nc" id="L308">					break;</span>
				default:
<span class="nc" id="L310">					throw new IllegalStateException();</span>
			}

			// Accrual Policy, if no Accrual License, NON_DISPLAYABLE
<span class="pc bpc" id="L314" title="4 of 6 branches missed.">			switch (!hasLicense ? ActivityFields.NON_DISPLAYABLE : m_displayMap[ActivityFields.TIMEOFF_ACCRUAL_POLICY]) {</span>
				case ActivityFields.EDITABLE:
<span class="fc" id="L316">					m_fields.append(addToTemplate(BbmWebBundleKey.ACCRUAL_POLICY, i++));</span>
<span class="fc" id="L317">					ArrayList options = new ArrayList();</span>
<span class="fc" id="L318">					options.add(new StringsPair(String.valueOf(Activity.ACCRUAL_POLICY_ALL_HOURS_ON_START), ActivityModelHandler</span>
<span class="fc" id="L319">							.getAccrualPolicyStr(m_localizer, Activity.ACCRUAL_POLICY_ALL_HOURS_ON_START)));</span>
<span class="fc" id="L320">					options.add(new StringsPair(String.valueOf(Activity.ACCRUAL_POLICY_PRORATED_ON_START), ActivityModelHandler</span>
<span class="fc" id="L321">							.getAccrualPolicyStr(m_localizer, Activity.ACCRUAL_POLICY_PRORATED_ON_START)));</span>
<span class="fc" id="L322">					options.add(new StringsPair(String.valueOf(Activity.ACCRUAL_POLICY_ALL_HOURS_ON_NEXT), ActivityModelHandler</span>
<span class="fc" id="L323">							.getAccrualPolicyStr(m_localizer, Activity.ACCRUAL_POLICY_ALL_HOURS_ON_NEXT)));</span>
<span class="fc" id="L324">					options.add(new StringsPair(String.valueOf(Activity.ACCRUAL_POLICY_PRORATED_ON_NEXT), ActivityModelHandler</span>
<span class="fc" id="L325">							.getAccrualPolicyStr(m_localizer, Activity.ACCRUAL_POLICY_PRORATED_ON_NEXT)));</span>
<span class="fc" id="L326">					addComponent(HtmlUtil.makeSelectInput(ActivityFields.TIMEOFF_ACCRUAL_POLICY_FN,</span>
<span class="fc" id="L327">							new String[] { String.valueOf(m_activity.getTOAccrualPolicy()) }, JSUtil.ON_CHANGE, options, false,</span>
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">							!isFieldDisabled(ActivityFields.TIMEOFF_ACCRUAL_POLICY)));</span>
<span class="fc" id="L329">					break;</span>
				case ActivityFields.DISPLAYABLE:
<span class="nc" id="L331">					m_fields.append(addToTemplate(BbmWebBundleKey.ACCRUAL_POLICY, i++));</span>
<span class="nc" id="L332">					addComponent(ActivityModelHandler.getAccrualPolicyStr(m_localizer, m_activity.getTOAccrualPolicy()));</span>
<span class="nc" id="L333">					addHiddenField(ActivityFields.TIMEOFF_ACCRUAL_POLICY);</span>
<span class="nc" id="L334">					break;</span>
				case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L336">					addHiddenField(ActivityFields.TIMEOFF_ACCRUAL_POLICY);</span>
<span class="nc" id="L337">					break;</span>
				default:
<span class="nc" id="L339">					throw new IllegalStateException();</span>
			}
			
			
<span class="fc" id="L343">		} else { // container is invisible</span>
<span class="nc" id="L344">			addHiddenField(ActivityFields.REQUESTABLE);</span>
<span class="nc" id="L345">			addHiddenField(ActivityFields.USE_DAILY_TOPOOL);</span>
<span class="nc" id="L346">			addHiddenField(ActivityFields.USE_INTERVAL_TOPOOL);</span>
<span class="nc" id="L347">			addHiddenField(ActivityFields.USE_ADVANCED_VTO_OPTIONS);</span>
<span class="nc" id="L348">			addHiddenField(ActivityFields.TIMEOFF_WITH_FLEX);</span>
<span class="nc" id="L349">			addHiddenField(ActivityFields.TIMEOFF_WITH_ALLOTMENT);</span>
<span class="nc" id="L350">			addHiddenField(ActivityFields.TIMEOFF_ACCRUAL_SCHEDULE);</span>
<span class="nc" id="L351">			addHiddenField(ActivityFields.TIMEOFF_ACCRUAL_POLICY);</span>
<span class="nc" id="L352">			addHiddenField(ActivityFields.USE_REQUIRED_PAY_PERIOD_HOURS);</span>
		}
<span class="fc" id="L354">		m_hiddenFields.append(HtmlUtil.makeHiddenInput(&quot;isActivityTypeWithAllotment&quot;, isActivityTypeWithAllotment()));</span>
<span class="fc" id="L355">	}</span>

	private boolean isTimeoffWithFlex(Activity activity) {
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">		return activityProperties.getTimeoffWithFlex() == ActivityProperties.FLEX_TIME;</span>
	}

	public boolean getRequestable() {
<span class="nc" id="L362">		return m_activity.isRequestable();</span>
	}

	public void setRequestable(boolean requestable) {
<span class="nc" id="L366">		m_activity.setRequestable(requestable);</span>
<span class="nc" id="L367">	}</span>

	public boolean getUseDailyTOPool() {
<span class="nc" id="L370">		return activityProperties.isUseDailyTOPool();</span>
	}

	public void setUseDailyTOPool(boolean useDailyTOPool) {
<span class="nc" id="L374">		activityProperties.setUseDailyTOPool(useDailyTOPool);</span>
<span class="nc" id="L375">	}</span>

	public boolean getUseIntervalTOPool() {
<span class="nc" id="L378">		return activityProperties.isUseIntervalTOPool();</span>
	}

	public void setUseIntervalTOPool(boolean useIntervalTOPool) {
<span class="nc" id="L382">		activityProperties.setUseIntervalTOPool(useIntervalTOPool);</span>
<span class="nc" id="L383">	}</span>

	public boolean getUseAdvancedVTOOptions() {
<span class="nc" id="L386">		return activityProperties.isUseAdvancedVTOOptions();</span>
	}

	public void setUseAdvancedVTOOptions(boolean useAdvancedVTOOptions) {
<span class="nc" id="L390">		activityProperties.setUseAdvancedVTOOptions(useAdvancedVTOOptions);</span>
<span class="nc" id="L391">	}</span>

	public boolean getTimeoffWithAllotment() {
<span class="nc" id="L394">		return m_activity.isTimeoffWithAllotment();</span>
	}

	public void setTimeoffWithAllotment(boolean isAllotment) {
<span class="nc" id="L398">		m_activity.setTimeoffWithAllotment(isAllotment);</span>
<span class="nc" id="L399">	}</span>

	public int getTimeoffAccrualSchedule() {
<span class="nc" id="L402">		return m_activity.getTOAccrualSchedule();</span>
	}

	public void setTimeoffAccrualSchedule(int value) {
<span class="nc" id="L406">		m_activity.setTOAccrualSchedule(value);</span>
<span class="nc" id="L407">	}</span>

	public int getTimeoffAccrualPolicy() {
<span class="nc" id="L410">		return m_activity.getTOAccrualPolicy();</span>
	}

	public void setTimeoffAccrualPolicy(int value) {
<span class="nc" id="L414">		m_activity.setTOAccrualPolicy(value);</span>
<span class="nc" id="L415">	}</span>

	@Override
	public void setDefaultValues() {
<span class="fc" id="L419">	};</span>

	/**
     * Add a tooltip to an HTML element
     */
    public String addTooltip(String htmlKey, String tooltipKey)
    {
<span class="fc" id="L426">    	String html = i18n(m_bundle, htmlKey);</span>
<span class="fc" id="L427">    	String tooltip = i18n(m_bundle, tooltipKey);</span>
<span class="fc" id="L428">    	return &quot;&lt;span title=\&quot;&quot; + tooltip + &quot;\&quot;&gt;&quot; + html + &quot;&lt;/span&gt;&quot;;</span>
    }

    private void addHiddenField(short field) {
<span class="nc bnc" id="L432" title="All 10 branches missed.">		switch (field) {</span>
			case ActivityFields.REQUESTABLE:
<span class="nc" id="L434">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.REQUESTABLE_FN, </span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">						m_activity.isRequestable() ? &quot;true&quot; : &quot;&quot;));</span>
<span class="nc" id="L436">				break;</span>
			case ActivityFields.USE_DAILY_TOPOOL:
<span class="nc" id="L438">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.USE_DAILY_TOPOOL_FN,</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">						activityProperties.isUseDailyTOPool() ? &quot;true&quot; : &quot;&quot;));</span>
<span class="nc" id="L440">				break;</span>
			case ActivityFields.USE_INTERVAL_TOPOOL:
<span class="nc" id="L442">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.USE_INTERVAL_TOPOOL_FN,</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">						activityProperties.isUseIntervalTOPool() ? &quot;true&quot; : &quot;&quot;));</span>
<span class="nc" id="L444">				break;</span>
			case ActivityFields.USE_ADVANCED_VTO_OPTIONS:
<span class="nc" id="L446">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.USE_ADVANCED_VTO_OPTIONS_FN,</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">						activityProperties.isUseAdvancedVTOOptions() ? &quot;true&quot; : &quot;&quot;));</span>
<span class="nc" id="L448">				break;</span>
			case ActivityFields.TIMEOFF_WITH_FLEX:
<span class="nc" id="L450">				m_hiddenFields</span>
<span class="nc" id="L451">						.append(HtmlUtil.makeHiddenInput(ActivityFields.TIMEOFF_WITH_FLEX_FN, activityProperties.getTimeoffWithFlex()));</span>
<span class="nc" id="L452">				break;</span>
			case ActivityFields.TIMEOFF_WITH_ALLOTMENT:
<span class="nc" id="L454">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.TIMEOFF_WITH_ALLOTMENT_FN,</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">						m_activity.isTimeoffWithAllotment() ? &quot;true&quot; : &quot;&quot;));</span>
<span class="nc" id="L456">				break;</span>
			case ActivityFields.TIMEOFF_ACCRUAL_SCHEDULE:
<span class="nc" id="L458">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.TIMEOFF_ACCRUAL_SCHEDULE_FN,</span>
<span class="nc" id="L459">						m_activity.getTOAccrualSchedule()));</span>
<span class="nc" id="L460">				break;</span>
			case ActivityFields.TIMEOFF_ACCRUAL_POLICY:
<span class="nc" id="L462">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.TIMEOFF_ACCRUAL_POLICY_FN,</span>
<span class="nc" id="L463">						m_activity.getTOAccrualPolicy()));</span>
<span class="nc" id="L464">				break;</span>
				
			case ActivityFields.USE_REQUIRED_PAY_PERIOD_HOURS:
<span class="nc" id="L467">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.USE_REQUIRED_PAY_PERIOD_HOURS_FN,</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">						activityProperties.getUseRequiredPayPeriodHours() ? &quot;true&quot; : &quot;&quot;));</span>
				break;
				
				
				
		}
<span class="nc" id="L474">		m_hiddenFields.append(&quot;\n&quot;);</span>
<span class="nc" id="L475">	}</span>

	private boolean isFieldDisabled(short field) {
<span class="fc" id="L478">		boolean disabled = false;</span>
<span class="pc bpc" id="L479" title="1 of 10 branches missed.">		switch (field) {</span>
			case ActivityFields.REQUESTABLE:
				// disable field if the activity not requestable and is not defined as absence or unavailability
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">				if (!m_activity.isRequestable()) {</span>
<span class="pc bpc" id="L483" title="2 of 4 branches missed.">					disabled = !(m_activity.isTimeoff() || m_activity.isUnavailability());</span>
				}
				break;
			case ActivityFields.USE_DAILY_TOPOOL:
				// disable field if the activity not requestable
<span class="pc bpc" id="L488" title="4 of 6 branches missed.">				disabled = !(m_activity.isTimeoff() || m_activity.isUnavailability()) || !m_activity.isRequestable();</span>
<span class="fc" id="L489">				break;</span>
			case ActivityFields.USE_INTERVAL_TOPOOL:
				// disable field if the activity not requestable
<span class="pc bpc" id="L492" title="4 of 6 branches missed.">				disabled = !(m_activity.isTimeoff() || m_activity.isUnavailability()) || !m_activity.isRequestable();</span>
<span class="fc" id="L493">				break;</span>
			case ActivityFields.USE_ADVANCED_VTO_OPTIONS:
				// disable field if not using Invterval TOPool
<span class="pc bpc" id="L496" title="1 of 2 branches missed.">				disabled = !activityProperties.isUseIntervalTOPool();</span>
<span class="fc" id="L497">				break;</span>
			case ActivityFields.TIMEOFF_WITH_FLEX:
				// disable field if the activity not timeoff or not requestable
<span class="pc bpc" id="L500" title="3 of 4 branches missed.">				disabled = !m_activity.isTimeoff() || !m_activity.isRequestable();</span>
<span class="fc" id="L501">				break;</span>
			case ActivityFields.TIMEOFF_WITH_ALLOTMENT:
				// disable field if ActivityType is with Allotment, or the activity is not timeoff with allotment and is not defined
				// as absence
<span class="pc bpc" id="L505" title="3 of 6 branches missed.">				if (isActivityTypeWithAllotment() || (!m_activity.isTimeoffWithAllotment() &amp;&amp; !m_activity.isTimeoff())) {</span>
<span class="fc" id="L506">					disabled = true;</span>
				}
				break;
			case ActivityFields.TIMEOFF_ACCRUAL_SCHEDULE:
				// disable field if ActivityType is with Allotment, or the activity is not timeoff
<span class="pc bpc" id="L511" title="2 of 4 branches missed.">				if (isActivityTypeWithAllotment() || !m_activity.isTimeoff()) {</span>
<span class="fc" id="L512">					disabled = true;</span>
				}
				break;
			case ActivityFields.TIMEOFF_ACCRUAL_POLICY:
				// disable field if ActivityType is with Allotment, or the activity is not timeoff
<span class="pc bpc" id="L517" title="2 of 4 branches missed.">				if (isActivityTypeWithAllotment() || !m_activity.isTimeoff()) {</span>
<span class="fc" id="L518">					disabled = true;</span>
				}
				break;
			case ActivityFields.USE_REQUIRED_PAY_PERIOD_HOURS:
				// disable field if the activity not requestable
<span class="pc bpc" id="L523" title="4 of 6 branches missed.">				disabled = !(m_activity.isTimeoff() || m_activity.isUnavailability()) || !m_activity.isRequestable();</span>
				break;
		}
<span class="fc" id="L526">		return disabled;</span>
	}

	private ActivityCategory getActivityType() {
<span class="pc bpc" id="L530" title="1 of 4 branches missed.">		if (m_activity == null || m_activity.getActivityCategoryId() == null)</span>
<span class="fc" id="L531">			return null;</span>
<span class="pc bpc" id="L532" title="1 of 4 branches missed.">		if (m_activityType == null || !m_activity.getActivityCategoryId().equals(m_activityType.getID())) {</span>
			try {
<span class="fc" id="L534">				m_activityType = ActivityTypeModelHandler.getActivityTypeByID(m_context, m_activity.getActivityCategoryId());</span>
<span class="nc" id="L535">			} catch (Exception ex) {</span>
<span class="nc" id="L536">				handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L537">			}</span>
		}
<span class="fc" id="L539">		return m_activityType;</span>
	}

	private boolean isActivityTypeWithAllotment() {
<span class="fc" id="L543">		boolean result = false;</span>
<span class="fc" id="L544">		ActivityCategory activityType = getActivityType();</span>
<span class="fc bfc" id="L545" title="All 2 branches covered.">		if (activityType != null) {</span>
<span class="fc" id="L546">			result = activityType.isTOAllotment();</span>
		}
<span class="fc" id="L548">		return result;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>