<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SpecialActivityAttributes.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.activity</a> &gt; <span class="el_source">SpecialActivityAttributes.java</span></div><h1>SpecialActivityAttributes.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.activity;

import java.util.*;
import com.witness.web.uif.pagecomponent.container.Collapsible2ColFormPC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.*;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.*;
import com.witness.web.uif.validator.*;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.common.datatypes.ID;

/**
 * Title:        SpecialActivityAttributes
 * Description:  A collapsable container for the Special Activity's attributes container
 * @author       Gonzalo Quintanar
 */

public class SpecialActivityAttributes extends Collapsible2ColFormPC {

	public static final int MAX_DURATION_DEFAULT_MIN = -1;
	public static final int TOLERANCE_DEFAULT_MIN = 5;

	private FormInputPC m_fiPC;
	
	protected static final String ACTIVITY_FIELD_ON_CHANGE = &quot;SpecialActivityOnChange(this);&quot;;

<span class="nc" id="L29">	protected boolean m_visible = true;</span>
	protected StringBuffer m_hiddenFields;
	protected StringBuffer m_fields;
	
	protected String m_maxDurationFN;
	protected String m_maxDurationCheckboxFN;
	protected String m_tolernaceFN;
	
	protected int m_adherenceTolerance;
	protected int m_maxDurationThreshold;	
<span class="nc" id="L39">	protected boolean m_isDurationUnlimited = true;</span>
	
	protected ID m_activityID; 
	protected String m_activityType; //Ex: &quot;None&quot;, &quot;Vto&quot;, etc. These are used for constructing the form element names
<span class="nc" id="L43">	protected boolean m_isEditable = true;</span>
	
	private short[] m_displayMap;
	
	public SpecialActivityAttributes(RequestContext context, ResourceBundle bundle) 
	{
<span class="nc" id="L49">		super(context, bundle);</span>
<span class="nc" id="L50">		m_fiPC = new FormInputPC(m_context);</span>
<span class="nc" id="L51">		addChildComponent(m_fiPC);</span>
<span class="nc" id="L52">	}</span>
	
	public void initForDisplay() {
<span class="nc bnc" id="L55" title="All 2 branches missed.">		if (m_isInitializedForDisplay) return;</span>
		else {
<span class="nc" id="L57">			super.initForDisplay();</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">			if(m_visible) {</span>
<span class="nc" id="L59">				setCollapsed(false);</span>
			}
		}
<span class="nc" id="L62">	}</span>
	
	public void initForm(ID activityID, String title, int adherenceTolerance, int maxDurationThreshold, boolean visible, 
			StringBuffer hiddenFields, boolean isEditable) 
	{
<span class="nc" id="L67">		m_isEditable = isEditable;</span>
<span class="nc" id="L68">		m_activityID = activityID;</span>
<span class="nc" id="L69">		m_activityType = SpecialActivityFormPageModel.getActivityType(activityID);</span>
<span class="nc" id="L70">		m_adherenceTolerance = adherenceTolerance;</span>
<span class="nc" id="L71">		m_maxDurationThreshold = maxDurationThreshold;</span>
		
<span class="nc" id="L73">		m_visible = visible;</span>
<span class="nc" id="L74">		m_hiddenFields = hiddenFields;</span>
		
<span class="nc" id="L76">		m_maxDurationFN = ActivityFields.MAX_DURATION_FN+m_activityType;</span>
<span class="nc" id="L77">		m_maxDurationCheckboxFN = ActivityFields.MAX_DURATION_CHKBOX_FN+m_activityType;</span>
<span class="nc" id="L78">		m_tolernaceFN = ActivityFields.TOLERANCE_FN+m_activityType;</span>
		
<span class="nc" id="L80">		m_displayMap = ActivityFields.getDisplayMap(m_activityID);</span>
		
<span class="nc" id="L82">		setTitle(title);</span>
<span class="nc" id="L83">		initFields();</span>
<span class="nc" id="L84">	}</span>

	protected void initFields() {
<span class="nc bnc" id="L87" title="All 2 branches missed.">		if(m_visible) </span>
		{
<span class="nc" id="L89">			m_fields = new StringBuffer(512);</span>
<span class="nc" id="L90">			int i = 0;</span>
			
<span class="nc bnc" id="L92" title="All 2 branches missed.">			if (m_isEditable)</span>
			{
				// Tolerance
<span class="nc bnc" id="L95" title="All 2 branches missed.">				if (m_displayMap[ActivityFields.TOLERANCE] == ActivityFields.EDITABLE)</span>
				{
<span class="nc" id="L97">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_FORM_TOLERANCE, i++));</span>
<span class="nc" id="L98">					addComponent(HtmlUtil.makeTextInput(m_tolernaceFN, 5, 5, getToleranceString(), JSUtil.ON_CHANGE));</span>
<span class="nc" id="L99">					addValidator(new IsNonNegativeIntegerFieldValidator(this, m_tolernaceFN,</span>
						BbmWebBundleKey.ACTIVITY_LABEL_FORM_TOLERANCE, BbmWebBundleKey.BUNDLE_NAME));
				}
				
				// Max Duration
<span class="nc bnc" id="L104" title="All 2 branches missed.">				if (m_displayMap[ActivityFields.MAX_DURATION] == ActivityFields.EDITABLE)</span>
				{
<span class="nc" id="L106">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_FORM_MAXTHRESHOLD, i++));</span>
<span class="nc" id="L107">					addComponent(getMaxDurationCombo());</span>
<span class="nc" id="L108">					addValidator(new IsNonNegativeIntegerFieldValidator(this, m_maxDurationFN,</span>
						BbmWebBundleKey.ACTIVITY_LABEL_LIST_MAXTHRESHOLD, BbmWebBundleKey.BUNDLE_NAME));
				}
			}
			else
			{
				// Tolerance
<span class="nc" id="L115">				m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_FORM_TOLERANCE, i++));</span>
<span class="nc" id="L116">				addComponent(getToleranceString());</span>
<span class="nc" id="L117">				addHiddenField(ActivityFields.TOLERANCE);</span>
				
				// Max Duration
<span class="nc" id="L120">				m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_FORM_MAXTHRESHOLD, i++));</span>
<span class="nc" id="L121">				addComponent(getMaxDurationString());</span>
<span class="nc" id="L122">				addHiddenField(ActivityFields.MAX_DURATION);</span>
			}
<span class="nc" id="L124">		}</span>
		else { // container is invisible
<span class="nc" id="L126">			addHiddenField(ActivityFields.TOLERANCE);</span>
<span class="nc" id="L127">			addHiddenField(ActivityFields.MAX_DURATION);</span>
		}

<span class="nc" id="L130">	}</span>

	public void setTolerance(int tolerance) {
<span class="nc" id="L133">		m_adherenceTolerance = tolerance;</span>
<span class="nc" id="L134">	}</span>

	public void setMaxDurationThreshold(int duration) {
<span class="nc" id="L137">		m_maxDurationThreshold = duration;</span>
<span class="nc" id="L138">	}</span>

	private String getToleranceString() {
<span class="nc" id="L141">		return Integer.toString(m_adherenceTolerance);</span>
	}

	private String getMaxDurationString() {
<span class="nc bnc" id="L145" title="All 2 branches missed.">		return isDurationUnlimited() ?&quot;&quot; : Integer.toString(m_maxDurationThreshold);</span>
	}

	private boolean isDurationUnlimited() {
<span class="nc" id="L149">		return m_isDurationUnlimited; //m_maxDurationThreshold == MAX_DURATION_DEFAULT_MIN;</span>
	}
	
	public void setDurationUnlimited(boolean isDurationUnlimited) {
<span class="nc" id="L153">		m_isDurationUnlimited = isDurationUnlimited;</span>
<span class="nc" id="L154">	}</span>

	/** creates a checkbox/label textinput/label combination for max duration */
	public String getMaxDurationCombo() {
<span class="nc" id="L158">		boolean unlimited = isDurationUnlimited();</span>

<span class="nc" id="L160">		StringBuffer sb = new StringBuffer(512);</span>
		// checkbox/label
<span class="nc" id="L162">		sb.append(HtmlChoiceInput.makeChkBoxInput(m_maxDurationCheckboxFN,</span>
<span class="nc" id="L163">										String.valueOf(unlimited),</span>
<span class="nc" id="L164">										i18n(m_bundle, BbmWebBundleKey.ACTIVITY_LABEL_UNLIMITED),</span>
										unlimited, ACTIVITY_FIELD_ON_CHANGE));
		// textinput/label
<span class="nc" id="L167">		sb.append(HtmlUtil.makeSpacerHtml(8, 1));</span>

		// Use a FieldInputPC because it supports the setMiscAttributes method,
		// which is used to set the onKeyUp event handler. onChange does not
		// take effect until the *next* event. 		
<span class="nc" id="L172">		m_fiPC.reset();</span>
<span class="nc" id="L173">		m_fiPC.setIsRequired(false);</span>
<span class="nc" id="L174">		m_fiPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="nc" id="L175">		m_fiPC.setInputValue(getMaxDurationString());</span>
<span class="nc" id="L176">		m_fiPC.setInputFN(m_maxDurationFN);</span>
<span class="nc" id="L177">		m_fiPC.setIsReadOnly(unlimited);</span>
<span class="nc" id="L178">		m_fiPC.setSize(5);</span>
<span class="nc" id="L179">		m_fiPC.setMiscAttributes(&quot;onKeyUp=&quot; + ACTIVITY_FIELD_ON_CHANGE);</span>
<span class="nc" id="L180">		m_fiPC.initForDisplay();</span>
<span class="nc" id="L181">		sb.append(m_fiPC.getHtmlDisplay());</span>
		
<span class="nc" id="L183">		sb.append(HtmlUtil.makeSpacerHtml(4, 1));</span>
<span class="nc" id="L184">		sb.append(i18n(m_bundle, BbmWebBundleKey.ACTIVITY_LABEL_MINUTES));</span>
<span class="nc" id="L185">		return sb.toString();</span>
	}

	public void setDefaultValues() {
<span class="nc" id="L189">		m_adherenceTolerance = TOLERANCE_DEFAULT_MIN;</span>
<span class="nc" id="L190">		m_maxDurationThreshold = MAX_DURATION_DEFAULT_MIN;</span>
<span class="nc" id="L191">	}</span>

	private void addHiddenField(short field) {
<span class="nc bnc" id="L194" title="All 3 branches missed.">		switch(field) {</span>
			case ActivityFields.MAX_DURATION:
<span class="nc" id="L196">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(m_maxDurationFN, getMaxDurationString()));</span>
<span class="nc" id="L197">				break;</span>
			case ActivityFields.TOLERANCE:
<span class="nc" id="L199">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(m_tolernaceFN, getToleranceString()));</span>
				break;
		}
<span class="nc" id="L202">		m_hiddenFields.append(&quot;\n&quot;);</span>
<span class="nc" id="L203">	}</span>

	/**
	 * Get string of the HTML representing this component.
	 */
	public String getHtmlDisplay() {
<span class="nc bnc" id="L209" title="All 2 branches missed.">		if(m_visible) {</span>
<span class="nc" id="L210">			return super.getHtmlDisplay(m_fields.toString());</span>
		}
		else {
<span class="nc" id="L213">			return &quot;&quot;;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>