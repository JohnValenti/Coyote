<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MyTimeModelHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.am.timecollection</a> &gt; <span class="el_source">MyTimeModelHandler.java</span></div><h1>MyTimeModelHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.am.timecollection;

import java.rmi.RemoteException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.am.AmEJBCreateException;
import com.bluepumpkin.ejb.am.AmManagerFactory;
import com.bluepumpkin.ejb.am.base.AmException;
import com.bluepumpkin.ejb.am.base.AmInvalidActivityException;
import com.bluepumpkin.ejb.am.mytime.ejb.MyTimeManager;
import com.bluepumpkin.ejb.am.mytime.model.MyTimeEvent;
import com.bluepumpkin.ejb.am.timecollection.model.RawTimeEntry;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.web.am.Log;
import com.bluepumpkin.web.am.l10n.AmWebLogBundleKey;
import com.bluepumpkin.web.bbm.workresource.WorkResourceModelHandler;
import com.bluepumpkin.web.core.base.ModelHandler;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        Blue Pumpkin Software Activity Management
 * Description:  Model Handler for My Time page
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       Swati Tewari
 * @version      1.0
 */

/**
	This class is the web tier representation of the MyTime module.
*/
<span class="nc" id="L45">public class MyTimeModelHandler extends ModelHandler{</span>
<span class="fc" id="L46">	private static MyTimeManager myTimeManager = null;</span>
<span class="fc" id="L47">	private static Category cat  = Log.initCategory(MyTimeModelHandler.class.getName());</span>

	/**
	* getMyTimeManager()
	* return MyTimeManager
	*/
	private static MyTimeManager getMyTimeManager()
	throws AmEJBCreateException{
<span class="fc bfc" id="L55" title="All 2 branches covered.">		if (myTimeManager == null){</span>
<span class="fc" id="L56">			myTimeManager = AmManagerFactory.getMyTimeManager();</span>
		}
<span class="fc" id="L58">		return myTimeManager;</span>
	}

	/**
	* getEmployeeOrgId()
	* return int
	*/
	public static ID getEmployeeOrgId(RequestContext context, ID empId){
<span class="fc" id="L66">		ID orgId = Organization.ROOT_ORG_ID_OBJ;//Organization.ROOT_ORG_ID;</span>
		try {
<span class="fc" id="L68">			return WorkResourceModelHandler.getWorkResourceManager(context).getEmployeeByID(empId,</span>
<span class="fc" id="L69">				new Date(), (long)Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY).getOrganizationID();</span>
<span class="nc" id="L70">		} catch (Exception bfe){</span>
<span class="nc" id="L71">			cat.l7dDebug(AmWebLogBundleKey.MSG_NO_USER_ORG, bfe);</span>
		}
<span class="nc" id="L73">		return orgId;</span>
	}

	/**
	* getHistoryEventsForToday()
	* return ArrayList of timerecords
	*/
	public static ArrayList getHistoryEventsForToday(ID empID, boolean ascend,  Calendar calendar)
	throws RemoteException, AmException{
<span class="fc" id="L82">		ArrayList myTimeEvent = null;</span>

		//set dates from start to end of calendar day: may need to use day boundaries??
<span class="fc" id="L85">		Date startDate = calendar.getTime();</span>

		//end day=start day + 1 day
<span class="fc" id="L88">		calendar.add(Calendar.DATE,1);</span>
<span class="fc" id="L89">		Date endDate = calendar.getTime();</span>

<span class="fc" id="L91">		myTimeEvent = (ArrayList)getMyTimeManager().getActualEvents(empID,</span>
			startDate, endDate);

<span class="pc bpc" id="L94" title="1 of 2 branches missed.">		if (  !ascend ) {</span>
			// reverse order of myTimeEvent
<span class="nc" id="L96">			ArrayList reversedTimeEvent = new ArrayList(myTimeEvent.size());</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">			for( int i = myTimeEvent.size() -1; i &gt;= 0 ;i-- ) {</span>
<span class="nc" id="L98">				reversedTimeEvent.add(myTimeEvent.get(i));</span>
			}
<span class="nc" id="L100">			myTimeEvent = reversedTimeEvent;</span>
		}

<span class="fc" id="L103">		return myTimeEvent;</span>
	}

	/**
	* getScheduleEventsForToday()
	* return MyTimeEvent
	*/
	public static ArrayList getScheduleEventsForDays(ID empID, Calendar aStrtCal, Calendar aEndCal, boolean bShowUnavail)
	throws RemoteException, AmException{
<span class="nc" id="L112">		ArrayList myTimeEvent = new ArrayList();</span>

<span class="nc" id="L114">		myTimeEvent = (ArrayList)getMyTimeManager().getScheduleEvents(empID,</span>
<span class="nc" id="L115">			TimeZoneUtil.toTimestamp(aStrtCal.getTime()), TimeZoneUtil.toTimestamp(aEndCal.getTime()));</span>

		//Changes start for QA98352
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (!bShowUnavail) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">			for (Iterator it = myTimeEvent.iterator(); it.hasNext();) {</span>
				//Changes starts for QA99911
<span class="nc" id="L121">				Object obj = it.next();</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">				if (obj instanceof MyTimeEvent) {</span>
<span class="nc" id="L123">					MyTimeEvent evt = (MyTimeEvent) obj;</span>
					//Changes End for QA99911
<span class="nc bnc" id="L125" title="All 2 branches missed.">					if (evt.getEventType() == Event.EVENT_TYPE_UNAVAILABILITY) {</span>
<span class="nc" id="L126">						it.remove();</span>
					}
				}
<span class="nc" id="L129">			}</span>
		}
		//Changes end for QA98352

<span class="nc" id="L133">		return myTimeEvent;</span>
	}

	/**
	* getChangeState()
	* return boolean for success
	*/
	public static ID getChangeState(MyTimeModel myTimeModel, boolean start) throws AmInvalidActivityException, Exception {
<span class="fc" id="L141">		ID punchID = null;</span>

		//make sure length of notes is not &gt;200
<span class="fc" id="L144">		String myNotes = myTimeModel.getNotes();</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">		if (myNotes.length()&gt;200){</span>
<span class="nc" id="L146">			myNotes = myNotes.substring(0, 200);</span>
		}

<span class="fc bfc" id="L149" title="All 2 branches covered.">		int punchCode = start ?RawTimeEntry.START_ACTIVITY:RawTimeEntry.END_SHIFT;</span>

		/*if (start &amp;&amp; myTimeModel.getState() == Activity.ACTIVITY_NONE.toInt()){
			punchCode = RawTimeEntry.START_SHIFT;
		}*/

<span class="fc" id="L155">		RawTimeEntry anEntry = new RawTimeEntry(new ID(myTimeModel.getEmpId()),</span>
<span class="fc" id="L156">						new ID(myTimeModel.getActivity()), null, myNotes, punchCode, new Timestamp(new Date().getTime()));</span>

<span class="fc" id="L158">			punchID = AmManagerFactory.getTimeCollectorManager().insertRawTimeEntry(anEntry,/*myTimeModel.getEnableDeviceId() ? myTimeModel.getDeviceID(): */&quot;&quot;);</span>

<span class="fc" id="L160">		return punchID;</span>
	}

	/**
	* getLogHistory()
	* return LogHistory for the given period: set in the LogHistoryModel
	*/
	public static ArrayList getLogHistoryForPeriod(LogHistoryModel logHistoryModel)
	throws Exception{
<span class="nc" id="L169">		Collection myTimeEvent = null;</span>

<span class="nc" id="L171">		myTimeEvent = WfmManagerFactory.getTimeRecordManager().getValidEventsForWorkResource(logHistoryModel.getEmpId(),</span>
<span class="nc" id="L172">				logHistoryModel.getStartDate(), logHistoryModel.getActualEndDate());</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">		if (myTimeEvent.equals(Collections.EMPTY_LIST))</span>
<span class="nc" id="L174">			  return new ArrayList();</span>
		else
<span class="nc" id="L176">         	return (ArrayList) myTimeEvent;</span>
	}

	/**
	* getCurrentActivity()
	* return Activity specifying current activity for the employee
	*/
	public static Activity getCurrentActivity(ID empId)
	throws Exception{
<span class="fc" id="L185">		Activity curActivity = new Activity();</span>

<span class="fc" id="L187">		curActivity = getMyTimeManager().findCurrentActivity(empId);</span>
<span class="fc" id="L188">		return curActivity;</span>
	}

	/**
	* Cache the deviceId in the proper scope
	*/
	//[Swati] London: no support for agent control
	/*
	public void cacheDeviceId(String deviceId){
		m_context.setAttribute(MODELSCOPE, &quot;device_id&quot;, deviceId);
	}*/

	/**
	* getLogHistoryModel()
	* return LogHistoryModel
	*/
	//[Swati] London: no support for agent control
	/*
	public String getDeviceId(){
		return (String)m_context.getAttribute(MODELSCOPE, &quot;device_id&quot;);
	}*/
}//MyTimeModelHandler
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>