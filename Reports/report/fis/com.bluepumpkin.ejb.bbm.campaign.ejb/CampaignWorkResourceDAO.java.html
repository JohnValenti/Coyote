<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignWorkResourceDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.campaign.ejb</a> &gt; <span class="el_source">CampaignWorkResourceDAO.java</span></div><h1>CampaignWorkResourceDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.campaign.ejb;

/**
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 */

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignWorkResource;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignWorkResourceFieldInfo;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.dao.DAOEffectivity;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourceInner;

public class CampaignWorkResourceDAO extends DAOEffectivity {

<span class="fc" id="L33">	private static FieldInfo m_fieldInfo = new CampaignWorkResourceFieldInfo();</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="fc" id="L37">		return m_fieldInfo;</span>
	}

	// private ChangeManager m_changeManager = null;

	public CampaignWorkResourceDAO() {
<span class="fc" id="L43">		super();</span>
<span class="fc" id="L44">	}</span>

	public CampaignWorkResourceDAO(Jdmo dmo) {
<span class="nc" id="L47">		super(dmo);</span>
<span class="nc" id="L48">	}</span>

	@Override
	protected ValueObjectBase createValueObject() {
<span class="nc" id="L52">		return (new CampaignWorkResource());</span>
	}

	/**
	 * When schedulingPeriod.isUsingAllEmployees() is set to false this is how
	 * we determine the assignments
	 * 
	 * 
	 */
	public Collection&lt;CampaignWorkResource&gt; getCampaignWorkResourceAssignmentsByLinkedEmployees(
			SchedulingPeriod schedulingPeriod) throws BbmFinderException {
<span class="fc" id="L63">		List&lt;CampaignWorkResource&gt; resources = new ArrayList&lt;CampaignWorkResource&gt;();</span>
<span class="fc" id="L64">		JdmoRowset r = null;</span>

		try {
<span class="fc" id="L67">			String query = &quot;SELECT DISTINCT map.WORKRESOURCEID, sp.FROMDATE, sp.TODATE, SP.SID \n&quot; + &quot; FROM SP sp \n&quot;</span>
					+ &quot; INNER JOIN SPWORKRESOURCE map \n&quot; + &quot;    ON map.SPID = SP.ID  \n&quot; + &quot; INNER JOIN WORKRESOURCE r \n&quot;
					+ &quot; 	ON r.ID = map.WORKRESOURCEID \n&quot; + &quot; 	AND r.WORKRESTYPE = '&quot; + WorkResourceInner.TYPE_EMPLOYEE
<span class="fc" id="L70">					+ &quot;' \n&quot; + &quot; WHERE SP.SID = &quot; + schedulingPeriod.getID() + &quot;   AND SP.FROMDATE &lt; '&quot;</span>
<span class="fc" id="L71">					+ JdmoUtil.formatDBString(schedulingPeriod.getEndTime()) + &quot;' \n&quot; + &quot; 	AND SP.TODATE &gt; '&quot;</span>
<span class="fc" id="L72">					+ JdmoUtil.formatDBString(schedulingPeriod.getStartTime())</span>
					+ &quot;'\n                                                                                               &quot;;

			// convert data to entities
<span class="fc" id="L76">			r = m_dmo.createRowset(query);</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L78">				ID employeeID = r.getID(&quot;WORKRESOURCEID&quot;);</span>
<span class="fc" id="L79">				Date startDate = r.getTimestamp(&quot;FROMDATE&quot;);</span>
<span class="fc" id="L80">				Date endDate = r.getTimestamp(&quot;TODATE&quot;);</span>
<span class="fc" id="L81">				ID SPID = r.getID(&quot;SID&quot;);</span>

<span class="fc" id="L83">				CampaignWorkResource resource = new CampaignWorkResource();</span>
				// Note this is SID
<span class="fc" id="L85">				resource.setCampaignID(schedulingPeriod.getCampaignID());</span>
<span class="fc" id="L86">				resource.setWorkResourceID(employeeID);</span>
<span class="fc" id="L87">				resource.setStartTime(startDate);</span>
<span class="fc" id="L88">				resource.setEndTime(endDate);</span>
<span class="fc" id="L89">				resource.setSPID(SPID);</span>

<span class="fc" id="L91">				resources.add(resource);</span>
<span class="fc" id="L92">			}</span>

<span class="fc" id="L94">			return resources;</span>

<span class="nc" id="L96">		} catch (JdmoException e) {</span>
<span class="nc" id="L97">			e.printStackTrace();</span>
<span class="nc" id="L98">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L100">			try {</span>
<span class="pc" id="L101">				r.close();</span>
<span class="nc" id="L102">			} catch (JdmoException e) {</span>

<span class="pc" id="L104">			}</span>
<span class="pc" id="L105">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * When schedulingPeriod.isUsingAllEmployees() is set to true this is how we
	 * determine the assignments
	 * 
	 * 
	 */
	public Collection&lt;CampaignWorkResource&gt; getCampaignWorkResourceAssignmentsByLinkedOrganizations(
			SchedulingPeriod schedulingPeriod) throws BbmFinderException {
<span class="fc" id="L117">		List&lt;CampaignWorkResource&gt; resources = new ArrayList&lt;CampaignWorkResource&gt;();</span>

<span class="fc" id="L119">		String query = &quot;SELECT DISTINCT staff.WORKRESOURCEID, sp.FROMDATE, sp.TODATE, SP.SID, map.ORGANIZATIONID, staff.STARTTIME, staff.ENDTIME \n&quot;</span>
				+ &quot; FROM SP sp \n&quot;
				+ &quot; INNER JOIN SPCALLCENTER map \n&quot;
				+ &quot;    ON map.SPID = sp.ID \n&quot;
				+ &quot; INNER JOIN WORKRESOURCEORGANIZATION staff \n&quot;
				+ &quot;    ON staff.ORGANIZATIONID =map.ORGANIZATIONID \n&quot;
				+ &quot;    AND staff.STARTTIME &lt; '&quot;
<span class="fc" id="L126">				+ JdmoUtil.formatDBString(schedulingPeriod.getEndTime())</span>
				+ &quot;' \n&quot;
				+ &quot;    AND (staff.ENDTIME &gt; '&quot;
<span class="fc" id="L129">				+ JdmoUtil.formatDBString(schedulingPeriod.getStartTime())</span>
				+ &quot;' OR staff.ENDTIME is null) \n&quot;
				+ &quot; INNER JOIN WORKRESOURCE r \n&quot;
				+ &quot;    ON r.ID = staff.WORKRESOURCEID \n&quot;
				+ &quot;    AND r.WORKRESTYPE = '&quot;
				+ WorkResourceInner.TYPE_EMPLOYEE
				+ &quot;' \n&quot;
				+ &quot; WHERE SP.isusingallemployees = 1 AND SP.SID = &quot;
<span class="fc" id="L137">				+ schedulingPeriod.getID()</span>
				+ &quot; \nUnion\n&quot;
				+ &quot; SELECT EMPLOYEEID, SP.FROMDATE, SP.TODATE, SP.SID, SPCALLCENTER.ORGANIZATIONID, PRule.STARTTIME, PRule.ENDTIME FROM EmployeePoolingRules PRule,empPoolingRulesOrganizations, SP,SPCALLCENTER &quot;
				+ &quot; WHERE SP.SID = &quot;
<span class="fc" id="L141">				+ schedulingPeriod.getID()</span>
				+ &quot; AND SPCALLCENTER.SPID = SP.ID &quot;
				+ &quot; AND SPCALLCENTER.ORGANIZATIONID = empPoolingRulesOrganizations.ORGANIZATIONID &quot;
				+ &quot; AND PRule.ID = empPoolingRulesOrganizations.poolingruleID &quot;
				+ &quot; AND ((PRule.STARTTIME &lt;= '&quot;
<span class="fc" id="L146">				+ JdmoUtil.formatDBString(schedulingPeriod.getStartTime())</span>
				+ &quot;'&quot;
				+ &quot; AND (PRule.ENDTIME &gt; '&quot;
<span class="fc" id="L149">				+ JdmoUtil.formatDBString(schedulingPeriod.getStartTime())</span>
				+ &quot;' OR PRule.ENDTIME is NULL))&quot;
				+ &quot; OR (PRule.STARTTIME&gt;= '&quot;
<span class="fc" id="L152">				+ JdmoUtil.formatDBString(schedulingPeriod.getStartTime())</span>
<span class="fc" id="L153">				+ &quot;' AND PRule.STARTTIME &lt; '&quot; + JdmoUtil.formatDBString(schedulingPeriod.getEndTime()) + &quot;'))&quot;;</span>

		// convert data to entities
<span class="fc" id="L156">		JdmoRowset r = null;</span>
		try {
<span class="fc" id="L158">			r = m_dmo.createRowset(query);</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L160">				ID employeeID = r.getID(&quot;WORKRESOURCEID&quot;);</span>
<span class="fc" id="L161">				Date startDate = r.getTimestamp(&quot;FROMDATE&quot;);</span>
<span class="fc" id="L162">				Date endDate = r.getTimestamp(&quot;TODATE&quot;);</span>
<span class="fc" id="L163">				ID SPID = r.getID(&quot;SID&quot;);</span>

<span class="fc" id="L165">				CampaignWorkResource resource = new CampaignWorkResource();</span>
				// Note this is SID
<span class="fc" id="L167">				resource.setCampaignID(schedulingPeriod.getCampaignID());</span>
<span class="fc" id="L168">				resource.setWorkResourceID(employeeID);</span>
<span class="fc" id="L169">				resource.setStartTime(startDate);</span>
<span class="fc" id="L170">				resource.setEndTime(endDate);</span>
<span class="fc" id="L171">				resource.setSPID(SPID);</span>

<span class="fc" id="L173">				resources.add(resource);</span>
<span class="fc" id="L174">			}</span>

<span class="fc" id="L176">			return resources;</span>

<span class="nc" id="L178">		} catch (JdmoException e) {</span>
<span class="nc" id="L179">			e.printStackTrace();</span>
<span class="nc" id="L180">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L182">			try {</span>
<span class="pc" id="L183">				r.close();</span>
<span class="nc" id="L184">			} catch (JdmoException e) {</span>
<span class="nc" id="L185">				m_dmo.cleanUp();</span>
<span class="pc" id="L186">			}</span>
		}
	}

	/**
	 * For a collection of work resource ids (usually employee ids) and a date
	 * range, return a map of work resource ids to the campaigns they are
	 * assigned to, only for those scheduling periods for which
	 * isUsingAllEmployees() does not obtain
	 * 
	 * @param startDate
	 *            null treated as unlimited
	 * @param endDate
	 *            null treated as unlimited
	 */
	public Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; getCampaignWorkResourceAssignmentsByLinkedEmployees(
			Collection&lt;ID&gt; workResourceIds, Date startDate, Date endDate) throws BbmFinderException {
<span class="fc" id="L203">		Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; resourceAssignmentMap = new HashMap&lt;ID, List&lt;CampaignWorkResource&gt;&gt;();</span>
<span class="pc bpc" id="L204" title="2 of 4 branches missed.">		if (workResourceIds == null || workResourceIds.size() == 0) {</span>
<span class="nc" id="L205">			return resourceAssignmentMap;</span>
		}

		// initialize map
<span class="fc bfc" id="L209" title="All 2 branches covered.">		for (ID id : workResourceIds) {</span>
<span class="fc" id="L210">			resourceAssignmentMap.put(id, new ArrayList&lt;CampaignWorkResource&gt;());</span>
<span class="fc" id="L211">		}</span>

<span class="fc" id="L213">		JdmoRowset r = null;</span>
		try {
<span class="fc" id="L215">			String query = &quot;SELECT DISTINCT c.sid AS c_sid, \n&quot; + &quot;    sp.sid AS sp_sid,  \n&quot; + &quot;    sp.fromdate, \n&quot;</span>
					+ &quot;    sp.todate, \n&quot; + &quot;    map.workresourceid \n&quot; + &quot; FROM spworkresource map \n&quot;
					+ &quot; INNER JOIN sp sp \n&quot; + &quot;    ON sp.id = map.spid \n&quot; + &quot;    AND SP.isusingallemployees = 0 \n&quot;
<span class="fc" id="L218">					+ &quot;    AND	sp.fromdate &lt; '&quot; + JdmoUtil.formatDBString(endDate) + &quot;' \n&quot; + &quot;    AND sp.todate &gt; '&quot;</span>
<span class="fc" id="L219">					+ JdmoUtil.formatDBString(startDate) + &quot;' \n&quot; + &quot; INNER JOIN campaign c \n&quot;</span>
					+ &quot;    ON sp.campaignid = c.id \n&quot; + &quot; WHERE  \n&quot; + &quot;    map.workresourceid IN &quot;
<span class="fc" id="L221">					+ (m_dmo.createInClause(workResourceIds));</span>

			// convert data to entities
<span class="fc" id="L224">			r = m_dmo.createRowset(query);</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L226">				ID campaignID = r.getID(&quot;c_sid&quot;);</span>
<span class="fc" id="L227">				Date fromDate = r.getTimestamp(&quot;fromdate&quot;);</span>
<span class="fc" id="L228">				Date toDate = r.getTimestamp(&quot;todate&quot;);</span>
<span class="fc" id="L229">				ID spSID = r.getID(&quot;sp_sid&quot;);</span>
<span class="fc" id="L230">				ID resourceID = r.getID(&quot;workresourceid&quot;);</span>
<span class="fc" id="L231">				CampaignWorkResource assignment = new CampaignWorkResource();</span>
<span class="fc" id="L232">				assignment.setCampaignID(campaignID);</span>
<span class="fc" id="L233">				assignment.setWorkResourceID(resourceID);</span>
<span class="fc" id="L234">				assignment.setStartTime(fromDate);</span>
<span class="fc" id="L235">				assignment.setEndTime(toDate);</span>
<span class="fc" id="L236">				assignment.setSPID(spSID);</span>
<span class="fc" id="L237">				resourceAssignmentMap.get(resourceID).add(assignment);</span>
<span class="fc" id="L238">			}</span>
<span class="fc" id="L239">			return resourceAssignmentMap;</span>
<span class="nc" id="L240">		} catch (JdmoException e) {</span>
<span class="nc" id="L241">			e.printStackTrace();</span>
<span class="nc" id="L242">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L244">			try {</span>
<span class="pc" id="L245">				r.close();</span>
<span class="nc" id="L246">			} catch (JdmoException e) {</span>
<span class="nc" id="L247">				m_dmo.cleanUp();</span>
<span class="pc" id="L248">			}</span>
		}
	}

	/**
	 * For a collection of work resource ids (usually employee ids) and a date
	 * range, return a map of work resource ids to the campaigns they are
	 * assigned to, only for those scheduling periods for which
	 * isUsingAllEmployees() obtains
	 * 
	 * @param startDate
	 *            null treated as unlimited
	 * @param endDate
	 *            null treated as unlimited
	 */
	public Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; getCampaignWorkResourceAssignmentsByLinkedOrganizations(
			Collection&lt;ID&gt; workResourceIds, Date startDate, Date endDate) throws BbmFinderException {
<span class="fc" id="L265">		Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; resourceAssignmentMap = new HashMap&lt;ID, List&lt;CampaignWorkResource&gt;&gt;();</span>
<span class="pc bpc" id="L266" title="2 of 4 branches missed.">		if (workResourceIds == null || workResourceIds.size() == 0) {</span>
<span class="nc" id="L267">			return resourceAssignmentMap;</span>
		}

		// initialize map
<span class="fc bfc" id="L271" title="All 2 branches covered.">		for (ID id : workResourceIds) {</span>
<span class="fc" id="L272">			resourceAssignmentMap.put(id, new ArrayList&lt;CampaignWorkResource&gt;());</span>
<span class="fc" id="L273">		}</span>

<span class="fc" id="L275">		JdmoRowset r = null;</span>
		try {
<span class="fc" id="L277">			String strEndDate = JdmoUtil.formatDBString(endDate);</span>
<span class="fc" id="L278">			String strStartDate = JdmoUtil.formatDBString(startDate);</span>
<span class="fc" id="L279">			String query = &quot;SELECT distinct c.sid AS c_sid, \n&quot; + &quot;    sp.sid AS sp_sid,  \n&quot; + &quot;    sp.fromdate, \n&quot;</span>
					+ &quot;    sp.todate, \n&quot; + &quot;    r_o.workresourceid  \n&quot; + &quot; FROM workresourceorganization r_o \n&quot;
					+ &quot; INNER JOIN spcallcenter sp_o \n&quot; + &quot;    ON sp_o.organizationid = r_o.organizationid \n&quot;
					+ &quot; INNER JOIN sp sp \n&quot; + &quot;    ON sp.id = sp_o.spid \n&quot; + &quot;    AND SP.isusingallemployees = 1 \n&quot;
					+ &quot;    AND sp.fromdate &lt; '&quot; + strEndDate + &quot;' \n&quot; + &quot;    AND sp.todate &gt; '&quot; + strStartDate + &quot;' \n&quot;
					+ &quot; INNER JOIN campaign c \n&quot; + &quot;    ON sp.campaignid = c.id \n&quot; + &quot; WHERE  \n&quot;
<span class="fc" id="L285">					+ &quot;    r_o.workresourceid IN &quot; + (m_dmo.createInClause(workResourceIds))</span>
					+ &quot;   AND r_o.starttime &lt; '&quot; + strEndDate + &quot;' \n&quot; + &quot;   AND isnull(r_o.endtime,'22000101') &gt; '&quot;
					+ strStartDate + &quot;'&quot;;

			// convert data to entities
<span class="fc" id="L290">			r = m_dmo.createRowset(query);</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L292">				ID campaignID = r.getID(&quot;c_sid&quot;);</span>
<span class="fc" id="L293">				Date fromDate = r.getTimestamp(&quot;fromdate&quot;);</span>
<span class="fc" id="L294">				Date toDate = r.getTimestamp(&quot;todate&quot;);</span>
<span class="fc" id="L295">				ID spSID = r.getID(&quot;sp_sid&quot;);</span>
<span class="fc" id="L296">				ID resourceID = r.getID(&quot;workresourceid&quot;);</span>
<span class="fc" id="L297">				CampaignWorkResource assignment = new CampaignWorkResource();</span>
<span class="fc" id="L298">				assignment.setCampaignID(campaignID);</span>
<span class="fc" id="L299">				assignment.setWorkResourceID(resourceID);</span>
<span class="fc" id="L300">				assignment.setStartTime(fromDate);</span>
<span class="fc" id="L301">				assignment.setEndTime(toDate);</span>
<span class="fc" id="L302">				assignment.setSPID(spSID);</span>
<span class="fc" id="L303">				resourceAssignmentMap.get(resourceID).add(assignment);</span>
<span class="fc" id="L304">			}</span>
<span class="fc" id="L305">			return resourceAssignmentMap;</span>
<span class="nc" id="L306">		} catch (JdmoException e) {</span>
<span class="nc" id="L307">			e.printStackTrace();</span>
<span class="nc" id="L308">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L310">			try {</span>
<span class="pc" id="L311">				r.close();</span>
<span class="nc" id="L312">			} catch (JdmoException e) {</span>
<span class="nc" id="L313">				m_dmo.cleanUp();</span>
<span class="pc" id="L314">			}</span>
		}
	}

	/**
	 * get the pooler assignments for the given set of Scheduling Periods.
	 * 
	 * @spIDs a collection of IDs of scheduling periods for which we want to
	 *        retrieve the pooling assignments.
	 * 
	 * @return a collection of work resource IDs which are poolers at any of the
	 *         given scheduling periods.
	 */
	public Collection&lt;ID&gt; getSPPoolerAssignments(Collection&lt;ID&gt; spIDs) throws BbmFinderException {
<span class="fc" id="L328">		return getSPPoolerAssignments(spIDs, null, null);</span>
	}

	/**
	 * get the pooler assignments for the given Scheduling Period between the
	 * given date range.
	 * 
	 * @spID sp id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 * 
	 * @return a collection of work resource IDs which are poolers at the given
	 *         scheduling period during the given time frame.
	 */
	public Collection&lt;ID&gt; getSPPoolerAssignments(ID spID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">		if (spID == null) {</span>
<span class="nc" id="L343">			return Collections.emptyList();</span>
		}
<span class="fc" id="L345">		return getSPPoolerAssignments(Collections.singleton(spID), dtStart, dtEnd);</span>
	}

	/**
	 * get the pooler assignments for the given Scheduling Periods between the
	 * given date range.
	 * 
	 * Note that if a collection of scheduling periods is given, then the dates
	 * should be null in this case. The date ranges will then be ignored and the
	 * dates used in the query will be the start and end dates of the respective
	 * scheduling periods.
	 * 
	 * If a single scheduling period is given, then the date ranges could be
	 * non-null if you want to specify a date range that might be a subset of
	 * the scheduling period date range. If the dates are null, the method will
	 * use the start/end dates of the scheduling period.
	 * 
	 * @spIDs a collection of IDs of scheduling periods for which we want to
	 *        retrieve the pooling assignments.
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 * 
	 * @return a collection of work resource IDs which are poolers at the given
	 *         scheduling periods during the given time frame.
	 */
	private Collection&lt;ID&gt; getSPPoolerAssignments(Collection&lt;ID&gt; spIDs, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="pc bpc" id="L370" title="2 of 4 branches missed.">		if (spIDs == null || spIDs.isEmpty()) {</span>
<span class="nc" id="L371">			return Collections.emptyList();</span>
		}
		// load all campaigns
<span class="fc" id="L374">		HashSet&lt;ID&gt; aAssignments = new HashSet&lt;ID&gt;();</span>
<span class="fc" id="L375">		JdmoRowset r = null;</span>
		try {
<span class="fc" id="L377">			StringBuffer query = new StringBuffer();</span>
<span class="fc" id="L378">			query.append(&quot;SELECT EMPLOYEEID FROM EmployeePoolingRules,empPoolingRulesOrganizations, SP,SPCALLCENTER &quot;);</span>
<span class="fc" id="L379">			query.append(&quot; WHERE SP.SID IN &quot;);</span>
<span class="fc" id="L380">			query.append(getDMO().createInClause(spIDs));</span>
<span class="fc" id="L381">			query.append(&quot; AND SPCALLCENTER.SPID = SP.ID &quot;);</span>
<span class="fc" id="L382">			query.append(&quot; AND SPCALLCENTER.ORGANIZATIONID = empPoolingRulesOrganizations.ORGANIZATIONID &quot;);</span>
<span class="fc" id="L383">			query.append(&quot; AND EmployeePoolingRules.ID = empPoolingRulesOrganizations.poolingruleID &quot;);</span>
<span class="fc" id="L384">			query.append(&quot; AND ((EmployeePoolingRules.STARTTIME &lt;= &quot;);</span>
<span class="fc bfc" id="L385" title="All 2 branches covered.">			if (dtStart != null) {</span>
<span class="fc" id="L386">				query.append(JdmoUtil.asSqlLiteral(dtStart));</span>
			} else {
<span class="fc" id="L388">				query.append(&quot; SP.FROMDATE &quot;);</span>
			}
<span class="fc" id="L390">			query.append(&quot; AND (EmployeePoolingRules.ENDTIME &gt; &quot;);</span>
<span class="fc bfc" id="L391" title="All 2 branches covered.">			if (dtEnd != null) {</span>
<span class="fc" id="L392">				query.append(JdmoUtil.asSqlLiteral(dtStart));</span>
			} else {
<span class="fc" id="L394">				query.append(&quot; SP.FROMDATE &quot;);</span>
			}
<span class="fc" id="L396">			query.append(&quot; OR EmployeePoolingRules.ENDTIME is NULL))&quot;);</span>
<span class="fc" id="L397">			query.append(&quot; OR (EmployeePoolingRules.STARTTIME &gt;= &quot;);</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">			if (dtStart != null) {</span>
<span class="fc" id="L399">				query.append(JdmoUtil.asSqlLiteral(dtStart));</span>
			} else {
<span class="fc" id="L401">				query.append(&quot; SP.FROMDATE &quot;);</span>
			}
<span class="fc" id="L403">			query.append(&quot; AND EmployeePoolingRules.STARTTIME &lt; &quot;);</span>
<span class="fc bfc" id="L404" title="All 2 branches covered.">			if (dtEnd != null) {</span>
<span class="fc" id="L405">				query.append(JdmoUtil.asSqlLiteral(dtEnd));</span>
			} else {
<span class="fc" id="L407">				query.append(&quot; SP.TODATE &quot;);</span>
			}
<span class="fc" id="L409">			query.append(&quot;))&quot;);</span>

<span class="fc" id="L411">			r = m_dmo.createRowset(query.toString());</span>

<span class="pc bpc" id="L413" title="1 of 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L414">				ID idEmployee = r.getID(&quot;EMPLOYEEID&quot;);</span>
<span class="nc" id="L415">				aAssignments.add(idEmployee);</span>
<span class="nc" id="L416">			}</span>

<span class="fc" id="L418">			r.close();</span>
<span class="fc" id="L419">			return aAssignments;</span>

<span class="nc" id="L421">		} catch (JdmoException e) {</span>
<span class="nc" id="L422">			e.printStackTrace();</span>
<span class="nc" id="L423">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L425">			try {</span>
<span class="pc" id="L426">				r.close();</span>
<span class="nc" id="L427">			} catch (JdmoException e) {</span>
<span class="nc" id="L428">				m_dmo.cleanUp();</span>
<span class="pc" id="L429">			}</span>
		}
	}

	/**
	 * get a campaign workresource assignment object by id
	 * 
	 */
	public CampaignWorkResource getCampaignWorkResourceAssignmentByID(ID idAssignment) throws BbmFinderException {
<span class="nc" id="L438">		return (CampaignWorkResource) getObjectByID(idAssignment);</span>
	}

	/**
	 * Get campaign work resource assignments given their ids
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public Collection&lt;CampaignWorkResource&gt; getCampaignWorkResourceAssignmentsByIDs(Collection&lt;ID&gt; colAssignmentIDs)
			throws BbmFinderException {
<span class="nc" id="L447">		return getObjectsByIDs(colAssignmentIDs);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>