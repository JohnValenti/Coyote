<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StaffingProfilesListPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.staffingprofiles</a> &gt; <span class="el_source">StaffingProfilesListPopupPM.java</span></div><h1>StaffingProfilesListPopupPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.staffingprofiles;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SPEmpTemplate;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTemplate;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTemplateFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.fs.workrules.WorkRulesJSFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.PopupWindowPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;


public class StaffingProfilesListPopupPM extends PopupWindowPM {
	private static final long serialVersionUID = 1L;

	public static final String FORM_ACTION = &quot;staffing_profiles_list_popup&quot;;
	public static final String POPUP_ID = &quot;POPUP_STAFFING_PROFILES&quot;;
	public static final String POPUP_ARGS = &quot;otExtensionIDs,isByOrg,isSelectionPopup,ownerID,selectedIDs&quot;;

	private StaffingProfilesListPC m_listPC;
	private ID ownerID;
	private boolean isByOrg;
<span class="fc" id="L47">	private boolean isSelectionPopup = false;</span>
<span class="fc" id="L48">	private HashSet&lt;ID&gt; selectedIDs = new HashSet&lt;ID&gt;();</span>
<span class="fc" id="L49">	private Collection&lt;EmployeeTemplate&gt; empTemplates = new HashSet&lt;EmployeeTemplate&gt; ();</span>

<span class="fc" id="L51">	private Map&lt;ID, Organization&gt; orgMap = new HashMap&lt;ID, Organization&gt;();</span>
<span class="fc" id="L52">	private Map&lt;ID, Campaign&gt; campaignMap = new HashMap&lt;ID, Campaign&gt;();</span>
<span class="fc" id="L53">	private Map&lt;ID, Activity&gt; activityMap = new HashMap&lt;ID, Activity&gt;();</span>

<span class="fc" id="L55">	boolean m_shouldCloseOnLoad = false; //default</span>


	public StaffingProfilesListPopupPM(RequestContext context) {
<span class="fc" id="L59">		super(context);</span>

<span class="fc" id="L61">		addRequiredJavaScriptFile(WorkRulesJSFileID.WORK_RULES_UTIL);</span>
<span class="fc" id="L62">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="fc" id="L63">	}</span>

	public static StaffingProfilesListPopupPM getInstance(RequestContext context) {
<span class="fc" id="L66">		return (StaffingProfilesListPopupPM)getInstance(context, StaffingProfilesListPopupPM.class);</span>
	}

	protected void initializeModel() {
<span class="fc bfc" id="L70" title="All 2 branches covered.">		if (m_isInitialized)</span>
<span class="fc" id="L71">			return;</span>
		else
<span class="fc" id="L73">			m_isInitialized = true;</span>
		try {
<span class="fc" id="L75">			loadData();</span>
<span class="fc" id="L76">			initContentTitle();</span>
<span class="fc" id="L77">			initList();</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">			if (isSelectionPopup) {</span>
				
				//boolean isEnable = (empTemplates.size() &gt; 0 &amp;&amp; selectedIDs.size()&gt;0 ? true:false);

<span class="fc" id="L82">				ToolbarTextButton addButton = m_toolbar.addSubmitTextButton(PageAction.ADD, m_toolbar.i18nCore(CoreWebBundleKey.TOOLBAR_SAVE), true);</span>
				//				addButton.setCustomJS(&quot;alert(table.getSelectedRowList())&quot;);
<span class="fc" id="L84">				addButton.setCustomJS(&quot;setSelectedIDs()&quot;);</span>
				//m_toolbar.addToolbarElement(addButton);
<span class="fc" id="L86">				m_toolbar.addCloseWindowTextButton(PageAction.CANCEL, m_localizer.i18n(</span>
						CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_CANCEL), true);
				//ToolbarUtil.addCloseWindowCancelBtn(m_toolbar, true);

			}

<span class="fc" id="L92">			setIsRefreshOpenerOnClose(true);</span>
<span class="nc" id="L93">		} catch (Exception ex) {</span>
<span class="nc" id="L94">			handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L95">		}</span>
<span class="fc" id="L96">	}</span>

	protected void initUtilityPane() {
<span class="fc" id="L99">		getUtilityPane().setIsHelpEnabled(false);</span>
<span class="fc" id="L100">	}</span>

	protected void initContentTitle() {
<span class="fc" id="L103">		m_contentTitlePC.setPageTitle(getLocalizer().i18n(</span>
				FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES));
<span class="fc" id="L105">	}</span>

	protected void loadData() throws Exception {
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">		if (ownerID != null) {</span>
<span class="fc" id="L109">			SchedulingPeriod selectedSchedulingPeriod = CampaignModelHandler.getSchedulingPeriodByID(</span>
					m_context, ownerID);
<span class="fc" id="L111">			CampaignManager campaignMgr = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L112">			Campaign camp = campaignMgr.getCampaignByID(selectedSchedulingPeriod.getCampaignID());</span>
<span class="fc" id="L113">			campaignMap.put(camp.getID(), camp);	</span>
			
<span class="fc" id="L115">			Collection&lt;ID&gt; orgs = campaignMgr.getOrganizationsForCampaign(selectedSchedulingPeriod.getCampaignID(), </span>
<span class="fc" id="L116">					selectedSchedulingPeriod.getStartTime(), selectedSchedulingPeriod.getEndTime());</span>

<span class="fc" id="L118">			ID spid = selectedSchedulingPeriod.getID();</span>
<span class="fc" id="L119">			Collection spEmpTemplateCollection = campaignMgr.getSPEmpTemplatesBySP(spid);</span>
<span class="fc" id="L120">			ArrayList empTemplatesAlreadyAdded = new ArrayList();</span>
<span class="fc" id="L121">			Iterator it = spEmpTemplateCollection.iterator();</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">			while(it.hasNext())</span>
			{
<span class="nc" id="L124">				SPEmpTemplate spEmp = (SPEmpTemplate) it.next();</span>
<span class="nc" id="L125">				ID empID = spEmp.getEmpTemplateID();</span>
<span class="nc" id="L126">				empTemplatesAlreadyAdded.add(empID);</span>
<span class="nc" id="L127">			}</span>

<span class="fc" id="L129">			ScheduleAccessManager saMgr = WfmManagerFactory.getScheduleAccessManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L130">			WorkResourceManager wrMgr = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L131">			Collection&lt;Organization&gt; orgObjs = wrMgr.getOrganizationsByIDs(orgs);</span>
<span class="fc" id="L132">			orgMap = ValueObjectUtil.getIDObjectMap(orgObjs);</span>
			
			//			Collection employeeTemplateIDs = new HashSet&lt;ID&gt;();
<span class="fc bfc" id="L135" title="All 2 branches covered.">			for (ID id: orgs)	{</span>
<span class="fc" id="L136">				Collection&lt;EmployeeTemplate&gt; employeeTemplatesForOrg = saMgr.getEmployeeTemplatesInOrg(id);</span>

				// filter out already added spEmpTemplates
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">				if(empTemplatesAlreadyAdded.size() &gt; 0)</span>
				{
<span class="nc" id="L141">					Iterator&lt;EmployeeTemplate&gt; iter = employeeTemplatesForOrg.iterator();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">					while (iter.hasNext()) {</span>
<span class="nc" id="L143">						EmployeeTemplate eTemplate = iter.next();</span>
<span class="nc" id="L144">						ID eID = (ID)eTemplate.getFieldValue(EmployeeTemplateFieldInfo.EMPTEMPLATE_ID);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">						if (empTemplatesAlreadyAdded.contains(eID)) iter.remove();</span>
<span class="nc" id="L146">					}</span>
				}
				// check if already added - this is not required if SPTemplates are already filtered out
<span class="fc bfc" id="L149" title="All 2 branches covered.">				if (selectedIDs.size() &gt; 0) {</span>
<span class="fc" id="L150">					Iterator&lt;EmployeeTemplate&gt; iter = employeeTemplatesForOrg.iterator();</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">					while (iter.hasNext()) {</span>
<span class="fc" id="L152">						EmployeeTemplate eTemplate = iter.next();</span>
<span class="fc" id="L153">						ID eID = (ID)eTemplate.getFieldValue(EmployeeTemplateFieldInfo.EMPTEMPLATE_ID);</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">						if (selectedIDs.contains(eID)) iter.remove();</span>
<span class="fc" id="L155">					}</span>
				}  

				//get rid of phaontoms
<span class="fc" id="L159">				Iterator&lt;EmployeeTemplate&gt; iterPhantom = employeeTemplatesForOrg.iterator();</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">				while (iterPhantom.hasNext()) {</span>
<span class="fc" id="L161">					EmployeeTemplate eTemplate = iterPhantom.next();</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">					if (eTemplate.getIsHidden()) iterPhantom.remove();</span>
<span class="fc" id="L163">				}</span>
				
<span class="fc" id="L165">				empTemplates.addAll(employeeTemplatesForOrg);		</span>
<span class="fc" id="L166">			}</span>

			//			empTemplates = wrMgr.getEmployeeTemplatesByIDs(employeeTemplateIDs);
		} 
<span class="fc" id="L170">	}</span>

	protected void initList() {
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">		if (m_listPC == null) {</span>
			//			m_listPC = new StaffingProfilesListPC(getRequestContext(), otExtensions, orgMap, 
			//					campaignMap, activityMap); 

<span class="fc" id="L177">			m_listPC = new StaffingProfilesListPC(m_context, null, empTemplates, </span>
					isByOrg,0,9999, orgMap, campaignMap, activityMap, /*empTypeMap*/null); // min/max phantoms -&gt; 0/9999
<span class="fc" id="L179">			addChildComponent(m_listPC);</span>
		}
<span class="fc" id="L181">	}</span>

	public String getHtmlDisplay() {
<span class="fc" id="L184">		String html = m_listPC.getHtmlDisplay();</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">		if (m_listPC.hasWeekStartMisAlligned()) {</span>
<span class="nc" id="L186">			html += ((&quot;&lt;br&gt;&lt;br&gt;&lt;p align=\&quot;left\&quot;&gt;&quot;) + m_localizer.i18n(</span>
					FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_CAMP_PROFILE_WARNING) +(&quot;&lt;/p&gt;&quot;));
		}
<span class="fc" id="L189">		return html;</span>
	}

	public void setIsByOrg(boolean isByOrg) {
<span class="fc" id="L193">		this.isByOrg = isByOrg;</span>
<span class="fc" id="L194">	}</span>

	public void setIsSelectionPopup(boolean isSelectionPopup) {
<span class="fc" id="L197">		this.isSelectionPopup = isSelectionPopup;</span>
<span class="fc" id="L198">	}</span>

	public void setOwnerID(String ownerID) {
<span class="fc" id="L201">		this.ownerID = new ID(ownerID);</span>
<span class="fc" id="L202">	}</span>

	public void setSelectedIDs(String selectedIDs) {
<span class="fc" id="L205">		this.selectedIDs = new HashSet&lt;ID&gt;(StringUtil.parseIDStringToCollection(selectedIDs));</span>
<span class="fc" id="L206">	}</span>

	public void setShouldCloseOnLoad(boolean b)
	{
<span class="fc" id="L210">		m_shouldCloseOnLoad = b;</span>
<span class="fc" id="L211">	}</span>

	/**
	 * Return JavaScript Init Code
	 */

	public String getJavaScriptInitCode() {
<span class="fc" id="L218">		String superJS = super.getJavaScriptInitCode();</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">		return superJS + &quot;\n&quot; +  (m_shouldCloseOnLoad ? &quot;window.close();\n&quot; : &quot;&quot;);</span>
	}

	public Collection&lt;SPEmpTemplate&gt; getSPEmpTemplates(RequestContext context){
<span class="fc" id="L223">		Collection&lt;SPEmpTemplate&gt; col = new HashSet&lt;SPEmpTemplate&gt;();</span>
		//		Collection&lt;ID&gt; empTemplateIDs = m_listPC.getSelectedRowIDs();
<span class="fc bfc" id="L225" title="All 2 branches covered.">		for (ID id: selectedIDs) {</span>
<span class="fc" id="L226">			SPEmpTemplate spET = new SPEmpTemplate();</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">			if(ownerID != null)</span>
<span class="fc" id="L228">				spET.setSPID(ownerID);</span>
<span class="fc" id="L229">			spET.setEmpTemplateID(id);</span>
<span class="fc" id="L230">			spET.setMinAllocation(0);</span>
<span class="fc" id="L231">			spET.setMaxAllocation(100);</span>
<span class="fc" id="L232">			spET.setMinNumEmployees(0);</span>
<span class="fc" id="L233">			spET.setMaxNumEmployees(9999);</span>
			//spET.setUseAllocPercentage(0);
<span class="fc" id="L235">			col.add(spET);</span>
<span class="fc" id="L236">		}</span>
<span class="fc" id="L237">		return col;</span>
	}

	public String getCustomJavaScript()  {
		//alert(DOM2.getElementByID('tableRef').getSelectedRowList())
<span class="fc" id="L242">		String str = &quot;function setSelectedIDs() {&quot;;</span>
		//str += &quot;\n alert('DOM2=' + DOM2);&quot;;
		//str += &quot;\n alert('DOM2.getElementById(tableRef)=' + DOM2.getElementById('tableRef'));&quot;;
		//str += &quot;\n alert('DOM2.getElementById(tableRef).getSelectedRowList()=' + DOM2.getElementById('tableRef').getSelectedRowList());&quot;;
<span class="fc" id="L246">		str += &quot;\n  var curStr = '';&quot;;</span>
<span class="fc" id="L247">		str += &quot;\n  var selectedStr = '';&quot;;</span>
<span class="fc" id="L248">		str += &quot;\n if( table.getSelectedRowList()== null) return;&quot;;</span>
<span class="fc" id="L249">		str += &quot;\n  var rowNames = table.getSelectedRowList();&quot;;</span>
		//str += &quot;\n alert(rowNames);&quot;;
<span class="fc" id="L251">		str += &quot;\n  if (rowNames.length == 0) return;&quot;;</span>
		//str += &quot;\n alert('2');&quot;;
<span class="fc" id="L253">		str += &quot;\n  for (var i = 0; i &lt; rowNames.length; i++) {&quot;;</span>
<span class="fc" id="L254">		str += &quot;\n  curStr = DOM2.getElementById('table'+ rowNames[i]).getAttribute('uid');&quot;;</span>
		//str += &quot;\n alert('curStr' + curStr);&quot;;
<span class="fc" id="L256">		str += &quot;\n selectedStr += curStr;&quot;;</span>
<span class="fc" id="L257">		str += &quot;\n if (i != rowNames.length -1) selectedStr += ','&quot;;</span>
<span class="fc" id="L258">		str += &quot;\n }&quot;;</span>
		//str += &quot;\n alert(selectedStr);&quot;;

<span class="fc" id="L261">		str += &quot;\n DOM2.getElementById('selectedIDs').value=selectedStr;&quot;;</span>
		//str += &quot;\n alert('selectedStr' + selectedStr);&quot;;
<span class="fc" id="L263">		str += &quot;\n }&quot;; </span>

<span class="fc" id="L265">		return super.getCustomJavaScript() + &quot; &quot; + str;</span>
	} 

	public String getRequiredHTML() {
		//return HtmlUtil.makeHiddenInput(&quot;selectedIDs&quot;, &quot;&quot;);
<span class="fc" id="L270">		StringBuffer reqHtml = new StringBuffer(512);</span>
<span class="fc" id="L271">		reqHtml.append(super.getRequiredHTML());</span>

<span class="fc" id="L273">		reqHtml.append(&quot;\n&quot;);</span>
<span class="fc" id="L274">		reqHtml.append(HtmlUtil.makeHiddenInput(&quot;selectedIDs&quot;, &quot;&quot;));</span>
<span class="fc" id="L275">		reqHtml.append(&quot;\n&quot;);</span>

<span class="fc" id="L277">		return reqHtml.toString();</span>
	} 
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>