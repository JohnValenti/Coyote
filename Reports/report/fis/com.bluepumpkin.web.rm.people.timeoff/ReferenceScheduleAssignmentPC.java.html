<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ReferenceScheduleAssignmentPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.people.timeoff</a> &gt; <span class="el_source">ReferenceScheduleAssignmentPC.java</span></div><h1>ReferenceScheduleAssignmentPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.people.timeoff;

import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.EmployeeReferenceScheduleAssignment;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.EmployeeReferenceScheduleAssignmentUpdateParameters;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.people.profile.ProfileAdminPC;
import com.bluepumpkin.web.bbm.people.profile.ProfilePageModel;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.verint.web.rm.rest.util.RmUtils;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.date.DateRangePickerPC;
import com.witness.web.uif.pagemodel.WorkpaneFieldNames;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;

/**
 * This is the collapsible container containing the current reference schedule name,
 *  the button to show the dialog to pick the effective dates and the reference schedule, 
 *  and the from and to dates for the current reference schedule. 
 *  
 *  
 *  This component is added to the employee's time off page  
 */
public class ReferenceScheduleAssignmentPC extends CollapsibleContainerPC {

<span class="nc" id="L41">	public enum Mode {</span>
<span class="nc" id="L42">		VIEW(&quot;VIEW_REF_SCHEDULE&quot;), SAVE(&quot;SAVE_REF_SCHEDULE&quot;);</span>

		private final String text;

<span class="nc" id="L46">		private Mode(final String text) {</span>
<span class="nc" id="L47">			this.text = text;</span>
<span class="nc" id="L48">		}</span>

		@Override
		public String toString() {
<span class="nc" id="L52">			return text;</span>
		}

	}

	//HTML field names
	private static class Fields {
		private static final String DATE_RANGE = &quot;refSchedule_EffDate&quot;;
		private static final String NAME = &quot;refScheduleName&quot;;
		private static final String ID = &quot;refScheduleID&quot;;
		private static final String IS_EDITABLE = &quot;refScheduleIsEditable&quot;;
		private static final String IS_VIEWABLE = &quot;refScheduleIsViewable&quot;;
		private static final String VIEW_DATE = &quot;refScheduleViewDate&quot;;
		private static final String REF_SCHEDULE_MODE=&quot;refScheduleMode&quot;;
		
		//Names of form fields whose values are passed to the ReferenceScheduleEffectivePopupPM dialog
		//@formatter:off
<span class="nc" id="L69">		private static final String FORM_FIELDS = String.format(&quot;%s,%s,%s,%s,%s&quot;, </span>
				WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN, 
				VIEW_DATE,
				ProfilePageModel.SHOW_AS_DATE_FN,
				NAME,
				ID);
		
<span class="nc" id="L76">		private static final String BUTTON_ATTRIBUTE_FIELDS = String.format(&quot;%s,%s,%s,%s&quot;, </span>
				REF_SCHEDULE_MODE, 
				ProfileAdminPC.IS_NEW_FN,
				ProfileAdminPC.EFF_START_DATE_FN,
				ProfileAdminPC.EFF_END_DATE_FN);
		
		//@formatter:on

<span class="nc" id="L84">		private Fields() {</span>

<span class="nc" id="L86">		}</span>
	}

	private static final long serialVersionUID = 1L;
	private static final int DEFAULT_FIELD_WIDTH = 50;

	private final transient ResourceBundle rmBundle;
<span class="nc" id="L93">	private Mode mode = Mode.VIEW;</span>
	private Collection&lt;ID&gt; selectedEmployeeIds;
	private Date viewDate;
	private Employee employee;
	private boolean isEditable;
	private final DateRangePickerPC dateRangePickerPC;
	private final transient ReferenceScheduleAssignmentViewModel viewModel;


	public ReferenceScheduleAssignmentPC(RequestContext context) {
<span class="nc" id="L103">		super(context);</span>
<span class="nc" id="L104">		rmBundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L105">		dateRangePickerPC = createDateRangePicker();</span>
<span class="nc" id="L106">		viewModel = new ReferenceScheduleAssignmentViewModel();</span>

<span class="nc" id="L108">		setName(&quot;ReferenceScheduleAssignmentPC&quot;);</span>

<span class="nc" id="L110">		addPopupArgs(</span>
		//sCmd The unique name associated with the Popup Argument
				ReferenceScheduleEffectivityPopupPM.POPUP_COMMAND,
				//URL 
				ReferenceScheduleEffectivityPopupPM.FORM_ACTION,
				//Name of this form's fields whose values are passed to the dialog
<span class="nc" id="L116">				Fields.FORM_FIELDS,</span>
				//Attribute names that are on the popup show (edit) button. The value of these attributes are passed to the dialog
<span class="nc" id="L118">				Fields.BUTTON_ATTRIBUTE_FIELDS,</span>
				//arguments 
				&quot;650,500,ctr,ctr&quot;,
				//show as modal dialog
				true,
				//the number of popup windows allowed
				1);
<span class="nc" id="L125">	}</span>

	@Override
	public void initForDisplay() {
<span class="nc bnc" id="L129" title="All 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L130">			return;</span>
		} else {
<span class="nc" id="L132">			super.initForDisplay();</span>
<span class="nc" id="L133">			initContent();</span>
		}
<span class="nc" id="L135">	}</span>

	public void initialize(Employee employee, Collection&lt;ID&gt; employeeIds, Date viewDate, boolean isEditable) throws Exception {
<span class="nc" id="L138">		this.employee = employee;</span>
<span class="nc" id="L139">		selectedEmployeeIds = employeeIds;</span>
<span class="nc" id="L140">		this.viewDate = viewDate;</span>
<span class="nc" id="L141">		this.isEditable = isEditable;</span>
<span class="nc" id="L142">		Map&lt;ID, EmployeeReferenceScheduleAssignment&gt; assignments = TimeOffMH.getReferenceScheduleForWorkResources(employeeIds, viewDate);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">		int selectedEmployeeCount = employeeIds==null ? 0:employeeIds.size();</span>
<span class="nc" id="L144">		List&lt;EmployeeReferenceScheduleAssignment&gt; fillerAssignments = null;</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">		if( assignments == null || assignments.isEmpty()) {</span>
<span class="nc" id="L146">			fillerAssignments = TimeOffMH.getFillerAssignments(employeeIds, viewDate); </span>
		}
<span class="nc" id="L148">		viewModel.initialize(selectedEmployeeCount, assignments, fillerAssignments);</span>
<span class="nc" id="L149">	}</span>

	private void initContent() {

<span class="nc" id="L153">		String title = i18n(rmBundle, RmWebBundleKey.PEOPLE_REFERENCE_SCHEDULE_HEADER);</span>
<span class="nc" id="L154">		setTitle(title);</span>
<span class="nc" id="L155">		setTemplate(&quot;{0}&quot;);</span>
<span class="nc" id="L156">		mode = Mode.VIEW;</span>
<span class="nc" id="L157">		String html = makeHtml();</span>
<span class="nc" id="L158">		super.addComponent(html);</span>
<span class="nc" id="L159">	}</span>

	private DateRangePickerPC createDateRangePicker() {
<span class="nc" id="L162">		DateRangePickerPC picker = new DateRangePickerPC(m_context, Fields.DATE_RANGE);</span>
<span class="nc" id="L163">		picker.setIsMultiValueSupported(true);</span>
<span class="nc" id="L164">		picker.setDateInputFieldName(Fields.DATE_RANGE);</span>
<span class="nc" id="L165">		picker.setIsControlEnabled(false);</span>

<span class="nc" id="L167">		DatePickerPC sDatePC = picker.getStartDatePickerPC();</span>
<span class="nc" id="L168">		DatePickerPC eDatePC = picker.getEndDatePickerPC();</span>

<span class="nc" id="L170">		sDatePC.setIsDateValueOptional(true);</span>
<span class="nc" id="L171">		eDatePC.setIsDateValueOptional(true);</span>
<span class="nc" id="L172">		eDatePC.setIsDateValueInclusive(false);</span>
<span class="nc" id="L173">		return picker;</span>
	}

	private String getDateRangeHtml(LocalDate sDate, LocalDate eDate) {
<span class="nc" id="L177">		DatePickerPC sDatePC = dateRangePickerPC.getStartDatePickerPC();</span>
<span class="nc" id="L178">		DatePickerPC eDatePC = dateRangePickerPC.getEndDatePickerPC();</span>

<span class="nc" id="L180">		sDatePC.setDate(sDate);</span>
<span class="nc" id="L181">		eDatePC.setDate(eDate);</span>

<span class="nc" id="L183">		sDatePC.setIsMultiValue(viewModel.isMultiStartTime());</span>
<span class="nc" id="L184">		eDatePC.setIsMultiValue(viewModel.isMultiEndTime());</span>
<span class="nc" id="L185">		return dateRangePickerPC.toString();</span>
	}

	private String getEmployeeIdString() {

<span class="nc bnc" id="L190" title="All 4 branches missed.">		if (employee != null &amp;&amp; employee.getID() != null) {</span>
<span class="nc" id="L191">			return employee.getID().toString();</span>
<span class="nc bnc" id="L192" title="All 4 branches missed.">		} else if (selectedEmployeeIds != null &amp;&amp; !selectedEmployeeIds.isEmpty()) {</span>
<span class="nc" id="L193">			return RmUtils.join(selectedEmployeeIds, ',');</span>
		}
<span class="nc" id="L195">		return &quot;&quot;;</span>
	}

	private String makeHtml() {
		
<span class="nc" id="L200">		ID refScheduleID = viewModel.getScheduleIntID(m_context);</span>
<span class="nc" id="L201">		String idString = getEmployeeIdString();</span>

		//Get the pool name input field
<span class="nc" id="L204">		StringBuilder sb = new StringBuilder();</span>
		// wrap the pool name's input so it aligns with the date picker
<span class="nc" id="L206">		sb.append(&quot;&lt;span style=\&quot;vertical-align: middle;\&quot;&gt;&quot;);</span>
<span class="nc" id="L207">		sb.append(HtmlUtil.makeTextReadOnlyInput(Fields.NAME, DEFAULT_FIELD_WIDTH, viewModel.getScheduleName(m_context)));</span>
<span class="nc" id="L208">		sb.append(&quot;&lt;/span&gt;&quot;);</span>
<span class="nc" id="L209">		sb.append(HtmlUtil.makeHiddenInput(Fields.ID, refScheduleID));</span>
<span class="nc" id="L210">		sb.append(HtmlUtil.makeHiddenInput(Fields.IS_EDITABLE, isEditable));</span>
<span class="nc" id="L211">		sb.append(HtmlUtil.makeHiddenInput(Fields.IS_VIEWABLE, true));</span>
		//this will be set to SAVE by JavaScript if popup value is set
<span class="nc" id="L213">		sb.append(HtmlUtil.makeHiddenInput(Fields.REF_SCHEDULE_MODE, mode));</span>
<span class="nc" id="L214">		sb.append(HtmlUtil.makeHiddenInput(WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN, idString));</span>
<span class="nc" id="L215">		sb.append(HtmlUtil.makeHiddenInput(Fields.VIEW_DATE, viewDate.getTime()));</span>

<span class="nc" id="L217">		TimeZone viewTimeZone = m_context.getViewingTimeZone();</span>

<span class="nc" id="L219">		LocalDate startDate = viewModel.getDisplayStartTime(viewTimeZone);</span>
<span class="nc" id="L220">		LocalDate endDate = viewModel.getDisplayEndTime(viewTimeZone);</span>

		//Add the popup button
<span class="nc bnc" id="L223" title="All 2 branches missed.">		if (isEditable) {</span>
<span class="nc" id="L224">			sb.append(getPopupButtonHtml(viewTimeZone));</span>
		} else {
<span class="nc" id="L226">			sb.append(&quot; &quot;);</span>
		}

		//Add the date range picker
<span class="nc" id="L230">		sb.append(getDateRangeHtml(startDate, endDate));</span>

<span class="nc" id="L232">		return sb.toString();</span>
	}

	

	private String getPopupButtonHtml(TimeZone viewTimeZone) {
<span class="nc" id="L238">		StringBuilder sb = new StringBuilder();</span>
		//These start/end times are in the viewing time zone. 
<span class="nc" id="L240">		long startDateInMillis = viewModel.getLocalStartTime(viewTimeZone);</span>
<span class="nc" id="L241">		long endDateInMillis = viewModel.getLocalEndTime(viewTimeZone);</span>
<span class="nc" id="L242">		String actionType = ReferenceScheduleEffectivityPopupPM.POPUP_COMMAND;</span>

<span class="nc" id="L244">		boolean isMultiSDate = viewModel.isMultiStartTime();</span>
<span class="nc" id="L245">		boolean isMultiEDate = viewModel.isMultiEndTime();</span>
<span class="nc" id="L246">		ResourceBundle bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>

		//create the EDIT button and its attributes
<span class="nc" id="L249">		sb.append(HtmlUtil.imageTag(ImageFileID.EDIT, ImageFileID.EDIT_WIDTH, ImageFileID.EDIT_HEIGHT, i18n(bbmBundle, BbmWebBundleKey.EDIT), false));</span>
<span class="nc" id="L250">		sb.append(&quot; onClick=\&quot;workpaneMediator_popupToolbar.onSelect('&quot;);</span>
<span class="nc" id="L251">		sb.append(actionType).append(&quot;',this)\&quot; &quot;).append(&quot;actionType=\&quot;&quot;).append(actionType).append(&quot;\&quot; &quot;);</span>
<span class="nc" id="L252">		sb.append(Fields.REF_SCHEDULE_MODE).append(&quot;=\&quot;&quot;).append(mode).append(&quot;\&quot; &quot;);</span>
<span class="nc" id="L253">		sb.append(ProfileAdminPC.IS_NEW_FN).append(&quot;=\&quot;&quot;).append(false).append(&quot;\&quot; &quot;);</span>

		try {

<span class="nc bnc" id="L257" title="All 4 branches missed.">			if (isMultiSDate || (startDateInMillis != -1)) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">				sb.append(ProfileAdminPC.EFF_START_DATE_FN).append(&quot;=\&quot;&quot;).append(isMultiSDate ? MULTI_VALUE_DATA : startDateInMillis).append(&quot;\&quot; &quot;);</span>
			}

<span class="nc bnc" id="L261" title="All 4 branches missed.">			if (isMultiEDate || (endDateInMillis != -1)) {</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">				sb.append(ProfileAdminPC.EFF_END_DATE_FN).append(&quot;=\&quot;&quot;).append(isMultiEDate ? MULTI_VALUE_DATA : endDateInMillis).append(&quot;\&quot; &quot;);</span>
			}

<span class="nc" id="L265">			sb.append(&quot; border=\&quot;0\&quot; align=\&quot;absmiddle\&quot; style=\&quot;&quot;).append(CSSUtil.STYLE_CLICKABLE).append(&quot;\&quot;&gt;&quot;);</span>
<span class="nc" id="L266">		} catch (Exception ex) {</span>
<span class="nc" id="L267">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L268">		}</span>
<span class="nc" id="L269">		return sb.toString();</span>
	}

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L274">		dateRangePickerPC.extractParameters(request);</span>
		
<span class="nc" id="L276">		DatePickerPC endPicker = dateRangePickerPC.getEndDatePickerPC();</span>
<span class="nc" id="L277">		viewModel.setEndTime(endPicker.getCalendar(), endPicker.isMultiValue());</span>
		
<span class="nc" id="L279">		DatePickerPC startPicker = dateRangePickerPC.getStartDatePickerPC();</span>
<span class="nc" id="L280">		viewModel.setStartTime(startPicker.getCalendar(), startPicker.isMultiValue());</span>
		
<span class="nc" id="L282">		return super.extractParameters(request);</span>
	}

	public void setRefScheduleID(String refScheduleID) {
<span class="nc" id="L286">		viewModel.setSpid(m_context, refScheduleID);</span>
<span class="nc" id="L287">	}</span>
	
	public EmployeeReferenceScheduleAssignmentUpdateParameters getUpdateAssignment() {
<span class="nc" id="L290">		return viewModel.getUpdateAssignment();</span>
	}

	public void setRefScheduleMode(String mode) {
<span class="nc bnc" id="L294" title="All 2 branches missed.">		this.mode = mode.equalsIgnoreCase(Mode.SAVE.toString())? Mode.SAVE : Mode.VIEW;</span>
<span class="nc" id="L295">	}</span>
	
	public String getMode() {
<span class="nc" id="L298">		return this.mode.toString();</span>
	}

	public boolean needsUpdate() {
<span class="nc" id="L302">		return mode.equals(Mode.SAVE);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>