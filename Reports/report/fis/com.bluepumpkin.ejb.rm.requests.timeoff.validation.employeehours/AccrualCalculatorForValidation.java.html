<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AccrualCalculatorForValidation.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.timeoff.validation.employeehours</a> &gt; <span class="el_source">AccrualCalculatorForValidation.java</span></div><h1>AccrualCalculatorForValidation.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.timeoff.validation.employeehours;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.List;

import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.DailyHoursBuckets;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffAccrued;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffYearly;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDay;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOAccrual;

public class AccrualCalculatorForValidation {

<span class="nc" id="L24">	private static final String CLASS_NAME = AccrualCalculatorForValidation.class.getName();</span>
<span class="nc" id="L25">	private static Category log = Log.initCategory(CLASS_NAME);</span>

	AccrualCalculatorDataLoader dataLoader;

	AccrualCalculatorForValidation() {
<span class="nc" id="L30">		this(null);</span>
<span class="nc" id="L31">	}</span>

<span class="nc" id="L33">	AccrualCalculatorForValidation(AccrualCalculatorDataLoader ldr) {</span>
<span class="nc" id="L34">		dataLoader = ldr;</span>
<span class="nc bnc" id="L35" title="All 2 branches missed.">		if (dataLoader == null) {</span>
<span class="nc" id="L36">			dataLoader = new DefaultAccrualCalculatorDataLoader();</span>
		}
<span class="nc" id="L38">	}</span>
	


	/*
	 * Does the validation and set the violations in the passed in toAccrual. 
	 * The passed in object is then returned back to the caller.
	 *  
	 * The toAccrual is created by the class TOAccrualLoaderForValidation 
	 *  
	 *   
	 */
	TOAccrual doValidations(TOAccrual toAccrual, Collection&lt;TOHoursPerDay&gt; schedOrUsedTOEventSet)
			throws Exception { // NOSONAR

<span class="nc bnc" id="L53" title="All 2 branches missed.">		for (TimeRange range : splitIntoTimeOffYearRanges(toAccrual)) {</span>
<span class="nc" id="L54">			Date startPeriod = range.getStartDate();</span>
<span class="nc" id="L55">			Date endPeriod = range.getEndDate();</span>

<span class="nc" id="L57">			int startYear = toAccrual.getEmployeeTimeOffYear(startPeriod);</span>
<span class="nc" id="L58">			EmployeeTimeOffYearly yearly = toAccrual.getEmployeeTimeOffYearly(startYear);</span>

<span class="nc bnc" id="L60" title="All 2 branches missed.">			if (hasNoAccrualRateForYear(yearly)) {</span>
<span class="nc" id="L61">				ValidationUtil.setSoftValidationResult(toAccrual, RmEjbBundleKey.TO_ACCRUAL_EMP_TO_ACCRUAL_RATE_NA,</span>
<span class="nc" id="L62">						Integer.toString(startYear),</span>
						CLASS_NAME);
<span class="nc" id="L64">				return toAccrual;</span>
			}

<span class="nc bnc" id="L67" title="All 2 branches missed.">			if (doNotAllowCarryOverFromPreviousYear(toAccrual, startPeriod)) {</span>
				//set the estimated hrs to 0 because no carry over is allowed from previous years
<span class="nc" id="L69">				toAccrual.setEstimatedAccrHrs(0);</span>
			}

<span class="nc" id="L72">			getAccruedHrsWithinYear(toAccrual, startPeriod, endPeriod, yearly, schedOrUsedTOEventSet);</span>

<span class="nc bnc" id="L74" title="All 2 branches missed.">			if (!endPeriod.equals(toAccrual.endDate)) {</span>
				//Check for Max balance carry over here
<span class="nc bnc" id="L76" title="All 4 branches missed.">				if (toAccrual.actTOBal != null &amp;&amp; toAccrual.getEstimatedAccrHrs() &gt; toAccrual.actTOBal.getMaxCarryOver()) {</span>
<span class="nc" id="L77">					toAccrual.setEstimatedAccrHrs(toAccrual.actTOBal.getMaxCarryOver());</span>
				}
			}
<span class="nc" id="L80">		}</span>

<span class="nc" id="L82">		return toAccrual;</span>
	}



	static boolean doNotAllowCarryOverFromPreviousYear(TOAccrual toAccrual, Date dt) {
<span class="nc bnc" id="L88" title="All 4 branches missed.">		return toAccrual.actTOBal.isZeroMaxCarryOver() &amp;&amp; toAccrual.getAccruedTO() != null</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">				&amp;&amp; toAccrual.getAccruedTO().getAccruedAtDate().before(dt);</span>
	}

	//Split the toAccrual.startDate to toAccrual.endDate range into ranges such that each item returned falls in the same time off year
	static List&lt;TimeRange&gt; splitIntoTimeOffYearRanges(TOAccrual toAccrual){
<span class="nc" id="L94">		Calendar startCal = Calendar.getInstance(toAccrual.org.getTimeZone());</span>
<span class="nc" id="L95">		startCal.setTime(toAccrual.startDate);</span>

<span class="nc" id="L97">		Calendar empTOYearStartCal = RequestUtil.getEmployeeTimeOffYearStart(toAccrual.startDate, toAccrual.org, toAccrual.empTOYrStArr);</span>
		// Get the ending of the time off year (inclusive)
<span class="nc" id="L99">		Calendar empTOYearEndCal = RequestUtil.getEmployeeTimeOffYearEnd(toAccrual.startDate, toAccrual.org, toAccrual.empTOYrStArr);</span>

<span class="nc" id="L101">		Date empTOYearStartDate = empTOYearStartCal.getTime();</span>
<span class="nc" id="L102">		Date empTOYearEndDate = empTOYearEndCal.getTime();</span>
		
<span class="nc" id="L104">		List&lt;TimeRange&gt; result = new ArrayList&lt;TimeRange&gt;();</span>

		do {
<span class="nc bnc" id="L107" title="All 2 branches missed.">			Date startPeriod = toAccrual.startDate.before(empTOYearStartDate) ? empTOYearStartDate : toAccrual.startDate;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">			Date endPeriod = toAccrual.endDate.after(empTOYearEndDate) ? empTOYearEndDate : toAccrual.endDate;</span>
			
<span class="nc" id="L110">			result.add(new TimeRange(startPeriod, endPeriod));</span>
			
<span class="nc" id="L112">			empTOYearEndCal.add(Calendar.MILLISECOND, 1);</span>
<span class="nc" id="L113">			empTOYearStartDate = empTOYearEndCal.getTime();</span>
			// QC 144918: Leap Day: First add the year to get the calendar back to March 1st Leap Year, 
			//and then subtract the millisecond so February 29th isn't missed.
<span class="nc" id="L116">			empTOYearEndCal.add(Calendar.YEAR, 1);</span>
<span class="nc" id="L117">			empTOYearEndCal.add(Calendar.MILLISECOND, -1);</span>
<span class="nc" id="L118">			empTOYearEndDate = empTOYearEndCal.getTime();</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">		} while (!toAccrual.endDate.before(empTOYearStartDate));</span>

<span class="nc" id="L122">		return result;</span>
	}

	private static boolean hasNoAccrualRateForYear(EmployeeTimeOffYearly toYearly) {
<span class="nc bnc" id="L126" title="All 4 branches missed.">		return toYearly == null || ((int) toYearly.getAccrualRateForYear()) == EmployeeTimeOffYearly.ACCRUAL_RATE_NA;</span>
	}

	private double getAccruedHrsWithinYear(TOAccrual toAccrual, Date startDate, Date endDate,
			EmployeeTimeOffYearly yearly, Collection&lt;TOHoursPerDay&gt; schedOrUsedTOEvents) throws Exception { // NOSONAR


		//toAccrual's estimated accrual hours is used as running counter
<span class="nc" id="L134">		double accruedHrsForPeriod = toAccrual.getEstimatedAccrHrs();</span>

<span class="nc bnc" id="L136" title="All 4 branches missed.">		if (schedOrUsedTOEvents == null || schedOrUsedTOEvents.isEmpty()) {</span>
			//Handle scenario where there is no TO for the given range.
<span class="nc" id="L138">			double[] accrHrsForEntireRange = calcAccruedHrsForPeriod(toAccrual, startDate, endDate);</span>
<span class="nc" id="L139">			accruedHrsForPeriod += accrHrsForEntireRange[0];</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">			if (accruedHrsForPeriod &gt; toAccrual.actTOBal.getMaxBalance()) {</span>
<span class="nc" id="L142">				accruedHrsForPeriod = toAccrual.actTOBal.getMaxBalance();</span>
			}

<span class="nc" id="L145">			toAccrual.addTOAccrlDetailRow(yearly.getCalendarYear(),</span>
<span class="nc" id="L146">					yearly.getAccrualRateForYear(),</span>
					null,
					startDate, endDate, endDate,
					true,
					0,
					accrHrsForEntireRange[0],
					0,
					accruedHrsForPeriod, (int) accrHrsForEntireRange[1]);
<span class="nc" id="L154">		} else {</span>

<span class="nc" id="L156">			accruedHrsForPeriod = getAccruedHoursForScheduledTimeOff(toAccrual, startDate, endDate, yearly,</span>
					schedOrUsedTOEvents);

		}

<span class="nc" id="L161">		toAccrual.setEstimatedAccrHrs(accruedHrsForPeriod);</span>
<span class="nc" id="L162">		return accruedHrsForPeriod;</span>
	}

	private double getAccruedHoursForScheduledTimeOff(TOAccrual toAccrual, Date startDate, Date endDate,
			EmployeeTimeOffYearly yearly, Collection&lt;TOHoursPerDay&gt; schedOrUsedTOEvents) throws Exception { // NOSONAR

<span class="nc" id="L168">		double accruedHrsForPeriod = toAccrual.getEstimatedAccrHrs();</span>
<span class="nc" id="L169">		double usedHrsForPeriod = 0;</span>
<span class="nc" id="L170">		Date lastTODate = new Date(startDate.getTime());</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">		for (TOHoursPerDay hrsPerDay : schedOrUsedTOEvents) {</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">			if (!isEligible(toAccrual, hrsPerDay, startDate, endDate)) {</span>
<span class="nc" id="L175">				continue;</span>
			}

<span class="nc" id="L178">			boolean isToEvtStartBeforeStart = hrsPerDay.getStartTime().before(startDate);</span>
<span class="nc" id="L179">			boolean isToEvtEndAfterEnd = hrsPerDay.getEndTime().after(endDate);</span>
<span class="nc" id="L180">			double usedHrsForThisTO = 0;</span>


<span class="nc bnc" id="L183" title="All 2 branches missed.">			Date adjStDate = isToEvtStartBeforeStart ? startDate : hrsPerDay.getStartTime();</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">			Date adjEnDate = isToEvtEndAfterEnd ? endDate : hrsPerDay.getEndTime();</span>

<span class="nc bnc" id="L186" title="All 4 branches missed.">			if (isToEvtStartBeforeStart || isToEvtEndAfterEnd) {</span>
				//partial hrsPerDay, we have to chop hrsPerDay since it starts or ends after the given range
<span class="nc" id="L188">				DailyHoursBuckets dailyBuckets = dataLoader.getDailyHoursBucketsForDateRange(null, hrsPerDay, adjStDate, adjEnDate);</span>
<span class="nc" id="L189">				usedHrsForThisTO += dailyBuckets.getTotalHours();</span>
<span class="nc" id="L190">			} else {</span>
<span class="nc" id="L191">				usedHrsForThisTO += (hrsPerDay.getTotalMinutes() / 60f);</span>
			}

			//The time off accrued from last accrual point to the start of this TOHour block (adjust if the block starts before startDate)
			//we are checking if at the start of each scheduled request we have enough hours accrued
			//we then filter out violations for requests that we are not interested in. see EmployeeHoursValidationRule.doAccrualValidation 
<span class="nc" id="L197">			double[] accrdHrsForThisTORange = calcAccruedHrsForPeriod(toAccrual, lastTODate, adjStDate);</span>
<span class="nc" id="L198">			double accrdHrsForThisTO = accrdHrsForThisTORange[0];</span>
<span class="nc" id="L199">			int accrualCount = (int) accrdHrsForThisTORange[1];</span>

<span class="nc" id="L201">			accruedHrsForPeriod += accrdHrsForThisTO;</span>

<span class="nc bnc" id="L203" title="All 2 branches missed.">			if (accruedHrsForPeriod &gt; toAccrual.actTOBal.getMaxBalance()) {</span>
<span class="nc" id="L204">				accruedHrsForPeriod = toAccrual.actTOBal.getMaxBalance();</span>
			}

<span class="nc" id="L207">			usedHrsForPeriod += usedHrsForThisTO;</span>
<span class="nc" id="L208">			accruedHrsForPeriod -= usedHrsForThisTO;</span>

			//if accruedHrsForPeriod is negative a violation is added by addTOAccrlDetailRow
<span class="nc" id="L211">			toAccrual.addTOAccrlDetailRow(</span>
					//year
<span class="nc" id="L213">					yearly.getCalendarYear(),</span>
					//accrual rage
<span class="nc" id="L215">					yearly.getAccrualRateForYear(),</span>
					//TOHoursPerDay
					hrsPerDay,
					//prevStart,start,end
					lastTODate, adjStDate, adjEnDate,
					//chkAccrualForEachTO
					true,
					//accounted hours for period - acctHrsForPeriod
					usedHrsForThisTO,
					//accrued hours for period -  accrdHrsForPeriod
					accrdHrsForThisTO,
					//accounted hours till date - acctHrsTillDate
					usedHrsForPeriod,
					//accrued hours till date - accrdHrsTillDate
					accruedHrsForPeriod,
					//accrualCount
					accrualCount);

<span class="nc" id="L233">			lastTODate = new Date(adjStDate.getTime());</span>
<span class="nc" id="L234">		}</span>
		
		//the accrual for the range that falls after the last TOHoursPerDay

		
<span class="nc" id="L239">		double[] accrdHrsForThisTORange = calcAccruedHrsForPeriod(toAccrual, lastTODate, endDate);</span>
<span class="nc" id="L240">		double accrdHrsForThisTO = accrdHrsForThisTORange[0];</span>
<span class="nc" id="L241">		int accrualCount = (int) accrdHrsForThisTORange[1];</span>

<span class="nc" id="L243">		accruedHrsForPeriod += accrdHrsForThisTO;</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">		if (accruedHrsForPeriod &gt; toAccrual.actTOBal.getMaxBalance()) {</span>
<span class="nc" id="L245">			accruedHrsForPeriod = toAccrual.actTOBal.getMaxBalance();</span>
		}
		
<span class="nc" id="L248">		toAccrual.addTOAccrlDetailRow(yearly.getCalendarYear(),</span>
<span class="nc" id="L249">				yearly.getAccrualRateForYear(),</span>
					null,
					lastTODate, endDate, endDate,
					true,
					0,
					accrdHrsForThisTO,
					0,
				accruedHrsForPeriod,
				accrualCount);

	
<span class="nc" id="L260">		return accruedHrsForPeriod;</span>
	}

	private static boolean isEligible(TOAccrual toAccrual, TOHoursPerDay hrsPerDay, Date startDate, Date endDate) {

<span class="nc bnc" id="L265" title="All 2 branches missed.">		if (!(hrsPerDay.getStartTime().before(endDate)) ||</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">				!(hrsPerDay.getEndTime().after(startDate)) ||</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">				!toAccrual.getActivityIDs().contains(hrsPerDay.getActivityID())) {</span>
			//Ignore any event that doesn't begin before the end date , including event starting on the end date
			//Ignore any event that ends before the start date ,including event ending on the start date
			//Ignore any events that are not part of the Accrual
<span class="nc" id="L271">			return false;</span>
		}

<span class="nc" id="L274">		Date accrualStart = toAccrual.getStDateForStartingBalance();</span>

<span class="nc bnc" id="L276" title="All 2 branches missed.">		if (accrualStart == null) {</span>
<span class="nc" id="L277">			return true;</span>
		}

<span class="nc bnc" id="L280" title="All 4 branches missed.">		if (hrsPerDay.getStartTime().equals(accrualStart) || (hrsPerDay.getStartTime().before(accrualStart)</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">				&amp;&amp; hrsPerDay.getEndTime().after(accrualStart))) {</span>
			//if the TO event starts on the accural start or straddles the accrual start then ignore it
			//This does not seem right, but this is what it was doing before
			//See TOAccrualCalculator.getAccruedHrsWithinYear
<span class="nc" id="L285">			return false;</span>
		}

<span class="nc" id="L288">		return true;</span>
	}

	//The first element is the hours accrued, the second is the number of periods
	private static double[] calcAccruedHrsForPeriod(TOAccrual toAccrual, Date start, Date end) throws Exception { // NOSONAR

<span class="nc" id="L294">		EmployeeTimeOffYearly toYearlyStart = toAccrual.getEmployeeTimeOffYearly(toAccrual.getEmployeeTimeOffYear(start));</span>
<span class="nc" id="L295">		EmployeeTimeOffYearly toYearlyPrevAccrPeriod = null;</span>
<span class="nc" id="L296">		Date adjEnd = null;</span>

<span class="nc bnc" id="L298" title="All 2 branches missed.">		if (toAccrual.getToAccrualPolicy() == Activity.ACCRUAL_POLICY_PRORATED_ON_NEXT</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">				|| toAccrual.getToAccrualPolicy() == Activity.ACCRUAL_POLICY_ALL_HOURS_ON_NEXT) {</span>

			//get previous period's yearly allotment details
<span class="nc" id="L302">			Calendar cal = Calendar.getInstance(toAccrual.org.getTimeZone());</span>
<span class="nc" id="L303">			cal.setTime(start);</span>
<span class="nc" id="L304">			toAccrual.decrementPeriod(cal);</span>
<span class="nc" id="L305">			toYearlyPrevAccrPeriod = toAccrual.getEmployeeTimeOffYearly(toAccrual.getEmployeeTimeOffYear(cal.getTime()));</span>

<span class="nc" id="L307">			toAccrual.incrementPeriod(cal);</span>
<span class="nc" id="L308">			adjEnd = cal.getTime();</span>
		}

		//Decide whether we want to calculate accrual for two different accrual rates or only one.
		//if adjEnd.after(end) then no need to calculate accrual in two parts since the next accrual is after the end date.
		//we might as well calculate with  one call, since we do not even want to calculate accrual for next accrual schedule.
		//QC 49312 ; Sameet Nov 2009

<span class="nc bnc" id="L316" title="All 8 branches missed.">		if (toYearlyPrevAccrPeriod == null || toYearlyStart.equals(toYearlyPrevAccrPeriod) || (adjEnd != null &amp;&amp; adjEnd.after(end))) {</span>
			//no need to get the previous period or the previous period is in the same year as the current period
<span class="nc" id="L318">			return calcAccruedHrsForPeriod(toAccrual, start, end, toYearlyStart);</span>
		} else {
			//split across two different accrual rates 
<span class="nc" id="L321">			double[] accrdHrsForStart = calcAccruedHrsForPeriod(toAccrual, start, adjEnd, toYearlyPrevAccrPeriod);</span>
<span class="nc" id="L322">			toAccrual.addTOAccrlDetailRow(</span>
<span class="nc" id="L323">					toYearlyPrevAccrPeriod.getCalendarYear(),</span>
<span class="nc" id="L324">					toYearlyPrevAccrPeriod.getAccrualRateForYear(),</span>
					null,
					start, adjEnd, adjEnd,
					true,
					0,
					accrdHrsForStart[0],
					0,
					//lastAccruedDate
					TOAccrual.NUMBER_NA,
					//accrualCount
					(int) accrdHrsForStart[1]);

<span class="nc" id="L336">			double[] accrdHrsForEnd = calcAccruedHrsForPeriod(toAccrual, adjEnd, end, toYearlyStart);</span>
			//Date endAdjusted is hack for debugging purposes only so that toAccrual.toHtml() displays all the info correctly
			//should not have any effect on business logic.
<span class="nc" id="L339">			Date endAdjusted = new Date(end.getTime() - 1);</span>
<span class="nc" id="L340">			toAccrual.addTOAccrlDetailRow(toYearlyStart.getCalendarYear(),</span>
<span class="nc" id="L341">					toYearlyStart.getAccrualRateForYear(),</span>
					null,
					adjEnd, endAdjusted, end,
					true,
					0,
					accrdHrsForEnd[0],
					0,
					TOAccrual.NUMBER_NA, (int) accrdHrsForEnd[1]);

<span class="nc" id="L350">			return new double[] {</span>
					accrdHrsForStart[0] + accrdHrsForEnd[0],
					accrdHrsForStart[1] + accrdHrsForEnd[1]
			};
		}
	}

	//The first element is the hours accrued, the second is the number of periods
	private static double[] calcAccruedHrsForPeriod(TOAccrual toAccrual, Date start, Date end, EmployeeTimeOffYearly toYearly)
			throws Exception { // NOSONAR

<span class="nc" id="L361">		int countBetnPeriod = toAccrual.getCountInBetween(start, end);</span>
<span class="nc" id="L362">		double accrRate = getYearlyAccrualRate(toYearly);</span>
<span class="nc" id="L363">		double accruedHrs = 0;</span>

		//isAccrualPolicyAdjustmentReqd seems to return true if the requested range ends before the end of the employee's first time off year 
<span class="nc bnc" id="L366" title="All 4 branches missed.">		if (toAccrual.isAccrualPolicyAdjustmentReqd(start, end) &amp;&amp; !toAccrual.isAccrualPolicyAdjusted()) {</span>

<span class="nc" id="L368">			EmployeeTimeOffAccrued accrued = toAccrual.adjustAccruedTOByAccrualPolicy(start, end);</span>

<span class="nc bnc" id="L370" title="All 6 branches missed.">			if (accrued != null &amp;&amp; (toAccrual.getToAccrualPolicy() == Activity.ACCRUAL_POLICY_PRORATED_ON_NEXT) &amp;&amp; countBetnPeriod &gt; 0) {</span>
				//Since its already counted when adjusting the accrual policy
<span class="nc" id="L372">				countBetnPeriod--;</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">				if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc" id="L374">					log.info(&quot;calcAccruedHrsForPeriod setting countBetnPeriod by -1 = &quot; + countBetnPeriod);</span>
				}
			}

<span class="nc bnc" id="L378" title="All 2 branches missed.">			accruedHrs += (accrued != null ? accrued.getAccruedHours() : 0);</span>
<span class="nc" id="L379">			logAccruedHours(accrued);</span>
		}

<span class="nc" id="L382">		accruedHrs += (accrRate * countBetnPeriod);</span>

<span class="nc bnc" id="L384" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled())</span>
<span class="nc" id="L385">			log.info(&quot;calcAccruedHrsForPeriodXXX start=&quot; + start + &quot;; end=&quot; + end + &quot;; count=&quot; + countBetnPeriod + &quot; ; Accrual Rate=&quot;</span>
<span class="nc" id="L386">					+ toYearly.getAccrualRateForYear() + &quot; ; Accrued hours=&quot; + accruedHrs);</span>

<span class="nc" id="L388">		return new double[] {</span>
				accruedHrs, countBetnPeriod
		};
	}

	private static void logAccruedHours(EmployeeTimeOffAccrued accrued) {
<span class="nc bnc" id="L394" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">			String accruedHours = accrued != null ? Double.toString(accrued.getAccruedHours()) : &quot;NULL&quot;;</span>
<span class="nc" id="L396">			log.info(&quot;calcAccruedHrsForPeriod ACCRD HRS BY POLICY = &quot; + accruedHours);</span>
		}
<span class="nc" id="L398">	}</span>

	private static double getYearlyAccrualRate(EmployeeTimeOffYearly toYearly) {
<span class="nc bnc" id="L401" title="All 2 branches missed.">		return ((int) toYearly.getAccrualRateForYear()) != EmployeeTimeOffYearly.ACCRUAL_RATE_NA ? toYearly.getAccrualRateForYear() : 0;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>