<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ServiceGoalsMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.servicegoals</a> &gt; <span class="el_source">ServiceGoalsMH.java</span></div><h1>ServiceGoalsMH.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.servicegoals;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.QueueFieldInfo;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.verint.ejb.bbm.fterequirements.FteRequirementsUtil;
import com.verint.ejb.bbm.servicegoals.ejb.ServiceGoalsManager;
import com.verint.ejb.bbm.servicegoals.model.ASATimeSeriesDataItem;
import com.verint.ejb.bbm.servicegoals.model.MaxDialsTimeSeriesDataItem;
import com.verint.ejb.bbm.servicegoals.model.ServiceLevelPercentTimeSeriesDataItem;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.base.ModelHandler;
import com.witness.web.uif.system.RequestContext;

import java.rmi.RemoteException;
import java.util.Collection;
import java.util.Collections;
import java.util.List;

<span class="nc" id="L30">public class ServiceGoalsMH extends ModelHandler {</span>

	public static void saveImmediateMediaModel(RequestContext context, List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; timeSeries,
			SPQueue spQueue) throws BbmEJBCreateException, BbmUpdateException, RemoteException, MultiUserException, BbmFinderException {
<span class="fc" id="L34">		ServiceGoalsManager serviceGoalsManager = WfmManagerFactory.getServiceGoalsManager(context.isInWhatIfMode());</span>

<span class="fc" id="L36">		saveChildDistributedQueues(context, timeSeries, null, null, spQueue, serviceGoalType.IMMEDIATE);</span>
<span class="fc" id="L37">		serviceGoalsManager.saveServiceLevelPercentTimeSeries(timeSeries, spQueue);</span>

<span class="fc" id="L39">		updateSPQueue(context, spQueue, serviceGoalType.IMMEDIATE);</span>
<span class="fc" id="L40">	}</span>

	public static void saveImmediateMediaModelWithASA(RequestContext context, List&lt;ASATimeSeriesDataItem&gt; timeSeries,
			SPQueue spQueue) throws BbmEJBCreateException, BbmUpdateException, RemoteException, MultiUserException, BbmFinderException {
<span class="nc" id="L44">		ServiceGoalsManager serviceGoalsManager = WfmManagerFactory.getServiceGoalsManager(context.isInWhatIfMode());</span>

<span class="nc" id="L46">		saveChildDistributedQueues(context, null, timeSeries, null, spQueue, serviceGoalType.IMMEDIATEASA);</span>
<span class="nc" id="L47">		serviceGoalsManager.saveASATimeSeries(timeSeries, spQueue);</span>

<span class="nc" id="L49">		updateSPQueue(context, spQueue, serviceGoalType.IMMEDIATEASA);</span>
<span class="nc" id="L50">	}</span>

	public static void saveOutboundMediaModel(RequestContext context, List&lt;MaxDialsTimeSeriesDataItem&gt; timeSeries,
			SPQueue spQueue) throws BbmEJBCreateException, BbmUpdateException, BbmFinderException, RemoteException, MultiUserException {
<span class="fc" id="L54">		ServiceGoalsManager serviceGoalsManager = WfmManagerFactory.getServiceGoalsManager(context.isInWhatIfMode());</span>

<span class="fc" id="L56">		saveChildDistributedQueues(context, null, null, timeSeries, spQueue, serviceGoalType.OUTBOUND);</span>
<span class="fc" id="L57">		serviceGoalsManager.saveMaxDialsTimeSeries(timeSeries, spQueue);</span>

<span class="fc" id="L59">		updateSPQueue(context, spQueue, serviceGoalType.OUTBOUND);</span>
<span class="fc" id="L60">	}</span>

	/**
	 * Saves the service goals model for a deferred media queue.  Use this method when Service Level is selected as the
	 * service goal type for the queue.
	 */
	public static void saveDeferredMediaModel(RequestContext context, List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; serviceLevelTimeSeries,
			SPQueue spQueue) throws BbmEJBCreateException, BbmFinderException, BbmUpdateException, RemoteException, MultiUserException {
<span class="fc" id="L68">		ServiceGoalsManager serviceGoalsManager = WfmManagerFactory.getServiceGoalsManager(context.isInWhatIfMode());</span>

<span class="fc" id="L70">		saveChildDistributedQueues(context, serviceLevelTimeSeries, null, null, spQueue, serviceGoalType.DEFERRED);</span>
<span class="fc" id="L71">		serviceGoalsManager.saveServiceLevelPercentTimeSeries(serviceLevelTimeSeries, spQueue);</span>

<span class="fc" id="L73">		updateSPQueue(context, spQueue, serviceGoalType.DEFERRED);</span>
<span class="fc" id="L74">	}</span>

	/**
	 * Saves the service goals model for a deferred media queue.  Use this method when Deadline Goals is selected as the
	 * service goal type for the queue.  This method will save both the deadline goals and deadline time series data for the queue.
	 */
	public static void saveDeferredMediaModel(RequestContext context, List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; deadlineGoalTimeSeries,
			List&lt;ASATimeSeriesDataItem&gt; deadlineTimeTimeSeries, SPQueue spQueue)
			throws BbmEJBCreateException, BbmUpdateException, BbmFinderException, RemoteException, MultiUserException {
<span class="nc" id="L83">		ServiceGoalsManager serviceGoalsManager = WfmManagerFactory.getServiceGoalsManager(context.isInWhatIfMode());</span>

<span class="nc" id="L85">		saveChildDistributedQueues(context, deadlineGoalTimeSeries, deadlineTimeTimeSeries, null, spQueue, serviceGoalType.DEFERREDASA);</span>
<span class="nc" id="L86">		serviceGoalsManager.saveDeadlineGoalsTimeSeries(deadlineGoalTimeSeries, deadlineTimeTimeSeries, spQueue);</span>

<span class="nc" id="L88">		updateSPQueue(context, spQueue, serviceGoalType.DEFERREDASA);</span>
<span class="nc" id="L89">	}</span>

	private static void updateSPQueue(RequestContext context, SPQueue spQueue, serviceGoalType sgType) throws BbmEJBCreateException, BbmUpdateException, MultiUserException, RemoteException {
<span class="fc" id="L92">		CampaignManager campaignManager = WfmManagerFactory.getCampaignManager(context.isInWhatIfMode());</span>
<span class="fc" id="L93">		campaignManager.updateSPQueue(spQueue);</span>
<span class="fc" id="L94">		FteRequirementsUtil.recalculateFteRequirementsForSPQueues(Collections.singleton(spQueue.getID()), context.isInWhatIfMode());</span>
<span class="fc" id="L95">	}</span>

	private static void saveChildDistributedQueues(RequestContext context,
			List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; slGoalTimeSeries,
			List&lt;ASATimeSeriesDataItem&gt; deadlineTimeTimeSeries,
			List&lt;MaxDialsTimeSeriesDataItem&gt; maxDialsTimeSeries,
			SPQueue spQueue,
			serviceGoalType sgType) throws BbmFinderException,
			RemoteException,
			BbmEJBCreateException,
			BbmUpdateException,
			MultiUserException {

		/* Steps to save the data to the Child Queues:
		 *
		 * 1. Fetch all the Child SP's to the given SP getSubSPIDsFromParentSPID
		 * 2. If there are Child SP's present it means its a distributed campaign
		 * 3. Iterate through the list of SP's fetch the Combined SP Queue getCombinedSPQueue
		 * 4. Repeat the same steps given below for the children too
		 *
		 * If the Campaign is skill based then the data needs to be stored for each individual queue rather then the combined queue
		 * 1. Fetch the Child SP's and Queues corresponding to the Child SP
		 * 2. Update only those Queues which are direct children of the Parent Distributed Queue being updated
		 * 3. There is a two point check
		 * 		a. Check whether the child queue being updated is child of the Parent Distributed Queue selected
		 * 		b. Update the data for the Individual SP Queue rather then to the Combined SP Queue
		 */

<span class="fc" id="L123">		ServiceGoalsManager serviceGoalsManager = WfmManagerFactory.getServiceGoalsManager(context.isInWhatIfMode());</span>
<span class="fc" id="L124">		CampaignManager campaignManager = WfmManagerFactory.getCampaignManager(context.isInWhatIfMode());</span>

<span class="fc" id="L126">		ID campaignID = campaignManager.getSchedulingPeriodByID(spQueue.getSpID()).getCampaignID();</span>
<span class="fc" id="L127">		Campaign campaignObj = campaignManager.getCampaignByID(campaignID);</span>
<span class="fc" id="L128">		Collection&lt;ID&gt; childSpIds = campaignManager.getSubSPIDsFromParentSPID(spQueue.getSpID());</span>

<span class="pc bpc" id="L130" title="1 of 4 branches missed.">		if (campaignObj != null &amp;&amp; campaignObj.getIsDistributed()) {</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">			for (ID spId : childSpIds) {</span>
<span class="fc" id="L132">				SchedulingPeriod childSp = campaignManager.getSchedulingPeriodByID(spId);</span>
<span class="fc" id="L133">				Collection&lt;SPQueue&gt; spQueues = campaignManager.getSPQueuesBySPID(childSp.getID());</span>

<span class="fc bfc" id="L135" title="All 2 branches covered.">				for (SPQueue childSpQueue : spQueues) {</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">					if (childSp.getSkillBased()) {</span>
<span class="fc" id="L137">						WorkloadManager workLoadManager = WfmManagerFactory.getWorkloadManager(context.isInWhatIfMode());</span>
<span class="fc" id="L138">						ID distributedQueueID = DAOUtil.mapIDToDEID(spQueue.getQueueID(), new QueueFieldInfo());</span>

<span class="fc" id="L140">						copySPQueueValuesToChild(spQueue, childSpQueue);</span>
<span class="fc" id="L141">						Queue childQueue = workLoadManager.getQueueByID(childSpQueue.getQueueID());</span>

<span class="pc bpc" id="L143" title="1 of 4 branches missed.">						if (childQueue.getParentQueueID() != null &amp;&amp; childQueue.getParentQueueID().equals(distributedQueueID.toString())) {</span>
<span class="fc" id="L144">							saveTimeSeries(deadlineTimeTimeSeries, slGoalTimeSeries, maxDialsTimeSeries,</span>
									sgType, serviceGoalsManager, childSpQueue);
<span class="fc" id="L146">							updateSPQueue(context, childSpQueue, sgType);</span>
						}
<span class="fc" id="L148">					} else {</span>
<span class="fc" id="L149">						SPQueue combinedSPQueue = campaignManager.getCombinedSPQueue(childSpQueue.getSpID(), childSpQueue.getMediaID());</span>
<span class="fc" id="L150">						copySPQueueValuesToChild(spQueue, combinedSPQueue);</span>

<span class="fc" id="L152">						saveTimeSeries(deadlineTimeTimeSeries, slGoalTimeSeries, maxDialsTimeSeries,</span>
								sgType, serviceGoalsManager, combinedSPQueue);
<span class="fc" id="L154">						updateSPQueue(context, combinedSPQueue, sgType);</span>
					}
<span class="fc" id="L156">				}</span>
<span class="fc" id="L157">			}</span>
		}
<span class="fc" id="L159">	}</span>

	private static void copySPQueueValuesToChild(SPQueue spQueue, SPQueue childSpQueue) {
<span class="fc" id="L162">		childSpQueue.setServiceLevelGoalType(spQueue.getServiceLevelGoalType());</span>
<span class="fc" id="L163">		childSpQueue.setSlAnswerWaitingTime(spQueue.getSlAnswerWaitingTime());</span>
<span class="fc" id="L164">		childSpQueue.setQualityGoalRequirement(spQueue.getQualityGoalRequirement());</span>
<span class="fc" id="L165">		childSpQueue.setMinimumQualityScore(spQueue.getMinimumQualityScore());</span>
<span class="fc" id="L166">		childSpQueue.setQueuePriorityGroup(spQueue.getQueuePriorityGroup());</span>
<span class="fc" id="L167">		childSpQueue.setPatience(spQueue.getPatience());</span>
<span class="fc" id="L168">		childSpQueue.setOverloadThreshold1(spQueue.getOverloadThreshold1());</span>
<span class="fc" id="L169">		childSpQueue.setOverloadThreshold2(spQueue.getOverloadThreshold2());</span>
<span class="fc" id="L170">		childSpQueue.setQPGThreshold(spQueue.getQPGThreshold());</span>
<span class="fc" id="L171">		childSpQueue.setMaxAbandonsPercent(spQueue.getMaxAbandonsPercent());</span>
<span class="fc" id="L172">		childSpQueue.setActualOrWorkingHour(spQueue.getActualOrWorkingHour());</span>
<span class="fc" id="L173">	}</span>


	protected static void saveTimeSeries(List&lt;ASATimeSeriesDataItem&gt; deadlineTimeTimeSeries,
			List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; slGoalTimeSeries,
			List&lt;MaxDialsTimeSeriesDataItem&gt; maxDialsTimeSeries,
			serviceGoalType sgType,
			ServiceGoalsManager serviceGoalsManager,
			SPQueue childSpQueue) throws BbmUpdateException, RemoteException {
<span class="pc bpc" id="L182" title="4 of 5 branches missed.">		switch (sgType) {</span>
			case IMMEDIATE:
			case DEFERRED:
<span class="fc" id="L185">				serviceGoalsManager.saveServiceLevelPercentTimeSeries(slGoalTimeSeries, childSpQueue);</span>
<span class="fc" id="L186">				break;</span>
			case IMMEDIATEASA:
<span class="nc" id="L188">				serviceGoalsManager.saveASATimeSeries(deadlineTimeTimeSeries, childSpQueue);</span>
<span class="nc" id="L189">				break;</span>
			case DEFERREDASA:
<span class="nc" id="L191">				serviceGoalsManager.saveDeadlineGoalsTimeSeries(slGoalTimeSeries, deadlineTimeTimeSeries, childSpQueue);</span>
<span class="nc" id="L192">				break;</span>
			case OUTBOUND:
<span class="nc" id="L194">				serviceGoalsManager.saveMaxDialsTimeSeries(maxDialsTimeSeries, childSpQueue);</span>
				break;
		}
<span class="fc" id="L197">	}</span>

<span class="pc" id="L199">	protected enum serviceGoalType {IMMEDIATE, IMMEDIATEASA, DEFERRED, DEFERREDASA, OUTBOUND}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>