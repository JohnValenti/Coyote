<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SkillsEmployeeAssignmentPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.skills</a> &gt; <span class="el_source">SkillsEmployeeAssignmentPM.java</span></div><h1>SkillsEmployeeAssignmentPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.skills;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.ArrayUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.skill.SkillModelHandler;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.employee.assignment.WfmEmployeeAssignmentPM;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.CacheUtil;
import com.witness.web.uif.util.js.JSDateTimeUtil;
import com.witness.web.uif.util.js.JSValidatorUtil;
import com.witness.web.uif.validator.InRangeFieldValidator;

import java.rmi.RemoteException;
import java.text.NumberFormat;
import java.text.ParseException;
import java.util.*;

public class SkillsEmployeeAssignmentPM extends WfmEmployeeAssignmentPM {
	private static final long serialVersionUID = 1L;
	public static final String START_DATE = &quot;startDate&quot;;
	public static final String END_DATE = &quot;endDate&quot;;
	
<span class="fc" id="L49">	protected boolean isByOrg = true;</span>
	protected SchedulingPeriod selectedSP;
	protected Campaign selectedCampaign;

	//key = employee ID, value = collection of skill assignments
	private Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; skillAssignmentMap;
	private boolean didTimePeriodChange;
	private String m_proficiency;
	private Map&lt;ID, Integer&gt; m_chatSessionMap;
<span class="fc" id="L58">	private boolean isViewPeriodValidForAllEmployees = true;</span>

	private SkillsInlineEditListPC pc_skill;
	private FormInputPC employeeProficiencyPC;
	private FormInputPC employeeChatPC;
	//We need to get the added/removed skill assignments when the pc_skill component
	//extracts its params so we can determine whether or not to disable employeeChatPC
	private Collection&lt;SkillAssignment&gt; addedSkillAssignments;
	private Collection&lt;SkillAssignment&gt; removedSkillAssignments;

	private static final String PROFICIENCY_FN = &quot;proficiencyFN&quot;;
	private static final String NUM_CHAT_FN = &quot;skillsAssignmentNumChatFN&quot;;

	static final String EMPLOYEE_ID_LIST_CONTEXT_KEY = &quot;com.verint.web.fs.skills.employeeIDs&quot;;

	private Map&lt;ID, List&lt;Integer&gt;&gt; authorizedViewFields;    // Authorized fields for viewing
	private Map&lt;ID, List&lt;Integer&gt;&gt; authorizedEditFields;    // Authorized fields for editing

	public SkillsEmployeeAssignmentPM(RequestContext context) {
<span class="fc" id="L77">		super(context, PageModel.FRAMED_MODEL);</span>

<span class="fc" id="L79">		didTimePeriodChange = SkillsEmployeeAssignmentRH.didTimePeriodChange(context);</span>

<span class="fc" id="L81">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="fc" id="L82">		addJSVariable(JSDateTimeUtil.getDateFormatJSVariables(m_localizer));</span>
		//We need to add these JS variables for the field validators to work properly
<span class="fc" id="L84">		JSValidatorUtil.addVDJSVars(this);</span>
<span class="fc" id="L85">	}</span>

	public static SkillsEmployeeAssignmentPM getInstance(RequestContext context) {
<span class="fc" id="L88">		return (SkillsEmployeeAssignmentPM) PageModel.getInstance(context, SkillsEmployeeAssignmentPM.class);</span>
	}

	@Override
	protected void initForm() {
<span class="fc" id="L93">		initContextDateFieldNames(START_DATE_FN, END_DATE_FN);</span>
		
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">		if (getSelectedIDSize() &gt; 0) {</span>
<span class="fc" id="L96">			viewStartDate = pc_timePeriod.getSelectedDateRange().getFirst();</span>
<span class="fc" id="L97">			viewEndDate = pc_timePeriod.getSelectedDateRange().getSecond();</span>

			//Setting list of employeeIDs in context for the associated popup window (the list may be too large
			//  to use as a query string param)
<span class="fc" id="L101">			CacheUtil.setCachedValue(m_context, CacheUtil.CACHE_MODE_SESSION, EMPLOYEE_ID_LIST_CONTEXT_KEY,</span>
<span class="fc" id="L102">					StringUtil.createDelimitedString(getSelectedIDs(), StringUtil.DELIM));</span>

<span class="pc bpc" id="L104" title="1 of 2 branches missed.">			if (getSelectedIDSize() &gt; 1) {</span>
<span class="nc" id="L105">				setIsMultiObjEditEnabled(true);</span>
			}

			try {
				//Loading this data here instead of loadData because we need the date range from the date selector
<span class="fc" id="L110">				employeeMap = EmployeeModelHandler.getEmployeeMap(m_context, getSelectedIDsAsCollection(),</span>
<span class="fc" id="L111">						viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>

				//If the user tries to bypass the UI and forge an HTTP request with employee IDs that they don't have access to, check
				//for that here and clear the selection if that is detected.
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">				if (!userHasPermissionToViewAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L116">					employeeMap.clear();</span>
<span class="nc" id="L117">					addPageMessage(Message.INSTRUCTION_TYPE, getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
							BbmWebBundleKey.SELECT_EMPLOYEE));
<span class="nc" id="L119">					return;</span>
				}

				// Initialize the data required to determine if fields are viewable/editable.
<span class="fc" id="L123">				initializeSecureFieldMetaData();</span>

<span class="pc bpc" id="L125" title="1 of 2 branches missed.">				if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L126">					addPageMessage(Message.WARNING_TYPE,</span>
							FsWebBundleKey.FS_SKILLS_NOT_ALL_EMPLOYEES_EDITABLE, FsWebBundleKey.BUNDLE_NAME);
				}

<span class="fc" id="L130">				ArrayList&lt;String&gt; invalidEmployeeNames = new ArrayList&lt;&gt;();</span>
				//Check to see if all employees start/end dates overlap with the view period.  If not, display
				// a message to the user and do not render the page.
<span class="fc bfc" id="L133" title="All 2 branches covered.">				for (Employee emp : employeeMap.values()) {</span>
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">					if (emp.getStartTimeLocal().after(viewEndDate) ||</span>
<span class="pc bpc" id="L135" title="3 of 4 branches missed.">							(emp.getEndTimeLocal() != null &amp;&amp; emp.getEndTimeLocal().before(viewStartDate))) {</span>
<span class="nc" id="L136">						isViewPeriodValidForAllEmployees = false;</span>
<span class="nc" id="L137">						invalidEmployeeNames.add(m_localizer.formatName(emp));</span>
					}
<span class="fc" id="L139">				}</span>

<span class="pc bpc" id="L141" title="1 of 2 branches missed.">				if (isViewPeriodValidForAllEmployees) {</span>
<span class="fc" id="L142">					loadSkills();</span>

<span class="fc bfc" id="L144" title="All 2 branches covered.">					for (ID employeeID : getSelectedIDsAsCollection()) {</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">						if (!skillAssignmentMap.keySet().contains(employeeID)) {</span>
<span class="fc" id="L146">							Set&lt;SkillAssignment&gt; set = Collections.emptySet();</span>
<span class="fc" id="L147">							skillAssignmentMap.put(employeeID, set);</span>
						}
<span class="fc" id="L149">					}</span>
<span class="fc" id="L150">					m_proficiency = SkillsAssignmentMH.getProficiencyForEmployees(m_context, getSelectedIDsAsCollection(),</span>
<span class="fc" id="L151">							viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
<span class="fc" id="L152">					m_chatSessionMap = SkillsAssignmentMH.getNumberOfChatSessionsForEmployees(m_context, getSelectedIDsAsCollection(), true);</span>
				} else {
<span class="nc" id="L154">					StringBuilder namesStr = new StringBuilder();</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">					for (String empName : invalidEmployeeNames) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">						if (!StringUtil.isEmpty(namesStr.toString())) {</span>
<span class="nc" id="L157">							namesStr.append(&quot;; &quot;);</span>
						}
<span class="nc" id="L159">						namesStr.append(empName);</span>
<span class="nc" id="L160">					}</span>
<span class="nc" id="L161">					addPageMessage(Message.ERROR_TYPE, FsWebBundleKey.FS_VIEW_DATE_OUT_OF_RANGE_FOR_EMP_WORK_RULE_ASSIGNMENT,</span>
<span class="nc" id="L162">							FsWebBundleKey.BUNDLE_NAME, new String[]{namesStr.toString()});</span>
				}

<span class="pc bpc" id="L165" title="1 of 2 branches missed.">				if (isViewPeriodValidForAllEmployees) {</span>
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">					if (selectedSP != null) {</span>
<span class="nc" id="L167">						pc_skill = new SkillsInlineEditListPC(m_context, &quot;skillTable&quot;,</span>
<span class="nc" id="L168">								skillAssignmentMap, viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc" id="L169">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), selectedSP, selectedCampaign, didTimePeriodChange,</span>
<span class="nc" id="L170">								getSelectedIDsAsCollection(), this, getOnSkillRemovedJS(),</span>
<span class="nc" id="L171">								isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY),</span>
<span class="nc" id="L172">								isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>
					} else {
<span class="fc" id="L174">						pc_skill = new SkillsInlineEditListPC(m_context, &quot;skillTable&quot;,</span>
<span class="fc" id="L175">								skillAssignmentMap, viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="fc" id="L176">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), null, null,</span>
<span class="fc" id="L177">								didTimePeriodChange, getSelectedIDsAsCollection(), this, getOnSkillRemovedJS(),</span>
<span class="fc" id="L178">								isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY),</span>
<span class="fc" id="L179">								isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>
					}
<span class="fc" id="L181">					addedSkillAssignments = pc_skill.getAddedSkillAssignments();</span>
<span class="fc" id="L182">					removedSkillAssignments = pc_skill.getRemovedSkillAssignments(skillAssignmentMap);</span>

					//Add proficiency/number of chat sessions form
<span class="fc" id="L185">					FormTwoColumnPC m_formPC = new FormTwoColumnPC(m_context);</span>
<span class="fc" id="L186">					m_formPC.setName(&quot;proficiencyChatForm&quot;);</span>
<span class="fc" id="L187">					m_formPC.setIsBorderEnabled(true);</span>

<span class="fc" id="L189">					employeeProficiencyPC = new FormInputPC(m_context);</span>
<span class="fc" id="L190">					employeeProficiencyPC.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L191">					employeeProficiencyPC.setInputFN(PROFICIENCY_FN);</span>
<span class="fc" id="L192">					employeeProficiencyPC.setIsReadOnly(false);</span>
<span class="fc" id="L193">					employeeProficiencyPC.setIsRequired(false);</span>
<span class="fc" id="L194">					employeeProficiencyPC.setInputFieldDesc(FsWebBundleKey.EMPLOYEE_PROFICIENCY, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L195">					employeeProficiencyPC.setSize(5);</span>
<span class="fc" id="L196">					employeeProficiencyPC.initForDisplay();</span>

<span class="pc bpc" id="L198" title="1 of 2 branches missed.">					employeeProficiencyPC.setEnabled(userHasPermissionToEditAllSelectedEmployees(employeeMap.values())</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">							&amp;&amp; isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>
<span class="fc" id="L200">					employeeProficiencyPC.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>

<span class="fc" id="L202">					employeeProficiencyPC.extractParameters(m_context.getRequest());</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">					if (StringUtil.isEmpty(employeeProficiencyPC.getInputValue())) {</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">						if (MULTI_VALUE_DATA.equals(m_proficiency)) {</span>
<span class="nc" id="L205">							employeeProficiencyPC.setInputValue(m_proficiency);</span>
						} else {
<span class="fc" id="L207">							NumberFormat formatter = NumberFormat.getInstance(m_localizer.getLocaleContext().getRegionalFormatLocale());</span>
<span class="fc" id="L208">							formatter.setMaximumFractionDigits(1);</span>
<span class="fc" id="L209">							double proficiency = Double.parseDouble(m_proficiency); // This value is with decimal always it seems.</span>
<span class="fc" id="L210">							employeeProficiencyPC.setInputValue(formatter.format(proficiency));</span>
						}
					}

<span class="pc bpc" id="L214" title="1 of 2 branches missed.">					if (isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY)) {</span>
<span class="fc" id="L215">						String title_proficiency = m_localizer.i18n(</span>
								FsWebBundleKey.BUNDLE_NAME,
								FsWebBundleKey.EMPLOYEE_PROFICIENCY);
<span class="fc" id="L218">						m_formPC.addRow(title_proficiency, employeeProficiencyPC.getHtmlDisplay());</span>
<span class="fc" id="L219">						m_formPC.addChildComponent(employeeProficiencyPC);</span>
<span class="fc" id="L220">						InRangeFieldValidator empProfValidator = new InRangeFieldValidator(this, PROFICIENCY_FN,</span>
								FsWebBundleKey.EMPLOYEE_PROFICIENCY, FsWebBundleKey.BUNDLE_NAME, 0.00, 9.9);
<span class="fc" id="L222">						empProfValidator.setValidateClientSideOnly(true);</span>
<span class="fc" id="L223">						addValidator(empProfValidator);</span>
					}

<span class="fc" id="L226">					employeeChatPC = new FormInputPC(m_context);</span>
<span class="fc" id="L227">					employeeChatPC.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L228">					employeeChatPC.setInputFN(NUM_CHAT_FN);</span>
<span class="fc" id="L229">					employeeChatPC.setIsRequired(false);</span>
<span class="fc" id="L230">					employeeChatPC.setInputFieldDesc(FsWebBundleKey.EMPLOYEE_NUM_CHAT, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L231">					employeeChatPC.setSize(5);</span>
<span class="fc" id="L232">					employeeChatPC.initForDisplay();</span>
<span class="fc" id="L233">					employeeChatPC.extractParameters(m_context.getRequest());</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">					if (isNumberOfChatSessionsDisabled()) {</span>
<span class="fc" id="L235">						employeeChatPC.setIsReadOnly(true);</span>
<span class="fc" id="L236">						employeeChatPC.setEnabled(false);</span>
					}
<span class="fc bfc" id="L238" title="All 2 branches covered.">					if (StringUtil.isEmpty(employeeChatPC.getInputValue())) {</span>
<span class="fc" id="L239">						employeeChatPC.setInputValue(getNumberOfChatSessionsForEmployees(m_chatSessionMap,</span>
								employeeMap, m_localizer));
					}

					// If overall editability is disabled, it trumps any enabled setting prior to this.
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">					if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L245">						employeeChatPC.setEnabled(false);</span>
					}

<span class="fc" id="L248">					InRangeFieldValidator empChatValidator = new InRangeFieldValidator(this,</span>
							NUM_CHAT_FN, FsWebBundleKey.EMPLOYEE_NUM_CHAT, FsWebBundleKey.BUNDLE_NAME, 1, 99);
<span class="fc" id="L250">					empChatValidator.setValidateClientSideOnly(true);</span>
<span class="fc" id="L251">					addValidator(empChatValidator);</span>
<span class="fc" id="L252">					String title_numchat = m_localizer.i18n(</span>
							FsWebBundleKey.BUNDLE_NAME,
							FsWebBundleKey.EMPLOYEE_NUM_CHAT);
<span class="fc" id="L255">					m_formPC.addRow(title_numchat, employeeChatPC.getHtmlDisplay());</span>
<span class="fc" id="L256">					m_formPC.addChildComponent(employeeChatPC);</span>
<span class="fc" id="L257">					addForm(m_formPC);</span>

					//Skill Assignment Container
<span class="fc" id="L260">					CollapsibleContainerPC skillAssignmentContainer = new CollapsibleContainerPC(m_context);</span>
<span class="fc" id="L261">					skillAssignmentContainer.setName(&quot;skillAssignmentContainer&quot;);</span>
<span class="fc" id="L262">					skillAssignmentContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
							FsWebBundleKey.SKILLASSIGNED));
<span class="fc" id="L264">					skillAssignmentContainer.setIsBorderEnabled(true);</span>
<span class="fc" id="L265">					pc_skill.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="fc" id="L266">					pc_skill.setIsInnerTable(true);</span>
<span class="fc" id="L267">					pc_skill.setIsBorderEnabled(false);</span>
<span class="fc" id="L268">					pc_skill.setIsCancelSelectEventPropagation(false);</span>
<span class="fc" id="L269">					pc_skill.setPreRowRemoveJS(getPreSkillRemovedJS());</span>
<span class="fc" id="L270">					pc_skill.setOnRowAddJS(getOnRowAddJS());</span>
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">					if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L272">						pc_skill.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L273">						pc_skill.setEnabled(false);</span>
					}

<span class="fc" id="L276">					skillAssignmentContainer.addComponent(pc_skill);</span>
<span class="fc" id="L277">					addChildComponent(skillAssignmentContainer);</span>
<span class="fc" id="L278">					addForm(skillAssignmentContainer);</span>
				}
<span class="nc" id="L280">			} catch (Exception e) {</span>
<span class="nc" id="L281">				handleUnableToLoadDataError(log, e);</span>
<span class="pc" id="L282">			}</span>
		} else {
<span class="nc" id="L284">			addPageMessage(Message.INSTRUCTION_TYPE, getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
					BbmWebBundleKey.SELECT_EMPLOYEE));
		}
<span class="fc" id="L287">	}</span>

	protected void loadSkills() throws BbmException, RemoteException {
<span class="pc bpc" id="L290" title="3 of 4 branches missed.">		if (selectedSP != null &amp;&amp; selectedCampaign != null) {</span>
<span class="nc" id="L291">			skillAssignmentMap = getEmpSkillAssignments(</span>
<span class="nc" id="L292">					viewStartDate.getTime(selectedCampaign.getTimeZone()),</span>
<span class="nc" id="L293">					viewEndDate.getTime(selectedCampaign.getTimeZone()));</span>
		} else {
<span class="fc" id="L295">			skillAssignmentMap = getEmpSkillAssignments(</span>
<span class="fc" id="L296">					viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="fc" id="L297">					viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
		}

		//We need to retrieve the skills in a separate call
		//TODO: This should really be a ValueObjectRich so it can be done in the back end but
		// I was unaware of how this would impact the FS client.
		// (These assignments also already extend DAOEffectivity which makes things more difficult)
<span class="fc" id="L304">		HashSet&lt;SkillAssignment&gt; assignments = new HashSet&lt;SkillAssignment&gt;();</span>
<span class="fc bfc" id="L305" title="All 2 branches covered.">		for (ID employeeID : skillAssignmentMap.keySet()) {</span>
			//We only want to display the earliest skill assignment within the view period if the employee
			//  has multiple skill assignments for the same skill in the view period
<span class="fc" id="L308">			HashMap&lt;ID, SkillAssignment&gt; filteredAssignmentMap = new HashMap&lt;ID, SkillAssignment&gt;();</span>

<span class="fc bfc" id="L310" title="All 2 branches covered.">			for (SkillAssignment assignment : skillAssignmentMap.get(employeeID)) {</span>
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">				if (isSkillAssignmentCurrent(assignment)) {</span>
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">					if (assignment.getStartTime() != null) {</span>
<span class="fc" id="L313">						assignment.setLocalStartTime(new LocalDate(assignment.getStartTime(),</span>
<span class="fc" id="L314">								employeeMap.get(employeeID).getTimeZone(assignment.getStartTime())));</span>
					}
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">					if (assignment.getEndTime() != null) {</span>
<span class="nc" id="L317">						assignment.setLocalEndTime(new LocalDate(assignment.getEndTime(),</span>
<span class="nc" id="L318">								employeeMap.get(employeeID).getTimeZone(assignment.getEndTime())));</span>
					}
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">					if (filteredAssignmentMap.get(assignment.getSkillID()) == null) {</span>
<span class="fc" id="L321">						filteredAssignmentMap.put(assignment.getSkillID(), assignment);</span>
					} else {
<span class="nc" id="L323">						SkillAssignment otherAssignment = filteredAssignmentMap.get(assignment.getSkillID());</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">						if (assignment.getStartTime().before(otherAssignment.getStartTime())) {</span>
<span class="nc" id="L325">							filteredAssignmentMap.put(assignment.getSkillID(), assignment);</span>
						}
					}
				}
<span class="fc" id="L329">			}</span>
<span class="fc" id="L330">			ArrayList&lt;SkillAssignment&gt; filteredAssignments = new ArrayList&lt;SkillAssignment&gt;(filteredAssignmentMap.values());</span>
<span class="fc" id="L331">			skillAssignmentMap.put(employeeID, filteredAssignments);</span>
<span class="fc" id="L332">			assignments.addAll(filteredAssignments);</span>
<span class="fc" id="L333">		}</span>
<span class="fc" id="L334">		ArrayList&lt;ID&gt; skillIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L335" title="All 2 branches covered.">		for (SkillAssignment assignment : assignments) {</span>
<span class="fc" id="L336">			skillIDs.add(assignment.getSkillID());</span>
<span class="fc" id="L337">		}</span>
<span class="fc bfc" id="L338" title="All 2 branches covered.">		if (!skillIDs.isEmpty()) {</span>
<span class="fc" id="L339">			Collection&lt;Skill&gt; tempSkills = SkillModelHandler.getSkillsByIDs(skillIDs);</span>
<span class="fc bfc" id="L340" title="All 2 branches covered.">			for (ID employeeID : skillAssignmentMap.keySet()) {</span>
<span class="fc bfc" id="L341" title="All 2 branches covered.">				for (SkillAssignment assignment : skillAssignmentMap.get(employeeID)) {</span>
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">					for (Skill skill : tempSkills) {</span>
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">						if (skill.getID().equals(assignment.getSkillID())) {</span>
<span class="fc" id="L344">							assignment.setSkill(skill);</span>
<span class="fc" id="L345">							break;</span>
						}
<span class="nc" id="L347">					}</span>
<span class="fc" id="L348">				}</span>
<span class="fc" id="L349">			}</span>
		}
<span class="fc" id="L351">	}</span>

	protected Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; getEmpSkillAssignments(Date start, Date end) throws BbmFinderException {
<span class="fc" id="L354">		return SkillsAssignmentMH.getSkillAssignmentsForEmployees(m_context,</span>
<span class="fc" id="L355">				getSelectedIDsAsCollection(), start,</span>
				end);
	}

	public void saveSkillsAssignments() throws BbmException, RemoteException {
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">		if (pc_skill.save(employeeMap)) {</span>
			//On successful save, we need to refresh the work pattern map for the workPatternPC so that
			//merged assignments will be displayed
<span class="fc" id="L363">			loadSkills();</span>
<span class="fc" id="L364">			pc_skill.refreshSkillAssignmentMap(skillAssignmentMap);</span>
		}
<span class="fc" id="L366">	}</span>

	public void saveEmployeeProficiency() throws BbmException, MultiUserException, RemoteException {
		try {
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">			if (!StringUtil.isEmpty(employeeProficiencyPC.getInputValue()) &amp;&amp;</span>
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">					!employeeProficiencyPC.getInputValue().equals(MULTI_VALUE_DATA)) {</span>
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">				if (isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY)) {</span>
<span class="fc" id="L373">					SkillsAssignmentMH.saveEmployeeProficiency(m_context, getSelectedIDsAsCollection(),</span>
<span class="fc" id="L374">							viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="fc" id="L375">							NumberFormat.getInstance(m_localizer.getLocaleContext().getRegionalFormatLocale()).parse(employeeProficiencyPC.getInputValue()).doubleValue());</span>
				}
			}
<span class="nc" id="L378">		} catch (ParseException e) {</span>
<span class="nc" id="L379">			throw new BbmException(e);</span>
<span class="fc" id="L380">		}</span>
<span class="fc" id="L381">	}</span>

	/**
	 * Saves employee chat sessions only if all selected employees have an assigned chat skill for the
	 * current view period.
	 */
	public void saveEmployeeChatSessions() throws BbmException, RemoteException {
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">		if (isNumberOfChatSessionsDisabled()) {</span>
<span class="fc" id="L389">			return;    //Don't save chat sessions if the field is disabled (i.e. aren't valid for the given view period)</span>
		}
<span class="nc bnc" id="L391" title="All 2 branches missed.">		if (!StringUtil.isEmpty(employeeChatPC.getInputValue()) &amp;&amp;</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">				!employeeChatPC.getInputValue().equals(MULTI_VALUE_DATA)) {</span>
<span class="nc" id="L393">			SkillsAssignmentMH.saveNumberOfChatSessionsForEmployees(m_context, getSelectedIDsAsCollection(),</span>
<span class="nc" id="L394">					Integer.parseInt(employeeChatPC.getInputValue()));</span>
		}
<span class="nc" id="L396">	}</span>

	public static String getOnRowAddJS() {
<span class="fc" id="L399">		StringBuilder js = new StringBuilder();</span>
<span class="fc" id="L400">		js.append(&quot;var $generalProficiencyInput = jQuery('input[name=&quot; + PROFICIENCY_FN + &quot;]');&quot;);</span>
<span class="fc" id="L401">		js.append(&quot;var rowAdded = skillTable.getRowByUID(id);&quot;);</span>
<span class="fc" id="L402">		js.append(&quot;var proficiencyId = skillTable.getRowAttribute(rowAdded, 'proficiencyFN');&quot;);</span>
<span class="fc" id="L403">		js.append(&quot;var num = $generalProficiencyInput.val();&quot;);</span>
<span class="fc" id="L404">		js.append(&quot;jQuery('input[name=' + proficiencyId + ']').val(num.toFixed ? num.toFixed(1) : num);&quot;);</span>
<span class="fc" id="L405">		return js.toString();</span>
	}

	public static String getOnChatSkillAddedJS(String numChatSessionsValue) {
<span class="nc" id="L409">		StringBuilder js = new StringBuilder();</span>
<span class="nc" id="L410">		js.append(&quot;var empAssignmentNumChatSessionsInputElement = jQuery('input[name=&quot; + NUM_CHAT_FN + &quot;]');&quot;);</span>
<span class="nc" id="L411">		js.append(&quot;empAssignmentNumChatSessionsInputElement.removeClass('&quot; + FormInputPC.INPUT_TEXT_READ_ONLY_STYLE + &quot;');&quot;);</span>
<span class="nc" id="L412">		js.append(&quot;empAssignmentNumChatSessionsInputElement.addClass('&quot; + FormInputPC.DEFAULT_STYLE + &quot;');&quot;);</span>
<span class="nc" id="L413">		js.append(&quot;empAssignmentNumChatSessionsInputElement.removeAttr('readOnly');&quot;);</span>
<span class="nc" id="L414">		js.append(&quot;empAssignmentNumChatSessionsInputElement.val('&quot; + numChatSessionsValue + &quot;');&quot;);</span>
<span class="nc" id="L415">		return js.toString();</span>
	}

	private static String getOnSkillRemovedJS() {
<span class="fc" id="L419">		StringBuilder js = new StringBuilder();</span>
<span class="fc" id="L420">		js.append(&quot;var chatSkillRows = skillTable.getRowCountWithAttribute('isCommonChatSkill');&quot;);</span>
<span class="fc" id="L421">		js.append(&quot;if (chatSkillRows == 0) {&quot;);</span>
<span class="fc" id="L422">		js.append(&quot;var empAssignmentNumChatSessionsInputElement = jQuery('input[name=&quot; + NUM_CHAT_FN + &quot;]');&quot;);</span>
<span class="fc" id="L423">		js.append(&quot;empAssignmentNumChatSessionsInputElement.removeClass('&quot; + FormInputPC.DEFAULT_STYLE + &quot;');&quot;);</span>
<span class="fc" id="L424">		js.append(&quot;empAssignmentNumChatSessionsInputElement.addClass('&quot; + FormInputPC.INPUT_TEXT_READ_ONLY_STYLE + &quot;');&quot;);</span>
<span class="fc" id="L425">		js.append(&quot;empAssignmentNumChatSessionsInputElement.attr('readOnly', 'true');&quot;);</span>
<span class="fc" id="L426">		js.append(&quot;}&quot;);</span>
<span class="fc" id="L427">		return js.toString();</span>
	}

	private static String getPreSkillRemovedJS() {
<span class="fc" id="L431">		StringBuilder js = new StringBuilder();</span>
<span class="fc" id="L432">		js.append(&quot;var rowToRemove = skillTable.getRowByUID(id);&quot;);</span>
<span class="fc" id="L433">		js.append(&quot;removeValidators(skillTable.getRowAttribute(rowToRemove, 'priorityFN'));&quot;);</span>
<span class="fc" id="L434">		js.append(&quot;removeValidators(skillTable.getRowAttribute(rowToRemove, 'proficiencyFN'));&quot;);</span>
<span class="fc" id="L435">		return js.toString();</span>
	}

	/**
	 * Returns true if any of the selected employees do not have any chat skills assigned for the current view period.
	 */
	private boolean isNumberOfChatSessionsDisabled() {
		//Return true if any of the added assignments are chat skills
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">		if (addedSkillAssignments != null) {</span>
<span class="fc bfc" id="L444" title="All 2 branches covered.">			for (SkillAssignment addedAssignment : addedSkillAssignments) {</span>
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">				if (addedAssignment.getSkill().getMediaID().equals(Media.MEDIA_ID_CHAT)) {</span>
<span class="nc" id="L446">					return false;</span>
				}
<span class="fc" id="L448">			}</span>
		}
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">		if (removedSkillAssignments == null) {</span>
<span class="nc" id="L451">			removedSkillAssignments = new ArrayList&lt;&gt;();</span>
		}
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">		for (Collection&lt;SkillAssignment&gt; employeeAssignments : skillAssignmentMap.values()) {</span>
<span class="fc" id="L454">			boolean employeeHasChatSkill = false;</span>
<span class="fc bfc" id="L455" title="All 2 branches covered.">			for (SkillAssignment assignment : employeeAssignments) {</span>
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">				if (assignment.getSkill().getMediaID().equals(Media.MEDIA_ID_CHAT) &amp;&amp;</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">						removedSkillAssignments.contains(assignment) == false) {</span>
<span class="nc" id="L458">					employeeHasChatSkill = true;</span>
<span class="nc" id="L459">					break;</span>
				}
<span class="fc" id="L461">			}</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">			if (employeeHasChatSkill == false) {</span>
<span class="fc" id="L463">				return true;</span>
			}
<span class="nc" id="L465">		}</span>

<span class="nc" id="L467">		return false;</span>
	}

	/**
	 * Returns a string representation of the number of chat sessions assigned to all selected employees.
	 * If employees do not have any chat sessions assigned, they will be treated as though they have 1 chat session
	 * assigned.  If the selected employees do not all have the same number of assigned chat sessions, then
	 * an asterisk &quot;*&quot; representing multi-value will be returned.
	 */
	public static String getNumberOfChatSessionsForEmployees(Map&lt;ID, Integer&gt; chatSessionMap, Map&lt;ID, Employee&gt; employeeMap,
			Localizer localizer) {
<span class="pc bpc" id="L478" title="2 of 4 branches missed.">		if (chatSessionMap == null || chatSessionMap.size() == 0) {</span>
<span class="nc" id="L479">			return localizer.formatNumber(1);</span>
		}
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">		if (chatSessionMap.size() != employeeMap.size()) {</span>
<span class="nc" id="L482">			return MULTI_VALUE_DATA;</span>
		}
<span class="fc" id="L484">		int numberOfChatSessions = chatSessionMap.values().iterator().next();</span>
<span class="fc bfc" id="L485" title="All 2 branches covered.">		for (Integer empChatSessions : chatSessionMap.values()) {</span>
<span class="pc bpc" id="L486" title="1 of 2 branches missed.">			if (numberOfChatSessions != empChatSessions) {</span>
<span class="nc" id="L487">				return MULTI_VALUE_DATA;</span>
			}
<span class="fc" id="L489">		}</span>

<span class="fc" id="L491">		return localizer.formatNumber(numberOfChatSessions);</span>
	}

	/**
	 * Determines if the current skill assignment is &quot;current&quot;, in other words it applies to the current
	 * view period.  This is true if the start date of the assignment lies before or at the view period start date
	 * and the assignment end date is either null or lies after the view period start date.  Skill assignments are also
	 * current if they lie between the view start and end dates.
	 */
	private boolean isSkillAssignmentCurrent(SkillAssignment assignment) {
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">		if (selectedCampaign == null) {</span>
			TimeZone empTimeZone;
<span class="fc" id="L503">			Employee emp = employeeMap.get(assignment.getWorkResourceID());</span>
			//Determine time zone of employee at record start
<span class="pc bpc" id="L505" title="1 of 2 branches missed.">			if (emp.getStartTime().after(assignment.getStartTime())) {</span>
<span class="nc" id="L506">				empTimeZone = emp.getTimeZone(emp.getStartTime());</span>
			} else {
<span class="fc" id="L508">				empTimeZone = emp.getTimeZone(assignment.getStartTime());</span>
			}
<span class="fc" id="L510">			LocalDate localEffectiveStart = new LocalDate(assignment.getStartTime(), empTimeZone);</span>
<span class="fc" id="L511">			LocalDate localEffectiveEnd = null;</span>
			//Determine time zone of employee at record end
<span class="pc bpc" id="L513" title="1 of 2 branches missed.">			if (assignment.getEndTime() != null) {</span>
<span class="nc bnc" id="L514" title="All 4 branches missed.">				if (emp.getEndTime() == null || emp.getEndTime().after(assignment.getEndTime())) {</span>
<span class="nc" id="L515">					empTimeZone = emp.getTimeZone(assignment.getEndTime());</span>
				} else {
<span class="nc" id="L517">					empTimeZone = emp.getTimeZone(emp.getEndTime());</span>
				}
<span class="nc" id="L519">				localEffectiveEnd = new LocalDate(assignment.getEndTime(), empTimeZone);</span>
			}
<span class="pc bpc" id="L521" title="4 of 6 branches missed.">			return ((localEffectiveStart.before(viewStartDate) || localEffectiveStart.equals(viewStartDate))</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">					&amp;&amp; (localEffectiveEnd == null || localEffectiveEnd.after(viewStartDate))) ||</span>
<span class="pc bnc" id="L523" title="All 4 branches missed.">					(localEffectiveStart.after(viewStartDate) &amp;&amp; localEffectiveStart.before(viewEndDate));</span>
		} else {
<span class="nc" id="L525">			Date absoluteViewStartDate = viewStartDate.getTime(selectedCampaign.getTimeZone());</span>
<span class="nc" id="L526">			Date absoluteViewEndDate = viewEndDate.getTime(selectedCampaign.getTimeZone());</span>
<span class="nc bnc" id="L527" title="All 4 branches missed.">			return ((assignment.getStartTime().before(absoluteViewStartDate) || assignment.getStartTime().equals(absoluteViewStartDate))</span>
<span class="nc bnc" id="L528" title="All 4 branches missed.">					&amp;&amp; (assignment.getEndTime() == null || assignment.getEndTime().after(absoluteViewStartDate))) ||</span>
<span class="nc bnc" id="L529" title="All 4 branches missed.">					(assignment.getStartTime().after(absoluteViewStartDate) &amp;&amp; assignment.getStartTime().before(absoluteViewEndDate));</span>
		}
	}

	/**
	 * Initializes the secure field meta data for use in determining viewability/editability of certain fields.
	 */
	private void initializeSecureFieldMetaData() {
<span class="fc" id="L537">		authorizedViewFields = new HashMap&lt;&gt;();</span>
<span class="fc" id="L538">		authorizedEditFields = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L540" title="All 2 branches covered.">		for (Employee emp : employeeMap.values()) {</span>
<span class="fc" id="L541">			int[] viewableFields =</span>
<span class="fc" id="L542">					m_context.getUser().getAuthorizedFields(</span>
							PrivilegeKeys.CORE_VIEWSECUREFIELD,
<span class="fc" id="L544">							new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE));</span>
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">			if (viewableFields == null) {</span>
<span class="nc" id="L546">				viewableFields = new int[0];</span>
			}

<span class="fc" id="L549">			int[] editableFields =</span>
<span class="fc" id="L550">					m_context.getUser().getAuthorizedFields(</span>
							PrivilegeKeys.CORE_EDITSECUREFIELD,
<span class="fc" id="L552">							new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE));</span>
<span class="pc bpc" id="L553" title="1 of 2 branches missed.">			if (editableFields == null) {</span>
<span class="nc" id="L554">				editableFields = new int[0];</span>
			}

<span class="fc" id="L557">			authorizedViewFields.put(emp.getID(), ArrayUtil.asList(viewableFields));</span>
<span class="fc" id="L558">			authorizedEditFields.put(emp.getID(), ArrayUtil.asList(editableFields));</span>
<span class="fc" id="L559">		}</span>
<span class="fc" id="L560">	}</span>

	/**
	 * Returns whether a field is EDITABLE based on the current user and employees/scope selected.
	 *
	 * @param secureFieldInfoId Secure field info {@link com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo SecureFieldInfo}
	 * @return boolean
	 */
	private boolean isFieldEditable(int secureFieldInfoId) {
		// If the field is not viewable then we don't even need to check
		// further for editability.
<span class="pc bpc" id="L571" title="1 of 2 branches missed.">		if (!isFieldViewable(secureFieldInfoId)) {</span>
<span class="nc" id="L572">			return false;</span>
		}

<span class="fc bfc" id="L575" title="All 2 branches covered.">		for (Employee emp : employeeMap.values()) {</span>
			// Just looking for any employee in the selection that doesn't permit EDITING
			// because we can't permit more access than the lowest permitted or actions
			// can be taken that shouldn't be allowed for some of the employees.
<span class="pc bpc" id="L579" title="1 of 2 branches missed.">			if (authorizedEditFields.containsKey(emp.getID())) {</span>
<span class="pc bpc" id="L580" title="1 of 2 branches missed.">				if (!authorizedEditFields.get(emp.getID()).contains(secureFieldInfoId)) {</span>
					// This field is not EDITABLE for this employee and scope so
					// we cannot permit the field to be EDITABLE for the selected
					// employees.
<span class="nc" id="L584">					return false;</span>
				}
			} // If the employee doesn't have any secured field information let's assume they can be accessed.
<span class="fc" id="L587">		}</span>
<span class="fc" id="L588">		return true;</span>
	}

	/**
	 * Returns whether a field is VIEWABLE based on the current user and employees/scope selected.
	 *
	 * @param secureFieldInfoId Secure field info {@link com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo SecureFieldInfo}
	 * @return boolean
	 */
	private boolean isFieldViewable(int secureFieldInfoId) {
<span class="fc bfc" id="L598" title="All 2 branches covered.">		for (Employee emp : employeeMap.values()) {</span>
			// Just looking for any employee in the selection that doesn't permit VIEWING
			// because we can't permit more access than the lowest permitted or actions
			// can be taken that shouldn't be allowed for some of the employees.
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">			if (authorizedViewFields.containsKey(emp.getID())) {</span>
<span class="pc bpc" id="L603" title="1 of 2 branches missed.">				if (!authorizedViewFields.get(emp.getID()).contains(secureFieldInfoId)) {</span>
					// This field is not VIEWABLE for this employee and scope so
					// we cannot permit the field to be VIEWABLE for the selected
					// employees.
<span class="nc" id="L607">					return false;</span>
				}
			} // If the employee doesn't have any secured field information let's assume they can be accessed.
<span class="fc" id="L610">		}</span>
<span class="fc" id="L611">		return true;</span>
	}

	@Override
	protected String getPageTitle() {
<span class="fc" id="L616">		return i18n(m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME), BbmWebBundleKey.PEOPLE_SKILLS_LIST_PAGE_TITLE);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>