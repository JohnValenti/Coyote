<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WeeklyHistoryPeriod.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.ejb.bbm.forecast.model.history</a> &gt; <span class="el_source">WeeklyHistoryPeriod.java</span></div><h1>WeeklyHistoryPeriod.java</h1><pre class="source lang-java linenums">/*
 * (c) 2011-2012 Verint Systems, Inc.
 */
package com.verint.ejb.bbm.forecast.model.history;

import com.bluepumpkin.common.datatypes.TimeContext;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.pulse.model.PulseNoteBO;
import com.bluepumpkin.ejb.bbm.time.TimeInterval;
import com.bluepumpkin.ejb.bbm.time.TimeIntervalAtTime;
import com.bluepumpkin.ejb.bbm.time.TimeUnits;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.verint.ejb.bbm.forecast.ProfileComponentUtil;
import com.verint.ejb.bbm.forecast.model.history.provider.IHistoryProvider;
import com.verint.ejb.wfm.l10n.WfmCommonBundleKey;

import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.List;

public class WeeklyHistoryPeriod extends ProfileEntryHistoryPeriod {

	private Date m_startDate;
	private Date m_endDate;

	public WeeklyHistoryPeriod(List&lt;TimeIntervalAtTime&gt; daysInPeriod, Date spWeekStartDate, TimeContext timeContext) {
<span class="nc" id="L31">		super(daysInPeriod, spWeekStartDate, timeContext);</span>
<span class="nc" id="L32">	}</span>

	@Override
	public ProfileEntryIntervalType getIntervalType() {
<span class="nc" id="L36">		return ProfileEntryIntervalType.Week;</span>
	}

	@Override
	public TraceCube getHistoryTraceCube(IHistoryProvider historyProvider) throws BbmException {
<span class="nc" id="L41">		return historyProvider.getHistory(intervalRepresentingPeriod);</span>
	}

	@Override
	public Collection&lt;PulseNoteBO&gt; getNotesForPeriod(IHistoryProvider historyProvider) throws BbmException {
<span class="nc" id="L46">		return historyProvider.getNotes(intervalRepresentingPeriod);</span>
	}

	@Override
	public String getLocalizedDescription(Localizer localizer) {
		//Always show the full week even if the history only covers a partial week - per the Monthly Forecasting requirement
<span class="nc" id="L52">		Calendar endCal = Calendar.getInstance(getTimeContext().getTimeZone());</span>
<span class="nc" id="L53">		endCal.setTime(m_endDate);</span>
<span class="nc" id="L54">		endCal.add(Calendar.DAY_OF_YEAR, -1);</span>
<span class="nc" id="L55">		return localizer.i18n(WfmCommonBundleKey.BUNDLE_NAME,</span>
				WfmCommonBundleKey.WEEK_OF_X_TO_Y, new Object[] {
<span class="nc" id="L57">				localizer.formatDate(m_startDate, getTimeContext().getTimeZone(),</span>
						RegionalFormatBundleKey.DATE_FORMAT),
<span class="nc" id="L59">						localizer.formatDate(m_endDate, getTimeContext().getTimeZone(),</span>
						RegionalFormatBundleKey.DATE_FORMAT)});
	}

	/**
	 * Returns a TimeIntervalAtTime which represents the interval for which history data will be used
	 * for this object's associated SP week.  For example, for an SP with a week boundary on Sunday, but given
	 * a partial week that spans Tuesday September 1st - Saturday September 5th, this method will return the
	 * interval spanning Tuesday September 1st - Saturday September 5th.  This could differ from the interval
	 * represented by the days in daysInPeriod.
	 *
	 * Generally, for full SP weeks, this interval will match the intervals in daysInPeriod.
	 */
	@Override
	protected TimeIntervalAtTime initIntervalRepresentingPeriod() {
<span class="nc bnc" id="L74" title="All 2 branches missed.">		if (daysInPeriod != null) {</span>
<span class="nc" id="L75">			m_startDate = daysInPeriod.get(0).getStartTime();</span>
<span class="nc" id="L76">			m_endDate = daysInPeriod.get(daysInPeriod.size() - 1).getStartTime();</span>
		}

<span class="nc" id="L79">		Calendar historyWeekStartCal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L80">		historyWeekStartCal.setTime(m_startDate);</span>
<span class="nc" id="L81">		Calendar spWeekStartCal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L82">		spWeekStartCal.setTime(spWeekStartDate);</span>

		//If the start of the SP week does not match the start of week in the time context, this indicates
		//that we have a partial SP week and so the interval to be returned will span only the partial week
		//and not the full week.
<span class="nc bnc" id="L87" title="All 2 branches missed.">		if (historyWeekStartCal.get(Calendar.DAY_OF_WEEK) != spWeekStartCal.get(Calendar.DAY_OF_WEEK)) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">			for (int i = 0; i &lt; daysInPeriod.size(); i++) {</span>
<span class="nc" id="L89">				TimeIntervalAtTime dayInPeriod = daysInPeriod.get(i);</span>
<span class="nc" id="L90">				if (dayInPeriod.getDayOfWeekAtStartOfInterval().getCalendarConstant() ==</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">						spWeekStartCal.get(Calendar.DAY_OF_WEEK)) {</span>
<span class="nc" id="L92">					return new TimeIntervalAtTime(dayInPeriod.getStartTime(),</span>
<span class="nc" id="L93">							new TimeInterval(TimeUnits.Day, daysInPeriod.size() - i, timeContext));</span>
				}
			}

		}
		//We should never get to this point, but just in case, return an ordinary week interval.
<span class="nc" id="L99">		return new TimeIntervalAtTime(m_startDate, timeIntervalFactory.getOneWeek());</span>
	}

	/**
	 * Returns the absolute start date for this weekly history period.  This date is defined
	 * as midnight of the SP's TimeZone on the start day of the SP week.
	 * 
	 * See ProfileComponent.getDate and ProfileComponent.setAbsoluteDate.
	 */
	@Override
	public Date getAbsoluteStartDate() {
<span class="nc bnc" id="L110" title="All 2 branches missed.">		if (timeContext.getDayBoundary() &gt; 0) {</span>
<span class="nc" id="L111">			Calendar retVal = Calendar.getInstance();</span>
<span class="nc" id="L112">			retVal.setTime(m_startDate);</span>
<span class="nc" id="L113">			retVal.add(Calendar.MINUTE, -timeContext.getDayBoundary());</span>
<span class="nc" id="L114">			return retVal.getTime();</span>
		} else {
<span class="nc" id="L116">			return m_startDate;</span>
		}
	}

	@Override
	public int getRelativeOffsetFromSPWeek() {
<span class="nc" id="L122">		Calendar startCal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L123">		startCal.setTime(m_startDate);</span>
<span class="nc" id="L124">		Calendar spWeekCal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
		//Offset will be determined by the start of the full week (with respect to the time context's start of week
		//definition.
<span class="nc" id="L127">		Date fullWeekStartDate =</span>
<span class="nc" id="L128">				ProfileComponentUtil.findNearestStartOfWeekDateBehindSelectedDate(spWeekStartDate, timeContext);</span>
<span class="nc" id="L129">		spWeekCal.setTime(fullWeekStartDate);</span>
		
<span class="nc" id="L131">		int weekCount = 0;</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">		if (startCal.before(spWeekCal)) {</span>
			// Add weeks until the difference is less than one day (should be enough to get around any DST offsets)
<span class="nc bnc" id="L134" title="All 2 branches missed.">			while ((fullWeekStartDate.getTime() - startCal.getTimeInMillis()) &gt; TimeZoneUtil.DAY_IN_MILLISECONDS) {</span>
<span class="nc" id="L135">				weekCount++;</span>
<span class="nc" id="L136">				startCal.add(Calendar.WEEK_OF_YEAR, 1);</span>
				//Safety to prevent an infinite loop
<span class="nc bnc" id="L138" title="All 2 branches missed.">				if (startCal.after(spWeekCal)) {</span>
<span class="nc" id="L139">					break;</span>
				}
			}
<span class="nc bnc" id="L142" title="All 2 branches missed.">		} else if (startCal.after(spWeekCal)) {</span>
			// Add weeks until the difference is less than one day (should be enough to get around any DST offsets)
<span class="nc bnc" id="L144" title="All 2 branches missed.">			while ((fullWeekStartDate.getTime() - startCal.getTimeInMillis()) &gt; TimeZoneUtil.DAY_IN_MILLISECONDS) {</span>
<span class="nc" id="L145">				weekCount--;</span>
<span class="nc" id="L146">				startCal.add(Calendar.WEEK_OF_YEAR, -1);</span>
				//Safety to prevent an infinite loop
<span class="nc bnc" id="L148" title="All 2 branches missed.">				if (startCal.before(spWeekCal)) {</span>
<span class="nc" id="L149">					break;</span>
				}
			}
		}
		
<span class="nc" id="L154">		return weekCount;</span>
	}

	/**
	 * Returns the date range of the full week of this history period (starting at the start of week
	 * defined in the Campaign), even if this history period is only used in a partial week for monthly SPs.  For partial
	 * SP weeks this interval may be different from the interval returned via getTimeIntervalRepresentingPeriod as
	 * this method returns the full week containing the partial week (as defined via this object's timeContext), while
	 * getTimeIntervalRepresentingPeriod starts at the beginning of the SP's partial week.
	 */
	public TimeIntervalAtTime getIntervalRepresentingProfileComponent() {
<span class="nc" id="L165">		return new TimeIntervalAtTime(m_startDate, new TimeInterval(TimeUnits.Week, 1, getTimeContext()));</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>