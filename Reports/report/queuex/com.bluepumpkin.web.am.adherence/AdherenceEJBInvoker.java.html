<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AdherenceEJBInvoker.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.am.adherence</a> &gt; <span class="el_source">AdherenceEJBInvoker.java</span></div><h1>AdherenceEJBInvoker.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.am.adherence;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.Map.Entry;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.datasource.ejb.DataSourceManager;
import com.bluepumpkin.ejb.bbm.datasource.model.DataSource;
import com.bluepumpkin.ejb.bbm.datasourcetype.model.DataSourceType;
import com.bluepumpkin.ejb.bbm.employeefilter.ejb.EmployeeFilter;
import com.bluepumpkin.ejb.bbm.employeefilter.model.Filter;
import com.bluepumpkin.ejb.bbm.rtaamanager.ejb.RTAAManager;
import com.bluepumpkin.ejb.bbm.rtaamanager.model.RTAAData;
import com.bluepumpkin.ejb.bbm.rtaaservice.ejb.RTAAService;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.RTAAException;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeTrackingEvent;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeDataSource;
import com.bluepumpkin.ejb.bpx.balance.model.BalanceUserRecording;
import com.bluepumpkin.ejb.bpx.balance.model.Interaction;
import com.bluepumpkin.ejb.bpx.util.EJBManagerFactory;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.am.Log;
import com.bluepumpkin.web.am.adherence.keys.AdherenceKeys;
import com.bluepumpkin.web.am.adherence.mapping.AdherenceMapping;
import com.bluepumpkin.web.am.adherence.mapping.AdherenceMappingModelHandler;
import com.bluepumpkin.web.am.adherence.util.AdherenceUtils;
import com.bluepumpkin.web.am.adherence.util.AgentContact;
import com.bluepumpkin.web.bbm.activity.SpecialActivityFormPageModel;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.helper.AccessRightHelper;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.system.RequestContext;


/**
 * Title:	 AdherenceEJBInvoker
 * Description:	 Handle the adherence interface to EJB
 * Copyright:	 Copyright (c) 2003
 * Company:	 Blue Pumpkin Software, Inc
 * @author	 Alvin Cham
 * @version 1.0
 */
<span class="nc" id="L65">public class AdherenceEJBInvoker {</span>
<span class="nc" id="L66">	private static Category cat = Log.initCategory(AdherenceEJBInvoker.class.getName());</span>

	private static final String EMPTY_MAPPED_ACTIVITIES_STRING = &quot;--&quot;;

	/**
	 *	Gets adherence data
	 *
	 *	@param empIDs
	 *	@param start   The start time
	 *	@param end	   The end time
	 *	@param sortKey The sorting parameter
	 *	@param pageNum The pagination number
	 *	@param pageSize The pagination size
	 *	@param timestamp  The last udpated timestamp
	 *
	 *	@return	 A RTAAData object
	 *	
	 */
	static public RTAAData getAdherenceData(RequestContext context, Collection empIDs,
											Date start,
											Date end,
											int sortKey,
											int pageNum,
											int pageSize,
											Date timestamp,
											boolean showUnavailable)
		throws Exception
	{
<span class="nc" id="L94">		RTAAManager rtaaManager = BbmManagerFactory.getRTAAManager(context.isInWhatIfMode());</span>

<span class="nc" id="L96">		Date ts = new Date();</span>

<span class="nc bnc" id="L98" title="All 2 branches missed."> 		if (cat.isDebugEnabled()) {</span>
<span class="nc" id="L99"> 			StringBuffer sb = new StringBuffer(512);</span>
<span class="nc" id="L100"> 			sb.append(&quot;getAdherenceData()::parameters::start=&quot;);</span>
<span class="nc" id="L101"> 			sb.append(start);</span>
<span class="nc" id="L102"> 			sb.append(&quot;:end=&quot;);</span>
<span class="nc" id="L103"> 			sb.append(end);</span>
<span class="nc" id="L104"> 			sb.append(&quot;:sort=&quot;);</span>
<span class="nc" id="L105"> 			sb.append(sortKey);</span>
<span class="nc" id="L106"> 			sb.append(&quot;:pageNum=&quot;);</span>
<span class="nc" id="L107"> 			sb.append(pageNum);</span>
<span class="nc" id="L108"> 			sb.append(&quot;:pageSize=&quot;);</span>
<span class="nc" id="L109"> 			sb.append(pageSize);</span>
<span class="nc" id="L110"> 			sb.append(&quot;:timestamp=&quot;);</span>
<span class="nc" id="L111"> 			sb.append(timestamp);</span>
<span class="nc" id="L112"> 			cat.debug(sb.toString());</span>
// 			System.out.println(sb.toString());
 		}
<span class="nc" id="L115">		RTAAData data = rtaaManager.getRTAAData(empIDs,</span>
												start,
												end,
												sortKey,
												true,
												pageNum * pageSize,
												pageSize,
												timestamp,
												showUnavailable);
<span class="nc" id="L124">		data.setTimestamp(ts);</span>

<span class="nc" id="L126">		updateSpecialActivityAttributes(context, data);</span>

<span class="nc bnc" id="L128" title="All 2 branches missed."> 		if (cat.isDebugEnabled()) {</span>
<span class="nc" id="L129"> 			String output = AdherenceUtils.dumpRTAAData(data);</span>
<span class="nc" id="L130"> 			cat.debug(output);</span>
 			//System.out.println(output);
 		}

<span class="nc" id="L134">		return data;</span>
	}
	
	/**
	 * For each special activity in the RTAAData parameter, we will substitute the overridden tolerance and
	 * MaxDuration attributes (if any) from the ORGANIZATIONCONFIG table. These settings are specified on
	 * the &quot;App Admin \ Activities \ Special Activities&quot; page. This code should only be called if the
	 * application is licensed for &quot;SpecialActivityOverrides&quot;. 
	 * @param context
	 * @param data
	 * @return The same RTAAData data, but with any special activity attribute overrides included in the list of activities.
	 * @throws BbmException
	 */
	private static void updateSpecialActivityAttributes(RequestContext context, RTAAData data) throws Exception 
	{
<span class="nc bnc" id="L149" title="All 2 branches missed.">		if (!CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.SPECIAL_ACTIVITY_OVERRIDES))</span>
<span class="nc" id="L150">			return;</span>
		
<span class="nc" id="L152">		ActivityManager activityManager = WfmManagerFactory.getActivityManager(context.isInWhatIfMode());</span>

		//just get the first orgID found in RTAAData because all adherence data will be for the same organization
		//branch, and it is assumed that each branch will use the same overrides for each activity type. In other
		//words, all orgs being shown at any time in Adherence will use the same special activity overrides.
<span class="nc" id="L157">		ID orgID = null;</span>
<span class="nc" id="L158">		Collection empIDs = data.getEmployeeIDs();		</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">		if (empIDs != null)</span>
		{
<span class="nc bnc" id="L161" title="All 2 branches missed.">			for (Iterator it=empIDs.iterator(); it.hasNext();)</span>
			{
<span class="nc" id="L163">				ID empID = (ID)it.next();</span>
				
				//get the employee's organization at the start of the date range getMinTime()
<span class="nc" id="L166">				Map orgMap = OrganizationModelHandler.getEmployeeOrgMap(context, Collections.singletonList(empID), data.getMinTime());</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">				if (orgMap != null)</span>
<span class="nc" id="L168">					orgID = (ID)orgMap.get(empID);</span>
				
<span class="nc bnc" id="L170" title="All 2 branches missed.">				if (orgID != null)</span>
<span class="nc" id="L171">					break;</span>
<span class="nc" id="L172">			}				</span>
		}
		
<span class="nc" id="L175">		ArrayList specialActivities = new ArrayList();</span>
		
<span class="nc" id="L177">		HashMap activitiesMap = data.getActivities();		</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">		for (Iterator it=activitiesMap.entrySet().iterator(); it.hasNext();)</span>
		{
<span class="nc" id="L180">			Entry entry = (Entry)it.next();</span>
<span class="nc" id="L181">			ID activityID = (ID)entry.getKey();</span>
			
<span class="nc bnc" id="L183" title="All 2 branches missed.">			if (SpecialActivityFormPageModel.isSpecialActivity(activityID))</span>
			{
<span class="nc" id="L185">				Activity activity = (Activity)entry.getValue();</span>
<span class="nc" id="L186">				activity = (Activity)activity.clone(); //clone it so that we don't change the values in the Activity cache</span>
<span class="nc" id="L187">				activity.setAdherenceTolerance(activityManager.getAdherenceToleranceOverride(orgID, activityID));</span>
<span class="nc" id="L188">				activity.setMaxDurationThreshold(activityManager.getMaxDurationOverride(orgID, activityID));</span>
<span class="nc" id="L189">				specialActivities.add(activity);</span>
			}
<span class="nc" id="L191">		}	</span>
		
		//update the special activities in the data
<span class="nc bnc" id="L194" title="All 2 branches missed.">		for (Iterator it=specialActivities.iterator(); it.hasNext();)</span>
		{
<span class="nc" id="L196">			Activity activity = (Activity)it.next();</span>
<span class="nc" id="L197">			activitiesMap.put(activity.getID(), activity);</span>
<span class="nc" id="L198">		}</span>
<span class="nc" id="L199">	}	</span>


	/**
	 *	Retrieves employee names from their IDs
	 *
	 *	@param empIDs  A collection of the employee IDs
	 *	@return A hashmap of empID -&gt; names
	 */
	static public HashMap getEmployeeNames(RequestContext context, Collection empIDs)	throws Exception {
<span class="nc" id="L209">		return EmployeeModelHandler.getEmployeeNamesByIDs(context, empIDs);</span>
	}

	/**
	 *	Authorizes a collection of exceptions (RTAAException objects)
	 *	
	 *	@param exceptions  The collection of exceptions to authorize
	 *
	 *	@throws Exception  If error occurs
	 */
	static public void authorizeExceptions(Collection exceptions, String comment)
		throws Exception
	{
<span class="nc bnc" id="L222" title="All 2 branches missed.">		for (Iterator iter = exceptions.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L223">			RTAAException exc = (RTAAException)iter.next();</span>
<span class="nc" id="L224">			createAdherenceOverride(exc.getEmployeeID(), </span>
<span class="nc" id="L225">									exc.getStartTime(),</span>
<span class="nc" id="L226">									exc.getEndTime(),</span>
									comment);
<span class="nc" id="L228">		}</span>
<span class="nc" id="L229">	}</span>

	/**
	 *	Un-authorizes a collection of exceptions (RTAAException objects)
	 *	
	 *	@param exceptions  The collection of exceptions to un-authorize
	 *
	 *	@throws Exception  If error occurs
	 */
	static public void unauthorizeExceptions(Collection exceptions) 
		throws Exception
	{
<span class="nc bnc" id="L241" title="All 2 branches missed.">		for (Iterator iter = exceptions.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L242">			RTAAException exc = (RTAAException)iter.next();</span>
<span class="nc" id="L243">			deleteAdherenceOverride(exc.getEmployeeID(), </span>
<span class="nc" id="L244">									exc.getStartTime(),</span>
<span class="nc" id="L245">									exc.getEndTime());</span>
<span class="nc" id="L246">		}</span>
<span class="nc" id="L247">	}</span>

	/**
	 *	For a particular employee, this method authorizes and un-authorizes a set of 
	 *	exceptions based on the time ranges.  Invoked from the 'Exception Detail'
	 *	dialog.
	 *
	 *	@param empID  The ID of the employee.
	 *	@param timeRangesToAuthorize  A collection of time ranges that specifies
	 *				  the exceptions are to be authorized.
	 *	@param timeRangesToUnauthorize	A collection of time ranges that specifies
	 *					the exceptions are to be authorized.
	 *
	 *	@throws Exception  If error occurs
	 */
	static public void massAuthorizeExceptions(ID empID, 
											   Collection timeRangesToAuthorize, 
											   Collection timeRangesToUnauthorize,
											   Collection comments)
		throws Exception
	{
<span class="nc bnc" id="L268" title="All 2 branches missed.">		if (timeRangesToAuthorize != null) {</span>
<span class="nc" id="L269">			Iterator commentsItr = comments.iterator();</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">			for (Iterator iter = timeRangesToAuthorize.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L271">				TimeRange timeRange = (TimeRange)iter.next();</span>
<span class="nc" id="L272">				createAdherenceOverride(empID, timeRange.getStartDate(), timeRange.getEndDate(), (String)commentsItr.next());</span>
<span class="nc" id="L273">			}</span>
		}

<span class="nc bnc" id="L276" title="All 2 branches missed.">		if (timeRangesToUnauthorize != null) {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">			for (Iterator iter = timeRangesToUnauthorize.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L278">				TimeRange timeRange = (TimeRange)iter.next();</span>
<span class="nc" id="L279">				deleteAdherenceOverride(empID, timeRange.getStartDate(), timeRange.getEndDate());</span>
<span class="nc" id="L280">			}</span>
		}
<span class="nc" id="L282">	}</span>

	/**
	 *	For a set of employees, this method authorizes or un-authorizes all of the
	 *	exceptions that belongs within the 'start' and the 'end' time range.
	 *	Invoked from the 'Group Exception' dialog.
	 *
	 *	@param empIDs  The collection of the employee ID's to authorize/un-authorize,
	 *     This collection is irrelevant if a given filterName is passed.
	 *	@param filterName  The name of the filter.	If non-&lt;code&gt;null&lt;/code&gt;,
	 *		   the request was passed using a user-created filter.
	 *	@param start   The start date.
	 *	@param end	   The end date.
	 *	@param authorized  &lt;code&gt;true&lt;/code&gt;  if authorizing exceptions,
	 *			   &lt;code&gt;false&lt;/code&gt; if un-authorizing exceptions.
	 *
	 *	@throws Exception  If error occurs
	 */
	static public void groupAuthorizeExceptions(RequestContext context,
												Collection empIDs, 
												String filterName,
												Date start,
												Date end,
												boolean authorized,
												String comment)
		throws Exception 
	{

<span class="nc bnc" id="L310" title="All 2 branches missed.">		if (cat.isDebugEnabled()) {</span>
<span class="nc" id="L311">			StringBuffer sb = new StringBuffer(512);</span>
<span class="nc" id="L312">			sb.append(&quot;groupAuthorizeExceptions()::parameters::start=&quot;);</span>
<span class="nc" id="L313">			sb.append(start);</span>
<span class="nc" id="L314">			sb.append(&quot;:end=&quot;);</span>
<span class="nc" id="L315">			sb.append(end);</span>
<span class="nc" id="L316">			sb.append(&quot;:filterName=&quot;);</span>
<span class="nc" id="L317">			sb.append(filterName);</span>
<span class="nc" id="L318">			sb.append(&quot;:authorized=&quot;);</span>
<span class="nc" id="L319">			sb.append(authorized);</span>
<span class="nc" id="L320">			cat.debug(sb.toString());</span>
			//System.out.println(sb.toString());
		}

<span class="nc" id="L324">		User user = context.getUser();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">		if (filterName != null) {</span>
<span class="nc" id="L326">			EmployeeFilter eFilter = EmployeeModelHandler.getEmployeeFilter(context);</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">			if (EmployeeModelHandler.isAllFilter(filterName)) {</span>
<span class="nc" id="L328">				Filter allFilter = EmployeeModelHandler.createAllFilter(user.getID(), filterName);</span>
<span class="nc" id="L329">				empIDs = eFilter.getEmployeeIDs(allFilter, user, Collections.emptyList(), true, 0, Integer.MAX_VALUE);</span>
<span class="nc" id="L330">			} else {</span>
<span class="nc" id="L331">				empIDs = eFilter.getEmployeeIDs(user.getID(), filterName, Collections.emptyList(), true, 0, Integer.MAX_VALUE);</span>
			}
		}

		// filter out the employees that user does not have exception mgmt privilege.
<span class="nc" id="L336">		Collection nonPrivIDs = getNonAuthEmployees(context, user, empIDs, start, end);</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">		for (Iterator nonPrivIter = nonPrivIDs.iterator(); nonPrivIter.hasNext();) {</span>
<span class="nc" id="L338">			ID id = (ID)nonPrivIter.next();</span>
<span class="nc" id="L339">			empIDs.remove(id);</span>
<span class="nc" id="L340">		}</span>

<span class="nc bnc" id="L342" title="All 2 branches missed.">		if (authorized) {</span>
<span class="nc" id="L343">			createAdherenceOverride(empIDs, start, end, comment);</span>
		} else {
<span class="nc" id="L345">			deleteAdherenceOverride(empIDs, start, end);</span>
		}
<span class="nc" id="L347">	}</span>

	/**
	 *	Retrieves the list of user-defined filters.	 In addition, the currently
	 *	selected filter (in this user's session) will have its name surrounded by
	 *	AdherenceKeys.CUR_SELECT_EMPFILTER_DELIMITER.  This way, when the client
	 *	receives this list, it would also know which filter is currently selected.
	 *
	 *	@param userID  The ID of the user.
	 */
	static public Collection getUserFilterNames(RequestContext context, ID userID) 
		throws Exception
	{
<span class="nc bnc" id="L360" title="All 2 branches missed.">		if (userID == null) {</span>
<span class="nc" id="L361">			return Collections.emptyList();</span>
		}

<span class="nc" id="L364">		String curFilter = context.getUserProperty(UserPreferenceKeys.EMP_FILTER);</span>

		// 2nd chance
<span class="nc bnc" id="L367" title="All 4 branches missed.">		if (curFilter == null || &quot;&quot;.equals(curFilter)) </span>
<span class="nc" id="L368">			curFilter = context.getUserProperty(UserPreferenceKeys.USER_DEFAULT_FILTER);</span>

<span class="nc" id="L370">		EmployeeFilter eFilter = EmployeeModelHandler.getEmployeeFilter(context);</span>
<span class="nc" id="L371">		Collection filters = eFilter.getFiltersByUserID(userID);</span>
<span class="nc" id="L372">		int len = filters.size();</span>

<span class="nc bnc" id="L374" title="All 2 branches missed.">		if (len == 0) {</span>
<span class="nc" id="L375">			return Collections.emptyList();</span>
		} else {
<span class="nc" id="L377">			ArrayList filterNames = new ArrayList(len);</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">			for (Iterator iter = filters.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L379">				Filter f = (Filter)iter.next();</span>

<span class="nc" id="L381">				String filterName = f.getFilterName();</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">				if (filterName.equals(curFilter)) {</span>
<span class="nc" id="L383">					filterName = AdherenceKeys.CUR_SELECT_EMPFILTER_DELIMITER +</span>
						filterName + 
						AdherenceKeys.CUR_SELECT_EMPFILTER_DELIMITER;
				}
<span class="nc" id="L387">				filterNames.add(filterName);</span>
<span class="nc" id="L388">			}</span>
<span class="nc" id="L389">			return filterNames;</span>
		}
	}
	
	/**
	 *	Retrieves the activity mappings for a set of activities
	 *
	 *	@param activityIDs	A collection of activity IDs
	 *
	 *	@return An array of String objects.
	 *
	 * @throws Exception if there is an error while executing database query
	 */
	static public String[] getActivityMappings(RequestContext context, Collection activityIDs)
		throws Exception
	{
<span class="nc" id="L405">		AdherenceMapping[] mappings = </span>
<span class="nc" id="L406">			AdherenceMappingModelHandler.getAdherenceMappings(context, activityIDs);</span>

<span class="nc bnc" id="L408" title="All 4 branches missed.">		if (mappings == null || mappings.length == 0) {</span>
<span class="nc" id="L409">			return new String[0];</span>
		}
			
<span class="nc" id="L412">		String[] mappingStr = new String[mappings.length];</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">		for (int i = 0; i &lt; mappingStr.length; i++) {</span>
<span class="nc" id="L414">			mappingStr[i] = convertEmptyStringToDashes(mappings[i].getMappedActivitiesString());</span>
		}

<span class="nc" id="L417">		return mappingStr;</span>
	}
	
	/**
	 *	Retrieves the activity mappings for a set of activities that the user has org scope for
	 *
	 *	@param activityIDs	A collection of activity IDs
	 *
	 *  @param scopedOrgIDs A collection of scoped organization IDs
	 *
	 *	@return An array of String objects.
	 *
	 * @throws Exception if there is an error while executing database query
	 */
	static public String[] getActivityMappings(RequestContext context, Collection activityIDs, Collection scopedOrgIDs)
		throws Exception
	{
<span class="nc" id="L434">		AdherenceMapping[] mappings = </span>
<span class="nc" id="L435">			AdherenceMappingModelHandler.getAdherenceMappings(context, activityIDs);</span>

<span class="nc bnc" id="L437" title="All 4 branches missed.">		if (mappings == null || mappings.length == 0) {</span>
<span class="nc" id="L438">			return new String[0];</span>
		}
			
<span class="nc" id="L441">		String[] mappingStr = new String[mappings.length];</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">		for (int i = 0; i &lt; mappingStr.length; i++) {</span>
<span class="nc" id="L443">			mappingStr[i] = convertEmptyStringToDashes(mappings[i].getMappedActivitiesString(scopedOrgIDs));</span>
		}

<span class="nc" id="L446">		return mappingStr;</span>
	}

	// ------------------------------------------------
	// private methods -- common utility methods
	// ------------------------------------------------

	/**
	 * creates an adherance override for given employee for the given time window.
	 *	 An adherance override causes any adherance exceptions that overlap
	 *	 the time window to be marked as approved.
	 * @param empID
	 * @param start - start of window
	 * @param end - end of window
	 *
	 * @throws Exception if there is an error while executing database query
	 */
	static private void createAdherenceOverride(ID empID, Date start, Date end, String comment)
		throws Exception
	{
<span class="nc" id="L466">		RTAAService rtaaService = BbmManagerFactory.getRTAAService();</span>
		//System.out.println(&quot;Authorizing:&quot; + empID + &quot;:&quot; + start + &quot;:&quot; + end);
<span class="nc" id="L468">		rtaaService.createAdheranceOverride(empID, start, end, comment);</span>
<span class="nc" id="L469">	}</span>


	/**
	 * removes the adherance override for given employee for the given time window.
	 *	 An adherance override does not have to exist for given time window.
	 * @param empID
	 * @param start - start of window
	 * @param end - end of window
	 *
	 * @throws Exception if there is an error while executing database query
	 */
	static private void deleteAdherenceOverride(ID empID, Date start, Date end)
		throws Exception
	{
<span class="nc" id="L484">		RTAAService rtaaService = BbmManagerFactory.getRTAAService();</span>
		//System.out.println(&quot;Un-authorizing:&quot; + empID + &quot;:&quot; + start + &quot;:&quot; + end);
<span class="nc" id="L486">		rtaaService.deleteAdheranceOverride(empID, start, end);</span>
<span class="nc" id="L487">	}</span>

	/**
	 * Mass approve adherence exceptions
	 *
	 * @param empIDs  A Collection of Employee IDs whose exceptions are to be approved.
	 * @param start The start date/time for the approvals.
	 * @param end	The end date/time for the approvals.
	 *
	 * @throws Exception
	 */
	static private void createAdherenceOverride(Collection empIDs, Date start, Date end, String comment)
		throws Exception 
	{
<span class="nc" id="L501">		RTAAService rtaaService = BbmManagerFactory.getRTAAService();</span>
<span class="nc" id="L502">		rtaaService.createAdheranceOverride(empIDs, start, end, comment);</span>
<span class="nc" id="L503">	}</span>

	/**
	 * Mass unapprove adherence exceptions
	 *
	 * @param empIDs  A Collection of Employee IDs whose exceptions are to be unapproved.
	 * @param start The start date/time for the unapprovals.
	 * @param end	The end date/time for the unapprovals.
	 *
	 * @throws Exception
	 */
	static private void deleteAdherenceOverride(Collection empIDs, Date start, Date end)
		throws Exception 
	{
<span class="nc" id="L517">		RTAAService rtaaService = BbmManagerFactory.getRTAAService();</span>
<span class="nc" id="L518">		rtaaService.deleteAdheranceOverride(empIDs, start, end);</span>
<span class="nc" id="L519">	}</span>

	/**
	 *	Basically filters out the employee IDs that the user doesn't have viewing privilege.
	 *
	 *	@param user	 The user in the current context.
	 *	@param empIDs  The list of employee IDs
	 *	@param start  The start date.
	 *	@param end	The end date.
	 *
	 *	@return	 The filetered collection of employee IDs.
	 */
	static Collection getViewableEmployees(RequestContext context, User user, Collection empIDs, Date start, Date end)
		throws Exception 
	{
<span class="nc" id="L534">		int[] authToView =	getAdherenceAuthCodes(context, user, PrivilegeKeys.AM_VIEWADHERENCE, empIDs, start, end);</span>
<span class="nc" id="L535">		Collection ids = new ArrayList(empIDs.size());</span>

		// only add the ID into the return list if we have privilege to view that employee.
<span class="nc" id="L538">		Iterator empIter = empIDs.iterator();</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">		for (int i=0; i&lt;authToView.length; i++) {</span>
<span class="nc" id="L540">			ID id = (ID)empIter.next();</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">			if (authToView[i] == AccessRightHelper.EMP_IS_AUTHORIZED) {</span>
<span class="nc" id="L542">				ids.add(id);</span>
			}
		}
<span class="nc" id="L545">		return ids;</span>
	}

	/**
	 *	Retrieves the privileges for performing adherence exception management for each 
	 *	of the employees.
	 *
	 *	@param user	 The user in the current context.
	 *	@param empIDs  The list of employee IDs
	 *	@param start  The start date.
	 *	@param end	The end date.
	 *
	 *	@return	 A Collection of Boolean objects, each indicating whether the employee is 
	 *		 can be (un)authorized by the current user.
	 */
	static Collection getAuthPrivs(RequestContext context, User user, Collection empIDs, Date start, Date end)
		throws Exception 
	{
<span class="nc" id="L563">		int[] auths = getAdherenceAuthCodes(context, user, PrivilegeKeys.AM_AUTHORIZATIONOFALERTS, empIDs, start, end);</span>

<span class="nc bnc" id="L565" title="All 2 branches missed.">		if (empIDs.size() == 0)</span>
<span class="nc" id="L566">			return Collections.emptyList();</span>

<span class="nc" id="L568">		Collection privs = new ArrayList(empIDs.size());</span>

<span class="nc bnc" id="L570" title="All 2 branches missed.">		for (int i=0; i&lt;auths.length; i++) {</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">			if (auths[i] == AccessRightHelper.EMP_IS_AUTHORIZED) {</span>
<span class="nc" id="L572">				privs.add(Boolean.TRUE);</span>
			} else {
<span class="nc" id="L574">				privs.add(Boolean.FALSE);</span>
			}
		}

<span class="nc" id="L578">		return privs;</span>
	}
	
	/**
	 *	Retrieves the privileges for performing balance realted functions (Playback, Monitor Record).
	 *
	 *	@param user	 The user in the current context.
	 *	@param empIDs  The list of employee IDs
	 *	@param start  The start date.
	 *	@param end	The end date.
	 *  @param qmAgents - a collection of the employeeIDs that are linked to a Quality (QM78) Data Source.
	 *
	 *	@return	 A HashMap of [employeeID, privilege array].
	 */
	public static HashMap getInteractionPrivs(RequestContext context, User user, Collection empIDs, Date start, Date end,
			Collection qmAgents)
		throws Exception 
	{
		//get employee effectivity to not display icons
<span class="nc" id="L597">		HashMap activeEmpMap = getValidEmployeeMap(context, empIDs);</span>
	
		//privilege need to be checked for current date for monitor and record
<span class="nc" id="L600">		int[] monitorAuths = getAdherenceAuthCodes(context, user, PrivilegeKeys.AM_MONITORAGENTINTERACTIONS, empIDs, new Date(), new Date());</span>
<span class="nc" id="L601">		int[] recordAuths = getAdherenceAuthCodes(context, user, PrivilegeKeys.AM_RECORDAGENTINTERACTIONS, empIDs, new Date(), new Date());		</span>
<span class="nc" id="L602">		int[] viewAuths = getAdherenceAuthCodes(context, user, PrivilegeKeys.AM_VIEWAGENTINTERACTIONS, empIDs, start, end);</span>
		
<span class="nc" id="L604">		HashMap privMap = new HashMap(empIDs.size());</span>
<span class="nc" id="L605">		int i=0;</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">		for (Iterator it=empIDs.iterator(); it.hasNext();) </span>
		{
<span class="nc" id="L608">			ID agentID = (ID) it.next();</span>
<span class="nc" id="L609">			boolean[] privs = new boolean[]{false, false, false};</span>
	
			//Check if the user can playback interactions for this agent
<span class="nc bnc" id="L612" title="All 2 branches missed.">			if (viewAuths[i] == AccessRightHelper.EMP_IS_AUTHORIZED) {</span>
<span class="nc" id="L613">				privs[0] = true;</span>
			} else {
<span class="nc" id="L615">				privs[0] = false;</span>
			}
			
			//For Monitor and Record: If site is licensed for both QM78 and QM11, then Record and Monitor
			//will only be enabled if the agent is linked to a Quality Data Source (QM78). Note: The default
			//is true because we still check the monitor/record privilges, which require the QM78 license.
<span class="nc bnc" id="L621" title="All 2 branches missed.">			boolean canMonitorAndRecord = hasBalanceAndUltraLicences() ? (qmAgents.contains(agentID)) : true;</span>
			
			//Check if the user can monitor interactions for this agent
<span class="nc bnc" id="L624" title="All 4 branches missed.">			if (((Boolean)activeEmpMap.get(agentID)).booleanValue() &amp;&amp; monitorAuths[i] == AccessRightHelper.EMP_IS_AUTHORIZED) {</span>
<span class="nc" id="L625">				privs[1] = canMonitorAndRecord;</span>
			} else {
<span class="nc" id="L627">				privs[1] = false;</span>
			}
			
			//Check if the user can record interactions for this agent
<span class="nc bnc" id="L631" title="All 4 branches missed.">			if (((Boolean)activeEmpMap.get(agentID)).booleanValue() &amp;&amp; recordAuths[i] == AccessRightHelper.EMP_IS_AUTHORIZED) {</span>
<span class="nc" id="L632">				privs[2] = canMonitorAndRecord;</span>
			} else {
<span class="nc" id="L634">				privs[2] = false;</span>
			}
			
<span class="nc" id="L637">			privMap.put(agentID, privs);</span>
<span class="nc" id="L638">			i++;</span>
<span class="nc" id="L639">		}</span>

<span class="nc" id="L641">		return privMap;</span>
	}
	
	private static HashMap getValidEmployeeMap(RequestContext context, Collection empIDs) throws Exception{
<span class="nc" id="L645">		HashMap map = new HashMap();</span>
<span class="nc" id="L646">		Collection employeeColl = EmployeeModelHandler.getEmployeesByIDs(context, empIDs);</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">		for (Iterator it = employeeColl.iterator(); it.hasNext();){</span>
<span class="nc" id="L648">			Employee emp = (Employee) it.next();</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">			map.put(emp.getID(), new Boolean(emp.getEndTime() == null ||</span>
<span class="nc bnc" id="L650" title="All 4 branches missed.">					(emp.getEndTime()!= null &amp;&amp; emp.getEndTime().after(new Date()))));</span>
<span class="nc" id="L651">		}</span>
<span class="nc" id="L652">		return map;</span>
	}
	
    /**
     * Tells us whether or not the application is licensed for both BALANCE (QM78) and ULTRA (QM10 or QM11). 
     * @return true if BALANCE (QM78) and ULTRA (QM10 or QM11) licenses is present, false if not.
     */
    public static boolean hasBalanceAndUltraLicences() throws Exception
    {
<span class="nc bnc" id="L661" title="All 2 branches missed.">        return CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_QM)</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">        		&amp;&amp; CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_ULTRA_V11);</span>
    }
    
    /**
     * Return a collection of the employeeIDs that are linked to a Quality (QM78) Data Source.
     * @param empIDs - employeeIDs of the agents that you are interested in.
     * @return a subset of empIDs.
     */
    public static Collection getAgentsWithQMDataSource(Collection empIDs) throws Exception
    {
    	//First get all of the QM78 data sources.
<span class="nc" id="L673">		Collection qmDataSources = new ArrayList();</span>
<span class="nc" id="L674">		DataSourceManager dsMgr = BbmManagerFactory.getDataSourceManager();</span>
<span class="nc" id="L675">		qmDataSources = dsMgr.getDataSourcesByType(DataSourceType.ID_BALANCE);</span>
		
		//extract the data source IDs
<span class="nc" id="L678">		Collection dsIDs = new ArrayList(qmDataSources.size());</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">		for (Iterator it=qmDataSources.iterator(); it.hasNext();)</span>
		{
<span class="nc" id="L681">			DataSource ds = (DataSource)it.next();</span>
<span class="nc" id="L682">			dsIDs.add(ds.getID());</span>
<span class="nc" id="L683">		}</span>
		
		//Now get all of the employees from empIDs that are linked to those data sources.
<span class="nc" id="L686">		WorkResourceManager workResourceManager = BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L687">		Collection empDataSources = workResourceManager.getEmployeesDataSources(empIDs, dsIDs);</span>
		 		
		//Finally, extract the agent IDs from the empDataSources
<span class="nc" id="L690">    	HashSet qmAgents = new HashSet();</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">		for (Iterator it=empDataSources.iterator(); it.hasNext();)</span>
		{
<span class="nc" id="L693">			EmployeeDataSource eds = (EmployeeDataSource)it.next();</span>
<span class="nc" id="L694">			qmAgents.add(eds.getEmployeeID());</span>
<span class="nc" id="L695">		}</span>
		
<span class="nc" id="L697">    	return qmAgents;</span>
    }
	
	
	/**
	 *	Retrieves a collection of employees whom user cannot perform adherence exception management.
	 *
	 *	@param user	 The user in the current context.
	 *	@param empIDs  The list of employee IDs
	 *	@param start  The start date.
	 *	@param end	The end date.
	 *
	 *	@return	 A Collection of employee IDs.
	 */
	static private Collection getNonAuthEmployees(RequestContext context, User user, Collection empIDs, Date start, Date end)
		throws Exception 
	{
<span class="nc" id="L714">		int[] auths = getAdherenceAuthCodes(context, user, PrivilegeKeys.AM_AUTHORIZATIONOFALERTS, empIDs, start, end);</span>

<span class="nc bnc" id="L716" title="All 2 branches missed.">		if (empIDs.size() == 0)</span>
<span class="nc" id="L717">			return Collections.emptyList();</span>

<span class="nc" id="L719">		Collection nonPrivIDs = new ArrayList(empIDs.size());</span>

<span class="nc" id="L721">		Iterator empIter = empIDs.iterator();</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">		for (int i=0; i&lt;auths.length; i++) {</span>
<span class="nc" id="L723">			ID id = (ID)empIter.next();</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">			if (auths[i] != AccessRightHelper.EMP_IS_AUTHORIZED) {</span>
<span class="nc" id="L725">				nonPrivIDs.add(id);</span>
			}
		}

<span class="nc" id="L729">		return nonPrivIDs;</span>
	}

	private static int[] getAdherenceAuthCodes(RequestContext context, User user, String privName, Collection empIDs, Date start, Date end)
		throws Exception 
	{
<span class="nc" id="L735">		return AccessRightHelper.getAuthorizationCode(context, user, privName, empIDs, start, end);</span>
	}

	private static String convertEmptyStringToDashes(String str) {
<span class="nc bnc" id="L739" title="All 2 branches missed.">		if(StringUtil.isEmpty(str)) {</span>
<span class="nc" id="L740">			return EMPTY_MAPPED_ACTIVITIES_STRING;</span>
		}
		else {
<span class="nc" id="L743">			return str;</span>
		}
	}
	
	/**
	 *	Starts recording for the given employee
	 *	
	 *	@param employeeID
	 *	@param userID
	 *
	 *	@throws Exception  If error occurs
	 */
	static public void startRecording(ID employeeID, ID userID)
		throws Exception
	{
		
<span class="nc" id="L759">		EJBManagerFactory.getInstance().getBalanceManager().startRecording(employeeID, userID);</span>
<span class="nc" id="L760">	}</span>
	
	/**
	 *	Stops recording for the given employee
	 *	
	 *	@param employeeID
	 *	@param userID
	 *
	 *	@throws Exception  If error occurs
	 */
	static public void stopRecording(ID employeeID, ID userID)
		throws Exception
	{
<span class="nc" id="L773">		EJBManagerFactory.getInstance().getBalanceManager().stopRecording(employeeID, userID);</span>
<span class="nc" id="L774">	}</span>
	
	/**
	 *	Gets the playback url for the given interaction
	 *	
	 *	@param interaction
	 *
	 *	@throws Exception  If error occurs
	 */
	static public String getPlaybackURL(Interaction interaction)
		throws Exception {
	    //this needs to be changed.. we should look for emp ID and not Balance ID - but the emp ID is in the blance id
<span class="nc" id="L786">		String url = AdherenceHelper.getQMManager().getPlaybackURL(interaction);</span>
		//if (url!= null &amp;&amp; url.length()&gt;0)
		//	url = HtmlUtil.encode(url, &quot;UTF-8&quot;); //QC#86873: Adherence Playback for QM 7.8 is not going to the proper page.
		
<span class="nc" id="L790">		return url;</span>
	}
	
	/**
	 *	Stops recording for the given employee
	 *	
	 *	@param employeeID
	 *
	 *	@throws Exception  If error occurs
	 */
	static public String getLiveMonitorURL(ID employeeID)
		throws Exception
	{
<span class="nc" id="L803">		return EJBManagerFactory.getInstance().getBalanceManager().getLiveMonitorURL(employeeID);</span>
	}
	
	/**
	 *	Get collection of employeeids being recorded by user
	 *	
	 *	@param userID
	 *
	 *	@throws Exception  If error occurs
	 */
	static public Collection getEmployeesBeingRecordedByUser(ID userID)
		throws Exception
	{
<span class="nc" id="L816">		Collection empIDS = new ArrayList();</span>
		
<span class="nc" id="L818">		Collection interactionsColl = EJBManagerFactory.getInstance().getBalanceManager().getBalanceUserRecording(userID);</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">		if (interactionsColl!=null){</span>
<span class="nc" id="L820">			Iterator it = interactionsColl.iterator();</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">			while (it.hasNext()){</span>
<span class="nc" id="L822">				BalanceUserRecording interaction = (BalanceUserRecording) it.next();</span>
<span class="nc" id="L823">				empIDS.add(interaction.getEmployeeID());</span>
<span class="nc" id="L824">			}</span>
		}
<span class="nc" id="L826">		return empIDS;</span>
	}
	
	/**
	 *	Get HashMap of empid, monitor url
	 *	
	 *	@param Collection empIds
	 *
	 *	@throws Exception  If error occurs
	 */
	/* add for 7.9
	static public HashMap getMonitorUrls(Collection empIds)
		throws Exception
	{
		HashMap urlMap = new HashMap(empIds.size());
			for (Iterator it= empIds.iterator(); it.hasNext();){
				ID empID = (ID)it.next();
				try {
					urlMap.put(empID, EJBManagerFactory.getInstance().getBalanceManager().getLiveMonitorURL(empID));
				} catch (Exception ex){
					urlMap.put(empID, ex.getLocalizedMessage());
				}
			}
		//TODO replace with API from Uri
		//Collection interactionsColl = EJBManagerFactory.getInstance().getBalanceManager().getBalanceUserRecording(userID);
		return urlMap;
	}
	*/

	/**
	 *	Retrieves a collection of interactions for the specified agent for the given time period.
	 *
	 *	@param start  The start date.
	 *	@param end	The end date.
	 *
	 *	@return	 A Collection of employee IDs.
	 */
	static public HashMap getInteractionsData(RequestContext context, ArrayList empIDs, Date start, Date end)
		throws Exception {
<span class="nc" id="L865">		HashMap map = new HashMap(empIDs.size());</span>
<span class="nc" id="L866">		ID userID = context.getUser().getEmployeeID();</span>
		//splitting the empIDs into two backets 
<span class="nc bnc" id="L868" title="All 2 branches missed.">		for (Iterator iter = empIDs.iterator();iter.hasNext();) {</span>
<span class="nc" id="L869">			ID empID = (ID)iter.next();</span>
			
<span class="nc" id="L871">			map.put(empID, </span>
<span class="nc" id="L872">					convertInteractionCollToACColl(AdherenceHelper.getQMManager().getInteractionsForEmployee(userID,empID, start,end),</span>
							empID));
<span class="nc" id="L874">		} </span>
		
/*	else {
			//convert object to UI specific AgentConatct object
			HashMap interactionMap = AdherenceHelper.getQMManager(userID).getInteractionsForEmployees(userID,empIDs, start,end); 
			//			 Iterate over the keys in the map
		    Iterator it = interactionMap.keySet().iterator();
		    while (it.hasNext()) {
		        // Get key
		        ID id = (ID)it.next();
		 
		        //now get the collection
		        Collection interactionColl = (Collection)interactionMap.get(id);
		        if (interactionColl != null){
		        	map.put(id, convertInteractionCollToACColl(interactionColl, id));
		        }
		    }
		}
*/
<span class="nc" id="L893">		return map;</span>
	}

	static private Collection convertInteractionCollToACColl(Collection interactionColl, ID empID){
<span class="nc" id="L897">		ArrayList aList = new ArrayList(interactionColl.size());</span>
<span class="nc" id="L898">		Iterator it = interactionColl.iterator();</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">		while (it.hasNext()){</span>
<span class="nc" id="L900">			Interaction inter = (Interaction)it.next();</span>
<span class="nc" id="L901">			AgentContact contact = new AgentContact(inter);</span>
<span class="nc" id="L902">			contact.setBalanceAgentID(empID.toString());</span>
<span class="nc" id="L903">			aList.add(contact);</span>
<span class="nc" id="L904">		}</span>
<span class="nc" id="L905">		return aList;</span>
	}
	
	/**
	 *	Retrieves the time tracking events for employees
	 *
	 *	@param user	 The user in the current context.
	 *	@param empIDs  The list of employee IDs
	 *	@param start  The start date.
	 *	@param end	The end date.
	 *
	 *	@return	 A HashMap of [employeeID, TimeTrackingEvent collection].
	 */
	public static HashMap getTimeTrackingEvents(Collection empIDs, Date start, Date end, TimeZone viewingTZ)
		throws Exception 
	{
<span class="nc" id="L921">		HashMap eventMap = new HashMap();</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">		if (start.after(end)){</span>
<span class="nc" id="L923">			return eventMap;</span>
		} else {

<span class="nc" id="L926">			eventMap = (HashMap)BbmManagerFactory.getTimeTrackingManager().getEventsForWorkResource(empIDs, start, end);</span>
		}
		
		//iterate through map and set null end time to current date,
		//truncate longer events for the selected time frame
<span class="nc" id="L931">		Collection mapValues = (Collection)eventMap.values();</span>
		
<span class="nc bnc" id="L933" title="All 2 branches missed.">		for (Iterator it = mapValues.iterator(); it.hasNext();){</span>
<span class="nc" id="L934">			ArrayList eventList = (ArrayList)it.next();</span>
<span class="nc" id="L935">			Iterator lstIter = eventList.iterator();</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">			while( lstIter.hasNext() )</span>
			{
<span class="nc" id="L938">				TimeTrackingEvent event = (TimeTrackingEvent)lstIter.next();</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">				if (event.getEndTime() == null)</span>
<span class="nc" id="L940">					event.setEndTime(new Date());</span>
		
<span class="nc bnc" id="L942" title="All 2 branches missed.">				if (event.getStartTime().before(start))</span>
				{
<span class="nc bnc" id="L944" title="All 2 branches missed.">					if( event.getEndTime().before(start) )</span>
					{
<span class="nc" id="L946">						lstIter.remove(); // this event does not fit in the time range</span>
<span class="nc" id="L947">						continue;</span>
					}
					
<span class="nc" id="L950">					event.setStartTime(start);</span>
				}
				
<span class="nc bnc" id="L953" title="All 2 branches missed.">				if (event.getEndTime().after(end))</span>
				{
<span class="nc bnc" id="L955" title="All 2 branches missed.">					if( event.getStartTime().after(end) )</span>
					{
<span class="nc" id="L957">						lstIter.remove(); // this event does not fit in the time range</span>
<span class="nc" id="L958">						continue;</span>
					}

<span class="nc" id="L961">					event.setEndTime(end);</span>
				}
				
				//When selecting all users in adherence for the current day it displays fine, but when changing to the previous day, the agents adherence does not update. - ESR#4076448
<span class="nc bnc" id="L965" title="All 2 branches missed.">				if (!(event.getEndTime().after(event.getStartTime()))) {</span>
<span class="nc" id="L966">					lstIter.remove(); //end before after. not a right time range. it could be happening because of line 843.</span>
				}
<span class="nc" id="L968">			}</span>
<span class="nc" id="L969">		}</span>
<span class="nc" id="L970">		return eventMap;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>