<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StaffingCalculator.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.facade.staffing.util</a> &gt; <span class="el_source">StaffingCalculator.java</span></div><h1>StaffingCalculator.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.facade.staffing.util;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.TreeSet;

import com.bluepumpkin.bpxCommon.common.Base.StopWatch;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.audit.ejb.EventAuditTrailManager;
import com.bluepumpkin.ejb.bbm.audit.model.AuditTrailEntry;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.FacadeException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignWorkResource;
import com.bluepumpkin.ejb.bbm.datasourcegroup.ejb.GroupManager;
import com.bluepumpkin.ejb.bbm.datasourcegroup.model.Group;
import com.bluepumpkin.ejb.bbm.people.ejb.PeopleFacade;
import com.bluepumpkin.ejb.bbm.queuegroup.ejb.QueueGroupManager;
import com.bluepumpkin.ejb.bbm.skill.ejb.SkillManager;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.timerecord.ejb.TimeRecordManager;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecord;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecordEntry;
import com.bluepumpkin.ejb.bbm.timeseries.ejb.TimeSeriesManager;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.QueueSkill;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.facade.FacadeManagerFactory;
import com.verint.ejb.wfm.WfmManagerFactory;

public class StaffingCalculator {
	public static final int DEFAULT_INTERVAL = 15; // 15min
	public static final long DEFAULT_INTERVAL_MILLIS = 900000L; // 15min
<span class="nc" id="L57">	private static String ejbTrace = &quot;_EJB_&quot;;</span>

	private Category cat;
	private StopWatch stw;
<span class="nc" id="L61">	private EventAuditTrailManager m_auditmgr = null;</span>
	private StaffingInfo m_info;

<span class="nc" id="L64">	public StaffingCalculator(Category category) {</span>
<span class="nc" id="L65">		this.cat = category;</span>
<span class="nc" id="L66">		this.stw = new StopWatch(category);</span>
<span class="nc" id="L67">	}</span>

	public void shutdown() {
		try {
<span class="nc bnc" id="L71" title="All 2 branches missed.">			if (m_auditmgr != null)</span>
<span class="nc" id="L72">				m_auditmgr.remove();</span>
<span class="nc" id="L73">		} catch (Exception ex) {</span>
<span class="nc" id="L74">		}</span>

<span class="nc bnc" id="L76" title="All 2 branches missed.">		if (m_info != null)</span>
<span class="nc" id="L77">			m_info.shutdown();</span>
<span class="nc" id="L78">	}</span>

	public void calculateStaffing(Collection dsColl, Date startDate, Date endDate, long lookBackDays, long empChunkSize)
			throws FacadeException, RemoteException {
<span class="nc" id="L82">		this.calculateStaffing(dsColl, startDate, endDate, startDate, lookBackDays, empChunkSize);</span>
<span class="nc" id="L83">	}</span>

	public void calculateStaffing(Collection dsColl, Date startDate, Date endDate, Date lastQueryDate,
			long lookBackDays, long empChunkSize) throws FacadeException, RemoteException {
<span class="nc" id="L87">		this.calculateStaffing(dsColl, startDate, endDate, lastQueryDate, lookBackDays, empChunkSize, false);</span>
<span class="nc" id="L88">	}</span>

	public void calculateStaffing(Collection dsColl, Date startDate, Date endDate, Date lastQueryDate,
			long lookBackDays, long empChunkSize, boolean enableProfiling) throws FacadeException, RemoteException {
<span class="nc" id="L92">		this.calculateStaffing(dsColl, startDate, endDate, lastQueryDate, lookBackDays, empChunkSize, enableProfiling,</span>
				false);
<span class="nc" id="L94">	}</span>

	public void calculateStaffing(Collection dsColl, Date startDate, Date endDate, Date lastQueryDate,
			long lookBackDays, long empChunkSize, boolean enableProfiling, boolean computeActual)
			throws FacadeException, RemoteException

	{
<span class="nc" id="L101">		this.stw.setIsEnabled(enableProfiling);</span>

<span class="nc" id="L103">		this.stw.start(&quot;Begin staffing calculator&quot;);</span>

		try {
<span class="nc" id="L106">			m_auditmgr = BbmManagerFactory.getEventAuditTrailManager();</span>
<span class="nc" id="L107">		} catch (Exception ex) {</span>
<span class="nc" id="L108">			this.cat.l7dError(ex.getMessage(), ex);</span>
<span class="nc" id="L109">			return;</span>
<span class="nc" id="L110">		}</span>

<span class="nc" id="L112">		this.m_info = new StaffingInfo(this.cat, this.stw);</span>

		// if we missed intervals the last query will be before the start
		// so we shift the start date, this will cover the missed intervals
<span class="nc bnc" id="L116" title="All 6 branches missed.">		if (lastQueryDate != null &amp;&amp; lastQueryDate.before(startDate) &amp;&amp; lookBackDays &gt; 0)</span>
<span class="nc" id="L117">			m_info.startDate = lastQueryDate;</span>
		else
<span class="nc" id="L119">			m_info.startDate = startDate;</span>
<span class="nc" id="L120">		m_info.endDate = endDate;</span>
<span class="nc" id="L121">		m_info.lastQueryDate = lastQueryDate;</span>
<span class="nc" id="L122">		m_info.lookBackDays = lookBackDays;</span>
<span class="nc" id="L123">		m_info.empChunkSize = empChunkSize;</span>
<span class="nc" id="L124">		m_info.computeActual = computeActual;</span>

		try {
			// Get all employee ID's
<span class="nc" id="L128">			Collection empColl = getEmployeeIDs(m_info.endDate);</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">			if (empColl == null || empColl.size() &lt;= 0) {</span>
<span class="nc" id="L130">				this.stw.logDebug(&quot;calculateStaffing(): No employees found&quot;);</span>
<span class="nc" id="L131">				return;</span>
			}

			// Get queues assigned to the datasources
<span class="nc" id="L135">			Collection dsqColl = m_info.getDatasource2Queues(dsColl);</span>
<span class="nc bnc" id="L136" title="All 4 branches missed.">			if (dsqColl == null || dsqColl.size() == 0) {</span>
<span class="nc" id="L137">				this.stw.logDebug(&quot;calculateStaffing(): No queues mapped for datasources&quot;);</span>
<span class="nc" id="L138">				return;</span>
			}

<span class="nc" id="L141">			m_info.allEmpColl = empColl;</span>
<span class="nc" id="L142">			m_info.dsColl = dsColl;</span>
<span class="nc" id="L143">			m_info.dsqColl = dsqColl;</span>

			// Collection of changed intervals
<span class="nc" id="L146">			Collection intvlColl = getIntervalsToProcess(m_info);</span>

<span class="nc" id="L148">			Iterator iter = intvlColl.iterator();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L150">				TimeRange tr = (TimeRange) iter.next();</span>
<span class="nc" id="L151">				m_info.startDate = tr.getStartDate();</span>
<span class="nc" id="L152">				m_info.endDate = tr.getEndDate();</span>

<span class="nc" id="L154">				calculateStaffing(m_info);</span>
<span class="nc" id="L155">			}</span>
<span class="nc" id="L156">		} catch (Exception ex) {</span>
<span class="nc" id="L157">			throw new FacadeException(ex);</span>
		}

		finally {
<span class="nc" id="L161">			this.stw.stop();</span>
<span class="nc" id="L162">			this.stw.logObjectDuration();</span>
<span class="nc" id="L163">		}</span>
<span class="nc" id="L164">	}</span>

	private Collection getIntervalsToProcess(StaffingInfo info) throws RemoteException, BbmFinderException,
			BbmEJBCreateException {
<span class="nc" id="L168">		this.stw.start(&quot;getIntervalsToProcess&quot;);</span>

		try {

			// contains a list of timerange objects
<span class="nc" id="L173">			ArrayList retVal = new ArrayList();</span>
			// add the requested start/end dates
<span class="nc" id="L175">			retVal.add(new TimeRange(info.startDate, info.endDate));</span>

<span class="nc bnc" id="L177" title="All 2 branches missed.">			if (info.lookBackDays &lt;= 0) {</span>
<span class="nc" id="L178">				return retVal;</span>
			}

			// Now get the list of changed intervals

			// Get the new start start date
<span class="nc" id="L184">			long millis = info.lookBackDays * 86400000L; // millis for days</span>
<span class="nc" id="L185">			long startMillis = info.startDate.getTime();</span>
<span class="nc" id="L186">			long newMillis = startMillis - millis;</span>

<span class="nc" id="L188">			Date newStartDate = new Date(newMillis);</span>

			// Get the new end date
<span class="nc" id="L191">			Date newEndDate = info.startDate;</span>

			// Check if the staffing was run at least once
<span class="nc bnc" id="L194" title="All 2 branches missed.">			if (info.lastQueryDate == null) {</span>
<span class="nc" id="L195">				info.lastQueryDate = newStartDate;</span>
			}

<span class="nc" id="L198">			this.cat.l7dInfo(&quot;getIntervalsToProcess(): ******* newStart=&quot; + newStartDate + &quot; newEndDate=&quot; + newEndDate</span>
					+ &quot; lastQueryDate=&quot; + info.lastQueryDate);

<span class="nc" id="L201">			this.stw.start(&quot;EJB getChangedIntervalsForWorkResource&quot;, this.ejbTrace);</span>

<span class="nc" id="L203">			HashMap hmEmpTr = m_auditmgr.getChangedIntervalsForWorkResource(info.allEmpColl,</span>
					AuditTrailEntry.MODULE_TIMERECORD, AuditTrailEntry.ACTION_ALL, newStartDate, newEndDate,
					info.lastQueryDate, &quot;&lt;anonymous&gt;&quot;);
<span class="nc" id="L206">			this.stw.stop();</span>

<span class="nc bnc" id="L208" title="All 2 branches missed.">			if (hmEmpTr == null) {</span>
<span class="nc" id="L209">				return retVal;</span>
			}

<span class="nc" id="L212">			Iterator iter = hmEmpTr.values().iterator();</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L214">				Collection trColl = (Collection) iter.next();</span>
<span class="nc" id="L215">				retVal.addAll(trColl);</span>
<span class="nc" id="L216">			}</span>

<span class="nc" id="L218">			this.cat.l7dInfo(&quot;getIntervalsToProcess(): Getting union start=&quot; + newStartDate.toString() + &quot; end=&quot;</span>
<span class="nc" id="L219">					+ info.endDate.toString() + &quot; retVal=&quot; + retVal.toString());</span>

<span class="nc" id="L221">			return this.getUnionOfChangedIntervals(newStartDate, info.endDate, retVal);</span>
		}

		finally {
<span class="nc" id="L225">			this.stw.stop();</span>
		}
	}

	public Collection getUnionOfChangedIntervals(Date startDate, Date endDate, Collection trColl) {
<span class="nc" id="L230">		this.stw.start(&quot;getUnionOfChangedIntervals&quot;);</span>

<span class="nc" id="L232">		this.cat.l7dInfo(&quot;getUnionOfChangedIntervals(): Intervals to unify=&quot; + trColl.toString());</span>

<span class="nc" id="L234">		ArrayList retVal = new ArrayList();</span>

<span class="nc bnc" id="L236" title="All 2 branches missed.">		if (trColl.size() &gt; 1) // processing required only if more than one</span>
		{
<span class="nc" id="L238">			TreeSet tsChg = new TreeSet();</span>

<span class="nc" id="L240">			Iterator trIter = trColl.iterator();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">			while (trIter.hasNext()) {</span>

<span class="nc" id="L243">				TimeRange tr = (TimeRange) trIter.next();</span>

				// This will reject events that don't start in the requested
				// interval
<span class="nc" id="L247">				Date trStart = tr.getStartDate();</span>

<span class="nc bnc" id="L249" title="All 6 branches missed.">				if (trStart.after(endDate) || trStart.equals(endDate) || tr.isInstant()) {</span>
<span class="nc" id="L250">					continue;</span>
				}

				// sort and remove duplicates
<span class="nc" id="L254">				tsChg.add(tr);</span>
<span class="nc" id="L255">			}</span>

<span class="nc" id="L257">			TimeRange startCmp = null;</span>

<span class="nc" id="L259">			Iterator chgIter = tsChg.iterator();</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">			while (chgIter.hasNext()) {</span>
<span class="nc" id="L261">				TimeRange cmp = (TimeRange) chgIter.next();</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">				if (startCmp == null)</span>

				{
<span class="nc" id="L265">					startCmp = cmp;</span>
<span class="nc" id="L266">					continue;</span>
				}

<span class="nc" id="L269">				long start = startCmp.getStartDate().getTime();</span>
<span class="nc" id="L270">				long end = startCmp.getEndDate().getTime();</span>

<span class="nc" id="L272">				long m_start = cmp.getStartDate().getTime();</span>
<span class="nc" id="L273">				long m_end = cmp.getEndDate().getTime();</span>

<span class="nc bnc" id="L275" title="All 4 branches missed.">				if (m_start &gt;= start &amp;&amp; m_start &lt;= end) // starts after</span>
				{
<span class="nc bnc" id="L277" title="All 2 branches missed.">					if (m_end &lt;= end) // in between</span>
<span class="nc" id="L278">						continue;</span>
					else
						// overlap or adjacent
<span class="nc" id="L281">						startCmp.setEndDate(cmp.getEndDate()); // extend the end</span>
																// date
				} else // no overlap
				{
<span class="nc" id="L285">					retVal.add(startCmp);</span>
<span class="nc" id="L286">					startCmp = cmp;</span>

				}
<span class="nc" id="L289">			}</span>

<span class="nc bnc" id="L291" title="All 2 branches missed.">			if (startCmp != null) // add the last one</span>
			{
<span class="nc" id="L293">				retVal.add(startCmp);</span>

			}
<span class="nc" id="L296">		} else</span>
			// add the only element
<span class="nc" id="L298">			retVal.addAll(trColl);</span>

<span class="nc" id="L300">		this.cat.l7dInfo(&quot;getUnionOfChangedIntervals(): Unified intervals=&quot; + retVal.toString());</span>

<span class="nc" id="L302">		this.stw.stop();</span>

<span class="nc" id="L304">		return retVal;</span>
	}

	private void calculateStaffing(StaffingInfo info) throws Exception {
<span class="nc" id="L308">		this.stw.start(&quot;calculateStaffing&quot;);</span>

		try {

<span class="nc" id="L312">			long intervalMillis = DEFAULT_INTERVAL_MILLIS;</span>

			// Check date/time
<span class="nc bnc" id="L315" title="All 2 branches missed.">			if (info.startDate.after(info.endDate)) {</span>

<span class="nc" id="L317">				this.stw.logDebug(&quot;calculateStaffing(): Invalid start/end dates: start=&quot; + info.startDate + &quot; end=&quot;</span>
						+ info.endDate);
<span class="nc" id="L319">				return;</span>
			}

			// If dates are same shift the start date by 15min
<span class="nc bnc" id="L323" title="All 2 branches missed.">			if (info.startDate.equals(info.endDate)) {</span>
<span class="nc" id="L324">				info.startDate = new Date(info.endDate.getTime() - (intervalMillis));</span>
			}

			// if the diff is less than the interval
<span class="nc bnc" id="L328" title="All 2 branches missed.">			if (info.endDate.getTime() - info.startDate.getTime() &lt; DEFAULT_INTERVAL_MILLIS) {</span>
<span class="nc" id="L329">				info.endDate = new Date(info.endDate.getTime() + DEFAULT_INTERVAL_MILLIS);</span>
			}

			// Align start/end date to INTERVAL
<span class="nc" id="L333">			info.startDate = TraceUtil.snapDate(info.startDate);</span>

			// find remainder and add 15min so that end date covers the
			// the next 15 min interval
<span class="nc" id="L337">			Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L338">			cal.setTime(info.endDate);</span>
<span class="nc" id="L339">			int min = cal.get(cal.MINUTE);</span>
<span class="nc" id="L340">			int rem = min % DEFAULT_INTERVAL;</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">			if (rem != 0) {</span>
<span class="nc" id="L342">				cal.set(cal.MINUTE, min + DEFAULT_INTERVAL);</span>
<span class="nc" id="L343">				info.endDate = cal.getTime();</span>
			}
<span class="nc" id="L345">			info.endDate = TraceUtil.snapDate(info.endDate);</span>

<span class="nc" id="L347">			long count = (info.endDate.getTime() - info.startDate.getTime()) / intervalMillis;</span>

<span class="nc" id="L349">			this.stw.logDebug(&quot;calculateStaffing(): No of intervals to calculate staffing=&quot; + count + &quot; start=&quot;</span>
					+ info.startDate + &quot; end=&quot; + info.endDate);

<span class="nc" id="L352">			long startMillis = info.startDate.getTime();</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">			for (int i = 0; i &lt; count; ++i) {</span>
<span class="nc" id="L354">				info.startDate = new Date(startMillis);</span>
<span class="nc" id="L355">				info.endDate = new Date(startMillis + intervalMillis);</span>

				// calculate staffing
<span class="nc" id="L358">				info.init();</span>
<span class="nc" id="L359">				calculateStaffingForInterval(info);</span>

<span class="nc" id="L361">				startMillis = info.endDate.getTime();</span>
			}

		}

		finally {
<span class="nc" id="L367">			this.stw.stop();</span>
<span class="nc" id="L368">		}</span>
<span class="nc" id="L369">	}</span>

	private void calculateStaffingForInterval(StaffingInfo info) throws RemoteException, BbmFinderException,
			BbmEJBCreateException, FacadeException, BbmCreateException {
<span class="nc" id="L373">		this.stw.start(&quot;calculateStaffingForInterval&quot;);</span>

		try {
<span class="nc" id="L376">			this.stw.logDebug(&quot;calculateStaffing():********** STAFFING start=&quot; + info.startDate + &quot; millis=&quot;</span>
<span class="nc" id="L377">					+ info.startDate.getTime() + &quot; end=&quot; + info.endDate + &quot; empCount=&quot; + info.allEmpColl.size());</span>

<span class="nc" id="L379">			ArrayList empColl = new ArrayList(info.allEmpColl);</span>
<span class="nc" id="L380">			Iterator iter = empColl.iterator();</span>
<span class="nc" id="L381">			int fromIndex = 0;</span>
<span class="nc" id="L382">			int toIndex = 0;</span>

<span class="nc bnc" id="L384" title="All 2 branches missed.">			for (fromIndex = 0; fromIndex &lt; empColl.size(); fromIndex = toIndex) {</span>
<span class="nc" id="L385">				ArrayList empList = new ArrayList();</span>
<span class="nc" id="L386">				toIndex = fromIndex;</span>
<span class="nc bnc" id="L387" title="All 4 branches missed.">				for (toIndex = fromIndex; toIndex &lt; fromIndex + info.empChunkSize &amp;&amp; toIndex &lt; empColl.size(); ++toIndex) {</span>
<span class="nc" id="L388">					empList.add(iter.next());</span>
				}

<span class="nc" id="L391">				this.stw.logDebug(&quot;calculateStaffing():********** Processing  empStart=&quot; + fromIndex + &quot; empEnd=&quot;</span>
						+ toIndex + &quot; ***************&quot;);

<span class="nc" id="L394">				info.empColl = empList;</span>

<span class="nc" id="L396">				info.preFetch();</span>
<span class="nc" id="L397">				calculateStaffingForEmployeeChunk(info);</span>
			}

<span class="nc" id="L400">			updateStaffing(info);</span>
		}

		finally {
<span class="nc" id="L404">			this.stw.stop();</span>
<span class="nc" id="L405">		}</span>
<span class="nc" id="L406">	}</span>

	private void calculateStaffingForEmployeeChunk(StaffingInfo info) throws RemoteException, BbmFinderException,
			BbmEJBCreateException {
<span class="nc" id="L410">		this.stw.start(&quot;calculateStaffingForEmployeeChunk&quot;);</span>

		try {

			// for each employee get the hash map of media 2 duration
<span class="nc" id="L415">			Iterator empIter = info.empColl.iterator();</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">			while (empIter.hasNext()) {</span>
<span class="nc" id="L417">				ID empID = (ID) empIter.next();</span>
<span class="nc" id="L418">				Collection trColl = (Collection) info.hmTR.get(empID);</span>
<span class="nc bnc" id="L419" title="All 4 branches missed.">				if (trColl == null || trColl.size() &lt;= 0) {</span>

<span class="nc" id="L421">					this.stw.logDebug(&quot;calculateStaffing():No Time records found for empID=&quot; + empID);</span>

<span class="nc" id="L423">					continue;</span>
				}

				// for each timerecord get the staffing
<span class="nc" id="L427">				Iterator recIter = trColl.iterator();</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">				while (recIter.hasNext()) {</span>
<span class="nc" id="L429">					TimeRecord trec = (TimeRecord) recIter.next();</span>

<span class="nc" id="L431">					Collection childColl = trec.getChildren();</span>
<span class="nc bnc" id="L432" title="All 4 branches missed.">					if (childColl == null || childColl.size() &lt;= 0) {</span>

<span class="nc" id="L434">						this.stw.logDebug(&quot;calculateStaffing():No Time entries found for empID=&quot; + empID);</span>
<span class="nc" id="L435">						continue; // no entries found for the timerecord</span>
					}

<span class="nc" id="L438">					this.stw.logDebug(&quot;calculateStaffing():************** EMPID &quot; + empID + &quot; ***************&quot;);</span>

					// Get the activity duration from time record entries
<span class="nc" id="L441">					HashMap media2Duration = getMedia2Agents(childColl, info);</span>

<span class="nc bnc" id="L443" title="All 4 branches missed.">					if (media2Duration == null || media2Duration.size() &lt; 1) {</span>

<span class="nc" id="L445">						this.stw.logDebug(&quot;calculateStaffing():No valid time entries found for empID=&quot; + empID);</span>
<span class="nc" id="L446">						continue;</span>
					}

					// update the global media list with the staffing info
<span class="nc" id="L450">					info.media2Duration.put(empID, media2Duration);</span>
<span class="nc" id="L451">				}</span>
<span class="nc" id="L452">			}</span>

<span class="nc" id="L454">			HashMap hmQueColl = getQueues(info);</span>
<span class="nc bnc" id="L455" title="All 4 branches missed.">			if (hmQueColl != null &amp;&amp; hmQueColl.size() &gt; 0) {</span>
<span class="nc" id="L456">				ArrayList updatedQueueIds = new ArrayList();</span>
<span class="nc" id="L457">				Iterator hmQueIter = hmQueColl.keySet().iterator();</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">				while (hmQueIter.hasNext()) {</span>
<span class="nc" id="L459">					ID empID = (ID) hmQueIter.next();</span>
<span class="nc" id="L460">					Collection queColl = (Collection) hmQueColl.get(empID);</span>
<span class="nc" id="L461">					Iterator queIter = queColl.iterator();</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">					while (queIter.hasNext()) {</span>
<span class="nc" id="L463">						StaffingData data = (StaffingData) queIter.next();</span>
<span class="nc" id="L464">						ID id = data.queID;</span>

<span class="nc" id="L466">						ID spID = (ID) info.hmCombinedQue.get(id);</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">						if (spID != null) {</span>
<span class="nc" id="L468">							HashSet hmCQ = (HashSet) info.hmCCQStaff.get(spID);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">							if (hmCQ == null) {</span>
<span class="nc" id="L470">								hmCQ = new HashSet();</span>
<span class="nc" id="L471">								info.hmCCQStaff.put(spID, hmCQ);</span>
							}
<span class="nc" id="L473">							hmCQ.add(data);</span>
						}

<span class="nc" id="L476">						this.updateQueCount(id, info.que2Agents, data, info);</span>

<span class="nc" id="L478">						ID parQueID = info.getParentQueID(id);</span>
<span class="nc" id="L479">						this.updateQueCount(parQueID, info.que2Agents, data, info);</span>

<span class="nc" id="L481">						this.stw.logDebug(&quot;calculateStaffing():Adding count empID=&quot; + empID + &quot; queID=&quot; + id</span>
								+ &quot; parQue=&quot; + parQueID);
<span class="nc" id="L483">						updatedQueueIds.add(id);</span>
<span class="nc" id="L484">					}</span>
					// fix QC 78473 Staffing Calculator - some intervals are
					// blank (not zero)
<span class="nc" id="L487">					Long duration = new Long(0L);</span>
<span class="nc" id="L488">					Iterator iter = info.hmcamQColl.keySet().iterator();</span>

<span class="nc bnc" id="L490" title="All 2 branches missed.">					while (iter.hasNext()) {</span>
<span class="nc" id="L491">						Collection queueColl = (Collection) info.hmcamQColl.get(iter.next());</span>
<span class="nc" id="L492">						Iterator iterQueColl = queueColl.iterator();</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">						while (iterQueColl.hasNext()) {</span>
<span class="nc" id="L494">							ID queID = (ID) iterQueColl.next();</span>
<span class="nc bnc" id="L495" title="All 4 branches missed.">							if (!info.que2Agents.containsKey(queID) &amp;&amp; !updatedQueueIds.contains(queID)) {</span>
<span class="nc" id="L496">								StaffingData data = new StaffingData();</span>
<span class="nc" id="L497">								data.empID = null;</span>
<span class="nc" id="L498">								data.queID = queID;</span>
<span class="nc" id="L499">								data.duration = duration;</span>
<span class="nc" id="L500">								this.updateQueCount(queID, info.que2Agents, data, info);</span>

							}
<span class="nc" id="L503">						}</span>
<span class="nc" id="L504">					}</span>
<span class="nc" id="L505">				}</span>
<span class="nc" id="L506">			} else // update ques linked to campaign with zero</span>
			{
<span class="nc" id="L508">				Long duration = new Long(0L);</span>

<span class="nc" id="L510">				Iterator iter = info.hmcamQColl.keySet().iterator();</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">				while (iter.hasNext()) {</span>
<span class="nc" id="L512">					Collection queColl = (Collection) info.hmcamQColl.get(iter.next());</span>
<span class="nc" id="L513">					Iterator iterQueColl = queColl.iterator();</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">					while (iterQueColl.hasNext()) {</span>
<span class="nc" id="L515">						ID queID = (ID) iterQueColl.next();</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">						if (!info.que2Agents.containsKey(queID)) {</span>
<span class="nc" id="L517">							StaffingData data = new StaffingData();</span>
<span class="nc" id="L518">							data.empID = null;</span>
<span class="nc" id="L519">							data.queID = queID;</span>
<span class="nc" id="L520">							data.duration = duration;</span>
<span class="nc" id="L521">							this.updateQueCount(queID, info.que2Agents, data, info);</span>
<span class="nc" id="L522">							this.updateQueCount(info.getParentQueID(queID), info.que2Agents, data, info);</span>
						}
<span class="nc" id="L524">					}</span>
<span class="nc" id="L525">				}</span>
			}

		}

		finally {
<span class="nc" id="L531">			this.stw.stop();</span>
<span class="nc" id="L532">		}</span>
<span class="nc" id="L533">	}</span>

	private void updateQueCount(ID queID, HashMap hmQue, StaffingData data, StaffingInfo info) {
<span class="nc" id="L536">		this.stw.start(&quot;updateQueCount&quot;);</span>

		try {
<span class="nc bnc" id="L539" title="All 2 branches missed.">			if (queID == null)</span>
<span class="nc" id="L540">				return;</span>

<span class="nc bnc" id="L542" title="All 2 branches missed.">			if (data == null)</span>
<span class="nc" id="L543">				return;</span>

<span class="nc" id="L545">			Queue que = (Queue) info.hmQueObj.get(queID);</span>
<span class="nc" id="L546">			HashSet empColl = (HashSet) hmQue.get(queID);</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">			if (empColl == null) {</span>
<span class="nc" id="L548">				empColl = new HashSet();</span>
<span class="nc" id="L549">				hmQue.put(queID, empColl);</span>
			}

<span class="nc bnc" id="L552" title="All 2 branches missed.">			if (data.empID != null) {</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">				if (empColl.contains(data)) {</span>
<span class="nc" id="L554">					Iterator it = empColl.iterator();</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">					while (it.hasNext()) {</span>
<span class="nc" id="L556">						StaffingData existingData = (StaffingData) it.next();</span>
<span class="nc bnc" id="L557" title="All 4 branches missed.">						if (existingData.empID.equals(data.empID) &amp;&amp; existingData.queID.equals(data.queID)) {</span>
<span class="nc" id="L558">							long duration = existingData.duration.longValue();</span>
<span class="nc" id="L559">							duration += data.duration.longValue();</span>
<span class="nc" id="L560">							existingData.duration = new Long(duration);</span>
<span class="nc" id="L561">							this.stw.logDebug(&quot;Summing duration for: que=&quot; + queID + &quot; emp=&quot; + data.empID</span>
									+ &quot; total duration =&quot; + existingData.duration);
<span class="nc" id="L563">							break;</span>
						}
<span class="nc" id="L565">					}</span>

<span class="nc" id="L567">				} else {</span>
<span class="nc" id="L568">					empColl.add(data);</span>
				}
			}

<span class="nc" id="L572">			this.stw.logDebug(&quot;updateQueCount(): que=&quot; + queID + &quot; emp=&quot; + data.empID + &quot; numEmployees=&quot;</span>
<span class="nc" id="L573">					+ empColl.size());</span>
		}

		finally {
<span class="nc" id="L577">			this.stw.stop();</span>
<span class="nc" id="L578">		}</span>
<span class="nc" id="L579">	}</span>

	private Long computeStaffingValues(Collection coll, StaffingInfo info) {
		try {
<span class="nc" id="L583">			this.stw.start(&quot;computeStaffingValues(): ********* computing staffing values&quot;);</span>

<span class="nc bnc" id="L585" title="All 4 branches missed.">			if (coll == null || coll.size() &lt;= 0)</span>
<span class="nc" id="L586">				return new Long(0);</span>

<span class="nc bnc" id="L588" title="All 4 branches missed.">			if (coll.size() &lt;= 0 || info.computeActual)</span>
<span class="nc" id="L589">				return new Long(coll.size());</span>

			// Duration based computing
<span class="nc" id="L592">			ID queID = null;</span>
<span class="nc" id="L593">			double totDuration = 0.0;</span>
<span class="nc" id="L594">			Iterator iter = coll.iterator();</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L596">				StaffingData data = (StaffingData) iter.next();</span>
<span class="nc" id="L597">				queID = data.queID;</span>
<span class="nc" id="L598">				totDuration += data.duration.longValue();</span>
<span class="nc" id="L599">			}</span>
<span class="nc" id="L600">			totDuration /= DEFAULT_INTERVAL_MILLIS;</span>
<span class="nc" id="L601">			long staff = Math.round(totDuration);</span>

<span class="nc" id="L603">			this.stw.logDebug(&quot;computeStaffingValues(): ********* que=&quot; + queID + &quot; totalDuration=&quot; + totDuration</span>
<span class="nc" id="L604">					+ &quot; numEmployees=&quot; + coll.size() + &quot; staff=&quot; + staff);</span>

<span class="nc" id="L606">			return new Long(staff);</span>
		} finally {
<span class="nc" id="L608">			this.stw.stop();</span>
		}
	}

	private void updateStaffing(StaffingInfo info) throws RemoteException, BbmFinderException, BbmEJBCreateException,
			BbmCreateException {
<span class="nc" id="L614">		this.stw.start(&quot;updateStaffing&quot;);</span>

		try {
<span class="nc" id="L617">			TimeSeriesManager mgr = WfmManagerFactory.getTimeSeriesManager();</span>
<span class="nc" id="L618">			WorkloadManager wlmgr = WfmManagerFactory.getWorkloadManager();</span>

<span class="nc" id="L620">			ArrayList queColl = new ArrayList();</span>
<span class="nc" id="L621">			HashMap hmCQueStaffing = new HashMap();</span>
<span class="nc" id="L622">			HashMap hmQue2SP = new HashMap(info.hmCombinedQue);</span>

<span class="nc" id="L624">			Iterator iter = info.que2Agents.keySet().iterator();</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L626">				ID queID = (ID) iter.next();</span>

<span class="nc" id="L628">				Long staff = new Long(0);</span>

<span class="nc" id="L630">				Queue que = (Queue) info.hmQueObj.get(queID);</span>

<span class="nc" id="L632">				staff = this.computeStaffingValues((Collection) info.que2Agents.get(queID), info);</span>

<span class="nc bnc" id="L634" title="All 4 branches missed.">				if (staff.longValue() == 0 &amp;&amp; info.isUnknownActivity) {</span>
<span class="nc" id="L635">					staff = new Long(Trace.TRACENA);</span>
				}

<span class="nc" id="L638">				queColl.clear();</span>
<span class="nc" id="L639">				queColl.add(queID);</span>

				// add child virtual ques from datasource
				// since these are not linked in a campaign
<span class="nc bnc" id="L643" title="All 2 branches missed.">				if (que.getQueueType() == Queue.QUEUE_TYPE_VIRTUAL) {</span>
<span class="nc" id="L644">					Iterator dsqIter = info.dsqColl.iterator();</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">					while (dsqIter.hasNext()) {</span>
<span class="nc" id="L646">						ID dsQueID = (ID) dsqIter.next();</span>
<span class="nc" id="L647">						Queue dsQue = (Queue) info.hmQueObj.get(dsQueID);</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">						if (dsQue != null) {</span>
<span class="nc" id="L649">							ID parQueID = dsQue.getParentID();</span>
<span class="nc bnc" id="L650" title="All 4 branches missed.">							if (parQueID != null &amp;&amp; parQueID.equals(queID)) {</span>
<span class="nc" id="L651">								queColl.add(dsQueID);</span>
							}
						}
<span class="nc" id="L654">					}</span>
				}

<span class="nc" id="L657">				Iterator queIter = queColl.iterator();</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">				while (queIter.hasNext()) {</span>
<span class="nc" id="L659">					this.stw.logDebug(&quot;updateStaffing(): ********* Updating que=&quot; + queIter.next() + &quot; staff=&quot; + staff</span>
							+ &quot; startDate=&quot; + info.startDate + &quot; ************** &quot;);
				}

<span class="nc" id="L663">				this.stw.start(&quot;EJB createActualTimeSeries&quot;, this.ejbTrace);</span>
<span class="nc" id="L664">				mgr.createActualTimeSeries(Trace.STAFFING, queColl, staff.intValue(), info.startDate);</span>

<span class="nc" id="L666">				ID spID = (ID) hmQue2SP.get(queID);</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">				if (spID != null) {</span>
					// calculate for each media
<span class="nc" id="L669">					this.calculateCombinedQStaffingForSP(hmCQueStaffing, spID, staff, info, queID);</span>

<span class="nc" id="L671">					hmQue2SP.remove(queID);</span>
				}

<span class="nc" id="L674">				this.stw.stop();</span>
<span class="nc" id="L675">			}</span>

			// update info for remaining combined queues with zero
<span class="nc bnc" id="L678" title="All 2 branches missed.">			if (hmQue2SP.size() &gt; 0) {</span>
<span class="nc" id="L679">				Long zeoVal = new Long(0L);</span>
<span class="nc" id="L680">				Iterator hmque2SPiter = hmQue2SP.keySet().iterator();</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">				while (hmque2SPiter.hasNext()) {</span>
<span class="nc" id="L682">					ID queID = (ID) hmque2SPiter.next();</span>
<span class="nc" id="L683">					this.calculateCombinedQStaffingForSP(hmCQueStaffing, (ID) hmQue2SP.get(queID), zeoVal, info, queID);</span>

<span class="nc" id="L685">				}</span>
			}

			// update the combined queue staffing values in database
<span class="nc bnc" id="L689" title="All 2 branches missed.">			if (hmCQueStaffing.size() &gt; 0) {</span>
<span class="nc" id="L690">				Iterator cqIter = hmCQueStaffing.values().iterator();</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">				while (cqIter.hasNext()) {</span>
<span class="nc" id="L692">					Object value[] = (Object[]) cqIter.next();</span>
<span class="nc" id="L693">					ID spQueID = (ID) value[0];</span>
<span class="nc" id="L694">					ID mediaID = (ID) value[1];</span>
<span class="nc" id="L695">					Collection coll = (Collection) value[2];</span>
<span class="nc" id="L696">					Long cqStaff = this.computeStaffingValues(coll, info);</span>

					try {
<span class="nc" id="L699">						this.stw.logDebug(&quot;updateStaffing(): ********* Updating combined queue spID=&quot; + spQueID</span>
<span class="nc" id="L700">								+ &quot; media=&quot; + mediaID + &quot; staff=&quot; + cqStaff.longValue());</span>

<span class="nc" id="L702">						wlmgr.updateCombinedQueueStaffing(spQueID, mediaID, cqStaff.floatValue(), info.startDate);</span>
<span class="nc" id="L703">					} catch (Exception ex) {</span>
						// ex.printStackTrace();
<span class="nc" id="L705">					}</span>
<span class="nc" id="L706">				}</span>
			}

		}

		finally {
<span class="nc" id="L712">			this.stw.stop();</span>
<span class="nc" id="L713">		}</span>
<span class="nc" id="L714">	}</span>

	private void calculateCombinedQStaffingForSP(HashMap hmCQueStaffing, ID spQueID, Long staff, StaffingInfo info,
			ID queID) {
<span class="nc" id="L718">		Queue cque = (Queue) info.hmQueObj.get(queID);</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">		if (cque == null)</span>
<span class="nc" id="L720">			return;</span>

<span class="nc" id="L722">		ID media = new ID(cque.getMediaStrID().trim().hashCode());</span>

		// calculate for each media
<span class="nc" id="L725">		this.calculateCombinedQStaffing(hmCQueStaffing, spQueID, media, staff, queID, info);</span>

		// calculate overall
<span class="nc" id="L728">		this.calculateCombinedQStaffing(hmCQueStaffing, spQueID, null, staff, queID, info);</span>

<span class="nc" id="L730">	}</span>

	private void calculateCombinedQStaffing(HashMap hmCQueStaffing, ID spQueID, ID mediaID, Long staff, ID queID,
			StaffingInfo info) {
<span class="nc" id="L734">		String key = spQueID.toString();</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">		if (mediaID != null) {</span>
<span class="nc" id="L736">			key += mediaID.toString();</span>
		}

<span class="nc" id="L739">		Collection coll = null;</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">		if (mediaID != null)</span>
<span class="nc" id="L741">			coll = (Collection) info.que2Agents.get(queID);</span>
		else
<span class="nc" id="L743">			coll = (HashSet) info.hmCCQStaff.get(spQueID);</span>

<span class="nc bnc" id="L745" title="All 2 branches missed.">		if (staff.longValue() == Trace.TRACENA) {</span>
<span class="nc" id="L746">			coll = null;</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">		} else if (coll == null) {</span>
<span class="nc" id="L748">			coll = Collections.emptyList();</span>
		}

<span class="nc" id="L751">		Object value[] = (Object[]) hmCQueStaffing.get(key);</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">		if (value == null) {</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">			if (coll != null) {</span>
<span class="nc" id="L754">				coll = new TreeSet(coll);</span>
			}
<span class="nc" id="L756">			value = new Object[] { spQueID, mediaID, coll };</span>
<span class="nc" id="L757">			hmCQueStaffing.put(key, value);</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">		} else if (mediaID != null) {</span>
<span class="nc" id="L759">			Collection sColl = (Collection) value[2];</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">			if (coll != null) {</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">				if (sColl == null) {</span>
<span class="nc" id="L762">					value[2] = sColl = new TreeSet();</span>
				}
<span class="nc" id="L764">				sColl.addAll(coll);</span>
			}
		}
<span class="nc" id="L767">	}</span>

	private HashMap getQueues(StaffingInfo info) throws RemoteException, BbmFinderException, BbmEJBCreateException {
<span class="nc" id="L770">		this.stw.start(&quot;getQueues&quot;);</span>

<span class="nc" id="L772">		HashMap hmQueColl = new HashMap();</span>

<span class="nc" id="L774">		Iterator empIter = info.media2Duration.keySet().iterator();</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">		while (empIter.hasNext()) {</span>
<span class="nc" id="L776">			ID empID = (ID) empIter.next();</span>
<span class="nc" id="L777">			HashMap media2Duration = (HashMap) info.media2Duration.get(empID);</span>

			// List of assigned skill ID's for agent
<span class="nc" id="L780">			ArrayList saIDColl = new ArrayList();</span>

			// Get the list of assigned skills for the agent
<span class="nc" id="L783">			Collection saColl = (Collection) info.hmsaColl.get(empID);</span>
<span class="nc bnc" id="L784" title="All 4 branches missed.">			if (saColl != null &amp;&amp; saColl.size() &gt; 0) {</span>
<span class="nc" id="L785">				Iterator saIter = saColl.iterator();</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">				while (saIter.hasNext()) {</span>
<span class="nc" id="L787">					SkillAssignment sa = (SkillAssignment) saIter.next();</span>

<span class="nc bnc" id="L789" title="All 2 branches missed.">					if (sa.isReserve()) // skip reserve skills</span>
					{
<span class="nc" id="L791">						continue;</span>
					}

<span class="nc" id="L794">					saIDColl.add(sa.getSkillID());</span>
<span class="nc" id="L795">				}</span>
<span class="nc" id="L796">			} else {</span>
<span class="nc" id="L797">				this.stw.logDebug(&quot;getQueues(): No skills found for empId=&quot; + empID);</span>
			}

			// List of que ID's to be updated
<span class="nc" id="L801">			ArrayList queColl = new ArrayList();</span>

			// Get campaigns linked to agent
<span class="nc" id="L804">			Collection campColl = (Collection) info.hmcampColl.get(empID);</span>
<span class="nc bnc" id="L805" title="All 4 branches missed.">			if (campColl == null || campColl.size() &lt;= 0) {</span>
<span class="nc" id="L806">				this.stw.logDebug(&quot;getQueues(): No campaigns found for empID=&quot; + empID);</span>
<span class="nc" id="L807">				continue;</span>
			}

			// Get queues linked to campaign
<span class="nc" id="L811">			Iterator campIter = campColl.iterator();</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">			while (campIter.hasNext()) {</span>
<span class="nc" id="L813">				CampaignWorkResource cw = (CampaignWorkResource) campIter.next();</span>
<span class="nc" id="L814">				ID campID = cw.getCampaignID();</span>
<span class="nc" id="L815">				Collection cqColl = (Collection) info.hmcamQColl.get(campID);</span>
<span class="nc bnc" id="L816" title="All 4 branches missed.">				if (cqColl == null || cqColl.size() &lt;= 0) {</span>
<span class="nc" id="L817">					this.stw.logDebug(&quot;getQueues(): No queues mapped for campaign=&quot; + campID);</span>
<span class="nc" id="L818">					continue;</span>
				}

				// get datasource/queue for the employee
<span class="nc" id="L822">				Collection eqColl = info.dsqColl;</span>

				// For each queue, check for valid skill &amp; media
<span class="nc" id="L825">				Iterator cqIter = cqColl.iterator();</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">				while (cqIter.hasNext()) {</span>
<span class="nc" id="L827">					ID queID = (ID) cqIter.next();</span>

					// skip queues not mapped to data source
<span class="nc bnc" id="L830" title="All 6 branches missed.">					if (eqColl == null || eqColl.size() &lt;= 0 || !eqColl.contains(queID)) {</span>
<span class="nc" id="L831">						this.stw.logDebug(&quot;getQueues(): ******* Employee ID=&quot; + empID + &quot; or Campaign queID=&quot; + queID</span>
								+ &quot; is not mapped to data source &quot; + info.dsColl);
<span class="nc" id="L833">						continue;</span>
					}

<span class="nc" id="L836">					Queue que = (Queue) info.hmQueObj.get(queID);</span>

<span class="nc" id="L838">					boolean addQue = true;</span>

<span class="nc" id="L840">					Collection qsColl = (Collection) info.hmqsColl.get(queID);</span>

<span class="nc bnc" id="L842" title="All 2 branches missed.">					if (qsColl != null) {</span>
						// If queue is associated with skill, check if agent
						// has all the skills
<span class="nc" id="L845">						Iterator qsIter = qsColl.iterator();</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">						while (qsIter.hasNext()) {</span>
<span class="nc" id="L847">							QueueSkill qs = (QueueSkill) qsIter.next();</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">							if (qs == null) {</span>

<span class="nc" id="L850">								this.stw.logDebug(&quot;getQueues(): Que &quot; + queID + &quot; does not have skill assignment&quot;);</span>
<span class="nc" id="L851">								continue;</span>
							}

							// check if que id from the assignment is valid i.e.
							// it is associated with the current campaign
<span class="nc" id="L856">							ID qsID = qs.getQueueID();</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">							if (info.hmQueObj.get(qsID) == null) {</span>
<span class="nc" id="L858">								continue;</span>
							}

<span class="nc bnc" id="L861" title="All 2 branches missed.">							if (!saIDColl.contains(qs.getSkillID())) {</span>
<span class="nc" id="L862">								addQue = false; // agent does not have the skill</span>
												// so skip this que

<span class="nc" id="L865">								this.stw.logDebug(&quot;getQueues(): Agent &quot; + empID + &quot; does not have skill=&quot;</span>
<span class="nc" id="L866">										+ qs.getSkillID() + &quot; rejected que=&quot; + queID);</span>
<span class="nc" id="L867">								break;</span>
							}
<span class="nc" id="L869">						}</span>
					}

					// ok to add que
<span class="nc bnc" id="L873" title="All 2 branches missed.">					if (addQue) {</span>
<span class="nc" id="L874">						ID mediaID = que.getMediaID();</span>
<span class="nc" id="L875">						Iterator iter = media2Duration.keySet().iterator();</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">						while (iter.hasNext()) {</span>
<span class="nc" id="L877">							CompoundKey actMedia = (CompoundKey) iter.next();</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">							if (actMedia.getKey1().equals(mediaID)) {</span>
								// get activity queue Hope for this media
<span class="nc" id="L880">								Collection colQue = info.getActivityQueueHope(actMedia.getKey2());</span>

								// activity is not queue hope to any queue or
								// activity is queue hope for current
								// queue --&gt; OK to add que
<span class="nc bnc" id="L885" title="All 4 branches missed.">								if ((colQue == null || colQue.size() &lt;= 0)) {</span>
<span class="nc" id="L886">									Long dur = (Long) media2Duration.get(actMedia);</span>
									// check if media of que is contained in the
									// activity
<span class="nc bnc" id="L889" title="All 4 branches missed.">									if (dur != null &amp;&amp; dur.longValue() &gt; 0) {</span>
										// all conditions are satisfied
<span class="nc" id="L891">										StaffingData data = new StaffingData();</span>
<span class="nc" id="L892">										data.duration = dur;</span>
<span class="nc" id="L893">										data.queID = queID;</span>
<span class="nc" id="L894">										data.empID = empID;</span>
<span class="nc" id="L895">										queColl.add(data);</span>

<span class="nc" id="L897">										this.stw.logDebug(&quot;getQueues():  OK to add to que=&quot; + queID + &quot;, queue media=&quot;</span>
<span class="nc" id="L898">												+ mediaID + &quot;, actv=&quot; + actMedia.getKey2() + &quot; is not queue hoping&quot;);</span>
<span class="nc" id="L899">									} else {</span>
<span class="nc" id="L900">										this.stw.logDebug(&quot;getQueues(): Queue Media=&quot; + que.getMediaID()</span>
												+ &quot; does not match activity media&quot;);
									}

<span class="nc bnc" id="L904" title="All 4 branches missed.">								} else if (colQue != null &amp;&amp; colQue.contains(queID)) {</span>
<span class="nc" id="L905">									Long dur = (Long) media2Duration.get(actMedia);</span>
									// check if media of que is contained in the
									// activity
<span class="nc bnc" id="L908" title="All 4 branches missed.">									if (dur != null &amp;&amp; dur.longValue() &gt; 0) {</span>
										// all conditions are satisfied
<span class="nc" id="L910">										StaffingData data = new StaffingData();</span>
<span class="nc" id="L911">										data.duration = dur;</span>
<span class="nc" id="L912">										data.queID = queID;</span>
<span class="nc" id="L913">										data.empID = empID;</span>
<span class="nc" id="L914">										queColl.add(data);</span>
<span class="nc" id="L915">										this.stw.logDebug(&quot;getQueues(): OK to add to que=&quot; + queID + &quot;, queue media=&quot;</span>
<span class="nc" id="L916">												+ mediaID + &quot;, actv=&quot; + actMedia.getKey2()</span>
												+ &quot; is queue hoping associate to this queue&quot;);

<span class="nc" id="L919">									} else {</span>
<span class="nc" id="L920">										this.stw.logDebug(&quot;getQueues(): Queue Media=&quot; + que.getMediaID()</span>
												+ &quot; does not match activity media&quot;);
									}
<span class="nc" id="L923">								} else {</span>
<span class="nc" id="L924">									this.stw.logDebug(&quot;getQueues(): Not OK to add to que=&quot; + queID + &quot;, queue media=&quot;</span>
<span class="nc" id="L925">											+ mediaID + &quot;, actv=&quot; + actMedia.getKey2()</span>
											+ &quot; is queue hoping associate to other que&quot;);
								}
							}
<span class="nc" id="L929">						}</span>
					}
<span class="nc" id="L931">				}</span>
<span class="nc" id="L932">			}</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">			if (queColl.size() &gt; 0) {</span>
<span class="nc" id="L934">				hmQueColl.put(empID, queColl);</span>
<span class="nc" id="L935">				this.stw.logDebug(&quot;Employee &quot; + empID + &quot; linked to &quot; + hmQueColl + &quot;queues&quot;);</span>

			}
<span class="nc" id="L938">		}</span>

<span class="nc" id="L940">		this.stw.stop();</span>

<span class="nc" id="L942">		return hmQueColl;</span>
	}

	private HashMap getMedia2Agents(Collection treColl, StaffingInfo info) throws RemoteException, BbmFinderException,
			BbmEJBCreateException {
<span class="nc" id="L947">		this.stw.start(&quot;getMedia2Agents&quot;);</span>

		try {

<span class="nc" id="L951">			HashMap media2Duration = new HashMap(); // media to duration</span>
<span class="nc" id="L952">			long interval = info.endDate.getTime() - info.startDate.getTime();</span>

<span class="nc" id="L954">			HashMap actv2Media = new HashMap(); // activity to media types</span>

<span class="nc" id="L956">			Iterator childIter = treColl.iterator();</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">			while (childIter.hasNext()) {</span>
<span class="nc" id="L958">				TimeRecordEntry tre = (TimeRecordEntry) childIter.next();</span>

<span class="nc" id="L960">				this.stw.logDebug(&quot;getMedia2Agents(): **** TRE start=&quot; + tre.getStartTime() + &quot; sec=&quot;</span>
<span class="nc" id="L961">						+ tre.getSeconds() + &quot; activity=&quot; + tre.getActivityID());</span>

<span class="nc" id="L963">				long treStartMillis = tre.getStartTime().getTime();</span>
<span class="nc" id="L964">				long startMillis = info.startDate.getTime();</span>
<span class="nc" id="L965">				long endMillis = info.endDate.getTime();</span>

				// past end time, so skip
<span class="nc bnc" id="L968" title="All 2 branches missed.">				if (treStartMillis &gt;= endMillis) {</span>
<span class="nc" id="L969">					continue;</span>
				}

				// before start time, so skip
<span class="nc" id="L973">				long eventDur = treStartMillis + tre.getSeconds() * 1000;</span>
<span class="nc bnc" id="L974" title="All 4 branches missed.">				if (treStartMillis &lt;= startMillis &amp;&amp; eventDur &lt;= startMillis) {</span>
<span class="nc" id="L975">					continue;</span>
				}

				// get the duration
<span class="nc" id="L979">				long duration = getDuration(tre, info.startDate, info.endDate, interval);</span>

				// check media type
<span class="nc" id="L982">				Collection mediaColl = (Collection) actv2Media.get(tre.getActivityID());</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">				if (mediaColl == null) {</span>
<span class="nc" id="L984">					Activity actv = info.getActivity(tre.getActivityID());</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">					if (actv == null) {</span>
<span class="nc" id="L986">						continue;</span>
					}

					// get the media types for this activity, if none then skip
<span class="nc" id="L990">					mediaColl = info.getMedia(tre.getActivityID());</span>
<span class="nc bnc" id="L991" title="All 4 branches missed.">					if (mediaColl == null || mediaColl.size() &lt;= 0) {</span>

						{
<span class="nc" id="L994">							this.stw.logDebug(&quot;getMedia2Agents(): Rejected activity since it does not contain media&quot;);</span>
						}

<span class="nc bnc" id="L997" title="All 2 branches missed.">						if (tre.getActivityID().equals(Activity.ACTIVITY_UNKNOWN)) {</span>
<span class="nc" id="L998">							info.isUnknownActivity = true;</span>
						}

						continue;
					} else {
<span class="nc" id="L1003">						actv2Media.put(tre.getActivityID(), mediaColl);</span>
<span class="nc" id="L1004">						info.isUnknownActivity = false;</span>
					}
				}

<span class="nc" id="L1008">				Iterator mediaIter = mediaColl.iterator();</span>
<span class="nc bnc" id="L1009" title="All 2 branches missed.">				while (mediaIter.hasNext()) {</span>
<span class="nc" id="L1010">					ID id = (ID) mediaIter.next();</span>
<span class="nc" id="L1011">					CompoundKey mediaKey = new CompoundKey(id, tre.getActivityID());</span>
<span class="nc" id="L1012">					Long dur = (Long) media2Duration.get(mediaKey);</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">					if (dur != null) {</span>
<span class="nc" id="L1014">						dur = new Long(dur.longValue() + duration);</span>
					} else {
<span class="nc" id="L1016">						dur = new Long(duration);</span>
					}

<span class="nc" id="L1019">					media2Duration.put(mediaKey, dur);</span>

<span class="nc" id="L1021">					this.stw.logDebug(&quot;getMedia2Agents(): Selected TRE start=&quot; + tre.getStartTime() + &quot; dur=&quot;</span>
<span class="nc" id="L1022">							+ dur.longValue() + &quot; media=&quot; + id + &quot; activity=&quot; + tre.getActivityID());</span>
<span class="nc" id="L1023">				}</span>
<span class="nc" id="L1024">			}</span>

<span class="nc" id="L1026">			return media2Duration;</span>
		}

		finally {
<span class="nc" id="L1030">			this.stw.stop();</span>
		}

	}

	// Return collection of all employee id's
	private Collection&lt;ID&gt; getEmployeeIDs(Date startDate) throws RemoteException, BbmFinderException,
			BbmEJBCreateException {
<span class="nc" id="L1038">		this.stw.start(&quot;getEmployeeIDs&quot;);</span>

		try {
<span class="nc" id="L1041">			WorkResourceManager mgr = BbmManagerFactory.getWorkResourceManager();</span>

<span class="nc" id="L1043">			this.stw.start(&quot;EJB getEmployeeIds&quot;, this.ejbTrace);</span>

<span class="nc" id="L1045">			Collection&lt;ID&gt; empColl = mgr.getEmployeeIds(Organization.ROOT_ORG_ID_OBJ, startDate,</span>
					Employee.DETAIL_LEVEL_EMPLOYEE_BASIC);
<span class="nc" id="L1047">			this.stw.stop();</span>

<span class="nc" id="L1049">			return empColl;</span>
		}

		finally {
<span class="nc" id="L1053">			this.stw.stop();</span>
		}
	}

	private long getDuration(TimeRecordEntry tre, Date startDate, Date endDate, long interval) {
<span class="nc" id="L1058">		long startDateMillis = startDate.getTime();</span>
<span class="nc" id="L1059">		long endDateMillis = endDate.getTime();</span>

<span class="nc" id="L1061">		long treStartMillis = tre.getStartTime().getTime();</span>
<span class="nc" id="L1062">		long treDuration = tre.getSeconds() * 1000;</span>

		// before start time but in the current interval, calculate the duration
<span class="nc bnc" id="L1065" title="All 2 branches missed.">		if (treStartMillis &lt;= startDateMillis) {</span>
<span class="nc" id="L1066">			treDuration -= startDateMillis - treStartMillis;</span>
<span class="nc bnc" id="L1067" title="All 2 branches missed.">		} else if ((treStartMillis + treDuration) &gt; endDateMillis) // after</span>
																	// start
																	// time but
																	// greater
																	// than end
		{
<span class="nc" id="L1073">			treDuration = endDateMillis - treStartMillis;</span>
		}

		// Normalize the duration
<span class="nc bnc" id="L1077" title="All 2 branches missed.">		if (treDuration &gt; interval) {</span>
<span class="nc" id="L1078">			treDuration = interval;</span>
		}

<span class="nc" id="L1081">		return treDuration;</span>
	}

	private class StaffingInfo {
		public Date startDate;
		public Date endDate;
		public Date lastQueryDate;
		public Collection allEmpColl;
		public Collection empColl;
		public Collection dsqColl;
		public Collection dsColl;
		long lookBackDays;
		long empChunkSize;
		Category cat;
		public boolean isUnknownActivity;
<span class="nc" id="L1096">		public boolean computeActual = false;</span>

		// Contains staffing info. The key is QueID and the value is the
		// number of agents
<span class="nc" id="L1100">		HashMap que2Agents = null;</span>

		// Get time records for employees. The hashmap key is the empId and
		// the value is a collection of timerecords
<span class="nc" id="L1104">		java.util.Map hmTR = null;</span>

		// Map of agent count for each media
<span class="nc" id="L1107">		HashMap media2Duration = null;</span>

<span class="nc" id="L1109">		HashMap hmActivities = new HashMap();</span>

<span class="nc" id="L1111">		HashMap hmMedia = new HashMap();</span>

<span class="nc" id="L1113">		HashMap hmActivityQueueHope = new HashMap();</span>

<span class="nc" id="L1115">		java.util.Map hmsaColl = null;</span>

<span class="nc" id="L1117">		Map hmcampColl = null;</span>

<span class="nc" id="L1119">		HashMap hmqsColl = new HashMap();</span>

<span class="nc" id="L1121">		HashMap hmcamQColl = new HashMap();</span>

<span class="nc" id="L1123">		HashMap hmQueObj = new HashMap();</span>

<span class="nc" id="L1125">		HashMap hmdsQue = new HashMap();</span>

<span class="nc" id="L1127">		HashMap hmparQColl = new HashMap();</span>

<span class="nc" id="L1129">		HashMap hmCombinedQue = new HashMap();</span>

<span class="nc" id="L1131">		HashMap hmCCQStaff = null;</span>

		StopWatch stw;

		WorkloadManager wlMgr;
		SkillManager skillMgr;
		CampaignManager cmMgr;
		TimeRecordManager trMgr;
		PeopleFacade pf;
		GroupManager grpMgr;
		QueueGroupManager qgMgr;
		ActivityManager actvMgr;

<span class="nc" id="L1144">		public StaffingInfo(Category category, StopWatch swatch) {</span>
<span class="nc" id="L1145">			this.cat = category;</span>
<span class="nc" id="L1146">			this.stw = swatch;</span>

			try {
<span class="nc" id="L1149">				this.stw.start(&quot;EJB getManagers&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1150">				skillMgr = WfmManagerFactory.getSkillManager();</span>
<span class="nc" id="L1151">				cmMgr = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L1152">				trMgr = WfmManagerFactory.getTimeRecordManager();</span>
<span class="nc" id="L1153">				pf = FacadeManagerFactory.getPeopleFacade();</span>
<span class="nc" id="L1154">				actvMgr = WfmManagerFactory.getActivityManager();</span>
<span class="nc" id="L1155">				grpMgr = BbmManagerFactory.getGroupManager();</span>
<span class="nc" id="L1156">				qgMgr = BbmManagerFactory.getQueueGroupManager();</span>
<span class="nc" id="L1157">				wlMgr = WfmManagerFactory.getWorkloadManager();</span>
<span class="nc" id="L1158">				this.stw.stop();</span>

<span class="nc" id="L1160">			} catch (Exception ex) {</span>
<span class="nc" id="L1161">				this.cat.l7dError(ex.getMessage(), ex);</span>
<span class="nc" id="L1162">			}</span>
<span class="nc" id="L1163">		}</span>

		public void init() {
<span class="nc" id="L1166">			this.media2Duration = new HashMap();</span>
<span class="nc" id="L1167">			this.que2Agents = new HashMap();</span>
<span class="nc" id="L1168">			this.isUnknownActivity = false;</span>
<span class="nc" id="L1169">			this.hmCCQStaff = new HashMap();</span>
<span class="nc" id="L1170">		}</span>

		public void shutdown() {
			try {
<span class="nc bnc" id="L1174" title="All 2 branches missed.">				if (this.trMgr != null)</span>
<span class="nc" id="L1175">					this.trMgr.remove();</span>

<span class="nc bnc" id="L1177" title="All 2 branches missed.">				if (this.cmMgr != null)</span>
<span class="nc" id="L1178">					this.cmMgr.remove();</span>

<span class="nc bnc" id="L1180" title="All 2 branches missed.">				if (this.wlMgr != null)</span>
<span class="nc" id="L1181">					this.wlMgr.remove();</span>

<span class="nc bnc" id="L1183" title="All 2 branches missed.">				if (this.skillMgr != null)</span>
<span class="nc" id="L1184">					this.skillMgr.remove();</span>

<span class="nc bnc" id="L1186" title="All 2 branches missed.">				if (this.pf != null)</span>
<span class="nc" id="L1187">					this.pf.remove();</span>

<span class="nc bnc" id="L1189" title="All 2 branches missed.">				if (this.grpMgr != null)</span>
<span class="nc" id="L1190">					this.grpMgr.remove();</span>

<span class="nc bnc" id="L1192" title="All 2 branches missed.">				if (this.qgMgr != null)</span>
<span class="nc" id="L1193">					this.qgMgr.remove();</span>

<span class="nc bnc" id="L1195" title="All 2 branches missed.">				if (this.actvMgr != null)</span>
<span class="nc" id="L1196">					this.actvMgr.remove();</span>
<span class="nc" id="L1197">			} catch (Exception ex) {</span>
<span class="nc" id="L1198">				this.cat.l7dError(ex.getMessage(), ex);</span>
<span class="nc" id="L1199">			}</span>
<span class="nc" id="L1200">		}</span>

		public void preFetch() throws RemoteException, BbmFinderException, BbmEJBCreateException, FacadeException {
			// Get all managers
<span class="nc" id="L1204">			this.stw.start(&quot;preFetch&quot;);</span>

			try {

<span class="nc" id="L1208">				HashSet campIDs = new HashSet();</span>

<span class="nc" id="L1210">				this.stw.start(&quot;EJB getWorkResourceCampaignAssignments&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1211">				this.hmcampColl = cmMgr.getWorkResourceCampaignAssignments(empColl, startDate, endDate);</span>
<span class="nc" id="L1212">				this.stw.stop();</span>

<span class="nc" id="L1214">				ArrayList empIDCamp = new ArrayList();</span>

<span class="nc" id="L1216">				Collection cqColl = new HashSet();</span>
<span class="nc" id="L1217">				Iterator cmIter = hmcampColl.keySet().iterator();</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">				while (cmIter.hasNext()) {</span>
<span class="nc" id="L1219">					ID empID = (ID) cmIter.next();</span>
<span class="nc" id="L1220">					Collection campColl = (Collection) hmcampColl.get(empID);</span>
<span class="nc bnc" id="L1221" title="All 4 branches missed.">					if (campColl == null || campColl.size() &lt; 1) {</span>
<span class="nc" id="L1222">						this.stw.logDebug(&quot;getQueues(): No campaigns found for empID=&quot; + empID);</span>
<span class="nc" id="L1223">						continue;</span>
					}

<span class="nc" id="L1226">					empIDCamp.add(empID);</span>

					// Get campaign ids
<span class="nc" id="L1229">					Iterator campIter = campColl.iterator();</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">					while (campIter.hasNext()) {</span>
<span class="nc" id="L1231">						CampaignWorkResource cw = (CampaignWorkResource) campIter.next();</span>
<span class="nc" id="L1232">						ID campID = cw.getCampaignID();</span>
<span class="nc" id="L1233">						Campaign camp = cmMgr.getCampaignByID(campID);</span>

<span class="nc bnc" id="L1235" title="All 2 branches missed.">						if (this.hmcamQColl.containsKey(campID))</span>
<span class="nc" id="L1236">							continue;</span>

<span class="nc" id="L1238">						this.stw.start(&quot;EJB getCampaignQueueAssignments&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1239">						Collection coll = cmMgr.getCampaignQueueAssignments(campID, this.startDate, this.endDate);</span>
<span class="nc" id="L1240">						this.stw.stop();</span>

<span class="nc bnc" id="L1242" title="All 4 branches missed.">						if (coll == null || coll.size() &lt;= 0) {</span>
<span class="nc" id="L1243">							this.stw.logDebug(&quot;getQueues(): No queues mapped for campaign=&quot; + campID);</span>
<span class="nc" id="L1244">							continue;</span>
						}

<span class="nc" id="L1247">						TreeSet parQueColl = new TreeSet();</span>

						// update the que/campaign info which is required for
						// combined queue
<span class="nc" id="L1251">						Iterator cqIter = coll.iterator();</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">						while (cqIter.hasNext()) {</span>
<span class="nc" id="L1253">							CampaignQueue cq = (CampaignQueue) cqIter.next();</span>
<span class="nc" id="L1254">							ID queID = cq.getQueueID();</span>

<span class="nc bnc" id="L1256" title="All 2 branches missed.">							if (cq.getSPID().equals(cw.getSPID())) {</span>
<span class="nc" id="L1257">								this.hmCombinedQue.put(queID, cq.getSPID());</span>
<span class="nc" id="L1258">								ID parQueID = this.getParentQueID(queID);</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">								if (parQueID != null)</span>
<span class="nc" id="L1260">									parQueColl.add(parQueID);</span>
							}
<span class="nc" id="L1262">						}</span>

						// update the parent campaign map required for combined
						// distributed queue/campaign
<span class="nc" id="L1266">						ID pCampID = camp.getParentID(); // get parent campaign</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed.">						if (pCampID != null) {</span>
<span class="nc" id="L1268">							Collection pCampQColl = cmMgr.getCampaignQueueAssignments(pCampID, this.startDate,</span>
									this.endDate);
<span class="nc bnc" id="L1270" title="All 4 branches missed.">							if (pCampQColl != null &amp;&amp; pCampQColl.size() &gt; 0) {</span>
<span class="nc" id="L1271">								Iterator pCampQCollIter = pCampQColl.iterator();</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">								while (pCampQCollIter.hasNext()) {</span>
<span class="nc" id="L1273">									CampaignQueue pcq = (CampaignQueue) pCampQCollIter.next();</span>
<span class="nc" id="L1274">									ID parQueID = pcq.getQueueID();</span>
<span class="nc" id="L1275">									ID parSPID = pcq.getSPID();</span>

									// check if queue exists and info not
									// already added to map
<span class="nc bnc" id="L1279" title="All 2 branches missed.">									if (parQueColl.contains(parQueID)) {</span>
<span class="nc" id="L1280">										this.hmCombinedQue.put(parQueID, parSPID);</span>
									}
<span class="nc" id="L1282">								}</span>
							}
						}

<span class="nc" id="L1286">						cqColl.addAll(coll);</span>
<span class="nc" id="L1287">						campIDs.add(cw.getSPID());</span>
<span class="nc" id="L1288">					}</span>
<span class="nc" id="L1289">				}</span>

				// For each queue, check for valid skill &amp; media
<span class="nc" id="L1292">				Collection queIDs = new HashSet();</span>
<span class="nc" id="L1293">				Iterator cqIter = cqColl.iterator();</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">				while (cqIter.hasNext()) {</span>
<span class="nc" id="L1295">					CampaignQueue cq = (CampaignQueue) cqIter.next();</span>
<span class="nc" id="L1296">					ID queID = cq.getQueueID();</span>
<span class="nc" id="L1297">					ID campID = cq.getCampaignID();</span>

					// remove queues that are not mapped to the data source
<span class="nc bnc" id="L1300" title="All 2 branches missed.">					if (!this.dsqColl.contains(queID)) {</span>
<span class="nc" id="L1301">						this.stw.logDebug(&quot;getQueues(): Queue=&quot; + queID + &quot; not mapped to a datasource &quot;);</span>
<span class="nc" id="L1302">						continue;</span>
					}

<span class="nc" id="L1305">					Collection queColl = (Collection) this.hmcamQColl.get(campID);</span>
<span class="nc bnc" id="L1306" title="All 2 branches missed.">					if (queColl == null) {</span>
<span class="nc" id="L1307">						queColl = new HashSet();</span>
<span class="nc" id="L1308">						this.hmcamQColl.put(campID, queColl);</span>
					}
<span class="nc" id="L1310">					queColl.add(queID);</span>

<span class="nc bnc" id="L1312" title="All 2 branches missed.">					if (!this.hmqsColl.containsKey(queID)) {</span>
<span class="nc" id="L1313">						queIDs.add(queID);</span>
					}

<span class="nc" id="L1316">				}</span>

<span class="nc bnc" id="L1318" title="All 2 branches missed.">				if (queIDs.size() &gt; 0) {</span>
<span class="nc" id="L1319">					this.stw.start(&quot;EJB getLinkedSkillIDsForQueues&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1320">					Map&lt;ID, List&lt;QueueSkill&gt;&gt; hmqs = wlMgr.getLinkedSkillIDsForQueues(queIDs, campIDs);</span>
<span class="nc" id="L1321">					this.stw.stop();</span>

<span class="nc" id="L1323">					this.hmqsColl.putAll(hmqs);</span>

<span class="nc" id="L1325">					this.getQueues(queIDs);</span>
<span class="nc" id="L1326">					this.getParentQueIds(queIDs);</span>
				}

<span class="nc bnc" id="L1329" title="All 2 branches missed.">				if (empIDCamp.size() &gt; 0) {</span>
<span class="nc" id="L1330">					this.stw.start(&quot;EJB getEventsForWorkResourceFromCache&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1331">					this.hmTR = trMgr.getEventsForWorkResourceFromCache(empIDCamp, startDate, endDate, true);</span>
<span class="nc" id="L1332">					this.stw.stop();</span>

					// Get the list of assigned skills for the employee
<span class="nc" id="L1335">					this.stw.start(&quot;EJB getSkillAssignments&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1336">					this.hmsaColl = skillMgr.getSkillAssignments(empIDCamp, startDate, endDate);</span>
<span class="nc" id="L1337">					this.stw.stop();</span>
				} else {
<span class="nc" id="L1339">					this.hmTR = Collections.emptyMap();</span>
<span class="nc" id="L1340">					this.hmsaColl = Collections.emptyMap();</span>
				}
			}

			finally {
<span class="nc" id="L1345">				this.stw.stop();</span>
<span class="nc" id="L1346">			}</span>
<span class="nc" id="L1347">		}</span>

		public Collection getParentQueIds(Collection queIDs) throws RemoteException, BbmFinderException,
				BbmEJBCreateException {
<span class="nc" id="L1351">			ArrayList retVal = new ArrayList();</span>

			// list that holds all parentqueues not found
<span class="nc" id="L1354">			ArrayList pqIds = new ArrayList();</span>

<span class="nc" id="L1356">			Collection queColl = this.getQueues(queIDs);</span>
<span class="nc" id="L1357">			Iterator iter = queColl.iterator();</span>
<span class="nc bnc" id="L1358" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L1359">				Queue que = (Queue) iter.next();</span>
<span class="nc" id="L1360">				ID id = que.getParentID();</span>

<span class="nc bnc" id="L1362" title="All 2 branches missed.">				if (id != null) {</span>
<span class="nc" id="L1363">					retVal.add(id);</span>
<span class="nc" id="L1364">					this.hmparQColl.put(que.getID(), id);</span>

					// if this que is not in the global list, fetch it later
<span class="nc bnc" id="L1367" title="All 2 branches missed.">					if (this.hmQueObj.get(id) == null) {</span>
<span class="nc" id="L1368">						pqIds.add(id);</span>
					}
				}
<span class="nc" id="L1371">			}</span>

<span class="nc bnc" id="L1373" title="All 2 branches missed.">			if (pqIds.size() &gt; 0) {</span>
				// this will fetch the missing queues and update the global list
<span class="nc" id="L1375">				this.getQueues(pqIds);</span>
			}

<span class="nc" id="L1378">			return retVal;</span>
		}

		public Collection getQueues(Collection queIDs) throws RemoteException, BbmFinderException,
				BbmEJBCreateException {
<span class="nc" id="L1383">			ArrayList retVal = new ArrayList();</span>
<span class="nc" id="L1384">			HashSet mQueIds = new HashSet();</span>

<span class="nc" id="L1386">			Iterator queIter = queIDs.iterator();</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">			while (queIter.hasNext()) {</span>
<span class="nc" id="L1388">				ID id = (ID) queIter.next();</span>
<span class="nc" id="L1389">				Queue que = (Queue) this.hmQueObj.get(id);</span>
<span class="nc bnc" id="L1390" title="All 2 branches missed.">				if (que == null) {</span>
<span class="nc" id="L1391">					mQueIds.add(id);</span>
				} else {
<span class="nc" id="L1393">					retVal.add(que);</span>
				}
<span class="nc" id="L1395">			}</span>

<span class="nc bnc" id="L1397" title="All 2 branches missed.">			if (mQueIds.size() &gt; 0) {</span>
<span class="nc" id="L1398">				this.stw.start(&quot;EJB getQueuesByIDs&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1399">				Collection coll = wlMgr.getQueuesByIDs(mQueIds);</span>
<span class="nc" id="L1400">				this.stw.stop();</span>

<span class="nc bnc" id="L1402" title="All 2 branches missed.">				if (coll != null) {</span>
<span class="nc" id="L1403">					Iterator collIter = coll.iterator();</span>
<span class="nc bnc" id="L1404" title="All 2 branches missed.">					while (collIter.hasNext()) {</span>
<span class="nc" id="L1405">						Queue que = (Queue) collIter.next();</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">						if (que != null) {</span>
<span class="nc" id="L1407">							this.hmQueObj.put(que.getID(), que);</span>
<span class="nc" id="L1408">							retVal.add(que);</span>
						}
<span class="nc" id="L1410">					}</span>
				}
			}

<span class="nc" id="L1414">			return retVal;</span>
		}

		public ID getParentQueID(ID queID) {
<span class="nc" id="L1418">			return (ID) this.hmparQColl.get(queID);</span>
		}

		public Collection getMedia(ID id) throws RemoteException, BbmFinderException, BbmEJBCreateException {
<span class="nc" id="L1422">			this.stw.start(&quot;getMedia&quot;);</span>

			try {
<span class="nc" id="L1425">				Collection obj = (Collection) this.hmMedia.get(id);</span>
<span class="nc bnc" id="L1426" title="All 2 branches missed.">				if (obj == null) {</span>
<span class="nc" id="L1427">					this.stw.start(&quot;EJB findMediaForActivity&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1428">					obj = actvMgr.findMediaForActivity(id);</span>
<span class="nc" id="L1429">					this.stw.stop();</span>

<span class="nc" id="L1431">					this.hmMedia.put(id, obj);</span>
				}
<span class="nc" id="L1433">				return obj;</span>
			}

			finally {
<span class="nc" id="L1437">				this.stw.stop();</span>
			}
		}

		public Collection getActivityQueueHope(ID id) throws RemoteException, BbmFinderException, BbmEJBCreateException {
<span class="nc" id="L1442">			this.stw.start(&quot;getMedia&quot;);</span>

			try {
<span class="nc" id="L1445">				Collection obj = (Collection) this.hmActivityQueueHope.get(id);</span>
<span class="nc bnc" id="L1446" title="All 2 branches missed.">				if (obj == null) {</span>
<span class="nc" id="L1447">					this.stw.start(&quot;EJB findQueueForActivity&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1448">					obj = actvMgr.findQueueForActivity(id);</span>
<span class="nc" id="L1449">					this.stw.stop();</span>

<span class="nc" id="L1451">					this.hmActivityQueueHope.put(id, obj);</span>
				}
<span class="nc" id="L1453">				return obj;</span>
			}

			finally {
<span class="nc" id="L1457">				this.stw.stop();</span>
			}
		}

		public Activity getActivity(ID id) throws RemoteException, BbmFinderException, BbmEJBCreateException {
<span class="nc" id="L1462">			this.stw.start(&quot;getActivity&quot;);</span>

			try {
<span class="nc" id="L1465">				Activity obj = (Activity) this.hmActivities.get(id);</span>
<span class="nc bnc" id="L1466" title="All 2 branches missed.">				if (obj == null) {</span>
<span class="nc" id="L1467">					this.stw.start(&quot;EJB findActivityById&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1468">					obj = actvMgr.findActivityById(id);</span>
<span class="nc" id="L1469">					this.stw.stop();</span>

<span class="nc" id="L1471">					this.hmActivities.put(id, obj);</span>
				}
<span class="nc" id="L1473">				return obj;</span>
			}

			finally {
<span class="nc" id="L1477">				this.stw.stop();</span>
			}
		}

		// get the collection of que id's associated to the datasource id's
		public Collection getDatasource2Queues(Collection dsColl) throws RemoteException, BbmFinderException,
				BbmEJBCreateException {
<span class="nc" id="L1484">			this.stw.start(&quot;getDatasource2Queues&quot;);</span>

			try {
<span class="nc" id="L1487">				HashSet retVal = new HashSet(); // use Set to avoid duplicates</span>

<span class="nc bnc" id="L1489" title="All 4 branches missed.">				if (dsColl == null || dsColl.size() == 0)</span>
<span class="nc" id="L1490">					return retVal;</span>

				// For each datasource get groups and for each group
				// get the associated queues
<span class="nc" id="L1494">				Iterator dsIter = dsColl.iterator();</span>
<span class="nc bnc" id="L1495" title="All 2 branches missed.">				while (dsIter.hasNext()) {</span>
<span class="nc" id="L1496">					ID dsID = (ID) dsIter.next();</span>

<span class="nc" id="L1498">					Collection queColl = (Collection) this.hmdsQue.get(dsID);</span>
<span class="nc bnc" id="L1499" title="All 2 branches missed.">					if (queColl != null) {</span>
<span class="nc" id="L1500">						retVal.addAll(queColl);</span>
<span class="nc" id="L1501">						continue;</span>
					}

					// Get groups for the datasource
<span class="nc" id="L1505">					this.stw.start(&quot;EJB getGroupsByDatasource&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1506">					Collection grpColl = grpMgr.getGroupsByDatasource(dsID);</span>
<span class="nc" id="L1507">					this.stw.stop();</span>

<span class="nc bnc" id="L1509" title="All 4 branches missed.">					if (grpColl != null &amp;&amp; grpColl.size() &gt; 0) {</span>
<span class="nc" id="L1510">						Collection qgList = new HashSet();</span>
<span class="nc" id="L1511">						Iterator grpIter = grpColl.iterator();</span>
<span class="nc bnc" id="L1512" title="All 2 branches missed.">						while (grpIter.hasNext()) {</span>
<span class="nc" id="L1513">							Group grp = (Group) grpIter.next();</span>

							// Get the queues for this group
<span class="nc" id="L1516">							this.stw.start(&quot;EJB getLinkedQueueIDsForGroup&quot;, StaffingCalculator.ejbTrace);</span>
<span class="nc" id="L1517">							Collection qgColl = qgMgr.getLinkedQueueIDsForGroup(grp.getID());</span>
<span class="nc" id="L1518">							this.stw.stop();</span>

<span class="nc bnc" id="L1520" title="All 4 branches missed.">							if (qgColl != null &amp;&amp; qgColl.size() &gt; 0) {</span>
<span class="nc" id="L1521">								qgList.addAll(qgColl); // add all queues, Set</span>
														// will eliminate
														// duplicates
							} else {

<span class="nc" id="L1526">								this.stw.logDebug(&quot;getDatasource2Queues(): Could not find queue mapping for groupId=&quot;</span>
<span class="nc" id="L1527">										+ grp.getID());</span>
							}
<span class="nc" id="L1529">						}</span>

<span class="nc" id="L1531">						Collection parQueColl = this.getParentQueIds(qgList);</span>
<span class="nc" id="L1532">						qgList.addAll(parQueColl);</span>

<span class="nc" id="L1534">						this.hmdsQue.put(dsID, qgList);</span>
<span class="nc" id="L1535">						retVal.addAll(qgList);</span>

<span class="nc" id="L1537">						this.stw.logDebug(&quot;getDatasource2Queues(): Found the following queues for dsID=&quot;</span>
<span class="nc" id="L1538">								+ dsID.toString() + &quot; queues=&quot; + qgList.toString());</span>

<span class="nc" id="L1540">					} else {</span>

<span class="nc" id="L1542">						this.stw.logDebug(&quot;getDatasource2Queues(): Could not find groups for dsId=&quot; + dsID);</span>
					}
<span class="nc" id="L1544">				}</span>

<span class="nc" id="L1546">				return retVal;</span>
			}

			finally {
<span class="nc" id="L1550">				this.stw.stop();</span>
			}

		}
	}

<span class="nc" id="L1556">	private class StaffingData implements Comparable</span>

	{
		ID queID;
		ID empID;
		Long duration;

		public int hashCode() {
<span class="nc bnc" id="L1564" title="All 2 branches missed.">			return empID != null ? empID.hashCode() : super.hashCode();</span>
		}

		public boolean equals(Object obj) {
<span class="nc" id="L1568">			StaffingData sd = (StaffingData) obj;</span>

<span class="nc bnc" id="L1570" title="All 2 branches missed.">			return this.empID == null ? false : this.empID.equals(sd.empID);</span>
		}

		public int compareTo(Object obj) {
<span class="nc" id="L1574">			StaffingData sd = (StaffingData) obj;</span>

<span class="nc bnc" id="L1576" title="All 2 branches missed.">			if (this.empID == null)</span>
<span class="nc" id="L1577">				return 1;</span>

<span class="nc bnc" id="L1579" title="All 2 branches missed.">			if (sd.empID == null)</span>
<span class="nc" id="L1580">				return -1;</span>

<span class="nc" id="L1582">			return this.empID.compareTo(sd.empID);</span>
		}

		public String toString() {
<span class="nc" id="L1586">			StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L1587">			buf.append(&quot;[emp=&quot;);</span>
<span class="nc" id="L1588">			buf.append(this.empID);</span>
<span class="nc" id="L1589">			buf.append(&quot; que=&quot;);</span>
<span class="nc" id="L1590">			buf.append(this.queID);</span>
<span class="nc" id="L1591">			buf.append(&quot; dur=&quot;);</span>
<span class="nc" id="L1592">			buf.append(this.duration);</span>
<span class="nc" id="L1593">			buf.append(&quot;]&quot;);</span>

<span class="nc" id="L1595">			return buf.toString();</span>
		}
	}

	private class CompoundKey {
		private ID key1;
		private ID key2;

<span class="nc" id="L1603">		public CompoundKey(ID k1, ID k2) {</span>
<span class="nc" id="L1604">			key1 = k1;</span>
<span class="nc" id="L1605">			key2 = k2;</span>
<span class="nc" id="L1606">		}</span>

		public ID getKey1() {
<span class="nc" id="L1609">			return key1;</span>
		}

		public ID getKey2() {
<span class="nc" id="L1613">			return key2;</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>