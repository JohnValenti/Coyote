<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.campaign.ejb</a> &gt; <span class="el_source">CampaignManagerEJB.java</span></div><h1>CampaignManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.campaign.ejb;

import java.rmi.RemoteException;
import java.text.MessageFormat;
import java.util.*;
import javax.naming.Context;
import javax.naming.InitialContext;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.PaginationPair;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoDuplicateKeyException;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.localization.LocaleContext;
import com.bluepumpkin.common.localization.LocalizationManager;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.CollectionUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.am.ops.gcr.LSGInfoExtractor;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.ActivitySPResourceConstraint;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.activity.model.EventUtils;
import com.bluepumpkin.ejb.bbm.base.*;
import com.bluepumpkin.ejb.bbm.campaign.model.*;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.dao.MapUtil;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.ObjectType;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.SystemType;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriodUtil;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.BbmScheduleConflictException;
import com.bluepumpkin.ejb.bbm.timeseries.ejb.TimeSeriesManager;
import com.bluepumpkin.ejb.bbm.timeseries.model.RequireTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.util.MonthlySPUtil;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.vo.HOOPeriod;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.QueueDAO;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTemplate;
import com.bluepumpkin.ejb.bbm.workresource.model.Phantom;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.verint.ejb.bbm.forecast.ejb.ForecastTimeSeriesManager;
import com.verint.ejb.bbm.forecast.model.ForecastProfileProject;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.gcr.ejb.GCRManager;
import com.witness.ejb.core.gcr.model.GCREntry;

<span class="fc" id="L66">public class CampaignManagerEJB extends SessionEJBBase {</span>

	private static final long serialVersionUID = 1L;

<span class="fc" id="L70">	private static Category LOG = Log.initCategory(CampaignManagerEJB.class.getName());</span>

	private WorkResourceManager m_workResourceManager;
	private WorkloadManager m_workloadManager;
	private ScheduleAccessManager m_scheduleAccessManager;
	private ForecastTimeSeriesManager forecastTimeSeriesManager;
	private CampaignManager campaignManager;
<span class="fc" id="L77">	private boolean m_isWhatIf = false;</span>

	@Override
	public void onEjbCreate() {
		try {
			// First query environment to get WIF setting from DD
<span class="fc" id="L83">			Context initialContext = new InitialContext();</span>
<span class="fc" id="L84">			Boolean WIF = (Boolean) initialContext.lookup(&quot;java:comp/env/WIF&quot;);</span>
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">			if (WIF != null) {</span>
<span class="fc" id="L86">				m_isWhatIf = WIF.booleanValue();</span>
			}

<span class="fc" id="L89">			m_workloadManager = WfmManagerFactory.getWorkloadManager(m_isWhatIf);</span>
<span class="fc" id="L90">			m_workResourceManager = BbmManagerFactory.getWorkResourceManager(m_isWhatIf);</span>
<span class="fc" id="L91">			m_scheduleAccessManager = WfmManagerFactory.getScheduleAccessManager(m_isWhatIf);</span>
<span class="fc" id="L92">			forecastTimeSeriesManager = WfmManagerFactory.getForecastTimeSeriesManager(m_isWhatIf);</span>
<span class="fc" id="L93">			campaignManager = WfmManagerFactory.getCampaignManager(m_isWhatIf);</span>
<span class="nc" id="L94">		} catch (Exception e) {</span>
<span class="nc" id="L95">			handleException(&quot;onEjbCreate&quot;, e, false);</span>
<span class="fc" id="L96">		}</span>
<span class="fc" id="L97">	}</span>

	/**
	 * override the base class to provide the appropriate logging category
	 */
	@Override
	protected Category getCategory() {
<span class="fc" id="L104">		return LOG;</span>
	}
	{
<span class="fc" id="L107">		super.init(CampaignManagerEJB.class.getName());</span>
<span class="fc" id="L108">	}</span>

	/**
	 * get campaign object given its SID
	 */
	public Campaign getCampaignByID(ID id) throws BbmObjectNotFoundException, BbmFinderException {
<span class="fc" id="L114">		methodStart(&quot;getCampaignByID&quot;, id);</span>
<span class="fc" id="L115">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="fc" id="L117">			ArrayList&lt;ID&gt; aIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L118">			aIDs.add(id);</span>
<span class="fc" id="L119">			Collection&lt;Campaign&gt; cpgCol = dao.getCampaign(aIDs, false);</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">			if (cpgCol.isEmpty()) {</span>
<span class="nc" id="L121">				return null;</span>
			}
<span class="fc" id="L123">			return cpgCol.iterator().next();</span>
<span class="nc" id="L124">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L125">			handleException(e, false);</span>
			// no rollback, since finder not support transaction
<span class="nc" id="L127">			throw e;</span>
<span class="nc" id="L128">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L129">			handleException(e, false);</span>
<span class="nc" id="L130">			throw e;</span>
		} finally {
<span class="pc" id="L132">			dao.cleanUp();</span>
<span class="pc" id="L133">			methodFinish();</span>
		}
	}

	public ID getCampaignIDByName(String name) throws BbmFinderException {
<span class="nc" id="L138">		methodStart(&quot;getQueueIDByName&quot;, name);</span>
		try {
<span class="nc" id="L140">			return CampaignDAO.getCampaignIDByName(name);</span>
<span class="nc" id="L141">		} catch (JdmoException e) {</span>
<span class="nc" id="L142">			handleException(e, false);</span>
<span class="nc" id="L143">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L145">			methodFinish();</span>
		}
	}

	/**
	 * get campaign object given the combined queue id
	 */
	public Campaign getCampaignByCombinedQueueID(ID idCombinedQueue) throws BbmObjectNotFoundException, BbmFinderException {
<span class="nc" id="L153">		methodStart(&quot;getCampaignByCombinedQueueID&quot;, idCombinedQueue);</span>
<span class="nc" id="L154">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="nc" id="L156">			return dao.getCampaignByCombinedQueueID(idCombinedQueue);</span>
<span class="nc" id="L157">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L158">			handleException(e, false);</span>
			// no rollback, since finder not support transaction
<span class="nc" id="L160">			throw e;</span>
<span class="nc" id="L161">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L162">			handleException(e, false);</span>
<span class="nc" id="L163">			throw e;</span>
		} finally {
<span class="nc" id="L165">			dao.cleanUp();</span>
<span class="nc" id="L166">			methodFinish();</span>
		}
	}

	/**
	 * get campaigns given their SIDs
	 */
	public Collection&lt;Campaign&gt; getCampaignsByIDs(Collection&lt;ID&gt; campaignSIDs) throws BbmFinderException {
<span class="fc" id="L174">		methodStart(&quot;getCampaignByIDs&quot;, campaignSIDs);</span>
<span class="fc" id="L175">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="fc" id="L177">			return dao.getCampaign(campaignSIDs, false);</span>
<span class="nc" id="L178">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L179">			handleException(e, false);</span>
			// no rollback, since finder not support transaction
<span class="nc" id="L181">			throw e;</span>
<span class="nc" id="L182">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L183">			handleException(e, false);</span>
<span class="nc" id="L184">			throw e;</span>
		} finally {
<span class="pc" id="L186">			dao.cleanUp();</span>
<span class="pc" id="L187">			methodFinish();</span>
		}
	}

	public Map&lt;ID, Integer&gt; getCampaignSIDAttachedSchedulingPeriodCountMap(Collection&lt;ID&gt; campaignSIDs)
			throws BbmFinderException {
<span class="fc" id="L193">		methodStart(&quot;getCampaignIDAttachedSchedulingPeriodCountMap&quot;, campaignSIDs);</span>
<span class="fc" id="L194">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="fc" id="L196">			return dao.getCampaignIDAttachedSchedulingPeriodCountMap(campaignSIDs);</span>
<span class="nc" id="L197">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L198">			handleException(e, false);</span>
<span class="nc" id="L199">			throw e;</span>
		} finally {
<span class="pc" id="L201">			dao.cleanUp();</span>
<span class="pc" id="L202">			methodFinish();</span>
		}
	}

	public Map&lt;ID, ActivitySPResourceConstraint&gt; getActivitySPResourceConstraintMap(ID schedulingPeriodSID)
			throws BbmFinderException {
<span class="nc" id="L208">		methodStart(&quot;getActivitySPResourceConstraintsBySP&quot;, schedulingPeriodSID);</span>
<span class="nc" id="L209">		ActivitySPResourceConstraintDAO dao = new ActivitySPResourceConstraintDAO();</span>
		try {
<span class="nc" id="L211">			List&lt;ActivitySPResourceConstraint&gt; constraints = dao.getActivitySPResourceConstraintsBySP(schedulingPeriodSID);</span>
<span class="nc" id="L212">			Map&lt;ID, ActivitySPResourceConstraint&gt; results = new HashMap&lt;ID, ActivitySPResourceConstraint&gt;();</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">			for (ActivitySPResourceConstraint constraint : constraints) {</span>
<span class="nc" id="L214">				results.put(constraint.getActivityID(), constraint);</span>
<span class="nc" id="L215">			}</span>
<span class="nc" id="L216">			return results;</span>

<span class="nc" id="L218">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L219">			handleException(e, false);</span>
<span class="nc" id="L220">			throw e;</span>
		} finally {
<span class="nc" id="L222">			dao.cleanUp();</span>
<span class="nc" id="L223">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; createActivitySPResourceConstraints(
			List&lt;ActivitySPResourceConstraint&gt; newActivitySPResourceConstraints) throws BbmCreateException,
			BbmCreateDuplicateKeyException {
<span class="nc" id="L230">		methodStart(&quot;createActivitySPResourceConstraints&quot;, newActivitySPResourceConstraints);</span>
<span class="nc" id="L231">		ActivitySPResourceConstraintDAO dao = new ActivitySPResourceConstraintDAO();</span>
		try {
<span class="nc" id="L233">			return dao.createObjects(newActivitySPResourceConstraints);</span>
<span class="nc" id="L234">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L235">			handleException(e); // log and rollback transaction</span>
<span class="nc" id="L236">			throw e;</span>
		} finally {
<span class="nc" id="L238">			dao.cleanUp();</span>
<span class="nc" id="L239">			methodFinish();</span>
		}
	}

	public void updateActivitySPResourceConstraints(List&lt;ActivitySPResourceConstraint&gt; activitySPResourceConstraints)
			throws BbmUpdateException, MultiUserException {
<span class="nc" id="L245">		methodStart(&quot;updateActivitySPResourceConstraints&quot;, activitySPResourceConstraints);</span>
<span class="nc" id="L246">		ActivitySPResourceConstraintDAO dao = new ActivitySPResourceConstraintDAO();</span>
		try {
<span class="nc" id="L248">			dao.updateObjects(activitySPResourceConstraints);</span>
<span class="nc" id="L249">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L250">			handleException(e);</span>
<span class="nc" id="L251">			throw e;</span>
<span class="nc" id="L252">		} catch (MultiUserException e) {</span>
<span class="nc" id="L253">			handleException(e);</span>
<span class="nc" id="L254">			throw e;</span>
		} finally {
<span class="nc" id="L256">			dao.cleanUp();</span>
<span class="nc" id="L257">			methodFinish();</span>
<span class="nc" id="L258">		}</span>
<span class="nc" id="L259">	}</span>

	/**
	 * get all campaigns
	 */
	public Collection&lt;Campaign&gt; getCampaigns() throws BbmFinderException {
<span class="fc" id="L265">		methodStart(&quot;getCampaigns&quot;);</span>
<span class="fc" id="L266">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="fc" id="L268">			return dao.getCampaign(null, false);</span>
<span class="nc" id="L269">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L270">			handleException(e, false);</span>
<span class="nc" id="L271">			throw e;</span>
		} finally {
<span class="pc" id="L273">			dao.cleanUp();</span>
<span class="pc" id="L274">			methodFinish();</span>
		}
	}

	/**
	 * insert a campaign object into database
	 */
	public ID createCampaign(Campaign objValue) throws BbmCreateException, BbmCreateDuplicateKeyException {
<span class="fc" id="L282">		methodStart(&quot;createCampaign&quot;);</span>
<span class="fc" id="L283">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="fc" id="L285">			return dao.createCampaign(objValue);</span>
<span class="nc" id="L286">		} catch (JdmoDuplicateKeyException e) {</span>
<span class="nc" id="L287">			handleException(e, false); // log but don't rollback transaction</span>
<span class="nc" id="L288">			throw new BbmCreateDuplicateKeyException(e);</span>
<span class="nc" id="L289">		} catch (JdmoException e) {</span>
<span class="nc" id="L290">			handleException(e, false); // log but don't rollback transaction</span>
<span class="nc" id="L291">			throw new BbmCreateException(e);</span>
		} finally {
<span class="pc" id="L293">			dao.cleanUp();</span>
<span class="pc" id="L294">			methodFinish();</span>
		}
	}

	public ID createCampaign(Campaign campaign, SystemType externalSystemType) throws BbmCreateException,
			BbmCreateDuplicateKeyException {

<span class="nc" id="L301">		methodStart(&quot;createCampaign&quot;);</span>
		try {
<span class="nc" id="L303">			ID campaignSID = createCampaign(campaign);</span>
<span class="nc" id="L304">			campaign.setID(campaignSID);</span>
<span class="nc" id="L305">			boolean insert = true;</span>
<span class="nc" id="L306">			MapUtil.setWfoToExternalID(externalSystemType, ObjectType.Campaign, campaign.getID(), campaign.getExternalID(),</span>
					new Jdmo(true), insert);
<span class="nc" id="L308">			return campaignSID;</span>
<span class="nc" id="L309">		} catch (BbmCreateException e) { // from createCampaign(campaign);</span>
<span class="nc" id="L310">			handleException(e); // log and rollback transaction</span>
<span class="nc" id="L311">			throw e;</span>
<span class="nc" id="L312">		} catch (JdmoException e) { // from mapUtil</span>
<span class="nc" id="L313">			handleException(e); // log and rollback transaction</span>
<span class="nc" id="L314">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L316">			methodFinish();</span>
		}

	}

	/**
	 * Warning: Identity based on SID not ID
	 */
	public void updateCampaigns(Collection&lt;Campaign&gt; campaignCol) throws BbmUpdateException {
<span class="nc" id="L325">		methodStart(&quot;updateCampaigns&quot;);</span>
<span class="nc" id="L326">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="nc" id="L328">			dao.updateCampaigns(campaignCol);</span>
<span class="nc" id="L329">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L330">			handleException(e);</span>
<span class="nc" id="L331">			throw e;</span>
		} finally {
<span class="nc" id="L333">			dao.cleanUp();</span>
<span class="nc" id="L334">			methodFinish();</span>
<span class="nc" id="L335">		}</span>
<span class="nc" id="L336">	}</span>

	public void matchCampaignWithExternalID(Campaign objValue, SystemType externalSystemType, ID campaignExternalID)
			throws RemoteException, BbmUpdateException {
<span class="nc" id="L340">		methodStart(&quot;matchCampaignWithExternalID&quot;, objValue, externalSystemType, campaignExternalID);</span>

		// validate
<span class="nc bnc" id="L343" title="All 2 branches missed.">		if (externalSystemType == null) {</span>
<span class="nc" id="L344">			throw new BbmUpdateException(&quot;externalSystemType is null&quot;);</span>
		}
<span class="nc bnc" id="L346" title="All 2 branches missed.">		if (campaignExternalID == null) {</span>
<span class="nc" id="L347">			throw new BbmUpdateException(&quot;externalSourceId is null&quot;);</span>
		}
<span class="nc bnc" id="L349" title="All 4 branches missed.">		if ((campaignExternalID.isInt() &amp;&amp; !externalSystemType.isExtIdAnInt)) {</span>
<span class="nc" id="L350">			throw new BbmUpdateException(&quot;For this external system, externalSourceId must be a string not an integer&quot;);</span>
		}
<span class="nc bnc" id="L352" title="All 4 branches missed.">		if ((!campaignExternalID.isInt() &amp;&amp; externalSystemType.isExtIdAnInt)) {</span>
<span class="nc" id="L353">			throw new BbmUpdateException(&quot;For this external system, externalSourceId must be an integer not a string&quot;);</span>
		}

		// match external id for campaign
		try {
<span class="nc" id="L358">			boolean insert = true;</span>
<span class="nc" id="L359">			MapUtil.setWfoToExternalID(externalSystemType, ObjectType.Campaign, objValue.getID(), campaignExternalID,</span>
					new Jdmo(true), insert);
<span class="nc" id="L361">		} catch (JdmoException e) {</span>
<span class="nc" id="L362">			handleException(e);</span>
<span class="nc" id="L363">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L365">			methodFinish();</span>
<span class="nc" id="L366">		}</span>

<span class="nc" id="L368">	}</span>

	/**
	 * get an given campaign's organization assignments
	 *
	 * @return a collection of CampaignOrg objects which hold the assignment
	 * information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;CampaignOrg&gt; getCampaignOrgAssignments(ID idCampaign, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L379">		methodStart(&quot;getCampaignOrgAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L380">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="fc" id="L382">			return dao.getCampaignOrgAssignments(idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L383">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L384">			handleException(e, false);</span>
<span class="nc" id="L385">			throw e;</span>
		} finally {
<span class="pc" id="L387">			dao.cleanUp();</span>
<span class="pc" id="L388">			methodFinish();</span>
		}
	}

	/**
	 * get campaign org assignment given its id
	 */
	public CampaignOrg getCampaignOrgAssignmentByID(ID idAssignment) throws BbmObjectNotFoundException, BbmFinderException {
<span class="nc" id="L396">		methodStart(&quot;getCampaignOrgAssignmentByID&quot;, idAssignment);</span>
<span class="nc" id="L397">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="nc" id="L399">			return dao.getCampaignOrgAssignmentByID(idAssignment);</span>
<span class="nc" id="L400">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L401">			handleException(e, false);</span>
<span class="nc" id="L402">			throw e;</span>
<span class="nc" id="L403">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L404">			handleException(e, false);</span>
<span class="nc" id="L405">			throw e;</span>
		} finally {
<span class="nc" id="L407">			dao.cleanUp();</span>
<span class="nc" id="L408">			methodFinish();</span>
		}
	}

	/**
	 * Given a collection of orgIDs, return all campaign IDs linked to any of
	 * those orgs, for any time period.
	 */
	public Collection&lt;ID&gt; getAllCampaignIDsLinkedToOrgs(Collection orgIDs) throws BbmFinderException {
<span class="nc" id="L417">		methodStart(&quot;getAllCampaignIDsLinkedToOrgs&quot;, orgIDs);</span>
<span class="nc" id="L418">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="nc" id="L420">			return dao.getAllCampaignIDsLinkedToOrgs(orgIDs);</span>
<span class="nc" id="L421">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L422">			handleException(e, false);</span>
<span class="nc" id="L423">			throw e;</span>
		} finally {
<span class="nc" id="L425">			dao.cleanUp();</span>
<span class="nc" id="L426">			methodFinish();</span>
		}
	}

	/**
	 * create a list of campaign organization assignments
	 *
	 * @return a list of ids of the created objects, if failed in creation of
	 * any object, raise exception
	 */
	public Collection&lt;ID&gt; createCampaignOrgAssignments(Collection&lt;CampaignOrg&gt; colAssignments) throws BbmCreateException {
<span class="nc" id="L437">		methodStart(&quot;createCampaignOrgAssignments&quot;, colAssignments);</span>
<span class="nc" id="L438">		ArrayList&lt;ID&gt; arrResult = new ArrayList&lt;ID&gt;();</span>

<span class="nc" id="L440">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="nc" id="L442">			Iterator&lt;CampaignOrg&gt; it = colAssignments.iterator();</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">			while (it.hasNext()) {</span>
<span class="nc" id="L444">				arrResult.add(dao.createCampaignOrgAssignment(it.next()));</span>
			}
<span class="nc" id="L446">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L447">			handleException(e);</span>
<span class="nc" id="L448">			throw e;</span>
		} finally {
<span class="nc" id="L450">			dao.cleanUp();</span>
<span class="nc" id="L451">			methodFinish();</span>
<span class="nc" id="L452">		}</span>

<span class="nc" id="L454">		return arrResult;</span>
	}

	/**
	 * return a list of skill Names associated with a spqueue
	 */
	public Collection&lt;String&gt; getSkillNamesMappedToQueue(ID idQueue, ID spID) throws BbmFinderException {
<span class="nc" id="L461">		methodStart(&quot;getSkillNamesMappedToQueue&quot;);</span>
<span class="nc" id="L462">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L464">			return dao.getSkillNamesMappedToQueue(idQueue, spID);</span>
		} finally {
<span class="nc" id="L466">			dao.cleanUp();</span>
<span class="nc" id="L467">			methodFinish();</span>
		}
	}

	/**
	 * Given an SP ID, return a Map that maps each queue SID to its skill SID.
	 * If the SP has a queue that is not linked to a skill, then the queue is
	 * not included in the map. We assume that an SP queue can only be linked to
	 * a single skill.
	 *
	 * @param spID - the SID of the scheduling period.
	 * @return A Map that maps each queue SID to its skill SID.
	 * @throws BbmFinderException TODO: change this to return Map&lt;ID, ID&gt; not HashMap&lt;ID, ID&gt;
	 */
	public HashMap&lt;ID, ID&gt; getQueueIDToSkillMap(ID spID) throws BbmFinderException {
<span class="fc" id="L482">		methodStart(&quot;getQueueIDToSkillMap&quot;);</span>
<span class="fc" id="L483">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {

<span class="fc" id="L486">			Map&lt;ID, ID&gt; queueIDToSkillMap = dao.getQueueIDToSkillMap(spID);</span>
<span class="fc" id="L487">			return new HashMap&lt;ID, ID&gt;(queueIDToSkillMap); // TODo remove when</span>
			// signature changed
		} finally {
<span class="pc" id="L490">			dao.cleanUp();</span>
<span class="pc" id="L491">			methodFinish();</span>
		}
	}

	/**
	 * save a campaign's organization assignment
	 */
	public void updateCampaignOrgAssignment(CampaignOrg objValue) throws MultiUserException, BbmUpdateException {
<span class="nc" id="L499">		methodStart(&quot;updateCampaignOrgAssignment&quot;, objValue);</span>
<span class="nc" id="L500">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="nc" id="L502">			dao.updateCampaignOrgAssignment(objValue);</span>
<span class="nc" id="L503">		} catch (MultiUserException e) {</span>
<span class="nc" id="L504">			handleException(e);</span>
<span class="nc" id="L505">			throw e;</span>
<span class="nc" id="L506">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L507">			handleException(e);</span>
<span class="nc" id="L508">			throw e;</span>
		} finally {
<span class="nc" id="L510">			dao.cleanUp();</span>
<span class="nc" id="L511">			methodFinish();</span>
<span class="nc" id="L512">		}</span>
<span class="nc" id="L513">	}</span>

	/**
	 * delete a campaign's organization assignments given the assignment ids
	 */
	public void deleteCampaignOrgAssignments(Collection&lt;ID&gt; colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L519">		methodStart(&quot;deleteCampaignOrgAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L520">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="nc" id="L522">			dao.deleteCampaignOrgAssignments(colIDAssignments);</span>
<span class="nc" id="L523">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L524">			handleException(e);</span>
<span class="nc" id="L525">			throw e;</span>
		} finally {
<span class="nc" id="L527">			dao.cleanUp();</span>
<span class="nc" id="L528">			methodFinish();</span>
<span class="nc" id="L529">		}</span>
<span class="nc" id="L530">	}</span>

	/**
	 * Because each scheduling period has a choice of biz rule, we need to
	 * implement this method piecewise Only scheduling periods
	 *
	 * @return a collection of CampaignWorkResource objects which hold the
	 * assignment information including start and end dates
	 */
	public Collection&lt;CampaignWorkResource&gt; getCampaignWorkResourceAssignments(ID campaignID, Date startDate, Date endDate)
			throws BbmFinderException {
<span class="fc" id="L541">		methodStart(&quot;getCampaignWorkResourceAssignments&quot;, campaignID, startDate, endDate);</span>

		try {
			// break down the campaign into its scheduling periods
<span class="fc" id="L545">			Collection&lt;SchedulingPeriod&gt; schedulingPeriods = getSchedulingPeriods(campaignID, startDate, endDate);</span>

			// for each scheduling period find resources based on that period's
			// biz rule
<span class="fc" id="L549">			Collection&lt;CampaignWorkResource&gt; result = new ArrayList&lt;CampaignWorkResource&gt;();</span>
<span class="fc bfc" id="L550" title="All 2 branches covered.">			for (SchedulingPeriod schedulingPeriod : schedulingPeriods) {</span>
<span class="fc" id="L551">				result.addAll(getCampaignWorkResourceAssignments(schedulingPeriod));</span>
<span class="fc" id="L552">			}</span>

<span class="fc" id="L554">			return result;</span>
<span class="nc" id="L555">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L556">			handleException(e, false);</span>
<span class="nc" id="L557">			throw e;</span>
		} finally {
<span class="pc" id="L559">			methodFinish();</span>
		}
	}

	public Collection&lt;CampaignWorkResource&gt; getCampaignWorkResourceAssignments(SchedulingPeriod schedulingPeriod)
			throws BbmFinderException {
<span class="fc" id="L565">		methodStart(&quot;getCampaignWorkResourceAssignments&quot;, schedulingPeriod);</span>

<span class="fc" id="L567">		CampaignWorkResourceDAO dao = null;</span>
		try {
<span class="fc" id="L569">			dao = new CampaignWorkResourceDAO();</span>
<span class="fc" id="L570">			Collection&lt;CampaignWorkResource&gt; schedulingPeriodResources = new ArrayList&lt;CampaignWorkResource&gt;();</span>

<span class="fc bfc" id="L572" title="All 2 branches covered.">			if (schedulingPeriod.isUsingAllEmployees()) {</span>
<span class="fc" id="L573">				schedulingPeriodResources = dao.getCampaignWorkResourceAssignmentsByLinkedOrganizations(schedulingPeriod);</span>
			} else {
<span class="fc" id="L575">				schedulingPeriodResources = dao.getCampaignWorkResourceAssignmentsByLinkedEmployees(schedulingPeriod);</span>
			}
<span class="fc" id="L577">			return schedulingPeriodResources;</span>
<span class="nc" id="L578">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L579">			handleException(e, false);</span>
<span class="nc" id="L580">			throw e;</span>
		} finally {
<span class="pc bpc" id="L582" title="3 of 4 branches missed.">			if (dao != null) {</span>
<span class="pc" id="L583">				dao.cleanUp();</span>
			}
<span class="pc" id="L585">			methodFinish();</span>
		}
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	public Collection&lt;ID&gt; getWorkResourceIDsBySchedulingPeriod(SchedulingPeriod schedulingPeriod) throws BbmFinderException {
<span class="nc" id="L591">		methodStart(&quot;getWorkResourceIDs&quot;, schedulingPeriod);</span>
		try {

<span class="nc" id="L594">			Collection&lt;CampaignWorkResource&gt; campaignWorkResources = getCampaignWorkResourceAssignments(schedulingPeriod);</span>

			// Extract employee ids from collection
<span class="nc" id="L597">			List&lt;ID&gt; workResourceIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">			for (CampaignWorkResource campaignWorkResource : campaignWorkResources) {</span>
<span class="nc" id="L599">				workResourceIDs.add(campaignWorkResource.getWorkResourceID());</span>
<span class="nc" id="L600">			}</span>
<span class="nc" id="L601">			return workResourceIDs;</span>
<span class="nc" id="L602">		} catch (Exception e) {</span>
<span class="nc" id="L603">			handleException(e, false);</span>
<span class="nc" id="L604">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L606">			methodFinish();</span>
		}
	}

	/**
	 * get the pooler assignments for the given set of Scheduling Periods.
	 *
	 * @return a collection of work resource IDs which are poolers at any of the
	 * given scheduling periods.
	 * @spIDs a collection of IDs of scheduling periods for which we want to
	 * retrieve the pooling assignments.
	 */
	public Collection&lt;ID&gt; getSPPoolerAssignments(Collection&lt;ID&gt; spIDs) throws BbmFinderException {
<span class="fc" id="L619">		methodStart(&quot;getSPPoolerAssignments&quot;, spIDs);</span>
<span class="fc" id="L620">		CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
		try {
<span class="fc" id="L622">			return dao.getSPPoolerAssignments(spIDs);</span>
<span class="nc" id="L623">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L624">			handleException(e, false);</span>
<span class="nc" id="L625">			throw e;</span>
		} finally {
<span class="pc" id="L627">			dao.cleanUp();</span>
<span class="pc" id="L628">			methodFinish();</span>
		}
	}

	/**
	 * get the pooler assignments for the given Scheduling Period between the
	 * given date range.
	 *
	 * @return a collection of work resource IDs which are poolers at the given
	 * scheduling period during the given time frame.
	 * @spID sp id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;ID&gt; getSPPoolerAssignments(ID spID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L642">		methodStart(&quot;getSPPoolerAssignments&quot;, spID, dtStart, dtEnd);</span>
<span class="fc" id="L643">		CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
		try {
<span class="fc" id="L645">			return dao.getSPPoolerAssignments(spID, dtStart, dtEnd);</span>
<span class="nc" id="L646">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L647">			handleException(e, false);</span>
<span class="nc" id="L648">			throw e;</span>
		} finally {
<span class="pc" id="L650">			dao.cleanUp();</span>
<span class="pc" id="L651">			methodFinish();</span>
		}
	}

	/**
	 * For a collection of work resource ids (usually employee ids) and a date
	 * range, return a map of work resource ids to the campaigns they are
	 * assigned to. Different logic based on weather constituent scheduling
	 * period.isUsingAllEmployees() is true or false
	 *
	 * @param startDate null treated as unlimited
	 * @param endDate   null treated as unlimited
	 */
	public Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; getWorkResourceCampaignAssignments(Collection&lt;ID&gt; workResourceIDs,
			Date startDate, Date endDate) throws BbmFinderException {
<span class="fc" id="L666">		methodStart(&quot;getWorkResourceCampaignAssignments&quot;, workResourceIDs, startDate, endDate);</span>

<span class="fc" id="L668">		CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
		try {
<span class="fc" id="L670">			Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; manualAssignmentMap = dao</span>
<span class="fc" id="L671">					.getCampaignWorkResourceAssignmentsByLinkedEmployees(workResourceIDs, startDate, endDate);</span>
<span class="fc" id="L672">			Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; byOrganizationAssignmentMap = dao</span>
<span class="fc" id="L673">					.getCampaignWorkResourceAssignmentsByLinkedOrganizations(workResourceIDs, startDate, endDate);</span>
<span class="fc" id="L674">			Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; mergedAssignmentMap = CollectionUtil.mergeIdCollectionMaps(</span>
					manualAssignmentMap, byOrganizationAssignmentMap);
<span class="fc" id="L676">			return mergedAssignmentMap;</span>
<span class="nc" id="L677">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L678">			handleException(e, false);</span>
<span class="nc" id="L679">			throw e;</span>
		} finally {
<span class="pc" id="L681">			dao.cleanUp();</span>
<span class="pc" id="L682">			methodFinish();</span>
		}
	}

	/**
	 * For one work resource id and a date range, return a list of campaigns
	 * they are assigned to. Special case of multiple work resource ids.
	 *
	 * @param startDate null treated as unlimited
	 * @param endDate   null treated as unlimited
	 * @return A list of CampaignWorkResource objects which hold the assignment
	 * information
	 */
	public List&lt;CampaignWorkResource&gt; getWorkResourceCampaignAssignments(ID workResourceID, Date startDate, Date endDate)
			throws BbmFinderException {
<span class="nc" id="L697">		methodStart(&quot;getWorkResourceCampaignAssignments&quot;, workResourceID, startDate, endDate);</span>
		try {
<span class="nc" id="L699">			List&lt;CampaignWorkResource&gt; campaignWorkResources = getWorkResourceCampaignAssignments(</span>
<span class="nc" id="L700">					Arrays.asList(workResourceID), startDate, endDate).get(workResourceID);</span>
<span class="nc" id="L701">			return campaignWorkResources;</span>
		} finally {
<span class="nc" id="L703">			methodFinish();</span>
		}
	}

	/**
	 * get a given campaign's queue assignments
	 *
	 * @return a collection of CampaignQueue objects which hold the assignment
	 * information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;CampaignQueue&gt; getCampaignQueueAssignments(ID idCampaign, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L716">		methodStart(&quot;getCampaignQueueAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L717">		CampaignQueueDAO dao = new CampaignQueueDAO();</span>
		try {
<span class="fc" id="L719">			return dao.getCampaignQueueAssignments(idCampaign, null, dtStart, dtEnd, false);</span>
<span class="nc" id="L720">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L721">			handleException(e, false);</span>
<span class="nc" id="L722">			throw e;</span>
		} finally {
<span class="pc" id="L724">			dao.cleanUp();</span>
<span class="pc" id="L725">			methodFinish();</span>
		}
	}

	public Collection&lt;CampaignQueue&gt; getCampaignQueueAssignmentsAndCombinedQueues(ID idCampaign, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="fc" id="L731">		methodStart(&quot;getCampaignQueueAssignmentsAndCombinedQueues&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L732">		CampaignQueueDAO dao = new CampaignQueueDAO();</span>
		try {
<span class="fc" id="L734">			return dao.getCampaignQueueAssignments(idCampaign, null, dtStart, dtEnd, true);</span>
<span class="nc" id="L735">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L736">			handleException(e, false);</span>
<span class="nc" id="L737">			throw e;</span>
		} finally {
<span class="pc" id="L739">			dao.cleanUp();</span>
<span class="pc" id="L740">			methodFinish();</span>
		}
	}

	public Collection&lt;CampaignQueue&gt; getCampaignQueueAndLinkedSubQueueAssignments(ID idCampaign, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="fc" id="L746">		methodStart(&quot;getCampaignQueueAndLinkedSubQueueAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L747">		CampaignQueueDAO dao = new CampaignQueueDAO();</span>
		try {
<span class="fc" id="L749">			return dao.getCampaignQueueAndLinkedSubQueueAssignments(idCampaign, null, dtStart, dtEnd);</span>
<span class="nc" id="L750">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L751">			handleException(e, false);</span>
<span class="nc" id="L752">			throw e;</span>
		} finally {
<span class="pc" id="L754">			dao.cleanUp();</span>
<span class="pc" id="L755">			methodFinish();</span>
		}
	}

	public Collection&lt;CampaignQueue&gt; getQueueCampaignAssignments(ID idQueue, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L760">		methodStart(&quot;getQueueCampaignAssignments&quot;, idQueue, dtStart, dtEnd);</span>
<span class="fc" id="L761">		CampaignQueueDAO dao = new CampaignQueueDAO();</span>
		try {
<span class="fc" id="L763">			return dao.getQueueCampaignAssignments(idQueue, dtStart, dtEnd);</span>
<span class="nc" id="L764">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L765">			handleException(e, false);</span>
<span class="nc" id="L766">			throw e;</span>
		} finally {
<span class="pc" id="L768">			dao.cleanUp();</span>
<span class="pc" id="L769">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; getSubCampaignIDs(ID idCampaign) throws BbmFinderException {
<span class="fc" id="L774">		methodStart(&quot;getSubCampaignIDs&quot;, idCampaign);</span>
<span class="fc" id="L775">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="fc" id="L777">			return dao.getSubCampaignIDs(idCampaign);</span>
<span class="nc" id="L778">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L779">			handleException(e, false);</span>
<span class="nc" id="L780">			throw e;</span>
		} finally {
<span class="pc" id="L782">			dao.cleanUp();</span>
<span class="pc" id="L783">			methodFinish();</span>
		}
	}

	public Collection getCampaignQueueAssignments(ID idCampaign, ID idMedia, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="fc" id="L789">		methodStart(&quot;getCampaignQueueAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L790">		CampaignQueueDAO dao = new CampaignQueueDAO();</span>
		try {
<span class="fc" id="L792">			return dao.getCampaignQueueAssignments(idCampaign, idMedia, dtStart, dtEnd, false);</span>
<span class="nc" id="L793">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L794">			handleException(e, false);</span>
<span class="nc" id="L795">			throw e;</span>
		} finally {
<span class="pc" id="L797">			dao.cleanUp();</span>
<span class="pc" id="L798">			methodFinish();</span>
		}
	}

	/**
	 * get a given campaign's hours's of operation (HOO)
	 *
	 * @param idCampaign      : campaign id
	 * @param dtStart         :
	 * @param dtEnd           : the time period, null date means a open period
	 * @param includeSubCamps : true if you want to include SPHOO's from sub-campaigns as
	 *                        well.
	 * @return a collection of CampaignHOO objects which hold the assignment
	 * information
	 */
	public Collection&lt;CampaignHOO&gt; getCampaignHOOAssignments(ID idCampaign, Date dtStart, Date dtEnd, boolean includeSubCamps)
			throws BbmFinderException {
<span class="fc" id="L815">		methodStart(&quot;getCampaignHOOAssignments&quot;, idCampaign, dtStart, dtEnd, includeSubCamps);</span>
<span class="fc" id="L816">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="fc" id="L818">			return dao.getCampaignHOOAssignments(idCampaign, dtStart, dtEnd, includeSubCamps);</span>
<span class="nc" id="L819">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L820">			handleException(e, false);</span>
<span class="nc" id="L821">			throw e;</span>
		} finally {
<span class="pc" id="L823">			dao.cleanUp();</span>
<span class="pc" id="L824">			methodFinish();</span>
		}
	}

	/**
	 * get a given campaign's hours's of operation (HOO)
	 *
	 * @return a collection of CampaignHOO objects which hold the assignment
	 * information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;CampaignHOO&gt; getCampaignHOOAssignments(ID idCampaign, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="fc" id="L838">		methodStart(&quot;getCampaignHOOAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L839">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="fc" id="L841">			return dao.getCampaignHOOAssignments(idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L842">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L843">			handleException(e, false);</span>
<span class="nc" id="L844">			throw e;</span>
		} finally {
<span class="pc" id="L846">			dao.cleanUp();</span>
<span class="pc" id="L847">			methodFinish();</span>
		}
	}

	/**
	 * get a given campaign's hours's of operation (HOO)
	 *
	 * @return a collection of CampaignHOO objects which hold the assignment
	 * information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public List&lt;CampaignHOO&gt; getCampaignHOOAssignmentsBySP(ID idSP) throws BbmFinderException {
<span class="fc" id="L860">		methodStart(&quot;getCampaignHOOAssignmentsBySP&quot;, idSP);</span>
<span class="fc" id="L861">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="fc" id="L863">			return dao.getCampaignHOOAssignmentsBySP(idSP);</span>
<span class="nc" id="L864">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L865">			handleException(e, false);</span>
<span class="nc" id="L866">			throw e;</span>
		} finally {
<span class="pc" id="L868">			dao.cleanUp();</span>
<span class="pc" id="L869">			methodFinish();</span>
		}
	}

	/**
	 * fetch a collection of HOO for the given campaign and using campaign TZ to
	 * prepare the HOOPeriod object. HOOPeriod differ from HOO since it is not a
	 * template but a daily definition of HOO in the given period.
	 */
	public HOOPeriod getHOOPeriod(ID idCampaign, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L879">		methodStart(&quot;getHOOPeriod&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L880">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="fc" id="L882">			return dao.getHOOPeriod(idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L883">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L884">			handleException(e, false);</span>
<span class="nc" id="L885">			throw e;</span>
		} finally {
<span class="pc" id="L887">			dao.cleanUp();</span>
<span class="pc" id="L888">			methodFinish();</span>
		}
	}

	/**
	 * create a campaign's HOO assignment
	 */
	public ID createCampaignHOOAssignment(CampaignHOO objValue) throws BbmCreateException {
<span class="fc" id="L896">		methodStart(&quot;createCampaignHOOAssignment&quot;, objValue);</span>
<span class="fc" id="L897">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="fc" id="L899">			return dao.createCampaignHOOAssignment(objValue);</span>
<span class="nc" id="L900">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L901">			handleException(e);</span>
<span class="nc" id="L902">			throw e;</span>
		} finally {
<span class="pc" id="L904">			dao.cleanUp();</span>
<span class="pc" id="L905">			methodFinish();</span>
		}
	}

	/**
	 * save a campaign's HOO assignment
	 */
	public void updateCampaignHOOAssignment(CampaignHOO objValue) throws BbmUpdateException {
<span class="fc" id="L913">		methodStart(&quot;updateCampaignHOOAssignment&quot;, objValue);</span>
<span class="fc" id="L914">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="fc" id="L916">			dao.updateCampaignHOOAssignment(objValue);</span>
<span class="nc" id="L917">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L918">			handleException(e);</span>
<span class="nc" id="L919">			throw e;</span>
		} finally {
<span class="pc" id="L921">			dao.cleanUp();</span>
<span class="pc" id="L922">			methodFinish();</span>
<span class="fc" id="L923">		}</span>
<span class="fc" id="L924">	}</span>

	/**
	 * delete a campaign's HOO assignments given the assignment ids
	 */
	public void deleteCampaignHOOAssignments(Collection colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L930">		methodStart(&quot;deleteCampaignHOOAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L931">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L933">			dao.deleteCampaignHOOAssignments(colIDAssignments);</span>
<span class="nc" id="L934">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L935">			handleException(e);</span>
<span class="nc" id="L936">			throw e;</span>
		} finally {
<span class="nc" id="L938">			dao.cleanUp();</span>
<span class="nc" id="L939">			methodFinish();</span>
<span class="nc" id="L940">		}</span>
<span class="nc" id="L941">	}</span>

	/**
	 * return a hashmap of (idCampaign, idName)
	 */
	public HashMap getCampaignNamesByIDs(Collection colCampaignIDs) throws BbmFinderException {
<span class="nc" id="L947">		methodStart(&quot;getCampaignNamesByIDs&quot;, colCampaignIDs);</span>
		try {
<span class="nc" id="L949">			return CampaignDAO.getCampaignNamesByIDs(colCampaignIDs);</span>
<span class="nc" id="L950">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L951">			handleException(e, false);</span>
<span class="nc" id="L952">			throw e;</span>
		} finally {
<span class="nc" id="L954">			methodFinish();</span>
		}
	}

	/**
	 * Creates a scheduling period
	 *
	 * @return ID of the created scheduling period
	 * @objValue the scheduling period value object
	 */
	public ID createSchedulingPeriod(SchedulingPeriod objValue) throws BbmCreateException {
<span class="fc" id="L965">		methodStart(&quot;createSchedulingPeriod&quot;, objValue);</span>
<span class="fc" id="L966">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="fc" id="L968">			return dao.createSchedulingPeriod(objValue);</span>
<span class="nc" id="L969">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L970">			handleException(e, false);</span>
<span class="nc" id="L971">			throw e;</span>
<span class="nc" id="L972">		} catch (Exception e) {</span>
<span class="nc" id="L973">			handleException(e);</span>
<span class="nc" id="L974">			throw new BbmCreateException(e);</span>
		} finally {
<span class="pc bpc" id="L976" title="3 of 4 branches missed.">			if (dao != null) {</span>
<span class="pc" id="L977">				dao.cleanUp();</span>
			}
<span class="pc" id="L979">			methodFinish();</span>
		}
	}

	/**
	 * Updates a collection of scheduling periods
	 *
	 * @return void
	 * @colObjValues the scheduling period collection of value objects
	 */
	public void updateSchedulingPeriods(Collection&lt;SchedulingPeriod&gt; colObjValues) throws BbmUpdateException,
			MultiUserException {
<span class="fc" id="L991">		methodStart(&quot;updateSchedulingPeriods&quot;);</span>
<span class="fc" id="L992">		SchedulingPeriodDAO dao = null;</span>
		try {
<span class="fc" id="L994">			dao = new SchedulingPeriodDAO();</span>
<span class="fc" id="L995">			dao.updateSchedulingPeriods(colObjValues);</span>
<span class="nc" id="L996">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L997">			handleException(e, false);</span>
<span class="nc" id="L998">			throw e;</span>
<span class="nc" id="L999">		} catch (Exception e) {</span>
<span class="nc" id="L1000">			handleException(e);</span>
<span class="nc" id="L1001">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="pc bpc" id="L1003" title="3 of 4 branches missed.">			if (dao != null) {</span>
<span class="pc" id="L1004">				dao.cleanUp();</span>
			}
<span class="pc" id="L1006">			methodFinish();</span>
<span class="fc" id="L1007">		}</span>
<span class="fc" id="L1008">	}</span>

	/**
	 * Deletes a collection of scheduling periods
	 *
	 * @return void
	 * @colIDs collection of ids of scheduling periods to be deleted
	 */
	public void deleteSchedulingPeriods(Collection&lt;ID&gt; colIDs) throws BbmRemoveException, MultiUserException {
<span class="nc" id="L1017">		methodStart(&quot;deleteSchedulingPeriods&quot;);</span>
<span class="nc" id="L1018">		SchedulingPeriodDAO dao = null;</span>
		try {
<span class="nc" id="L1020">			dao = new SchedulingPeriodDAO();</span>
<span class="nc" id="L1021">			dao.deleteSchedulingPeriods(colIDs);</span>
<span class="nc" id="L1022">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1023">			handleException(e, false);</span>
<span class="nc" id="L1024">			throw e;</span>
<span class="nc" id="L1025">		} catch (Exception e) {</span>
<span class="nc" id="L1026">			handleException(e);</span>
<span class="nc" id="L1027">			throw new BbmRemoveException(e);</span>
		} finally {
<span class="nc bnc" id="L1029" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1030">				dao.cleanUp();</span>
			}
<span class="nc" id="L1032">			methodFinish();</span>
<span class="nc" id="L1033">		}</span>
<span class="nc" id="L1034">	}</span>

	/**
	 * get scheduling periods for a campaign
	 *
	 * @return a collection of SchedulingPeriod objects which hold the
	 * assignment information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="fc" id="L1046">		methodStart(&quot;getSchedulingPeriods&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="fc" id="L1047">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="fc" id="L1049">			return dao.getSchedulingPeriods(idCampaign, dtStart, dtEnd, null, null);</span>
<span class="nc" id="L1050">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1051">			handleException(e, false);</span>
<span class="nc" id="L1052">			throw e;</span>
		} finally {
<span class="pc bpc" id="L1054" title="3 of 4 branches missed.">			if (dao != null) {</span>
<span class="pc" id="L1055">				dao.cleanUp();</span>
			}
<span class="pc" id="L1057">			methodFinish();</span>
		}
	}

	/**
	 * get scheduling periods for a campaign and linked to a org
	 *
	 * @return a collection of SchedulingPeriod objects which hold the
	 * assignment information
	 * @idCampaign campaign id
	 * @idOrg organization id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, ID idOrg, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L1072">		methodStart(&quot;getSchedulingPeriods&quot;, idCampaign, idOrg, dtStart, dtEnd);</span>
<span class="nc" id="L1073">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1075">			return dao.getSchedulingPeriods(idCampaign, idOrg, dtStart, dtEnd, null, null);</span>
<span class="nc" id="L1076">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1077">			handleException(e, false);</span>
<span class="nc" id="L1078">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1080" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1081">				dao.cleanUp();</span>
			}
<span class="nc" id="L1083">			methodFinish();</span>
		}
	}

	/**
	 * get a campaign workresource assignment object by id
	 */
	public CampaignWorkResource getCampaignWorkResourceAssignmentByID(ID idAssignment) throws BbmFinderException {
<span class="nc" id="L1091">		methodStart(&quot;getCampaignWorkResourceAssignmentByID&quot;, idAssignment);</span>
<span class="nc" id="L1092">		CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
		try {
<span class="nc" id="L1094">			return dao.getCampaignWorkResourceAssignmentByID(idAssignment);</span>
<span class="nc" id="L1095">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1096">			handleException(e, false);</span>
<span class="nc" id="L1097">			throw e;</span>
		} finally {
<span class="nc" id="L1099">			dao.cleanUp();</span>
<span class="nc" id="L1100">			methodFinish();</span>
		}
	}

	/**
	 * get campaign workresource assignments given their ids
	 */
	public Collection getCampaignWorkResourceAssignmentsByIDs(Collection colAssignmentIDs) throws BbmFinderException {
<span class="nc" id="L1108">		methodStart(&quot;getCampaignWorkResourceAssignmentsByIDs&quot;, colAssignmentIDs);</span>
<span class="nc" id="L1109">		CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
		try {
<span class="nc" id="L1111">			return dao.getCampaignWorkResourceAssignmentsByIDs(colAssignmentIDs);</span>
<span class="nc" id="L1112">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1113">			handleException(e, false);</span>
<span class="nc" id="L1114">			throw e;</span>
		} finally {
<span class="nc" id="L1116">			dao.cleanUp();</span>
<span class="nc" id="L1117">			methodFinish();</span>
		}
	}

	/**
	 * get a campaignHOO object by id
	 */
	public CampaignHOO getCampaignHOOAssignmentByID(ID idAssignment) throws BbmFinderException {
<span class="nc" id="L1125">		methodStart(&quot;getCampaignHOOAssignmentByID&quot;, idAssignment);</span>
<span class="nc" id="L1126">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L1128">			return dao.getCampaignHOOAssignmentByID(idAssignment);</span>
<span class="nc" id="L1129">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1130">			handleException(e, false);</span>
<span class="nc" id="L1131">			throw e;</span>
		} finally {
<span class="nc" id="L1133">			dao.cleanUp();</span>
<span class="nc" id="L1134">			methodFinish();</span>
		}
	}

	/**
	 * Returns the SchedulingPeriod matching the given ID.  This Scheduling Period will have its
	 * local start and end times set.
	 * @param idSP - The integer ID of the scheduling period.
	 * @return The Scheduling Period object matching the given ID.
	 * @throws BbmFinderException
	 * @throws BbmObjectNotFoundException
	 */
	public SchedulingPeriod getSchedulingPeriodByID(ID idSP) throws BbmFinderException, BbmObjectNotFoundException {
<span class="fc" id="L1147">		methodStart(&quot;getSchedulingPeriodByID&quot;, idSP);</span>
<span class="fc" id="L1148">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="fc" id="L1150">			Collection&lt;SchedulingPeriod&gt; schedulingPeriods = dao.getSchedulingPeriods(null, null, null, idSP, null);</span>
<span class="pc bpc" id="L1151" title="1 of 2 branches missed.">			if (schedulingPeriods.isEmpty()) {</span>
<span class="nc" id="L1152">				return null;</span>
			}
<span class="fc" id="L1154">			SchedulingPeriod sp = schedulingPeriods.iterator().next();</span>

<span class="fc" id="L1156">			Campaign campaign = this.getCampaignByID(sp.getCampaignID());</span>
<span class="fc" id="L1157">			TimeZone tz = campaign.getTimeZone();</span>
<span class="fc" id="L1158">			sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), tz));</span>
<span class="fc" id="L1159">			sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), tz));</span>

<span class="fc" id="L1161">			return sp;</span>
<span class="nc" id="L1162">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1163">			handleException(e, false);</span>
<span class="nc" id="L1164">			throw e;</span>
		} finally {
<span class="pc bpc" id="L1166" title="5 of 6 branches missed.">			if (dao != null) {</span>
<span class="pc" id="L1167">				dao.cleanUp();</span>
			}
<span class="pc" id="L1169">			methodFinish();</span>
		}
	}

	/**
	 * get scheduling period by id
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByID(Collection&lt;ID&gt; cSP) throws BbmFinderException, BbmObjectNotFoundException {
<span class="fc" id="L1177">		methodStart(&quot;getSchedulingPeriodsByID&quot;, cSP);</span>
<span class="fc" id="L1178">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="fc" id="L1180">			return dao.getSchedulingPeriods(null, null, null, null, cSP);</span>
<span class="nc" id="L1181">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1182">			handleException(e, false);</span>
<span class="nc" id="L1183">			throw e;</span>
		} finally {
<span class="pc bpc" id="L1185" title="3 of 4 branches missed.">			if (dao != null) {</span>
<span class="pc" id="L1186">				dao.cleanUp();</span>
			}
<span class="pc" id="L1188">			methodFinish();</span>
		}
	}

	/**
	 * create campaign HOO based on its linked organization HOO.
	 * &lt;p&gt;
	 * 1. do not create any campaignHOO if the campaign already has an hours of
	 * operation. 2. set campaign HOO to be the same as the organization HOO if
	 * they have the same time zone.
	 *
	 * @return the campaignHOO ID if created successfully
	 */
	public ID createCampaignHOOFromOrg(ID idCampaign, ID idOrg) throws BbmCreateException {
<span class="nc" id="L1202">		methodStart(&quot;createCampaignHOOFromOrg&quot;, idCampaign, idOrg);</span>
<span class="nc" id="L1203">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L1205">			return dao.createCampaignHOOFromOrg(idCampaign, idOrg);</span>
<span class="nc" id="L1206">		} catch (Exception e) {</span>
<span class="nc" id="L1207">			handleException(e);</span>
<span class="nc" id="L1208">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L1210">			dao.cleanUp();</span>
<span class="nc" id="L1211">			methodFinish();</span>
		}
	}

	public Map getSchedulingParameters(ID idSchedulingPeriod) throws BbmFinderException {
<span class="fc" id="L1216">		methodStart(&quot;getSchedulingParameters&quot;, idSchedulingPeriod);</span>
		try {
<span class="fc" id="L1218">			return new SPParamDAO().getSchedulingParameters(idSchedulingPeriod);</span>
<span class="nc" id="L1219">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1220">			handleException(e);</span>
<span class="nc" id="L1221">			throw e;</span>
		} finally {
<span class="pc" id="L1223">			methodFinish();</span>
		}
	}

	public void setSchedulingParameters(ID idSchedulingPeriod, Map mParameters, String sEmployees) throws BbmCreateException {
<span class="fc" id="L1228">		methodStart(&quot;setSchedulingParameters&quot;, idSchedulingPeriod, mParameters, sEmployees);</span>
		try {
<span class="fc" id="L1230">			new SPParamDAO().setSchedulingParameters(idSchedulingPeriod, mParameters, sEmployees);</span>
<span class="nc" id="L1231">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1232">			handleException(e);</span>
<span class="nc" id="L1233">			throw e;</span>
		} finally {
<span class="pc" id="L1235">			methodFinish();</span>
<span class="fc" id="L1236">		}</span>
<span class="fc" id="L1237">	}</span>

	public ID getMostRecentSPWithParameters(Date dtStart, ID idCampaign) throws BbmFinderException {
<span class="nc" id="L1240">		methodStart(&quot;getMostRecentSPWithParameters&quot;, dtStart, idCampaign);</span>
		try {
<span class="nc" id="L1242">			return new SPParamDAO().getMostRecentSPWithParameters(dtStart, idCampaign);</span>
<span class="nc" id="L1243">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1244">			handleException(e);</span>
<span class="nc" id="L1245">			throw e;</span>
		} finally {
<span class="nc" id="L1247">			methodFinish();</span>
		}
	}

	public Pair getDirtyStatus(ID idSchedulingPeriod) throws BbmFinderException {
<span class="nc" id="L1252">		methodStart(&quot;getDirtyStatus&quot;, idSchedulingPeriod);</span>
		try {
<span class="nc" id="L1254">			return new SPParamDAO().getDirtyStatus(idSchedulingPeriod);</span>
<span class="nc" id="L1255">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1256">			handleException(e);</span>
<span class="nc" id="L1257">			throw e;</span>
		} finally {
<span class="nc" id="L1259">			methodFinish();</span>
		}
	}

	public Collection&lt;SchedulingPeriod&gt; getCommonSchedulingPeriods(ID campaignID, Collection&lt;ID&gt; employeeIDs, Date date, int nNumberToGet) throws BbmFinderException {

<span class="nc" id="L1265">		methodStart(&quot;getCommonSchedulingPeriods&quot;, campaignID, date);</span>
<span class="nc" id="L1266">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1268">			Collection&lt;SchedulingPeriod&gt; schedulingPeriods = dao.getCommonSchedulingPeriods(campaignID, employeeIDs, date, nNumberToGet);</span>
<span class="nc" id="L1269">			return convertSchedulingPeriodDatesToCampaignTZ(campaignID, schedulingPeriods);</span>

<span class="nc" id="L1271">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1272">			handleException(e);</span>
<span class="nc" id="L1273">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1275" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1276">				dao.cleanUp();</span>
			}
<span class="nc" id="L1278">			methodFinish();</span>
		}

	}

	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, Date dtDate, int nNumberToGet, int eTimeFrame)
			throws BbmFinderException {
<span class="fc" id="L1285">		methodStart(&quot;getSchedulingPeriods&quot;, idCampaign, dtDate);</span>
<span class="fc" id="L1286">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="fc" id="L1288">			Collection&lt;SchedulingPeriod&gt; schedulingPeriods = dao.getSchedulingPeriods(idCampaign, dtDate, nNumberToGet,</span>
					eTimeFrame);

			// Configure the local time for the campaign time zone.
<span class="fc" id="L1292">			return convertSchedulingPeriodDatesToCampaignTZ(idCampaign, schedulingPeriods);</span>
<span class="nc" id="L1293">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1294">			handleException(e);</span>
<span class="nc" id="L1295">			throw e;</span>
		} finally {
<span class="pc bpc" id="L1297" title="3 of 4 branches missed.">			if (dao != null) {</span>
<span class="pc" id="L1298">				dao.cleanUp();</span>
			}
<span class="pc" id="L1300">			methodFinish();</span>
		}
	}

	private Collection&lt;SchedulingPeriod&gt; convertSchedulingPeriodDatesToCampaignTZ(ID idCampaign, Collection&lt;SchedulingPeriod&gt; schedulingPeriods) throws BbmObjectNotFoundException, BbmFinderException {
<span class="fc" id="L1305">		Campaign campaign = this.getCampaignByID(idCampaign);</span>
<span class="fc" id="L1306">		TimeZone tz = campaign.getTimeZone();</span>
<span class="fc bfc" id="L1307" title="All 2 branches covered.">		for (SchedulingPeriod sp : schedulingPeriods) {</span>
<span class="fc" id="L1308">			sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), tz));</span>
<span class="fc" id="L1309">			sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), tz));</span>
<span class="fc" id="L1310">		}</span>
<span class="fc" id="L1311">		return schedulingPeriods;</span>
	}

	/**
	 * Gets the SP object from the SP table (as opposed to the getSP() method,
	 * which gets a SchedulingPeriod object).
	 *
	 * @param spID - The SP ID
	 * @return An SP object.
	 * @throws BbmFinderException
	 */
	public SP getRealSP(ID spID) throws BbmFinderException {
<span class="nc" id="L1323">		methodStart(&quot;getRealSP&quot;);</span>
		try {
<span class="nc" id="L1325">			return SPDAO.getSPByID(spID);</span>
<span class="nc" id="L1326">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1327">			handleException(e);</span>
<span class="nc" id="L1328">			throw e;</span>
		} finally {
<span class="nc" id="L1330">			methodFinish();</span>
		}
	}

	/**
	 * Update the SP object from the SP table (as opposed to the
	 * SchedulingPeriod object). We only update the following fields for now:
	 * FTESHIFTS, FTEWORKHOURS, FTEPAIDHOURS, FTEPHONEHOURS, FTEWAGE.
	 *
	 * @param spID - The SP ID
	 * @return An SP object.
	 * @throws BbmFinderException
	 */
	public void updateRealSP(SP sp) throws BbmUpdateException {
<span class="nc" id="L1344">		methodStart(&quot;updateRealSP&quot;);</span>
		try {
<span class="nc" id="L1346">			SPDAO.updateRealSP(sp);</span>
<span class="nc" id="L1347">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1348">			handleException(e, false);</span>
<span class="nc" id="L1349">			throw e;</span>
<span class="nc" id="L1350">		} catch (Exception e) {</span>
<span class="nc" id="L1351">			handleException(e);</span>
<span class="nc" id="L1352">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L1354">			methodFinish();</span>
<span class="nc" id="L1355">		}</span>
<span class="nc" id="L1356">	}</span>

	/**
	 * Get a SchedulingPeriod object given the SP ID.
	 *
	 * @param spID - The SP ID
	 * @return A SchedulingPeriod object.
	 * @throws BbmFinderException
	 */
	public SchedulingPeriod getSP(ID spID) throws BbmFinderException {
<span class="nc" id="L1366">		methodStart(&quot;getSP&quot;);</span>
<span class="nc" id="L1367">		SchedulingPeriodDAO dao = null;</span>
		try {
<span class="nc" id="L1369">			dao = new SchedulingPeriodDAO();</span>
<span class="nc" id="L1370">			return dao.getSchedulingPeriodByID(spID);</span>
<span class="nc" id="L1371">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1372">			handleException(e);</span>
<span class="nc" id="L1373">			throw e;</span>
		} finally {
<span class="nc" id="L1375">			methodFinish();</span>
<span class="nc bnc" id="L1376" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1377">				dao.cleanUp();</span>
			}
		}
	}

	/**
	 * Creates a sp queue
	 *
	 * @return ID of the created sp queue
	 * @objValue the sp queue value object
	 */
	public ID createSPQueue(SPQueue objValue) throws BbmCreateException, BbmTimePeriodOverlapException {
<span class="fc" id="L1389">		methodStart(&quot;createSPQueue&quot;);</span>
<span class="fc" id="L1390">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="fc" id="L1392">			return dao.createSPQueue(objValue);</span>
<span class="nc" id="L1393">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1394">			handleException(e);</span>
<span class="nc" id="L1395">			throw e;</span>
<span class="nc" id="L1396">		} catch (BbmTimePeriodOverlapException e) {</span>
<span class="nc" id="L1397">			handleException(e);</span>
<span class="nc" id="L1398">			throw e;</span>
		} finally {
<span class="pc" id="L1400">			dao.cleanUp();</span>
<span class="pc" id="L1401">			methodFinish();</span>
		}
	}

	/**
	 * Updates an sp queue
	 *
	 * @throws MultiUserException
	 * @objValue the sp queue value object
	 */
	public void updateSPQueue(SPQueue objValue) throws BbmUpdateException, MultiUserException {
<span class="fc" id="L1412">		methodStart(&quot;updateSPQueue&quot;);</span>
<span class="fc" id="L1413">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="fc" id="L1415">			dao.updateObject(objValue);</span>
<span class="fc bfc" id="L1416" title="All 2 branches covered.">			if (objValue.IsSkillsUpdated()) {</span>
<span class="fc" id="L1417">				dao.linkSkillsToSPQueue(objValue.getID(), objValue.getSkills());</span>
			}
<span class="nc" id="L1419">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1420">			handleException(e);</span>
<span class="nc" id="L1421">			throw e;</span>
<span class="nc" id="L1422">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1423">			handleException(e);</span>
<span class="nc" id="L1424">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="pc" id="L1426">			dao.cleanUp();</span>
<span class="pc" id="L1427">			methodFinish();</span>
<span class="fc" id="L1428">		}</span>
<span class="fc" id="L1429">	}</span>

	/**
	 * Updates the given collection of spqueues, and the skills associated to
	 * them (spqueueskills).
	 */
	public void updateSPQueues(Collection&lt;SPQueue&gt; spQueues) throws BbmUpdateException, MultiUserException {
<span class="nc" id="L1436">		methodStart(&quot;updateSPQueues&quot;);</span>
<span class="nc" id="L1437">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1439">			dao.updateObjects(spQueues);</span>
<span class="nc" id="L1440">			Map&lt;ID, Collection&lt;ID&gt;&gt; spQueueSkillMap = new HashMap&lt;ID, Collection&lt;ID&gt;&gt;();</span>
<span class="nc bnc" id="L1441" title="All 2 branches missed.">			for (SPQueue spQueue : spQueues) {</span>
<span class="nc bnc" id="L1442" title="All 2 branches missed.">				if (spQueue.IsSkillsUpdated()) {</span>
<span class="nc" id="L1443">					spQueueSkillMap.put(spQueue.getDEID(), spQueue.getSkills());</span>
				}
<span class="nc" id="L1445">			}</span>
<span class="nc bnc" id="L1446" title="All 2 branches missed.">			if (spQueueSkillMap.isEmpty() == false) {</span>
<span class="nc" id="L1447">				dao.linkSkillsToSPQueues(spQueueSkillMap);</span>
			}
<span class="nc" id="L1449">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1450">			handleException(e);</span>
<span class="nc" id="L1451">			throw e;</span>
<span class="nc" id="L1452">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1453">			handleException(e);</span>
<span class="nc" id="L1454">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L1456">			dao.cleanUp();</span>
<span class="nc" id="L1457">			methodFinish();</span>
<span class="nc" id="L1458">		}</span>
<span class="nc" id="L1459">	}</span>

	/**
	 * Creates the SPQueues. This method is specifically written to optimize
	 * the bulk push from the Branch Forecasting. This only reads the following
	 * fields of the SPqueue while creating the spqueues- spid, queueid, media
	 * id, service level type, patience, sl anwer waiting time.
	 */
	public SPQueueIDMap createSPQueuesWithLimitedFields(Collection&lt;SPQueue&gt; spQueues) throws BbmCreateException {
<span class="nc" id="L1468">		methodStart(&quot;createSPQueuesWithLimitedFields&quot;, spQueues);</span>
<span class="nc" id="L1469">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1471">			return dao.createSPQueuesWithLimitedFields(spQueues);</span>
<span class="nc" id="L1472">		} catch (JdmoException e) {</span>
<span class="nc" id="L1473">			handleException(e);</span>
<span class="nc" id="L1474">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L1476">			dao.cleanUp();</span>
<span class="nc" id="L1477">			methodFinish();</span>
		}
	}

	/**
	 * Updates the SPQueues. This method is specifically written to optimize
	 * the bulk push from the Branch Forecasting. This only reads the following
	 * fields of the SPqueue while updating the spqueues- spid, queueid, media
	 * id, service level type, patience, sl anwer waiting time.
	 *
	 */
	public void updateSPQueuesWithLimitedFields(Collection&lt;SPQueue&gt; spQueues) throws BbmUpdateException {
<span class="nc" id="L1489">		methodStart(&quot;updateSPQueuesWithLimitedFields&quot;, spQueues);</span>
<span class="nc" id="L1490">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1492">			dao.updateSPQueuesWithLimitedFields(spQueues);</span>
<span class="nc" id="L1493">		} catch (JdmoException e) {</span>
<span class="nc" id="L1494">			handleException(e);</span>
<span class="nc" id="L1495">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L1497">			dao.cleanUp();</span>
<span class="nc" id="L1498">			methodFinish();</span>
<span class="nc" id="L1499">		}</span>
<span class="nc" id="L1500">	}</span>

	/**
	 * Deleted a sp queue
	 *
	 * @spQueueID the ID of the sp queue to delete
	 */
	public void deleteSPQueue(ID spQueueID) throws BbmRemoveException {
<span class="nc" id="L1508">		methodStart(&quot;deleteSPQueue&quot;);</span>
<span class="nc" id="L1509">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1511">			dao.deleteSPQueue(spQueueID);</span>
<span class="nc" id="L1512">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1513">			handleException(e);</span>
<span class="nc" id="L1514">			throw e;</span>
		} finally {
<span class="nc" id="L1516">			dao.cleanUp();</span>
<span class="nc" id="L1517">			methodFinish();</span>
<span class="nc" id="L1518">		}</span>
<span class="nc" id="L1519">	}</span>

	public Collection&lt;SPQueue&gt; getSPQueues(Collection&lt;ID&gt; spQueueIDs) throws BbmFinderException {
<span class="nc" id="L1522">		methodStart(&quot;getSPQueues&quot;);</span>
<span class="nc" id="L1523">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1525">			return dao.getObjectsByIDs(spQueueIDs);</span>
<span class="nc" id="L1526">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1527">			handleException(e);</span>
<span class="nc" id="L1528">			throw e;</span>
		} finally {
<span class="nc" id="L1530">			dao.cleanUp();</span>
<span class="nc" id="L1531">			methodFinish();</span>
		}
	}

	public SPQueue getSPQueue(ID spQueueID) throws BbmFinderException {
<span class="fc" id="L1536">		methodStart(&quot;getSPQueue&quot;);</span>
<span class="fc" id="L1537">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="fc" id="L1539">			return dao.getSPQueue(spQueueID);</span>
<span class="nc" id="L1540">		} catch (JdmoException e) {</span>
<span class="nc" id="L1541">			handleException(e);</span>
<span class="nc" id="L1542">			throw new BbmFinderException(e);</span>
<span class="nc" id="L1543">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L1544">			handleException(e);</span>
<span class="nc" id="L1545">			throw e;</span>
<span class="nc" id="L1546">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1547">			handleException(e);</span>
<span class="nc" id="L1548">			throw e;</span>
		} finally {
<span class="pc" id="L1550">			dao.cleanUp();</span>
<span class="pc" id="L1551">			methodFinish();</span>
		}
	}

	public SPQueue getSPQueue(ID spID, ID queueID) throws BbmFinderException {
<span class="fc" id="L1556">		methodStart(&quot;getSPQueue&quot;);</span>
<span class="fc" id="L1557">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="fc" id="L1559">			ID id = SPQueueDAO.getSPQueueID(spID, queueID);</span>
<span class="fc" id="L1560">			return dao.getSPQueue(id);</span>
<span class="nc" id="L1561">		} catch (JdmoException e) {</span>
<span class="nc" id="L1562">			handleException(e);</span>
<span class="nc" id="L1563">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L1565">			dao.cleanUp();</span>
<span class="pc" id="L1566">			methodFinish();</span>
		}
	}

	// SpQueueIDs are SIDs
	public Collection&lt;SPQueue&gt; getSPQueuesByIDs(Collection&lt;ID&gt; spQueueIDs) throws BbmFinderException {
<span class="fc" id="L1572">		methodStart(&quot;getSPQueuesByIDs&quot;);</span>
<span class="fc" id="L1573">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="fc" id="L1575">			return dao.getSPQueuesByIDs(spQueueIDs);</span>
		} finally {
<span class="pc" id="L1577">			dao.cleanUp();</span>
<span class="pc" id="L1578">			methodFinish();</span>
		}
	}

	public SPQueue getCombinedSPQueue(ID spID, ID mediaID) throws BbmFinderException {
<span class="fc" id="L1583">		methodStart(&quot;getCombinedSPQueue&quot;, spID, mediaID);</span>
<span class="fc" id="L1584">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="fc" id="L1586">			return dao.getCombinedSPQueue(spID, mediaID);</span>
<span class="nc" id="L1587">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1588">			handleException(e);</span>
<span class="nc" id="L1589">			throw e;</span>
		} finally {
<span class="pc" id="L1591">			dao.cleanUp();</span>
<span class="pc" id="L1592">			methodFinish();</span>
		}
	}

	/**
	 * Returns a list of combined SPQueues associated to (i.e. having the same
	 * SP and media ID of) the given list of spQueues.
	 */
	public Collection&lt;SPQueue&gt; getCombinedSPQueues(Collection&lt;SPQueue&gt; spQueues) throws BbmFinderException {
<span class="nc" id="L1601">		methodStart(&quot;getCombinedSPQueues&quot;, spQueues);</span>
<span class="nc" id="L1602">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1604">			return dao.getCombinedSPQueues(spQueues);</span>
<span class="nc" id="L1605">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1606">			handleException(e);</span>
<span class="nc" id="L1607">			throw e;</span>
		} finally {
<span class="nc" id="L1609">			dao.cleanUp();</span>
<span class="nc" id="L1610">			methodFinish();</span>
		}
	}

	/**
	 * @deprecated
	 */
	@Deprecated
	public Collection&lt;SPQueue&gt; getSPQueuesBySPIDs(Collection&lt;ID&gt; SPIDs) throws BbmFinderException {
<span class="nc" id="L1619">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1621">			return dao.getSPQueuesBySPIDs(SPIDs);</span>
<span class="nc" id="L1622">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1623">			handleException(e);</span>
<span class="nc" id="L1624">			throw e;</span>
<span class="nc" id="L1625">		} catch (Exception e) {</span>
<span class="nc" id="L1626">			handleException(e);</span>
<span class="nc" id="L1627">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1629">			dao.cleanUp();</span>
<span class="nc" id="L1630">			methodFinish();</span>
		}
	}

	/**
	 * Returns all non-combined SPQueues linked to the given Scheduling Periods.  For combined SPQueues in an SP, please
	 * use {@link CampaignManagerEJB#getCombinedSPQueue(ID, ID)}
	 */
	public Collection&lt;SPQueue&gt; getSPQueuesBySPIDsFixed(Collection&lt;ID&gt; SPSIDs) throws BbmFinderException {
<span class="nc" id="L1639">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1641">			return dao.getSPQueuesBySPIDsFixed(SPSIDs);</span>
<span class="nc" id="L1642">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1643">			handleException(e);</span>
<span class="nc" id="L1644">			throw e;</span>
<span class="nc" id="L1645">		} catch (Exception e) {</span>
<span class="nc" id="L1646">			handleException(e);</span>
<span class="nc" id="L1647">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1649">			dao.cleanUp();</span>
<span class="nc" id="L1650">			methodFinish();</span>
		}
	}

	/**
	 * Returns a paginated set of SPQueues for the given scheduling period. The
	 * returned value includes the following: a chunk of SPQueue value objects,
	 * representing the sp queues on the first viewed page, and a sorted list of
	 * SPQueue IDs that are sorted by the given sort fields in the comparators
	 * map.
	 */
	public PaginationPair&lt;SPQueue&gt; getPaginatedSPQueuesForSchedulingPeriod(ID spID, boolean isAscendingSort, int pageIDSize,
			int pageIndex, LinkedHashMap&lt;DBSortField, Comparator&gt; comparators, Collection&lt;ID&gt; filteredIDs)
			throws BbmFinderException {
<span class="fc" id="L1664">		methodStart(&quot;getPaginatedSPQueuesForSchedulingPeriod&quot;, spID, isAscendingSort, pageIDSize, pageIndex, comparators);</span>
<span class="fc" id="L1665">		SPQueueDAO spqDAO = new SPQueueDAO();</span>

		try {
<span class="fc" id="L1668">			return spqDAO.getCompletePaginationDataSetForSchedulingPeriod(spID, isAscendingSort, pageIDSize, pageIndex,</span>
					comparators, filteredIDs);
<span class="nc" id="L1670">		} catch (BbmFinderException ex) {</span>
<span class="nc" id="L1671">			handleException(ex);</span>
<span class="nc" id="L1672">			throw ex;</span>
		} finally {
<span class="pc" id="L1674">			spqDAO.cleanUp();</span>
<span class="pc" id="L1675">			methodFinish();</span>
		}
	}

	/*
	 * Returns the non-combined SPQueues belonging to the given SP with the
	 * specified media ID. If a null media ID is specified, it will return all
	 * non-combined SPQueues in belonging to the SP.
	 */
	public Collection&lt;SPQueue&gt; getNonCombinedSPQueuesByMediaAndSP(ID spID, ID mediaID) throws BbmFinderException {
<span class="nc" id="L1685">		methodStart(&quot;getNonCombinedSPQueuesByMediaAndSP&quot;, spID, mediaID);</span>
<span class="nc" id="L1686">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1688">			return dao.getNonCombinedSPQueuesByMediaAndSP(spID, mediaID);</span>
<span class="nc" id="L1689">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1690">			handleException(e);</span>
<span class="nc" id="L1691">			throw e;</span>
		} finally {
<span class="nc" id="L1693">			dao.cleanUp();</span>
<span class="nc" id="L1694">			methodFinish();</span>
		}
	}

	/**
	 * Deleted collection of campaigns
	 *
	 * @colCampaignIDs the IDs of the campaigns to delete
	 */
	public void deleteCampaigns(Collection&lt;ID&gt; colCampaignIDs) throws BbmRemoveException {
<span class="nc" id="L1704">		methodStart(&quot;deleteCampaigns&quot;);</span>
		try {
<span class="nc" id="L1706">			CampaignDAO.deleteCampaigns(colCampaignIDs);</span>
<span class="nc" id="L1707">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1708">			handleException(e);</span>
<span class="nc" id="L1709">			throw e;</span>
		} finally {
<span class="nc" id="L1711">			methodFinish();</span>
<span class="nc" id="L1712">		}</span>
<span class="nc" id="L1713">	}</span>

	public void deleteAllCampaigns() throws BbmRemoveException {
<span class="nc" id="L1716">		methodStart(&quot;deleteAllCampaigns&quot;);</span>
		try {
<span class="nc" id="L1718">			CampaignDAO.deleteAllCampaigns();</span>
<span class="nc" id="L1719">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1720">			handleException(e);</span>
<span class="nc" id="L1721">			throw e;</span>
		} finally {
<span class="nc" id="L1723">			methodFinish();</span>
<span class="nc" id="L1724">		}</span>
<span class="nc" id="L1725">	}</span>

	public void unlinkWorkResourcesToSchedulingPeriod(ID spID, ID SPDEID, Collection wkrsIDs) throws BbmRemoveException {
<span class="nc" id="L1728">		methodStart(&quot;unlinkWorkResourcesToSchedulingPeriod&quot;, spID, SPDEID, wkrsIDs);</span>
<span class="nc" id="L1729">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1731">			dao.unlinkWorkResourcesToSchedulingPeriod(spID, SPDEID, wkrsIDs);</span>
<span class="nc" id="L1732">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1733">			handleException(e, false);</span>
<span class="nc" id="L1734">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1736" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1737">				dao.cleanUp();</span>
			}
<span class="nc" id="L1739">			methodFinish();</span>
<span class="nc" id="L1740">		}</span>
<span class="nc" id="L1741">	}</span>

	public void linkWorkResourcesToSchedulingPeriod(ID spID, Collection wkrsIDs) throws BbmCreateException {
<span class="fc" id="L1744">		methodStart(&quot;linkWorkResourcesToSchedulingPeriod&quot;, spID, wkrsIDs);</span>
<span class="fc" id="L1745">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="fc" id="L1747">			dao.linkWorkResourcesToSchedulingPeriod(spID, wkrsIDs);</span>
<span class="nc" id="L1748">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1749">			handleException(e, false);</span>
<span class="nc" id="L1750">			throw e;</span>
		} finally {
<span class="pc bpc" id="L1752" title="3 of 4 branches missed.">			if (dao != null) {</span>
<span class="pc" id="L1753">				dao.cleanUp();</span>
			}
<span class="pc" id="L1755">			methodFinish();</span>
<span class="fc" id="L1756">		}</span>
<span class="fc" id="L1757">	}</span>

	/**
	 * get parent scheduling period by id
	 */
	public ID getParentSchedulingPeriodID(ID idSubSP) throws BbmFinderException {
<span class="nc" id="L1763">		methodStart(&quot;getParentSchedulingPeriodByID&quot;, idSubSP);</span>
<span class="nc" id="L1764">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1766">			return dao.getParentSchedulingPeriodID(idSubSP);</span>
<span class="nc" id="L1767">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1768">			handleException(e, false);</span>
<span class="nc" id="L1769">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1771" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1772">				dao.cleanUp();</span>
			}
<span class="nc" id="L1774">			methodFinish();</span>
		}
	}

	// this API will returns all the shift ID defined for this campaign or
	// inherited from the org linked to campaign
	public Collection&lt;ID&gt; getShift(ID campaignSID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L1781">		methodStart(&quot;getShift&quot;, campaignSID, dtStart, dtEnd);</span>
<span class="fc" id="L1782">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="fc" id="L1784">			HashSet&lt;ID&gt; shifts = new HashSet&lt;ID&gt;();</span>
			// first find the shifts inherited from orgs that links to this
			// campaign and the shifts defined for this
			// campaign
<span class="fc" id="L1788">			shifts.addAll(getShiftForCampaign(dmo, campaignSID, dtStart, dtEnd));</span>
			// for distributed campaign, if the current campaign is parent, it
			// can access all the shifts defined for the
			// children
<span class="fc" id="L1792">			StringBuffer sb = new StringBuffer(100);</span>
<span class="fc" id="L1793">			sb.append(&quot;select sid from campaign where parentcampaignid in (select id from campaign where sid =&quot;)</span>
<span class="fc" id="L1794">					.append(campaignSID).append(&quot;)&quot;);</span>
<span class="fc" id="L1795">			JdmoRowset rs = dmo.createRowset(sb.toString());</span>
<span class="fc" id="L1796">			ArrayList&lt;ID&gt; relatedSID = new ArrayList&lt;ID&gt;();</span>
<span class="pc bpc" id="L1797" title="1 of 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1798">				relatedSID.add(rs.getID(1)); // all children</span>
			}

			// for distributed campaign, if it is child, it can access all the
			// shifts defined for its parent
<span class="fc" id="L1803">			Campaign current = this.getCampaignByID(campaignSID);</span>
<span class="pc bpc" id="L1804" title="1 of 2 branches missed.">			if (current.getParentID() != null) {</span>
<span class="nc" id="L1805">				relatedSID.add(current.getParentID());</span>
			}

<span class="pc bpc" id="L1808" title="1 of 2 branches missed.">			for (Iterator&lt;ID&gt; i = relatedSID.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L1809">				shifts.addAll(getShiftForCampaign(dmo, i.next(), dtStart, dtEnd));</span>
			}

			// remove predefined SHIFT_OFF fromt the list
<span class="fc" id="L1813">			ID shiftID = null;</span>
<span class="fc bfc" id="L1814" title="All 2 branches covered.">			for (Iterator&lt;ID&gt; i = shifts.iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L1815">				shiftID = i.next();</span>
<span class="fc bfc" id="L1816" title="All 2 branches covered.">				if (shiftID.toInt() == 1) {</span>
<span class="fc" id="L1817">					i.remove();</span>
				}
			}
<span class="fc" id="L1820">			return new ArrayList&lt;ID&gt;(shifts);</span>
<span class="nc" id="L1821">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1822">			handleException(e, false);</span>
<span class="nc" id="L1823">			throw e;</span>
<span class="nc" id="L1824">		} catch (Exception e) {</span>
<span class="nc" id="L1825">			handleException(e, false);</span>
<span class="nc" id="L1826">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L1828">			dmo.cleanUp();</span>
<span class="pc" id="L1829">			methodFinish();</span>
		}
	}

	private Collection&lt;ID&gt; getShiftForCampaign(Jdmo dmo, ID campaignSID, Date dtStart, Date dtEnd) throws Exception {
<span class="fc" id="L1834">		Collection orgIDs = getCampaignOrgs(dmo, campaignSID, dtStart, dtEnd);</span>
<span class="fc" id="L1835">		orgIDs.addAll(m_workResourceManager.getOrganizationsParentsByIDs(orgIDs));</span>

<span class="fc" id="L1837">		StringBuffer sbWhere = new StringBuffer(200);</span>
<span class="fc" id="L1838">		sbWhere.append(&quot;( CAMPAIGNID IN (SELECT ID FROM CAMPAIGN WHERE SID = &quot;).append(campaignSID).append(&quot;)&quot;);</span>
<span class="pc bpc" id="L1839" title="1 of 2 branches missed.">		if (!orgIDs.isEmpty()) {</span>
<span class="fc" id="L1840">			sbWhere.append(&quot; OR ORGANIZATIONID IN &quot;).append(dmo.createInClause(new HashSet(orgIDs)));</span>
		}
<span class="fc" id="L1842">		sbWhere.append(&quot;)&quot;);</span>
		// fix QC60132, not return deleted shifts
<span class="fc" id="L1844">		sbWhere.append(&quot; AND DELETEONDATE IS NULL order by name&quot;);</span>

<span class="fc" id="L1846">		JdmoRowset rs = dmo.createRowset(&quot;select sid from shift where &quot; + sbWhere.toString());</span>
<span class="fc" id="L1847">		Collection&lt;ID&gt; shiftIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L1848" title="All 2 branches covered.">		while (rs.next()) {</span>
<span class="fc" id="L1849">			shiftIDs.add(rs.getID(1));</span>
		}
<span class="fc" id="L1851">		return shiftIDs;</span>
	}

	public Collection&lt;ID&gt; getOrganizationsForCampaign(ID campaignSID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L1855">		methodStart(&quot;getOrganizationsForCampaign&quot;, campaignSID, dtStart, dtEnd);</span>
<span class="fc" id="L1856">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="fc" id="L1858">			return getCampaignOrgs(dmo, campaignSID, dtStart, dtEnd);</span>
<span class="nc" id="L1859">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1860">			handleException(e, false);</span>
<span class="nc" id="L1861">			throw e;</span>
		} finally {
<span class="pc" id="L1863">			dmo.cleanUp();</span>
<span class="pc" id="L1864">			methodFinish();</span>
		}
	}

	private Collection&lt;ID&gt; getCampaignOrgs(Jdmo dmo, ID campaignSID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L1869">		CampaignOrgDAO dao = new CampaignOrgDAO(dmo);</span>
<span class="fc" id="L1870">		Campaign campaign = getCampaignByID(campaignSID);</span>
<span class="fc" id="L1871">		Collection&lt;CampaignOrg&gt; campOrgs = dao.getCampaignOrgAssignments(campaignSID, dtStart, dtEnd,</span>
<span class="fc" id="L1872">				campaign.getIsDistributed());</span>
<span class="fc" id="L1873">		ArrayList&lt;ID&gt; orgIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L1874">		CampaignOrg assignment = null;</span>
<span class="fc bfc" id="L1875" title="All 2 branches covered.">		for (Iterator&lt;CampaignOrg&gt; i = campOrgs.iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L1876">			assignment = i.next();</span>
<span class="fc" id="L1877">			orgIDs.add(assignment.getOrganizationID());</span>
		}
<span class="fc" id="L1879">		return orgIDs;</span>
	}

	/**
	 * this API is created by angela in v11, to retrieve all the SPs for a
	 * campaign.
	 *
	 * @param campaign
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(Campaign campaign) throws BbmFinderException {
<span class="fc" id="L1891">		methodStart(&quot;getSchedulingPeriods&quot;);</span>
<span class="fc" id="L1892">		SchedulingPeriodDAO dao = null;</span>
		try {
<span class="fc" id="L1894">			dao = new SchedulingPeriodDAO();</span>
<span class="fc" id="L1895">			return dao.getSchedulingPeriods(campaign);</span>
<span class="nc" id="L1896">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1897">			handleException(e);</span>
<span class="nc" id="L1898">			throw e;</span>
		} finally {
<span class="pc bpc" id="L1900" title="3 of 4 branches missed.">			if (dao != null) {</span>
<span class="pc" id="L1901">				dao.cleanUp();</span>
			}
<span class="pc" id="L1903">			methodFinish();</span>
		}
	}

	/**
	 * getFTECalculator for the specified collection of employees/phantoms and
	 * events in the SP.
	 *
	 * @param idSP            - The SP SID.
	 * @param hasProjectQueue - Is there a Project queue linked to the SP?
	 * @param wrIds           - the selected employee/phantom ID's. Only these will be
	 *                        considered for the FTE calculations. If you pass null here, we
	 *                        will assume all emploees/phantoms/events in the entire SP.
	 * @param defaultWage     - The default wage to use when the employee's wage is $0.0,
	 *                        for calculating the &quot;Total Scheduled Cost&quot;.
	 */
	public FTECalculator getFTECalculator(ID idSP, boolean hasProjectQueue, Collection&lt;ID&gt; wrIds, double defaultWage)
			throws BbmFinderException {
<span class="nc" id="L1921">		methodStart(&quot;getFTECalculator&quot;, idSP, wrIds);</span>
		try {
<span class="nc" id="L1923">			ScheduleAccessManager mScheduleAccess = WfmManagerFactory.getScheduleAccessManager(m_isWhatIf);</span>
<span class="nc" id="L1924">			ActivityManager mActivity = WfmManagerFactory.getActivityManager(m_isWhatIf);</span>
<span class="nc" id="L1925">			TimeSeriesManager mTimeSeries = WfmManagerFactory.getTimeSeriesManager(m_isWhatIf);</span>
<span class="nc" id="L1926">			WorkloadManager mWorkLoad = WfmManagerFactory.getWorkloadManager(m_isWhatIf);</span>
<span class="nc" id="L1927">			ForecastTimeSeriesManager mForcastTimeSeries = WfmManagerFactory.getForecastTimeSeriesManager(m_isWhatIf);</span>

<span class="nc" id="L1929">			SchedulingPeriod pPeriod = getSchedulingPeriodByID(idSP);</span>
<span class="nc" id="L1930">			Date dtStart = pPeriod.getStartTime();</span>
<span class="nc" id="L1931">			Date dtEnd = pPeriod.getEndTime();</span>

<span class="nc" id="L1933">			ID campaignID = pPeriod.getCampaignID();</span>
<span class="nc" id="L1934">			Campaign pCampaign = getCampaignByID(campaignID);</span>

<span class="nc" id="L1936">			Collection&lt;CampaignHOO&gt; cHOOs = getCampaignHOOAssignments(pPeriod.getID(), dtStart, dtEnd);</span>

<span class="nc" id="L1938">			Collection&lt;CampaignWorkResource&gt; cWorkResourceAssignments = getCampaignWorkResourceAssignments(campaignID,</span>
					dtStart, dtEnd);
<span class="nc" id="L1940">			TreeSet&lt;ID&gt; cEmployeeIDs = new TreeSet&lt;&gt;();</span>
<span class="nc bnc" id="L1941" title="All 2 branches missed.">			for (Iterator j = cWorkResourceAssignments.iterator(); j.hasNext(); ) {</span>
<span class="nc" id="L1942">				CampaignWorkResource cAssignment = (CampaignWorkResource) j.next();</span>

				// retain only the Employees that are in workResIds
<span class="nc bnc" id="L1945" title="All 4 branches missed.">				if (wrIds == null || wrIds.contains(cAssignment.getWorkResourceID())) {</span>
<span class="nc" id="L1946">					cEmployeeIDs.add(cAssignment.getWorkResourceID());</span>
				}
<span class="nc" id="L1948">			}</span>
<span class="nc" id="L1949">			Collection cEmployees = m_workResourceManager.getEmployeesByIDs(cEmployeeIDs, dtStart,</span>
					Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);

<span class="nc" id="L1952">			Collection&lt;Phantom&gt; cPhantoms = mScheduleAccess.getPhantoms(idSP);</span>

			// retain only the Phantoms that are in workResIds
<span class="nc" id="L1955">			Collection&lt;Phantom&gt; cPhantomsRetained = new ArrayList&lt;&gt;(cPhantoms.size());</span>
<span class="nc bnc" id="L1956" title="All 2 branches missed.">			for (Iterator pIt = cPhantoms.iterator(); pIt.hasNext(); ) {</span>
<span class="nc" id="L1957">				Phantom phantom = (Phantom) pIt.next();</span>
<span class="nc bnc" id="L1958" title="All 4 branches missed.">				if (wrIds == null || wrIds.contains(phantom.getID())) {</span>
<span class="nc" id="L1959">					cPhantomsRetained.add(phantom);</span>
				}
<span class="nc" id="L1961">			}</span>

<span class="nc" id="L1963">			ArrayList&lt;ID&gt; aWorkResourceIDs = new ArrayList&lt;&gt;(cEmployeeIDs);</span>
<span class="nc" id="L1964">			Collection&lt;EmployeeTemplate&gt; cEmpTemplates = new ArrayList&lt;&gt;(cPhantomsRetained.size());</span>
<span class="nc" id="L1965">			Map&lt;ID, ID&gt; hPhantomsIdsToEmpTemplateIDs = new LinkedHashMap&lt;&gt;(cPhantomsRetained.size());</span>

			// temporary Set for keeping track of employee templates added to cEmpTemplates
<span class="nc" id="L1968">			Set&lt;EmployeeTemplate&gt; empTemplatesSet = new HashSet&lt;&gt;();</span>

<span class="nc" id="L1970">			Iterator&lt;Phantom&gt; phantomIt = cPhantomsRetained.iterator();</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">			while (phantomIt.hasNext()) {</span>
<span class="nc" id="L1972">				Phantom phantom = phantomIt.next();</span>

				// aWorkResourceIDs contains employeeIDs followed by phantomIDs
<span class="nc" id="L1975">				aWorkResourceIDs.add(phantom.getID());</span>
<span class="nc" id="L1976">				EmployeeTemplate empTemplate = m_scheduleAccessManager.getEmployeeTemplateByID(</span>
<span class="nc" id="L1977">					phantom.getEmployeeTemplateID());</span>
<span class="nc" id="L1978">				cEmpTemplates.add(empTemplate);</span>
<span class="nc" id="L1979">				empTemplatesSet.add(empTemplate);</span>
<span class="nc" id="L1980">				hPhantomsIdsToEmpTemplateIDs.put(phantom.getID(), phantom.getEmployeeTemplateID());</span>
<span class="nc" id="L1981">			}</span>

			// Get any remaining Staffing Profiles linked to this SP that have
			// not been scheduled.
<span class="nc" id="L1985">			Collection allEmpTemplatesInSP = m_scheduleAccessManager.getEmployeeTemplatesInSP(idSP);</span>
<span class="nc bnc" id="L1986" title="All 2 branches missed.">			for (Iterator spTempIt = allEmpTemplatesInSP.iterator(); spTempIt.hasNext(); ) {</span>
<span class="nc" id="L1987">				EmployeeTemplate et = (EmployeeTemplate) spTempIt.next();</span>
<span class="nc bnc" id="L1988" title="All 2 branches missed.">				if (!empTemplatesSet.contains(et)) {</span>
<span class="nc" id="L1989">					cEmpTemplates.add(et);</span>
<span class="nc" id="L1990">					empTemplatesSet.add(et);</span>
				}
<span class="nc" id="L1992">			}</span>

			Collection cSchedules;
<span class="nc" id="L1995">			cSchedules = mScheduleAccess.getEventsForWorkResources(aWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L1996">			Map&lt;ID, Collection&lt;Event&gt;&gt; wrIdsToEventsMap = new HashMap&lt;ID, Collection&lt;Event&gt;&gt;();</span>
<span class="nc" id="L1997">			Iterator scheduleIt = cSchedules.iterator();</span>
<span class="nc bnc" id="L1998" title="All 2 branches missed.">			for (Iterator it = aWorkResourceIDs.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L1999">				ID id = (ID) it.next();</span>
<span class="nc" id="L2000">				Collection schedulesForCurEmp = (Collection) scheduleIt.next();</span>
<span class="nc" id="L2001">				wrIdsToEventsMap.put(id, schedulesForCurEmp);</span>
<span class="nc" id="L2002">			}</span>

			// get the set of Activity ID's from the schedules.

<span class="nc" id="L2006">			TreeSet activityIdSet = new TreeSet();</span>
<span class="nc bnc" id="L2007" title="All 2 branches missed.">			for (Iterator schedIt = cSchedules.iterator(); schedIt.hasNext(); ) {</span>
<span class="nc" id="L2008">				Collection cAssignments = (Collection) schedIt.next();</span>
<span class="nc bnc" id="L2009" title="All 2 branches missed.">				if (cAssignments != null) {</span>
					// flatten the Event collection first.
<span class="nc" id="L2011">					Collection colFlattenedEvents = EventUtils.convertEventsToTimelineForSingleEmployee(cAssignments, null,</span>
							null, null, true);

<span class="nc bnc" id="L2014" title="All 2 branches missed.">					for (Iterator assignmentIt = colFlattenedEvents.iterator(); assignmentIt.hasNext(); ) {</span>
<span class="nc" id="L2015">						Event pEvent = (Event) assignmentIt.next();</span>
<span class="nc" id="L2016">						activityIdSet.add(pEvent.getActivityID());</span>

<span class="nc bnc" id="L2018" title="All 2 branches missed.">						for (Iterator childEventIt = pEvent.getChildren().iterator(); childEventIt.hasNext(); ) {</span>
<span class="nc" id="L2019">							pEvent = (Event) childEventIt.next();</span>
<span class="nc" id="L2020">							activityIdSet.add(pEvent.getActivityID());</span>
						}
<span class="nc" id="L2022">					}</span>
				}
<span class="nc" id="L2024">			}</span>

			// retrieve the ActivityMedia's and ActivityQueue's
<span class="nc" id="L2027">			Map&lt;ID, Collection&lt;ID&gt;&gt; activityIdToMediaIds = mActivity.findMediaForActivities(activityIdSet);</span>
<span class="nc" id="L2028">			Map mActivityQueues = mActivity.findQueueForActivities(activityIdSet);</span>

			// Get required TraceCube for the combined queue
<span class="nc" id="L2031">			short[] types = {Trace.FTE};</span>
<span class="nc" id="L2032">			TraceCube tRequirements = new RequireTraceCube(null, dtStart, dtEnd, types);</span>
<span class="nc bnc" id="L2033" title="All 2 branches missed.">			ID mediaID = pPeriod.getSkillBased() ? null : Media.MEDIA_ID_PHONE;</span>
<span class="nc" id="L2034">			Collection cubeCol = mTimeSeries.getRawCombinedQueuesTimeSeries(tRequirements, campaignID, mediaID, dtStart,</span>
					dtEnd);
<span class="nc bnc" id="L2036" title="All 2 branches missed.">			if (cubeCol != null) {</span>
<span class="nc bnc" id="L2037" title="All 2 branches missed.">				for (Iterator it = cubeCol.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2038">					tRequirements = (TraceCube) it.next();</span>
				}
			}

			// Get the data for Project Statistics
<span class="nc" id="L2043">			Collection&lt;ForecastProfileProject&gt; forecastProfileProjects = null;</span>
			// a map of project queue DEID to queue name
<span class="nc" id="L2045">			Map projectQueueIdNameMap = null;</span>
			// a map of project queue DEID to SID
<span class="nc" id="L2047">			Map projectQueueIdSIDMap = null;</span>
<span class="nc bnc" id="L2048" title="All 2 branches missed.">			if (hasProjectQueue) {</span>
				// Get the SPQueue ID's.
<span class="nc" id="L2050">				ArrayList spQueueIDs = null;</span>
<span class="nc" id="L2051">				Collection spQueues = getNonCombinedSPQueuesByMediaAndSP(idSP, Media.MEDIA_ID_PROJECT);</span>
<span class="nc bnc" id="L2052" title="All 4 branches missed.">				if (spQueues != null &amp;&amp; !spQueues.isEmpty()) {</span>
<span class="nc" id="L2053">					spQueueIDs = new ArrayList(spQueues.size());</span>
<span class="nc bnc" id="L2054" title="All 2 branches missed.">					for (Iterator spqIt = spQueues.iterator(); spqIt.hasNext(); ) {</span>
<span class="nc" id="L2055">						spQueueIDs.add(((SPQueue) spqIt.next()).getID());</span>
					}
				}

<span class="nc bnc" id="L2059" title="All 4 branches missed.">				if (spQueueIDs != null &amp;&amp; spQueueIDs.size() &gt; 0) {</span>
					// Get the ForecastProfileProject's for these SPQueueIDs
<span class="nc" id="L2061">					forecastProfileProjects = mForcastTimeSeries.getActiveProjects(spQueueIDs);</span>

					// Get the project queue names
<span class="nc bnc" id="L2064" title="All 4 branches missed.">					if (forecastProfileProjects != null &amp;&amp; forecastProfileProjects.size() &gt; 0) {</span>
<span class="nc" id="L2065">						HashSet queueDEIDs = new HashSet();</span>

<span class="nc bnc" id="L2067" title="All 2 branches missed.">						for (Iterator projectIt = forecastProfileProjects.iterator(); projectIt.hasNext(); ) {</span>
<span class="nc" id="L2068">							ForecastProfileProject project = (ForecastProfileProject) projectIt.next();</span>
<span class="nc" id="L2069">							queueDEIDs.add(project.getQueueID());</span>
<span class="nc" id="L2070">						}</span>

						// Get a Pair: a map of project queue DEID to queue
						// name, and a map of project queue DEID to SID.
<span class="nc" id="L2074">						Pair queueMapPair = mWorkLoad.getQueueNameSIDMapsByDEIDs(queueDEIDs);</span>
<span class="nc" id="L2075">						projectQueueIdNameMap = (Map) queueMapPair.getFirst();</span>
<span class="nc" id="L2076">						projectQueueIdSIDMap = (Map) queueMapPair.getSecond();</span>
					}
				}
			}

<span class="nc" id="L2081">			LinkedHashMap hEmployeeIDsToWages = new LinkedHashMap(cEmployees.size());</span>
<span class="nc bnc" id="L2082" title="All 2 branches missed.">			for (Iterator it = cEmployees.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2083">				Employee emp = (Employee) it.next();</span>
<span class="nc" id="L2084">				hEmployeeIDsToWages.put(emp.getID(), emp.getWage());</span>
<span class="nc" id="L2085">			}</span>

<span class="nc" id="L2087">			FTECalculator fteCalculator = new FTECalculator(hEmployeeIDsToWages, hPhantomsIdsToEmpTemplateIDs,</span>
					cEmpTemplates, tRequirements, activityIdToMediaIds, dtStart, dtEnd, forecastProfileProjects, projectQueueIdNameMap,
					projectQueueIdSIDMap, mActivityQueues, idSP, wrIdsToEventsMap, defaultWage);

<span class="nc" id="L2091">			return fteCalculator;</span>

<span class="nc" id="L2093">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2094">			handleException(e);</span>
<span class="nc" id="L2095">			throw e;</span>
<span class="nc" id="L2096">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L2097">			handleException(e);</span>
<span class="nc" id="L2098">			throw new BbmFinderException(e);</span>
<span class="nc" id="L2099">		} catch (RemoteException e) {</span>
<span class="nc" id="L2100">			handleException(e);</span>
<span class="nc" id="L2101">			throw new BbmFinderException(e);</span>
<span class="nc" id="L2102">		} catch (BbmTimeSeriesException e) {</span>
<span class="nc" id="L2103">			handleException(e);</span>
<span class="nc" id="L2104">			throw new BbmFinderException(e);</span>
<span class="nc" id="L2105">		} catch (JdmoException e) {</span>
<span class="nc" id="L2106">			handleException(e);</span>
<span class="nc" id="L2107">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L2109">			methodFinish();</span>
		}
	}

	/**
	 * Returns a collection of SchedulingPeriods associated with the campaigns
	 *
	 * @param campaigns
	 * @return schedulingPeriods
	 * @throws BbmFinderException
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(Collection&lt;Campaign&gt; campaigns) throws BbmFinderException {
<span class="fc" id="L2121">		methodStart(&quot;getSchedulingPeriods&quot;);</span>
<span class="fc" id="L2122">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="fc" id="L2124">			return dao.getSchedulingPeriods(campaigns);</span>
<span class="nc" id="L2125">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2126">			handleException(e, false);</span>
<span class="nc" id="L2127">			throw e;</span>
		} finally {
<span class="pc" id="L2129">			dao.cleanUp();</span>
<span class="pc" id="L2130">			methodFinish();</span>
		}
	}

	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByCampaignID(ID campaignSID) throws BbmFinderException {
<span class="nc" id="L2135">		methodStart(&quot;getSchedulingPeriodsByCampaignID&quot;);</span>
<span class="nc" id="L2136">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L2138">			return dao.getSchedulingPeriods(campaignSID);</span>
<span class="nc" id="L2139">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2140">			handleException(e, false);</span>
<span class="nc" id="L2141">			throw e;</span>
		} finally {
<span class="nc" id="L2143">			dao.cleanUp();</span>
<span class="nc" id="L2144">			methodFinish();</span>
		}
	}

	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByCampaignIDs(Collection&lt;ID&gt; campaignIDs, Date minDate,
			Date maxDate) throws BbmFinderException {
<span class="nc" id="L2150">		methodStart(&quot;getSchedulingPeriodsByCampaignIDs&quot;);</span>
<span class="nc" id="L2151">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L2153">			return dao.getSchedulingPeriodsByCampaignIDs(campaignIDs, minDate, maxDate);</span>
<span class="nc" id="L2154">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2155">			handleException(e, false);</span>
<span class="nc" id="L2156">			throw e;</span>
		} finally {
<span class="nc" id="L2158">			dao.cleanUp();</span>
<span class="nc" id="L2159">			methodFinish();</span>
		}
	}

	public Collection&lt;CampaignHOO&gt; getCampaignHOOsByCampaignIDs(Collection&lt;ID&gt; campaignIDs, Date minDate, Date maxDate)
			throws BbmFinderException {
<span class="nc" id="L2165">		methodStart(&quot;getCampaignHOOs&quot;);</span>
<span class="nc" id="L2166">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L2168">			return dao.getCampaignHOOsByCampaignIDs(campaignIDs, minDate, maxDate);</span>
<span class="nc" id="L2169">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2170">			handleException(e, false);</span>
<span class="nc" id="L2171">			throw e;</span>
		} finally {
<span class="nc" id="L2173">			dao.cleanUp();</span>
<span class="nc" id="L2174">			methodFinish();</span>
		}
	}

	/**
	 * Returns shrinkage and modeling factor data for the specified scheduling
	 * period. If no such data exist, then entries are created for hourly data,
	 * initialized to all zeros.
	 *
	 * @param spID
	 * @return
	 * @throws BbmCreateException
	 * @throws BbmFinderException
	 */
	public Collection&lt;SPShrinkage&gt; getOrCreateSPShrinkageBySPID(ID spID) throws BbmCreateException, BbmFinderException {
<span class="fc" id="L2189">		methodStart(&quot;getOrCreateSPShrinkageBySPID&quot;, spID);</span>
<span class="fc" id="L2190">		SPShrinkageDAO dao = new SPShrinkageDAO();</span>
		try {
<span class="fc" id="L2192">			String loginUserName = m_sessionContext.getCallerPrincipal().getName();</span>
<span class="fc" id="L2193">			return dao.getOrCreateShrinkageBySPID(spID, loginUserName);</span>
<span class="nc" id="L2194">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2195">			handleException(e, false);</span>
<span class="nc" id="L2196">			throw e;</span>
<span class="nc" id="L2197">		} catch (BbmCreateException bce) {</span>
<span class="nc" id="L2198">			handleException(bce);</span>
<span class="nc" id="L2199">			throw bce;</span>
		} finally {
<span class="pc" id="L2201">			dao.cleanUp();</span>
<span class="pc" id="L2202">			methodFinish();</span>
		}
	}

	/**
	 * Updates the database with the specified collection of SPShrinkage
	 * records. It is assumed that each record represents an already-created row
	 * in the database.
	 * &lt;p&gt;
	 * TODO: Once SPShrinkage is updated, FTE Requirements should be calculated
	 * for the affected SPQueues. This needs to occur in a separate transaction
	 * since FTE reqs are calc'd asynchronously via a JMS queue. Right now, the
	 * call to calculate FTE Requirements after shrinkage is done manually in
	 * the client but this should be moved to this method.
	 *
	 * @param spShrinkageCol
	 * @throws BbmCreateException
	 * @throws BbmUpdateException
	 * @throws MultiUserException
	 */
	public void updateSPShrinkage(Collection&lt;SPShrinkage&gt; spShrinkageCol) throws BbmUpdateException, MultiUserException {
<span class="fc" id="L2223">		methodStart(&quot;updateSPShrinkage&quot;, spShrinkageCol);</span>
<span class="fc" id="L2224">		SPShrinkageDAO dao = new SPShrinkageDAO();</span>
<span class="fc" id="L2225">		SPQueueDAO spQueueDAO = new SPQueueDAO();</span>
		try {
<span class="fc" id="L2227">			dao.updateObjects(spShrinkageCol);</span>
<span class="nc" id="L2228">		} catch (MultiUserException mue) {</span>
<span class="nc" id="L2229">			handleException(mue);</span>
<span class="nc" id="L2230">			throw new BbmUpdateException(mue);</span>
<span class="nc" id="L2231">		} catch (BbmUpdateException bue) {</span>
<span class="nc" id="L2232">			handleException(bue);</span>
<span class="nc" id="L2233">			throw bue;</span>
		} finally {
<span class="pc" id="L2235">			dao.cleanUp();</span>
<span class="pc" id="L2236">			spQueueDAO.cleanUp();</span>
<span class="pc" id="L2237">			methodFinish();</span>
<span class="fc" id="L2238">		}</span>
<span class="fc" id="L2239">	}</span>

	/**
	 * Returns all of the SPQueues associated to the Scheduling Periods in the
	 * collection of SPShrinkage value objects
	 *
	 * @param spShrinkageCol
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;SPQueue&gt; getSPQueuesFromSPShrinkage(Collection&lt;SPShrinkage&gt; spShrinkageCol) throws BbmFinderException {
<span class="fc" id="L2250">		methodStart(&quot;getSPQueueIDsFromSPShrinkage&quot;, spShrinkageCol);</span>
<span class="fc" id="L2251">		SPQueueDAO spQueueDAO = new SPQueueDAO();</span>
		try {
			// First retrieve the Scheduling Period IDs from the SPShrinkage
			// objects
<span class="fc" id="L2255">			Collection&lt;ID&gt; spIDs = new HashSet&lt;ID&gt;();</span>
<span class="fc bfc" id="L2256" title="All 2 branches covered.">			for (SPShrinkage spShrinkage : spShrinkageCol) {</span>
<span class="fc" id="L2257">				spIDs.add(spShrinkage.getSPID());</span>
<span class="fc" id="L2258">			}</span>
			// Then return the SPQueues belonging to those Scheduling periods.
<span class="fc" id="L2260">			return new HashSet&lt;SPQueue&gt;(spQueueDAO.getSPQueuesBySPIDs(spIDs));</span>
		} finally {
<span class="pc" id="L2262">			spQueueDAO.cleanUp();</span>
<span class="pc" id="L2263">			methodFinish();</span>
		}
	}

	public SchedulingState getSchedulingState(ID spSID, String modeChar) throws BbmFinderException {
<span class="fc" id="L2268">		methodStart(&quot;getSchedulingState&quot;, spSID);</span>
<span class="fc" id="L2269">		SchedulingStateDAO dao = new SchedulingStateDAO();</span>
		try {
<span class="fc" id="L2271">			String mode = &quot; and MODE='&quot; + modeChar + &quot;'&quot;;</span>
<span class="fc" id="L2272">			Collection col = dao.getObjects(&quot;SPID=&quot; + spSID + mode);</span>
<span class="pc bpc" id="L2273" title="1 of 4 branches missed.">			if (col != null &amp;&amp; !col.isEmpty()) {</span>
<span class="fc" id="L2274">				return (SchedulingState) col.iterator().next();</span>
			}
<span class="fc" id="L2276">			return null; // should never happen!</span>
<span class="nc" id="L2277">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2278">			handleException(e, false);</span>
<span class="nc" id="L2279">			throw e;</span>
		} finally {
<span class="pc" id="L2281">			dao.cleanUp();</span>
<span class="pc" id="L2282">			methodFinish();</span>
		}
	}

	public Map&lt;ID, Date&gt; getAllSchedulingStateLastUpdatedTimes()
			throws BbmFinderException {
<span class="fc" id="L2288">		methodStart(&quot;getAllSchedulingStateLastUpdatedTimes&quot;);</span>
<span class="fc" id="L2289">		SchedulingStateDAO dao = new SchedulingStateDAO();</span>

		try {
<span class="fc" id="L2292">			return dao.getTimeLastUpdatedBySPs();</span>
		} finally {
<span class="pc" id="L2294">			dao.cleanUp();</span>
<span class="pc" id="L2295">			methodFinish();</span>
		}
	}

	public Date getSchedulingStateLastUpdatedTime(ID spId, String mode)
			throws BbmFinderException {
<span class="fc" id="L2301">		methodStart(&quot;getSchedulingStateLastUpdatedTime&quot;);</span>
<span class="fc" id="L2302">		SchedulingStateDAO dao = new SchedulingStateDAO();</span>

		try {
<span class="fc" id="L2305">			return dao.getTimeLastUpdated(spId, mode);</span>
		} finally {
<span class="pc" id="L2307">			dao.cleanUp();</span>
<span class="pc" id="L2308">			methodFinish();</span>
		}
	}

	public void clearSchedulingState(ID spSID, String modeChar) throws BbmRemoveException {
<span class="fc" id="L2313">		methodStart(&quot;clearSchedulingState&quot;, spSID);</span>
<span class="fc" id="L2314">		SchedulingStateDAO dao = new SchedulingStateDAO();</span>
		try {
<span class="fc" id="L2316">			String mode = &quot;and MODE='&quot; + modeChar + &quot;'&quot;;</span>
<span class="fc" id="L2317">			dao.deleteObjects(&quot;select id from SPSCHEDSTATE where spid =&quot; + spSID.toString() + mode);</span>
<span class="nc" id="L2318">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L2319">			handleException(e, false);</span>
<span class="nc" id="L2320">			throw e;</span>
		} finally {
<span class="pc" id="L2322">			dao.cleanUp();</span>
<span class="pc" id="L2323">			methodFinish();</span>
<span class="fc" id="L2324">		}</span>
<span class="fc" id="L2325">	}</span>

	public void clearSchedulingStateWarnings(Collection ids) throws BbmFinderException {
<span class="nc" id="L2328">		methodStart(&quot;clearSchedulingStateWarnings&quot;, ids);</span>
<span class="nc" id="L2329">		SchedulingStateDAO dao = new SchedulingStateDAO();</span>
		try {
<span class="nc" id="L2331">			dao.deleteWarnings(ids);</span>
<span class="nc" id="L2332">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2333">			handleException(e, false);</span>
<span class="nc" id="L2334">			throw e;</span>
		} finally {
<span class="nc" id="L2336">			dao.cleanUp();</span>
<span class="nc" id="L2337">			methodFinish();</span>
<span class="nc" id="L2338">		}</span>
<span class="nc" id="L2339">	}</span>

	// cancel - 1; stop and save - 1, continue - 2
	public void makeSchedulingRequest(SchedulingRequest request) throws BbmCreateException {
<span class="nc" id="L2343">		methodStart(&quot;makeSchedulingRequest&quot;, request);</span>
<span class="nc" id="L2344">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L2346">			dmo.execute(&quot;insert into SPSCHEDREQUEST (REQUEST, SPID, MODE) values (&quot; + request.getRequest() + &quot;, &quot;</span>
<span class="nc" id="L2347">					+ request.getSPSID() + &quot;, '&quot; + request.getMode() + &quot;')&quot;);</span>
<span class="nc" id="L2348">		} catch (JdmoException e) {</span>
<span class="nc" id="L2349">			handleException(e, false);</span>
<span class="nc" id="L2350">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L2352">			dmo.cleanUp();</span>
<span class="nc" id="L2353">			methodFinish();</span>
<span class="nc" id="L2354">		}</span>
<span class="nc" id="L2355">	}</span>

	/**
	 * Clears any scheduling request for the given SPID and mode. Only use if
	 * you have reason to believe the FS client has died without removing the
	 * request entry.
	 */
	public void clearSchedulingRequest(SchedulingRequest request) throws BbmRemoveException {
<span class="fc" id="L2363">		methodStart(&quot;makeSchedulingRequest&quot;, request);</span>
<span class="fc" id="L2364">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="fc" id="L2366">			dmo.execute(&quot;delete from SPSCHEDREQUEST where SPID = &quot; + request.getSPSID() + &quot; and MODE = '&quot;</span>
<span class="fc" id="L2367">					+ request.getMode() + &quot;'&quot;);</span>
<span class="nc" id="L2368">		} catch (JdmoException e) {</span>
<span class="nc" id="L2369">			handleException(e, false);</span>
<span class="nc" id="L2370">			throw new BbmRemoveException(e);</span>
		} finally {
<span class="pc" id="L2372">			dmo.cleanUp();</span>
<span class="pc" id="L2373">			methodFinish();</span>
<span class="fc" id="L2374">		}</span>
<span class="fc" id="L2375">	}</span>

	public Collection getSPScheduleSession(ID spSID) throws BbmFinderException, RemoteException {
<span class="fc" id="L2378">		methodStart(&quot;getSPScheduleSession&quot;, spSID);</span>
<span class="fc" id="L2379">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="fc" id="L2381">			SchedulingPeriod sp = this.getSchedulingPeriodByID(spSID);</span>
<span class="fc" id="L2382">			Date start = TimeZoneUtil.previousWeek(sp.getStartTime());</span>
<span class="fc" id="L2383">			Date end = TimeZoneUtil.addWeek(sp.getEndTime());</span>
<span class="fc" id="L2384">			Collection sps = this.getSchedulingPeriods(sp.getCampaignID(), start, end);</span>
<span class="fc" id="L2385">			ArrayList sessions = new ArrayList(3);</span>
<span class="pc bpc" id="L2386" title="2 of 4 branches missed.">			if (sps != null &amp;&amp; !sps.isEmpty()) {</span>
<span class="fc" id="L2387">				HashMap spIDMap = ValueObjectUtil.getIDObjectMap(sps);</span>
<span class="fc" id="L2388">				StringBuffer sb = new StringBuffer(200);</span>
<span class="fc" id="L2389">				sb.append(&quot;select username, sp.sid from bpsession, sp where sp.id = bpsession.spid and useraction ='scheduling' and SP.SID in &quot;);</span>
<span class="fc" id="L2390">				sb.append(dmo.createInClause(spIDMap.keySet()));</span>
<span class="fc" id="L2391">				JdmoRowset rs = dmo.createRowset(sb.toString());</span>
<span class="fc" id="L2392">				SchedulingSession session = null;</span>
<span class="fc" id="L2393">				ID spID = null;</span>
<span class="pc bpc" id="L2394" title="1 of 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L2395">					session = new SchedulingSession();</span>
<span class="nc" id="L2396">					session.setUserName(rs.getString(1));</span>
<span class="nc" id="L2397">					spID = rs.getID(2);</span>
<span class="nc" id="L2398">					session.setSchedulingPeriod((SchedulingPeriod) spIDMap.get(spID));</span>
<span class="nc" id="L2399">					sessions.add(session);</span>
				}
			}
<span class="fc" id="L2402">			return sessions;</span>
<span class="nc" id="L2403">		} catch (JdmoException e) {</span>
<span class="nc" id="L2404">			handleException(e, false);</span>
<span class="nc" id="L2405">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L2407">			dmo.cleanUp();</span>
<span class="pc" id="L2408">			methodFinish();</span>
		}
	}

	/**
	 * Removes any scheduling BPSESSION entry for the specified SPID. Only use
	 * if you have reason to believe the FS client has died without removing the
	 * session entry.
	 */
	public void clearSPScheduleSession(ID spSID) throws BbmFinderException, BbmRemoveException, RemoteException {
<span class="fc" id="L2418">		methodStart(&quot;clearSPScheduleSession&quot;, spSID);</span>
<span class="fc" id="L2419">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="fc" id="L2421">			SchedulingPeriod sp = this.getSchedulingPeriodByID(spSID);</span>
<span class="pc bpc" id="L2422" title="1 of 2 branches missed.">			if (sp != null) {</span>
				// Not good that we have to use DEID
<span class="fc" id="L2424">				dmo.execute(&quot;delete from bpsession where useraction = 'scheduling' and SPID = '&quot; + sp.getDEID() + &quot;'&quot;);</span>
			}
<span class="fc" id="L2426">			return;</span>
<span class="nc" id="L2427">		} catch (JdmoException e) {</span>
<span class="nc" id="L2428">			handleException(e, false);</span>
<span class="nc" id="L2429">			throw new BbmRemoveException(e);</span>
		} finally {
<span class="pc" id="L2431">			dmo.cleanUp();</span>
<span class="pc" id="L2432">			methodFinish();</span>
		}
	}

	public Collection&lt;SPQueue&gt; getSPQueuesBySPID(ID SPID) throws BbmObjectNotFoundException, BbmFinderException {
<span class="fc" id="L2437">		methodStart(&quot;getSPQueuesBySPID&quot;);</span>
<span class="fc" id="L2438">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="fc" id="L2440">			return dao.getSPQueuesBySPID(SPID);</span>
<span class="nc" id="L2441">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2442">			handleException(e, false);</span>
<span class="nc" id="L2443">			throw e;</span>
		} finally {
<span class="pc" id="L2445">			dao.cleanUp();</span>
<span class="pc" id="L2446">			methodFinish();</span>
		}
	}

	/**
	 * Returns the TimeZone associated with the specified SPQueue ID.
	 *
	 * @param spQueueID
	 * @return
	 * @throws BbmObjectNotFoundException
	 * @throws BbmFinderException
	 */
	private TimeZone getTimeZoneBySPQueueID(ID spQueueID) throws BbmFinderException {
<span class="nc" id="L2459">		SPQueue spqueue = getSPQueue(spQueueID);</span>
<span class="nc" id="L2460">		SchedulingPeriod sp = getSP(spqueue.getSpID());</span>
<span class="nc" id="L2461">		return getTimeZoneByCampaignID(sp.getCampaignID());</span>
	}

	public Collection&lt;ID&gt; getLinkedOrgsforSP(ID schedID) throws BbmFinderException {
<span class="fc" id="L2465">		methodStart(&quot;getLinkedOrgsforSP&quot;, schedID);</span>
<span class="fc" id="L2466">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="fc" id="L2468">			return (dao.getLinkedOrgsforSP(schedID));</span>
<span class="nc" id="L2469">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2470">			handleException(e, false);</span>
<span class="nc" id="L2471">			throw e;</span>
		} finally {
<span class="pc" id="L2473">			dao.cleanUp();</span>
<span class="pc" id="L2474">			methodFinish();</span>
		}
	}

	public TimeZone getTimeZoneByCampaignID(ID campaignID) throws BbmFinderException {
<span class="fc" id="L2479">		methodStart(&quot;getTimeZoneByCampaignID&quot;, campaignID);</span>
<span class="fc" id="L2480">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="fc" id="L2482">			return (dao.getTimeZoneByCampaignID(campaignID));</span>
<span class="nc" id="L2483">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2484">			handleException(e, false);</span>
<span class="nc" id="L2485">			throw e;</span>
		} finally {
<span class="pc" id="L2487">			dao.cleanUp();</span>
<span class="pc" id="L2488">			methodFinish();</span>
		}
	}

	/**
	 * Returns a map from child SPQueue ID to child campaign time zone for all
	 * children of the specified parent SPQueue ID.
	 *
	 * @param parentSPQueueID
	 * @return
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	public Map&lt;ID, TimeZone&gt; getChildSPQueueTimeZonesByParentSPQueueID(ID parentSPQueueID) throws BbmFinderException,
			RemoteException {

<span class="nc" id="L2504">		Map&lt;ID, TimeZone&gt; timeZoneMap = new HashMap&lt;ID, TimeZone&gt;();</span>
<span class="nc" id="L2505">		Collection&lt;SPQueue&gt; childSPQueues = getChildSpQueuesOfDistributedSpQueue(parentSPQueueID);</span>
<span class="nc bnc" id="L2506" title="All 2 branches missed.">		for (SPQueue childSPQueue : childSPQueues) {</span>
<span class="nc" id="L2507">			timeZoneMap.put(childSPQueue.getID(), getTimeZoneBySPQueueID(childSPQueue.getID()));</span>
<span class="nc" id="L2508">		}</span>
<span class="nc" id="L2509">		return timeZoneMap;</span>
	}

	/**
	 * Clones the given Scheduling Period.  The cloning operation is performed in a series of steps:
	 * - The CLONESP stored procedure is executed for the target SP.  This procedure is quite extensive and is
	 * responsible for copying a large set of data including but not limited to: absolute/manually modified forecast
	 * profiles, service goals, spqueues, shrinkage, and hours of operation.
	 * - Employee min/max hours, skills, and work pattern assignments are copied to the new scheduling period (if
	 * this option was checked)
	 *  - If this SP is part of a distributed campaign, then the above steps are performed again for each additional
	 *  sub/child campaign
	 *  - If the source SP contained a forecast profile with relative history weeks, then the forecasts and FTE requirements
	 *  will be calculated for the new SP based on the relative dates for the new SP.  This step is also performed for the
	 *  sub/child SPs in the case of a distributed campaign.
	 *
	 * @param newSP - Essentially an empty SP, but it needs to have the time interval set to match the date range of the
	 *              target SP.
	 * @param spHOOs - The hours of the operation of the source SP, which will be cloned to the new SP.
	 * @param copyFlags - A set of boolean arguments to indicate whether or not certain types of data are to be cloned.
	 * @param bIgnoreWarnings - If false, will throw a BbmConflictException if any conflicts are detected before the
	 *                        stored procedure is executed (see SchedulingPeriodDAO.CloneSP method)
	 * @param localeCtx - Used to create a localized description for the newly cloned SP, e.g.
	 *                  &quot;This scheduling period is cloned from 01/04/2016To02/03/2016.&quot;
	 * @return - The ID of the newly cloned SP.
	 */
	public ID cloneSchedulingPeriod(SchedulingPeriod newSP, Collection&lt;CampaignHOO&gt; spHOOs, CloneSPOptions copyFlags,
			boolean bIgnoreWarnings, LocaleContext localeCtx) throws JdmoException, BbmException, RemoteException {

<span class="nc" id="L2538">		ClonedSchedulingPeriodResult clonedSps =</span>
<span class="nc" id="L2539">				campaignManager.cloneBaseDataForSchedulingPeriod(newSP, spHOOs, copyFlags, bIgnoreWarnings, localeCtx);</span>

<span class="nc" id="L2541">		cloneForecastDataForSchedulingPeriods(clonedSps);</span>

<span class="nc" id="L2543">		return clonedSps.getClonedSchedulingPeriod().getID();</span>
	}

	/**
	 * Clones the forecast data for the newly created scheduling periods.  This is mainly to support forecasts
	 * with relative profiles, which are not supported by the CLONESP stored procedure and need to be handled
	 * by the EJB due to their complexity.
	 *
	 * @param clonedSps - A ClonedSchedulingPeriodResult containing the newly cloned SP as well as its children
	 *                  if it belongs to a distributed campaign.
	 */
	private void cloneForecastDataForSchedulingPeriods(ClonedSchedulingPeriodResult clonedSps)
			throws JdmoException, BbmException, RemoteException {

		//We currently only clone the forecast data for the parent scheduling period in a distributed campaign.
		//We don't currently clone the Forecast Allocation Time series, and because that needs to be set manually
		//it doesn't make sense to clone the forecast data for the child SPs.
<span class="nc" id="L2560">		forecastTimeSeriesManager.recalculateForecastDataForClonedSp(clonedSps.getClonedSchedulingPeriod());</span>
<span class="nc" id="L2561">	}</span>

	/**
	 * This method is NOT intended to be executed by client code.  If you are a client, you should use
	 * CampaignManager.cloneSchedulingPeriod instead.
	 *
	 * This method has a &quot;RequiresNew&quot; attribute set to ensure that it runs in its own transaction.  This is done
	 * so that post clone operations can be performed asynchronously but still utilize the persisted objects created
	 * during the clone operation.
	 *
	 * @param newSP - Essentially an empty SP, but it needs to have the time interval set to match the date range of the
	 *              target SP.
	 * @param spHOOs - The hours of the operation of the source SP, which will be cloned to the new SP.
	 * @param copyFlags - A set of boolean arguments to indicate whether or not certain types of data are to be cloned.
	 * @param bIgnoreWarnings - If false, will throw a BbmConflictException if any conflicts are detected before the
	 *                        stored procedure is executed (see SchedulingPeriodDAO.CloneSP method)
	 * @param localeCtx - Used to create a localized description for the newly cloned SP, e.g.
	 *                  &quot;This scheduling period is cloned from 01/04/2016To02/03/2016.&quot;
	 * @return A ClonedSchedulingPeriodResult containing the newly cloned SP and Child SP (for distributed) objects.
	 */
	public ClonedSchedulingPeriodResult cloneBaseDataForSchedulingPeriod(SchedulingPeriod newSP,
			Collection&lt;CampaignHOO&gt; spHOOs, CloneSPOptions copyFlags, boolean bIgnoreWarnings, LocaleContext localeCtx)
			throws JdmoException, BbmException, RemoteException {

<span class="nc" id="L2585">		methodStart(&quot;cloneSchedulingPeriod&quot;, newSP, spHOOs, copyFlags, bIgnoreWarnings, localeCtx);</span>
		ID idTargetSP;
<span class="nc" id="L2587">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
<span class="nc" id="L2588">		CampaignDAO camDao = new CampaignDAO();</span>
<span class="nc" id="L2589">		CampaignHOODAO camHOODao = new CampaignHOODAO();</span>
<span class="nc" id="L2590">		SchedulingPeriod sp = null;</span>
<span class="nc" id="L2591">		List&lt;SchedulingPeriod&gt; childSps = new ArrayList&lt;SchedulingPeriod&gt;();</span>
		try {
<span class="nc" id="L2593">			ID campaignID = newSP.getCampaignID();</span>
<span class="nc" id="L2594">			TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(campaignID);</span>
<span class="nc" id="L2595">			boolean bCopyAssignments = copyFlags.isCopyAssignments();</span>
<span class="nc" id="L2596">			idTargetSP = dao.CloneSP(tz, newSP, spHOOs, copyFlags, bIgnoreWarnings);</span>

<span class="nc" id="L2598">			Campaign campaign = camDao.getCampaignByID(newSP.getCampaignID(), false);</span>
<span class="nc" id="L2599">			String strSPname = copyShiftAssignmentsAndEffectiveDates(dao, campaign, newSP, spHOOs, bCopyAssignments, tz,</span>
					idTargetSP);

<span class="nc" id="L2602">			sp = dao.getSchedulingPeriodByID(idTargetSP);</span>

			// Set description: This scheduling period is cloned from &lt;date&gt; to &lt;date&gt;
<span class="nc" id="L2605">			Localizer localizer = LocalizationManager.getInstance().getLocalizer(localeCtx);</span>
<span class="nc" id="L2606">			String messageTemplate = localizer.i18n(BbmEjbBundleKey.BUNDLE, BbmEjbBundleKey.SCHEDULINGPERIOD_CLONED_DESC);</span>
<span class="nc" id="L2607">			Object[] args = new Object[]{strSPname};</span>
<span class="nc" id="L2608">			String descStr = MessageFormat.format(messageTemplate, args);</span>
<span class="nc" id="L2609">			sp.setDescription(descStr);</span>

<span class="nc" id="L2611">			dao.updateSchedulingPeriods(Collections.singleton(sp));</span>

<span class="nc" id="L2613">			Collection&lt;ID&gt; subIDs = camDao.getSubCampaignIDs(campaignID);</span>
<span class="nc bnc" id="L2614" title="All 2 branches missed.">			for (ID subID : subIDs) {</span>
<span class="nc" id="L2615">				SchedulingPeriod subSP = new SchedulingPeriod();</span>
<span class="nc" id="L2616">				subSP.setCampaignID(subID);</span>
<span class="nc" id="L2617">				subSP.setName(sp.getName());</span>
<span class="nc" id="L2618">				subSP.setStartTimeLocal(newSP.getStartTimeLocal());</span>
<span class="nc" id="L2619">				subSP.setEndTimeLocal(newSP.getEndTimeLocal());</span>
<span class="nc" id="L2620">				childSps.add(subSP);</span>

<span class="nc" id="L2622">				TimeZone subtz = CampaignDAO.getTimeZoneByCampaignID(subID);</span>

<span class="nc" id="L2624">				Collection&lt;CampaignHOO&gt; subSPHOOs = new ArrayList&lt;CampaignHOO&gt;();</span>
<span class="nc bnc" id="L2625" title="All 2 branches missed.">				for (CampaignHOO spHOO : spHOOs) {</span>
<span class="nc" id="L2626">					LocalDate ld1 = new LocalDate(spHOO.getStartTime(), tz);</span>
<span class="nc" id="L2627">					Date d1 = ld1.getTime(tz);</span>
<span class="nc" id="L2628">					Collection&lt;CampaignHOO&gt; subHOOs = camHOODao.getCampaignHOOAssignments(subID, spHOO.getStartTime(),</span>
<span class="nc" id="L2629">							spHOO.getEndTime());</span>
<span class="nc bnc" id="L2630" title="All 2 branches missed.">					for (CampaignHOO spHOO2 : subHOOs) {</span>
<span class="nc" id="L2631">						LocalDate ld2 = new LocalDate(spHOO2.getStartTime(), subtz);</span>
<span class="nc" id="L2632">						Date d2 = ld2.getTime(subtz);</span>

<span class="nc bnc" id="L2634" title="All 2 branches missed.">						if (d1.equals(d2)) {</span>
<span class="nc" id="L2635">							subSPHOOs.add(spHOO2);</span>
						}
<span class="nc" id="L2637">					}</span>
<span class="nc" id="L2638">				}</span>
				// new construct the hoos
<span class="nc bnc" id="L2640" title="All 2 branches missed.">				if (subSPHOOs.size() == 0) {</span>
<span class="nc" id="L2641">					continue;</span>
				}

<span class="nc" id="L2644">				ID targetSubSPID = dao.CloneSP(subtz, subSP, subSPHOOs, copyFlags, bIgnoreWarnings);</span>

				SchedulingPeriod subSP2;
<span class="nc" id="L2647">				String strSubSPname = copyShiftAssignmentsAndEffectiveDates(dao, campaign, subSP, subSPHOOs,</span>
						bCopyAssignments, tz, targetSubSPID);

<span class="nc" id="L2650">				subSP2 = dao.getSchedulingPeriodByID(targetSubSPID);</span>

<span class="nc" id="L2652">				Object[] argsSub = new Object[]{strSubSPname};</span>
<span class="nc" id="L2653">				String descSubStr = MessageFormat.format(messageTemplate, argsSub);</span>
<span class="nc" id="L2654">				subSP2.setDescription(descSubStr);</span>
<span class="nc" id="L2655">				subSP2.setParentSPID(sp.getDEID());</span>
<span class="nc" id="L2656">				dao.updateSchedulingPeriods(Collections.singleton(subSP2));</span>
<span class="nc" id="L2657">			}</span>
<span class="nc" id="L2658">		} catch (JdmoException e) {</span>
<span class="nc" id="L2659">			handleException(e);</span>
<span class="nc" id="L2660">			throw e;</span>
<span class="nc" id="L2661">		} catch (MultiUserException e) {</span>
			// Don't need to re-throw exception because this is for
			// updating SP Description after clone SP
<span class="nc" id="L2664">			handleException(e);</span>
<span class="nc" id="L2665">		} catch (BbmUpdateException e) {</span>
			// Don't need to re-throw exception because this is for
			// updating SP Description after clone SP
<span class="nc" id="L2668">			handleException(e);</span>
<span class="nc" id="L2669">		} catch (RemoteException e) {</span>
<span class="nc" id="L2670">			handleException(e);</span>
<span class="nc" id="L2671">			throw e;</span>
<span class="nc" id="L2672">		} catch (BbmException e) {</span>
<span class="nc" id="L2673">			handleException(e);</span>
<span class="nc" id="L2674">			throw e;</span>
		} finally {
<span class="nc" id="L2676">			dao.cleanUp();</span>
<span class="nc" id="L2677">			camDao.cleanUp();</span>
<span class="nc" id="L2678">			camHOODao.cleanUp();</span>
<span class="nc" id="L2679">			methodFinish();</span>
<span class="nc" id="L2680">		}</span>
<span class="nc" id="L2681">		return new ClonedSchedulingPeriodResult(sp, childSps);</span>
	}

	private String copyShiftAssignmentsAndEffectiveDates(SchedulingPeriodDAO dao, Campaign campaign, SchedulingPeriod newSP,
			Collection&lt;CampaignHOO&gt; spHOOs, boolean bCopyAssignments, TimeZone tz, ID idTargetSP)
			throws BbmFinderException, RemoteException, BbmScheduleConflictException {

<span class="nc" id="L2688">		boolean bClearDestinationSP = false;</span>
<span class="nc" id="L2689">		LocalDate startLD = new LocalDate(newSP.getEndTimeLocal());</span>
<span class="nc" id="L2690">		LocalDate endLD = new LocalDate(newSP.getEndTimeLocal());</span>
		Date targetWeekStart, sourceWeekStart;
		ID idSourceSP;
<span class="nc" id="L2693">		ArrayList&lt;CampaignHOO&gt; CampHOOAL = new ArrayList&lt;CampaignHOO&gt;(spHOOs);</span>
<span class="nc" id="L2694">		ListIterator&lt;CampaignHOO&gt; litr = CampHOOAL.listIterator(CampHOOAL.size());</span>
<span class="nc" id="L2695">		ArrayList&lt;ID&gt; spIds = new ArrayList();</span>
<span class="nc" id="L2696">		StringBuilder strSPname = new StringBuilder();</span>
<span class="nc" id="L2697">		SchedulingPeriod sp = null;</span>

<span class="nc" id="L2699">		Date startGMTDt = newSP.getStartTime();</span>
<span class="nc" id="L2700">		Calendar currentDate = Calendar.getInstance(tz);</span>
<span class="nc" id="L2701">		currentDate.setTime(newSP.getEndTime());</span>

<span class="nc bnc" id="L2703" title="All 2 branches missed.">		while (litr.hasPrevious()) {</span>
<span class="nc" id="L2704">			CampaignHOO spHOO = litr.previous();</span>
<span class="nc" id="L2705">			endLD = new LocalDate(startLD);</span>

<span class="nc bnc" id="L2707" title="All 2 branches missed.">			if (campaign.isMonthly()) {</span>
				// some weeks of monthly SPs may have less than 7 days
<span class="nc" id="L2709">				int numOfDaysToStartWeek = MonthlySPUtil.getNumOfDaysToWeekStartDate(tz, currentDate.getTime(), MonthlySPUtil.getWeekStartDay(campaign.getWeekStart()), startGMTDt);</span>
<span class="nc" id="L2710">				currentDate.add(Calendar.DATE, -numOfDaysToStartWeek);</span>
<span class="nc" id="L2711">				startLD.add(Calendar.DATE, -numOfDaysToStartWeek);</span>
<span class="nc" id="L2712">			} else {</span>
<span class="nc" id="L2713">				startLD.add(Calendar.DATE, -7);</span>
			}

<span class="nc" id="L2716">			targetWeekStart = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(startLD, tz);</span>
<span class="nc" id="L2717">			sourceWeekStart = spHOO.getStartTime();</span>
<span class="nc" id="L2718">			idSourceSP = spHOO.getSPID();</span>

<span class="nc bnc" id="L2720" title="All 2 branches missed.">			if (spIds.isEmpty()) {</span>
<span class="nc" id="L2721">				spIds.add(idSourceSP);</span>
<span class="nc" id="L2722">				sp = dao.getSchedulingPeriodByID(idSourceSP);</span>
<span class="nc" id="L2723">				strSPname.append(sp.getName());</span>
<span class="nc bnc" id="L2724" title="All 2 branches missed.">			} else if (!spIds.contains(idSourceSP)) {</span>
				// check for duplicate sp id
<span class="nc" id="L2726">				spIds.add(idSourceSP);</span>
<span class="nc" id="L2727">				sp = dao.getSchedulingPeriodByID(idSourceSP);</span>
<span class="nc" id="L2728">				strSPname.append(&quot;, &quot;).append(sp.getName());</span>
			}

<span class="nc" id="L2731">			m_scheduleAccessManager.copyShiftAssignments(idSourceSP, sourceWeekStart, idTargetSP, targetWeekStart, bClearDestinationSP);</span>
<span class="nc bnc" id="L2732" title="All 2 branches missed.">			if (bCopyAssignments) {</span>
<span class="nc" id="L2733">				m_scheduleAccessManager.copyEffectiveDates(idSourceSP, sourceWeekStart, idTargetSP, targetWeekStart);</span>
			}
<span class="nc" id="L2735">			endLD = startLD;</span>
<span class="nc" id="L2736">		}</span>

<span class="nc" id="L2738">		return strSPname.toString();</span>
	}

	/**
	 * &lt;B&gt;createSPEmpTemplate&lt;/B&gt;
	 * &lt;p&gt;
	 * creates given SPEmpTemplate in db, and sets it's id
	 * &lt;p&gt;
	 *
	 * @param spEmpTemp : SPEmpTemplate to create
	 * @return SPEmpTemplate id
	 */
	public ID createSPEmpTemplate(SPEmpTemplate spEmpTemp) throws BbmCreateException {
<span class="nc" id="L2751">		methodStart(&quot;createSPEmpTemplate&quot;, spEmpTemp);</span>
<span class="nc" id="L2752">		SPEmpTemplateDAO spEmpTemplateDao = null;</span>
<span class="nc" id="L2753">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L2755">			spEmpTemplateDao = new SPEmpTemplateDAO();</span>
<span class="nc" id="L2756">			spEmpTemp.setDEID(new ID(DAOUtil.getDEID(dmo)));</span>
<span class="nc" id="L2757">			spEmpTemplateDao.setIDs(spEmpTemp);</span>
<span class="nc" id="L2758">			ID spEmpTempID = spEmpTemplateDao.createObject(spEmpTemp);</span>
<span class="nc" id="L2759">			spEmpTemp.setDEID(spEmpTempID);</span>
			// find SID and return
<span class="nc" id="L2761">			ID createdID = spEmpTempID;</span>
<span class="nc" id="L2762">			String stmt = &quot;SELECT SID FROM SPEMPTEMPLATE WHERE ID ='&quot; + spEmpTempID + &quot;'&quot;;</span>
<span class="nc" id="L2763">			JdmoRowset rs = dmo.createRowset(stmt);</span>
<span class="nc bnc" id="L2764" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L2765">				createdID = rs.getID(1);</span>
			}
<span class="nc" id="L2767">			rs.close();</span>
<span class="nc" id="L2768">			return createdID;</span>
<span class="nc" id="L2769">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L2770">			handleException(e, true);</span>
<span class="nc" id="L2771">			throw e;</span>
<span class="nc" id="L2772">		} catch (JdmoException e) {</span>
<span class="nc" id="L2773">			handleException(e, true);</span>
<span class="nc" id="L2774">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc bnc" id="L2776" title="All 4 branches missed.">			if (spEmpTemplateDao != null) {</span>
<span class="nc" id="L2777">				spEmpTemplateDao.cleanUp();</span>
			}
<span class="nc" id="L2779">			dmo.cleanUp();</span>
<span class="nc" id="L2780">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;updateSPEmpTemplate&lt;/B&gt;
	 * &lt;p&gt;
	 * creates given SPEmpTemplate in db, and sets it's id
	 * &lt;p&gt;
	 *
	 * @param colSPEmpTemplateIDs
	 *            : list of SPEmpTemplate to create
	 * @return SPEmpTemplate id
	 */
	public void updateSPEmpTemplate(Collection&lt;SPEmpTemplate&gt; colSPEmpTemplateIDs) throws BbmUpdateException,
			MultiUserException {
<span class="nc" id="L2796">		methodStart(&quot;updateSPEmpTemplate&quot;);</span>
<span class="nc" id="L2797">		SPEmpTemplateDAO spEmpTemplateDao = null;</span>
		try {
<span class="nc bnc" id="L2799" title="All 2 branches missed.">			for (SPEmpTemplate spEmpTemp : colSPEmpTemplateIDs) {</span>
				// spEmpTemp.validate();
<span class="nc" id="L2801">				spEmpTemplateDao = new SPEmpTemplateDAO();</span>
<span class="nc" id="L2802">				spEmpTemplateDao.setIDs(spEmpTemp);</span>
<span class="nc" id="L2803">				spEmpTemplateDao.updateObject(spEmpTemp);</span>
				// if (cacheUsed()) {
				// m_ActivityCache.put(activity.getID(), activity);
				// }
<span class="nc" id="L2807">			}</span>
<span class="nc" id="L2808">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L2809">			handleException(e, true);</span>
<span class="nc" id="L2810">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L2811">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L2812">			handleException(e, true);</span>
<span class="nc" id="L2813">			throw e;</span>
<span class="nc" id="L2814">		} catch (MultiUserException e) {</span>
<span class="nc" id="L2815">			handleException(e, true);</span>
<span class="nc" id="L2816">			throw e;</span>
		} finally {
<span class="nc bnc" id="L2818" title="All 4 branches missed.">			if (spEmpTemplateDao != null) {</span>
<span class="nc" id="L2819">				spEmpTemplateDao.cleanUp();</span>
			}
<span class="nc" id="L2821">			methodFinish();</span>
<span class="nc" id="L2822">		}</span>
<span class="nc" id="L2823">	}</span>

	public void deleteSPEmpTemplate(Collection&lt;ID&gt; colSPEmpTemplateIDs) throws BbmRemoveException {
<span class="nc" id="L2826">		methodStart(&quot;deleteSPEmpTemplate&quot;);</span>
<span class="nc bnc" id="L2827" title="All 4 branches missed.">		if (colSPEmpTemplateIDs == null || colSPEmpTemplateIDs.isEmpty()) {</span>
<span class="nc" id="L2828">			return;</span>
		}
<span class="nc" id="L2830">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L2832">			String where = &quot;select ID from SPEMPTEMPLATE where SID in &quot; + dmo.createInClause(colSPEmpTemplateIDs);</span>
<span class="nc" id="L2833">			DAOUtil.deleteObjects(dmo, &quot;SPEMPTEMPLATE&quot;, where);</span>
<span class="nc" id="L2834">			DAOUtil.deleteObjects(dmo, &quot;SPEMPTEMPLATE&quot;, colSPEmpTemplateIDs);</span>

<span class="nc" id="L2836">		} catch (Exception ex) {</span>
<span class="nc" id="L2837">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc" id="L2839">			dmo.cleanUp();</span>
<span class="nc" id="L2840">		}</span>
<span class="nc" id="L2841">	}</span>

	/**
	 * Get the SPEmpTemplates that belong to this scheduling period
	 *
	 * @param spid
	 * @return
	 * @throws BbmFinderException
	 */
	private Collection getSPEmpTemplatesBySPID(ID spid) throws BbmFinderException {
<span class="nc" id="L2851">		methodStart(&quot;getSPEmpTemplatesBySP&quot;);</span>
<span class="nc" id="L2852">		SPEmpTemplateDAO dao = new SPEmpTemplateDAO();</span>
		try {
<span class="nc" id="L2854">			return dao.getSPEmpTemplatesBySP(spid);</span>
<span class="nc" id="L2855">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2856">			handleException(e);</span>
<span class="nc" id="L2857">			throw e;</span>
		} finally {
<span class="nc" id="L2859">			dao.cleanUp();</span>
<span class="nc" id="L2860">			methodFinish();</span>
		}
	}

	public Collection getSPEmpTemplatesBySP(ID spid) throws BbmFinderException {
<span class="nc" id="L2865">		methodStart(&quot;getSPEmpTemplatesBySP&quot;);</span>
<span class="nc" id="L2866">		SPEmpTemplateDAO dao = new SPEmpTemplateDAO();</span>
<span class="nc" id="L2867">		SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO();</span>
<span class="nc" id="L2868">		Collection&lt;SPEmpTemplate&gt; spEmpTemplate = new ArrayList&lt;SPEmpTemplate&gt;();</span>
<span class="nc" id="L2869">		SchedulingPeriod childSp = spDAO.getSchedulingPeriodByID(spid);</span>
<span class="nc" id="L2870">		ID parentSPID = DAOUtil.mapIDToSID(childSp.getParentSPID(), spDAO.getFieldInfo());// childSp.getParentSPID();</span>

		try {
<span class="nc bnc" id="L2873" title="All 2 branches missed.">			if (parentSPID == null) {</span>
				// cur SP is parent, add from Sub SP
<span class="nc" id="L2875">				Collection&lt;ID&gt; subSPIDs = getSubSPIDsFromParentSPID(spid);</span>
<span class="nc" id="L2876">				long nNumSPs = subSPIDs.size();</span>
<span class="nc bnc" id="L2877" title="All 2 branches missed.">				for (Iterator it = subSPIDs.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2878">					ID subID = (ID) it.next();</span>
<span class="nc" id="L2879">					spEmpTemplate.addAll(getSPEmpTemplatesBySPID(subID));</span>
<span class="nc" id="L2880">				}</span>

				// add from current SP
<span class="nc" id="L2883">				spEmpTemplate.addAll(getSPEmpTemplatesBySPID(spid));</span>
<span class="nc" id="L2884">			} else {</span>
				// cur SP is child, add from parent SP
<span class="nc bnc" id="L2886" title="All 2 branches missed.">				if (parentSPID != null) {</span>
					// parentSPID is a DEID, however getSPEmpTemplatesBySPID
					// expects an SID. It would be
					// ideal to have the parent SP ID set automatically with an
					// SID, but I'm not sure what
					// the ramifications of doing so would be to the other areas
					// in the code that reference
					// SchedulingPeriodDAO.getSchedulingPeriodByID()
<span class="nc" id="L2894">					ID parentSPSID = DAOUtil.mapIDToSID(parentSPID, new SchedulingPeriodFieldInfo());</span>
<span class="nc" id="L2895">					spEmpTemplate.addAll(getSPEmpTemplatesBySPID(parentSPSID));</span>
				}

				// add from sub sp if any?
<span class="nc" id="L2899">				Collection&lt;ID&gt; subSPIDs = getSubSPIDsFromParentSPID(spid);</span>
<span class="nc" id="L2900">				long nNumSPs = subSPIDs.size();</span>
<span class="nc bnc" id="L2901" title="All 2 branches missed.">				for (Iterator it = subSPIDs.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2902">					ID subID = (ID) it.next();</span>
<span class="nc bnc" id="L2903" title="All 2 branches missed.">					if (subID != spid) {</span>
<span class="nc" id="L2904">						spEmpTemplate.addAll(getSPEmpTemplatesBySPID(subID));</span>
					}
<span class="nc" id="L2906">				}</span>
				// add from current SP
<span class="nc" id="L2908">				spEmpTemplate.addAll(getSPEmpTemplatesBySPID(spid));</span>

			}
<span class="nc" id="L2911">			return spEmpTemplate;</span>
<span class="nc" id="L2912">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2913">			handleException(e);</span>
<span class="nc" id="L2914">			throw e;</span>
		} finally {
<span class="nc" id="L2916">			dao.cleanUp();</span>
<span class="nc" id="L2917">			spDAO.cleanUp();</span>
<span class="nc" id="L2918">			methodFinish();</span>
		}
	}

	/**
	 * Returns the child scheduling period IDs of the SP having the specified
	 * numeric or alphanumeric ID.
	 *
	 * @param parentSPID the ID of the parent SP--may be SID or DEID (numeric or
	 *                   alphanumeric)
	 * @return a collection of IDs of the child SPs
	 * @throws JdmoException
	 * @throws BbmFinderException if the specified ID cannot be mapped to a DEID
	 */
	public Collection&lt;ID&gt; getSubSPIDsFromParentSPID(ID parentSPID) throws BbmFinderException {
<span class="fc" id="L2933">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="fc" id="L2935">			return dao.getSubSPIDsFromParentSPID(parentSPID);</span>
<span class="nc" id="L2936">		} catch (BbmFinderException bfe) {</span>
<span class="nc" id="L2937">			handleException(bfe);</span>
<span class="nc" id="L2938">			throw bfe;</span>
<span class="nc" id="L2939">		} catch (Exception e) {</span>
<span class="nc" id="L2940">			handleException(e);</span>
<span class="nc" id="L2941">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L2943">			dao.cleanUp();</span>
		}
	}

	/**
	 * Returns a map whose keys are SPQueue IDs and whose values are the
	 * corresponding SPQueues. The map will contain all the SPQueues associated
	 * with the specified campaign, collection of queues, and time range.
	 * &lt;p/&gt;
	 * Returns an empty map if {@code campaignID} is {@code null}.
	 *
	 * @param campaignID
	 * @param queueIDs
	 * @param start
	 * @param end
	 * @return
	 * @throws RemoteException
	 * @throws BbmFinderException
	 */
	public Map&lt;ID, SPQueue&gt; getIDToSPQueueMapping(ID campaignID, Collection&lt;? extends ID&gt; queueIDs, Date start, Date end)
			throws RemoteException, BbmFinderException {
<span class="fc" id="L2964">		methodStart(&quot;getIDToSPQueueMapping&quot;, campaignID, queueIDs, start, end);</span>
<span class="fc" id="L2965">		Map&lt;ID, SPQueue&gt; idToSPQueueMapping = new HashMap&lt;ID, SPQueue&gt;();</span>
<span class="fc" id="L2966">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="pc bpc" id="L2968" title="1 of 2 branches missed.">			if (campaignID != null) {</span>
<span class="fc" id="L2969">				SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO(dmo);</span>
<span class="fc" id="L2970">				Collection&lt;SchedulingPeriod&gt; colSP = spDAO.getSchedulingPeriods(campaignID, start, end, null, null);</span>
<span class="fc" id="L2971">				SPQueueDAO dao = new SPQueueDAO(dmo);</span>
<span class="fc" id="L2972">				Collection&lt;SPQueue&gt; colSPQs = dao.getSPQueuesBySPIDsFixed(ValueObjectUtil.getIDFromObjects(colSP));</span>
<span class="fc bfc" id="L2973" title="All 2 branches covered.">				for (SPQueue spQ : colSPQs) {</span>
<span class="pc bpc" id="L2974" title="1 of 2 branches missed.">					if (queueIDs.contains(spQ.getQueueID())) {</span>
<span class="fc" id="L2975">						idToSPQueueMapping.put(spQ.getID(), spQ);</span>
					}
<span class="fc" id="L2977">				}</span>
			}
<span class="nc" id="L2979">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2980">			handleException(e, false);</span>
<span class="nc" id="L2981">			throw e;</span>
		} finally {
<span class="pc bpc" id="L2983" title="3 of 4 branches missed.">			if (dmo != null) {</span>
<span class="pc" id="L2984">				dmo.cleanUp();</span>
			}
<span class="pc" id="L2986">			methodFinish();</span>
<span class="fc" id="L2987">		}</span>
<span class="fc" id="L2988">		return idToSPQueueMapping;</span>
	}

	/**
	 * Returns a map whose keys are SPQueue IDs and whose values are the
	 * corresponding SPQueues. The map will contain all the SPQueues associated
	 * with the specified campaign, queue, and time range.
	 * &lt;p/&gt;
	 * Returns an empty map if {@code campaignID} is {@code null} or if the
	 * queue ID does not share any SPQueues with the specified campaign.
	 *
	 * @param campaignID
	 * @param queueID
	 * @param start
	 * @param end
	 * @return
	 * @throws RemoteException
	 * @throws BbmFinderException
	 */
	public Map&lt;ID, SPQueue&gt; getIDToSPQueueMapping(ID campaignID, ID queueID, Date start, Date end)
			throws RemoteException, BbmFinderException {
<span class="nc" id="L3009">		return getIDToSPQueueMapping(campaignID, new ArrayList(Arrays.asList(queueID)), start, end);</span>
	}

	/**
	 * Returns a list of all the child SpQueues of the parent distributed
	 * SpQueue.
	 *
	 * @param distributedSpQueueId
	 * @return
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	public Collection&lt;SPQueue&gt; getChildSpQueuesOfDistributedSpQueue(ID distributedSpQueueId) throws BbmFinderException,
			RemoteException {
<span class="nc" id="L3023">		Collection&lt;SPQueue&gt; childSpQueues = new ArrayList&lt;SPQueue&gt;();</span>
<span class="nc" id="L3024">		SPQueue spq = getSPQueue(distributedSpQueueId);</span>
<span class="nc bnc" id="L3025" title="All 2 branches missed.">		boolean isCombined = spq.getQueueID() == null;</span>
<span class="nc" id="L3026">		Collection&lt;ID&gt; childQueueIds = null;</span>
<span class="nc bnc" id="L3027" title="All 2 branches missed.">		if (!isCombined) {</span>
<span class="nc" id="L3028">			childQueueIds = m_workloadManager.getSubQueues(Collections.singleton(spq.getQueueID()));</span>
		}
<span class="nc" id="L3030">		Collection&lt;ID&gt; childSpIds = getSubSPIDsFromParentSPID(spq.getSpID());</span>
<span class="nc" id="L3031">		Collection&lt;SPQueue&gt; candidateSpQueues = getSPQueuesBySPIDs(childSpIds);</span>
<span class="nc bnc" id="L3032" title="All 2 branches missed.">		for (SPQueue spQueue : candidateSpQueues) {</span>
			// We handle combined single media but not combined-combined
<span class="nc bnc" id="L3034" title="All 8 branches missed.">			if ((isCombined &amp;&amp; spQueue.getQueueID() == null &amp;&amp; spQueue.getMediaID() != null)</span>
<span class="nc bnc" id="L3035" title="All 2 branches missed.">					|| ((!isCombined) &amp;&amp; childQueueIds.contains(spQueue.getQueueID()))) {</span>
<span class="nc" id="L3036">				childSpQueues.add(spQueue);</span>
			}
<span class="nc" id="L3038">		}</span>
<span class="nc" id="L3039">		return childSpQueues;</span>
	}

	/**
	 * If the queue associated with {@code childSpQueueId} is deferred or
	 * immediate and a child queue of a parent distributed queue, then this
	 * method returns the parent SPQueue. Otherwise it returns {@code null}.
	 * {@code childSpQueueId} may be associated either with a single or combined
	 * queue.
	 *
	 * @param childSpQueueId
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	public SPQueue getDistributedParentSpQueue(ID childSpQueueId) throws BbmFinderException, RemoteException {
<span class="fc" id="L3054">		SPQueueDAO spqDao = new SPQueueDAO();</span>
<span class="fc" id="L3055">		SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO();</span>
		try {
<span class="fc" id="L3057">			SPQueue childSpQueue = spqDao.getObjectByID(childSpQueueId);</span>
			// Only process immediate and deferred queues
<span class="pc bpc" id="L3059" title="3 of 4 branches missed.">			if (Media.isMediaImmediate(childSpQueue.getMediaID()) || Media.isMediaDeferred(childSpQueue.getMediaID())) {</span>

<span class="fc" id="L3061">				SchedulingPeriod childSp = spDAO.getSchedulingPeriodByID(childSpQueue.getSpID());</span>
<span class="fc" id="L3062">				Campaign campaign = getCampaignByID(childSp.getCampaignID());</span>
<span class="fc" id="L3063">				ID parentCampaignID = campaign.getParentCampaignID();</span>
				// Only process if the current campaign has a parent...
<span class="pc bpc" id="L3065" title="1 of 2 branches missed.">				if (parentCampaignID != null) {</span>
<span class="nc" id="L3066">					Campaign parentCampaign = getCampaignByID(parentCampaignID);</span>
					// ... and the parent is distributed
<span class="nc bnc" id="L3068" title="All 2 branches missed.">					if (parentCampaign.getIsDistributed()) {</span>
<span class="nc bnc" id="L3069" title="All 2 branches missed.">						if (childSpQueue.getQueueID() == null) {</span>
							// combined queue
<span class="nc" id="L3071">							return getCombinedSPQueue(childSp.getParentID(), childSpQueue.getMediaID());</span>
						} else {
							// single queue
<span class="nc" id="L3074">							QueueDAO queueDao = new QueueDAO(); // Doesn't need</span>
							// cleanup call.
<span class="nc" id="L3076">							Queue queue = queueDao.getObjects(Collections.singleton(childSpQueue.getQueueID())).iterator()</span>
<span class="nc" id="L3077">									.next();</span>
<span class="nc" id="L3078">							ID parentQueueId = queue.getParentID();</span>
<span class="nc" id="L3079">							return getSPQueue(DAOUtil.mapIDToSID(childSp.getParentSPID(), spDAO.getFieldInfo()),</span>
									parentQueueId);
						}
					}
				}
			}
<span class="nc" id="L3085">		} catch (BbmFinderException bfe) {</span>
<span class="nc" id="L3086">			handleException(bfe);</span>
<span class="nc" id="L3087">			throw bfe;</span>
<span class="nc" id="L3088">		} catch (Exception e) {</span>
<span class="nc" id="L3089">			handleException(&quot;getDistributedParentSpQueue&quot;, e, false);</span>
<span class="nc" id="L3090">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L3092">			spqDao.cleanUp();</span>
<span class="pc" id="L3093">			spDAO.cleanUp();</span>
<span class="fc" id="L3094">		}</span>
<span class="fc" id="L3095">		return null;</span>
	}

	/**
	 * Returns a map of Scheduling Period IDs to their associated campaign's
	 * name.
	 *
	 * @param spIDs - The scheduling period IDs for which we'd like to look up
	 *              their associated campaign's name.
	 * @throws BbmFinderException
	 */
	public Map&lt;ID, String&gt; getCampaignNamesLinkedToSPs(Collection&lt;ID&gt; spIDs) throws RemoteException, BbmFinderException {
<span class="nc" id="L3107">		methodStart(&quot;getCampaignNamesLinkedToSPs&quot;, spIDs);</span>
<span class="nc" id="L3108">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="nc" id="L3110">			return dao.getCampaignNamesLinkedToSPs(spIDs);</span>
		} finally {
<span class="nc" id="L3112">			dao.cleanUp();</span>
<span class="nc" id="L3113">			methodFinish();</span>
		}
	}

	public void unlinkEmployeeShiftAssignments(Employee emp) throws BbmFinderException, BbmRemoveException {
<span class="nc" id="L3118">		methodStart(&quot;unlinkEmployeeShiftAssignments&quot;);</span>

<span class="nc" id="L3120">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L3122">			dao.unlinkShiftAssignmentToSP(emp.getID(), emp.getOrgChangedDate());</span>
		} finally {
<span class="nc" id="L3124">			dao.cleanUp();</span>
<span class="nc" id="L3125">			methodFinish();</span>
<span class="nc" id="L3126">		}</span>
<span class="nc" id="L3127">	}</span>

	/**
	 * get an given organization's campaign assignments
	 *
	 * @param idOrg   organization id
	 * @param dtStart
	 * @param dtEnd   the time period, null date means a open period
	 * @return a collection of CampaignOrg objects which hold the assignment
	 * information
	 */
	public Collection getOrgCampaignAssignments(ID idOrg, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L3139">		methodStart(&quot;getOrgCampaignAssignments&quot;, idOrg, dtStart, dtEnd);</span>
<span class="fc" id="L3140">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="fc" id="L3142">			return dao.getOrgCampaignAssignments(idOrg, dtStart, dtEnd);</span>
<span class="nc" id="L3143">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L3144">			handleException(e, false);</span>
<span class="nc" id="L3145">			throw e;</span>
		} finally {
<span class="pc" id="L3147">			dao.cleanUp();</span>
<span class="pc" id="L3148">			methodFinish();</span>
		}
	}

	public Collection&lt;SPQueue&gt; getSPQueuesByQueues(Collection&lt;Queue&gt; queues) throws BbmFinderException {
<span class="nc" id="L3153">		methodStart(&quot;getSPQueuesByQueues&quot;);</span>
<span class="nc" id="L3154">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L3156">			return dao.getSPQueuesByQueues(queues);</span>
		} finally {
<span class="nc" id="L3158">			dao.cleanUp();</span>
<span class="nc" id="L3159">			methodFinish();</span>
		}
	}

	public void cloneLSGTemplateForNewSP(ID idTargetSP, Collection&lt;CampaignHOO&gt; spHOOs) throws BbmCreateException {
<span class="nc bnc" id="L3164" title="All 6 branches missed.">		if (idTargetSP == null || spHOOs == null || spHOOs.isEmpty()) {</span>
<span class="nc" id="L3165">			return;</span>
		}
<span class="nc" id="L3167">		SPQueueDAO dao = null;</span>
<span class="nc" id="L3168">		SchedulingPeriodDAO spDao = null;</span>
		try {
<span class="nc" id="L3170">			dao = new SPQueueDAO();</span>
<span class="nc" id="L3171">			spDao = new SchedulingPeriodDAO();</span>
<span class="nc" id="L3172">			Collection&lt;SPQueue&gt; spQueues = dao.getSPQueuesBySPID(idTargetSP);</span>
<span class="nc" id="L3173">			Set&lt;ID&gt; previousSPIDs = new HashSet&lt;ID&gt;();</span>

<span class="nc bnc" id="L3175" title="All 2 branches missed.">			for (CampaignHOO campaignHOO : spHOOs) {</span>
<span class="nc bnc" id="L3176" title="All 2 branches missed.">				if (!previousSPIDs.contains(campaignHOO.getSPID())) {</span>
<span class="nc" id="L3177">					previousSPIDs.add(campaignHOO.getSPID());</span>
				}
<span class="nc" id="L3179">			}</span>

<span class="nc" id="L3181">			List&lt;SchedulingPeriod&gt; sortedPreviousSPs = new ArrayList&lt;SchedulingPeriod&gt;(spDao.getObjectsByIDs(previousSPIDs));</span>
<span class="nc" id="L3182">			Collections.sort(sortedPreviousSPs, new Comparator&lt;SchedulingPeriod&gt;() {</span>
				@Override
				public int compare(SchedulingPeriod o1, SchedulingPeriod o2) {
<span class="nc" id="L3185">					return o2.getStartTime().compareTo(o1.getStartTime());</span>
				}
			});
<span class="nc" id="L3188">			Map&lt;ID, ID&gt; queueIDToSPQueues = new HashMap&lt;ID, ID&gt;();</span>

<span class="nc bnc" id="L3190" title="All 2 branches missed.">			for (SchedulingPeriod sortedPreviousSP : sortedPreviousSPs) {</span>
<span class="nc" id="L3191">				Collection&lt;SPQueue&gt; spQueuesTemp = dao.getSPQueuesBySPID(sortedPreviousSP.getID());</span>
<span class="nc bnc" id="L3192" title="All 2 branches missed.">				for (SPQueue oQueue : spQueuesTemp) {</span>
<span class="nc bnc" id="L3193" title="All 2 branches missed.">					if (!queueIDToSPQueues.containsKey(oQueue.getQueueID())) {</span>
<span class="nc" id="L3194">						queueIDToSPQueues.put(oQueue.getQueueID(), oQueue.getDEID());</span>
					}
<span class="nc bnc" id="L3196" title="All 2 branches missed.">					if (queueIDToSPQueues.size() == spQueues.size()) {</span>
<span class="nc" id="L3197">						break;</span>
					}
<span class="nc" id="L3199">				}</span>
<span class="nc bnc" id="L3200" title="All 2 branches missed.">				if (queueIDToSPQueues.size() == spQueues.size()) {</span>
<span class="nc" id="L3201">					break;</span>
				}
<span class="nc" id="L3203">			}</span>

<span class="nc" id="L3205">			Map&lt;ID, ID&gt; previousSPQueueIdToNewSPQueueID = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc bnc" id="L3206" title="All 2 branches missed.">			for (SPQueue spQueue : spQueues) {</span>
<span class="nc" id="L3207">				ID oldSPQueueID = queueIDToSPQueues.get(spQueue.getQueueID());</span>
<span class="nc bnc" id="L3208" title="All 2 branches missed.">				if (oldSPQueueID != null) {</span>
<span class="nc" id="L3209">					previousSPQueueIdToNewSPQueueID.put(oldSPQueueID, spQueue.getDEID());</span>
				}
<span class="nc" id="L3211">			}</span>
<span class="nc" id="L3212">			getLSInfoExtractor().cloneLsgTemplateFromCurrentSPQueueIDToClonedSPQueueID(previousSPQueueIdToNewSPQueueID);</span>
<span class="nc" id="L3213">		} catch (Exception e) {</span>
<span class="nc" id="L3214">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc bnc" id="L3216" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L3217">				dao.cleanUp();</span>
			}
<span class="nc bnc" id="L3219" title="All 4 branches missed.">			if (spDao != null) {</span>
<span class="nc" id="L3220">				spDao.cleanUp();</span>
			}
		}
<span class="nc" id="L3223">	}</span>

	private LSGInfoExtractor getLSInfoExtractor() throws Exception {
<span class="nc" id="L3226">		final GCRManager m_gcrManager = CoreManagerFactory.getGCRManagerRemote(m_isWhatIf);</span>
<span class="nc" id="L3227">		final String gcrType = &quot;OPERATIONS_LSG_MANAGER&quot;;</span>
<span class="nc" id="L3228">		final Collection entries = m_gcrManager.getGCREntryOfType(gcrType);</span>
<span class="nc" id="L3229">		final Class clazz = Class.forName(((GCREntry) (entries.iterator().next())).getHook());</span>
<span class="nc" id="L3230">		return (LSGInfoExtractor) clazz.newInstance();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>