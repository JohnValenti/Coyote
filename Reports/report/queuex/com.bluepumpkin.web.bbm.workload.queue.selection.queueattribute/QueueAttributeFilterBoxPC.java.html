<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueAttributeFilterBoxPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute</a> &gt; <span class="el_source">QueueAttributeFilterBoxPC.java</span></div><h1>QueueAttributeFilterBoxPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute;

import java.rmi.RemoteException;
import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.CoreEJBCreateException;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationUtil;
import com.bluepumpkin.web.bbm.workload.queue.selection.QueueFilterUtil;
import com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute.filter.QueueAttributeFilterPickerPC;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.jsp.HtmlTable;
import com.witness.web.uif.jsp.HtmlTableCell;
import com.witness.web.uif.jsp.HtmlTableRow;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.pagecomponent.filterbox.FilterBoxPC;
import com.witness.web.uif.pagecomponent.list.ListBoxPC;
import com.witness.web.uif.pagecomponent.list.OptionData;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.SortUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title:
 * Description:
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author		Sankar Nair
 * @version 1.0
 */
public class QueueAttributeFilterBoxPC extends FilterBoxPC {
	private static final String ORGANIZATION_SELECTED = &quot;ORGANIZATION_SELECTED&quot;;
	private static final String CAMPAIGN_SELECTED = &quot;CAMPAIGN_SELECTED&quot;;
<span class="nc" id="L53">	private static final ID BLANK_ID = new ID(0);</span>
	private static final String FILTER_NAME = &quot;queueFilter&quot;;
	private static final String MEDIA_ID_FN = &quot;mediaID&quot;;
	private static final String ORGANIZATION_ID_FN = &quot;organizationID&quot;;
	private static final short LIST_FILTER_MAX_WIDTH = (short)125;
	private static final String OUTER_TABLE_WIDTH = &quot;305&quot;;
<span class="nc" id="L59">	private String m_tempCampaignID = null;</span>

<span class="nc" id="L61">	private Collection m_mediaFilterList = Collections.emptyList();</span>
	private ListBoxPC m_mediaListbox;
<span class="nc" id="L63">	private Collection m_organizationFilterList = Collections.emptyList();</span>
	private ListBoxPC m_OrganizationListBox;
	private QueueAttributeFilterPickerPC m_queueAttribPicker;
	private ID m_queueAttribFilterID;
	private ResourceBundle m_bbmBundle;
	private ID m_mediaID;
	private ID m_organizationID;
	private String m_orgCampSelection;

<span class="nc" id="L72">	private Boolean m_isCampaignPermitted = null;</span>

	public QueueAttributeFilterBoxPC(RequestContext context) {
<span class="nc" id="L75">		super(context);</span>
<span class="nc" id="L76">		setName(FILTER_NAME);</span>


<span class="nc" id="L79">		m_bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L81">		m_OrganizationListBox = new ListBoxPC(context);</span>

<span class="nc" id="L83">		m_mediaListbox = new ListBoxPC(context);</span>

<span class="nc" id="L85">		m_queueAttribPicker = new QueueAttributeFilterPickerPC(context);</span>
<span class="nc" id="L86">		addSiblingComponent(m_queueAttribPicker);</span>

<span class="nc" id="L88">		setIsActionOptionsEnabled(false);</span>
<span class="nc" id="L89">	}</span>

	/**
	 * Initialize Component For Display
	 */
	public void initForDisplay() {
<span class="nc bnc" id="L95" title="All 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L96">			return;</span>
		} else {
<span class="nc" id="L98">			super.initForDisplay();</span>

<span class="nc" id="L100">			String header=verticalize(m_bbmBundle, BbmWebBundleKey.FILTERBOX_CAMPAIGN);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">			if(!isCampaignPermitted()) {</span>
<span class="nc" id="L102">				header = &quot;&quot;;</span>
			}

<span class="nc" id="L105">			setHeader(header);</span>
<span class="nc" id="L106">			initQueueAttributeProperties();</span>
		}
<span class="nc" id="L108">	}</span>

	private void initQueueAttributeProperties() {
<span class="nc" id="L111">		m_queueAttribPicker.setName(getName() + &quot;_queueAttribListBox&quot;);</span>
<span class="nc" id="L112">		m_queueAttribPicker.initFilter(true);</span>

<span class="nc" id="L114">		m_queueAttribPicker.getListbox().getWrapper().setAttribute(&quot;colspan&quot;, &quot;2&quot;);//Wrapper is an HtmlTableCell</span>
<span class="nc" id="L115">		m_queueAttribPicker.getListbox().getSelect().setAttribute(&quot;width&quot;, &quot;86px&quot;);//set a longer width, override the default m_filterWidth</span>
<span class="nc" id="L116">		m_queueAttribPicker.getListbox().setMaxDisplayWidth(LIST_FILTER_MAX_WIDTH);</span>

<span class="nc" id="L118">		m_queueAttribPicker.getListbox().getSelect().setAttribute(&quot;width&quot;, LIST_FILTER_MAX_WIDTH + &quot;px&quot;);</span>
<span class="nc" id="L119">	}</span>

	/**
	 * Initialize Media List Properties
	 */
	private void initMediaListProperties() {
<span class="nc" id="L125">		m_mediaListbox.setName(getName() + &quot;_mediaListbox&quot;);</span>
<span class="nc" id="L126">		m_mediaListbox.setMaxDisplayWidth(getListBoxDisplayMaxWidth());</span>
<span class="nc" id="L127">		m_mediaListbox.setHtmlName(MEDIA_ID_FN);</span>
<span class="nc" id="L128">		m_mediaListbox.getSelect().setAttribute(&quot;width&quot;, m_filterWidth + &quot;px&quot;);</span>
<span class="nc" id="L129">		m_mediaListbox.setOptions(m_mediaFilterList);</span>
<span class="nc" id="L130">	}</span>


	/**
	 * Initialize Organization List Properties
	 */
	private void initOrganizationListProperties() {
<span class="nc" id="L137">		m_OrganizationListBox.setName(getName() + &quot;_organizationListbox&quot;);</span>
<span class="nc" id="L138">		m_OrganizationListBox.setMaxDisplayWidth(getListBoxDisplayMaxWidth());</span>
<span class="nc" id="L139">		m_OrganizationListBox.setHtmlName(ORGANIZATION_ID_FN);</span>
<span class="nc" id="L140">		m_OrganizationListBox.getSelect().setAttribute(&quot;width&quot;, m_filterWidth + &quot;px&quot;);</span>
<span class="nc" id="L141">		Iterator iter = m_organizationFilterList.iterator();</span>

		//The below code is added to avoid the growth in width of Org picker
		//when any sub orgs are picked.
		//This is the current indentation used in TreeModelBuilder class to
		//as the indentation between an organization and sub organization.
		//The below logic will replace this two space with a single space thus
		//saving space - Sankar
<span class="nc" id="L149">		String indent = HtmlUtil.DD_OPTION_INDENT + HtmlUtil.DD_OPTION_INDENT;</span>
<span class="nc" id="L150">		int indexTemp = -1;</span>
<span class="nc" id="L151">		int index = 0;</span>
<span class="nc" id="L152">		int length = 0;</span>
<span class="nc" id="L153">		StringBuffer newString = null;</span>


<span class="nc bnc" id="L156" title="All 2 branches missed.">		while(iter.hasNext()) {</span>
<span class="nc" id="L157">			Object value = iter.next();</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">			if( value instanceof OptionData) {</span>
<span class="nc" id="L159">				OptionData data = (OptionData)value;</span>
<span class="nc" id="L160">				String sValue = data.getValue();</span>
<span class="nc" id="L161">				newString = new StringBuffer(&quot;&quot;);</span>

<span class="nc" id="L163">				indexTemp = -1;</span>
<span class="nc" id="L164">				index = 0;</span>
<span class="nc" id="L165">				length = 0;</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">				while(index != -1) {</span>
<span class="nc" id="L168">					index = sValue.indexOf(indent, index + length);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">					if(index != -1) {</span>
<span class="nc" id="L170">						newString.append(HtmlUtil.DD_OPTION_INDENT);</span>
					}

<span class="nc" id="L173">					length = indent.length();</span>
					//End of string reached
<span class="nc bnc" id="L175" title="All 2 branches missed.">					if(index == -1) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">						if(indexTemp == -1)</span>
<span class="nc" id="L177">							newString.append(sValue);</span>
						else
<span class="nc" id="L179">							newString.append(sValue.substring(indexTemp + length));</span>
					}
<span class="nc" id="L181">					indexTemp = index;</span>
				}
<span class="nc" id="L183">				data.setValue(newString.toString());</span>
			}
<span class="nc" id="L185">		}</span>

<span class="nc" id="L187">		m_OrganizationListBox.setOptions(m_organizationFilterList);</span>

<span class="nc" id="L189">	}</span>

	protected short getListBoxDisplayMaxWidth() {
<span class="nc" id="L192">		return LIST_FILTER_MAX_WIDTH;</span>
	}

	/**
	 * Initialize Component
	 */
	public void init() throws Exception {
<span class="nc" id="L199">		initFilterDD();</span>
<span class="nc" id="L200">	}</span>

	public void setMediaID(ID id) {
<span class="nc bnc" id="L203" title="All 2 branches missed.">		if (BLANK_ID.equals(id)) id=null;</span>
<span class="nc" id="L204">		m_mediaID=id;</span>
<span class="nc" id="L205">	}</span>

	public ID getMediaID() {
<span class="nc" id="L208">		return m_mediaID;</span>
	}

	public void setQueueAttributeFilterID(ID id) {
<span class="nc bnc" id="L212" title="All 2 branches missed.">		if(BLANK_ID.equals(id)) id = null;</span>
<span class="nc" id="L213">		m_queueAttribFilterID = id;</span>
<span class="nc" id="L214">	}</span>

	public ID getQueueAttributeFilterID() {
		//System.out.println(&quot;Selected Filter Name &quot; + m_queueAttribPicker.getSelectedFilterName());
<span class="nc bnc" id="L218" title="All 2 branches missed.">		if(m_context.getUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER) == null)</span>
<span class="nc" id="L219">			return BLANK_ID;</span>
<span class="nc" id="L220">		return new ID(m_context.getUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER));</span>
	}

	public ID getCampaignID() {
		//isCampaignSelected();
<span class="nc" id="L225">		return QueueFilterUtil.retrieveCampaignID(m_context);</span>
	}


	public void setOrganizationID(ID id) {
<span class="nc bnc" id="L230" title="All 4 branches missed.">		if (id == null || BLANK_ID.equals(id)) {</span>
<span class="nc" id="L231">			id=null;</span>
<span class="nc" id="L232">			OrganizationUtil.setSelectedOrganizationID(m_context, &quot;&quot;);</span>
		} else {
<span class="nc" id="L234">			OrganizationUtil.setSelectedOrganizationID(m_context, id.toString());</span>
		}
<span class="nc" id="L236">		m_organizationID = id;</span>
<span class="nc" id="L237">	}</span>

	public ID getOrganizationID() {
<span class="nc" id="L240">		String orgID = OrganizationUtil.getSelectedOrganizationID(m_context);</span>
<span class="nc bnc" id="L241" title="All 4 branches missed.">		if(orgID == null || orgID.trim().length() &lt; 1)</span>
<span class="nc" id="L242">			m_organizationID = null;</span>
		else
<span class="nc" id="L244">			m_organizationID = new ID(orgID);</span>

<span class="nc" id="L246">		return m_organizationID;</span>
	}

	public void setOrgCampSelection(String selection) {
<span class="nc bnc" id="L250" title="All 4 branches missed.">		if(selection == null || selection.trim().length() == 0)</span>
<span class="nc" id="L251">			return;</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">		if(selection.equals(CAMPAIGN_SELECTED))</span>
<span class="nc" id="L253">			restoreCampaigID();</span>
		else
<span class="nc" id="L255">			backupCampaignID();</span>
<span class="nc" id="L256">		m_orgCampSelection = selection;</span>
<span class="nc" id="L257">	}</span>

	public String getOrgCampSelection() {
<span class="nc" id="L260">		return m_orgCampSelection;</span>
	}

	private void backupCampaignID() {
<span class="nc" id="L264">		m_tempCampaignID = QueueFilterUtil.getSelectedCampaignID(m_context);</span>
<span class="nc bnc" id="L265" title="All 4 branches missed.">		if(m_tempCampaignID != null &amp;&amp; m_tempCampaignID.trim().length() &gt; 0) {</span>
<span class="nc" id="L266">			m_context.setUserProperty(&quot;TEMP_CAMPAIGN_ID&quot;, m_tempCampaignID);</span>
		}
<span class="nc" id="L268">		QueueFilterUtil.setSelectedCampaignID(m_context, &quot;&quot;);</span>

<span class="nc" id="L270">	}</span>

	private void restoreCampaigID() {
<span class="nc" id="L273">		m_tempCampaignID = m_context.getUserProperty(&quot;TEMP_CAMPAIGN_ID&quot;);</span>
<span class="nc bnc" id="L274" title="All 4 branches missed.">		if(m_tempCampaignID != null &amp;&amp; m_tempCampaignID.trim().length() &gt; 0){</span>
<span class="nc" id="L275">			QueueFilterUtil.setSelectedCampaignID(m_context, m_tempCampaignID);</span>
<span class="nc" id="L276">			m_context.setUserProperty(&quot;TEMP_CAMPAIGN_ID&quot;, &quot;&quot;);</span>
<span class="nc" id="L277">			m_tempCampaignID = null;</span>
		}
<span class="nc" id="L279">	}</span>

	public boolean isOrganizationSelected() {
		//Initial Loading - Set campaign selected by default, if no permission, fall back to Org as default
<span class="nc bnc" id="L283" title="All 4 branches missed.">		if(m_orgCampSelection == null || m_orgCampSelection.trim().length() &lt; 1) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">			if(isCampaignPermitted()) {</span>
<span class="nc" id="L285">				setOrgCampSelection(CAMPAIGN_SELECTED);</span>
<span class="nc" id="L286">				return false;</span>
			}
<span class="nc bnc" id="L288" title="All 2 branches missed.">			if(isOrganizationPermitted()) {</span>
<span class="nc" id="L289">				setOrgCampSelection(ORGANIZATION_SELECTED);</span>
<span class="nc" id="L290">				return true;</span>
			}
<span class="nc" id="L292">			return false;</span>
		}
<span class="nc bnc" id="L294" title="All 4 branches missed.">		return m_orgCampSelection.equals(ORGANIZATION_SELECTED) &amp;&amp; isOrganizationPermitted();</span>
	}


	public boolean isCampaignSelected() {

		//Initial Loading - Set campaign selected by default
<span class="nc bnc" id="L301" title="All 4 branches missed.">		if(m_orgCampSelection == null || m_orgCampSelection.trim().length() &lt; 1) {</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">			if(isCampaignPermitted()) {</span>
<span class="nc" id="L303">				setOrgCampSelection(CAMPAIGN_SELECTED);</span>
<span class="nc" id="L304">				return true;</span>
			}
<span class="nc" id="L306">			return false;</span>
		}

<span class="nc bnc" id="L309" title="All 4 branches missed.">		return  m_orgCampSelection.equals(CAMPAIGN_SELECTED) &amp;&amp; isCampaignPermitted();</span>
	}

	/**
	 * Create Media Display with Hidden Field
	 */
	private Object getMediaUI() {
		//return m_mediaListbox;
<span class="nc" id="L317">		return m_queueAttribPicker;</span>
	}

	/**
	 * Create Top Row
	 */
	protected HtmlTableRow createTopRow() {
<span class="nc bnc" id="L324" title="All 2 branches missed.">		if(!isCampaignPermitted()) {</span>
<span class="nc" id="L325">			return createSpacerRow();</span>
		}

<span class="nc" id="L328">		ArrayList rowcells = new ArrayList();</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">		if (m_isFullDisplayMode) {</span>
<span class="nc" id="L330">			HtmlTableCell cell = createLabelCell(getHeader());</span>
<span class="nc" id="L331">			rowcells.add(cell);</span>
		}

<span class="nc bnc" id="L334" title="All 2 branches missed.">		if(isOrganizationPermitted()) {</span>
<span class="nc" id="L335">			String label = i18n(m_bbmBundle, BbmWebBundleKey.FILTERBOX_ORGANIZATION);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">			if(isCampaignPermitted())</span>
<span class="nc" id="L337">				label = HtmlChoiceInput.makeRadioInput(&quot;orgCampSelection&quot;, ORGANIZATION_SELECTED, isOrganizationSelected(),</span>
						JSUtil.REFRESH_PAGE) + label;
<span class="nc" id="L339">			HtmlTableCell cell = new HtmlTableCell(label + &quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L340">			cell.setHeight(&quot;18&quot;);</span>
<span class="nc" id="L341">			cell.setStyleClass(&quot;headerText&quot;);</span>
<span class="nc" id="L342">			cell.setStyle(&quot;white-space:nowrap;&quot;);</span>
<span class="nc" id="L343">			rowcells.add(cell);</span>
		}

<span class="nc" id="L346">		return new HtmlTableRow(rowcells);</span>
	}

	/**
	 * Create Second Row
	 */
	protected HtmlTableRow createSpacerRow() {
<span class="nc" id="L353">		ListBoxPC listBox = null;</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">		if (isCampaignSelected()) {</span>
<span class="nc" id="L355">			listBox = m_listbox;</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">		} else if (isOrganizationSelected()) {</span>
<span class="nc" id="L357">			listBox = m_OrganizationListBox;</span>
		}
<span class="nc" id="L359">		List rowcells = new ArrayList();</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">		if (listBox != null) {</span>
			//Wrapper is an HtmlTableCell
<span class="nc" id="L362">			listBox.getWrapper().setAttribute(&quot;colspan&quot;, &quot;3&quot;);</span>
			//set a longer width, override the default m_filterWidth
<span class="nc" id="L364">			listBox.getSelect().setAttribute(&quot;width&quot;, LIST_FILTER_MAX_WIDTH + &quot;px&quot;);</span>
			//INPUT width 241px + 14px Button
<span class="nc" id="L366">			listBox.setMaxDisplayWidth(LIST_FILTER_MAX_WIDTH);</span>
<span class="nc" id="L367">			rowcells.add(createLabelCell(getHeader()).toString() + listBox.toString());</span>
		}
<span class="nc" id="L369">		return new HtmlTableRow(rowcells);</span>
	}

	private boolean isOrganizationPermitted() {
<span class="nc" id="L373">		return false;</span>
	}

	private boolean isCampaignPermitted() {
<span class="nc bnc" id="L377" title="All 2 branches missed.">		if(m_isCampaignPermitted == null)</span>
<span class="nc" id="L378">			m_isCampaignPermitted = new Boolean(isLicensed(LicenseKeys.APP_FS));</span>
<span class="nc" id="L379">		return m_isCampaignPermitted.booleanValue();</span>
	}

	/**
	 * Return Bottom Row : Media UI
	 */
	public HtmlTableRow createBottomRow() {
<span class="nc" id="L386">		Object rowData = getMediaUI();</span>
		//((FilterBoxPC)rowData).setGenerateWrapper(false);

<span class="nc" id="L389">		Object[] args = new Object[1];</span>
<span class="nc" id="L390">	    args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="nc" id="L391">	    String label = MessageFormat.format( m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_ATTRIBUTE_FILTER_PICKER_CAPTION), args);</span>
<span class="nc" id="L392">	    label+=&quot;:&quot;;</span>
<span class="nc" id="L393">		m_queueAttribPicker.setHeader(label);</span>
<span class="nc" id="L394">		m_queueAttribPicker.setIsFullDisplayMode(true);</span>
<span class="nc" id="L395">		m_queueAttribPicker.setDisplayLabels(true);</span>

<span class="nc" id="L397">		ArrayList rowcells = new ArrayList();</span>
<span class="nc" id="L398">		rowcells.add(createLabelCell(m_queueAttribPicker.getHeader()).toString() + m_queueAttribPicker.toString());</span>
<span class="nc" id="L399">		return new HtmlTableRow(rowcells);</span>
	}

	/**
	 * Extract Parameter
	 */
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L406">		boolean success = super.extractParameters(request);</span>

		// Cache Campaign ID
<span class="nc" id="L409">		String sTmpID = getSelectedFilterName();</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">		if (!StringUtil.isEmpty(sTmpID)) {</span>

			// If One Time Use ID is available then use it instead of extracted value
			// Used by Workpane Refreshing Selection Pane
<span class="nc" id="L414">			ID camID = QueueFilterUtil.retrieveCampaignIDForOneTimeUse(m_context);</span>

<span class="nc bnc" id="L416" title="All 2 branches missed.">			if (camID!=null) sTmpID = camID.toString();</span>

<span class="nc bnc" id="L418" title="All 2 branches missed.">			if (BLANK_ID.toString().equals(sTmpID)) {</span>
				// User Blank Campaign (All Queues Selected)
<span class="nc" id="L420">				QueueFilterUtil.storeCampaignID(m_context, null);</span>
			} else {
<span class="nc" id="L422">				QueueFilterUtil.storeCampaignID(m_context, new ID(sTmpID));</span>
			}
		}

<span class="nc" id="L426">		return success;</span>
	}

	//////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	//////////////////////////////////////////////////////////////////////////////
	private void addBlankOption(List filters, String display, boolean isSelected) {
<span class="nc" id="L433">		OptionData data = new OptionData(display, BLANK_ID.toString(), isSelected);</span>
<span class="nc" id="L434">		filters.add(data);</span>
<span class="nc" id="L435">	}</span>

	/**
	 * init Filter Drown Down of Organizations
	 */
	private void initFilterDD_Organizations() throws Exception {
<span class="nc" id="L441">		ArrayList filters = new ArrayList();</span>

		// Create Organization List
<span class="nc" id="L444">		Collection orgList = OrganizationModelHandler.getAllOrgsInUserScope(m_context, m_context.getUser());</span>

		// Retrieve Selected Organization ID
<span class="nc" id="L447">		ID orgID = getOrganizationID();</span>


		// Add All Queues Option
<span class="nc bnc" id="L451" title="All 2 branches missed.">		if (m_context.getUser().isAuthorized(PrivilegeKeys.FS_VIEWALLQUEUEHISTORY_ID))</span>
		{
      // verticalise queue
<span class="nc" id="L454">      Object[] args = new Object[1];</span>
<span class="nc" id="L455">      args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="nc" id="L456">      String formattedTitle = MessageFormat.format( m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.ALL_QUEUES), args);</span>

<span class="nc" id="L458">      addBlankOption(filters, formattedTitle, false);</span>
<span class="nc" id="L459">			filters.add( FILTER_OPTION_DIVIDER );</span>
<span class="nc" id="L460">		}</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">		else if (orgID == null)</span>
		{
			//User cannot see the 'All Queues' selection, and there is no cached campaign,
			//so we will just choose the first campaign for him.
<span class="nc bnc" id="L465" title="All 2 branches missed.">			if (orgList != null)</span>
			{
<span class="nc" id="L467">				orgList = SortUtil.sortBasicVO(orgList, m_localizer);</span>
<span class="nc" id="L468">				Organization org = null;</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">				for (Iterator it = orgList.iterator(); it.hasNext();)</span>
				{
<span class="nc" id="L471">					org = (Organization) it.next();</span>
					break;
				}

<span class="nc bnc" id="L475" title="All 2 branches missed.">				if (org != null)</span>
<span class="nc" id="L476">					orgID = org.getID();</span>
			}
		}

<span class="nc bnc" id="L480" title="All 2 branches missed.">		String selectedID = orgID==null?null:orgID.toString();</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">		if(orgList != null) {</span>
<span class="nc" id="L482">			Collection optionList = CampaignModelHandler.createDropDownValueList(orgList, selectedID, m_localizer, false);</span>
<span class="nc" id="L483">			filters.addAll(optionList);</span>
		}


		//initFilterWithOptions(filters);
<span class="nc" id="L488">		m_organizationFilterList = filters;</span>
<span class="nc" id="L489">	}</span>


	/**
	 * init Filter Drown Down of Campaigns
	 */
	private void initFilterDD() throws Exception {
<span class="nc bnc" id="L496" title="All 2 branches missed.">		if(!isCampaignSelected()) {</span>
<span class="nc" id="L497">			backupCampaignID();</span>
<span class="nc" id="L498">			return;</span>
		}

<span class="nc" id="L501">		ArrayList filters = new ArrayList();</span>

		// Create Campaign List
<span class="nc" id="L504">		Collection campList = CampaignModelHandler.getCampaignsForUser(m_context, m_context.getUser());</span>

		// Retrieve Selected campaign ID
<span class="nc" id="L507">		ID camID = getCampaignID();</span>

		// Add All Queues Option
<span class="nc bnc" id="L510" title="All 2 branches missed.">		if (m_context.getUser().isAuthorized(PrivilegeKeys.FS_VIEWALLQUEUEHISTORY_ID))</span>
		{
	      // verticalise queue
<span class="nc" id="L513">	      Object[] args = new Object[1];</span>
<span class="nc" id="L514">	      args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="nc" id="L515">	      String formattedTitle = MessageFormat.format( m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.ALL_QUEUES), args);</span>

<span class="nc" id="L517">	      addBlankOption(filters, formattedTitle, false);</span>
<span class="nc" id="L518">				filters.add( FILTER_OPTION_DIVIDER );</span>
<span class="nc" id="L519">		}</span>
		else {
			/*
			 *If the user do not have privilege to see all orgs, we still add an option to
			 *enable no campaign selection. This is mainly to let the user select
			 *and view queues of an org using Queue Attribute Filter. When this option
			 *is selected and no filter option is selected, the queue selection would show queues
			 *of all the campaigns in which the user has permission. - Sankar
			 */

<span class="nc" id="L529">			String formattedTitle=verticalize(m_bbmBundle, BbmWebBundleKey.QUEUE_ATTRIBUTE_NO_CAMPAIGN);</span>
<span class="nc" id="L530">			addBlankOption(filters, formattedTitle, false);</span>
<span class="nc" id="L531">			filters.add( FILTER_OPTION_DIVIDER );</span>

		}
		/*
		 * Removing the below case as we are adding No Campaign option even if the user don't
		 * have the privilege to see all Organization
		else if (camID == null)
		{
			//User cannot see the 'All Queues' selection, and there is no cached campaign,
			//so we will just choose the first campaign for him.
			if (campList != null)
			{
				campList = SortUtil.sortBasicVO(campList, m_localizer);
				Campaign camp = null;
				for (Iterator it = campList.iterator(); it.hasNext();)
				{
					camp = (Campaign) it.next();
					break;
				}

				if (camp != null)
					camID = camp.getID();

				CampaignUtil.setSelectedCampaignID(m_context, camID==null?null:camID.toString());
			}
		}*/

<span class="nc bnc" id="L558" title="All 2 branches missed.">		String selectedID = camID==null?null:camID.toString();</span>

<span class="nc" id="L560">		Collection optionList = CampaignModelHandler.createDropDownValueList(campList, selectedID, m_localizer, false);</span>
<span class="nc" id="L561">		filters.addAll(optionList);</span>

<span class="nc" id="L563">		initFilterWithOptions(filters);</span>
<span class="nc" id="L564">	}</span>
	/**
	 * Initialize the Media Drop Down
	 */
	private void initMediaDD(Collection mediaList) throws Exception {
<span class="nc bnc" id="L569" title="All 4 branches missed.">		if (mediaList!=null &amp;&amp; !mediaList.isEmpty()) {</span>
<span class="nc" id="L570">			ID selectedID = getMediaID();</span>
<span class="nc" id="L571">			ArrayList filters = new ArrayList(mediaList.size() + 1);</span>
<span class="nc" id="L572">			addBlankOption(filters, &quot;&quot;, false);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">			for (Iterator it = mediaList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L574">				Media media = (Media)it.next();</span>
<span class="nc" id="L575">				ID mediaID = media.getID();</span>
<span class="nc" id="L576">				boolean isSelected = mediaID.equals(selectedID);</span>
<span class="nc" id="L577">				OptionData data = new OptionData(media.getName(), mediaID.toString(), isSelected);</span>
<span class="nc" id="L578">				filters.add(data);</span>
<span class="nc" id="L579">			}</span>
<span class="nc" id="L580">			m_mediaFilterList = filters;</span>
		}
<span class="nc" id="L582">	}</span>

	/**
	 * Return Html Display
	 * Sankar Nair - Overriding this function to ensure that
	 * the alignment of selector pane is matching to Pulse applet
	 * when both the Campaign picker and Org picker are shown.
	 */
	public String getHtmlDisplay() {
		// initialize the filters in the listbox
<span class="nc" id="L592">		m_listbox.setOptions(getFilters());</span>

<span class="nc" id="L594">		HtmlTable outer_table = new HtmlTable(&quot;0&quot;, &quot;0&quot;, &quot;0&quot;);</span>
<span class="nc" id="L595">		outer_table.setWidth(OUTER_TABLE_WIDTH);</span>
		//outer_table.add( createTopRow() );
<span class="nc" id="L597">		outer_table.add( createSpacerRow());</span>

		// Show bottom is it is in Full Display Mode
<span class="nc bnc" id="L600" title="All 2 branches missed.">		if (m_isFullDisplayMode) {</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">			if (m_isBottomRowEnabled)	outer_table.add( createBottomRow() );</span>
<span class="nc" id="L602">			else outer_table.add( createEmptyBottomRow() );</span>
		}

		//Length specified in the FilterBoxPC class
<span class="nc" id="L606">		String height = &quot;12&quot;;</span>
		//Checking whether both the Org picker and Campaign picker are going to be displayed.
<span class="nc bnc" id="L608" title="All 4 branches missed.">		if(isCampaignPermitted() &amp;&amp; isOrganizationPermitted())</span>
<span class="nc" id="L609">			height = &quot;2&quot;;</span>

		// Generate HTML output
<span class="nc" id="L612">		StringBuffer buff = new StringBuffer(1024);</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">		if (useWrapper()) {</span>
<span class="nc" id="L614">			buff.append(&quot;\n&lt;div style=\&quot;margin-top:&quot;);</span>
<span class="nc" id="L615">			buff.append(height);</span>
<span class="nc" id="L616">			buff.append(&quot;px; margin-bottom:7px;\&quot;&gt;&quot;);</span>
		}



<span class="nc" id="L621">		buff.append(outer_table);</span>
<span class="nc" id="L622">		buff.append(HtmlUtil.makeHiddenInput(getName(), &quot;&quot;));</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">		if (useWrapper()) buff.append(&quot;\n&lt;/div&gt;&quot;);</span>

<span class="nc" id="L625">		return buff.toString();</span>
	}

	private boolean isLicensed(String license) {
		//LicenseKeys.APP_FS;
		//LicenseKeys.APP_Operations
<span class="nc bnc" id="L631" title="All 4 branches missed.">		if(license == null || license.trim().length() &lt; 1)</span>
<span class="nc" id="L632">			return false;</span>
		try {
<span class="nc" id="L634">			return CoreManagerFactory.getLicenseManager().isLicensed(license);</span>
<span class="nc" id="L635">		} catch (CoreEJBCreateException e) {</span>
<span class="nc" id="L636">		} catch (RemoteException e) {</span>
<span class="nc" id="L637">		}</span>
<span class="nc" id="L638">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>