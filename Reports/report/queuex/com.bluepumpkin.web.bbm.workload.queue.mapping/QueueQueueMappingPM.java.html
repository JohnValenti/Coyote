<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueQueueMappingPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload.queue.mapping</a> &gt; <span class="el_source">QueueQueueMappingPM.java</span></div><h1>QueueQueueMappingPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload.queue.mapping;

import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.ResourceBundle;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.keys.BbmImageFileID;
import com.bluepumpkin.web.bbm.keys.BbmJavaScriptFileID;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationUtil;
import com.bluepumpkin.web.bbm.workload.WorkloadModelHandler;
import com.bluepumpkin.web.bbm.workload.queue.QueueUtil;
import com.verint.web.wfm.keys.WfmJavaScriptFileID;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.jsp.HtmlButton;
import com.witness.web.uif.jsp.HtmlImage;
import com.witness.web.uif.jsp.HtmlTableCell;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.assignmentbox.AdvancedAssignBoxPC;
import com.witness.web.uif.pagecomponent.container.ContainerPC;
import com.witness.web.uif.pagecomponent.contenttitle.ContentTitlePC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagemodel.WorkpaneFormPageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.HtmlUtil;

/**
 * Title: QueueMappingPM Description: Display the page for mapping Queues to
 * Queue Copyright: Copyright (c) 2003 Company: Blue Pumpkin Software, inc
 * 
 * @author Uri Peleg
 * @version 1.0
 */
public class QueueQueueMappingPM extends WorkpaneFormPageModel {
<span class="fc" id="L54">    private static final Category log = Log.initCategory(QueueMappingPM.class.getName());</span>
    protected ResourceBundle m_bbmBundle;
    private final AdvancedAssignBoxPC m_queuesAssignBox;
<span class="fc" id="L57">    private boolean m_isInitiated = false;</span>
    // private final ArrayList m_mappedQueuesIDs = new ArrayList();
    private String m_mappedQueues;
    // private HashMap m_allQueuesMap;
    private final ContainerPC m_containerPC;
    private Collection m_mappedQueueIDs;
    boolean m_refreshSelection;

<span class="fc" id="L65">    private int m_limitingPageSize = 0;</span>
    private final FormInputPC m_searchInputPC;

    public static final String QUEUE_MAPPING_URL = &quot;queue_queue_fs&quot;;

    // sort actions
    public static final String LIST_QUEUE_NAME_SRC_SORT = &quot;NAME&quot;;
    public static final String LIST_QUEUE_SRC_SORT = &quot;LIST_QUEUE_SRC_SORT&quot;;
    public static final String LIST_QUEUE_NAME_DST_SORT = &quot;DST&quot;;
    public static final String LIST_QUEUE_DST_SORT = &quot;LIST_QUEUE_DST_SORT&quot;;

    protected static final String ROW_HEIGHT = &quot;18&quot;;
    protected static final String DEFAULT_LABEL_STYLE_CLASS = &quot;headerText&quot;;
    protected static final String DEFAULT_LABEL_STYLE = &quot;white-space:nowrap;&quot;;

    protected static final int MAX_DSG_COUNT = 5000; // Limit page size to 5000
    // for the DataSourceGroup
    // screen, if this value
    // is not configured in
    // BPCONFIG for key
    // &quot;bluepumpkin/dsg/pageIDSizeLimit&quot;
    protected static final int DEFAULT_DSG_COUNT = 200;

    public static final String DSG_LIMIT_COUNT_HTML_NAME = &quot;dsLimitCount&quot;;

    public QueueQueueMappingPM(RequestContext context) {
<span class="fc" id="L91">        super(context, QueueQueueMappingPM.FRAMED_MODEL);</span>
<span class="fc" id="L92">        m_bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>

        // Component specific required JavaScript Files
<span class="fc" id="L95">        addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE);</span>
<span class="fc" id="L96">        setJSMediator(WfmJavaScriptFileID.MEDIATOR_QUEUE_WORKPANE_FORM);</span>

        // JQuery file added for the new dynamic DSG search
<span class="fc" id="L99">        addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>

        // Add JavaScript Variables
<span class="fc" id="L102">        addJSVariable(DELETE_CONFIRMATION, m_bbmBundle, BbmWebBundleKey.DATASOURCE_DELETE_CONFIRM);</span>
        // Add JavaScript Variables
<span class="fc" id="L104">        addJSVariable(&quot;LOSE_CHANGES&quot;, m_bbmBundle, BbmWebBundleKey.QUEUE_LOSE_CHANGES);</span>

<span class="fc" id="L106">        m_queuesAssignBox = new AdvancedAssignBoxPC(context);</span>
<span class="fc" id="L107">        addChildComponent(m_queuesAssignBox);</span>
<span class="fc" id="L108">        m_queuesAssignBox.setName(getName() + &quot;_assignmentbox&quot;);</span>

<span class="fc" id="L110">        m_containerPC = new ContainerPC(context);</span>
<span class="fc" id="L111">        addChildComponent(m_containerPC);</span>

        // People search client-side logic.
<span class="fc" id="L114">        addRequiredJavaScriptFile(BbmJavaScriptFileID.PARENT_QUEUE_MAPPING_SEARCH);</span>

        // Input box for the people search function.
<span class="fc" id="L117">        m_searchInputPC = new FormInputPC(m_context);</span>
<span class="fc" id="L118">        m_searchInputPC.reset();</span>
<span class="fc" id="L119">        m_searchInputPC.setInputFN(&quot;parentQueueSearchString&quot;);</span>
<span class="fc" id="L120">        m_searchInputPC.setStyle(&quot;width:134px;left:3px; top:-5px; margin-top: 5px;&quot;);</span>
<span class="fc" id="L121">        m_searchInputPC.setOnChangeJS(&quot;&quot;);</span>
<span class="fc" id="L122">        m_searchInputPC.setIsRequired(false);</span>
<span class="fc" id="L123">        setLimitingPageSize();</span>
<span class="fc" id="L124">    }</span>

    @Override
    public void initForDisplay() {
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L129">            return;</span>
        } else {
<span class="fc" id="L131">            super.initForDisplay();</span>

            // Component specific required JavaScript Files
<span class="fc" id="L134">            addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE);</span>
<span class="fc" id="L135">            setJSMediator(JavaScriptFileID.MEDIATOR_WORKPANE_GENERIC);</span>

<span class="fc" id="L137">            this.setSelectedID(OrganizationUtil.getSelectedOrganizationID(m_context));</span>
<span class="fc" id="L138">            QueueUtil.setSelectedQueueID(m_context, this.getPerformActionOnID());</span>

<span class="fc" id="L140">            m_context.setAttribute(RequestContext.SESSION_SCOPE, &quot;CACHED_QUEUE_ID&quot;, this.getPerformActionOnID());</span>
            // Add JavaScript Variables
<span class="fc" id="L142">            addJSVariable(DELETE_CONFIRMATION, m_bbmBundle, BbmWebBundleKey.DATASOURCE_DELETE_CONFIRM);</span>
            // Add JavaScript Variables
<span class="fc" id="L144">            addJSVariable(&quot;LOSE_CHANGES&quot;, m_bbmBundle, BbmWebBundleKey.QUEUE_LOSE_CHANGES);</span>

            // Init the form and toolbar should be called only after loading the
            // data. These components
            // need Data from the Back-End. The assumtion is that
            // populateModel() is called before initForDisplay
<span class="fc" id="L150">            initToolbar();</span>
        }
<span class="fc" id="L152">    }</span>

    public static QueueQueueMappingPM getInstance(RequestContext context) {
<span class="fc" id="L155">        QueueQueueMappingPM model = null;</span>
<span class="fc" id="L156">        model = new QueueQueueMappingPM(context);</span>
<span class="fc" id="L157">        model.extractParameters(context);</span>
<span class="fc" id="L158">        context.setPageModel(model);</span>

<span class="fc" id="L160">        model.populateModel(context);</span>
<span class="fc" id="L161">        return model;</span>
    }

    /**
     * Override extract Parameters to handle date input
     */
    public boolean extractParameters(RequestContext context) {
<span class="fc" id="L168">        final boolean success = super.extractParameters(context.getRequest());</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        if (m_queuesAssignBox != null) {</span>
<span class="fc" id="L170">            m_queuesAssignBox.extractParameters(context.getRequest());</span>
        }
<span class="fc" id="L172">        return success;</span>
    }

    /**
     * Populate Model
     *
     */
    public void populateModel(RequestContext context) {
<span class="pc bpc" id="L180" title="4 of 8 branches missed.">        if ((this.getPageAction() != null) &amp;&amp; (this.getPageAction().equals(PageAction.RESET) || this.getPageAction().equals(&quot;CHANGEDS_ACTION&quot;) || this.getPageAction().equals(PageAction.SAVE))) {</span>
<span class="nc" id="L181">            m_queuesAssignBox.resetExtractedIDs();</span>
        }
<span class="fc" id="L183">        int type = 0;</span>

<span class="fc" id="L185">        this.setSelectedID(OrganizationUtil.getSelectedOrganizationID(m_context));</span>
<span class="fc" id="L186">        QueueUtil.setSelectedQueueID(m_context, this.getPerformActionOnID());</span>

        try {
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">            if (hasSelectedID()) {</span>
<span class="fc" id="L190">                type = WorkloadModelHandler.getQueueByID(m_context, new ID(this.getPerformActionOnID())).getQueueType();</span>
            }
<span class="pc bpc" id="L192" title="2 of 4 branches missed.">            if (!hasSelectedID() || (type == Queue.QUEUE_TYPE_NORMAL)) {</span>
<span class="nc" id="L193">                this.removeChildComponent(m_queuesAssignBox);</span>
            }
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">            if (m_isInitiated) {</span>
<span class="nc" id="L196">                return;</span>
            } else {
<span class="fc" id="L198">                m_isInitiated = true;</span>
            }

            // verticalise queue
<span class="fc" id="L202">            final Object[] args = new Object[1];</span>
<span class="fc" id="L203">            args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUESMALL);</span>

<span class="pc bpc" id="L205" title="1 of 2 branches missed.">            if (!isAuthorizedToConfigure()) {</span>
<span class="nc" id="L206">                addPageMessage(Message.INFO_TYPE, MessageFormat.format(m_localizer.i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_NOTAUTHORIZED_CONFIGURE), args));</span>
            }

<span class="pc bpc" id="L209" title="1 of 2 branches missed.">            if (hasSelectedID()) {</span>
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">                if (type == Queue.QUEUE_TYPE_NORMAL) {</span>
<span class="nc" id="L211">                    addPageMessage(Message.ERROR_TYPE, m_localizer.i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_SELECTION_ERROR));</span>
<span class="nc" id="L212">                    m_initFailure = true;</span>
                } else {
<span class="fc" id="L214">                    addPageMessage(Message.INFO_TYPE, MessageFormat.format(m_localizer.i18n(m_bbmBundle, BbmWebBundleKey.UPTO_N_QUEUES_SHOWN), new Object[] { m_limitingPageSize }));</span>
<span class="fc" id="L215">                    initQueuesAssignBox();</span>
                }
            } else {
<span class="nc" id="L218">                addPageMessage(Message.RESPONSE_TYPE, MessageFormat.format(m_localizer.i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_MAKE_SELECTION), args));</span>
            }
<span class="nc" id="L220">        } catch (final Exception ex) {</span>
<span class="nc" id="L221">            handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L222">            m_initFailure = true;</span>
<span class="fc" id="L223">        }</span>

<span class="fc" id="L225">    }</span>

    /**
     * Initialize Toolbar
     */
    @Override
    protected void initToolbar() {
        // if failed to load the page - don't show the buttons
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        if (m_initFailure) {</span>
<span class="nc" id="L234">            return;</span>
        }
<span class="fc" id="L236">        m_toolbar.setName(getName() + &quot;_toolbar&quot;);</span>
<span class="fc" id="L237">        m_toolbar.setAlignment(ToolbarPC.ALIGN_RIGHT);</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        final boolean isSelectedID = !StringUtil.isEmpty(this.getSelectedID());</span>

<span class="pc bpc" id="L240" title="2 of 4 branches missed.">        m_toolbar.addValidateSubmitTextButton(PageAction.SAVE, i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_MAPPING_SAVE_LABEL), isSelectedID &amp;&amp; isAuthorizedToConfigure());</span>

<span class="pc bpc" id="L242" title="2 of 4 branches missed.">        m_toolbar.addConfirmSubmitTextButton(PageAction.RESET, i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_RESET), isSelectedID &amp;&amp; isAuthorizedToConfigure());</span>

<span class="fc" id="L244">        m_toolbar.addConfirmSubmitTextButton(PageAction.CANCEL, i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_CANCEL), true);</span>
<span class="fc" id="L245">    }</span>

    /**
     * Initialize the Assignment box
     */
    @SuppressWarnings(&quot;rawtypes&quot;)
    private void initQueuesAssignBox() throws Exception {
        // verticalise queue
<span class="fc" id="L253">        Object[] args = new Object[1];</span>
<span class="fc" id="L254">        args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="fc" id="L255">        m_queuesAssignBox.setHeaderTitle(MessageFormat.format(i18n(m_bbmBundle, BbmWebBundleKey.QUEUES_MAPPING_LIST_TITLE), args));</span>

<span class="fc" id="L257">        Collection allQueues = Collections.emptyList();</span>
<span class="fc" id="L258">        List mappedQueues = Collections.emptyList();</span>

<span class="fc" id="L260">        final ID queueId = new ID(this.getPerformActionOnID());</span>
        // createQueuesMap();

<span class="pc bpc" id="L263" title="1 of 2 branches missed.">        if (queueId != null) {</span>
<span class="fc" id="L264">            m_mappedQueueIDs = WorkloadModelHandler.getSubQueues(m_context, queueId);</span>
        }

        try {
<span class="fc" id="L268">            Collection availQueueColl = new ArrayList();</span>
            // final Queue queue = (Queue) m_allQueuesMap.get(queueId);
<span class="fc" id="L270">            final Queue queue = WorkloadModelHandler.getQueueByID(m_context, queueId);</span>

<span class="fc" id="L272">            availQueueColl = WorkloadModelHandler.getAllNormalQueues(m_context, null, queue.getOrganizationID(), queue.getMediaID(), queueId, m_limitingPageSize);</span>
<span class="fc" id="L273">            allQueues = getAllQueues(availQueueColl);</span>
<span class="nc" id="L274">        } catch (final Exception ex) {</span>
<span class="nc" id="L275">            log.l7dError(&quot;Failed to get all queues from the data base&quot;, ex);</span>

            // verticalise queue
<span class="nc" id="L278">            args = new Object[1];</span>
<span class="nc" id="L279">            args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUESMALL);</span>

<span class="nc" id="L281">            addPageMessage(Message.ERROR_TYPE, MessageFormat.format(i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_GET_ALL_FAIL), args));</span>
<span class="nc" id="L282">            return;</span>
<span class="fc" id="L283">        }</span>

        // verticalise queue
<span class="fc" id="L286">        args = new Object[1];</span>
<span class="fc" id="L287">        args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUES);</span>

<span class="fc" id="L289">        final StringBuffer sbfLeftTitle = new StringBuffer(1024);</span>
<span class="fc" id="L290">        sbfLeftTitle.append(MessageFormat.format(i18n(m_bbmBundle, BbmWebBundleKey.AVAILABLE_QUEUES_HEADING), args));</span>
<span class="fc" id="L291">        sbfLeftTitle.append(&quot;&lt;br&gt;&lt;span style=\&quot;white-space:nowrap;\&quot;&gt;&quot;);</span>
<span class="fc" id="L292">        sbfLeftTitle.append(this.createSearchBox());</span>
<span class="fc" id="L293">        sbfLeftTitle.append(&quot;&lt;/span&gt;&quot;);</span>

<span class="fc" id="L295">        m_queuesAssignBox.setLeftTitle(sbfLeftTitle.toString());</span>

<span class="fc" id="L297">        m_queuesAssignBox.setRightTitle(MessageFormat.format(i18n(m_bbmBundle, BbmWebBundleKey.MAPPED_QUEUES_HEADING), args) + &quot;&lt;br&gt;&amp;nbsp;&quot;);</span>

        try {
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">            if (queueId != null) {</span>
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">                if (m_mappedQueueIDs != null) {</span>
<span class="fc" id="L302">                    mappedQueues = getMappedQueues(m_mappedQueueIDs);</span>
<span class="fc" id="L303">                    m_mappedQueues = StringUtil.createDelimitedString(m_mappedQueueIDs, &quot;,&quot;);</span>
                    // if (mappedQueues != null) {
                    // for (final Iterator it = mappedQueues.iterator();
                    // it.hasNext();) {
                    // final DefaultMultiColumnNodeData data =
                    // (DefaultMultiColumnNodeData) it.next();
                    // m_mappedQueuesIDs.add(data.getID());
                    // }
                    // }
                }
            }
<span class="nc" id="L314">        } catch (final Exception ex) {</span>
<span class="nc" id="L315">            log.l7dError(&quot;Failed to get mapped queues&quot;, ex);</span>

            // verticalise queue
<span class="nc" id="L318">            args = new Object[1];</span>
<span class="nc" id="L319">            args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUESSMALL);</span>

<span class="nc" id="L321">            addPageMessage(Message.ERROR_TYPE, MessageFormat.format(i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_GET_ALL_FAIL), args));</span>
<span class="nc" id="L322">            return;</span>
<span class="fc" id="L323">        }</span>

<span class="pc bpc" id="L325" title="1 of 2 branches missed.">        if (allQueues == null) {</span>
<span class="nc" id="L326">            allQueues = Collections.emptyList();</span>
        }
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">        if (mappedQueues == null) {</span>
<span class="nc" id="L329">            mappedQueues = Collections.emptyList();</span>
        }
<span class="fc" id="L331">        final int mappedQueuesSize = mappedQueues.size();</span>
<span class="fc" id="L332">        final int availableQueuesSize = allQueues.size() - mappedQueuesSize;</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">        final int initialCapacity = availableQueuesSize &gt; 0 ? availableQueuesSize : 0;</span>
<span class="fc" id="L334">        final ArrayList availableQueues = new ArrayList(initialCapacity);</span>

<span class="fc" id="L336">        int allFound = 0;</span>

<span class="fc bfc" id="L338" title="All 2 branches covered.">        for (final Iterator it1 = allQueues.iterator(); it1.hasNext();) {</span>
<span class="fc" id="L339">            final DefaultMultiColumnNodeData data1 = (DefaultMultiColumnNodeData) it1.next();</span>
<span class="fc" id="L340">            boolean found = false;</span>
<span class="fc bfc" id="L341" title="All 2 branches covered.">            if (mappedQueuesSize &gt; allFound) {</span>
<span class="fc bfc" id="L342" title="All 2 branches covered.">                for (final Iterator it2 = mappedQueues.iterator(); it2.hasNext();) {</span>
<span class="fc" id="L343">                    final DefaultMultiColumnNodeData data2 = (DefaultMultiColumnNodeData) it2.next();</span>
<span class="pc bpc" id="L344" title="1 of 2 branches missed.">                    if (data1.getID().equals(data2.getID())) {</span>
<span class="nc" id="L345">                        found = true;</span>
<span class="nc" id="L346">                        break;</span>
                    }
<span class="fc" id="L348">                }</span>
            }
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">            if (!found) {</span>
<span class="fc" id="L351">                allFound++;</span>
<span class="fc" id="L352">                availableQueues.add(data1);</span>
            }
<span class="fc" id="L354">        }</span>

<span class="fc" id="L356">        final TableHeaderPC leftHeader = m_queuesAssignBox.getSrcListPC().getHeader();</span>

        // verticalise queue
<span class="fc" id="L359">        args = new Object[1];</span>
<span class="fc" id="L360">        args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>

        // Set up Headers
<span class="fc" id="L363">        leftHeader.addColumnHeaderData(LIST_QUEUE_NAME_SRC_SORT, MessageFormat.format(i18n(m_bbmBundle, BbmWebBundleKey.QUEUE), args), true);</span>

        // Enable List Sorting
<span class="fc" id="L366">        leftHeader.setSortable(true);</span>
<span class="fc" id="L367">        leftHeader.setDefaultSortColumn(LIST_QUEUE_NAME_SRC_SORT);</span>

        // sort QC69427
<span class="fc" id="L370">        m_queuesAssignBox.getSrcListPC().setIsAutoSortEnabled(true);</span>
<span class="fc" id="L371">        m_queuesAssignBox.getSrcListPC().getHeader().setSortColumn(LIST_QUEUE_NAME_SRC_SORT);</span>
<span class="fc" id="L372">        m_queuesAssignBox.getSrcListPC().setEnabled(true);</span>
<span class="fc" id="L373">        m_queuesAssignBox.setEnabled(true);</span>

<span class="fc" id="L375">        final TableHeaderPC rightHeader = m_queuesAssignBox.getDstListPC().getHeader();</span>
        // Set up Headers
<span class="fc" id="L377">        rightHeader.addColumnHeaderData(LIST_QUEUE_NAME_DST_SORT, MessageFormat.format(i18n(m_bbmBundle, BbmWebBundleKey.QUEUE), args), true);</span>
<span class="fc" id="L378">        rightHeader.setDefaultSortColumn(LIST_QUEUE_DST_SORT);</span>

        // Enable List Sorting
<span class="fc" id="L381">        rightHeader.setSortable(true);</span>

<span class="fc" id="L383">        m_queuesAssignBox.setIsSortable(true);</span>
<span class="fc" id="L384">        m_queuesAssignBox.getDstListPC().getHeader().setSortColumn(LIST_QUEUE_NAME_DST_SORT);</span>
<span class="fc" id="L385">        m_queuesAssignBox.getSrcListPC().setWidth(&quot;225&quot;);</span>
<span class="fc" id="L386">        m_queuesAssignBox.getDstListPC().setWidth(&quot;225&quot;);</span>

<span class="fc" id="L388">        m_queuesAssignBox.getSrcListPC().setHeightInPixels(250);</span>
<span class="fc" id="L389">        m_queuesAssignBox.getDstListPC().setHeightInPixels(250);</span>

<span class="fc" id="L391">        m_queuesAssignBox.getSrcListPC().setListModel(availableQueues);</span>
<span class="fc" id="L392">        m_queuesAssignBox.getDstListPC().setListModel(mappedQueues);</span>
<span class="fc" id="L393">        m_queuesAssignBox.getDstListPC().getWrapper().setStyle(&quot;background-color:#F7F7F7; border:0px solid #D2D2D2; height: 250px; overflow: auto&quot;);</span>
<span class="fc" id="L394">        m_queuesAssignBox.getSrcListPC().getWrapper().setStyle(&quot;background-color:#F7F7F7; border:0px solid #D2D2D2; height: 250px; overflow: auto&quot;);</span>
<span class="fc" id="L395">        m_containerPC.setTemplate(&quot;&lt;table&gt;&lt;tr&gt;&lt;td width = \&quot;*\&quot;&gt;{0}&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;);</span>
<span class="fc" id="L396">        m_containerPC.addComponent(m_queuesAssignBox);</span>
<span class="fc" id="L397">    }</span>

    private String createSearchBox() {

<span class="fc" id="L401">        final ArrayList&lt;HtmlTableCell&gt; cells = new ArrayList&lt;HtmlTableCell&gt;();</span>
<span class="fc" id="L402">        final HtmlTableCell cell = createLabelCell(m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.EMPLOYEE_SEARCH_INPUT_LABEL));</span>
<span class="fc" id="L403">        cells.add(cell);</span>

<span class="fc" id="L405">        final HtmlImage searchIcon = new HtmlImage(BbmImageFileID.SEARCH, m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.SEARCH));</span>
<span class="fc" id="L406">        searchIcon.setWidth(&quot;16&quot;);</span>
<span class="fc" id="L407">        searchIcon.setHeight(&quot;16&quot;);</span>

<span class="fc" id="L409">        final HtmlButton searchButton = new HtmlButton(&quot;dataSourceSearchButton&quot;);</span>
<span class="fc" id="L410">        searchButton.setStyle(&quot;border: #7386ad 1px solid; padding: 0px; border-left: none; height: 18px; cursor: pointer; margin-top: 5px;&quot;);</span>
<span class="fc" id="L411">        searchButton.setInnerHtml(searchIcon);</span>

<span class="fc" id="L413">        final HtmlImage ajaxLoading = new HtmlImage(BbmImageFileID.AJAX_LOADING, m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.LOADING_DATA));</span>
<span class="fc" id="L414">        ajaxLoading.setWidth(&quot;14&quot;);</span>
<span class="fc" id="L415">        ajaxLoading.setHeight(&quot;14&quot;);</span>
<span class="fc" id="L416">        ajaxLoading.setStyleClass(&quot;employeeSearchLoading&quot;);</span>
<span class="fc" id="L417">        ajaxLoading.setStyle(&quot;display: none;&quot;);</span>

<span class="fc" id="L419">        return m_searchInputPC.toString() + searchButton.toString() + ajaxLoading.toString();</span>
    }

    protected HtmlTableCell createLabelCell(String label) {
<span class="fc" id="L423">        final HtmlTableCell cell = new HtmlTableCell(label + &quot;&amp;nbsp;&quot;);</span>
        // cell.setWidth(&quot;35&quot;);
<span class="fc" id="L425">        cell.setHeight(ROW_HEIGHT);</span>
<span class="fc" id="L426">        cell.setStyleClass(DEFAULT_LABEL_STYLE_CLASS);</span>
<span class="fc" id="L427">        cell.setStyle(DEFAULT_LABEL_STYLE);</span>
<span class="fc" id="L428">        return cell;</span>
    }

    /*
     * private void createQueuesMap() throws Exception { final Collection
     * allQueues = WorkloadModelHandler .getAllQueues(m_context); m_allQueuesMap
     * = new HashMap(allQueues.size()); for (final Iterator it =
     * allQueues.iterator(); it.hasNext();) { final Queue queue = (Queue)
     * it.next(); m_allQueuesMap.put(queue.getID(), queue); } }
     */

    public void setRefreshSelection(boolean refreshSelection) {
<span class="fc" id="L440">        m_refreshSelection = refreshSelection;</span>
<span class="fc" id="L441">    }</span>

    public boolean getRefreshSelection() {
<span class="nc" id="L444">        return m_refreshSelection;</span>
    }

    /**
     * Return the JavaScript init code required by Page model.
     *
     * Default behavior is to retrieve sub-component JavaScript Init code
     */
    @Override
    public String getJavaScriptInitCode() {
<span class="fc" id="L454">        final StringBuffer jsInit = new StringBuffer(1000);</span>
<span class="fc" id="L455">        jsInit.append(super.getJavaScriptInitCode());</span>

<span class="pc bpc" id="L457" title="1 of 2 branches missed.">        if (m_refreshSelection) {</span>
<span class="nc" id="L458">            jsInit.append(getPageMediatorRef() + &quot;.refreshSelectionPane();\n&quot;);</span>
        }

<span class="fc" id="L461">        return jsInit.toString();</span>
    }

    private List getMappedQueues(Collection mappedQueues) throws Exception {
<span class="fc" id="L465">        List data = new ArrayList();</span>

        // Build the collection
<span class="pc bpc" id="L468" title="1 of 4 branches missed.">        if ((mappedQueues != null) &amp;&amp; (mappedQueues.size() &gt; 0)) {</span>
<span class="fc" id="L469">            data = new ArrayList(mappedQueues.size());</span>
<span class="fc" id="L470">            final Collection&lt;Queue&gt; queues = WorkloadModelHandler.getQueuesByIDs(m_context, mappedQueues);</span>
<span class="fc bfc" id="L471" title="All 2 branches covered.">            for (final Queue queue : queues) {</span>
<span class="fc" id="L472">                final ArrayList rowData = new ArrayList(2);</span>
<span class="fc" id="L473">                rowData.add(queue.getName());</span>
<span class="fc" id="L474">                final DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(queue.getID().toString(), rowData);</span>

<span class="fc" id="L476">                data.add(nodeData);</span>
<span class="fc" id="L477">            }</span>
        }

<span class="fc" id="L480">        return data;</span>
    }

    public Collection getAllQueues(Collection allQueues) {
<span class="fc" id="L484">        ArrayList data = new ArrayList();</span>

        // Build the collection
<span class="pc bpc" id="L487" title="2 of 4 branches missed.">        if ((allQueues != null) &amp;&amp; (allQueues.size() &gt; 0)) {</span>
<span class="fc" id="L488">            data = new ArrayList(allQueues.size());</span>
<span class="fc bfc" id="L489" title="All 2 branches covered.">            for (final Iterator it = allQueues.iterator(); it.hasNext();) {</span>
<span class="fc" id="L490">                final Queue queue = (Queue) it.next();</span>
<span class="fc" id="L491">                final ArrayList rowData = new ArrayList(2);</span>
<span class="fc" id="L492">                rowData.add(queue.getName());</span>
<span class="fc" id="L493">                final DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(queue.getID().toString(), rowData);</span>

<span class="fc" id="L495">                data.add(nodeData);</span>
<span class="fc" id="L496">            }</span>
        }

<span class="fc" id="L499">        return data;</span>
    }

    @Override
    public void initFieldValidators() {

<span class="fc" id="L505">    }</span>

    /**
     * Return Required HTML
     */
    @Override
    public String getRequiredHTML() {
<span class="fc" id="L512">        return super.getRequiredHTML() + HtmlUtil.makeHiddenInput(&quot;curQueueID&quot;, m_mappedQueues) + HtmlUtil.makeHiddenInput(&quot;selectedID&quot;, this.getSelectedID()) + HtmlUtil.makeHiddenInput(&quot;queueID&quot;, this.getPerformActionOnID()) + HtmlUtil.makeHiddenInput(&quot;dsLimitCount&quot;, m_limitingPageSize) + HtmlUtil.makeHiddenInput(&quot;performActionOnID&quot;, this.getPerformActionOnID()) + HtmlUtil.makeHiddenInput(IS_WORKPANE_MODE, true);</span>
    }

    /**
     * setCurQueueID
     */
    public void setCurQueueID(String curQueueID) {
<span class="fc" id="L519">        m_mappedQueues = curQueueID;</span>
<span class="fc" id="L520">    }</span>

    /**
     * getCurQueueID
     */
    public String getCurQueueID() {
<span class="nc" id="L526">        return m_mappedQueues;</span>
    }

    /**
     * getCurQueueID
     */
    public Collection getCurQueueIDColl() {
<span class="nc bnc" id="L533" title="All 2 branches missed.">        if (!StringUtil.isEmpty(m_mappedQueues)) {</span>
<span class="nc" id="L534">            return StringUtil.parseIDStringToCollection(m_mappedQueues);</span>
        } else {
<span class="nc" id="L536">            return null;</span>
        }
    }

    @Override
    public String getFormTitle() {
        // verticalise queue
<span class="fc" id="L543">        final Object[] args = new Object[1];</span>
<span class="fc" id="L544">        args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="fc" id="L545">        return MessageFormat.format(i18n(m_bbmBundle, BbmWebBundleKey.ORG_WORKLOADS_QUEUE_MAPPING_LIST_TITLE), args);</span>
    }

    protected String getTitleEntityType() {
<span class="fc" id="L549">        return getFormTitle();</span>
    }

    /**
     * Returns an entity name. Used for title.
     */
    protected String getEntityName() {
<span class="fc" id="L556">        String name = &quot;&amp;nbsp;&quot;;</span>
        try {
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">            if (hasSelectedID()) {</span>
<span class="fc" id="L559">                final Queue queue = WorkloadModelHandler.getQueueByID(m_context, new ID(getPerformActionOnID()));</span>
<span class="fc" id="L560">                name = queue.getName();</span>
            }
<span class="nc" id="L562">        } catch (final Exception ex) {</span>
<span class="fc" id="L563">        }</span>
<span class="fc" id="L564">        return name;</span>
    }

    public Collection getAssignedQueueIDs() {
<span class="fc" id="L568">        return m_queuesAssignBox.getDstListIDs();</span>
    }

    /**
     * Return the title
     */
    @Override
    public ContentTitlePC getContentTitle() {
<span class="fc" id="L576">        final StringBuffer itemName = new StringBuffer(64);</span>

<span class="fc" id="L578">        m_contentTitlePC.setPageTitle(this.getTitleEntityType());</span>

        // Set the item name: [queue name]
<span class="fc" id="L581">        itemName.append(this.getEntityName());</span>

<span class="fc" id="L583">        m_contentTitlePC.setItemName(itemName.toString());</span>

<span class="fc" id="L585">        return m_contentTitlePC;</span>
    }

    /**
     * Return the Page Form Component associated with Page Model Use this method
     * if you have only one form
     */
    public PageComponent getContainerPC() {
<span class="fc" id="L593">        return m_containerPC;</span>
    }

    /**
     * Return URL for HTML Form Action
     */
    @Override
    public String getFormAction() {
<span class="fc" id="L601">        return &quot;queuequeue_mapping&quot;;</span>
    }

    private boolean isAuthorizedForDSGroup() {
<span class="nc" id="L605">        final String privName = PrivilegeKeys.FS_VIEWDATASOURCEGROUPS;</span>
<span class="nc bnc" id="L606" title="All 4 branches missed.">        return (m_context.getUser() != null) &amp;&amp; m_context.getUser().isAuthorized(privName);</span>
    }

    @Override
    protected boolean isAuthorizedToConfigure() {
<span class="pc bpc" id="L611" title="2 of 4 branches missed.">        return (m_context.getUser() != null) &amp;&amp; m_context.getUser().isAuthorized(PrivilegeKeys.FS_CONFIGUREQUEUES);</span>
    }

    /**
     * Sets the maximum page size for the requests screens. The default value is
     * DEFAULT_DSG_COUNT , unless overridden by the BPCONFIG key
     * &quot;bluepumpkin/rm/pageIDSizeLimit&quot;
     */
    public int readLimitingPageSize() {
<span class="fc" id="L620">        int limitingPageSize = 0;</span>
        try {
<span class="fc" id="L622">            final String pageIDSizeFetched = BbmManagerFactory.getDBConfigManager().getValue(ConfigKey.DS_PAGE_ID_SIZE_LIMIT);</span>
<span class="pc bpc" id="L623" title="1 of 2 branches missed.">            if (pageIDSizeFetched != null) {</span>
<span class="nc" id="L624">                limitingPageSize = Integer.parseInt(pageIDSizeFetched);</span>
            } else {
<span class="fc" id="L626">                limitingPageSize = DEFAULT_DSG_COUNT;</span>
            }
<span class="pc bpc" id="L628" title="2 of 4 branches missed.">            if ((limitingPageSize &lt;= 0) || (limitingPageSize &gt; MAX_DSG_COUNT)) {</span>
<span class="nc" id="L629">                limitingPageSize = DEFAULT_DSG_COUNT;</span>
            }

<span class="nc" id="L632">        } catch (final Exception ex) {</span>
            // ignoring any exception caught.
<span class="fc" id="L634">        }</span>
<span class="fc" id="L635">        return limitingPageSize;</span>
    }

    protected void setLimitingPageSize() {
<span class="fc" id="L639">        m_limitingPageSize = readLimitingPageSize();</span>
<span class="fc" id="L640">    }</span>

    protected void createFormModel() {

<span class="nc" id="L644">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>