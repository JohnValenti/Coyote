<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.activity.ejb</a> &gt; <span class="el_source">ActivityDAO.java</span></div><h1>ActivityDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.activity.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Set;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.Filter.Filter;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFieldInfo;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilterDAO;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityProperties;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.witness.ejb.core.licensing.LicenseKeys;

public class ActivityDAO extends DAOBase&lt;Activity&gt; {

	private static final String AND = &quot; AND &quot;;
<span class="fc" id="L29">	private static final FieldInfo activityFieldInfo = new ActivityFieldInfo();</span>

	@Override
	public FieldInfo getFieldInfo() {
<span class="fc" id="L33">		return activityFieldInfo;</span>
	}

	public ActivityDAO(){
<span class="fc" id="L37">		super();</span>
<span class="fc" id="L38">	}</span>

	public ActivityDAO(Jdmo dmo) {
<span class="fc" id="L41">		super(dmo);</span>
<span class="fc" id="L42">	}</span>

	@Override
	protected Activity createValueObject() {
<span class="fc" id="L46">		return new Activity();</span>
	}

	protected Collection findActivities(Collection ids) throws BbmFinderException {
		try {
<span class="nc" id="L51">			return checkLicense(getObjects(&quot;A.ID in &quot; + m_dmo.createInClause(ids)));</span>
<span class="nc" id="L52">		} catch(JdmoException e) {</span>
<span class="nc" id="L53">			throw new BbmFinderException(e);</span>
		}
	}

	// find organization (and its parents) activities
	protected Collection&lt;Activity&gt; findOrganizationActivities(Collection&lt;ID&gt; organizationIdCol, ActivityFilter activityFilter)
		throws BbmFinderException {
<span class="nc" id="L60">		Collection parentOrgs = DAOUtil.getParentOrganizationsCollection(organizationIdCol, m_dmo);</span>
<span class="nc" id="L61">		parentOrgs.addAll(organizationIdCol);</span>
<span class="nc" id="L62">		return findOrganizationActivities(parentOrgs, activityFilter, false);</span>
	}


	private static String replaceFieldWithCase(String selectStatement, String fieldName) {
<span class="fc" id="L67">		String replacement = String.format( &quot;case when ACTIVITYCATEGORY.%s &gt; 0 then ACTIVITYCATEGORY.%s	else A.%s end as %s&quot;,</span>
					fieldName,fieldName,fieldName,fieldName );
<span class="fc" id="L69">		return selectStatement.replace( &quot;A.&quot;+fieldName, replacement);</span>
	}

	private Set&lt;ID&gt; getAllOrgIds(Collection&lt;ID&gt; orgIds, boolean findParentOrgs) {
<span class="fc" id="L73">		HashSet&lt;ID&gt; allOrgs = new HashSet&lt;&gt;(orgIds);</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">		if(findParentOrgs) {</span>
<span class="fc" id="L75">			HashSet&lt;ID&gt; parentOrgs = DAOUtil.getParentOrganizationsCollection(orgIds, m_dmo);</span>
<span class="fc" id="L76">			allOrgs.addAll(parentOrgs);</span>
		}
<span class="fc" id="L78">		return allOrgs;</span>
	}


	/**
	 * Similar to findOrganizationActivities, but findOrganizationActivitiesCheckCategory
	 *  also checks for the values of fields ISDELETED and ISTIMEOFFWITHALLOTMENT
	 * in the ActivityCategory table in addition to the values in Activity table.
	 * This is needed since a value of  ISTIMEOFFWITHALLOTMENT = 1 in the ActivityCategory table
	 * implies that all activities that have this category will also have a value of 1.
	 * @param orgIds orgIds
	 * @param activityFilter activityFilter
	 * @param findParentOrgs findParentOrgs
	 * @return Collection&lt;Activity&gt;
	 * @throws BbmFinderException BbmFinderException
	 */
	protected Collection&lt;Activity&gt; findOrganizationActivitiesCheckCategory( Collection&lt;ID&gt; orgIds,
			ActivityFilter activityFilter, boolean findParentOrgs) throws BbmFinderException {
		try {
<span class="fc" id="L97">			String fullSql = getOrganizationActvitiesSql(orgIds,activityFilter,findParentOrgs, ActivityProperties.FLEX_TIME_INVALID);</span>
<span class="fc" id="L98">			return checkLicense(getObjectsGivenFullSqlQueryStr(fullSql));</span>
<span class="nc" id="L99">		} catch(JdmoException e) {</span>
<span class="nc" id="L100">			throw new BbmFinderException(e);</span>
		}

	}

	/**
	 * This method appends all the possible conditions to attain the final sql that would return the org related categories.
	 * Major change from previous version of this method is to filter flex and time off activities based on FLEXTIMEOFF value
	 * @param orgIds orgIds
	 * @param activityFilter activityFilter
	 * @param findParentOrgs findParentOrgs
	 * @param flexType -
	 * @return String
	 * @throws JdmoException JdmoException
	 */
	private String getOrganizationActvitiesSql(Collection&lt;ID&gt; orgIds,
			ActivityFilter activityFilter, boolean findParentOrgs, int flexType) throws JdmoException {

<span class="fc" id="L118">		Set&lt;ID&gt; allOrgs = getAllOrgIds(orgIds, findParentOrgs);</span>
		//Select field1,field2...
<span class="fc" id="L120">		StringBuffer selectFieldBuffer = getSelectStatement();</span>
<span class="fc" id="L121">		appendSystemFieldsToSelect(selectFieldBuffer);</span>

		//replace fields that need to be checked against ACTIVITYCATEGORY with case statements
<span class="fc" id="L124">		String selectFields = selectFieldBuffer.toString();</span>
<span class="fc" id="L125">		selectFields = replaceFieldWithCase(selectFields, &quot;ISDELETED&quot;);</span>
<span class="fc" id="L126">		selectFields = replaceFieldWithCase(selectFields, &quot;ISTIMEOFFWITHALLOTMENT&quot;);</span>

<span class="fc" id="L128">		StringBuilder whereAndOrder = new StringBuilder(128);</span>
<span class="fc" id="L129">		whereAndOrder.append(&quot;Where A.ORGANIZATIONID IN &quot;).append(m_dmo.createInClause(allOrgs));</span>

<span class="fc" id="L131">		String strFilter = getFilterStr(activityFilter);</span>

<span class="pc bpc" id="L133" title="1 of 2 branches missed.">		if(!StringUtil.isEmpty(strFilter)) {</span>
<span class="fc" id="L134">			whereAndOrder.append(AND).append(strFilter);</span>
		}

		//filtering flex and TO request types
<span class="fc" id="L138">		checkFlexType(flexType, whereAndOrder);</span>

<span class="fc" id="L140">		String orderBy = getDefaultOrderByStatement();</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">		if(!StringUtil.isEmpty(orderBy)) {</span>
<span class="fc" id="L142">			whereAndOrder.append(&quot; &quot;).append(orderBy);</span>
		}

<span class="fc" id="L145">		return String.format( &quot;Select A.* from ( %s  FROM ACTIVITY A  inner join ACTIVITYCATEGORY  on ACTIVITYCATEGORY.ID = A.ACTIVITYCATEGORYID ) A %s &quot;,</span>
				selectFields,
				whereAndOrder );
	}

	/**
	 * This method is used for appending the where clause with the condition on FLEXTIMEOFF column
	 * Based on whether the request is for pulling flex acitivites or time off activities
	 * Possible valid values are: 1=flex, 0=TimeOff and Activity.FLEX_TIME_INVALID = do nothing
	 * @param flexType flexType
	 * @param whereAndOrder whereAndOrder
	 */
	protected void checkFlexType(int flexType, StringBuilder whereAndOrder) {
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">		if(ActivityProperties.FLEX_TIME_INVALID != flexType) {</span>
<span class="nc" id="L159">			whereAndOrder.append(AND);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">			if(ActivityProperties.TIME_OFF_TIME == flexType) {</span>
<span class="nc" id="L161">					whereAndOrder.append(&quot;NOT &quot;);</span>
			}
<span class="nc" id="L163">			whereAndOrder.append(&quot;EXISTS (SELECT 1 FROM ACTIVITYPROPERTIES WHERE FLEXTIMEOFF = 1 AND ID = A.ID ) &quot;);</span>
		}
<span class="fc" id="L165">	}</span>

	/**
	 * Similar to findOrganizationActivities, but findOrganizationActivitiesCheckCategory
	 *  also checks for the values of fields ISDELETED and ISTIMEOFFWITHALLOTMENT
	 * in the ActivityCategory table in addition to the values in Activity table.
	 * This is needed since a value of  ISTIMEOFFWITHALLOTMENT = 1 in the ActivityCategory table
	 * implies that all activities that have this category will also have a value of 1.
	 * @param orgIds orgIds
	 * @param activityFilter activityFilter
	 * @param findParentOrgs findParentOrgs
	 * @param flexType flexType
	 * @return Collection&lt;Activity&gt;
	 * @throws BbmFinderException BbmFinderException
	 */
	protected Collection&lt;Activity&gt; findOrganizationActivitiesCheckCategory( Collection&lt;ID&gt; orgIds, ActivityFilter activityFilter,
			boolean findParentOrgs, int flexType) throws BbmFinderException {
		try {
<span class="nc" id="L183">			String fullSql = getOrganizationActvitiesSql(orgIds,activityFilter,findParentOrgs, flexType);</span>
<span class="nc" id="L184">			return checkLicense(getObjectsGivenFullSqlQueryStr(fullSql));</span>
<span class="nc" id="L185">		} catch(JdmoException e) {</span>
<span class="nc" id="L186">			throw new BbmFinderException(e);</span>
		}

	}

	protected Collection&lt;Activity&gt; findOrganizationActivities( Collection&lt;ID&gt; orgIds, ActivityFilter activityFilter, boolean findParentOrgs)
		throws BbmFinderException {
<span class="fc" id="L193">		Set&lt;ID&gt; allOrgs = getAllOrgIds(orgIds, findParentOrgs);</span>
<span class="fc" id="L194">		StringBuilder strWhere = new StringBuilder(128);</span>
		try {
<span class="fc" id="L196">			strWhere.append(&quot;A.ORGANIZATIONID IN &quot;).append(m_dmo.createInClause(allOrgs));</span>
<span class="fc" id="L197">			String strFilter = getFilterStr(activityFilter);</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">			if(!StringUtil.isEmpty(strFilter)) {</span>
<span class="fc" id="L199">				strWhere.append(AND).append(strFilter);</span>
			}
<span class="fc" id="L201">			return checkLicense(getObjects(strWhere.toString(), getDefaultOrderByStatement()));</span>
<span class="nc" id="L202">		} catch(JdmoException e) {</span>
<span class="nc" id="L203">			throw new BbmFinderException(e);</span>
		}
	}

	// no parent lookup is performed here
	protected Collection&lt;Activity&gt; findOrganizationActivities( Collection&lt;ID&gt; orgIds, ActivityFilter activityFilter, boolean findParentOrgs,
			int flexType) throws BbmFinderException {
<span class="nc" id="L210">		Set&lt;ID&gt; allOrgs = getAllOrgIds(orgIds, findParentOrgs);</span>
<span class="nc" id="L211">		StringBuilder strWhere = new StringBuilder(128);</span>
		try {
<span class="nc" id="L213">			strWhere.append(&quot;A.ORGANIZATIONID IN &quot;).append(m_dmo.createInClause(allOrgs));</span>
<span class="nc" id="L214">			String strFilter = getFilterStr(activityFilter);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">			if(!StringUtil.isEmpty(strFilter)) {</span>
<span class="nc" id="L216">				strWhere.append(AND).append(strFilter);</span>
			}

			//filtering flex and TO request types
<span class="nc" id="L220">			checkFlexType(flexType, strWhere);</span>

<span class="nc" id="L222">			return checkLicense(getObjects(strWhere.toString(), getDefaultOrderByStatement()));</span>
<span class="nc" id="L223">		} catch(JdmoException e) {</span>
<span class="nc" id="L224">			throw new BbmFinderException(e);</span>
		}
	}

	protected Collection findOrganizationActivitiesByCategory(Collection organizationIdCol, ID activityCategoryId, ActivityFilter activityFilter)
		throws BbmFinderException {
<span class="nc" id="L230">		activityFilter.setActivityCategoryId(activityCategoryId, Filter.OP_EQUAL);</span>
<span class="nc" id="L231">		return findOrganizationActivities(organizationIdCol, activityFilter);</span>
	}

	protected Collection&lt;Activity&gt; findActivities(ActivityFilter activityFilter) throws BbmFinderException {
<span class="fc" id="L235">		return checkLicense(getObjects(getFilterStr(activityFilter), getDefaultOrderByStatement()));</span>
	}

	protected Collection&lt;ID&gt; findActivitiesIds(ActivityFilter activityFilter) throws BbmFinderException {
		try {
			// create the sql statement
<span class="nc" id="L241">			StringBuffer sqlQuery = new StringBuffer(128);</span>
<span class="nc" id="L242">			sqlQuery.append(&quot;SELECT &quot;).append(&quot;A.&quot;).append(activityFieldInfo.getFieldName(ActivityFieldInfo.ACTIVITY_ID));</span>
<span class="nc" id="L243">			appendFromWhereStatement(sqlQuery);</span>
<span class="nc" id="L244">			String filterStr = getFilterStr(activityFilter);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">			if(!StringUtil.isEmpty(filterStr)) {</span>
<span class="nc" id="L246">				sqlQuery.append(&quot;WHERE &quot;).append(filterStr);</span>
			}

			// fetch the data
			// fetch the data
<span class="nc" id="L251">			return fetchActivitiesIds(sqlQuery.toString());</span>
<span class="nc" id="L252">		} catch (Exception e) {</span>
<span class="nc" id="L253">			throw new BbmFinderException(e);</span>
		}
	}

	protected Collection findOrganizationActivitiesIds(ID organizationId, ActivityFilter activityFilter)
		throws BbmFinderException {
		try {
			// create the sql statement
<span class="nc" id="L261">			StringBuffer sqlQuery = new StringBuffer(128);</span>
<span class="nc" id="L262">			sqlQuery.append(&quot;SELECT &quot;).append(&quot;A.&quot;).append(activityFieldInfo.getFieldName(ActivityFieldInfo.ACTIVITY_ID));</span>
<span class="nc" id="L263">			appendFromWhereStatement(sqlQuery);</span>
			// where clause
<span class="nc" id="L265">			sqlQuery.append(&quot;WHERE &quot;);</span>
<span class="nc" id="L266">			Collection parentOrgs = DAOUtil.getParentOrganizationsCollection(organizationId, m_dmo);</span>
<span class="nc" id="L267">			parentOrgs.add(organizationId);</span>
<span class="nc" id="L268">			sqlQuery.append(&quot;A.ORGANIZATIONID IN &quot;).append(m_dmo.createInClause(parentOrgs));</span>
<span class="nc" id="L269">			String strFilter = getFilterStr(activityFilter);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">			if(!StringUtil.isEmpty(strFilter)) {</span>
<span class="nc" id="L271">				sqlQuery.append(AND).append(strFilter);</span>
			}

			// fetch the data
<span class="nc" id="L275">			return fetchActivitiesIds(sqlQuery.toString());</span>
<span class="nc" id="L276">		} catch (Exception e) {</span>
<span class="nc" id="L277">			throw new BbmFinderException(e);</span>
		}
	}

	private Collection&lt;ID&gt; fetchActivitiesIds(String sqlQuery) throws JdmoException, BbmFinderException {
		// fetch the data
<span class="nc" id="L283">		ArrayList&lt;ID&gt; activityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L284">		JdmoRowset rs = m_dmo.createRowset(sqlQuery);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">		while(rs.next()){</span>
<span class="nc" id="L286">			ID id = rs.getID(activityFieldInfo.getFieldName(ActivityFieldInfo.ACTIVITY_ID));</span>
<span class="nc" id="L287">			activityIds.add(id);</span>
<span class="nc" id="L288">		}</span>
<span class="nc" id="L289">		return checkLicense(activityIds);</span>
	}

	private String getDefaultOrderByStatement() {
<span class="fc" id="L293">		return &quot; ORDER BY A.&quot; + activityFieldInfo.getFieldName(ActivityFieldInfo.ACTIVITY_NAME) + &quot; ASC &quot;;</span>
	}

	private String getFilterStr(ActivityFilter activityFilter) {
<span class="fc bfc" id="L297" title="All 2 branches covered.">		if(activityFilter != null) {</span>
<span class="fc" id="L298">			ActivityFilterDAO activityFilterDAO = new ActivityFilterDAO(activityFilter);</span>
<span class="fc" id="L299">			String strFilter = new String(activityFilterDAO.getFilterText());</span>
<span class="fc" id="L300">			strFilter = strFilter.trim();</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">			if(strFilter.length() &gt; 0) {</span>
<span class="fc" id="L302">				return strFilter;</span>
			}
		}
<span class="fc" id="L305">		return &quot;&quot;;</span>
	}

	public Collection getAllNonSeedActivities() throws BbmFinderException {
<span class="nc" id="L309">		return getObjects(&quot; ID not like '-%'&quot;);</span>
	}

	public Collection getAllActivities() throws BbmFinderException {
<span class="nc" id="L313">		return getAllObjects();</span>
	}

	private &lt;T&gt; Collection&lt;T&gt; checkLicense(Collection&lt;T&gt; col) throws BbmFinderException {
<span class="fc" id="L317">		boolean hasOutboundLicense = ActivityMediaDAO.checkLicense(LicenseKeys.APP_MEDIA_OUTBOUND);</span>
<span class="fc" id="L318">		boolean hasMultiSideLicense = ActivityMediaDAO.checkLicense(LicenseKeys.APP_MULTIMEDIA);</span>
<span class="fc" id="L319">		boolean hasDeskTopLicense = ActivityMediaDAO.checkLicense(LicenseKeys.APP_DESKTOPMONITORING);</span>

<span class="pc bpc" id="L321" title="3 of 6 branches missed.">		if (hasOutboundLicense &amp;&amp; hasMultiSideLicense &amp;&amp; hasDeskTopLicense)</span>
<span class="nc" id="L322">			return col;</span>
		Object obj;
<span class="fc bfc" id="L324" title="All 2 branches covered.">		for (Iterator&lt;T&gt; i = col.iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L325">			obj = i.next();</span>
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">			if (!hasOutboundLicense) {</span>
<span class="nc bnc" id="L327" title="All 4 branches missed.">				if (obj instanceof ID &amp;&amp; ((ID)obj).toInt() == -4138) { //predefined outbound id</span>
<span class="nc" id="L328">					i.remove();</span>
<span class="nc" id="L329">					continue;</span>
				}
<span class="nc bnc" id="L331" title="All 4 branches missed.">				if (obj instanceof Activity &amp;&amp; ((Activity)obj).getID().toInt() == -4138) {</span>
<span class="nc" id="L332">					i.remove();</span>
<span class="nc" id="L333">					continue;</span>
				}
			}
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">			if (!hasMultiSideLicense) {</span>
<span class="nc bnc" id="L337" title="All 6 branches missed.">				if (obj instanceof ID &amp;&amp; (((ID)obj).toInt() == -4102 || ((ID)obj).toInt() == -4103)) { //predefined deferred and blended</span>
<span class="nc" id="L338">					i.remove();</span>
<span class="nc" id="L339">					continue;</span>
				}
<span class="nc bnc" id="L341" title="All 6 branches missed.">				if (obj instanceof Activity &amp;&amp; (((Activity)obj).getID().toInt() == -4102 || ((Activity)obj).getID().toInt() == -4103)) {</span>
<span class="nc" id="L342">					i.remove();</span>
<span class="nc" id="L343">					continue;</span>
				}
			}
<span class="pc bpc" id="L346" title="1 of 2 branches missed.">			if (!hasDeskTopLicense) {</span>
<span class="fc" id="L347">				ID id = null;</span>
<span class="pc bpc" id="L348" title="1 of 2 branches missed.">				if (obj instanceof ID)</span>
<span class="nc" id="L349">					id = (ID)obj;</span>
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">				else if (obj instanceof Activity)</span>
<span class="fc" id="L351">					id = ((Activity)obj).getID();</span>

				//id from -4140 to -4165 are desktop activities
<span class="pc bpc" id="L354" title="1 of 6 branches missed.">				if (id != null &amp;&amp; id.toInt() &lt;= -4140 &amp;&amp; id.toInt() &gt;= -4164) {</span>
<span class="fc" id="L355">					i.remove();</span>
				}
<span class="fc" id="L357">			}</span>
		}
<span class="fc" id="L359">		return col;</span>
	}

	protected Collection&lt;ID&gt; getDailyPoolAllotmentActivityIDs(boolean checkTimeOffWithAllotment) throws BbmFinderException {
		try {
<span class="nc" id="L364">			String sql = &quot;select A.ID from ACTIVITY A inner join ACTIVITYPROPERTIES AP on AP.ID = A.ID where AP.USEDAILYTOPOOL = 1 &quot;;</span>

<span class="nc bnc" id="L366" title="All 2 branches missed.">			if (checkTimeOffWithAllotment) {</span>
<span class="nc" id="L367">				sql += &quot; AND ISTIMEOFFWITHALLOTMENT = 1&quot;;</span>
			}
<span class="nc" id="L369">			return fetchActivitiesIds(sql);</span>
<span class="nc" id="L370">		} catch (Exception e) {</span>
<span class="nc" id="L371">			throw new BbmFinderException(e);</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>