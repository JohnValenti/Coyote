<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ForecastingAppletRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.optimization.forecasting</a> &gt; <span class="el_source">ForecastingAppletRequestHandler.java</span></div><h1>ForecastingAppletRequestHandler.java</h1><pre class="source lang-java linenums">/*
 * ï¿½ 2009-2012 Verint Systems, Inc.
 */
package com.verint.web.fs.optimization.forecasting;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.pulse.ejb.TrackingManager;
import com.bluepumpkin.ejb.bbm.pulse.model.PulseNoteBO;
import com.bluepumpkin.ejb.bbm.timeseries.ejb.TimeSeriesManager;
import com.bluepumpkin.ejb.bbm.timeseries.model.ActualTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.BacklogType;
import com.bluepumpkin.ejb.bbm.timeseries.model.ClientForecastTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastInstance;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceOperator;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.QueueList;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.core.l10n.CoreWebLogBundleKey;
import com.bluepumpkin.web.fs.Log;
import com.bluepumpkin.web.fs.keys.FsKeys;
import com.bluepumpkin.web.fs.pulse.keys.PulseKeys;
import com.verint.ejb.bbm.forecast.ForecastTraceCubeUtil;
import com.verint.ejb.bbm.forecast.ejb.ForecastTimeSeriesManager;
import com.verint.ejb.bbm.forecast.ejb.calculator.IForecastCalculator;
import com.verint.ejb.bbm.forecast.model.ForecastProfile;
import com.verint.ejb.bbm.forecast.model.ForecastProfileList;
import com.verint.ejb.bbm.forecast.model.ForecastProfileProject;
import com.verint.ejb.bbm.forecast.model.ProfileComponent.Type;
import com.verint.ejb.bbm.forecast.model.ProfileTimeSeries;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.fs.optimization.CombinedQueuePartialResponse;
import com.verint.web.fs.optimization.MultiQueuePartialResponse;
import com.verint.web.fs.optimization.OptimizationAppletRequestHandler;
import com.verint.web.fs.optimization.OptimizationKeys;
import com.verint.web.fs.optimization.SingleQueuePartialResponse;
import com.verint.web.fs.optimization.forecasting.l10n.ForecastingWebBundleKey;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.web.uif.system.RequestContext;

<span class="fc" id="L69">public class ForecastingAppletRequestHandler extends OptimizationAppletRequestHandler {</span>

<span class="fc" id="L71">	private static final Category cat = Log.initCategory(ForecastingAppletRequestHandler.class.getName());</span>

	/**
	 * Process Applet Request - to be overridden by derived classes
	 * @param context - The Request Context
	 * @param request - Map containing Applet Request Information
	 * @param response - Map containing Response to be send to Applet
	 */
	@Override
	protected void processAppletRequest(RequestContext context, Map&lt;? extends Object, ? extends Object&gt; request,
			Map&lt;Object, Object&gt; response) {
		try {
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">			if (isAppletAction(request, ForecastingKeys.PROC_GET_VOLUME_AHT_HISTORY)) {</span>
<span class="nc" id="L84">				getVolumeAndAHTHistory(context, request, response);</span>
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_OUTBOUND_HISTORY)) {</span>
<span class="nc" id="L86">				getOutboundHistory(context, request, response);</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_VOLUME_AHT_FORECAST)) {</span>
<span class="fc" id="L88">				getVolumeAndAHTForecast(context, request, response);</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_OUTBOUND_FORECAST)) {</span>
<span class="fc" id="L90">				getOutboundMediaForecast(context, request, response);</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_SINGLE_QUEUE_OUTBOUND_MEDIA_FORECAST_MODEL)) {</span>
<span class="fc" id="L92">				getOutboundMediaFullSingleQueueModel(context, request, response);</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_COMBINED_QUEUE_OUTBOUND_MEDIA_FORECAST_MODEL)) {</span>
<span class="fc" id="L94">				getOutboundMediaPartialCombinedQueueModel(context, request, response);</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_MULTI_QUEUE_OUTBOUND_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L96">				getOutboundMediaPartialMultiQueueModel(context, request, response);</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_SINGLE_QUEUE_IMMEDIATE_MEDIA_FORECAST_MODEL)) {</span>
<span class="fc" id="L98">				getImmediateMediaFullSingleQueueModel(context, request, response);</span>
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_COMBINED_QUEUE_IMMEDIATE_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L100">				getImmediateMediaPartialCombinedQueueModel(context, request, response);</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_MULTI_QUEUE_IMMEDIATE_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L102">				getImmediateMediaPartialMultiQueueModel(context, request, response);</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_SINGLE_QUEUE_DEFERRED_MEDIA_FORECAST_MODEL)) {</span>
<span class="fc" id="L104">				getDeferredMediaFullSingleQueueModel(context, request, response);</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_COMBINED_QUEUE_DEFERRED_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L106">				getDeferredMediaPartialCombinedQueueModel(context, request, response);</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_MULTI_QUEUE_DEFERRED_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L108">				getDeferredMediaPartialMultiQueueModel(context, request, response);</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_FORECAST_PROFILES)) {</span>
<span class="nc" id="L110">				getForecastProfiles(context, request, response);</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_FORECAST_PROFILE)) {</span>
<span class="nc" id="L112">				saveForecastProfile(context, request, response);</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_OUTBOUND_FORECAST_PROFILE)) {</span>
<span class="nc" id="L114">				saveOutboundForecastProfile(context, request, response);</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_PROFILE_LISTS_FOR_SAVED_PROFILE)) {</span>
<span class="nc" id="L116">				getForecastProfileListsForManuallyModifiedAbsoluteForecastProfile(context, request, response);</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_DELETE_FORECAST_PROFILE)) {</span>
<span class="nc" id="L118">				deleteForecastProfile(context, request, response);</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_PROFILE_TIMESERIES_BY_PROFILE_ID)) {</span>
<span class="nc" id="L120">				getProfileTimeSeriesForProfileID(context, request, response);</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_NOTES)) {</span>
<span class="nc" id="L122">				getNotes(context, request, response);</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_IMMEDIATE_MEDIA_FORECAST_AS_BASE)) {</span>
<span class="fc" id="L124">				saveImmediateMediaForecastAsBase(context, request, response);</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_IMMEDIATE_MEDIA_FORECAST_AS_ACTIVE)) {</span>
<span class="fc" id="L126">				saveImmediateMediaForecastAsActive(context, request, response);</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_IMMEDIATE_MEDIA_FORECAST_INSTANCE)) {</span>
<span class="nc" id="L128">				saveImmediateMediaForecastInstance(context, request, response);</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_DEFERRED_MEDIA_FORECAST_AS_BASE)) {</span>
<span class="fc" id="L130">				saveDeferredMediaForecastAsBase(context, request, response);</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_DEFERRED_MEDIA_FORECAST_AS_ACTIVE)) {</span>
<span class="fc" id="L132">				saveDeferredMediaForecastAsActive(context, request, response);</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_DEFERRED_MEDIA_FORECAST_INSTANCE)) {</span>
<span class="nc" id="L134">				saveDeferredMediaForecastInstance(context, request, response);</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_OUTBOUND_MEDIA_FORECAST_AS_BASE)) {</span>
<span class="fc" id="L136">				saveOutboundMediaForecastAsBase(context, request, response);</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_OUTBOUND_MEDIA_FORECAST_AS_ACTIVE)) {</span>
<span class="fc" id="L138">				saveOutboundMediaForecastAsActive(context, request, response);</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_OUTBOUND_MEDIA_FORECAST_INSTANCE)) {</span>
<span class="nc" id="L140">				saveOutboundMediaForecastInstance(context, request, response);</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_FORECAST_INSTANCES_FOR_SP)) {</span>
<span class="nc" id="L142">				getForecastInstancesForSP(context, request, response);</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_FORECAST_INSTANCES_FOR_SPQUEUE)) {</span>
<span class="nc" id="L144">				getForecastInstancesForSPQueue(context, request, response);</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">			} else if (isAppletAction(request, ForecastingKeys.PROC_IS_BASE_FORECAST_SET)) {</span>
<span class="fc" id="L146">				isBaseForecastSet(context, request, response);</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_SCHEDULING_PERIODS_FOR_CAMPAIGN)) {</span>
<span class="nc" id="L148">				getSchedulingPeriodsForCampaign(context, request, response);</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_FETCH_STARTING_BACKLOG_FOR_SPQUEUES)) {</span>
<span class="nc" id="L150">				fetchStartingBacklogForSPQueues(context, request, response);</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_FETCH_ACTUAL_STARTING_BACKLOG_FOR_SPQUEUES_AT_DATE)) {</span>
<span class="nc" id="L152">				fetchActualStartingBacklogForSPQueuesAtDate(context, request, response);</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_OUTBOUND_CALLS_HISTORY_LIST)) {</span>
<span class="nc" id="L154">				getHistoricalOutboundCallLists(context, request, response);</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_COMBINED_QUEUE_PROJECT_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L156">				getProjectMediaPartialCombinedQueueModel(context, request, response);</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_MULTI_QUEUE_PROJECT_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L158">				getProjectMediaPartialMultiQueueModel(context, request, response);	</span>
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">			} else if(isAppletAction(request, ForecastingKeys.PROC_GET_SINGLE_QUEUE_PROJECT_MEDIA_FORECAST_MODEL)){</span>
<span class="nc" id="L160">				getProjectMediaFullSingleQueueModel(context, request, response);</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_PROJECT_MEDIA_FORECAST_AS_ACTIVE)) {</span>
<span class="nc" id="L162">				saveProjectMediaForecast(context, request, response);</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_STRATEGIC_FORECAST)) {</span>
<span class="nc" id="L164">				getStrategicForecast(context, request, response);</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_DELETE_FORECAST_INSTANCE)) {</span>
<span class="nc" id="L166">				deleteForecastInstance(context, request, response);</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.IS_PROFILE_SECURITY_ENABLED)) {</span>
<span class="nc" id="L168">				isProfileSecurityEnabled(context, request, response);</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_DAYS_WITH_HISTORY)) {</span>
<span class="nc" id="L170">				getDaysWithHistory(context, request, response);</span>
			} else {
<span class="fc" id="L172">				super.processAppletRequest(context, request, response);</span>
			}
<span class="nc" id="L174">		} catch (Exception e) {</span>
<span class="nc" id="L175">			handleError(context, e,</span>
					CoreWebLogBundleKey.APPLET_PROCESS_REQUEST_ERROR,
					CoreWebBundleKey.APPLET_PROCESS_REQUEST_ERROR,
					CoreWebBundleKey.BUNDLE_NAME);
<span class="fc" id="L179">		}</span>
<span class="fc" id="L180">	}</span>
	private void isBaseForecastSet(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="fc" id="L184">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L185">			Collection&lt;? extends ID&gt; ids = (Collection&lt;? extends ID&gt;) request.get(ForecastingKeys.PARAM_SPQUEUE_IDS);</span>
<span class="fc" id="L186">			Map&lt;ID, Boolean&gt; retVal = ftsm.isBaseForecastSet(ids);</span>
<span class="fc" id="L187">			response.put(ForecastingKeys.RETVAL_ID_BOOLEAN_MAP, retVal);</span>
<span class="nc" id="L188">		} catch (RemoteException e) {</span>
<span class="nc" id="L189">			throw new BbmException(e);</span>
<span class="fc" id="L190">		}</span>
<span class="fc" id="L191">	}</span>

	private void getForecastInstancesForSPQueue(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L196">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L197">			ID spQueueID = (ID)request.get(ForecastingKeys.PARAM_SPQUEUE_ID);</span>
<span class="nc" id="L198">			Collection&lt;ForecastInstance&gt; retVal = ftsm.getForecastInstancesForSPQueue(spQueueID);</span>
<span class="nc" id="L199">			response.put(ForecastingKeys.RETVAL_FORECAST_INSTANCE_COL, retVal);</span>
<span class="nc" id="L200">		} catch (RemoteException e) {</span>
<span class="nc" id="L201">			throw new BbmException(e);</span>
<span class="nc" id="L202">		}</span>
<span class="nc" id="L203">	}</span>

	private void getForecastInstancesForSP(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L208">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L209">			ID spID = (ID)request.get(ForecastingKeys.PARAM_SP_ID);</span>
<span class="nc" id="L210">			Collection&lt;ForecastInstance&gt; retVal = ftsm.getForecastInstancesForSP(spID);</span>
<span class="nc" id="L211">			response.put(ForecastingKeys.RETVAL_FORECAST_INSTANCE_COL, retVal);</span>
<span class="nc" id="L212">		} catch (RemoteException e) {</span>
<span class="nc" id="L213">			throw new BbmException(e);</span>
<span class="nc" id="L214">		}</span>
<span class="nc" id="L215">	}</span>
	
	private boolean checkIfUnknownCallVolumeIncluded() throws BbmEJBCreateException, RemoteException {
<span class="fc" id="L218">		return BbmManagerFactory.getDBConfigManager().getBooleanValue(ConfigKey.FORECASTING_INCLUDEUNKNOWNCV);</span>
	}

	private boolean getUseWeightedSmoothingInForecast() throws BbmEJBCreateException, RemoteException {
<span class="fc" id="L222">		return BbmManagerFactory.getDBConfigManager().getBooleanValue(IForecastCalculator.useWeightedSmoothingConfigKey);</span>
	}

	private void isProfileSecurityEnabled(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L228">			response.put(ForecastingKeys.RETVAL, checkIfProfileSecurityEnabled());</span>
<span class="nc" id="L229">		} catch (RemoteException e) {</span>
<span class="nc" id="L230">			throw new BbmException(e);</span>
<span class="nc" id="L231">		}</span>
<span class="nc" id="L232">	}</span>
	
	private boolean checkIfProfileSecurityEnabled() throws BbmEJBCreateException, RemoteException {
<span class="nc" id="L235">		int enabled = BbmManagerFactory.getDBConfigManager().getIntValue(ConfigKey.ENABLEPROFILESECURITY);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">		return (enabled==1);</span>
	}

	private void saveImmediateMediaForecastInstance(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L242">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L243">			String name = (String) request.get(ForecastingKeys.PARAM_FORECAST_NAME);</span>
<span class="nc" id="L244">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="nc" id="L245">			Map&lt;? extends ID, ? extends TraceCube&gt; forecastDataBySPQueueID = (Map&lt;? extends ID, ? extends TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="nc" id="L246">			ftsm.saveImmediateMediaForecastInstance(name, profiles, forecastDataBySPQueueID, false);</span>
<span class="nc" id="L247">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L248">		} catch (RemoteException e) {</span>
<span class="nc" id="L249">			throw new BbmException(e);</span>
<span class="nc" id="L250">		}</span>
<span class="nc" id="L251">	}</span>

	private void saveImmediateMediaForecastAsActive(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="fc" id="L256">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L257">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>

<span class="fc" id="L259">			Map&lt;? extends ID, ? extends TraceCube&gt; forecastDataBySPQueueID = (Map&lt;? extends ID, ? extends TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
			// set profiles ID = null in order to delete the Active instance and create again. Otherwise, existing instance would be updated as active
<span class="fc" id="L261">			Collection&lt;ForecastProfile&gt; clonedProfiles = cloneProfiles(profiles);</span>
<span class="fc" id="L262">			ftsm.saveImmediateMediaForecastAsActive(clonedProfiles, forecastDataBySPQueueID);</span>
<span class="fc" id="L263">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L264">		} catch (RemoteException e) {</span>
<span class="nc" id="L265">			throw new BbmException(e);</span>
<span class="nc" id="L266">		}catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L267">			throw new BbmException(e);</span>
<span class="fc" id="L268">		}</span>
		
<span class="fc" id="L270">	}</span>

	private void saveImmediateMediaForecastAsBase(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="fc" id="L275">			String name = context.getLocalizer().i18n(ForecastingWebBundleKey.BUNDLE_NAME, ForecastingWebBundleKey.BASE_FORECAST_INSTANCE_NAME);</span>
<span class="fc" id="L276">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L277">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="fc" id="L278">			Map&lt;? extends ID, ? extends TraceCube&gt; forecastDataBySPQueueID = (Map&lt;? extends ID, ? extends TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="fc" id="L279">			ftsm.saveImmediateMediaForecastAsBase(name, profiles, forecastDataBySPQueueID);</span>
<span class="fc" id="L280">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L281">		} catch (RemoteException e) {</span>
<span class="nc" id="L282">			throw new BbmException(e);</span>
<span class="fc" id="L283">		}</span>
<span class="fc" id="L284">	}</span>

	private void saveDeferredMediaForecastAsBase(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="fc" id="L289">			String name = context.getLocalizer().i18n(ForecastingWebBundleKey.BUNDLE_NAME, ForecastingWebBundleKey.BASE_FORECAST_INSTANCE_NAME);</span>
<span class="fc" id="L290">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L291">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="fc" id="L292">			Map&lt;? extends ID, ? extends TraceCube&gt; forecastDataBySPQueueID = (Map&lt;? extends ID, ? extends TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="fc" id="L293">			Collection&lt;SPQueue&gt; spQueues = (Collection&lt;SPQueue&gt;) request.get(ForecastingKeys.PARAM_SPQUEUES);</span>
<span class="fc" id="L294">			ftsm.saveDeferredMediaForecastAsBase(name, profiles, forecastDataBySPQueueID, spQueues);</span>
<span class="fc" id="L295">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L296">		} catch (RemoteException e) {</span>
<span class="nc" id="L297">			throw new BbmException(e);</span>
<span class="fc" id="L298">		}</span>
<span class="fc" id="L299">	}</span>

	private void saveDeferredMediaForecastInstance(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L304">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L305">			String name = (String) request.get(ForecastingKeys.PARAM_FORECAST_NAME);</span>
<span class="nc" id="L306">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="nc" id="L307">			Map&lt;? extends ID, ? extends TraceCube&gt; forecastDataBySPQueueID = (Map&lt;? extends ID, ? extends TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="nc" id="L308">			Collection&lt;SPQueue&gt; spQueues = (Collection&lt;SPQueue&gt;) request.get(ForecastingKeys.PARAM_SPQUEUES);</span>
<span class="nc" id="L309">			ftsm.saveDeferredMediaForecastInstance(name, profiles, forecastDataBySPQueueID, spQueues, false);</span>
<span class="nc" id="L310">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L311">		} catch (RemoteException e) {</span>
<span class="nc" id="L312">			throw new BbmException(e);</span>
<span class="nc" id="L313">		}</span>
<span class="nc" id="L314">	}</span>

	private void saveDeferredMediaForecastAsActive(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="fc" id="L319">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L320">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="fc" id="L321">			Map&lt;? extends ID, ? extends TraceCube&gt; forecastDataBySPQueueID = (Map&lt;? extends ID, ? extends TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="fc" id="L322">			Collection&lt;SPQueue&gt; spQueues = (Collection&lt;SPQueue&gt;) request.get(ForecastingKeys.PARAM_SPQUEUES);</span>
			// set profiles ID = null in order to delete the Active instance and create again. Otherwise, existing instance would be updated as active
<span class="fc" id="L324">			Collection&lt;ForecastProfile&gt; clonedProfiles = cloneProfiles(profiles);</span>
<span class="fc" id="L325">			ftsm.saveDeferredMediaForecastAsActive(clonedProfiles, forecastDataBySPQueueID, spQueues);</span>
<span class="fc" id="L326">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L327">		} catch (RemoteException e) {</span>
<span class="nc" id="L328">			throw new BbmException(e);</span>
<span class="nc" id="L329">		}catch (CloneNotSupportedException e){</span>
<span class="nc" id="L330">			throw new BbmException(e);</span>
<span class="fc" id="L331">		}</span>
<span class="fc" id="L332">	}</span>
	
	private void saveOutboundMediaForecastAsBase(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="fc" id="L337">			String name = context.getLocalizer().i18n(ForecastingWebBundleKey.BUNDLE_NAME, ForecastingWebBundleKey.BASE_FORECAST_INSTANCE_NAME);</span>
<span class="fc" id="L338">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L339">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="fc" id="L340">			Map&lt;ID, TraceCube&gt; forecastDataBySPQueueID = (Map&lt;ID, TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="fc" id="L341">			Map&lt;ForecastProfile, Collection&lt;ForecastProfileList&gt;&gt; forecastProfileLists = (Map&lt;ForecastProfile, Collection&lt;ForecastProfileList&gt;&gt;) </span>
<span class="fc" id="L342">				request.get(ForecastingKeys.PARAM_FORECASTPROFILE_TO_FORECASTEDLISTS_MAP);</span>
<span class="fc" id="L343">			ftsm.saveOutboundMediaForecastAsBase(name, profiles,</span>
<span class="fc" id="L344">					ForecastTraceCubeUtil.convertOutboundClientForecastIntoSavableFormat(forecastDataBySPQueueID),</span>
					forecastProfileLists);
<span class="fc" id="L346">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L347">		} catch (RemoteException e) {</span>
<span class="nc" id="L348">			throw new BbmException(e);</span>
<span class="fc" id="L349">		}</span>
<span class="fc" id="L350">	}</span>

	private void saveOutboundMediaForecastInstance(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L355">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L356">			String name = (String) request.get(ForecastingKeys.PARAM_FORECAST_NAME);</span>
<span class="nc" id="L357">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="nc" id="L358">			Map&lt;ID, TraceCube&gt; forecastDataBySPQueueID = (Map&lt;ID, TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="nc" id="L359">			Map&lt;ForecastProfile, Collection&lt;ForecastProfileList&gt;&gt; forecastProfileLists = (Map&lt;ForecastProfile, Collection&lt;ForecastProfileList&gt;&gt;) </span>
<span class="nc" id="L360">			request.get(ForecastingKeys.PARAM_FORECASTPROFILE_TO_FORECASTEDLISTS_MAP);</span>
<span class="nc" id="L361">			ftsm.saveOutboundMediaForecastInstance(name, profiles,</span>
<span class="nc" id="L362">					ForecastTraceCubeUtil.convertOutboundClientForecastIntoSavableFormat(forecastDataBySPQueueID),</span>
					forecastProfileLists, false);
<span class="nc" id="L364">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L365">		} catch (RemoteException e) {</span>
<span class="nc" id="L366">			throw new BbmException(e);</span>
<span class="nc" id="L367">		}</span>
<span class="nc" id="L368">	}</span>

	private void saveOutboundMediaForecastAsActive(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="fc" id="L373">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L374">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="fc" id="L375">			Map&lt;ID, TraceCube&gt; forecastDataBySPQueueID = (Map&lt;ID, TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="fc" id="L376">			Map&lt;ForecastProfile, Collection&lt;ForecastProfileList&gt;&gt; forecastProfileLists = (Map&lt;ForecastProfile, Collection&lt;ForecastProfileList&gt;&gt;) </span>
<span class="fc" id="L377">				request.get(ForecastingKeys.PARAM_FORECASTPROFILE_TO_FORECASTEDLISTS_MAP);</span>
			// set profiles ID = null in order to delete the Active instance and create again. Otherwise, existing instance would be updated as active
<span class="fc" id="L379">			Collection&lt;ForecastProfile&gt; clonedProfiles = cloneProfiles(profiles);</span>
<span class="fc" id="L380">			ftsm.saveOutboundMediaForecastAsActive(clonedProfiles,</span>
<span class="fc" id="L381">					ForecastTraceCubeUtil.convertOutboundClientForecastIntoSavableFormat(forecastDataBySPQueueID),</span>
					forecastProfileLists);
<span class="fc" id="L383">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L384">		} catch (RemoteException e) {</span>
<span class="nc" id="L385">			throw new BbmException(e);</span>
<span class="nc" id="L386">		} catch (CloneNotSupportedException e){</span>
<span class="nc" id="L387">			throw new BbmException(e);</span>
<span class="fc" id="L388">		}</span>
<span class="fc" id="L389">	}</span>
	
	private Collection&lt;ForecastProfile&gt; cloneProfiles(Collection&lt;ForecastProfile&gt; original) throws CloneNotSupportedException {
<span class="fc" id="L392">		Collection&lt;ForecastProfile&gt; clonedProfiles = new ArrayList&lt;ForecastProfile&gt;();</span>
<span class="fc bfc" id="L393" title="All 2 branches covered.">		for (ForecastProfile profile : original) {</span>
<span class="fc" id="L394">			clonedProfiles.add(profile.cloneForecastProfileValueFields());</span>
<span class="fc" id="L395">		}</span>
<span class="fc" id="L396">		return clonedProfiles;</span>
	}

	private void getDeferredMediaFullSingleQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="fc" id="L404">			response.put(ForecastingKeys.RETVAL_DEFERRED_MEDIA_FORECAST_MODEL,</span>
<span class="fc" id="L405">					getFullVolumeAndAHTSingleQueueModelResponse( </span>
							context, request, response));
		}
<span class="nc" id="L408">		catch(Exception e){</span>
<span class="nc" id="L409">			notifyError(context, response, e);</span>
<span class="fc" id="L410">		}</span>
<span class="fc" id="L411">	}</span>

	private void getDeferredMediaPartialCombinedQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L418">			response.put(ForecastingKeys.RETVAL_DEFERRED_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L419">					getPartialCombinedQueueModelResponse(new short[]{Trace.CV, Trace.AHT, Trace.CV_VH}, context, request, response));</span>
		}
<span class="nc" id="L421">		catch(Exception e){</span>
<span class="nc" id="L422">			notifyError(context, response, e);</span>
<span class="nc" id="L423">		}</span>
<span class="nc" id="L424">	}</span>

	private void getDeferredMediaPartialMultiQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L431">			response.put(ForecastingKeys.RETVAL_DEFERRED_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L432">					getPartialMultiQueueModelResponse(new short[]{Trace.CV, Trace.AHT, Trace.CV_VH}, context, request, response));</span>
		}
<span class="nc" id="L434">		catch(Exception e){</span>
<span class="nc" id="L435">			notifyError(context, response, e);</span>
<span class="nc" id="L436">		}</span>
<span class="nc" id="L437">	}</span>
	
	private void getOutboundMediaFullSingleQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="fc" id="L444">			response.put(ForecastingKeys.RETVAL_OUTBOUND_MEDIA_FORECAST_MODEL,</span>
<span class="fc" id="L445">					doGetOutboundMediaFullSingleQueueModel(context, request, response));</span>
		}
<span class="nc" id="L447">		catch(Exception e){</span>
<span class="nc" id="L448">			notifyError(context, response, e);</span>
<span class="fc" id="L449">		}</span>
<span class="fc" id="L450">	}</span>

	private void getImmediateMediaFullSingleQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="fc" id="L457">			response.put(ForecastingKeys.RETVAL_IMMEDIATE_MEDIA_FORECAST_MODEL,</span>
<span class="fc" id="L458">					getFullVolumeAndAHTSingleQueueModelResponse(context,</span>
							request, response));
		}
<span class="nc" id="L461">		catch(Exception e){</span>
<span class="nc" id="L462">			notifyError(context, response, e);</span>
<span class="fc" id="L463">		}</span>
<span class="fc" id="L464">	}</span>

	private void getImmediateMediaPartialCombinedQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L471">			response.put(ForecastingKeys.RETVAL_IMMEDIATE_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L472">					getPartialCombinedQueueModelResponse(new short[]{Trace.CV, Trace.AHT, Trace.CV_VH}, context, request, response));</span>
		}
<span class="nc" id="L474">		catch(Exception e){</span>
<span class="nc" id="L475">			notifyError(context, response, e);</span>
<span class="nc" id="L476">		}</span>
<span class="nc" id="L477">	}</span>
	
	private void getOutboundMediaPartialCombinedQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="fc" id="L484">			response.put(ForecastingKeys.RETVAL_OUTBOUND_MEDIA_FORECAST_MODEL,</span>
<span class="fc" id="L485">					getOutboundPartialCombinedQueueModelResponse(context, request, response));</span>
		}
<span class="nc" id="L487">		catch(Exception e){</span>
<span class="nc" id="L488">			notifyError(context, response, e);</span>
<span class="fc" id="L489">		}</span>
<span class="fc" id="L490">	}</span>
	
	private void getOutboundMediaPartialMultiQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L497">			response.put(ForecastingKeys.RETVAL_OUTBOUND_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L498">					getOutboundPartialMultiQueueModelResponse(context, request, response));</span>
		}
<span class="nc" id="L500">		catch(Exception e){</span>
<span class="nc" id="L501">			notifyError(context, response, e);</span>
<span class="nc" id="L502">		}</span>
<span class="nc" id="L503">	}</span>

	private void getImmediateMediaPartialMultiQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L510">			response.put(ForecastingKeys.RETVAL_IMMEDIATE_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L511">					getPartialMultiQueueModelResponse(new short[]{Trace.CV, Trace.AHT, Trace.CV_VH}, context, request, response));</span>
		}
<span class="nc" id="L513">		catch(Exception e){</span>
<span class="nc" id="L514">			notifyError(context, response, e);</span>
<span class="nc" id="L515">		}</span>
<span class="nc" id="L516">	}</span>
	
	/**
	 * This method is only intended to be used for outbound media.
	 */
	private void getHistoricalOutboundCallLists(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L526">			ID queueId = (ID)request.get(OptimizationKeys.PARAM_QUEUE_ID);</span>
<span class="nc" id="L527">			WorkloadManager workloadManager = WfmManagerFactory.getWorkloadManager(context.isInWhatIfMode());</span>
<span class="nc" id="L528">			Collection&lt;QueueList&gt; queueHistoryList = workloadManager.getQueueHistoryList(queueId);</span>
<span class="nc" id="L529">			response.put(ForecastingKeys.RETVAL_OUTBOUND_CALLS_HISTORY_LIST, queueHistoryList);</span>
		}
<span class="nc" id="L531">		catch(Exception e){</span>
<span class="nc" id="L532">			notifyError(context, response, e);</span>
<span class="nc" id="L533">		}</span>
<span class="nc" id="L534">	}</span>

	/**
	 * This method is only intended to be used for immediate and deferred media.
	 */
	private void getVolumeAndAHTHistory(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) {
		try {
<span class="nc" id="L542">			ID campaignId = (ID)request.get(OptimizationKeys.PARAM_CAMPAIGN_ID);</span>
<span class="nc" id="L543">			Collection&lt;Queue&gt; queues = (Collection&lt;Queue&gt;)request.get(OptimizationKeys.PARAM_QUEUES);</span>
<span class="nc" id="L544">			Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="nc" id="L545">			Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>

<span class="nc" id="L547">			ForecastTimeSeriesManager manager =</span>
<span class="nc" id="L548">					WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L549">			Map&lt;ID, ActualTraceCube&gt; history = manager.getVolumeAndAhtHistory(queues, campaignId, start, end);</span>
<span class="nc" id="L550">			response.put(ForecastingKeys.RETVAL_HISTORY_TRACECUBE, history);</span>
<span class="nc" id="L551">		} catch(Exception e) {</span>
<span class="nc" id="L552">			notifyError(context, response, e);</span>
<span class="nc" id="L553">		}</span>
<span class="nc" id="L554">	}</span>
	
	/**
	 * This method is only intended to be used for outbound media.
	 */
	private void getOutboundHistory(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) {
		try {
<span class="nc" id="L562">			ID campaignId = (ID)request.get(OptimizationKeys.PARAM_CAMPAIGN_ID);</span>
<span class="nc" id="L563">			Collection&lt;Queue&gt; queues = (Collection&lt;Queue&gt;)request.get(OptimizationKeys.PARAM_QUEUES);</span>
<span class="nc" id="L564">			Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="nc" id="L565">			Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>

<span class="nc" id="L567">			ForecastTimeSeriesManager manager =</span>
<span class="nc" id="L568">					WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L569">			Map&lt;ID, ActualTraceCube&gt; history =</span>
<span class="nc" id="L570">					manager.getOutboundHistory(queues, campaignId, start, end);</span>
<span class="nc" id="L571">			response.put(ForecastingKeys.RETVAL_HISTORY_TRACECUBE, history);</span>
<span class="nc" id="L572">		} catch(Exception e) {</span>
<span class="nc" id="L573">			notifyError(context, response, e);</span>
<span class="nc" id="L574">		}</span>
<span class="nc" id="L575">	}</span>

	private void getDaysWithHistory(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) {
		try {
<span class="nc" id="L580">			Collection&lt;ID&gt; queueIds = (Collection&lt;ID&gt;)request.get(OptimizationKeys.PARAM_QUEUE_IDS);</span>
<span class="nc" id="L581">			Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="nc" id="L582">			Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>

<span class="nc" id="L584">			TimeSeriesManager manager =</span>
<span class="nc" id="L585">					WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L586">			List&lt;Date&gt; history = manager.getDaysWithHistoryForQueues(queueIds, start, end);</span>
<span class="nc" id="L587">			response.put(ForecastingKeys.RETVAL_DAYS_WITH_HISTORY, history);</span>
<span class="nc" id="L588">		} catch(Exception e) {</span>
<span class="nc" id="L589">			notifyError(context, response, e);</span>
<span class="nc" id="L590">		}</span>
<span class="nc" id="L591">	}</span>

	/**
	 * This method is only intended to be used for immediate and deferred media.
	 */
	private void getVolumeAndAHTForecast(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) {
		try {
<span class="fc" id="L599">			TimeSeriesManager timeSeriesManager = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L600">			ID campaignId = (ID)request.get(OptimizationKeys.PARAM_CAMPAIGN_ID);</span>
<span class="fc" id="L601">			ID queueId = (ID)request.get(OptimizationKeys.PARAM_QUEUE_ID);</span>
<span class="fc" id="L602">			Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="fc" id="L603">			Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>
<span class="fc" id="L604">			Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L605">			queueIds.add(queueId);</span>
<span class="fc" id="L606">			ForecastTraceCube result = null;</span>
<span class="fc" id="L607">			ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="fc" id="L608">			ForecastTraceCube meta = getMetaForecastTraceCube(new short[]{Trace.CV, Trace.AHT, Trace.CV_VH}, instanceId);</span>
<span class="fc" id="L609">			Collection forecast = timeSeriesManager.getRawMultipleQueuesTimeSeries(meta, campaignId,</span>
					queueIds, start, end);
<span class="pc bpc" id="L611" title="1 of 2 branches missed.">			if (forecast.size() == 0) {</span>
<span class="nc" id="L612">				result = createZeroForecast(queueId, start, end);</span>
			} else {
<span class="fc" id="L614">				result = (ForecastTraceCube) forecast.iterator().next();</span>
<span class="fc" id="L615">				TraceUtil.setUndefinedValuesToZero(result);</span>
			}
<span class="fc" id="L617">			response.put(ForecastingKeys.RETVAL_FORECAST_TRACECUBE, result);</span>
<span class="nc" id="L618">		} catch(Exception e){</span>
<span class="nc" id="L619">			notifyError(context, response, e);</span>
<span class="fc" id="L620">		}</span>
<span class="fc" id="L621">	}</span>
	

	
	private void getOutboundMediaForecast(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) {
		try {
<span class="fc" id="L628">			ID campaignId = (ID)request.get(OptimizationKeys.PARAM_CAMPAIGN_ID);</span>
<span class="fc" id="L629">			ID queueId = (ID)request.get(OptimizationKeys.PARAM_QUEUE_ID);</span>
<span class="fc" id="L630">			Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="fc" id="L631">			Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>
<span class="fc" id="L632">			ID forecastInstanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="fc" id="L633">			TraceCube forecast = doGetOutboundMediaForecast(queueId, campaignId, start, end, context.isInWhatIfMode(),</span>
					forecastInstanceId);
<span class="pc bpc" id="L635" title="1 of 2 branches missed.">			if (forecast == null) {</span>
<span class="nc" id="L636">				forecast = createZeroForecast(queueId, start, end);</span>
			} else {
<span class="fc" id="L638">				TraceUtil.setUndefinedValuesToZero(forecast);</span>
			}
<span class="fc" id="L640">			response.put(ForecastingKeys.RETVAL_FORECAST_TRACECUBE, forecast);</span>
<span class="nc" id="L641">		} catch(Exception e){</span>
<span class="nc" id="L642">			notifyError(context, response, e);</span>
<span class="fc" id="L643">		}</span>
<span class="fc" id="L644">	}</span>

	private ForecastTraceCube getMetaForecastTraceCube(short[] traceTypes, ID instanceId) {
<span class="pc bpc" id="L647" title="1 of 2 branches missed.">		if (instanceId != null) {</span>
<span class="nc" id="L648">			return getForecastTraceCubeWithInstance(instanceId, traceTypes);</span>
		} else {
<span class="fc" id="L650">			return new ForecastTraceCube(traceTypes);</span>
		}
	}
	
	private void getForecastProfiles(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L657">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L658">			appletResponse.put(ForecastingKeys.RETVAL_FORECAST_PROFILES, ftsm.getManuallySavedForecastProfiles());</span>
<span class="nc" id="L659">		} catch (Exception e) {</span>
<span class="nc" id="L660">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L661">		}</span>
<span class="nc" id="L662">	}</span>

	private void getProfileTimeSeriesForProfileID(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L667">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L668">			ID id = (ID) appletRequest.get(ForecastingKeys.PARAM_FORECAST_PROFILE_ID);</span>
<span class="nc" id="L669">			appletResponse.put(ForecastingKeys.RETVAL_PROFILE_TIMESERIES_COL, ftsm.getProfileTimeSeriesByProfileID(id));</span>
<span class="nc" id="L670">		} catch (Exception e) {</span>
<span class="nc" id="L671">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L672">		}</span>
<span class="nc" id="L673">	}</span>

	private void saveForecastProfile(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L678">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L679">			ForecastProfile fp = (ForecastProfile)appletRequest.get(ForecastingKeys.PARAM_FORECAST_PROFILE);</span>
<span class="nc" id="L680">			ftsm.saveForecastProfile(</span>
					fp,
<span class="nc" id="L682">					(Collection&lt;ProfileTimeSeries&gt;)appletRequest.get(ForecastingKeys.PARAM_PROFILE_TIMESERIES_COL));</span>
<span class="nc" id="L683">			appletResponse.put(ForecastingKeys.RETVAL_FORECAST_PROFILE, fp);</span>
<span class="nc" id="L684">		} catch (Exception e) {</span>
<span class="nc" id="L685">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L686">		}</span>
<span class="nc" id="L687">	}</span>
	
	/**
	 * Takes a forecast profile for outbound media and persists it to the database, including the profile's
	 * forecast profile lists and profile time series (if the profile is manually modified, otherwise it
	 * will not persist either the lists or timeseries).
	 */
	private void saveOutboundForecastProfile(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L697">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L698">			ForecastProfile fp = (ForecastProfile)appletRequest.get(ForecastingKeys.PARAM_FORECAST_PROFILE);</span>
<span class="nc" id="L699">			Collection&lt;ProfileTimeSeries&gt; pts = (Collection&lt;ProfileTimeSeries&gt;)appletRequest.get(ForecastingKeys.PARAM_PROFILE_TIMESERIES_COL);</span>
<span class="nc" id="L700">			Collection&lt;ForecastProfileList&gt; fpl = (Collection&lt;ForecastProfileList&gt;)appletRequest.get(ForecastingKeys.PARAM_FORECAST_PROFILE_LISTS);</span>
<span class="nc" id="L701">			Date spWeekStartDate = (Date)appletRequest.get(ForecastingKeys.PARAM_START_DATE);</span>
<span class="nc" id="L702">			Type type = (Type)appletRequest.get(ForecastingKeys.PARAM_PROFILE_COMPONENT_TYPE);</span>
			
<span class="nc" id="L704">			ftsm.saveOutboundForecastProfile(fp, pts, fpl, spWeekStartDate, type);</span>
<span class="nc" id="L705">			appletResponse.put(ForecastingKeys.RETVAL_FORECAST_PROFILE, fp);</span>
<span class="nc" id="L706">		} catch (Exception e) {</span>
<span class="nc" id="L707">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L708">		}</span>
<span class="nc" id="L709">	}</span>
	
	/**
	 * Returns the ForecastProfileLists that were saved as part of a manually modified ForecastProfile for outbound media.
	 * Note that ForecastProfiles that were not manually modified will not have any ForecastProfileLists: these instead are
	 * generated from history lists (QueueList) that intersect with the historical weeks of the profile.
	 */
	private void getForecastProfileListsForManuallyModifiedAbsoluteForecastProfile(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L719">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L720">			ForecastProfile fp = (ForecastProfile)appletRequest.get(ForecastingKeys.PARAM_FORECAST_PROFILE);</span>
<span class="nc" id="L721">			Date spWeekStartDate = (Date)appletRequest.get(ForecastingKeys.PARAM_START_DATE);</span>
<span class="nc" id="L722">			Map&lt;ID, Collection&lt;ForecastProfileList&gt;&gt; lists = ftsm.getForecastProfileListsByProfile(Collections.singletonList(fp));</span>
<span class="nc bnc" id="L723" title="All 4 branches missed.">			if (lists != null &amp;&amp; lists.containsKey(fp.getID())) {</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">				for (ForecastProfileList list : lists.get(fp.getID())) {	</span>
<span class="nc" id="L725">					int daysFromReferenceDate = TimeZoneUtil.numberOfDaysRound(</span>
<span class="nc" id="L726">							ForecastProfileList.getReferenceDateForManuallyModifiedProfiles().getTime(), list.getStartTime());</span>
<span class="nc" id="L727">					int lengthOfFplInDays = TimeZoneUtil.numberOfDaysRound(list.getStartTime(), list.getEndTime());</span>
					
<span class="nc" id="L729">					Calendar fplStartDate = Calendar.getInstance();</span>
<span class="nc" id="L730">					fplStartDate.setTime(spWeekStartDate);</span>
<span class="nc" id="L731">					fplStartDate.add(Calendar.DATE, daysFromReferenceDate);</span>
<span class="nc" id="L732">					Calendar fplEndDate = (Calendar)fplStartDate.clone();</span>
<span class="nc" id="L733">					fplEndDate.add(Calendar.DATE, lengthOfFplInDays);</span>
<span class="nc" id="L734">					list.setStartTime(fplStartDate.getTime());</span>
<span class="nc" id="L735">					list.setEndTime(fplEndDate.getTime());</span>
<span class="nc" id="L736">				}</span>
				
<span class="nc" id="L738">				appletResponse.put(ForecastingKeys.RETVAL_FORECAST_PROFILE_LISTS, lists.get(fp.getID()));</span>
			}
<span class="nc" id="L740">		} catch (Exception e) {</span>
<span class="nc" id="L741">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L742">		}</span>
<span class="nc" id="L743">	}</span>

	private void deleteForecastProfile(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L748">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L749">			ftsm.deleteForecastProfile((ID) appletRequest.get(ForecastingKeys.PARAM_FORECAST_PROFILE_ID));</span>
			// The ServerRequest object will indicate failure by returning a null value for the retVal, so by setting anything
			// we indicate success
<span class="nc" id="L752">			appletResponse.put(ForecastingKeys.RETVAL, &quot;success!&quot;);</span>
<span class="nc" id="L753">		} catch (Exception e) {</span>
<span class="nc" id="L754">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L755">		}</span>
<span class="nc" id="L756">	}</span>
	
	/**
	 * Get the notes for a set of queues in a given time period	 
	 */
	private void getNotes(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
<span class="nc" id="L763">		Collection&lt;ID&gt; queueIDs = (Collection&lt;ID&gt;)appletRequest.get(ForecastingKeys.PARAM_QUEUE_IDS);</span>
<span class="nc" id="L764">		Date startDate = (Date)appletRequest.get(ForecastingKeys.PARAM_START_DATE);</span>
<span class="nc" id="L765">		Date endDate = (Date)appletRequest.get(ForecastingKeys.PARAM_END_DATE);</span>

		try {
<span class="nc" id="L768">			TrackingManager tm = WfmManagerFactory.getPulseTrackingManager();</span>
<span class="nc" id="L769">			Collection&lt;PulseNoteBO&gt; notes = tm.getPulseNotes(queueIDs, startDate, endDate);</span>
<span class="nc" id="L770">			appletResponse.put(ForecastingKeys.RETVAL_NOTES, notes);</span>
		} 
<span class="nc" id="L772">		catch (Exception ex) {</span>
<span class="nc" id="L773">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L774">		}</span>
<span class="nc" id="L775">	}</span>

	private static ForecastTraceCube createZeroForecast(ID queueId, Date start, Date end) throws BbmTimeSeriesException {
<span class="nc" id="L778">		short[] types = new short[] {Trace.CV, Trace.AHT, Trace.CV_VH};</span>
<span class="nc" id="L779">		ForecastTraceCube result = new ForecastTraceCube(queueId, start, end, types);</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">		for (short type : types) {</span>
<span class="nc" id="L781">			result.initTraceValue(type, 0);</span>
		}
<span class="nc" id="L783">		return result;</span>
	}
	
	private TraceCube doGetOutboundMediaForecast(ID queueId, ID campaignId, Date startTime, Date endTime, boolean inWhatIf,
			ID forecastInstanceId) throws BbmEJBCreateException, BbmTimeSeriesException, BbmFinderException,
			RemoteException {
<span class="fc" id="L789">		TimeSeriesManager timeSeriesManager = WfmManagerFactory.getTimeSeriesManager(inWhatIf);</span>
<span class="fc" id="L790">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L791">		queueIds.add(queueId);</span>
		ForecastTraceCube result;
<span class="fc" id="L793">		ForecastTraceCube meta = getMetaForecastTraceCube(new short[] {Trace.CRATE, Trace.AHT, Trace.RPCRATE, Trace.RPCAHT},</span>
				forecastInstanceId);
<span class="fc" id="L795">		Collection forecast = timeSeriesManager.getRawMultipleQueuesTimeSeries(meta, campaignId,</span>
				queueIds, startTime, endTime);
<span class="pc bpc" id="L797" title="1 of 2 branches missed.">		if (forecast.size() == 0) {</span>
<span class="nc" id="L798">			result = createZeroForecast(queueId, startTime, endTime);</span>
		} else {
<span class="fc" id="L800">			result = (ForecastTraceCube) forecast.iterator().next();</span>
<span class="fc" id="L801">			TraceUtil.setUndefinedValuesToZero(result);</span>
		}
<span class="fc" id="L803">		return new ClientForecastTraceCube(result);</span>
	}
	
	private TraceCube getOutboundMediaCombinedForecast(List&lt;Queue&gt; queues, SchedulingPeriod sp, Campaign campaign, Media media, ID instanceId, boolean inWhatIf) 
			throws BbmEJBCreateException, BbmTimeSeriesException, BbmFinderException, RemoteException {
<span class="fc" id="L808">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(inWhatIf);</span>
<span class="fc" id="L809">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>

<span class="fc" id="L811">		ForecastTraceCube meta = getMetaForecastTraceCube(</span>
				new short[] {Trace.CRATE, Trace.AHT, Trace.RPCRATE, Trace.RPCAHT}, instanceId);
<span class="fc" id="L813">		Collection forecast = tsm.getRawCombinedQueuesTimeSeries(meta, campaign.getID(), </span>
<span class="fc" id="L814">				media.getID(), sp.getStartTime(), new Date(sp.getEndTime().getTime() -1));</span>

<span class="pc bpc" id="L816" title="1 of 2 branches missed.">		boolean noForecast = (forecast.size() == 0);</span>
<span class="fc bfc" id="L817" title="All 2 branches covered.">		for (int i = 0; i &lt;= queues.size() - 1; i++) {</span>
<span class="fc" id="L818">			queueMediaMap.put(queues.get(i).getID(), media.getID());</span>
<span class="pc bpc" id="L819" title="1 of 2 branches missed.">			if (noForecast) {</span>
<span class="nc" id="L820">				forecast.add(createZeroForecast(queues.get(i).getID(), sp.getStartTime(), new Date(sp.getEndTime().getTime() - 1)));</span>
			}
		}

<span class="fc" id="L824">		ForecastTraceCube[] constituentForecasts = (ForecastTraceCube[])forecast.toArray(new ForecastTraceCube[forecast.size()]);</span>
<span class="fc" id="L825">		ClientForecastTraceCube[] constituentClientForecasts = new ClientForecastTraceCube[constituentForecasts.length];</span>
<span class="fc bfc" id="L826" title="All 2 branches covered.">		for (int i = 0; i &lt; constituentForecasts.length; i++) {</span>
<span class="fc" id="L827">			constituentClientForecasts[i] = new ClientForecastTraceCube(constituentForecasts[i]);</span>
		}
<span class="fc" id="L829">		ClientForecastTraceCube aggregatedForecast = (ClientForecastTraceCube)TraceOperator.combineQueue(constituentClientForecasts, true, queueMediaMap);</span>
<span class="pc bpc" id="L830" title="1 of 2 branches missed.">		if (!noForecast)</span>
<span class="fc" id="L831">			TraceUtil.setUndefinedValuesToZero(aggregatedForecast);</span>
<span class="fc" id="L832">		return aggregatedForecast;</span>
	}
	
	private ForecastResponse&lt;SingleOutboundForecastQueueDTO&gt; doGetOutboundMediaFullSingleQueueModel(
			RequestContext context, Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response)
	throws Exception {
<span class="fc" id="L838">		SingleQueuePartialResponse partialResponse = createSingleQueuePartialResponse(context, request);</span>
<span class="fc" id="L839">		Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForSingleQueueModelResponse(context, partialResponse, request);</span>
<span class="fc" id="L840">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L841">		Map&lt;ID, Collection&lt;ForecastProfileList&gt;&gt; forecastedLists = ftsm.getForecastProfileListsByProfile(profiles);</span>
<span class="fc" id="L842">		ID forecastInstanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="fc" id="L843">		TraceCube forecast = doGetOutboundMediaForecast(partialResponse.getQueue().getID(), </span>
<span class="fc" id="L844">				partialResponse.getCampaign().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="fc" id="L845">				new Date(partialResponse.getSp().getEndTime().getTime() - 1), context.isInWhatIfMode(), forecastInstanceId);</span>
<span class="fc" id="L846">		SingleOutboundForecastQueueDTO queueDto = new </span>
<span class="fc" id="L847">		SingleOutboundForecastQueueDTO(partialResponse.getQueue(), </span>
<span class="fc" id="L848">				partialResponse.getSPQueue(), new ArrayList&lt;ForecastProfile&gt;(profiles), </span>
				forecast, forecastedLists);
<span class="fc" id="L850">		ForecastResponse&lt;SingleOutboundForecastQueueDTO&gt; fullResponse = </span>
<span class="fc" id="L851">			new ForecastResponse&lt;SingleOutboundForecastQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="fc" id="L852">					partialResponse.getCampaign(), </span>
<span class="fc" id="L853">					partialResponse.getSp(), queueDto, partialResponse.getHoursOfOperation(),</span>
<span class="fc" id="L854">					getUseWeightedSmoothingInForecast()</span>
			);
<span class="fc" id="L856">		return fullResponse;</span>
	}

	/**
	 * This method is only intended to be used for immediate and deferred media.
	 */
	private VolumeAndAHTForecastResponse&lt;SingleForecastQueueDTO&gt; getFullVolumeAndAHTSingleQueueModelResponse(
			RequestContext context, Map request, Map response)
	throws Exception {
<span class="fc" id="L865">		SingleQueuePartialResponse partialResponse = createSingleQueuePartialResponse(context, request);</span>
<span class="fc" id="L866">		Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForSingleQueueModelResponse(context, partialResponse,</span>
				request);
<span class="fc" id="L868">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="fc" id="L869">		ForecastTraceCube meta = getMetaForecastTraceCube(new short[] {Trace.CV, Trace.AHT, Trace.CV_VH} , instanceId);</span>
<span class="fc" id="L870">		TimeSeriesManager timeSeriesManager = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L871">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L872">		queueIds.add(partialResponse.getQueue().getID());</span>

		// Trace cubes use an inclusive end date, so subtract 1 millisecond from the sp end time.
<span class="fc" id="L875">		Date endDate = new Date(partialResponse.getSp().getEndTime().getTime() - 1);</span>
		
<span class="fc" id="L877">		Collection&lt;TraceCube&gt; forecast = timeSeriesManager.getRawMultipleQueuesTimeSeries(meta,</span>
<span class="fc" id="L878">				partialResponse.getCampaign().getID(),</span>
<span class="fc" id="L879">				queueIds, partialResponse.getSp().getStartTime(), endDate);</span>
<span class="pc bpc" id="L880" title="1 of 2 branches missed.">		ForecastTraceCube forecastCube = forecast.size() != 0 ? (ForecastTraceCube)forecast.iterator().next() : </span>
<span class="pc" id="L881">			createZeroForecast(partialResponse.getQueue().getID(), partialResponse.getSp().getStartTime(), endDate);</span>
<span class="fc" id="L882">		TraceUtil.setUndefinedValuesToZero(forecastCube);</span>
<span class="fc" id="L883">		SingleForecastQueueDTO queueDto = new </span>
<span class="fc" id="L884">		SingleForecastQueueDTO(partialResponse.getQueue(), </span>
<span class="fc" id="L885">				partialResponse.getSPQueue(), new ArrayList&lt;ForecastProfile&gt;(profiles), </span>
				forecastCube);

<span class="fc" id="L888">		VolumeAndAHTForecastResponse&lt;SingleForecastQueueDTO&gt; fullResponse = </span>
<span class="fc" id="L889">			new VolumeAndAHTForecastResponse&lt;SingleForecastQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="fc" id="L890">					partialResponse.getCampaign(), </span>
<span class="fc" id="L891">					partialResponse.getSp(), queueDto, partialResponse.getHoursOfOperation(),</span>
<span class="fc" id="L892">					checkIfUnknownCallVolumeIncluded(), getUseWeightedSmoothingInForecast()</span>
			);
<span class="fc" id="L894">		return fullResponse;</span>
	}

	protected Collection&lt;ForecastProfile&gt; getForecastProfilesForSingleQueueModelResponse(RequestContext context,
			SingleQueuePartialResponse partialResponse, Map request) throws Exception {
<span class="pc bpc" id="L899" title="1 of 2 branches missed.">		if (request.containsKey(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS)) {</span>
<span class="nc" id="L900">			return getForecastProfilesForSingleQueueModelResponseWithInstance(context, partialResponse, request);</span>
		} else {
<span class="fc" id="L902">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L903">			return ftsm.getActiveForecastProfilesBySPQueueIDs(</span>
<span class="fc" id="L904">					Collections.singleton(partialResponse.getSPQueue().getID()));</span>
		}
	}

	protected Collection&lt;ForecastProfile&gt; getForecastProfilesForCombinedQueueModelResponse(RequestContext context,
			CombinedQueuePartialResponse partialResponse, Map request, int queueIndex) throws Exception {
<span class="pc bpc" id="L910" title="1 of 2 branches missed.">		if (request.containsKey(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS)) {</span>
<span class="nc" id="L911">			return getForecastProfilesForCombinedQueueModelResponseWithInstance(context, partialResponse, request,</span>
					queueIndex);
		} else {
<span class="fc" id="L914">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L915">			return ftsm.getActiveForecastProfilesBySPQueueIDs(</span>
<span class="fc" id="L916">					Collections.singleton(partialResponse.getSPQueues().get(queueIndex).getID()));</span>
		}
	}

	protected Collection&lt;ForecastProfile&gt; getForecastProfilesForMultiQueueModelResponse(RequestContext context,
			MultiQueuePartialResponse partialResponse, Map request, int queueIndex) throws Exception {
<span class="nc bnc" id="L922" title="All 2 branches missed.">		if (request.containsKey(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS)) {</span>
<span class="nc" id="L923">			return getForecastProfilesForMultiQueueModelResponseWithInstance(context, partialResponse, request, queueIndex);</span>
		} else {
<span class="nc" id="L925">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L926">			return ftsm.getActiveForecastProfilesBySPQueueIDs(</span>
<span class="nc" id="L927">					Collections.singleton(partialResponse.getSPQueues().get(queueIndex).getID()));</span>
		}
	}

	/**
	 * This method is only intended to be used for immediate and deferred media.
	 * &lt;p&gt;
	 * &lt;em&gt;Note:&lt;/em&gt; Since this method cannot easily be refactored into a utility
	 * class this request handler is being instantiated directly and this method
	 * called directly by the {@code CalendarAllocationAppletRH} class.
	 */
	public VolumeAndAHTForecastResponse&lt;CombinedForecastQueueDTO&lt;?&gt;&gt;
		getPartialCombinedQueueModelResponse(short[] traceTypes, RequestContext context,
				Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
				throws Exception {
<span class="nc" id="L942">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L943">		CombinedQueuePartialResponse partialResponse = createCombinedQueuePartialResponse(context, request);</span>
<span class="nc" id="L944">		List&lt;SingleForecastQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleForecastQueueDTO&gt;();</span>
<span class="nc" id="L945">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L946">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L947">		ForecastTraceCube meta = getMetaForecastTraceCube(traceTypes, instanceId); //new ForecastTraceCube(new short[] {Trace.CV, Trace.AHT, Trace.CV_VH});</span>
<span class="nc" id="L948">		Collection forecast = tsm.getRawCombinedQueuesTimeSeries(meta, partialResponse.getCampaign().getID(), </span>
<span class="nc" id="L949">				partialResponse.getMedia().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L950">				new Date(partialResponse.getSp().getEndTime().getTime() -1));</span>

<span class="nc bnc" id="L952" title="All 2 branches missed.">		boolean noForecast = (forecast.size() == 0);</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">		for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {</span>
<span class="nc" id="L954">			Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForCombinedQueueModelResponse(context,</span>
					partialResponse, request, i);

<span class="nc" id="L957">			SingleForecastQueueDTO singleQueueDto = new SingleForecastQueueDTO(</span>
<span class="nc" id="L958">					partialResponse.getQueues().get(i), partialResponse.getSPQueues().get(i),</span>
					new ArrayList&lt;ForecastProfile&gt;(profiles));
<span class="nc" id="L960">			singleQueueDtos.add(singleQueueDto);</span>
<span class="nc" id="L961">			queueMediaMap.put(singleQueueDto.getQueue().getID(), partialResponse.getMedia().getID());</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">			if (noForecast) {</span>
<span class="nc" id="L963">				forecast.add(createZeroForecast(singleQueueDto.getQueue().getID(),</span>
<span class="nc" id="L964">						partialResponse.getSp().getStartTime(), new Date(partialResponse.getSp().getEndTime().getTime() - 1)));</span>
			}
		}

<span class="nc" id="L968">		TraceCube[] constituentForecasts = (TraceCube[])forecast.toArray(new TraceCube[forecast.size()]); </span>
<span class="nc" id="L969">		TraceCube aggregatedForecast = TraceOperator.combineQueue(constituentForecasts, true, queueMediaMap);</span>
<span class="nc bnc" id="L970" title="All 2 branches missed.">		if (!noForecast)</span>
<span class="nc" id="L971">			adjustVolumeAhtForecastTraceValues(aggregatedForecast);</span>
<span class="nc" id="L972">		MultiForecastQueueDTO multiQueueDto = new MultiForecastQueueDTO(singleQueueDtos, aggregatedForecast);</span>
<span class="nc" id="L973">		CombinedForecastQueueDTO queueDto = new CombinedForecastQueueDTO(partialResponse.getSPQueue(), multiQueueDto);</span>
<span class="nc" id="L974">		VolumeAndAHTForecastResponse&lt;CombinedForecastQueueDTO&lt;?&gt;&gt; fullResponse = </span>
			new VolumeAndAHTForecastResponse&lt;CombinedForecastQueueDTO&lt;?&gt;&gt;(
<span class="nc" id="L976">					partialResponse.getMedia(), </span>
<span class="nc" id="L977">					partialResponse.getCampaign(), </span>
<span class="nc" id="L978">					partialResponse.getSp(), queueDto, partialResponse.getHoursOfOperation(),</span>
<span class="nc" id="L979">					checkIfUnknownCallVolumeIncluded(), getUseWeightedSmoothingInForecast());</span>
<span class="nc" id="L980">		return fullResponse;</span>
	}

	private ForecastResponse&lt;CombinedForecastQueueDTO&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt;&gt;
	getOutboundPartialCombinedQueueModelResponse(RequestContext context, Map&lt;? extends Object, ? extends Object&gt; request,
			Map&lt;Object, Object&gt; response) throws Exception {
<span class="fc" id="L986">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="fc" id="L987">		CombinedQueuePartialResponse partialResponse = createCombinedQueuePartialResponse(context, request);</span>
<span class="fc" id="L988">		List&lt;SingleOutboundForecastQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleOutboundForecastQueueDTO&gt;();</span>
		
<span class="fc" id="L990">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="fc" id="L991">		TraceCube forecast = getOutboundMediaCombinedForecast(partialResponse.getQueues(), partialResponse.getSp(),</span>
<span class="fc" id="L992">				partialResponse.getCampaign(), partialResponse.getMedia(), instanceId, context.isInWhatIfMode());</span>
		
<span class="fc bfc" id="L994" title="All 2 branches covered.">		for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {</span>
<span class="fc" id="L995">			Collection&lt;ForecastProfile&gt; profiles =</span>
<span class="fc" id="L996">					getForecastProfilesForCombinedQueueModelResponse(context, partialResponse, request, i);</span>

<span class="fc" id="L998">			Map&lt;ID, Collection&lt;ForecastProfileList&gt;&gt; forecastedLists = ftsm.getForecastProfileListsByProfile(profiles);</span>

<span class="fc" id="L1000">			SingleOutboundForecastQueueDTO singleQueueDto = new SingleOutboundForecastQueueDTO(</span>
<span class="fc" id="L1001">					partialResponse.getQueues().get(i),</span>
<span class="fc" id="L1002">					partialResponse.getSPQueues().get(i), new ArrayList&lt;ForecastProfile&gt;(profiles),</span>
					forecastedLists);
			
<span class="fc" id="L1005">			singleQueueDtos.add(singleQueueDto);</span>
		}
<span class="fc" id="L1007">		MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt; multiQueueDto = new MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;(singleQueueDtos, forecast);</span>
<span class="fc" id="L1008">		CombinedForecastQueueDTO&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt; queueDto = </span>
<span class="fc" id="L1009">			new CombinedForecastQueueDTO&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt;(partialResponse.getSPQueue(), multiQueueDto);</span>
<span class="fc" id="L1010">		ForecastResponse&lt;CombinedForecastQueueDTO&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt;&gt; fullResponse = </span>
<span class="fc" id="L1011">			new ForecastResponse&lt;CombinedForecastQueueDTO&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt;&gt;(partialResponse.getMedia(), </span>
<span class="fc" id="L1012">					partialResponse.getCampaign(), </span>
<span class="fc" id="L1013">					partialResponse.getSp(), </span>
					queueDto, 
<span class="fc" id="L1015">					partialResponse.getHoursOfOperation(), getUseWeightedSmoothingInForecast());</span>
<span class="fc" id="L1016">		return fullResponse;</span>
	}

	/**
	 * This method is only intended to be used for immediate and deferred media.
	 */
	private VolumeAndAHTForecastResponse&lt;MultiForecastQueueDTO&gt; getPartialMultiQueueModelResponse(short[] traceTypes,
			RequestContext context, Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response)
			throws Exception {
<span class="nc" id="L1025">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1026">		MultiQueuePartialResponse partialResponse = createMultiQueuePartialResponse(context, request);</span>
<span class="nc" id="L1027">		List&lt;SingleForecastQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleForecastQueueDTO&gt;();</span>
<span class="nc" id="L1028">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L1029">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L1030">		ForecastTraceCube meta = getMetaForecastTraceCube(traceTypes, instanceId);</span>

<span class="nc" id="L1032">		Collection&lt;TraceCube&gt; forecastData = getForecastTraceDataForMultiQueuePartialResponse(partialResponse, meta, tsm);</span>

<span class="nc bnc" id="L1034" title="All 2 branches missed.">		boolean noForecast = (forecastData.size() == 0);</span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">		for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {</span>
<span class="nc" id="L1036">			Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForMultiQueueModelResponse(context,</span>
					partialResponse, request, i);
<span class="nc" id="L1038">			SingleForecastQueueDTO singleQueueDto = new SingleForecastQueueDTO(</span>
<span class="nc" id="L1039">					partialResponse.getQueues().get(i), partialResponse.getSPQueues().get(i),</span>
					new ArrayList&lt;ForecastProfile&gt;(profiles));
<span class="nc" id="L1041">			singleQueueDtos.add(singleQueueDto);</span>
<span class="nc" id="L1042">			queueMediaMap.put(singleQueueDto.getQueue().getID(), partialResponse.getMedia().getID());</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">			if (noForecast) {</span>
<span class="nc" id="L1044">				forecastData.add(createZeroForecast(singleQueueDto.getQueue().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1045">						new Date(partialResponse.getSp().getEndTime().getTime() - 1)));</span>
			}
		}
<span class="nc" id="L1048">		TraceCube[] constituentForecasts = (TraceCube[])forecastData.toArray(new TraceCube[forecastData.size()]);</span>
<span class="nc" id="L1049">		TraceCube aggregatedForecast = TraceOperator.combineQueue(constituentForecasts, true, queueMediaMap);</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">		if (!noForecast) {</span>
<span class="nc" id="L1051">			adjustVolumeAhtForecastTraceValues(aggregatedForecast);</span>
		}
<span class="nc" id="L1053">		MultiForecastQueueDTO multiQueueDto = new MultiForecastQueueDTO(singleQueueDtos, aggregatedForecast);</span>
<span class="nc" id="L1054">		VolumeAndAHTForecastResponse&lt;MultiForecastQueueDTO&gt; fullResponse = </span>
<span class="nc" id="L1055">			new VolumeAndAHTForecastResponse&lt;MultiForecastQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L1056">					partialResponse.getCampaign(), </span>
<span class="nc" id="L1057">					partialResponse.getSp(), multiQueueDto, partialResponse.getHoursOfOperation(),</span>
<span class="nc" id="L1058">					checkIfUnknownCallVolumeIncluded(), getUseWeightedSmoothingInForecast());</span>
<span class="nc" id="L1059">		return fullResponse;</span>
	}
	

	private ForecastResponse&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt; getOutboundPartialMultiQueueModelResponse(RequestContext context, 
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws Exception {
<span class="nc" id="L1065">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1066">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1067">		MultiQueuePartialResponse partialResponse = createMultiQueuePartialResponse(context, request);</span>
<span class="nc" id="L1068">		List&lt;SingleForecastQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleForecastQueueDTO&gt;();</span>
<span class="nc" id="L1069">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L1070">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L1071">		ForecastTraceCube meta = getMetaForecastTraceCube(new short[] {Trace.CRATE, Trace.AHT, Trace.RPCRATE, Trace.RPCAHT}, instanceId);</span>

<span class="nc" id="L1073">		Collection&lt;TraceCube&gt; forecastData = getForecastTraceDataForMultiQueuePartialResponse(partialResponse, meta, tsm);</span>

<span class="nc bnc" id="L1075" title="All 2 branches missed.">		boolean noForecast = (forecastData.size() == 0);</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">		for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {</span>
<span class="nc" id="L1077">			Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForMultiQueueModelResponse(context,</span>
					partialResponse, request, i);
			
<span class="nc" id="L1080">			Map&lt;ID, Collection&lt;ForecastProfileList&gt;&gt; forecastedLists = ftsm.getForecastProfileListsByProfile(profiles);</span>

<span class="nc" id="L1082">			SingleOutboundForecastQueueDTO singleQueueDto = new SingleOutboundForecastQueueDTO(partialResponse.getQueues().get(i), </span>
<span class="nc" id="L1083">					partialResponse.getSPQueues().get(i), new ArrayList&lt;ForecastProfile&gt;(profiles), </span>
					forecastedLists);
			
<span class="nc" id="L1086">			singleQueueDtos.add(singleQueueDto);</span>
<span class="nc" id="L1087">			queueMediaMap.put(singleQueueDto.getQueue().getID(), partialResponse.getMedia().getID());</span>
<span class="nc bnc" id="L1088" title="All 2 branches missed.">			if (noForecast) {</span>
<span class="nc" id="L1089">				forecastData.add(createZeroForecast(singleQueueDto.getQueue().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1090">						new Date(partialResponse.getSp().getEndTime().getTime() - 1)));</span>
			}
		}
		
<span class="nc" id="L1094">		ForecastTraceCube[] constituentForecasts = (ForecastTraceCube[])forecastData.toArray(new ForecastTraceCube[forecastData.size()]);</span>
<span class="nc" id="L1095">		ClientForecastTraceCube[] constituentClientForecasts = new ClientForecastTraceCube[constituentForecasts.length];</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">		for (int i = 0; i &lt; constituentForecasts.length; i++) {</span>
<span class="nc" id="L1097">			constituentClientForecasts[i] = new ClientForecastTraceCube(constituentForecasts[i]);</span>
		}
<span class="nc" id="L1099">		ClientForecastTraceCube aggregatedForecast = (ClientForecastTraceCube)TraceOperator.combineQueue(constituentClientForecasts, true, queueMediaMap);</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">		if (!noForecast) {</span>
<span class="nc" id="L1101">			TraceUtil.setUndefinedValuesToZero(aggregatedForecast);</span>
		}

<span class="nc" id="L1104">		MultiForecastQueueDTO multiQueueDto = new MultiForecastQueueDTO(singleQueueDtos, aggregatedForecast);</span>
<span class="nc" id="L1105">		ForecastResponse&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt; fullResponse = </span>
<span class="nc" id="L1106">			new ForecastResponse&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L1107">					partialResponse.getCampaign(), partialResponse.getSp(), multiQueueDto,</span>
<span class="nc" id="L1108">					partialResponse.getHoursOfOperation(), getUseWeightedSmoothingInForecast());</span>
<span class="nc" id="L1109">		return fullResponse;</span>
	}

	private void getSchedulingPeriodsForCampaign(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L1115">			CampaignManager cm = WfmManagerFactory.getCampaignManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1116">			Campaign campaign = (Campaign)appletRequest.get(ForecastingKeys.PARAM_CAMPAIGN);</span>
<span class="nc" id="L1117">			appletResponse.put(ForecastingKeys.RETVAL, cm.getSchedulingPeriods(campaign));</span>
<span class="nc" id="L1118">		} catch (Exception ex) {</span>
<span class="nc" id="L1119">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1120">		}</span>
<span class="nc" id="L1121">	}</span>

	/**
	 * Returns a map of SPQueues with integer values specifying the starting backlog for those SPQueues.
	 * The starting backlog is determined by the target Scheduling Period that is handed in to this method.
	 * The starting backlog will either be pulled from the PREDICTEDTIMESERIES table (for forecasted backlog) or
	 * the QUEUEHISTORYTIMESERIES table (for Actual backlog).  The starting backlog will be pulled from the
	 * latest backlog value from the target SP matching the work queue from the input spQueue.  However, we will
	 * only look back 24 hours from the end date of the target SP (and queue) to find an ending backlog value.
	 * If no backlog is present during the last 24 hours of the SP then the starting backlog will be set as 
	 * 0 for that spQueue.  If the targetSP does not have a matching work queue, the starting backlog for the
	 * spQueue will be set to 0.
	 * @return Map&lt;SPQueue, Integer&gt; - The SPQueue key is from the collection of spQueues handed into the method.
	 * The Integer value represents the starting backlog for that spQueue, determined by looking at the forecasted
	 * or actual ending backlog values of the targetSP for the matching work queues.
	 */
	private void fetchStartingBacklogForSPQueues(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) throws BbmException {
		try {
<span class="nc" id="L1140">			TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>

<span class="nc" id="L1142">			Collection&lt;SPQueue&gt; spQueues = (Collection&lt;SPQueue&gt;)appletRequest.get(ForecastingKeys.PARAM_SPQUEUES);</span>
<span class="nc" id="L1143">			SchedulingPeriod targetSP = (SchedulingPeriod)appletRequest.get(ForecastingKeys.PARAM_SP);</span>
<span class="nc" id="L1144">			BacklogType backlogType = (BacklogType)appletRequest.get(ForecastingKeys.PARAM_BACKLOG_TYPE);</span>

<span class="nc" id="L1146">			appletResponse.put(ForecastingKeys.RETVAL,</span>
<span class="nc" id="L1147">					tsm.fetchStartingBacklogForSPQueues(spQueues, targetSP, backlogType));</span>
<span class="nc" id="L1148">		} catch (RemoteException ex) {</span>
<span class="nc" id="L1149">			throw new BbmException(ex);</span>
<span class="nc" id="L1150">		}</span>
<span class="nc" id="L1151">	}</span>

	private void fetchActualStartingBacklogForSPQueuesAtDate(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) throws BbmException {
		try {
<span class="nc" id="L1156">			TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>

<span class="nc" id="L1158">			Collection&lt;SPQueue&gt; spQueues = (Collection&lt;SPQueue&gt;)appletRequest.get(ForecastingKeys.PARAM_SPQUEUES);</span>
<span class="nc" id="L1159">			ID campaignId = (ID)appletRequest.get(ForecastingKeys.PARAM_CAMPAIGN_ID);</span>
<span class="nc" id="L1160">			Date date = (Date)appletRequest.get(ForecastingKeys.PARAM_START_DATE);</span>

<span class="nc" id="L1162">			appletResponse.put(ForecastingKeys.RETVAL,</span>
<span class="nc" id="L1163">					tsm.fetchActualStartingBacklogForSPQueuesAtDate(spQueues, campaignId, date));</span>
<span class="nc" id="L1164">		} catch (RemoteException ex) {</span>
<span class="nc" id="L1165">			throw new BbmException(ex);</span>
<span class="nc" id="L1166">		}</span>
<span class="nc" id="L1167">	}</span>

	// with forecast instance
	private Collection&lt;ForecastProfile&gt; getForecastProfilesForSingleQueueModelResponseWithInstance(RequestContext context,
			SingleQueuePartialResponse partialResponse, Map request) throws Exception {
<span class="nc" id="L1172">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1173">		ID forecastinstanceID = null;</span>
<span class="nc" id="L1174">		forecastinstanceID = (ID) request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>

<span class="nc bnc" id="L1176" title="All 2 branches missed.">		if (forecastinstanceID != null) {</span>
<span class="nc" id="L1177">			return ftsm.getForecastProfilesByForecastInstanceIDAndSPQueueIDs</span>
<span class="nc" id="L1178">			(forecastinstanceID, Collections.singleton(partialResponse.getSPQueue().getID()));</span>
		} else {
<span class="nc" id="L1180">			return getForecastProfilesForSingleQueueModelResponse(context, partialResponse, request);</span>
		}
	}

	private Collection&lt;ForecastProfile&gt; getForecastProfilesForCombinedQueueModelResponseWithInstance(RequestContext context,
			CombinedQueuePartialResponse partialResponse, Map request, int i) throws Exception {
<span class="nc" id="L1186">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1187">		ID forecastinstanceID = null;</span>
<span class="nc" id="L1188">		forecastinstanceID = (ID) request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc bnc" id="L1189" title="All 2 branches missed.">		if (forecastinstanceID != null) {</span>
<span class="nc" id="L1190">			return ftsm.getForecastProfilesByForecastInstanceIDAndSPQueueIDs(forecastinstanceID,</span>
<span class="nc" id="L1191">					Collections.singleton(partialResponse.getSPQueues().get(i).getID()));</span>
		} else {
<span class="nc" id="L1193">			return getForecastProfilesForCombinedQueueModelResponseWithInstance(context, partialResponse, request, i);</span>
		}
	}

	private Collection&lt;ForecastProfile&gt; getForecastProfilesForMultiQueueModelResponseWithInstance(RequestContext context,
			MultiQueuePartialResponse partialResponse, Map request, int i) throws Exception {
<span class="nc" id="L1199">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1200">		ID forecastinstanceID = null;</span>
<span class="nc" id="L1201">		forecastinstanceID = (ID) request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">		if(forecastinstanceID != null) {</span>
<span class="nc" id="L1203">			return ftsm.getForecastProfilesByForecastInstanceIDAndSPQueueIDs(forecastinstanceID,</span>
<span class="nc" id="L1204">					Collections.singleton(partialResponse.getSPQueues().get(i).getID()));</span>
		}
		else {
<span class="nc" id="L1207">			return getForecastProfilesForMultiQueueModelResponseWithInstance(context, partialResponse, request, i);</span>
		}
	}


	private ForecastTraceCube getForecastTraceCubeWithInstance(ID instanceId, short[] traceTypes) {
<span class="nc" id="L1213">		ForecastTraceCube meta =  new ForecastTraceCube(traceTypes);</span>
<span class="nc" id="L1214">		String instanceIDString = instanceId.toString();</span>
<span class="nc" id="L1215">		meta.setForecastInstanceID(instanceIDString);</span>
<span class="nc" id="L1216">		return meta;</span>

	}
	
	protected void deleteForecastInstance(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L1223">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1224">			ID  instanceID = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L1225">			Collection&lt;ID&gt; spQueueIDs = (Collection&lt;ID&gt;) request.get(ForecastingKeys.PARAM_SPQUEUE_IDS);</span>
<span class="nc" id="L1226">			ftsm.deleteForecastInstance(instanceID, spQueueIDs);</span>

<span class="nc" id="L1228">			response.put(ForecastingKeys.RETVAL, &quot;Success!&quot;);</span>
<span class="nc" id="L1229">		} catch (Exception e) {</span>
<span class="nc" id="L1230">			throw new BbmException(e);</span>
<span class="nc" id="L1231">		}</span>
<span class="nc" id="L1232">	}</span>

	private ProjectForecastingResponse&lt;SingleProjectForecastQueueDTO&gt; getFullSingleProjectQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response)
	throws Exception {
		
<span class="nc" id="L1238">		Collection &lt;ForecastProfileProject&gt; lstProjectProfiles = null;</span>
		
<span class="nc" id="L1240">		SingleQueuePartialResponse partialResponse = createSingleQueuePartialResponse(context, request);</span>
<span class="nc" id="L1241">		Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForSingleQueueModelResponse(context, partialResponse, request);</span>
<span class="nc" id="L1242">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L1243">		ForecastTraceCube meta = getMetaForecastTraceCube(new short[] {Trace.CV, Trace.AHT, Trace.CV_VH}, instanceId); //new ForecastTraceCube(new short[] {Trace.CV, Trace.AHT, Trace.CV_VH});</span>
<span class="nc" id="L1244">		TimeSeriesManager timeSeriesManager = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
		
<span class="nc" id="L1246">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L1247">		queueIds.add(partialResponse.getQueue().getID());</span>
<span class="nc" id="L1248">		Collection&lt;ID&gt; spQueueIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L1249">		spQueueIds.add(partialResponse.getSPQueue().getID());</span>
<span class="nc" id="L1250">		Collection forecast = timeSeriesManager.getRawMultipleQueuesTimeSeries(meta, partialResponse.getCampaign().getID(),</span>
<span class="nc" id="L1251">				queueIds, partialResponse.getSp().getStartTime(), new Date(partialResponse.getSp().getEndTime().getTime() - 1));</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">		ForecastTraceCube forecastCube = forecast.size() != 0 ? (ForecastTraceCube)forecast.iterator().next() : </span>
<span class="nc" id="L1253">			createZeroForecast(partialResponse.getQueue().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1254">					new Date(partialResponse.getSp().getEndTime().getTime() - 1));</span>
<span class="nc" id="L1255">		TraceUtil.setUndefinedValuesToZero(forecastCube);</span>
		
<span class="nc" id="L1257">		lstProjectProfiles = this.getProjectProfiles(context,spQueueIds);</span>

<span class="nc" id="L1259">		SingleProjectForecastQueueDTO queueDto = new SingleProjectForecastQueueDTO(partialResponse.getQueue(), </span>
<span class="nc" id="L1260">				partialResponse.getSPQueue(), new ArrayList&lt;ForecastProfile&gt;(profiles), new ArrayList&lt;ForecastProfileProject&gt;(lstProjectProfiles), forecastCube);</span>

		
<span class="nc" id="L1263">		ProjectForecastingResponse&lt;SingleProjectForecastQueueDTO&gt; fullResponse = </span>
<span class="nc" id="L1264">			new ProjectForecastingResponse&lt;SingleProjectForecastQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L1265">					partialResponse.getCampaign(), </span>
<span class="nc" id="L1266">					partialResponse.getSp(), queueDto, partialResponse.getHoursOfOperation(),</span>
<span class="nc" id="L1267">					checkIfUnknownCallVolumeIncluded(), getUseWeightedSmoothingInForecast()</span>
			);
<span class="nc" id="L1269">		return fullResponse;</span>
	}
	
	private Collection &lt;ForecastProfileProject&gt; getProjectProfiles(RequestContext context,Collection&lt;ID&gt; spQueueIDs) throws Exception{
		
<span class="nc" id="L1274">		Collection&lt;ForecastProfileProject&gt; lstProjectProfiles = null;</span>
<span class="nc" id="L1275">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
		
<span class="nc" id="L1277">		lstProjectProfiles = ftsm.getActiveProjects(spQueueIDs);</span>
		
<span class="nc" id="L1279">		return lstProjectProfiles;</span>
	}
	private void getProjectMediaFullSingleQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L1286">			response.put(ForecastingKeys.RETVAL_PROJECT_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L1287">					getFullSingleProjectQueueModel(context, request, response));</span>
		}
<span class="nc" id="L1289">		catch(Exception e){</span>
<span class="nc" id="L1290">			notifyError(context, response, e);</span>
<span class="nc" id="L1291">		}</span>
<span class="nc" id="L1292">	}</span>
	/**
	 * Insert the strategic forecast for the specified queue ID and time interval into
	 * the response map.
	 * 
	 * @param context
	 * @param request
	 * @param response
	 */
	private void getStrategicForecast(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) {
		try {
<span class="nc" id="L1304">			ID queueId = (ID)request.get(OptimizationKeys.PARAM_QUEUE_ID);</span>
<span class="nc" id="L1305">			Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="nc" id="L1306">			Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>

<span class="nc" id="L1308">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1309">			response.put(ForecastingKeys.RETVAL_STRATEGIC_FORECAST, ftsm.getStrategicForecast(queueId, start, end));</span>
<span class="nc" id="L1310">		} catch (Exception e) {</span>
<span class="nc" id="L1311">			notifyError(context, response, e);</span>
<span class="nc" id="L1312">		}</span>
<span class="nc" id="L1313">	}</span>
	private ProjectForecastingResponse&lt;MultiProjectForecastQueueDTO&gt; getPartialMultiProjectQueueModelResponse(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response)
	throws Exception {
		
<span class="nc" id="L1318">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L1319">		MultiQueuePartialResponse partialResponse = createMultiQueuePartialResponse(context, request);</span>
<span class="nc" id="L1320">		List&lt;SingleProjectForecastQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleProjectForecastQueueDTO&gt;();</span>
<span class="nc" id="L1321">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1322">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L1323">		ForecastTraceCube meta = getMetaForecastTraceCube(new short[] {Trace.CV, Trace.AHT, Trace.CV_VH}, instanceId);</span>

<span class="nc" id="L1325">		Collection forecast = tsm.getRawCombinedQueuesTimeSeries(meta, partialResponse.getCampaign().getID(),</span>
<span class="nc" id="L1326">				partialResponse.getMedia().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1327">				partialResponse.getSp().getEndTime());</span>
		
<span class="nc" id="L1329">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">		boolean noForecast = (forecast.size() == 0);</span>
		
<span class="nc bnc" id="L1332" title="All 2 branches missed.">		for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {</span>
<span class="nc" id="L1333">			queueIds.add(partialResponse.getSPQueues().get(i).getID());</span>
<span class="nc" id="L1334">			Collection&lt;ForecastProfileProject&gt; lstProjectprofiles = this.getProjectProfiles(context,queueIds);</span>
<span class="nc" id="L1335">			Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForMultiQueueModelResponse(context,</span>
					partialResponse, request, i);
<span class="nc" id="L1337">			SingleProjectForecastQueueDTO singleQueueDto = new SingleProjectForecastQueueDTO(</span>
<span class="nc" id="L1338">					partialResponse.getQueues().get(i), partialResponse.getSPQueues().get(i),</span>
					new ArrayList&lt;ForecastProfile&gt;(profiles),new ArrayList&lt;ForecastProfileProject&gt;(lstProjectprofiles),null);
<span class="nc" id="L1340">			singleQueueDtos.add(singleQueueDto);</span>
<span class="nc" id="L1341">			queueMediaMap.put(singleQueueDto.getQueue().getID(), partialResponse.getMedia().getID());</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">			if (noForecast) {</span>
<span class="nc" id="L1343">				forecast.add(createZeroForecast(singleQueueDto.getQueue().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1344">						new Date(partialResponse.getSp().getEndTime().getTime() - 1)));</span>
			}
<span class="nc" id="L1346">			queueIds.remove(partialResponse.getSPQueues().get(i).getID());</span>
		}

<span class="nc" id="L1349">		MultiProjectForecastQueueDTO multiQueueDto = new MultiProjectForecastQueueDTO(singleQueueDtos);</span>
<span class="nc" id="L1350">		ProjectForecastingResponse&lt;MultiProjectForecastQueueDTO&gt; fullResponse = </span>
<span class="nc" id="L1351">			new ProjectForecastingResponse&lt;MultiProjectForecastQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L1352">					partialResponse.getCampaign(), </span>
<span class="nc" id="L1353">					partialResponse.getSp(), multiQueueDto, partialResponse.getHoursOfOperation(),</span>
<span class="nc" id="L1354">					checkIfUnknownCallVolumeIncluded(), getUseWeightedSmoothingInForecast());</span>
<span class="nc" id="L1355">		return fullResponse;</span>
	}
	private void getProjectMediaPartialMultiQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L1362">			response.put(ForecastingKeys.RETVAL_PROJECT_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L1363">					getPartialMultiProjectQueueModelResponse(context, request, response));</span>
		}
<span class="nc" id="L1365">		catch(Exception e){</span>
<span class="nc" id="L1366">			notifyError(context, response, e);</span>
<span class="nc" id="L1367">		}</span>
<span class="nc" id="L1368">	}</span>
	private ProjectForecastingResponse&lt;CombinedProjectForecastQueueDTO&gt; getPartialCombinedProjectQueueModelResponse(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	throws Exception { 
		
<span class="nc" id="L1373">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L1374">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1375">		CombinedQueuePartialResponse partialResponse = createCombinedQueuePartialResponse(context, request);</span>
<span class="nc" id="L1376">		List&lt;SingleProjectForecastQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleProjectForecastQueueDTO&gt;();</span>
<span class="nc" id="L1377">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
		
<span class="nc" id="L1379">		ForecastTraceCube meta = getMetaForecastTraceCube(new short[] {Trace.CV, Trace.AHT, Trace.CV_VH}, instanceId);		</span>
<span class="nc" id="L1380">		Collection forecast = tsm.getRawCombinedQueuesTimeSeries(meta, partialResponse.getCampaign().getID(),</span>
<span class="nc" id="L1381">			partialResponse.getMedia().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1382">			new Date(partialResponse.getSp().getEndTime().getTime() - 1));</span>

<span class="nc bnc" id="L1384" title="All 2 branches missed.">		boolean noForecast = (forecast.size() == 0);</span>
<span class="nc" id="L1385">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
		
<span class="nc bnc" id="L1387" title="All 2 branches missed.">		for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {   </span>
<span class="nc" id="L1388">			queueIds.add(partialResponse.getSPQueues().get(i).getID());</span>
<span class="nc" id="L1389">			Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForCombinedQueueModelResponse(context,</span>
					partialResponse, request, i);
<span class="nc" id="L1391">			Collection&lt;ForecastProfileProject&gt; lstProjectprofiles = this.getProjectProfiles(context,queueIds);</span>
<span class="nc" id="L1392">			SingleProjectForecastQueueDTO singleQueueDto = new SingleProjectForecastQueueDTO(</span>
<span class="nc" id="L1393">					partialResponse.getQueues().get(i), partialResponse.getSPQueues().get(i),</span>
					new ArrayList&lt;ForecastProfile&gt;(profiles),new ArrayList&lt;ForecastProfileProject&gt;(lstProjectprofiles),null);
<span class="nc" id="L1395">			singleQueueDtos.add(singleQueueDto);</span>
<span class="nc" id="L1396">			queueMediaMap.put(singleQueueDto.getQueue().getID(), partialResponse.getMedia().getID());</span>
<span class="nc bnc" id="L1397" title="All 2 branches missed.">			if (noForecast) {</span>
<span class="nc" id="L1398">				forecast.add(createZeroForecast(singleQueueDto.getQueue().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1399">						new Date(partialResponse.getSp().getEndTime().getTime() - 1)));</span>
			}
<span class="nc" id="L1401">			queueIds.remove(partialResponse.getSPQueues().get(i).getID());</span>
		}

<span class="nc" id="L1404">		TraceCube[] constituentForecasts = (TraceCube[])forecast.toArray(new TraceCube[forecast.size()]); </span>
<span class="nc" id="L1405">		TraceCube aggretagedForecast = TraceOperator.combineQueue(constituentForecasts, true, queueMediaMap);</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">		if (!noForecast){}</span>
<span class="nc" id="L1407">			TraceUtil.setUndefinedValuesToZero(aggretagedForecast);</span>
			
<span class="nc" id="L1409">		MultiProjectForecastQueueDTO multiQueueDto = new MultiProjectForecastQueueDTO(singleQueueDtos);</span>
<span class="nc" id="L1410">		CombinedProjectForecastQueueDTO queueDto = new CombinedProjectForecastQueueDTO(partialResponse.getSPQueue(), multiQueueDto);</span>
		
<span class="nc" id="L1412">		ProjectForecastingResponse&lt;CombinedProjectForecastQueueDTO&gt; fullResponse = new ProjectForecastingResponse&lt;CombinedProjectForecastQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L1413">					partialResponse.getCampaign(), </span>
<span class="nc" id="L1414">					partialResponse.getSp(), queueDto, partialResponse.getHoursOfOperation(),</span>
<span class="nc" id="L1415">					checkIfUnknownCallVolumeIncluded(), getUseWeightedSmoothingInForecast());</span>
<span class="nc" id="L1416">		return fullResponse;</span>
	}

	private void getProjectMediaPartialCombinedQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L1424">			response.put(ForecastingKeys.RETVAL_PROJECT_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L1425">					getPartialCombinedProjectQueueModelResponse(context, request, response));</span>
		}
<span class="nc" id="L1427">		catch(Exception e){</span>
<span class="nc" id="L1428">			notifyError(context, response, e);</span>
<span class="nc" id="L1429">		}</span>
<span class="nc" id="L1430">	}</span>
	
	private void saveProjectMediaForecast(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L1435">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1436">			Map&lt;ForecastProfile, Collection&lt;ForecastProfileProject&gt;&gt; projectsByForecastProfile =</span>
<span class="nc" id="L1437">				(Map&lt;ForecastProfile, Collection&lt;ForecastProfileProject&gt;&gt;) request.get(ForecastingKeys.PARAM_PROJECTS_BY_FORECAST_PROFILE);</span>
<span class="nc" id="L1438">			ftsm.saveProjectMediaForecastAsActive(projectsByForecastProfile);</span>

<span class="nc" id="L1440">			response.put(ForecastingKeys.RETVAL, &quot;Success!&quot;);</span>
<span class="nc" id="L1441">		} catch (RemoteException e) {</span>
<span class="nc" id="L1442">			throw new BbmException(e);</span>
<span class="nc" id="L1443">		}</span>
<span class="nc" id="L1444">	}</span>
	
    /**
     * Returns true if the monthly forecast / work rules license is present.
     */
	private Boolean checkMonthlyLicense(RequestContext context, Map appletResponse) {
<span class="fc" id="L1450">    	Boolean hasLicense = null;</span>
        try 
		{
<span class="fc" id="L1453">        	String licenseKey = LicenseKeys.APP_MONTHLY_FORECAST_AND_RULES;</span>
<span class="fc" id="L1454">           	hasLicense = new Boolean(CoreManagerFactory.getLicenseManager().isLicensed(licenseKey));</span>
		} 
<span class="nc" id="L1456">        catch (Exception ex) </span>
		{
<span class="nc" id="L1458">        	notifyError(context, appletResponse, ex);</span>
<span class="fc" id="L1459">        }</span>
<span class="fc" id="L1460">        return hasLicense;</span>
    }
	
	/**
	 * We need to add the check for the monthly license as part of the Forecasting Applet's init data.
	 * checkMonthlyLicense() will get called and the result from that method will be put in the
	 * Forecasting Applet's cached applet init info.
	 */
	protected Object getAppletInitData(RequestContext context, Map appletRequest,
			Map appletResponse, String command) {
		try {
<span class="fc bfc" id="L1471" title="All 2 branches covered.">			if (ForecastingKeys.PROC_CHECK_MONTHLY_LICENSE.equals(command)) {</span>
<span class="fc" id="L1472">				return checkMonthlyLicense(context, appletRequest);</span>
			}
<span class="pc bpc" id="L1474" title="1 of 2 branches missed.">			else if (PulseKeys.FORECAST_ID.equals(command)) {</span>
<span class="fc" id="L1475">				String forecastIDString = (String)(context.getAttribute(RequestContext.ONE_TIME_USE_SESSION_SCOPE, &quot;FORECAST_PROFILE_ID_KEY&quot;)); //tbd PageKeys.FORECAST_PROFILE_ID_KEY</span>
<span class="pc bpc" id="L1476" title="3 of 4 branches missed.">				ID id = (forecastIDString==null||forecastIDString.isEmpty()) ? null : new ID(forecastIDString);</span>
<span class="fc" id="L1477">				return id;</span>
			}
		}
<span class="nc" id="L1480">		catch (Exception ex) {</span>
<span class="nc" id="L1481">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1482">		}</span>
<span class="nc" id="L1483">		return null;</span>
	}

	/**
	 * Retrieves the forecast trace data for each queue in the partialResponse object.  The trace data returned will
	 * only contain data for the trace types that are specified in the given metaTraceCube.  The date range of the trace
	 * data returned will span the start/end dates of the Scheduling Period defined in the partialResponse.
	 */
	private static Collection&lt;TraceCube&gt; getForecastTraceDataForMultiQueuePartialResponse(MultiQueuePartialResponse partialResponse,
			ForecastTraceCube metaTraceCube, TimeSeriesManager tsm) throws RemoteException, BbmFinderException {
<span class="nc" id="L1493">		Collection&lt;ID&gt; queueIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L1494" title="All 2 branches missed.">		for (Queue queue : partialResponse.getQueues()) {</span>
<span class="nc" id="L1495">			queueIDs.add(queue.getID());</span>
<span class="nc" id="L1496">		}</span>
<span class="nc" id="L1497">		Collection&lt;TraceCube&gt; forecastData = tsm.getRawMultipleQueuesTimeSeries(metaTraceCube,</span>
<span class="nc" id="L1498">				partialResponse.getCampaign().getID(), queueIDs, partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1499">				new Date(partialResponse.getSp().getEndTime().getTime() - 1));</span>

<span class="nc" id="L1501">		return forecastData;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>