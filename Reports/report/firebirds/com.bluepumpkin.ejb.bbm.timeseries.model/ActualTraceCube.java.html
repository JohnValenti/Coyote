<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActualTraceCube.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.timeseries.model</a> &gt; <span class="el_source">ActualTraceCube.java</span></div><h1>ActualTraceCube.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.timeseries.model;

import java.util.Date;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceUtil;
import com.bluepumpkin.ejb.bbm.workload.model.Media;

/**
 * Title: Blue Pumpkin Software Basic Business Model Description:
 * ActualTraceCube object, associated with Actual Traces Copyright: Copyright
 * (c) 2002 Company: Blue Pumpkin Software, inc
 *
 * @author Sheng Song
 * @version 2.0
 */

public class ActualTraceCube extends TraceCube {
	// static final long serialVersionUID = -5971257797245447869L;

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
	// As of August 2010, every defined trace type except DEADLINE_TIME
	// can be derived from actual values.
<span class="fc" id="L30">	public static final short[] TYPES = { Trace.CV, Trace.AHT, Trace.PCA,</span>
			Trace.ASA, Trace.ABANDONMENT, Trace.BACKLOG, Trace.STAFFING,
			Trace.OCCUPANCY, Trace.FTE, Trace.DIALS, Trace.CONNECTS,
			Trace.CRATE, Trace.RPC, Trace.RPCRATE, Trace.RPCAHT, Trace.VH,
			Trace.VAR, Trace.CV_VH };

	// Default constructor
<span class="fc" id="L37">	public ActualTraceCube() {</span>
<span class="fc" id="L38">	}</span>

	public ActualTraceCube(short[] types) {
<span class="fc" id="L41">		super(types);</span>
<span class="fc" id="L42">	}</span>

	// array of all trac types that are computed for ActualTraceCube
	// public static
<span class="pc" id="L46">	private final short[] COMPUTED_TYPES = { CRATE, RPCRATE, VAR, CV_VH };</span>

	public short[] getComputedTraceTypes() {
<span class="nc" id="L49">		return COMPUTED_TYPES;</span>
	}

	/**
	 * TraceCube is a container for types of Trace, given period
	 *
	 * @param ID
	 *            , queueID
	 * @param Date
	 *            , startDate,
	 * @param Date
	 *            , endDate,
	 * @param short[], the Trace Types to be included
	 */
	public ActualTraceCube(ID queueID, Date startDate, Date endDate,
			short[] types) throws BbmTimeSeriesException {
<span class="nc" id="L65">		this(queueID, startDate, endDate, types, TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L66">	}</span>

	/**
	 * TraceCube is a container for types of Trace, given period
	 *
	 * @param ID
	 *            , queueID
	 * @param Date
	 *            , startDate,
	 * @param Date
	 *            , endDate,
	 * @param short[], the Trace Types to be included
	 * @param TimeZone
	 */
	public ActualTraceCube(ID queueID, Date startDate, Date endDate,
			short[] types, TimeZone timeZone) throws BbmTimeSeriesException {
<span class="nc" id="L82">		super(queueID, startDate, endDate, types);</span>
<span class="nc" id="L83">		checkTraceTypeSupport(types);</span>
<span class="nc" id="L84">	}</span>

	// Base TraceCube supports all types of Trace
	protected short[] getSupportedTraceType() {
<span class="fc" id="L88">		return TYPES;</span>
	}

	// Override parent function used in toString()
	protected String getCubeName() {
<span class="nc" id="L93">		return &quot;QUEUEHISTORYTIMESERIES&quot;;</span>
	}

	// make a clone from given parameters
	public TraceCube newInstance(ID queueID, Date startDate, Date endDate,
			short[] types) throws BbmTimeSeriesException {
<span class="nc" id="L99">		return new ActualTraceCube(queueID, startDate, endDate, types);</span>
	}

	/**
	 * Calculates all the computed values for the given array of Trace types.
	 * this method needs to implemented in all child object that use computed
	 * trace types the computation is done for each time interval Separately
	 * (identified by the offset) This method is used to calculate the computed
	 * values of the trace cube and should be called for each time interval
	 * after all the reqd values are acquired for a that time interval.
	 *
	 * @param mediaID
	 * @return result
	 */
	public void calcComputedTraceValues(ID mediaID) {
<span class="nc" id="L114">		short traceTypes[] = getTraceTypes();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">		for (int j = 0; j &lt; traceTypes.length; j++) {</span>
<span class="nc" id="L116">			short type = traceTypes[j];</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">			if (isTraceTypeComputed(type)) {</span>
<span class="nc bnc" id="L118" title="All 4 branches missed.">				if (type == Trace.CRATE || type == Trace.RPCRATE) {</span>
<span class="nc" id="L119">					calcComputedTraceValuesForOutbound(type);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">				} else if (type == Trace.CV_VH) {</span>
<span class="nc" id="L121">					calcComputedTraceValuesFoCV_VH(type);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">				} else if (type == Trace.VAR) {</span>
<span class="nc bnc" id="L123" title="All 4 branches missed.">					if (Media.isMediaImmediate(mediaID) &amp;&amp; Trace.isComputeActualImmediateSLOnVHAndAbandons()) {</span>
<span class="nc" id="L124">						calcComputedTraceValuesForVARWithVHAndABN(mediaID, type);</span>
					} else {
<span class="nc" id="L126">						calcComputedTraceValuesForVARWithCVOrVH(mediaID, type);</span>
					}
				}
			}
		}
<span class="nc" id="L131">	}</span>

	protected void calcComputedTraceValuesForVARWithVHAndABN(ID mediaID, short type) {

<span class="nc" id="L135">		double[] abnArray = getTraceValueD(Trace.ABANDONMENT);</span>
<span class="nc bnc" id="L136" title="All 4 branches missed.">		if (abnArray == null || !doesArrayHaveValidValues(abnArray)) {</span>
<span class="nc" id="L137">			calcComputedTraceValuesForVARWithCVOrVH(mediaID, type);</span>
<span class="nc" id="L138">			return;</span>
		}

		double[] valueArray;
<span class="nc" id="L142">		double[] vhArray = getTraceValueD(Trace.VH);</span>
<span class="nc bnc" id="L143" title="All 4 branches missed.">		if (vhArray == null || !doesArrayHaveValidValues(vhArray)) {</span>
<span class="nc" id="L144">			double[] cvArray = getTraceValueD(Trace.CV);</span>
<span class="nc" id="L145">			valueArray = new double[cvArray.length];</span>
<span class="nc" id="L146">			System.arraycopy(cvArray, 0, valueArray, 0, cvArray.length);</span>
<span class="nc" id="L147">		} else {</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">			int arrayLength = (vhArray.length &gt; abnArray.length ? abnArray.length : vhArray.length);</span>
<span class="nc" id="L149">			valueArray = new double[arrayLength];</span>
<span class="nc" id="L150">			initIntArray(valueArray);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">			for (int i = 0; i &lt; arrayLength; i++) {</span>
<span class="nc bnc" id="L152" title="All 4 branches missed.">				if (vhArray[i] &gt;= 0 &amp;&amp; abnArray[i] &gt;= 0) {</span>
<span class="nc" id="L153">					valueArray[i] = vhArray[i] + abnArray[i];</span>
				}
			}
		}
<span class="nc" id="L157">		setTraceValue(type, valueArray);</span>
<span class="nc" id="L158">	}</span>
	
	protected void calcComputedTraceValuesForVARWithCVOrVH(ID mediaID, short type) {
<span class="nc" id="L161">		double[] cArray = null;</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">		if (isVolumeHandledEnabled()</span>
<span class="nc bnc" id="L163" title="All 4 branches missed.">				&amp;&amp; (isAlwaysUseVHInsteadOfCV() || (mediaID != null &amp;&amp; !Media</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">						.isMediaImmediate(mediaID)))) {</span>
<span class="nc" id="L165">			cArray = getTraceValueD(Trace.VH);</span>
		}
<span class="nc bnc" id="L167" title="All 4 branches missed.">		if (cArray == null || !doesArrayHaveValidValues(cArray)) {</span>
<span class="nc" id="L168">			cArray = getTraceValueD(Trace.CV);</span>
		}
<span class="nc" id="L170">		double[] value = new double[cArray.length];</span>
<span class="nc" id="L171">		System.arraycopy(cArray, 0, value, 0, cArray.length);</span>
<span class="nc" id="L172">		setTraceValue(type, value);</span>
<span class="nc" id="L173">	}</span>

	protected void calcComputedTraceValuesFoCV_VH(short type) {
<span class="nc" id="L176">		double[] cArray = null;</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">		if (isVolumeHandledEnabled()) {</span>
<span class="nc" id="L178">			cArray = getTraceValueD(Trace.VH);</span>
		}
<span class="nc bnc" id="L180" title="All 4 branches missed.">		if (cArray == null || !doesArrayHaveValidValues(cArray)) {</span>
<span class="nc" id="L181">			cArray = getTraceValueD(Trace.CV);</span>
		}
<span class="nc" id="L183">		double[] value = new double[cArray.length];</span>
<span class="nc" id="L184">		System.arraycopy(cArray, 0, value, 0, cArray.length);</span>
<span class="nc" id="L185">		setTraceValue(type, value);</span>
<span class="nc" id="L186">	}</span>

	protected void calcComputedTraceValuesForOutbound(short type) {
<span class="nc" id="L189">		double[] cArray = null;</span>
<span class="nc" id="L190">		double[] dialsArray = getTraceValueD(Trace.DIALS);</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">		if (type == Trace.CRATE) {</span>
<span class="nc" id="L192">			cArray = getTraceValueD(Trace.CONNECTS);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">		} else if (type == Trace.RPCRATE) {</span>
<span class="nc" id="L194">			cArray = getTraceValueD(Trace.RPC);</span>
		}
<span class="nc bnc" id="L196" title="All 4 branches missed.">		if (dialsArray == null || cArray == null) {</span>
<span class="nc" id="L197">			return;</span>
		}
<span class="nc bnc" id="L199" title="All 2 branches missed.">		int arrayLength = (dialsArray.length &gt; cArray.length ? cArray.length</span>
				: dialsArray.length);
<span class="nc" id="L201">		double[] value = new double[arrayLength];</span>
<span class="nc" id="L202">		initIntArray(value);</span>
<span class="nc bnc" id="L203" title="All 4 branches missed.">		for (int i = 0; cArray != null &amp;&amp; i &lt; cArray.length; i++) {</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">			if (i &lt; dialsArray.length) {</span>
<span class="nc bnc" id="L205" title="All 4 branches missed.">				if (cArray[i] &gt;= 0 &amp;&amp; dialsArray[i] &gt; 0) {</span>
<span class="nc" id="L206">					value[i] = (double) (cArray[i] * 100)</span>
							/ dialsArray[i];
<span class="nc bnc" id="L208" title="All 4 branches missed.">				} else if (cArray[i] == 0 &amp;&amp; dialsArray[i] == 0) {</span>
<span class="nc" id="L209">					value[i] = 0;</span>
				}
			} else {
				break;
			}
		}
<span class="nc" id="L215">		setTraceValue(type, value);</span>
<span class="nc" id="L216">	}</span>

	public void calcComputedTraceValues(short traceTypes[],
			float[] traceValues, ID mediaID) {
<span class="nc" id="L220">		float dials = getTraceValueForTraceTypeFromGivenArrayOfTraceValues(</span>
				Trace.DIALS, traceTypes, traceValues);
<span class="nc bnc" id="L222" title="All 2 branches missed.">		for (int j = 0; j &lt; traceTypes.length; j++) {</span>
<span class="nc" id="L223">			short type = traceTypes[j];</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">			if (isTraceTypeComputed(type)) {</span>
<span class="nc bnc" id="L225" title="All 4 branches missed.">				if (type == Trace.CRATE || type == Trace.RPCRATE) {</span>
<span class="nc" id="L226">					calcComputedTraceValuesForOutbound(traceTypes, traceValues, dials, j, type);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">				} else if (type == Trace.CV_VH) {</span>
<span class="nc" id="L228">					calcComputedTraceValuesFoCV_VH(traceTypes, traceValues, j);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">				} else if (type == Trace.VAR) {</span>
<span class="nc bnc" id="L230" title="All 4 branches missed.">					if (Media.isMediaImmediate(mediaID) &amp;&amp; Trace.isComputeActualImmediateSLOnVHAndAbandons()) {</span>
<span class="nc" id="L231">						calcComputedTraceValuesForVARWithVHAndABN(traceTypes, traceValues, j);</span>
					} else {
<span class="nc" id="L233">						calcComputedTraceValuesForVARWithCVOrVH(traceTypes, traceValues, mediaID, j);</span>
					}
				}
			}
		}
<span class="nc" id="L238">	}</span>

	protected void calcComputedTraceValuesForVARWithVHAndABN(short[] traceTypes, float[] traceValues, int j) {
<span class="nc" id="L241">		float varVal = Trace.TRACENA;</span>
<span class="nc" id="L242">		float abnVal = getTraceValueForTraceTypeFromGivenArrayOfTraceValues(Trace.ABANDONMENT, traceTypes, traceValues);</span>
<span class="nc" id="L243">		float vhVal = getTraceValueForTraceTypeFromGivenArrayOfTraceValues(Trace.VH, traceTypes, traceValues);</span>

<span class="nc bnc" id="L245" title="All 4 branches missed.">		if (isTraceValueValid(abnVal) &amp;&amp; isTraceValueValid(vhVal)) {</span>
<span class="nc" id="L246">			varVal = abnVal + vhVal;</span>
		} else {
<span class="nc" id="L248">			varVal = getTraceValueForTraceTypeFromGivenArrayOfTraceValues(Trace.CV, traceTypes, traceValues);</span>
		}
<span class="nc" id="L250">		traceValues[j] = varVal;</span>
<span class="nc" id="L251">	}</span>

	protected void calcComputedTraceValuesForVARWithCVOrVH(short[] traceTypes, float[] traceValues, ID mediaID, int j) {
<span class="nc" id="L254">		float cVal = Trace.TRACENA;</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">		if (isVolumeHandledEnabled()</span>
<span class="nc bnc" id="L256" title="All 6 branches missed.">				&amp;&amp; (isAlwaysUseVHInsteadOfCV() || (mediaID != null &amp;&amp; !Media.isMediaImmediate(mediaID)))) {</span>
<span class="nc" id="L257">			cVal = getTraceValueForTraceTypeFromGivenArrayOfTraceValues(</span>
					Trace.VH, traceTypes, traceValues);
		}
<span class="nc bnc" id="L260" title="All 2 branches missed.">		if (!isTraceValueValid(cVal)) {</span>
<span class="nc" id="L261">			cVal = getTraceValueForTraceTypeFromGivenArrayOfTraceValues(</span>
					Trace.CV, traceTypes, traceValues);
		}
<span class="nc" id="L264">		traceValues[j] = cVal;</span>
<span class="nc" id="L265">	}</span>

	protected void calcComputedTraceValuesFoCV_VH(short[] traceTypes, float[] traceValues, int j) {
<span class="nc" id="L268">		float cVal = Trace.TRACENA;</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">		if (isVolumeHandledEnabled()) {</span>
<span class="nc" id="L270">			cVal = getTraceValueForTraceTypeFromGivenArrayOfTraceValues(</span>
					Trace.VH, traceTypes, traceValues);
		}
<span class="nc bnc" id="L273" title="All 2 branches missed.">		if (!isTraceValueValid(cVal)) {</span>
<span class="nc" id="L274">			cVal = getTraceValueForTraceTypeFromGivenArrayOfTraceValues(</span>
					Trace.CV, traceTypes, traceValues);
		}
<span class="nc" id="L277">		traceValues[j] = cVal;</span>
<span class="nc" id="L278">	}</span>

	protected void calcComputedTraceValuesForOutbound(short[] traceTypes, float[] traceValues, float dials, int j,
			short type) {
<span class="nc" id="L282">		float cVal = Trace.TRACENA;</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">		if (type == Trace.CRATE) {</span>
<span class="nc" id="L284">			cVal = getTraceValueForTraceTypeFromGivenArrayOfTraceValues(</span>
					Trace.CONNECTS, traceTypes, traceValues);
<span class="nc bnc" id="L286" title="All 2 branches missed.">		} else if (type == Trace.RPCRATE) {</span>
<span class="nc" id="L287">			cVal = getTraceValueForTraceTypeFromGivenArrayOfTraceValues(</span>
					Trace.RPC, traceTypes, traceValues);
		}
<span class="nc bnc" id="L290" title="All 4 branches missed.">		if (dials &gt; 0 &amp;&amp; cVal &gt;= 0) {</span>
<span class="nc" id="L291">			traceValues[j] = (cVal * 100) / dials;</span>
<span class="nc bnc" id="L292" title="All 4 branches missed.">		} else if (dials == 0 &amp;&amp; cVal == 0) {</span>
<span class="nc" id="L293">			traceValues[j] = 0;</span>
		}
<span class="nc" id="L295">	}</span>

	public void calcComputedTraceValuesForTraceChunk(TraceChunk tc, ID mediaID) {
<span class="nc" id="L298">		calcComputedTraceValuesForTraceChunkForOutbound(tc);</span>

<span class="nc" id="L300">		float vhVal = tc.getTraceValue(Trace.VH);</span>
<span class="nc bnc" id="L301" title="All 4 branches missed.">		boolean setVH = (isVolumeHandledEnabled() &amp;&amp; isTraceValueValid(vhVal));</span>
<span class="nc" id="L302">		calcComputedTraceValuesForTraceChunkForCV_VH(tc, setVH);</span>

<span class="nc" id="L304">		calcComputedTraceValuesForTraceChunkForVARWithCVOrVH(tc, mediaID, setVH);</span>

<span class="nc bnc" id="L306" title="All 6 branches missed.">		if (Media.isMediaImmediate(mediaID) &amp;&amp; Trace.isComputeActualImmediateSLOnVHAndAbandons() &amp;&amp; setVH) {</span>
<span class="nc" id="L307">			calcComputedTraceValuesForTraceChunkForVARWithVHAndABN(tc, mediaID, vhVal);</span>
		} else {
<span class="nc" id="L309">			calcComputedTraceValuesForTraceChunkForVARWithCVOrVH(tc, mediaID, setVH);</span>
		}

<span class="nc" id="L312">	}</span>

	protected void calcComputedTraceValuesForTraceChunkForVARWithVHAndABN(TraceChunk tc,  ID mediaID, float vhVal) {
<span class="nc" id="L315">		float abnVal = tc.getTraceValue(Trace.ABANDONMENT);</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">		if (isTraceValueValid(abnVal)) {</span>
<span class="nc" id="L317">			float varVal = abnVal + vhVal;</span>
<span class="nc" id="L318">			tc.setTraceValue(Trace.VAR, varVal);</span>
<span class="nc" id="L319">		} else {</span>
<span class="nc" id="L320">			calcComputedTraceValuesForTraceChunkForVARWithCVOrVH(tc, mediaID, true);</span>
		}
<span class="nc" id="L322">	}</span>

	protected void calcComputedTraceValuesForTraceChunkForVARWithCVOrVH(TraceChunk tc, ID mediaID, boolean setVH) {
<span class="nc bnc" id="L325" title="All 2 branches missed.">		boolean vh = setVH</span>
<span class="nc bnc" id="L326" title="All 6 branches missed.">				&amp;&amp; (isAlwaysUseVHInsteadOfCV() || (mediaID != null &amp;&amp; !Media.isMediaImmediate(mediaID)));</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">		tc.setTraceValue(Trace.VAR, tc.getTraceValue(vh ? Trace.VH : Trace.CV));</span>
<span class="nc" id="L328">	}</span>

	protected void calcComputedTraceValuesForTraceChunkForCV_VH(TraceChunk tc, boolean setVH) {
<span class="nc bnc" id="L331" title="All 2 branches missed.">		tc.setTraceValue(Trace.CV_VH, tc.getTraceValue(setVH ? Trace.VH : Trace.CV));</span>
<span class="nc" id="L332">	}</span>

	protected void calcComputedTraceValuesForTraceChunkForOutbound(TraceChunk tc) {
<span class="nc" id="L335">		float dials = tc.getTraceValue(Trace.DIALS);</span>
<span class="nc" id="L336">		float connects = tc.getTraceValue(Trace.CONNECTS);</span>
<span class="nc bnc" id="L337" title="All 4 branches missed.">		if (dials &gt; 0 &amp;&amp; connects &gt;= 0) {</span>
<span class="nc" id="L338">			tc.setTraceValue(Trace.CRATE, (connects * 100) / dials);</span>
<span class="nc bnc" id="L339" title="All 4 branches missed.">		} else if (dials == 0 &amp;&amp; connects == 0) {</span>
<span class="nc" id="L340">			tc.setTraceValue(Trace.CRATE, 0);</span>
		}
<span class="nc" id="L342">		float rpc = tc.getTraceValue(Trace.RPC);</span>
<span class="nc bnc" id="L343" title="All 4 branches missed.">		if (dials &gt; 0 &amp;&amp; rpc &gt;= 0) {</span>
<span class="nc" id="L344">			tc.setTraceValue(Trace.RPCRATE, (rpc * 100) / dials);</span>
<span class="nc bnc" id="L345" title="All 4 branches missed.">		} else if (dials == 0 &amp;&amp; rpc == 0) {</span>
<span class="nc" id="L346">			tc.setTraceValue(Trace.RPCRATE, 0);</span>
		}
<span class="nc" id="L348">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>