<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.activity</a> &gt; <span class="el_source">ActivityListPC.java</span></div><h1>ActivityListPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.activity;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.Map.Entry;
import java.util.ResourceBundle;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategory;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TOAccrualCalculator;
import com.bluepumpkin.web.bbm.earningtype.EarningTypeModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.workload.WorkloadModelHandler;
import com.bluepumpkin.web.core.setup.mediatypes.MediaTypesSetupPageModel;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.licensing.ejb.LicenseManager;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.InsertableMultiColListPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.WorkpaneMultiColPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.ColorUtil;

/**
 * Title:        ActivityListPC
 * Description:  Page component that displays a detailed list of activities
 * Copyright:    Copyright (c) 2009
 * Company:      Verint Systems Inc.
 * @author       Dustin Stanley
 */
public class ActivityListPC extends InsertableMultiColListPC {
	private static final long serialVersionUID = 1L;

	protected ResourceBundle m_bbmBundle;
<span class="pc" id="L48">	private Map&lt;ID, String&gt; m_orgMap = null;</span>
<span class="pc" id="L49">	private Map&lt;ID, ActivityCategory&gt; m_activityTypeMap = null;</span>
<span class="pc" id="L50">	private Map&lt;ID, String&gt; m_earningTypeMap = null;</span>
<span class="pc" id="L51">	private Map&lt;ID, Collection&lt;Media&gt;&gt; m_mediaMap = null;</span>
<span class="pc" id="L52">	private Map&lt;ID, Collection&lt;Queue&gt;&gt; m_queuesMap = null;</span>
<span class="pc" id="L53">	private Map&lt;ID, String&gt; m_coreSourceMeasureMap = null;</span>
<span class="pc" id="L54">	private boolean m_hasPayrollLicense = false;</span>
<span class="pc" id="L55">	private boolean m_hasMultiMediaLicense = false;</span>
<span class="pc" id="L56">	private boolean m_hasAdvisorLicense = false;</span>
<span class="pc" id="L57">	private boolean m_hasAccrualLicense = false;</span>
<span class="pc" id="L58">	private boolean m_hasQueueHoppingLicense = false;</span>

<span class="pc" id="L60">	private boolean m_enableSorting = false;</span>


	public ActivityListPC(RequestContext context, String name, Collection&lt;Activity&gt; activities) {
<span class="fc" id="L64">		super(context);</span>
<span class="fc" id="L65">		init(context, name, activities);</span>
<span class="fc" id="L66">	}</span>

	public ActivityListPC(RequestContext context, String name, Collection&lt;Activity&gt; activities, boolean enableSorting) {
<span class="nc" id="L69">		super(context);</span>
<span class="nc" id="L70">		m_enableSorting = enableSorting;</span>
<span class="nc" id="L71">		init(context, name, activities);</span>
<span class="nc" id="L72">	}</span>

	/**
	 * @param context
	 * @param name
	 * @param activities
	 * @param enableSorting
	 * @param isRepeatHeaderEnabled - Specify whether Repeat Header is enabled
	 */
	public ActivityListPC(RequestContext context, String name, Collection&lt;Activity&gt; activities, boolean enableSorting, boolean isRepeatHeaderEnabled) {
<span class="fc" id="L82">		super(context);</span>

<span class="pc bpc" id="L84" title="1 of 2 branches missed.">		if (isRepeatHeaderEnabled) {</span>
<span class="fc" id="L85">			initRepeatHeaderInterval();</span>
		}

<span class="fc" id="L88">		setIsZebra(true);</span>

<span class="fc" id="L90">		m_enableSorting = enableSorting;</span>
<span class="fc" id="L91">		init(context, name, activities);</span>
<span class="fc" id="L92">	}</span>

	protected void init(RequestContext context, String name, Collection&lt;Activity&gt; activities)
	{
<span class="pc bpc" id="L96" title="2 of 4 branches missed.">		if (name != null &amp;&amp; name.length() &gt; 0) {</span>
<span class="fc" id="L97">			setName(name);</span>
		}
<span class="fc" id="L99">		m_bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L100">		checkForLicenses();</span>

<span class="fc" id="L102">		initRows(activities);</span>
<span class="fc" id="L103">		initHeader();</span>
<span class="fc" id="L104">	}</span>

	protected void initHeader() {
<span class="fc" id="L107">		TableHeaderPC header = getHeader();</span>
<span class="fc" id="L108">		header.setPartialSortable(m_enableSorting);</span>

		// Generic attributes
<span class="fc" id="L111">		header.addColumnHeaderData(getNameColumnIdentifier(),</span>
<span class="fc" id="L112">				i18n(m_common_bundle, UIFWebBundleKey.LIST_HEADER_NAME), m_enableSorting);</span>
<span class="fc" id="L113">		header.addColumnHeaderData(ActivityFields.DESCRIPTION_FN,</span>
<span class="fc" id="L114">				i18n(m_common_bundle, UIFWebBundleKey.LIST_HEADER_DESCRIPTION), m_enableSorting);</span>
<span class="fc" id="L115">		header.addColumnHeaderData(ActivityFields.OWNER_ORG_FN,</span>
<span class="fc" id="L116">				i18n(m_bbmBundle, BbmWebBundleKey.LIST_HEADER_OWNER_ORG), m_enableSorting);</span>
<span class="fc" id="L117">		header.addColumnHeaderData(ActivityFields.ACTIVITY_CATEGORY_FN,</span>
<span class="fc" id="L118">				i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_ACTIVITY_TYPE), m_enableSorting);</span>
<span class="fc" id="L119">		header.addColumnHeaderData(ActivityFields.PAID_FN,</span>
<span class="fc" id="L120">				i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_IS_PAID), m_enableSorting);</span>

<span class="pc bpc" id="L122" title="3 of 4 branches missed.">		if (m_hasPayrollLicense &amp;&amp; isFullList()){</span>
<span class="nc" id="L123">			header.addColumnHeaderData(ActivityFields.EARNING_TYPE_FN,</span>
<span class="nc" id="L124">					m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.ACTIVITY_LABEL_EARNING_TYPE), m_enableSorting);</span>
		}
<span class="fc" id="L126">		header.addColumnHeaderData(ActivityFields.COLOR_FN,</span>
<span class="fc" id="L127">				i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_COLOR), m_enableSorting);</span>
<span class="fc" id="L128">		header.addColumnHeaderData(ActivityFields.COLOR_CODE_FN,</span>
<span class="fc" id="L129">				i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_COLOR_CODE), m_enableSorting);</span>
<span class="fc" id="L130">		header.addColumnHeaderData(ActivityFields.TIMEOFF_FN,</span>
<span class="fc" id="L131">				i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF), m_enableSorting);</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">		if (isFullList()) //Fixed QC#81240: Activity Edit page in web suite doesn't have a Media selector when Multi-Media license not present.</span>
		{
<span class="fc" id="L134">			header.addColumnHeaderData(ActivityFields.MEDIA_FN,</span>
<span class="fc" id="L135">				i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_MEDIA), m_enableSorting);</span>
		}

<span class="pc bpc" id="L138" title="1 of 2 branches missed.">		if (m_hasQueueHoppingLicense)</span>
		{
<span class="fc" id="L140">			header.addColumnHeaderData(ActivityFields.QUEUE_HOPPING_FN, i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_IS_QUEUE_HOPPING), m_enableSorting);</span>
		}
<span class="pc bpc" id="L142" title="3 of 6 branches missed.">		if ((m_hasQueueHoppingLicense || m_hasMultiMediaLicense) &amp;&amp; isFullList())</span>
		{
<span class="fc" id="L144">			header.addColumnHeaderData(ActivityFields.QUEUES_FN, i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_QUEUES), m_enableSorting);</span>
		}

		// FS related attributes
<span class="fc" id="L148">		header.addColumnHeaderData(ActivityFields.USED_IN_SHIFT_FN,</span>
<span class="fc" id="L149">			i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_LIST_USED_IN_SHIFT), m_enableSorting);</span>
<span class="fc" id="L150">		header.addColumnHeaderData(ActivityFields.USED_IN_SHIFT_EVENT_FN,</span>
<span class="fc" id="L151">			i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_LIST_USED_IN_SHIFT_EVENT), m_enableSorting);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">		if (isFullList()) {</span>
<span class="fc" id="L153">			header.addColumnHeaderData(ActivityFields.USED_IN_CALENDAR_EVENT_FN,</span>
<span class="fc" id="L154">				i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_LIST_USED_IN_CALENDAR_EVENT), m_enableSorting);</span>
<span class="fc" id="L155">			header.addColumnHeaderData(ActivityFields.UNAVAILABILITY_FN,</span>
<span class="fc" id="L156">				i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_UNAVAILABILITY), m_enableSorting);</span>
			// TO related attribute
<span class="fc" id="L158">			header.addColumnHeaderData(ActivityFields.REQUESTABLE_FN,</span>
<span class="fc" id="L159">				i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_REQUESTABLE), m_enableSorting);</span>
			String bundleKeyALLOTMENT;
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">				if (!m_hasAccrualLicense)</span>
<span class="nc" id="L162">					bundleKeyALLOTMENT = BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF_WITH_ALLOTMENT;</span>
				else
<span class="fc" id="L164">					bundleKeyALLOTMENT = BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF_WITH_ACCRUAL;</span>
<span class="fc" id="L165">				header.addColumnHeaderData(ActivityFields.TIMEOFF_WITH_ALLOTMENT_FN,</span>
<span class="fc" id="L166">						i18n(m_bbmBundle, bundleKeyALLOTMENT), m_enableSorting);</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">				if (m_hasAccrualLicense) {</span>
<span class="fc" id="L168">					header.addColumnHeaderData(ActivityFields.TIMEOFF_ACCRUAL_SCHEDULE_FN,</span>
<span class="fc" id="L169">							i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF_ACCRUAL_SCHEDULE), m_enableSorting);</span>
<span class="fc" id="L170">					header.addColumnHeaderData(ActivityFields.TIMEOFF_ACCRUAL_POLICY_FN,</span>
<span class="fc" id="L171">							i18n(m_bbmBundle, BbmWebBundleKey.ACCRUAL_POLICY), m_enableSorting);</span>
				}


			// AM related attributes
<span class="fc" id="L176">			header.addColumnHeaderData(ActivityFields.TOLERANCE_FN,</span>
<span class="fc" id="L177">				i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_LIST_TOLERANCE), m_enableSorting);</span>
<span class="fc" id="L178">			header.addColumnHeaderData(ActivityFields.MAX_DURATION_FN,</span>
<span class="fc" id="L179">				i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_LIST_MAXTHRESHOLD), m_enableSorting);</span>
<span class="fc" id="L180">			header.addColumnHeaderData(ActivityFields.OUT_FN,</span>
<span class="fc" id="L181">				i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_WHOSIN), m_enableSorting);</span>

<span class="pc bpc" id="L183" title="1 of 2 branches missed.">			if (m_hasAdvisorLicense){</span>
				//advisor related attributes
<span class="fc" id="L185">				header.addColumnHeaderData(ActivityFields.SOURCE_MEASURE_FN,</span>
<span class="fc" id="L186">					i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_ADV_SOURCE_MEASURE), m_enableSorting);</span>
			}

<span class="fc" id="L189">			header.addColumnHeaderData(ActivityFields.RESOURCE_CONSTRAINT_FN,</span>
<span class="fc" id="L190">					i18n(m_bbmBundle, BbmWebBundleKey.RESOURCE_CONSTRAINT), m_enableSorting);</span>

<span class="fc" id="L192">			header.addColumnHeaderData(ActivityFields.CELL_GROUP_SIZE_FN,</span>
<span class="fc" id="L193">					i18n(m_bbmBundle, BbmWebBundleKey.CELL_GROUP_SIZE), m_enableSorting);</span>

		}

		// Enable Auto Sorting
<span class="fc bfc" id="L198" title="All 2 branches covered.">		if (m_enableSorting)</span>
		{
<span class="fc" id="L200">			ArrayList&lt;String&gt; sortColumns = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L201">			sortColumns.add(ActivityFields.NAME_FN);</span>
<span class="fc" id="L202">			header.setDefaultSortColumns(sortColumns);</span>
		}
<span class="fc" id="L204">	}</span>

	private void initRows(Collection&lt;Activity&gt; activities) {
<span class="fc" id="L207">		Collection&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>

		try {
<span class="pc bpc" id="L210" title="1 of 4 branches missed.">			if(activities != null &amp;&amp; activities.size() &gt; 0) {</span>
<span class="fc" id="L211">				HashSet&lt;ID&gt; orgIds = new HashSet&lt;ID&gt;(activities.size());</span>
<span class="fc" id="L212">				HashSet&lt;ID&gt; activityTypeIds = new HashSet&lt;ID&gt;(activities.size());</span>
<span class="fc" id="L213">				HashSet&lt;ID&gt; earningTypesIds = new HashSet&lt;ID&gt;(activities.size());</span>
<span class="fc" id="L214">				HashSet&lt;ID&gt; activityIds = new HashSet&lt;ID&gt;(activities.size());</span>
<span class="fc" id="L215">				ID id = null;</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">				for(Activity activity : activities) {</span>
<span class="fc" id="L217">					id = activity.getOrganizationId();</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">					if(!orgIds.contains(id)) {</span>
<span class="fc" id="L219">						orgIds.add(id);</span>
					}
<span class="fc" id="L221">					id = activity.getActivityCategoryId();</span>
<span class="fc bfc" id="L222" title="All 2 branches covered.">					if(!activityTypeIds.contains(id)) {</span>
<span class="fc" id="L223">						activityTypeIds.add(id);</span>
					}
<span class="fc" id="L225">					id = activity.getEarningTypeId();</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">					if(!earningTypesIds.contains(id)) {</span>
<span class="fc" id="L227">						earningTypesIds.add(id);</span>
					}
<span class="fc" id="L229">					id = activity.getID();</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">					if(!activityIds.contains(id)) {</span>
<span class="fc" id="L231">						activityIds.add(id);</span>
					}
<span class="fc" id="L233">				}</span>
<span class="fc" id="L234">				m_orgMap = OrganizationModelHandler.buildOrganizationMap(m_context, orgIds);</span>
<span class="fc" id="L235">				m_activityTypeMap = ActivityTypeModelHandler.buildActivityTypeMap(m_context, activityTypeIds);</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">				if (m_hasPayrollLicense){</span>
<span class="nc" id="L237">					m_earningTypeMap = EarningTypeModelHandler.buildEarningTypeMap(earningTypesIds);</span>
				}

				//if (m_hasMultiMediaLicense) //Fixed QC#81240: Activity Edit page in web suite doesn't have a Media selector when Multi-Media license not present.
				{
<span class="fc" id="L242">					m_mediaMap = getActivitiesMediaMap(activityIds);</span>
				}

<span class="pc bpc" id="L245" title="3 of 4 branches missed.">				if (m_hasQueueHoppingLicense || m_hasMultiMediaLicense){</span>
<span class="fc" id="L246">					m_queuesMap = ActivityModelHandler.getActivitiesQueueMap(m_context, activityIds);</span>
				}
			}
<span class="nc" id="L249">		} catch (Exception ex) {</span>
<span class="nc" id="L250">			handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L251">		}</span>

		//get sourcemeasure map if advisor stand alone
<span class="fc" id="L254">		m_coreSourceMeasureMap = null;</span>
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">		if (m_hasAdvisorLicense)</span>
<span class="fc" id="L256">			m_coreSourceMeasureMap = ActivityModelHandler.getCoreSourceMeasureMap(m_context);</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">		if (activities != null) {</span>
<span class="fc bfc" id="L258" title="All 2 branches covered.">			for (Activity activity : activities) {</span>
				//#27127: check for multi- contact license
				//as in DE, filter out deferred(-4102) and blended(-4103) activities if no license
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">				if (!m_hasMultiMediaLicense &amp;&amp;</span>
<span class="nc bnc" id="L262" title="All 4 branches missed.">						(activity.getID().equals(new ID(-4102)) || activity.getID().equals(new ID(-4103))))</span>
<span class="nc" id="L263">					continue;</span>

				// Create the row data
<span class="fc" id="L266">				MultiColumnNodeData rowData = buildNodeData(activity);</span>
<span class="fc" id="L267">				rows.add(rowData);</span>
<span class="fc" id="L268">			}</span>
		}
<span class="fc" id="L270">	}</span>

	protected  Map&lt;ID, Collection&lt;Media&gt;&gt; getActivitiesMediaMap(Collection activityIds) throws Exception
	{
		//ACTIVITY_ID -&gt; list of Media
<span class="fc" id="L275">		 Map&lt;ID, Collection&lt;Media&gt;&gt; mediaMap = ActivityModelHandler.getActivitiesMediaMap(m_context, activityIds);</span>

<span class="pc bpc" id="L277" title="1 of 2 branches missed.">		if (!m_hasMultiMediaLicense)</span>
		{
			//Since they don't have the Multi-Media license, we will only keep the Phone media

<span class="nc bnc" id="L281" title="All 2 branches missed.">			if (mediaMap!=null)</span>
			{
<span class="nc bnc" id="L283" title="All 2 branches missed.">				for (Iterator&lt;Entry&lt;ID, Collection&lt;Media&gt;&gt;&gt; it=mediaMap.entrySet().iterator(); it.hasNext();)</span>
				{
<span class="nc" id="L285">					Entry&lt;ID, Collection&lt;Media&gt;&gt; entry = (Entry&lt;ID, Collection&lt;Media&gt;&gt;)it.next();</span>
<span class="nc" id="L286">					Collection&lt;Media&gt; medias = entry.getValue();</span>
					//iterate through all the Media's and remove all that are not Phone
<span class="nc bnc" id="L288" title="All 2 branches missed.">					for (Iterator&lt;Media&gt; mediaIt = medias.iterator(); mediaIt.hasNext();)</span>
					{
<span class="nc" id="L290">						Media media = mediaIt.next();</span>
<span class="nc bnc" id="L291" title="All 6 branches missed.">						if (!media.getID().equals(Media.MEDIA_ID_PHONE) &amp;&amp; (!media.getID().equals(Media.MEDIA_ID_OPERATIONS) || !MediaTypesSetupPageModel.hasAnyBackOfficeLicence()))</span>
<span class="nc" id="L292">							mediaIt.remove();</span>
<span class="nc" id="L293">					}</span>
<span class="nc" id="L294">				}</span>
			}
		}
<span class="fc" id="L297">		return mediaMap;</span>
	}

	/**
	 *
	 * @param activity
	 * @return
	 */
	protected MultiColumnNodeData buildNodeData(Activity activity) {
<span class="fc" id="L306">		ActivityCategory activityType = (ActivityCategory) m_activityTypeMap.get(activity.getActivityCategoryId());</span>
<span class="pc bpc" id="L307" title="2 of 4 branches missed.">		if (activityType != null &amp;&amp; activityType.isTOAllotment()) {//sync activity fields with its category</span>
<span class="nc" id="L308">			activity.setTimeoffWithAllotment(true);</span>
<span class="nc" id="L309">			activity.setTOAccrualSchedule(activityType.getTOAccrualSchedule());</span>
<span class="nc" id="L310">			activity.setTOAccrualPolicy(activityType.getTOAccrualPolicy());</span>
		}

		// Set the HTML for coloring the color column
<span class="fc" id="L314">		StringBuffer colorCellHTML = new StringBuffer(64);</span>
<span class="fc" id="L315">		String colorStr = ColorUtil.getHtmlColorCode(activity.getColor());</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">		if(ColorUtil.validateColor(colorStr)) {</span>
<span class="fc" id="L317">			colorCellHTML.append(&quot;&lt;span style=\&quot;background-color:#&quot;)</span>
<span class="fc" id="L318">				.append(colorStr)</span>
<span class="fc" id="L319">				.append(&quot;;\&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&quot;);</span>
		}
		else {
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">			if(StringUtil.isEmpty(colorStr)) {</span>
<span class="fc" id="L323">				colorCellHTML.append(i18n(m_bbmBundle,</span>
					BbmWebBundleKey.ACTIVITY_COLOR_NOT_DEFINED));
			}
			else {
<span class="nc" id="L327">				colorCellHTML.append(i18n(m_bbmBundle,</span>
					BbmWebBundleKey.ACTIVITY_COLOR_INVALID));
			}
		}

<span class="fc" id="L332">		DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData(</span>
<span class="fc" id="L333">				activity.getID());</span>
<span class="fc" id="L334">		short[] displayMap = ActivityFields.getDisplayMap(activity.getID());</span>

		// Name
<span class="pc bpc" id="L337" title="1 of 2 branches missed.">		if (activity.isMultiEditCommon() == false) {</span>
<span class="nc" id="L338">			rowData.add(MULTI_VALUE_DATA + activity.getName());</span>
		} else {
<span class="fc" id="L340">			rowData.add(activity.getName());</span>
		}

		// Description
<span class="fc" id="L344">		rowData.add( activity.getDescription() );</span>

		// Organization name
<span class="fc" id="L347">		rowData.add( m_orgMap.get(activity.getOrganizationId()) );</span>

		// Activity Type
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">		rowData.add( activityType != null ? activityType.getName() : null );</span>

		// Paid
<span class="fc" id="L353">		rowData.add( m_localizer.formatYesNo(activity.isPaid()) );</span>

		// Earning Type
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">		if (m_hasPayrollLicense){</span>
<span class="nc" id="L357">			rowData.add( m_earningTypeMap.get(activity.getEarningTypeId()) );</span>
		}

		// Color
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">		rowData.add( (displayMap[ActivityFields.COLOR] != ActivityFields.NON_DISPLAYABLE) ?</span>
<span class="pc" id="L362">			colorCellHTML.toString() : i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_NA_STRING) );</span>

		// Activity Code
<span class="pc bpc" id="L365" title="1 of 2 branches missed.">		rowData.add( (displayMap[ActivityFields.COLOR_CODE] != ActivityFields.NON_DISPLAYABLE) ?</span>
<span class="pc" id="L366">			activity.getColorCode() : i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_NA_STRING) );</span>

		// Absence
<span class="fc" id="L369">		rowData.add( m_localizer.formatYesNo(activity.isTimeoff()) );</span>

		//Media
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">		if (isFullList()) //Fixed QC#81240: Activity Edit page in web suite doesn't have a Media selector when Multi-Media license not present.</span>
		{
<span class="fc bfc" id="L374" title="All 2 branches covered.">			rowData.add( (displayMap[ActivityFields.MEDIA] != ActivityFields.NON_DISPLAYABLE) ?</span>
<span class="fc" id="L375">				WorkloadModelHandler.getMediaDisplay(m_mediaMap.get(activity.getID())) : i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_NA_STRING) );</span>
		}

		//Queue Hopping
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">		if (m_hasQueueHoppingLicense)</span>
		{
<span class="fc" id="L381">			rowData.add( m_localizer.formatYesNo(activity.isQueueHopping()) );</span>
		}

		//Queues
<span class="pc bpc" id="L385" title="4 of 6 branches missed.">		if ((m_hasQueueHoppingLicense || m_hasMultiMediaLicense) &amp;&amp; isFullList())</span>
		{
<span class="fc bfc" id="L387" title="All 2 branches covered.">			rowData.add( (displayMap[ActivityFields.QUEUES] != ActivityFields.NON_DISPLAYABLE) ?</span>
<span class="fc" id="L388">					WorkloadModelHandler.getQueuesDisplay(m_queuesMap.get(activity.getID()), 4) : i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_NA_STRING) );</span>
		}

		// used in shift
<span class="fc" id="L392">		rowData.add( m_localizer.formatYesNo(activity.isUsedInShift()) );</span>

		// used in shift event
<span class="fc" id="L395">		rowData.add( m_localizer.formatYesNo(activity.isUsedInShiftEvent()) );</span>

<span class="pc bpc" id="L397" title="1 of 2 branches missed.">		if (isFullList()) {</span>
			// used in calendar event
<span class="fc" id="L399">			rowData.add( m_localizer.formatYesNo(activity.isUsedInCalendarEvent()) );</span>
			// Unavailability
<span class="fc" id="L401">			rowData.add( m_localizer.formatYesNo(activity.isUnavailability()) );</span>
			// Requestable
<span class="fc" id="L403">			rowData.add( m_localizer.formatYesNo(activity.isRequestable()) );</span>
			// Timeoff with Allotment
<span class="fc" id="L405">			rowData.add( m_localizer.formatYesNo(activity.isTimeoffWithAllotment()) );</span>
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">			if (m_hasAccrualLicense) {</span>
					//Timeoff Accrual Schedule
<span class="fc" id="L408">					rowData.add( ActivityModelHandler.getAccrualScheduleStr(m_localizer, activity.getTOAccrualSchedule()) );</span>
					//Timeoff Accrual Policy
<span class="fc" id="L410">					rowData.add( ActivityModelHandler.getAccrualPolicyStr(m_localizer, activity.getTOAccrualPolicy()) );</span>
				}
			// Tolerance
<span class="fc bfc" id="L413" title="All 2 branches covered.">			rowData.add( (displayMap[ActivityFields.TOLERANCE] != ActivityFields.NON_DISPLAYABLE) ?</span>
<span class="fc" id="L414">				Integer.toString(activity.getAdherenceTolerance()) : i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_NA_STRING) );</span>
			// Duration
<span class="fc bfc" id="L416" title="All 2 branches covered.">			rowData.add( (displayMap[ActivityFields.MAX_DURATION] != ActivityFields.NON_DISPLAYABLE) ?</span>
<span class="fc" id="L417">				getMaxDurationDisplay(activity.getMaxDurationThreshold()) : i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_NA_STRING) );</span>
			// Who's in state
<span class="fc" id="L419">			rowData.add(ActivityAMUsage.getWhosInStateDisplay(activity.isOut(), m_bbmBundle, m_localizer) );</span>

<span class="pc bpc" id="L421" title="1 of 2 branches missed.">			if (m_hasAdvisorLicense){</span>
<span class="fc" id="L422">				String sourceName = i18n(m_common_bundle, UIFWebBundleKey.NONE);</span>
<span class="pc bpc" id="L423" title="1 of 4 branches missed.">				if (activity.getSourceMeasureId()!=null &amp;&amp; m_coreSourceMeasureMap != null &amp;&amp;</span>
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">						m_coreSourceMeasureMap.containsKey(activity.getSourceMeasureId())){</span>
<span class="fc" id="L425">					sourceName = (String)m_coreSourceMeasureMap.get(activity.getSourceMeasureId());</span>
				}
<span class="fc" id="L427">				rowData.add( sourceName );</span>
			}

			// resource constraint
<span class="pc bpc" id="L431" title="1 of 2 branches missed.">			rowData.add( (displayMap[ActivityFields.RESOURCE_CONSTRAINT] != ActivityFields.NON_DISPLAYABLE) ?</span>
<span class="pc" id="L432">				Integer.toString(activity.getResourceConstraint()) : i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_NA_STRING) );</span>

			// cell group size
<span class="pc bpc" id="L435" title="1 of 2 branches missed.">			rowData.add( (displayMap[ActivityFields.CELL_GROUP_SIZE] != ActivityFields.NON_DISPLAYABLE) ?</span>
<span class="pc" id="L436">				Integer.toString(activity.getCellGroupSize()) : i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_NA_STRING) );</span>

		}

<span class="fc" id="L440">		setRowAttributes(rowData, activity);</span>
<span class="fc" id="L441">		return rowData;</span>
	}

	protected void setRowAttributes(DefaultMultiColumnNodeData mcnd, Activity activity) {
<span class="fc" id="L445">		mcnd.setNodeAttribute(WorkpaneMultiColPM.IS_DELETEABLE, String.valueOf(true));</span>
<span class="fc" id="L446">	}</span>

	/**
	 * Get the string to display for maxDuration
	 */
	private String getMaxDurationDisplay(int duration) {
<span class="fc bfc" id="L452" title="All 2 branches covered.">		return (duration == ActivityAMUsage.MAX_DURATION_DEFAULT_MIN)</span>
<span class="fc" id="L453">			? i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_UNLIMITED)</span>
<span class="fc" id="L454">			: Integer.toString(duration);</span>
	}

	private void checkForLicenses(){
		try {
<span class="fc" id="L459">			LicenseManager licManager = CoreManagerFactory.getLicenseManager();</span>
<span class="fc" id="L460">			m_hasPayrollLicense = licManager.isLicensed(LicenseKeys.APP_PAYROLL);</span>
<span class="fc" id="L461">			m_hasMultiMediaLicense = licManager.isLicensed(LicenseKeys.APP_MULTIMEDIA);</span>
<span class="fc" id="L462">			m_hasAdvisorLicense = licManager.isLicensed(LicenseKeys.APP_ADVISOR_EXPRESS);</span>
<span class="fc" id="L463">			m_hasQueueHoppingLicense = licManager.isLicensed(LicenseKeys.APP_QUEUE_HOPPING);</span>
<span class="nc" id="L464">		} catch (Exception ex){</span>
<span class="nc" id="L465">			log.l7dError(BbmWebBundleKey.UNABLE_TO_LOAD_DATA, ex);</span>
<span class="fc" id="L466">		}</span>
<span class="fc" id="L467">		m_hasAccrualLicense = TOAccrualCalculator.hasLicenseForAccrual();</span>
<span class="fc" id="L468">	}</span>

	/**
	 * To be called by the request handler that dynamically returns a set of html rows via ajax.
	 * @param Collection&lt;Activity&gt;
	 * @return
	 */
	public String getRowHtml(Collection&lt;Activity&gt; activities) {
<span class="nc" id="L476">		StringBuffer html = new StringBuffer();</span>
<span class="nc" id="L477">		super.appendRowData(html);</span>
<span class="nc" id="L478">		return html.toString();</span>
	}

	/**
	 * This value is called in the buildNodeData and initHeader methods to determine if the full
	 * set of columns is to be rendered.
	 */
	protected boolean isFullList() {
<span class="fc" id="L486">		return true;</span>
	}

	@Override
	public String getJavaScriptInitCode() {
<span class="fc" id="L491">		StringBuffer js = new StringBuffer(super.getJavaScriptInitCode());</span>
<span class="fc bfc" id="L492" title="All 2 branches covered.">		if (getToolbar() != null) {</span>
<span class="fc" id="L493">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.setToolbar(&quot;).append(getToolbar().getName()).append(&quot;);&quot;);</span>
<span class="fc" id="L494">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.addButtonEnableAttribute('isDeleteable', 'removeActivity');\n&quot;);</span>
		}
<span class="fc" id="L496">		return js.toString();</span>
	}

	/**
	 * Returns the string used as the name column &quot;identifier&quot; when creating the header data for the activity
	 * name column.
	 */
<span class="fc" id="L503">	protected String getNameColumnIdentifier() { return ActivityFields.NAME_FN; }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>