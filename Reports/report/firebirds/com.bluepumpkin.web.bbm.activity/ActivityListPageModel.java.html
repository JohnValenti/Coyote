<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityListPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.activity</a> &gt; <span class="el_source">ActivityListPageModel.java</span></div><h1>ActivityListPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.activity;

import java.text.MessageFormat;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.workresource.OrganizationScopeManagerProxy;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrgWorkpaneListPageModel;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.verint.web.wfm.keys.WfmJavaScriptFileID;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        ActivityListPageModel
 * Description:  Display the list of Activity per given organization
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       Shimon Kakon
 * @version 1.0
 */
public class ActivityListPageModel extends OrgWorkpaneListPageModel {
<span class="fc" id="L33">	private static final Category log = Log.initCategory(ActivityListPageModel.class.getName());</span>
	private Collection&lt;Activity&gt; m_activities;

<span class="fc" id="L36">	private static final HashSet NO_DELETION_ACTIVITIES = new HashSet();</span>
	static {
<span class="fc" id="L38">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_COACHING);</span>
<span class="fc" id="L39">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_LEARNING_START);</span>
<span class="fc" id="L40">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_LEARNING_END);</span>
<span class="fc" id="L41">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_LEARNING_BREAK);</span>
<span class="fc" id="L42">	}</span>

	/**
	 * Constructor
	 *
	 * @param context the request context
	 */
	public ActivityListPageModel(RequestContext context) {
<span class="fc" id="L50">		super(context);</span>
		

<span class="fc" id="L53">	}</span>

	/**
	 * Initialize Component For Display
	 */
	public void initForDisplay() {
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">		if (m_isInitializedForDisplay) return;</span>
		else {
<span class="fc" id="L61">			super.initForDisplay();</span>

			// Add JavaScript Variables
<span class="fc" id="L64">			addJSVariable(DELETE_CONFIRMATION, m_bbmBundle, BbmWebBundleKey.ACTIVITY_DELETE_CONFIRMATION);</span>

<span class="fc" id="L66">			addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE_LIST);</span>
<span class="fc" id="L67">			setJSMediator(WfmJavaScriptFileID.MEDIATOR_ACTIVITY_WORKPANE_LIST);</span>

			// Enable Object Copy
<span class="fc" id="L70">			initCopyObjType(Activity.OBJECT_TYPE_ACTIVITY);</span>
		}
<span class="fc" id="L72">	}</span>


	/**
	 * Return instance of Model which is ready to be rendered
	 *
	 * @param context - The request context
	 * @return Activity List PageModel
	 */
	public static ActivityListPageModel getInstance(RequestContext context) {
<span class="fc" id="L82">		return (ActivityListPageModel)getInstance(context, ActivityListPageModel.class);</span>
	}

	/**
	 * get URL for HTML Form Action
	 *
	 * @return the form action
	 */
	public String getFormAction() {
<span class="fc" id="L91">		return &quot;activity_list&quot;;</span>
	}

	/**
	 * Initialize toolbar.
	 * Override default toolbar defined in WorkpaneListPageModel
	 */
	protected void initToolbar() {
		///*[Swati]: London
<span class="fc" id="L100">		String addLabel = i18n(m_bbmBundle,	BbmWebBundleKey.ACTIVITY_CREATE_NEW_ACTION);</span>
<span class="fc" id="L101">		String copyLabel = i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_COPY_ACTION);</span>
<span class="fc" id="L102">		String editLabel = i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_EDIT_ACTION);</span>
<span class="fc" id="L103">		String delLabel = i18n(m_bbmBundle,	BbmWebBundleKey.ACTIVITY_DELETE_ACTION);</span>
<span class="fc" id="L104">		useDefaultToolbar(false, addLabel, copyLabel, editLabel, delLabel);</span>
<span class="fc" id="L105">	}</span>

	/**
	 * Create the list model
	 */
	protected void createListModel(){
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">		if(!this.loadActivities()) {</span>
<span class="nc" id="L112">			return;</span>
		}

<span class="fc" id="L115">		this.removeChildComponent(m_list);</span>
<span class="fc" id="L116">		m_list = new ActivityListPC(getRequestContext(), &quot;activityTable&quot;, m_activities, true, true) {</span>
			@Override
			protected void setRowAttributes(DefaultMultiColumnNodeData mcnd, Activity activity) {
<span class="fc" id="L119">				super.setRowAttributes(mcnd, activity);</span>
<span class="fc" id="L120">				HashMap&lt;String, String&gt; nodeAttributes = mcnd.getNodeAttributes();</span>
<span class="fc" id="L121">				nodeAttributes.put(IS_EDITABLE,	isRowEditable(activity.getOrganizationId()));</span>
<span class="fc" id="L122">				nodeAttributes.put(IS_DELETEABLE, isRowDeleteable(activity.getId(), activity.getOrganizationId()));</span>
<span class="fc" id="L123">				nodeAttributes.put(IS_COPYABLE, isRowCopyable(activity.getId(), activity.getOrganizationId()));</span>
<span class="fc" id="L124">				nodeAttributes.put(COPY_ITEM_NAME, activity.getName());</span>
	
				// Check if row should be selected, assuming only one should be selected
<span class="fc bfc" id="L127" title="All 2 branches covered.">				if (OrganizationModelHandler.UNREASONABLE_ORG_ID.equals(m_selectedRowOrgID)) {</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">					if(isRowSelected(activity.getID())) {</span>
<span class="fc" id="L129">						m_list.addSelectedRowID(activity.getID().toString());</span>
<span class="fc" id="L130">						m_selectedRowOrgID = activity.getOrganizationId();</span>
					}
				}
<span class="fc" id="L133">			}</span>
		};
		
		// Enable List Sorting
		//m_list.getHeader().setDefaultSortColumn(ActivityFields.NAME_FN);				
<span class="fc" id="L138">		removeChildComponent(m_list);</span>
<span class="fc" id="L139">    	addChildComponent(m_list);</span>
<span class="fc" id="L140">		m_list.setIsAutoSortEnabled(true);</span>
<span class="fc" id="L141">		m_list.extractParameters(m_context.getRequest());</span>
		
<span class="fc" id="L143">		m_list.setMultiRowSelectable(false);</span>
<span class="fc" id="L144">	}</span>

	/**
	 * Get entity name. Used for title.
	 */
	protected String getTitleEntityType() {
<span class="fc" id="L150">		return i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LIST_TITLE);</span>
	}



	/**
	 * Loads all the activity value objects
	 *
	 * @return true if load was successful
	 */
	private boolean loadActivities() {
		try {
			// Load all the activities value objects
<span class="fc" id="L163">			m_activities = ActivityModelHandler.getActivitiesFilterActivities(m_context, getSelectedIDObject(),</span>
				new ActivityFilter(), new ID[]{Activity.ACTIVITY_DELETED});
<span class="fc" id="L165">			return true;</span>
<span class="nc" id="L166">		} catch (Exception ex) {</span>
<span class="nc" id="L167">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L168">			return false;</span>
		}
	}


	/**
	 * Return true if Current User is authorized to configure specified Organization
	 */
	protected boolean isAuthorizedToView(ID orgID) {
<span class="fc" id="L177">		return m_context.getUser().isAuthorized(PrivilegeKeys.CORE_VIEWACTIVITIES,</span>
<span class="fc" id="L178">				OrganizationScopeManagerProxy.getScopeID(orgID));</span>
	}


	/**
	 * Return true if Current User is authorized to configure specified Organization
	 */
	protected boolean isAuthorizedToConfigure(ID orgID) {
<span class="fc" id="L186">		return m_context.getUser().isAuthorized(PrivilegeKeys.CORE_EDITACTIVITIES,</span>
<span class="fc" id="L187">				OrganizationScopeManagerProxy.getScopeID(orgID));</span>
	}
	

	/**
	 * Return localized message indicating that current user is not authorized
	 * to view activities in the selected Organization.
	 */
	protected String getNotAuthorizedToViewMsg() {
<span class="nc" id="L196">		return MessageFormat.format(</span>
<span class="nc" id="L197">			i18n(m_bbmBundle, BbmWebBundleKey.NOT_AUTHORIZED_TO_VIEW_ENTITY_IN_SELECTED_ORG),</span>
<span class="nc" id="L198">			new Object[] { i18n(m_bbmBundle, BbmWebBundleKey.BBM_ORG_ACTIVITIES) } );</span>
	}

	/**
	 * Is the list row editable?
	 * Override parent to allow editing of activities defined in the root
	 *
	 * @param rowOrgID the row's organization ID
	 * @return &quot;true&quot; if a row is editable, &quot;false&quot; otherwise
	 *
	 */
	protected String isRowEditable(ID rowOrgID) {
<span class="fc bfc" id="L210" title="All 2 branches covered.">		if(rowOrgID.equals(Organization.ROOT_ORG_ID_OBJ)) {</span>
<span class="fc" id="L211">			return super.isRowEditable(Organization.YOUR_COMPANY_ID_OBJ);</span>
		}
		else {
<span class="fc" id="L214">			return super.isRowEditable(rowOrgID);</span>
		}
	}		

	/**
	 * Is the list row delete-able?
	 * Activities defined in the root should never be deleteable
	 *
	 * @param rowOrgID the row's organization ID
	 * @return &quot;true&quot; if a row is editable, &quot;false&quot; otherwise
	 *
	 */
	protected String isRowDeleteable(ID activityID, ID rowOrgID) {
<span class="fc bfc" id="L227" title="All 2 branches covered.">		if ( rowOrgID.equals(Organization.ROOT_ORG_ID_OBJ)</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">				|| NO_DELETION_ACTIVITIES.contains(activityID) ) {			</span>
<span class="fc" id="L229">			return &quot;false&quot;;</span>
		}
		else {
<span class="fc" id="L232">			String deleteable = &quot;false&quot;;</span>

<span class="fc" id="L234">			ID selectedOrgID = getSelectedIDObject();</span>
<span class="fc" id="L235">			boolean isAuthorizedToDelete= m_context.getUser().isAuthorized(PrivilegeKeys.CORE_DELETEACTIVITIES,</span>
<span class="fc" id="L236">					OrganizationScopeManagerProxy.getScopeID(selectedOrgID)); </span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">			if ( selectedOrgID != null &amp;&amp;</span>
<span class="pc bpc" id="L238" title="1 of 4 branches missed.">					 selectedOrgID.equals(rowOrgID) &amp;&amp; isAuthorizedToDelete ) {</span>
<span class="fc" id="L239">				deleteable = &quot;true&quot;;</span>
			}

<span class="fc" id="L242">			return deleteable;</span>
		}
	}

	/**
	 * Is the list row copy-able?
	 * Activities defined in the root should never be copyable
	 *
	 * @param rowOrgID the row's organization ID
	 * @return &quot;true&quot; if a row is editable, &quot;false&quot; otherwise
	 *
	 */
	protected String isRowCopyable(ID activityID, ID rowOrgID) {
<span class="fc bfc" id="L255" title="All 2 branches covered.">		if ( rowOrgID.equals(Organization.ROOT_ORG_ID_OBJ)</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">				|| NO_DELETION_ACTIVITIES.contains(activityID) ) {			</span>
<span class="fc" id="L257">			return &quot;false&quot;;</span>
		}
		else {
<span class="fc" id="L260">			return super.isRowEditable(rowOrgID);</span>
		}
	}


	/**
	 * is the edit/delete actions should be enabled?
	 * Override parent to allow editing of activities defined in the root
	 *
	 * @param isSuperEnabled the result from the super class &quot;decision&quot;
	 * @return true if super returns true and the selected row org id
	 * equals to the selected organization org id
	 */
	protected boolean isEditDeleteActionsEnabled(boolean isSuperEnabled) {
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">		if(m_selectedRowOrgID.equals(Organization.ROOT_ORG_ID_OBJ)) {</span>
<span class="nc" id="L275">			boolean isEnabled = Organization.YOUR_COMPANY_ID_OBJ.equals(getSelectedIDObject());</span>
<span class="nc bnc" id="L276" title="All 4 branches missed.">			return (isEnabled &amp;&amp; isSuperEnabled);</span>
		}
		else {
<span class="fc" id="L279">			return super.isEditDeleteActionsEnabled(isSuperEnabled);</span>
		}
	}

	/**
	 * is the add action should be enabled?
	 */
	protected boolean isAddActionEnabled() {
<span class="fc" id="L287">		boolean isAuthorizedToAdd= m_context.getUser().isAuthorized(PrivilegeKeys.CORE_ADDACTIVITIES,</span>
<span class="fc" id="L288">				OrganizationScopeManagerProxy.getScopeID(getSelectedIDObject()));</span>
<span class="fc" id="L289">		return isAuthorizedToAdd;</span>
	}

	

	/**
	 * is the edit action should be enabled?
	 */
	protected boolean isEditActionEnabled() {
<span class="fc" id="L298">		boolean isSuperEnabled = super.isEditActionEnabled();</span>
<span class="fc" id="L299">		boolean isAuthorizedToEdit= m_context.getUser().isAuthorized(PrivilegeKeys.CORE_EDITACTIVITIES,</span>
<span class="fc" id="L300">				OrganizationScopeManagerProxy.getScopeID(getSelectedIDObject()));</span>
<span class="pc bpc" id="L301" title="1 of 4 branches missed.">		return isEditDeleteActionsEnabled(isSuperEnabled) &amp;&amp;isAuthorizedToEdit;</span>
	}

	/**
	 * is the delete action should be enabled?
	 * * Override parent to prevent deletion of activities defined in the root
	 */
	protected boolean isDeleteActionEnabled() {
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">		if(m_selectedRowOrgID.equals(Organization.ROOT_ORG_ID_OBJ)) {</span>
<span class="nc" id="L310">			return false;</span>
		}
		else {
<span class="fc" id="L313">			boolean isSuperEnabled = super.isDeleteActionEnabled();</span>
<span class="fc" id="L314">			boolean isAuthorizedToDelete= m_context.getUser().isAuthorized(PrivilegeKeys.CORE_DELETEACTIVITIES,</span>
<span class="fc" id="L315">					OrganizationScopeManagerProxy.getScopeID(getSelectedIDObject())); </span>
<span class="pc bpc" id="L316" title="1 of 4 branches missed.">			return isEditDeleteActionsEnabled(isSuperEnabled) &amp;&amp; isAuthorizedToDelete;</span>
		}
	}

	/**
	 * Returns true if the list support sorting.
	 * Override default toolbar defined in WorkpaneListPageModel
	 */
	protected boolean isSortSupported() {
<span class="fc" id="L325">		return true;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>