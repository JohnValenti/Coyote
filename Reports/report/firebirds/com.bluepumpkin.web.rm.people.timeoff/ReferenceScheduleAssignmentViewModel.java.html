<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ReferenceScheduleAssignmentViewModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.people.timeoff</a> &gt; <span class="el_source">ReferenceScheduleAssignmentViewModel.java</span></div><h1>ReferenceScheduleAssignmentViewModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.people.timeoff;

import java.util.Calendar;
import java.util.Collection;
import java.util.Map;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.EmployeeReferenceScheduleAssignment;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.EmployeeReferenceScheduleAssignmentUpdateParameters;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.bluepumpkin.web.bbm.campaign.sp.SchedulingPeriodUtil;
import com.verint.web.wfm.WfmModelHandler;
import com.witness.web.uif.Log;
import com.witness.web.uif.system.RequestContext;

<span class="nc" id="L22">public class ReferenceScheduleAssignmentViewModel {</span>

<span class="nc" id="L24">	protected static final Category LOG = Log.initCategory(ReferenceScheduleAssignmentViewModel.class.getName());</span>

	private static final String MULTI_VALUE_DATA = &quot;*&quot;;

	//the selected employee's have multiple reference schedule id
	boolean multiRefScheduleId;
	//the selected employee's have multiple start times
	boolean multiStartTime;
	//the selected employee's have multiple end times
	boolean multiEndTime;

	EmployeeReferenceScheduleAssignment assignment;
	//cache the schedule period name if we multiRefScheduleId is false
	String scheduleName;
	//if true then none of the employees have any actual assignments
	boolean usingFillerAssignments;

	public boolean isMultiRefScheduleId() {
<span class="nc" id="L42">		return multiRefScheduleId;</span>
	}

	public boolean isMultiStartTime() {
<span class="nc" id="L46">		return multiStartTime;</span>
	}

	public boolean isMultiEndTime() {
<span class="nc" id="L50">		return multiEndTime;</span>
	}

	private static long getLocalTimeInMilliseconds(LocalDate dt) {
<span class="nc bnc" id="L54" title="All 2 branches missed.">		if (dt == null) {</span>
<span class="nc" id="L55">			return -1;</span>
		}
<span class="nc" id="L57">		return dt.getTime(TimeZoneUtil.GMT_TIMEZONE).getTime();</span>
	}

	/*
	 * getLocalStartTime and getLocalEndTime is used to populate the current period in the popup dialog and hence we
	 * return the filler start time. getDisplayStartTime and getDisplayEndTime is used to populate the date range picker
	 * on the main window we show that as blanks initially if we do not have an actual reference schedule assignment.
	 * 
	*/
	public long getLocalStartTime(TimeZone viewingTimeZone) {
<span class="nc" id="L67">		return getLocalTimeInMilliseconds(getStartTime(viewingTimeZone));</span>
	}

	public long getLocalEndTime(TimeZone viewingTimeZone) {
<span class="nc" id="L71">		return getLocalTimeInMilliseconds(getEndTime(viewingTimeZone));</span>
	}

	public LocalDate getDisplayStartTime(TimeZone viewingTimeZone) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">		if (usingFillerAssignments) {</span>
<span class="nc" id="L76">			return null;</span>
		}
<span class="nc" id="L78">		return getStartTime(viewingTimeZone);</span>
	}

	public LocalDate getDisplayEndTime(TimeZone viewingTimeZone) {
<span class="nc bnc" id="L82" title="All 2 branches missed.">		if (usingFillerAssignments) {</span>
<span class="nc" id="L83">			return null;</span>
		}
<span class="nc" id="L85">		return getEndTime(viewingTimeZone);</span>
	}

	private LocalDate getStartTime(TimeZone viewingTimeZone) {
<span class="nc bnc" id="L89" title="All 4 branches missed.">		if (multiStartTime || assignment == null) {</span>
<span class="nc" id="L90">			return null;</span>
		}
<span class="nc" id="L92">		return new LocalDate(assignment.getStartTime(), viewingTimeZone);</span>
	}

	private LocalDate getEndTime(TimeZone viewingTimeZone) {
<span class="nc bnc" id="L96" title="All 6 branches missed.">		if (multiEndTime || assignment == null || assignment.getEndTime() == null) {</span>
<span class="nc" id="L97">			return null;</span>
		}

		//The date is stored as exclusive end date time in UTC in the database
		//convert it to a local date based on the current viewing time zone and subtract one 
		//so that it looks like it is inclusive
<span class="nc" id="L103">		LocalDate displayEndDate = new LocalDate(assignment.getEndTime(), viewingTimeZone);</span>
<span class="nc" id="L104">		displayEndDate.add(Calendar.DATE, -1);</span>
<span class="nc" id="L105">		return displayEndDate;</span>
	}

	public String getScheduleName(RequestContext context) {

<span class="nc bnc" id="L110" title="All 4 branches missed.">		if (assignment == null || usingFillerAssignments) {</span>
<span class="nc" id="L111">			return &quot;&quot;;</span>
		}

<span class="nc bnc" id="L114" title="All 2 branches missed.">		if (multiRefScheduleId) {</span>
<span class="nc" id="L115">			return MULTI_VALUE_DATA;</span>
		}

<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (scheduleName != null) {</span>
<span class="nc" id="L119">			return scheduleName;</span>
		}

<span class="nc" id="L122">		scheduleName = ReferenceScheduleAssignmentViewModel.getScheduleNameFromID(context, assignment.getSchedulingPeriodDEID());</span>
<span class="nc" id="L123">		return scheduleName;</span>
	}

	//convert the integer scheduling period id to DEID (string)
	private static ID getSchedulePeriodDEID(RequestContext context, ID spid) {
<span class="nc" id="L128">		SchedulingPeriod sp = getSchedulePeriodFromID(context, spid);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">		if (sp == null) {</span>
<span class="nc" id="L130">			return null;</span>
		}
<span class="nc" id="L132">		return sp.getDEID();</span>
	}

	//convert the string DEID to the integer ID 
	private static ID getSchedulePeriodIntId(RequestContext context, ID deid) {
<span class="nc" id="L137">		SchedulingPeriod sp = getSchedulePeriodFromID(context, deid);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">		if (sp == null) {</span>
<span class="nc" id="L139">			return null;</span>
		}
<span class="nc" id="L141">		return sp.getID();</span>
	}

	//get the SchedulingPeriod for either a string DEID or an integer ID
	private static SchedulingPeriod getSchedulePeriodFromID(RequestContext context, ID id) {
		try {
<span class="nc" id="L147">			return WfmModelHandler.getCoreCampaignManager(context).getSchedulingPeriodByID(id);</span>

<span class="nc" id="L149">		} catch (Exception e) {</span>
<span class="nc" id="L150">			LOG.warn(&quot;Exception while trying to get scheduling period by ID&quot;, e);</span>
		}
<span class="nc" id="L152">		return null;</span>
	}

	//get the scheduling period name from either a string DEID or an integer ID
	public static String getScheduleNameFromID(RequestContext context, ID spid) {
		try {
<span class="nc" id="L158">			SchedulingPeriod sp = getSchedulePeriodFromID(context, spid);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">			if (sp != null) {</span>
<span class="nc" id="L160">				ID campaignID = sp.getCampaignID();</span>
<span class="nc" id="L161">				Campaign campaign = WfmModelHandler.getCoreCampaignManager(context).getCampaignByID(campaignID);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">				if (campaign != null) {</span>
<span class="nc" id="L163">					return String.format(&quot;%s : %s&quot;, campaign.getName(), SchedulingPeriodUtil.getSPDisplay(sp, context.getLocalizer(), campaign.getTimeZone()));</span>
				}
			}

<span class="nc" id="L167">		} catch (Exception e) {</span>
<span class="nc" id="L168">			LOG.warn(&quot;Exception while trying to get schedule period name. Will use empty string for schedule period name&quot;, e);</span>
<span class="nc" id="L169">		}</span>
<span class="nc" id="L170">		return &quot;&quot;;</span>
	}

	//get the integer scheduling period id. The schedule period picker expects the integer scheduling period id
	public ID getScheduleIntID(RequestContext context) {
<span class="nc bnc" id="L175" title="All 4 branches missed.">		if (multiRefScheduleId || assignment == null) {</span>
<span class="nc" id="L176">			return ID.fromString(&quot;&quot;);</span>
		}
<span class="nc" id="L178">		return getSchedulePeriodIntId(context, assignment.getSchedulingPeriodDEID());</span>
	}

	private void ensureAssignment() {
<span class="nc bnc" id="L182" title="All 2 branches missed.">		if (assignment == null) {</span>
<span class="nc" id="L183">			assignment = new EmployeeReferenceScheduleAssignment();</span>
		}
<span class="nc" id="L185">	}</span>

	/*
		Called from the UI with the string extracted from the HTTP request.
		The UI handles scheduling period ID using the integer ID. 
		Hence this value is the string representation of the integer scheduling period ID. 
		The internal representation for scheduling period is DEID.
		So we take the string value from the HTTP request and convert it into a ID and then convert this ID to a DEID 
	*/
	public void setSpid(RequestContext context, String spid) {

<span class="nc bnc" id="L196" title="All 4 branches missed.">		if (spid == null || spid.isEmpty()) {</span>
<span class="nc" id="L197">			return;</span>
		}

<span class="nc bnc" id="L200" title="All 2 branches missed.">		if (spid.equalsIgnoreCase(MULTI_VALUE_DATA)) {</span>
<span class="nc" id="L201">			multiRefScheduleId = true;</span>
<span class="nc" id="L202">			return;</span>
		}

<span class="nc" id="L205">		ensureAssignment();</span>
<span class="nc" id="L206">		multiRefScheduleId = false;</span>
<span class="nc" id="L207">		assignment.setSchedulingPeriodDEID(getSchedulePeriodDEID(context, new ID(spid)));</span>
<span class="nc" id="L208">	}</span>

	public void setStartTime(Calendar start, boolean isMultiValue) {
<span class="nc bnc" id="L211" title="All 2 branches missed.">		if (isMultiValue) {</span>
<span class="nc" id="L212">			multiStartTime = true;</span>
<span class="nc" id="L213">			return;</span>
		}

<span class="nc bnc" id="L216" title="All 2 branches missed.">		if (start == null) {</span>
<span class="nc" id="L217">			return;</span>
		}

<span class="nc" id="L220">		ensureAssignment();</span>
<span class="nc" id="L221">		multiStartTime = false;</span>
<span class="nc" id="L222">		assignment.setStartTime(start.getTime());</span>
<span class="nc" id="L223">	}</span>

	public void setEndTime(Calendar endDatePickerCalendar, boolean isMultiValue) {

<span class="nc bnc" id="L227" title="All 2 branches missed.">		if (isMultiValue) {</span>
<span class="nc" id="L228">			multiEndTime = true;</span>
<span class="nc" id="L229">			return;</span>
		}

<span class="nc bnc" id="L232" title="All 2 branches missed.">		if (endDatePickerCalendar == null) {</span>
<span class="nc" id="L233">			return;</span>
		}

		//the UI date picker will give us an end date that is inclusive. 
		//To store it as a exclusive date and time in UTC we add a day to it in the date picker's calendar (which is in the user's viewing time zone)
		//and call getTime() which will converts it to milliseconds from epoch. 
<span class="nc" id="L239">		ensureAssignment();</span>
<span class="nc" id="L240">		endDatePickerCalendar.add(Calendar.DATE, 1);</span>
<span class="nc" id="L241">		multiEndTime = false;</span>
<span class="nc" id="L242">		assignment.setEndTime(endDatePickerCalendar.getTime());</span>
<span class="nc" id="L243">	}</span>

	public void initialize(int selectedEmployeeCount, Map&lt;ID, EmployeeReferenceScheduleAssignment&gt; assignments, Collection&lt;EmployeeReferenceScheduleAssignment&gt; fillers) {

<span class="nc" id="L247">		assignment = null;</span>

<span class="nc bnc" id="L249" title="All 2 branches missed.">		if (selectedEmployeeCount == 0) {</span>
			//no employees selected ??
<span class="nc" id="L251">			return;</span>
		}

<span class="nc bnc" id="L254" title="All 2 branches missed.">		if (assignments.isEmpty()) {</span>
			//none of the employees selected have any assignments
<span class="nc" id="L256">			usingFillerAssignments = true;</span>
<span class="nc" id="L257">			checkForMultiValues(selectedEmployeeCount, fillers);</span>
<span class="nc" id="L258">			return;</span>
		}

<span class="nc" id="L261">		usingFillerAssignments = false;</span>
<span class="nc" id="L262">		checkForMultiValues(selectedEmployeeCount, assignments.values());</span>
<span class="nc" id="L263">		return;</span>
	}

	//check assignments for multiple values and sets the multiValue members of this class accordingly
	private void checkForMultiValues(int selectedEmployeeCount, Collection&lt;EmployeeReferenceScheduleAssignment&gt; assignments) {

<span class="nc bnc" id="L269" title="All 2 branches missed.">		if (assignments.isEmpty()) {</span>
<span class="nc" id="L270">			return;</span>
		}

<span class="nc bnc" id="L273" title="All 2 branches missed.">		if (assignments.size() &lt; selectedEmployeeCount) {</span>
			//not every employee has a reference schedule assignment. 
<span class="nc" id="L275">			multiRefScheduleId = true;</span>
<span class="nc" id="L276">			multiStartTime = true;</span>
<span class="nc" id="L277">			multiEndTime = true;</span>
<span class="nc" id="L278">			return;</span>
		}

<span class="nc bnc" id="L281" title="All 2 branches missed.">		for (EmployeeReferenceScheduleAssignment refSchedule : assignments) {</span>

<span class="nc bnc" id="L283" title="All 2 branches missed.">			if (assignment == null) {</span>
<span class="nc" id="L284">				assignment = refSchedule;</span>
<span class="nc" id="L285">				continue;</span>
			}

<span class="nc bnc" id="L288" title="All 2 branches missed.">			multiRefScheduleId = multiRefScheduleId</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">					|| !RmUtil.areEqual(refSchedule.getSchedulingPeriodDEID(), assignment.getSchedulingPeriodDEID());</span>
<span class="nc bnc" id="L290" title="All 4 branches missed.">			multiStartTime = multiStartTime || !RmUtil.areEqual(refSchedule.getStartTime(), assignment.getStartTime());</span>
<span class="nc bnc" id="L291" title="All 4 branches missed.">			multiEndTime = multiEndTime || !RmUtil.areEqual(refSchedule.getEndTime(), assignment.getEndTime());</span>
<span class="nc" id="L292">		}</span>

<span class="nc" id="L294">	}</span>

	private boolean allAttributesAreMutliValued() {
<span class="nc bnc" id="L297" title="All 6 branches missed.">		return multiRefScheduleId &amp;&amp; multiStartTime &amp;&amp; multiEndTime;</span>
	}
	
	//is there a valid schedule DEID that we can use to modify the database?
	private boolean hasValidScheduleId() {
<span class="nc bnc" id="L302" title="All 4 branches missed.">		if(assignment==null || multiRefScheduleId) {</span>
<span class="nc" id="L303">			return false;</span>
		}
<span class="nc" id="L305">		ID deid = assignment.getSchedulingPeriodDEID();</span>
<span class="nc bnc" id="L306" title="All 4 branches missed.">		return deid!=null &amp;&amp; !deid.toString().isEmpty();</span>
	}

	//returns null to specify that the database should not be updated. 
	public EmployeeReferenceScheduleAssignmentUpdateParameters getUpdateAssignment() {

<span class="nc bnc" id="L312" title="All 4 branches missed.">		if (assignment == null || allAttributesAreMutliValued()) {</span>
<span class="nc" id="L313">			return null;</span>
		}

<span class="nc bnc" id="L316" title="All 4 branches missed.">		if (usingFillerAssignments &amp;&amp; !hasValidScheduleId() ) {</span>
			//there are no actual assignments in the database. 
			//The user has to specify the reference schedule to use.
<span class="nc" id="L319">			return null;</span>
		}

<span class="nc" id="L322">		EmployeeReferenceScheduleAssignmentUpdateParameters update = new EmployeeReferenceScheduleAssignmentUpdateParameters();</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">		update.setUpdateSpID(!multiRefScheduleId);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">		update.setUpdateStartTime(!multiStartTime);</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">		update.setUpdateEndTime(!multiEndTime);</span>

<span class="nc" id="L327">		update.setSchedulingPeriodDEID(assignment.getSchedulingPeriodDEID());</span>
<span class="nc" id="L328">		update.setStartTime(assignment.getStartTime());</span>
<span class="nc" id="L329">		update.setEndTime(assignment.getEndTime());</span>
<span class="nc" id="L330">		return update;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>