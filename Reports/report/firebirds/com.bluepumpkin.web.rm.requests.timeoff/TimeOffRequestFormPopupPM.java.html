<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffRequestFormPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.timeoff</a> &gt; <span class="el_source">TimeOffRequestFormPopupPM.java</span></div><h1>TimeOffRequestFormPopupPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.timeoff;

import java.rmi.RemoteException;
import java.util.*;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.PersonNameUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.profile.model.UserProfile;
import com.bluepumpkin.ejb.facade.base.FacadeException;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.requests.timeoff.waitlist.model.TOWaitlist;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.TORequestUtil;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.keys.RmJavaScriptFileID;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestFormPopupPM;
import com.bluepumpkin.web.rm.requests.RequestUtil;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.list.DualListBoxPC;
import com.witness.web.uif.pagecomponent.list.DynamicMultiColListPC;
import com.witness.web.uif.pagecomponent.list.DynamicMultiColListWithToolbarPC;
import com.witness.web.uif.pagecomponent.list.OptionData;
import com.witness.web.uif.pagecomponent.message.MessagePC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.date.DateRangePickerPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title:		     TimeOffRequestFormPopupPM
 * Description:  Time Off Request Form
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       David Su
 * @version      1.0
 */
public class TimeOffRequestFormPopupPM extends RequestFormPopupPM implements ContainersInRowsPM {
<span class="fc" id="L72">	private static final String CLASS_NAME = TimeOffRequestFormPopupPM.class.getName();</span>
<span class="fc" id="L73">	private static final Category LOGGER = Log.initCategory(CLASS_NAME);</span>
	private static final String DATE_CHOICE_FN  = &quot;dateChoice&quot;;
	private static final String TIMEOFF_TYPE_FN = &quot;timeOffType&quot;;
	public static final String DEBIT_TYPE_FN   = &quot;debitType&quot;;
	private static final String REQUESTED_FOR_FN  = &quot;requestedFor&quot;;
	private static final String REQUEST_STATUS_FN = &quot;requestStatus&quot;;
	private static final String REQUEST_ADDTOWL_FN = &quot;addToWL&quot;;
	private static final String REQUEST_WL_EXPIRYDATE_FN = &quot;wlExpiryDate&quot;;
    private static final String WAITLIST_TO_CHOICE = &quot;waitlistTOChoiceUserRank&quot;;
    private static final String WAITLIST_ELIGIBLE_TO_CHOICE = &quot;waitlistEligibleTOChoiceID&quot;;

	private static final int TIME_INTERVAL = 15;

	private final DateRangePickerPC m_dateRangePickerPC;
	private FormTwoColumnPC m_mainContainerPC;
	private DynamicMultiColListWithToolbarPC m_choiceListPC;
	private final TimeOffCalendarPC m_timeOffCalPC;
	private final DualListBoxPC m_dualListBoxPC;

	private final ContainerList m_containerList;
	private ID m_toCalEmpID;
<span class="fc" id="L94">	private Collection&lt;EmployeeName&gt; m_empNames = Collections.emptyList();</span>
<span class="fc" id="L95">	private Collection&lt;Activity&gt; m_timeoffTypeList = Collections.emptyList();</span>
	private TORequest m_timeoffRequest;
	protected OrganizationSetting m_orgSetting;
	private TOPool m_pool;
<span class="fc" id="L99">	private boolean m_isAuthorized = true;</span>
<span class="fc" id="L100">	private boolean m_isRequestSaved = false;</span>
	private DatePickerPC m_wlExpiryDatePickerPC;
	private boolean m_addToWL;
<span class="fc" id="L103">	private int numberOfChoice = 0;</span>

	//From the Net Staffing Ribbon Selection
<span class="fc" id="L106">	private boolean m_isFromNetStaffingRibbon = false;</span>
	private Date m_ribbonStartDate;
	private Date m_ribbonEndDate;

<span class="fc" id="L110">    private int waitlistTOChoiceUserRank =-1;</span>
<span class="fc" id="L111">    private boolean validChoiceList = true;</span>
	/**
	 * Constructor
	 */
	public TimeOffRequestFormPopupPM(RequestContext context) {
<span class="fc" id="L116">		super(context, RmKeys.RH_TIMEOFF_FORM);</span>

<span class="fc" id="L118">		m_containerList = new ContainerList(this, 3);</span>
<span class="fc" id="L119">		setTimeOffRequest(new TORequest(TORequest.DL_BASIC));</span>
<span class="fc" id="L120">		m_dateRangePickerPC = initDateRangePickerPC();</span>
<span class="fc" id="L121">		addChildComponent(m_dateRangePickerPC);</span>

<span class="fc" id="L123">		initDatePickerPC();</span>

<span class="fc" id="L125">		m_timeOffCalPC = new TimeOffCalendarPC(m_context, 2, true, m_toolbar);//changed in 7.6.2 for performance</span>
<span class="fc" id="L126">		addChildComponent(m_timeOffCalPC);</span>

<span class="fc" id="L128">		m_dualListBoxPC = new DualListBoxPC(m_context);</span>
<span class="fc" id="L129">		addChildComponent(m_dualListBoxPC);</span>

<span class="fc" id="L131">		addRequiredJavaScriptFile(RmJavaScriptFileID.TIME_OFF_REQUEST_DIALOG_JS);</span>
<span class="fc" id="L132">	}</span>

	/**
	 * Return an instance of the model that is ready for rendering
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="fc" id="L138">		return getInstance(context, TimeOffRequestFormPopupPM.class);</span>
	}

	/**
	 * Initialize Model with Data
	 */
	@Override
	protected void initializeModel() {
<span class="fc bfc" id="L146" title="All 2 branches covered.">		if (m_isInitialized) {</span>
<span class="fc" id="L147">			return;</span>
		} else {
<span class="fc" id="L149">			m_isInitialized = true;</span>
		}
<span class="fc" id="L151">		boolean requestExists = true;</span>
		try	{
<span class="fc" id="L153">			ID empID = getRequestedFor();</span>
<span class="fc" id="L154">			TimeOffRequestsMH.TODetailData toData = null;</span>

<span class="fc bfc" id="L156" title="All 2 branches covered.">			TORequest aRequest = (getRequestID()==null)?null:TimeOffRequestsMH.getTORequest(getRequestID());</span>

			//make sure request has not been deleted
<span class="pc bpc" id="L159" title="1 of 4 branches missed.">			if (aRequest == null &amp;&amp; !isNew()){</span>
<span class="nc" id="L160">				requestExists = false;</span>
<span class="nc" id="L161">				this.addPageMessage(Message.ERROR_TYPE, i18n(m_bundle, RmWebBundleKey.REQUEST_NOT_FOUND_ERROR));</span>
			} else {

				// if only part of page is being refreshed, use the user input object (instead of database object) to avoid loosing user input
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">				if (&quot;REFRESH_COMPONENT_ACTION&quot;.equals(m_context.getParameter(PageAction.PAGE_ACTION))) {</span>
<span class="nc" id="L166">					aRequest = getTimeOffRequest();</span>
				}

<span class="fc" id="L169">				toData = initializeModelTimeOffData(empID, aRequest);</span>

<span class="fc" id="L171">				m_timeoffTypeList = toData.getTOTypes();</span>
<span class="fc" id="L172">				m_empNames = toData.getEmployeeNames();</span>
<span class="fc" id="L173">				m_orgSetting = toData.getOrgSetting();</span>
<span class="fc" id="L174">				m_pool = toData.getPool();</span>
<span class="fc" id="L175">				m_toCalEmpID = toData.getEmpID();</span>

				//set the date picker start dates
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">				if (m_orgSetting != null) {</span>
<span class="fc" id="L179">					setDatePickerWeekStarts(new ID(m_orgSetting.getCurrentOrgId()));</span>
				}

				// Populate Time Off Calendar PC
<span class="fc" id="L183">				m_timeOffCalPC.setOrgSetting(m_orgSetting);</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">				if (m_toCalEmpID!=null) {</span>
<span class="fc" id="L185">					m_timeOffCalPC.fetchData(m_toCalEmpID, false, null);</span>
				}

<span class="fc bfc" id="L188" title="All 2 branches covered.">				if (!isNew()) {</span>
<span class="fc" id="L189">					TORequest request = toData.getTORequest();</span>
<span class="fc" id="L190">					m_isAuthorized = RequestUtil.isAuthToUpdate(m_context, request);</span>

					// Try to keep extracted value in case of error
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">					if (hasError()) {</span>
<span class="nc" id="L194">						m_timeoffRequest.setAuditTrailList( request.getAuditTrail() );</span>
					} else {
<span class="fc" id="L196">						setTimeOffRequest(request);</span>
					}

<span class="pc bpc" id="L199" title="1 of 2 branches missed.">					if (waitlistTOChoiceUserRank == -1) {</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">						waitlistTOChoiceUserRank = m_timeoffRequest.getWaitlistTOChoice()!=null?m_timeoffRequest.getWaitlistTOChoice().getUserRank():-1;</span>
					}
				}
			}
<span class="nc" id="L204">		} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L205">			Message msg = handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L206">			msg.setAssociatedMessage(ex.getLocalizedMessage(m_localizer, m_context.getViewingTimeZone()));</span>
<span class="nc" id="L207">		} catch (Exception ex) {</span>
<span class="nc" id="L208">			handleUnableToLoadDataError(log, ex);</span>
		} finally {
<span class="pc" id="L210">			initContentTitle();</span>
<span class="pc bpc" id="L211" title="7 of 8 branches missed.">			if (requestExists) {</span>
<span class="pc" id="L212">				initContent();</span>
			} else {
<span class="nc" id="L214">				initToolbar(false);</span>
			}
<span class="pc" id="L216">			initPageMessages();</span>
<span class="pc" id="L217">		}</span>
<span class="fc" id="L218">	}</span>


	protected TimeOffRequestsMH.TODetailData initializeModelTimeOffData(ID empID, TORequest aRequest)
			throws RemoteException, BbmException, FacadeException, RmHardValidationException, Exception {
		TimeOffRequestsMH.TODetailData toData;
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">		if (isManagerMode()) {</span>
<span class="nc" id="L225">			toData = TimeOffRequestsMH.getTODetailDataForManager(m_context,</span>
<span class="nc" id="L226">					m_context.getUser(), empID, isNew(), aRequest, m_isFromNetStaffingRibbon);</span>
		} else {
<span class="fc" id="L228">			toData = TimeOffRequestsMH.getTODetailData(m_context, empID, aRequest, m_isFromNetStaffingRibbon);</span>
		}
<span class="fc" id="L230">		return toData;</span>
	}

	protected void initPageMessages() {
<span class="fc" id="L234">		int timeInterval = getTimeOffRoundInterval();</span>
<span class="fc" id="L235">		String timeOffRoundedMsg = TimeOffRequestUtil.getRoundedMsg(m_localizer,timeInterval);</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">		if (!m_timeoffTypeList.isEmpty()) {</span>
<span class="fc" id="L237">			addPageMessage(Message.INFO_TYPE, timeOffRoundedMsg);</span>
		}
<span class="fc" id="L239">	}</span>

	/**
	 * Create and add Date Range Picker as Child Component
	 */
	protected DateRangePickerPC initDateRangePickerPC() {
<span class="fc" id="L245">		DateRangePickerPC dateRangePickerPC = new DateRangePickerPC(m_context, DATE_CHOICE_FN);</span>
<span class="fc" id="L246">		dateRangePickerPC.setIsTimeEnabled(true);</span>

		// initialize date pickers properties
<span class="fc" id="L249">		DatePickerPC startDatePC = dateRangePickerPC.getStartDatePickerPC();</span>
<span class="fc" id="L250">		DatePickerPC endDatePC = dateRangePickerPC.getEndDatePickerPC();</span>
		//startDatePC.setLowerLimit(new Date());
<span class="fc" id="L252">		startDatePC.setIsDateValueOptional(true);</span>
<span class="fc" id="L253">		endDatePC.setIsDateValueOptional(true);</span>

		//set upper date limit to 12/31/2078
<span class="fc" id="L256">		Calendar cal = Calendar.getInstance(m_context.getViewingTimeZone());</span>
<span class="fc" id="L257">		cal.set(2078,11,31,23,59,59);</span>
<span class="fc" id="L258">		endDatePC.setUpperLimit(cal.getTime());</span>
<span class="fc" id="L259">		return dateRangePickerPC;</span>
	}

	/**
	 * Init waitlist date picker
	 */
    private void initDatePickerPC() {
<span class="fc" id="L266">        m_wlExpiryDatePickerPC = new DatePickerPC(m_context, REQUEST_WL_EXPIRYDATE_FN);</span>
<span class="fc" id="L267">        m_wlExpiryDatePickerPC.setLowerLimit(new Date());</span>
<span class="fc" id="L268">        m_wlExpiryDatePickerPC.setIsDateValueOptional(true);</span>
<span class="fc" id="L269">        m_wlExpiryDatePickerPC.setIsTimeEnabled(true);</span>
<span class="fc" id="L270">        addChildComponent(m_wlExpiryDatePickerPC);</span>
<span class="fc" id="L271">    }</span>

    /**
	 * Set first day of week using org week start
	 */
	private void setDatePickerWeekStarts(ID orgID) throws Exception {
<span class="fc" id="L277">		Organization org = OrganizationModelHandler.getOrganization(m_context, orgID);</span>

<span class="fc" id="L279">		m_dateRangePickerPC.setFirstDayOfWeek(org.getWeekStartDate());</span>
<span class="fc" id="L280">		m_wlExpiryDatePickerPC.setFirstDayOfWeek(org.getWeekStartDate());</span>

		//set the default time to use organization day boundary
<span class="fc" id="L283">		int dayBoundaryOffset = org.getDayBoundaryOffset();</span>
<span class="fc" id="L284">		Calendar startCal = Calendar.getInstance(m_context.getViewingTimeZone());</span>
<span class="fc" id="L285">		startCal.setTime(new Date());</span>
<span class="fc" id="L286">		startCal.set(Calendar.HOUR_OF_DAY, dayBoundaryOffset/60);</span>
<span class="fc" id="L287">		startCal.set(Calendar.MINUTE, dayBoundaryOffset%60);</span>

<span class="pc bpc" id="L289" title="1 of 2 branches missed.">		if (startCal.getTime().before(new Date())) {</span>
<span class="fc" id="L290">			startCal.add(Calendar.DATE, 1);</span>
		}

<span class="fc" id="L293">		Calendar endCal = Calendar.getInstance(m_context.getViewingTimeZone());</span>
<span class="fc" id="L294">		endCal.setTime(startCal.getTime());</span>

<span class="fc" id="L296">		endCal.add(Calendar.DATE, 1);</span>
<span class="fc" id="L297">		endCal.set(Calendar.MINUTE, dayBoundaryOffset%60-1);</span>
<span class="fc" id="L298">		m_dateRangePickerPC.getStartDatePickerPC().setDefaultDisplayDate(startCal.getTime(), m_context.getViewingTimeZone());</span>
<span class="fc" id="L299">		m_dateRangePickerPC.getEndDatePickerPC().setDefaultDisplayDate(endCal.getTime(), m_context.getViewingTimeZone());</span>
<span class="fc" id="L300">	}</span>

	/**
	 * Disable Date Range Picker to Read Only
	 */
	private void disableDateRangePickerPC() {
<span class="nc" id="L306">		m_dateRangePickerPC.setIsPickerEnabled(false);</span>
<span class="nc" id="L307">		m_dateRangePickerPC.getStartDatePickerPC().setInputType(DatePickerPC.INPUT_TYPE_READONLY);</span>
<span class="nc" id="L308">		m_dateRangePickerPC.getEndDatePickerPC().setInputType(DatePickerPC.INPUT_TYPE_READONLY);</span>
<span class="nc" id="L309">	}</span>

	/**
	 * Create Debit Drop Down Option
	 */
	private OptionData createDebitOption(String debitType) {
<span class="fc" id="L315">		String value = i18n(m_bundle, TimeOffRequestUtil.getDebitTypeRBKey(debitType));</span>
<span class="fc" id="L316">		boolean isSelected = debitType.equals( getDebitType() );</span>
<span class="fc" id="L317">		return new OptionData(value, debitType, isSelected);</span>
	}

	/**
	 * Prepare content title for rendering
	 */
	protected void initContentTitle(){
<span class="fc bfc" id="L324" title="All 2 branches covered.">		String rbKey = isNew()?</span>
			RmWebBundleKey.CREATE_NEW_REQUEST:RmWebBundleKey.EDIT_REQUEST;
<span class="fc" id="L326">		String pageTitle = i18n(m_bundle, rbKey);</span>

<span class="fc" id="L328">		String itemName = i18n(m_bundle, RmWebBundleKey.REQUEST_TYPE_TIME_OFF);</span>
<span class="fc" id="L329">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="fc" id="L330">		m_contentTitlePC.setItemName(itemName);</span>
<span class="fc" id="L331">	}</span>

	/**
	 * Initialize Content
	 */
	private void initContent() {
<span class="pc bpc" id="L337" title="3 of 4 branches missed.">		if (isManagerMode() &amp;&amp; m_empNames.isEmpty()) {</span>

<span class="nc" id="L339">			String[] args = new String[1];</span>
<span class="nc" id="L340">				args[0] = m_context.getSystemManagerFactory()</span>
<span class="nc" id="L341">					  .getVerticalizationManager()</span>
<span class="nc" id="L342">					  .getVerticalizedString(m_context, DefaultVerticalizationManager.WORKERS);</span>

<span class="nc" id="L344">			addPageMessage(Message.WARNING_TYPE,</span>
				RmWebBundleKey.WARNING_NO_PRIV_FOR_TOREQ_CREATION, RmWebBundleKey.BUNDLE_NAME, args);
<span class="nc" id="L346">			initToolbar(false);</span>
<span class="nc" id="L347">		} else {</span>
<span class="fc" id="L348">			addMsgIfNoTOTypes();</span>
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">			if (m_isAuthorized) {</span>
<span class="fc" id="L350">				initMainList();</span>
<span class="fc" id="L351">				initChoiceList();</span>
<span class="fc" id="L352">				initTimeOffCalendars();</span>
<span class="fc" id="L353">				initAdditionalContent();</span>
<span class="fc" id="L354">				addAccrualCalculatorToolBtn(m_toCalEmpID);</span>
<span class="fc" id="L355">				initToolbar(true);</span>
			} else {
<span class="nc" id="L357">				initToolbar(false);</span>
			}
		}

<span class="fc bfc" id="L361" title="All 2 branches covered.">		if (m_isRequestSaved) {</span>
<span class="fc" id="L362">			RequestUtil.addSavedRequestMsg(m_timeoffRequest, this);</span>
		}
<span class="fc" id="L364">	}</span>

	protected void addMsgIfNoTOTypes() {
<span class="pc bpc" id="L367" title="1 of 4 branches missed.">		if (isNew() &amp;&amp; m_timeoffTypeList.isEmpty()) {</span>
<span class="nc" id="L368">			addPageMessageNoActivities();</span>
		}
<span class="fc" id="L370">	}</span>

	protected void addPageMessageNoActivities() {
<span class="nc" id="L373">		addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.WARNING_NO_TO_ACTIVITIES, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L374">	}</span>

	protected void initAdditionalContent() {
<span class="fc" id="L377">	}</span>

	private void addAccrualCalculatorToolBtn(ID empID) {
<span class="pc bpc" id="L380" title="2 of 4 branches missed.">		boolean enabled = (empID != null &amp;&amp; !m_timeoffTypeList.isEmpty());</span>
<span class="fc" id="L381">		final String cmd = &quot;CALCULATE_TO_&quot; + empID;</span>
<span class="fc" id="L382">		addPopupArgs(cmd, &quot;to_accrual_calculator&quot;, &quot;empID=&quot; + empID, null,</span>
				&quot;480,360,ctr,ctr&quot;, true, 1);
<span class="fc" id="L384">		m_toolbar.addPopupWindowTextButton(cmd, i18n(m_bundle, RmWebBundleKey.TIMEOFF_CALCULATE_ESTIMATE), enabled);</span>
<span class="fc" id="L385">	}</span>

	/**
	 * Return Employee Name Drop Down
	 */
	private String createEmpNameDD() {
<span class="nc bnc" id="L391" title="All 2 branches missed.">		if (m_empNames.isEmpty()) {</span>
<span class="nc" id="L392">			return &quot;&quot;;</span>
		}
<span class="nc" id="L394">		ID selectedID = getRequestedFor();</span>

		// If there is only a single employee name or request has Escalated Status
		// then just return it as text
<span class="nc bnc" id="L398" title="All 4 branches missed.">		if (m_empNames.size()==1 || isEscalatedRequest()) {</span>
<span class="nc" id="L399">			EmployeeName eName = findEmpNameByID(selectedID);</span>
<span class="nc" id="L400">			return m_localizer.formatName(eName) +</span>
<span class="nc" id="L401">				HtmlUtil.makeHiddenInput(REQUESTED_FOR_FN, eName.getID().toString());</span>
		}

		// Create Employee Name Drop Down
<span class="nc" id="L405">		List sortedENames = new ArrayList(m_empNames);</span>
<span class="nc" id="L406">		PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>
<span class="nc" id="L407">		int listSize = sortedENames.size();</span>
<span class="nc" id="L408">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">		for(Iterator it = sortedENames.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L410">			EmployeeName eName = (EmployeeName)it.next();</span>
<span class="nc" id="L411">			String id = eName.getID().toString();</span>
<span class="nc" id="L412">			String display = m_localizer.formatName(eName);</span>
<span class="nc" id="L413">			StringsPair option = new StringsPair(id, display);</span>
<span class="nc" id="L414">			options.add(option);</span>
<span class="nc" id="L415">		}</span>

<span class="nc bnc" id="L417" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot;: selectedID.toString();</span>
<span class="nc" id="L418">		return HtmlUtil.makeSelectInput(REQUESTED_FOR_FN, selectedValue, &quot;jQuery(document).trigger('requestedForUpdatedEvent');reload();&quot;, options, false);</span>
	}

	/**
	 * Create Time Off Type Display
	 */
	private String createTimeOffTypeDsp() {
<span class="nc bnc" id="L425" title="All 2 branches missed.">		if (m_timeoffTypeList.isEmpty()) {</span>
<span class="nc" id="L426">			return &quot;&quot;;</span>
		}

<span class="nc" id="L429">		Activity activity = null;</span>
<span class="nc" id="L430">		ID selectedID = getTimeOffType();</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">		for(Iterator it = m_timeoffTypeList.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L432">			Activity tmpActivity = (Activity)it.next();</span>
			// Keep track of First One
<span class="nc bnc" id="L434" title="All 2 branches missed.">			if (activity==null) {</span>
<span class="nc" id="L435">				activity = tmpActivity;</span>
			}

<span class="nc bnc" id="L438" title="All 2 branches missed.">			if (tmpActivity.getID().equals(selectedID)) {</span>
<span class="nc" id="L439">				activity = tmpActivity;</span>
<span class="nc" id="L440">				break;</span>
			}
<span class="nc" id="L442">		}</span>

<span class="nc" id="L444">		return activity.getName() +</span>
<span class="nc" id="L445">			HtmlUtil.makeHiddenInput(TIMEOFF_TYPE_FN, activity.getID().toString());</span>
	}

	/**
	 * Return Time Off Type Drop Down
	 */
	private String createTimeOffTypeDD() {
		// If Request has Escalated Status then just return it as text
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">		if (isEscalatedRequest()) {</span>
<span class="nc" id="L454">			return createTimeOffTypeDsp();</span>
		}

<span class="fc" id="L457">		return m_dualListBoxPC.getPrimaryListBox();</span>
	}

	/**
	 * Return Time Off Debit Type Drop Down
	 */
	protected String createDebitTypeDD() {
		// If Request has Escalated Status then just return it as text
<span class="pc bpc" id="L465" title="1 of 2 branches missed.">		if (isEscalatedRequest()) {</span>
<span class="nc" id="L466">			String debitType = getDebitType();</span>
<span class="nc" id="L467">			return i18n(m_bundle, TimeOffRequestUtil.getDebitTypeRBKey(debitType)) +</span>
<span class="nc" id="L468">				HtmlUtil.makeHiddenInput(DEBIT_TYPE_FN, debitType);</span>
		}

<span class="fc" id="L471">		return m_dualListBoxPC.getSecondaryListBox();</span>
	}

	/**
	 * Create Comment History Page Component
	 */
	private MessagePC createCommentHistoryPC() {
<span class="fc" id="L478">		MessagePC msgPC = RequestUtil.createCmntMsgPC(m_context, &quot;510px&quot;, &quot;50px&quot;,</span>
				&quot;&quot;);
<span class="fc" id="L480">		Collection msgs = RequestUtil.getCommentsAsMessages(m_timeoffRequest);</span>
<span class="fc" id="L481">		msgPC.addMessage(msgs);</span>
<span class="fc" id="L482">		return msgPC;</span>
	}

	/**
	 * Initializes Dual List Box PC
	 */
	private void initDualListBoxPC() {
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">		if (m_timeoffTypeList.isEmpty()) {</span>
<span class="nc" id="L490">			return;</span>
		}

		// Create Debit Types for Time Off
<span class="fc" id="L494">		List timeoffDebitTypes = new ArrayList(2);</span>
		//get the config setting for the request type allowed option
<span class="fc" id="L496">		int reqTypeAllowedVal = 2;</span>
		try {
<span class="fc" id="L498">			reqTypeAllowedVal = BbmManagerFactory.getDBConfigManager().getIntValue(ConfigKey.TIMEOFF_REQUEST_TYPES_ALLOWED);</span>
<span class="nc" id="L499">		} catch(Exception ex) {</span>
<span class="nc" id="L500">			log.l7dError(&quot;failed to fetch time off request option value from BPCONFIG&quot;, ex);</span>
<span class="fc" id="L501">		}</span>

<span class="pc bpc" id="L503" title="3 of 4 branches missed.">		boolean showDebit = reqTypeAllowedVal == 1 &amp;&amp; m_timeoffRequest.getTimeOffDebitType().equals(TORequest.DEBITTYPE_DEBIT);</span>
<span class="pc bpc" id="L504" title="3 of 4 branches missed.">		boolean showDebitIf = reqTypeAllowedVal == 0 &amp;&amp; m_timeoffRequest.getTimeOffDebitType().equals(TORequest.DEBITTYPE_DEBIT_ONLY_IF);</span>
<span class="pc bpc" id="L505" title="5 of 6 branches missed.">		if (reqTypeAllowedVal == 2 || reqTypeAllowedVal == 0 || showDebit) {</span>
<span class="fc" id="L506">			timeoffDebitTypes.add( createDebitOption(TORequest.DEBITTYPE_DEBIT) );</span>
		}
<span class="pc bpc" id="L508" title="5 of 6 branches missed.">		if (reqTypeAllowedVal == 2 || reqTypeAllowedVal == 1 || showDebitIf) {</span>
<span class="fc" id="L509">			timeoffDebitTypes.add( createDebitOption(TORequest.DEBITTYPE_DEBIT_ONLY_IF) );</span>
		}

		//add appropriate page message
<span class="pc bpc" id="L513" title="1 of 2 branches missed.">		if (reqTypeAllowedVal != 2){</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">			if (showDebit) {</span>
<span class="nc" id="L515">				addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.TIMEOFF_REQ_TYPE_DEBIT_IF, RmWebBundleKey.BUNDLE_NAME);</span>
			}
<span class="nc bnc" id="L517" title="All 2 branches missed.">			if (showDebitIf) {</span>
<span class="nc" id="L518">				addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.TIMEOFF_REQ_TYPE_DEBIT, RmWebBundleKey.BUNDLE_NAME);</span>
			}
		}
		// Create Debit Types for Unavailability
<span class="fc" id="L522">		List unavailDebitTypes = new ArrayList(2);</span>
<span class="fc" id="L523">		unavailDebitTypes.add( createDebitOption(TORequest.DEBITTYPE_DONT_DEBIT) );</span>

		// Process Time Off Types
<span class="fc" id="L526">		ID selectedID = getTimeOffType();</span>
<span class="fc" id="L527">		int size = m_timeoffTypeList.size();</span>
<span class="fc" id="L528">		List pOptionList = new ArrayList( size );</span>
<span class="fc" id="L529">		Map sOptionMap = new HashMap(size);</span>
<span class="fc bfc" id="L530" title="All 2 branches covered.">		for(Iterator it = m_timeoffTypeList.iterator(); it.hasNext(); ) {</span>
<span class="fc" id="L531">			Activity activity = (Activity)it.next();</span>
<span class="fc" id="L532">			ID id = activity.getID();</span>
<span class="fc" id="L533">			OptionData od = new OptionData(activity.getName(), id.toString());</span>
<span class="fc" id="L534">			od.setSelected( id.equals(selectedID) );</span>
<span class="fc" id="L535">			pOptionList.add(od);</span>

			// Process Debit Type Map
<span class="fc" id="L538">			List sOptionList = new ArrayList(3);</span>
<span class="pc bpc" id="L539" title="1 of 2 branches missed.">			if (activity.isTimeoff()) {</span>
<span class="fc" id="L540">				sOptionList.addAll( timeoffDebitTypes );</span>
			}
<span class="pc bpc" id="L542" title="1 of 2 branches missed.">			if (activity.isUnavailability()) {</span>
<span class="nc" id="L543">				sOptionList.addAll( unavailDebitTypes );</span>
			}
<span class="fc" id="L545">			sOptionMap.put(od, sOptionList);</span>
<span class="fc" id="L546">		}</span>

<span class="fc" id="L548">		m_dualListBoxPC.setPrimaryListName(TIMEOFF_TYPE_FN);</span>
<span class="fc" id="L549">		m_dualListBoxPC.setSecondaryListName(DEBIT_TYPE_FN);</span>

<span class="fc" id="L551">		m_dualListBoxPC.setOnChange(JSUtil.ON_CHANGE);</span>
<span class="fc" id="L552">		m_dualListBoxPC.setOptionValue(pOptionList, sOptionMap);</span>
<span class="fc" id="L553">	}</span>

	/**
	 * Initialize Main List
	 */
	private void initMainList() {
<span class="fc" id="L559">		m_mainContainerPC = new FormTwoColumnPC(m_context);</span>
<span class="fc" id="L560">		m_mainContainerPC.setTitle(i18n(m_bundle, RmWebBundleKey.REQUEST_SUMMARY));</span>
<span class="fc" id="L561">		m_mainContainerPC.setSummary(i18n(m_bundle, RmWebBundleKey.TO_REQUEST_POPUP_MAIN_TABLE_SUMMARY));</span>
<span class="fc" id="L562">		m_containerList.add(m_mainContainerPC);</span>

<span class="fc" id="L564">		m_mainContainerPC.setWrapperCSSClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="fc" id="L565">		m_mainContainerPC.setLastRowType(FormTwoColumnPC.LAST_ROW_FULL);</span>

<span class="fc" id="L567">		initMainListRowEmployeeName();</span>

		// Time Off Type and Time Off Hours Drop Downs
<span class="fc" id="L570">		initMainListTimeOffTypeAndTimeOffHours();</span>

<span class="fc" id="L572">		boolean isShowWaitlistRow = initMainListRowAddToWaitlist();</span>

<span class="fc" id="L574">		initMainListRowCommentHistory();</span>

<span class="fc" id="L576">		initMainListRowAddComment();</span>

<span class="pc bpc" id="L578" title="3 of 4 branches missed.">		if (!isShowWaitlistRow &amp;&amp; isAccessibilityMode())</span>
		{
			//Fix for QC#00000: JAWS Tables dialog doesn't recognize this table unless it has 4 or more rows! Add a dummy row.
<span class="nc" id="L581">			m_mainContainerPC.addRow(&quot;&quot;, &quot;&quot;);</span>
		}

<span class="fc" id="L584">	}</span>

	/**
	 * Determine whether the logged-in user has the &quot;Use Accessiblity Compliance Mode&quot; preference set to true.
	 * @return the &quot;Use Accessiblity Compliance Mode&quot; preference.
	 */
	public boolean isAccessibilityMode()
	{
<span class="nc" id="L592">		UserProfile userProfile = (UserProfile)m_context.getAttribute(RequestContext.SESSION_SCOPE, &quot;UserProfile&quot;);</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">		if (userProfile==null) {</span>
<span class="nc" id="L594">			return false;</span>
		}

<span class="nc" id="L597">		String strVal = userProfile.loadProperty(UserPreferenceKeys.USER_ACCESSIBILITY_COMPLIANCE_MODE, &quot;false&quot;);</span>
<span class="nc" id="L598">		Boolean boolFlag = new Boolean(&quot;true&quot;.equals(strVal));</span>
<span class="nc" id="L599">		return boolFlag.booleanValue();</span>
	}

	protected void initMainListRowAddComment() {
<span class="fc" id="L603">		String commentUI = RequestUtil.createCommentUI(COMMENT_FN, getComment(), 100, 3, this, i18n(m_common_bundle, UIFWebBundleKey.ADD_COMMENT));</span>
<span class="fc" id="L604">		m_mainContainerPC.addRow(i18n(m_common_bundle, UIFWebBundleKey.ADD_COMMENT), commentUI);</span>
<span class="fc" id="L605">	}</span>

	protected void initMainListRowCommentHistory() {
<span class="fc bfc" id="L608" title="All 2 branches covered.">		if (!isNew()) {</span>
<span class="fc" id="L609">			m_mainContainerPC.addRow(i18n(m_common_bundle, UIFWebBundleKey.COMMENT_HISTORY), createCommentHistoryPC());</span>
		}
<span class="fc" id="L611">	}</span>

	protected boolean initMainListRowAddToWaitlist() {
		//add the option to add to waitlist if applicable
<span class="pc bpc" id="L615" title="1 of 2 branches missed.">		boolean isShowWaitlistRow = (TORequestUtil.isTOWaitlistFeatureEnabled() &amp;&amp;</span>
<span class="pc bpc" id="L616" title="1 of 2 branches missed.">				isAuthToWaitlist() &amp;&amp;</span>
<span class="pc bpc" id="L617" title="1 of 2 branches missed.">				isWaitlistEnabledForPool());</span>

<span class="pc bpc" id="L619" title="1 of 2 branches missed.">		if (isShowWaitlistRow) {</span>
<span class="fc" id="L620">            String checkboxLabel = i18n(m_bundle, RmWebBundleKey.TIMEOFF_ADD_TO_WL);</span>
<span class="fc" id="L621">            createAndAddWaitListRow(checkboxLabel);</span>
        }
<span class="fc" id="L623">		return isShowWaitlistRow;</span>
	}

	protected void initMainListRowEmployeeName() {
<span class="pc bpc" id="L627" title="1 of 2 branches missed.">		if (isManagerMode()) {</span>
<span class="nc" id="L628">			String empNameLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.EMPLOYEE_NAME_LABEL), REQUESTED_FOR_FN);</span>
<span class="nc" id="L629">			m_mainContainerPC.addRow(empNameLabel, createEmpNameDD());</span>
		}
<span class="fc" id="L631">	}</span>

	private void initMainListTimeOffTypeAndTimeOffHours() {
<span class="fc" id="L634">		initDualListBoxPC();</span>

<span class="fc" id="L636">		String timeOffTypeLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.TIMEOFF_TYPE_LABEL), TIMEOFF_TYPE_FN);</span>
<span class="fc" id="L637">		m_mainContainerPC.addRow(timeOffTypeLabel, createTimeOffTypeDD());</span>

<span class="fc" id="L639">		initMainListTimeOffHours();</span>
<span class="fc" id="L640">	}</span>

	protected void initMainListTimeOffHours() {
<span class="fc" id="L643">		String timeOffDebitLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.TIMEOFF_HOURS_LABEL), DEBIT_TYPE_FN);</span>
<span class="fc" id="L644">		m_mainContainerPC.addRow(timeOffDebitLabel, createDebitTypeDD());</span>
<span class="fc" id="L645">	}</span>

	/**
	 * Return true if User is authorized to waitlist a Request.
	 */
	protected boolean isAuthToWaitlist()
	{
<span class="fc" id="L652">		return m_context.getUser().isAuthorized(PrivilegeKeys.TOM_ADDREQUESTTOWAITLIST_ID);</span>
	}

	private boolean isWaitlistEnabledForPool()
	{
<span class="pc bpc" id="L657" title="2 of 4 branches missed.">		return m_pool != null &amp;&amp; m_pool.isWaitlistEnabled();</span>
	}

    /**
     * Create the waitlist row, which has the &quot;Add to Waitlist if not Approvable&quot; checkbox and expiry date.
     * @param checkboxLabel For 508 Accessibility compliance, we need the label text for the checkbox.
     * @return The HTML for the waitlist row.
     */
	private String createAndAddWaitListRow(String checkboxLabel)
    {
<span class="fc" id="L667">		StringBuffer sb = new StringBuffer(100);</span>

<span class="pc bpc" id="L669" title="3 of 6 branches missed.">		boolean canBeAddedToWL = isAuthToWaitlist() &amp;&amp; isWaitlistEnabledForPool() &amp;&amp; TORequestUtil.isTOWaitlistFeatureEnabled();</span>
<span class="pc bpc" id="L670" title="1 of 4 branches missed.">		if (!isNew() &amp;&amp; m_timeoffRequest.getWaitlistInfo()==null) {</span>
<span class="pc bpc" id="L671" title="3 of 4 branches missed.">			canBeAddedToWL = m_timeoffRequest.isEligibleForWaitlist() &amp;&amp; isAuthToWaitlist();</span>
		}

<span class="fc" id="L674">        HtmlChoiceInput wlInput = new HtmlChoiceInput();</span>
<span class="fc" id="L675">		sb.append(wlInput.getChkBoxInput(REQUEST_ADDTOWL_FN, REQUEST_ADDTOWL_FN, checkboxLabel,</span>
<span class="pc bpc" id="L676" title="2 of 6 branches missed.">                m_timeoffRequest.getWaitlistInfo()!=null || m_addToWL, !canBeAddedToWL, &quot;&quot;, true));</span>

<span class="fc" id="L678">		sb.append(HtmlUtil.NBSP + HtmlUtil.NBSP + HtmlUtil.NBSP + HtmlUtil.NBSP);</span>
<span class="fc" id="L679">		sb.append(i18n(m_bundle, RmWebBundleKey.TIMEOFF_WL_EXPIRY_DATE));</span>

<span class="pc bpc" id="L681" title="1 of 2 branches missed.">		if (m_timeoffRequest.getWaitlistInfo()!=null) {</span>
<span class="nc" id="L682">			m_wlExpiryDatePickerPC.setDate(m_timeoffRequest.getWaitlistInfo().getTOWaitlistExpiryDate());</span>
		}
<span class="fc" id="L684">		m_wlExpiryDatePickerPC.setIsPickerEnabled(canBeAddedToWL);</span>
<span class="fc" id="L685">		sb.append(m_wlExpiryDatePickerPC.getHtmlDisplay());</span>

<span class="pc bpc" id="L687" title="3 of 4 branches missed.">		if (m_timeoffRequest.isWaitlisted() &amp;&amp; !com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil.isWaitListRankOnRqPageDisabled()) {//Waitlist Rank</span>
<span class="nc" id="L688">			sb.append(HtmlUtil.NBSP + HtmlUtil.NBSP + HtmlUtil.NBSP + HtmlUtil.NBSP);</span>
<span class="nc" id="L689">			sb.append(i18n(m_bundle, RmWebBundleKey.TIMEOFF_WAITLIST_RANK));</span>
<span class="nc" id="L690">			sb.append(HtmlUtil.NBSP);</span>
<span class="nc" id="L691">			sb.append(TimeOffRequestsMH.getWaitlistRank(m_timeoffRequest.getID()));</span>
		}

<span class="fc" id="L694">        m_mainContainerPC.addRow(checkboxLabel, sb.toString());</span>
<span class="fc" id="L695">		return sb.toString();</span>
	}

	/**
	 * Initialize Choise List
	 */
	public void initChoiceList() {
<span class="fc" id="L702">		m_choiceListPC = new DynamicMultiColListWithToolbarPC(m_context);</span>

<span class="pc bpc" id="L704" title="1 of 2 branches missed.">		m_choiceListPC.setEnabled( !isTOChoiceEditDisabled() );</span>
<span class="fc" id="L705">		m_choiceListPC.setPaddingBottom(&quot;10px&quot;);</span>
<span class="fc" id="L706">		m_containerList.add(m_choiceListPC);</span>
<span class="pc bpc" id="L707" title="1 of 2 branches missed.">		if (!m_choiceListPC.isEnabled()) {</span>
<span class="nc" id="L708">			disableDateRangePickerPC();</span>
		}

		// Init List
<span class="fc" id="L712">		DynamicMultiColListPC listPC = m_choiceListPC.getDynamicMultiColList();</span>
<span class="fc" id="L713">		listPC.setHeightInPixels(110);</span>
<span class="fc" id="L714">		listPC.setIsRowNumberEnabled(true);</span>
<span class="fc" id="L715">		listPC.disableRepeatHeader();</span>
<span class="fc" id="L716">		listPC.setTableAttribute(&quot;summary&quot;, i18n(m_bundle, RmWebBundleKey.TO_REQUEST_POPUP_CHOICES_TABLE_SUMMARY));</span>

		// Init Header
<span class="fc" id="L719">		TableHeaderPC headerPC = listPC.getHeader();</span>
<span class="fc" id="L720">		headerPC.addColumnHeaderData(&quot;&quot;, i18n(m_bundle, RmWebBundleKey.TIMEOFF_CHOICES));</span>
<span class="fc" id="L721">		headerPC.addColumnHeaderData(&quot;&quot;, i18n(m_common_bundle, UIFWebBundleKey.LENGTH));</span>
<span class="fc" id="L722">		headerPC.addColumnHeaderData(&quot;&quot;, i18n(m_bundle, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_LABEL));</span>
<span class="fc" id="L723">		headerPC.addColumnHeaderData(&quot;&quot;, i18n(m_bundle, RmWebBundleKey.TIMEOFF_CHOICES_ALERTS));</span>

		// Init Template Node
<span class="fc" id="L726">		DefaultMultiColumnNodeData tmplNodeData = getTemplateData();</span>
<span class="fc" id="L727">		listPC.setTemplateNodeData(tmplNodeData);</span>

		// Populdate List Model
<span class="fc" id="L730">		List&lt;DefaultMultiColumnNodeData&gt; listModel = getChoiceDateList();</span>
<span class="fc" id="L731">		listPC.setListModel(listModel);</span>
<span class="fc" id="L732">	}</span>

	/**
	 * Return Template Row Data
	 */
	protected DefaultMultiColumnNodeData getTemplateData() {
<span class="fc" id="L738">		return createChoiceRowData(&quot;_&quot;, 0, null);</span>
	}

	/**
	 * Create Choice Row Data
	 */
	private DefaultMultiColumnNodeData createChoiceRowData(String rowID, int index, TOChoice choice) {

<span class="fc bfc" id="L746" title="All 2 branches covered.">		Date startDate = (choice==null) ? null : choice.getStartDate();</span>
<span class="fc bfc" id="L747" title="All 2 branches covered.">		Date endDate = (choice==null) ? null : choice.getEndDate();</span>

		// Initialize Date Range
<span class="fc" id="L750">		m_dateRangePickerPC.setDateInputIndex(index);</span>
<span class="fc" id="L751">		m_dateRangePickerPC.getStartDatePickerPC().setDate(startDate);</span>
<span class="fc" id="L752">		m_dateRangePickerPC.getEndDatePickerPC().setDate(endDate);</span>

<span class="pc bpc" id="L754" title="1 of 2 branches missed.">		if (m_dateRangePickerPC != null) {</span>
<span class="fc" id="L755">			m_wlExpiryDatePickerPC.setUpperLimit(m_dateRangePickerPC.getStartDatePickerPC().getDate());</span>
		}

<span class="fc" id="L758">		DefaultMultiColumnNodeData tmplNodeData = new DefaultMultiColumnNodeData(rowID);</span>
<span class="fc" id="L759">		tmplNodeData.add(m_dateRangePickerPC.getHtmlDisplay());</span>
<span class="fc" id="L760">		String[] lenngthHoursAlerts = getTimeOffChoiceLenAndAlerts(choice, m_localizer, m_view_tz, m_bundle, m_timeoffRequest.isApproved(), this.validChoiceList);</span>
<span class="fc bfc" id="L761" title="All 2 branches covered.">		for (String data : lenngthHoursAlerts) {</span>
<span class="fc" id="L762">			tmplNodeData.add(data);</span>
		}

<span class="fc" id="L765">		return tmplNodeData;</span>
	}

	protected String[] getTimeOffChoiceLenAndAlerts(TOChoice choice, Localizer localizer, TimeZone tz, ResourceBundle rmBundle, boolean isApproved, boolean hasValidChoiceList) {
<span class="fc" id="L769">		return TimeOffRequestUtil.getTimeOffChoiceLenAndAlertsWithPrintAccountedHours(choice, localizer, tz, rmBundle, isApproved, false, hasValidChoiceList);</span>
	}

	/**
	 * Return Choice Date List Model
	 */
	protected List&lt;DefaultMultiColumnNodeData&gt; getChoiceDateList()
	{
<span class="fc" id="L777">		List&lt;DefaultMultiColumnNodeData&gt; listModel = new ArrayList&lt;DefaultMultiColumnNodeData&gt;();</span>
		@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L779">		Collection&lt;TOChoice&gt; choiceList = m_timeoffRequest.getRequestChoiceList();</span>

<span class="fc bfc" id="L781" title="All 2 branches covered.">		if (choiceList.isEmpty())</span>
		{
<span class="pc bpc" id="L783" title="1 of 2 branches missed.">			if (!m_isFromNetStaffingRibbon)</span>
			{
<span class="fc" id="L785">				DefaultMultiColumnNodeData firstRow = createChoiceRowData(&quot;&quot;, 1, null);</span>
<span class="fc" id="L786">				listModel.add(firstRow);</span>
<span class="fc" id="L787">			}</span>
			else
			{
<span class="nc" id="L790">				TOChoice choice = new TOChoice();</span>
<span class="nc" id="L791">				choice.setStartDate(m_ribbonStartDate);</span>
<span class="nc" id="L792">				choice.setEndDate(m_ribbonEndDate);</span>
<span class="nc" id="L793">				DefaultMultiColumnNodeData firstRow = createChoiceRowData(&quot;&quot;, 1, choice);</span>
<span class="nc" id="L794">				listModel.add(firstRow);</span>
<span class="nc" id="L795">			}</span>
		}
		else
		{
<span class="pc bpc" id="L799" title="1 of 2 branches missed.">			if (isTOChoiceEditDisabled()) {</span>
<span class="nc" id="L800">				disableDateRangePickerPC();</span>
			}

<span class="fc" id="L803">            int index=1;</span>
<span class="fc bfc" id="L804" title="All 2 branches covered.">			for (TOChoice choice : choiceList) {</span>
<span class="fc" id="L805">				DefaultMultiColumnNodeData nodeData =	createChoiceRowData(&quot;&quot;, index++, choice);</span>
<span class="fc" id="L806">				listModel.add(nodeData);</span>
<span class="fc" id="L807">			}</span>
		}
<span class="fc" id="L809">		numberOfChoice = listModel.size();</span>
<span class="fc" id="L810">		return listModel;</span>
	}

	/**
	 * Init Time Off Calendar
	 */
	public void initTimeOffCalendars() {
<span class="fc" id="L817">		m_timeOffCalPC.setIsLegendButtonEnabled(true);</span>
<span class="fc" id="L818">		removeChildComponent(m_timeOffCalPC);</span>
<span class="fc" id="L819">		m_containerList.add(m_timeOffCalPC);</span>
<span class="fc" id="L820">	}</span>

	/** Return List of Containers
	 *
	 * NOTE: Items in the Collection will be treated either as Page Components or
	 *       just a basic Object.
	 */
	@Override
	public Collection getContainers() {
<span class="fc" id="L829">		return m_containerList;</span>
	}

	@Override
	protected boolean isSaveButtonEnabled() {
<span class="pc bpc" id="L834" title="1 of 2 branches missed.">		if (getTOTypeList().isEmpty()) {</span>
<span class="nc" id="L835">			return false;</span>
		}
<span class="fc" id="L837">		return RequestUtil.isRequestFormSaveBtnEnabled(m_request);</span>
	}

	protected Collection&lt;Activity&gt; getTOTypeList() {
<span class="fc" id="L841">		return m_timeoffTypeList;</span>
	}

	/**
	 * Extract parameter
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L849">		boolean success = super.extractParameters(request);</span>

<span class="pc bpc" id="L851" title="1 of 2 branches missed.">        boolean isNewTORequest= (getTimeOffRequest().getID()==null);</span>
		//also set the waitlist info
<span class="pc bpc" id="L853" title="1 of 2 branches missed.">		if (m_addToWL){</span>
<span class="nc" id="L854">			TOWaitlist waitlist = new TOWaitlist();</span>
<span class="nc" id="L855">			waitlist.setTOWaitlistCreatorID(m_context.getUser().getID());</span>
<span class="nc" id="L856">			waitlist.setTOWaitlistCreationDate(new Date());</span>
<span class="nc" id="L857">			m_timeoffRequest.setWaitlistInfo(waitlist);</span>
			//also set the expiry date
<span class="nc" id="L859">			m_wlExpiryDatePickerPC.extractParameters(request);</span>
<span class="nc" id="L860">			m_timeoffRequest.getWaitlistInfo().setTOWaitlistExpiryDate(m_wlExpiryDatePickerPC.getDate());</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">			if(m_timeoffRequest.getRequestStatus().equals(RequestAuditTrail.STATUS_DENIED)){</span>
<span class="nc" id="L862">				m_timeoffRequest.setRequestStatus(RequestAuditTrail.STATUS_PENDING);</span>
			}
<span class="nc" id="L864">		} else {</span>
			//User definitely wants to remove the Waitlist preferences &amp; also the request from Waitlist if its already waitlisted.
<span class="pc bpc" id="L866" title="2 of 4 branches missed.">			if (!m_addToWL&amp;&amp; m_timeoffRequest.getRequestStatus().equals(RequestAuditTrail.STATUS_WAITLIST)) {</span>
<span class="nc" id="L867">				m_timeoffRequest.setRequestStatus(RequestAuditTrail.STATUS_PENDING); //Auto Processing cannot revert the status to pending</span>
			}
<span class="fc" id="L869">			m_timeoffRequest.setWaitlistInfo(null);</span>

		}

		// QC 45654: Save button doesn't resubmit after request has been denied
<span class="pc bpc" id="L874" title="1 of 2 branches missed.">		if(m_timeoffRequest.getRequestStatus().equals(RequestAuditTrail.STATUS_DENIED)){</span>
<span class="nc" id="L875">			m_timeoffRequest.setRequestStatus(RequestAuditTrail.STATUS_PENDING);</span>
		}

<span class="fc" id="L878">		List sDates = m_dateRangePickerPC.getStartDatePickerPC().getDates();</span>
<span class="fc" id="L879">		List eDates = m_dateRangePickerPC.getEndDatePickerPC().getDates();</span>

<span class="fc" id="L881">		int choiceSize = sDates.size();</span>
<span class="fc bfc" id="L882" title="All 2 branches covered.">		if (choiceSize&lt;2) {</span>
			// It must be at least two choices because one is hidden
<span class="fc" id="L884">			success=false;</span>
		} else {
<span class="fc" id="L886">			ArrayList choiceList = new ArrayList(choiceSize);</span>
<span class="fc" id="L887">			int timeInterval = getTimeOffRoundInterval();</span>

<span class="fc bfc" id="L889" title="All 2 branches covered.">            for (int i=1; i&lt;choiceSize; i++) {</span>
<span class="fc" id="L890">				Date startDate = (Date)sDates.get(i);</span>
<span class="fc" id="L891">				Date endDate   = (Date)eDates.get(i);</span>

				// Round the dates to the nearest interval
<span class="pc bpc" id="L894" title="1 of 2 branches missed.">				if (startDate!=null) {</span>
<span class="fc" id="L895">					startDate = roundTOStartDateParameter(startDate,timeInterval);</span>
<span class="pc bpc" id="L896" title="1 of 2 branches missed.">					if (endDate!=null) {</span>
<span class="fc" id="L897">						endDate = roundTOEndDateParameter(endDate,timeInterval);</span>
					} else {
<span class="nc" id="L899">						endDate = TimeZoneUtil.addDay(startDate);</span>
					}
				}
<span class="fc" id="L902">				TOChoice choice = new TOChoice();</span>

<span class="pc bpc" id="L904" title="4 of 6 branches missed.">				if((isNewTORequest|| !m_addToWL) &amp;&amp; i==1){</span>
<span class="fc" id="L905">                   choice.setRank(1);</span>
<span class="nc bnc" id="L906" title="All 6 branches missed.">                }else if(!isNewTORequest &amp;&amp; m_addToWL &amp;&amp; i==waitlistTOChoiceUserRank ){</span>
<span class="nc" id="L907">                   choice.setRank(1);</span>
<span class="nc" id="L908">                   choice.setIsWaitlist(true);</span>
                }else{
<span class="nc bnc" id="L910" title="All 4 branches missed.">	                if (waitlistTOChoiceUserRank == -1 &amp;&amp; i==1){</span>
<span class="nc" id="L911">		                choice.setRank(1);</span>
	                }else{
<span class="nc" id="L913">                        choice.setRank(0);</span>
	                }
                }
<span class="fc" id="L916">                choice.setUserRank(i);</span>
<span class="fc" id="L917">				choice.setStartDate(startDate);</span>
<span class="fc" id="L918">				choice.setEndDate(endDate);</span>
<span class="fc" id="L919">				choiceList.add(choice);</span>
			}
<span class="fc" id="L921">			m_timeoffRequest.setRequestChoiceList(choiceList);</span>
		}



<span class="fc" id="L926">		return success;</span>
	}

	protected Date roundTOStartDateParameter(Date startDate, int timeInterval) {
<span class="fc" id="L930">		return  TimeOffRequestUtil.roundToNearestInterval(m_context.getViewingTimeZone(),startDate,timeInterval);</span>
	}
	protected Date roundTOEndDateParameter(Date endDate,int timeInterval) {
<span class="fc" id="L933">		return TimeOffRequestUtil.roundToNearestInterval(m_context.getViewingTimeZone(),endDate,timeInterval);</span>
	}

	/**
	 * Return true if choice list is valid
	 */
	private boolean isValidChoiceList() {
<span class="fc" id="L940">		validChoiceList = true;</span>
<span class="fc" id="L941">		Collection choiceList = m_timeoffRequest.getRequestChoiceList();</span>

<span class="pc bpc" id="L943" title="2 of 4 branches missed.">		if (choiceList!=null &amp;&amp; !choiceList.isEmpty()) {</span>
<span class="fc" id="L944">			int i=1;</span>
<span class="fc bfc" id="L945" title="All 2 branches covered.">			for (Iterator it=choiceList.iterator(); it.hasNext(); ) {</span>
<span class="fc" id="L946">				TOChoice choice = (TOChoice)it.next();</span>
<span class="fc" id="L947">				Date sDate = choice.getStartDate();</span>
<span class="fc" id="L948">				Date eDate = choice.getEndDate();</span>
<span class="pc bpc" id="L949" title="2 of 4 branches missed.">				long duration = sDate!=null &amp;&amp; eDate!=null?eDate.getTime() - sDate.getTime():0;</span>
<span class="fc" id="L950">				long maxDuration = 2*365*24*60*60*1000L;</span>
<span class="pc bpc" id="L951" title="2 of 4 branches missed.">				if (sDate==null || eDate==null) {</span>
<span class="nc" id="L952">					addChoiceErrorMsg(i, RmWebBundleKey.TIMEOFF_CHOICE_ERROR_BLANK);</span>
<span class="nc" id="L953">					validChoiceList = false;</span>
<span class="pc bpc" id="L954" title="1 of 2 branches missed.">				} else if (sDate.equals(eDate)) {</span>
<span class="nc" id="L955">					addChoiceErrorMsg(i, RmWebBundleKey.TIMEOFF_CHOICE_ERROR_SAMETIME);</span>
<span class="nc" id="L956">					validChoiceList = false;</span>
<span class="pc bpc" id="L957" title="1 of 2 branches missed.">				} else if (duration &gt; maxDuration){//duration greater than 2 years</span>
<span class="nc" id="L958">					addChoiceErrorMsg(i, RmWebBundleKey.TIMEOFF_CHOICE_DURATION_ERROR);</span>
<span class="nc" id="L959">					validChoiceList = false;</span>
				}
<span class="fc" id="L961">				i++;</span>
<span class="fc" id="L962">			}</span>
<span class="fc" id="L963">		} else {</span>
<span class="nc" id="L964">			addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.TIMEOFF_CHOICE_ERROR_NONE, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L965">			validChoiceList = false;</span>
		}

<span class="fc" id="L968">		return validChoiceList;</span>
	}

	/**
	 * Return true if choice list is valid
	 */
    private boolean isValidExpiryDate() {
<span class="fc" id="L975">        return true;</span>
    }

	private void addChoiceErrorMsg(int num, String rbKey) {
<span class="nc" id="L979">		String[] args = new String[]{m_localizer.formatNumber(num)};</span>
<span class="nc" id="L980">		addPageMessage(Message.ERROR_TYPE, rbKey, RmWebBundleKey.BUNDLE_NAME, args);</span>
<span class="nc" id="L981">	}</span>

	/**
	 * Validate Data to be valid
	 */
	@Override
	public boolean validate() {
<span class="fc" id="L988">		boolean success = super.validate();</span>

<span class="pc bpc" id="L990" title="1 of 2 branches missed.">		if (!isValidChoiceList()) {</span>
<span class="nc" id="L991">			return false;</span>
		}

<span class="pc bpc" id="L994" title="1 of 2 branches missed.">		if (!isValidExpiryDate()){</span>
<span class="nc" id="L995">			return false;</span>
		}

<span class="fc" id="L998">		return success;</span>
	}

	/**
	 * Specify Employee which Request is for
	 */
	public void setRequestedFor(ID empID) {
<span class="fc" id="L1005">		m_timeoffRequest.setEmployeeID(empID);</span>
<span class="fc" id="L1006">	}</span>

	/**
	 * Return Employee which Request is for
	 */
	public ID getRequestedFor() {
<span class="fc" id="L1012">		ID id = m_timeoffRequest.getEmployeeID();</span>

<span class="pc bpc" id="L1014" title="1 of 4 branches missed.">		if (!isManagerMode() &amp;&amp; id==null) {</span>
<span class="fc" id="L1015">			id = m_context.getUser().getEmployeeID();</span>
		}

<span class="fc" id="L1018">		return id;</span>
	}

	/**
	 * Set the Time Off Request to be used
	 */
	public void setTimeOffRequest(TORequest request) {
<span class="fc" id="L1025">		m_timeoffRequest = request;</span>
<span class="fc" id="L1026">		m_request = request;</span>
<span class="fc" id="L1027">	}</span>

	/**
	 * Return the Time Off Request
	 */
	public TORequest getTimeOffRequest() {
<span class="fc" id="L1033">		return m_timeoffRequest;</span>
	}

	/**
	 * Set Time Off Type ID
	 */
	public void setTimeOffType(ID id) {
<span class="fc" id="L1040">		m_timeoffRequest.setTimeOffType(id);</span>
<span class="fc" id="L1041">	}</span>

	/**
	 * Return Time Off Type ID
	 */
	public ID getTimeOffType() {
<span class="fc" id="L1047">		return m_timeoffRequest.getTimeOffType();</span>
	}



	/**
	 * Set isFromNetStaffingRibbon
	 */
	public void setIsFromNetStaffingRibbon(String val) {
<span class="pc bpc" id="L1056" title="1 of 2 branches missed.">		if (val.equals(&quot;true&quot;))</span>
		{
<span class="nc" id="L1058">			m_isFromNetStaffingRibbon = true;</span>
			//Set default activity as VTO only if no activity has been selected by the user.
<span class="nc bnc" id="L1060" title="All 2 branches missed.">			if(getTimeOffType()==null) {</span>
<span class="nc" id="L1061">				setTimeOffType(Activity.ACTIVITY_VOLUNTARY_TIMEOFF);</span>
			}
		}
		else
		{
<span class="fc" id="L1066">			m_isFromNetStaffingRibbon = false;</span>
		}
<span class="fc" id="L1068">	}</span>

	/**
	 * Return isFromNetStaffingRibbon
	 */
	public boolean getIsFromNetStaffingRibbon() {
<span class="nc" id="L1074">		return m_isFromNetStaffingRibbon;</span>
	}

	/**
	 * Set the date at which the user's selection starts on the graph schedule view's Net Staffing ribbon.
	 * @param date
	 */
	public void setRibbonStartDate(String date)
	{
<span class="nc" id="L1083">		m_ribbonStartDate = new Date(Long.parseLong(date));</span>
<span class="nc" id="L1084">	}</span>

	/**
	 * Get the date at which the user's selection starts on the graph schedule view's Net Staffing ribbon.
	 */
	public Date getRibbonStartDate()
	{
<span class="nc" id="L1091">		return m_ribbonStartDate;</span>
	}

	/**
	 * Set the date at which the user's selection ends on the graph schedule view's Net Staffing ribbon.
	 * @param date
	 */
	public void setRibbonEndDate(String date)
	{
<span class="nc" id="L1100">		m_ribbonEndDate = new Date(Long.parseLong(date));</span>
<span class="nc" id="L1101">	}</span>

	/**
	 * Get the date at which the user's selection ends on the graph schedule view's Net Staffing ribbon.
	 */
	public Date getRibbonEndDate()
	{
<span class="nc" id="L1108">		return m_ribbonEndDate;</span>
	}

	/**
	 * Set Debit Type
	 */
	public void setDebitType(String type) {
<span class="fc" id="L1115">		m_timeoffRequest.setTimeOffDebitType(type);</span>
<span class="fc" id="L1116">	}</span>

	/**
	 * Return Debit Type
	 */
	public String getDebitType() {
<span class="fc" id="L1122">		return m_timeoffRequest.getTimeOffDebitType();</span>
	}

	/**
	 * Set Request Status
	 */
	public void setRequestStatus(String status) {
<span class="fc" id="L1129">		m_timeoffRequest.setRequestStatus(status);</span>
<span class="fc" id="L1130">	}</span>

	/**
	 * Return Request Status
	 */
	public String getRequestStatus() {
<span class="fc" id="L1136">		return m_timeoffRequest.getRequestStatus();</span>
	}

	/**
	 * Set add to wl
	 */
	public void setAddToWL(boolean addToWL) {
<span class="nc" id="L1143">		m_addToWL = true;</span>
<span class="nc" id="L1144">	}</span>

	/**
	 * Return Debit Type
	 */
	public boolean getAddToWL() {
<span class="nc bnc" id="L1150" title="All 2 branches missed.">		return m_timeoffRequest.getWaitlistInfo()!=null;</span>
	}

	/**
	 * Return true if Request is Escalated
	 */
	private boolean isEscalatedRequest() {
<span class="fc" id="L1157">		return RequestAuditTrail.STATUS_ESCALATED.equals(getRequestStatus());</span>
	}

	/**
	 * Return Required Html
	 */
	@Override
	public String getRequiredHTML() {
<span class="fc" id="L1165">		StringBuffer sb = new StringBuffer(100);</span>
<span class="fc" id="L1166">		sb.append(super.getRequiredHTML());</span>

<span class="pc bpc" id="L1168" title="1 of 2 branches missed.">		if (!isManagerMode()) {</span>
<span class="fc" id="L1169">			ID empID = m_context.getUser().getEmployeeID();</span>
<span class="fc" id="L1170">			String requestFor = HtmlUtil.makeHiddenInput(REQUESTED_FOR_FN, empID.toString());</span>
<span class="fc" id="L1171">			sb.append(requestFor);</span>
		}

<span class="fc" id="L1174">		String requestStatus = HtmlUtil.makeHiddenInput(REQUEST_STATUS_FN, m_timeoffRequest.getRequestStatus());</span>
<span class="fc" id="L1175">		sb.append(requestStatus);</span>
        //if (getWaitlistTOChoiceUserRank() != -1) {
<span class="fc" id="L1177">        sb.append(HtmlUtil.makeHiddenInput(WAITLIST_TO_CHOICE, getWaitlistTOChoiceUserRank()));</span>
       //}

<span class="pc bpc" id="L1180" title="1 of 2 branches missed.">        sb.append(HtmlUtil.makeHiddenInput(&quot;isFromNetStaffingRibbon&quot;, m_isFromNetStaffingRibbon ? &quot;true&quot; : &quot;false&quot;));</span>

<span class="fc" id="L1182">        return sb.toString();</span>
	}

	@Override
	public void setSavedRequestID(ID requsetID) {
<span class="fc" id="L1187">		m_isRequestSaved = true;</span>
<span class="fc" id="L1188">		super.setSavedRequestID(requsetID);</span>

<span class="pc bpc" id="L1190" title="1 of 2 branches missed.">		if (m_isFromNetStaffingRibbon) {</span>
<span class="nc" id="L1191">			setIsRefreshOpenerOnClose(false);</span>
		}
<span class="fc" id="L1193">	}</span>

	//////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	//////////////////////////////////////////////////////////////////////////////
	/**
	 * Return Employee Name By ID or the First One
	 */
	private EmployeeName findEmpNameByID(ID empID) {
<span class="nc" id="L1202">		EmployeeName eName = null;</span>

<span class="nc bnc" id="L1204" title="All 2 branches missed.">		for(Iterator it=m_empNames.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L1205">			EmployeeName tmpEName = (EmployeeName)it.next();</span>
			// Keep track of First Employee Name
<span class="nc bnc" id="L1207" title="All 2 branches missed.">			if (eName==null) {</span>
<span class="nc" id="L1208">				eName = tmpEName;</span>
			}

<span class="nc bnc" id="L1211" title="All 2 branches missed.">			if (tmpEName.getID().equals(empID)) {</span>
<span class="nc" id="L1212">				eName = tmpEName;</span>
<span class="nc" id="L1213">				break;</span>
			}
<span class="nc" id="L1215">		}</span>

<span class="nc" id="L1217">		return eName;</span>
	}

	/**
	 * Set the Time Off Waitlist TO ChoiceID to be used
	 */
	public void setWaitlistTOChoiceUserRank(int rank ) {
<span class="fc" id="L1224">		waitlistTOChoiceUserRank = rank;</span>
<span class="fc" id="L1225">	}</span>
	/**
	 * Return the Time Off Request
	 */
	public int getWaitlistTOChoiceUserRank() {
<span class="fc" id="L1230">		 return waitlistTOChoiceUserRank;</span>
	}
    public boolean isTOChoiceEditDisabled(){
<span class="pc bpc" id="L1233" title="1 of 2 branches missed.">		return isEscalatedRequest() ||</span>
<span class="pc bpc" id="L1234" title="1 of 2 branches missed.">				RequestAuditTrail.STATUS_WAITLIST.equals(getRequestStatus()) ||</span>
<span class="pc bpc" id="L1235" title="1 of 2 branches missed.">				m_timeoffTypeList.isEmpty();</span>
    }

    /**
	 * Initialize Component For Display
	 */
	@Override
	public void initForDisplay() {
<span class="fc" id="L1243">		super.initForDisplay();</span>
<span class="fc" id="L1244">		initForDisplayChoiceList();</span>
<span class="fc" id="L1245">	}</span>

	protected void initForDisplayChoiceList() {
		try {
<span class="fc" id="L1249">			int choiceLimit = getMaxNumberOfChoiceAllowed();</span>
<span class="fc" id="L1250">			String tableName = m_choiceListPC.getDynamicMultiColList().getName() + &quot;Ref&quot;; //refer MultiColListPC line 773</span>
<span class="fc" id="L1251">			String toolbarName = m_choiceListPC.getToolbar().getName();</span>

<span class="fc" id="L1253">			ToolbarTextButton button = (ToolbarTextButton)this.m_choiceListPC.getToolbar().getElement(PageAction.ADD);</span>
<span class="pc bpc" id="L1254" title="2 of 4 branches missed.">			if (choiceLimit == numberOfChoice || m_timeoffTypeList.isEmpty()) {</span>
<span class="nc" id="L1255">				button.setEnabled(false);</span>
			}
<span class="fc" id="L1257">			button.setAttribute(&quot;choice_limit&quot;, String.valueOf(choiceLimit));</span>
<span class="fc" id="L1258">			String onClickJS = &quot;onClickAddChoiceButton(&quot; + toolbarName + &quot;, &quot; + tableName + &quot;, &quot; + choiceLimit + &quot;, this);&quot;;</span>
<span class="fc" id="L1259">			button.getContainer().setOnClick(onClickJS);</span>
<span class="fc" id="L1260">			button.getContainer().setOnDblClick(onClickJS);</span>

<span class="fc" id="L1262">			button = (ToolbarTextButton)m_choiceListPC.getToolbar().getElement(PageAction.DELETE);</span>
<span class="fc" id="L1263">			button.setAttribute(&quot;choice_limit&quot;, String.valueOf(choiceLimit));</span>
<span class="fc" id="L1264">			onClickJS = &quot;onClickDeleteChoiceButton(&quot; + toolbarName + &quot;, &quot; + tableName + &quot;, &quot; + choiceLimit + &quot;, this);&quot;;</span>
<span class="fc" id="L1265">			button.getContainer().setOnClick(onClickJS);</span>
<span class="fc" id="L1266">			button.getContainer().setOnDblClick(onClickJS);</span>
<span class="nc" id="L1267">		} catch (Exception ex) {</span>
			//log and ignore the exception
<span class="nc" id="L1269">			log.l7dError(&quot;failed to get max number of choice for employee &quot; + getRequestedFor(), ex);</span>
<span class="fc" id="L1270">		}</span>
<span class="fc" id="L1271">	}</span>

	private int getMaxNumberOfChoiceAllowed() throws Exception {
<span class="fc" id="L1274">		int maxCount = 1;</span>
<span class="fc" id="L1275">		ID empID = getRequestedFor();</span>
<span class="pc bpc" id="L1276" title="5 of 6 branches missed.">		if (empID == null &amp;&amp; m_empNames != null &amp;&amp; m_empNames.size() &gt; 0) {</span>
<span class="nc bnc" id="L1277" title="All 2 branches missed.">			if (m_empNames.size() &gt; 1) {</span>
<span class="nc" id="L1278">				List sortedENames = new ArrayList(m_empNames);</span>
<span class="nc" id="L1279">				PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>
<span class="nc" id="L1280">				EmployeeName eName = (EmployeeName) sortedENames.iterator().next();</span>
<span class="nc" id="L1281">				empID = eName.getID();</span>
<span class="nc" id="L1282">			} else {</span>
<span class="nc" id="L1283">				EmployeeName eName = m_empNames.iterator().next();</span>
<span class="nc" id="L1284">				empID = eName.getID();</span>
			}
		}
<span class="fc" id="L1287">		OrganizationSetting orgSetting = TimeOffRequestsMH.getOrgSettingForEmployee(getRequestContext(), empID);</span>
<span class="pc bpc" id="L1288" title="1 of 2 branches missed.">		if (orgSetting != null) {</span>
<span class="fc" id="L1289">			maxCount = orgSetting.getTimeOffChoicesCount();</span>
		}
<span class="fc" id="L1291">		return maxCount;</span>
	}
	private int getTimeOffRoundInterval(){
<span class="fc" id="L1294">		int timeInterval = TIME_INTERVAL;</span>
<span class="fc" id="L1295">		ID empID = getRequestedFor();</span>
<span class="pc bpc" id="L1296" title="5 of 6 branches missed.">		if (empID == null &amp;&amp; m_empNames != null &amp;&amp; !m_empNames.isEmpty()) {</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">			if (m_empNames.size() &gt; 1) {</span>
<span class="nc" id="L1298">				List&lt;EmployeeName&gt; sortedENames = new ArrayList&lt;EmployeeName&gt;(m_empNames);</span>
<span class="nc" id="L1299">				PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>
<span class="nc" id="L1300">				EmployeeName eName = sortedENames.iterator().next();</span>
<span class="nc" id="L1301">				empID = eName.getID();</span>
<span class="nc" id="L1302">			} else {</span>
<span class="nc" id="L1303">				EmployeeName eName = m_empNames.iterator().next();</span>
<span class="nc" id="L1304">				empID = eName.getID();</span>
			}
		}
		OrganizationSetting orgSetting;
		try {
<span class="fc" id="L1309">			orgSetting = TimeOffRequestsMH.getOrgSettingForEmployee(getRequestContext(), empID);</span>
<span class="pc bpc" id="L1310" title="1 of 2 branches missed.">			if (orgSetting != null) {</span>
<span class="fc" id="L1311">				timeInterval = orgSetting.getTimeOffRoudingOption();</span>
			}
<span class="nc" id="L1313">		} catch (Exception e) {</span>
<span class="nc" id="L1314">			handleUnableToLoadDataErrorAndLogAsDebug(LOGGER, e);</span>
<span class="fc" id="L1315">		}</span>
<span class="fc" id="L1316">		return timeInterval;</span>
	}


	/**
	 * Return the JavaScript init code required by Page Component.
	 */
	@Override
	public String getJavaScriptInitCode() {
<span class="fc bfc" id="L1325" title="All 2 branches covered.">		if (m_request.getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="fc" id="L1326">			setIsRefreshOpenerOnClose(true);</span>
		}

<span class="fc" id="L1329">		return super.getJavaScriptInitCode() + getOnClickOverrideJavaScript();</span>
	}

	public String getOnClickOverrideJavaScript() {
<span class="fc" id="L1333">		StringBuffer sb = new StringBuffer();</span>

		/* The time off calendar controls should not cause the ribbon selection to be lost */
<span class="fc" id="L1336">		sb.append(&quot;\n\nvar monthDD = document.getElementById('timeOffCalMonth');\n&quot;)</span>
<span class="fc" id="L1337">		.append(&quot;if (monthDD) { monthDD.onchange = function(){notClosingWindow(); timeOffCal.onSelectMonth(this.value);}; }\n&quot;)</span>

<span class="fc" id="L1339">		.append(&quot;var yearDD = document.getElementById('timeOffCalYear');\n&quot;)</span>
<span class="fc" id="L1340">		.append(&quot;if (yearDD) { yearDD.onchange = function(){notClosingWindow(); timeOffCal.onSelectMonth(this.value);}; }\n&quot;)</span>

<span class="fc" id="L1342">		.append(&quot;var prevMonth = document.getElementById('timeOffCalPrev');\n&quot;)</span>
<span class="fc" id="L1343">		.append(&quot;if (prevMonth) { prevMonth.onclick = function(){notClosingWindow(); timeOffCal.onSelectPrev();}; }\n&quot;)</span>

<span class="fc" id="L1345">		.append(&quot;var nextMonth = document.getElementById('timeOffCalNext');\n&quot;)</span>
<span class="fc" id="L1346">		.append(&quot;if (nextMonth) { nextMonth.onclick = function(){notClosingWindow(); timeOffCal.onSelectNext();}; }\n\n&quot;);</span>
<span class="fc" id="L1347">		return sb.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>