<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AvailableTimeOffImportPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.setup.allocations</a> &gt; <span class="el_source">AvailableTimeOffImportPageModel.java</span></div><h1>AvailableTimeOffImportPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.setup.allocations;

import java.text.ParseException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.StringTokenizer;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import org.apache.commons.fileupload.FileItem;

import weblogic.wsee.util.StringUtil;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.CalendarTimeOffDay;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOIntervalAllocation;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.keys.RmJavaScriptFileID;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.bluepumpkin.web.rm.setup.RmSetupUtil;
import com.bluepumpkin.web.rm.util.ImportExportUtil;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagemodel.PopupWindowPM;
import com.witness.web.uif.pagemodel.WorkpaneFieldNames;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.IOUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;
import com.witness.web.uif.util.reflection.ParameterUtil;
import com.witness.web.uif.validator.IsPosIntegerFieldValidator;

/**
 * Title: AvailableTimeOffImportPageModel Description: Model for selecting
 * fields to import Copyright: Copyright (c) 2002 Company: Blue Pumpkin
 * Software, inc
 *
 * @author Howrd Mullings
 * @version 1.0
 * @author Truc Pham
 * @version 2.0: has Import Interval Allocation
 */
public class AvailableTimeOffImportPageModel extends PopupWindowPM {

	/**
	 *
	 */
	private static final long serialVersionUID = 1L;

	public static final String SUCCESS = &quot;SUCCESS&quot;;
	public static final String FAILED = &quot;FAILED&quot;;

	// form field names
	public static final int DAILY_ALLOCATION = 0;
	public static final int INTERVAL_ALLOCATION = 1;
	public static final String ALLOCATION_TYPE_FN = &quot;allocationType&quot;;
	public static final String DATE_FN = &quot;date&quot;;
	public static final String HOURS_FN = &quot;hours&quot;;
	public static final String DELIMITER_FN = &quot;delimiter&quot;;
	public static final String NUM_LINES_FN = &quot;numLines&quot;;
	// For Advanced RM license
	public static final String START_TIME_FN = &quot;startTime&quot;;
	public static final String END_TIME_FN = &quot;endTime&quot;;

	public static final String STORED_DATE_FORMAT = &quot;yyyy-MM-dd&quot;;

	protected ResourceBundle m_bbmBundle;
	protected ResourceBundle m_rmBundle;

<span class="fc" id="L93">	private static Category logImportPage = Log.initCategory(AvailableTimeOffImportPageModel.class.getName());</span>
<span class="nc" id="L94">	private boolean m_isInitiated = false;</span>
	private FormTwoColumnPC m_formPC;
	private FormTwoColumnPC m_formPC1;
	private MultiColListPC m_list;
	private ID m_poolID; // The Time Off Pool ID which was selected in the Time Off Pool List page
<span class="nc" id="L99">	private String m_poolName = &quot;&quot;;</span>
<span class="nc" id="L100">	private boolean hasAdvancedRMLicense = false;</span>
<span class="nc" id="L101">	private int allocationTimeOffType = DAILY_ALLOCATION;</span>
<span class="nc" id="L102">	private String intervalStartTime = &quot;&quot;;</span>
<span class="nc" id="L103">	private String intervalEndTime = &quot;&quot;;</span>
<span class="nc" id="L104">	private String valueDelimiter = &quot;&quot;;</span>
<span class="nc" id="L105">	private String ignoreNumLines = &quot;&quot;;</span>
<span class="nc" id="L106">	private String dailyPoolDate = &quot;&quot;;</span>
<span class="nc" id="L107">	private String dailyHours = &quot;&quot;;</span>

	/**
	 * Constructor
	 */
	public AvailableTimeOffImportPageModel(RequestContext context, boolean hasAdvancedLicense) {
<span class="nc" id="L113">		super(context);</span>

<span class="nc" id="L115">		hasAdvancedRMLicense = hasAdvancedLicense;</span>
<span class="nc" id="L116">		m_bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L117">		m_rmBundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>

		// Initialize Form PC==
<span class="nc" id="L120">		m_formPC = new FormTwoColumnPC(context);</span>
<span class="nc" id="L121">		addChildComponent(m_formPC);</span>

		// Initialize second Form PC==
<span class="nc" id="L124">		m_formPC1 = new FormTwoColumnPC(context);</span>
<span class="nc" id="L125">		addChildComponent(m_formPC1);</span>

		// Initialize second Form PC==
<span class="nc" id="L128">		m_list = new MultiColListPC(context);</span>
<span class="nc" id="L129">		addChildComponent(m_list);</span>

		// --- Add Toolbar
<span class="nc" id="L132">		m_toolbar = new ToolbarPC(context);</span>
<span class="nc" id="L133">		addChildComponent(m_toolbar);</span>
<span class="nc" id="L134">		addRequiredJavaScriptFile(RmJavaScriptFileID.TIME_OFF_POOL_IMPORT_DIALOG_JS);</span>

<span class="nc" id="L136">	}</span>

	public AvailableTimeOffImportPageModel(RequestContext context) {
<span class="nc" id="L139">		this(context, false);</span>
<span class="nc" id="L140">	}</span>

	public static AvailableTimeOffImportPageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L143">		return (AvailableTimeOffImportPageModel) getInstance(context, AvailableTimeOffImportPageModel.class);</span>
	}

	/**
	 * Initialize Component For Display
	 */
	@Override
	public void initForDisplay() {
<span class="nc bnc" id="L151" title="All 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L152">			return;</span>
		} else {
<span class="nc" id="L154">			super.initForDisplay();</span>

			// Component specific required JavaScript Files
<span class="nc" id="L157">			addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE_GENERIC);</span>
<span class="nc" id="L158">			addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>

		}
<span class="nc" id="L161">	}</span>

	@Override
	protected void initializeModel() {
<span class="nc bnc" id="L165" title="All 2 branches missed.">		if (m_isInitiated) {</span>
<span class="nc" id="L166">			return;</span>
		} else {
<span class="nc" id="L168">			m_isInitiated = true;</span>
		}
<span class="nc" id="L170">		setFormEncType(HtmlUtil.FORM_ENCTYPE_MULTIPART);</span>

<span class="nc" id="L172">		initTitle();</span>
<span class="nc" id="L173">		initForm();</span>
<span class="nc" id="L174">		initToolbar();</span>
<span class="nc" id="L175">	}</span>

	/**
	 * Return the form Component associated with Page Model
	 */
	@Override
	public String getHtmlDisplay() {
<span class="nc" id="L182">		StringBuilder aBuf = new StringBuilder();</span>
<span class="nc" id="L183">		aBuf.append(&quot;&lt;table width=\&quot;100%\&quot;&gt;&lt;tr&gt;&lt;td class=\&quot;normalText \&quot;&gt;&quot;);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">		if (hasAdvancedRMLicense) {</span>
<span class="nc" id="L185">			aBuf.append(i18n(RmWebBundleKey.TIMEOFF_POOL_ALLOCATION_TYPE));</span>
<span class="nc" id="L186">			aBuf.append(&quot;: &lt;/td&gt;&lt;td class=\&quot;normalText \&quot;&gt;&quot;);</span>
<span class="nc" id="L187">			aBuf.append(getAllocationTypeOptions());</span>
<span class="nc" id="L188">			aBuf.append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
			// append delimiter picker
<span class="nc" id="L190">			aBuf.append(&quot;&lt;tr&gt;&lt;td class=\&quot;normalText \&quot;&gt;&quot;);</span>
		}
		// append the file dialog
<span class="nc" id="L193">		aBuf.append(i18n(m_bbmBundle, BbmWebBundleKey.FileToImport));</span>
<span class="nc" id="L194">		aBuf.append(&quot;&lt;/td&gt;&lt;td&gt;&quot;);</span>
<span class="nc" id="L195">		aBuf.append(&quot;&lt;INPUT name=\&quot;file\&quot; type=\&quot;file\&quot; value=\&quot;&quot;);</span>
<span class="nc" id="L196">		aBuf.append(i18n(m_bbmBundle, BbmWebBundleKey.Browse));</span>
<span class="nc" id="L197">		aBuf.append(&quot;\&quot; size=\&quot;25\&quot;&gt;&quot;);</span>
<span class="nc" id="L198">		aBuf.append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
		// append delimiter picker
<span class="nc" id="L200">		aBuf.append(&quot;&lt;tr&gt;&lt;td class=\&quot;normalText \&quot;&gt;&quot;);</span>
<span class="nc" id="L201">		aBuf.append(i18n(m_bbmBundle, BbmWebBundleKey.Delimiter));</span>
<span class="nc" id="L202">		aBuf.append(&quot;&lt;/td&gt;&lt;td&gt;&quot;);</span>
<span class="nc" id="L203">		aBuf.append(getDelimiterDropDown());</span>
<span class="nc" id="L204">		aBuf.append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
		// append number of lines selection
<span class="nc" id="L206">		aBuf.append(&quot;&lt;tr&gt;&lt;td class=\&quot;normalText \&quot;&gt;&quot;);</span>
<span class="nc" id="L207">		aBuf.append(i18n(m_bbmBundle, BbmWebBundleKey.LinesToIgnore));</span>
<span class="nc" id="L208">		aBuf.append(&quot;&lt;/td&gt;&lt;td&gt;&quot;);</span>
<span class="nc" id="L209">		aBuf.append(HtmlUtil.makeTextInput(NUM_LINES_FN, 3, 8, &quot;&quot;, &quot;&quot;, true));</span>
<span class="nc" id="L210">		aBuf.append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
		// row with text for fields below
<span class="nc" id="L212">		aBuf.append(&quot;&lt;tr&gt;&lt;td class=\&quot;normalText \&quot; style=\&quot;height:22px\&quot; colspan=\&quot;2\&quot; bgcolor=\&quot;#A5BAE7\&quot;&gt;&quot;);</span>
<span class="nc" id="L213">		aBuf.append(i18n(m_bbmBundle, BbmWebBundleKey.CheckFields));</span>
<span class="nc" id="L214">		aBuf.append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
<span class="nc" id="L215">		aBuf.append(&quot;&lt;/table&gt;&quot;);</span>
<span class="nc" id="L216">		aBuf.append(m_list.getHtmlDisplay());</span>
<span class="nc" id="L217">		return aBuf.toString();</span>
	}

	/**
	 * Prepare content title for rendering
	 */
	private void initTitle() {
<span class="nc" id="L224">		m_contentTitlePC.setPageTitle(i18n(RmWebBundleKey.RM_ORG_REQUEST_PROCESSING_AVAILABLETIMEOFF_IMPORT_PAGE_TITLE));</span>
<span class="nc" id="L225">		m_contentTitlePC.setItemNameText(m_poolName);</span>
<span class="nc" id="L226">	}</span>

	/**
	 * Initialize Form Display
	 */
	protected void initForm() {
		try {
			// set list to ne unselectable
<span class="nc" id="L234">			m_list.setRowSelectable(false);</span>
<span class="nc" id="L235">			ArrayList listModel = new ArrayList();</span>

			// suffix and manager
<span class="nc bnc" id="L238" title="All 4 branches missed.">			if (hasAdvancedRMLicense &amp;&amp; getAllocationType() == INTERVAL_ALLOCATION) {</span>
<span class="nc" id="L239">				listModel.add(getNodeData(DATE_FN, getDateLabel(), HOURS_FN, getHoursLabel(), START_TIME_FN, getStartTimeLabel(),</span>
<span class="nc" id="L240">						END_TIME_FN, getEndTimeLabel()));</span>

			} else {
<span class="nc" id="L243">				listModel.add(getNodeData(DATE_FN, getDateLabel(), &quot;1&quot;, true, HOURS_FN, getHoursLabel(), &quot;2&quot;, true));</span>
			}

<span class="nc" id="L246">			m_list.setListModel(listModel);</span>
<span class="nc" id="L247">		} catch (Exception ex) {</span>
<span class="nc" id="L248">			handleUnableToLoadDataError(logImportPage, ex);</span>
<span class="nc" id="L249">		}</span>

<span class="nc" id="L251">	}</span>

	private DefaultMultiColumnNodeData getNodeData(String lStr, String lLabel, String lIndex, boolean lDisabled, String rStr,
			String rLabel, String rIndex, boolean rDisabled) {
		// Create the row data
<span class="nc" id="L256">		DefaultMultiColumnNodeData row_data = new DefaultMultiColumnNodeData();</span>

		// left column
<span class="nc" id="L259">		row_data.add(HtmlUtil.makeChkBoxInput(lStr + &quot;Cb&quot;, lStr + &quot;Cb&quot;, null, true, lDisabled) + &quot;&amp;nbsp;&quot; + lLabel);</span>
<span class="nc" id="L260">		row_data.add(HtmlUtil.makeTextInput(lStr, 1, 5, lIndex, null, &quot;changeTextField('&quot; + lStr + &quot;');&quot;, true));</span>

		// empty column
<span class="nc" id="L263">		row_data.add(&quot;&amp;nbsp;&quot;);</span>

		// right column
<span class="nc bnc" id="L266" title="All 2 branches missed.">		if (rStr != null) {</span>
<span class="nc" id="L267">			row_data.add(HtmlUtil.makeChkBoxInput(rStr + &quot;Cb&quot;, rStr + &quot;Cb&quot;, null, true, rDisabled) + &quot;&amp;nbsp;&quot; + rLabel);</span>
<span class="nc" id="L268">			row_data.add(HtmlUtil.makeTextInput(rStr, 1, 5, rIndex, null, &quot;changeTextField('&quot; + rStr + &quot;');&quot;, true));</span>
		} else {
<span class="nc" id="L270">			row_data.add(&quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L271">			row_data.add(&quot;&amp;nbsp;&quot;);</span>
		}

<span class="nc" id="L274">		return row_data;</span>
	}

	private DefaultMultiColumnNodeData getNodeData(String lStr, String lLabel, String cStr, String cLabel, String r1Str, String r1Label,
			String r2Str, String r2Label) {
		// Create the row data
<span class="nc" id="L280">		DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData(&quot;intervalRow&quot;);</span>

		// left column
<span class="nc" id="L283">		rowData.add(HtmlUtil.makeChkBoxInput(lStr + &quot;Cb&quot;, lStr + &quot;Cb&quot;, null, true, true) + &quot;&amp;nbsp;&quot; + lLabel);</span>
<span class="nc" id="L284">		rowData.add(HtmlUtil.makeTextInput(lStr, 1, 5, &quot;1&quot;, null, &quot;changeTextField('&quot; + lStr + &quot;');&quot;, true));</span>

		// center column
<span class="nc" id="L287">		rowData.add(HtmlUtil.makeChkBoxInput(cStr + &quot;Cb&quot;, cStr + &quot;Cb&quot;, null, true, true) + &quot;&amp;nbsp;&quot; + cLabel);</span>
<span class="nc" id="L288">		rowData.add(HtmlUtil.makeTextInput(cStr, 1, 5, &quot;2&quot;, null, &quot;changeTextField('&quot; + cStr + &quot;');&quot;, true));</span>

		// right column
<span class="nc" id="L291">		rowData.add(HtmlUtil.makeChkBoxInput(r1Str + &quot;Cb&quot;, r1Str + &quot;Cb&quot;, null, true, true) + &quot;&amp;nbsp;&quot; + r1Label);</span>
<span class="nc" id="L292">		rowData.add(HtmlUtil.makeTextInput(r1Str, 1, 5, &quot;3&quot;, null, &quot;changeTextField('&quot; + r1Str + &quot;');&quot;, true));</span>

<span class="nc" id="L294">		rowData.add(HtmlUtil.makeChkBoxInput(r2Str + &quot;Cb&quot;, r2Str + &quot;Cb&quot;, null, true, true) + &quot;&amp;nbsp;&quot; + r2Label);</span>
<span class="nc" id="L295">		rowData.add(HtmlUtil.makeTextInput(r2Str, 1, 5, &quot;4&quot;, null, &quot;changeTextField('&quot; + r2Str + &quot;');&quot;, true));</span>

<span class="nc" id="L297">		return rowData;</span>
	}

	/**
	 * Initialize Toolbar
	 */
	@Override
	protected void initToolbar() {
<span class="nc" id="L305">		m_toolbar.setAlignment(ToolbarPC.ALIGN_RIGHT);</span>
		// save
<span class="nc" id="L307">		m_toolbar.addSubmitTextButton(PageAction.IMPORT, i18n(m_bbmBundle, BbmWebBundleKey.SAVE), true);</span>
<span class="nc" id="L308">		m_toolbar.addCloseWindowTextButton(PageAction.DONE, i18n(m_bbmBundle, BbmWebBundleKey.CANCEL), true);</span>
<span class="nc" id="L309">	}</span>

	/**
	 * Set the validators to the form fields
	 */
	protected void initFieldValidators() {
		// Add Field Validators
<span class="nc" id="L316">		addValidator(new IsPosIntegerFieldValidator(this, DATE_FN, UIFWebBundleKey.DATE, UIFWebBundleKey.BUNDLE_NAME));</span>
<span class="nc" id="L317">		addValidator(new IsPosIntegerFieldValidator(this, HOURS_FN, UIFWebBundleKey.HOURS, UIFWebBundleKey.BUNDLE_NAME));</span>
<span class="nc" id="L318">	}</span>

	/**
	 * ============================================== Labels for the field
	 * columns ============================================
	 */

	/**
	 * Return Localized Suffix Label
	 */
	private String getDateLabel() {
<span class="nc" id="L329">		return i18n(m_common_bundle, UIFWebBundleKey.DATE);</span>
	}

	/**
	 * Return First Name Suffix Label
	 */
	private String getHoursLabel() {
<span class="nc" id="L336">		return i18n(m_common_bundle, UIFWebBundleKey.HOURS);</span>
	}

	private String getStartTimeLabel() {
<span class="nc" id="L340">		return i18n(m_common_bundle, UIFWebBundleKey.START_TIME);</span>
	}

	private String getEndTimeLabel() {
<span class="nc" id="L344">		return i18n(m_common_bundle, UIFWebBundleKey.END_TIME);</span>
	}

	public int getAllocationType() {
<span class="nc" id="L348">		String allocationTypeSession = (String) m_context.getAttribute(RequestContext.SESSION_SCOPE,</span>
				AvailableTimeOffPageModel.ALLOCATION_SESSION_KEY);
<span class="nc bnc" id="L350" title="All 2 branches missed.">		return StringUtil.isEmpty(allocationTypeSession) ? allocationTimeOffType : Integer.parseInt(allocationTypeSession);</span>
	}

	public void setAllocationType(String type) {
<span class="nc" id="L354">		allocationTimeOffType = Integer.parseInt(type);</span>
<span class="nc" id="L355">		m_context.setAttribute(RequestContext.SESSION_SCOPE, AvailableTimeOffPageModel.ALLOCATION_SESSION_KEY, type);</span>

<span class="nc" id="L357">	}</span>

	private String getAllocationTypeOptions() {
<span class="nc" id="L360">		StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L362">		int allocationType = getAllocationType();</span>
<span class="nc" id="L363">		String jsToClearSelectedFileAndRefreshPage = JSUtil.REFRESH_PAGE;</span>
<span class="nc" id="L364">		sb.append(HtmlChoiceInput.makeRadioInput(ALLOCATION_TYPE_FN, Integer.toString(DAILY_ALLOCATION),</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">				i18n(RmWebBundleKey.TIMEOFF_POOL_DAILY_ALLOCATIONS), DAILY_ALLOCATION == allocationType,</span>
				jsToClearSelectedFileAndRefreshPage));
<span class="nc" id="L367">		sb.append(HtmlUtil.NBSP);</span>
<span class="nc" id="L368">		sb.append(HtmlChoiceInput.makeRadioInput(ALLOCATION_TYPE_FN, Integer.toString(INTERVAL_ALLOCATION),</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">				i18n(RmWebBundleKey.TIMEOFF_POOL_INTERVAL_ALLOCATIONS), INTERVAL_ALLOCATION == allocationType,</span>
				jsToClearSelectedFileAndRefreshPage));
<span class="nc" id="L371">		return sb.toString();</span>
	}

	public void processUpload(RequestContext context) throws Exception {
<span class="nc" id="L375">		String pageAction = &quot;&quot;;</span>

		/*
		 * ID orgId = OrganizationUtil.getCachedOrgIDIfValid(context); if (orgId
		 * == null) { // Wrong message. This is the wrong place too. This won't
		 * show in // the parent page. addPageMessage(Message.ERROR_TYPE,
		 * UIFWebBundleKey.UNABLE_TO_LOAD_DATA, UIFWebBundleKey.BUNDLE_NAME );
		 * return; }
		 */

		try {
			// @todo: No need to manually call extraction of param since
			// framework now supports
			// multipart form just use regular setter methods. See
			// LicenseUploadPopupPM for example
<span class="nc" id="L390">			HttpServletRequest request = context.getRequest();</span>
<span class="nc" id="L391">			Map paramMap = ParameterUtil.getParameterMap(request);</span>
<span class="nc" id="L392">			Map fileMap = ParameterUtil.getExtractedFileMap(request);</span>

<span class="nc" id="L394">			FileItem file = (FileItem) fileMap.get(&quot;file&quot;);</span>
<span class="nc" id="L395">			String fileContent = IOUtil.readStringFromTextFile(file, 10 * 1024 * 1024, context);</span>

			// set pageAction
<span class="nc" id="L398">			pageAction = ParameterUtil.getParameter(paramMap, PageAction.PAGE_ACTION);</span>
			// now process the info to save data
<span class="nc" id="L400">			String delimiter = ParameterUtil.getParameter(paramMap, DELIMITER_FN);</span>
<span class="nc" id="L401">			int numLines = 0;</span>
<span class="nc" id="L402">			int colIndex = 0;</span>
			try {
<span class="nc" id="L404">				numLines = Integer.parseInt(ParameterUtil.getParameter(paramMap, NUM_LINES_FN));</span>
<span class="nc" id="L405">			} catch (Exception e) {</span>
<span class="nc" id="L406">				logImportPage.debug(e);</span>
<span class="nc" id="L407">			}</span>

<span class="nc bnc" id="L409" title="All 4 branches missed.">			if (delimiter == null || delimiter.equals(&quot;tab&quot;)) {</span>
<span class="nc" id="L410">				delimiter = &quot;\t&quot;;</span>
			}

<span class="nc" id="L413">			String str = null;</span>
<span class="nc" id="L414">			int count = 1;</span>
<span class="nc" id="L415">			HashMap atoColl = new HashMap(31);</span>
<span class="nc" id="L416">			Calendar c = new GregorianCalendar();</span>

<span class="nc" id="L418">			StringTokenizer aToken = new StringTokenizer(fileContent, &quot;\r\n&quot;);</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">			while (aToken.hasMoreTokens()) {</span>
<span class="nc" id="L420">				String data = aToken.nextToken();</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">				if (count &gt; numLines) {</span>
<span class="nc" id="L422">					List&lt;String&gt; dataList = ImportExportUtil.parseData(data, delimiter);</span>
					// create a new employee and set the fields as got from the
					// file
<span class="nc" id="L425">					CalendarTimeOffDay timeOff = new CalendarTimeOffDay();</span>
					// now populate the available timeoff object as per column
					// specified
					try {// date
<span class="nc" id="L429">						colIndex = Integer.parseInt(ParameterUtil.getParameter(paramMap, DATE_FN));</span>
<span class="nc" id="L430">						str = (String) dataList.get(colIndex - 1);</span>
<span class="nc bnc" id="L431" title="All 4 branches missed.">						if (str != null &amp;&amp; !str.equals(&quot;-1&quot;)) {</span>
<span class="nc" id="L432">							Date date = RmSetupUtil.getDateFromStr(str, m_localeContext.getRegionalFormatLocale());</span>
<span class="nc" id="L433">							timeOff.setTimeOffDate(date);</span>
						}
<span class="nc" id="L435">					} catch (Exception e) {</span>
<span class="nc" id="L436">						logImportPage.debug(e);</span>
<span class="nc" id="L437">					}</span>

					try {// hours
<span class="nc" id="L440">						colIndex = Integer.parseInt(ParameterUtil.getParameter(paramMap, HOURS_FN));</span>
<span class="nc" id="L441">						str = (String) dataList.get(colIndex - 1);</span>
<span class="nc bnc" id="L442" title="All 4 branches missed.">						if (str != null &amp;&amp; !str.equals(&quot;-1&quot;)) {</span>
<span class="nc" id="L443">							double hour = FormInputPC.convertLocalizedRealNumber(str.trim(), m_localizer);</span>
<span class="nc" id="L444">							timeOff.setAllocatedHours(hour);</span>
						}
<span class="nc" id="L446">					} catch (Exception e) {</span>
<span class="nc" id="L447">						logImportPage.debug(e);</span>
<span class="nc" id="L448">					}</span>
<span class="nc" id="L449">					Date d = timeOff.getTimeOffDate();</span>
<span class="nc bnc" id="L450" title="All 4 branches missed.">					if (d != null &amp;&amp; timeOff.getAllocatedHours() &gt;= 0) {</span>
<span class="nc" id="L451">						c.setTime(d);</span>
<span class="nc" id="L452">						Integer key = new Integer(c.get(Calendar.MONTH) * 10000 + c.get(Calendar.YEAR));</span>
<span class="nc" id="L453">						CalendarTimeOffDay al[] = (CalendarTimeOffDay[]) atoColl.get(key);</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">						if (al == null) {</span>
<span class="nc" id="L455">							atoColl.put(key, al = new CalendarTimeOffDay[31]);</span>
						}
<span class="nc" id="L457">						al[c.get(Calendar.DAY_OF_MONTH) - 1] = timeOff;</span>
					}
<span class="nc" id="L459">				} else {</span>
<span class="nc" id="L460">					count++;</span>
				}
<span class="nc" id="L462">			}</span>

			// now try to save everything
<span class="nc" id="L465">			Iterator itr = atoColl.values().iterator();</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L467">				CalendarTimeOffDay timeOffs[] = (CalendarTimeOffDay[]) itr.next();</span>
<span class="nc" id="L468">				AvailableTimeOffModelHandler.saveCalendarTimeOffDays(timeOffs, getPoolID());</span>
<span class="nc" id="L469">			}</span>
<span class="nc" id="L470">			this.setPageAction(SUCCESS);</span>

<span class="nc" id="L472">		} catch (Exception ex) {</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">			if (pageAction.equals(PageAction.IMPORT)) {</span>
<span class="nc" id="L474">				logImportPage.l7dError(RmWebLogBundleKey.UNABLE_TO_UPLOAD_DATA_FROM_FILE, ex);</span>
<span class="nc" id="L475">				throw ex;</span>
			}
<span class="nc" id="L477">		}</span>
<span class="nc" id="L478">	}</span>

	private boolean checkMinuteHasIntervalFormat(int minute) {
<span class="nc bnc" id="L481" title="All 8 branches missed.">		return minute == 0 || minute == 15 || minute == 30 || minute == 45;</span>
	}

	protected Pair&lt;LocalDate, TOIntervalAllocation&gt; buildTimeOffIntervalObjectByRawData(int[] colIndexArray, List&lt;String&gt; dataList,
			ID poolID, Localizer localizer, TimeZone orgTz) throws ParseException {
<span class="nc" id="L486">		Pair&lt;LocalDate, TOIntervalAllocation&gt; result = new Pair&lt;LocalDate, TOIntervalAllocation&gt;(null, null);</span>
<span class="nc" id="L487">		TOIntervalAllocation timeOffInterval = new TOIntervalAllocation();</span>
		String strDate;
		String strStartTime;
		String strEndTime;
		String strHour;
<span class="nc" id="L492">		LocalDate shortDate = null;</span>
		// Date
<span class="nc" id="L494">		strDate = dataList.get(colIndexArray[0] - 1);</span>

<span class="nc bnc" id="L496" title="All 4 branches missed.">		if (strDate != null &amp;&amp; !(&quot;-1&quot;).equals(strDate)) {</span>
<span class="nc" id="L497">			shortDate = RmSetupUtil.getLocaleDateFromStr(strDate, localizer.getLocaleContext().getRegionalFormatLocale(), 0, 0);</span>

<span class="nc" id="L499">			strStartTime = dataList.get(colIndexArray[2] - 1);</span>
<span class="nc" id="L500">			Date startDate = buildDateFromStr(strDate, strStartTime, localizer, orgTz);</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">			if (startDate != null) {</span>
<span class="nc" id="L502">				timeOffInterval.setStartTime(startDate);</span>
			}

<span class="nc" id="L505">			strEndTime = dataList.get(colIndexArray[3] - 1);</span>
<span class="nc" id="L506">			Date endDate = buildDateFromStr(strDate, strEndTime, localizer, orgTz);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">			if (endDate != null) {</span>
<span class="nc" id="L508">				timeOffInterval.setEndTime(endDate);</span>
			}
		}
		// hours
<span class="nc" id="L512">		strHour = dataList.get(colIndexArray[1] - 1);</span>
<span class="nc bnc" id="L513" title="All 4 branches missed.">		if (strHour != null &amp;&amp; !(&quot;-1&quot;).equals(strHour)) {</span>
<span class="nc" id="L514">			float hour = (float) RmSetupUtil.convertLocalizedRealNumber(strHour.trim(), localizer);</span>
<span class="nc" id="L515">			timeOffInterval.setAllocatedHours(hour);</span>
		}
<span class="nc" id="L517">		timeOffInterval.setTOPoolID(poolID);</span>
		//Validate before return result
<span class="nc bnc" id="L519" title="All 4 branches missed.">		if (shortDate != null &amp;&amp; isIntervalValid(timeOffInterval)) {</span>
<span class="nc" id="L520">			result.setPair(shortDate, timeOffInterval);</span>
		}

<span class="nc" id="L523">		return result;</span>
	}

	private Date buildDateFromStr(String strDate, String strHourMinute, Localizer localizer, TimeZone orgTz) throws ParseException {
<span class="nc" id="L527">		Date resultDate = null;</span>
<span class="nc bnc" id="L528" title="All 4 branches missed.">		if (strHourMinute != null &amp;&amp; !(&quot;-1&quot;).equals(strHourMinute)) {</span>
<span class="nc" id="L529">			int[] hourminute = RmSetupUtil.getHourMinuteFromStrTime(strHourMinute, localizer);</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">			if (checkMinuteHasIntervalFormat(hourminute[1])) {</span>
<span class="nc" id="L531">				resultDate = RmSetupUtil.getFullDate(strDate, localizer.getLocaleContext().getRegionalFormatLocale(), orgTz, hourminute[0],</span>
						hourminute[1]);
			}
		}
<span class="nc" id="L535">		return resultDate;</span>
	}

	private boolean isIntervalValid(TOIntervalAllocation timeOffInterval) {
		//Validate the saving object timeOffInterval should does not have null value
		//And the allocated hours &gt; 0
		//the endtime should always be larger than starttime
<span class="nc bnc" id="L542" title="All 4 branches missed.">		boolean result = timeOffInterval.getTOPoolID() != null &amp;&amp; timeOffInterval.getAllocatedHours() &gt;= 0;</span>
<span class="nc bnc" id="L543" title="All 6 branches missed.">		result = result &amp;&amp; timeOffInterval.getStartTime() != null &amp;&amp; timeOffInterval.getEndTime() != null;</span>
<span class="nc bnc" id="L544" title="All 4 branches missed.">		return result &amp;&amp; timeOffInterval.getEndTime().after(timeOffInterval.getStartTime());</span>
	}

	/**
	 * Return the DropDown display of sets
	 */
	private String getDelimiterDropDown() {
<span class="nc" id="L551">		Collection&lt;StringsPair&gt; delimiterStringsPair = new ArrayList&lt;StringsPair&gt;();</span>

		// add \t
<span class="nc" id="L554">		delimiterStringsPair.add(new StringsPair(&quot;tab&quot;, i18n(m_bbmBundle, BbmWebBundleKey.ImportTab)));</span>
<span class="nc" id="L555">		delimiterStringsPair.add(new StringsPair(&quot;,&quot;, i18n(m_bbmBundle, BbmWebBundleKey.ImportComma)));</span>
<span class="nc" id="L556">		delimiterStringsPair.add(new StringsPair(&quot;;&quot;, i18n(m_bbmBundle, BbmWebBundleKey.ImportSemiColon)));</span>
<span class="nc" id="L557">		return HtmlUtil.makeSelectInput(DELIMITER_FN, &quot;&quot;, &quot;&quot;, delimiterStringsPair);</span>
	}

	/**
	 * Return URL for HTML Form Action
	 */
	@Override
	public String getFormAction() {
<span class="nc" id="L565">		return &quot;available_time_off_import&quot;;</span>
	}

	/**
	 * Setter for pool ID. Automatically extracted.
	 *
	 * @param poolID
	 */
	public void setPerformActionOnID(ID poolID) {
<span class="nc" id="L574">		m_poolID = poolID;</span>
<span class="nc" id="L575">	}</span>

	public ID getPoolID() {
<span class="nc" id="L578">		return m_poolID;</span>
	}

	/**
	 * Setter for pool Name. Automatically extracted.
	 *
	 * @param poolName
	 */
	public void setPoolName(String poolName) {
<span class="nc" id="L587">		m_poolName = poolName;</span>
<span class="nc" id="L588">	}</span>

	/**
	 * Getter for pool Name.
	 *
	 * @return the time off pool name
	 */
	public String getPoolName() {
<span class="nc" id="L596">		return m_poolName;</span>
	}

	/**
	 * Return the Required HTML for this component.
	 */
	@Override
	public String getRequiredHTML() {
		// store poolID, poolName
<span class="nc" id="L605">		return super.getRequiredHTML() + HtmlUtil.makeHiddenInput(WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN, m_poolID)</span>
<span class="nc" id="L606">				+ HtmlUtil.makeHiddenInput(&quot;poolName&quot;, m_poolName);</span>
	}

	public String i18n(String key) {
<span class="nc" id="L610">		return i18n(m_rmBundle, key);</span>
	}

	public String getStartTime() {
<span class="nc" id="L614">		return intervalStartTime;</span>
	}

	public void setStartTime(String startTime) {
<span class="nc" id="L618">		this.intervalStartTime = startTime;</span>
<span class="nc" id="L619">	}</span>

	public String getEndTime() {
<span class="nc" id="L622">		return intervalEndTime;</span>
	}

	public void setEndTime(String endTime) {
<span class="nc" id="L626">		this.intervalEndTime = endTime;</span>
<span class="nc" id="L627">	}</span>

	public String getDelimiter() {
<span class="nc" id="L630">		return valueDelimiter;</span>
	}

	public void setDelimiter(String delimiter) {
<span class="nc" id="L634">		this.valueDelimiter = delimiter;</span>
<span class="nc" id="L635">	}</span>

	public String getNumLines() {
<span class="nc" id="L638">		return ignoreNumLines;</span>
	}

	public void setNumLines(String numLines) {
<span class="nc" id="L642">		this.ignoreNumLines = numLines;</span>
<span class="nc" id="L643">	}</span>

	public String getDate() {
<span class="nc" id="L646">		return dailyPoolDate;</span>
	}

	public void setDate(String date) {
<span class="nc" id="L650">		this.dailyPoolDate = date;</span>
<span class="nc" id="L651">	}</span>

	public String getHours() {
<span class="nc" id="L654">		return dailyHours;</span>
	}

	public void setHours(String hours) {
<span class="nc" id="L658">		this.dailyHours = hours;</span>
<span class="nc" id="L659">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>