<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MyAdherencePM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.am.adherence.self</a> &gt; <span class="el_source">MyAdherencePM.java</span></div><h1>MyAdherencePM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.am.adherence.self;

import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.CalendarRange;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.HtmlEncoder;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.SimpleEvent;
import com.bluepumpkin.ejb.bbm.rtaamanager.model.EmployeeData;
import com.bluepumpkin.ejb.bbm.rtaamanager.model.RTAAData;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.RTAAException;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeTrackingEvent;
import com.bluepumpkin.ejb.bbm.util.AdherenceSummaryUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.web.am.Log;
import com.bluepumpkin.web.am.adherence.AdherenceHelper;
import com.bluepumpkin.web.am.adherence.keys.AdherenceKeys;
import com.bluepumpkin.web.am.keys.AmJavaScriptFileID;
import com.bluepumpkin.web.am.l10n.AmWebBundleKey;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.jsp.HtmlButton;
import com.witness.web.uif.jsp.HtmlImage;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.dialog.DialogLegendPC;
import com.witness.web.uif.pagecomponent.list.DualListPC;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpanePageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;

/**
 * Title: MyAdherencePM Description: Page Model for the Agent Self Adherence
 * screen. Copyright: Copyright (c) 2008 Company: Verint Systems. Inc.
 * 
 * @author Gonzalo Quintanar
 */
public class MyAdherencePM extends WorkpanePageModel implements ContainersInRowsPM {
<span class="fc" id="L74">	private static final Category log = Log.initCategory(MyAdherencePM.class.getName());</span>

	// Field Name constants
	public static final String VIEW_DATE_FN = &quot;viewDate&quot;;

	// form field name
	public static final String REFRESH_RATE_FN = &quot;refreshRate&quot;;

	// for the current time indicator dynamic javascript text
	public static final String TIME_OF_DAY_FN = &quot;timeOfDay&quot;;

	// Refresh rate constants
	// indicates that the refresh rate was not set yet
	public static final int REFRESH_RATE_NOT_SET = -1;
	public static final int NO_AUTO_REFRESH = -2;
	public static final int DEFAULT_REFRESH_RATE = NO_AUTO_REFRESH;
	// user profile key
	public static final String REFRESH_RATE_USER_PROPERTY_KEY = &quot;UserAdherenceAutoRefresh&quot;;

	// Action constants
	public static final String FORM_ACTION = &quot;showadherence&quot;;
	// probably not needed, since we have no RH class
	public static final String CHANGE_REFRESH_RATE_ACTION = &quot;CHANGE_REFRESH_RATE_ACTION&quot;;

	// Adherence Grid Constants
	public static final int PREV_DAY_INDEX = -1;
	public static final int NEXT_DAY_INDEX = 1441;

	// Adherence Line Types
	public static final int SCHEDULEDEVENT_LINE = -1;
	public static final int ACTUALEVENT_LINE = -2;
	public static final int ADHERENCEEXCEPTION_LINE = -3;
	public static final int TRACKINGEVENT_LINE = -4;

	// Adherence Exception Colors
	public static final String COLOR_APPROVED_EXCEPTION = &quot;B7D85B&quot;;
	public static final String COLOR_UNAPPROVED_EXCEPTION = &quot;EF6D18&quot;;
	public static final String DEFAULT_EVENT_COLOR = &quot;DFEFAE&quot;;

	// Column headers for the Summary Table
<span class="fc" id="L114">	private static final String[] SUMMARY_RB_KEYS = new String[] { AmWebBundleKey.MY_ADHERENCE_SUMMARY_APPROVED,</span>
			AmWebBundleKey.MY_ADHERENCE_SUMMARY_UNAPPROVED, AmWebBundleKey.MY_ADHERENCE_SUMMARY_SCHEDULED,
			AmWebBundleKey.MY_ADHERENCE_SUMMARY_EXCEPTIONS, AmWebBundleKey.MY_ADHERENCE_SUMMARY_PERCENTAGE };

	// Containers
	private ContainerList m_containerList;
	// the collapsable Summary container
<span class="nc" id="L121">	private CollapsibleContainerPC m_summaryPC = null;</span>
	// the adherence dual list (strings on the left, grid on the right)
<span class="nc" id="L123">	private MyDualListPC m_dualList = null;</span>

	// Components
<span class="nc" id="L126">	protected DialogLegendPC m_legendPC = null;</span>
	// allows the user to select the view date
	private DatePickerPC m_datePicker;

	// Data variables
	private int viewYear;
	private int viewMonth;
	private int viewDay;
<span class="nc" id="L134">	protected TimeRange m_dayRange = null; // date range for the view date (ex:</span>
											// today from 12:00 AM to 11:59 PM)
<span class="nc" id="L136">	protected StringBuffer m_sbJS = new StringBuffer(); // for accumulation of</span>
														// js data for the
														// Adherence grid
<span class="nc" id="L139">	protected MyAdherenceSummaryData m_adherenceSummaryData = new MyAdherenceSummaryData();</span>
<span class="nc" id="L140">	int m_scrollX = Integer.MIN_VALUE; // The horizontal position to scroll to</span>
										// by default when the page loads.

	// 508
	// simply the string &quot;Approved exception&quot;
<span class="nc" id="L145">	protected String m_approvedName = &quot;&quot;;</span>
	// simply the string &quot;Unapproved exception&quot;
<span class="nc" id="L147">	protected String m_unapprovedName = &quot;&quot;;</span>
	// the template to use for accessible text descriptions of events
<span class="nc" id="L149">	protected String m_textTemplate = &quot;&quot;;</span>

	// Refresh Rate variables
	// a list of refresh rate options for the drop down
<span class="nc" id="L153">	private ArrayList m_refreshRateList = null;</span>
<span class="nc" id="L154">	private int m_refreshRate = REFRESH_RATE_NOT_SET;</span>

	// Supporting variables
	private ResourceBundle m_bundle;
	private User m_user;

<span class="nc" id="L160">	private int m_minRefreshRate = 15;</span>
	// default is true, unless you override it with the bpconfig setting
<span class="nc" id="L162">	private boolean m_allowManualRefresh = true;</span>

	/**
	 * Constructor
	 */
	public MyAdherencePM(RequestContext context) {
<span class="nc" id="L168">		super(context, PageModel.BASIC_MODEL);</span>

		// Initialize member variables
<span class="nc" id="L171">		m_bundle = m_localizer.getBundle(AmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L172">		m_user = context.getUser();</span>
<span class="nc" id="L173">		m_containerList = new ContainerList(this, 3);</span>
<span class="nc" id="L174">		TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L175">		m_approvedName = i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_APPROVED_EXCEPTION);</span>
<span class="nc" id="L176">		m_unapprovedName = i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_UNAPPROVED_EXCEPTION);</span>
		// Ex:
		// &quot;Lunch: 8:15 AM - 11:45 AM. &quot;
<span class="nc" id="L179">		m_textTemplate = i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_EVENT_DESCRIPTION);</span>

		// Initialize JavaScript Files
<span class="nc" id="L182">		setJSMediator(JavaScriptFileID.MEDIATOR_WORKPANE_GENERIC);</span>
<span class="nc" id="L183">		addRequiredJavaScriptFile(AmJavaScriptFileID.GRAPH_VIEW_SUPPORT);</span>

		// Initialize the Legend dialog
<span class="nc" id="L186">		m_legendPC = new DialogLegendPC(context, m_toolbar);</span>
<span class="nc" id="L187">		addChildComponent(m_legendPC);</span>

		// Initialize the Date Picker
<span class="nc" id="L190">		m_datePicker = new DatePickerPC(context, VIEW_DATE_FN);</span>
<span class="nc" id="L191">		m_datePicker.setTimeZone(tz);</span>
<span class="nc" id="L192">		m_datePicker.setIsDayNavEnabled(true);</span>
<span class="nc" id="L193">		m_datePicker.setIsDateValueOptional(false);</span>
		// m_datePicker.setIsTodayButtonEnabled(true); //bug with different
		// timezones
<span class="nc" id="L196">		addChildComponent(m_datePicker);</span>

		// Set default date before extracting parameters from the url
<span class="nc" id="L199">		Calendar aCalendar = getCalendar();</span>
<span class="nc" id="L200">		viewYear = aCalendar.get(Calendar.YEAR);</span>
<span class="nc" id="L201">		viewMonth = aCalendar.get(Calendar.MONTH);</span>
<span class="nc" id="L202">		viewDay = aCalendar.get(Calendar.DAY_OF_MONTH);</span>
<span class="nc" id="L203">		m_dayRange = makeDayRange(new Date(), tz, false);</span>

		// Initialize the Dual List component
<span class="nc" id="L206">		m_dualList = new MyDualListPC(context);</span>
<span class="nc" id="L207">		addChildComponent(m_dualList);</span>
		// 508: The row headers are actually in the left list!
<span class="nc" id="L209">		m_dualList.getRightListPC().setHasRowHeaders(false);</span>

		// get the minimum refresh rate from BPCONFIG, and whether to allow
		// manula refresh
		try {
<span class="nc" id="L214">			String sMinRefreshRate = BbmManagerFactory.getDBConfigManager().getValue(</span>
					ConfigKey.AM_MY_ADHERENCE_MIN_REFRESH_RATE);
<span class="nc bnc" id="L216" title="All 2 branches missed.">			if (sMinRefreshRate != null) {</span>
<span class="nc" id="L217">				m_minRefreshRate = Integer.parseInt(sMinRefreshRate);</span>
			}

<span class="nc" id="L220">			String sAllowManualRefresh = BbmManagerFactory.getDBConfigManager().getValue(</span>
					ConfigKey.AM_MY_ADHERENCE_ALLOW_MANUAL_REFRESH);
<span class="nc bnc" id="L222" title="All 2 branches missed.">			if (sAllowManualRefresh != null) {</span>
<span class="nc" id="L223">				m_allowManualRefresh = (sAllowManualRefresh.equals(&quot;true&quot;));</span>
			}
<span class="nc" id="L225">		} catch (Exception ex) {</span>
<span class="nc" id="L226">			log.l7dError(</span>
					&quot;failed to fetch AM_MY_ADHERENCE_MIN_REFRESH_RATE, AM_MY_ADHERENCE_ALLOW_MANUAL_REFRESH values from DBCONFIG&quot;,
					ex);
<span class="nc" id="L229">		}</span>

<span class="nc" id="L231">	}// constructor</span>

	// /////////////////////////////////////////////////////////////////////////
	// JavaScript-related methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Return the JavaScript init code required by Page model. The output of
	 * this method is put inside the JavaScript main() function. Default
	 * behavior is to retrieve sub-component JavaScript Init code.
	 */
	public String getJavaScriptInitCode() {
<span class="nc" id="L243">		StringBuffer jsInitCode = new StringBuffer(128);</span>

		// Add sub-component JavaScript code first
<span class="nc" id="L246">		jsInitCode.append(super.getJavaScriptInitCode());</span>

		// If viewing current day, enable auto-refresh
<span class="nc bnc" id="L249" title="All 2 branches missed.">		if (getViewDate().equals(getToday())) {</span>
<span class="nc" id="L250">			String template = &quot;\nsetTimeout(\&quot;{0}.refreshPage()\&quot;,{1});\n\n&quot;;</span>

<span class="nc" id="L252">			Object[] args = new Object[] { getPageMediatorRef(), Integer.toString(getRefreshRate() * 60000)</span>

			};

<span class="nc bnc" id="L256" title="All 2 branches missed.">			if (getRefreshRate() &gt; 0)</span>
<span class="nc" id="L257">				jsInitCode.append(MessageFormat.format(template, args));</span>
		}

		// set horizontal scroll position
<span class="nc bnc" id="L261" title="All 2 branches missed.">		if (m_scrollX == Integer.MIN_VALUE)</span>
<span class="nc" id="L262">			m_scrollX = 0;</span>
<span class="nc" id="L263">		jsInitCode.append(super.getJavaScriptInitCode() + &quot;scrollIt(&quot; + m_scrollX + &quot;);\n\n&quot;);</span>

<span class="nc" id="L265">		return jsInitCode.toString();</span>
	}

	/**
	 * Return the custom JavaScript code for the Page model. The output of this
	 * method is added outside of the JavaScript main() function.
	 */
	public String getCustomJavaScript() {
<span class="nc" id="L273">		StringBuffer jsInitCode = new StringBuffer(1024);</span>
<span class="nc" id="L274">		jsInitCode.append(super.getCustomJavaScript());</span>

		// Append the customResize() function for the dual list
<span class="nc bnc" id="L277" title="All 2 branches missed.">		if (m_dualList != null)</span>
<span class="nc" id="L278">			jsInitCode.append(&quot;\nfunction customResize() {&quot; + m_dualList.getName() + &quot;.onResize(); } \n&quot;);</span>

		// Append the Adherence grid javascript buffer
<span class="nc" id="L281">		jsInitCode.append(m_sbJS.toString());</span>

<span class="nc" id="L283">		jsInitCode.append(&quot;\n\n&quot;);</span>
<span class="nc" id="L284">		jsInitCode.append(&quot;function scrollIt(posX){\n&quot;);</span>
<span class="nc" id="L285">		jsInitCode.append(&quot;DOM2.getElementById(\&quot;dualList_rPane\&quot;).scrollLeft = posX;\n&quot;);</span>
<span class="nc" id="L286">		jsInitCode.append(&quot;}\n\n&quot;);</span>

<span class="nc" id="L288">		return jsInitCode.toString();</span>
	}

	/**
	 * initialize generated JS data objects
	 */
	protected void startGenerateJSData() {
<span class="nc" id="L295">		m_sbJS.append(&quot;\n\n// Graph View Data \n function afterMain(){\n var calendarGrid = new CalendarGrid();&quot;);</span>
<span class="nc" id="L296">	}</span>

	/**
	 * initialize generated JS data objects
	 */
	protected void finishGenerateJSData() {
<span class="nc" id="L302">		m_sbJS.append(&quot;\n calendarGrid.writeGrid();\n }\n&quot;);</span>
<span class="nc" id="L303">	}</span>

	// /////////////////////////////////////////////////////////////////////////
	// Other common PageModel methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L313">		return getInstance(context, MyAdherencePM.class);</span>
	}// getInstance

	/**
	 * Initialize Model with Data
	 */
	protected void initializeModel() {
<span class="nc bnc" id="L320" title="All 2 branches missed.">		if (m_isInitialized)</span>
<span class="nc" id="L321">			return;</span>
		else
<span class="nc" id="L323">			m_isInitialized = true;</span>

		try {
			// --- check if valid employee
<span class="nc bnc" id="L327" title="All 2 branches missed.">			if (m_user.getEmployeeID() == null)</span>
<span class="nc" id="L328">				addPageMessage(Message.INFO_TYPE, BbmWebBundleKey.NO_PERSON_INFO, BbmWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L330">			ArrayList employeeIDs = new ArrayList(1);</span>
<span class="nc" id="L331">			HashMap theData = null;</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">			if (m_user.getEmployeeID() != null) {</span>
<span class="nc" id="L333">				employeeIDs.add(m_user.getEmployeeID());</span>

<span class="nc" id="L335">				CalendarRange aDay = makeDayRange(m_dayRange.getStartDate(), m_context.getViewingTimeZone(), true);</span>
<span class="nc" id="L336">				theData = MyAdherenceMH</span>
<span class="nc" id="L337">						.getAdherenceData(m_context, employeeIDs, aDay.getStartDate(), aDay.getEndDate());</span>
			}

<span class="nc" id="L340">			populateAdherenceList(theData);</span>

<span class="nc bnc" id="L342" title="All 2 branches missed.">			if (m_user.getEmployeeID() != null) {</span>
<span class="nc" id="L343">				initRefreshRateComponent();</span>
<span class="nc" id="L344">				populateSummary();</span>
<span class="nc" id="L345">				initLegend();</span>
			}
<span class="nc" id="L347">		} catch (Exception ex) {</span>
<span class="nc" id="L348">			handleUnableToLoadDataError(log, ex);</span>
			// msg.setAssociatedMessage(ex.getLocalizedMessage(m_localizer,
			// m_context.getViewingTimeZone()));
		} finally {
<span class="nc" id="L352">			initToolbar();</span>
<span class="nc" id="L353">			initContentTitle();</span>
<span class="nc" id="L354">		}</span>
<span class="nc" id="L355">	}// populateModel</span>

	/**
	 * Initialize Component For Display
	 */
	public void initForDisplay() {
<span class="nc bnc" id="L361" title="All 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L362">			return;</span>
		} else {
<span class="nc" id="L364">			super.initForDisplay();</span>
<span class="nc" id="L365">			getUtilityPane().setIsRefreshEnabled(m_allowManualRefresh);</span>
		}
<span class="nc" id="L367">	}</span>

	/**
	 * The output of this method is added to the end of the HTML output, before
	 * the &lt;/form&gt; tag. You can use it for placing hidden variables in the HTML.
	 */
	public String getRequiredHTML() {
		// We need to add the refresh rate to the session to maintail selected
		// value when the entire page is reloaded.
<span class="nc" id="L376">		m_context.setAttribute(RequestContext.SESSION_SCOPE, REFRESH_RATE_USER_PROPERTY_KEY, &quot;&quot; + m_refreshRate);</span>

		// We also add refresh rate as a hidden variable for when the page
		// reloads (so as not to access session)
<span class="nc" id="L380">		return super.getRequiredHTML() + HtmlUtil.makeHiddenInput(REFRESH_RATE_FN, m_refreshRate);</span>
	}

	/**
	 * Return List of Containers NOTE: Items in the Collection will be treated
	 * either as Page Components or just as Objects.
	 */
	public Collection getContainers() {
<span class="nc" id="L388">		return m_containerList;</span>
	}

	/**
	 * Override extract Parameters to handle date input
	 */
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L395">		boolean success = super.extractParameters(request);</span>

		// Extract Date
		try {
<span class="nc" id="L399">			TimeZone tz = m_context.getViewingTimeZone();</span>

			// Get the extracted date from the date component. If null, then get
			// from session.
			// If still null, then just use the current day.
<span class="nc" id="L404">			Date viewDate = m_datePicker.getDate();</span>
<span class="nc" id="L405">			TimeRange timeRange = null;</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">			if (viewDate == null) {</span>
<span class="nc" id="L407">				timeRange = (TimeRange) m_context.getAttribute(RequestContext.SESSION_SCOPE,</span>
						UserPreferenceKeys.USER_SCHEDULE_VIEW_DAY);
<span class="nc bnc" id="L409" title="All 2 branches missed.">				if (timeRange != null) {</span>
<span class="nc" id="L410">					m_dayRange = timeRange;</span>
<span class="nc" id="L411">					viewDate = timeRange.getStartDate();</span>
				}
			}

<span class="nc bnc" id="L415" title="All 2 branches missed.">			if (viewDate != null) {</span>
<span class="nc" id="L416">				Calendar cal = Calendar.getInstance(tz);</span>
<span class="nc" id="L417">				cal.setTime(viewDate);</span>
<span class="nc" id="L418">				viewYear = cal.get(Calendar.YEAR);</span>
<span class="nc" id="L419">				viewMonth = cal.get(Calendar.MONTH);</span>
<span class="nc" id="L420">				viewDay = cal.get(Calendar.DAY_OF_MONTH);</span>

<span class="nc" id="L422">				m_dayRange = makeDayRange(viewDate, tz, false);</span>

				// Share the view date with the schedule view pages
<span class="nc" id="L425">				m_context.setAttribute(RequestContext.SESSION_SCOPE, UserPreferenceKeys.USER_SCHEDULE_VIEW_DAY,</span>
						m_dayRange);
			}
<span class="nc" id="L428">		} catch (Exception ex) {</span>
<span class="nc" id="L429">			log.setResourceBundle(m_common_bundle);</span>
<span class="nc" id="L430">			log.l7dError(UIFWebBundleKey.EXTRACT_PARAM_FAILED, ex);</span>
<span class="nc" id="L431">		}</span>
<span class="nc" id="L432">		return success;</span>
	}

	// /////////////////////////////////////////////////////////////////////////
	// Setters which are automatically called by super.extractParameters()
	// /////////////////////////////////////////////////////////////////////////

	public void setRefreshRate(int rate) {
<span class="nc" id="L440">		m_refreshRate = rate;</span>
<span class="nc" id="L441">	}</span>

	// /////////////////////////////////////////////////////////////////////////
	// Other Getters and Setters
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc" id="L451">		return FORM_ACTION;</span>
	}

	public int getRefreshRate() {
<span class="nc bnc" id="L455" title="All 2 branches missed.">		if (m_refreshRate == REFRESH_RATE_NOT_SET) {</span>
			// If rate is not set, then try getting it from session. If not in
			// session, then try getting
			// it from the user profile. If not in profile, then just use the
			// default refresh rate.
<span class="nc" id="L460">			String sRate = (String) m_context</span>
<span class="nc" id="L461">					.getAttribute(RequestContext.SESSION_SCOPE, REFRESH_RATE_USER_PROPERTY_KEY);</span>
<span class="nc" id="L462">			boolean isFromProfile = false;</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">			if (sRate == null) {</span>
<span class="nc" id="L464">				sRate = m_context.getUserProperty(REFRESH_RATE_USER_PROPERTY_KEY);</span>
<span class="nc" id="L465">				isFromProfile = true;</span>
			}

<span class="nc bnc" id="L468" title="All 2 branches missed.">			if (!StringUtil.isEmpty(sRate)) {</span>
				try {
<span class="nc" id="L470">					int rate = Integer.parseInt(sRate);</span>
<span class="nc bnc" id="L471" title="All 4 branches missed.">					if ((rate &gt; 0) &amp;&amp; (isFromProfile))</span>
<span class="nc" id="L472">						rate /= 60;</span>
<span class="nc" id="L473">					m_refreshRate = getClosestValidRefreshRate(rate);</span>
<span class="nc" id="L474">				} catch (NumberFormatException e) {</span>
<span class="nc" id="L475">					m_refreshRate = DEFAULT_REFRESH_RATE;</span>
<span class="nc" id="L476">				}</span>
			} else {
<span class="nc" id="L478">				m_refreshRate = DEFAULT_REFRESH_RATE;</span>
			}
		}
<span class="nc" id="L481">		return m_refreshRate;</span>
	}

	// /////////////////////////////////////////////////////////////////////////
	// Date-related Methods
	// /////////////////////////////////////////////////////////////////////////

	protected Calendar getCalendar() {
		// must add time zone
<span class="nc" id="L490">		return Calendar.getInstance(m_context.getViewingTimeZone());</span>
	}

	public Date getToday() {
<span class="nc" id="L494">		Calendar calendar = getCalendar();</span>
<span class="nc" id="L495">		calendar.set(calendar.get(Calendar.YEAR), calendar.get(Calendar.MONTH), calendar.get(Calendar.DAY_OF_MONTH), 0,</span>
				0, 0);
<span class="nc" id="L497">		return calendar.getTime();</span>
	}

	public Date getViewDate() {
<span class="nc" id="L501">		Calendar calendar = getCalendar();</span>
<span class="nc" id="L502">		calendar.set(viewYear, viewMonth, viewDay, 0, 0, 0);</span>
<span class="nc" id="L503">		return calendar.getTime();</span>
	}

	/**
	 * Implemented our own makeDayRange() instead of using DateTimeUtil, because
	 * we need to include 12:00 AM of the next day. This will make our duration
	 * calculations work as expected (endtime - starttime).
	 * 
	 * @param dateInside
	 *            A date inside of the day that you want to get.
	 * @param tz
	 *            The timezone to use for generating the date range for the day.
	 * @param includeNextDayStart
	 *            : If you want to include midnight of the next day, pass true.
	 * @return A CalendarRange containing the start and end dates for a day.
	 */
	public static CalendarRange makeDayRange(Date dateInside, TimeZone tz, boolean includeNextDayStart) {
<span class="nc bnc" id="L520" title="All 4 branches missed.">		if (dateInside == null || tz == null) {</span>
<span class="nc" id="L521">			throw new IllegalArgumentException();</span>
		}
<span class="nc" id="L523">		Calendar aCal = Calendar.getInstance(tz);</span>
<span class="nc" id="L524">		aCal.setTime(dateInside);</span>
<span class="nc" id="L525">		Calendar startCal = getDayStart(aCal);</span>
<span class="nc" id="L526">		Calendar endCal = getDayEnd(aCal, includeNextDayStart);</span>
<span class="nc" id="L527">		return new CalendarRange(startCal.getTime(), endCal.getTime(), tz);</span>
	}// makeDayRange

	/**
	 * return the beginning of the day Calendar for the given Calendar
	 * 
	 * @param Calendar
	 *            aCal
	 * @return Calendar dayStart
	 */
	public static Calendar getDayStart(Calendar aCal) {
<span class="nc" id="L538">		Calendar dayStart = (Calendar) aCal.clone();</span>
<span class="nc" id="L539">		AdherenceSummaryUtil.adjustToDayStart(dayStart);</span>
<span class="nc" id="L540">		return dayStart;</span>
	}// getDayStart

	/**
	 * return the end of the day Calendar for the given Calendar consider day
	 * end being 1 msec before the next midnight
	 * 
	 * @param Calendar
	 *            aCal
	 * @param includeNextDayStart
	 *            : If you want to include midnight of the next day, pass true.
	 * @return Calendar dayStart
	 */
	public static Calendar getDayEnd(Calendar aCal, boolean includeNextDayStart) {
<span class="nc" id="L554">		Calendar dayEnd = (Calendar) aCal.clone();</span>
<span class="nc" id="L555">		AdherenceSummaryUtil.adjustToDayEnd(dayEnd, includeNextDayStart);</span>
<span class="nc" id="L556">		return dayEnd;</span>
	}// getDayEnd

	// /////////////////////////////////////////////////////////////////////////
	// Refresh Rate methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Initialize the refresh rate component
	 */
	private void initRefreshRateComponent() {
<span class="nc" id="L567">		m_refreshRateList = new ArrayList(7);</span>
<span class="nc" id="L568">		String minutes = i18n(m_bundle, AmWebBundleKey.ADHERENCE_MINUTES);</span>
<span class="nc" id="L569">		String noAutoRefresh = i18n(m_bundle, AmWebBundleKey.ADHERENCE_NO_REFRESH);</span>
<span class="nc" id="L570">		m_refreshRateList.add(new StringsPair(&quot;&quot; + NO_AUTO_REFRESH, noAutoRefresh));</span>

<span class="nc bnc" id="L572" title="All 2 branches missed.">		if (m_minRefreshRate &lt;= 5) {</span>
<span class="nc" id="L573">			m_refreshRateList.add(new StringsPair(&quot;5&quot;, &quot;5 &quot; + minutes));</span>
		}

<span class="nc bnc" id="L576" title="All 2 branches missed.">		if (m_minRefreshRate &lt;= 10) {</span>
<span class="nc" id="L577">			m_refreshRateList.add(new StringsPair(&quot;10&quot;, &quot;10 &quot; + minutes));</span>
		}

<span class="nc bnc" id="L580" title="All 2 branches missed.">		if (m_minRefreshRate &lt;= 15) {</span>
<span class="nc" id="L581">			m_refreshRateList.add(new StringsPair(&quot;15&quot;, &quot;15 &quot; + minutes));</span>
		}

<span class="nc bnc" id="L584" title="All 2 branches missed.">		if (m_minRefreshRate &lt;= 30) {</span>
<span class="nc" id="L585">			m_refreshRateList.add(new StringsPair(&quot;30&quot;, &quot;30 &quot; + minutes));</span>
		}

<span class="nc bnc" id="L588" title="All 2 branches missed.">		if (m_minRefreshRate &lt;= 45) {</span>
<span class="nc" id="L589">			m_refreshRateList.add(new StringsPair(&quot;45&quot;, &quot;45 &quot; + minutes));</span>
		}

<span class="nc bnc" id="L592" title="All 2 branches missed.">		if (m_minRefreshRate &lt;= 60) {</span>
<span class="nc" id="L593">			m_refreshRateList.add(new StringsPair(&quot;60&quot;, &quot;60 &quot; + minutes));</span>
		}
<span class="nc" id="L595">	}</span>

	/**
	 * Given an integer, find the closest refresh rate that we support
	 * 
	 * @param rate
	 *            The desired refresh rate (in minutes)
	 * @return the closest supported refresh rate (in minutes)
	 */
	private int getClosestValidRefreshRate(int rate) {
<span class="nc bnc" id="L605" title="All 2 branches missed.">		if (rate &lt; 0) {</span>
<span class="nc" id="L606">			rate = NO_AUTO_REFRESH;</span>
<span class="nc bnc" id="L607" title="All 4 branches missed.">		} else if (rate &lt;= 5 &amp;&amp; m_minRefreshRate &lt;= 5) {</span>
<span class="nc" id="L608">			rate = 5;</span>
<span class="nc bnc" id="L609" title="All 4 branches missed.">		} else if (rate &lt;= 10 &amp;&amp; m_minRefreshRate &lt;= 10) {</span>
<span class="nc" id="L610">			rate = 10;</span>
<span class="nc bnc" id="L611" title="All 4 branches missed.">		} else if (rate &lt;= 15 &amp;&amp; m_minRefreshRate &lt;= 15) {</span>
<span class="nc" id="L612">			rate = 15;</span>
<span class="nc bnc" id="L613" title="All 4 branches missed.">		} else if (rate &lt;= 30 &amp;&amp; m_minRefreshRate &lt;= 30) {</span>
<span class="nc" id="L614">			rate = 30;</span>
<span class="nc bnc" id="L615" title="All 4 branches missed.">		} else if (rate &lt;= 45 &amp;&amp; m_minRefreshRate &lt;= 45) {</span>
<span class="nc" id="L616">			rate = 45;</span>
<span class="nc bnc" id="L617" title="All 4 branches missed.">		} else if (rate &gt; 45 &amp;&amp; m_minRefreshRate &lt;= 60) {</span>
<span class="nc" id="L618">			rate = 60;</span>
		} else {
<span class="nc" id="L620">			rate = NO_AUTO_REFRESH;</span>
		}

<span class="nc" id="L623">		return rate;</span>
	}

	// /////////////////////////////////////////////////////////////////////////
	// Content Title methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Initialize Content Title
	 */
	protected void initContentTitle() {
<span class="nc" id="L634">		Employee employee = null;</span>
<span class="nc" id="L635">		String nameStr = &quot;&quot;;</span>
		try {
<span class="nc" id="L637">			ID id = m_user.getEmployeeID();</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">			if (id != null) {</span>
<span class="nc" id="L639">				employee = EmployeeModelHandler.getEmployeeByID(m_context, id);</span>
<span class="nc" id="L640">				nameStr = m_localizer.formatName(employee.getPerson());</span>

				// Add the Refresh Rate Selector
<span class="nc bnc" id="L643" title="All 2 branches missed.">				if (getViewDate().equals(getToday()))</span>
<span class="nc" id="L644">					m_contentTitlePC.addActiveComponent(getRefreshRateComponentHtml());</span>

				// Add the Date Selector
<span class="nc" id="L647">				m_contentTitlePC.addActiveComponent(getDateSelectorComponentHtml());</span>
			}
<span class="nc" id="L649">		} catch (Exception ex) {</span>
<span class="nc" id="L650">		}</span>
<span class="nc" id="L651">		m_contentTitlePC.setProperties(i18n(m_bundle, AmWebBundleKey.MYTIME_ADHERENCE_PAGETITLE),</span>
<span class="nc" id="L652">				HtmlEncoder.encode(nameStr));</span>

<span class="nc" id="L654">	}// initContentTitle</span>

	// 508
	private HtmlButton getRefreshBtn(String title, String onClick) {
<span class="nc" id="L658">		HtmlImage image = new HtmlImage(ImageFileID.REFRESH_WITH_BORDER);</span>
<span class="nc" id="L659">		image.setAttribute(&quot;class&quot;, &quot;imgToolbarDefault&quot;);</span>
<span class="nc" id="L660">		image.setAttribute(&quot;style&quot;, &quot;margin:0px 0px 0px 0px;&quot;);</span>
<span class="nc" id="L661">		image.setAlt(title);</span>

<span class="nc" id="L663">		HtmlButton button = new HtmlButton(&quot;LogHstoryRefreshButton&quot;);</span>
<span class="nc" id="L664">		button.setInnerHtml(image);</span>
<span class="nc" id="L665">		button.setAttribute(&quot;class&quot;, &quot;dialogBtn&quot;);</span>

<span class="nc" id="L667">		button.setOnClick(onClick);</span>
<span class="nc" id="L668">		button.setAttribute(&quot;title&quot;, title);</span>

<span class="nc" id="L670">		return button;</span>
	}

	/**
	 * Get the HTML for the Date selector component
	 * 
	 * @return the HTML to be added to the page title section.
	 */
	private String getDateSelectorComponentHtml() {
<span class="nc" id="L679">		StringBuffer sb = new StringBuffer(256);</span>
<span class="nc" id="L680">		sb.append(HtmlUtil.TBL_OPEN_TAG</span>
				+ &quot;&lt;tr&gt;&lt;td&gt;&quot;
<span class="nc bnc" id="L682" title="All 2 branches missed.">				+ getDateSelectorUI()</span>
				+ &quot;&lt;/td&gt;&lt;td&gt;&quot;
<span class="nc" id="L684">				+ (m_allowManualRefresh ? getRefreshBtn(i18n(m_bundle, AmWebBundleKey.ADHERENCE_REFRESH_TITLE),</span>
						&quot;document.oFormMain.submit();&quot;) : &quot;&quot;) + &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);

<span class="nc" id="L687">		return sb.toString();</span>
	}

	/**
	 * Return Date Selector UI
	 */
	private String getDateSelectorUI() {
<span class="nc" id="L694">		m_datePicker.setDate(getViewDate());</span>
<span class="nc" id="L695">		m_datePicker.setOnChangeJS(&quot;document.oFormMain.submit();&quot;);</span>
<span class="nc" id="L696">		m_datePicker.initForDisplay();</span>
<span class="nc" id="L697">		return m_datePicker.getHtmlDisplay();</span>
	}

	/**
	 * Get the HTML for the Refresh Rate component
	 * 
	 * @return the HTML to be added to the page title section.
	 */
	private String getRefreshRateComponentHtml() {
<span class="nc" id="L706">		StringBuffer onClick = new StringBuffer(64);</span>
<span class="nc" id="L707">		onClick.append(getNamePrefix()).append(getName()).append(&quot;.refreshPageWithAction('&quot;)</span>
<span class="nc" id="L708">				.append(CHANGE_REFRESH_RATE_ACTION).append(&quot;')&quot;);</span>

<span class="nc" id="L710">		StringBuffer sb = new StringBuffer(256);</span>
<span class="nc" id="L711">		sb.append(HtmlUtil.TBL_OPEN_TAG)</span>
<span class="nc" id="L712">				.append(&quot;&lt;tr&gt;&lt;td nowrap&gt;\n&quot;)</span>
<span class="nc" id="L713">				.append(&quot;&lt;span class=\&quot;headerText2\&quot; id=\&quot;&quot;)</span>
<span class="nc" id="L714">				.append(TIME_OF_DAY_FN)</span>
<span class="nc" id="L715">				.append(&quot;\&quot; style=\&quot;position:relative;\&quot;&gt;&lt;/span&gt;\n&quot;)</span>
<span class="nc" id="L716">				.append(&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/td&gt;\n&quot;)</span>
<span class="nc" id="L717">				.append(&quot;&lt;td nowrap&gt;&quot;)</span>
<span class="nc" id="L718">				.append(&quot;&lt;span class=\&quot;headerText2\&quot;&gt;&quot;)</span>

<span class="nc" id="L720">				.append(i18n(m_bundle, AmWebBundleKey.ADHERENCE_REFRESHRATE_TITLE))</span>
<span class="nc" id="L721">				.append(&quot;: &lt;/span&gt;&quot;)</span>
<span class="nc" id="L722">				.append(HtmlUtil.makeSelectInput(REFRESH_RATE_FN, Integer.toString(getRefreshRate()),</span>
<span class="nc" id="L723">						onClick.toString(), m_refreshRateList)).append(&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/td&gt;&quot;)</span>
<span class="nc" id="L724">				.append(&quot;&lt;/tr&gt;\n&lt;/table&gt;\n&quot;);</span>

<span class="nc" id="L726">		return sb.toString();</span>
	}

	// /////////////////////////////////////////////////////////////////////////
	// Toolbar-related methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Initialize Toolbar
	 */
	protected void initToolbar() {
<span class="nc bnc" id="L737" title="All 2 branches missed.">		if (m_user.getEmployeeID() != null) {</span>
<span class="nc" id="L738">			m_toolbar.addToolbarElement(m_legendPC.getLegendButton());</span>
		}
<span class="nc" id="L740">	}// initToolbar</span>

	/**
	 * Initialize Legend
	 */
	protected void initLegend() {
<span class="nc" id="L746">		m_legendPC.setHeader(i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_LEGEND_PAGETITLE));</span>
<span class="nc" id="L747">	}// initLegend</span>

	// /////////////////////////////////////////////////////////////////////////
	// Main Adherence component methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Populate the Adherence list model m_dualList with data - prepare for
	 * rendering.
	 * 
	 * @param theData
	 *            HashMap containing all the adherence data for the user.
	 *            AdherenceKeys.ADHERENCE_DATA: the RTAA data
	 *            AdherenceKeys.TRACKING_EVENTS: the tracking events
	 *            AdherenceKeys.TRACKING_ACTIVITY_MAP: the tracking activity
	 *            mappings.
	 */
	protected void populateAdherenceList(HashMap theData) {
<span class="nc" id="L765">		ArrayList leftListModel = new ArrayList();</span>
<span class="nc" id="L766">		ArrayList rightListModel = new ArrayList();</span>
<span class="nc" id="L767">		HashMap trackingActivitiesMap = new HashMap();</span>
<span class="nc" id="L768">		HashMap activitiesMap = new HashMap();</span>

		// --- initialize generated JavaScript data objects
<span class="nc" id="L771">		startGenerateJSData();</span>

<span class="nc bnc" id="L773" title="All 2 branches missed.">		if (theData != null) {</span>
			// Get the employee adherence data
<span class="nc" id="L775">			RTAAData rtaaData = (RTAAData) theData.get(AdherenceKeys.ADHERENCE_DATA);</span>

			// Get tracking events and tracking activities (for secondary
			// activity line)
<span class="nc" id="L779">			HashMap trackingEventsMap = (HashMap) theData.get(AdherenceKeys.TRACKING_EVENTS);</span>
<span class="nc" id="L780">			ArrayList trackingEvents = (ArrayList) trackingEventsMap.get(m_user.getEmployeeID());</span>
<span class="nc" id="L781">			trackingActivitiesMap = (HashMap) theData.get(AdherenceKeys.TRACKING_ACTIVITY_MAP);</span>

			// Get activities map and parent event map
<span class="nc" id="L784">			activitiesMap = rtaaData.getActivities();</span>
			// HashMap parentEventsMap = rtaaData.getParentEventsMap();
<span class="nc" id="L786">			HashMap hmActivityMappings = rtaaData.getActivityMappings();</span>

			// Get the EmployeeData for the user. There is only one user.
<span class="nc" id="L789">			Collection colEmployeeData = rtaaData.getEmployeeData();</span>
<span class="nc" id="L790">			EmployeeData employeeData = null;</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">			for (Iterator it = colEmployeeData.iterator(); it.hasNext();)</span>
<span class="nc" id="L792">				employeeData = (EmployeeData) it.next();</span>

			// Get the event data
<span class="nc" id="L795">			Collection plannedEvents = employeeData.getPlannedEvents();</span>
<span class="nc" id="L796">			Collection actualEvents = employeeData.getActualEvents();</span>
<span class="nc" id="L797">			Collection rtaaExceptions = employeeData.getAdheranceViolations();</span>

			// Get the names for the actual line(s)
<span class="nc" id="L800">			Pair actualNames = AdherenceHelper.getActualDisplayNames(m_context);</span>
<span class="nc" id="L801">			String primaryActual = (String) actualNames.getFirst();</span>
<span class="nc" id="L802">			String secondaryActual = (String) actualNames.getSecond();</span>

			// --- first pass - calculate shown hours range ---
<span class="nc" id="L805">			int shownHours[] = { 0, 23 };</span>

			// --- set headers -------------------
<span class="nc" id="L808">			setListHeaders(shownHours);</span>

<span class="nc" id="L810">			TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L811">			CalendarRange aDay = makeDayRange(m_dayRange.getStartDate(), tz, false);</span>

<span class="nc" id="L813">			int rowIndex = 0;</span>

			// //////////////////////////////////////////////////////
			// Create the Scheduled row
			// //////////////////////////////////////////////////////
			// DefaultMultiColumnNodeData rightRowData;
<span class="nc" id="L819">			String rightRowText = &quot;&quot;; // 508</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">			if (plannedEvents != null) {</span>
<span class="nc" id="L821">				rightRowText = makeRightRow(m_sbJS, aDay, shownHours, plannedEvents, activitiesMap, true, true,</span>
						rowIndex++, true, SCHEDULEDEVENT_LINE, rightListModel);
				// rightListModel.add(rightRowData);
			} else
<span class="nc" id="L825">				rightRowText = &quot;&quot;;</span>

<span class="nc" id="L827">			DefaultMultiColumnNodeData leftRowData = makeLeftRow(i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_SCHEDULED),</span>
					rightRowText);
<span class="nc" id="L829">			leftListModel.add(leftRowData);</span>

			// //////////////////////////////////////////////////////
			// Create the Primary Actual row
			// //////////////////////////////////////////////////////
<span class="nc bnc" id="L834" title="All 2 branches missed.">			if (actualEvents != null) {</span>
<span class="nc" id="L835">				rightRowText = makeRightRow(m_sbJS, aDay, shownHours, actualEvents, activitiesMap, true, true,</span>
						rowIndex++, true, ACTUALEVENT_LINE, rightListModel);
				// rightListModel.add(rightRowData);
			} else
<span class="nc" id="L839">				rightRowText = &quot;&quot;;</span>

<span class="nc" id="L841">			leftRowData = makeLeftRow(primaryActual, rightRowText);</span>
<span class="nc" id="L842">			leftListModel.add(leftRowData);</span>

			// //////////////////////////////////////////////////////
			// Create the Exceptions row
			// //////////////////////////////////////////////////////
<span class="nc bnc" id="L847" title="All 2 branches missed.">			if (rtaaExceptions != null) {</span>
<span class="nc" id="L848">				rightRowText = makeRightRow(m_sbJS, aDay, shownHours, rtaaExceptions, activitiesMap, true, true,</span>
						rowIndex++, true, ADHERENCEEXCEPTION_LINE, rightListModel);
			} else {
<span class="nc" id="L851">				rightRowText = &quot;&quot;;</span>
			}

<span class="nc" id="L854">			leftRowData = makeLeftRow(i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_EXCEPTIONS), rightRowText);</span>
<span class="nc" id="L855">			leftListModel.add(leftRowData);</span>

			// //////////////////////////////////////////////////////
			// Create the Secondary Actual row
			// //////////////////////////////////////////////////////
<span class="nc bnc" id="L860" title="All 4 branches missed.">			if (secondaryActual != null &amp;&amp; m_context.getUser().isAuthorized(PrivilegeKeys.AM_VIEWTRACKINGEVENTS)) {</span>
<span class="nc" id="L861">				rightRowText = makeRightRow(m_sbJS, aDay, shownHours, trackingEvents, trackingActivitiesMap, true,</span>
						true, rowIndex++, true, TRACKINGEVENT_LINE, rightListModel);

<span class="nc" id="L864">				leftRowData = makeLeftRow(secondaryActual, rightRowText);</span>
<span class="nc" id="L865">				leftListModel.add(leftRowData);</span>
			}

			// Add the Legend activities
<span class="nc" id="L869">			addLegendData(activitiesMap, trackingActivitiesMap);</span>

			// If viewing today, then Summary Table only includes data up to now
<span class="nc" id="L872">			Date now = new Date();</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">			if (m_dayRange.includes(now)) {</span>
<span class="nc" id="L874">				aDay.setEndDate(now);</span>
			} else {
<span class="nc" id="L876">				aDay = makeDayRange(m_dayRange.getStartDate(), m_context.getViewingTimeZone(), true);</span>
			}

<span class="nc" id="L879">			calculateSummaryData(aDay, plannedEvents, rtaaExceptions, hmActivityMappings);</span>
		}

		// Add the left and right list models to the dual list component
<span class="nc" id="L883">		setDualListModels(leftListModel, rightListModel);</span>

		// --- finish JS data creation
<span class="nc" id="L886">		finishGenerateJSData();</span>

<span class="nc" id="L888">		initDualListForDisplay();</span>
<span class="nc" id="L889">		m_containerList.add(m_dualList);</span>

<span class="nc" id="L891">	}// populateAdherenceList</span>

	/**
	 * Populate the legend with the activity color, name string pairs.
	 * 
	 * @param activitiesMap
	 *            Map of activityID to Activity.
	 * @param trackingActivitiesMap
	 *            Map of activityID to Activity.
	 */
	private void addLegendData(HashMap activitiesMap, HashMap trackingActivitiesMap) {
<span class="nc" id="L902">		ArrayList legendStringPairs = new ArrayList();</span>
<span class="nc bnc" id="L903" title="All 4 branches missed.">		if (activitiesMap != null &amp;&amp; activitiesMap.size() &gt; 0) {</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">			for (Iterator it = activitiesMap.values().iterator(); it.hasNext();) {</span>
<span class="nc" id="L905">				Activity activity = (Activity) it.next();</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">				if (activity.getID().toInt() != Activity.NO_ACTIVITY) {</span>
<span class="nc" id="L907">					legendStringPairs.add(new StringsPair(activity.getColor(), activity.getName()));</span>
				}
<span class="nc" id="L909">			}</span>
		}
<span class="nc bnc" id="L911" title="All 4 branches missed.">		if (trackingActivitiesMap != null &amp;&amp; trackingActivitiesMap.size() &gt; 0) {</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">			for (Iterator it = trackingActivitiesMap.values().iterator(); it.hasNext();) {</span>
<span class="nc" id="L913">				Activity activity = (Activity) it.next();</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">				if (activity.getID().toInt() != Activity.NO_ACTIVITY) {</span>
<span class="nc" id="L915">					legendStringPairs.add(new StringsPair(activity.getColor(), activity.getName()));</span>
				}
<span class="nc" id="L917">			}</span>
		}
<span class="nc" id="L919">		legendStringPairs.add(new StringsPair(COLOR_APPROVED_EXCEPTION, m_approvedName));</span>
<span class="nc" id="L920">		legendStringPairs.add(new StringsPair(COLOR_UNAPPROVED_EXCEPTION, m_unapprovedName));</span>
<span class="nc" id="L921">		m_legendPC.setItems(new ArrayList(legendStringPairs));</span>
<span class="nc" id="L922">	}</span>

	/**
	 * set list headers for the multicolumn list
	 */
	private void setListHeaders(int[] shownHours) {
<span class="nc" id="L928">		makeLeftDualLIstHeader(&quot; &quot;);</span>
<span class="nc" id="L929">		makeRightDualListHeader(shownHours);</span>
<span class="nc" id="L930">	}// setListHeaders</span>

	/**
	 * make a row for the list display of the line types.
	 * 
	 * @param rowName
	 *            The name of the row to display in the left list
	 * @param labelText
	 *            The hidden label text describing the events for that row. This
	 *            hidden text will be read by screen readers for 508
	 *            accessibility compliance, since visually impaired users cannot
	 *            see the graph.
	 */
	private DefaultMultiColumnNodeData makeLeftRow(String rowName, String labelText) {
<span class="nc" id="L944">		DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L945">		rowData.add(rowName + HtmlUtil.makeHiddenReadableText(labelText), CSSUtil.STYLE_NOWRAP_NORMAL_LEFT);</span>
<span class="nc" id="L946">		rowData.setSelectable(false);</span>
<span class="nc" id="L947">		return rowData;</span>
	}// makeLeftRow

	/**
	 * Make a graphical row for the multicolumn list display of the adherence
	 * events
	 */
	private String makeRightRow(StringBuffer sbJS, TimeRange aDay, int[] shownHours, Collection events,
			HashMap activities, boolean bShowUnavailable, boolean bShowTimeoff, int rowIndex, boolean isMy,
			int lineType, ArrayList rightListModel) {
<span class="nc" id="L957">		DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L958">		TimeZone tz = m_context.getViewingTimeZone();</span>

		// 508: Holds a textual description of the graph events
<span class="nc" id="L961">		StringBuffer sbRowText = new StringBuffer();</span>

		// --- calculate offset indexes for shown hours (index is the number of
		// minutes before)
<span class="nc" id="L965">		int firstShownIndex = shownHours[0] * 60;</span>
<span class="nc" id="L966">		int lastShownIndex = (shownHours[1] + 1) * 60 - 1;</span>
<span class="nc" id="L967">		int gridWidth = lastShownIndex - firstShownIndex + 1;</span>

		// --- make the row with one empty cell ---
<span class="nc" id="L970">		rowData.add(&quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L971">		rowData.setNodeAttribute(&quot;style&quot;, &quot;font-size:0px&quot;);</span>

		// --- generate JS object with the data for the row ---
<span class="nc" id="L974">		sbJS.append(&quot;\n calendarGrid.addRow(new GridRow(&quot;).append(rowIndex).append(&quot;,&quot;).append(gridWidth).append(&quot;));&quot;);</span>

		// for each event in the falattened schedule for this day
<span class="nc" id="L977">		int eventStartIndex = -1;</span>
<span class="nc" id="L978">		int eventEndIndex = -1;</span>
<span class="nc" id="L979">		String eventColor = &quot;&quot;;</span>
<span class="nc" id="L980">		String eventPattern = &quot;&quot;;</span>

<span class="nc bnc" id="L982" title="All 4 branches missed.">		if (events != null &amp;&amp; !events.isEmpty()) {</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">			for (Iterator i = events.iterator(); i.hasNext();) {</span>
<span class="nc" id="L984">				Object event = i.next();</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">				if (event != null) {</span>
<span class="nc" id="L986">					TimeRange eventRange = new TimeRange(AdherenceSummaryUtil.getEventStartTime(event),</span>
<span class="nc" id="L987">							AdherenceSummaryUtil.getEventEndTime(event));</span>

<span class="nc" id="L989">					Calendar startCal = eventRange.getStartCalendar(tz, null);</span>
<span class="nc" id="L990">					Calendar endCal = eventRange.getEndCalendar(tz, null);</span>

<span class="nc" id="L992">					eventStartIndex = makeMinuteIndexDST(aDay, startCal, firstShownIndex, lastShownIndex);</span>
<span class="nc" id="L993">					eventEndIndex = makeMinuteIndexDST(aDay, endCal, firstShownIndex, lastShownIndex);</span>

<span class="nc bnc" id="L995" title="All 2 branches missed.">					if (eventEndIndex &gt; gridWidth) {</span>
<span class="nc" id="L996">						eventEndIndex = gridWidth;</span>
					}

<span class="nc bnc" id="L999" title="All 4 branches missed.">					if (eventStartIndex != NEXT_DAY_INDEX &amp;&amp; eventEndIndex != PREV_DAY_INDEX) {</span>
						// event overlaps with the shown hrs
<span class="nc" id="L1001">						eventColor = getEventActivityColor(event, activities, lineType);</span>
<span class="nc" id="L1002">						eventPattern = &quot;null&quot;;</span>

						// create JS ScheduleEvent object and add it to
						// calendarGrid.rows[rowIndex]
<span class="nc" id="L1006">						sbJS.append(&quot;\n calendarGrid.rows[&quot;).append(rowIndex).append(&quot;].addEvent(&quot;)</span>
<span class="nc" id="L1007">								.append(eventStartIndex).append(&quot;,&quot;).append(eventEndIndex).append(&quot;,\&quot;&quot;)</span>
<span class="nc" id="L1008">								.append(eventColor).append(&quot;\&quot;,\&quot;&quot;).append(eventPattern).append(&quot;\&quot;)&quot;);</span>

<span class="nc bnc" id="L1010" title="All 2 branches missed.">						if (eventColor.length() &gt; 0) {</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">							if (m_scrollX == Integer.MIN_VALUE) {</span>
								// first time it is being set
<span class="nc" id="L1013">								m_scrollX = eventStartIndex;</span>
							} else {
<span class="nc" id="L1015">								m_scrollX = Math.min(m_scrollX, eventStartIndex);</span>
							}
						}

						// get the the text string which will be read read to
						// blind users
<span class="nc" id="L1021">						String sActivityName = getEventActivityName(event, activities, lineType);</span>
<span class="nc bnc" id="L1022" title="All 4 branches missed.">						if (sActivityName != null &amp;&amp; sActivityName.length() &gt; 0) {</span>
<span class="nc" id="L1023">							String sStartTime = m_localizer.formatDate(startCal.getTime(), tz,</span>
									RegionalFormatBundleKey.TIME_FORMAT);
<span class="nc" id="L1025">							String sEndTime = m_localizer.formatDate(endCal.getTime(), tz,</span>
									RegionalFormatBundleKey.TIME_FORMAT);
<span class="nc" id="L1027">							Object[] args = new Object[] { sActivityName, sStartTime, sEndTime };</span>
<span class="nc" id="L1028">							sbRowText.append(MessageFormat.format(m_textTemplate, args));</span>
						}
					}
				}
<span class="nc" id="L1032">			}</span>
		} else {
			// just insert a blank row so that the empty cells are shown
<span class="nc" id="L1035">			sbJS.append(&quot;\n calendarGrid.rows[&quot;).append(rowIndex).append(&quot;].addEvent(&quot;).append(0).append(&quot;,&quot;)</span>
<span class="nc" id="L1036">					.append(1439).append(&quot;,\&quot;&quot;).append(&quot;&quot;).append(&quot;\&quot;,\&quot;&quot;).append(&quot;null&quot;).append(&quot;\&quot;)&quot;);</span>
		}

<span class="nc" id="L1039">		rowData.setSelectable(false);</span>
<span class="nc" id="L1040">		rightListModel.add(rowData);</span>

<span class="nc" id="L1042">		return sbRowText.toString();</span>
	}// makeRightRow

	/**
	 * Calculate the columns of data for the Summary Table, and store the data
	 * in m_adherenceSummaryData.
	 * 
	 * @param hmActivityMappings
	 *            - the activity mappings for all activities for the data.
	 */
	private void calculateSummaryData(CalendarRange aDay, Collection plannedEvents, Collection rtaaExceptions,
			HashMap hmActivityMappings) {
<span class="nc" id="L1054">		int[] durations = AdherenceSummaryUtil.calculateDaySummaryData(aDay, plannedEvents, rtaaExceptions,</span>
				hmActivityMappings);

<span class="nc" id="L1057">		int approved = durations[0];</span>
<span class="nc" id="L1058">		int unapproved = durations[1];</span>
<span class="nc" id="L1059">		int scheduled = durations[2];</span>
<span class="nc" id="L1060">		int exceptions = durations[3];</span>
<span class="nc" id="L1061">		float percentage = AdherenceSummaryUtil.getPercentage(scheduled, exceptions);</span>

<span class="nc" id="L1063">		m_adherenceSummaryData.setApproved(approved);</span>
<span class="nc" id="L1064">		m_adherenceSummaryData.setUnapproved(unapproved);</span>
<span class="nc" id="L1065">		m_adherenceSummaryData.setScheduled(scheduled);</span>
<span class="nc" id="L1066">		m_adherenceSummaryData.setExceptions(exceptions);</span>
<span class="nc" id="L1067">		m_adherenceSummaryData.setPercentage(percentage);</span>
<span class="nc" id="L1068">	}</span>

	/**
	 * get Event Activity Color
	 * 
	 * @param obj
	 *            - An object of type SimpleEvent, RTAAEXCeption, or
	 *            TimeTrackingEvent.
	 * @param activities
	 *            HashMap mapping activity ID's to Activity objects.
	 * @return String color or empty string if not found
	 */
	public String getEventActivityColor(Object obj, HashMap activities, int lineType) {
<span class="nc" id="L1081">		String color = &quot;&quot;;</span>
<span class="nc bnc" id="L1082" title="All 4 branches missed.">		if (obj != null &amp;&amp; activities != null) {</span>
<span class="nc bnc" id="L1083" title="All 4 branches missed.">			if (lineType == SCHEDULEDEVENT_LINE || lineType == ACTUALEVENT_LINE) {</span>
<span class="nc" id="L1084">				ID activityID = ((SimpleEvent) obj).getActivityID();</span>
<span class="nc" id="L1085">				Activity activity = (Activity) activities.get(activityID);</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">				if (activity != null) {</span>
<span class="nc" id="L1087">					color = activity.getColor();</span>
				}
<span class="nc bnc" id="L1089" title="All 2 branches missed.">			} else if (lineType == ADHERENCEEXCEPTION_LINE) {</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">				if (!((RTAAException) obj).isDeleted()) {</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">					if (((RTAAException) obj).isApproved()) {</span>
<span class="nc" id="L1092">						color = COLOR_APPROVED_EXCEPTION;</span>
					} else {
<span class="nc" id="L1094">						color = COLOR_UNAPPROVED_EXCEPTION;</span>
					}
				}
<span class="nc bnc" id="L1097" title="All 2 branches missed.">			} else if (lineType == TRACKINGEVENT_LINE) {</span>
<span class="nc" id="L1098">				ID activityID = ((TimeTrackingEvent) obj).getActivityID();</span>
<span class="nc" id="L1099">				Activity activity = (Activity) activities.get(activityID);</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">				if (activity != null) {</span>
<span class="nc" id="L1101">					color = activity.getColor();</span>
				}
			}
		}
<span class="nc" id="L1105">		return color;</span>
	}// getEventActivityColor

	/**
	 * get Event Activity name
	 * 
	 * @param obj
	 *            - An object of type SimpleEvent, RTAAEXCeption, or
	 *            TimeTrackingEvent.
	 * @param activities
	 *            HashMap mapping activity ID's to Activity objects.
	 * @return Name of the activity or empty string if not found.
	 */
	public String getEventActivityName(Object obj, HashMap activities, int lineType) {
<span class="nc" id="L1119">		String name = &quot;&quot;;</span>
<span class="nc bnc" id="L1120" title="All 4 branches missed.">		if (obj != null &amp;&amp; activities != null) {</span>
<span class="nc bnc" id="L1121" title="All 4 branches missed.">			if (lineType == SCHEDULEDEVENT_LINE || lineType == ACTUALEVENT_LINE) {</span>
<span class="nc" id="L1122">				ID activityID = ((SimpleEvent) obj).getActivityID();</span>
<span class="nc" id="L1123">				Activity activity = (Activity) activities.get(activityID);</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">				if (activity != null) {</span>
<span class="nc" id="L1125">					name = activity.getName();</span>
				}
<span class="nc bnc" id="L1127" title="All 2 branches missed.">			} else if (lineType == ADHERENCEEXCEPTION_LINE) {</span>
<span class="nc bnc" id="L1128" title="All 2 branches missed.">				if (!((RTAAException) obj).isDeleted()) {</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">					if (((RTAAException) obj).isApproved()) {</span>
<span class="nc" id="L1130">						name = m_approvedName;</span>
					} else {
<span class="nc" id="L1132">						name = m_unapprovedName;</span>
					}
				}
<span class="nc bnc" id="L1135" title="All 2 branches missed.">			} else if (lineType == TRACKINGEVENT_LINE) {</span>
<span class="nc" id="L1136">				ID activityID = ((TimeTrackingEvent) obj).getActivityID();</span>
<span class="nc" id="L1137">				Activity activity = (Activity) activities.get(activityID);</span>
<span class="nc bnc" id="L1138" title="All 2 branches missed.">				if (activity != null) {</span>
<span class="nc" id="L1139">					name = activity.getName();</span>
				}
			}
		}
<span class="nc" id="L1143">		return name;</span>
	}// getEventActivityColor

	/**
	 * calculate the index in minutes of the Calendar value from the shown index
	 * in the given day
	 * 
	 * @param theDay
	 *            - the given day
	 * @param theCal
	 *            - the time value
	 * @param firstShownIndex
	 *            - limitation by the grid boundaries
	 * @param lastShownIndex
	 *            - limitation by the grid boundaries
	 * @return int index - offset in minutes of theCal from the firstShownIndex
	 *         or -1 if theCal is before the shown hours and 1441 if after shown
	 *         hours
	 */
	public int makeMinuteIndex(TimeRange theDay, Calendar theCal, int firstShownIndex, int lastShownIndex) {
<span class="nc" id="L1163">		int relLocOfTheCal = theDay.getRelativeLocation(theCal);</span>
<span class="nc bnc" id="L1164" title="All 2 branches missed.">		if (relLocOfTheCal == TimeRange.TIME_BEFORE) {</span>
<span class="nc" id="L1165">			return PREV_DAY_INDEX;</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">		} else if (relLocOfTheCal == TimeRange.TIME_AFTER) {</span>
<span class="nc" id="L1167">			return NEXT_DAY_INDEX;</span>
		} else {
<span class="nc" id="L1169">			int minutesFromDayStart = theCal.get(Calendar.HOUR_OF_DAY) * 60 + theCal.get(Calendar.MINUTE);</span>
<span class="nc bnc" id="L1170" title="All 2 branches missed.">			if (minutesFromDayStart &lt; firstShownIndex) {</span>
<span class="nc" id="L1171">				return PREV_DAY_INDEX;</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">			} else if (minutesFromDayStart &gt; lastShownIndex) {</span>
<span class="nc" id="L1173">				return NEXT_DAY_INDEX;</span>
			} else {
<span class="nc" id="L1175">				return minutesFromDayStart - firstShownIndex;</span>
			}
		}
	}// makeMinuteIndex

	/**
	 * Calculate the DST-adjusted index in minutes of the Calendar value from
	 * the shown index in the given day. Just like makeMinuteIndex(), except we
	 * consider if the day is the Fall DST transition day. If so, and an event
	 * starts or ends in the 2'nd 1AM hour, we change the start/end index to the
	 * next hour (2 AM), so that we do not end up with an end index which is
	 * less than the start index.
	 * 
	 * @param theDay
	 *            - the given day
	 * @param theCal
	 *            - the time value
	 * @param firstShownIndex
	 *            - limitation by the grid boundaries
	 * @param lastShownIndex
	 *            - limitation by the grid boundaries
	 * @return int index - offset in minutes of theCal from the firstShownIndex
	 *         or -1 if theCal is before the shown hours and 1441 if after shown
	 *         hours
	 */
	public int makeMinuteIndexDST(TimeRange theDay, Calendar theCal, int firstShownIndex, int lastShownIndex) {
<span class="nc" id="L1201">		int minuteIndexTemp = -1;</span>
<span class="nc" id="L1202">		int minuteIndex = makeMinuteIndex(theDay, theCal, firstShownIndex, lastShownIndex);</span>

		// If event starts in the hidden DST hour (ex: the 2'nd 1 AM in PST),
		// make it start at next hour (ex: 2AM)
<span class="nc" id="L1206">		Calendar calClone = (Calendar) theCal.clone();</span>
<span class="nc" id="L1207">		calClone.add(Calendar.HOUR_OF_DAY, -1);</span>
<span class="nc" id="L1208">		minuteIndexTemp = makeMinuteIndex(theDay, calClone, firstShownIndex, lastShownIndex);</span>

<span class="nc bnc" id="L1210" title="All 2 branches missed.">		if (minuteIndex == minuteIndexTemp) {</span>
<span class="nc" id="L1211">			minuteIndex = ((minuteIndex / 60) + 1) * 60;</span>
		}

<span class="nc" id="L1214">		return minuteIndex;</span>
	}

	// /////////////////////////////////////////////////////////////////////////
	// Summary Component methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Populate Summary page component
	 */
	private void populateSummary() {
		try {
<span class="nc" id="L1226">			m_summaryPC = createContainerPC(&quot;SummaryContainer&quot;);</span>
<span class="nc bnc" id="L1227" title="All 2 branches missed.">			if (getViewDate().equals(getToday())) {</span>
<span class="nc" id="L1228">				m_summaryPC.setTitle(i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_SUMMARY_SUMMARY_TODAY));</span>
			} else {
<span class="nc" id="L1230">				m_summaryPC.setTitle(i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_SUMMARY_SUMMARY));</span>
			}

<span class="nc" id="L1233">			MultiColListPC theListPC = initContianerAndCreateList(m_context, m_summaryPC);</span>
<span class="nc bnc" id="L1234" title="All 2 branches missed.">			if (getViewDate().equals(getToday())) {</span>
<span class="nc" id="L1235">				theListPC.setTableAttribute(&quot;summary&quot;,</span>
<span class="nc" id="L1236">						i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_SUMMARY_TODAY_TABLE_SUMMARY));</span>
			} else {
<span class="nc" id="L1238">				theListPC.setTableAttribute(&quot;summary&quot;,</span>
<span class="nc" id="L1239">						i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_SUMMARY_TABLE_SUMMARY));</span>
			}
<span class="nc" id="L1241">			initHeader(theListPC, SUMMARY_RB_KEYS);</span>

<span class="nc" id="L1243">			createSummaryListModel(theListPC, m_adherenceSummaryData);</span>
<span class="nc" id="L1244">		} catch (Exception ex) {</span>
<span class="nc" id="L1245">			handlePopulateContainerError(AmWebBundleKey.MSG_MY_ADHERENCE_SUMMARY_NO_SUMMARY, ex);</span>
<span class="nc" id="L1246">		}</span>
<span class="nc" id="L1247">	}// populateSummary</span>

	/**
	 * Create a CollapsibleContainerPC.
	 * 
	 * @param name
	 *            the name of the component.
	 * @return the new component.
	 */
	private final CollapsibleContainerPC createContainerPC(String name) {
<span class="nc" id="L1257">		CollapsibleContainerPC containerPC = new CollapsibleContainerPC(m_context);</span>
<span class="nc" id="L1258">		containerPC.setName(name);</span>
<span class="nc" id="L1259">		m_containerList.add(containerPC);</span>
<span class="nc" id="L1260">		return containerPC;</span>
	}

	/**
	 * Initialize the header of a MultiColListPC.
	 * 
	 * @param theListPC
	 *            the MultiColListPC to initialize.
	 * @param rbKeys
	 *            The names of the columns for the MultiColListPC.
	 */
	private void initHeader(MultiColListPC theListPC, String[] rbKeys) {
<span class="nc" id="L1272">		TableHeaderPC header = theListPC.getHeader();</span>
<span class="nc bnc" id="L1273" title="All 2 branches missed.">		for (int i = 0; i &lt; rbKeys.length; i++) {</span>
<span class="nc" id="L1274">			String label = i18n(m_bundle, rbKeys[i]);</span>
<span class="nc" id="L1275">			header.addColumnHeaderData(null, label, CSSUtil.CLASS_INNER_HEADER_BORDER_NUMERIC);</span>
		}
<span class="nc" id="L1277">	}</span>

	/**
	 * Set Summary List model
	 */
	private void createSummaryListModel(MultiColListPC theListPC, MyAdherenceSummaryData summaryData) {
<span class="nc bnc" id="L1283" title="All 2 branches missed.">		if (summaryData == null) {</span>
<span class="nc" id="L1284">			return;</span>
		}

		// Create the list model
<span class="nc" id="L1288">		ArrayList listModel = new ArrayList(1);</span>
<span class="nc" id="L1289">		DefaultMultiColumnNodeData row_data = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L1290">		addDurationData(summaryData.getApproved(), row_data);</span>
<span class="nc" id="L1291">		addDurationData(summaryData.getUnapproved(), row_data);</span>
<span class="nc" id="L1292">		addDurationData(summaryData.getScheduled(), row_data);</span>
<span class="nc" id="L1293">		addDurationData(summaryData.getExcpetions(), row_data);</span>
<span class="nc" id="L1294">		addPercentData(summaryData.getPercentage(), summaryData.getScheduled(), row_data);</span>

<span class="nc" id="L1296">		listModel.add(row_data);</span>
<span class="nc" id="L1297">		theListPC.setListModel(listModel);</span>
<span class="nc" id="L1298">	}</span>

	private final MultiColListPC initContianerAndCreateList(RequestContext context, CollapsibleContainerPC parentPC) {
		// List for Display purpose
<span class="nc" id="L1302">		MultiColListPC theListPC = new MultiColListPC(context, false);</span>
<span class="nc" id="L1303">		theListPC.setEnabled(false);</span>

		// Initialize Container
<span class="nc" id="L1306">		parentPC.setStyleClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="nc" id="L1307">		parentPC.setTemplate(&quot;{0}&quot;);</span>
<span class="nc" id="L1308">		parentPC.addComponent(theListPC);</span>

<span class="nc" id="L1310">		return theListPC;</span>
	}

	private void handlePopulateContainerError(String rbKey, Exception ex) {
<span class="nc" id="L1314">		log.l7dError(rbKey, ex);</span>
<span class="nc" id="L1315">		addPageMessage(Message.ERROR_TYPE, rbKey, AmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L1316">	}</span>

	/**
	 * Given a number of milliseconds such as 4020000, add a row like &quot;01:07&quot;
	 * for HH:MM format.
	 * 
	 * @param duration
	 *            a number of milliseconds such as 4020000.
	 * @param row_data
	 *            DefaultMultiColumnNodeData to receive the duration data.
	 */
	private void addDurationData(int duration, DefaultMultiColumnNodeData row_data) {
<span class="nc" id="L1328">		int mm = AdherenceSummaryUtil.getRoundedMinutes(duration);</span>
<span class="nc" id="L1329">		String hhmm = m_localizer.formatDurationInMins(mm);</span>
<span class="nc" id="L1330">		row_data.add(hhmm, CSSUtil.STYLE_NUMERIC);</span>
<span class="nc" id="L1331">	}</span>

	/**
	 * Given a decimal percentage such as .67, add a row like &quot;67%&quot;.
	 * 
	 * @param duration
	 *            a decimal percentage such as .67
	 * @param scheduled
	 *            a number of milliseconds of scheduled time such as 4020000.
	 * @param row_data
	 *            DefaultMultiColumnNodeData to receive the percentage data.
	 */
	private void addPercentData(float duration, int scheduled, DefaultMultiColumnNodeData row_data) {
<span class="nc bnc" id="L1344" title="All 2 branches missed.">		if (scheduled &gt; 0) {</span>
<span class="nc" id="L1345">			row_data.add(m_localizer.formatPercentage(duration, 0), CSSUtil.STYLE_NUMERIC);</span>
		} else {
<span class="nc" id="L1347">			row_data.add(HtmlUtil.NBSP);</span>
		}
<span class="nc" id="L1349">	}</span>

	// /////////////////////////////////////////////////////////////////////////
	// Dual List Helper Methods
	// /////////////////////////////////////////////////////////////////////////

	private void initDualListForDisplay() {
<span class="nc" id="L1356">		MultiColListPC leftListPC = m_dualList.getLeftListPC();</span>
<span class="nc" id="L1357">		MultiColListPC rightListPC = m_dualList.getRightListPC();</span>
<span class="nc" id="L1358">		leftListPC.setTableAttribute(&quot;summary&quot;, i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_CATEGORY_TABLE_SUMMARY));</span>
<span class="nc" id="L1359">		rightListPC.setTableAttribute(&quot;summary&quot;, i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_DETAIL_TABLE_SUMMARY));</span>
<span class="nc" id="L1360">		leftListPC.setRowSelectable(false);</span>
<span class="nc" id="L1361">		rightListPC.setRowSelectable(false);</span>

<span class="nc" id="L1363">		initRightListProperties();</span>

<span class="nc bnc" id="L1365" title="All 2 branches missed.">		if (leftListPC.getListModel().isEmpty()) {</span>
<span class="nc" id="L1366">			m_dualList.setIsBorderEnabled(false);</span>
		}
<span class="nc" id="L1368">	}</span>

	protected void initRightListProperties() {
		// set CSS class to remove margins in the right list
<span class="nc" id="L1372">		MultiColListPC rightListPC = m_dualList.getRightListPC();</span>
<span class="nc" id="L1373">		rightListPC.setCellClass(&quot;tblItemNoPaddn&quot;);</span>
<span class="nc" id="L1374">		rightListPC.setTableRowClass(&quot;tblRowNoPaddn&quot;);</span>
<span class="nc" id="L1375">		rightListPC.getHeader().setStyleClass(&quot;tableHeaderNoPaddn&quot;);</span>

<span class="nc" id="L1377">		MultiColListPC leftListPC = m_dualList.getLeftListPC();</span>
<span class="nc" id="L1378">		leftListPC.setCellClass(&quot;tblRow tblItemNoPaddn&quot;); // tableItem tblItem</span>
															// tblItemNoPaddn
<span class="nc" id="L1380">		leftListPC.setTableRowClass(&quot;tblRow&quot;); // tblRow tblRowNoPaddn</span>
<span class="nc" id="L1381">	}</span>

	/**
	 * generate left list header in dual list
	 */
	protected void makeLeftDualLIstHeader(String title) {
		// --- left column header ----
<span class="nc" id="L1388">		MultiColListPC leftListPC = m_dualList.getLeftListPC();</span>
<span class="nc" id="L1389">		TableHeaderPC leftHeader = leftListPC.getHeader();</span>
<span class="nc" id="L1390">		leftHeader.addColumnHeaderData(null, title);</span>
<span class="nc" id="L1391">	}// makeLeftDualLIstHeader</span>

	/**
	 * generate right list headers with hours for the graph view
	 */
	protected void makeRightDualListHeader(int[] shownHours) {
		// --- right headers = times within shown hours ----
<span class="nc" id="L1398">		MultiColListPC rightListPC = m_dualList.getRightListPC();</span>
<span class="nc" id="L1399">		TableHeaderPC rightHeader = rightListPC.getHeader();</span>

<span class="nc" id="L1401">		TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L1402">		Calendar aCal = Calendar.getInstance(tz);</span>
<span class="nc" id="L1403">		aCal.set(Calendar.MONTH, 1); // to avoid DST-based formatting on</span>
										// DST-switch date
<span class="nc" id="L1405">		aCal.set(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L1406">		aCal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L1407">		aCal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L1408">		aCal.set(Calendar.MILLISECOND, 0);</span>

		// put one string with fixed width spans for each hour
<span class="nc" id="L1411">		StringBuffer sb = new StringBuffer();</span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">		for (int i = shownHours[0]; i &lt;= shownHours[1]; i++) {</span>
<span class="nc" id="L1413">			aCal.set(Calendar.HOUR_OF_DAY, i);</span>
<span class="nc" id="L1414">			sb.append(&quot;&lt;span class=\&quot;hour\&quot;&gt;&quot;)</span>
<span class="nc" id="L1415">					.append(m_localizer.formatDate(aCal.getTime(), tz, RegionalFormatBundleKey.TIME_FORMAT))</span>
<span class="nc" id="L1416">					.append(&quot;&lt;/span&gt;&quot;);</span>
		}
<span class="nc" id="L1418">		rightHeader.addColumnHeaderData(null, sb.toString());</span>
<span class="nc" id="L1419">	}// makeRightDualListHeader</span>

	/**
	 * Initialize Dual List with Models
	 */
	protected void setDualListModels(List lModel, List rModel) {
<span class="nc" id="L1425">		m_dualList.getLeftListPC().setListModel(lModel);</span>
<span class="nc" id="L1426">		m_dualList.getRightListPC().setListModel(rModel);</span>
<span class="nc" id="L1427">	}</span>

	// ////////////////////////////////////////////////////////////////////////////
	// Helper Classes
	// ////////////////////////////////////////////////////////////////////////////

	public class MyDualListPC extends DualListPC {
		private static final String BORDER_CLASS = &quot; class=\&quot;&quot; + CSSUtil.CLASS_BORDER_DEFAULT + &quot;\&quot; &quot;;
		private static final String DEFAULT_LWPR_STYLE = &quot;height:150px; overflow-x:auto; overflow-y:hidden; &quot;;
		private static final String DEFAULT_LWPR_ATTR = &quot; style=\&quot;&quot; + DEFAULT_LWPR_STYLE + &quot;\&quot; &quot;;
		private static final String DEFAULT_RWPR_STYLE = &quot;height:150px; overflow:auto; &quot;;
		private static final String DEFAULT_RWPR_ATTR = &quot; style=\&quot;&quot; + DEFAULT_RWPR_STYLE + &quot;\&quot; &quot;;

<span class="nc" id="L1440">		public MyDualListPC(RequestContext context) {</span>
<span class="nc" id="L1441">			super(context);</span>
<span class="nc" id="L1442">		}</span>

		/**
		 * Return Left Wrapper Attributes As String. Override the method in
		 * DualContainerPC to change height.
		 */
		protected String getLWAttrAsString() {
<span class="nc bnc" id="L1449" title="All 4 branches missed.">			if (m_leftWprAttr == null || m_leftWprAttr.isEmpty()) {</span>
<span class="nc bnc" id="L1450" title="All 2 branches missed.">				if (isBorderEnabled()) {</span>
<span class="nc" id="L1451">					return BORDER_CLASS + DEFAULT_LWPR_ATTR;</span>
				} else {
<span class="nc" id="L1453">					return DEFAULT_LWPR_ATTR;</span>
				}
			}

<span class="nc" id="L1457">			appendDefaultWprAttr(m_leftWprAttr, DEFAULT_LWPR_STYLE);</span>
<span class="nc" id="L1458">			return getVPfromMap(m_leftWprAttr);</span>
		}

		/**
		 * Return Right Wrapper Attributes As String. Override the method in
		 * DualContainerPC to change height.
		 */
		protected String getRWAttrAsString() {
<span class="nc bnc" id="L1466" title="All 4 branches missed.">			if (m_rightWprAttr == null || m_rightWprAttr.isEmpty()) {</span>
<span class="nc bnc" id="L1467" title="All 2 branches missed.">				if (isBorderEnabled()) {</span>
<span class="nc" id="L1468">					return BORDER_CLASS + DEFAULT_RWPR_ATTR;</span>
				} else {
<span class="nc" id="L1470">					return DEFAULT_RWPR_ATTR;</span>
				}
			}

<span class="nc" id="L1474">			appendDefaultWprAttr(m_rightWprAttr, DEFAULT_RWPR_STYLE);</span>
<span class="nc" id="L1475">			return getVPfromMap(m_rightWprAttr);</span>
		}
	}

}// class MyAdherencePM
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>