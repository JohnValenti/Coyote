<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests</a> &gt; <span class="el_source">RequestUtil.java</span></div><h1>RequestUtil.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests;

import java.rmi.RemoteException;
import java.util.*;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.workresource.OrganizationScopeManagerProxy;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestFilter;
import com.bluepumpkin.ejb.rm.requests.custshift.model.CustShiftReq;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.request.validation.PSSDiffBaseShiftActivities;
import com.bluepumpkin.ejb.rm.requests.swap.withdraw.model.ShiftSwapWithdraw;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.requests.timeoff.validation.TimeOffChoiceContainsHoliday;
import com.bluepumpkin.ejb.rm.requests.timeoff.validation.TimeOffChoiceContainsOrgChange;
import com.bluepumpkin.ejb.rm.requests.timeoff.validation.TimeOffChoiceHasZeroLength;
import com.bluepumpkin.ejb.rm.requests.timeoff.withdraw.model.TOWithdraw;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.rm.auction.AuctionMH;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.filter.RequestsFilterBoxPC;
import com.bluepumpkin.web.rm.setup.validation.ValidationModelHandler;
import com.bluepumpkin.web.rm.validation.ValidationResources;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.message.MessagePC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;
import com.witness.web.uif.validator.InLengthRangeFieldValidator;

/**
 * Title:        RequestUtil
 * Description:  Utility class to provide useful methods to deal with Request
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, dsu
 * @version      1.0
 *
 * Created on September 17, 2002, 2:42 PM
 */
public final class RequestUtil {
	private static final String REQUEST_TYPE = &quot;RequestUtil_REQUEST_TYPE&quot;;
	private static final String SWAPBOARD_VIEW_MODE = &quot;RequestUtil_SWAPBOARD_VIEW_MODE&quot;;
<span class="fc" id="L63">	private static final String TO_CHOICE_LEN_ZERO_VAL_NAME = TimeOffChoiceHasZeroLength.class.getName();</span>
<span class="fc" id="L64">	private static final String TO_CHOICE_LEN_CONTAINS_HOL_VAL_NAME = TimeOffChoiceContainsHoliday.class.getName();</span>
<span class="fc" id="L65">	private static final String PSS_DIFF_BASE_SHIFT_ACTIVITIES_VAL_NAME = PSSDiffBaseShiftActivities.class.getName();</span>
<span class="fc" id="L66">	private static final String TO_CHOICE_CONTAINS_ORG_CHANGE_VAL_NAME = TimeOffChoiceContainsOrgChange.class.getName();</span>

	/** Creates a new instance of RequestUtil */
<span class="nc" id="L69">	private RequestUtil() {</span>
<span class="nc" id="L70">	}</span>

	/**
	 * Return Localized Action
	 */
	public static String getLocalizedAction(Localizer localizer, ResourceBundle bundle, String action) {
<span class="fc" id="L76">		String rbKey = null;</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">		if (PageAction.EDIT.equals(action)) {</span>
<span class="fc" id="L78">			rbKey = UIFWebBundleKey.EDIT;</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">		} else if (PageAction.SUBMIT_TO_MGR.equals(action)) {</span>
<span class="nc" id="L80">			rbKey = UIFWebBundleKey.SUBMIT_TO_MGR;</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">		} else if (PageAction.VIEW_DETAIL.equals(action)) {</span>
<span class="fc" id="L82">			rbKey = UIFWebBundleKey.VIEW_DETAIL;</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">		} else if (PageAction.DENY.equals(action)) {</span>
<span class="fc" id="L84">			rbKey = UIFWebBundleKey.DENY;</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">		} else if (PageAction.WITHDRAW.equals(action)) {</span>
<span class="fc" id="L86">			rbKey = UIFWebBundleKey.WITHDRAW;</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">		} else if (PageAction.WITHDRAW_NEGOTIATION.equals(action)) {</span>
<span class="nc" id="L88">			rbKey = UIFWebBundleKey.WITHDRAW;</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">		} else if (PageAction.APPROVE.equals(action)) {</span>
<span class="fc" id="L90">			rbKey = UIFWebBundleKey.APPROVE;</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">		} else if (PageAction.TENTATIVELY_APPROVE.equals(action)) {</span>
<span class="fc" id="L92">			rbKey = UIFWebBundleKey.TENTATIVELY_APPROVE;</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">		} else if (PageAction.VIEW_SCHEDULE.equals(action)) {</span>
<span class="nc" id="L94">			rbKey = UIFWebBundleKey.VIEW_SCHEDULE;</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">		} else if (PageAction.ESCALATE.equals(action)) {</span>
<span class="fc" id="L96">			rbKey = UIFWebBundleKey.ESCALATE;</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">		} else if (RmPageAction.ADD_TO_WAITLIST_ACTION.equals(action)) {</span>
			//use rmwebbundle here
<span class="nc" id="L99">			return localizer.i18n(localizer.getBundle(RmWebBundleKey.BUNDLE_NAME), RmWebBundleKey.ADD_TO_WAITLIST_ACTION);</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">		} else if (RmPageAction.ADD_TO_MAN_WAITLIST_ACTION.equals(action)) {</span>
			//use rmwebbundle here
<span class="fc" id="L102">			return localizer.i18n(localizer.getBundle(RmWebBundleKey.BUNDLE_NAME), RmWebBundleKey.ADD_TO_MAN_WAITLIST_ACTION);</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">		} else if (PageAction.ACCEPT_WITHDRAW_ACTION.equals(action)) {</span>
<span class="fc" id="L104">			rbKey = UIFWebBundleKey.ACCEPT_WITHDRAW;</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">		} else if (PageAction.REJECT_WITHDRAW_ACTION.equals(action)) {</span>
<span class="fc" id="L106">			rbKey = UIFWebBundleKey.REJECT_WITHDRAW;</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">		} else if (PageAction.CANCEL_WITHDRAW_ACTION.equals(action)) {</span>
<span class="fc" id="L108">			rbKey = UIFWebBundleKey.CANCEL_WITHDRAW;</span>
		}
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">		return rbKey != null ? localizer.i18n(bundle, rbKey) : action;</span>
	}

	/**
	 * Return true if Request Form Save Button is enabled for specified Request
	 */
	public static boolean isRequestFormSaveBtnEnabled(RequestAggregate request) {
		// Disable Save Button when Request is already Approved
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">		String status = request != null ? request.getRequestStatus() : null;</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">		return !RequestAuditTrail.STATUS_APPROVED.equals(status);</span>
	}

	/**
	 * Add Page Message to indicate that a request has been saved and its status
	 * is displayed
	 */
	public static void addSavedRequestMsg(RequestAggregate request, PageModel model) {
<span class="fc" id="L127">		addSavedRequestMsg(request.getRequestStatus(), model);</span>
<span class="fc" id="L128">	}</span>

	public static void addSavedRequestMsg(String s, PageModel model) {
<span class="fc" id="L131">		String[] imgLbl = getImgAndL10nDisplayForStatus(s, model.getLocalizer());</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">		String status = imgLbl == null ? &quot;-&quot; : imgLbl[1];</span>

<span class="fc" id="L134">		String[] args = new String[] { status };</span>
<span class="fc" id="L135">		model.addPageMessage(Message.INFO_TYPE, RmWebBundleKey.REQUEST_SAVED_WITH_STATUS, RmWebBundleKey.BUNDLE_NAME, args);</span>
<span class="fc" id="L136">	}</span>

	public static void cacheMyRequestType(RequestContext context, String type) {
<span class="fc" id="L139">		context.setAttribute(RequestContext.SESSION_SCOPE, REQUEST_TYPE, type);</span>
<span class="fc" id="L140">	}</span>

	public static String getCachedMyRequestType(RequestContext context) {
<span class="fc" id="L143">		return (String) context.getAttribute(RequestContext.SESSION_SCOPE, REQUEST_TYPE);</span>
	}

	public static void cacheSwapBoardViewMode(RequestContext context, String viewMode) {
<span class="nc" id="L147">		context.setUserProperty(SWAPBOARD_VIEW_MODE, viewMode);</span>
<span class="nc" id="L148">	}</span>

	public static String getCachedSwapBoardViewMode(RequestContext context) {
<span class="nc" id="L151">		return context.getUserProperty(SWAPBOARD_VIEW_MODE);</span>
	}

	/**
	 * Create Comment UI
	 */
	public static String createCommentUI(String name, String value, int cols, int rows, PageComponent pc, String label) {
<span class="fc" id="L158">		final int COMMENT_MAX_LEN = 200;</span>
<span class="fc" id="L159">		return createTextArea(name, value, cols, rows, COMMENT_MAX_LEN, pc, UIFWebBundleKey.COMMENTS, UIFWebBundleKey.BUNDLE_NAME, label);</span>
	}

	/**
	 * Create Comment UI
	 */
	public static String createCommentUI(String name, String value, int cols, int rows, PageComponent pc, boolean isReadOnly, String label) {
<span class="nc" id="L166">		final int COMMENT_MAX_LEN = 200;</span>
<span class="nc" id="L167">		return createTextArea(name, value, cols, rows, COMMENT_MAX_LEN, pc, UIFWebBundleKey.COMMENTS, UIFWebBundleKey.BUNDLE_NAME,</span>
				isReadOnly, label);
	}

	/**
	 * Create Text Area with Validation for length added
	 */
	public static String createTextArea(String name, String value, int cols, int rows, int maxLen, PageComponent pc, String rbKey,
			String rbName, String label) {
<span class="fc" id="L176">		return createTextArea(name, value, cols, rows, maxLen, pc, rbKey, rbName, false, label);</span>
	}

	/**
	 * Create Text Area with Validation for length added
	 */
	public static String createTextArea(String name, String value, int cols, int rows, int maxLen, PageComponent pc, String rbKey,
			String rbName, boolean isReadOnly, String label) {

<span class="fc" id="L185">		InLengthRangeFieldValidator validator = new InLengthRangeFieldValidator(pc, name, rbKey, rbName, 0, maxLen);</span>
<span class="fc" id="L186">		pc.addValidator(validator);</span>

<span class="fc" id="L188">		return HtmlUtil.makeTextAreaInput(name, cols, rows, JSUtil.ON_CHANGE, true, isReadOnly, false, value, label);</span>
	}

	/**
	 * Create MessagePC used to render comments
	 *
	 * @param context The Request Context
	 * @param width The with in pixel for the rendered component
	 * @param height The height in pixel for the rendered component
	 * @param css The Css used by the rendered component
	 */
	public static MessagePC createCmntMsgPC(RequestContext context, String width, String height, String css) {
<span class="fc" id="L200">		MessagePC msgPC = new MessagePC(context, &quot;rCmnts&quot;);</span>
<span class="fc" id="L201">		msgPC.setWidth(width);</span>
<span class="fc" id="L202">		msgPC.setHeight(height);</span>
<span class="fc" id="L203">		msgPC.setWrapperCSS(css);</span>
<span class="fc" id="L204">		msgPC.setMessageStyle(&quot;font-size:9px;&quot;);</span>
<span class="fc" id="L205">		msgPC.setMsgPreFmtEnabled(true);</span>
<span class="fc" id="L206">		return msgPC;</span>
	}

	/**
	 * Return Request Comments as Message objects
	 */
	public static Collection&lt;Message&gt; getCommentsAsMessages(RequestAggregate request) {
<span class="fc" id="L213">		Collection atList = request.getAuditTrail();</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">		if (atList.isEmpty()) {</span>
<span class="nc" id="L215">			return Collections.emptyList();</span>
		}

<span class="fc" id="L218">		ArrayList&lt;Message&gt; msgList = new ArrayList&lt;Message&gt;(atList.size());</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">		for (Iterator it = atList.iterator(); it.hasNext();) {</span>
<span class="fc" id="L220">			RequestAuditTrail rqt = (RequestAuditTrail) it.next();</span>
<span class="fc" id="L221">			Message msg = new Message(Message.INFO_TYPE, rqt.getNote());</span>
<span class="fc" id="L222">			msg.setIsHtmlCodeAllowed(true);</span>
<span class="fc" id="L223">			msgList.add(msg);</span>
<span class="fc" id="L224">		}</span>
<span class="fc" id="L225">		return msgList;</span>
	}

	/**
	 * Return String array where first element is the assocated image
	 * and second is the localizer status display.
	 *
	 * return null if invalid status;
	 */
	public static String[] getImgAndL10nDisplayForStatus(String status, Localizer localizer) {
<span class="fc" id="L235">		String[] result = new String[2];</span>
<span class="fc" id="L236">		ResourceBundle bundle = localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">		if (RequestAuditTrail.STATUS_PENDING.equals(status)) {</span>
<span class="fc" id="L238">			result[0] = ImageFileID.STATUS_PENDING;</span>
<span class="fc" id="L239">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_PENDING);</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">		} else if (RequestAuditTrail.STATUS_DENIED.equals(status)) {</span>
<span class="fc" id="L241">			result[0] = ImageFileID.STATUS_DENIED;</span>
<span class="fc" id="L242">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_DENIED);</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">		} else if (RequestAuditTrail.STATUS_WITHDRAWN.equals(status)) {</span>
<span class="fc" id="L244">			result[0] = ImageFileID.STATUS_WITHDRAWN;</span>
<span class="fc" id="L245">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WITHDRAWN);</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">		} else if (RequestAuditTrail.STATUS_APPROVED.equals(status)) {</span>
<span class="fc" id="L247">			result[0] = ImageFileID.STATUS_APPROVED;</span>
<span class="fc" id="L248">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_APPROVED);</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">		} else if (RequestAuditTrail.STATUS_TENTATIVE.equals(status)) {</span>
<span class="nc" id="L250">			result[0] = ImageFileID.STATUS_TENTATIVELY_APPROVED;</span>
<span class="nc" id="L251">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_TENTATIVE);</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">		} else if (RequestAuditTrail.STATUS_NEGOTIATION.equals(status)) {</span>
<span class="nc" id="L253">			result[0] = ImageFileID.STATUS_IN_NEGOTIATION;</span>
<span class="nc" id="L254">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_NEGOTIATION);</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">		} else if (RequestAuditTrail.STATUS_ESCALATED.equals(status)) {</span>
<span class="fc" id="L256">			result[0] = ImageFileID.STATUS_ESCALATED;</span>
<span class="fc" id="L257">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_ESCALATED);</span>
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">		} else if (RequestFilter.EXPIRED_STATUS.equals(status)) {</span>
<span class="nc" id="L259">			result[0] = ImageFileID.STATUS_EXPIRED;</span>
<span class="nc" id="L260">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_EXPIRED);</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">		} else if (RequestAuditTrail.STATUS_INVALID.equals(status)) {</span>
<span class="nc" id="L262">			result[0] = ImageFileID.STATUS_INVALID;</span>
<span class="nc" id="L263">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_INVALID);</span>
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WAITLIST.equals(status)) {</span>
<span class="nc" id="L265">			result[0] = ImageFileID.STATUS_WAITLIST;</span>
<span class="nc" id="L266">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WAITLIST);</span>
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WITHDRAW_REQUEST.equals(status)) {</span>
<span class="fc" id="L268">			result[0] = ImageFileID.STATUS_WITHDRAW_REQUEST;</span>
<span class="fc" id="L269">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WITHDRAW_REQUEST);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WITHDRAW_REJECT.equals(status)) {</span>
<span class="nc" id="L271">			result[0] = ImageFileID.STATUS_WITHDRAW_REJECT;</span>
<span class="nc" id="L272">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WITHDRAW_REJECT);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WITHDRAW_ACCEPT.equals(status)) {</span>
<span class="nc" id="L274">			result[0] = ImageFileID.STATUS_WITHDRAW_ACCEPT;</span>
<span class="nc" id="L275">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WITHDRAW_ACCEPT);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WITHDRAW_CANCEL.equals(status)) {</span>
<span class="nc" id="L277">			result[0] = ImageFileID.STATUS_WITHDRAW_CANCEL;</span>
<span class="nc" id="L278">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WITHDRAW_CANCEL);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION.equals(status)) {</span>
<span class="nc" id="L280">			result[0] = ImageFileID.STATUS_WITHDRAW_NEGOTIATION;</span>
<span class="nc" id="L281">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WITHDRAW_NEGOTIATION);</span>
		} else {
<span class="nc" id="L283">			result = null;</span>
		}

<span class="fc" id="L286">		return result;</span>
	}

	/**
	 * Create Request Status Icon
	 */
	public static String createStatusIcon(String status, boolean isForAgent, Localizer localizer, RequestAggregate request) {
		// Agents don't see Tentative Status
<span class="pc bpc" id="L294" title="1 of 4 branches missed.">		if (isForAgent &amp;&amp; RequestAuditTrail.STATUS_TENTATIVE.equals(status)) {</span>
<span class="nc" id="L295">			status = RequestAuditTrail.STATUS_PENDING;</span>
		}

<span class="fc" id="L298">		String[] imgAndAltText = getImgAndL10nDisplayForStatus(status, localizer);</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">		if (imgAndAltText == null) {</span>
<span class="nc" id="L300">			return status;</span>
		}

<span class="fc" id="L303">		String src = imgAndAltText[0];</span>
<span class="fc" id="L304">		String alt = imgAndAltText[1];</span>
<span class="fc" id="L305">		String imgStr = HtmlUtil.imageTag(src, alt);</span>
<span class="pc bpc" id="L306" title="2 of 4 branches missed.">		if (request != null &amp;&amp; request.isTimeOffRequest()) {</span>
<span class="fc" id="L307">			TOWithdraw toWithdraw = ((TORequest) request).getWithdrawInfo();</span>
<span class="fc bfc" id="L308" title="All 4 branches covered.">			if (toWithdraw != null &amp;&amp; RequestAuditTrail.isRequestForWithdrawalStates(toWithdraw.getRequestStatus())) {</span>
<span class="fc" id="L309">				imgAndAltText = getImgAndL10nDisplayForStatus(toWithdraw.getRequestStatus(), localizer);</span>
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">				if (imgAndAltText != null) {</span>
<span class="fc" id="L311">					src = imgAndAltText[0];</span>
<span class="fc" id="L312">					alt = imgAndAltText[1];</span>
<span class="fc" id="L313">					imgStr += &quot;&lt;BR&gt;&quot; + HtmlUtil.imageTag(src, alt);</span>
				}
			}
		}
<span class="pc bpc" id="L317" title="2 of 4 branches missed.">		if (request != null &amp;&amp; request.isShiftSwapRequest()) {</span>
<span class="nc" id="L318">			ShiftSwapWithdraw ssWithdraw = ((ShiftSwapRequest) request).getWithdrawInfo();</span>
<span class="nc bnc" id="L319" title="All 4 branches missed.">			if (ssWithdraw != null &amp;&amp; RequestAuditTrail.isRequestForWithdrawalStates(ssWithdraw.getRequestStatus())) {</span>
<span class="nc" id="L320">				imgAndAltText = getImgAndL10nDisplayForStatus(ssWithdraw.getRequestStatus(), localizer);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">				if (imgAndAltText != null) {</span>
<span class="nc" id="L322">					src = imgAndAltText[0];</span>
<span class="nc" id="L323">					alt = imgAndAltText[1];</span>
<span class="nc" id="L324">					imgStr += &quot;&lt;BR&gt;&quot; + HtmlUtil.imageTag(src, alt);</span>
				}
			}
		}
<span class="fc" id="L328">		return imgStr;</span>
	}

	/**
	 * Convenience method to retrieve Employee ID from context.
	 *
	 * It adds Error Message specific to Request Pages
	 * to Model if Employee ID is not available.
	 */
	public static ID getEmpIDAndAddMsgIfNotAvailable(RequestContext context, PageModel model) {
<span class="fc" id="L338">		ID empID = context.getUser().getEmployeeID();</span>
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">		if (empID == null) {</span>
<span class="nc" id="L340">			model.addPageMessage(Message.INFO_TYPE, UIFWebBundleKey.SCREEN_DISABLED_FOR_NON_EMP, UIFWebBundleKey.BUNDLE_NAME);</span>
		}
<span class="fc" id="L342">		return empID;</span>
	}

	/**
	 * Return Localized Date Display
	 */
	public static String getDateDisplay(RequestContext context, Date date) {
<span class="fc" id="L349">		Localizer localizer = context.getLocalizer();</span>
<span class="fc" id="L350">		TimeZone tz = context.getViewingTimeZone();</span>
<span class="fc" id="L351">		return localizer.formatDateTime(date, tz);</span>
	}

	/**
	 * Create Alert Icons with associated Message for the specified Validation results
	 */
	public static String createAlertIconsWithMsg(Collection&lt;ValidationResult&gt; validationResults, Localizer localizer, TimeZone tz) {
<span class="fc" id="L358">		StringBuilder sb = new StringBuilder(100);</span>
<span class="fc" id="L359">		validationResults = getUniqueValidationResultsCollection(validationResults);</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">		if (validationResults == null) {</span>
<span class="fc" id="L361">			return sb.toString();</span>
		}

<span class="fc bfc" id="L364" title="All 2 branches covered.">		for (Iterator&lt;ValidationResult&gt; it = validationResults.iterator(); it.hasNext();) {</span>
<span class="fc" id="L365">			ValidationResult vr = it.next();</span>
<span class="fc" id="L366">			String alertIcon = createAlertIcon(vr, localizer);</span>
<span class="fc" id="L367">			String vrMsg = vr.getLocalizedMessage(localizer, tz);</span>

<span class="fc" id="L369">			sb.append(alertIcon).append(&quot; &quot;).append(vrMsg);</span>
<span class="fc" id="L370">			sb.append(&quot;&amp;nbsp;&lt;br&gt;&quot;);</span>
<span class="fc" id="L371">		}</span>

<span class="fc" id="L373">		return sb.toString();</span>
	}

	/**
	 * Create Unique Alert Icons for the specified Validation results.
	 *
	 * If there are two Validation result of the same type, it will only generate
	 * a single alert icon for them.
	 */
	public static String createUniqueAlertIcons(RequestAggregate request, Localizer localizer) {
		// Create list of unique validator's
<span class="fc" id="L384">		Collection&lt;ValidationResult&gt; uniqueValidationResults = getUniqueValidationResultsCollection(</span>
<span class="fc" id="L385">				request.getValidationResults(true));</span>

<span class="pc bpc" id="L387" title="1 of 4 branches missed.">		if (uniqueValidationResults == null || uniqueValidationResults.isEmpty()) {</span>
<span class="fc" id="L388">			return &quot;&quot;;</span>
            }
<span class="fc" id="L390">		String alerts = createAlertIcons(uniqueValidationResults, localizer);</span>
<span class="pc bpc" id="L391" title="2 of 4 branches missed.">        if (alerts != null &amp;&amp; request.isTimeOffRequest() &amp;&amp;</span>
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">                (((TORequest) request).isEligibleForAcceptWithdrawAction() ||</span>
<span class="pc bpc" id="L393" title="1 of 2 branches missed.">                ((TORequest) request).isEligibleForRejectWithdrawAction())) {</span>
<span class="nc" id="L394">            alerts = createIconButton(ImageFileID.BLANK_SPACER, null, null) + &quot;&lt;BR&gt;&quot; + alerts;</span>
        }
<span class="fc" id="L396">        return alerts;</span>
	}

	public static Collection&lt;ValidationResult&gt; getUniqueValidationResultsCollection(
			Collection&lt;ValidationResult&gt; validationResults) {

<span class="fc" id="L402">		Collection&lt;ValidationResult&gt; retColl = null;</span>
<span class="pc bpc" id="L403" title="1 of 4 branches missed.">		if (validationResults == null || validationResults.isEmpty()) {</span>
<span class="fc" id="L404">			return retColl;</span>
		}

<span class="fc" id="L407">		retColl = new ArrayList&lt;ValidationResult&gt;(validationResults);</span>
		
<span class="fc" id="L409">			Map&lt;String, ValidationResult&gt; map = new LinkedHashMap&lt;String, ValidationResult&gt;();</span>
<span class="fc bfc" id="L410" title="All 2 branches covered.">			for (ValidationResult vr : validationResults) {</span>

<span class="pc bpc" id="L412" title="1 of 2 branches missed.">				if (map.containsKey(vr.getValidatorName())) {</span>
<span class="nc" id="L413">					continue;</span>
				}
<span class="fc" id="L415">				map.put(vr.getValidatorName(), vr);</span>
<span class="fc" id="L416">			}</span>
<span class="fc" id="L417">			retColl = map.values();</span>
		
<span class="fc" id="L419">		return retColl;</span>
	}

	protected static String createIconButton(String src, String alt, String onClickJS) {
<span class="nc" id="L423">		return &quot;&lt;span class=\&quot;itemActionWpr\&quot;&gt;&lt;span class=\&quot;itemAction\&quot;&gt;&quot;</span>
<span class="nc" id="L424">				+ HtmlUtil.imageTag(null, src, null, null, alt, null, onClickJS, true) + &quot;&lt;/span&gt;&lt;/span&gt;&quot;;</span>
	}

	/**
	 * Create Alert Icons for the specified Validation results
	 */
	public static String createAlertIcons(Collection&lt;ValidationResult&gt; validationResults, Localizer localizer) {
<span class="fc" id="L431">		StringBuilder sb = new StringBuilder(100);</span>
<span class="fc" id="L432">		validationResults = getUniqueValidationResultsCollection(validationResults);</span>
<span class="fc" id="L433">		sb.append(&quot;&lt;nobr&gt;&quot;);</span>
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">		if (validationResults == null) {</span>
<span class="nc" id="L435">			return sb.append(&quot;&amp;nbsp;&lt;/nobr&gt;&quot;).toString();</span>
		}
<span class="fc bfc" id="L437" title="All 2 branches covered.">		for (Iterator&lt;ValidationResult&gt; it = validationResults.iterator(); it.hasNext();) {</span>
<span class="fc" id="L438">			ValidationResult vr = it.next();</span>

<span class="fc" id="L440">			String alertIcon = createAlertIcon(vr, localizer);</span>
<span class="fc" id="L441">			sb.append(alertIcon);</span>
<span class="fc" id="L442">		}</span>
<span class="fc" id="L443">		sb.append(&quot;&amp;nbsp;&lt;/nobr&gt;&quot;);</span>

<span class="fc" id="L445">		return sb.toString();</span>
	}

	/**
	 * Create Alert Icon for specified Validation Result
	 */
	public static String createAlertIcon(ValidationResult vr, Localizer localizer) {
<span class="fc" id="L452">		String validatorName = vr.getValidatorName();</span>
<span class="fc" id="L453">		String[] imgStrs = getImgStrings(validatorName, localizer);</span>
<span class="fc" id="L454">		String imgSrc = null;</span>
<span class="fc" id="L455">		String imgAlt = getImgAltOfSpecialRules(vr,localizer);</span>
		
<span class="pc bpc" id="L457" title="1 of 2 branches missed.">		if(!StringUtil.isEmpty(imgAlt)){</span>
			//Since special rules have similar hard validation rules when creating so it should so it should show red color to have consistency
<span class="nc" id="L459">			imgSrc =ImageFileID.ALERT_RED;</span>
		} else{
<span class="pc bpc" id="L461" title="1 of 2 branches missed.">			if (vr.isSoft()) {</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">				if (imgStrs == null) {</span>
<span class="nc" id="L463">					return &quot;[ERROR] - No ValidationResources found for validator:'&quot; + validatorName + &quot;'.&quot;;</span>
				} else {
<span class="fc" id="L465">					imgSrc = imgStrs[0];</span>
<span class="fc" id="L466">					imgAlt = imgStrs[1];</span>
				}
			}
		} 
<span class="pc bpc" id="L470" title="2 of 4 branches missed.">		if (imgSrc != null &amp;&amp; imgAlt != null) {</span>
<span class="fc" id="L471">			return &quot;&lt;span class=\&quot;itemAlertWpr\&quot;&gt;&lt;span class=\&quot;itemAlert\&quot;&gt;&quot; + HtmlUtil.imageTag(imgSrc, imgAlt) + &quot;&lt;/span&gt;&lt;/span&gt;&quot;;</span>
		} else {
<span class="nc" id="L473">			return &quot;&quot;;</span>
		}
	}
	
	private static String getImgAltOfSpecialRules(ValidationResult vr,Localizer localizer){
<span class="fc" id="L478">		String imgAlt = null;</span>
<span class="fc" id="L479">		boolean toBidChoiceViolateMinPeriod = vr.getMessageResource().equals(</span>
				RmEjbBundleKey.TIMEOFF_BID_TOCHOICE_VIOLATE_MIN_PERIOD_VALUE);
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">		if (toBidChoiceViolateMinPeriod) {</span>
<span class="nc" id="L482">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME,</span>
					RmWebBundleKey.TIMEOFF_BID_TOCHOICE_VIOLATE_MIN_PERIOD_VALUE_VALIDATION_MSG);
		}
<span class="fc" id="L485">		boolean toBidChoiceViolateMaxPeriod = vr.getMessageResource().equals(</span>
				RmEjbBundleKey.TIMEOFF_BID_TOCHOICE_VIOLATE_MAX_PERIOD_VALUE);
<span class="pc bpc" id="L487" title="1 of 2 branches missed.">		if (toBidChoiceViolateMaxPeriod) {</span>
<span class="nc" id="L488">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME,</span>
					RmWebBundleKey.TIMEOFF_BID_TOCHOICE_VIOLATE_MAX_PERIOD_VALUE_VALIDATION_MSG);
		}
<span class="pc bpc" id="L491" title="1 of 2 branches missed.">		boolean toContainedInSchedule = vr.getMessageResource() != null ? vr.getMessageResource().equals(</span>
				RmEjbBundleKey.TO_CONTAINED_IN_SCHEDTO) : false;
<span class="pc bpc" id="L493" title="1 of 2 branches missed.">		if (toContainedInSchedule) {</span>
<span class="nc" id="L494">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_CONTAINED_IN_SCHEDTO_VALIDATION_MSG);</span>
		}
<span class="fc" id="L496">		boolean toChoiceBeforeEmpStart = vr.getMessageResource().equals(RmEjbBundleKey.TO_TIMEOFF_BEFORE_START);</span>
		
<span class="pc bpc" id="L498" title="1 of 2 branches missed.">		if (toChoiceBeforeEmpStart) {</span>
<span class="nc" id="L499">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_TIMEOFF_BEFORE_START_VALIDATION_MSG);</span>
		}
<span class="fc" id="L501">		boolean toChoiceAfterEmpEnd = vr.getMessageResource().equals(RmEjbBundleKey.TO_TIMEOFF_AFTER_TERM);</span>
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">		if (toChoiceAfterEmpEnd) {</span>
<span class="nc" id="L503">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_TIMEOFF_AFTER_TERM_VALIDATION_MSG);</span>
		}
<span class="fc" id="L505">		return imgAlt;</span>
	}

	public static String[] getImgStrings(String validatorName, Localizer localizer) {
		String imgSrc;
		String imgAlt;

<span class="pc bpc" id="L512" title="1 of 2 branches missed.">		if (TO_CHOICE_LEN_ZERO_VAL_NAME.equals(validatorName)) {</span>
<span class="nc" id="L513">			imgSrc = ImageFileID.ALERT_YELLOW;</span>
<span class="nc" id="L514">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_CHOICE_HAS_ZERO_LEN);</span>
<span class="pc bpc" id="L515" title="1 of 2 branches missed.">		} else if (TO_CHOICE_LEN_CONTAINS_HOL_VAL_NAME.equals(validatorName)) {</span>
<span class="nc" id="L516">			imgSrc = ImageFileID.ALERT_YELLOW;</span>
<span class="nc" id="L517">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_CHOICE_CONTAINS_HOLIDAY);</span>
<span class="pc bpc" id="L518" title="1 of 2 branches missed.">		} else if (PSS_DIFF_BASE_SHIFT_ACTIVITIES_VAL_NAME.equals(validatorName)) {</span>
<span class="nc" id="L519">			imgSrc = ImageFileID.ALERT_YELLOW;</span>
<span class="nc" id="L520">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.VALIDATION_PSS_DIFF_BASE_SHIFT_ACTIVITIES);</span>
<span class="pc bpc" id="L521" title="1 of 2 branches missed.">		} else if (TO_CHOICE_CONTAINS_ORG_CHANGE_VAL_NAME.equals(validatorName)) {</span>
<span class="nc" id="L522">			imgSrc = ImageFileID.ALERT_YELLOW;</span>
<span class="nc" id="L523">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_CHOICE_CONTAINS_ORG_CHANGE);</span>
		} else {
<span class="fc" id="L525">			ValidationResources vrs = ValidationModelHandler.getValidationResource(validatorName);</span>
<span class="pc bpc" id="L526" title="1 of 2 branches missed.">			if (vrs == null) {</span>
<span class="nc" id="L527">				return null;</span>
			}

<span class="fc" id="L530">			imgSrc = vrs.getIconPath(localizer);</span>
<span class="fc" id="L531">			imgAlt = vrs.getErrorMessage(localizer);</span>
		}

<span class="fc" id="L534">		return new String[] { imgSrc, imgAlt };</span>
	}

	/**
	 * Return True if Authorized to Update Request
	 */
	public static boolean isAuthToUpdate(RequestContext context, RequestAggregate request) throws RemoteException, BbmException {
<span class="fc" id="L541">		boolean isAuth = false;</span>

<span class="pc bpc" id="L543" title="1 of 2 branches missed.">		if (request instanceof TORequest) {</span>
<span class="fc" id="L544">			isAuth = isAuthorized(context, (TORequest) request, true);</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">		} else if (request instanceof ShiftSwapRequest) {</span>
<span class="nc" id="L546">			isAuth = isAuthorized(context, (ShiftSwapRequest) request, true);</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">		} else if (request instanceof ShiftBidRequest) {</span>
<span class="nc" id="L548">			isAuth = isAuthorized(context, (ShiftBidRequest) request, true);</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">		} else if (request instanceof CustShiftReq) {</span>
<span class="nc" id="L550">			isAuth = isAuthorized(context, (CustShiftReq) request, true);</span>
		}

<span class="fc" id="L553">		return isAuth;</span>
	}

	/**
	 * Return True if Authorized to Update Request
	 */
	public static boolean isAuthToView(RequestContext context, RequestAggregate request) throws RemoteException, BbmException {
<span class="nc" id="L560">		boolean isAuth = false;</span>

<span class="nc bnc" id="L562" title="All 2 branches missed.">		if (request instanceof TORequest) {</span>
<span class="nc" id="L563">			isAuth = isAuthorized(context, (TORequest) request, false);</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">		} else if (request instanceof ShiftSwapRequest) {</span>
<span class="nc" id="L565">			isAuth = isAuthorized(context, (ShiftSwapRequest) request, false);</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">		} else if (request instanceof ShiftBidRequest) {</span>
<span class="nc" id="L567">			isAuth = isAuthorized(context, (ShiftBidRequest) request, false);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">		} else if (request instanceof CustShiftReq) {</span>
<span class="nc" id="L569">			isAuth = isAuthorized(context, (CustShiftReq) request, false);</span>
		}

<span class="nc" id="L572">		return isAuth;</span>
	}

	/**
	 * Verify whether user is authorized to access the request
	 *
	 * It also adds error message to context if user is not authorized.
	 */
	public static boolean isAuthorized(RequestContext context, TORequest request, boolean isUpdate) throws RemoteException, BbmException {
<span class="fc" id="L581">		boolean isAuthorized = false;</span>

<span class="fc" id="L583">		User user = context.getUser();</span>
<span class="fc" id="L584">		boolean isMyRequest = isMyRequest(user, request);</span>
<span class="pc bpc" id="L585" title="1 of 2 branches missed.">		if (isMyRequest) {</span>
			ID privID;
<span class="pc bpc" id="L587" title="1 of 2 branches missed.">			if (!request.isFlexTimeRequest()) {</span>
<span class="pc bpc" id="L588" title="1 of 2 branches missed.">				privID = isUpdate ? PrivilegeKeys.TOM_MODIFYPERSONALREQUESTS_ID : PrivilegeKeys.TOM_VIEWPERSONALREQUESTS_ID;</span>
			} else {
<span class="nc bnc" id="L590" title="All 2 branches missed.">				privID = isUpdate ? PrivilegeKeys.FT_MODIFYPERSONALREQUESTS_ID : PrivilegeKeys.FT_VIEWPERSONALREQUESTS_ID;</span>
			}
<span class="fc" id="L592">			isAuthorized = user.isAuthorized(privID);</span>
<span class="fc" id="L593">		} else {</span>
			ID privID;
<span class="nc bnc" id="L595" title="All 2 branches missed.">			if (!request.isFlexTimeRequest()) {</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">				privID = isUpdate ? PrivilegeKeys.TOM_MODIFYREQUESTSFOREMPLOYEE_ID : PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE_ID;</span>
			} else {
<span class="nc bnc" id="L598" title="All 2 branches missed.">				privID = isUpdate ? PrivilegeKeys.FT_MODIFYREQUESTSFOREMPLOYEE_ID : PrivilegeKeys.FT_VIEWREQUESTSFOREMPLOYEE_ID;</span>
			}
<span class="nc" id="L600">			ID empID = request.getEmployeeID();</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">			if (empID != null) {</span>
<span class="nc" id="L602">				ID orgID = RequestsMH.getEmpOrgID(context, empID);</span>
<span class="nc" id="L603">				isAuthorized = user.isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID));</span>
			}
		}

<span class="pc bpc" id="L607" title="1 of 2 branches missed.">		if (!isAuthorized) {</span>
<span class="nc" id="L608">			addUnauthorizedMsg(context, isUpdate);</span>
		}
<span class="fc" id="L610">		return isAuthorized;</span>
	}

	/**
	 * Verify whether user is authorized to access the request
	 *
	 * It also adds error message to context if user is not authorized.
	 */
	public static boolean isAuthorized(RequestContext context, ShiftSwapRequest request, boolean isUpdate) throws RemoteException,
			BbmException {
<span class="nc" id="L620">		boolean isAuthorized = false;</span>

<span class="nc" id="L622">		User user = context.getUser();</span>
<span class="nc" id="L623">		boolean isMyRequest = isMyRequest(user, request);</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">		if (isMyRequest) {</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">			ID privID = isUpdate ? PrivilegeKeys.SS_MODIFYPERSONALREQUESTS_ID : PrivilegeKeys.SS_VIEWPERSONALREQUESTS_ID;</span>
<span class="nc" id="L626">			isAuthorized = user.isAuthorized(privID);</span>
<span class="nc" id="L627">		} else {</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">			ID privID = isUpdate ? PrivilegeKeys.SS_MODIFYREQUESTSFOREMPLOYEE_ID : PrivilegeKeys.SS_VIEWREQUESTSFOREMPLOYEE_ID;</span>

<span class="nc" id="L630">			List empIDList = request.getEmployees();</span>
<span class="nc" id="L631">			Map orgMap = RequestsMH.getEmpOrgMap(context, empIDList);</span>
<span class="nc" id="L632">			ID orgID1 = (ID) orgMap.get(empIDList.get(0));</span>
<span class="nc" id="L633">			ID orgID2 = (ID) orgMap.get(empIDList.get(1));</span>

<span class="nc bnc" id="L635" title="All 2 branches missed.">			isAuthorized = user.isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID1))</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">					|| user.isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID2));</span>
		}

<span class="nc bnc" id="L639" title="All 2 branches missed.">		if (!isAuthorized) {</span>
<span class="nc" id="L640">			addUnauthorizedMsg(context, isUpdate);</span>
		}
<span class="nc" id="L642">		return isAuthorized;</span>
	}

	/**
	 * Verify whether user is authorized to access the request
	 *
	 * It also adds error message to context if user is not authorized.
	 */
	public static boolean isAuthorized(RequestContext context, ShiftBidRequest request, boolean isUpdate) throws RemoteException,
			BbmException {
<span class="nc" id="L652">		boolean isAuthorized = false;</span>

<span class="nc" id="L654">		User user = context.getUser();</span>
<span class="nc" id="L655">		boolean isMyRequest = isMyRequest(user, request);</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">		if (isMyRequest) {</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">			ID privID = isUpdate ? PrivilegeKeys.SB_MODIFYPERSONALBIDS_ID : PrivilegeKeys.SB_VIEWPERSONALBIDS_ID;</span>
<span class="nc" id="L658">			isAuthorized = user.isAuthorized(privID);</span>
<span class="nc" id="L659">		} else {</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">			ID privID = isUpdate ? PrivilegeKeys.SB_MODIFYSHIFTBIDSFOREMP_ID : PrivilegeKeys.SB_VIEWSHIFTBIDSFOREMP_ID;</span>

<span class="nc" id="L662">			ID empID = request.getEmployeeID();</span>
<span class="nc" id="L663">			ID orgID = RequestsMH.getEmpOrgID(context, empID);</span>
<span class="nc" id="L664">			isAuthorized = user.isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID));</span>
		}

<span class="nc bnc" id="L667" title="All 2 branches missed.">		if (!isAuthorized) {</span>
<span class="nc" id="L668">			addUnauthorizedMsg(context, isUpdate);</span>
		}
<span class="nc" id="L670">		return isAuthorized;</span>
	}

	/**
	 * Verify whether user is authorized to access the Custom Shift Request.
	 *
	 * It also adds error message to context if user is not authorized.
	 */
	public static boolean isAuthorized(RequestContext context, CustShiftReq request, boolean isUpdate) throws RemoteException, BbmException {
<span class="nc" id="L679">		boolean isAuthorized = false;</span>
<span class="nc" id="L680">		User user = context.getUser();</span>
<span class="nc" id="L681">		boolean isMyRequest = isMyRequest(user, request);</span>

<span class="nc bnc" id="L683" title="All 2 branches missed.">		if (isMyRequest) {</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">			ID privID = isUpdate ? PrivilegeKeys.CS_MODIFYPERSONALREQUESTS_ID : PrivilegeKeys.CS_VIEWPERSONALREQUESTS_ID;</span>
<span class="nc" id="L685">			isAuthorized = user.isAuthorized(privID);</span>
<span class="nc" id="L686">		} else {</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">			ID privID = isUpdate ? PrivilegeKeys.CS_MODIFYREQUESTSFOREMPLOYEE_ID : PrivilegeKeys.CS_VIEWREQUESTSFOREMPLOYEE_ID;</span>

<span class="nc" id="L689">			ID empID = request.getEmployeeID();</span>
<span class="nc" id="L690">			ID orgID = RequestsMH.getEmpOrgID(context, empID);</span>
<span class="nc" id="L691">			isAuthorized = user.isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID));</span>
		}

<span class="nc bnc" id="L694" title="All 2 branches missed.">		if (!isAuthorized) {</span>
<span class="nc" id="L695">			addUnauthorizedMsg(context, isUpdate);</span>
		}

<span class="nc" id="L698">		return isAuthorized;</span>
	}

	public static Map&lt;ID, Boolean&gt; getAuctionmapForApprovedSBRequests(Collection requestList) throws Exception {
<span class="nc" id="L702">		List&lt;ID&gt; auctionIDList = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">		for (Iterator it = requestList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L704">			RequestAggregate request = (RequestAggregate) it.next();</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">			if (request.getRequestType().equals(Request.REQUESTTYPE_SHIFTBID)</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">					&amp;&amp; request.getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L707">				auctionIDList.add(((ShiftBidRequest) request).getShiftBidAuctionID());</span>
			}
<span class="nc" id="L709">		}</span>
<span class="nc" id="L710">		Map&lt;ID, Boolean&gt; auctionMap = null;</span>
		//now get the auction map
<span class="nc bnc" id="L712" title="All 4 branches missed.">		if (auctionIDList != null &amp;&amp; auctionIDList.size() &gt; 0) {</span>
<span class="nc" id="L713">			auctionMap = new HashMap&lt;ID, Boolean&gt;(auctionIDList.size());</span>
<span class="nc" id="L714">			Collection auctionIDs = AuctionMH.getAuctionsByIDs(auctionIDList);</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">			for (Iterator it = auctionIDs.iterator(); it.hasNext();) {</span>
<span class="nc" id="L716">				ShiftBidAuction auction = (ShiftBidAuction) it.next();</span>
<span class="nc" id="L717">				auctionMap.put(auction.getID(), Boolean.valueOf(auction.getIsAuctionOpen()));</span>
<span class="nc" id="L718">			}</span>
		}

<span class="nc" id="L721">		return auctionMap;</span>
	}

	/**
	 * Return true if the Specified Request belongs to current User
	 */
	public static boolean isMyRequest(User user, RequestAggregate request) {
<span class="pc bpc" id="L728" title="1 of 2 branches missed.">		if (request instanceof ShiftSwapRequest) {</span>
<span class="nc" id="L729">			List empIDList = ((ShiftSwapRequest) request).getEmployees();</span>
<span class="nc bnc" id="L730" title="All 4 branches missed.">			return (empIDList != null &amp;&amp; empIDList.contains(user.getEmployeeID()));</span>
		} else {
<span class="fc" id="L732">			ID empID = request.getEmployeeID();</span>
<span class="pc bpc" id="L733" title="2 of 4 branches missed.">			return empID != null &amp;&amp; empID.equals(user.getEmployeeID());</span>
		}
	}

	/**
	 * Add Unauthorized to access/update Request error message
	 */
	public static void addUnauthorizedMsg(RequestContext context, boolean isUpdate) {
<span class="nc bnc" id="L741" title="All 2 branches missed.">		String rbKey = isUpdate ? RmWebBundleKey.UNAUTHORIZED_TO_UPDATE_REQUEST : RmWebBundleKey.UNAUTHORIZED_TO_ACCESS_REQUEST;</span>
<span class="nc" id="L742">		addErrorMsg(context, rbKey);</span>
<span class="nc" id="L743">	}</span>

	/**
	 * Add Error Message
	 */
	private static void addErrorMsg(RequestContext context, String rbKey) {
<span class="nc" id="L749">		String rbName = RmWebBundleKey.BUNDLE_NAME;</span>
<span class="nc" id="L750">		Message msg = new Message(Message.ERROR_TYPE, rbKey, rbName);</span>
<span class="nc" id="L751">		context.addPageMessage(msg);</span>
<span class="nc" id="L752">	}</span>

	/**
	 * Return Request Type for Agents Request Page
	 */
	public static String getRequestType(RequestContext context) {
<span class="fc" id="L758">		RequestsFilterBoxPC rFilterPC = new RequestsFilterBoxPC(context);</span>
<span class="fc" id="L759">		rFilterPC.extractParameters(context.getRequest());</span>
<span class="fc" id="L760">		ID filterID = rFilterPC.getSelectedFilterID();</span>

<span class="fc" id="L762">		String reqType = null;</span>
<span class="pc bpc" id="L763" title="1 of 2 branches missed.">		if (filterID != null) {</span>
<span class="nc" id="L764">			reqType = RequestsMH.getRequestTypeFromFilterID(filterID);</span>
		}

<span class="fc" id="L767">		return reqType;</span>
	}

	/**
	 * Assuming current employee is a participate in the swap, get the display name of the other swap employee
	 * @param request - the shift swap request
	 * @param context - the context of the request which includes the logged in employee id
	 * @return String - the name of the swap employee
	 * @throws Exception
	 */
	public static String getSwapEmployeeName(RequestAggregate request, RequestContext context) throws Exception {
<span class="nc" id="L778">		ShiftSwapRequest ssReq = (ShiftSwapRequest) request;</span>
<span class="nc" id="L779">		List&lt;ID&gt; empIDList = ssReq.getEmployees();</span>
<span class="nc" id="L780">		ID swapID = null;</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">		if (context.getUser().getEmployeeID().compareTo(empIDList.get(0)) == 0) {</span>
<span class="nc" id="L782">			swapID = empIDList.get(1);</span>
		} else {
<span class="nc" id="L784">			swapID = empIDList.get(0);</span>
		}
<span class="nc" id="L786">		EmployeeName e = EmployeeModelHandler.getEmployeeNameByID(context, swapID);</span>
<span class="nc" id="L787">		return context.getLocalizer().formatFullName(e);</span>
	}

	/**
	 * is the logged in employee privileged for the 2 employees participating in the swap
	 * @param request - Shift Swap request
	 * @param privID
	 * @param context
	 * @return true or false
	 * @throws Exception
	 */
	public static boolean isSSAuthPriv(RequestAggregate request, ID privID, RequestContext context) throws Exception {
<span class="nc" id="L799">		ShiftSwapRequest ssReq = (ShiftSwapRequest) request;</span>
<span class="nc" id="L800">		List&lt;ID&gt; empIDList = ssReq.getEmployees();</span>

<span class="nc" id="L802">		Map&lt;ID, ID&gt; eOrgMap = RequestsMH.getEmpOrgMap(context, empIDList);</span>
<span class="nc" id="L803">		ID orgID1 = eOrgMap.get(empIDList.get(0));</span>
<span class="nc" id="L804">		ID orgID2 = eOrgMap.get(empIDList.get(1));</span>

<span class="nc bnc" id="L806" title="All 2 branches missed.">		return context.getUser().isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID1))</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">				|| context.getUser().isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID2));</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>