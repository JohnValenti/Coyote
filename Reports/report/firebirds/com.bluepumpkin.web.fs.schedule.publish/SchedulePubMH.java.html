<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SchedulePubMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.schedule.publish</a> &gt; <span class="el_source">SchedulePubMH.java</span></div><h1>SchedulePubMH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.schedule.publish;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.Iterator;
import java.util.List;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.transaction.UserTransaction;

import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.fs.Log;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:       SchedulePubMH
 * Description: Schedule Publish Model Handler
 * Copyright:   Copyright (c) 2004
 * Company:     Blue Pumpkin Software, Inc
 *
 * @author David Su, dsu
 * @version 1.0
 *          Created on Aug 24, 2004, 9:22:08 AM
 */
<span class="nc" id="L32">public class SchedulePubMH {</span>

	static final int PAST_TYPE = 0;
	static final int FUTURE_TYPE = 1;

<span class="nc" id="L37">	private static final Category LOG = Log.initCategory(SchedulePubMH.class.getName());</span>
	private static final int TWENTRY_MINS_IN_SECS = 20 * 60;
	private static final int CHUNCK_SIZE = 100;

	/**
	 * Publish Schedule for specified Dates
	 *
	 * @param fromDate - From DAte
	 * @param toDate - To Date
	 * @param type - Type of events to publish, either PAST_TYPE or FUTURE_TYPE
	 * @throws BbmException
	 * @throws RemoteException
	 */
	public static void publishSchedForDates(RequestContext context, Date fromDate, Date toDate, int type) throws Exception, RemoteException {
<span class="nc" id="L51">		Collection empIDs = EmployeeModelHandler.getAllEmployeeIDsVisibleToCurrentUser(context);</span>

<span class="nc" id="L53">		int processedCount=0;</span>

		try {
<span class="nc" id="L56">			LOG.info(&quot;[publishSchedForDates] Start publishing for &quot; + empIDs.size() + &quot; employees &quot; + &quot; : &quot; + fromDate + &quot; - &quot; + toDate);</span>
			
<span class="nc" id="L58">			ScheduleAccessManager mgr = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc" id="L59">			List empChunk = new ArrayList(CHUNCK_SIZE);</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">			for(Iterator it=empIDs.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L61">				empChunk.add(it.next());</span>
<span class="nc bnc" id="L62" title="All 4 branches missed.">				if (empChunk.size()==CHUNCK_SIZE || !it.hasNext()) {</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">					if (type == PAST_TYPE)</span>
<span class="nc" id="L64">						publishSchedForDates(mgr, empChunk, fromDate, toDate);</span>
					else
<span class="nc" id="L66">						publishTimeOffForDates(mgr, empChunk, fromDate, toDate);</span>
<span class="nc" id="L67">					processedCount += empChunk.size();</span>
<span class="nc" id="L68">					empChunk.clear();</span>
				}
			}
		} finally {
<span class="nc" id="L72">			LOG.info(&quot;[publishSchedForDates] Completed publishing for &quot; + processedCount + &quot; employees &quot; + &quot; : &quot; + fromDate + &quot; - &quot; + toDate);</span>
<span class="nc" id="L73">		}</span>
<span class="nc" id="L74">	}</span>

	private static void publishTimeOffForDates(ScheduleAccessManager mgr, Collection empIDs, Date fromDate, Date toDate)  throws Exception, RemoteException {
<span class="nc" id="L77">		LOG.info(&quot;Processing empIDs:&quot; + empIDs);</span>

		// Resolve default transaction time out by allowing 1 hour as timeout
<span class="nc" id="L80">		Context c = new InitialContext();</span>
<span class="nc" id="L81">		UserTransaction ut = (UserTransaction) c.lookup(&quot;java:comp/UserTransaction&quot;);</span>
<span class="nc" id="L82">		ut.setTransactionTimeout(TWENTRY_MINS_IN_SECS);</span>
<span class="nc" id="L83">		ut.begin();</span>
        try {
<span class="nc" id="L85">			mgr.publishTimeOffEvents(empIDs, fromDate, toDate);</span>
<span class="nc" id="L86">        } catch (Exception ex) {</span>
<span class="nc" id="L87">        	ut.rollback();</span>
<span class="nc" id="L88">        	LOG.info(&quot;Fail to publish time off events for employees: &quot; + empIDs);</span>
<span class="nc" id="L89">        	return;</span>
<span class="nc" id="L90">        }</span>
		
<span class="nc" id="L92">		ut.commit();</span>
<span class="nc" id="L93">		LOG.info(&quot;Completed Processing specified empIDs.&quot;);</span>
<span class="nc" id="L94">	}</span>


	private static void publishSchedForDates(ScheduleAccessManager mgr, Collection empIDs, Date fromDate, Date toDate)  throws Exception, RemoteException {
<span class="nc" id="L98">		LOG.info(&quot;Processing empIDs:&quot; + empIDs);</span>

		// Resolve default transaction time out by allowing 1 hour as timeout
<span class="nc" id="L101">		Context c = new InitialContext();</span>
<span class="nc" id="L102">		UserTransaction ut = (UserTransaction) c.lookup(&quot;java:comp/UserTransaction&quot;);</span>
<span class="nc" id="L103">		ut.setTransactionTimeout(TWENTRY_MINS_IN_SECS);</span>
<span class="nc" id="L104">		ut.begin();</span>
		try {
<span class="nc" id="L106">			mgr.publishSchedule(empIDs, fromDate, toDate);</span>
<span class="nc" id="L107">		} catch (Exception ex) {</span>
<span class="nc" id="L108">			ut.rollback();</span>
<span class="nc" id="L109">			LOG.info(&quot;Fail to publish events for employees: &quot; + empIDs);</span>
<span class="nc" id="L110">        	return;</span>
<span class="nc" id="L111">		}</span>
		
<span class="nc" id="L113">		ut.commit();</span>
<span class="nc" id="L114">		LOG.info(&quot;Completed Processing specified empIDs.&quot;);</span>
<span class="nc" id="L115">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>