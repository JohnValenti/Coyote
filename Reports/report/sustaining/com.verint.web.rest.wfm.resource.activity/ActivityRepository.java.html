<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityRepository.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.rest.wfm.resource.activity</a> &gt; <span class="el_source">ActivityRepository.java</span></div><h1>ActivityRepository.java</h1><pre class="source lang-java linenums">package com.verint.web.rest.wfm.resource.activity;

import java.rmi.RemoteException;
import java.util.Collection;
import java.util.Collections;
import java.util.Set;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import javax.inject.Inject;
import javax.ws.rs.container.ContainerRequestContext;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityValidationException;
import com.bluepumpkin.ejb.bbm.base.BbmCreateDuplicateKeyException;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.google.common.collect.Sets;
import com.verint.web.rest.wfm.exception.EntityDeleteException;
import com.verint.web.rest.wfm.repository.RepositoryLogger;
import com.verint.web.rest.wfm.repository.ValidateJsonApiFilterParams;
import com.verint.web.rest.wfm.repository.WfoResourceRepository;
import com.verint.web.rest.wfm.util.IdUtil;
import com.witness.ejb.bbm.delete.DeleteException;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.ejb.core.security.model.User;

import io.katharsis.legacy.queryParams.QueryParams;
import io.katharsis.legacy.repository.annotations.JsonApiResourceRepository;



@JsonApiResourceRepository(ActivityEntity.class)
<span class="nc" id="L46">public class ActivityRepository extends WfoResourceRepository&lt;Integer, ActivityEntity&gt; {</span>

<span class="nc" id="L48">	private final static Logger log = LoggerFactory.getLogger(ActivityRepository.class.getName());</span>
	private final static String USE_ACTIVITY_SCOPE_FILTER_KEY = &quot;useActivityScope&quot;;

	@Inject
	private ActivityManager am;

	@Inject
	private WorkResourceManager wrm;

<span class="nc" id="L57">	private final static String ENTITY_NAME = ActivityEntity.class.getSimpleName();</span>

	final static String RESOURCE_NAME = &quot;activities&quot;;

	@Override
	protected Logger logger() {
<span class="nc" id="L63">		return log;</span>
	}

	@Override
	@RepositoryLogger
	public &lt;T extends ActivityEntity&gt; T save(T entity, ContainerRequestContext requestContext) {
		try {
<span class="nc" id="L70">			Activity activity = ActivityMapper.INSTANCE.entityToActivity(entity);</span>
			//Create new shift assignment if ID is null
<span class="nc bnc" id="L72" title="All 2 branches missed.">			if (activity.getID() == null) {</span>
<span class="nc" id="L73">				ID newId = am.createActivity(activity);</span>
<span class="nc" id="L74">				entity.setID(newId.toInt());</span>
				//Otherwise, update existing assignment
<span class="nc" id="L76">			} else {</span>
<span class="nc" id="L77">				am.updateActivity(activity);</span>
			}
<span class="nc" id="L79">			return entity;</span>
<span class="nc" id="L80">		} catch (RemoteException e) {</span>
<span class="nc" id="L81">			throw handleRemoteException(ENTITY_NAME, Integer.toString(entity.getID()), e);</span>
<span class="nc" id="L82">		} catch (BbmCreateDuplicateKeyException e) {</span>
<span class="nc" id="L83">			throw handleBbmCreateDuplicateKeyException(entity, e);</span>
<span class="nc" id="L84">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L85">			throw handleBbmCreateException(entity, e);</span>
<span class="nc" id="L86">		} catch (ActivityValidationException e) {</span>
<span class="nc" id="L87">			logger().error(&quot;ActivityValidationException was thrown: &quot;, e);</span>
<span class="nc" id="L88">			throw new EntityActivityValidationException(ENTITY_NAME, Integer.toString(entity.getID()), e);</span>
<span class="nc" id="L89">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L90">			throw handleBbmUpdateException(entity, e);</span>
<span class="nc" id="L91">		} catch (MultiUserException e) {</span>
<span class="nc" id="L92">			throw handleMultiUserException(ENTITY_NAME, Integer.toString(entity.getID()), e);</span>
<span class="nc" id="L93">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L94">			throw handleBbmFinderException(ENTITY_NAME, Integer.toString(entity.getID()), e);</span>
		}
	}

	@Override
	@RepositoryLogger
	@ValidateJsonApiFilterParams
	public ActivityEntity findOne(Integer id, QueryParams requestParams, ContainerRequestContext requestContext) {
		try {
<span class="nc" id="L103">			Activity activity = am.findActivityById(ID.fromInt(id));</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">			if (activity == null) {</span>
<span class="nc" id="L105">				return null;</span>
			}
<span class="nc" id="L107">			return ActivityMapper.INSTANCE.activityToEntity(activity);</span>
<span class="nc" id="L108">		} catch (RemoteException e) {</span>
<span class="nc" id="L109">			throw handleRemoteException(ENTITY_NAME, Integer.toString(id), e);</span>
<span class="nc" id="L110">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L111">			throw handleBbmObjectNotFoundException(ENTITY_NAME, Integer.toString(id), e);</span>
<span class="nc" id="L112">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L113">			throw handleBbmFinderException(ENTITY_NAME, Integer.toString(id), e);</span>
		}
	}

	@Override
	@RepositoryLogger
	@ValidateJsonApiFilterParams
	public Iterable&lt;ActivityEntity&gt; findAll(QueryParams queryParams, ContainerRequestContext requestContext) {
		try {
<span class="nc" id="L122">			Collection&lt;Activity&gt; activities = am.getAllActivities();</span>
<span class="nc" id="L123">			Collection&lt;ActivityEntity&gt; activityEntities = ActivityMapper.INSTANCE.activitiesToEntities(activities);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">			if (isFilterByActivityScopeActive()) {</span>
<span class="nc" id="L125">				return filterActivitiesWithScheduleEditPermissionsForCurrentUser(activityEntities, requestContext);</span>
			}
<span class="nc" id="L127">			return activityEntities;</span>
<span class="nc" id="L128">		} catch (RemoteException e) {</span>
<span class="nc" id="L129">			throw handleRemoteException(ENTITY_NAME, ALL_IDS, e);</span>
<span class="nc" id="L130">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L131">			throw handleBbmFinderException(ENTITY_NAME, ALL_IDS, e);</span>
		}
	}

	@Override
	@RepositoryLogger
	@ValidateJsonApiFilterParams
	public Iterable&lt;ActivityEntity&gt; findAll(Iterable&lt;Integer&gt; ids, QueryParams queryParams,
			ContainerRequestContext requestContext) {
		try {
<span class="nc" id="L141">			Collection&lt;Activity&gt; activities = am.findActivities(IdUtil.fromInt(ids));</span>
<span class="nc" id="L142">			Collection&lt;ActivityEntity&gt; activityEntities = ActivityMapper.INSTANCE.activitiesToEntities(activities);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">			if (isFilterByActivityScopeActive()) {</span>
<span class="nc" id="L144">				activityEntities = filterActivitiesWithScheduleEditPermissionsForCurrentUser(activityEntities, requestContext);</span>
			}
<span class="nc" id="L146">			return activityEntities;</span>
<span class="nc" id="L147">		} catch (RemoteException e) {</span>
<span class="nc" id="L148">			throw handleRemoteException(ENTITY_NAME, null, e);</span>
<span class="nc" id="L149">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L150">			throw handleBbmFinderException(ENTITY_NAME, null, e);</span>
		}
	}

	@Override
	@RepositoryLogger
	public void delete(Integer id, ContainerRequestContext requestContext) {
		try {
<span class="nc" id="L158">			am.deleteActivity(ID.fromInt(id));</span>
<span class="nc" id="L159">		} catch (RemoteException e) {</span>
<span class="nc" id="L160">			throw handleRemoteException(ENTITY_NAME, Integer.toString(id), e);</span>
<span class="nc" id="L161">		} catch (DeleteException e) {</span>
<span class="nc" id="L162">			logger().error(&quot;ActivityRepository.delete: An error occurred deleting Activity with ID &quot; + id, e);</span>
<span class="nc" id="L163">			throw new EntityDeleteException(ENTITY_NAME, Integer.toString(id), e);</span>
<span class="nc" id="L164">		}</span>
<span class="nc" id="L165">	}</span>

	@Override
	protected String getResourceName() {
<span class="nc" id="L169">		return RESOURCE_NAME;</span>
	}

	@Override
	protected Set&lt;String&gt; getValidFilterParamKeys() {
<span class="nc" id="L174">		return Sets.newHashSet(USE_ACTIVITY_SCOPE_FILTER_KEY);</span>
	}

	private boolean isFilterByActivityScopeActive() {
<span class="nc" id="L178">		Set&lt;String&gt; useActivityScopeStr = getFilterParam(USE_ACTIVITY_SCOPE_FILTER_KEY);</span>
<span class="nc bnc" id="L179" title="All 4 branches missed.">		if (useActivityScopeStr != null &amp;&amp; !useActivityScopeStr.isEmpty()) {</span>
<span class="nc" id="L180">			return Boolean.parseBoolean(useActivityScopeStr.iterator().next());</span>
		}

<span class="nc" id="L183">		return false;</span>
	}

	/**
	 * Returns a subset of filtered activities that contain only the activities for which the user has schedule
	 * edit permissions.
	 *
	 * This initial set of activities is filtered in two ways:
	 * 1 - Activities in the user's activity scope are included.  Activities are in the user's scope if the user has
	 * activity scope for them.
	 * 2 - The activity belongs to an Organization which is in the user's scope.
	 */
	public Collection&lt;ActivityEntity&gt; filterActivitiesWithScheduleEditPermissionsForCurrentUser(
			Collection&lt;ActivityEntity&gt; activitiesToFilter, ContainerRequestContext context)
			throws RemoteException, BbmFinderException {

		try {
<span class="nc bnc" id="L200" title="All 4 branches missed.">			if (activitiesToFilter != null &amp;&amp; !activitiesToFilter.isEmpty()) {</span>
<span class="nc" id="L201">				User currentUser = getCurrentUser(context);</span>
<span class="nc" id="L202">				Collection&lt;ID&gt; authorizedActivityIds =</span>
<span class="nc" id="L203">						currentUser.getAuthorizedScopes(PrivilegeKeys.FS_MODIFYCALENDAR_ID, Scope.ACTIVITY_SCOPE);</span>

<span class="nc bnc" id="L205" title="All 4 branches missed.">				if (authorizedActivityIds != null &amp;&amp; !authorizedActivityIds.isEmpty()) {</span>
<span class="nc" id="L206">					Collection&lt;ID&gt; scopedOrgIDs = wrm.getAllOrgIDsInUserScopePlusAncestors(currentUser, true);</span>

<span class="nc" id="L208">					Stream&lt;ActivityEntity&gt; entityStream = activitiesToFilter.stream();</span>

					//If scoped activity IDs is a single size with value &quot;-1&quot;, that means that have &quot;All Activity&quot; scope and
					//we should not use the collection of authorizedActivityIds for filtering.
<span class="nc bnc" id="L212" title="All 2 branches missed.">					if (!(authorizedActivityIds.size() == 1 &amp;&amp;</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">							authorizedActivityIds.iterator().next().equals(ID.fromInt(-1)))) {</span>
<span class="nc" id="L214">						entityStream = entityStream</span>
<span class="nc" id="L215">								.filter(a -&gt; authorizedActivityIds.contains(ID.fromInt(a.getOrganizationID())));</span>
					}

<span class="nc" id="L218">					return entityStream</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">							.filter(a -&gt; scopedOrgIDs.contains(ID.fromInt(a.getOrganizationID()))</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">									|| a.getOrganizationID() == Organization.ROOT_ORG_ID)</span>
<span class="nc" id="L221">							.collect(Collectors.toList());</span>
				}
			}

<span class="nc" id="L225">			return Collections.emptyList();</span>
<span class="nc" id="L226">		} catch (BbmException ex) {</span>
<span class="nc" id="L227">			throw new BbmFinderException(ex);</span>
		}
	}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>