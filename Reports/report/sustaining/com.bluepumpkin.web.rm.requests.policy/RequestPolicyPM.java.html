<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestPolicyPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.policy</a> &gt; <span class="el_source">RequestPolicyPM.java</span></div><h1>RequestPolicyPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.policy;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.ResourceBundle;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.setup.autoprocessing.model.AutoProcessingRule;
import com.bluepumpkin.ejb.rm.setup.filingrules.model.RequestFilingRule;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.bluepumpkin.web.rm.requests.RequestsPM;
import com.bluepumpkin.web.rm.setup.RmSetupUtil;
import com.bluepumpkin.web.rm.setup.autoprocessing.AutoProcessingModelHandler;
import com.bluepumpkin.web.rm.setup.autoprocessing.AutoProcessingUtil;
import com.bluepumpkin.web.rm.setup.filingrules.FilingRuleModelHandler;
import com.bluepumpkin.web.rm.setup.filingrules.FilingRuleUtil;
import com.bluepumpkin.web.rm.validation.ValidationRulesMap;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.jsp.HtmlDiv;
import com.witness.web.uif.jsp.HtmlDivWSpan;
import com.witness.web.uif.pagecomponent.BaseNodeData;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;


/**
 * Title:        RequestPolicyPM
 * Description:  Request Policy
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       David Su
 * @version      1.0
 */
public class RequestPolicyPM extends RequestsPM implements ContainersInRowsPM {
	public static final String FILING_RULE_ID = &quot;FilingRuleID&quot;;
	public static final String AUTO_PROCESSING_ID = &quot;AutoProcessingID&quot;;
	
	private static final String OPEN_WPR =
			&quot;&lt;span style=\&quot;width:100%; overflow:auto; height:100\&quot;&gt;&lt;pre class=\&quot;textBlock\&quot;&gt;&quot;;
	private static final String CLOSE_WPR = &quot;&lt;/pre&gt;&lt;/span&gt;&quot;;
	private static final String FORM_ACTION = &quot;my_requests_policy&quot;;

	private ContainerList m_containerList;
	private CollapsibleContainerPC m_toPolicyPC;
	private CollapsibleContainerPC m_ftPolicyPC;
	private CollapsibleContainerPC m_ssPolicyPC;
	private CollapsibleContainerPC m_sbPolicyPC;
	private CollapsibleContainerPC m_csPolicyPC;
	private CollapsibleContainerPC m_autoProPC;
	private CollapsibleContainerPC m_filingRulePC;
	private ResourceBundle m_bbm_bundle;
	private ValidationRulesMap m_vrMap;
<span class="nc" id="L72">	private Collection m_apList = Collections.emptyList();</span>
<span class="nc" id="L73">	private Collection m_frList = Collections.emptyList();</span>
	private TimeZone m_orgTimeZone;

	/**
	 * Constructs a schedule view page model shell.
	 */
	public RequestPolicyPM(RequestContext context)	{
<span class="nc" id="L80">		super(context);</span>
<span class="nc" id="L81">		m_bbm_bundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L82">		m_vrMap = ValidationRulesMap.getInstance();</span>

<span class="nc" id="L84">		m_containerList = new ContainerList(this, 4);</span>
<span class="nc" id="L85">		m_toPolicyPC = createCCPC(&quot;toPolicy&quot;);</span>
<span class="nc" id="L86">		m_ftPolicyPC = createCCPC(&quot;ftPolicy&quot;);</span>
<span class="nc" id="L87">		m_ssPolicyPC = createCCPC(&quot;ssPolicy&quot;);</span>
<span class="nc" id="L88">		m_sbPolicyPC = createCCPC(&quot;sbPolicy&quot;);</span>
<span class="nc" id="L89">		m_csPolicyPC = createCCPC(&quot;csPolicy&quot;);</span>
<span class="nc" id="L90">		m_autoProPC = createCCPC(&quot;autoPro&quot;);</span>
<span class="nc" id="L91">		m_filingRulePC = createCCPC(&quot;filingRule&quot;);</span>
<span class="nc" id="L92">	}</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L98">		return getInstance(context, RequestPolicyPM.class);</span>
	}

	/**
	 * Populate Model
	 */
	protected void loadData() throws Exception {
<span class="nc bnc" id="L105" title="All 2 branches missed.">		if (m_empID!=null) {</span>
<span class="nc" id="L106">			ID orgID = OrganizationModelHandler.getEmployeeOrgID(m_context, m_empID);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">			if (orgID == null){</span>
<span class="nc" id="L108">            	this.addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.EMP_NO_ORG,</span>
    					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L110">            	return;</span>
            }
			//get org time zone for display
<span class="nc" id="L113">			m_orgTimeZone = RmSetupUtil.getOrgTimeZone(m_context, orgID);</span>
<span class="nc" id="L114">			m_orgSetting = RequestsMH.getOrgSetting(orgID);</span>
				
<span class="nc" id="L116">			m_apList = AutoProcessingModelHandler.getAutoProcessingRuleList(orgID, Request.REQUESTTYPE_ALL);</span>
<span class="nc" id="L117">			m_frList = FilingRuleModelHandler.getFilingRuleList(orgID);</span>
		}
<span class="nc" id="L119">	}</span>

	/**
	 * Create Collapsible Container PC
	 */
	private CollapsibleContainerPC createCCPC(String name) {
<span class="nc" id="L125">		CollapsibleContainerPC containerPC = new CollapsibleContainerPC(m_context);</span>
<span class="nc" id="L126">		containerPC.setName(name);</span>
<span class="nc" id="L127">		containerPC.setToggleable(true);</span>
<span class="nc" id="L128">		containerPC.setStyleClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="nc" id="L129">		containerPC.setTemplate(&quot;{0}&quot;);</span>
<span class="nc" id="L130">		return containerPC;</span>
	}

	/**
	 * Initialize Content Tittle
	 */
	protected void initContentTitle()	{
		// Initialize Content Title    
<span class="nc" id="L138">		String pageTitle = i18n(m_bundle, RmWebBundleKey.RM_MYSCHEDULE_POLICIES);</span>
<span class="nc" id="L139">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="nc" id="L140">	}</span>

	/**
	 * Initiailize Container
	 */
	protected void initContainer(CollapsibleContainerPC containerPC, String label_rbKey, String content) {
<span class="nc" id="L146">		String title = i18n(m_bundle, label_rbKey);</span>
<span class="nc" id="L147">		containerPC.setTitle(title);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">		content = (content != null) ? content : &quot;&quot;;</span>
<span class="nc bnc" id="L149" title="All 4 branches missed.">		if (isAccessibilityComplianceMode() &amp;&amp; !StringUtil.isEmpty(content)) {</span>
<span class="nc" id="L150">			content = HtmlUtil.getTabbableLabel(content, null);</span>
		}
<span class="nc" id="L152">		content = OPEN_WPR + content + CLOSE_WPR;</span>
<span class="nc" id="L153">		containerPC.addComponent(content);</span>
<span class="nc" id="L154">		m_containerList.add(containerPC);</span>
<span class="nc" id="L155">	}</span>

	/**
	 * Create and Add Inner List PC to Container
	 */
	private MultiColListPC addInnerListPC(CollapsibleContainerPC container, String label, String pcName) {
<span class="nc" id="L161">		MultiColListPC listPC = new MultiColListPC(m_context) {</span>
			@Override
			protected HtmlDiv getNewHtmlDiv() {
<span class="nc" id="L164">				return new HtmlDivWSpan(getPCAriaLabelID(), label);</span>
			}

			@Override
			protected boolean skipEncloseForKeyboardAccess(BaseNodeData nodeData) {
<span class="nc bnc" id="L169" title="All 2 branches missed.">				return !nodeData.isSelectable();</span>
			}
		};
<span class="nc" id="L172">		listPC.setHeightInPixels(100);</span>
<span class="nc" id="L173">		listPC.setEnabled(false);</span>
<span class="nc" id="L174">		listPC.setWrapperRegion(false);		 </span>
<span class="nc" id="L175">		listPC.setName(pcName);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L177">			listPC.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L178">			listPC.setUseWrapper(true);</span>
<span class="nc" id="L179">			listPC.addTableArrowNavigation();</span>
<span class="nc" id="L180">			listPC.setReadableRowInfoEnabled(true);</span>
<span class="nc" id="L181">			listPC.disableRepeatHeader();</span>
		}
<span class="nc" id="L183">		container.addComponent(listPC);</span>
<span class="nc" id="L184">		return listPC;</span>
	}

	/**
	 * Initialize Auto Processing Container
	 */
	protected void initAutoProcessing() {
<span class="nc bnc" id="L191" title="All 2 branches missed.">		if (!m_orgSetting.getAllowAgentsViewAutoProcessingRules()) return;</span>

<span class="nc" id="L193">		String title = i18n(m_bundle, RmWebBundleKey.RM_ORG_REQUEST_PROCESSING_AUTOPROCESSING);</span>
<span class="nc" id="L194">		String gridTitle = i18n(m_bundle, RmWebBundleKey.RM_ORG_REQUEST_PROCESSING_AUTOPROCESSING_GRID);</span>
<span class="nc" id="L195">		m_autoProPC.setTitle(title);</span>

<span class="nc" id="L197">		MultiColListPC listPC = addInnerListPC(m_autoProPC, gridTitle, AUTO_PROCESSING_ID);</span>
<span class="nc" id="L198">		AutoProcessingUtil.initListHeader(listPC.getHeader(), m_bundle, m_bbm_bundle, false, m_localizer);</span>
<span class="nc" id="L199">		List listModel = new ArrayList();</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">		if (m_apList.isEmpty()) {</span>
			// Create/Add no data msg Row
<span class="nc" id="L202">			MultiColumnNodeData row_data = AutoProcessingUtil.createNoDataRow(m_bundle, false, m_localizer);</span>
<span class="nc" id="L203">			listModel.add(row_data);</span>
<span class="nc" id="L204">		} else {</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">			for(Iterator it=m_apList.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L206">				AutoProcessingRule rule = (AutoProcessingRule)it.next();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">				if (!rule.isApplied()) continue;</span>
				
				DefaultMultiColumnNodeData row_data;
<span class="nc bnc" id="L210" title="All 2 branches missed.">				if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L211">					row_data = AutoProcessingUtil</span>
<span class="nc" id="L212">							.createRuleDataRow(m_context, rule, m_bundle, m_vrMap, null, null, false, m_orgTimeZone, m_localizer, true, true);	</span>
				} else {
<span class="nc" id="L214">					row_data = AutoProcessingUtil</span>
<span class="nc" id="L215">							.createRuleDataRow(m_context, rule, m_bundle, m_vrMap, null, null, false, m_orgTimeZone, m_localizer);	</span>
				}
				
<span class="nc" id="L218">				listModel.add(row_data);</span>
<span class="nc" id="L219">			}</span>
		}
<span class="nc" id="L221">		listPC.setListModel(listModel);</span>
<span class="nc" id="L222">		m_containerList.add(m_autoProPC);</span>
<span class="nc" id="L223">	}</span>

	/**
	 * Initialize Filing Rule Container
	 */
	protected void initFilingRule() {
<span class="nc" id="L229">		String title = i18n(m_bundle, RmWebBundleKey.RM_ORG_REQUEST_PROCESSING_FILINGRULE);</span>
<span class="nc" id="L230">		String gridTitle = i18n(m_bundle, RmWebBundleKey.RM_ORG_REQUEST_PROCESSING_FILINGRULE_GRID);</span>
<span class="nc" id="L231">		m_filingRulePC.setTitle(title);</span>

<span class="nc" id="L233">		MultiColListPC listPC = addInnerListPC(m_filingRulePC, gridTitle, FILING_RULE_ID);</span>
<span class="nc" id="L234">		FilingRuleUtil.initListHeader(listPC.getHeader(), m_bundle, m_bbm_bundle, false, m_localizer);</span>
<span class="nc" id="L235">		List listModel = new ArrayList();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">		if (m_frList.isEmpty()) {</span>
			// Create/Add no data msg Row
<span class="nc" id="L238">			MultiColumnNodeData row_data = FilingRuleUtil.createNoDataRow(m_bundle, false, m_localizer);</span>
<span class="nc" id="L239">			listModel.add(row_data);</span>
<span class="nc" id="L240">		} else {</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">			for(Iterator it=m_frList.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L242">				RequestFilingRule rule = (RequestFilingRule)it.next();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">				if (!rule.isApplied()) continue;</span>

<span class="nc" id="L245">				DefaultMultiColumnNodeData row_data = FilingRuleUtil.createRuleDataRow(</span>
						m_context, rule, m_bundle, null, null, false, m_localizer, m_orgTimeZone);
<span class="nc" id="L247">				listModel.add(row_data);</span>
<span class="nc" id="L248">			}</span>
		}
<span class="nc" id="L250">		listPC.setListModel(listModel);</span>

<span class="nc" id="L252">		m_containerList.add(m_filingRulePC);</span>
<span class="nc" id="L253">	}</span>

	// Not Used
<span class="nc" id="L256">	protected void initHeader() {}</span>

	/**
	 * Initialize Selectable Items
	 */
	protected void initSelectableItems() {
<span class="nc bnc" id="L262" title="All 2 branches missed.">		if (m_orgSetting==null) return;</span>

<span class="nc" id="L264">		User user = m_context.getUser();</span>

<span class="nc bnc" id="L266" title="All 2 branches missed.">		if (user.isAuthorized(PrivilegeKeys.TOM_VIEWPERSONALREQUESTS_ID)) {</span>
<span class="nc" id="L267">			initContainer(m_toPolicyPC,</span>
					RmWebBundleKey.ORG_RM_SETTINGS_TO_POLICY_TITLE,
<span class="nc" id="L269">					m_orgSetting.getTimeOffPolicy());</span>
		}

<span class="nc bnc" id="L272" title="All 2 branches missed.">		if (user.isAuthorized(PrivilegeKeys.FT_VIEWPERSONALREQUESTS_ID)) {</span>
<span class="nc" id="L273">			initContainer(m_ftPolicyPC,</span>
					RmWebBundleKey.ORG_RM_SETTINGS_FT_POLICY_TITLE,
<span class="nc" id="L275">					m_orgSetting.getFlexTimePolicy());</span>
		}

<span class="nc bnc" id="L278" title="All 2 branches missed.">		if (user.isAuthorized(PrivilegeKeys.SS_VIEWPERSONALREQUESTS_ID)) {</span>
<span class="nc" id="L279">			initContainer(m_ssPolicyPC,</span>
					RmWebBundleKey.ORG_RM_SETTINGS_SS_POLICY_TITLE,
<span class="nc" id="L281">					m_orgSetting.getShiftSwapPolicy());</span>
		}

<span class="nc bnc" id="L284" title="All 2 branches missed.">		if (user.isAuthorized(PrivilegeKeys.SB_VIEWPERSONALBIDS_ID)) {</span>
<span class="nc" id="L285">			initContainer(m_sbPolicyPC,</span>
					RmWebBundleKey.ORG_RM_SETTINGS_SB_POLICY_TITLE,
<span class="nc" id="L287">					m_orgSetting.getShiftBidPolicy());</span>
		}
		
<span class="nc bnc" id="L290" title="All 2 branches missed.">		if (user.isAuthorized(PrivilegeKeys.CS_VIEWPERSONALREQUESTS_ID)) {</span>
<span class="nc" id="L291">			initContainer(m_csPolicyPC,</span>
					RmWebBundleKey.ORG_RM_SETTINGS_CS_POLICY_TITLE,
<span class="nc" id="L293">					m_orgSetting.getCustomShiftPolicy());</span>
		}

<span class="nc" id="L296">		initAutoProcessing();</span>
<span class="nc" id="L297">		initFilingRule();</span>
<span class="nc" id="L298">	}</span>

	/**
	 * Initialize Toolbar
	 */
	@Override
	protected void initToolbar() {
<span class="nc" id="L305">		this.getToolbar().setIsRegion(false);</span>
<span class="nc" id="L306">	}</span>

	/** Return URL for HTML Form Action
	 *
	 */
	public String getFormAction() {
<span class="nc" id="L312">		return FORM_ACTION;</span>
	}

	/**
	 * Return List of Containers
	 *
	 * NOTE: Items in the Collection will be treated either as Page Components or
	 *       just a basic Object.
	 */
	public Collection getContainers() {
<span class="nc" id="L322">		return m_containerList;</span>
	}	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>