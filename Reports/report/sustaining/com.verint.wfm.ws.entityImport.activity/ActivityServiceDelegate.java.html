<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityServiceDelegate.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.wfm.ws.entityImport.activity</a> &gt; <span class="el_source">ActivityServiceDelegate.java</span></div><h1>ActivityServiceDelegate.java</h1><pre class="source lang-java linenums">package com.verint.wfm.ws.entityImport.activity;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import javax.annotation.PostConstruct;
import javax.annotation.PreDestroy;

import org.apache.commons.collections.CollectionUtils;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Filter.Filter;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategory;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategoryFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityValidationException;
import com.bluepumpkin.ejb.bbm.base.BbmCreateDuplicateKeyException;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.MapUtil;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.SystemType;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.vo.validators.ValidatorConstants;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.core.Log;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.wfm.ws.ServiceApplicationException;
import com.verint.wfm.ws.entityImport.EntityImportService;
import com.verint.wfm.ws.entityImport.activity.model.ActivityDTO;
import com.verint.wfm.ws.util.ExternalIDUtil;
import com.verint.wfm.ws.util.MapJAXBType;
import com.verint.wfm.ws.util.SyncUtil;

/**
 * @author Eliot Clingman, Copyright (c) 2011 by Verint Systems, Inc. All Rights Reserved. Organization Manager Web
 *         Service This supports methods to synchronize activity instances between WFO and an external application
 */
<span class="nc" id="L54">public class ActivityServiceDelegate {</span>

	private static final long serialVersionUID = 1L;

	// predefined source measure
<span class="nc" id="L59">	public static final ID SOURCE_MEASURE_TIME_IN_ADMIN = ID.fromInt(-277050);</span>

<span class="nc" id="L61">	private static final Category CAT = Log.initCategory(ActivityServiceDelegate.class.getName());</span>
<span class="nc" id="L62">	private ActivityManager m_activityManager = null;</span>
<span class="nc" id="L63">	private WorkResourceManager m_workResourceManager = null;</span>

	public List&lt;ActivityNotPersistedInfo&gt; createOrUpdate(Collection&lt;ActivityDTO&gt; activityDTOs, String systemTypeName)
			throws ServiceApplicationException {

<span class="nc" id="L68">		SystemType systemType = SystemType.valueOf(systemTypeName);</span>
<span class="nc" id="L69">		CAT.debug(&quot;createOrUpdate(): systemType.name(): &quot; + systemType.name());</span>
<span class="nc" id="L70">		List&lt;ActivityNotPersistedInfo&gt; activityNotPersistedInfos = new ArrayList&lt;ActivityNotPersistedInfo&gt;();</span>
<span class="nc bnc" id="L71" title="All 4 branches missed.">		if (activityDTOs == null || activityDTOs.isEmpty()) {</span>
<span class="nc" id="L72">			CAT.debug(&quot;No activities to create or update&quot;);</span>
<span class="nc" id="L73">			return activityNotPersistedInfos;</span>
		}

		// Convert From DTO's to entities so that the EJB layer can handle them
<span class="nc" id="L77">		Collection&lt;ActivityWithMediaIdsWrapper&gt; newActivityWrappers = new ArrayList&lt;ActivityWithMediaIdsWrapper&gt;();</span>
<span class="nc" id="L78">		Collection&lt;ActivityWithMediaIdsWrapper&gt; oldActivityWrappers = new ArrayList&lt;ActivityWithMediaIdsWrapper&gt;();</span>
		
<span class="nc" id="L80">		convertToEntity(activityDTOs, systemType, newActivityWrappers, oldActivityWrappers, activityNotPersistedInfos);</span>
<span class="nc" id="L81">		CAT.info(&quot;createOrUpdate(): newActivityWrappers.size(): &quot; + newActivityWrappers.size());</span>
<span class="nc" id="L82">		CAT.info(&quot;createOrUpdate(): oldActivityWrappers.size(): &quot; + oldActivityWrappers.size());</span>

		// Create persist the new activities
<span class="nc bnc" id="L85" title="All 2 branches missed.">		if (m_activityManager == null) {</span>
<span class="nc" id="L86">			CAT.error(&quot;ActivityService failed to obtain reference to activityManager session bean!&quot;);</span>
<span class="nc" id="L87">			throw new ServiceApplicationException(</span>
					&quot;ActivityService failed to obtain reference to activityManager session bean!&quot;);
		}

<span class="nc bnc" id="L91" title="All 2 branches missed.">		for (ActivityWithMediaIdsWrapper newActivityWrapper : newActivityWrappers) {</span>
<span class="nc" id="L92">			Activity newActivity = newActivityWrapper.getActivity();</span>
<span class="nc" id="L93">			CAT.info(&quot;Before create entity... note org id: &quot; + newActivity.getOrganizationId().toString());</span>
			try {
				// create activity, and link external id to it in the map table
<span class="nc" id="L96">				ID activityId = m_activityManager.createActivity(newActivity, newActivityWrapper.getMediaIDs(),systemType);</span>
				// Warning: this should really be part of the create method but its ugly to change Corba exposed methods
<span class="nc bnc" id="L98" title="All 2 branches missed.">				if (CollectionUtils.isNotEmpty(newActivityWrapper.getQueueIDs())) {</span>
<span class="nc" id="L99">					m_activityManager.createActivityQueue(activityId, newActivityWrapper.getQueueIDs());</span>
				}
<span class="nc" id="L101">				CAT.info(&quot;In createOrUpdate method: inserted the Activity and linked activity external id!&quot;);</span>
			}

<span class="nc" id="L104">			catch (ActivityValidationException e) {</span>
<span class="nc" id="L105">				throw new ServiceApplicationException(e);</span>
				// Note: any problem with validity or database state should have been detected by now
				// So any exceptions thrown here are unrecoverable system bugs
<span class="nc" id="L108">			} catch (BbmCreateDuplicateKeyException e) {</span>
<span class="nc" id="L109">				CAT.error(&quot;In createOrUpdate method(BbmCreateException): failed to create the activity!&quot;, e);</span>
<span class="nc" id="L110">				throw new ServiceApplicationException(</span>
						&quot;In createOrUpdate method(BbmCreateException):persistence framework tried to reuse unique key for new activity!&quot;,
						e);
<span class="nc" id="L113">			} catch (BbmCreateException e) {</span>
<span class="nc" id="L114">				CAT.error(&quot;In createOrUpdate method(BbmCreateException): failed to create the activity!&quot;, e);</span>
<span class="nc" id="L115">				throw new ServiceApplicationException(</span>
						&quot;In createOrUpdate method(BbmCreateException): failed to create the activity!&quot;, e);
<span class="nc" id="L117">			} catch (RemoteException e) {</span>
<span class="nc" id="L118">				throw new ServiceApplicationException(</span>
						&quot;There was a communication fault invoking activityManager.createActivity()&quot;, e);
<span class="nc" id="L120">			} catch (RuntimeException e) {</span>
<span class="nc" id="L121">				CAT.error(&quot;In createOrUpdate method(Throwable): failed to create the activity!&quot;, e);</span>
<span class="nc" id="L122">				throw new ServiceApplicationException(</span>
						&quot;In createOrUpdate method(Throwable): failed to create the activity!&quot;, e);
<span class="nc" id="L124">			} catch (BbmFinderException e) {</span>
<span class="nc" id="L125">				CAT.error(&quot;In createOrUpdate method(BbmFinderException): failed to create the activity!&quot;, e);</span>
<span class="nc" id="L126">				throw new ServiceApplicationException(</span>
					&quot;In createOrUpdate method(BbmFinderException): failed to create the activity!&quot;, e);
<span class="nc" id="L128">			}</span>
<span class="nc" id="L129">		}</span>

		// Persist update of old activities
<span class="nc bnc" id="L132" title="All 2 branches missed.">		for (ActivityWithMediaIdsWrapper oldActivityWrapper : oldActivityWrappers) {</span>
<span class="nc" id="L133">			Activity oldActivity = oldActivityWrapper.getActivity();</span>
<span class="nc" id="L134">			CAT.debug(&quot;Before update entity... note org id: &quot; + oldActivity.getOrganizationId());</span>
			try {
<span class="nc" id="L136">				m_activityManager.updateActivity(oldActivity, oldActivityWrapper.getMediaIDs(),</span>
<span class="nc" id="L137">						oldActivityWrapper.getQueueIDs());</span>
				
<span class="nc bnc" id="L139" title="All 2 branches missed.">				if(oldActivityWrapper.getActivityExternalID() != null) {</span>
<span class="nc" id="L140">					ID wfoActivityId = MapUtil.getExternalToWfoID(systemType, MapUtil.ObjectType.Activity,oldActivityWrapper.getActivityExternalID());</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">					if(wfoActivityId == null) {</span>
<span class="nc" id="L142">						m_activityManager.matchActivityWithExternalID(oldActivityWrapper.getActivity(),systemType, oldActivityWrapper.getActivityExternalID());</span>
					}
				}
<span class="nc" id="L145">				CAT.info(&quot;Update suceeded&quot;);</span>
<span class="nc" id="L146">			} catch (ActivityValidationException e) {</span>
<span class="nc" id="L147">				CAT.error(&quot;Another process is trying to update this activity&quot;, e);</span>
<span class="nc" id="L148">				throw new ServiceApplicationException(e);</span>
				// Note: any problem with validity or database state should have been detected by now
				// So any exceptions thrown here are unrecoverable system bugs
<span class="nc" id="L151">			} catch (MultiUserException e) {</span>
<span class="nc" id="L152">				CAT.error(&quot;Another process is trying to update this activity&quot;, e);</span>
<span class="nc" id="L153">				throw new ServiceApplicationException(&quot;Failed to update the activity!&quot;, e);</span>
<span class="nc" id="L154">			} catch (BbmUpdateException e) {</span>
<span class="nc" id="L155">				CAT.error(&quot;Failed to update the activity!&quot;, e);</span>
<span class="nc" id="L156">				throw new ServiceApplicationException(&quot;Failed to update the activity!&quot;, e);</span>
<span class="nc" id="L157">			} catch (RemoteException e) {</span>
<span class="nc" id="L158">				throw new ServiceApplicationException(</span>
						&quot;There was a communication fault invoking activityManager.updateActivity()&quot;, e);
<span class="nc" id="L160">			} catch (RuntimeException e) {</span>
<span class="nc" id="L161">				CAT.error(&quot;In createOrUpdate method(Throwable): failed to create the activity!&quot;, e);</span>
<span class="nc" id="L162">				throw new ServiceApplicationException(</span>
						&quot;In createOrUpdate method(Throwable): failed to create the activity!&quot;, e);
<span class="nc" id="L164">			} catch(Exception any) {</span>
<span class="nc" id="L165">				CAT.error(&quot;Failed to update the activity!&quot;, any);</span>
<span class="nc" id="L166">				throw new ServiceApplicationException(&quot;Failed to update the activity!&quot;, any);</span>
<span class="nc" id="L167">			}</span>
<span class="nc" id="L168">		}</span>
<span class="nc" id="L169">		return activityNotPersistedInfos;</span>
	}

	public MapJAXBType areSaved(Collection&lt;String&gt; activityNames) throws ServiceApplicationException {

<span class="nc" id="L174">		Map&lt;String, Boolean&gt; preResult = new HashMap&lt;String, Boolean&gt;();</span>
<span class="nc bnc" id="L175" title="All 4 branches missed.">		if (activityNames == null || activityNames.isEmpty()) {</span>
<span class="nc" id="L176">			CAT.debug(&quot;No activities to check&quot;);</span>
<span class="nc" id="L177">			return new MapJAXBType(preResult);</span>
		}
<span class="nc bnc" id="L179" title="All 2 branches missed.">		for (String activityName : activityNames) {</span>
<span class="nc" id="L180">			ID localId = SyncUtil.getActivityIDByNameCaseInsensitive(activityName, m_activityManager, true);</span>

			// There is a saved entity precisely when we find a local id that is mapped to the external id
<span class="nc bnc" id="L183" title="All 2 branches missed.">			preResult.put(activityName, (localId != null));</span>
<span class="nc" id="L184">		}</span>

		// Map needs to be wrapped by a custom JAXB type
<span class="nc" id="L187">		return new MapJAXBType(preResult);</span>
	}

	// --------------------------------------------------------- helper methods
	@PostConstruct
	public void postConstruct() {
		try {
<span class="nc" id="L194">			m_activityManager = WfmManagerFactory.getActivityManager();</span>
<span class="nc" id="L195">			m_workResourceManager = BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L196">			CAT.info(&quot;Succeeded to obtain reference to all managers :)&quot;);</span>
<span class="nc" id="L197">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L198">			CAT.error(&quot;Failed to obtain reference to a manager :(&quot;, e);</span>
<span class="nc" id="L199">		}</span>
<span class="nc" id="L200">	}</span>

	@PreDestroy
	public void preDestroy() {
<span class="nc" id="L204">		m_activityManager = null;</span>
<span class="nc" id="L205">	}</span>

	@SuppressWarnings(&quot;unchecked&quot;)
	protected void convertToEntity(Collection&lt;ActivityDTO&gt; activityDTOs, SystemType systemType,
			Collection&lt;ActivityWithMediaIdsWrapper&gt; newActivityWrappers,
			Collection&lt;ActivityWithMediaIdsWrapper&gt; oldActivityWrappers,
			List&lt;ActivityNotPersistedInfo&gt; activityNotPersistedInfos) throws ServiceApplicationException {

		try {
			// Clear the external id cache in case its stale
<span class="nc" id="L215">			MapUtil.flushMap(systemType);</span>
			// Refresh the org name and activity name cache too in case its stale
<span class="nc" id="L217">			SyncUtil.getOrganizationIDsByNamesCaseInsensitive(Collections.emptyList(), m_workResourceManager,</span>
					true);
<span class="nc" id="L219">			SyncUtil.getActivityIDsByNamesCaseInsensitive(Collections.emptyList(), m_activityManager,</span>
					true);

			// First pass: Convert DTO to local entity object
<span class="nc" id="L223">			Collection&lt;ID&gt; activityIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">			for (ActivityDTO activityDTO : activityDTOs) {</span>
				// We will create exception info; only add to collection if there is an exception
<span class="nc" id="L226">				ActivityNotPersistedInfo activityNotPersistedInfo = new ActivityNotPersistedInfo(</span>
<span class="nc" id="L227">						activityDTO.getName());</span>

<span class="nc" id="L229">				ActivityWithMediaIdsWrapper activityWrapper = new ActivityWithMediaIdsWrapper();</span>
<span class="nc" id="L230">				Activity activity = new Activity();</span>
<span class="nc" id="L231">				activityWrapper.setActivity(activity);</span>
				
<span class="nc" id="L233">				ID activityExternalID = ExternalIDUtil.buildExternalID(systemType,</span>
<span class="nc" id="L234">						activityDTO.getExternalSourceId());				</span>
<span class="nc" id="L235">				activityWrapper.setActivityExternalID(activityExternalID);</span>
				
<span class="nc" id="L237">				activity.setExternalID(activityExternalID);</span>
				
				// Validation (in addition to entity's built in validate() method
<span class="nc bnc" id="L240" title="All 2 branches missed.">				if (StringUtil.isEmptyOrWhiteSpace(activityDTO.getName())) {</span>
<span class="nc" id="L241">					activityNotPersistedInfo.addNameMissingMessage();</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">				} else if (StringUtil.containsInvalidChars(</span>
<span class="nc" id="L243">						activityDTO.getName(),</span>
						ValidatorConstants.INVALID_NAME_CHARS)) {
<span class="nc" id="L245">					activityNotPersistedInfo</span>
<span class="nc" id="L246">							.addNameHasInvalidCharactersMessage(ValidatorConstants.INVALID_NAME_CHARS);</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">				} else if (activityDTO.getName().length() &gt; EntityImportService.NAME_MAX_LENGTH) {</span>
<span class="nc" id="L248">					activityNotPersistedInfo.addNameLengthExceededMessage(</span>
<span class="nc" id="L249">							activityDTO.getName().length(),</span>
							EntityImportService.NAME_MAX_LENGTH);
				} else {
					// id is null means this is a new activity, update otherwise
<span class="nc" id="L253">					ID wfoActivityId = null;</span>
					try {
<span class="nc" id="L255">						wfoActivityId = MapUtil.getExternalToWfoID(systemType, MapUtil.ObjectType.Activity,activityWrapper.getActivityExternalID());</span>
<span class="nc" id="L256">					} catch (JdmoException e) {</span>
<span class="nc" id="L257">						throw new ServiceApplicationException(e);</span>
<span class="nc" id="L258">					}</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">					if(wfoActivityId == null) {</span>
<span class="nc" id="L260">						wfoActivityId = SyncUtil.getActivityIDByNameCaseInsensitive(activityDTO.getName(),m_activityManager, false);</span>
					}
<span class="nc" id="L262">					activity.setID(wfoActivityId);</span>
<span class="nc" id="L263">					CAT.info(&quot;Mapped name to: &quot; + wfoActivityId);</span>
				}

<span class="nc bnc" id="L266" title="All 2 branches missed.">				if (StringUtil.isEmptyOrWhiteSpace(activityDTO.getOrganizationName())) {</span>
<span class="nc" id="L267">					activityNotPersistedInfo.addOrganizationNameMissingMessage();</span>
				} else {
					// Look up linked organization id
<span class="nc" id="L270">					ID wfoOrgId = SyncUtil</span>
<span class="nc" id="L271">							.getOrganizationIDByNameCaseInsensitive(activityDTO.getOrganizationName(),</span>
									m_workResourceManager, false);
<span class="nc bnc" id="L273" title="All 2 branches missed.">					if (wfoOrgId == null) {</span>
<span class="nc" id="L274">						activityNotPersistedInfo.addNoSuchOrganizatonNameMessage(activityDTO</span>
<span class="nc" id="L275">									.getOrganizationName());</span>
					}
<span class="nc" id="L277">					activity.setOrganizationId(wfoOrgId);</span>
<span class="nc" id="L278">					CAT.info(&quot;Mapped org external id to: &quot; + wfoOrgId.toString());</span>
				}

				// Now assign remaining properties
				// lookup linked queue ids also
<span class="nc bnc" id="L283" title="All 2 branches missed.">				if (activityDTO.getAdditionalQueueExternalSourceIds() != null) {</span>
<span class="nc" id="L284">					List&lt;ID&gt; queueExternalIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">					for (String queueExternalSourceId : activityDTO.getAdditionalQueueExternalSourceIds()) {</span>
<span class="nc" id="L286">						queueExternalIDs.add(ExternalIDUtil.buildExternalID(systemType, queueExternalSourceId));</span>
<span class="nc" id="L287">					}</span>
					Map&lt;ID, ID&gt; queueExternalWfoIDMap;
					try {
<span class="nc" id="L290">						queueExternalWfoIDMap = MapUtil.getExternalIDMap(systemType, MapUtil.ObjectType.Queue,</span>
								queueExternalIDs, true);
<span class="nc" id="L292">					} catch (JdmoException e) {</span>
<span class="nc" id="L293">						throw new ServiceApplicationException(e);</span>
<span class="nc" id="L294">					}</span>
<span class="nc" id="L295">					activityWrapper.setQueueIDs(new HashSet&lt;ID&gt;(queueExternalWfoIDMap.values()));</span>
<span class="nc" id="L296">					activity.setQueueHopping(activityDTO.isQueueHopping());</span>
					// Any bad IDs?
<span class="nc" id="L298">					Set&lt;ID&gt; noSuchQueueEternalIds = new HashSet&lt;ID&gt;(queueExternalIDs);</span>
<span class="nc" id="L299">					noSuchQueueEternalIds.removeAll(queueExternalWfoIDMap.keySet());</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">					if (!noSuchQueueEternalIds.isEmpty()) {</span>
<span class="nc" id="L301">						activityNotPersistedInfo.addNoSuchQueueExternalIdsMessage(noSuchQueueEternalIds);</span>
					}
				}

				// Remaining properties are straightforward
<span class="nc" id="L306">				activity.setName(activityDTO.getName());</span>
<span class="nc" id="L307">				activity.setDescription(activityDTO.getDescription());</span>
<span class="nc" id="L308">				activity.setPaid(activityDTO.isPaid());</span>
<span class="nc" id="L309">				activity.setAdherenceTolerance(activityDTO.getAdherenceTolerance());</span>
<span class="nc" id="L310">				activity.setColor(activityDTO.getGuiColor());</span>
<span class="nc" id="L311">				activity.setTimeoff(activityDTO.isTimeoff());</span>
<span class="nc" id="L312">				activity.setUsedInShiftEvent(activityDTO.isUsedInShiftEvent());</span>
<span class="nc" id="L313">				activity.setUsedInCalendarEvent(activityDTO.isUsedInCalendarEvent());</span>
<span class="nc" id="L314">				activity.setUsedInShift(activityDTO.isUsedInShift());</span>
								
				// activity category id needs to be an ID not a string
<span class="nc" id="L317">				ID activityTypeID = convertActivityCategoryName2ID(activityNotPersistedInfo,</span>
<span class="nc" id="L318">						activityDTO.getActivityType());</span>
<span class="nc" id="L319">				activity.setActivityCategoryId(activityTypeID);</span>

				// Activity can be multi-media: e.g. phone and fax
				// An activity that includes project medium is considered administrative
				// for the purpose of of calculating statistics (source measures and KPIs)
<span class="nc" id="L324">				List&lt;ID&gt; mediaIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">				for (String mediaIdString : activityDTO.getMediaIds()) {</span>
					// TODO: This method is nasty... (1) it doesn't belong to Skill class and (2) it
					// should not default to telephone when there is a problem
<span class="nc" id="L328">					ID mediaID = Skill.convertStr2MediaID(mediaIdString);</span>
<span class="nc" id="L329">					mediaIDs.add(mediaID);</span>
<span class="nc" id="L330">				}</span>
<span class="nc" id="L331">				activityWrapper.setMediaIDs(mediaIDs);</span>

				
<span class="nc bnc" id="L334" title="All 2 branches missed.">				if (mediaIDs.contains(Media.MEDIA_ID_PROJECT)) {</span>
<span class="nc" id="L335">					activity.setSourceMeasureId(SOURCE_MEASURE_TIME_IN_ADMIN);</span>
				}

				// add validation exception info as appropriate
				try {
<span class="nc" id="L340">					activity.validate();</span>
<span class="nc" id="L341">				} catch (ActivityValidationException e) {</span>
<span class="nc" id="L342">					activityNotPersistedInfo.addUnknownValidationMessage();</span>
<span class="nc" id="L343">				}</span>

<span class="nc bnc" id="L345" title="All 2 branches missed.">				if (!activityNotPersistedInfo.getMessages().isEmpty()) {</span>
<span class="nc" id="L346">					CAT.error(&quot;User error: Activity entity will not be persisted&quot;);</span>
<span class="nc" id="L347">					activityNotPersistedInfos.add(activityNotPersistedInfo);</span>
				} else {

					// Separate out activities which are new, based on not having a local id
<span class="nc bnc" id="L351" title="All 2 branches missed.">					if (activity.getID() == null) {</span>
<span class="nc" id="L352">						newActivityWrappers.add(activityWrapper);</span>
					} else {
<span class="nc" id="L354">						oldActivityWrappers.add(activityWrapper);</span>
<span class="nc" id="L355">						activityIds.add(activity.getID());</span>
					}
				}
<span class="nc" id="L358">			} // end activityDTO first pass loop</span>

			// find out what queues each activity is linked to
			Map&lt;ID, List&lt;ID&gt;&gt; activityIDQueueIDMap;
			try {
<span class="nc" id="L363">				activityIDQueueIDMap = m_activityManager.findQueueForActivities(activityIds);</span>
<span class="nc" id="L364">			} catch (BbmFinderException e) {</span>
<span class="nc" id="L365">				CAT.error(&quot;Failed to load queue ids!&quot;, e);</span>
<span class="nc" id="L366">				throw new ServiceApplicationException(&quot;Failed to load queue ids!&quot;, e);</span>
<span class="nc" id="L367">			} catch (RemoteException e) {</span>
<span class="nc" id="L368">				CAT.error(&quot;Failed to load queue ids!&quot;, e);</span>
<span class="nc" id="L369">				throw new ServiceApplicationException(&quot;Failed to load queue ids!&quot;, e);</span>
<span class="nc" id="L370">			}</span>

			// Integrate queues in the DTO with queues already linked.... we don't want to unlink them
<span class="nc bnc" id="L373" title="All 2 branches missed.">			for (ActivityWithMediaIdsWrapper oldActivityWrapper : oldActivityWrappers) {</span>
<span class="nc" id="L374">				final List&lt;ID&gt; oldQueueIDs = activityIDQueueIDMap.get(oldActivityWrapper.getActivity().getID());</span>
<span class="nc bnc" id="L375" title="All 4 branches missed.">				if (oldQueueIDs != null &amp;&amp; oldQueueIDs.size() &gt; 0) {</span>
<span class="nc" id="L376">					oldActivityWrapper.getQueueIDs().addAll(oldQueueIDs);</span>
					// there are old queues assigned, meaning queue hopping
					// needs to be checked.
					// QC-154566(11.1SP1), 156049 without this, if the activity
					// is not assigned to any queues in the present set
					// the queue hopping will be set to false even when queues
					// are attached to this activity.
<span class="nc" id="L383">					oldActivityWrapper.getActivity().setQueueHopping(true);</span>
				}
<span class="nc" id="L385">			}</span>

<span class="nc" id="L387">			CAT.info(&quot;Succeeded to convert DTOs!&quot;);</span>
<span class="nc" id="L388">		} catch (RuntimeException e) {</span>
<span class="nc" id="L389">			CAT.error(&quot;Failed to convert DTOs!&quot;, e);</span>
<span class="nc" id="L390">			throw new ServiceApplicationException(&quot;System bug: activityDTO to activity entity conversion failure&quot;, e);</span>
<span class="nc" id="L391">		}</span>
<span class="nc" id="L392">	}</span>

	@SuppressWarnings(&quot;unchecked&quot;)
	private ID convertActivityCategoryName2ID(ActivityNotPersistedInfo activityNotPersistedInfo, String activityType)
			throws ServiceApplicationException {

		// Empty case
<span class="nc bnc" id="L399" title="All 2 branches missed.">		if (StringUtil.isEmpty(activityType)) {</span>
<span class="nc" id="L400">			activityNotPersistedInfo.addActivityTypeMissingMessage();</span>
<span class="nc" id="L401">			return null;</span>
		}

		// Find activity category by name (as name is unique, collection size will be zero or one
<span class="nc" id="L405">		ActivityCategoryFilter activityCategoryNameFilter = new ActivityCategoryFilter();</span>
<span class="nc" id="L406">		activityCategoryNameFilter.setActivityCategoryName(activityType, Filter.OP_EQUAL);</span>
		Collection&lt;ActivityCategory&gt; activityCategorys;
		try {
<span class="nc" id="L409">			activityCategorys = m_activityManager.findActivityCategories(activityCategoryNameFilter);</span>
<span class="nc" id="L410">		} catch (RemoteException e) {</span>
<span class="nc" id="L411">			throw new ServiceApplicationException(e);</span>
<span class="nc" id="L412">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L413">			throw new ServiceApplicationException(e);</span>
<span class="nc" id="L414">		}</span>

<span class="nc bnc" id="L416" title="All 2 branches missed.">		if (activityCategorys.isEmpty()) {</span>
<span class="nc" id="L417">			activityNotPersistedInfo.addNoSuchActivityTypeMessage(activityType);</span>
<span class="nc" id="L418">			return null;</span>
		} else {
<span class="nc" id="L420">			ActivityCategory activityCategory = activityCategorys.iterator().next();</span>
<span class="nc" id="L421">			return activityCategory.getID();</span>
		}
	}

<span class="nc" id="L425">	public static class ActivityWithMediaIdsWrapper {</span>
		protected Activity m_activity;
		protected List&lt;ID&gt; m_mediaIDs;
<span class="nc" id="L428">		protected Set&lt;ID&gt; m_queueIDs = new HashSet&lt;ID&gt;();</span>
		protected ID m_activityExternalID;


		public Activity getActivity() {
<span class="nc" id="L433">			return m_activity;</span>
		}

		public void setActivity(Activity activity) {
<span class="nc" id="L437">			m_activity = activity;</span>
<span class="nc" id="L438">		}</span>

		public List&lt;ID&gt; getMediaIDs() {
<span class="nc" id="L441">			return m_mediaIDs;</span>
		}

		public void setMediaIDs(List&lt;ID&gt; mediaIDs) {
<span class="nc" id="L445">			m_mediaIDs = mediaIDs;</span>
<span class="nc" id="L446">		}</span>

		public Set&lt;ID&gt; getQueueIDs() {
<span class="nc" id="L449">			return m_queueIDs;</span>
		}

		public void setQueueIDs(Set&lt;ID&gt; queueIDs) {
<span class="nc" id="L453">			m_queueIDs = queueIDs;</span>
<span class="nc" id="L454">		}</span>
		
		public ID getActivityExternalID() {
<span class="nc" id="L457">			return m_activityExternalID;</span>
		}
		
		public void setActivityExternalID(ID activityExternalID) {
<span class="nc" id="L461">			m_activityExternalID = activityExternalID;</span>
<span class="nc" id="L462">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>