<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DailyScheduleSummary.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.schedule.summary</a> &gt; <span class="el_source">DailyScheduleSummary.java</span></div><h1>DailyScheduleSummary.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.schedule.summary;
/**
 * Title:        DailyScheduleSummary
 * Description:  Encapsulate Daily Schedule data for UI display
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       Chris King
 * @version      1.0
 */
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.Map;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.CalendarRange;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.schedule.model.CalendarEvent;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftEventAssignment;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.schedule.ScheduleViewPM;
import com.bluepumpkin.web.fs.shift.ShiftUtil;
import com.witness.web.uif.system.RequestContext;
/**
 * This class encapsulates Schedule data for a single user and a single day.
 */
public class DailyScheduleSummary
{
    private Localizer       m_localizer;
    private TimeZone		m_tz;

    CalendarRange           m_day;
    private Date            m_shiftStartDate;
    //theoretically may be on the next day e.g shift starts at 11pm, but there is time off 11pm-1am

    private Date            m_shiftEndDate;
    private boolean         m_hasShift;
    private boolean         m_isPublished;
    private boolean         m_isDayOff;
    private boolean 		m_isClosed;

	private ID              m_shiftSchedulingPeriodID;
	private Collection&lt;ID&gt;  m_agentSchedulingPeriodIDs;
	private ID              m_orgID;
	
	//A collection of the shift event assignments corresponding to this
	//daily schedule.  Used to determine the campaign name of the various
	//activities of the shift as well as whether or not the schedule contains
	//pooling activities.
	private Collection&lt;ShiftEventAssignment&gt; m_shiftEventAssignments;
	//The main shift assignment for this day for the employee
	private ShiftAssignment m_shiftAssignment;
	//Any associated calendar events that have been scheduled for the day for the employee
	private Collection&lt;CalendarEvent&gt; m_calendarEvents;
	//A map of activities (keyed on activity ID), used to display detailed shift information
	//including the names of the activities of each event in the shift.
	private Map&lt;ID, Activity&gt; m_activityMap;
	
    /**
     * There may be two shifts on one day if the user changed the view time zone and
     * a shift that would have started early the next day is now included in
     * the new 24 hour window which we are viewing (QC44831).
     */
    private DailyScheduleSummary m_secondShift;

    /**
     * Constructs a Daily schedule summary.
     */
    public DailyScheduleSummary(RequestContext context, CalendarRange theDay, Date shiftStartDate,
                Date shiftEndDate, boolean hasShift, boolean isPublished, boolean isDayOff)
<span class="nc" id="L76">    {</span>
<span class="nc" id="L77">        m_localizer = context.getLocalizer();</span>
<span class="nc" id="L78">        m_tz = context.getViewingTimeZone();</span>

<span class="nc" id="L80">        m_day = theDay;</span>
<span class="nc" id="L81">        m_shiftStartDate = shiftStartDate;</span>
<span class="nc" id="L82">        m_shiftEndDate = shiftEndDate;</span>
<span class="nc" id="L83">        m_hasShift = hasShift;</span>
<span class="nc" id="L84">        m_isPublished = isPublished;</span>
<span class="nc" id="L85">        m_isDayOff = isDayOff;</span>
<span class="nc" id="L86">		m_isClosed = false;</span>
<span class="nc" id="L87">        m_secondShift = null;</span>
<span class="nc" id="L88">    }</span>

	/**
     * Constructs a Daily schedule summary.
     */
    public DailyScheduleSummary(RequestContext context, CalendarRange theDay, Date shiftStartDate,
                Date shiftEndDate, boolean hasShift, boolean isPublished, boolean isDayOff, ID shiftSchedulingPeriodID,
                Collection&lt;ID&gt; agentSchedulingPeriodIDs, ID orgID)
<span class="fc" id="L96">    {</span>
<span class="fc" id="L97">        m_localizer = context.getLocalizer();</span>
<span class="fc" id="L98">        m_tz = context.getViewingTimeZone();</span>

<span class="fc" id="L100">        m_day = theDay;</span>
<span class="fc" id="L101">        m_shiftStartDate = shiftStartDate;</span>
<span class="fc" id="L102">        m_shiftEndDate = shiftEndDate;</span>
<span class="fc" id="L103">        m_hasShift = hasShift;</span>
<span class="fc" id="L104">        m_isPublished = isPublished;</span>
<span class="fc" id="L105">        m_isDayOff = isDayOff;</span>
<span class="fc" id="L106">		m_isClosed = false;</span>
<span class="fc" id="L107">		m_shiftSchedulingPeriodID = shiftSchedulingPeriodID;</span>
<span class="fc" id="L108">		m_agentSchedulingPeriodIDs = agentSchedulingPeriodIDs;</span>
<span class="fc" id="L109">		m_orgID = orgID;</span>
<span class="fc" id="L110">		m_secondShift = null;</span>
<span class="fc" id="L111">    }</span>

	/**
     * Constructs a Daily schedule summary.
     */
    public DailyScheduleSummary(RequestContext context,
    		CalendarRange theDay,
    		Date shiftStartDate,
    		Date shiftEndDate,
    		boolean hasShift,
    		boolean isPublished,
    		boolean isDayOff,
    		ID schedulingPeriodID,
    		Collection&lt;ID&gt; agentSchedulingPeriodIDs,
    		ID orgID,
    		Collection&lt;ShiftEventAssignment&gt; shiftEventAssignments,
    		ShiftAssignment shiftAssignment,
    		Collection&lt;CalendarEvent&gt; calendarEvents,
    		Map&lt;ID, Activity&gt; activityMap)
    {
<span class="nc" id="L131">        this(context, theDay, shiftStartDate, shiftEndDate, hasShift, isPublished, isDayOff, schedulingPeriodID, </span>
        		agentSchedulingPeriodIDs, orgID);
<span class="nc" id="L133">    	m_shiftEventAssignments = shiftEventAssignments;</span>
<span class="nc" id="L134">    	m_shiftAssignment = shiftAssignment;</span>
<span class="nc" id="L135">    	m_calendarEvents = calendarEvents;</span>
<span class="nc" id="L136">    	m_activityMap = activityMap;</span>
<span class="nc" id="L137">    }</span>
    
	/** 
	 * additional loaded constructor to accomodate for isClosed 
	 * @TODO: replace the other constructor and remove setter after the sweep of calling code. 
	 */
	public DailyScheduleSummary(RequestContext context, CalendarRange theDay, Date shiftStartDate,
				Date shiftEndDate, boolean hasShift, boolean isPublished, boolean isDayOff, boolean isClosed, 
				ID schedulingPeriodID, Collection&lt;ID&gt; agentSchedulingPeriodIDs, ID orgID)
	{
<span class="nc" id="L147">		this(context, theDay, shiftStartDate, shiftEndDate, hasShift, isPublished, isDayOff, schedulingPeriodID, </span>
				agentSchedulingPeriodIDs, orgID);
<span class="nc" id="L149">		setIsClosed(isClosed);</span>
<span class="nc" id="L150">	}</span>
	
    /**
     * Returns the Day of Week for the Shift start
     *
     * @param timeZone is the User's viewing timezone
     * @return int Java day of the week
     */
    public int getDayOfWeek() {
<span class="nc" id="L159">        Calendar dayStartCal = m_day.getStartCalendar();</span>
<span class="nc" id="L160">        return dayStartCal.get(Calendar.DAY_OF_WEEK);</span>
    }


    /**
     * Returns the Shift day of Week name in the language of the user locale.
     * This is taken from the Shift Start date.
     *
     * @return String Day of the week in the user locale language.
     */
    public String getDayOfWeekName() {
<span class="nc" id="L171">        return m_localizer.formatDate(m_shiftStartDate,m_tz,</span>
					RegionalFormatBundleKey.DATE_NOYEAR_DAYINWEEKFULL_FORMAT);
    }

    /**
     * Returns the CalendarRange for the day
     */
    public CalendarRange getDayRange() {
<span class="fc" id="L179">        return m_day;</span>
    }

    /**
     * Returns true if there is a shift on this day
     */
    public boolean hasShift() {
<span class="nc" id="L186">        return m_hasShift;</span>
    }

    /**
     * Returns true if shedule is published for this day
     */
    public boolean isPublished() {
<span class="fc" id="L193">        return m_isPublished;</span>
    }

    /**
     * Returns true if this day has Time Off event any shift part is completely covered by time off
     */
    public boolean isDayOff() {
<span class="fc" id="L200">        return m_isDayOff;</span>
    }

	/**
	 * Returns true if this day is Closed based on the Org HOO
	 */
	public boolean isClosed() {
<span class="fc" id="L207">		return m_isClosed;</span>
	}

	/**
	 * Returns true if this day is Closed based on the Org HOO
	 */
	public void setIsClosed(boolean bVal) {
<span class="nc" id="L214">		m_isClosed = bVal;</span>
<span class="nc" id="L215">	}</span>

    /**
     * Returns the Shift start date
     */
    public Date getShiftStartDate() {
<span class="nc" id="L221">        return m_shiftStartDate;</span>
    }
  
    /**
     * Returns the Scheduling Period ID of the shift assignment
     * coinciding with this date.
     */
    public ID getShiftSchedulingPeriodID() {
<span class="fc" id="L229">        return m_shiftSchedulingPeriodID;</span>
    }

    /**
     * Returns the &quot;secondary&quot; (pooling) Scheduling Period IDs of for the agent
     * coinciding with this date.
     */
    public Collection&lt;ID&gt; getAgentSchedulingPeriodIDs() {
<span class="nc" id="L237">        return m_agentSchedulingPeriodIDs;</span>
    }

    /**
     * Returns the Organization ID
     */
    public ID getOrgID() {
<span class="nc" id="L244">        return m_orgID;</span>
    }

    /**
     * Returns the Shift end date
     */
    public Date getShiftEndDate() {
<span class="nc" id="L251">        return m_shiftEndDate;</span>
    }

    /**
     * There may be two shifts on one day if the user changed the view time zone and
     * a shift that would have started early the next day is now included in
     * the new 24 hour window which we are viewing (QC44831).
     */    
    public void setSecondShift(DailyScheduleSummary secondShift)
    {
<span class="nc" id="L261">        m_secondShift = secondShift;</span>
<span class="nc" id="L262">    }</span>

    /**
     * There may be two shifts on one day if the user changed the view time zone and
     * a shift that would have started early the next day is now included in
     * the new 24 hour window which we are viewing (QC44831).
     */
    public DailyScheduleSummary getSecondShift()
    {
<span class="nc" id="L271">        return m_secondShift;</span>
    }
    
	public String toString() {
<span class="nc" id="L275">		StringBuffer sb = new StringBuffer(256);</span>
<span class="nc" id="L276">		sb.append(&quot;************************\n&quot;);</span>
<span class="nc" id="L277">		sb.append(&quot;calendar day: &quot; + m_day);</span>
<span class="nc" id="L278">		sb.append(&quot;\n&quot;).append(&quot;Shift Start: &quot; + m_shiftStartDate);</span>
<span class="nc" id="L279">		sb.append(&quot;\n&quot;).append(&quot;Shift End: &quot; + m_shiftEndDate);</span>
<span class="nc" id="L280">		sb.append(&quot;\n&quot;).append(&quot;hasShift: &quot; + m_hasShift);</span>
<span class="nc" id="L281">		sb.append(&quot;\n&quot;).append(&quot;isPublished: &quot; + m_isPublished);</span>
<span class="nc" id="L282">		sb.append(&quot;\n&quot;).append(&quot;isDayOff: &quot; + m_isDayOff);</span>
<span class="nc" id="L283">		sb.append(&quot;\n&quot;).append(&quot;isClosed: &quot; + m_isClosed);</span>
<span class="nc" id="L284">		sb.append(&quot;\n&quot;).append(&quot;Shift Scheduling Period ID: &quot; + m_shiftSchedulingPeriodID);</span>
<span class="nc" id="L285">		sb.append(&quot;\n&quot;).append(&quot;Agent Scheduling Period IDs: &quot; + m_agentSchedulingPeriodIDs);</span>
<span class="nc" id="L286">		sb.append(&quot;\n&quot;).append(&quot;Organization ID: &quot; + m_orgID);</span>

<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (m_secondShift != null)</span>
<span class="nc" id="L289">            sb.append(&quot;\n&quot;).append(&quot;SECOND SHIFT: &quot; + m_secondShift);</span>
		
<span class="nc" id="L291">		sb.append(&quot;\n&quot;).append(&quot;************************\n&quot;);</span>
<span class="nc" id="L292">		return sb.toString();</span>
	}

	/**
	 * Return the collection of shift event assignments contained within
	 * the shift of this daily schedule.
	 */
	public Collection&lt;ShiftEventAssignment&gt; getShiftEventAssignments() {
<span class="nc" id="L300">		return m_shiftEventAssignments;</span>
	}
	
	/**
	 * Returns the main shift assignment for the day.
	 */
	public ShiftAssignment getShiftAssignment() {
<span class="nc" id="L307">		return m_shiftAssignment;</span>
	}

	/**
	 * Returns true if either the shift assignment, or any of the shift event assignments of this daily
	 * schedule have a different scheduling period ID than the scheduling
	 * period ID of the SP that the agent is assigned to on this day.
	 */
	public boolean containsPoolingActivities() {
<span class="nc bnc" id="L316" title="All 4 branches missed.">		if (m_shiftSchedulingPeriodID == null ||</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">				m_agentSchedulingPeriodIDs == null || m_agentSchedulingPeriodIDs.isEmpty()) {</span>
<span class="nc" id="L318">			return false;</span>
		}

		//see if the shiftAssignment is for one of the agent's secondary SP's. If so, he's pooling.
<span class="nc bnc" id="L322" title="All 2 branches missed.">		if (m_agentSchedulingPeriodIDs.contains(m_shiftSchedulingPeriodID))</span>
<span class="nc" id="L323">			return true;</span>

<span class="nc bnc" id="L325" title="All 4 branches missed.">		if (m_shiftEventAssignments == null || m_shiftEventAssignments.isEmpty()) {</span>
<span class="nc" id="L326">			return false;</span>
		}

		//see if the shiftEventAssignment is for one of the agent's secondary SP's. If so, he's pooling.
<span class="nc bnc" id="L330" title="All 2 branches missed.">		for (ShiftEventAssignment assignment : m_shiftEventAssignments) {</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">			if (m_agentSchedulingPeriodIDs.contains(assignment.getSPID())) {</span>
<span class="nc" id="L332">				return true;</span>
			}
<span class="nc" id="L334">		}</span>

<span class="nc" id="L336">		return false;</span>
	}
	
	/**
	 * Returns true if the daily schedule contains any calendar events.
	 * @return
	 */
	public boolean containsCalendarEvents() {
<span class="nc bnc" id="L344" title="All 4 branches missed.">		if (m_calendarEvents != null &amp;&amp; m_calendarEvents.isEmpty() == false) {</span>
<span class="nc" id="L345">			return true;</span>
		}
<span class="nc" id="L347">		return false;</span>
	}
	
	/**
	 * Returns true if the daily schedule contains any overtime (either the
	 * shift itself is overtime or has any OT extensions).
	 */
	public boolean containsOvertime() {
<span class="nc bnc" id="L355" title="All 2 branches missed.">		if (m_shiftAssignment != null &amp;&amp;</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">				(m_shiftAssignment.getExtensionAfter() &gt; 0 ||</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">						m_shiftAssignment.getExtensionBefore() &gt; 0)) {</span>
<span class="nc" id="L358">			return true;</span>
		}
<span class="nc" id="L360">		return false;</span>
	}
	
	/**
	 * Returns a text description of the scheduled calendar events of this daily schedule.
	 * Format is similar to the following:  &quot;Calendar Events: &lt;Activity Name1&gt;: 8:00AM - 9:45AM,
	 * &lt;Activity Name2&gt;: 3:00PM - 3:15PM&quot;.
	 */
	public String getCalendarEventsDescription(Localizer localizer) {
<span class="nc" id="L369">		StringBuffer sb = new StringBuffer();</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">		for (CalendarEvent event : m_calendarEvents) {</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">			if (sb.length() &gt; 0) {</span>
<span class="nc" id="L372">				sb.append(&quot;, &quot;);</span>
			}
			//For each calendar event, create a localized string containing the activity
			//name and the time range of the event
<span class="nc" id="L376">			sb.append(localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SV_ACTIVITY_NAME_AND_TIME_RANGE,</span>
<span class="nc" id="L377">					new Object[]{ ShiftUtil.makeShiftDatesString(m_day, event.getStartTime(), event.getEndTime(), localizer, m_tz),</span>
<span class="nc" id="L378">							m_activityMap.get(event.getActivityID()).getName() }));</span>
<span class="nc" id="L379">		}</span>
<span class="nc" id="L380">		return sb.toString();</span>
	}

	/**
	 * Returns a text description of the scheduled overtime of this shift.  Returns an empty
	 * string if no overtime is worked.
	 */
	public String getOvertimeDescription(Localizer localizer) {
<span class="nc bnc" id="L388" title="All 4 branches missed.">		if (m_shiftAssignment != null &amp;&amp; containsOvertime()) {</span>
<span class="nc" id="L389">			return ScheduleViewPM.makeShiftOvertimeString(m_day, this, m_shiftAssignment, m_tz, localizer, false, true);</span>
		}
<span class="nc" id="L391">		return &quot;&quot;;</span>
	}
	
	/**
	 * Returns the activity of the overtime extension matching the given time range.  If the
	 * shift of this schedule does not contain any overtime, this will return null.
	 */
	public Activity getOvertimeActivityForTimeRange(TimeRange range) {
<span class="nc bnc" id="L399" title="All 4 branches missed.">		if (range != null &amp;&amp; containsOvertime()) {</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">			if (range.getStartDate().equals(m_shiftAssignment.getStartTime())) {</span>
				//Shift assignment itself is overtime
<span class="nc bnc" id="L402" title="All 2 branches missed.">				if (range.getEndDate().equals(m_shiftAssignment.getEndTime())) {</span>
<span class="nc" id="L403">					return m_activityMap.get(m_shiftAssignment.getActivityID());</span>
				} else {  	//Time range is an OT extension before the main shift
<span class="nc" id="L405">					return m_activityMap.get(m_shiftAssignment.getOTExtensionBeforeActivityID());</span>
				}
			}
			//Time range is an OT extension after the main shift
<span class="nc bnc" id="L409" title="All 2 branches missed.">			if (range.getEndDate().equals(m_shiftAssignment.getEndTime())) {</span>
<span class="nc" id="L410">				return m_activityMap.get(m_shiftAssignment.getOTExtensionAfterActivityID());</span>
			}
		}
<span class="nc" id="L413">		return null;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>