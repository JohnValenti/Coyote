<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ScheduleSummaryMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.schedule.summary</a> &gt; <span class="el_source">ScheduleSummaryMH.java</span></div><h1>ScheduleSummaryMH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.schedule.summary;
/**
 * Title:        ScheduleSummaryMH
 * Description:  Handle EJB interaction for Schedule Summary
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       Chris King, Pavel Bosin
 * @version 1.0
 */

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.config.ejb.DBConfigManager;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.EmpWorkRuleManager;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpTimeBank;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpTimeBankAdjust;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.PublishingPeriod;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.vo.HOOAssignment;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourceAssignment;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.TimeBank;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.SupportNavigation;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.base.RmException;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.ejb.param.RequestCountParam;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.flextime.validation.MaxNumberRequestsPerPeriodValidationRule;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionManager;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb.ShiftBidRequestManager;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.requests.swap.posting.ejb.ShiftSwapPostingManager;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.ShiftSwapPosting;
import com.bluepumpkin.ejb.rm.requests.swap.request.ejb.ShiftSwapRequestManager;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.request.validation.MaxNumberOneWaySwapPerPersonPeriodValidationRule;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TORequestManager;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOAccrual;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TimeOffActivitySummary;
import com.bluepumpkin.ejb.rm.setup.validation.model.ValidationRule;
import com.bluepumpkin.ejb.rm.util.DateUtil;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.ejb.rm.util.ShiftSwapRequestUtil;
import com.bluepumpkin.ejb.rm.util.TORequestUtil;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.workresource.WorkResourceModelHandler;
import com.bluepumpkin.web.fs.keys.FsKeys;
import com.bluepumpkin.web.fs.schedule.ScheduleViewMH;
import com.bluepumpkin.web.fs.schedule.ScheduleViewUtil;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.ModelHandler;
import com.witness.web.uif.system.RequestContext;

/**
 * Schedule Summary model handler handles EJB interactions for the
 * user's schedule summary page model.  Since there are no update functions,
 * the only interaction is retrieval of the value objects needed for the
 * page model.
 */
<span class="nc" id="L92">public class ScheduleSummaryMH extends ModelHandler {</span>
	//keys for the hash map of page data objects
	public static final String THIS_WEEK_SCHEDULE_KEY = &quot;THIS_WEEK_SCHEDULE_KEY&quot;;
	public static final String THIS_WEEK_START_DATE_KEY = &quot;THIS_WEEK_START_DATE_KEY&quot;;
	public static final String SHOW_TO_SUMMARY = &quot;SHOW_TO_SUMMARY&quot;;
	public static final String SHOW_TO_FLEX_TIME_SUMMARY = &quot;SHOW_TO_FLEX_TIME_SUMMARY&quot;;
	public static final String SHOW_SS_SUMMARY = &quot;SHOW_SS_SUMMARY&quot;;
	public static final String SHOW_SB_SUMMARY = &quot;SHOW_SB_SUMMARY&quot;;
	public static final String SHOW_TB_SUMMARY = &quot;SHOW_TB_SUMMARY&quot;;
	public static final String SHOW_ONE_WAY_SS_SUMMARY = &quot;SHOW_ONE_WAY_SS_SUMMARY&quot;;

	public static final String TO_SUMMARY_DATA_KEY = &quot;TO_SUMMARY_DATA_KEY&quot;;
	public static final String TO_YEAR_KEY = &quot;TO_YEAR_KEY&quot;;
	public static final String SS_SUMMARY_DATA_KEY = &quot;SS_SUMMARY_DATA_KEY&quot;;
	public static final String SB_SUMMARY_DATA_KEY = &quot;SB_SUMMARY_DATA_KEY&quot;;
	public static final String TB_SUMMARY_DATA_KEY = &quot;TB_SUMMARY_DATA_KEY&quot;;
	public static final String ONE_WAY_SS_SUMMARY_DATA_KEY = &quot;ONE_WAY_SS_SUMMARY_DATA_KEY&quot;;
	public static final String FLEX_TIME_DATA_KEY = &quot;FLEX_TIME_DATA_KEY&quot;;

	public static final int PERIOD_MONTH_INDEX = 0;
	public static final int PERIOD_QUARTER_INDEX = 1;

	/**
	 * Returns all the data for the Schedule Summary page
	 * @param context
	 */
	public static HashMap getData(RequestContext context)
			throws RemoteException, RmHardValidationException, Exception {
<span class="nc" id="L120">		HashMap&lt;String, Object&gt; theData = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L121">		ScheduleViewMH.putUserOrgID(context,theData);</span>
<span class="nc" id="L122">		getThisWeekSchedule(context,theData);</span>
<span class="nc" id="L123">		Collection&lt;ShiftAssignment&gt; shiftAssignments = (Collection&lt;ShiftAssignment&gt;)theData.get(ScheduleViewMH.SCHEDULE_SHIFTS_KEY);</span>
<span class="nc" id="L124">		ScheduleViewMH.putCampaignNamesBySpId(context, theData, shiftAssignments);</span>
<span class="nc" id="L125">		getShiftSwapSummary(context,theData);</span>
<span class="nc" id="L126">		getOneWayShiftSwapSummary(context,theData);</span>
<span class="nc" id="L127">		getFlexTimeSummary(context, theData);</span>
<span class="nc" id="L128">		getShiftBiddingSummary(context,theData);</span>
<span class="nc" id="L129">		getTimeBankingSummary(context, theData);</span>

<span class="nc" id="L131">		return theData;</span>
	}//getData

	//======= this week schedule ===================
	/**
	 * Get Daily Schedule Summary for the current employee/user and the current week
	 * @param context
	 * @param theData - hash map to be filled with data
	 */
	private static void getThisWeekSchedule( RequestContext context, HashMap theData)
			throws RemoteException, BbmException
		{
		//--- get this week period
<span class="nc" id="L144">		Calendar thisWeekStart = ScheduleViewMH.getThisWeekStart(context, theData);</span>
<span class="nc" id="L145">		theData.put(THIS_WEEK_START_DATE_KEY,thisWeekStart);</span>

		//    week end
<span class="nc" id="L148">		Calendar thisWeekEnd = ScheduleViewMH.getThisWeekEnd(context,thisWeekStart);</span>

		//--- get this employee schedule events
<span class="nc" id="L151">		ID employeeID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L152">		TimeRange timeRange = new TimeRange(thisWeekStart.getTime(),thisWeekEnd.getTime());</span>
<span class="nc" id="L153">		ScheduleAccessManager scheduleAccessManager = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc" id="L154">		Collection&lt;? extends Event&gt; scheduleEvents = ScheduleViewMH.getPersonalScheduleEvents(scheduleAccessManager, employeeID, timeRange);</span>
<span class="nc" id="L155">		Collection&lt;ShiftAssignment&gt; scheduledShiftAssignments = ScheduleViewMH.selectOnlyShiftAssignments(scheduleEvents);</span>
<span class="nc" id="L156">		theData.put(ScheduleViewMH.SCHEDULE_SHIFTS_KEY, scheduledShiftAssignments);</span>

		//--- load published periods for the employee, from, to
<span class="nc" id="L159">		ArrayList eIDs = new ArrayList(1);  eIDs.add(employeeID);</span>
<span class="nc" id="L160">        Collection pubPeriodsForEmps = scheduleAccessManager.getPublishedPeriods(eIDs, timeRange.getStartDate(), timeRange.getEndDate());</span>
<span class="nc" id="L161">		Collection&lt;TimeRange&gt; ppTimeRanges = ScheduleViewMH.getTimeRangesForPublishedPeriods(pubPeriodsForEmps, theData, timeRange, eIDs);</span>

        //Get the only PublishingPeriod from the collection
<span class="nc" id="L164">        PublishingPeriod pubPeriodForEmp = null;</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        for (Iterator ppIt = pubPeriodsForEmps.iterator(); ppIt.hasNext();)</span>
        {
<span class="nc" id="L167">            Object obj = ppIt.next();</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">            if (obj != null)</span>
            {
<span class="nc bnc" id="L170" title="All 2 branches missed.">                if (obj instanceof PublishingPeriod)</span>
                {
<span class="nc" id="L172">                    pubPeriodForEmp = (PublishingPeriod)ppIt.next();</span>
                }
<span class="nc bnc" id="L174" title="All 2 branches missed.">                else if (obj instanceof ArrayList)</span>
                {
<span class="nc" id="L176">                    ArrayList pubPeriodsForEmps2 = (ArrayList)obj;</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                    for (Iterator ppIt2 = pubPeriodsForEmps2.iterator(); ppIt2.hasNext();) {</span>
<span class="nc" id="L178">						pubPeriodForEmp = (PublishingPeriod)ppIt2.next();</span>
					}
                }
            }
<span class="nc" id="L182">        }</span>

		//--- get agent HOOs
<span class="nc" id="L185">		ID userOrgID = (ID)theData.get(ScheduleViewMH.USER_ORG_ID_KEY);</span>
<span class="nc" id="L186">		HOOAssignment hOOAssignment = ScheduleViewMH.getOrgHOOs(context, userOrgID, timeRange);</span>
<span class="nc" id="L187">		theData.put(ScheduleViewMH.HOOS_KEY, hOOAssignment);</span>

<span class="nc" id="L189">		ScheduleViewMH.putActivities(context, theData);</span>

		//--- make and store daily summaries
<span class="nc" id="L192">		Collection&lt;DailyScheduleSummary&gt; daySummaries = ScheduleViewUtil.makeDaySummaries(context, timeRange,</span>
							scheduleEvents, ppTimeRanges, hOOAssignment, pubPeriodsForEmps, null, employeeID,
<span class="nc" id="L194">							(Map&lt;ID, Activity&gt;)theData.get(ScheduleViewMH.ACTIVITIES_KEY)); //Passing whole pubperiod for QA99660</span>
<span class="nc" id="L195">		theData.put(THIS_WEEK_SCHEDULE_KEY, daySummaries);</span>
<span class="nc" id="L196">	}//getThisWeekSchedule</span>


	//=========== time off sumary =============================
	/**
	 * Get Time Off Summary for the given employee/user and the selected year
	 * @param context
	 * @param empID
	 * @param theData - hash map to be filled with data
	 */
	public static void getTimeOffSummary( RequestContext context, ID empID, Date inputDate, String thisOrNextTOYear,
			Map&lt;String, Object&gt; theData, boolean isAgentPage)
			throws RemoteException, BbmException, Exception {
		//--- check if need to show TO summary, with either privilege will show
		//if (! ScheduleViewUtil.isPrivWithGenScope(context, theData, PrivilegeKeys.TOM_VIEWPERSONALSUMMARY, SHOW_TO_SUMMARY))
<span class="nc bnc" id="L211" title="All 2 branches missed.">		boolean bValue = (context.getUser().isAuthorized(PrivilegeKeys.TOM_VIEWPERSONALSUMMARY)</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">				|| context.getUser().isAuthorized(PrivilegeKeys.TOM_VIEWAVAILABLETIMEOFF));</span>
<span class="nc" id="L213">		theData.put(SHOW_TO_SUMMARY, new Boolean(bValue));</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">		if (!bValue) {</span>
<span class="nc" id="L215">			return;</span>
		}

<span class="nc" id="L218">		Calendar yearStart =getEmployeeYearStart ( context,  empID,  inputDate,  thisOrNextTOYear);</span>
<span class="nc" id="L219">		theData.put(TO_YEAR_KEY,yearStart);</span>

		//--- get this employee Time Off summary
<span class="nc" id="L222">		Collection toSummaryData = getTimeOffSummary(empID,yearStart,null, isAgentPage);</span>
<span class="nc" id="L223">		theData.put(TO_SUMMARY_DATA_KEY,toSummaryData);</span>
<span class="nc" id="L224">	}//getTimeOffSummary</span>

	public static Calendar getEmployeeYearStart (RequestContext context, ID empID, Date inputDate, String thisOrNextTOYear)throws Exception{
<span class="nc" id="L227">		Calendar now = Calendar.getInstance(context.getViewingTimeZone());//current time</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">		if (inputDate != null) {</span>
<span class="nc" id="L229">			now.setTime(inputDate);</span>
		}
<span class="nc" id="L231">		Calendar yearStart = getYearStart(context, empID, now, thisOrNextTOYear);</span>
<span class="nc" id="L232">		return  yearStart;</span>
	}

	/**
	 * @param isAgentPage - Is this for the agent's page? true if yes, no if manager's page.
	 * @return
	 * @throws Exception
	 */
	public static HashMap getTimeOffSummary(RequestContext context, Collection empIDs, Date inputDate, boolean isAgentPage) throws Exception {
		//--- check if need to show TO summary, with either privilege will show
<span class="nc bnc" id="L242" title="All 2 branches missed.">		boolean bValue = (context.getUser().isAuthorized(PrivilegeKeys.TOM_VIEWPERSONALSUMMARY)</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">		        || context.getUser().isAuthorized(PrivilegeKeys.TOM_VIEWAVAILABLETIMEOFF));</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">		if (!bValue) {</span>
<span class="nc" id="L245">			return new HashMap();</span>
		}
<span class="nc" id="L247">		RmManagerFactory rmManagerFactory = RmManagerFactory.getInstance();</span>
<span class="nc" id="L248">		TORequestManager toRequestManager = rmManagerFactory.getTimeOffRequestManager();</span>

<span class="nc" id="L250">		Calendar now = Calendar.getInstance(context.getViewingTimeZone());//current time</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">		if (inputDate != null) {</span>
<span class="nc" id="L252">			now.setTime(inputDate);</span>
		}

<span class="nc" id="L255">		HashMap empSummaryMap = toRequestManager.getTOActivitySummaryData(empIDs, -1, null, now.getTime(), isAgentPage, isAgentPage);</span>

<span class="nc bnc" id="L257" title="All 2 branches missed.">		for (Iterator iterator = empSummaryMap.keySet().iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L258">			ID empId = (ID) iterator.next();</span>
<span class="nc" id="L259">			TimeOffActivitySummary[] summaries = (TimeOffActivitySummary[]) empSummaryMap.get(empId);</span>
<span class="nc" id="L260">			ArrayList theTOSummary = new ArrayList();</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">			if (summaries != null) {</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">				for (int i = 0; i &lt; summaries.length; i++) {</span>
<span class="nc" id="L263">					theTOSummary.add(summaries[i]);</span>
				}
			}
<span class="nc" id="L266">			empSummaryMap.put(empId, theTOSummary);</span>
<span class="nc" id="L267">		}</span>
<span class="nc" id="L268">		return empSummaryMap;</span>
	}

	/**
	 * get time off year start for the given user
	 */
	public static Calendar getYearStart(RequestContext context, ID empID, Calendar now, String thisOrNextTOYear)
			throws RemoteException, BbmException, BbmCreateException, Exception {
		// Create Default Start Year
<span class="nc" id="L277">		Calendar toYearStart = Calendar.getInstance(context.getViewingTimeZone());</span>
<span class="nc" id="L278">		toYearStart.set( now.get(Calendar.YEAR), 0, 1, 0, 0, 0 );</span>
<span class="nc" id="L279">		toYearStart.set( Calendar.MILLISECOND, 0 );</span>

		//if user is an employee, get user time off year
<span class="nc" id="L282">		ID userOrgID = null;</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">		if (empID != null) {</span>
<span class="nc" id="L284">			userOrgID = OrganizationModelHandler.getEmployeeOrgID(context, empID);</span>
		}
<span class="nc bnc" id="L286" title="All 2 branches missed.">		if (userOrgID != null) {</span>
			// Get the month and day for the employee's time off year
<span class="nc" id="L288">			int[] md=RequestUtil.getEmployeeTimeOffYearStart(empID, userOrgID);</span>

			//set month and day into year start
<span class="nc" id="L291">			toYearStart.set(Calendar.MONTH, md[0]);</span>
<span class="nc" id="L292">			toYearStart.set(Calendar.DAY_OF_MONTH, md[1]);</span>

			//move year to cover this or next year
<span class="nc bnc" id="L295" title="All 4 branches missed.">			if (thisOrNextTOYear.equals(FsKeys.TO_YEAR_CURRENT) &amp;&amp; toYearStart.after(now)){</span>
<span class="nc" id="L296">				toYearStart.add(Calendar.YEAR,-1);</span>
<span class="nc bnc" id="L297" title="All 4 branches missed.">			} else if (thisOrNextTOYear.equals(FsKeys.TO_YEAR_NEXT) &amp;&amp; !toYearStart.after(now)) {</span>
<span class="nc" id="L298">				toYearStart.add(Calendar.YEAR,1);</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">			}else if (thisOrNextTOYear.equals(FsKeys.TO_YEAR_PREVIOUS)){</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">				toYearStart.add(Calendar.YEAR,(toYearStart.after(now)?-2:-1));</span>
			}
<span class="nc" id="L302">		} else {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">			if (thisOrNextTOYear.equals(FsKeys.TO_YEAR_NEXT)){</span>
<span class="nc" id="L304">				toYearStart.add(Calendar.YEAR,1);</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">			}else if (thisOrNextTOYear.equals(FsKeys.TO_YEAR_PREVIOUS)){</span>
<span class="nc" id="L306">				toYearStart.add(Calendar.YEAR,-1);</span>
			}
		}

<span class="nc" id="L310">		return toYearStart;</span>
	}//getYearStart

	/**
	 * Return TO summary data from the EJB tier for selected year for the current employee
	 */
	public static Collection getTimeOffSummary(ID empID, Calendar periodStart, ID activityID, boolean isAgentPage)
			throws RemoteException, BbmException, BbmCreateException {

<span class="nc" id="L319">		RmManagerFactory rmManagerFactory = RmManagerFactory.getInstance();</span>
<span class="nc" id="L320">		TORequestManager toRequestManager = rmManagerFactory.getTimeOffRequestManager();</span>
<span class="nc" id="L321">		TimeOffActivitySummary[] summaries =</span>
<span class="nc" id="L322">				toRequestManager.getTOActivitySummaryData(empID, periodStart.get(Calendar.YEAR), activityID, isAgentPage, isAgentPage);</span>

<span class="nc" id="L324">		ArrayList theTOSummary = new ArrayList();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">		if (summaries != null) {</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">			for (int i = 0; i &lt; summaries.length; i++) {</span>
<span class="nc" id="L327">				theTOSummary.add(summaries[i]);</span>
			}
		}

<span class="nc" id="L331">		return theTOSummary;</span>
	}


	//=========== ShiftSwap summary =============================
	/**
	 * Get Shift Swap Summary for the current employee/user
	 * @param context
	 * @param theData - hash map to be filled with data
	 */
	public static void getShiftSwapSummary( RequestContext context, Map&lt;String, Object&gt; theData)
			throws RemoteException, BbmException, RmHardValidationException {
<span class="nc bnc" id="L343" title="All 2 branches missed.">		if ( !ScheduleViewUtil.isPrivWithGenScope(context, theData,</span>
				PrivilegeKeys.SS_VIEWPERSONALREQUESTS, SHOW_SS_SUMMARY)) {
<span class="nc" id="L345">			return;</span>
		}

		//--- get swap board postings for employee
<span class="nc" id="L349">		ID employeeID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L350">		RmManagerFactory factory = RmManagerFactory.getInstance();</span>
<span class="nc" id="L351">		ShiftSwapPostingManager shiftSwapPostingManager = factory.getShiftSwapPostingManager();</span>
		//get swap board postings from this employeeID
<span class="nc" id="L353">		Collection swapPostings = shiftSwapPostingManager.findShiftSwapPostingsByEmployee(</span>
<span class="nc" id="L354">				employeeID, ShiftSwapPosting.DL_ALL, SupportNavigation.CHUNKSIZE_ALL, true).getPostings();</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">		int nPostings = (swapPostings!=null)?swapPostings.size():0;</span>

		//--- get swap requests for employee
<span class="nc" id="L358">		ShiftSwapRequestManager shiftSwapRequestManager = factory.getShiftSwapRequestManager();</span>
<span class="nc" id="L359">		Collection swapRequests = shiftSwapRequestManager.getRequestsByEmployee(employeeID, true, true, ShiftSwapRequest.DL_BASIC);</span>

		// calculate numbers by status
<span class="nc" id="L362">		int nRequests = swapRequests.size();</span>
		int nExpired, nNegot, nPending, nApproved, nDenied, nInvalid;
<span class="nc" id="L364">		nExpired = nNegot = nPending = nApproved = nDenied = nInvalid = 0;</span>

<span class="nc bnc" id="L366" title="All 2 branches missed.">		for (Iterator it = swapRequests.iterator();it.hasNext();){</span>
<span class="nc" id="L367">			ShiftSwapRequest aRequest = (ShiftSwapRequest)it.next();</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">			if (aRequest.hasExpired()) {</span>
<span class="nc" id="L369">				nExpired++;</span>
<span class="nc" id="L370">				continue;</span>
			}

<span class="nc" id="L373">			String status = aRequest.getRequestStatus();</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">			if (status.equals(RequestAuditTrail.STATUS_NEGOTIATION)) {</span>
<span class="nc" id="L375">				nNegot ++;</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">			} else if (status.equals(RequestAuditTrail.STATUS_PENDING)</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">					|| status.equals(RequestAuditTrail.STATUS_TENTATIVE)) {</span>
<span class="nc" id="L378">				nPending ++;</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">			} else if (status.equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L380">				nApproved ++;</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">			} else if (status.equals(RequestAuditTrail.STATUS_DENIED)) {</span>
<span class="nc" id="L382">				nDenied ++;</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">			} else if (status.equals(RequestAuditTrail.STATUS_INVALID)) {</span>
<span class="nc" id="L384">				nInvalid ++;</span>
			}
<span class="nc" id="L386">		}</span>

		//---make summary VO
<span class="nc" id="L389">		ShiftSwapSummaryData sData = new ShiftSwapSummaryData(nPostings,nRequests,nExpired,nNegot,nPending,nApproved,nDenied,nInvalid);</span>
<span class="nc" id="L390">		theData.put(SS_SUMMARY_DATA_KEY,sData);</span>
<span class="nc" id="L391">	}//getShiftSwapSummary</span>

	//=========== Flex Time summary =============================

	/**
	 * Get Flex Time Summary for the current employee/user (agent page).
	 * @param context
	 * @param theData - hash map to be filled with data
	 * @throws Exception
	 */
	public static void getFlexTimeSummary(RequestContext context, Map&lt;String, Object&gt; theData) throws Exception {
<span class="nc bnc" id="L402" title="All 2 branches missed.">		if (LicenseUtil.isAdvancedRMLicense() &amp;&amp;</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">				ScheduleViewUtil.isPrivWithGenScope(context, PrivilegeKeys.FT_VIEWPERSONALREQUESTS)) {</span>
<span class="nc" id="L404">			ID employeeID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L405">			Set&lt;ID&gt; empIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L406">			empIDs.add(employeeID);</span>
<span class="nc" id="L407">			Map&lt;ID, FlexTimeSummaryData&gt; map = getFlexTimeSummary(context, empIDs);</span>
<span class="nc bnc" id="L408" title="All 4 branches missed.">			if (map != null &amp;&amp; map.containsKey(employeeID)) {</span>
<span class="nc" id="L409">				theData.put(SHOW_TO_FLEX_TIME_SUMMARY, true);</span>
<span class="nc" id="L410">				theData.put(FLEX_TIME_DATA_KEY, map.get(employeeID));</span>
<span class="nc" id="L411">				return;</span>
			}
<span class="nc" id="L413">		} else {</span>
<span class="nc" id="L414">			theData.put(SHOW_TO_FLEX_TIME_SUMMARY, false);</span>
		}
<span class="nc" id="L416">	}</span>

	/**
	 * Get Flex Time Summary for the given employees.
	 * @param context
	 * @param employeeIDs - the multi-selected employee ID's that you want data for.
	 * @throws Exception
	 */
	public static Map&lt;ID, FlexTimeSummaryData&gt; getFlexTimeSummary(RequestContext context, Set&lt;ID&gt; employeeIDs)
			throws Exception {
<span class="nc" id="L426">		Map&lt;ID, FlexTimeSummaryData&gt; summaryDataMap = new HashMap&lt;ID, FlexTimeSummaryData&gt;();</span>

<span class="nc bnc" id="L428" title="All 6 branches missed.">		if (LicenseUtil.isAdvancedRMLicense() &amp;&amp; employeeIDs != null &amp;&amp; !employeeIDs.isEmpty()) {</span>
<span class="nc" id="L429">			Map&lt;ID,Set&lt;ID&gt;&gt; orgIDsMap = getOrgIDsMap(context, employeeIDs);</span>

<span class="nc bnc" id="L431" title="All 2 branches missed.">			for (ID curOrgID : orgIDsMap.keySet()) {</span>
<span class="nc" id="L432">				Set&lt;ID&gt; empIDsForThisOrg = orgIDsMap.get(curOrgID);</span>

<span class="nc" id="L434">				ValidationRule vr = getEnabledValidationRuleForAdvancedRM(curOrgID, Request.REQUESTTYPE_FLEXTIME,</span>
						ValidationRule.VALIDATION_FT_MAX_NUMBER_FLEX_REQ_PER_PERIOD);
<span class="nc bnc" id="L436" title="All 4 branches missed.">				if (vr == null || !vr.isEnabled()) {</span>
<span class="nc" id="L437">					continue;</span>
				}

<span class="nc" id="L440">				Map&lt;?, ?&gt; paramMap = vr.getParamMap();</span>

<span class="nc" id="L442">				int limit = getParamValue(</span>
<span class="nc" id="L443">						String.valueOf(paramMap.get(MaxNumberRequestsPerPeriodValidationRule.MAX_FLEX_MAKEUP_PER_PERIOD)));</span>

<span class="nc" id="L445">				int periodUnit = getParamValue(</span>
<span class="nc" id="L446">						String.valueOf(paramMap.get(MaxNumberRequestsPerPeriodValidationRule.MAX_FLEX_MAKEUP_PER_PERIOD_UNIT)));</span>

<span class="nc" id="L448">				Organization org = RequestUtil.getOrganizationByID(curOrgID, null);</span>
<span class="nc" id="L449">				TimeRange periodRange = getTimeRangeOfConfiguredPeriodUnit(periodUnit, org.getTimeZone());</span>

<span class="nc" id="L451">				RequestCountParam param = new RequestCountParam().addAllEmployeeIDs(empIDsForThisOrg)</span>
<span class="nc" id="L452">						.addStatus(RequestAuditTrail.STATUS_APPROVED).setRequestType(Request.REQUESTTYPE_FLEXTIME)</span>
<span class="nc" id="L453">						.setTimeRange(periodRange);</span>

<span class="nc" id="L455">				Map&lt;ID, Integer&gt; numApprovedPerEmp = TORequestUtil.getNumberOfRequestPerPeriod(param);</span>

<span class="nc bnc" id="L457" title="All 2 branches missed.">				for (ID curEmpID : empIDsForThisOrg) {</span>
<span class="nc" id="L458">					int approved = 0;</span>
<span class="nc bnc" id="L459" title="All 4 branches missed.">					if (numApprovedPerEmp != null &amp;&amp; numApprovedPerEmp.containsKey(curEmpID)) {</span>
<span class="nc" id="L460">						approved = numApprovedPerEmp.get(curEmpID);</span>
					}

<span class="nc bnc" id="L463" title="All 2 branches missed.">					int remaining = limit &gt; approved ? (limit - approved) : 0;</span>

					// ---make summary VO
<span class="nc" id="L466">					FlexTimeSummaryData sData = new FlexTimeSummaryData();</span>
<span class="nc" id="L467">					sData.setPeriod(periodUnit).setApproved(approved).setLimit(limit)</span>
<span class="nc" id="L468">							.setRemaining(remaining).setStartDate(periodRange.getStartDate())</span>
<span class="nc" id="L469">							.setEndDate(adjustEndDate(periodRange.getEndDate(), org.getTimeZone()));</span>

<span class="nc" id="L471">					summaryDataMap.put(curEmpID, sData);</span>
<span class="nc" id="L472">				}</span>

<span class="nc" id="L474">			}</span>
		}
<span class="nc" id="L476">		return summaryDataMap;</span>
	}

	private static Date adjustEndDate(Date date, TimeZone timeZone) {
<span class="nc" id="L480">		Calendar cal = Calendar.getInstance(timeZone);</span>
<span class="nc" id="L481">		cal.setTime(date);</span>
<span class="nc" id="L482">		cal.add(Calendar.SECOND, -1);</span>
<span class="nc" id="L483">		return cal.getTime();</span>
	}

	//=========== One Way ShiftSwap summary =============================

	/**
	 * Get OneWayShift Swap Summary for the current employee/user (agent page).
	 * @param context
	 * @param theData - hash map to be filled with data
	 * @throws Exception
	 */
	public static void getOneWayShiftSwapSummary(RequestContext context, Map&lt;String, Object&gt; theData) throws Exception {
<span class="nc bnc" id="L495" title="All 2 branches missed.">		if (LicenseUtil.isAdvancedRMLicense() &amp;&amp;</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">				ScheduleViewUtil.isPrivWithGenScope(context, PrivilegeKeys.SS_VIEWPERSONALREQUESTS)) {</span>
<span class="nc" id="L497">			ID employeeID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L498">			Set&lt;ID&gt; empIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L499">			empIDs.add(employeeID);</span>
<span class="nc" id="L500">			Map&lt;ID, OneWayShiftSwapSummaryData&gt; map = getOneWayShiftSwapSummary(context, empIDs);</span>
<span class="nc bnc" id="L501" title="All 4 branches missed.">			if (map != null &amp;&amp; map.containsKey(employeeID)) {</span>
<span class="nc" id="L502">				theData.put(SHOW_ONE_WAY_SS_SUMMARY, true);</span>
<span class="nc" id="L503">				theData.put(ONE_WAY_SS_SUMMARY_DATA_KEY, map.get(employeeID));</span>
<span class="nc" id="L504">				return;</span>
			}
<span class="nc" id="L506">		} else {</span>
<span class="nc" id="L507">			theData.put(SHOW_ONE_WAY_SS_SUMMARY, false);</span>
		}
<span class="nc" id="L509">	}</span>

	/**
	 * Get OneWayShift Swap Summary for the given employees.
	 * @param context
	 * @param employeeIDs - the multi-selected employee ID's that you want data for.
	 * @throws Exception
	 */
	public static Map&lt;ID, OneWayShiftSwapSummaryData&gt; getOneWayShiftSwapSummary(
			RequestContext context, Set&lt;ID&gt; employeeIDs)	throws Exception {
<span class="nc" id="L519">		Map&lt;ID, OneWayShiftSwapSummaryData&gt; summaryDataMap = new HashMap&lt;ID, OneWayShiftSwapSummaryData&gt;();</span>

<span class="nc bnc" id="L521" title="All 6 branches missed.">		if (LicenseUtil.isAdvancedRMLicense() &amp;&amp; employeeIDs != null &amp;&amp; !employeeIDs.isEmpty()) {</span>
<span class="nc" id="L522">			Map&lt;ID,Set&lt;ID&gt;&gt; orgIDsMap = getOrgIDsMap(context, employeeIDs);</span>

<span class="nc bnc" id="L524" title="All 2 branches missed.">			for (ID curOrgID : orgIDsMap.keySet()) {</span>
<span class="nc" id="L525">				Set&lt;ID&gt; empIDsForThisOrg = orgIDsMap.get(curOrgID);</span>

<span class="nc" id="L527">				ValidationRule vr = getEnabledValidationRuleForAdvancedRM(curOrgID, Request.REQUESTTYPE_SHIFTSWAP,</span>
						ValidationRule.VALIDATION_SS_MAX_ONE_WAY_SWAP_PER_PERSON_PERIOD);
<span class="nc bnc" id="L529" title="All 4 branches missed.">				if (vr == null || !vr.isEnabled()) {</span>
<span class="nc" id="L530">					continue;</span>
				}

<span class="nc" id="L533">				Map&lt;?, ?&gt; paramMap = vr.getParamMap();</span>

<span class="nc" id="L535">				int limit = getParamValue(String.valueOf(paramMap</span>
<span class="nc" id="L536">						.get(MaxNumberOneWaySwapPerPersonPeriodValidationRule.MAX_ONE_WAY_SWAP_PER_PERSON_PERIOD)));</span>

<span class="nc" id="L538">				int periodUnit = getParamValue(String.valueOf(paramMap</span>
<span class="nc" id="L539">						.get(MaxNumberOneWaySwapPerPersonPeriodValidationRule.MAX_ONE_WAY_SWAP_PER_PERSON_PERIOD_UNIT)));</span>

<span class="nc" id="L541">				Organization org = RequestUtil.getOrganizationByID(curOrgID, null);</span>
<span class="nc" id="L542">				TimeRange periodRange = getTimeRangeOfConfiguredPeriodUnit(periodUnit, org.getTimeZone());</span>

<span class="nc" id="L544">				Map&lt;ID, Integer&gt; numApprovedPerEmp = ShiftSwapRequestUtil.getNormalizedNumberOfOneWaySwapsForEmployees(empIDsForThisOrg, org,</span>
<span class="nc" id="L545">						periodRange.getStartDate(), periodRange.getEndDate());</span>

<span class="nc bnc" id="L547" title="All 2 branches missed.">				for (ID curEmpID : empIDsForThisOrg) {</span>
<span class="nc" id="L548">					int approved = 0;</span>
<span class="nc bnc" id="L549" title="All 4 branches missed.">					if (numApprovedPerEmp != null &amp;&amp; numApprovedPerEmp.containsKey(curEmpID)) {</span>
<span class="nc" id="L550">						approved = numApprovedPerEmp.get(curEmpID);</span>
					}

<span class="nc bnc" id="L553" title="All 2 branches missed.">					int remaining = limit &gt; approved ? (limit - approved) : 0;</span>

					//---make summary VO
<span class="nc" id="L556">					OneWayShiftSwapSummaryData sData = new OneWayShiftSwapSummaryData();</span>
<span class="nc" id="L557">					sData.setPeriod(periodUnit).setApproved(approved).setLimit(limit).setRemaining(remaining)</span>
<span class="nc" id="L558">							.setStartDate(periodRange.getStartDate())</span>
<span class="nc" id="L559">							.setEndDate(adjustEndDate(periodRange.getEndDate(), org.getTimeZone()));</span>

<span class="nc" id="L561">					summaryDataMap.put(curEmpID, sData);</span>
<span class="nc" id="L562">				}</span>
<span class="nc" id="L563">			}</span>
		}
<span class="nc" id="L565">		return summaryDataMap;</span>
	}

	/**
	 * Build a map of each org mapped to all of the employeeID's belonging to that org.
	 */
	private static Map&lt;ID,Set&lt;ID&gt;&gt; getOrgIDsMap(RequestContext context, Set&lt;ID&gt; employeeIDs) throws Exception {
<span class="nc" id="L572">		Map&lt;ID,Set&lt;ID&gt;&gt; orgIDsMap = new HashMap&lt;ID,Set&lt;ID&gt;&gt;();</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">		for (ID curEmpID : employeeIDs) {</span>
<span class="nc" id="L574">			ID orgID = getOrgIDForEmp(context, curEmpID);</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">			if (orgIDsMap.containsKey(orgID)) {</span>
<span class="nc" id="L576">				orgIDsMap.get(orgID).add(curEmpID);</span>
			} else {
<span class="nc" id="L578">				Set&lt;ID&gt; empIDsForThisOrg = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L579">				empIDsForThisOrg.add(curEmpID);</span>
<span class="nc" id="L580">				orgIDsMap.put(orgID, empIDsForThisOrg);</span>
			}
<span class="nc" id="L582">		}</span>
<span class="nc" id="L583">		return orgIDsMap;</span>
	}

	private static TimeRange getTimeRangeOfConfiguredPeriodUnit(int periodUnit, TimeZone orgTZ)
			throws BbmEJBCreateException, RemoteException {
<span class="nc bnc" id="L588" title="All 2 branches missed.">		return DateUtil.getFiscalRange(getFirstDateOfYear(orgTZ), new Date(), periodUnit == PERIOD_MONTH_INDEX ? 1 : 3, orgTZ);</span>
	}

	private static Date getFirstDateOfYear(TimeZone orgTZ) throws BbmEJBCreateException, RemoteException {
<span class="nc" id="L592">		String strFirstDateOfYearFromEM = getDbConfigManager().getValue(&quot;EnterpriseSettings/CAL_STARTING_DATE_YEAR&quot;);</span>
<span class="nc bnc" id="L593" title="All 4 branches missed.">		if (strFirstDateOfYearFromEM == null || strFirstDateOfYearFromEM.isEmpty()) {</span>
			// NO EM FISCAL YEAR, USE THE STANDARD CALENDAR
<span class="nc" id="L595">			return DateUtil.getFirstDateOfCurrentCalendarYear(orgTZ);</span>
		}
<span class="nc" id="L597">		Date firstDate = DateUtil.iso8601SecPrecisionStringToDate(strFirstDateOfYearFromEM, orgTZ);</span>
<span class="nc" id="L598">		return firstDate;</span>
	}

	private static DBConfigManager getDbConfigManager() throws BbmEJBCreateException {
<span class="nc" id="L602">		return BbmManagerFactory.getDBConfigManager();</span>
	}

	/**
	 * If the Advanced RM license is installed, and the valRuleID validation rule is enabled for the given
	 * orgID, return the rule. Otherwise, return null.
	 */
	private static ValidationRule getEnabledValidationRuleForAdvancedRM(ID orgID, String requestType, String valRuleID)
			throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L611">		ValidationRule vr = null;</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">		if (LicenseUtil.isAdvancedRMLicense()) {</span>
			// Check the Validation rules for this employee
			@SuppressWarnings(&quot;unchecked&quot;)
			Map&lt;String, ValidationRule&gt; validationRules = (Map&lt;String, ValidationRule&gt;)
<span class="nc" id="L616">					RmManagerFactory.getInstance().getValidationRuleManager().findValidationRules(</span>
					requestType, orgID, false);
<span class="nc" id="L618">			vr = validationRules.get(valRuleID);</span>
<span class="nc bnc" id="L619" title="All 4 branches missed.">			if (vr == null || !vr.isEnabled()) {</span>
<span class="nc" id="L620">				return null;</span>
			}
		}
<span class="nc" id="L623">		return vr;</span>
	}

	/**
	 * Convert a validation rule's parameter value String to an int, or 0 if no value has been set for it.
	 */
    private static int getParamValue(String paramValue) {
<span class="nc bnc" id="L630" title="All 4 branches missed.">        return paramValue.equals(&quot;-1&quot;) || paramValue.equals(&quot;null&quot;) ? 0 : Integer.parseInt(paramValue);</span>
    }

	/**
	 * Get an employee's organization ID.
	 */
    private static ID getOrgIDForEmp(RequestContext context, ID empID) throws Exception {
<span class="nc bnc" id="L637" title="All 2 branches missed.">		if (empID != null) {</span>
<span class="nc" id="L638">			return OrganizationModelHandler.getEmployeeOrgID(context, empID);</span>
		}
<span class="nc" id="L640">		return null;</span>
	}

	//=========== Shift Bidding summary =============================
	/**
	 * Get Shift Bidding Summary for the current employee/user
	 * @param context
	 * @param theData - hash map to be filled with data
	 */
	public static void getShiftBiddingSummary(RequestContext context, Map&lt;String, Object&gt; theData) throws Exception  {
<span class="nc bnc" id="L650" title="All 2 branches missed.">		if ( !ScheduleViewUtil.isPrivWithGenScope(context, theData,</span>
				PrivilegeKeys.SB_VIEWPERSONALBIDS, SHOW_SB_SUMMARY)) {
<span class="nc" id="L652">			return;</span>
		}

		//--- get requests for employee
<span class="nc" id="L656">		ID employeeID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L657">		RmManagerFactory factory = RmManagerFactory.getInstance();</span>
<span class="nc" id="L658">		ShiftBidRequestManager sbManager = factory.getShiftBidRequestManager();</span>
<span class="nc" id="L659">		Collection requests = sbManager.getRequestsByEmployee(employeeID, true, true, ShiftBidRequest.DL_BASIC);</span>

		// number of auctions user is involvednote
<span class="nc" id="L662">		int nAuctions = 0;</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">		if (employeeID == null) {</span>
<span class="nc" id="L664">			nAuctions = Collections.emptyList().size();</span>
		}
		else {
<span class="nc" id="L667">			ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L668">			nAuctions = sbAuctionMgr.getAuctionsForBidderEmpID(employeeID, ShiftBidAuction.DL_BASIC | ShiftBidAuction.DL_EXCLUDE_EXPIRED_AUCTION).size();</span>
		}

		// calculate numbers by status
<span class="nc" id="L672">		int nRequests = requests.size();</span>
		int nExpired, nPending, nApproved, nDenied, nInvalid;
<span class="nc" id="L674">		nExpired = nPending = nApproved = nDenied = nInvalid = 0;</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">		for (Iterator it = requests.iterator();it.hasNext();){</span>
<span class="nc" id="L676">			ShiftBidRequest aRequest = (ShiftBidRequest)it.next();</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">			if (aRequest.hasExpired()) {</span>
<span class="nc" id="L678">				nExpired++;</span>
<span class="nc" id="L679">				continue;</span>
			}

<span class="nc" id="L682">			String status = aRequest.getRequestStatus();</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">			if (status.equals(RequestAuditTrail.STATUS_PENDING)) {</span>
<span class="nc" id="L684">				nPending ++;</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">			} else if (status.equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L686">				nApproved ++;</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">			} else if (status.equals(RequestAuditTrail.STATUS_DENIED)) {</span>
<span class="nc" id="L688">				nDenied ++;</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">			} else if (status.equals(RequestAuditTrail.STATUS_INVALID)) {</span>
<span class="nc" id="L690">				nInvalid ++;</span>
			}
<span class="nc" id="L692">		}</span>

<span class="nc" id="L694">		ShiftBidSummaryData sData = new ShiftBidSummaryData(nAuctions,nRequests,nExpired,nPending,nApproved,nDenied,nInvalid);</span>
<span class="nc" id="L695">		theData.put(SB_SUMMARY_DATA_KEY, sData);</span>
<span class="nc" id="L696">	}</span>

    //=========== Time Banking Summary =============================
    /**
     * Get Time Banking Summary for the current employee/user
     * @param context
     * @param theData - hash map to be filled with data
     */
    public static void getTimeBankingSummary(RequestContext context, HashMap theData) throws Exception
    {
        //if ( !ScheduleViewUtil.isPrivWithGenScope(context, theData, PrivilegeKeys.TB_VIEWPERSONALBANKS, SHOW_TB_SUMMARY))
<span class="nc" id="L707">        boolean bValue = checkLicense(LicenseKeys.APP_TIME_BANK);</span>
<span class="nc" id="L708">        Boolean boolFlag = new Boolean(bValue);</span>
<span class="nc" id="L709">        theData.put(SHOW_TB_SUMMARY, boolFlag);</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">        if (!bValue) {</span>
<span class="nc" id="L711">			return;</span>
		}

<span class="nc" id="L714">        ID empID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L715">        ArrayList empIDs = new ArrayList(1);</span>
<span class="nc" id="L716">        empIDs.add(empID);</span>
<span class="nc" id="L717">        HashMap tbSummaries = getTimeBankingSummaries(context, empIDs);</span>
<span class="nc" id="L718">        TimeBankSummaryData sData=null;</span>
<span class="nc bnc" id="L719" title="All 4 branches missed.">        if (tbSummaries!=null &amp;&amp; !tbSummaries.isEmpty())</span>
        {
<span class="nc" id="L721">            sData = (TimeBankSummaryData)tbSummaries.get(empID);</span>
        }
<span class="nc" id="L723">        theData.put(TB_SUMMARY_DATA_KEY, sData);</span>
<span class="nc" id="L724">    }</span>

    /**
     * Get Time Banking Summary data for the desired employees.
     * @param context - request context.
     * @param empIDs - The IDs of the selected employees whose time bank data is to be shown
     * @return a HashMap of empID-&gt;TimeBankSummaryData for the specified employee IDs.
     */
    public static HashMap getTimeBankingSummaries(RequestContext context, Collection empIDs) throws Exception
    {
<span class="nc" id="L734">        HashMap theResult = new HashMap();</span>
<span class="nc" id="L735">        Date now = new Date();</span>

<span class="nc bnc" id="L737" title="All 6 branches missed.">        if (empIDs==null || empIDs.isEmpty() || !checkLicense(LicenseKeys.APP_TIME_BANK)) {</span>
<span class="nc" id="L738">			return theResult;</span>
		}

<span class="nc" id="L741">        EmpWorkRuleManager empWorkRuleManager = WfmManagerFactory.getEmpWorkRuleManager();</span>
<span class="nc" id="L742">        WorkRuleManager workRuleManager = WfmManagerFactory.getWorkRuleManager();</span>
<span class="nc" id="L743">        ScheduleAccessManager scheduleAccessManager = WfmManagerFactory.getScheduleAccessManager();</span>

<span class="nc" id="L745">        HashMap tbaMap = empWorkRuleManager.getTimeBankAssignments(empIDs, now, now);</span>
<span class="nc" id="L746">        HashMap timeBanks = new HashMap();</span>

<span class="nc bnc" id="L748" title="All 2 branches missed.">        for (Iterator employeeIt=empIDs.iterator(); employeeIt.hasNext();)</span>
        {
<span class="nc" id="L750">            ID empID = (ID)employeeIt.next();</span>
<span class="nc" id="L751">            String tbName = &quot;&quot;;</span>
<span class="nc" id="L752">            Date tbStartDate = null;     //time bank start date for employee's current time bank in GMT</span>
<span class="nc" id="L753">            Date tbEndDate = null;       //time bank end date minus 1 second, for employee's current time bank in GMT</span>
<span class="nc" id="L754">            Date tbEndDateOrig = null;   //time bank end date for employee's current time bank in GMT</span>
<span class="nc" id="L755">            Date tbStartDateLocal = null;//time bank start date for employee's current time bank in org TZ</span>
<span class="nc" id="L756">            Date tbEndDateLocal = null;  //time bank end date for employee's current time bank in org TZ</span>
<span class="nc" id="L757">            Date prEndDate = null;       //pro-rate end date. This is the &quot;up-to-now&quot; date used for the pro-rated fields (the end of the last fully published schedule period, in the campaign's tz)</span>
<span class="nc" id="L758">            Date prEndDateLocal = null;  //prEndDate converted to the Org timezone (midnight).</span>
<span class="nc" id="L759">            int tbTargetMinutes = 0;     //full target minutes for employee's current time bank</span>
<span class="nc" id="L760">            int prTargetMinutes = 0;     //pro-rated target minutes up to prEndDate</span>
<span class="nc" id="L761">            int prAdjustmentMinutes = 0; //time bank adjustments for employee's current time bank up to prEndDate</span>
<span class="nc" id="L762">            int prScheduledMinutes = 0;  //pro-rated scheduled minutes for employee during time bank period up to prEndDate</span>
<span class="nc" id="L763">            int adjustedMinutes = 0;     //will be: (prScheduledMinutes + prAdjustmentMinutes)</span>
<span class="nc" id="L764">            int balanceMinutes = 0;      //will be: (tbTargetMinutes - adjustedMinutes)</span>

            //Get current time bank data for the employee

<span class="nc" id="L768">            TimeBankSummaryData sData = null;</span>
<span class="nc" id="L769">            EmpTimeBank empTimeBank = null;</span>

<span class="nc bnc" id="L771" title="All 4 branches missed.">            if (tbaMap != null &amp;&amp; !tbaMap.isEmpty())</span>
            {
<span class="nc" id="L773">                Collection tbaCol = (Collection)tbaMap.get(empID);</span>
<span class="nc bnc" id="L774" title="All 4 branches missed.">                if (tbaCol != null &amp;&amp; !tbaCol.isEmpty())</span>
                {
<span class="nc bnc" id="L776" title="All 2 branches missed.">                    for (Iterator it=tbaCol.iterator(); it.hasNext();)</span>
                    {
<span class="nc" id="L778">                        empTimeBank = (EmpTimeBank)it.next();</span>
                        break; //There should only be 1 because our date range is only for right now
                    }
                }
            }

<span class="nc bnc" id="L784" title="All 2 branches missed.">            if (empTimeBank != null)</span>
            {
<span class="nc" id="L786">                ID timeBankID = empTimeBank.getTimeBankID();</span>
                TimeBank timeBank;
<span class="nc bnc" id="L788" title="All 2 branches missed.">                if (timeBanks.containsKey(timeBankID))</span>
                {
<span class="nc" id="L790">                    timeBank = (TimeBank)timeBanks.get(timeBankID);</span>
                }
                else
                {
<span class="nc" id="L794">                    timeBank = workRuleManager.getTimeBank(timeBankID);</span>
<span class="nc" id="L795">                    timeBanks.put(timeBankID, timeBank);</span>
                }

<span class="nc" id="L798">                boolean addOneMilliSec = false;</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">                if (timeBank != null)</span>
                {
<span class="nc" id="L801">                    tbName = timeBank.getName();</span>

<span class="nc" id="L803">                    tbStartDateLocal = timeBank.getStartDate();</span>
<span class="nc" id="L804">                    tbEndDateLocal = timeBank.getEndDate();</span>

                    //remove the last millisecond from the end date, because it includes the start of the next date.
<span class="nc" id="L807">                    tbEndDate = new Date(tbEndDateLocal.getTime()-1);</span>

                    //Convert time bank start/end dates to org timezone. TBD: Do we need to use the org's day boundary too?
<span class="nc" id="L810">                    TimeZone orgTZ = getCurrentOrgTZForEmp(context, empID);</span>
<span class="nc" id="L811">                    tbStartDate = prEndDate = covertToTZ(tbStartDateLocal, orgTZ); //tbStartDateOrgTZ</span>
<span class="nc" id="L812">                    tbEndDateOrig = covertToTZ(tbEndDateLocal, orgTZ);</span>
<span class="nc" id="L813">                    tbEndDate = covertToTZ(tbEndDate, orgTZ);</span>

<span class="nc" id="L815">                    tbTargetMinutes = timeBank.getTotalTargetMinutes();</span>

                    //We need a single empID list in order to call backend methods with different date ranges per employee
<span class="nc" id="L818">                    ArrayList singleEmpIdList = new ArrayList(1);</span>
<span class="nc" id="L819">                    singleEmpIdList.add(empID);</span>

                    //Determine the pro-rate date, which is the end of the last fully-published schedule period intersecting time bank.
<span class="nc" id="L822">                    boolean initedPrEndDate = false;</span>
                    //Date ppStartDate = null;
<span class="nc" id="L824">                    Collection pubPeriodsForEmps = scheduleAccessManager.getPublishedPeriods(singleEmpIdList, tbStartDate, tbEndDate);</span>
<span class="nc bnc" id="L825" title="All 4 branches missed.">                    if (pubPeriodsForEmps!=null &amp;&amp; !pubPeriodsForEmps.isEmpty())</span>
                    {
<span class="nc bnc" id="L827" title="All 2 branches missed.">                        for (Iterator i=pubPeriodsForEmps.iterator(); i.hasNext();)</span>
                        {
<span class="nc" id="L829">                            Collection personalPeriods = (Collection) i.next();</span>
<span class="nc bnc" id="L830" title="All 4 branches missed.">                            if (personalPeriods != null &amp;&amp; !personalPeriods.isEmpty())</span>
                            {
<span class="nc bnc" id="L832" title="All 2 branches missed.">                                for (Iterator ppi = personalPeriods.iterator(); ppi.hasNext();)</span>
                                {
<span class="nc" id="L834">                                    PublishingPeriod pp = (PublishingPeriod) ppi.next();</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">                                    if (!pp.isPartialPublish())</span>
                                    {
<span class="nc bnc" id="L837" title="All 4 branches missed.">                                        if (!initedPrEndDate || pp.getEndTime().after(prEndDate))</span>
                                        {
                                            //ppStartDate = pp.getStartTime();
<span class="nc" id="L840">                                            prEndDate = pp.getEndTime();</span>
<span class="nc" id="L841">                                            initedPrEndDate = true;</span>
                                        }
                                    }
<span class="nc" id="L844">                                }</span>
                            }
                            else {
<span class="nc" id="L847">                            	addOneMilliSec = true;</span>
                            }
<span class="nc" id="L849">                            break; //only 1 employee</span>
                        }
                    }
                    else {
<span class="nc" id="L853">                    	addOneMilliSec = true;</span>
                    }
<span class="nc bnc" id="L855" title="All 2 branches missed.">                    prEndDate = (prEndDate.before(tbEndDateOrig))? prEndDate : tbEndDateOrig;</span>

                    /*
                    //Find which campaign the user belongs to at the prEndDate, so we can get its timezone
                    CampaignManager cm = BbmManagerFactory.getCampaignManager();
                    if (ppStartDate != null &amp;&amp; prEndDate != null)
                    {
                        Collection campWorkResAssns = cm.getWorkResourceCampaignAssignments(empID, ppStartDate, prEndDate);
                        if (campWorkResAssns != null)
                        {
                            ID campaignID = null;
                            for (Iterator iter = campWorkResAssns.iterator(); iter.hasNext();)
                            {
                                CampaignWorkResource campWorkRes = (CampaignWorkResource) iter.next();
                                campaignID = campWorkRes.getCampaignID();
                            }
                            if (campaignID != null)
                            {
                                Campaign camp = cm.getCampaignByID(campaignID);
                                if (camp != null)
                                {
                                    TimeZone campTZ = camp.getTimeZone();
                                    prEndDateGMT = covertToTZ(prEndDate, campTZ, TimeZone.getTimeZone(&quot;GMT&quot;));
                                }

                            }
                        }
                    }
                    */

                    //Get scheduled events for employee.
<span class="nc" id="L886">                    prEndDateLocal = covertGmtToLocalTZ(prEndDate, orgTZ);</span>
<span class="nc" id="L887">                    HashMap workHoursMap = scheduleAccessManager.getEmployeeWorkHours(singleEmpIdList,</span>
                            tbStartDate, prEndDate, true);
<span class="nc bnc" id="L889" title="All 2 branches missed.">                    if (workHoursMap!=null)</span>
                    {
<span class="nc" id="L891">                        Set keys = workHoursMap.keySet();</span>
<span class="nc bnc" id="L892" title="All 4 branches missed.">                        if (keys!=null &amp;&amp; !keys.isEmpty())</span>
                        {
<span class="nc bnc" id="L894" title="All 2 branches missed.">                            for (Iterator it=keys.iterator();it.hasNext();)</span>
                            {
<span class="nc" id="L896">                                ID curEmpID = (ID)it.next();</span>
<span class="nc" id="L897">                                List curWorkHourPerDayList = (List)workHoursMap.get(curEmpID);</span>
<span class="nc bnc" id="L898" title="All 4 branches missed.">                                if (curWorkHourPerDayList != null &amp;&amp; !curWorkHourPerDayList.isEmpty())</span>
                                {
<span class="nc bnc" id="L900" title="All 2 branches missed.">                                    for (Iterator it2=curWorkHourPerDayList.iterator();it2.hasNext();)</span>
                                    {
<span class="nc" id="L902">                                        Integer curMinutes = (Integer)it2.next();</span>
<span class="nc" id="L903">                                        prScheduledMinutes += curMinutes.intValue();</span>
<span class="nc" id="L904">                                    }</span>
                                }
                                break; //only 1 employee
                            }
                        }
                    }

                    //get the employee's time bank adjustment minutes up to the pro-rate date
<span class="nc" id="L912">                    prAdjustmentMinutes = 0;</span>
<span class="nc" id="L913">                    Collection adjustments = empWorkRuleManager.getTimeBankAdjustments(singleEmpIdList, tbStartDateLocal, prEndDateLocal);</span>
<span class="nc bnc" id="L914" title="All 4 branches missed.">                    if (adjustments!=null &amp;&amp; !adjustments.isEmpty())</span>
                    {
<span class="nc bnc" id="L916" title="All 2 branches missed.">                        for (Iterator empIt=adjustments.iterator(); empIt.hasNext();)</span>
                        {
<span class="nc" id="L918">                            Collection curAdjustments = (Collection)empIt.next();</span>
<span class="nc bnc" id="L919" title="All 4 branches missed.">                            if (curAdjustments!=null &amp;&amp; !curAdjustments.isEmpty())</span>
                            {
<span class="nc bnc" id="L921" title="All 2 branches missed.">                                for (Iterator adjIt=curAdjustments.iterator(); adjIt.hasNext();)</span>
                                {
<span class="nc" id="L923">                                    EmpTimeBankAdjust adjustment = (EmpTimeBankAdjust)adjIt.next();</span>
<span class="nc" id="L924">                                    prAdjustmentMinutes += adjustment.getAdjustMinute();</span>
<span class="nc" id="L925">                                }</span>
                            }
                            break; //only 1 employee
                        }
                    }

                    //calculate the pro-rated target and adjustment minutes using a simple average
<span class="nc" id="L932">                    prTargetMinutes = Math.round(tbTargetMinutes *</span>
<span class="nc" id="L933">                            getProRatePercentage(tbStartDate, tbEndDateOrig, prEndDate));</span>

<span class="nc" id="L935">                    adjustedMinutes = (prScheduledMinutes + prAdjustmentMinutes);</span>
<span class="nc" id="L936">                    balanceMinutes = (adjustedMinutes - prTargetMinutes);</span>
                }
                // the TimeBankSummaryPC subtracts one millisec from upToDate (prEndDate) to get prev day
                // but if no publishing period intersects the TB period then the upToDate should be the orig day
<span class="nc bnc" id="L940" title="All 2 branches missed.">                if (addOneMilliSec) {</span>
<span class="nc" id="L941">					prEndDate = new Date(prEndDate.getTime() + 1);</span>
				}
<span class="nc" id="L943">                sData = new TimeBankSummaryData(tbName, tbStartDate, tbEndDate, prEndDate,</span>
                        tbTargetMinutes, prTargetMinutes, prScheduledMinutes, prAdjustmentMinutes, balanceMinutes);

<span class="nc" id="L946">                theResult.put(empID, sData);</span>
            }
<span class="nc" id="L948">        }</span>
<span class="nc" id="L949">        return theResult;</span>
    }

    /**
     * Get the TimeZone of the org that the employee is currently assigned to.
     * @param empID The employee whose time zone you want to get.
     * @return the TimeZone of the org that the employee is currently assigned to.
     */
    private static TimeZone getCurrentOrgTZForEmp(RequestContext context, ID empID)
    {
<span class="nc" id="L959">        TimeZone tz = TimeZone.getTimeZone(&quot;GMT&quot;);</span>
        try
        {
<span class="nc" id="L962">            Date now = new Date();</span>
<span class="nc" id="L963">            WorkResourceManager workResourceManager = WorkResourceModelHandler.getWorkResourceManager(context);</span>
<span class="nc" id="L964">            Collection workResourceAssignments = workResourceManager.getWorkResourceAssignments(empID, now, now, false);</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">            if (workResourceAssignments != null)</span>
            {
<span class="nc bnc" id="L967" title="All 2 branches missed.">                for (Iterator it=workResourceAssignments.iterator(); it.hasNext();)</span>
                {
<span class="nc" id="L969">                    WorkResourceAssignment workResourceAssignment = (WorkResourceAssignment)it.next();</span>
<span class="nc" id="L970">                    ID orgID = workResourceAssignment.getOrganizationID();</span>
<span class="nc" id="L971">                    Organization org = workResourceManager.getOrganizationByID(orgID);</span>
<span class="nc" id="L972">                    tz = org.getTimeZone();</span>
<span class="nc" id="L973">                    break; //There should only be one workResourceAssignment, since we're only looking at the current time.</span>
                }
            }
        }
<span class="nc" id="L977">        catch (Exception e)</span>
        {
<span class="nc" id="L979">        }</span>
<span class="nc" id="L980">        return tz;</span>
    }

    /**
     * Given a &quot;local&quot; date (i.e., time is irrelevant), return a new date for the date portion in the given time zone.
     * @param startDate - the &quot;local&quot; date to be converted. We ignore its time zone and the time portion.
     * @param tz - the TimeZone to convert the date to.
     * @return a new date for the date portion in the given time zone.
     */
    private static Date covertToTZ(Date localDate, TimeZone tz)
    {
<span class="nc" id="L991">        TimeZone GMT = TimeZone.getTimeZone(&quot;GMT&quot;);</span>
<span class="nc" id="L992">        Calendar cal1 = Calendar.getInstance(GMT);</span>
<span class="nc" id="L993">        cal1.setTime(localDate);</span>

<span class="nc" id="L995">        Calendar cal2 = Calendar.getInstance(tz);</span>

<span class="nc" id="L997">        cal2.set(Calendar.DATE, cal1.get(Calendar.DATE));</span>
<span class="nc" id="L998">        cal2.set(Calendar.MONTH, cal1.get(Calendar.MONTH));</span>
<span class="nc" id="L999">        cal2.set(Calendar.YEAR, cal1.get(Calendar.YEAR));</span>
<span class="nc" id="L1000">        cal2.set(Calendar.HOUR_OF_DAY, cal1.get(Calendar.HOUR_OF_DAY));</span>
<span class="nc" id="L1001">        cal2.set(Calendar.MINUTE, cal1.get(Calendar.MINUTE));</span>
<span class="nc" id="L1002">        cal2.set(Calendar.SECOND, cal1.get(Calendar.SECOND));</span>
<span class="nc" id="L1003">        cal2.set(Calendar.MILLISECOND, cal1.get(Calendar.MILLISECOND));</span>

<span class="nc" id="L1005">        return cal2.getTime();</span>
    }

    /**
     * Given a GMT date, return a new local date for it (midnight) in the given time zone.
     * @param startDate - the GMT date to be converted.
     * @param tz - the TimeZone to convert the date to.
     * @return a new local date for the date portion in the given local time zone, set to midnight..
     */
    private static Date covertGmtToLocalTZ(Date gmtDate, TimeZone localTZ)
    {
<span class="nc" id="L1016">        Calendar cal2 = Calendar.getInstance(localTZ);</span>
<span class="nc" id="L1017">        cal2.setTime(gmtDate);</span>

<span class="nc" id="L1019">        TimeZone GMT = TimeZone.getTimeZone(&quot;GMT&quot;);</span>
<span class="nc" id="L1020">        Calendar cal1 = Calendar.getInstance(GMT);</span>

<span class="nc" id="L1022">        cal1.set(Calendar.DATE, cal2.get(Calendar.DATE));</span>
<span class="nc" id="L1023">        cal1.set(Calendar.MONTH, cal2.get(Calendar.MONTH));</span>
<span class="nc" id="L1024">        cal1.set(Calendar.YEAR, cal2.get(Calendar.YEAR));</span>
<span class="nc" id="L1025">        cal1.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L1026">        cal1.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L1027">        cal1.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L1028">        cal1.set(Calendar.MILLISECOND, 0);</span>

<span class="nc" id="L1030">        return cal1.getTime();</span>
    }

    /**
     * Given a startDate, endDate and pro-rate date which falls in the range,
     * determine the percentage of days in the range which fall on or before
     * the pro-rate date.
     * @param startDate - The beginning of a date range to be pro-rated
     * @param endDate - The end of a date range to be pro-rated
     * @param prDate - the pro-rate date, which must fall in the range (startDate,endDate)
     * @return - the percentage of days in the range which fall on or before the pro-rate date
     */
    public static float getProRatePercentage(Date startDate, Date endDate, Date prDate)
    {
<span class="nc" id="L1044">        float percentage = 0.0f;</span>

<span class="nc bnc" id="L1046" title="All 6 branches missed.">        if (startDate!=null &amp;&amp; endDate!=null &amp;&amp; prDate!=null &amp;&amp;</span>
<span class="nc bnc" id="L1047" title="All 6 branches missed.">            !startDate.after(endDate) &amp;&amp; !prDate.before(startDate) &amp;&amp; !prDate.after(endDate))</span>
        {
<span class="nc bnc" id="L1049" title="All 2 branches missed.">            if (startDate.equals(endDate))</span>
            {
<span class="nc" id="L1051">                percentage = 1.0f; //100%</span>
            }
            else
            {
<span class="nc" id="L1055">                long fullRangeDuration = endDate.getTime() - startDate.getTime();</span>
<span class="nc" id="L1056">                long subRangeDuration = prDate.getTime() - startDate.getTime();</span>
<span class="nc" id="L1057">                percentage = ((float)subRangeDuration) / ((float)fullRangeDuration);</span>
            }
        }
<span class="nc" id="L1060">        return percentage;</span>
    }

	/**
	 * Calculate the accrued Time-off for an employee of given activity at given date
	 * @return number of hours
	 * @exception BbmFinderException
	 */
	public static TOAccrual calculateAccruedTO(ID empId, ID activityID, Date asOfDate)
			throws RmException, BbmCreateException, RemoteException {
<span class="nc" id="L1070">		RmManagerFactory rmManagerFactory = RmManagerFactory.getInstance();</span>
<span class="nc" id="L1071">		TORequestManager toRequestManager = rmManagerFactory.getTimeOffRequestManager();</span>
<span class="nc" id="L1072">		TOAccrual accrual = toRequestManager.calculateAccruedTO(empId, activityID, null, asOfDate);</span>
<span class="nc" id="L1073">		return accrual;</span>
	}

    /**
     * Check whether a particular license is installed in the system.
     * @param licenseKey The name license key to check.
     * @return true if the specified license is installed in the system, false otherwise.
     */
     public static boolean checkLicense(String licenseKey)
    {
<span class="nc" id="L1083">        boolean installed = false;</span>
        try
        {
<span class="nc" id="L1086">            installed = CoreManagerFactory.getLicenseManager().isLicensed(licenseKey);</span>
        }
<span class="nc" id="L1088">        catch (Exception ex)</span>
        {
<span class="nc" id="L1090">        }</span>
<span class="nc" id="L1091">        return installed;</span>
    }

    	/**
	 * Get the override for the &quot;Absent&quot; string, which is used in the Schedule view pages and My Schedule Summary component.
	 * If an override exists, then this is also used as an indicator to replace Total and Starting Balance columns with Balance
	 * and Date Last Updated in the Time Off Summary component.
	 * @return The &quot;Absent&quot; override string if one exists in the BPCONFIG table, or null if none.
	 */
	public static String getAbsentStringOverride()
	{
		try
		{
<span class="nc" id="L1104">			return BbmManagerFactory.getDBConfigManager().getValue(ConfigKey.RM_ABSENT_STRING_OVERRIDE);</span>
		}
<span class="nc" id="L1106">		catch(Exception ex)</span>
		{
			//ignoring any exception caught.
		}
<span class="nc" id="L1110">		return null;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>