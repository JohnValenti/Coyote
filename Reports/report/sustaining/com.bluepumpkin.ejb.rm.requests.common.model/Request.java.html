<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Request.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.common.model</a> &gt; <span class="el_source">Request.java</span></div><h1>Request.java</h1><pre class="source lang-java linenums">/*
 * Request.java
 *
 * Copyright (c) 2002, Blue Pumpkin Software, Inc.
 * All rights reserved.
 */
package com.bluepumpkin.ejb.rm.requests.common.model;

import java.util.*;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectRoot;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;


/**
 * A base class for Requests. Subtypes of Request are derived from Request.
 */
public class Request extends ValueObjectRoot {
	//xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
	// Any changes to the constant values here must also be done in RequestStatusChangeRuleChecker in BBM.
	//xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
	// Types of requests
	public static final String REQUESTTYPE_TIMEOFF = &quot;time-off&quot;;
	public static final String REQUESTTYPE_FLEXTIME = &quot;flex-time&quot;;
	public static final String REQUESTTYPE_SHIFTSWAP = &quot;shift-swap&quot;;
	public static final String REQUESTTYPE_SHIFTBID = &quot;shift-bid&quot;;
	public static final String REQUESTTYPE_ALL = &quot;all&quot;;
	public static final String REQUESTTYPE_TIMEOFF_WITHDRAW = &quot;time-off-withdraw&quot;;
	public static final String REQUESTTYPE_CUSTSHIFT = &quot;cust-shift&quot;;
	public static final String REQUESTTYPE_SHIFTSWAP_WITHDRAW = &quot;shift-swap-withdraw&quot;;
	

	// Request sorting options
	public static final int SORT_MINVALUE = 1;
	public static final int SORT_LAST_NAME_FIRST = 1;
	public static final int SORT_FIRST_NAME_FIRST = 2;
	public static final int SORT_PLAST_NAME_FIRST = 3;
	public static final int SORT_PFIRST_NAME_FIRST = 4;
	public static final int SORT_STATUS = 5;
	public static final int SORT_TYPE = 6;
	public static final int SORT_CREATED = 7;   //Original request creation date
	public static final int SORT_MODIFIED = 8;
	public static final int SORT_TO_ACTIVITY = 9;   // Time off only
	public static final int SORT_TO_DEBIT_TYPE = 10;  // Time off only
	public static final int SORT_TO_FIRST_START = 11;  // Time off only, first choice start date
	public static final int SORT_TO_FIRST_END = 12;  // Time off only, first choice end date
	public static final int SORT_SWAP_TYPE = 13;  // Shift swap only (one-way or two-way)
	public static final int SORT_SWAP_FIRST_START = 14;  // Shift swap only, first item start date
	public static final int SORT_SWAP_SHIFT_TYPE = 15;  // Shift swap only, (shift or time-off)
	public static final int SORT_SHIFTBID_PREFERENCE = 16;  // sort by preference for shift bid requests
	public static final int SORT_SHIFTBID_ISBONUSUSED = 17;  // sort by usePoints for shift bid requests
	public static final int SORT_SHIFTBID_SENIORITY = 18;  // sort requests by employee(shiftBidder) seniority.
	public static final int SORT_EMP_RANK = 19;  // sort requests by employee(shiftBidder /TO) Rank.
	public static final int SORT_SHIFTBID_POINTS = 20;  // sort requests by employee(shiftBidder) Accumulated Bonus.
	public static final int SORT_SHIFTBID_BIDDERBONUS = 21;  // sort requests by shiftBidder's 'bonus this auction'.
	public static final int SORT_TO_SENIORITY = 22;  // employee seniority for TO Requests.
	public static final int SORT_SHIFTBID_SCORE = 22; // sort by score for shift bid requests.
	public static final int SORT_TO_WAITLIST_PRIORITY_ORDER = 23;    //	Prority order of the request in the waitlist.
	public static final int SORT_ORGANIZATION_NAME = 24;        //	Name of the organization
	public static final int SORT_TO_WAITLIST_PENDING_DAYS = 25;       // 	Number of days elapsed on Waitlist
	public static final int SORT_TO_WAITLIST_PENDING_DATE_TIME = 26; // 	Exact Time elapsed on waitlist
	public static final int SORT_EMPLOYEE_SCORE = 27; // sort requests by bidder's score.
	public static final int SORT_TO_WAITLIST_TOCHOICE_REQ_LENGTH = 28;    //actual length of request in msecs of the first TOCHOICE in Request.
	public static final int SORT_TO_WAITLIST_TOCHOICE_ALLOCATION_HOURS = 29; // Allocation hours used by the firstTOChoice
	public static final int SORT_TO_WAITLIST_TOCHOICE_START = 30;
	public static final int SORT_TO_POOL_NAME = 31;  // the time off pool of the employee who made the time off request

	public final static int SORT_CS_CAMPAIGN = 32;	//	Name of Campaign &amp; SP range
	public final static int SORT_CS_SHIFTID = 33;	//Name of Shift
	public final static int SORT_CS_ACTIVITYID = 34;
	public final static int SORT_CS_STARTTIME = 35;
	public final static int SORT_CS_ENDTIME = 36;
	public final static int SORT_CS_ISOT = 37;
	public final static int SORT_CS_EXTBEFOREID = 38;	//Name of Extn
	public final static int SORT_CS_EXTBEFOREACTIVITYID = 39;
	public final static int SORT_CS_EXTBEFOREISOT = 40;
	public final static int SORT_CS_EXTAFTERID = 41; //	Name of Extn
	public final static int SORT_CS_EXTAFTERACTIVITYID = 42;
	public final static int SORT_CS_EXTAFTERISOT = 43;
	public final static int SORT_CS_SUBTYPE = 44;

	public final static int SORT_CS_EXTINGAPSID = 45;	//Name of Extn
	public final static int SORT_CS_EXTINGAPSACTIVITYID = 46;

	public static final int SORT_MAXVALUE = 46;

<span class="nc" id="L89">	private static HashMap waitlistSortOrderColumns = new HashMap();</span>

	//This stores the Columns available for the Waitlist Priority Order Columns used for Dynamically getting values for In Memory Sort
	static {
<span class="nc" id="L93">		waitlistSortOrderColumns.put(new Integer(SORT_TO_SENIORITY), &quot;getEmployeeStartDate&quot;);</span>
<span class="nc" id="L94">		waitlistSortOrderColumns.put(new Integer(SORT_EMP_RANK), &quot;getEmployeeRank&quot;);</span>
<span class="nc" id="L95">		waitlistSortOrderColumns.put(new Integer(SORT_TO_WAITLIST_TOCHOICE_START), &quot;getWaitlistTOChoiceStartDate&quot;);</span>
<span class="nc" id="L96">		waitlistSortOrderColumns.put(new Integer(SORT_TO_WAITLIST_PENDING_DAYS), &quot;getNumberOfDaysOnWaitlist&quot;);</span>
<span class="nc" id="L97">		waitlistSortOrderColumns.put(new Integer(SORT_TO_WAITLIST_PENDING_DATE_TIME), &quot;getTimeOnWaitlist&quot;);</span>
<span class="nc" id="L98">		waitlistSortOrderColumns.put(new Integer(SORT_TO_WAITLIST_TOCHOICE_REQ_LENGTH), &quot;getWaitlistTOChoiceActualDurationInMilliSecs&quot;);</span>
<span class="nc" id="L99">		waitlistSortOrderColumns.put(new Integer(SORT_TO_WAITLIST_TOCHOICE_ALLOCATION_HOURS), &quot;getWaitlistTOChoiceUsedAllocationHours&quot;);</span>
<span class="nc" id="L100">		waitlistSortOrderColumns.put(new Integer(SORT_CREATED), &quot;getSubmittedOn&quot;);</span>
<span class="nc" id="L101">		waitlistSortOrderColumns.put(new Integer(SORT_ORGANIZATION_NAME), &quot;getOrgName&quot;);</span>
	}

	public static String getMethodForSortOrderColumn(int sortColumn) {
<span class="nc" id="L105">		return (String) waitlistSortOrderColumns.get(new Integer(sortColumn));</span>
	}

	// detail Levels
	public static final long DL_BASIC = RequestDetailLevel.DL_BASIC;
	public static final long DL_INCLUDE_EXPIRED = RequestDetailLevel.DL_INCLUDE_EXPIRED;
	public static final long DL_AUDIT_TRAIL = RequestDetailLevel.DL_AUDIT_TRAIL;
	public static final long DL_EMPLOYEE = RequestDetailLevel.DL_EMPLOYEE_REQUEST_CHILD;

	// non-persistent fields
<span class="nc" id="L115">	private static final FieldInfo m_fieldInfo = new RequestFieldInfo();</span>

	private static final long serialVersionUID = -4034475424756865122L;

<span class="nc" id="L119">	private transient List&lt;RequestAuditTrail&gt;  m_cachedAuditTrail = null;</span>
	private transient Employee m_cachedEmployee;

	// default detailLevel.
<span class="nc" id="L123">	private long m_detailLevel = DL_BASIC;</span>

	private transient RequestOptMethods m_reqOptMethods;

	public boolean isAuditTrailSet() {
<span class="nc" id="L128">		return isAuditTrailSet;</span>
	}

	public void setAuditTrailSet(boolean auditTrailSet) {
<span class="nc" id="L132">		isAuditTrailSet = auditTrailSet;</span>
<span class="nc" id="L133">	}</span>

<span class="nc" id="L135">	private transient boolean isAuditTrailSet = false;</span>

	//todo: A Request should never be created without a requestType as a request
	// is always either a TORequest or SSRequest. But DAOBase.getValueObject()
	// instantiates a Request without a request type and hence this constructor
	// is necessary.
<span class="nc" id="L141">	public Request() {</span>
<span class="nc" id="L142">	}</span>

<span class="nc" id="L144">	public Request(String requestType, long detailLevel) {</span>
<span class="nc" id="L145">		this.setFieldValue(RequestFieldInfo.REQUEST_S_REQUESTTYPE, requestType);</span>
<span class="nc" id="L146">		m_detailLevel = detailLevel;</span>
<span class="nc" id="L147">	}</span>

	@Override
<span class="nc" id="L150">	protected FieldInfo getFieldInfo() { return m_fieldInfo; }</span>

	/**
	 * defines optional methods which return optional data (data which may or may not be
	 * available based on the detail level specified).
	 *
	 * @author rrajendran
	 *         &lt;p/&gt;
	 *         To change the template for this generated type comment go to
	 *         Window&amp;gt;Preferences&amp;gt;Java&amp;gt;Code Generation&amp;gt;Code and Comments
	 */
<span class="nc bnc" id="L161" title="All 2 branches missed.">	public class RequestOptMethods {</span>
		public Employee getEmployee() {
<span class="nc bnc" id="L163" title="All 4 branches missed.">			assert (m_detailLevel &amp; DL_EMPLOYEE) != 0:&quot;(m_detailLevel &amp; DL_EMPLOYEE) != 0): &quot; + m_detailLevel;</span>

<span class="nc bnc" id="L165" title="All 2 branches missed.">			if (m_cachedEmployee != null) return m_cachedEmployee;</span>

<span class="nc" id="L167">			Collection&lt;Employee&gt; employees = getChildObjects(RequestFieldInfo.CHILD_TYPE_EMPLOYEE);</span>
<span class="nc bnc" id="L168" title="All 4 branches missed.">			assert employees.size() == 1:&quot;employees.size() == 1: &quot; + employees.size();</span>
<span class="nc" id="L169">			m_cachedEmployee = employees.iterator().next();</span>
<span class="nc" id="L170">			m_cachedEmployee.setDetailLevel(Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);//</span>
<span class="nc" id="L171">			return m_cachedEmployee;</span>
		}
	}

	public RequestOptMethods getOptMethods() {
<span class="nc bnc" id="L176" title="All 2 branches missed.">		return (m_reqOptMethods = (m_reqOptMethods == null) ? new RequestOptMethods() : m_reqOptMethods);</span>
	}

	// getters
	public ID getCreatorID() {
<span class="nc" id="L181">		return getFieldValueID(RequestFieldInfo.REQUEST_I_CREATORID);</span>
	}

	public String getRequestType() {
<span class="nc" id="L185">		return getFormattedFieldValue(RequestFieldInfo.REQUEST_S_REQUESTTYPE);</span>
	}

	public String getRequestStatus() {
<span class="nc" id="L189">		return getFormattedFieldValue(RequestFieldInfo.REQUEST_S_REQUESTSTATUS);</span>
	}

	public Date getSubmittedOn() {
<span class="nc" id="L193">		return getFieldValueDate(RequestFieldInfo.REQUEST_D_SUBMITTEDON);</span>
	}

	/**
	 * Get the last modified date
	 */
	public Date getLastModifiedAt() {
<span class="nc" id="L200">		return getFieldValueDate(RequestFieldInfo.REQUEST_D_LASTMODIFIEDAT);</span>
	}

	/**
	 * Get the expiration date
	 */
	public Date getExpirationDate() {
<span class="nc" id="L207">		return getFieldValueDate(RequestFieldInfo.REQUEST_D_EXPIRATIONDATE);</span>
	}

	/**
	 * Get the employee ID
	 */
	public ID getEmployeeID() {
<span class="nc" id="L214">		return getFieldValueID(RequestFieldInfo.REQUEST_I_EMPLOYEEID);</span>
	}

	public Collection&lt;RequestAuditTrail&gt; getAuditTrail() {
<span class="nc" id="L218">		Collection&lt;RequestAuditTrail&gt; trails = getChildObjects(RequestFieldInfo.AUDIT_TRAIL_CHILD_TYPE);</span>

		// populate cache if necessary.
<span class="nc bnc" id="L221" title="All 2 branches missed.">		if (m_cachedAuditTrail == null) {</span>
			// add retrieved list to cache
<span class="nc" id="L223">			m_cachedAuditTrail = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L224">			m_cachedAuditTrail.addAll(trails);</span>

			// sort by updated time.  Sorting done here, instead of the db layer, as ValueObjectNode
			// cannot store an ordered list of children (uses a map to hold child objects).
<span class="nc" id="L228">			Collections.sort(m_cachedAuditTrail);</span>
		}

<span class="nc" id="L231">		return m_cachedAuditTrail;</span>
	}

	public long getDetailLevel() {
<span class="nc" id="L235">		return m_detailLevel;</span>
	}

	// setters
	public void setCreatorID(ID id) {
<span class="nc" id="L240">		setFieldValue(RequestFieldInfo.REQUEST_I_CREATORID, id);</span>
<span class="nc" id="L241">	}</span>

	public void setRequestStatus(String status) {
<span class="nc" id="L244">		setFieldValue(RequestFieldInfo.REQUEST_S_REQUESTSTATUS, status);</span>
<span class="nc" id="L245">	}</span>

	public void setSubmittedOn(Date submittedOn) {
<span class="nc" id="L248">		setFieldValue(RequestFieldInfo.REQUEST_D_SUBMITTEDON, submittedOn);</span>
<span class="nc" id="L249">	}</span>

	/**
	 * Set the last modified date
	 */
	public void setLastModifiedAt(Date lastModifiedAt) {
<span class="nc" id="L255">		setFieldValue(RequestFieldInfo.REQUEST_D_LASTMODIFIEDAT, lastModifiedAt);</span>
<span class="nc" id="L256">	}</span>

	/**
	 * Set the expiration date
	 */
	public void setExpirationDate(Date expirationDate) {
<span class="nc" id="L262">		setFieldValue(RequestFieldInfo.REQUEST_D_EXPIRATIONDATE, expirationDate);</span>
<span class="nc" id="L263">	}</span>

	/**
	 * Set the employee ID
	 */
	public void setEmployeeID(ID id) {
<span class="nc" id="L269">		setFieldValue(RequestFieldInfo.REQUEST_I_EMPLOYEEID, id);</span>
<span class="nc" id="L270">	}</span>

	public void setAuditTrail(RequestAuditTrail pAuditTrail) {
<span class="nc" id="L273">		createChildObject(RequestFieldInfo.AUDIT_TRAIL_CHILD_TYPE, pAuditTrail);</span>

		// Instead of invalidating the cache, if the new audit trial is just appended,
		// the cache will become stale if getAuditTrail() is called before this method.
<span class="nc bnc" id="L277" title="All 2 branches missed.">		if (m_cachedAuditTrail != null) m_cachedAuditTrail.clear();</span>
<span class="nc" id="L278">		m_cachedAuditTrail = null;</span>
<span class="nc" id="L279">	}</span>

	// todo: makes sense to set 1 audit trail instead of a list. check with david.
	public void setAuditTrailList(Collection pAuditTrails) {
<span class="nc bnc" id="L283" title="All 2 branches missed.">		for (Iterator itr = pAuditTrails.iterator(); itr.hasNext();) {</span>
<span class="nc" id="L284">			createChildObject(RequestFieldInfo.AUDIT_TRAIL_CHILD_TYPE, (RequestAuditTrail) itr.next());</span>
		}

		// If we choose to append the nwe audit trail, instead of invalidating the cache,
		// the cache will become stale, if getAuditTrail() is called before this method.
<span class="nc bnc" id="L289" title="All 2 branches missed.">		if (m_cachedAuditTrail != null) m_cachedAuditTrail.clear();</span>
<span class="nc" id="L290">		m_cachedAuditTrail = null;</span>
<span class="nc" id="L291">	}</span>

	/**
	 * Inspect the audit trail records and return the latest last modified date.
	 * If there are no audit trail records stored in this request object, then
	 * return null.
	 *
	 * @return the last modified date for this request as determined by
	 *         inspecting the audit trail records, or null if no audit trail records
	 *         are available.
	 */
	//todo: use an array, instead of a collection, for direct access to last element.
	public Date getLastAuditTrailModifiedAt() {
		// Loop through audit trails to determine the last date.
<span class="nc" id="L305">		Date result = null;</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">		for (Iterator it = this.getAuditTrail().iterator(); it.hasNext();) {</span>
<span class="nc" id="L307">			RequestAuditTrail at = (RequestAuditTrail) it.next();</span>
<span class="nc bnc" id="L308" title="All 4 branches missed.">			if (result == null || at.getModifiedAt().after(result)) {</span>
<span class="nc" id="L309">				result = at.getModifiedAt();</span>
			}
<span class="nc" id="L311">		}</span>
<span class="nc" id="L312">		return result;</span>
	}

	public boolean hasExpired() {
<span class="nc bnc" id="L316" title="All 2 branches missed.">		if (getExpirationDate().getTime() &lt; System.currentTimeMillis())</span>
<span class="nc" id="L317">			return true;</span>

<span class="nc" id="L319">		return false;</span>
	}

	public boolean isApproved() {
<span class="nc bnc" id="L323" title="All 4 branches missed.">		return (getRequestStatus() != null &amp;&amp; getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED));</span>
	}

	public boolean isTentative() {
<span class="nc bnc" id="L327" title="All 4 branches missed.">		return (getRequestStatus() != null &amp;&amp; getRequestStatus().equals(RequestAuditTrail.STATUS_TENTATIVE));</span>
	}

	public boolean isInvalid() {
<span class="nc bnc" id="L331" title="All 4 branches missed.">		return (getRequestStatus() != null &amp;&amp; getRequestStatus().equals(RequestAuditTrail.STATUS_INVALID));</span>
	}

	public boolean isPending() {
<span class="nc bnc" id="L335" title="All 4 branches missed.">		return (getRequestStatus() != null &amp;&amp; getRequestStatus().equals(RequestAuditTrail.STATUS_PENDING));</span>
	}

	public boolean isWaitlisted() {
<span class="nc bnc" id="L339" title="All 4 branches missed.">		return (getRequestStatus() != null &amp;&amp; getRequestStatus().equals(RequestAuditTrail.STATUS_WAITLIST));</span>
	}

	public boolean isNegotiation() {
<span class="nc bnc" id="L343" title="All 4 branches missed.">		return (getRequestStatus() != null &amp;&amp; getRequestStatus().equals(RequestAuditTrail.STATUS_NEGOTIATION));</span>
	}

	public boolean isEscalated() {
<span class="nc bnc" id="L347" title="All 4 branches missed.">		return (getRequestStatus() != null &amp;&amp; getRequestStatus().equals(RequestAuditTrail.STATUS_ESCALATED));</span>
	}

	public boolean isWithdrawn() {
<span class="nc bnc" id="L351" title="All 4 branches missed.">		return (getRequestStatus() != null &amp;&amp; getRequestStatus().equals(RequestAuditTrail.STATUS_WITHDRAWN));</span>
	}

	public boolean isDenied() {
<span class="nc bnc" id="L355" title="All 4 branches missed.">		return (getRequestStatus() != null &amp;&amp; getRequestStatus().equals(RequestAuditTrail.STATUS_DENIED));</span>
	}

	public boolean isTimeOffRequest() {
<span class="nc bnc" id="L359" title="All 4 branches missed.">		return (getRequestType() != null) &amp;&amp; getRequestType().equals(REQUESTTYPE_TIMEOFF);</span>
	}

	public boolean isShiftSwapRequest() {
<span class="nc bnc" id="L363" title="All 4 branches missed.">		return (getRequestType() != null) &amp;&amp; getRequestType().equals(REQUESTTYPE_SHIFTSWAP);</span>
	}

	public boolean isShiftBidRequest() {
<span class="nc bnc" id="L367" title="All 4 branches missed.">		return (getRequestType() != null) &amp;&amp; getRequestType().equals(REQUESTTYPE_SHIFTBID);</span>
	}

	public boolean isCustShiftRequest() {
<span class="nc bnc" id="L371" title="All 4 branches missed.">		return (getRequestType() != null) &amp;&amp; getRequestType().equals(REQUESTTYPE_CUSTSHIFT);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>