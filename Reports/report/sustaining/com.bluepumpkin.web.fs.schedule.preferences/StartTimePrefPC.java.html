<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StartTimePrefPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.schedule.preferences</a> &gt; <span class="el_source">StartTimePrefPC.java</span></div><h1>StartTimePrefPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.schedule.preferences;

import com.bluepumpkin.ejb.bbm.schedulepref.model.SimpleSchedulePreference;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.witness.web.uif.jsp.HtmlTag;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagecomponent.picker.time.TimePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.TimeRangePickerPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.TimeZoneHelper;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;

import javax.servlet.http.HttpServletRequest;
import java.util.*;

/**
 * Title:       StartTimePrefPC
 * Description: Start Time Preference PC
 * Copyright:   Copyright (c) 2004
 * Company:     Blue Pumpkin Software, Inc
 *
 * @author David Su, dsu
 * @version 1.0
 * Created on Aug 18, 2004, 10:17:49 AM
 */
public class StartTimePrefPC extends CollapsibleContainerPC {
	private static final String EARLY_OR_LATE_FN = &quot;earlyOrLate&quot;;

	private ResourceBundle m_bundle;
	
	private TimeRangePickerPC m_timeRangePickerPC;

	private short m_earlyOrLate;
<span class="nc" id="L41">	private int[] m_startPrefs = new int[42]; // 7*3*2 day,pref,from-to (for extraction)</span>

	public StartTimePrefPC(RequestContext context) {
<span class="nc" id="L44">		super(context);</span>

<span class="nc" id="L46">		setName(&quot;startTimeContainer&quot;);</span>
<span class="nc" id="L47">		m_bundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L49">		m_timeRangePickerPC = new TimeRangePickerPC(context, &quot;time&quot;);</span>

<span class="nc" id="L51">		m_timeRangePickerPC.getStartTimePickerPC().setIsInputValueOptional(true);</span>
<span class="nc" id="L52">		m_timeRangePickerPC.getEndTimePickerPC().setIsInputValueOptional(true);</span>

<span class="nc" id="L54">		m_timeRangePickerPC.setTimeInterval(15);</span>
<span class="nc" id="L55">		addChildComponent(m_timeRangePickerPC);</span>
<span class="nc" id="L56">	}</span>

	/**
	 * populate start time preferences container
	 */
	protected void init(HashMap theData) {
<span class="nc" id="L62">		setStyleClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="nc" id="L63">		setTitle(i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS));</span>
<span class="nc" id="L64">		setTemplate(&quot;&lt;table cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot; width=\&quot;100%\&quot;&gt;&quot;</span>
			+ &quot;&lt;tr&gt;&lt;td class=\&quot;schedPrefText\&quot;&gt;&lt;div id=\&quot;startTimePrefHeading\&quot;&gt;{0}&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&quot;
			+ &quot;&lt;tr&gt;&lt;td class=\&quot;schedPrefText\&quot;&gt;{1}&lt;/td&gt;&lt;/tr&gt;&quot;
			+ &quot;&lt;tr&gt;&lt;td class=\&quot;schedPrefText\&quot;&gt;{2}&lt;/td&gt;&lt;/tr&gt;&quot;
			+ &quot;&lt;tr&gt;&lt;td class=\&quot;schedPrefItalic\&quot;&gt;&lt;div id=\&quot;timeZoneTextItalic\&quot;&gt;{3}&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);

		// Descriptive message about the start time preferences
<span class="nc" id="L71">		addComponent(i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_DESC));</span>

		// Start Time Prefs table
<span class="nc" id="L74">		SimpleSchedulePreference simpleSchedPref =</span>
<span class="nc" id="L75">			(SimpleSchedulePreference) theData.get(SchedulePreferenceMH.SIMPLE_PREFS_KEY);</span>
<span class="nc" id="L76">		addComponent(makeStartPreferencesTable(simpleSchedPref));</span>

		// Radio NoPrefs/Early/Late goes here
<span class="nc bnc" id="L79" title="All 2 branches missed.">		short preferredStart = (simpleSchedPref != null) ? simpleSchedPref.getPreferredStart() : 0;</span>
<span class="nc" id="L80">		addComponent(makeEarlyOrLateRadio(preferredStart));</span>

		// time zone message
<span class="nc" id="L83">		TimeZone orgTz = (TimeZone) theData.get(SchedulePreferenceMH.ORG_TZ_KEY);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">		String orgTzName = (orgTz != null)</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">				? isAccessibilityComplianceMode() ? m_localizer.formatTimeZone(orgTz.getID())</span>
<span class="nc" id="L86">						: TimeZoneHelper.getDisplayTimeZone(orgTz.getID(), m_localizer)</span>
<span class="nc" id="L87">				: i18n(m_bundle, FsWebBundleKey.SP_TZ_NOT_DEFINED);</span>
<span class="nc" id="L88">		addComponent(i18n(m_bundle, FsWebBundleKey.SP_TZ_SHOWN) + &quot; &quot; + orgTzName);</span>
<span class="nc" id="L89">	}</span>

	/**
	 * make html table with start preferences
	 */
	private String makeStartPreferencesTable(SimpleSchedulePreference simpleSchedPref) {
<span class="nc" id="L95">		MultiColListPC listPC = new MultiColListPC(m_context) {</span>
			@Override
			public HtmlTag getWrapper() {
<span class="nc" id="L98">				HtmlTag wrapper = super.getWrapper();</span>
<span class="nc bnc" id="L99" title="All 4 branches missed.">				if (isAccessibilityComplianceMode() &amp;&amp; this.isSubregion()) {</span>
<span class="nc" id="L100">					String wrapperClasses = Optional.ofNullable(wrapper.getAttribute(&quot;class&quot;)).orElse(&quot;&quot;);</span>
<span class="nc" id="L101">					wrapper.setAttribute(&quot;class&quot;, PageComponent.SUBREGION_CLASS_VALUE + &quot; &quot; + wrapperClasses);</span>
<span class="nc" id="L102">					wrapper.setAttribute(ATTR_TABINDEX, &quot;0&quot;);</span>
<span class="nc" id="L103">					wrapper.setAttribute(ATTR_ROLE, &quot;table&quot;);</span>
<span class="nc" id="L104">					wrapper.setAttribute(ATTR_ARIA_LABEL, i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS));</span>
<span class="nc" id="L105">					wrapper.setAttribute(ATTR_ARIA_DESCRIBEDBY, &quot;startTimePrefHeading timeZoneTextItalic&quot;);</span>
				}
<span class="nc" id="L107">				return wrapper;</span>
			}
		};
<span class="nc" id="L110">		listPC.setTableClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="nc" id="L111">		listPC.setUseWrapper(true);</span>
<span class="nc" id="L112">		listPC.setEnabled(false);</span>
<span class="nc" id="L113">		listPC.setIsSubregion(true);</span>
<span class="nc" id="L114">		listPC.setWrapperRegion(false);</span>

<span class="nc" id="L116">		TableHeaderPC header = listPC.getHeader();</span>
<span class="nc" id="L117">		header.addColumnHeaderData(&quot;day&quot;, i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_DAY));</span>
<span class="nc" id="L118">		header.addColumnHeaderData(&quot;first&quot;, i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_FIRST));</span>
<span class="nc" id="L119">		header.addColumnHeaderData(&quot;second&quot;, i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_SECOND));</span>
<span class="nc" id="L120">		header.addColumnHeaderData(&quot;third&quot;, i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_THIRD));</span>

<span class="nc" id="L122">		listPC.setListModel(makeListModel(simpleSchedPref));</span>

<span class="nc" id="L124">		return listPC.getHtmlDisplay();</span>
	}

	/**
	 * make html string with Radio NoPrefs/Early/Late
	 */
	private String makeEarlyOrLateRadio(short preferredStart) {
<span class="nc" id="L131">		StringBuilder sb = new StringBuilder(1000);</span>
<span class="nc" id="L132">		sb.append(&quot;&lt;div id=\&quot;earlyOrLatePreference\&quot; aria-labelledby=\&quot;earlyOrLateRadioLabel\&quot; &quot; +</span>
			&quot; class=\&quot;tabbable subregion\&quot; tabindex=\&quot;0\&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;&lt;span id=\&quot;earlyOrLateRadioLabel\&quot;&gt;&quot;)
<span class="nc" id="L134">			.append(i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_GENERAL_Q))</span>
<span class="nc" id="L135">			.append(HtmlUtil.makeHiddenReadableText(i18n(m_common_bundle, UIFWebBundleKey.RADIO_GROUP)))</span>
<span class="nc" id="L136">			.append(&quot;&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;div&gt;&quot;)</span>
<span class="nc" id="L137">			.append(makeRadioEntry(EARLY_OR_LATE_FN, preferredStart,</span>
				SimpleSchedulePreference.PREFERRED_START_NON,
<span class="nc" id="L139">				i18n(m_bundle, FsWebBundleKey.SP_START_TIME_NO_PREF)))</span>
<span class="nc" id="L140">			.append(i18n(m_bundle, FsWebBundleKey.SP_START_TIME_NO_PREF))</span>
<span class="nc" id="L141">			.append(makeRadioEntry(EARLY_OR_LATE_FN, preferredStart,</span>
				SimpleSchedulePreference.PREFERRED_START_EARLY,
<span class="nc" id="L143">				i18n(m_bundle, FsWebBundleKey.SP_START_TIME_EARLY_PREF)))</span>
<span class="nc" id="L144">			.append(i18n(m_bundle, FsWebBundleKey.SP_START_TIME_EARLY_PREF))</span>
<span class="nc" id="L145">			.append(makeRadioEntry(EARLY_OR_LATE_FN, preferredStart,</span>
				SimpleSchedulePreference.PREFERRED_START_LATE,
<span class="nc" id="L147">				i18n(m_bundle, FsWebBundleKey.SP_START_TIME_LATE_PREF)))</span>
<span class="nc" id="L148">			.append(i18n(m_bundle, FsWebBundleKey.SP_START_TIME_LATE_PREF))</span>
<span class="nc" id="L149">			.append(&quot;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&quot;);</span>
<span class="nc" id="L150">		return sb.toString();</span>
	}

	/**
	 * make list model for the table with start time preferences
	 */
	private List makeListModel(SimpleSchedulePreference simpleSchedPref) {
<span class="nc" id="L157">		ArrayList listModel = new ArrayList();</span>
<span class="nc" id="L158">		String[] weekdayNames = m_localizer.getWeekdayNames(true);</span>
<span class="nc" id="L159">		int[] weekdayValues = m_localizer.getWeekdayValues();</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">		for (int i = 0; i &lt; weekdayValues.length; i++) {</span>
<span class="nc" id="L162">			int iDay = weekdayValues[i];</span>
<span class="nc" id="L163">			String weekday = weekdayNames[iDay];</span>
<span class="nc" id="L164">			DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(weekday);</span>
<span class="nc" id="L165">			nodeData.add(weekday, CSSUtil.STYLE_NORMAL_LEFT); //508</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">			for (int iPref = 0; iPref &lt; 3; iPref++) {</span>
				// 5.x set limits to time picker with HOO ??
<span class="nc" id="L168">				int startPrefInMin = TimePickerPC.BLANK_TIME;</span>
<span class="nc" id="L169">				int endPrefInMin = TimePickerPC.BLANK_TIME;</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">				if (simpleSchedPref != null) {</span>
<span class="nc" id="L171">					startPrefInMin = simpleSchedPref.getStartTimePreferenceStart(iDay, iPref);</span>
<span class="nc" id="L172">					endPrefInMin = simpleSchedPref.getStartTimePreferenceEnd(iDay, iPref);</span>
				}

<span class="nc" id="L175">				String rangePicker = makeTimeRangePickerHtml(startPrefInMin, endPrefInMin, iDay, iPref);</span>
<span class="nc" id="L176">				nodeData.add(rangePicker, CSSUtil.STYLE_NOWRAP);</span>
			}
<span class="nc" id="L178">			listModel.add(nodeData);</span>
		}
<span class="nc" id="L180">		return listModel;</span>
	}

	/** get timePicker string for rendering, checking for empty values
	 private String makeTimePickerHtml(int offsetInMin, int iDay, int iPref, int oneForEnd){
	 if (offsetInMin != TimePickerPC.BLANK_TIME)
	 offsetInMin *= 60;
	 //day is in [1,7]
	 m_timePickerPC.setInputIndex((iDay-1) * 6 + iPref * 2 + oneForEnd);
	 m_timePickerPC.setTime(offsetInMin);
	 return m_timePickerPC.getHtmlDisplay();
	 }
	 */

	/**
	 * Get timeRangePicker string for rendering, checking for empty values.
	 *
	 * @param startOffsetInMin Start time
	 * @param endOffsetInMin   End time
	 * @param iDay             1=first day, 2=second day, etc.
	 * @param iPref            0=first pref, 1=second pref, 2=third pref
	 * @return The HTML for the desired time range picker.
	 */
	private String makeTimeRangePickerHtml(int startOffsetInMin, int endOffsetInMin, int iDay, int iPref) {
<span class="nc bnc" id="L204" title="All 2 branches missed.">		if (startOffsetInMin != TimePickerPC.BLANK_TIME)</span>
<span class="nc" id="L205">			startOffsetInMin *= 60;</span>

<span class="nc bnc" id="L207" title="All 2 branches missed.">		if (endOffsetInMin != TimePickerPC.BLANK_TIME)</span>
<span class="nc" id="L208">			endOffsetInMin *= 60;</span>

<span class="nc" id="L210">		m_timeRangePickerPC.setTimeInputIndex((iDay - 1) * 3 + iPref);</span>

<span class="nc" id="L212">		m_timeRangePickerPC.getStartTimePickerPC().setTime(startOffsetInMin);</span>
<span class="nc" id="L213">		m_timeRangePickerPC.getEndTimePickerPC().setTime(endOffsetInMin);</span>
<span class="nc" id="L214">		m_timeRangePickerPC.setTitles(i18n(m_bundle, FsWebBundleKey.SP_FROM_TIME), i18n(m_bundle, FsWebBundleKey.SP_TO_TIME)); //508</span>
<span class="nc" id="L215">		String[] ariaLabels = createArialLabelForTimeRangePicker(iPref, iDay);</span>
<span class="nc" id="L216">		m_timeRangePickerPC.setAriaLabels(ariaLabels[0], ariaLabels[1]);</span>
<span class="nc" id="L217">		return m_timeRangePickerPC.getHtmlDisplay();</span>
	}

	private String[] createArialLabelForTimeRangePicker(int iPref, int iDay) {
<span class="nc" id="L221">		String[] ariaLabels = new String[2];</span>
<span class="nc" id="L222">		String header = getHeaderLabel(iPref);</span>
<span class="nc" id="L223">		String weekday = getWeekDay(iDay);</span>
<span class="nc" id="L224">		ariaLabels[0] = weekday + &quot; &quot; + header + &quot; &quot; + i18n(m_bundle, FsWebBundleKey.SP_FROM_TIME);</span>
<span class="nc" id="L225">		ariaLabels[1] = weekday + &quot; &quot; + header + &quot; &quot; + i18n(m_bundle, FsWebBundleKey.SP_TO_TIME);</span>
<span class="nc" id="L226">		return ariaLabels;</span>
	}

	private String getHeaderLabel(int iPref) {
<span class="nc" id="L230">		String headerLabel = &quot;&quot;;</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">		if (iPref == 0) {</span>
<span class="nc" id="L232">			headerLabel = i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_FIRST);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">		} else if (iPref == 1) {</span>
<span class="nc" id="L234">			headerLabel = i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_SECOND);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">		} else if (iPref == 2) {</span>
<span class="nc" id="L236">			headerLabel = i18n(m_bundle, FsWebBundleKey.SP_START_TIME_PREFS_THIRD);</span>
		}
<span class="nc" id="L238">		return headerLabel;</span>
	}

	private String getWeekDay(int iDay) {
<span class="nc" id="L242">		String[] weekdayNames = m_localizer.getWeekdayNames(true);</span>
<span class="nc" id="L243">		return weekdayNames[iDay];</span>
	}

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L248">		boolean success = super.extractParameters(request);</span>
<span class="nc" id="L249">		m_startPrefs = null;</span>

		//Since the pickers have different names (ex: one has &quot;START&quot; and one has &quot;END&quot;), we have to 
		//call getTimes() for each, then combine the two into the member array by alternating from start 
		//and end array values.
<span class="nc" id="L254">		int[] rangeStartPrefs = m_timeRangePickerPC.getStartTimePickerPC().getTimes();</span>
<span class="nc" id="L255">		int[] rangeEndPrefs = m_timeRangePickerPC.getEndTimePickerPC().getTimes();</span>

<span class="nc bnc" id="L257" title="All 2 branches missed.">		if (rangeStartPrefs != null) {</span>
<span class="nc" id="L258">			m_startPrefs = new int[rangeStartPrefs.length * 2]; //should be 21*2 = 42</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">			for (int i = 0, count = 0; i &lt; rangeStartPrefs.length; i++) {</span>
<span class="nc" id="L260">				m_startPrefs[count++] = rangeStartPrefs[i];</span>
<span class="nc" id="L261">				m_startPrefs[count++] = rangeEndPrefs[i];</span>
			}
		}
<span class="nc" id="L264">		return success;</span>
	}

	//===== setters for data fields for extraction
	public void setEarlyOrLate(short sVal) {
<span class="nc" id="L269">		m_earlyOrLate = sVal;</span>
<span class="nc" id="L270">	}</span>

	/**
	 * populate simple prefs obj with extracted start time prefs data
	 */
	public void transferStartTimePrefs(SimpleSchedulePreference simpleSchedPref) {
		//flags from radio
<span class="nc" id="L277">		simpleSchedPref.setPreferredStart(m_earlyOrLate);</span>

		//convert into minutes
<span class="nc bnc" id="L280" title="All 2 branches missed.">		for (int i = 0; i &lt; m_startPrefs.length; i++) {</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">			if (m_startPrefs[i] != -1) m_startPrefs[i] /= 60;</span>
		}

		//set in the object
<span class="nc" id="L285">		int[] weekdayValues = m_localizer.getWeekdayValues();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">		for (int i = 0, iDayIndex = 0; iDayIndex &lt; weekdayValues.length; iDayIndex++) {</span>
<span class="nc" id="L287">			int iDay = weekdayValues[iDayIndex];</span>
<span class="nc" id="L288">			int minPrefForDay = 0;</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">			for (int iPref = 0; iPref &lt; 3; iPref++) {</span>
				//convert time values from secs into mins
<span class="nc" id="L291">				simpleSchedPref.setStartTimePreference(iDay, minPrefForDay, m_startPrefs[i], m_startPrefs[i + 1]);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">				if (m_startPrefs[i] != -1) //to make sure that we always have a first preference (bug #94967)</span>
<span class="nc" id="L293">					minPrefForDay++;</span>
<span class="nc" id="L294">				i += 2;</span>
			}
		}
<span class="nc" id="L297">	}</span>

	private static String makeRadioEntry(String fieldName, short selectedValue, short entryValue, String label) {
<span class="nc bnc" id="L300" title="All 2 branches missed.">		boolean isChecked = (selectedValue == entryValue);</span>
<span class="nc" id="L301">		return HtmlChoiceInput.makeRadioInput(fieldName, String.valueOf(entryValue), label, isChecked, &quot;&quot;, true);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>