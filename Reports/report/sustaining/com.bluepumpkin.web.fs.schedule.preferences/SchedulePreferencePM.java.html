<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SchedulePreferencePM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.schedule.preferences</a> &gt; <span class="el_source">SchedulePreferencePM.java</span></div><h1>SchedulePreferencePM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.schedule.preferences;

import java.util.Collection;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.people.PeopleMH;
import com.bluepumpkin.web.fs.keys.FsJavaScriptFileID;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.schedule.ScheduleViewMH;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpaneListPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.config.Screen;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;


/**
 * Title:        SchedulePreferencePM
 * Description:  This class is used as a common base for the Schedule Preference pages.
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       Chris King; Pavel Bosin
 * @version      1.0
 */
@SuppressWarnings(&quot;serial&quot;)
public abstract class SchedulePreferencePM extends WorkpaneListPM implements ContainersInRowsPM {
	protected static final String VIEW_TYPE_FN = &quot;viewType&quot;;
	public static final String PREFS_ID_FN = &quot;prefsID&quot;;
	public static final String ASOF_CHANGE_FN = &quot;asOfChange&quot;;
	public static final String OVERTIME_FN = &quot;overTime&quot;;

	public static final String VIEW_TYPE_SIMPLE = &quot;VIEW_TYPE_SIMPLE&quot;;
	public static final String VIEW_TYPE_ADVANCED = &quot;VIEW_TYPE_ADVANCED&quot;;
	public static final String VIEW_TYPE_PRINT = &quot;VIEW_TYPE_PRINT&quot;;

	public static final String FORM_ACTION_MY_SIMPLE = &quot;scheduleprefsimple&quot;;
	public static final String FORM_ACTION_PEOPLE_SIMPLE = &quot;people_schedprefsimple&quot;;
	public static final String FORM_ACTION_MY_PRINT = &quot;scheduleprefprint&quot;;
	public static final String FORM_ACTION_PEOPLE_PRINT = &quot;people_scheduleprefprint&quot;;
	public static final String FORM_ACTION_MY_ADVANCED = &quot;scheduleprefadvanced&quot;;
	public static final String FORM_ACTION_PEOPLE_ADVANCED = &quot;people_scheduleprefadvanced&quot;;

	public static final String PREFS_HISTORY = &quot;PREFS_HISTORY&quot;;

	//page definitions
	protected ResourceBundle m_bundle;
	protected String m_formAction;
	protected String m_viewType;

<span class="nc" id="L62">	protected String m_employeeName=&quot;&quot;;</span>
	protected ID m_employeeId;      //ID of the peron, whos preferences are shown

	//page flags
	protected boolean m_isMy;     //this is a personal view vs. employees view

	private boolean m_bPrintButton;
	private boolean m_bRefreshButton;
	private boolean m_bSaveButton;
	private boolean m_bRevertButton;

	protected ContainerList m_containerList;

	/**
	 * Constructs a schedule preference base class.
	 */
	public SchedulePreferencePM(RequestContext context, String viewType) {
<span class="nc" id="L79">		super(context, PageModel.BASIC_MODEL);</span>

<span class="nc" id="L81">	    m_isMy = isMyPage();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">	    if (!m_isMy) setPageModelType(PageModel.FRAMED_MODEL);</span>

<span class="nc" id="L84">	    m_containerList = new ContainerList(this, 5);</span>

<span class="nc" id="L86">	    m_viewType = viewType;</span>
<span class="nc" id="L87">	    initFormAction(viewType);</span>
<span class="nc" id="L88">	    initFlags(viewType);</span>

<span class="nc" id="L90">	    m_bundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

	    //=== Component specific required JavaScript Files
<span class="nc" id="L93">	    addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE_GENERIC);</span>
<span class="nc" id="L94">	    setJSMediator(FsJavaScriptFileID.MEDIATOR_SCHEDULE_PREFS);</span>
<span class="nc" id="L95">	}</span>

	/**
	 * initialize boolean flags for the view
	 */
	private void initFlags(String viewType) {
<span class="nc bnc" id="L101" title="All 2 branches missed.">		if (viewType==null) viewType = &quot;&quot;;</span>
<span class="nc" id="L102">		m_bPrintButton = m_bRefreshButton =</span>
<span class="nc" id="L103">                (viewType.equals(VIEW_TYPE_PRINT));</span>
<span class="nc" id="L104">		m_bSaveButton = m_bRevertButton =</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                (!viewType.equals(VIEW_TYPE_PRINT));</span>
<span class="nc" id="L106">	}</span>

    /**
	 * Return true if Current page is My Preferences Page
	 */
	private boolean isMyPage() {
<span class="nc" id="L112">		boolean isMy = true;</span>
<span class="nc" id="L113">		Screen screen = m_context.getScreen();</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">		if (screen != null)</span>
		{
<span class="nc bnc" id="L116" title="All 2 branches missed.">			if(screen.getName().toLowerCase().indexOf(&quot;people&quot;)!=-1)</span>
<span class="nc" id="L117">				isMy = false;</span>
		}
		else
		{
<span class="nc" id="L121">	        HttpServletRequest aRequest = m_context.getRequest();</span>
<span class="nc" id="L122">	        String pathInfo = aRequest.getPathInfo();</span>
<span class="nc bnc" id="L123" title="All 4 branches missed.">	        if (pathInfo!=null &amp;&amp; pathInfo.indexOf(&quot;people&quot;)!=-1)</span>
<span class="nc" id="L124">	          isMy = false;</span>
	    }
<span class="nc" id="L126">		return isMy;</span>
	}

    /**
     * initialize the form action based on the viewType and isMy
     */
    private void initFormAction(String viewType)
    {
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (m_isMy)</span>
<span class="nc" id="L135">            m_formAction = FORM_ACTION_MY_SIMPLE;</span>
        else
<span class="nc" id="L137">        	m_formAction = &quot;people_schedpredorgmode&quot;;</span>
<span class="nc" id="L138">    }</span>

	/**
	 * Populate Model
	 */
	public void populateModel(RequestContext context)
	{
<span class="nc bnc" id="L145" title="All 2 branches missed.">		if (m_isInitialized)</span>
<span class="nc" id="L146">			return;</span>
		else
<span class="nc" id="L148">			m_isInitialized = true;</span>

<span class="nc" id="L150">		m_employeeId = getEmployeeID();</span>

		try
		{
<span class="nc bnc" id="L154" title="All 2 branches missed.">			if (isEditEnabled() == false) {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">				if (m_isMy) {</span>
<span class="nc" id="L156">					addPageMessage(Message.WARNING_TYPE,</span>
							FsWebBundleKey.FS_MY_SCHEDULE_PREFS_NOT_EDITABLE, FsWebBundleKey.BUNDLE_NAME);
				} else {
<span class="nc" id="L159">					addPageMessage(Message.WARNING_TYPE,</span>
							FsWebBundleKey.FS_MY_SCHEDULE_PREFS_NOT_ALL_EMPLOYEES_EDITABLE, FsWebBundleKey.BUNDLE_NAME);
				}
			}

<span class="nc bnc" id="L164" title="All 2 branches missed.">			if (m_employeeId == null)</span>
			{
<span class="nc" id="L166">				addNoPersonMessage();</span>
<span class="nc" id="L167">				clearInnerContainers();</span>
			}
			else
			{
<span class="nc" id="L171">				m_employeeName = ScheduleViewMH.getEmployeeDisplayName(m_context, m_employeeId, m_localizer);</span>
<span class="nc" id="L172">				loadAndInitData();</span>
			}
		}
<span class="nc" id="L175">		catch (Exception ex)</span>
		{
<span class="nc" id="L177">			handleUnableToLoadDataError(log, ex);</span>
		}
		finally
		{
<span class="nc" id="L181">			initContentTitle();</span>
<span class="nc" id="L182">			initToolbar();</span>
<span class="nc" id="L183">		}</span>
<span class="nc" id="L184">	}</span>


	@Override
	protected void initHeader() {
<span class="nc" id="L189">	}</span>


	@Override
	protected void initSelectableItems()
	{
<span class="nc bnc" id="L195" title="All 2 branches missed.">		if (m_isInitialized)</span>
<span class="nc" id="L196">			return;</span>
		else
<span class="nc" id="L198">			m_isInitialized = true;</span>

<span class="nc" id="L200">		m_employeeId = getEmployeeID();</span>

		try
		{
<span class="nc bnc" id="L204" title="All 2 branches missed.">			if (m_employeeId == null)</span>
			{
<span class="nc" id="L206">				addNoPersonMessage();</span>
<span class="nc" id="L207">				clearInnerContainers();</span>
			}
			else
			{
<span class="nc" id="L211">				m_employeeName = ScheduleViewMH.getEmployeeDisplayName(m_context, m_employeeId, m_localizer);</span>
<span class="nc" id="L212">				loadAndInitData();</span>
			}
		}
<span class="nc" id="L215">		catch (Exception ex)</span>
		{
<span class="nc" id="L217">			handleUnableToLoadDataError(log, ex);</span>
		}
		finally
		{
<span class="nc" id="L221">			initContentTitle();</span>
<span class="nc" id="L222">			initToolbar();</span>
<span class="nc" id="L223">		}</span>
<span class="nc" id="L224">	}</span>

	/**
	 * Clear Inner Containers
	 */
	protected void clearInnerContainers() {
<span class="nc" id="L230">		m_containerList.clear();</span>
<span class="nc" id="L231">	}</span>

    /**
     * add page mesage in no person case
     */
    private void addNoPersonMessage(){
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (m_isMy){</span>
<span class="nc" id="L238">            addPageMessage(Message.INFO_TYPE, BbmWebBundleKey.NO_PERSON_INFO,</span>
                    BbmWebBundleKey.BUNDLE_NAME);
        } else {
<span class="nc" id="L241">            addPageMessage(Message.RESPONSE_TYPE, BbmWebBundleKey.SELECT_EMPLOYEE,</span>
                    BbmWebBundleKey.BUNDLE_NAME);
        }
<span class="nc" id="L244">    }</span>

	/**
	 * Initialize Content Title.
	 *	Content title: Title + Agent Name + As-Of datepicker + view selector
     *  (@TODO 5.x: view selector scoped out in 5.0 - implementing only simple view )
	 */
	protected void initContentTitle() {
<span class="nc bnc" id="L252" title="All 2 branches missed.">        String bundleKey = (m_isMy) ? FsWebBundleKey.MYPROFILE_SCHEDPREF_SIMPLE_PAGETITLE</span>
                                    : FsWebBundleKey.PEOPLE_SCHEDPREF_PAGE_TITLE;
<span class="nc" id="L254">		String pageTitle = i18n(m_bundle, bundleKey);</span>

<span class="nc" id="L256">		m_contentTitlePC.setProperties(pageTitle, m_employeeName);</span>
<span class="nc" id="L257">	}</span>

	/**
	 * Initialize Toolbar
	 */
	protected void initToolbar() {
<span class="nc bnc" id="L263" title="All 2 branches missed.">		boolean bDisableAllButton = (m_employeeId == null);</span>
		// check if user has privilege to edit simple prefs
<span class="nc" id="L265">		boolean bEditEnabled = isEditEnabled();</span>

<span class="nc" id="L267">		m_toolbar.setAlignment(ToolbarPC.ALIGN_RIGHT);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">		if (m_bPrintButton) //for Print view</span>
<span class="nc" id="L269">			m_toolbar.addToolbarElement(new ToolbarTextButton(m_toolbar, &quot;SCHEDULE_PREFERENCE_PRINT&quot;,</span>
<span class="nc" id="L270">                    i18n(m_bundle, FsWebBundleKey.PRINT), ToolbarTextButton.GREEN_BUTTON));</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">      	if (m_bRefreshButton) //for Print view</span>
<span class="nc" id="L272">			m_toolbar.addSubmitTextButton(PageAction.REFRESH,</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                    i18n(m_bundle, FsWebBundleKey.REFRESH), !bDisableAllButton);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">		if (m_bSaveButton)</span>
<span class="nc" id="L275">			m_toolbar.addValidateSubmitTextButton(PageAction.SAVE,</span>
<span class="nc bnc" id="L276" title="All 4 branches missed.">                    i18n(m_bundle, FsWebBundleKey.SAVE), !bDisableAllButton &amp;&amp; bEditEnabled);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (m_bRevertButton)</span>
<span class="nc" id="L278">            m_toolbar.addConfirmSubmitTextButton(PageAction.RESET,</span>
<span class="nc bnc" id="L279" title="All 4 branches missed.">                    i18n(m_bundle, FsWebBundleKey.REVERT), !bDisableAllButton &amp;&amp; bEditEnabled);</span>
<span class="nc" id="L280">    }</span>

	/**
	 * User has edit privileges if:
	 * On &quot;My Schedule Preference Page&quot; and user has the edit schedule preferences privilege OR
	 * on the User Management schedule preferences page if the user has edit employee privileges
	 * for all of the currently selected employees.
	 */
	protected boolean isEditEnabled() {
		try {
<span class="nc bnc" id="L290" title="All 2 branches missed.">			if (m_isMy) {</span>
<span class="nc" id="L291">				return m_context.getUser().isAuthorized(PrivilegeKeys.FS_EDITSCHEDULEPREFSSIMPLE);</span>
			} else {
<span class="nc" id="L293">				return PeopleMH.isAuthToOrgForAll(m_context, m_context.getUser(),</span>
<span class="nc" id="L294">					getSelectedIDsAsCollection(), PrivilegeKeys.CORE_MODIFYPEOPLE_ID);</span>
			}
<span class="nc" id="L296">		} catch (Exception ex) {</span>
<span class="nc" id="L297">			handleUnableToLoadDataError(log, ex);</span>
		}
<span class="nc" id="L299">		return true;</span>
	}

	/**
	 * Retrieve request parameters from request object to the page model object.
	 * Override to extract dates from DatePickerPC objects.
	 *
	 * @param request The HttpRequest
	 * @return true if no errors were encountered, otherwise false
	 */
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L310">		boolean success=super.extractParameters(request);</span>
<span class="nc" id="L311">		return success;</span>
	}

    /**
     * get employee ID for the current user or the currently viewed employee
     */
    protected ID getEmployeeID()
    {
<span class="nc" id="L319">        ID eId = null;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (m_isMy) {</span>
<span class="nc" id="L321">            eId = m_context.getUser().getEmployeeID();</span>
        } else {
<span class="nc bnc" id="L323" title="All 2 branches missed.">            eId = (hasSelectedID())?getSelectedIDs()[getEditIndex()]:null;</span>
        }
<span class="nc" id="L325">        return eId;</span>
    }

    /** add hidden field to the page */
    public String getRequiredHTML(){
<span class="nc" id="L330">        return super.getRequiredHTML()</span>
<span class="nc" id="L331">                + HtmlUtil.makeHiddenInput(SELECTED_ID_FN, getSelectedID())</span>
<span class="nc" id="L332">                + HtmlUtil.makeHiddenInput(PERFORM_ACTION_ON_ID_FN, getPerformActionOnID())</span>
<span class="nc" id="L333">                + HtmlUtil.makeHiddenInput(EDIT_INDEX_FN, getEditIndex())</span>
<span class="nc" id="L334">                + HtmlUtil.makeHiddenInput(ASOF_CHANGE_FN,&quot;&quot;);</span>
    }

    /** add JS to set AsOfChanged flag*/
    public String getCustomJavaScript(){
<span class="nc" id="L339">        StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L340">        sb.append(&quot;\n function changeAsOf() { \n&quot;)</span>
<span class="nc" id="L341">          .append(&quot;   var element = DOM2.getElementsByName(\&quot;&quot;)</span>
<span class="nc" id="L342">          .append(ASOF_CHANGE_FN).append(&quot;\&quot;)[0];\n&quot;)</span>
<span class="nc" id="L343">          .append(&quot;   element.value=\&quot;TRUE\&quot;&quot;)</span>
<span class="nc" id="L344">          .append(&quot;   }\n&quot;);</span>
<span class="nc" id="L345">        return sb.toString();</span>
    }

	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc" id="L352">		return m_formAction;</span>
	}

    /** Return List of Containers
     * NOTE: Items in the Collection will be treated either as Page Components or
     *       just as Objects.
     */
    public Collection getContainers() {
<span class="nc" id="L360">        return m_containerList;</span>
    }

    //================ abstract ======================

    /** inheriting classes overwrite data loading with or without group data */
    protected abstract void loadAndInitData();

}//class

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>