<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AdherenceMappingFormPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.am.adherence.mapping</a> &gt; <span class="el_source">AdherenceMappingFormPageModel.java</span></div><h1>AdherenceMappingFormPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.am.adherence.mapping;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.ResourceBundle;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.am.Log;
import com.bluepumpkin.web.am.keys.AmJavaScriptFileID;
import com.bluepumpkin.web.am.l10n.AmWebBundleKey;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrgWorkpaneFormPageModel;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.DefaultNodeData;
import com.witness.web.uif.pagecomponent.assignmentbox.AssignmentBoxPC;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        AdherenceMappingFormPageModel
 * Description:  Display a form for Adherence Mapping
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       Shimon Kakon
 * @version 1.0
 */
@SuppressWarnings(&quot;serial&quot;)
public class AdherenceMappingFormPageModel extends OrgWorkpaneFormPageModel {
<span class="nc" id="L41">	private static final Category log = Log.initCategory(AdherenceMappingFormPageModel.class.getName());</span>
<span class="nc" id="L42">	private AdherenceMapping m_adherenceMapping = new AdherenceMapping();</span>
<span class="nc" id="L43">	private String m_mappedActivities = null;</span>
<span class="nc" id="L44">	private String m_notEditableMappedActivities = null;</span>
	private ResourceBundle m_amBundle;
	private AssignmentBoxPC m_mappingAssignmentBox;
<span class="nc" id="L47">	private boolean m_isToolbarEnabled = true;</span>
	//an organization map(id, name) for all organizations owners of the non-editable mapped activities
<span class="nc" id="L49">	private Map&lt;ID, String&gt; m_orgMap = Collections.emptyMap();</span>

	// Fields name
	public static final String ID_FN = &quot;activityID&quot;;
	public static final String MAPPED_ACTIVITIES_FN = &quot;mappedActivities&quot;;
	public static final String NOT_EDITABLE_MAPPED_ACTIVITIES_FN = &quot;notEditableMappedActivities&quot;;


	// Constants
	public static final int ASSIGNMENT_BOX_ENTRIES = 15;

	/**
	 * Constructor
	 */
	public AdherenceMappingFormPageModel(RequestContext context) {
<span class="nc" id="L64">		super(context);</span>
<span class="nc" id="L65">		m_amBundle = m_localizer.getBundle(AmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L66">		m_mappingAssignmentBox = new AssignmentBoxPC(context);</span>
<span class="nc" id="L67">		addChildComponent(m_mappingAssignmentBox);</span>
<span class="nc" id="L68">		addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE_FORM);</span>
<span class="nc" id="L69">		setJSMediator(AmJavaScriptFileID.MEDIATOR_ADHERENCE_MAPPING_FORM);</span>
<span class="nc" id="L70">	}</span>


	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static AdherenceMappingFormPageModel getInstance(RequestContext context) {
<span class="nc" id="L77">		return (AdherenceMappingFormPageModel)getInstance(context, AdherenceMappingFormPageModel.class);</span>
	}

	/**
	 * Return the form title
	 *
	 * @return form title
	 */
	public String getFormTitle() {
<span class="nc" id="L86">		return i18n(m_amBundle, AmWebBundleKey.ADHERENCE_MAPPING_LIST_TITLE);</span>
	}

	public void setActivityID(String id) {
<span class="nc bnc" id="L90" title="All 4 branches missed.">		if(id != null &amp;&amp; id.length() &gt; 0) {</span>
<span class="nc" id="L91">			m_adherenceMapping.getActivity().setID(new ID(id));</span>
		}
<span class="nc" id="L93">	}</span>

	public String getActivityID() {
<span class="nc" id="L96">		ID id = m_adherenceMapping.getActivity().getID();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">		if( id!=null ) {</span>
<span class="nc" id="L98">			return id.toString();</span>
		}
		else {
<span class="nc" id="L101">			return &quot;&quot;;</span>
		}
	}


	public void setMappedActivities(String mappedActivities) {
<span class="nc" id="L107">		m_mappedActivities = mappedActivities;</span>
<span class="nc" id="L108">	}</span>


	public String getMappedActivities() {
<span class="nc" id="L112">		return m_mappedActivities;</span>
	}


	public void setNotEditableMappedActivities(String notEditableMappedActivities) {
<span class="nc" id="L117">		m_notEditableMappedActivities = notEditableMappedActivities;</span>
<span class="nc" id="L118">	}</span>


	public String getNotEditableMappedActivities() {
<span class="nc" id="L122">		return m_notEditableMappedActivities;</span>
	}


	public String getActivityName() {
<span class="nc" id="L127">		return m_adherenceMapping.getActivity().getName();</span>
	}


	/**
	 * Gets the adherence mapping value object
	 *
	 * @return activity value object
	 */
	public AdherenceMapping getAdherenceMapping() {
<span class="nc" id="L137">		return m_adherenceMapping;</span>
	}


	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc" id="L145">		return &quot;adherence_mapping_form&quot;;</span>
	}


	/**
	 * Return assignment box component
	 */
	public AssignmentBoxPC getMappingAssignmentBox() {
<span class="nc" id="L153">		return m_mappingAssignmentBox;</span>
	}

	public String getOtherAdheringActivitiesLabel() {
<span class="nc" id="L157">		return i18n(m_amBundle, AmWebBundleKey.ADHERENCE_MAPPING_OTHER_ADHERING_ACTIVITIES);</span>
	}

	public String getNonEditableMappingLabel() {
<span class="nc" id="L161">		return i18n(m_amBundle, AmWebBundleKey.ADHERENCE_MAPPING_LABEL_NON_EDITABLE_ACTIVITIES);</span>
	}


	public AdherenceMapping getNonEditableMappedActivities() {
<span class="nc" id="L166">		return m_adherenceMapping.getNonEditableMapping(getSelectedIDObject());</span>
	}

	public String getActivityNameLabel() {
<span class="nc" id="L170">		return i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_NAME);</span>
	}

	public String getOwnerOrganizationLabel() {
<span class="nc" id="L174">		return i18n(m_bbmBundle, BbmWebBundleKey.LIST_HEADER_OWNER_ORG);</span>
	}

	// Returns an organization map(id, name) for all organizations owners of the non-editable mapped activities
	public Map&lt;ID, String&gt; getOrganizationMap() {
<span class="nc" id="L179">		return m_orgMap;</span>
	}



	/**
	 * Returns a (single) entity type.
	 */
	protected String getTitleEntityType() {
<span class="nc" id="L188">		return this.getFormTitle();</span>
	}

	/**
	 * Returns an entity name. Used for title.
	 */
	protected String getEntityName() {
<span class="nc" id="L195">		return this.getActivityName();</span>
	}


	/**
	 * Populate Model
	 *
	 */
	protected void createFormModel() {

		try {
<span class="nc" id="L206">			m_adherenceMapping = AdherenceMappingModelHandler.getAdherenceMappingByID(m_context,</span>
<span class="nc" id="L207">					getCurrentID(), getSelectedIDObject());</span>
<span class="nc" id="L208">			initMappingAssignmentBox();</span>
<span class="nc" id="L209">			initNonEditable();</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">			if(!m_isToolbarEnabled) {</span>
<span class="nc" id="L211">				m_initFailure = true; //just to disable the save button</span>
			}
			// now load the org map. It will be used in the form to display the owner organization names

<span class="nc bnc" id="L215" title="All 2 branches missed.">			if(m_adherenceMapping != null) </span>
			{
<span class="nc" id="L217">				AdherenceMapping noneditableMapping = m_adherenceMapping.getNonEditableMapping(getSelectedIDObject());</span>
<span class="nc" id="L218">				int nonEditableMappingsCount = noneditableMapping.getMappedActivitiesCount();</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">				if(nonEditableMappingsCount &gt; 0) </span>
				{
<span class="nc" id="L221">					HashSet&lt;ID&gt; orgIds = new HashSet&lt;ID&gt;(nonEditableMappingsCount);</span>
<span class="nc" id="L222">					ID orgID = null;</span>
<span class="nc" id="L223">					Activity[] nonEditableMappedActivities = noneditableMapping.getMappedActivities();</span>
					
					//Get the scoped orgs plus their ancestor orgs for the logged-in user
<span class="nc" id="L226">					Collection&lt;ID&gt; scopedOrgIDs = OrganizationModelHandler.getAllOrgIDsInUserScopePlusAncestors(m_context, m_context.getUser(), true);</span>
					
<span class="nc bnc" id="L228" title="All 2 branches missed.">					for(int i = 0; i &lt; nonEditableMappingsCount; i++) </span>
					{
<span class="nc" id="L230">						orgID = nonEditableMappedActivities[i].getOrganizationId();</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">						if (scopedOrgIDs.contains(orgID))</span>
						{
<span class="nc bnc" id="L233" title="All 2 branches missed.">							if(!orgIds.contains(orgID)) </span>
							{
<span class="nc" id="L235">								orgIds.add(orgID);</span>
							}
						}
					}
<span class="nc" id="L239">					m_orgMap = OrganizationModelHandler.buildOrganizationMap(m_context, orgIds);</span>
				}
			}
		} 
<span class="nc" id="L243">		catch (Exception ex) </span>
		{
<span class="nc" id="L245">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L246">			m_initFailure = true;</span>
<span class="nc" id="L247">		}</span>
<span class="nc" id="L248">	}</span>



<span class="nc" id="L252">	protected void initFieldValidators() {}</span>




	/**
	 * Initialize the Assignment box
	 */
	private void initMappingAssignmentBox() throws Exception {
		AdherenceMapping editableAdherenceMapping;

<span class="nc" id="L263">		m_mappingAssignmentBox.setName(getName() + &quot;_assignmentbox&quot;);</span>
<span class="nc" id="L264">		m_mappingAssignmentBox.setLeftTitle(i18n(m_amBundle,</span>
			AmWebBundleKey.ADHERENCE_MAPPING_AVAILABLE_ACTIVITIES));
<span class="nc" id="L266">		m_mappingAssignmentBox.setRightTitle(i18n(m_amBundle,</span>
			AmWebBundleKey.ADHERENCE_MAPPING_LABEL_MAPPING));
<span class="nc" id="L268">		m_mappingAssignmentBox.setItemCount(ASSIGNMENT_BOX_ENTRIES);</span>

<span class="nc" id="L270">		ID orgID = getSelectedIDObject();</span>

<span class="nc bnc" id="L272" title="All 2 branches missed.">		if (orgID == null) {</span>
<span class="nc" id="L273">			log.l7dError(BbmWebBundleKey.ORGANIZATION_NO_ID_FAILURE);</span>
<span class="nc" id="L274">			throw new Exception( i18n(m_bbmBundle,</span>
				BbmWebBundleKey.ORGANIZATION_NO_ID_FAILURE));
		}

		// Get all activities and filter the mapped activities
<span class="nc" id="L279">		editableAdherenceMapping = m_adherenceMapping.getEditableMapping(orgID);</span>
		Collection&lt;Activity&gt; allActivities;
		ArrayList&lt;DefaultNodeData&gt; availableActivitiesData;
<span class="nc" id="L282">		ID[] mappedActivities = editableAdherenceMapping.getMappedActivitiesIds();</span>
<span class="nc" id="L283">		String[] mappedActivitiesNames = editableAdherenceMapping.getMappedActivitiesName();</span>
<span class="nc" id="L284">		String[] mappedActivitiesDesc = editableAdherenceMapping.getMappedActivitiesDesc();</span>
		ArrayList&lt;DefaultNodeData&gt; mappedActivitiesData;
		Activity activity;
		boolean isRemoved;


<span class="nc" id="L290">		Collection&lt;Activity&gt; allActivitiesBeforeFilter = ActivityModelHandler.getActivitiesFilterActivities(</span>
				m_context, orgID,	new ActivityFilter(),	new ID[]{Activity.ACTIVITY_DELETED});

		//if Basic adherence license, filter all activities except
		//Generic Work Activity activity, Generic Non-Work Activity and No Activity
<span class="nc bnc" id="L295" title="All 2 branches missed.">		if (!checkForAdherenceLicense()){//check for adherence license</span>
			//no privilege
<span class="nc bnc" id="L297" title="All 2 branches missed.">			for (Iterator&lt;Activity&gt; it = allActivitiesBeforeFilter.iterator(); it.hasNext();) {</span>
<span class="nc" id="L298">				activity = it.next();</span>
				// remove the activity to be mapped
<span class="nc bnc" id="L300" title="All 2 branches missed.">				if( !activity.getID().equals(Activity.ACTIVITY_NONE)</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">						&amp;&amp; !activity.getID().equals(Activity.ACIIVITY_GENERIC_WORK)</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">						&amp;&amp; !activity.getID().equals(Activity.ACIIVITY_GENERIC_NONWORK)){</span>
<span class="nc" id="L303">					it.remove();</span>
				}
			}
		}
<span class="nc" id="L307">		allActivities = allActivitiesBeforeFilter;</span>

<span class="nc bnc" id="L309" title="All 4 branches missed.">		if(allActivities != null &amp;&amp; allActivities.size() &gt; 0) {</span>
<span class="nc" id="L310">			availableActivitiesData = new ArrayList&lt;DefaultNodeData&gt;(allActivities.size());</span>
<span class="nc" id="L311">			ArrayList childOrganization = AdherenceMappingModelHandler.getChildOrganizations(m_context, orgID);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">			for (Iterator&lt;Activity&gt; it = allActivities.iterator(); it.hasNext();) {</span>
<span class="nc" id="L313">				activity = it.next();</span>
				// remove the activity to be mapped
<span class="nc bnc" id="L315" title="All 2 branches missed.">				if( activity.getID().equals(editableAdherenceMapping.getActivity().getID()) ){</span>
<span class="nc" id="L316">					it.remove();</span>
<span class="nc" id="L317">					continue;</span>
				}

				// remove activities that were not defined in the selected org level or child orgs
<span class="nc bnc" id="L321" title="All 2 branches missed.">				if(!orgID.equals(m_adherenceMapping.getActivity().getOrganizationId())) {</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">					if(!orgID.equals(Organization.YOUR_COMPANY_ID_OBJ) &amp;&amp;</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">							!childOrganization.contains(activity.getOrganizationId())) {</span>
<span class="nc" id="L324">						it.remove();</span>
<span class="nc" id="L325">						continue;</span>
					}
				}

				// remove the already-mapped activities
<span class="nc" id="L330">				isRemoved = false;</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">				if(mappedActivities.length &gt; 0) {</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">					for(int i = 0; i &lt; mappedActivities.length; i++){</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">						if(activity.getID().equals(mappedActivities[i])) {</span>
<span class="nc" id="L334">							it.remove();</span>
<span class="nc" id="L335">							isRemoved = true;</span>
<span class="nc" id="L336">							break;</span>
						}
					}//end internal for loop
<span class="nc bnc" id="L339" title="All 2 branches missed.">					if(isRemoved) {</span>
<span class="nc" id="L340">						continue;</span>
					}
				}

<span class="nc" id="L344">				DefaultNodeData node = new DefaultNodeData(</span>
<span class="nc" id="L345">					activity.getID().toString(),</span>
<span class="nc" id="L346">					activity.getName(),</span>
<span class="nc" id="L347">					StringUtil.convertEmptyStringToNBSP(activity.getDescription()) );</span>
<span class="nc" id="L348">					availableActivitiesData.add(node);</span>

<span class="nc" id="L350">			}// end external for loop</span>
<span class="nc" id="L351">		}</span>
		else { // no activities for this org
<span class="nc" id="L353">			availableActivitiesData = new ArrayList&lt;DefaultNodeData&gt;();</span>
		}

<span class="nc" id="L356">		m_mappingAssignmentBox.getLeftListPC().setData(availableActivitiesData);</span>

		// convert mapped activities
<span class="nc bnc" id="L359" title="All 2 branches missed.">		if(mappedActivities.length &gt; 0) {</span>
<span class="nc" id="L360">			mappedActivitiesData = new ArrayList&lt;DefaultNodeData&gt;(mappedActivities.length);</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">			for(int i=0; i &lt; mappedActivities.length; i++) </span>
			{
<span class="nc bnc" id="L363" title="All 2 branches missed.">				if (mappedActivities[i] != null)</span>
				{
<span class="nc" id="L365">					DefaultNodeData node = new DefaultNodeData(</span>
<span class="nc" id="L366">						mappedActivities[i].toString(),</span>
						mappedActivitiesNames[i],
<span class="nc" id="L368">						StringUtil.convertEmptyStringToNBSP(mappedActivitiesDesc[i]) );</span>
<span class="nc" id="L369">					mappedActivitiesData.add(node);</span>
				}
			}
		}
		else {
<span class="nc" id="L374">			mappedActivitiesData = new ArrayList&lt;DefaultNodeData&gt;();</span>
		}

<span class="nc" id="L377">		m_mappingAssignmentBox.getRightListPC().setData(mappedActivitiesData);</span>

<span class="nc bnc" id="L379" title="All 4 branches missed.">		if( !(mappedActivities.length &gt; 0 || availableActivitiesData.size() &gt; 0) ){</span>
<span class="nc" id="L380">			m_isToolbarEnabled = false;</span>
		}

<span class="nc" id="L383">	}</span>

	private boolean checkForAdherenceLicense(){
<span class="nc" id="L386">		boolean hasLicense = false;</span>
		try {
<span class="nc" id="L388">			hasLicense = CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_ADHERENCE);</span>
<span class="nc" id="L389">		} catch (Exception ex){</span>
<span class="nc" id="L390">			log.l7dError(AmWebBundleKey.UNABLE_TO_LOAD_DATA, ex);</span>
<span class="nc" id="L391">		}</span>

<span class="nc" id="L393">		return hasLicense;</span>
	}

	private void initNonEditable() {
<span class="nc" id="L397">		ID[] noneditableIDs = getNonEditableMappedActivities().getMappedActivitiesIds();</span>
<span class="nc" id="L398">		setNotEditableMappedActivities(StringUtil.createDelimitedString(noneditableIDs));</span>
<span class="nc" id="L399">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>