<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FacadeCorbaFacadeManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.facade.corbafacade.ejb</a> &gt; <span class="el_source">FacadeCorbaFacadeManagerEJB.java</span></div><h1>FacadeCorbaFacadeManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.facade.corbafacade.ejb;

import java.rmi.Naming;
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Queue;

import javax.naming.Context;
import javax.naming.InitialContext;

import com.bluepumpkin.bpxCommon.common.rmi.IRemoteInterface;
import com.bluepumpkin.bpxCommon.common.rmi.IRemoteScheduleImport;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.employeefilter.ejb.EmployeeFilter;
import com.bluepumpkin.ejb.bbm.employeefilter.model.Filter;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bpx.fxregistration.ejb.FXRegistrationManager;
import com.bluepumpkin.ejb.bpx.fxregistration.model.FXServer;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.bluepumpkin.ejb.facade.Log;
import com.bluepumpkin.ejb.facade.corbafacade.model.CFUserRemote;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.UserManager;
import com.witness.ejb.core.security.model.User;
import com.witness.ejb.core.security.util.UserConverter;

/**
 * Title:        FacadeCorbaFacadeManagerEJB
 * Description:  Methods to facilitate communication with FIS (Integration Server).  There are however some methods in this class
 * which have a different purpose, and ideally these should be moved to a different class.
 * Copyright:    Copyright (c) 2003, 2017
 * Company:      Verint Systems, Inc.
 */
<span class="nc" id="L50">public class FacadeCorbaFacadeManagerEJB extends SessionEJBBase {</span>
	/**
	 *
	 */
	private static final long serialVersionUID = 1L;

<span class="nc" id="L56">	private final static Category m_cat = Log.initCategory(FacadeCorbaFacadeManagerEJB.class.getName());</span>

	private EmployeeFilter m_employeeFilterEJB;
	private UserManager m_userManager;
	private CampaignManager m_campaignManager;


	/*
	 * Constants for error conditions encountered when importing staffing
	 * profiles. This will be interpreted by DE and signalled accordingly 
	 */
	private static final int OUTSOURCER_IMPORT_SUCCESSFUL = 0;

	/*
	 * The import operation failed because of adapter errors and could be 
	 * due to the following reasons: 
	 * 1. Empty or non-existent file to import
	 * 2. File did not contain staffing profiles for the date/time specified
	 */
	private static final int OUTSOURCER_ADAPTER_PROCESSING_ERROR = 1;

	/*
	 * The import operation failed because of adapter errors and could be 
	 * due to the following reasons:
	 * 1. Remote connection to the adapter was broken.
	 * 2. The Integration server or adapter was shutdown.  
	 */
	private static final int OUTSOURCER_ADAPTER_ERROR = 2;

	/*
	 * The import operation failed because of integration server errors 
	 * and could be due to the following reasons: 
	 * 1. Integration server not configured
	 * 2. Integration server not running
	 * 3. Import adapter not configured on the integration server.
	 */
	private static final int OUTSOURCER_INTEGRATION_SERVER_ERROR = 3;

	/*
	 * The import operation failed because of adapter errors and could be 
	 * due to the following reasons: 
	 * 1. Import adapter not configured for the correct organization and
	 * campaign.
	 */
	private static final int OUTSOURCER_ADAPTER_CONFIGURATION_ERROR = 4;

	/*
	 * The import operation was unsuccessful due to application server errors
	 */
	private static final int OUTSOURCER_APPLICATION_SERVER_ERROR = 5;


	/* a flag that indicates whether or not this instance is running in what
	 if mode */
<span class="nc" id="L110">	private boolean m_isWhatIf = false;</span>

	{
<span class="nc" id="L113">		super.init(FacadeCorbaFacadeManagerEJB.class.getName());</span>
<span class="nc" id="L114">	}</span>

	/**
	 * Perform one-time initialization of this EJB instance
	 */
	public void onEjbCreate() {
		try {
			// First query environment to get WIF setting from DD
<span class="nc" id="L122">			Context initialContext = new InitialContext();</span>
<span class="nc" id="L123">			Boolean WIF = (Boolean) initialContext.lookup(&quot;java:comp/env/WIF&quot;);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">			if (WIF != null) {</span>
<span class="nc" id="L125">				m_isWhatIf = WIF;</span>
			}
<span class="nc" id="L127">			m_employeeFilterEJB = BbmManagerFactory.getEmployeeFilter(m_isWhatIf);</span>
<span class="nc" id="L128">			m_userManager = CoreManagerFactory.getUserManager(m_isWhatIf);</span>
<span class="nc" id="L129">			m_campaignManager = WfmManagerFactory.getCampaignManager(m_isWhatIf);</span>
<span class="nc" id="L130">		} catch (Exception e) {</span>
<span class="nc" id="L131">			handleException(&quot;onEjbCreate&quot;, e, false);</span>
<span class="nc" id="L132">		}</span>
<span class="nc" id="L133">	}</span>

	protected Category getCategory() {
<span class="nc" id="L136">		return m_cat;</span>
	}

	public Collection&lt;ID&gt; getEmployeeIDsForOrgs(Collection&lt;ID&gt; orgIDs, Date start, Date end)
			throws RemoteException {
<span class="nc" id="L141">		methodStart(&quot;getEmployeeIDsForOrgs&quot;, orgIDs, start, end);</span>
		try {
<span class="nc" id="L143">			User currentUser = getCurrentUser();</span>
<span class="nc" id="L144">			Filter filter = buildEmployeeFilterForOrgs(currentUser, orgIDs, start, end);</span>
<span class="nc" id="L145">			Collection&lt;ID&gt; employeeIDs = getEmployeeIDs(currentUser, filter, null);</span>
<span class="nc" id="L146">			return employeeIDs;</span>
<span class="nc" id="L147">		} catch (Exception ex) {</span>
<span class="nc" id="L148">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L149">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="nc" id="L151">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; getEmployeeIDsAssignedToSP(ID spID)
			throws RemoteException {
<span class="nc" id="L157">		methodStart(&quot;getEmployeeIDsAssignedToSP&quot;, spID);</span>
		try {

<span class="nc" id="L160">			SchedulingPeriod schedulingPeriod = m_campaignManager.getSchedulingPeriodByID(spID);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">			if (schedulingPeriod.isUsingAllEmployees()) {</span>
<span class="nc" id="L162">				Collection&lt;ID&gt; organizationIDs = m_campaignManager.getLinkedOrgsforSP(spID);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">				if (organizationIDs == null) {</span>
<span class="nc" id="L164">					organizationIDs = new ArrayList&lt;ID&gt;();</span>
				}
<span class="nc" id="L166">				User currentUser = getCurrentUser();</span>
<span class="nc" id="L167">				Filter filter = buildEmployeeFilterForOrgs(currentUser, organizationIDs,</span>
<span class="nc" id="L168">						schedulingPeriod.getStartTime(), schedulingPeriod.getEndTime());</span>
<span class="nc" id="L169">				Collection&lt;ID&gt; employeeIDs = getEmployeeIDs(currentUser, filter, spID);</span>
<span class="nc" id="L170">				return employeeIDs;</span>
			} else {
<span class="nc" id="L172">				User currentUser = getCurrentUser();</span>
<span class="nc" id="L173">				Filter filter = Filter.createAllFilter(currentUser.getID());</span>
<span class="nc" id="L174">				Collection&lt;ID&gt; employeeIDs = getEmployeeIDsAssignedDirectlyToSP(currentUser, spID, filter);</span>
<span class="nc" id="L175">				return employeeIDs;</span>
			}
<span class="nc" id="L177">		} catch (Exception ex) {</span>
			//how to handle?
<span class="nc" id="L179">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L180">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="nc" id="L182">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; getFilteredEmployeeIDsAssignedToSP(ID spID, ID filterID) throws RemoteException {
<span class="nc" id="L187">		methodStart(&quot;getFilteredEmployeeIDsAssignedToSP&quot;, spID, filterID);</span>
		try {
<span class="nc" id="L189">			User currentUser = getCurrentUser();</span>
<span class="nc" id="L190">			return getFilteredEmployeeIDsAssignedToSPWithUser(spID, filterID, currentUser);</span>
<span class="nc" id="L191">		} catch (Exception ex) {</span>
<span class="nc" id="L192">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L193">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="nc" id="L195">			methodFinish();</span>
		}
	}

	private Collection&lt;ID&gt; getFilteredEmployeeIDsAssignedToSPWithUser(ID spID,
			ID filterID, User currentUser) throws BbmFinderException,
			BbmObjectNotFoundException, RemoteException {
<span class="nc" id="L202">		SchedulingPeriod schedulingPeriod = m_campaignManager.getSchedulingPeriodByID(spID);</span>
<span class="nc" id="L203">		Collection&lt;ID&gt; employeeIDs = m_campaignManager.getWorkResourceIDsBySchedulingPeriod(schedulingPeriod);</span>
<span class="nc" id="L204">		Filter filter = m_employeeFilterEJB.getFilterByID(filterID);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">		if (filter.getTimePeriodType() == Filter.TIMEPERIODTYPE_CONTEXT) {</span>
<span class="nc" id="L206">			filter.setStartTime(schedulingPeriod.getStartTime());</span>
<span class="nc" id="L207">			filter.setEndTime(schedulingPeriod.getEndTime());</span>
		}
<span class="nc" id="L209">		employeeIDs.retainAll(m_employeeFilterEJB.getEmployeeIDs(filter, currentUser,</span>
<span class="nc" id="L210">				Collections.emptyList(), true, 0, Integer.MAX_VALUE));</span>
<span class="nc" id="L211">		return employeeIDs;</span>
	}

	private Collection&lt;ID&gt; getEmployeeIDs(User currentUser, Filter filter, ID spID)
			throws RemoteException {
<span class="nc" id="L216">		methodStart(&quot;getEmployeeIDs&quot;, filter);</span>
		try {
<span class="nc" id="L218">			Collection&lt;ID&gt; employeeIDs = new ArrayList&lt;ID&gt;(m_employeeFilterEJB.getEmployeeIDs(filter, currentUser, new ArrayList(), true, 0, Integer.MAX_VALUE, false, spID));</span>
<span class="nc" id="L219">			return employeeIDs;</span>
<span class="nc" id="L220">		} catch (Exception ex) {</span>
			//how to handle?
<span class="nc" id="L222">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L223">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="nc" id="L225">			methodFinish();</span>
		}
	}

	private Collection&lt;ID&gt; getEmployeeIDsAssignedDirectlyToSP(User currentUser, ID spID, Filter filter)
			throws RemoteException {
<span class="nc" id="L231">		methodStart(&quot;getEmployeeIDsAssignedDirectlyToSP&quot;, spID, filter);</span>
		try {
<span class="nc" id="L233">			SchedulingPeriod schedulingPeriod = m_campaignManager.getSchedulingPeriodByID(spID);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">			if (filter.getStartTime() == null) {</span>
<span class="nc" id="L235">				filter.setStartTime(schedulingPeriod.getStartTime());</span>
			}
<span class="nc bnc" id="L237" title="All 2 branches missed.">			if (filter.getEndTime() == null) {</span>
<span class="nc" id="L238">				filter.setEndTime(schedulingPeriod.getEndTime());</span>
			}
<span class="nc" id="L240">			List&lt;ID&gt; employeeIDs = new ArrayList&lt;ID&gt;(m_employeeFilterEJB.getEmployeeIDs(filter, currentUser, new ArrayList(), true, 0, Integer.MAX_VALUE, false, spID));</span>
<span class="nc" id="L241">			return employeeIDs;</span>
<span class="nc" id="L242">		} catch (Exception ex) {</span>
<span class="nc" id="L243">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L244">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="nc" id="L246">			methodFinish();</span>
		}
	}

	private Filter buildEmployeeFilterForOrgs(User currentUser, Collection orgIDs, Date start, Date end) throws Exception {
<span class="nc" id="L251">		ArrayList alParameters = new ArrayList();</span>
<span class="nc" id="L252">		alParameters.add(new ArrayList(orgIDs)); // the parameter must be a list of lists in the sacred interest of confusion, not telling and type un-safety.</span>
<span class="nc" id="L253">		Filter filter = new Filter(Filter.ORGANIZATIONID, Filter.OPERATOR_IN, alParameters);</span>
<span class="nc" id="L254">		filter.setUserID(currentUser.getID());</span>
<span class="nc" id="L255">		filter.setTimePeriodType(Filter.TIMEPERIODTYPE_TIMEWINDOW);</span>
<span class="nc" id="L256">		filter.setStartTime(start);</span>
<span class="nc" id="L257">		filter.setEndTime(end);</span>
<span class="nc" id="L258">		return filter;</span>
	}

	public Collection&lt;ID&gt; getPhantomsIDsAssignedToSP(ID spID)
			throws RemoteException {
<span class="nc" id="L263">		methodStart(&quot;getPhantomsIDsAssignedToSP&quot;, spID);</span>
		try {
<span class="nc" id="L265">			User currentUser = getCurrentUser();</span>
<span class="nc" id="L266">			Filter filter = Filter.createAllFilter(currentUser.getID());</span>
<span class="nc" id="L267">			return new ArrayList&lt;ID&gt;(m_employeeFilterEJB.getEmployeeIDs(filter, currentUser, new ArrayList(), true, 0, Integer.MAX_VALUE, true, spID));</span>
<span class="nc" id="L268">		} catch (Exception ex) {</span>
			//how to handle?
<span class="nc" id="L270">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L271">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="nc" id="L273">			methodFinish();</span>
		}
	}

	public CFUserRemote getUserByName(String userName) throws RemoteException {
<span class="nc" id="L278">		methodStart(&quot;getUserByName&quot;, userName);</span>
		try {
<span class="nc" id="L280">			return CFUserRemote.convert(UserConverter.convertUser(m_userManager</span>
<span class="nc" id="L281">					.getUserByName(userName), new short[]{1}));</span>
<span class="nc" id="L282">		} catch (Exception ex) {</span>
<span class="nc" id="L283">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L284">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="nc" id="L286">			methodFinish();</span>
		}
	}


	private User getCurrentUser() throws Exception {
<span class="nc" id="L292">		String userName = this.m_sessionContext.getCallerPrincipal().getName();</span>

<span class="nc" id="L294">		User currentUser = m_userManager.getUserByName(userName);</span>

<span class="nc bnc" id="L296" title="All 2 branches missed.">		if (currentUser == null) {</span>
<span class="nc" id="L297">			m_cat.debug(&quot;Can't get current user name &quot; + userName + &quot;, use supperuser as default user&quot;);</span>
<span class="nc" id="L298">			currentUser = m_userManager.getUserByID(User.SUPER_USERID);</span>
		}

<span class="nc" id="L301">		return currentUser;</span>
	}

	private IRemoteScheduleImport[] getOutsourcerImportStubs() throws Exception {
<span class="nc" id="L305">		return getRemoteImportStubs(IRemoteScheduleImport.class, IRemoteScheduleImport.RMT_ID);</span>
	}

	private IRemoteInterface[] getGenericStubs() throws Exception {
<span class="nc" id="L309">		return getRemoteImportStubs(IRemoteInterface.class, IRemoteInterface.RMT_ID);</span>
	}


	private &lt;T&gt; T[] getRemoteImportStubs(Class&lt;T&gt; cls, String typeID) throws Exception {
<span class="nc" id="L314">		methodStart(&quot;getRemoteImportStubs&quot;);</span>

		try {
<span class="nc" id="L317">			FXRegistrationManager fxMgr = BbmManagerFactory.getFXRegistrationManager();</span>

<span class="nc" id="L319">			Collection coll = fxMgr.getAllServers();</span>
<span class="nc bnc" id="L320" title="All 4 branches missed.">			if (coll == null || coll.size() &lt;= 0) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">				if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L322">					m_cat.debug(&quot; No integration servers registered &quot;);</span>
<span class="nc" id="L323">				return null;</span>
			}

<span class="nc" id="L326">			ArrayList&lt;T&gt; objList = new ArrayList&lt;T&gt;();</span>

<span class="nc" id="L328">			Iterator iter = coll.iterator();</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L330">				int count = 0;</span>
<span class="nc" id="L331">				FXServer srvr = (FXServer) iter.next();</span>
<span class="nc" id="L332">				String url = &quot;//&quot; + srvr.getRmiHost() + &quot;:&quot; + srvr.getRmiPort();</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">				if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L334">					m_cat.debug(&quot; Looking up integration server url=&quot; + url);</span>

				try {
<span class="nc" id="L337">					String[] list = Naming.list(url);</span>
<span class="nc" id="L338">					url = url + &quot;/&quot;;</span>
<span class="nc bnc" id="L339" title="All 4 branches missed.">					for (int i = 0; list != null &amp;&amp; i &lt; list.length; ++i) {</span>
<span class="nc" id="L340">						String objUrl = list[i].substring(url.length());</span>

<span class="nc bnc" id="L342" title="All 4 branches missed.">						if (objUrl != null &amp;&amp; objUrl.startsWith(typeID)) {</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">							if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L344">								m_cat.debug(&quot; Looking up adapter=&quot; + list[i]);</span>
<span class="nc" id="L345">							T obj = (T) Naming.lookup(list[i]);</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">							if (obj != null) {</span>
<span class="nc" id="L347">								objList.add(obj);</span>
<span class="nc" id="L348">								++count;</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">								if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L350">									m_cat.debug(&quot; Found Import Adapter running on url=&quot; + list[i]);</span>
							}
						}
					}
<span class="nc" id="L354">				} catch (Exception ex) {</span>
<span class="nc" id="L355">					m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L356">					continue;</span>
<span class="nc" id="L357">				}</span>

<span class="nc bnc" id="L359" title="All 2 branches missed.">				if (count == 0)</span>
<span class="nc" id="L360">					m_cat.debug(&quot; Import Adapter is not running on url=&quot; + url);</span>
<span class="nc" id="L361">			}</span>

<span class="nc" id="L363">			return objList.toArray((T[]) java.lang.reflect.Array.newInstance(cls, objList.size()));</span>
		} finally {
<span class="nc" id="L365">			methodFinish();</span>
		}
	}

	public boolean isConfiguredForImport(ID orgID, ID campaignID)
			throws RemoteException {
<span class="nc" id="L371">		methodStart(&quot;isConfiguredForImport&quot;, orgID, campaignID);</span>
		try {
<span class="nc" id="L373">			IRemoteScheduleImport[] impList = this.getOutsourcerImportStubs();</span>
<span class="nc bnc" id="L374" title="All 4 branches missed.">			if (impList == null || impList.length &lt;= 0) {</span>
<span class="nc" id="L375">				return false;</span>
			}

<span class="nc bnc" id="L378" title="All 2 branches missed.">			for (int i = 0; i &lt; impList.length; ++i) {</span>
				try {
<span class="nc" id="L380">					IRemoteScheduleImport imp = impList[i];</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">					if (imp.isConfiguredForImport(orgID, campaignID)) {</span>
<span class="nc" id="L382">						return true;</span>
					}
<span class="nc" id="L384">				} catch (Exception ex) {</span>
<span class="nc" id="L385">					m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L386">				}</span>
			}

<span class="nc bnc" id="L389" title="All 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L390">				m_cat.debug(&quot; No Adapters configured for import&quot;);</span>

<span class="nc" id="L392">			return false;</span>
<span class="nc" id="L393">		} catch (Exception ex) {</span>
<span class="nc" id="L394">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L395">			throw new RemoteException(ex.getMessage(), ex);</span>
		} finally {
<span class="nc" id="L397">			methodFinish();</span>
		}
	}

	public int importOutsourcerStaffingProfiles(ID orgID, ID campaignID,
			Date start,
			Date end)
			throws RemoteException {

<span class="nc" id="L406">		methodStart(&quot;importOutsourcerStaffingProfiles&quot;, orgID, campaignID, start, end);</span>

		try {
<span class="nc" id="L409">			ArrayList retVal = null;</span>
<span class="nc" id="L410">			IRemoteScheduleImport[] impList = null;</span>

			try {
<span class="nc" id="L413">				impList = this.getOutsourcerImportStubs();</span>
<span class="nc bnc" id="L414" title="All 4 branches missed.">				if (impList == null || impList.length &lt;= 0) {</span>
<span class="nc" id="L415">					return OUTSOURCER_INTEGRATION_SERVER_ERROR;</span>
				}
<span class="nc" id="L417">			} catch (Exception ex) {</span>
<span class="nc" id="L418">				return OUTSOURCER_INTEGRATION_SERVER_ERROR;</span>
<span class="nc" id="L419">			}</span>

<span class="nc bnc" id="L421" title="All 2 branches missed.">			for (int i = 0; i &lt; impList.length; ++i) {</span>
				try {
<span class="nc" id="L423">					IRemoteScheduleImport imp = impList[i];</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">					if (!imp.isConfiguredForImport(orgID, campaignID)) {</span>
<span class="nc" id="L425">						continue;</span>
					}

<span class="nc bnc" id="L428" title="All 2 branches missed.">					if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L429">						m_cat.debug(&quot; Importing staffing profile for orgID=&quot; + orgID +</span>
								&quot; campaignID=&quot; + campaignID +
								&quot; start=&quot; + start +
								&quot; end=&quot; + end);
<span class="nc" id="L433">					retVal = (ArrayList) imp.importStaffingProfiles(orgID, campaignID, start, end);</span>
<span class="nc" id="L434">				} catch (Exception ex) {</span>
<span class="nc" id="L435">					m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L436">					return OUTSOURCER_ADAPTER_ERROR;</span>
<span class="nc" id="L437">				}</span>

<span class="nc" id="L439">				int count = 0;</span>
<span class="nc bnc" id="L440" title="All 4 branches missed.">				if (retVal != null &amp;&amp; retVal.size() &gt; 1) {</span>
<span class="nc" id="L441">					count = ((ArrayList) retVal.get(1)).size();</span>
				}

				// check if profiles are available for import
<span class="nc bnc" id="L445" title="All 2 branches missed.">				if (count &gt; 0) {</span>
					try {
<span class="nc" id="L447">						ScheduleAccessManager mgr = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc" id="L448">						mgr.importStaffingProfiles(orgID,</span>
								campaignID,
								(ArrayList) retVal,
								start,
								end);
<span class="nc" id="L453">						return OUTSOURCER_IMPORT_SUCCESSFUL;</span>
<span class="nc" id="L454">					} catch (Exception ex) {</span>
<span class="nc" id="L455">						m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L456">						return OUTSOURCER_APPLICATION_SERVER_ERROR;</span>
					}
				} else {
<span class="nc bnc" id="L459" title="All 2 branches missed.">					if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L460">						m_cat.debug(&quot; Adapter returned null or empty collection for &quot; +</span>
								&quot; orgID=&quot; + orgID +
								&quot; campaignID=&quot; + campaignID +
								&quot; start=&quot; + start +
								&quot; end=&quot; + end);
<span class="nc" id="L465">					return OUTSOURCER_ADAPTER_PROCESSING_ERROR;</span>
				}
			}

<span class="nc bnc" id="L469" title="All 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L470">				m_cat.debug(&quot; No adapters configured to import orgID=&quot; + orgID +</span>
						&quot; campaignID=&quot; + campaignID);

<span class="nc" id="L473">			return OUTSOURCER_ADAPTER_CONFIGURATION_ERROR;</span>
		} finally {
<span class="nc" id="L475">			methodFinish();</span>
		}
	}

<span class="nc" id="L479">	public static String SILENT_FNS_ADAPTER = &quot;SILENT_FNS_ADAPTER&quot;;</span>
<span class="nc" id="L480">	public static String SILENT_FNS_ADAPER_IDLE = &quot;SILENT_FNS_ADAPER_IDLE&quot;;</span>

	/**
	 * Initiates a schedule recalculation for the given SP (spID) using the Silent FnS Adapter in Integration Services.
	 *
	 * @param userName
	 * @param token
	 * @param isWhatIfMode
	 * @param actionID            1-recalc; 2-scheduling; 3-analyze
	 * @param spID
	 * @param isEnableLQF
	 * @param isRecalcSubCampaign
	 * @param params
	 * @return An integer indicating the status of the operation.
	 * 1 - recalc was successfully initiated (the calc itself is done asynchronously so this gives no information on whether the
	 * calc itself was successful).
	 * OUTSOURCER_INTEGRATION_SERVER_ERROR (3) - Will be returned if there was a problem connecting to the integration server.
	 * OUTSOURCER_ADAPTER_CONFIGURATION_ERROR (4) - Will be returned if there was a problem with the configuration of the integration
	 * server (perhaps the Silent FnS module was not present or configured?)
	 */
	public int recalcScheduling(String userName, String token, boolean isWhatIfMode, int actionID, ID spID, boolean isEnableLQF, boolean isRecalcSubCampaign, String[] params) {
<span class="nc" id="L501">		methodStart(&quot;recalcScheduling&quot;, new Integer(actionID), spID, new Boolean(isEnableLQF));</span>
<span class="nc" id="L502">		String command = &quot;&quot;;</span>
<span class="nc bnc" id="L503" title="All 4 branches missed.">		switch (actionID) {</span>
			case 1:
<span class="nc" id="L505">				command = &quot;ReCalc&quot;;</span>
<span class="nc" id="L506">				break;</span>
			case 2:
<span class="nc" id="L508">				command = &quot;Scheduling&quot;;</span>
<span class="nc" id="L509">				break;</span>
			case 3:
<span class="nc" id="L511">				command = &quot;Analyze&quot;;</span>
				break;
		}
		try {
<span class="nc" id="L515">			Pair stubPair = getStub();</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">			IRemoteInterface imp = (IRemoteInterface) (stubPair != null ? stubPair.getSecond() : null);</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">			if (imp == null) {</span>
<span class="nc" id="L518">				m_cat.info(&quot; No adapters configured to recalc or scheduling!&quot;);</span>
<span class="nc bnc" id="L519" title="All 4 branches missed.">				if (stubPair != null &amp;&amp; stubPair.getFirst() != null) {</span>
<span class="nc" id="L520">					return ((Integer) stubPair.getFirst()).intValue();</span>
				}
<span class="nc" id="L522">				return OUTSOURCER_ADAPTER_CONFIGURATION_ERROR;</span>
			}
<span class="nc bnc" id="L524" title="All 2 branches missed.">			if (m_cat.isDebugEnabled()) m_cat.debug(command + &quot; for spID=&quot; + spID);</span>
<span class="nc" id="L525">			String[] deiParams = new String[]{userName, token, String.valueOf(isWhatIfMode), String.valueOf(actionID), spID.toString(), String.valueOf(isEnableLQF)};</span>
<span class="nc bnc" id="L526" title="All 4 branches missed.">			if (actionID == 1 &amp;&amp; isRecalcSubCampaign)//1-recalc,2-scheduling, 3-analyze</span>
			{
<span class="nc" id="L528">				deiParams = new String[]{userName, token, String.valueOf(isWhatIfMode), String.valueOf(actionID), spID.toString(), String.valueOf(isEnableLQF), String.valueOf(isRecalcSubCampaign)};</span>
			}

<span class="nc bnc" id="L531" title="All 4 branches missed.">			if (actionID == 2 || actionID == 3) {//1-recalc,2-scheduling, 3-analyze</span>
				//maybe more parameters for dei file
<span class="nc bnc" id="L533" title="All 4 branches missed.">				if (params != null &amp;&amp; params.length &gt; 0) {</span>
<span class="nc" id="L534">					int numParams = 6 + params.length;</span>
<span class="nc" id="L535">					deiParams = new String[numParams];</span>
<span class="nc" id="L536">					int index = 0;</span>
<span class="nc" id="L537">					deiParams[index++] = userName;</span>
<span class="nc" id="L538">					deiParams[index++] = token;</span>
<span class="nc" id="L539">					deiParams[index++] = String.valueOf(isWhatIfMode);</span>
<span class="nc" id="L540">					deiParams[index++] = String.valueOf(actionID);</span>
<span class="nc" id="L541">					deiParams[index++] = spID.toString();</span>
<span class="nc" id="L542">					deiParams[index++] = String.valueOf(isEnableLQF);</span>

<span class="nc bnc" id="L544" title="All 2 branches missed.">					for (int j = 0; j &lt; params.length; j++) {</span>
<span class="nc" id="L545">						deiParams[index++] = params[j];</span>
					}
				}
			}
			// test here
			//generateDEI(deiParams);
<span class="nc" id="L551">			System.out.println(imp + &quot;================&quot; + imp.doCommand(deiParams));</span>
<span class="nc" id="L552">			return 1;</span>
<span class="nc" id="L553">		} catch (Exception ex) {</span>
<span class="nc" id="L554">			m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L555">			return OUTSOURCER_ADAPTER_ERROR;</span>
		} finally {
<span class="nc" id="L557">			methodFinish();</span>
		}
	}


	public int getCountOfServers(String type) throws RemoteException {
<span class="nc" id="L563">		int count = 0;</span>

		try {
<span class="nc" id="L566">			FXRegistrationManager fxMgr = BbmManagerFactory.getFXRegistrationManager();</span>

<span class="nc" id="L568">			Collection&lt;FXServer&gt; coll = fxMgr.getAllServers();</span>
<span class="nc bnc" id="L569" title="All 4 branches missed.">			if (coll == null || coll.size() &lt;= 0) {</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">				if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L571">					m_cat.debug(&quot; No integration servers registered &quot;);</span>
				}
<span class="nc" id="L573">				return 0;</span>
			}

<span class="nc" id="L576">			Iterator&lt;FXServer&gt; iter = coll.iterator();</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L578">				FXServer srvr = iter.next();</span>
<span class="nc" id="L579">				String url = &quot;//&quot; + srvr.getRmiHost() + &quot;:&quot; + srvr.getRmiPort();</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">				if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L581">					m_cat.debug(&quot; Looking up integration server url=&quot; + url);</span>
				}

				try {
<span class="nc" id="L585">					String[] list = Naming.list(url);</span>
<span class="nc" id="L586">					url = url + &quot;/&quot;;</span>
<span class="nc bnc" id="L587" title="All 4 branches missed.">					for (int i = 0; list != null &amp;&amp; i &lt; list.length; ++i) {</span>
<span class="nc" id="L588">						String objUrl = list[i].substring(url.length());</span>

<span class="nc bnc" id="L590" title="All 2 branches missed.">						if (objUrl.startsWith(IRemoteInterface.RMT_ID)) {</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">							if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L592">								m_cat.debug(&quot; Looking up adapter=&quot; + list[i]);</span>
							}
<span class="nc" id="L594">							IRemoteInterface iRemInterface = (IRemoteInterface) Naming.lookup(list[i]);</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">							if (iRemInterface != null</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">									&amp;&amp; iRemInterface.getInstanceID() != null</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">									&amp;&amp; iRemInterface.getInstanceID().startsWith(type)) {</span>
								// count only one adapter for one server
<span class="nc" id="L599">								count++;</span>
<span class="nc" id="L600">								break;</span>

							}
						}
					}
<span class="nc" id="L605">				} catch (Exception ex) {</span>
<span class="nc" id="L606">					m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L607">					continue;</span>
<span class="nc" id="L608">				}</span>
<span class="nc" id="L609">			}</span>
<span class="nc" id="L610">		} catch (BbmFinderException | BbmEJBCreateException e) {</span>
<span class="nc" id="L611">			m_cat.error(e.getMessage(), e);</span>
<span class="nc" id="L612">		}</span>
<span class="nc" id="L613">		return count;</span>
	}

<span class="nc" id="L616">	static Queue&lt;String&gt; queue = new LinkedList&lt;String&gt;();</span>

	public Pair&lt;Integer, IRemoteInterface&gt; getStub() throws Exception {
<span class="nc" id="L619">		Pair&lt;Integer, IRemoteInterface&gt; retPair = new Pair&lt;Integer, IRemoteInterface&gt;();</span>
<span class="nc" id="L620">		HashMap&lt;String, IRemoteInterface&gt; remoteListUsable = new HashMap&lt;&gt;();</span>
<span class="nc" id="L621">		IRemoteInterface iRemInterface = null;</span>
		try {
<span class="nc" id="L623">			IRemoteInterface[] remoteList = this.getGenericStubs();</span>
<span class="nc bnc" id="L624" title="All 4 branches missed.">			if (remoteList == null || remoteList.length &lt;= 0) {</span>
<span class="nc" id="L625">				retPair.setPair(new Integer(OUTSOURCER_INTEGRATION_SERVER_ERROR), null);</span>
<span class="nc" id="L626">				return retPair;</span>
			}
<span class="nc bnc" id="L628" title="All 2 branches missed.">			for (int i = 0; i &lt; remoteList.length; ++i) {</span>
				try {
<span class="nc" id="L630">					iRemInterface = remoteList[i];</span>
<span class="nc bnc" id="L631" title="All 4 branches missed.">					if (iRemInterface != null &amp;&amp; iRemInterface.getInstanceID() != null</span>
<span class="nc bnc" id="L632" title="All 4 branches missed.">							&amp;&amp; iRemInterface.getInstanceID().startsWith(SILENT_FNS_ADAPTER) &amp;&amp; isAdapterIdle(iRemInterface)) {</span>
<span class="nc" id="L633">						remoteListUsable.put(iRemInterface.getInstanceID(), iRemInterface);</span>
					}
<span class="nc" id="L635">				} catch (RemoteException e) {</span>
<span class="nc" id="L636">					m_cat.debug(e);</span>
<span class="nc" id="L637">					m_cat.info(&quot;Adapter is not responding; ignoring it (must be stopped). moving to next one i=&quot; + i);</span>
<span class="nc" id="L638">				}</span>
			}
<span class="nc bnc" id="L640" title="All 4 branches missed.">			if (remoteListUsable == null || remoteListUsable.isEmpty()) {</span>
<span class="nc" id="L641">				retPair.setPair(new Integer(OUTSOURCER_ADAPTER_CONFIGURATION_ERROR), null);</span>
<span class="nc" id="L642">				return retPair;</span>
			}
<span class="nc" id="L644">		} catch (Exception ex) {</span>
<span class="nc" id="L645">			retPair.setPair(new Integer(OUTSOURCER_INTEGRATION_SERVER_ERROR), null);</span>
<span class="nc" id="L646">			return retPair;</span>
<span class="nc" id="L647">		}</span>
<span class="nc" id="L648">		iRemInterface = null;</span>
		//If size is 1 then no need to bother about round robin implementation. just return the first adapter.
<span class="nc bnc" id="L650" title="All 4 branches missed.">		if (remoteListUsable != null &amp;&amp; remoteListUsable.size() == 1) {</span>
<span class="nc bnc" id="L651" title="All 4 branches missed.">			if (queue != null &amp;&amp; !queue.isEmpty()) queue.clear();</span>
<span class="nc" id="L652">			iRemInterface = (IRemoteInterface) remoteListUsable.values().iterator().next();</span>
<span class="nc" id="L653">			retPair.setPair(null, iRemInterface);</span>
<span class="nc" id="L654">			return retPair;</span>
		}
		//round robin implementation; applicable only if adapters found on more than one integration servers.
<span class="nc" id="L657">		synchronized (queue) {</span>
<span class="nc bnc" id="L658" title="All 4 branches missed.">			if (remoteListUsable != null &amp;&amp; queue.size() &gt; remoteListUsable.size()) {</span>
				//should go here only if a running adapter is removed
<span class="nc" id="L660">				m_cat.info(&quot;Existing adapter has been removed; clearing the round robin queue&quot;);</span>
<span class="nc" id="L661">				queue.clear();</span>
			}
<span class="nc bnc" id="L663" title="All 4 branches missed.">			if (queue.size() == remoteListUsable.size() &amp;&amp; remoteListUsable.keySet().containsAll(queue)) {</span>
				//normal scenario get the adapters in round robin. Rely on linked list for that
<span class="nc" id="L665">				String interfaceName = (String) queue.remove();</span>
<span class="nc" id="L666">				iRemInterface = (IRemoteInterface) remoteListUsable.get(interfaceName);</span>
<span class="nc" id="L667">				queue.add(interfaceName);</span>
<span class="nc" id="L668">			} else {</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">				for (Iterator&lt;IRemoteInterface&gt; iterator = remoteListUsable.values().iterator(); iterator.hasNext(); ) {</span>
					//only should got here on startup or when a new adapter is added
<span class="nc" id="L671">					iRemInterface = iterator.next();</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">					if (!queue.contains(iRemInterface.getInstanceID())) {</span>
<span class="nc" id="L673">						m_cat.info(&quot; new Adapter found; adding it to the round robin queue:&quot; + iRemInterface.getInstanceID());</span>
<span class="nc" id="L674">						queue.add(iRemInterface.getInstanceID());</span>
<span class="nc" id="L675">						break;</span>
					}
				}
			}
<span class="nc" id="L679">		}</span>
<span class="nc" id="L680">		retPair.setPair(null, iRemInterface);</span>
<span class="nc" id="L681">		return retPair;</span>
	}

	private final static String STAT_IDLE_KEY = &quot;STAT_IDLE_KEY&quot;; //defined in SilentFnSAdapter.java as well

	private boolean isAdapterIdle(IRemoteInterface imp) throws RemoteException {
<span class="nc" id="L687">		boolean isAdapterIdle = true;</span>
<span class="nc" id="L688">		String[] keys = new String[]{STAT_IDLE_KEY};</span>
<span class="nc" id="L689">		String[] values = imp.get(keys);</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">		if (values.length == 1) {</span>
<span class="nc bnc" id="L691" title="All 4 branches missed.">			if (values[0] != null &amp;&amp; values[0].trim().equals(&quot;false&quot;))</span>
<span class="nc" id="L692">				isAdapterIdle = false;</span>
		}
<span class="nc" id="L694">		return isAdapterIdle;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>