<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TOHoursPerDayDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb</a> &gt; <span class="el_source">TOHoursPerDayDAO.java</span></div><h1>TOHoursPerDayDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.IDPair;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoPCommand;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.base.RmException;
import com.bluepumpkin.ejb.rm.l10n.RmEjbLogBundleKey;
import com.bluepumpkin.ejb.rm.l10n.RmSettingKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDay;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDayFieldInfo;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TimeOffActivitySummary;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.ejb.rm.util.DAOUtil;
import com.bluepumpkin.ejb.rm.util.JdmoPreparedStatement;
import com.bluepumpkin.ejb.rm.util.JdmoPreparedStatementBuilder;
import com.bluepumpkin.ejb.rm.util.RmDAOBase;
import com.bluepumpkin.ejb.rm.util.RmUtil;


/**
 * DAO class for TOHoursPerDay
 */
public class TOHoursPerDayDAO extends RmDAOBase&lt;TOHoursPerDay&gt; {
	// TOChoiceFieldInfo for the DAO class.
<span class="nc" id="L56">	private static FieldInfo m_fieldInfo = new TOHoursPerDayFieldInfo();</span>
<span class="nc" id="L57">	private static Category m_cat = Log.initCategory(TOHoursPerDayDAO.class.getName());</span>

	/**
	 * Constructor
	 */
	public TOHoursPerDayDAO() {
<span class="nc" id="L63">		super();</span>
<span class="nc" id="L64">	}</span>

	/**
	 * Constructor
	 *
	 * @param - Jdmo - Jdmo object instance
	 * @see
	 */
	public TOHoursPerDayDAO(Jdmo dmo) {
<span class="nc" id="L73">		super(dmo);</span>
<span class="nc" id="L74">	}</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="nc" id="L78">		return TOHoursPerDayDAO.m_fieldInfo;</span>
	}

	protected Category getCategory() {
<span class="nc" id="L82">		return TOHoursPerDayDAO.m_cat;</span>
	}

	/**
	 * Creates the value object.
	 *
	 * @return - returns new Value object
	 * @see com.bluepumpkin.ejb.bbm.vo.ValueObjectBase
	 * @see com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDay
	 */
	@Override
	protected TOHoursPerDay createValueObject() {
<span class="nc" id="L94">		return (new TOHoursPerDay());</span>
	}

	/**
	 * Finds TOHoursPerDay for the TOHoursPerDay id object passed as argument.
	 *
	 * @param - ID -  ID object for Time off Choice.
	 * @return - TOHoursPerDay Object.
	 * @throw BbmFinderException
	 */
	public TOHoursPerDay getTOHoursPerDayRequestById(ID pTOHoursPerDayId) throws BbmFinderException {
<span class="nc" id="L105">		return getObjectByID(pTOHoursPerDayId);</span>
	}

	/**
	 * Create new TimeOff HoursPerDay for the TimeOff HoursPerDay object passed as argument.
	 *
	 * @param - pTOHoursPerDay -  TOHoursPerDay object for Time off Choice / To event.
	 * @return - ID object for created TOHoursPerDay.
	 * @throw BbmCreateException
	 */
	public ID createTOHoursPerDayRequest(TOHoursPerDay pTOHoursPerDay) throws RmException, BbmCreateException {
<span class="nc bnc" id="L116" title="All 4 branches missed.">		if (pTOHoursPerDay.getTOChoiceID() == null &amp;&amp; pTOHoursPerDay.getTOEventID() == null) {</span>
<span class="nc" id="L117">			throw RequestUtil.createRmException(RmEjbLogBundleKey.REQUEST_ID_NULL, TOHoursPerDayDAO.m_cat);</span>
		}
		/*
	    if (pTOHoursPerDay.getTOHoursPerDayCreationDate() == null) {
	        throw RequestUtil.createRmException(RmEjbLogBundleKey.t, TOHoursPerDayDAO.m_cat);
	    }
	    if (pTOHoursPerDay.getTOHoursPerDayExpiryDate() == null) {
	        throw RequestUtil.createRmException(RmEjbLogBundleKey.TOHoursPerDay_EXPIRY_DATE_NULL, TOHoursPerDayDAO.m_cat);
	    }  */
<span class="nc" id="L126">		ID l_TOHoursPerDayId = createObject(pTOHoursPerDay);</span>
<span class="nc" id="L127">		return l_TOHoursPerDayId;</span>

	}

	/**
	 * Update TO HoursPerDay database for the TO HoursPerDay object passed as argument.
	 *
	 * @param - pTOHoursPerDay -  TOHoursPerDay object for Time off Choice.
	 * @throw BbmUpdateException
	 */
	public void updateTOHoursPerDay(TOHoursPerDay pTOHoursPerDay) throws BbmUpdateException, MultiUserException {
<span class="nc" id="L138">		updateObject(pTOHoursPerDay);</span>
<span class="nc" id="L139">	}</span>

	/**
	 * Delete TO HoursPerDay database for the TO HoursPerDay id object passed as argument.
	 *
	 * @param - pTOHoursPerDayID -  ID object for Time off Choice.
	 * @throw BbmRemoveException
	 * @see
	 */
	public void deleteTOHoursPerDayRequest(ID pTOHoursPerDayID) throws BbmRemoveException {
<span class="nc" id="L149">		deleteObject(pTOHoursPerDayID);</span>
<span class="nc" id="L150">	}</span>

	//on HOO change or Holiday change
	public Collection findEligibleTOHoursPerDay(ID orgID, TimeRange dateRange) throws Exception {
<span class="nc" id="L154">		return new ArrayList();</span>
	}

	// on HOO or Holiday change
	public Collection findEligibleTOHoursPerDay(ID empID, ID TOActivityID) throws Exception {
<span class="nc" id="L159">		return new ArrayList();</span>
	}

	// on  unavailability
	public Collection findEligibleTOHoursPerDayForEmp(ID empID, TimeRange dateRange) throws Exception {
<span class="nc" id="L164">		StringBuffer query = new StringBuffer(256);</span>
<span class="nc" id="L165">		query.append(&quot;SELECT A.ID FROM &quot;);</span>
<span class="nc" id="L166">		query.append(getFieldInfo().getTableName()).append(&quot; A &quot;);</span>
<span class="nc" id="L167">		query.append(&quot;WHERE A.EMPLOYEEID=? and startdate &gt;= ? and endDate&lt;= ? &quot;);</span>
<span class="nc" id="L168">		List toReqIDs = DAOUtil.getIDsUsingSQLQuery(getDMO(),</span>
<span class="nc" id="L169">		        query.toString(),</span>
		        new Object[]{new Date()},
		        new DAOUtil.ColumnMetaData[]
<span class="nc" id="L172">		        {DAOUtil.ColumnMetaData.getColMetaDataForDate()</span>
		        });
<span class="nc" id="L174">		return toReqIDs;</span>
	}

	// on HOO or Holiday change
	public Collection getAllDirtyTOHoursPerDay() throws Exception {
<span class="nc" id="L179">		StringBuffer query = new StringBuffer(256);</span>
<span class="nc" id="L180">		query.append(&quot;SELECT A.ID FROM &quot;);</span>
<span class="nc" id="L181">		query.append(getFieldInfo().getTableName()).append(&quot; A &quot;);</span>
<span class="nc" id="L182">		query.append(&quot;WHERE A.ISDIRTY = 1&quot;);</span>
<span class="nc" id="L183">		List toReqIDs = DAOUtil.getIDsUsingSQLQuery(getDMO(),</span>
<span class="nc" id="L184">		        query.toString(),</span>
		        new Object[]{new Date()},
		        new DAOUtil.ColumnMetaData[]
<span class="nc" id="L187">		        {DAOUtil.ColumnMetaData.getColMetaDataForDate()</span>
		        });
<span class="nc" id="L189">		return toReqIDs;</span>
	}

	public void updateTOEventsForEmp(Collection delTOEventIDs, HashMap newTOEvents) throws Exception {
<span class="nc bnc" id="L193" title="All 4 branches missed.">		if (delTOEventIDs != null &amp;&amp; !delTOEventIDs.isEmpty()) {</span>
<span class="nc" id="L194">			deleteTOHoursPerDay(delTOEventIDs, TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID, null);</span>
		}
<span class="nc" id="L196">		Collection existingObjects = getObjects(newTOEvents.keySet(), TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID, null);</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">		for (Iterator iterator = existingObjects.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L198">			TOHoursPerDay toHoursPerDayToBeUpdated = (TOHoursPerDay) iterator.next();</span>
<span class="nc" id="L199">			TOHoursPerDay toHoursPerDayNew = (TOHoursPerDay) newTOEvents.remove(toHoursPerDayToBeUpdated.getTOEventID());</span>
			//toHoursPerDayToBeUpdated will be updated with all the refreshed contents of  toHoursPerDayNew Object
<span class="nc" id="L201">			TOHoursPerDayUtil.updateTOEventToHoursPerDay(toHoursPerDayToBeUpdated, toHoursPerDayNew);</span>
<span class="nc" id="L202">		}</span>
<span class="nc bnc" id="L203" title="All 4 branches missed.">		if (existingObjects != null &amp;&amp; !existingObjects.isEmpty()) {</span>
<span class="nc" id="L204">			updateObjects(existingObjects);</span>
		}
<span class="nc bnc" id="L206" title="All 4 branches missed.">		if (newTOEvents != null &amp;&amp; !newTOEvents.isEmpty()) {</span>
<span class="nc" id="L207">			createObjects(newTOEvents.values());</span>
		}
<span class="nc" id="L209">	}</span>

	public void updateTOChoicesForEmp(Collection delTOChoiceIDs, HashMap newTOChoices) throws Exception {
<span class="nc bnc" id="L212" title="All 4 branches missed.">		if (delTOChoiceIDs != null &amp;&amp; !delTOChoiceIDs.isEmpty()) {</span>
<span class="nc" id="L213">			deleteTOHoursPerDay(delTOChoiceIDs, TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID, null);</span>
		}
<span class="nc" id="L215">		Collection existingObjects = getObjects(newTOChoices.keySet(), TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID, null);</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">		for (Iterator iterator = existingObjects.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L217">			TOHoursPerDay toHoursPerDayToBeUpdated = (TOHoursPerDay) iterator.next();</span>
<span class="nc" id="L218">			TOHoursPerDay toHoursPerDayNew = (TOHoursPerDay) newTOChoices.remove(toHoursPerDayToBeUpdated.getTOChoiceID());</span>
			//toHoursPerDayToBeUpdated will be updated with all the refreshed contents of  toHoursPerDayNew Object
<span class="nc bnc" id="L220" title="All 2 branches missed.">			if (toHoursPerDayNew == null) {</span>
<span class="nc" id="L221">				throw new BbmUpdateException(toHoursPerDayToBeUpdated + &quot; not found in new Objects&quot;);</span>
			}
<span class="nc" id="L223">			TOHoursPerDayUtil.updateTOEventToHoursPerDay(toHoursPerDayToBeUpdated, toHoursPerDayNew);</span>
<span class="nc" id="L224">		}</span>
<span class="nc bnc" id="L225" title="All 4 branches missed.">		if (existingObjects != null &amp;&amp; !existingObjects.isEmpty()) {</span>
<span class="nc" id="L226">			updateObjects(existingObjects);</span>
		}
<span class="nc bnc" id="L228" title="All 4 branches missed.">		if (newTOChoices != null &amp;&amp; !newTOChoices.isEmpty()) {</span>
<span class="nc" id="L229">			createObjects(newTOChoices.values());</span>
		}
<span class="nc" id="L231">	}</span>

	public void deleteTOHoursPerDay(Collection col, int columnId, TimeRange dateRange) throws Exception {
<span class="nc" id="L234">		StringBuilder buf = new StringBuilder();</span>
<span class="nc" id="L235">		buf.append(&quot;SELECT ID FROM &quot;);</span>
<span class="nc" id="L236">		buf.append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L237">		buf.append(&quot; WHERE &quot;);</span>
<span class="nc" id="L238">		buf.append(TOHoursPerDayFieldInfo.getColumnName(columnId)).append(&quot; in &quot;).append(m_dmo.createInClause(col));</span>
<span class="nc" id="L239">		appendDateRangeClause(buf, dateRange, &quot; AND &quot;);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;deleteTOHoursPerDay QRY=&quot; + buf.toString());</span>
<span class="nc" id="L241">		deleteObjects(buf.toString());</span>
<span class="nc" id="L242">	}</span>

	public void deleteTOHoursPerDayForTOEventEmpPairs(Collection toEventEmpPairs) throws BbmUpdateException {
<span class="nc" id="L245">		Jdmo jdmo = null;</span>
		try {
<span class="nc" id="L247">			jdmo = getDMO();</span>
<span class="nc bnc" id="L248" title="All 4 branches missed.">			if (toEventEmpPairs == null || toEventEmpPairs.isEmpty()) {</span>
<span class="nc" id="L249">				return;</span>
			}
<span class="nc" id="L251">			StringBuilder buf = new StringBuilder();</span>
<span class="nc" id="L252">			buf.append(&quot;DELETE &quot;).append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L253">			buf.append(&quot; WHERE &quot;).append(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID).append(&quot; = ? AND &quot;);</span>
<span class="nc" id="L254">			buf.append(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_EMPLOYEEID).append(&quot; = ? &quot;);</span>
<span class="nc" id="L255">			JdmoPCommand pc = jdmo.createPCommand(buf.toString());</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">			for (Iterator iterator = toEventEmpPairs.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L257">				IDPair pair = (IDPair) iterator.next();</span>
<span class="nc" id="L258">				jdmo.addBatchPCommand(pc, new Object[]{pair.getFirst(), pair.getSecond()});</span>
<span class="nc" id="L259">			}</span>
<span class="nc" id="L260">			jdmo.executeBatchPCommand(pc);</span>
<span class="nc" id="L261">		} catch (Exception e) {</span>
<span class="nc" id="L262">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L263">		}</span>
<span class="nc" id="L264">	}</span>

	public void markTOHoursPerDayAsDirty(Collection col, int columnId, TimeRange dateRange) throws Exception {
<span class="nc" id="L267">		Jdmo dmo = getDMO();</span>
<span class="nc" id="L268">		StringBuilder buf = new StringBuilder();</span>
<span class="nc" id="L269">		buf.append(&quot; UPDATE &quot;);</span>
<span class="nc" id="L270">		buf.append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L271">		buf.append(&quot; SET &quot;);</span>
<span class="nc" id="L272">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_B_ISDIRTY));</span>
<span class="nc" id="L273">		buf.append(&quot;= 1 , &quot;);</span>
<span class="nc" id="L274">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_D_DIRTYTIME));</span>
<span class="nc" id="L275">		buf.append(&quot;= '&quot;).append(JdmoUtil.formatDBString(new Date())).append(&quot;' &quot;);</span>
<span class="nc" id="L276">		buf.append(&quot; WHERE &quot;);</span>
<span class="nc" id="L277">		buf.append(TOHoursPerDayFieldInfo.getColumnName(columnId)).append(&quot; in &quot;).append(m_dmo.createInClause(col));</span>
<span class="nc" id="L278">		appendDateRangeClause(buf, dateRange, &quot; AND &quot;);</span>
<span class="nc" id="L279">		dmo.executeCommand(buf.toString());</span>
<span class="nc" id="L280">	}</span>

	public Collection getObjectsWithExactMatch(TOHoursPerDay hoursPerDay) throws Exception {
<span class="nc" id="L283">		StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L284">		buf.append(&quot; TIMEOFFEVENTID is not null AND EMPLOYEEID= &quot;).append(hoursPerDay.getEmployeeID().toInt());</span>
<span class="nc" id="L285">		buf.append(&quot; AND STARTTIME ='&quot;).append(JdmoUtil.formatDBString(hoursPerDay.getStartTime())).append(&quot;' &quot;);</span>
<span class="nc" id="L286">		buf.append(&quot; AND ENDTIME ='&quot;).append(JdmoUtil.formatDBString(hoursPerDay.getEndTime())).append(&quot;' &quot;);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getObjects QRY= &quot; + buf.toString());</span>
<span class="nc" id="L288">		return getObjects(buf.toString());</span>
	}

	public Collection getObjects(Collection col, int columnId, TimeRange dateRange) throws Exception {

<span class="nc" id="L293">		JdmoPreparedStatementBuilder where = new JdmoPreparedStatementBuilder();</span>
<span class="nc" id="L294">		where.add(TOHoursPerDayFieldInfo.getColumnName(columnId));</span>
<span class="nc" id="L295">		where.add(&quot; in ? &quot;, col);</span>

<span class="nc" id="L297">		appendDateRangeClausePrepared(where, dateRange, &quot; AND &quot;);</span>

<span class="nc bnc" id="L299" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc" id="L300">			m_cat.debug(&quot;getObjects QRY= &quot; + where.toString());</span>
		}

<span class="nc" id="L303">		return getObjectsWhere(where);</span>
	}


	public Collection getTOHoursPerDayForTORequests(Collection empIDs, TimeRange dateRange) throws Exception {
<span class="nc" id="L308">		StringBuilder buf = new StringBuilder();</span>
<span class="nc" id="L309">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID)).append(&quot; IS NOT NULL &quot;);</span>
<span class="nc" id="L310">		appendDateRangeClause(buf, dateRange, &quot; AND &quot;);</span>
<span class="nc" id="L311">		appendEmpIdsClause(buf, empIDs, &quot; AND &quot;);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getTOHoursPerDayForTORequests QRY= &quot; + buf.toString());</span>
<span class="nc" id="L313">		return getObjects(buf.toString());</span>
	}

	public Collection getHoursPerDayForTOevents(Collection empIDs, Collection activityIDs, TimeRange dateRange) throws Exception {
<span class="nc" id="L317">		JdmoPreparedStatementBuilder where = new JdmoPreparedStatementBuilder();</span>

<span class="nc" id="L319">		where.add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID)).add(&quot; IS NOT NULL &quot;);</span>

<span class="nc" id="L321">		return getObjectsUsingPrepared(empIDs, activityIDs, dateRange, where);</span>
	}

	private Collection&lt;TOHoursPerDay&gt; getObjectsUsingPrepared(Collection empIDs, Collection activityIDs, TimeRange dateRange,
			JdmoPreparedStatementBuilder where)
			throws BbmFinderException {
		
<span class="nc" id="L328">		appendDateRangeClausePrepared(where, dateRange, &quot; AND &quot;);</span>
<span class="nc" id="L329">		appendActivityIdsClausePrepared(where, activityIDs, &quot; AND &quot;);</span>
<span class="nc" id="L330">		appendEmpIdsClausePrepared(where, empIDs, &quot; AND &quot;);</span>
<span class="nc" id="L331">		return getObjectsWhere(where);</span>
	}



	public Map&lt;Boolean, List&lt;TOHoursPerDay&gt;&gt; getHoursPerDayForCalendar(Collection empIDs, Collection activityIDs, TimeRange dateRange,
			boolean schedOrPending) throws Exception {
<span class="nc" id="L338">		JdmoPreparedStatementBuilder where = new JdmoPreparedStatementBuilder(&quot;(&quot;);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">		if (schedOrPending) {  //if true ; then get scheduled or used TOEvents only</span>
<span class="nc" id="L340">			where.add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID))</span>
<span class="nc" id="L341">					.add(&quot; IS NOT NULL &quot;);</span>
		} else {         // if false then get Pending TO Choices only
<span class="nc" id="L343">			where.add(&quot;(&quot;).add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID))</span>
<span class="nc" id="L344">					.add(&quot; is not NULL AND &quot;);</span>
<span class="nc" id="L345">			where.add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_TIMEOFFCHOICERANK)).add(&quot;=1 AND &quot;);</span>
<span class="nc" id="L346">			where.add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_STATUS)).add(&quot; in &quot;);</span>
<span class="nc" id="L347">			where.add(getInClauseTOPendingStatuses()).add(&quot;) AND &quot;);</span>
<span class="nc" id="L348">			where.add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_D_EXPIRYDATE)).add(&quot;&gt;'&quot;);</span>
<span class="nc" id="L349">			where.add(JdmoUtil.formatDBString(new Date())).add(&quot;' &quot;);</span>

		}
<span class="nc" id="L352">		where.add(&quot;) &quot;);</span>

<span class="nc" id="L354">		Collection&lt;TOHoursPerDay&gt; toHoursPerDays = getObjectsUsingPrepared(empIDs, activityIDs, dateRange, where);</span>
<span class="nc" id="L355">		return DAOUtil.groupByField(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_B_ISDIRTY, toHoursPerDays);</span>
	}

<span class="nc" id="L358">	private static String pendingStatusInClause = null;</span>

	private String getInClauseTOPendingStatuses() {
<span class="nc bnc" id="L361" title="All 2 branches missed.">		if (pendingStatusInClause == null) {</span>
<span class="nc" id="L362">			StringBuffer sbPendingClause = new StringBuffer();</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">			for (int i = 0; i &lt; TORequest.PENDING_HOUR_STATUSES.length; i++) {</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">				sbPendingClause.append((i == 0 ? &quot;(&quot; : &quot;,&quot;));</span>
<span class="nc" id="L365">				sbPendingClause.append(TOHoursPerDay.convertStatusToIntVal(TORequest.PENDING_HOUR_STATUSES[i]));</span>
			}
<span class="nc" id="L367">			sbPendingClause.append(&quot;)&quot;);</span>
<span class="nc" id="L368">			pendingStatusInClause = sbPendingClause.toString();</span>
		}
<span class="nc" id="L370">		return pendingStatusInClause;</span>
	}

	private void appendDateRangeClausePrepared(JdmoPreparedStatementBuilder where, TimeRange dateRange, String appendStr) {
<span class="nc" id="L374">		appendDateRangeClausePrepared(where, dateRange, appendStr, true);</span>
<span class="nc" id="L375">	}</span>

	// if overlap==true, then the ENDTIME clause uses &gt;=, otherwise strictly =
	private void appendDateRangeClausePrepared(JdmoPreparedStatementBuilder where, TimeRange dateRange, String appendStr, boolean overlap) {
<span class="nc bnc" id="L379" title="All 2 branches missed.">		if (dateRange == null) {</span>
<span class="nc" id="L380">			return;</span>
		}
<span class="nc bnc" id="L382" title="All 2 branches missed.">		if (appendStr != null) {</span>
<span class="nc" id="L383">			where.add(appendStr);</span>
		}
<span class="nc" id="L385">		where.add(&quot; STARTTIME &lt;= ?  AND &quot;, dateRange.getEndDate());</span>
<span class="nc" id="L386">		where.add(&quot; ENDTIME &gt;&quot;);</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">		if (overlap) {</span>
<span class="nc" id="L388">			where.add(&quot;=&quot;);</span>
		}
<span class="nc" id="L390">		where.add(&quot; ?&quot;, dateRange.getStartDate());</span>
<span class="nc" id="L391">	}</span>

	// return the requests spanning by date range
	//if StartDate !=null then  will return all requests that end after this date
	//if endDate !=null then will return all requests that start before this date.
	private void appendDateRangeClause(StringBuilder buf, TimeRange dateRange, String appendStr) {
<span class="nc" id="L397">		appendDateRangeClause(buf,dateRange,appendStr,true);</span>
<span class="nc" id="L398">	}</span>

	// if overlap==true, then the ENDTIME clause uses &gt;=, otherwise strictly =
	private void appendDateRangeClause(StringBuilder buf, TimeRange dateRange, String appendStr, boolean overlap) {
<span class="nc bnc" id="L402" title="All 2 branches missed.">		if (dateRange != null) {</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">			if (appendStr != null) {</span>
<span class="nc" id="L404">				buf.append(appendStr);</span>
			}
<span class="nc" id="L406">			buf.append(&quot; STARTTIME &lt;= '&quot;).append(JdmoUtil.formatDBString(dateRange.getEndDate())).append(&quot;' AND &quot;);</span>
<span class="nc" id="L407">			buf.append(&quot; ENDTIME &gt;&quot;);</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">			if (overlap) {</span>
<span class="nc" id="L409">				buf.append(&quot;=&quot;);</span>
			}
<span class="nc" id="L411">			buf.append(&quot; '&quot;).append(JdmoUtil.formatDBString(dateRange.getStartDate())).append(&quot;' &quot;);</span>
		}
<span class="nc" id="L413">	}</span>

	private static boolean validIds(Collection&lt;?&gt; ids) {
<span class="nc bnc" id="L416" title="All 4 branches missed.">		if (ids != null &amp;&amp; !ids.isEmpty()) {</span>
<span class="nc bnc" id="L417" title="All 4 branches missed.">			if (ids.size() == 1 &amp;&amp; ids.iterator().next() == null) {</span>
<span class="nc" id="L418">				return false;</span>
			}
<span class="nc" id="L420">			return true;</span>
		}
<span class="nc" id="L422">		return false;</span>
	}

	private void appendActivityIdsClause(StringBuilder buf, Collection activityIDs, String appendStr) throws Exception {
<span class="nc bnc" id="L426" title="All 2 branches missed.">		if (validIds(activityIDs)) {</span>

<span class="nc bnc" id="L428" title="All 2 branches missed.">			if (appendStr != null) {</span>
<span class="nc" id="L429">				buf.append(appendStr);</span>
			}
<span class="nc" id="L431">			buf.append(&quot; A.&quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_ACTIVITYID));</span>
<span class="nc" id="L432">			buf.append(&quot; in &quot;).append(m_dmo.createInClause(activityIDs));</span>
		}
<span class="nc" id="L434">	}</span>

	private void appendEmpIdsClause(StringBuilder buf, Collection empIDs, String appendStr) throws Exception {
<span class="nc bnc" id="L437" title="All 2 branches missed.">		if (validIds(empIDs)) {</span>

<span class="nc bnc" id="L439" title="All 2 branches missed.">			if (appendStr != null) {</span>
<span class="nc" id="L440">				buf.append(appendStr);</span>
			}
<span class="nc" id="L442">			buf.append(&quot; A.&quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_EMPLOYEEID));</span>
<span class="nc" id="L443">			buf.append(&quot; in &quot;).append(m_dmo.createInClause(empIDs));</span>
		}
<span class="nc" id="L445">	}</span>

	private void appendActivityIdsClausePrepared(JdmoPreparedStatementBuilder where, Collection activityIDs, String appendStr) {
<span class="nc bnc" id="L448" title="All 2 branches missed.">		if (validIds(activityIDs)) {</span>

<span class="nc bnc" id="L450" title="All 2 branches missed.">			if (appendStr != null) {</span>
<span class="nc" id="L451">				where.add(appendStr);</span>
			}
<span class="nc" id="L453">			where.add(&quot; A.&quot;).add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_ACTIVITYID));</span>
<span class="nc" id="L454">			where.add(&quot; in ? &quot;, activityIDs);</span>
		}
<span class="nc" id="L456">	}</span>

	private void appendEmpIdsClausePrepared(JdmoPreparedStatementBuilder where, Collection empIDs, String appendStr) {
<span class="nc bnc" id="L459" title="All 2 branches missed.">		if (validIds(empIDs)) {</span>

<span class="nc bnc" id="L461" title="All 2 branches missed.">			if (appendStr != null) {</span>
<span class="nc" id="L462">				where.add(appendStr);</span>
			}
<span class="nc" id="L464">			where.add(&quot; A.&quot;).add(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_EMPLOYEEID));</span>
<span class="nc" id="L465">			where.add(&quot; in ? &quot;, empIDs);</span>
		}
<span class="nc" id="L467">	}</span>

	public Collection getValidHoursPerDayForEmpIds(Collection empIDs, Collection activityIDs, TimeRange dateRange) throws Exception {
<span class="nc" id="L470">		JdmoPreparedStatementBuilder where = new JdmoPreparedStatementBuilder();</span>
<span class="nc" id="L471">		where.add(getValidHoursPerDayClause(false));</span>

<span class="nc bnc" id="L473" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled())</span>
<span class="nc" id="L474">			m_cat.debug(&quot;getHoursPerDayForEmpIds QRY= &quot; + where.toString());</span>
<span class="nc" id="L475">		return getObjectsUsingPrepared(empIDs, activityIDs, dateRange, where);</span>
	}




	private String getValidHoursPerDayClause(boolean addAnd) {
<span class="nc" id="L482">		StringBuilder validStatusClause = new StringBuilder();</span>

<span class="nc bnc" id="L484" title="All 2 branches missed.">		if (addAnd) {</span>
<span class="nc" id="L485">			validStatusClause.append(&quot; AND &quot;);</span>
		}

<span class="nc" id="L488">		validStatusClause.append(&quot; A.&quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_STATUS));</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">		for (int i = 0; i &lt; TORequest.PENDING_HOUR_STATUSES.length; i++) {</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">			validStatusClause.append((i == 0 ? &quot; IN (&quot; : &quot;,&quot;));</span>
<span class="nc" id="L491">			validStatusClause.append(TOHoursPerDay.convertStatusToIntVal(TORequest.PENDING_HOUR_STATUSES[i]));</span>
		}
<span class="nc" id="L493">		validStatusClause.append(&quot;,&quot;).append(TOHoursPerDay.convertStatusToIntVal(RequestAuditTrail.STATUS_APPROVED));</span>
<span class="nc" id="L494">		validStatusClause.append(&quot;,&quot;).append(TOHoursPerDay.convertStatusToIntVal(RequestAuditTrail.STATUS_DENIED));</span>
<span class="nc" id="L495">		validStatusClause.append(&quot;) &quot;);</span>
<span class="nc" id="L496">		return validStatusClause.toString();</span>
	}

	public Collection getHoursPerDayForEmpAfterGivenDate(ID empID, Collection activityIDs, Date pubDate, boolean activeOnly) throws Exception {
<span class="nc" id="L500">		StringBuilder buf = new StringBuilder(&quot; &quot;);</span>

<span class="nc" id="L502">		buf.append(&quot; ENDTIME &gt;= '&quot;).append(JdmoUtil.formatDBString(pubDate)).append(&quot;' &quot;);</span>
<span class="nc" id="L503">		appendActivityIdsClause(buf, activityIDs, &quot; AND &quot;);</span>
<span class="nc" id="L504">		appendEmpIdsClause(buf, Collections.singleton(empID), &quot; AND &quot;);</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getHoursPerDayForEmpAfterGivenDate QRY= &quot; + buf.toString());</span>
<span class="nc" id="L506">		return getObjects(buf.toString());</span>
	}

	public void refershTOEventsHavingFixedMinutes(HashMap toEventIDHrsPerDayMap) throws Exception {
		/*
		StringBuffer strSQL = new StringBuffer(&quot; SELECT ID, COUNTSMINSTOWARDSRULES from CALENDAREVENTASSIGNMENTPUB where ID in &quot;);
		strSQL.append(&quot; in &quot;).append(m_dmo.createInClause(toChoiceHrsPerDayMap.keySet()));
		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;refreshStatusForTOChoices QRY= &quot; + strSQL.toString());
		JdmoRowset rs = m_dmo.createRowset(strSQL.toString());
		while (rs.next()) {
			ID eventID = rs.getID(1);
			TOHoursPerDay hrsPerDay = (TOHoursPerDay) toChoiceHrsPerDayMap.get(eventID);
			hrsPerDay.setTotalMinutes(rs.getInt(2));
		}    */
<span class="nc" id="L520">	}</span>

	public Collection getAllDirtyTOHoursPerDay(Collection empIDs) throws Exception {
<span class="nc" id="L523">		StringBuilder buf = new StringBuilder(256);</span>
<span class="nc" id="L524">		buf.append(&quot; A.ISDIRTY = 1 &quot;);</span>
<span class="nc" id="L525">		appendEmpIdsClause(buf, empIDs, &quot; AND &quot;);</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getAllDirtyTOHoursPerDay QRY= &quot; + buf.toString());</span>
<span class="nc" id="L527">		return getObjects(buf.toString());</span>
	}

	public int getCountOfAllDirtyTOHoursPerDay() throws Exception {
<span class="nc" id="L531">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L532">		buf.append(&quot;Select Count(1)  &quot;);</span>
<span class="nc" id="L533">		appendFromWhereStatement(buf);</span>
<span class="nc" id="L534">		buf.append(&quot; WHERE A.ISDIRTY = 1 &quot;);</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getCountOfAllDirtyTOHoursPerDay QRY= &quot; + buf.toString());</span>
<span class="nc" id="L536">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc" id="L537">		int count = -1;</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L539">			count = rs.getInt(1);</span>
		}
<span class="nc" id="L541">		return count;</span>
	}


	public void insertLastPublishedDate(Collection&lt;ID&gt; empIDs, Jdmo jdmo) throws JdmoException {
<span class="nc bnc" id="L546" title="All 2 branches missed.">		if (jdmo == null) {</span>
<span class="nc" id="L547">			jdmo = m_dmo;</span>
		}
<span class="nc bnc" id="L549" title="All 4 branches missed.">		if (empIDs == null || empIDs.isEmpty()) {</span>
<span class="nc" id="L550">			return;</span>
		}
<span class="nc" id="L552">		Date date = new Date();</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">		for (ID empID : empIDs) {</span>
<span class="nc" id="L554">			jdmo.addBatch(&quot; INSERT INTO EMPLOYEELASTPUBDATE (ID,LASTPUBLISHEDDATE) VALUES (&quot; + empID.toInt() + &quot;,'&quot; + JdmoUtil.formatDBString(date) + &quot;')&quot;);</span>
<span class="nc" id="L555">		}</span>
<span class="nc" id="L556">		jdmo.executeBatch();</span>
<span class="nc" id="L557">	}</span>

	public void refreshLastPublishedDate(Collection&lt;ID&gt; empIDs) throws JdmoException {
<span class="nc" id="L560">		StringBuilder buf = new StringBuilder(256);</span>
<span class="nc" id="L561">		buf.append(&quot; UPDATE EMPLOYEELASTPUBDATE SET LASTPUBLISHEDDATE =  &quot;);</span>
<span class="nc" id="L562">		buf.append(&quot; (SELECT MAX(STARTTIME) LASTPUBLISHEDDATE FROM SHIFTASSIGNMENTPUB WHERE WORKRESOURCEID= EMPLOYEELASTPUBDATE.ID) &quot;);</span>
<span class="nc" id="L563">		buf.append(&quot; WHERE EMPLOYEELASTPUBDATE.ID IN (SELECT WORKRESOURCEID FROM SHIFTASSIGNMENTPUB WHERE &quot;);</span>
<span class="nc" id="L564">		buf.append(&quot; WORKRESOURCEID IN &quot;).append(m_dmo.createInClause(empIDs)).append(&quot;)&quot;);</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc" id="L566">			m_cat.debug(&quot;refreshLastPublishedDate QRY= &quot; + buf.toString());</span>
		}
<span class="nc" id="L568">		m_dmo.executeCommand(buf.toString());</span>
<span class="nc" id="L569">	}</span>

	public void lockEmployees(Collection empIDs) throws JdmoException {
<span class="nc" id="L572">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L573">		buf.append(&quot;UPDATE EMPLOYEELASTPUBDATE SET ID=ID WHERE ID IN &quot;).append(m_dmo.createInClause(empIDs));</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;lockEmployees QRY= &quot; + buf.toString());</span>
<span class="nc" id="L575">		m_dmo.executeCommand(buf.toString());</span>
<span class="nc" id="L576">	}</span>

	public Collection getHoursPerDayForEmpsBetweenLastPubDateAndGivenDate(Collection empIDs, Collection activityIDs, Date endDate) throws Exception {
<span class="nc" id="L579">		StringBuilder buf = new StringBuilder(256);</span>
		//insertLastPublishedDate(empIDs);
<span class="nc" id="L581">		buf.append(getSelectStatement());</span>
<span class="nc" id="L582">		appendFromWhereStatement(buf);</span>
<span class="nc" id="L583">		buf.append(&quot; , EMPLOYEELASTPUBDATE B &quot;);</span>
<span class="nc" id="L584">		buf.append(&quot;  WHERE ENDTIME &gt;=  B.LASTPUBLISHEDDATE  AND B.ID = A.&quot;);</span>
<span class="nc" id="L585">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_EMPLOYEEID));</span>
<span class="nc" id="L586">		appendActivityIdsClause(buf, activityIDs, &quot; AND &quot;);</span>
<span class="nc" id="L587">		appendEmpIdsClause(buf, empIDs, &quot; AND &quot;);</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">		if (endDate != null) {</span>
<span class="nc" id="L589">			buf.append(&quot; AND &quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_D_STARTTIME));</span>
<span class="nc" id="L590">			buf.append(&quot;&lt;= '&quot;).append(JdmoUtil.formatDBString(endDate)).append(&quot;' &quot;);</span>
		}
<span class="nc" id="L592">		buf.append(getValidHoursPerDayClause(true));</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getHoursPerDayForEmpsBetweenLastPubDateAndGivenDate QRY= &quot; + buf.toString());</span>
<span class="nc" id="L594">		return getObjectsFromFullSqlQuery(buf.toString());</span>
	}

	public Collection getValidHoursPerDayForDateRangeOnlyAfterLastPubDate(Collection empIDs, Collection activityIDs, TimeRange dateRange) throws Exception {

<span class="nc" id="L599">		StringBuilder buf = new StringBuilder(256);</span>
<span class="nc" id="L600">		buf.append(getSelectStatement());</span>
<span class="nc" id="L601">		appendFromWhereStatement(buf);</span>
<span class="nc" id="L602">		buf.append(&quot; , EMPLOYEELASTPUBDATE B &quot;);</span>
		//STARTTIME &gt;=  B.LASTPUBLISHEDDATE was added just so that the query can use an index
<span class="nc" id="L604">		buf.append(&quot;  WHERE  STARTTIME &gt;=  B.LASTPUBLISHEDDATE AND  ENDTIME &gt;=  B.LASTPUBLISHEDDATE  AND B.ID = A.&quot;);</span>
<span class="nc" id="L605">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_EMPLOYEEID));</span>
<span class="nc" id="L606">		appendActivityIdsClause(buf, activityIDs, &quot; AND &quot;);</span>
<span class="nc" id="L607">		appendEmpIdsClause(buf, empIDs, &quot; AND &quot;);</span>
<span class="nc" id="L608">		buf.append(getValidHoursPerDayClause(true));</span>
<span class="nc" id="L609">		appendDateRangeClause(buf, dateRange, &quot; AND &quot;);</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc" id="L611">			m_cat.debug(&quot;getValidHoursPerDayForDateRangeOnlyAfterLastPubDate QRY= &quot; + buf.toString());</span>
		}
<span class="nc" id="L613">		return getObjectsFromFullSqlQuery(buf.toString());</span>
	}

	private Collection getObjectsFromFullSqlQuery(String strSql) throws BbmFinderException {
<span class="nc" id="L617">		ArrayList arrItems = new ArrayList();</span>
		try {
<span class="nc" id="L619">			JdmoRowset rs = m_dmo.createRowset(strSql);</span>
<span class="nc" id="L620">			long lCount = m_lRecords;</span>
<span class="nc bnc" id="L621" title="All 4 branches missed.">			while (rs.next() &amp;&amp; (lCount != 0)) {</span>
<span class="nc" id="L622">				ValueObjectBase item = readObjectFromDB(rs);</span>
<span class="nc" id="L623">				arrItems.add(item);</span>
<span class="nc" id="L624">				lCount--;</span>
<span class="nc" id="L625">			}</span>
<span class="nc" id="L626">		} catch (Exception e) {</span>
<span class="nc" id="L627">			throw new BbmFinderException(e);</span>
<span class="nc" id="L628">		}</span>
<span class="nc" id="L629">		return arrItems;</span>
	}

	public void deleteTOHoursPerDayOnUnPublish(Collection empIDs, Date startDate, Date endDate) throws JdmoException {
<span class="nc" id="L633">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L634">		buf.append(&quot; DELETE FROM TIMEOFFHOURSPERDAY WHERE TIMEOFFEVENTID IS NOT NULL AND &quot;);</span>
<span class="nc" id="L635">		buf.append(&quot; STARTTIME &lt; '&quot;).append(JdmoUtil.formatDBString(endDate)).append(&quot;' AND &quot;);</span>
<span class="nc" id="L636">		buf.append(&quot; ENDTIME &gt; '&quot;).append(JdmoUtil.formatDBString(startDate)).append(&quot;' AND &quot;);</span>
<span class="nc" id="L637">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_EMPLOYEEID));</span>
<span class="nc" id="L638">		buf.append(&quot; in &quot;).append(m_dmo.createInClause(empIDs));</span>
<span class="nc" id="L639">		buf.append(&quot; AND NOT EXISTS (SELECT ID FROM CALENDAREVENTATTENDEEPUB &quot;);</span>
<span class="nc" id="L640">		buf.append(&quot; WHERE WORKRESOURCEID=EMPLOYEEID AND	CALENDAREVENTASSIGNMENTID= TIMEOFFEVENTID) &quot;);</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;deleteTOHoursPerDayOnUnPublish QRY= &quot; + buf.toString());</span>
<span class="nc" id="L642">		m_dmo.executeCommand(buf.toString());</span>
<span class="nc" id="L643">	}</span>

	public boolean checkHealth() throws JdmoException {
<span class="nc" id="L646">		boolean retVal = true;</span>
<span class="nc" id="L647">		StringBuffer buf = new StringBuffer(1024);</span>
<span class="nc" id="L648">		buf.append(&quot; SELECT 'ORPHANED TO-EVENTS, Need to be DELETED' REASON,COUNT(*) COUNT    FROM TIMEOFFHOURSPERDAY  &quot;);</span>
<span class="nc" id="L649">		buf.append(&quot; WHERE TIMEOFFEVENTID IS NOT NULL AND &quot;);</span>
<span class="nc" id="L650">		buf.append(&quot; NOT EXISTS (SELECT ID FROM CALENDAREVENTATTENDEEPUB  &quot;);</span>
<span class="nc" id="L651">		buf.append(&quot; WHERE WORKRESOURCEID=EMPLOYEEID AND CALENDAREVENTASSIGNMENTID= TIMEOFFEVENTID) &quot;);</span>
<span class="nc" id="L652">		buf.append(&quot; UNION &quot;);</span>
<span class="nc" id="L653">		buf.append(&quot; SELECT  'ORPHANED TO-CHOICES, Need to be DELETED' REASON,  COUNT(*) COUNT FROM TIMEOFFHOURSPERDAY  &quot;);</span>
<span class="nc" id="L654">		buf.append(&quot; WHERE TIMEOFFCHOICEID IS NOT NULL AND &quot;);</span>
<span class="nc" id="L655">		buf.append(&quot; NOT EXISTS (SELECT ID from TIMEOFFREQUESTCHOICE C where C.id= TIMEOFFCHOICEID) &quot;);</span>
<span class="nc" id="L656">		buf.append(&quot; UNION &quot;);</span>
<span class="nc" id="L657">		buf.append(&quot; SELECT  'INVALID ROWS, Need to be DELETED' REASON,  COUNT(*) COUNT FROM TIMEOFFHOURSPERDAY  &quot;);</span>
<span class="nc" id="L658">		buf.append(&quot; WHERE (TIMEOFFCHOICEID IS  NULL and TIMEOFFEVENTID is null) OR ( TIMEOFFCHOICEID IS  NOT NULL and TIMEOFFEVENTID is NOT null) &quot;);</span>
<span class="nc" id="L659">		buf.append(&quot; UNION &quot;);</span>
<span class="nc" id="L660">		buf.append(&quot; SELECT  'MISSING TO-EVENTS, Need to be ADDED' REASON,  COUNT(*) COUNT FROM CALENDAREVENTATTENDEEPUB A,CALENDAREVENTASSIGNMENTPUB P  &quot;);</span>
<span class="nc" id="L661">		buf.append(&quot; WHERE P.EVENTTYPE=512 AND P.ID= A.CALENDAREVENTASSIGNMENTID AND &quot;);</span>
<span class="nc" id="L662">		buf.append(&quot; NOT EXISTS (SELECT ID FROM TIMEOFFHOURSPERDAY WHERE EMPLOYEEID=WORKRESOURCEID AND	CALENDAREVENTASSIGNMENTID= TIMEOFFEVENTID) &quot;);</span>
<span class="nc" id="L663">		buf.append(&quot; UNION &quot;);</span>
<span class="nc" id="L664">		buf.append(&quot; select  'MISSING TO-CHOICES, Need to be ADDED' REASON,  COUNT(*) COUNT from TIMEOFFREQUESTCHOICE c &quot;);</span>
<span class="nc" id="L665">		buf.append(&quot; where NOT EXISTS (SELECT ID FROM TIMEOFFHOURSPERDAY WHERE TIMEOFFCHOICEID = c.id)  &quot;);</span>
<span class="nc" id="L666">		buf.append(&quot; UNION SELECT 'MISSING Entries in last pub date, Need to be ADDED' REASON,  COUNT(*) COUNT FROM EMPLOYEEAM &quot;);</span>
<span class="nc" id="L667">		buf.append(&quot; WHERE not EXISTS (SELECT ID FROM EMPLOYEELASTPUBDATE WHERE EMPLOYEELASTPUBDATE.ID=EMPLOYEEAM.ID) &quot;);</span>
<span class="nc" id="L668">		buf.append(&quot; UNION &quot;);</span>
<span class="nc" id="L669">		buf.append(&quot; SELECT 'DUPLICATE TOEVENTS  , Need to be Deleted', COUNT(*) COUNT FROM TIMEOFFHOURSPERDAY WHERE TIMEOFFEVENTID IN  &quot;);</span>
<span class="nc" id="L670">		buf.append(&quot; (SELECT TIMEOFFEVENTID 	FROM TIMEOFFHOURSPERDAY WHERE TIMEOFFEVENTID IS NOT NULL  &quot;);</span>
<span class="nc" id="L671">		buf.append(&quot; GROUP BY TIMEOFFEVENTID ,EMPLOYEEID HAVING COUNT(*) &gt;1 	) &quot;);</span>
<span class="nc" id="L672">		buf.append(&quot; UNION  &quot;);</span>
<span class="nc" id="L673">		buf.append(&quot; SELECT 'DUPLICATE TOCHOICES, Need to be Deleted', COUNT(*) COUNT FROM TIMEOFFHOURSPERDAY WHERE TIMEOFFCHOICEID IN  &quot;);</span>
<span class="nc" id="L674">		buf.append(&quot; (SELECT TIMEOFFCHOICEID 	FROM TIMEOFFHOURSPERDAY WHERE TIMEOFFCHOICEID IS NOT NULL  &quot;);</span>
<span class="nc" id="L675">		buf.append(&quot; GROUP BY TIMEOFFCHOICEID ,EMPLOYEEID HAVING COUNT(*) &gt;1 	) &quot;);</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;checkHealth QRY= &quot; + buf.toString());</span>
<span class="nc" id="L677">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc" id="L678">		StringBuffer sb = new StringBuffer();</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L680">			int intVal = rs.getInt(2);</span>
<span class="nc" id="L681">			sb.append(&quot;\n&quot; + rs.getString(1) + &quot;\t = &quot; + intVal);</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">			if (intVal &gt; 0) {</span>
<span class="nc" id="L683">				retVal = false;</span>
			}
<span class="nc" id="L685">		}</span>
<span class="nc" id="L686">		m_cat.info(&quot;Check Health Status=&quot; + retVal + &quot; : TOHoursPerDay=&quot; + sb.toString());</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;Check Health Status=&quot; + retVal + &quot; : TOHoursPerDay=&quot; + sb.toString());</span>
<span class="nc" id="L688">		return retVal;</span>
	}

	public Collection refreshStatusForTOChoices(Collection toHrsPerDayCol) throws JdmoException {
<span class="nc" id="L692">		HashMap toChoiceHrsPerDayMap = ValueObjectUtil.getFieldObjectMap(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID, toHrsPerDayCol);</span>
<span class="nc bnc" id="L693" title="All 4 branches missed.">		if (toChoiceHrsPerDayMap == null || toChoiceHrsPerDayMap.isEmpty()) {</span>
<span class="nc" id="L694">			return toHrsPerDayCol;// nothing to update here return back</span>
		}
<span class="nc" id="L696">		StringBuffer strSQL = new StringBuffer();</span>
<span class="nc" id="L697">		strSQL.append(&quot;SELECT C.ID,R.REQUESTSTATUS FROM REQUEST R, TIMEOFFREQUESTCHOICE C WHERE R.ID=C.TIMEOFFREQUESTID and C.ID  in  &quot;);</span>
<span class="nc" id="L698">		strSQL.append(m_dmo.createInClause(toChoiceHrsPerDayMap.keySet()));</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;refreshStatusForTOChoices QRY= &quot; + strSQL.toString());</span>
<span class="nc" id="L700">		JdmoRowset rs = m_dmo.createRowset(strSQL.toString());</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L702">			ID choiceID = rs.getID(1);</span>
<span class="nc" id="L703">			TOHoursPerDay hrsPerDay = (TOHoursPerDay) toChoiceHrsPerDayMap.get(choiceID);</span>
<span class="nc" id="L704">			String status = rs.getString(2);</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">			if (!hrsPerDay.getStatus().equals(status)) {</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">				if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;chaning status for choiceid= &quot; + choiceID + &quot; : hrsPerDay Status=&quot; + hrsPerDay.getStatus() + &quot;: orig status=&quot; + status);</span>
<span class="nc" id="L707">				hrsPerDay.setStatus(status);</span>
			}
<span class="nc" id="L709">		}</span>
<span class="nc" id="L710">		return toHrsPerDayCol;</span>
	}

	//Pass True for Schedule &amp; false for Pending
	public void getHoursPerDayContainedInDateRange(HashMap activitySummaryMap, ID empID, Date startDate, Date endDate, boolean schedOrPending) throws Exception {
<span class="nc" id="L715">		StringBuilder buf = new StringBuilder(&quot;SELECT ACTIVITYID , SUM(TOTALMINUTES) TOTAL_MINUTES FROM &quot;)</span>
<span class="nc" id="L716">				.append(m_fieldInfo.getTableName()).append(&quot; (&quot;);</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">		if (schedOrPending) {  //if true ; then get scheduled or used TOEvents only</span>
<span class="nc" id="L718">			buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID)).append(&quot; IS NOT NULL &quot;);</span>
		} else {         // if false then get Pending TO Choices only
<span class="nc" id="L720">			buf.append(&quot;(&quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID)).append(&quot; is not NULL AND &quot;);</span>
<span class="nc" id="L721">			buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_TIMEOFFCHOICERANK)).append(&quot;=1 AND &quot;);</span>
<span class="nc" id="L722">			buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_STATUS)).append(&quot; in &quot;);</span>
<span class="nc" id="L723">			buf.append(getInClauseTOPendingStatuses()).append(&quot;) AND &quot;);</span>
<span class="nc" id="L724">			buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_D_EXPIRYDATE)).append(&quot;&gt;'&quot;);</span>
<span class="nc" id="L725">			buf.append(JdmoUtil.formatDBString(new Date())).append(&quot;' &quot;);</span>
		}
<span class="nc" id="L727">		buf.append(&quot;) AND&quot;);</span>
<span class="nc" id="L728">		buf.append(&quot; STARTTIME &gt;= '&quot;).append(JdmoUtil.formatDBString(startDate)).append(&quot;' AND &quot;);</span>
<span class="nc" id="L729">		buf.append(&quot; ENDTIME &lt;= '&quot;).append(JdmoUtil.formatDBString(endDate)).append(&quot;' &quot;);</span>
<span class="nc" id="L730">		appendActivityIdsClause(buf, activitySummaryMap.values(), &quot; AND &quot;);</span>
<span class="nc" id="L731">		appendEmpIdsClause(buf, Collections.singleton(empID), &quot; AND &quot;);</span>
<span class="nc" id="L732">		buf.append(&quot;GROUP BY &quot;).append(&quot; A.&quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_ACTIVITYID));</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;getHoursPerDayForCalendar QRY= &quot; + buf.toString());</span>
<span class="nc" id="L734">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L736">			ID activityID = rs.getID(1);</span>
<span class="nc" id="L737">			TimeOffActivitySummary activitySummary = (TimeOffActivitySummary) activitySummaryMap.get(activityID);</span>
<span class="nc" id="L738">			float hours = (float) (rs.getDouble(2) / 60f);</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">			if (schedOrPending) {</span>
<span class="nc" id="L740">				activitySummary.setScheduled(hours);</span>
			} else {
<span class="nc" id="L742">				activitySummary.setPending(hours);</span>
			}
<span class="nc" id="L744">		}</span>
<span class="nc" id="L745">	}</span>

	public void updateStatusAndRankForTOChoices(Collection toHrsPerDayList) {

<span class="nc" id="L749">	}</span>

	public boolean isLastPublishedDateChanged(Collection empIDs) throws Exception {
<span class="nc" id="L752">		StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L753">		buf.append(&quot;  SELECT count(1) FROM EMPLOYEELASTPUBDATE P,  &quot;);</span>
<span class="nc" id="L754">		buf.append(&quot;  (SELECT MAX(STARTTIME) LASTPUBDATE,WORKRESOURCEID WORKRESOURCEID &quot;);</span>
<span class="nc" id="L755">		buf.append(&quot;  FROM SHIFTASSIGNMENTPUB WHERE WORKRESOURCEID IN &quot;).append(m_dmo.createInClause(empIDs));</span>
<span class="nc" id="L756">		buf.append(&quot; group by WORKRESOURCEID)A  &quot;);</span>
<span class="nc" id="L757">		buf.append(&quot;  WHERE P.ID = A.WORKRESOURCEID AND P.LASTPUBLISHEDDATE != A.LASTPUBDATE &quot;);</span>
<span class="nc" id="L758">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc" id="L759">		int count = -1;</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L761">			count = rs.getInt(1);</span>
		}
<span class="nc bnc" id="L763" title="All 2 branches missed.">		boolean result = count &gt; 0;</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;isLastPublishedDateChanged result=&quot; + result + &quot; :QRY= &quot; + buf.toString());</span>
<span class="nc" id="L765">		return result;  //return true if rows changed is more than 0;</span>
	}

	public TimeRange findMinMaxTimeRangeOfApprovedTOEvents(ID empID, Collection activityIDs, TimeRange dateRange) throws Exception {
<span class="nc" id="L769">		StringBuilder buf = new StringBuilder(256);</span>
<span class="nc" id="L770">		buf.append(&quot; SELECT MIN(STARTTIME), MAX(ENDTIME) FROM &quot;);</span>
<span class="nc" id="L771">		buf.append(getFieldInfo().getTableName()).append(&quot; A WHERE &quot;);</span>
<span class="nc" id="L772">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID)).append(&quot; IS NOT NULL &quot;);</span>
<span class="nc" id="L773">		appendDateRangeClause(buf, dateRange, &quot; AND &quot;);</span>
<span class="nc" id="L774">		appendActivityIdsClause(buf, activityIDs, &quot; AND &quot;);</span>
<span class="nc" id="L775">		appendEmpIdsClause(buf, Collections.singleton(empID), &quot; AND &quot;);</span>
<span class="nc" id="L776">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc" id="L777">		TimeRange range = null;</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L779">			Date startDate = rs.getTimestamp(1);</span>
<span class="nc" id="L780">			Date endDate = rs.getTimestamp(2);</span>
<span class="nc bnc" id="L781" title="All 4 branches missed.">			if (startDate != null &amp;&amp; endDate != null) {</span>
<span class="nc" id="L782">				range = new TimeRange(startDate, endDate);</span>
			}
		}
<span class="nc" id="L785">		return range;</span>
	}

	public boolean checkIfNewTOEventsAreCommited(Collection eventIDs) throws Exception {
<span class="nc" id="L789">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L790">		buf.append(&quot; select count(ID) from CALENDAREVENTASSIGNMENTPUB where ID &quot;).append(&quot; in &quot;).append(m_dmo.createInClause(eventIDs));</span>
<span class="nc" id="L791">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc" id="L792">		int eventsInDB = -1;</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L794">			eventsInDB = rs.getInt(1);</span>
		}
<span class="nc bnc" id="L796" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) m_cat.debug(&quot;checkIfNewTOEventsAreCommited eventsInDB=&quot; + eventsInDB + &quot; :eventIDs= &quot; + eventIDs.size() + &quot; QRY=&quot; + buf.toString());</span>
<span class="nc bnc" id="L797" title="All 6 branches missed.">		return (eventIDs != null &amp;&amp; !eventIDs.isEmpty() &amp;&amp; eventsInDB == eventIDs.size());</span>
	}

	/**
	 * Returns (CALENDAREVENTASSIGNMENTID,WORKRESOURCEID) pairs for Time Off events that exists in published calendar events assignments,
	 * but  are missing from  TIMEOFFHOURSPERDAY
	 * 
	 * @return
	 * 	Return missing (CALENDAREVENTASSIGNMENTID,WORKRESOURCEID) pairs 
	 */
	public Collection&lt;IDPair&gt; getMissingTOEventsToBeSynced() throws Exception {
<span class="nc" id="L808">		List&lt;IDPair&gt; arrItems = new ArrayList&lt;IDPair&gt;();</span>
<span class="nc" id="L809">		StringBuilder buf = new StringBuilder();</span>
<span class="nc" id="L810">		buf.append(&quot; SELECT CALENDAREVENTASSIGNMENTID,WORKRESOURCEID &quot;);</span>
<span class="nc" id="L811">		buf.append(&quot; FROM CALENDAREVENTATTENDEEPUB A,CALENDAREVENTASSIGNMENTPUB P &quot;);</span>
<span class="nc" id="L812">		buf.append(&quot; WHERE P.EVENTTYPE=512 AND P.ID= A.CALENDAREVENTASSIGNMENTID AND &quot;);</span>
<span class="nc" id="L813">		buf.append(&quot; NOT EXISTS (SELECT ID FROM TIMEOFFHOURSPERDAY &quot;);</span>
<span class="nc" id="L814">		buf.append(&quot; WHERE EMPLOYEEID=WORKRESOURCEID AND CALENDAREVENTASSIGNMENTID= TIMEOFFEVENTID)&quot;);</span>
<span class="nc" id="L815">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc bnc" id="L816" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L817">			arrItems.add(new IDPair(rs.getID(&quot;CALENDAREVENTASSIGNMENTID&quot;), rs.getID(&quot;WORKRESOURCEID&quot;)));</span>
		}
<span class="nc" id="L819">		return arrItems;</span>
	}

	/**
	 * @return
	 * List of employee IDs which are missing from EMPLOYEELASTPUBDATE
	 */
	public List&lt;ID&gt; getMissingEntriesInLastPubDate() throws Exception {
<span class="nc" id="L827">		List&lt;ID&gt; arrItems = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L828">		StringBuilder buf = new StringBuilder(256);</span>
<span class="nc" id="L829">		buf.append(&quot; SELECT ID FROM EMPLOYEEAM WHERE NOT EXISTS ( SELECT ID &quot;);</span>
<span class="nc" id="L830">		buf.append(&quot; FROM EMPLOYEELASTPUBDATE WHERE EMPLOYEELASTPUBDATE.ID=EMPLOYEEAM.ID) &quot;);</span>
<span class="nc" id="L831">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L833">			arrItems.add(rs.getID(&quot;ID&quot;));</span>
		}
<span class="nc" id="L835">		return arrItems;</span>
	}

	private String createTempTableToQueryTOHrPerDayForRange(Jdmo dmo, Map empIDStDateMap, Map empIDEnDateMap)
	        throws JdmoException, Exception {
		//create temp table to hold workresource, start and end, later it will join with event tables to get the events
<span class="nc" id="L841">		StringBuffer strSQL = new StringBuffer();</span>
<span class="nc" id="L842">		String strTableName = &quot;EMPTOHOURSPERDAYDATERANGE&quot;;</span>
<span class="nc" id="L843">		String strNativeTempName = dmo.getNativeTemptableName(strTableName);</span>

		// drop temp table just in case
		try {
<span class="nc" id="L847">			dmo.dropTempTable(strTableName);</span>
<span class="nc" id="L848">		} catch (Exception e) {</span>
			// do nothing
<span class="nc" id="L850">		}</span>
<span class="nc" id="L851">		strSQL.append(strNativeTempName);</span>
<span class="nc" id="L852">		strSQL.append(&quot; (EMPLOYEEID int, STARTTIME DATETIME , ENDTIME DATETIME )&quot;);</span>
<span class="nc" id="L853">		dmo.createTempTable(strSQL.toString());</span>

<span class="nc" id="L855">		JdmoPCommand pc = dmo.createPCommand(&quot;insert into &quot; + strNativeTempName + &quot; values (?,?,?)&quot;);</span>
<span class="nc" id="L856">		HashMap param = new HashMap();</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">		for (Iterator iter = empIDStDateMap.keySet().iterator(); iter.hasNext();) {</span>
<span class="nc" id="L858">			ID empId = (ID) iter.next();</span>
<span class="nc" id="L859">			param.clear();</span>
<span class="nc" id="L860">			param.put(new Integer(1), new Integer(empId.toInt()));</span>
<span class="nc" id="L861">			param.put(new Integer(2), ((Calendar) empIDStDateMap.get(empId)).getTime());</span>
<span class="nc" id="L862">			param.put(new Integer(3), ((Calendar) empIDEnDateMap.get(empId)).getTime());</span>
<span class="nc" id="L863">			pc.setParams(param);</span>
<span class="nc" id="L864">			pc.addBatch();</span>
<span class="nc" id="L865">		}</span>
<span class="nc" id="L866">		dmo.executeBatchPCommand(pc);</span>
<span class="nc" id="L867">		return strNativeTempName;</span>
	}

	public Map&lt;Boolean, List&lt;TOHoursPerDay&gt;&gt; getHoursPerDayForRange(Map empStDateMap, Map empEnDateMap, Collection activityIDs)
			throws Exception {
<span class="nc bnc" id="L872" title="All 8 branches missed.">		if (empStDateMap == null || empStDateMap.isEmpty() || empEnDateMap == null || empEnDateMap.isEmpty()) {</span>
<span class="nc" id="L873">			m_cat.debug(&quot;one of  the Maps is empty&quot;);</span>
<span class="nc" id="L874">			return Collections.emptyMap();</span>
		}
<span class="nc" id="L876">		StringBuilder buf = new StringBuilder(getSelectStatement());</span>
<span class="nc" id="L877">		appendFromWhereStatement(buf);</span>
<span class="nc bnc" id="L878" title="All 4 branches missed.">		if (empStDateMap != null &amp;&amp; empStDateMap.size() &gt; 1) {</span>
<span class="nc" id="L879">			String tmpTable = createTempTableToQueryTOHrPerDayForRange(getDMO(), empStDateMap, empEnDateMap);</span>
<span class="nc" id="L880">			buf.append(&quot;, &quot;).append(tmpTable).append(&quot; C WHERE &quot;);</span>
<span class="nc" id="L881">			buf.append(&quot;  A.STARTTIME &lt;= C.ENDTIME AND A.ENDTIME &gt; C.STARTTIME AND A.EMPLOYEEID = C.EMPLOYEEID &quot;);</span>
<span class="nc" id="L882">		} else {</span>
<span class="nc" id="L883">			TimeRange dateRange = new TimeRange(((Calendar) empStDateMap.values().iterator().next()).getTime(),</span>
<span class="nc" id="L884">			        ((Calendar) empEnDateMap.values().iterator().next()).getTime());</span>
<span class="nc" id="L885">			appendDateRangeClause(buf, dateRange, &quot; WHERE &quot;, false);</span>
<span class="nc" id="L886">			appendEmpIdsClause(buf, empStDateMap.keySet(), &quot; AND &quot;);</span>
		}
<span class="nc" id="L888">		buf.append(&quot;AND ( &quot;);</span>
<span class="nc" id="L889">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFEVENTID)).append(&quot; IS NOT NULL &quot;);</span>
		// pending clause
<span class="nc" id="L891">		buf.append(&quot;OR (&quot;).append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_I_TIMEOFFCHOICEID)).append(&quot; is not NULL AND &quot;);</span>
<span class="nc" id="L892">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_TIMEOFFCHOICERANK)).append(&quot;=1 AND &quot;);</span>
<span class="nc" id="L893">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_N_STATUS)).append(&quot; in &quot;);</span>
<span class="nc" id="L894">		buf.append(getInClauseTOPendingStatuses()).append(&quot; AND &quot;);</span>
<span class="nc" id="L895">		buf.append(TOHoursPerDayFieldInfo.getColumnName(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_D_EXPIRYDATE)).append(&quot;&gt;'&quot;);</span>
<span class="nc" id="L896">		buf.append(JdmoUtil.formatDBString(new Date())).append(&quot;')) &quot;);</span>
<span class="nc" id="L897">		appendActivityIdsClause(buf, activityIDs, &quot; AND &quot;);</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc" id="L899">			m_cat.debug(&quot;getHoursPerDayForCalendar QRY= &quot; + buf.toString());</span>
		}
<span class="nc" id="L901">		return DAOUtil.groupByField(TOHoursPerDayFieldInfo.TIMEOFFHOURSPERDAY_B_ISDIRTY, getObjectsFromFullSqlQuery(buf.toString()));</span>
	}

	private void appendFromWhereStatement(StringBuilder buf) {
		//Temp hack till foundation fixes DAOBase to take StringBuilder instead of StringBuffer
<span class="nc" id="L906">		StringBuffer temp = new StringBuffer(); //NOSONAR</span>
<span class="nc" id="L907">		appendFromWhereStatement(temp);</span>
<span class="nc" id="L908">		buf.append(temp);</span>
<span class="nc" id="L909">	}</span>

	public void insertOrUpdateObjects(Collection toHoursPerDayToIns) throws Exception {
<span class="nc" id="L912">		Collection toHoursPerDayToUpdate = new ArrayList();</span>
<span class="nc" id="L913">		StringBuffer buf = new StringBuffer(256);</span>
<span class="nc" id="L914">		HashMap hrsPerDayMap = new HashMap();</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">		for (Iterator iterator = toHoursPerDayToIns.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L916">			TOHoursPerDay hoursPerDay = (TOHoursPerDay) iterator.next();</span>
<span class="nc" id="L917">			hrsPerDayMap.put(hoursPerDay.getUniqueKey(), hoursPerDay);</span>
<span class="nc" id="L918">		}</span>
<span class="nc" id="L919">		buf.append(&quot; SELECT H.ID, CAST(ISNULL( H.EMPLOYEEID,0) AS VARCHAR(15))+'_' + &quot;);</span>
<span class="nc" id="L920">		buf.append(&quot; CAST (ISNULL(H.TIMEOFFEVENTID,0)AS VARCHAR(15))+'_'+&quot;);</span>
<span class="nc" id="L921">		buf.append(&quot; CAST ( ISNULL(H.TIMEOFFCHOICEID,0)AS VARCHAR(15)) UNIQ_KEY FROM &quot;);</span>
<span class="nc" id="L922">		buf.append(createTempTableTOCheckForUniqueKey(toHoursPerDayToIns));</span>
<span class="nc" id="L923">		buf.append(&quot; T, TIMEOFFHOURSPERDAY H WHERE T.EMPLOYEEID= H.EMPLOYEEID &quot;);</span>
<span class="nc" id="L924">		buf.append(&quot; AND ISNULL(T.TIMEOFFEVENTID,0)= ISNULL(H.TIMEOFFEVENTID,0) &quot;);</span>
<span class="nc" id="L925">		buf.append(&quot; AND ISNULL(T.TIMEOFFCHOICEID,0)=ISNULL(H.TIMEOFFCHOICEID,0)&quot;);</span>
<span class="nc" id="L926">		JdmoRowset rs = m_dmo.createRowset(buf.toString());</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L928">			TOHoursPerDay hoursPerDay = (TOHoursPerDay) hrsPerDayMap.remove(rs.getString(&quot;UNIQ_KEY&quot;));</span>
<span class="nc" id="L929">			hoursPerDay.setID(rs.getID(&quot;ID&quot;));</span>
<span class="nc" id="L930">			toHoursPerDayToUpdate.add(hoursPerDay);</span>
<span class="nc" id="L931">		}</span>
<span class="nc bnc" id="L932" title="All 4 branches missed.">		if (toHoursPerDayToUpdate != null &amp;&amp; !toHoursPerDayToUpdate.isEmpty()) {</span>
<span class="nc" id="L933">			updateObjects(toHoursPerDayToUpdate);</span>
		}
<span class="nc bnc" id="L935" title="All 4 branches missed.">		if (hrsPerDayMap != null &amp;&amp; !hrsPerDayMap.values().isEmpty()) {</span>
<span class="nc" id="L936">			createObjects(hrsPerDayMap.values());</span>
		}
<span class="nc" id="L938">	}</span>

	private String createTempTableTOCheckForUniqueKey(Collection toHoursPerDayToIns) throws JdmoException, Exception {
		//create temp table to hold workresource, start and end, later it will join with event tables to get the events
<span class="nc" id="L942">		StringBuffer strSQL = new StringBuffer();</span>
<span class="nc" id="L943">		String strTableName = &quot;NEWTOHOURSPERDAY&quot;;</span>
<span class="nc" id="L944">		Jdmo dmo = getDMO();</span>
<span class="nc" id="L945">		String strNativeTempName = dmo.getNativeTemptableName(strTableName);</span>
		// drop temp table just in case
		try {
<span class="nc" id="L948">			dmo.dropTempTable(strTableName);</span>
<span class="nc" id="L949">		} catch (Exception e) {}</span>
<span class="nc" id="L950">		strSQL.append(strNativeTempName);</span>
<span class="nc" id="L951">		strSQL.append(&quot; (EMPLOYEEID int, TIMEOFFEVENTID INT , TIMEOFFCHOICEID INT )&quot;);</span>
<span class="nc" id="L952">		dmo.createTempTable(strSQL.toString());</span>

<span class="nc" id="L954">		JdmoPCommand pc = dmo.createPCommand(&quot;insert into &quot; + strNativeTempName + &quot; values (?,?,?)&quot;);</span>
<span class="nc" id="L955">		HashMap param = new HashMap();</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">		for (Iterator iterator = toHoursPerDayToIns.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L957">			TOHoursPerDay hoursPerDay = (TOHoursPerDay) iterator.next();</span>
<span class="nc" id="L958">			param.clear();</span>
<span class="nc" id="L959">			param.put(new Integer(1), new Integer(hoursPerDay.getEmployeeID().toInt()));</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">			param.put(new Integer(2), new Integer(hoursPerDay.getTOEventID() != null ? hoursPerDay.getTOEventID().toInt() : 0));</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">			param.put(new Integer(3), new Integer(hoursPerDay.getTOChoiceID() != null ? hoursPerDay.getTOChoiceID().toInt() : 0));</span>
<span class="nc" id="L962">			pc.setParams(param);</span>
<span class="nc" id="L963">			pc.addBatch();</span>
<span class="nc" id="L964">		}</span>
<span class="nc" id="L965">		dmo.executeBatchPCommand(pc);</span>
<span class="nc" id="L966">		return strNativeTempName;</span>
	}

	//Returns a list of (RequestID, TOHoursPerDay) for the given employees that use the given pool in the given date interval
	public List&lt;Pair&lt;ID, TOHoursPerDay&gt;&gt; getOrderedTOWaitlists(TOPool pool, Collection&lt;ID&gt; empIds, Date stDate, Date enDate)
			throws Exception {

<span class="nc bnc" id="L973" title="All 4 branches missed.">		if (empIds == null || empIds.isEmpty()) {</span>
<span class="nc" id="L974">			return Collections.emptyList();</span>
		}

<span class="nc" id="L977">		JdmoPreparedStatementBuilder builder = getOrderedTOWaitlistsQry(pool, empIds, stDate, enDate);</span>
<span class="nc" id="L978">		JdmoRowset rs = JdmoPreparedStatement.createRowset(getDMO(), builder);</span>
<span class="nc" id="L979">		List&lt;Pair&lt;ID, TOHoursPerDay&gt;&gt; arrItems = new ArrayList&lt;Pair&lt;ID, TOHoursPerDay&gt;&gt;();</span>

<span class="nc bnc" id="L981" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L982">			TOHoursPerDay item = readObjectFromDB(rs);</span>
<span class="nc" id="L983">			arrItems.add(new Pair(rs.getID(&quot;TIMEOFFREQUESTID&quot;), item));</span>
<span class="nc" id="L984">		}</span>

<span class="nc" id="L986">		return arrItems;</span>

	}

	private JdmoPreparedStatementBuilder getOrderedTOWaitlistsQry(TOPool pool, Collection&lt;ID&gt; empIds, Date stDate, Date enDate) {

<span class="nc" id="L992">		JdmoPreparedStatementBuilder fromClause = new JdmoPreparedStatementBuilder();</span>
<span class="nc" id="L993">		fromClause.add(&quot; from REQUEST REQ &quot; +</span>
				&quot;inner join TIMEOFFREQUESTCHOICE TRC on TRC.TIMEOFFREQUESTID = REQ.ID &quot; +
				&quot;inner join TIMEOFFHOURSPERDAY THD on THD.TIMEOFFCHOICEID = TRC.ID &quot; +

				&quot;cross apply ( &quot; +
				//Pick the pool for the activity if it is setup for the employee, otherwise use the default pool for the employee
				&quot;	select top 1 WP.TOPOOLID,WP.ACTIVITYID as PoolActivityID &quot; +
				&quot;	from WORKRESOURCETOPOOL WP  &quot; +
				&quot;	where WP.WORKRESOURCEID = REQ.EMPLOYEEID and  &quot; +
				&quot;	(THD.STARTTIME&lt;WP.ENDTIME OR WP.ENDTIME IS NULL) AND THD.STARTTIME&gt;=WP.STARTTIME &quot; +
				&quot;	and (WP.ACTIVITYID = THD.ACTIVITYID or WP.ACTIVITYID is null) &quot; +
				&quot;	order by WP.ACTIVITYID desc &quot; +
				&quot;) WP &quot;);

		//WHERE Clause
<span class="nc" id="L1008">		JdmoPreparedStatementBuilder whereClause = new JdmoPreparedStatementBuilder();</span>
<span class="nc" id="L1009">		Date now = new Date();</span>
<span class="nc" id="L1010">		whereClause.add(&quot; where  THD.TIMEOFFCHOICERANK = 1 AND THD.STATUS = 8 &quot; +</span>
				&quot; AND THD.STARTTIME &lt; ?  AND THD.ENDTIME &gt; ? AND WP.TOPOOLID = ? &quot; +
				&quot; AND THD.EmployeeID in ? &quot; +
<span class="nc" id="L1013">				&quot; AND THD.EXPIRYDATE &gt; ? &quot;, enDate, stDate, pool.getID(), empIds, now);</span>


<span class="nc" id="L1016">		StringBuilder selectClause = new StringBuilder(&quot; SELECT DISTINCT THD.*,TRC.TIMEOFFREQUESTID &quot;);</span>
<span class="nc" id="L1017">		StringBuilder sortClause = getSortClause(pool, now, fromClause, selectClause);</span>

<span class="nc" id="L1019">		JdmoPreparedStatementBuilder full = new JdmoPreparedStatementBuilder(selectClause.toString());</span>
<span class="nc" id="L1020">		full.append(fromClause).append(whereClause);</span>
<span class="nc" id="L1021">		full.add(sortClause.toString());</span>
<span class="nc" id="L1022">		return full;</span>
	}

	private static StringBuilder getSortClause(TOPool pool, Date now, JdmoPreparedStatementBuilder fromClause, StringBuilder selectClause) {
<span class="nc" id="L1026">		StringBuilder sortClause = new StringBuilder();</span>

<span class="nc" id="L1028">		Pair[] wlPriorityorder = pool.getTOWaitlistPriortyOrderSettings();</span>
<span class="nc" id="L1029">		boolean addWltable = false;</span>
<span class="nc" id="L1030">		boolean addRanktable = false;</span>
<span class="nc" id="L1031">		boolean addEMPAMtable = false;</span>
		//String priorityClause = &quot;&quot;;
<span class="nc bnc" id="L1033" title="All 2 branches missed.">		for (int i = 0; i &lt; wlPriorityorder.length; i++) {</span>
			
<span class="nc" id="L1035">			Pair&lt;Integer, String&gt; sortPair = getSortColumnAndDirection(wlPriorityorder[i]);</span>
			
<span class="nc bnc" id="L1037" title="All 2 branches missed.">			if (sortPair == null) {</span>
<span class="nc" id="L1038">					break;</span>
			}

<span class="nc" id="L1041">			int sortCol = sortPair.getFirst();</span>
<span class="nc" id="L1042">			String sorDirStr = sortPair.getSecond();</span>
<span class="nc" id="L1043">			String colName = getColumnName(sortCol);</span>
<span class="nc bnc" id="L1044" title="All 2 branches missed.">			if (colName != null) {</span>
<span class="nc" id="L1045">				addWltable = needWaitListTable(addWltable, sortCol);</span>
<span class="nc" id="L1046">				addRanktable = needRankTable(addRanktable, sortCol);</span>
<span class="nc" id="L1047">				addEMPAMtable = needEmployeeAMTable(addEMPAMtable, sortCol);</span>

<span class="nc" id="L1049">				selectClause.append(&quot; , &quot; + colName);</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">				sortClause.append(sortClause.length() &gt; 0 ? &quot; ,&quot; : &quot; ORDER BY &quot;).append(colName).append(&quot; &quot;).append(sorDirStr);</span>
			}
		}
<span class="nc bnc" id="L1053" title="All 2 branches missed.">		sortClause.append((sortClause.length() &gt; 5 ? &quot; ,&quot; : &quot; ORDER BY &quot;)).append(&quot; TRC.TIMEOFFREQUESTID ASC &quot;);</span>

<span class="nc bnc" id="L1055" title="All 2 branches missed.">		if (addRanktable) {</span>
<span class="nc" id="L1056">			fromClause.add(&quot; LEFT JOIN ( SELECT EMPLOYEEID, RANK FROM EMPLOYEERANK WHERE STARTTIME &lt; ? &quot; +</span>
						  &quot; 	AND (ENDTIME&gt; ? OR ENDTIME IS NULL) &quot; +
						  &quot;)EMPRANK ON EMPRANK.EMPLOYEEID=REQ.EMPLOYEEID &quot;, now, now);
		}
<span class="nc bnc" id="L1060" title="All 2 branches missed.">		if (addWltable) {</span>
<span class="nc" id="L1061">			fromClause.add(String.format(&quot; inner join TIMEOFFWAITLIST %s on %s.TIMEOFFREQUESTID = REQ.ID  &quot;,</span>
					 RequestUtil.TABLE_TOWAITLIST_ALIAS,  RequestUtil.TABLE_TOWAITLIST_ALIAS ) );
		}
<span class="nc bnc" id="L1064" title="All 2 branches missed.">		if (addEMPAMtable) {</span>
<span class="nc" id="L1065">			fromClause.add(String.format(&quot; inner join EMPLOYEEAM %s on %s.ID = THD.EMPLOYEEID  &quot;,</span>
					RequestUtil.TABLE_EMPLOYEEAM_ALIAS, RequestUtil.TABLE_EMPLOYEEAM_ALIAS));
		}
<span class="nc" id="L1068">		return sortClause;</span>
	}
	
	private static boolean needRankTable(boolean need, int sortCol) {
<span class="nc bnc" id="L1072" title="All 4 branches missed.">		return need || (sortCol == Request.SORT_EMP_RANK);</span>
	}

	private static boolean needEmployeeAMTable(boolean need, int sortCol) {
<span class="nc bnc" id="L1076" title="All 4 branches missed.">		return need || (sortCol == Request.SORT_TO_SENIORITY);</span>
	}

	private static boolean needWaitListTable(boolean need, int sortCol) {
<span class="nc bnc" id="L1080" title="All 6 branches missed.">		return need || (sortCol == Request.SORT_TO_WAITLIST_PENDING_DATE_TIME) || (sortCol == Request.SORT_TO_WAITLIST_PENDING_DAYS);</span>
	}

	private static String getColumnName(int sortCol) {
<span class="nc bnc" id="L1084" title="All 9 branches missed.">		switch (sortCol) {</span>
		case Request.SORT_CREATED:
<span class="nc" id="L1086">			return &quot;REQ.SUBMITTEDON&quot;;</span>
		case Request.SORT_EMP_RANK:
<span class="nc" id="L1088">			return &quot;EMPRANK.RANK&quot;;</span>
		case Request.SORT_TO_SENIORITY:
<span class="nc" id="L1090">			return RequestUtil.TABLE_EMPLOYEEAM_ALIAS + &quot;.STARTTIME &quot;;</span>
		case Request.SORT_TO_WAITLIST_PENDING_DATE_TIME:
<span class="nc" id="L1092">			return RequestUtil.TABLE_TOWAITLIST_ALIAS + &quot;.CREATEDON &quot;;</span>
		case Request.SORT_TO_WAITLIST_PENDING_DAYS:
<span class="nc" id="L1094">			return &quot;DATEDIFF(D,&quot; + RequestUtil.TABLE_TOWAITLIST_ALIAS + &quot;.CREATEDON, GETUTCDATE() )&quot;;</span>
		case Request.SORT_TO_WAITLIST_TOCHOICE_ALLOCATION_HOURS:
<span class="nc" id="L1096">			return &quot;THD.TOTALMINUTES&quot;;</span>
		case Request.SORT_TO_WAITLIST_TOCHOICE_REQ_LENGTH:
<span class="nc" id="L1098">			return &quot;DATEDIFF(ss,THD.STARTTIME,THD.ENDTIME)&quot;;</span>
		case Request.SORT_TO_WAITLIST_TOCHOICE_START:
<span class="nc" id="L1100">			return &quot;THD.STARTTIME&quot;;</span>
		default:
<span class="nc" id="L1102">			return null;</span>
		}

	}

	private static Pair&lt;Integer, String&gt; getSortColumnAndDirection(Pair wlPriorityPair) {
<span class="nc bnc" id="L1108" title="All 2 branches missed.">		if (wlPriorityPair == null) {</span>
<span class="nc" id="L1109">			return null;</span>
		}
<span class="nc" id="L1111">		String sortColStr = (String) wlPriorityPair.getFirst();</span>
<span class="nc" id="L1112">		String sortDir = (String) wlPriorityPair.getSecond();</span>
<span class="nc bnc" id="L1113" title="All 4 branches missed.">		if (StringUtil.isEmptyOrWhiteSpace(sortColStr) || StringUtil.isEmptyOrWhiteSpace(sortDir)</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">				|| sortColStr.equals(RmSettingKey.ORG_RM_SETTINGS_TO_WAITLIST_ORDER_COLUMN_NO_VALUE)) {</span>
<span class="nc" id="L1115">			return null;</span>
		}
<span class="nc" id="L1117">		int sortCol = RmUtil.tryParseInt(sortColStr, -1);</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">		if (sortCol &lt; 0) {</span>
<span class="nc" id="L1119">			return null;</span>
		}

<span class="nc bnc" id="L1122" title="All 4 branches missed.">		sortDir = sortDir != null &amp;&amp; RequestUtil.SORTDIR_DESC.trim().equalsIgnoreCase(sortDir.trim()) ? RequestUtil.SORTDIR_ASC</span>
				: RequestUtil.SORTDIR_DESC;

<span class="nc" id="L1125">		return new Pair&lt;Integer, String&gt;(sortCol, sortDir);</span>
	}

	/**
	 * @return 
	 * The collection of TIMEOFFHOURSPERDAY that use scheduling periods that are affected when the date range [start,end) is published/unpublished.
	 * 
	 * A TIMEOFFHOURSPERDAY record is affected if the time off request choice associated with the hours per day 
	 * is using the reference scheduling period with range [start,end)  and the request is pending and is in the future.
	 */
	public Collection&lt;TOHoursPerDay&gt; getHoursPerDayGeneratedByReferenceSchedule(Collection&lt;ID&gt; empIDs, Date start, Date end)
			throws BbmFinderException {

<span class="nc bnc" id="L1138" title="All 4 branches missed.">		if (empIDs == null || empIDs.isEmpty()) {</span>
<span class="nc" id="L1139">			return Collections.emptyList();</span>
		}

		//@formatter:off
<span class="nc" id="L1143">		String sql =</span>
				&quot;select THD.*  &quot; 
				+ &quot;from TIMEOFFHOURSPERDAY THD &quot;
				+ &quot;inner join TIMEOFFREQUESTCHOICE TRC on TRC.ID = THD.TIMEOFFCHOICEID &quot;
				+ &quot;inner join REQUEST R on TRC.TIMEOFFREQUESTID = R.ID &quot; 
				+ &quot;inner join SP on SP.SID = TRC.REFERENCESPID &quot;
				+ &quot;where R.EMPLOYEEID in ? and R.REQUESTSTATUS in ( 'pending' , 'waitlist' ) &quot;
				+&quot;and SP.FROMDATE = ? and SP.TODATE = ?   and TRC.ENDTIME &gt; ? &quot;;
		//@formatter:on

<span class="nc" id="L1153">		Date now = new Date();</span>
<span class="nc" id="L1154">		return getObjectsWithFullSqlQueryStr(sql, empIDs, start, end, now);</span>
	}
	
	/**
	 * @return 
	 * The collection of TIMEOFFHOURSPERDAY from a list of TOChoices
	 * 
	 */
	public Collection&lt;TOHoursPerDay&gt; getHoursPerDayFromTOChoiceList(Collection&lt;ID&gt; toChoiceList)
			throws BbmFinderException {

<span class="nc bnc" id="L1165" title="All 4 branches missed.">		if (toChoiceList == null || toChoiceList.isEmpty()) {</span>
<span class="nc" id="L1166">			return Collections.emptyList();</span>
		}

		try {
<span class="nc" id="L1170">			String sql = &quot; A.TIMEOFFCHOICEID in &quot; + m_dmo.createInClause(toChoiceList);</span>
<span class="nc" id="L1171">			return getObjects(sql);</span>
<span class="nc" id="L1172">		} catch (JdmoException e) {</span>
<span class="nc" id="L1173">			throw new BbmFinderException(e);</span>
		}
		
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>