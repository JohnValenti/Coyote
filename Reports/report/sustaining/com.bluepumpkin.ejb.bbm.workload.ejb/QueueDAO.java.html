<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.workload.ejb</a> &gt; <span class="el_source">QueueDAO.java</span></div><h1>QueueDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.workload.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoPKGeneratorFactory;
import com.bluepumpkin.common.jdmo.JdmoParam;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriodFieldInfo;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.workload.model.MediaFieldInfo;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.QueueFieldInfo;
import com.bluepumpkin.ejb.bbm.workload.model.QueuePaginationData;

public class QueueDAO {
<span class="nc" id="L31">	private static final FieldInfo m_fieldInfo = new QueueFieldInfo();</span>
	private static final String FROM_ORGANIZATION = &quot;FROM ORGANIZATION &quot;;

	protected FieldInfo getFieldInfo() {
<span class="nc" id="L35">		return m_fieldInfo;</span>
	}

<span class="nc" id="L38">	public QueueDAO() {</span>
<span class="nc" id="L39">	}</span>

	/**
	 * get queue object given its sid
	 */
	static Queue getQueueByID(ID sID) throws JdmoException {
<span class="nc" id="L45">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L47">			final StringBuilder pStmt = new StringBuilder(</span>
				&quot;select A.ID, A.NAME, A.DESCRIPTION, A.PARENTQUEUEID,(select sid from queue q where a.parentqueueid = q.id)&quot; 
					+ &quot; as PARENTSID , A.QUEUETYPE, A.SID as QUEUEID, A.ORGANIZATIONID, C.NAME as ORGANIZATIONNAME, B.SID &quot; 
					+ &quot;as MEDIAID, B.NAME as MEDIANAME, B.ID as MEDIASTRID from QUEUE A, MEDIA B, ORGANIZATION C where A&quot; 
					+ &quot;.ORGANIZATIONID = C.ID and A.MEDIAID = B.ID and A.SID=?&quot;);
<span class="nc" id="L52">			final JdmoQuery jq = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L53">			jq.setParID(1, sID);</span>
<span class="nc" id="L54">			final JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L55">			Queue queue = null;</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L57">				queue = getQueue(rs);</span>
			}
<span class="nc" id="L59">			return queue;</span>
		} finally {
<span class="nc" id="L61">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * get queue object given its sid
	 */
	static Collection&lt;Queue&gt; getAllQueues() throws JdmoException {
<span class="nc" id="L69">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L71">			final StringBuilder pStmt = new StringBuilder(</span>
				&quot;select a.SID as QUEUEID, a.NAME, a.DESCRIPTION, A.PARENTQUEUEID,(select sid from queue q where a&quot; 
					+ &quot;.parentqueueid = q.id) as PARENTSID , A.QUEUETYPE, A.ORGANIZATIONID, c.NAME as ORGANIZATIONNAME, b&quot; 
					+ &quot;.SID as MEDIAID, b.NAME as MEDIANAME, B.ID as MEDIASTRID from QUEUE a, MEDIA b, ORGANIZATION c where&quot; 
					+ &quot; a.ORGANIZATIONID = c.ID and a.MEDIAID = b.ID&quot;);
<span class="nc" id="L76">			return getQueues(jdmo, pStmt);</span>
		} finally {
<span class="nc" id="L78">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * it only returns queues that have not been linked to a SP
	 *
	 * @param searchString
	 * @param mediaType
	 * @param orgIds
	 * @return
	 * @throws JdmoException
	 */
	static List&lt;Queue&gt; getQueuesByOrgIdsMediaTypeAndSearchString(String searchString, ID mediaType, List&lt;ID&gt; orgIds,
		int type, ID queueId, int totalrows) throws JdmoException {
<span class="nc" id="L93">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L95">			final StringBuilder pStmt = new StringBuilder(&quot;select TOP &quot;)</span>
<span class="nc" id="L96">				.append(totalrows)</span>
<span class="nc" id="L97">				.append(&quot; a.SID as QUEUEID, a.NAME, a.DESCRIPTION, A.PARENTQUEUEID,(select sid from queue q where a&quot; </span>
					+ &quot;.parentqueueid = q.id) as PARENTSID , A.QUEUETYPE, A.ORGANIZATIONID, c.NAME as ORGANIZATIONNAME, b&quot; 
					+ &quot;.SID as MEDIAID, b.NAME as MEDIANAME, B.ID as MEDIASTRID from QUEUE a, MEDIA b, ORGANIZATION c where&quot; 
					+ &quot; a.ORGANIZATIONID = c.ID and a.MEDIAID = b.ID &quot;);
<span class="nc bnc" id="L101" title="All 4 branches missed.">			if (searchString != null &amp;&amp; !searchString.trim().isEmpty()) {</span>
<span class="nc" id="L102">				pStmt.append(&quot; and a.NAME LIKE '%&quot;).append(JdmoUtil.formatDBString(searchString)).append(&quot;%'&quot;);</span>
			}
<span class="nc" id="L104">			pStmt.append(&quot; and b.SID = &quot;).append(mediaType).append(&quot; and c.ID in &quot;).append(jdmo.createInClause(orgIds))</span>
<span class="nc" id="L105">				.append(&quot; and a.QUEUETYPE = &quot;).append(type)</span>
<span class="nc" id="L106">				.append(&quot; and (a.PARENTQUEUEID not in (select ID from QUEUE where SID = &quot;).append(queueId)</span>
<span class="nc" id="L107">				.append(&quot;) OR a.PARENTQUEUEID is null)&quot;)</span>
<span class="nc" id="L108">				.append(&quot; and a.id not in (&quot;)        // it only returns queues that have not been linked to an SP</span>
<span class="nc" id="L109">				.append(&quot; select distinct qq.id&quot;)</span>
<span class="nc" id="L110">				.append(&quot; from CAMPAIGN cp inner join sp s on s.CAMPAIGNID = cp.ID&quot;)</span>
<span class="nc" id="L111">				.append(&quot; inner join SPQUEUE sq on s.ID = sq.SPID&quot;)</span>
<span class="nc" id="L112">				.append(&quot; inner join QUEUE qq on qq.id = sq.QUEUEID&quot;)</span>
<span class="nc" id="L113">				.append(&quot; where qq.PARENTQUEUEID is null)&quot;)</span>
<span class="nc" id="L114">				.append(&quot; ORDER BY NAME&quot;);</span>
<span class="nc" id="L115">			final JdmoRowset rs = jdmo.createRowset(pStmt.toString());</span>
<span class="nc" id="L116">			final List&lt;Queue&gt; queuesColl = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L118">				queuesColl.add(getQueue(rs));</span>
			}
<span class="nc" id="L120">			return queuesColl;</span>
		} finally {
<span class="nc" id="L122">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * get queue object given its sid
	 */
	static Collection&lt;Queue&gt; getQueuesByOrgID(ID orgID) throws JdmoException {
<span class="nc" id="L130">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L132">			final StringBuilder pStmt = new StringBuilder(</span>
				&quot;select a.SID as QUEUEID, a.NAME, a.DESCRIPTION, A.PARENTQUEUEID,(select sid from queue q where a&quot; 
					+ &quot;.parentqueueid = q.id) as PARENTSID , A.QUEUETYPE, A.ORGANIZATIONID, C.NAME as ORGANIZATIONNAME, b&quot; 
					+ &quot;.SID as MEDIAID, b.NAME as MEDIANAME, B.ID as MEDIASTRID from QUEUE a, MEDIA b, ORGANIZATION C where&quot; 
					+ &quot; a.MEDIAID = b.ID and a.ORGANIZATIONID = c.ID and A.ORGANIZATIONID = &quot;);
<span class="nc" id="L137">			pStmt.append(orgID.toString());</span>
<span class="nc" id="L138">			return getQueues(jdmo, pStmt);</span>
		} finally {
<span class="nc" id="L140">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * get queue object given its sid
	 */
	static Collection&lt;Queue&gt; getQueuesByRecursedOrgID(ID orgID) throws JdmoException {
<span class="nc" id="L148">		return getQueuesByRecursedOrgID(orgID, null);</span>
	}

	/**
	 * get queue object given its sid and a Media DEID
	 *
	 * @param orgID    - the ID of the org for which you want to get all the queues
	 *                 available to it (including those defined at parent orgs)
	 * @param mediaIDs - a collection of DEID's (String ID's) of the Medias that you
	 *                 want to filter the queues by (EX: &quot;ID_PHONE       &quot;). Pass
	 *                 null for all.
	 * @return all of the queues defined at orgID (or one of its parent orgs)
	 * which are of the specified media type.
	 */
	static Collection&lt;Queue&gt; getQueuesByRecursedOrgID(ID orgID, Collection&lt;ID&gt; mediaIDs) throws JdmoException {
<span class="nc" id="L163">		final Jdmo jdmo = new Jdmo();</span>
		try {

<span class="nc" id="L166">			final Collection&lt;ID&gt; queueIds = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L168">			final StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L169">			query.append(&quot;SELECT ID, Name, ParentID&quot;).append(&quot; FROM ORGANIZATION&quot;).</span>
<span class="nc" id="L170">				append(&quot; WHERE ID = &quot;).append(JdmoUtil.asSqlLiteral(orgID));</span>

<span class="nc" id="L172">			final JdmoRowset x = jdmo.createRowset(query.toString());</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">			if (x.next()) {</span>
<span class="nc" id="L175">				final ID idOrg = x.getID(&quot;ID&quot;);</span>
<span class="nc" id="L176">				final ID idOrgParent = x.getID(&quot;ParentID&quot;);</span>
<span class="nc" id="L177">				final Collection&lt;ID&gt; qcoll = recurseQueuesUP(idOrg, idOrgParent, mediaIDs);</span>
<span class="nc" id="L178">				queueIds.addAll(qcoll);</span>
			}

<span class="nc bnc" id="L181" title="All 2 branches missed.">			if (queueIds.isEmpty()) {</span>
<span class="nc" id="L182">				return Collections.emptyList();</span>
			} else {
<span class="nc" id="L184">				return getQueuesByIDs(queueIds);</span>
			}
		} finally {
<span class="nc" id="L187">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * @param orgID      - the ID of the org for which you want to get all the queues
	 *                   available to it (including those defined at parent orgs)
	 * @param sortColumn - the column on which the sorting will be done
	 * @param sortOrder  - the order in which sorting will be done basically ASC or
	 *                   DESC
	 * @param from       - the row number to start with
	 * @param to         - the row number till which you need the record
	 * @param down       - if true will pull the children for the organization
	 * @param queueTypes - list of Queue Types you want to filter with. this can be
	 *                   null or empty if you do not want to filter by Queue Types
	 * @return all of the queues defined at orgID (or one of its parent or child
	 * orgs).
	 */
	static QueuePaginationData getPaginatedQueuesByRecursedOrgID(ID orgID, String sortColumn, String sortOrder, int from,
		int limit, boolean down, Collection&lt;ID&gt; queueTypes) throws JdmoException {
<span class="nc" id="L207">		final QueuePaginationData queuePaginationData = new QueuePaginationData();</span>

		// If the Organization ID is not passed then just return the Object
<span class="nc bnc" id="L210" title="All 2 branches missed.">		if (orgID == null) {</span>
<span class="nc" id="L211">			return queuePaginationData;</span>
		}

		// In case the Sort Column is passed as NULL or EMPTY
<span class="nc bnc" id="L215" title="All 2 branches missed.">		if (StringUtil.isEmpty(sortColumn)) {</span>
<span class="nc" id="L216">			sortColumn = &quot;NAME&quot;;</span>
		}

<span class="nc" id="L219">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L221">			final List&lt;Queue&gt; queues = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L223">			final StringBuilder query = new StringBuilder(getOrganizationHierarchyQuery(down));</span>
<span class="nc" id="L224">			query.append(&quot;-- Doing a query on queue based on Organization heirarchy result \n&quot;)</span>
<span class="nc" id="L225">				.append(&quot;Select * from( SELECT ROW_NUMBER() OVER (ORDER BY &quot;)</span>
<span class="nc" id="L226">				.append(sortColumn)</span>
<span class="nc" id="L227">				.append(&quot; &quot;)</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">				.append(&quot;descending&quot;.equalsIgnoreCase(sortOrder) ? &quot;DESC&quot; // This</span>
					// is
					// written
					// in
					// this
					// way
					// to
					// handle
					// if
					// NULL
					// sortOrder
					// is
					// passed
					: &quot;ASC&quot;)
<span class="nc" id="L242">				.append(&quot; &quot;)</span>
<span class="nc" id="L243">				.append(&quot;) AS rownum ,TEMP.*, COUNT(*) OVER() AS total &quot;)</span>
<span class="nc" id="L244">				.append(&quot;FROM ( &quot;)</span>
<span class="nc" id="L245">				.append(&quot;SELECT a.SID AS QUEUEID &quot;)</span>
<span class="nc" id="L246">				.append(&quot;,a.NAME, a.DESCRIPTION, A.PARENTQUEUEID &quot;)</span>
<span class="nc" id="L247">				.append(&quot;,(SELECT sid FROM QUEUE q WHERE a.parentqueueid = q.id ) AS PARENTSID&quot;)</span>
<span class="nc" id="L248">				.append(&quot;,A.QUEUETYPE, A.ORGANIZATIONID&quot;)</span>
<span class="nc" id="L249">				.append(&quot;,c.NAME AS ORGANIZATIONNAME, b.SID AS MEDIAID&quot;)</span>
<span class="nc" id="L250">				.append(&quot;,b.NAME AS MEDIANAME, B.ID AS MEDIASTRID, &quot;)</span>
<span class="nc" id="L251">				.append(&quot;CASE A.QUEUETYPE &quot;)</span>
<span class="nc" id="L252">				.append(&quot;when 0 then 'NORMAL' &quot;)</span>
<span class="nc" id="L253">				.append(&quot;when 1 then 'DISTRIBUTED' &quot;)</span>
<span class="nc" id="L254">				.append(&quot;when 2 then 'VIRTUAL' &quot;)</span>
<span class="nc" id="L255">				.append(&quot;when 3 then 'PROCESS' &quot;)</span>
<span class="nc" id="L256">				.append(&quot;end as TYPENAME, &quot;)</span>
<span class="nc" id="L257">				.append(&quot;e.DSG as DSG &quot;)</span>
<span class="nc" id="L258">				.append(&quot;FROM QUEUE a left join (select Q.ID,Q.NAME,Q.SID,TOPDSG.DATASOURCEGROUPID,TOPDSG.NAME as DSG from &quot; </span>
					+ &quot;queue q &quot;)
<span class="nc" id="L260">				.append(&quot;cross apply (select TOP 1 DATASOURCEGROUPid,DSG.NAME from QUEUEGROUP QG inner join DATASOURCEGROUP&quot; </span>
					+ &quot; DSG ON DSG.ID = QG.DATASOURCEGROUPID WHERE Q.SID = QG.QUEUEID ORDER BY DSG.NAME ASC) TOPDSG )&quot;)
<span class="nc" id="L262">				.append(&quot; as e on a.SID = e.SID&quot;).append(&quot;, MEDIA b, ORGANIZATION c &quot;).append(&quot;, (&quot;);</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">			if (down) {</span>
<span class="nc" id="L264">				query.append(&quot;SELECT * FROM ORGANIZATIONHIERARCHICYDOWN UNION &quot;);</span>
			}
<span class="nc" id="L266">			query.append(&quot;SELECT * FROM ORGANIZATIONHIERARCHICYUP) d &quot;).append(</span>
				&quot;WHERE a.ORGANIZATIONID = c.ID AND a.MEDIAID = b.ID AND a.ORGANIZATIONID = d.ID&quot;);
<span class="nc bnc" id="L268" title="All 4 branches missed.">			if (queueTypes != null &amp;&amp; !queueTypes.isEmpty()) {</span>
<span class="nc" id="L269">				query.append(&quot; and a.QUEUETYPE  in &quot;).append(jdmo.createInClause(queueTypes)).append(&quot; &quot;);</span>
			}
<span class="nc" id="L271">			query.append(&quot;) AS TEMP) As Temp2 &quot;).append(&quot;WHERE rownum &gt;= ? AND rownum &lt;= ?&quot;);</span>

<span class="nc" id="L273">			final JdmoQuery jq = jdmo.createQuery(query.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L274">			int parameterNumber = 1;</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">			if (down) {</span>
<span class="nc" id="L276">				jq.setParID(parameterNumber++, orgID);</span>
			}
<span class="nc" id="L278">			jq.setParID(parameterNumber++, orgID);</span>
<span class="nc" id="L279">			jq.setParInt(parameterNumber++, from);</span>
<span class="nc" id="L280">			jq.setParInt(parameterNumber++, limit);</span>
<span class="nc" id="L281">			final JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="nc bnc" id="L283" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L284">				queuePaginationData.setTotal(rs.getInt(&quot;total&quot;));</span>
<span class="nc" id="L285">				queues.add(getQueue(rs));</span>
			}
<span class="nc" id="L287">			queuePaginationData.setQueues(queues);</span>
<span class="nc" id="L288">			return queuePaginationData;</span>

		} finally {
<span class="nc" id="L291">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * @param orgID      - the ID of the org for which you want to get all the queues
	 *                   available to it (including those defined at parent orgs)
	 * @param sortColumn - the column on which the sorting will be done
	 * @param sortOrder  - the order in which sorting will be done basically ASC or
	 *                   DESC
	 * @param from       - the row number to start with
	 * @param to         - the row number till which you need the record
	 * @param down       - if true will pull the children for the organization
	 * @param queueTypes - list of Queue Types you want to filter with. this can be
	 *                   null or empty if you do not want to filter by Queue Types
	 * @return all of the parent queues defined at orgID (or one of its parent
	 * or child orgs).
	 */
	static QueuePaginationData getPaginatedParentQueuesByRecursedOrgID(ID orgID, String sortColumn, String sortOrder,
		int from, int limit, boolean down, Collection&lt;ID&gt; queueTypes) throws JdmoException {
<span class="nc" id="L311">		final QueuePaginationData queuePaginationData = new QueuePaginationData();</span>

		// If the Organization ID is not passed then just return the Object
<span class="nc bnc" id="L314" title="All 2 branches missed.">		if (orgID == null) {</span>
<span class="nc" id="L315">			return queuePaginationData;</span>
		}

		// In case the Sort Column is passed as NULL or EMPTY
<span class="nc bnc" id="L319" title="All 2 branches missed.">		if (StringUtil.isEmpty(sortColumn)) {</span>
<span class="nc" id="L320">			sortColumn = &quot;NAME&quot;;</span>
		}

<span class="nc" id="L323">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L325">			final List&lt;Queue&gt; queues = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L327">			final StringBuilder query = new StringBuilder(getOrganizationHierarchyQuery(down));</span>
<span class="nc" id="L328">			query.append(&quot;,&quot;)</span>
<span class="nc" id="L329">				.append(&quot;-- This will pull the Down Heirarchy Data for Organization \n&quot;)</span>
<span class="nc" id="L330">				.append(&quot;QUEUEHIERARCHICY (ID, NAME, PARENTID)&quot;)</span>
<span class="nc" id="L331">				.append(&quot; AS (SELECT ID, NAME, PARENTQUEUEID &quot;)</span>
<span class="nc" id="L332">				.append(&quot;FROM QUEUE &quot;)</span>
<span class="nc" id="L333">				.append(&quot;UNION ALL &quot;)</span>
<span class="nc" id="L334">				.append(&quot;SELECT QUEUE.ID, QUEUE.NAME, QUEUE.PARENTQUEUEID &quot;)</span>
<span class="nc" id="L335">				.append(&quot;FROM QUEUE &quot;)</span>
<span class="nc" id="L336">				.append(&quot;INNER JOIN QUEUEHIERARCHICY ON QUEUE.PARENTQUEUEID = QUEUEHIERARCHICY.ID &quot;)</span>
<span class="nc" id="L337">				.append(&quot;WHERE QUEUE.PARENTQUEUEID IS NOT NULL) &quot;)</span>
<span class="nc" id="L338">				.append(&quot;-- Doing a query on queue based on Organization heirarchy result \n&quot;)</span>
<span class="nc" id="L339">				.append(&quot;Select * from( SELECT ROW_NUMBER() OVER (ORDER BY &quot;)</span>
<span class="nc" id="L340">				.append(sortColumn)</span>
<span class="nc" id="L341">				.append(&quot; &quot;)</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">				.append(&quot;descending&quot;.equalsIgnoreCase(sortOrder) ? &quot;DESC&quot; // This</span>
					// is
					// written
					// in
					// this
					// way
					// to
					// handle
					// if
					// NULL
					// sortOrder
					// is
					// passed
					: &quot;ASC&quot;)
<span class="nc" id="L356">				.append(&quot; &quot;)</span>
<span class="nc" id="L357">				.append(&quot;) AS rownum ,TEMP.*, COUNT(*) OVER() AS total &quot;)</span>
<span class="nc" id="L358">				.append(&quot;FROM ( &quot;)</span>
<span class="nc" id="L359">				.append(&quot;SELECT a.SID AS QUEUEID &quot;)</span>
<span class="nc" id="L360">				.append(&quot;,a.NAME, a.DESCRIPTION, A.PARENTQUEUEID &quot;)</span>
<span class="nc" id="L361">				.append(&quot;,(SELECT sid FROM QUEUE q WHERE a.parentqueueid = q.id ) AS PARENTSID&quot;)</span>
<span class="nc" id="L362">				.append(&quot;,A.QUEUETYPE, A.ORGANIZATIONID&quot;)</span>
<span class="nc" id="L363">				.append(&quot;,c.NAME AS ORGANIZATIONNAME, b.SID AS MEDIAID&quot;)</span>
<span class="nc" id="L364">				.append(&quot;,b.NAME AS MEDIANAME, B.ID AS MEDIASTRID, &quot;)</span>
<span class="nc" id="L365">				.append(&quot;CASE A.QUEUETYPE &quot;)</span>
<span class="nc" id="L366">				.append(&quot;when 0 then 'NORMAL' &quot;)</span>
<span class="nc" id="L367">				.append(&quot;when 1 then 'DISTRIBUTED' &quot;)</span>
<span class="nc" id="L368">				.append(&quot;when 2 then 'VIRTUAL' &quot;)</span>
<span class="nc" id="L369">				.append(&quot;when 3 then 'PROCESS' &quot;)</span>
<span class="nc" id="L370">				.append(&quot;end as TYPENAME, &quot;)</span>
<span class="nc" id="L371">				.append(&quot;e.DSG as DSG &quot;)</span>
<span class="nc" id="L372">				.append(&quot;FROM QUEUE a left join (SELECT distinct r.parentid, STUFF((SELECT distinct ','+ a.NAME FROM &quot; </span>
					+ &quot;QUEUEHIERARCHICY a WHERE r.parentid = a.parentid &quot;)
<span class="nc" id="L374">				.append(&quot;FOR xml PATH (''), TYPE) .value('.', 'VARCHAR(max)'), 1, 1, '') AS DSG FROM QUEUEHIERARCHICY r)&quot;)</span>
<span class="nc" id="L375">				.append(&quot; as e on a.ID = e.PARENTID&quot;).append(&quot;, MEDIA b, ORGANIZATION c &quot;).append(&quot;, (&quot;);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">			if (down) {</span>
<span class="nc" id="L377">				query.append(&quot;SELECT * FROM ORGANIZATIONHIERARCHICYDOWN UNION &quot;);</span>
			}
<span class="nc" id="L379">			query.append(&quot;SELECT * FROM ORGANIZATIONHIERARCHICYUP) d &quot;).append(</span>
				&quot;WHERE a.ORGANIZATIONID = c.ID AND a.MEDIAID = b.ID AND a.ORGANIZATIONID = d.ID&quot;);
<span class="nc bnc" id="L381" title="All 4 branches missed.">			if (queueTypes != null &amp;&amp; !queueTypes.isEmpty()) {</span>
<span class="nc" id="L382">				query.append(&quot; and a.QUEUETYPE  in &quot;).append(jdmo.createInClause(queueTypes)).append(&quot; &quot;);</span>
			}
<span class="nc" id="L384">			query.append(&quot;) AS TEMP) As Temp2 &quot;).append(&quot;WHERE rownum &gt;= ? AND rownum &lt;= ?&quot;);</span>

<span class="nc" id="L386">			final JdmoQuery jq = jdmo.createQuery(query.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L387">			int parameterNumber = 1;</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">			if (down) {</span>
<span class="nc" id="L389">				jq.setParID(parameterNumber++, orgID);</span>
			}
<span class="nc" id="L391">			jq.setParID(parameterNumber++, orgID);</span>
<span class="nc" id="L392">			jq.setParInt(parameterNumber++, from);</span>
<span class="nc" id="L393">			jq.setParInt(parameterNumber++, limit);</span>
<span class="nc" id="L394">			final JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="nc bnc" id="L396" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L397">				queuePaginationData.setTotal(rs.getInt(&quot;total&quot;));</span>
<span class="nc" id="L398">				queues.add(getQueue(rs));</span>
			}
<span class="nc" id="L400">			queuePaginationData.setQueues(queues);</span>
<span class="nc" id="L401">			return queuePaginationData;</span>

		} finally {
<span class="nc" id="L404">			jdmo.cleanUp();</span>
		}
	}

	static String getOrganizationHierarchyQuery(boolean down) {
<span class="nc" id="L409">		final StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L410">		query.append(&quot;WITH&quot;);</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">		if (down) {</span>
<span class="nc" id="L412">			query.append(&quot;-- This will pull the Down Heirarchy Data for Organization \n&quot;)</span>
<span class="nc" id="L413">				.append(&quot;ORGANIZATIONHIERARCHICYDOWN (ID, NAME, PARENTID) &quot;)</span>
<span class="nc" id="L414">				.append(&quot;AS (SELECT ID, NAME, PARENTID &quot;)</span>
<span class="nc" id="L415">				.append(FROM_ORGANIZATION)</span>
<span class="nc" id="L416">				.append(&quot;WHERE ID = ? &quot;)</span>
<span class="nc" id="L417">				.append(&quot;UNION ALL &quot;)</span>
<span class="nc" id="L418">				.append(&quot;SELECT ORGANIZATION.ID, ORGANIZATION.NAME, ORGANIZATION.PARENTID &quot;)</span>
<span class="nc" id="L419">				.append(FROM_ORGANIZATION)</span>
<span class="nc" id="L420">				.append(&quot;INNER JOIN ORGANIZATIONHIERARCHICYDOWN ON ORGANIZATION.PARENTID = ORGANIZATIONHIERARCHICYDOWN.ID &quot;)</span>
<span class="nc" id="L421">				.append(&quot;WHERE ORGANIZATION.PARENTID IS NOT NULL), &quot;);</span>
		}

<span class="nc" id="L424">		query.append(&quot;-- This will pull the Up Heirarchy Data for Organization \n&quot;)</span>
<span class="nc" id="L425">			.append(&quot;ORGANIZATIONHIERARCHICYUP (ID, NAME, PARENTID) &quot;).append(&quot;AS (&quot;).append(&quot;SELECT ID,NAME,ParentID &quot;)</span>
<span class="nc" id="L426">			.append(FROM_ORGANIZATION).append(&quot;WHERE ID = ? &quot;).append(&quot;UNION ALL &quot;)</span>
<span class="nc" id="L427">			.append(&quot;SELECT ORGANIZATION.ID, ORGANIZATION.NAME, ORGANIZATION.PARENTID &quot;).append(FROM_ORGANIZATION)</span>
<span class="nc" id="L428">			.append(&quot;INNER JOIN ORGANIZATIONHIERARCHICYUP ON ORGANIZATION.ID = ORGANIZATIONHIERARCHICYUP.PARENTID &quot;)</span>
<span class="nc" id="L429">			.append(&quot;WHERE ORGANIZATION.PARENTID IS NOT NULL AND ORGANIZATION.ID != - 3001) &quot;);</span>
<span class="nc" id="L430">		return query.toString();</span>
	}

	private static Collection&lt;ID&gt; recurseQueuesUP(ID idOrg, ID idOrgParent, Collection&lt;ID&gt; mediaIDs) throws JdmoException {
<span class="nc" id="L434">		final Jdmo jdmo = new Jdmo();</span>

		try {

<span class="nc" id="L438">			final Collection&lt;ID&gt; localQueueIds = new ArrayList&lt;&gt;();</span>

			// get the queues for this org....
<span class="nc" id="L441">			StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L442">			query.append(&quot;SELECT q.SID, q.NAME&quot;).append(&quot; FROM QUEUE q&quot;).append(&quot; WHERE q.ORGANIZATIONID = &quot;).append(idOrg);</span>

<span class="nc bnc" id="L444" title="All 4 branches missed.">			if (mediaIDs != null &amp;&amp; !mediaIDs.isEmpty()) {</span>
<span class="nc" id="L445">				query.append(&quot; and q.MEDIAID in ( select ID from MEDIA where SID in &quot;).append(jdmo.createInClause(mediaIDs))</span>
<span class="nc" id="L446">					.append(&quot; ) &quot;);</span>
			}

<span class="nc" id="L449">			JdmoRowset r = jdmo.createRowset(query.toString());</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L451">				localQueueIds.add(r.getID(&quot;SID&quot;));</span>
			}
<span class="nc" id="L453">			r.close();</span>

<span class="nc bnc" id="L455" title="All 2 branches missed.">			if (!idOrg.equals(idOrgParent)) { // when OrgID = Parent ID, we've reached the top</span>
				// get the next layer of organizations...
<span class="nc" id="L457">				query = new StringBuilder();</span>
<span class="nc" id="L458">				query.append(&quot; SELECT ID, Name, ParentID&quot;).append(&quot; FROM ORGANIZATION &quot;).append(&quot; WHERE ID = &quot;)</span>
<span class="nc" id="L459">					.append(idOrgParent);</span>

<span class="nc" id="L461">				r = jdmo.createRowset(query.toString());</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">				while (r.next()) {</span>
<span class="nc" id="L463">					final ID idNextOrg = r.getID(&quot;ID&quot;);</span>
<span class="nc" id="L464">					final ID idNextOrgParent = r.getID(&quot;ParentID&quot;); // todo</span>
					// CHECK
					// THIS
<span class="nc" id="L467">					final Collection&lt;ID&gt; qcoll = recurseQueuesUP(idNextOrg, idNextOrgParent, mediaIDs);</span>
<span class="nc" id="L468">					localQueueIds.addAll(qcoll);</span>
<span class="nc" id="L469">				}</span>
<span class="nc" id="L470">				r.close();</span>
			}

<span class="nc" id="L473">			return localQueueIds;</span>

		} finally {
<span class="nc" id="L476">			jdmo.cleanUp();</span>
		}

	}

	/**
	 * get queue object given its sid
	 */
	static Collection&lt;Queue&gt; getQueuesByRecursedOrgIDDown(ID orgID) throws JdmoException {
<span class="nc" id="L485">		return getQueuesByRecursedOrgIDDown(orgID, null);</span>
	}

	/**
	 * get queue object given its sid and a Media DEID
	 *
	 * @param orgID    - the ID of the org for which you want to get all the queues
	 *                 available to it (including those defined at parent orgs)
	 * @param mediaIDs - a collection of DEID's (String ID's) of the Medias that you
	 *                 want to filter the queues by (EX: &quot;ID_PHONE       &quot;). Pass
	 *                 null for all.
	 * @return all of the queues defined at orgID (or one of its parent orgs)
	 * which are of the specified media type.
	 */
	static Collection&lt;Queue&gt; getQueuesByRecursedOrgIDDown(ID orgID, Collection&lt;ID&gt; mediaIDs) throws JdmoException {
<span class="nc" id="L500">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L502">			final Collection&lt;ID&gt; queueIds = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L504">			final StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L505">			query.append(&quot;SELECT ID, Name, ParentID&quot;).append(&quot; FROM ORGANIZATION&quot;).append(&quot; WHERE ID = &quot;).append(orgID);</span>

<span class="nc" id="L507">			final JdmoRowset x = jdmo.createRowset(query.toString());</span>

<span class="nc bnc" id="L509" title="All 2 branches missed.">			if (x.next()) {</span>
<span class="nc" id="L510">				final ID idOrg = x.getID(&quot;ID&quot;);</span>
<span class="nc" id="L511">				final Collection&lt;ID&gt; qcoll = recurseQueuesDOWN(idOrg, mediaIDs);</span>
<span class="nc" id="L512">				queueIds.addAll(qcoll);</span>
			}

<span class="nc bnc" id="L515" title="All 4 branches missed.">			if (queueIds == null || queueIds.isEmpty()) {</span>
<span class="nc" id="L516">				return null;</span>
			} else {
<span class="nc" id="L518">				return getQueuesByIDs(queueIds);</span>
			}
		} finally {
<span class="nc" id="L521">			jdmo.cleanUp();</span>
		}
	}

	static Collection&lt;ID&gt; recurseQueuesDOWN(ID idOrg, Collection&lt;ID&gt; mediaIDs) throws JdmoException {
<span class="nc" id="L526">		final Jdmo jdmo = new Jdmo();</span>

		try {
<span class="nc" id="L529">			final Collection&lt;ID&gt; localQueueIds = new ArrayList&lt;&gt;();</span>

			// get the queues for this org....
<span class="nc" id="L532">			StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L533">			query.append(&quot;SELECT q.SID, q.NAME&quot;).append(&quot; FROM QUEUE q&quot;).append(&quot; WHERE q.ORGANIZATIONID = &quot;).append(idOrg);</span>

<span class="nc bnc" id="L535" title="All 4 branches missed.">			if (mediaIDs != null &amp;&amp; !mediaIDs.isEmpty()) {</span>
<span class="nc" id="L536">				query.append(&quot; and q.MEDIAID in ( select ID from MEDIA where SID in &quot;).append(jdmo.createInClause(mediaIDs))</span>
<span class="nc" id="L537">					.append(&quot; ) &quot;);</span>
			}

<span class="nc" id="L540">			JdmoRowset r = jdmo.createRowset(query.toString());</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L542">				localQueueIds.add(r.getID(&quot;SID&quot;));</span>

			}
<span class="nc" id="L545">			r.close();</span>

			// get the next layer of organizations...
<span class="nc" id="L548">			query = new StringBuilder();</span>
<span class="nc" id="L549">			query.append(&quot; SELECT ID, Name, ParentID&quot;).append(&quot; FROM ORGANIZATION &quot;).append(&quot; WHERE ParentID = &quot;)</span>
<span class="nc" id="L550">				.append(idOrg);</span>

<span class="nc" id="L552">			r = jdmo.createRowset(query.toString());</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L554">				final ID idNextOrg = r.getID(&quot;ID&quot;);</span>
<span class="nc" id="L555">				final Collection&lt;ID&gt; qcoll = recurseQueuesDOWN(idNextOrg, mediaIDs);</span>
<span class="nc" id="L556">				localQueueIds.addAll(qcoll);</span>
<span class="nc" id="L557">			}</span>
<span class="nc" id="L558">			r.close();</span>

<span class="nc" id="L560">			return localQueueIds;</span>

		} finally {
<span class="nc" id="L563">			jdmo.cleanUp();</span>
		}

	}

	/**
	 * get queue objects given their SIDs
	 */
	static Collection&lt;Queue&gt; getQueuesByIDs(Collection&lt;? extends ID&gt; colIDs) throws JdmoException {
<span class="nc" id="L572">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L574">			final StringBuilder pStmt = new StringBuilder(</span>
				&quot;select a.SID as QUEUEID, a.NAME, a.DESCRIPTION, A.PARENTQUEUEID, (select sid from queue q where a&quot; 
					+ &quot;.parentqueueid = q.id) as PARENTSID , A.QUEUETYPE, A.ORGANIZATIONID, c.NAME as ORGANIZATIONNAME, b&quot; 
					+ &quot;.SID as MEDIAID, b.NAME as MEDIANAME, B.ID as MEDIASTRID from QUEUE a, MEDIA b, ORGANIZATION c where&quot; 
					+ &quot; a.ORGANIZATIONID = c.ID and a.MEDIAID = b.ID and a.SID in &quot;);
<span class="nc" id="L579">			pStmt.append(jdmo.createInClause(colIDs));</span>
<span class="nc" id="L580">			return getQueues(jdmo, pStmt);</span>
		} finally {
<span class="nc" id="L582">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * create queue
	 */
	static ID createQueue(Queue objValue) throws JdmoException {
<span class="nc" id="L590">		final Jdmo jdmo = new Jdmo();</span>
		try {
			// get ID from DE
<span class="nc" id="L593">			final String idStr = DAOUtil.getDEID(jdmo);</span>

			// parameters must have escaped character processing, when prepared
			// statement style ? is not used
<span class="nc" id="L597">			final String escapedQueueName = JdmoUtil.formatDBString(objValue.getName());</span>

<span class="nc" id="L599">			final String pStmt1 = &quot;insert into QUEUE (ID, NAME, DESCRIPTION, MEDIAID, QUEUETYPE, ORGANIZATIONID) values (?,&quot; </span>
				+ &quot; ?, ?, ?, ?, ?)&quot;;
<span class="nc" id="L601">			Object[] param = new Object[6];</span>
<span class="nc" id="L602">			param[0] = idStr;</span>

			// These don't need escaping because they are bound to ? style
			// prepared statement thingies
<span class="nc" id="L606">			param[1] = objValue.getName();</span>
<span class="nc" id="L607">			param[2] = objValue.getDescription();</span>

<span class="nc" id="L609">			param[3] = objValue.getMediaStrID();</span>
<span class="nc" id="L610">			param[4] = new Integer(objValue.getQueueType());</span>
<span class="nc" id="L611">			param[5] = objValue.getOrganizationID();</span>

			// failsafe. No defined org ID = system org.
<span class="nc bnc" id="L614" title="All 2 branches missed.">			if (param[5] == null) {</span>
<span class="nc" id="L615">				objValue.setOrganizationID(new ID(-3002));</span>
<span class="nc" id="L616">				param[5] = objValue.getOrganizationID();</span>
			}

<span class="nc" id="L619">			jdmo.executePCommand(pStmt1, param);</span>

			// Query the new row for its database generated SID
<span class="nc" id="L622">			StringBuilder pStmt = new StringBuilder(&quot;select SID from QUEUE where ID=?&quot;);</span>
<span class="nc" id="L623">			final JdmoQuery jq1 = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L624">			jq1.setParString(1, idStr);</span>
<span class="nc" id="L625">			JdmoRowset rs = jdmo.createRowset(jq1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="nc" id="L627">			ID queueID = null;</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L629">				queueID = rs.getID(1);</span>

				// Create a QUEUE edm in EDM table (this is used for warehouse
				// number crunching, based on concept of extended dimension)
				// TODO: Logic of EDM relationship to QUEUE seems like it
				// belongs in biz layer not DAO layer
<span class="nc" id="L635">				pStmt = new StringBuilder(&quot;SELECT * FROM EDM WHERE UPPER(RTRIM(LTRIM(NAME))) = UPPER('&quot;);</span>
<span class="nc" id="L636">				pStmt.append((escapedQueueName).trim());</span>
<span class="nc" id="L637">				pStmt.append(&quot;')&quot;);</span>
<span class="nc" id="L638">				rs = jdmo.createRowset(pStmt.toString(), Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">				if (!rs.next()) {</span>
<span class="nc" id="L640">					pStmt = new StringBuilder(&quot;INSERT INTO EDM (ID, EDTID, NAME, DESCRIPTION, &quot;);</span>
<span class="nc" id="L641">					pStmt.append(&quot;ISDEFAULT, CREATIONDATE, ISACTIVE, ISAUTOMAPPING) &quot;);</span>
<span class="nc" id="L642">					pStmt.append(&quot;VALUES (?, -277000, ?, ?, 0, GETDATE(), 1, 1)&quot;);</span>
<span class="nc" id="L643">					final ID edmId = JdmoPKGeneratorFactory.create(&quot;EDM&quot;, false).generate(jdmo.getConnection(), &quot;EDM&quot;);</span>
<span class="nc" id="L644">					param = new Object[3];</span>
<span class="nc" id="L645">					param[0] = edmId.toString();</span>

					// These don't need escaping because they are bound to ?
					// style prepared statement thingies
<span class="nc" id="L649">					param[1] = objValue.getName();</span>
<span class="nc" id="L650">					param[2] = objValue.getDescription();</span>

<span class="nc" id="L652">					jdmo.executePCommand(pStmt.toString(), param);</span>

					// Create EMD mapping to F&amp;S data source: Insert data into
					// EDMDATASOURCE, EDMDATASOURCEEXT
					// EDMDATASOURCE Table
<span class="nc" id="L657">					pStmt = new StringBuilder(&quot;INSERT INTO EDMDATASOURCE (ID, DATASOURCEID, INDATASOURCEID, EDMID) &quot;);</span>
<span class="nc" id="L658">					pStmt.append(&quot;VALUES (?, null, -50000, ?)&quot;);</span>
<span class="nc" id="L659">					final ID edmDataSourceId = JdmoPKGeneratorFactory.create(&quot;EDMDATASOURCE&quot;, false).generate(</span>
<span class="nc" id="L660">						jdmo.getConnection(), &quot;EDMDATASOURCE&quot;);</span>
<span class="nc" id="L661">					param = new Object[2];</span>
<span class="nc" id="L662">					param[0] = edmDataSourceId.toString();</span>
<span class="nc" id="L663">					param[1] = edmId.toString();</span>
<span class="nc" id="L664">					jdmo.executePCommand(pStmt.toString(), param);</span>
					// EDMDATASOURCEEXT Table
<span class="nc" id="L666">					pStmt = new StringBuilder(&quot;INSERT INTO EDMDATASOURCEEXT (ID, EXTERNALEDMIDENT, EDMDATASOURCEID) &quot;);</span>
<span class="nc" id="L667">					pStmt.append(&quot;VALUES (?, ?, ?)&quot;);</span>
<span class="nc" id="L668">					final ID edmDataSourceExtId = JdmoPKGeneratorFactory.create(&quot;EDMDATASOURCEEXT&quot;, false).generate(</span>
<span class="nc" id="L669">						jdmo.getConnection(), &quot;EDMDATASOURCEEXT&quot;);</span>
<span class="nc" id="L670">					param = new Object[3];</span>
<span class="nc" id="L671">					param[0] = edmDataSourceExtId.toString();</span>
<span class="nc" id="L672">					param[1] = idStr;</span>
<span class="nc" id="L673">					param[2] = edmDataSourceId.toString();</span>
<span class="nc" id="L674">					jdmo.executePCommand(pStmt.toString(), param);</span>
				}
			}
<span class="nc" id="L677">			return queueID;</span>
		} finally {
<span class="nc" id="L679">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Remove a Queue by SID
	 *
	 * @param SID
	 */
	static void deleteQueues(Collection&lt;ID&gt; colIDs) throws JdmoException {
<span class="nc" id="L689">		String queueIds = StringUtil.join(colIDs, &quot;,&quot;);</span>
<span class="nc" id="L690">		try (Jdmo jdmo = new Jdmo()) {</span>
<span class="nc" id="L691">			JdmoQuery query = jdmo.createQuery(&quot;BP_DeleteQueues&quot;, Jdmo.STORPROC_QUERY_NORS);</span>
<span class="nc" id="L692">			query.setParString(1, queueIds);</span>
<span class="nc" id="L693">			jdmo.execute(query);</span>
<span class="nc bnc" id="L694" title="All 8 branches missed.">		}</span>
<span class="nc" id="L695">	}</span>

	/**
	 * Remove a Queue by SID
	 *
	 * @param SID
	 */
	static void updateQueue(Queue objValue) throws JdmoException {

<span class="nc" id="L704">		final Jdmo jdmo = new Jdmo();</span>
		try {
			// Keep the old name (escaped) as well as the new name (escaped)
			// except for ? style prepared statements
<span class="nc" id="L708">			final String oldQueueNameEscaped = JdmoUtil.formatDBString(getQueueNameByID(objValue.getID()));</span>
<span class="nc" id="L709">			final String queueNameEscaped = JdmoUtil.formatDBString(objValue.getName());</span>

<span class="nc" id="L711">			StringBuilder pStmt = new StringBuilder(&quot;update QUEUE set NAME=?, &quot;)</span>
<span class="nc" id="L712">				.append(&quot;DESCRIPTION=?, MEDIAID=?, PARENTQUEUEID= ?, QUEUETYPE=?, ORGANIZATIONID=? where SID=?&quot;);</span>
<span class="nc" id="L713">			final Object[] param = new Object[7];</span>
<span class="nc" id="L714">			param[0] = objValue.getName();</span>
<span class="nc" id="L715">			param[1] = objValue.getDescription();</span>
<span class="nc" id="L716">			param[2] = objValue.getMediaStrID();</span>
<span class="nc" id="L717">			final String parentID = objValue.getParentQueueID();</span>
<span class="nc" id="L718">			final Object jobj = new JdmoParam(null, 3);</span>
<span class="nc bnc" id="L719" title="All 4 branches missed.">			param[3] = ((parentID == null) || parentID.trim().equals(&quot;&quot;)) ? jobj : parentID;</span>
<span class="nc" id="L720">			param[4] = new Integer(objValue.getQueueType());</span>
<span class="nc" id="L721">			param[5] = objValue.getOrganizationID().toString();</span>
<span class="nc" id="L722">			param[6] = objValue.getID();</span>
<span class="nc" id="L723">			jdmo.executePCommand(pStmt.toString(), param);</span>

			// Update to new name, desc in EDM table (using name as the pseudo
			// Key a/k/a alternate unique key)
<span class="nc" id="L727">			final String strQueueDesc = JdmoUtil.formatDBString(objValue.getDescription());</span>

<span class="nc" id="L729">			pStmt = new StringBuilder(&quot;UPDATE EDM SET NAME = '&quot;);</span>
<span class="nc" id="L730">			pStmt.append(queueNameEscaped).append(&quot;' &quot;);</span>
<span class="nc" id="L731">			pStmt.append(&quot;, DESCRIPTION = '&quot;);</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">			pStmt.append(strQueueDesc != null ? strQueueDesc : &quot;&quot;);</span>
<span class="nc" id="L733">			pStmt.append(&quot;' &quot;);</span>
<span class="nc" id="L734">			pStmt.append(&quot;WHERE NAME='&quot;);</span>
<span class="nc" id="L735">			pStmt.append(oldQueueNameEscaped).append(&quot;' &quot;);</span>
<span class="nc" id="L736">			jdmo.executeCommand(pStmt.toString());</span>

		} finally {
<span class="nc" id="L739">			jdmo.cleanUp();</span>
<span class="nc" id="L740">		}</span>

<span class="nc" id="L742">	}</span>

	static String getQueueNameByID(ID idQueue) throws JdmoException {
<span class="nc" id="L745">		final Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L747">			final StringBuilder pStmt = new StringBuilder(&quot;select NAME from QUEUE where SID=?&quot;);</span>
<span class="nc" id="L748">			final JdmoQuery jq = dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L749">			jq.setParID(1, idQueue);</span>
<span class="nc" id="L750">			final JdmoRowset rs = dmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L751">			String queueName = null;</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L753">				queueName = rs.getString(1);</span>
			}
<span class="nc" id="L755">			return queueName;</span>
		} finally {
<span class="nc" id="L757">			dmo.cleanUp();</span>
		}
	}

	/**
	 * Routine to return the ID of a queue given the name. Throws an erro if
	 * name is not unique
	 *
	 * @param name
	 * @return ID
	 * @throws JdmoException
	 */
	static ID getQueueIDByName(String name) throws JdmoException {
<span class="nc" id="L770">		ID queueID = null;</span>

<span class="nc" id="L772">		final Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L774">			final StringBuilder pStmt = new StringBuilder(&quot;select SID from QUEUE where NAME=?&quot;);</span>
<span class="nc" id="L775">			final JdmoQuery jq = dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L776">			jq.setParString(1, name);</span>
<span class="nc" id="L777">			final JdmoRowset rs = dmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="nc bnc" id="L779" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L780">				queueID = rs.getID(1);</span>

				// check unique
<span class="nc bnc" id="L783" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L784">					throw new JdmoException(&quot;Non unique queue name; &quot; + name);</span>
				}
			}

		} finally {
<span class="nc" id="L789">			dmo.cleanUp();</span>
<span class="nc" id="L790">		}</span>

<span class="nc" id="L792">		return queueID;</span>
	}

	static HashMap&lt;ID, String&gt; getQueueNamesByIDs(Collection&lt;ID&gt; idCol) throws JdmoException {
<span class="nc" id="L796">		final Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L798">			final StringBuilder pStmt = new StringBuilder(&quot;select SID, NAME from QUEUE where SID in &quot;);</span>
<span class="nc" id="L799">			pStmt.append(dmo.createInClause(idCol));</span>
<span class="nc" id="L800">			final JdmoRowset rs = dmo.createRowset(pStmt.toString());</span>
<span class="nc" id="L801">			final HashMap&lt;ID, String&gt; nameMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L803">				nameMap.put(rs.getID(1), rs.getString(2));</span>
			}
<span class="nc" id="L805">			return nameMap;</span>
		} finally {
<span class="nc" id="L807">			dmo.cleanUp();</span>
		}
	}

	/**
	 * Get a pair of maps given a collection of queue DE String ids
	 *
	 * @return a map of queue DEID to queue name, and a map of queue DEID to SID
	 */
	static Pair&lt;Map&lt;ID, String&gt;, Map&lt;ID, ID&gt;&gt; getQueueNameSIDMapsByDEIDs(Collection&lt;ID&gt; idCol) throws JdmoException {
<span class="nc" id="L817">		final Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L819">			final StringBuilder pStmt = new StringBuilder(&quot;select ID, SID, NAME from QUEUE where ID in &quot;);</span>
<span class="nc" id="L820">			pStmt.append(dmo.createInClause(idCol));</span>
<span class="nc" id="L821">			final JdmoRowset rs = dmo.createRowset(pStmt.toString());</span>
<span class="nc" id="L822">			final Map&lt;ID, String&gt; nameMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L823">			final Map&lt;ID, ID&gt; sidMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L825">				nameMap.put(rs.getID(1), rs.getString(3));</span>
<span class="nc" id="L826">				sidMap.put(rs.getID(1), rs.getID(2));</span>
			}
<span class="nc" id="L828">			return new Pair&lt;&gt;(nameMap, sidMap);</span>
		} finally {
<span class="nc" id="L830">			dmo.cleanUp();</span>
		}
	}

	/**
	 * @param colIDs - collection of queue SIDs
	 * @throws JdmoException
	 */
	static void unLinkQueuesParents(Collection&lt;ID&gt; colIDs) throws JdmoException {
<span class="nc" id="L839">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L841">			final StringBuilder pStmt = new StringBuilder(&quot;update QUEUE set PARENTQUEUEID=NULL where SID in &quot;);</span>
<span class="nc" id="L842">			pStmt.append(jdmo.createInClause(colIDs));</span>
<span class="nc" id="L843">			jdmo.executeCommand(pStmt.toString());</span>
		} finally {
<span class="nc" id="L845">			jdmo.cleanUp();</span>
<span class="nc" id="L846">		}</span>
<span class="nc" id="L847">	}</span>

	/**
	 * @param queueID - queue SID
	 * @param colIDs  - collection of queue SIDs
	 * @throws JdmoException
	 */
	static void linkQueues(ID queueID, Collection&lt;ID&gt; colIDs) throws JdmoException {
<span class="nc" id="L855">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L857">			final StringBuilder pStmt = new StringBuilder(</span>
				&quot;update QUEUE set PARENTQUEUEID=(select ID from QUEUE q where SID =?)  where SID in &quot;);
<span class="nc" id="L859">			pStmt.append(jdmo.createInClause(colIDs));</span>
<span class="nc" id="L860">			final Object[] param = new Object[1];</span>
<span class="nc" id="L861">			param[0] = queueID;</span>

<span class="nc" id="L863">			jdmo.executePCommand(pStmt.toString(), param);</span>
		} finally {
<span class="nc" id="L865">			jdmo.cleanUp();</span>
<span class="nc" id="L866">		}</span>

<span class="nc" id="L868">	}</span>

	/**
	 * get queues given type bit mask
	 */
	static Collection&lt;Queue&gt; getQueuesByType(int queueTypeBitMask) throws JdmoException {
<span class="nc" id="L874">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L876">			final StringBuilder pStmt = new StringBuilder(</span>
				&quot;select a.SID as QUEUEID, a.NAME, a.DESCRIPTION, A.PARENTQUEUEID,(select sid from queue q where a&quot;
					+ &quot;.parentqueueid = q.id) as PARENTSID , A.QUEUETYPE, A.ORGANIZATIONID, C.NAME as ORGANIZATIONNAME, b&quot; 
					+ &quot;.SID as MEDIAID, b.NAME as MEDIANAME, B.ID as MEDIASTRID from QUEUE a, MEDIA b, ORGANIZATION c where&quot; 
					+ &quot; a.ORGANIZATIONID = c.ID and a.MEDIAID = b.ID&quot;);
<span class="nc" id="L881">			final List&lt;ID&gt; primQueues = new ArrayList&lt;&gt;(3);</span>
<span class="nc" id="L882">			final List&lt;ID&gt; parentQueues = new ArrayList&lt;&gt;(2);</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">			if ((queueTypeBitMask &amp; Queue.QUEUE_TYPE_BIT_NORMAL) != 0) {</span>
<span class="nc" id="L884">				primQueues.add(new ID(Queue.QUEUE_TYPE_NORMAL));</span>
			}

<span class="nc bnc" id="L887" title="All 2 branches missed.">			if ((queueTypeBitMask &amp; Queue.QUEUE_TYPE_BIT_PROCESS) != 0) {</span>
<span class="nc" id="L888">				primQueues.add(new ID(Queue.QUEUE_TYPE_PROCESS));</span>
			}

<span class="nc bnc" id="L891" title="All 2 branches missed.">			if ((queueTypeBitMask &amp; Queue.QUEUE_TYPE_BIT_DISTRIBUTED) != 0) {</span>
<span class="nc" id="L892">				primQueues.add(new ID(Queue.QUEUE_TYPE_DISTRIBUTED));</span>
			}
<span class="nc bnc" id="L894" title="All 2 branches missed.">			if ((queueTypeBitMask &amp; Queue.QUEUE_TYPE_BIT_VIRTUAL) != 0) {</span>
<span class="nc" id="L895">				primQueues.add(new ID(Queue.QUEUE_TYPE_VIRTUAL));</span>
			}

<span class="nc bnc" id="L898" title="All 2 branches missed.">			if ((queueTypeBitMask &amp; Queue.QUEUE_TYPE_BIT_SUB_DISTRIBUTED) != 0) {</span>
<span class="nc" id="L899">				parentQueues.add(new ID(Queue.QUEUE_TYPE_DISTRIBUTED));</span>
			}
<span class="nc bnc" id="L901" title="All 2 branches missed.">			if ((queueTypeBitMask &amp; Queue.QUEUE_TYPE_BIT_SUB_VIRTUAL) != 0) {</span>
<span class="nc" id="L902">				parentQueues.add(new ID(Queue.QUEUE_TYPE_VIRTUAL));</span>
			}

<span class="nc bnc" id="L905" title="All 4 branches missed.">			if (!primQueues.isEmpty() || !parentQueues.isEmpty()) {</span>
<span class="nc" id="L906">				pStmt.append(&quot; AND (&quot;);</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">				if (!primQueues.isEmpty()) {</span>
<span class="nc" id="L908">					pStmt.append(&quot;QUEUETYPE IN &quot;);</span>
<span class="nc" id="L909">					pStmt.append(jdmo.createInClause(primQueues));</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">					if (!parentQueues.isEmpty()) {</span>
<span class="nc" id="L911">						pStmt.append(&quot; OR (PARENTQUEUEID in (select ID from QUEUE where queuetype in &quot;);</span>
<span class="nc" id="L912">						pStmt.append(jdmo.createInClause(parentQueues));</span>
<span class="nc" id="L913">						pStmt.append(&quot; ))&quot;);</span>
					}
				} else {
<span class="nc" id="L916">					pStmt.append(&quot; AND PARENTQUEUEID in (select ID from QUEUE where queuetype in &quot;);</span>
<span class="nc" id="L917">					pStmt.append(jdmo.createInClause(parentQueues));</span>
<span class="nc" id="L918">					pStmt.append(&quot; )&quot;);</span>
				}
<span class="nc" id="L920">				pStmt.append(&quot; )&quot;);</span>

			}
<span class="nc" id="L923">			return getQueues(jdmo, pStmt);</span>
		} finally {
<span class="nc" id="L925">			jdmo.cleanUp();</span>
		}

	}

	/**
	 * @param distributedQueues - collection of distributed queues IDs
	 * @return Collection of Queues
	 */
	static Collection&lt;Queue&gt; getSubQueueus(Collection&lt;ID&gt; distributedQueuesIDs) throws JdmoException {
<span class="nc" id="L935">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L937">			final StringBuilder pStmt = new StringBuilder(</span>
				&quot;select a.SID as QUEUEID, a.NAME, a.DESCRIPTION, A.PARENTQUEUEID,(select sid from queue q where a&quot; 
					+ &quot;.parentqueueid = q.id) as PARENTSID , A.QUEUETYPE, A.ORGANIZATIONID, c.NAME as ORGANIZATIONNAME, b&quot; 
					+ &quot;.SID as MEDIAID, b.NAME as MEDIANAME, B.ID as MEDIASTRID from QUEUE a, MEDIA b, ORGANIZATION c where&quot; 
					+ &quot; a.ORGANIZATIONID = c.ID and a.MEDIAID = b.ID&quot;);
<span class="nc" id="L942">			pStmt.append(&quot; AND A.PARENTQUEUEID in (select a.ID from QUEUE where A.SID in &quot;);</span>
<span class="nc" id="L943">			pStmt.append(jdmo.createInClause(distributedQueuesIDs));</span>
<span class="nc" id="L944">			pStmt.append(&quot;)&quot;);</span>
<span class="nc" id="L945">			return getQueues(jdmo, pStmt);</span>
		} finally {
<span class="nc" id="L947">			jdmo.cleanUp();</span>
		}
	}

	static Collection&lt;ID&gt; getSubQueuesIDs(Collection&lt;ID&gt; queuesIDs) throws JdmoException {
<span class="nc" id="L952">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L954">			final StringBuilder pStmt = new StringBuilder(</span>
				&quot;select a.SID as QUEUEID from QUEUE a where A.PARENTQUEUEID in (select q.ID from QUEUE q where q.SID in &quot;);
<span class="nc" id="L956">			pStmt.append(jdmo.createInClause(queuesIDs));</span>
<span class="nc" id="L957">			pStmt.append(&quot;)&quot;);</span>
<span class="nc" id="L958">			final JdmoQuery jq = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L959">			final JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L960">			final List&lt;ID&gt; collIDs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L962">				collIDs.add(new ID(rs.getInt(&quot;QUEUEID&quot;)));</span>
			}
<span class="nc" id="L964">			return collIDs;</span>
		} finally {
<span class="nc" id="L966">			jdmo.cleanUp();</span>
		}

	}

	private static Collection&lt;Queue&gt; getQueues(Jdmo jdmo, StringBuilder pStmt) throws JdmoException {
<span class="nc" id="L972">		final JdmoQuery jq = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L973">		final JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L974">		final ArrayList&lt;Queue&gt; queuesColl = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L975" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L976">			queuesColl.add(getQueue(rs));</span>
		}
<span class="nc" id="L978">		return queuesColl;</span>

	}

	/**
	 * Returns the non-combined queues in the given SP with the given media ID.
	 * If a null media ID is specified, this method will return all non-combined
	 * queues in the SP.
	 */
	public static Collection&lt;Queue&gt; getNonCombinedQueuesByMediaAndSP(ID mediaID, ID spID) throws JdmoException {
<span class="nc" id="L988">		final Jdmo jdmo = new Jdmo();</span>
		try {

<span class="nc" id="L991">			spID = DAOUtil.mapIDToDEID(spID, new SchedulingPeriodFieldInfo());</span>
<span class="nc" id="L992">			mediaID = DAOUtil.mapIDToDEID(mediaID, new MediaFieldInfo());</span>

<span class="nc" id="L994">			String query = &quot;select a.SID as QUEUEID, a.NAME, a.DESCRIPTION, A.PARENTQUEUEID,&quot;</span>
				+ &quot;(select sid from queue q where a.parentqueueid = q.id) as PARENTSID ,&quot;
				+ &quot;A.QUEUETYPE, A.ORGANIZATIONID, c.NAME as ORGANIZATIONNAME, b.SID as MEDIAID,&quot;
				+ &quot;b.NAME as MEDIANAME, B.ID as MEDIASTRID from QUEUE a, MEDIA b,&quot;
				+ &quot;ORGANIZATION c, SPQUEUE d where a.ORGANIZATIONID = c.ID and a.MEDIAID = b.ID and &quot;
<span class="nc" id="L999">				+ &quot;a.ID = d.QUEUEID and &quot; + &quot;d.SPID = &quot; + JdmoUtil.asSqlLiteral(spID) + &quot; and &quot;</span>
				+ &quot;d.QUEUEID IS NOT NULL&quot;;
<span class="nc bnc" id="L1001" title="All 2 branches missed.">			if (mediaID != null) {</span>
<span class="nc" id="L1002">				query += &quot; and a.MEDIAID =  &quot; + JdmoUtil.asSqlLiteral(mediaID);</span>
			}
<span class="nc" id="L1004">			final StringBuilder pStmt = new StringBuilder(query);</span>
<span class="nc" id="L1005">			return getQueues(jdmo, pStmt);</span>
<span class="nc" id="L1006">		} catch (final BbmFinderException e) {</span>
<span class="nc" id="L1007">			throw new JdmoException(e);</span>
		} finally {
<span class="nc" id="L1009">			jdmo.cleanUp();</span>
		}
	}

	public static Collection&lt;ID&gt; getRootLinkQueueIDs(ID spID) throws JdmoException {
<span class="nc" id="L1014">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1016">			final StringBuilder pStmt = new StringBuilder(&quot;SELECT	DISTINCT Q.SID FROM VCTCHAIN VC, VCTCHAINQUEUE VCQ, &quot;</span>
				+ &quot;VCTQUEUECONFIGURATION VQC, QUEUE Q, SPQUEUE SPQ, QUEUE Q2, &quot;
				+ &quot;VCTQUEUECONFIGURATION VQC2, MEDIA M, SP WHERE VCQ.VCTCHAINID = VC.ID &quot;
				+ &quot;AND M.ID = Q.MEDIAID AND VQC.ID = VC.VCTQUEUECONFIGURATIONID &quot;
				+ &quot;AND VQC.QUEUEID = Q.SID AND SPQ.QUEUEID = Q.ID AND SPQ.SPID = SP.ID &quot; + &quot;AND SP.SID=&quot;
<span class="nc" id="L1021">				+ JdmoUtil.asSqlLiteral(spID) + &quot;AND SPQ.QUEUEID IS NOT NULL AND ISMULTISELECT = 0 AND &quot;</span>
				+ &quot;Q2.SID = VCQ.QUEUEID AND VQC2.QUEUEID = VCQ.QUEUEID &quot; + &quot;AND ((VC.TARGETEVENT = 1) OR &quot;
				+ &quot;(VC.TARGETEVENT = 3 AND VQC2.COLLECTIONTYPE = 3)) &quot;
				+ &quot;AND VQC.QUEUEID NOT IN (SELECT QUEUEID FROM VCTCHAINQUEUE)&quot;);
<span class="nc" id="L1025">			final ArrayList&lt;ID&gt; queueIDs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1026">			final JdmoQuery jq = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L1027">			final JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1029">				queueIDs.add(rs.getID(1));</span>
			}
<span class="nc" id="L1031">			return queueIDs;</span>
		} finally {
<span class="nc" id="L1033">			jdmo.cleanUp();</span>
		}
	}

	public static Queue getQueue(JdmoRowset rs) throws JdmoException {
<span class="nc" id="L1038">		final Queue queue = new Queue();</span>
<span class="nc" id="L1039">		queue.setID(new ID(rs.getInt(&quot;QUEUEID&quot;)));</span>
<span class="nc" id="L1040">		queue.setName(rs.getString(&quot;NAME&quot;));</span>
<span class="nc" id="L1041">		queue.setDescription(rs.getString(&quot;DESCRIPTION&quot;));</span>
<span class="nc" id="L1042">		queue.setMediaID(new ID(rs.getInt(&quot;MEDIAID&quot;)));</span>
<span class="nc" id="L1043">		queue.setMediaName(rs.getString(&quot;MEDIANAME&quot;));</span>
<span class="nc" id="L1044">		queue.setMediaStrID(rs.getString(&quot;MEDIASTRID&quot;));</span>
<span class="nc" id="L1045">		queue.setQueueType(rs.getInt(&quot;QUEUETYPE&quot;));</span>
<span class="nc" id="L1046">		queue.setParentQueueID(rs.getString(&quot;PARENTQUEUEID&quot;));</span>
<span class="nc" id="L1047">		queue.setParentID(rs.getID(&quot;PARENTSID&quot;));</span>
<span class="nc" id="L1048">		queue.setOrganizationID(rs.getID(&quot;ORGANIZATIONID&quot;));</span>
<span class="nc" id="L1049">		queue.setOrganizationName(rs.getString(&quot;ORGANIZATIONNAME&quot;));</span>
<span class="nc" id="L1050">		return queue;</span>
	}

	/**
	 * This method is used by Strategic Planner application
	 *
	 * @param rs - result set contains information from QUEUE, ORGANIZATION and TIMEZONE tables
	 * @return Queue Note: Not all the Queue information are set
	 * @throws JdmoException
	 */
	public static Queue getQueueInfoForPlanner(JdmoRowset rs) throws JdmoException {
<span class="nc" id="L1061">		final Queue queue = new Queue();</span>
<span class="nc" id="L1062">		queue.setID(new ID(rs.getInt(&quot;QUEUEID&quot;)));</span>
<span class="nc" id="L1063">		queue.setDEID(new ID(rs.getString(&quot;ID&quot;)));</span>
<span class="nc" id="L1064">		queue.setName(rs.getString(&quot;NAME&quot;));</span>
<span class="nc" id="L1065">		queue.setMediaStrID(rs.getString(&quot;MEDIAID&quot;));</span>
<span class="nc" id="L1066">		queue.setOrganizationID(rs.getID(&quot;ORGANIZATIONID&quot;));</span>
<span class="nc" id="L1067">		return queue;</span>
	}

	/**
	 * This method is used by Strategic Planner application
	 *  Note: This method is same as the getQueueInfoForPlanner method except the result set does not have QUEUEID
	 * @param rs - result set contains information from QUEUE, ORGANIZATION and TIMEZONE tables
	 * @return Queue Note: Not all the Queue information are set
	 * @throws JdmoException
	 */
	public static Queue getAllQueuesInfoForPlanner(JdmoRowset rs) throws JdmoException {
<span class="nc" id="L1078">		final Queue queue = new Queue();</span>
<span class="nc" id="L1079">		queue.setName(rs.getString(&quot;NAME&quot;));</span>
<span class="nc" id="L1080">		queue.setDEID(ID.fromString(&quot;ID&quot;));</span>
<span class="nc" id="L1081">		queue.setOrganizationID(rs.getID(&quot;ORGANIZATIONID&quot;));</span>
<span class="nc" id="L1082">		queue.setMediaStrID(rs.getString(&quot;MEDIAID&quot;));</span>
<span class="nc" id="L1083">		return queue;</span>
	}

	/**
	 * /**
	 * Get the queues corresponding to the SIDs in {@code queueIDs}, or all
	 * queues if {@code queueIDs} is {@code null}.
	 */
	public Collection&lt;Queue&gt; getObjects(Collection&lt;ID&gt; queueIDs) throws BbmFinderException {
		try {
<span class="nc bnc" id="L1093" title="All 2 branches missed.">			if (queueIDs == null) {</span>
<span class="nc" id="L1094">				return getAllQueues();</span>
			}
<span class="nc" id="L1096">			return getQueuesByIDs(queueIDs);</span>
<span class="nc" id="L1097">		} catch (final JdmoException e) {</span>
<span class="nc" id="L1098">			throw new BbmFinderException(e);</span>
		}
	}

	/**
	 * This function returns List of Parent and Child Organization Id's for the
	 * given Organization ID
	 *
	 * @param orgId
	 * @return List of ID
	 * @throws JdmoException
	 */
	public static List&lt;ID&gt; getOrganizationHierarchy(ID orgId, boolean down) throws JdmoException {
<span class="nc" id="L1111">		final Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1113">			final StringBuilder pStmt = new StringBuilder(getOrganizationHierarchyQuery(down));</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">			if (down) {</span>
<span class="nc" id="L1115">				pStmt.append(&quot;-- Doing a Union for both the Up and Down heirarchy result \n&quot;).append(</span>
					&quot; SELECT * FROM ORGANIZATIONHIERARCHICYDOWN  union &quot;);
			}
<span class="nc" id="L1118">			pStmt.append(&quot;select * from ORGANIZATIONHIERARCHICYUP&quot;);</span>
<span class="nc" id="L1119">			final ArrayList&lt;ID&gt; orgIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1120">			final JdmoQuery jq = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L1121">			jq.setParID(1, orgId);</span>
<span class="nc bnc" id="L1122" title="All 2 branches missed.">			if (down) {</span>
<span class="nc" id="L1123">				jq.setParID(2, orgId);</span>
			}
<span class="nc" id="L1125">			final JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L1126" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1127">				orgIds.add(rs.getID(1));</span>
			}
<span class="nc" id="L1129">			return orgIds;</span>
		} finally {
<span class="nc" id="L1131">			jdmo.cleanUp();</span>
		}
	}

	public static String getSqlQueryToGetQueuesWithHistoricalDataInThePeriod(Date startDate, Date endDate) {
<span class="nc" id="L1136">		StringBuffer stringBuffer = new StringBuffer();</span>
<span class="nc" id="L1137">		stringBuffer.append(&quot;SELECT DISTINCT QUEUE.SID AS QUEUEID, QUEUE.NAME, QUEUE.ID,QUEUE.ORGANIZATIONID, QUEUE&quot; </span>
			+ &quot;.MEDIAID,&quot;);
<span class="nc" id="L1139">		stringBuffer.append(&quot; TIMEZONEMAP.JAVATZIDENT TZ \n&quot;);</span>
<span class="nc" id="L1140">		stringBuffer.append(&quot;FROM QUEUEHISTORYTIMESERIES, QUEUE, TIMEZONE, TIMEZONEMAP, CAMPAIGN, SP, SPQUEUE \n&quot;);</span>
<span class="nc" id="L1141">		stringBuffer.append(&quot;WHERE QUEUEHISTORYTIMESERIES.QUEUEID=QUEUE.ID AND \n&quot;);</span>
<span class="nc" id="L1142">		stringBuffer.append(&quot;(SPQUEUE.QUEUEID = QUEUE.ID OR SPQUEUE.QUEUEID = QUEUE.PARENTQUEUEID) AND \n&quot;);</span>
<span class="nc" id="L1143">		stringBuffer.append(&quot; SP.ID = SPQUEUE.SPID AND \n&quot;);</span>
<span class="nc" id="L1144">		stringBuffer.append(&quot; CAMPAIGN.ID = SP.CAMPAIGNID AND \n&quot;);</span>
<span class="nc" id="L1145">		stringBuffer.append(&quot; CAMPAIGN.TIMEZONEID = TIMEZONE.ID AND \n&quot;);</span>
<span class="nc" id="L1146">		stringBuffer.append(&quot; TIMEZONE.STANDARDNAME = TIMEZONEMAP.WINTZSTDNAME AND \n&quot;);</span>
<span class="nc" id="L1147">		stringBuffer.append(&quot; QUEUE.QUEUETYPE = 0 AND \n&quot;);</span>
<span class="nc" id="L1148">		stringBuffer.append(&quot; QUEUEHISTORYTIMESERIES.TIME &gt;=&quot;);</span>
<span class="nc" id="L1149">		JdmoUtil.asSqlLiteral(startDate, stringBuffer);</span>
<span class="nc" id="L1150">		stringBuffer.append(&quot;AND QUEUEHISTORYTIMESERIES.TIME &lt;&quot;);</span>
<span class="nc" id="L1151">		JdmoUtil.asSqlLiteral(endDate, stringBuffer);</span>
<span class="nc" id="L1152">		return stringBuffer.toString();</span>
	}

	public static StringBuilder getSqlQueryToGetQueuesForImport() {
<span class="nc" id="L1156">		StringBuilder pStmt = new StringBuilder();</span>
<span class="nc" id="L1157">		pStmt.append(&quot;SELECT QUEUE.SID AS QUEUEID, QUEUE.NAME, QUEUE.ID,QUEUE.ORGANIZATIONID, QUEUE.MEDIAID, TIMEZONEMAP&quot; </span>
			+ &quot;.JAVATZIDENT TZ \n&quot;);
<span class="nc" id="L1159">		pStmt.append(&quot;FROM QUEUE, TIMEZONE, TIMEZONEMAP, CAMPAIGN, SP, SPQUEUE  \n&quot;);</span>
<span class="nc" id="L1160">		pStmt.append(&quot;WHERE QUEUE.ID in (SELECT DISTINCT QUEUEID from QUEUEHISTORYTIMESERIES) AND \n&quot;);</span>
<span class="nc" id="L1161">		pStmt.append(&quot;(SPQUEUE.QUEUEID = QUEUE.ID OR SPQUEUE.QUEUEID = QUEUE.PARENTQUEUEID) AND  \n&quot;);</span>
<span class="nc" id="L1162">		pStmt.append(&quot; SP.ID = SPQUEUE.SPID AND  \n&quot;);</span>
<span class="nc" id="L1163">		pStmt.append(&quot;CAMPAIGN.ID = SP.CAMPAIGNID AND \n&quot;);</span>
<span class="nc" id="L1164">		pStmt.append(&quot;CAMPAIGN.TIMEZONEID = TIMEZONE.ID AND  \n&quot;);</span>
<span class="nc" id="L1165">		pStmt.append(&quot;TIMEZONEMAP.WINTZSTDNAME = TIMEZONE.STANDARDNAME AND  \n&quot;);</span>
<span class="nc" id="L1166">		pStmt.append(&quot;QUEUE.QUEUETYPE = 0 \n&quot;);</span>
<span class="nc" id="L1167">		pStmt.append(&quot;GROUP BY QUEUE.SID, QUEUE.NAME,QUEUE.ID,QUEUE.MEDIAID,TIMEZONEMAP.JAVATZIDENT,QUEUE.ORGANIZATIONID &quot; </span>
			+ &quot;ORDER BY QUEUE.NAME&quot;);
<span class="nc" id="L1169">		return pStmt;</span>
	}

	public static StringBuilder getSqlQueryToGetQueuesForLongtermForecast() {
<span class="nc" id="L1173">		StringBuilder pStmt = new StringBuilder();</span>
<span class="nc" id="L1174">		pStmt.append(&quot;SELECT QUEUE.SID AS QUEUEID, QUEUE.NAME, QUEUE.ID,QUEUE.ORGANIZATIONID, QUEUE.MEDIAID, TIMEZONEMAP&quot; </span>
			+ &quot;.JAVATZIDENT as TZ \n&quot;);
<span class="nc" id="L1176">		pStmt.append(&quot;FROM QUEUEHISTORYTIMESERIES, QUEUE, TIMEZONE, TIMEZONEMAP, CAMPAIGN, SP, SPQUEUE  \n&quot;);</span>
<span class="nc" id="L1177">		pStmt.append(&quot;WHERE QUEUEHISTORYTIMESERIES.QUEUEID=QUEUE.ID AND \n&quot;);</span>
<span class="nc" id="L1178">		pStmt.append(&quot;(SPQUEUE.QUEUEID = QUEUE.ID OR SPQUEUE.QUEUEID = QUEUE.PARENTQUEUEID) AND  \n&quot;);</span>
<span class="nc" id="L1179">		pStmt.append(&quot;SP.ID = SPQUEUE.SPID AND  \n&quot;);</span>
<span class="nc" id="L1180">		pStmt.append(&quot;CAMPAIGN.ID = SP.CAMPAIGNID AND \n&quot;);</span>
<span class="nc" id="L1181">		pStmt.append(&quot;CAMPAIGN.TIMEZONEID = TIMEZONE.ID AND  \n&quot;);</span>
<span class="nc" id="L1182">		pStmt.append(&quot;TIMEZONEMAP.WINTZSTDNAME = TIMEZONE.STANDARDNAME AND  \n&quot;);</span>
<span class="nc" id="L1183">		pStmt.append(&quot;(QUEUE.QUEUETYPE = 0 OR QUEUE.QUEUETYPE = 2)\n&quot;);</span>
<span class="nc" id="L1184">		pStmt.append(&quot;GROUP BY QUEUE.SID, QUEUE.NAME,QUEUE.ID,QUEUE.MEDIAID,TIMEZONEMAP.JAVATZIDENT,QUEUE.ORGANIZATIONID &quot; </span>
			+ &quot;ORDER BY QUEUE.NAME&quot;);
<span class="nc" id="L1186">		return pStmt;</span>
	}

	public static StringBuilder getSqlQueryToGetQueueForExport() {
<span class="nc" id="L1190">		return new StringBuilder(&quot;SELECT QUEUE.SID AS QUEUEID, QUEUE.NAME, QUEUE.ID, QUEUE.ORGANIZATIONID, QUEUE.MEDIAID, &quot; </span>
			+ &quot;TIMEZONEMAP.JAVATZIDENT as TZ  \n&quot; +
			&quot;FROM QUEUE, TIMEZONE, TIMEZONEMAP, CAMPAIGN, SP, SPQUEUE \n&quot; +
			&quot;WHERE SP.ID = SPQUEUE.SPID AND  \n&quot; +
			&quot;CAMPAIGN.ID = SP.CAMPAIGNID AND  \n&quot; +
			&quot;CAMPAIGN.TIMEZONEID = TIMEZONE.ID AND \n&quot; +
			&quot;TIMEZONEMAP.WINTZSTDNAME = Timezone.STANDARDNAME \n&quot; +
			&quot;GROUP BY  QUEUE.SID, QUEUE.NAME,QUEUE.ID,QUEUE.MEDIAID, TIMEZONEMAP.JAVATZIDENT, QUEUE.ORGANIZATIONID ORDER BY&quot; 
			+ &quot; QUEUE.NAME\n&quot;);

	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>