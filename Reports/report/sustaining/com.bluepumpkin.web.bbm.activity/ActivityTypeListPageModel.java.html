<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityTypeListPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.activity</a> &gt; <span class="el_source">ActivityTypeListPageModel.java</span></div><h1>ActivityTypeListPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.activity;

import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategory;
import com.bluepumpkin.ejb.bbm.workresource.OrganizationScopeManagerProxy;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TOAccrualCalculator;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrgWorkpaneListPageModel;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        ActivityTypeListPageModel
 * Description:  Display the list of Activity Types per given organization
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       Shimon Kakon
 * @version 1.0
 */
public class ActivityTypeListPageModel extends OrgWorkpaneListPageModel {
<span class="nc" id="L38">	private static final Category log = Log.initCategory(ActivityTypeListPageModel.class.getName());</span>
	private Collection m_activityTypes;
<span class="nc" id="L40">	private HashMap m_orgMap = null;</span>
<span class="nc" id="L41">	private boolean m_hasMyTimeLicense = false;</span>
<span class="nc" id="L42">	private boolean m_hasAccrualLicense = false;</span>

	// sort actions
	public static final String LIST_NAME_SORT = &quot;LIST_NAME_SORT&quot;;
	public static final String LIST_DESCRIPTION_SORT = &quot;LIST_DESCRIPTION_SORT&quot;;
	public static final String LIST_MY_TIME_SORT = &quot;LIST_MY_TIME_SORT&quot;;
	public static final String LIST_ORG_SORT = &quot;LIST_ORG_SORT&quot;;
	public static final String LIST_TO_ALLOTMENT_SORT = &quot;LIST_TO_ALLOTMENT_SORT&quot;;
	public static final String LIST_ACCRUAL_SCHEDULE_SORT = &quot;LIST_ACCRUAL_SCHEDULE_SORT&quot;;
	public static final String LIST_ACCRUAL_POLICY_SORT = &quot;LIST_ACCRUAL_POLICY_SORT&quot;;

	/**
	 * Constructor
	 *
	 * @param context the request context
	 */
	public ActivityTypeListPageModel(RequestContext context) {
<span class="nc" id="L59">		super(context);</span>

		// Add JavaScript Variables
<span class="nc" id="L62">		addJSVariable(DELETE_CONFIRMATION, m_bbmBundle, BbmWebBundleKey.ACTIVITY_TYPE_DELETE_CONFIRMATION);</span>
<span class="nc" id="L63">	}</span>



	/**
	 * Return instance of Model which is ready to be rendered
	 *
	 * @param context - The request context
	 * @return Activity Type List PageModel
	 */
	public static ActivityTypeListPageModel getInstance(RequestContext context) {
<span class="nc" id="L74">		return (ActivityTypeListPageModel)getInstance(context, ActivityTypeListPageModel.class);</span>
	}

	/**
	 * get URL for HTML Form Action
	 *
	 * @return the form action
	 */
	public String getFormAction() {
<span class="nc" id="L83">		return &quot;activity_type_list&quot;;</span>
	}

	/**
	 * Initialize List
	 * Override default toolbar defined in WorkpaneListPageModel
	 */
	protected void initList() {
<span class="nc" id="L91">		checkForLicenses();</span>
<span class="nc" id="L92">		super.initList();</span>
<span class="nc" id="L93">		m_list.setIsZebra(true);</span>
<span class="nc" id="L94">		TableHeaderPC header = m_list.getHeader();</span>
		// Set up Headers
<span class="nc" id="L96">		header.addColumnHeaderData(LIST_NAME_SORT,</span>
<span class="nc" id="L97">				i18n(m_common_bundle, UIFWebBundleKey.LIST_HEADER_NAME));</span>
<span class="nc" id="L98">		header.addColumnHeaderData(LIST_DESCRIPTION_SORT,</span>
<span class="nc" id="L99">				i18n(m_common_bundle, UIFWebBundleKey.LIST_HEADER_DESCRIPTION));</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">		if (m_hasMyTimeLicense){</span>
<span class="nc" id="L101">			header.addColumnHeaderData(LIST_MY_TIME_SORT,</span>
<span class="nc" id="L102">					i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_TYPE_LIST_HEADER_MY_TIME));</span>
		}
<span class="nc" id="L104">		header.addColumnHeaderData(LIST_ORG_SORT,</span>
<span class="nc" id="L105">				i18n(m_bbmBundle, BbmWebBundleKey.LIST_HEADER_OWNER_ORG));</span>
		
<span class="nc bnc" id="L107" title="All 2 branches missed.">		header.addColumnHeaderData(LIST_TO_ALLOTMENT_SORT,</span>
<span class="nc" id="L108">				i18n(m_bbmBundle, m_hasAccrualLicense ? </span>
						BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF_WITH_ACCRUAL :
						BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF_WITH_ALLOTMENT));
		
<span class="nc bnc" id="L112" title="All 2 branches missed.">		if (m_hasAccrualLicense) {</span>
<span class="nc" id="L113">			header.addColumnHeaderData(LIST_ACCRUAL_SCHEDULE_SORT,</span>
<span class="nc" id="L114">					i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LABEL_TIMEOFF_ACCRUAL_SCHEDULE));</span>
<span class="nc" id="L115">			header.addColumnHeaderData(LIST_ACCRUAL_POLICY_SORT,</span>
<span class="nc" id="L116">					i18n(m_bbmBundle, BbmWebBundleKey.ACCRUAL_POLICY));</span>
		}

		// Enable List Sorting
<span class="nc" id="L120">		header.setDefaultSortColumn(LIST_NAME_SORT);</span>
<span class="nc" id="L121">		m_list.setIsAutoSortEnabled(true);</span>
<span class="nc" id="L122">	}</span>



	/**
	 * Initialize toolbar
	 * Override default toolbar defined in WorkpaneListPageModel
	 */
	protected void initToolbar() {
<span class="nc" id="L131">		String addLabel = i18n(m_bbmBundle,</span>
			BbmWebBundleKey.ACTIVITY_TYPE_CREATE_NEW_ACTION);
<span class="nc" id="L133">		String editLabel = i18n(m_bbmBundle,</span>
			BbmWebBundleKey.ACTIVITY_TYPE_EDIT_ACTION);
<span class="nc" id="L135">		String delLabel = i18n(m_bbmBundle,</span>
			BbmWebBundleKey.ACTIVITY_TYPE_DELETE_ACTION);

<span class="nc" id="L138">		useDefaultToolbar(false, addLabel, editLabel, delLabel);</span>
<span class="nc" id="L139">	}</span>



	/**
	 * Get the default sort order.
	 * Override default toolbar defined in WorkpaneListPageModel
	 */
	protected String getDefaultSortColumn() {
<span class="nc" id="L148">		return LIST_NAME_SORT;</span>
	}



	/**
	 * Returns true if the list support sorting.
	 * Override default toolbar defined in WorkpaneListPageModel
	 */
	protected boolean isSortSupported() {
<span class="nc" id="L158">		return true;</span>
	}



	/**
	 * Create the list model
	 */
	protected void createListModel(){
<span class="nc bnc" id="L167" title="All 2 branches missed.">		if(!this.loadActivityTypes()) {</span>
<span class="nc" id="L168">			return;</span>
		}

<span class="nc" id="L171">		ArrayList listModel = new ArrayList();</span>
<span class="nc" id="L172">		ActivityCategory activityType = null;</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">		for(Iterator it = m_activityTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L175">			activityType = (ActivityCategory)it.next();</span>

			// Create the row data
<span class="nc" id="L178">			ArrayList rowData = new ArrayList(4);</span>
<span class="nc" id="L179">			rowData.add( activityType.getName() );</span>
<span class="nc" id="L180">			rowData.add( activityType.getDescription() );</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">			if (m_hasMyTimeLicense){</span>
<span class="nc" id="L182">				rowData.add( getYesNoString(activityType.isVisibleToTimeCollection()) );</span>
			}
<span class="nc" id="L184">			rowData.add( m_orgMap.get(activityType.getOrganizationId()) );</span>
<span class="nc" id="L185">			rowData.add( getYesNoString(activityType.isTOAllotment()) );</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">			if (m_hasAccrualLicense) {</span>
<span class="nc" id="L187">				rowData.add( ActivityModelHandler.getAccrualScheduleStr(m_localizer,</span>
<span class="nc" id="L188">						activityType.getTOAccrualSchedule()) );</span>
<span class="nc" id="L189">				rowData.add( ActivityModelHandler.getAccrualPolicyStr(m_localizer,</span>
<span class="nc" id="L190">						activityType.getTOAccrualPolicy()) );</span>
			}

			// Set if the row should be editable or not. Row should be editable if the
			// selected org is the owner of the activity type
<span class="nc" id="L195">			HashMap rowAttributes = new HashMap(1);</span>
<span class="nc" id="L196">			ScopeID scopeID = OrganizationScopeManagerProxy.getScopeID(activityType.getOrganizationId());</span>
			
<span class="nc bnc" id="L198" title="All 2 branches missed.">			if (!m_context.getUser().isAuthorized(PrivilegeKeys.CORE_ADDACTIVITIES, scopeID)) {</span>
<span class="nc" id="L199">				rowAttributes.put(IS_ADDABLE, &quot;false&quot;);</span>
			}
<span class="nc" id="L201">			rowAttributes.put( this.IS_EDITABLE,</span>
<span class="nc" id="L202">				this.isRowEditable(activityType.getOrganizationId()) );</span>
<span class="nc" id="L203">			rowAttributes.put(IS_DELETEABLE, isRowDeleteable(activityType.getOrganizationId()));</span>
			// Add row data to list model
<span class="nc" id="L205">			String rowID = activityType.getID().toString();</span>
<span class="nc" id="L206">			listModel.add( new DefaultMultiColumnNodeData(rowID, rowData, rowAttributes));</span>

			// Check if row should be selected, assuming only one should be selected
<span class="nc bnc" id="L209" title="All 2 branches missed.">			if (OrganizationModelHandler.UNREASONABLE_ORG_ID.equals(m_selectedRowOrgID)) {</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">				if(this.isRowSelected(activityType.getID())) {</span>
<span class="nc" id="L211">					m_list.addSelectedRowID(rowID);</span>
<span class="nc" id="L212">					m_selectedRowOrgID = activityType.getOrganizationId();</span>
				}
			}

<span class="nc" id="L216">		} //end for</span>

<span class="nc" id="L218">		m_list.setListModel( listModel );</span>
<span class="nc" id="L219">	}</span>



	/**
	 * Get entity name. Used for title.
	 */
	protected String getTitleEntityType() {
<span class="nc" id="L227">		return i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_TYPE_LIST_TITLE);</span>
	}



	/**
	 * Return localized string Yes/No based on input
	 */
	private String getYesNoString(boolean isYes) {
<span class="nc bnc" id="L236" title="All 2 branches missed.">		if (isYes) {</span>
<span class="nc" id="L237">			return i18n(m_common_bundle, UIFWebBundleKey.FIELD_VALUE_YES);</span>
		} else {
<span class="nc" id="L239">			return i18n(m_common_bundle, UIFWebBundleKey.FIELD_VALUE_NO);</span>
		}
	}


	/**
	 * Loads all the activity types value objects
	 *
	 * @return true if load was successful
	 */
	private boolean loadActivityTypes() {
		try {
<span class="nc" id="L251">			m_activityTypes = ActivityTypeModelHandler.getActivityTypes(m_context, getSelectedIDObject(), true);</span>
<span class="nc bnc" id="L252" title="All 4 branches missed.">			if(m_activityTypes != null &amp;&amp; m_activityTypes.size() &gt; 0) {</span>
				// extract the list of org IDs
<span class="nc" id="L254">				HashSet orgIds = new HashSet(m_activityTypes.size());</span>
<span class="nc" id="L255">				ActivityCategory activityType = null;</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">				for(Iterator it = m_activityTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L257">					activityType = (ActivityCategory)it.next();</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">					if(!orgIds.contains(activityType.getOrganizationId())) {</span>
<span class="nc" id="L259">						orgIds.add(activityType.getOrganizationId());</span>
					}
				}
<span class="nc" id="L262">				m_orgMap = OrganizationModelHandler.buildOrganizationMap(m_context, orgIds);</span>
			}

<span class="nc" id="L265">			return true;</span>
<span class="nc" id="L266">		} catch (Exception ex) {</span>
<span class="nc" id="L267">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L268">			return false;</span>
		}


				//m_orgMap = OrganizationModelHandler.buildOrganizationMap(orgIDs);

	}


	/**
	 * Return true if Current User is authorized to configure specified Organization
	 */
	protected boolean isAuthorizedToConfigure(ID orgID) {
<span class="nc" id="L281">		return m_context.getUser().isAuthorized(PrivilegeKeys.CORE_EDITACTIVITIES,</span>
<span class="nc" id="L282">				OrganizationScopeManagerProxy.getScopeID(orgID));</span>
	}


	/**
	* Return true if Current User is authorized to configure specified Organization
	*/
	protected boolean isAuthorizedToView(ID orgID) {
<span class="nc" id="L290">		return m_context.getUser().isAuthorized(PrivilegeKeys.CORE_VIEWACTIVITIES,</span>
<span class="nc" id="L291">				OrganizationScopeManagerProxy.getScopeID(orgID));</span>
	}


	/**
	 * Return localized message indicating that current user is not authorized
	 * to view activities in the selected Organization.
	 */
	protected String getNotAuthorizedToViewMsg() {
<span class="nc" id="L300">		return MessageFormat.format(</span>
<span class="nc" id="L301">			i18n(m_bbmBundle, BbmWebBundleKey.NOT_AUTHORIZED_TO_VIEW_ENTITY_IN_SELECTED_ORG),</span>
<span class="nc" id="L302">			new Object[] { i18n(m_bbmBundle, BbmWebBundleKey.BBM_ORG_ACT_CATEGORIES) } );</span>
	}

	private void checkForLicenses(){
		try {
<span class="nc" id="L307">			m_hasMyTimeLicense = CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_MY_TIME);</span>
<span class="nc" id="L308">		} catch (Exception ex){</span>
<span class="nc" id="L309">			log.l7dError(BbmWebBundleKey.UNABLE_TO_LOAD_DATA, ex);</span>
<span class="nc" id="L310">		}</span>
		
<span class="nc" id="L312">		m_hasAccrualLicense = TOAccrualCalculator.hasLicenseForAccrual();</span>
<span class="nc" id="L313">	}</span>

	/**
	 * Is the list row editable?
	 * Override parent to allow editing of activities defined in the root
	 *
	 * @param rowOrgID the row's organization ID
	 * @return &quot;true&quot; if a row is editable, &quot;false&quot; otherwise
	 *
	 */
	protected String isRowEditable(ID rowOrgID) {
<span class="nc bnc" id="L324" title="All 2 branches missed.">		if(rowOrgID.equals(Organization.ROOT_ORG_ID_OBJ)) {</span>
<span class="nc" id="L325">			return super.isRowEditable(Organization.YOUR_COMPANY_ID_OBJ);</span>
		}
		else {
<span class="nc" id="L328">			return super.isRowEditable(rowOrgID);</span>
		}
	}
	/**
	 * is the add action should be enabled?
	 */
	protected boolean isAddActionEnabled() {
<span class="nc" id="L335">		boolean isAuthorizedToAdd= m_context.getUser().isAuthorized(PrivilegeKeys.CORE_ADDACTIVITIES,</span>
<span class="nc" id="L336">				OrganizationScopeManagerProxy.getScopeID(getSelectedIDObject()));</span>
<span class="nc" id="L337">		return isAuthorizedToAdd;</span>
	}

	

	/**
	 * is the edit action should be enabled?
	 */
	protected boolean isEditActionEnabled() {
<span class="nc" id="L346">		boolean isSuperEnabled = super.isEditActionEnabled();</span>
<span class="nc" id="L347">		boolean isAuthorizedToEdit= m_context.getUser().isAuthorized(PrivilegeKeys.CORE_EDITACTIVITIES,</span>
<span class="nc" id="L348">				OrganizationScopeManagerProxy.getScopeID(getSelectedIDObject()));</span>
<span class="nc bnc" id="L349" title="All 4 branches missed.">		return isEditDeleteActionsEnabled(isSuperEnabled) &amp;&amp;isAuthorizedToEdit;</span>
	}

	/**
	 * is the delete action should be enabled?
	 * * Override parent to prevent deletion of activities defined in the root
	 */
	protected boolean isDeleteActionEnabled() {
<span class="nc bnc" id="L357" title="All 2 branches missed.">		if(m_selectedRowOrgID.equals(Organization.ROOT_ORG_ID_OBJ)) {</span>
<span class="nc" id="L358">			return false;</span>
		}
		else {
<span class="nc" id="L361">			boolean isSuperEnabled = super.isDeleteActionEnabled();</span>
<span class="nc" id="L362">			boolean isAuthorizedToDelete= m_context.getUser().isAuthorized(PrivilegeKeys.CORE_DELETEACTIVITIES,</span>
<span class="nc" id="L363">					OrganizationScopeManagerProxy.getScopeID(getSelectedIDObject())); </span>
<span class="nc bnc" id="L364" title="All 4 branches missed.">			return isEditDeleteActionsEnabled(isSuperEnabled) &amp;&amp; isAuthorizedToDelete;</span>
		}
	}
	/**
	 * Is the list row delete-able?
	 * Activities defined in the root should never be deleteable
	 *
	 * @param rowOrgID the row's organization ID
	 * @return &quot;true&quot; if a row is editable, &quot;false&quot; otherwise
	 *
	 */
	protected String isRowDeleteable(ID rowOrgID) {
<span class="nc" id="L376">			String deleteable = &quot;false&quot;;</span>

<span class="nc" id="L378">			ID selectedOrgID = getSelectedIDObject();</span>
<span class="nc" id="L379">			boolean isAuthorizedToDelete= m_context.getUser().isAuthorized(PrivilegeKeys.CORE_DELETEACTIVITIES,</span>
<span class="nc" id="L380">					OrganizationScopeManagerProxy.getScopeID(selectedOrgID)); </span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">			if ( selectedOrgID != null &amp;&amp;</span>
<span class="nc bnc" id="L382" title="All 4 branches missed.">					 selectedOrgID.equals(rowOrgID) &amp;&amp; isAuthorizedToDelete ) {</span>
<span class="nc" id="L383">				deleteable = &quot;true&quot;;</span>
			}

<span class="nc" id="L386">			return deleteable;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>