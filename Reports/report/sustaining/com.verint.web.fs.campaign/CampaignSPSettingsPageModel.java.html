<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignSPSettingsPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.campaign</a> &gt; <span class="el_source">CampaignSPSettingsPageModel.java</span></div><h1>CampaignSPSettingsPageModel.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.campaign;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOO;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.OrganizationHOO;
import com.bluepumpkin.ejb.core.CoreEJBCreateException;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.bbm.campaign.selection.CampaignSchedulingPeriodSelectionUtil;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.organization.selection.OrganizationSelectorPC;
import com.bluepumpkin.web.core.pagecomponent.CheckBoxPC;
import com.bluepumpkin.web.core.pagecomponent.time.TimePeriodSelectorController;
import com.bluepumpkin.web.core.pagecomponent.time.TimePeriodSelectorPC;
import com.bluepumpkin.web.core.pagecomponent.time.TimePeriodSelectorSPWeekController;
import com.bluepumpkin.web.bbm.campaign.sp.SchedulingPeriodUtil;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.licensing.ejb.LicenseManager;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.CommonWebBundleKey;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.picker.time.TimePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.TimeZoneOverrideTogglePC;
import com.witness.web.uif.pagecomponent.tree.MultiColInputTreePC;
import com.witness.web.uif.pagemodel.SettingPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.TimeZoneOverrideUtil;
import com.witness.web.uif.util.html.HtmlBooleanCheckbox;
import com.witness.web.uif.util.js.JSUtil;

@SuppressWarnings(&quot;serial&quot;)
public class CampaignSPSettingsPageModel extends SettingPM {
	private ResourceBundle m_bundle;
	private FormTwoColumnPC m_formPC;
	private FormInputPC m_formInputPC;
	private String m_selectedCampaignIDs;
	private String m_selectedSchedulingPeriodIDs;
	private SchedulingPeriod m_SP;
<span class="nc" id="L76">	private Campaign m_campaign = null;</span>
	private TimePickerPC m_timePickerPC;
	private OrganizationSelectorPC m_orgSelectorPC;
	private FormTwoColumnPC m_formHooPC;
	private TimePeriodSelectorPC m_pctimePeriod;

	// 1~7 are being used
<span class="nc" id="L83">	private final TimePickerPC[] startTimePCs = new TimePickerPC[8];</span>
	// 1~7 are being used
<span class="nc" id="L85">	private final TimePickerPC[] endTimePCs = new TimePickerPC[8];</span>
<span class="nc" id="L86">	private final CheckBoxPC[] checkboxPCs = new CheckBoxPC[8];</span>

<span class="nc" id="L88">	private List&lt;CampaignHOO&gt; m_hoos = null;</span>
<span class="nc" id="L89">	private CampaignHOO m_hoo = null;</span>
<span class="nc" id="L90">	private String m_description = null;</span>
<span class="nc" id="L91">	private Boolean m_skillbased = null;</span>
<span class="nc" id="L92">	private Boolean m_isUsingAllEmployees = null;</span>
	protected TimeZone optimizationTargetTimeZone;
	private TimeZoneOverrideTogglePC m_timezonePC;

	public static final String MULTI_VALUE = &quot;*&quot;;
	public static final String SP_DESC_FN = &quot;description&quot;;
	public static final String SP_WEEK_START_DAY_FN = &quot;spweekstartday&quot;;
	public static final String SP_TIMEZONE_ID_FN = &quot;sptimezoneid&quot;;
	public static final String SP_DAY_BOUNDARY_OFFSET_FN = &quot;spdayboundary&quot;;
	public static final String SP_SKILL_BASED = &quot;skillbased&quot;;
	public static final String SP_USING_ALL_EMPLOYEES = &quot;usingAllEmployees&quot;;

	private static final String DAY_BOUNDARY = &quot;HooDayBoundary&quot;;
	private static final String SP_ORIG_WEEK_START_DAY_FN = &quot;sporigweekstartday&quot;;
	public static final String ON_CHANGE_SCRIPT = &quot;pageMediator.refreshPageWithAction('&quot;
			+ PageAction.SP_REFRESH_HOO_WITH_ORG + &quot;', true);&quot;;

	private static final String START_TP_PREFIX = &quot;HooStart&quot;;
	private static final String END_TP_PREFIX = &quot;HooEnd&quot;;
	private static final String RANGE_SPAN_PREFIX = &quot;HooRange&quot;;
	private static final String IS_ACTIVE_PREFIX = &quot;HooIsActive&quot;;
	private static final String START_DAY_PREFIX = &quot;HooStartDay&quot;;
	private static final String END_DAY_PREFIX = &quot;HooEndDay&quot;;
<span class="nc" id="L115">	private Collection&lt;ID&gt; orgIDs = null;</span>

	public CampaignSPSettingsPageModel(RequestContext context) {
<span class="nc" id="L118">		super(context);</span>

<span class="nc" id="L120">		m_bundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L122">		m_SP = new SchedulingPeriod();</span>

<span class="nc" id="L124">		m_formPC = new FormTwoColumnPC(context);</span>
<span class="nc" id="L125">		m_formPC.setName(&quot;GeneralTwoColumnPC&quot;);</span>
<span class="nc" id="L126">		addChildComponent(m_formPC);</span>

<span class="nc" id="L128">		m_formHooPC = new FormTwoColumnPC(context);</span>
<span class="nc" id="L129">		m_formHooPC.setName(&quot;HooTwoColumnPC&quot;);</span>
<span class="nc" id="L130">		addChildComponent(m_formHooPC);</span>

<span class="nc" id="L132">		m_formInputPC = new FormInputPC(context);</span>
<span class="nc" id="L133">		addChildComponent(m_formInputPC);</span>

		// Add Date Time Picker for Day Boundary
<span class="nc" id="L136">		m_timePickerPC = new TimePickerPC(context);</span>
<span class="nc" id="L137">		m_timePickerPC.setInputFieldName(SP_DAY_BOUNDARY_OFFSET_FN);</span>
<span class="nc" id="L138">		m_timePickerPC.setTimeInterval(15);</span>
<span class="nc" id="L139">		addChildComponent(m_timePickerPC);</span>

<span class="nc" id="L141">		m_orgSelectorPC = createOrgSelectorPC(&quot;spOrgSelectorPC&quot;);</span>
<span class="nc" id="L142">		addChildComponent(m_orgSelectorPC);</span>

		TimePickerPC tp;
		CheckBoxPC cb;

		/**
		 * SPExtHOOonCheck will copy the previous day's start/end times when a day's checkbox is enabled. Then it will call
		 * cordinateUI() to update the rest of the HOO elements.
		 */
<span class="nc" id="L151">		addJSVariable(&quot;SPExtHOOonCheck&quot;, &quot;function(iDay) {\n&quot; + &quot; var var1 = DOM2.getElementById('&quot; + IS_ACTIVE_PREFIX</span>
				+ &quot;'+iDay+'__input_id');\n&quot; + &quot; if(var1.checked &amp;&amp; iDay&gt;1 &amp;&amp; iDay&lt;8){\n&quot; + &quot; var iLastDay=iDay-1;\n&quot;
				+ &quot; pageMediator.setValue('&quot; + START_TP_PREFIX + &quot;'+iDay+'_0', pageMediator.getValue('&quot; + START_TP_PREFIX
				+ &quot;'+iLastDay+'_0'));\n&quot; + &quot; pageMediator.setValue('&quot; + END_TP_PREFIX
				+ &quot;'+iDay+'_0', pageMediator.getValue('&quot; + END_TP_PREFIX + &quot;'+iLastDay+'_0'));\n&quot; + &quot; cordinateUI();\n&quot;
				+ &quot; }\n&quot; + &quot;}&quot;);

<span class="nc bnc" id="L158" title="All 2 branches missed.">		for (short iDay = 1; iDay &lt; 8; iDay++) {</span>
<span class="nc" id="L159">			tp = new TimePickerPC(context, START_TP_PREFIX + iDay, false);</span>
<span class="nc" id="L160">			tp.setTimeInterval(15);</span>
<span class="nc" id="L161">			this.addChildComponent(tp);</span>
<span class="nc" id="L162">			startTimePCs[iDay] = tp;</span>
<span class="nc" id="L163">			startTimePCs[iDay].setIsMultiValueSupported(true);</span>
<span class="nc" id="L164">			tp = new TimePickerPC(context, END_TP_PREFIX + iDay, false);</span>
<span class="nc" id="L165">			tp.setTimeInterval(15);</span>
<span class="nc" id="L166">			this.addChildComponent(tp);</span>
<span class="nc" id="L167">			endTimePCs[iDay] = tp;</span>
<span class="nc" id="L168">			endTimePCs[iDay].setIsMultiValueSupported(true);</span>

			// why do we need to enable/disable the time pickers before calling cordinateUI, since
			// cordinatUI already does that?
<span class="nc" id="L172">			String onIsPaidJS =</span>
<span class="nc" id="L173">					enableTimePickerJS(START_TP_PREFIX + iDay, true) + enableTimePickerJS(END_TP_PREFIX + iDay, true)</span>
<span class="nc" id="L174">							+ this.getCoordinateUiJS();</span>
<span class="nc" id="L175">			String onIsNotPaidJS =</span>
<span class="nc" id="L176">					enableTimePickerJS(START_TP_PREFIX + iDay, false) + enableTimePickerJS(END_TP_PREFIX + iDay, false)</span>
<span class="nc" id="L177">							+ this.getCoordinateUiJS();</span>

			// why do we even need onIsPaidJS, since SPExtHOOonCheck calls cordinateUI at the end?
<span class="nc" id="L180">			cb =</span>
					new CheckBoxPC(context, IS_ACTIVE_PREFIX + iDay, false, onIsPaidJS + &quot;;&quot; + &quot;SPExtHOOonCheck(&quot; + iDay
							+ &quot;);&quot;, onIsNotPaidJS);
<span class="nc" id="L183">			this.addChildComponent(cb);</span>
<span class="nc" id="L184">			checkboxPCs[iDay] = cb;</span>
		}
<span class="nc" id="L186">	}</span>

	private OrganizationSelectorPC createOrgSelectorPC(String name) {
<span class="nc" id="L189">		OrganizationSelectorPC orgSelPC = new OrganizationSelectorPC(m_context, m_toolbar);</span>
<span class="nc" id="L190">		orgSelPC.setName(name);</span>
<span class="nc" id="L191">		orgSelPC.setOnSelectAction(MultiColInputTreePC.HANDLE_ON_SELECT_SYNC_CHILD);</span>
<span class="nc" id="L192">		return orgSelPC;</span>
	}

	public static CampaignSPSettingsPageModel getInstance(RequestContext context) {
<span class="nc" id="L196">		return (CampaignSPSettingsPageModel) getInstance(context, CampaignSPSettingsPageModel.class);</span>
	}

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L201">		boolean success = super.extractParameters(request);</span>

		// weekStartDay is the current viewing weekstart day. origWeekStartDay
		// is the true Hoo start day.
<span class="nc" id="L205">		String strWeekStartDay = request.getParameter(SP_WEEK_START_DAY_FN);</span>
<span class="nc" id="L206">		String strOrigWeekStartDay = request.getParameter(SP_ORIG_WEEK_START_DAY_FN);</span>
<span class="nc bnc" id="L207" title="All 4 branches missed.">		if (strWeekStartDay == null || strOrigWeekStartDay == null) {</span>
<span class="nc" id="L208">			return success;</span>
		}

<span class="nc" id="L211">		int origWeekStartDay = Integer.parseInt(strOrigWeekStartDay);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">		if (m_hoo == null) {</span>
<span class="nc" id="L213">			m_hoo = new CampaignHOO();</span>
		}

<span class="nc" id="L216">		m_orgSelectorPC.extractParameters(request);</span>
<span class="nc" id="L217">		String orgs = m_orgSelectorPC.getSelectedIDs();</span>
<span class="nc" id="L218">		orgIDs = StringUtil.parseIDStringToCollection(orgs);</span>

<span class="nc bnc" id="L220" title="All 2 branches missed.">		for (short iDay = 1; iDay &lt; 8; iDay++) {</span>
<span class="nc" id="L221">			short iHooIndex = (short) (iDay + origWeekStartDay - 1);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">			if (iHooIndex &gt; 7) {</span>
<span class="nc" id="L223">				iHooIndex -= 7;</span>
			}

<span class="nc" id="L226">			boolean isActive = checkboxPCs[iDay].isChecked();</span>
			int start;
			int end;
<span class="nc bnc" id="L229" title="All 2 branches missed.">			if (isActive) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">				if (startTimePCs[iDay].isMultiValue()) {</span>
<span class="nc" id="L231">					start = -1;</span>
				} else {
<span class="nc" id="L233">					start = startTimePCs[iDay].getTimeInMinutes();</span>
				}

<span class="nc bnc" id="L236" title="All 2 branches missed.">				if (endTimePCs[iDay].isMultiValue()) {</span>
<span class="nc" id="L237">					end = -1;</span>
				} else {
<span class="nc" id="L239">					end = endTimePCs[iDay].getTimeInMinutes();</span>
				}

<span class="nc" id="L242">				m_hoo.setDayOpen(iHooIndex, (short) start);</span>
<span class="nc" id="L243">				m_hoo.setDayClose(iHooIndex, (short) end);</span>
			} else {
				// deactivation overrides DayOpen &amp; DayClose
<span class="nc" id="L246">				m_hoo.setActive(iHooIndex, false);</span>
			}
		}

<span class="nc" id="L250">		return success;</span>
	}

	@Override
	protected boolean isDeleteActionEnabled() {
		// TODO Auto-generated method stub
<span class="nc" id="L256">		return true;</span>
	}

	@Override
	protected void initContentTitle() {
<span class="nc" id="L261">		super.initContentTitle();</span>
<span class="nc" id="L262">		m_contentTitlePC.setPageTitle(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME,</span>
				FsWebBundleKey.CAMPAIGN_SP_SETTINGS_PAGE_TITLE));

<span class="nc bnc" id="L265" title="All 6 branches missed.">		if (m_campaign != null &amp;&amp; isSPSelected() || m_isAddMode) {</span>

<span class="nc bnc" id="L267" title="All 2 branches missed.">			if (!m_isAddMode) {</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">				if (!m_context.getUser().isAuthorized(PrivilegeKeys.FS_VIEWCAMPAIGN_ID,</span>
<span class="nc" id="L269">						new ScopeID(m_campaign.getID(), Scope.CAMPAIGN_SCOPE))) {</span>
<span class="nc" id="L270">					return;</span>
				}
			}

<span class="nc" id="L274">			m_pctimePeriod = new TimePeriodSelectorPC(m_context, getTimePeriodSelectorController());</span>
<span class="nc" id="L275">			this.addChildComponent(m_pctimePeriod);</span>
<span class="nc" id="L276">			m_contentTitlePC.setActiveComponent(m_pctimePeriod);</span>
			// Add time zone toggle

<span class="nc bnc" id="L279" title="All 2 branches missed.">			if (optimizationTargetTimeZone != null) {</span>
<span class="nc" id="L280">				m_timezonePC = new TimeZoneOverrideTogglePC(m_context, m_toolbar, optimizationTargetTimeZone, false);</span>
<span class="nc" id="L281">				m_timezonePC.setOnClickJS(&quot;if(showAlertIfPageIsDirty()== false) return;&quot;);</span>
				// ESR#4234460
<span class="nc" id="L283">				m_contentTitlePC.addAdditionalComponent(&quot;&amp;nbsp;&amp;nbsp;&quot; + m_timezonePC);</span>
			}

<span class="nc bnc" id="L286" title="All 2 branches missed.">			if (getSelectedIDSize() &gt; 0) {</span>
				try {
<span class="nc" id="L288">					CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L289">					SchedulingPeriod sp =</span>
<span class="nc" id="L290">							camManager.getSchedulingPeriodByID(getSelectedSchedulingPeriodIDs().iterator().next());</span>
<span class="nc" id="L291">					m_contentTitlePC.setItemName(getSPNameInRegionalFormat(sp));</span>
<span class="nc" id="L292">				} catch (Exception ex) {</span>
<span class="nc" id="L293">					handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L294">				}</span>
			}
		}
<span class="nc" id="L297">	}</span>

	protected TimePeriodSelectorController getTimePeriodSelectorController() {
<span class="nc" id="L300">		TimePeriodSelectorSPWeekController controller = null;</span>
		try {
<span class="nc" id="L302">			CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L303">			SchedulingPeriod sp = camManager.getSchedulingPeriodByID(getSelectedSchedulingPeriodIDs().iterator().next());</span>
<span class="nc" id="L304">			ID campaignID = sp.getCampaignID();</span>
<span class="nc" id="L305">			Campaign selectedCampaign = camManager.getCampaignByID(campaignID);</span>
<span class="nc" id="L306">			controller = new TimePeriodSelectorSPWeekController(selectedCampaign, sp);</span>
<span class="nc" id="L307">		} catch (Exception ex) {</span>
<span class="nc" id="L308">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L309">		}</span>

<span class="nc" id="L311">		return controller;</span>
	}

	public LocalDate[] getLocalDatesSelected() {
<span class="nc bnc" id="L315" title="All 2 branches missed.">		if (m_pctimePeriod == null) {</span>
<span class="nc" id="L316">			m_pctimePeriod = new TimePeriodSelectorPC(m_context, getTimePeriodSelectorController());</span>
		}
<span class="nc" id="L318">		LocalDate start = m_pctimePeriod.getSelectedDateRange().getFirst();</span>
<span class="nc" id="L319">		LocalDate end = m_pctimePeriod.getSelectedDateRange().getSecond();</span>
<span class="nc" id="L320">		return new LocalDate[] { start, end };</span>
	}

	@Override
	protected void initForm() {
		try {
<span class="nc" id="L326">			setForm(m_formPC);</span>
<span class="nc" id="L327">			m_formPC.setTitle(getFormTitle());</span>
<span class="nc" id="L328">			m_formHooPC.setTitle(getHOOFormTitle());</span>

			// Only display form field when there is a selected SPID or it is in
			// Add mode
<span class="nc bnc" id="L332" title="All 6 branches missed.">			if (m_campaign != null &amp;&amp; isSPSelected() || m_isAddMode) {</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">				if (!m_isAddMode) {</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">					if (!m_context.getUser().isAuthorized(PrivilegeKeys.FS_VIEWCAMPAIGN_ID,</span>
<span class="nc" id="L335">							new ScopeID(m_campaign.getID(), Scope.CAMPAIGN_SCOPE))) {</span>
<span class="nc" id="L336">						addPageMessage(Message.INFO_TYPE, FsWebBundleKey.FS_NOT_AUTHORIZED_TO_VIEW_SP_SCOPE,</span>
								FsWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L338">						return;</span>
					}
				}

<span class="nc" id="L342">				boolean isEditable = isAuthorizedToConfigure();</span>

				// in the case of sub campaign of a distributed campaign, need
				// to save the hoo in the timezone
				// of the sub, because that's the true timezone (equvalent to
				// parent's timezone)
<span class="nc" id="L348">				TimeZone trueTimeZone = optimizationTargetTimeZone;</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">				if (m_campaign.getParentID() != null) {</span>
<span class="nc" id="L350">					trueTimeZone = m_campaign.getTimeZone();</span>
				}
<span class="nc" id="L352">				TimeZone curTimeZone = TimeZoneOverrideUtil.getViewingTimeZone(m_context, optimizationTargetTimeZone);</span>
<span class="nc" id="L353">				long dateLong = m_SP.getStartTime().getTime();</span>
<span class="nc" id="L354">				int timezoneOffSet = (curTimeZone.getOffset(dateLong) - trueTimeZone.getOffset(dateLong)) / (60 * 1000);</span>

<span class="nc" id="L356">				boolean bAddTimeZoneOffSet = true;</span>

<span class="nc" id="L358">				CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>

<span class="nc" id="L360">				int weekStartForCurTZ = m_campaign.getWeekStart() + timezoneOffSet;</span>
<span class="nc" id="L361">				int origWeekStartDay = ((m_campaign.getWeekStart() / 1440) % 7) + 1;</span>
<span class="nc" id="L362">				int weekStartDayForCurTZ = 0;</span>

<span class="nc bnc" id="L364" title="All 2 branches missed.">				if (weekStartForCurTZ &lt; 0) {</span>
<span class="nc" id="L365">					weekStartDayForCurTZ = 7;</span>
				} else {
<span class="nc" id="L367">					weekStartDayForCurTZ = ((weekStartForCurTZ / 1440) % 7) + 1;</span>
				}

<span class="nc" id="L370">				addGenericHTML(HtmlUtil.makeHiddenInput(SP_ORIG_WEEK_START_DAY_FN, origWeekStartDay));</span>

<span class="nc" id="L372">				LocalDate start = m_pctimePeriod.getSelectedDateRange().getFirst();</span>
<span class="nc" id="L373">				LocalDate end = m_pctimePeriod.getSelectedDateRange().getSecond();</span>
<span class="nc" id="L374">				long diffDays = (end.getTime().getTime() - start.getTime().getTime()) / (24 * 60 * 60 * 1000);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">				boolean isMultiWeek = diffDays &gt; 8;</span>
<span class="nc" id="L376">				CampaignHOO hoo = null;</span>

<span class="nc bnc" id="L378" title="All 2 branches missed.">				if (isMultiWeek) {</span>
<span class="nc" id="L379">					setIsMultiObjEditEnabled(true);</span>
<span class="nc" id="L380">					hoo = m_hoos.get(0);</span>

<span class="nc bnc" id="L382" title="All 2 branches missed.">					if (SchedulingPeriodUtil.isMonthlyCampaign(m_campaign)) {</span>
						// use the first non-partial HOO week for displaying period HOO values in Monthly SP's
<span class="nc" id="L384">						LocalDate hooStartTimeLocal = hoo.getStartTimeLocal();</span>
<span class="nc" id="L385">						LocalDate hooEndTimeLocal = hoo.getEndTimeLocal();</span>
<span class="nc" id="L386">						int numDaysInWeek = SchedulingPeriodUtil.countNumDays(hooStartTimeLocal, hooEndTimeLocal) - 1;</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">						boolean isPartialWeek = numDaysInWeek &lt; 7;</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">						if (isPartialWeek) {</span>
<span class="nc" id="L389">							hoo = m_hoos.get(1);</span>
						}
<span class="nc" id="L391">					}</span>
				} else {
<span class="nc" id="L393">					int weekIndex = SchedulingPeriodUtil.getWeekIndex(m_campaign, m_SP, start);</span>
<span class="nc" id="L394">					hoo = m_hoos.get(weekIndex);</span>
				}

<span class="nc bnc" id="L397" title="All 2 branches missed.">				if (hoo == null) {</span>
<span class="nc" id="L398">					hoo = new CampaignHOO();</span>
				}

<span class="nc bnc" id="L401" title="All 4 branches missed.">				if (null != getPageAction() &amp;&amp; PageAction.SP_REFRESH_HOO_WITH_ORG.equals(getPageAction())) {</span>
<span class="nc" id="L402">					Collection&lt;ID&gt; orgIdsLinkedToSP = getLinkedOrgsforSP();</span>
<span class="nc bnc" id="L403" title="All 8 branches missed.">					if (orgIdsLinkedToSP != null &amp;&amp; orgIdsLinkedToSP.size() == 0 &amp;&amp; orgIDs != null &amp;&amp; orgIDs.size() &gt; 0) {</span>
<span class="nc" id="L404">						copyHOOFromOrgToSP(isMultiWeek, hoo);</span>
					} else {
<span class="nc" id="L406">						hoo = m_hoo;</span>
<span class="nc" id="L407">						bAddTimeZoneOffSet = false;</span>
					}

<span class="nc" id="L410">					validateOrgSelection(camManager, orgIdsLinkedToSP);</span>
				}

<span class="nc" id="L413">				addDescriptionRowToForm(isEditable);</span>

<span class="nc" id="L415">				addTimeZoneRowToForm();</span>

<span class="nc" id="L417">				addWeekStartDayRowToForm();</span>

<span class="nc" id="L419">				addDayBoundaryRowToForm(weekStartForCurTZ);</span>

<span class="nc" id="L421">				addOrgSelectorRowToForm(isEditable);</span>

<span class="nc" id="L423">				addSkillBasedCheckboxRowToForm(isEditable);</span>

<span class="nc" id="L425">				addUseAllEmployeesCheckboxRowToForm(isEditable);</span>

<span class="nc" id="L427">				addHOOSectionToForm(isEditable, weekStartDayForCurTZ, origWeekStartDay, timezoneOffSet, bAddTimeZoneOffSet,</span>
						isMultiWeek, hoo);
			}
<span class="nc" id="L430">		} catch (Exception ex) {</span>
<span class="nc" id="L431">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L432">		}</span>
<span class="nc" id="L433">	}</span>

	/**
	 * For the first selected org that matches the SP's start day and day boundary, copy the org HOO's start and end times
	 * for each day to the SP HOO (but only for SP days that are not yet marked as active).
	 * @param isMultiWeek
	 * @param hoo
	 * @throws BbmEJBCreateException
	 * @throws BbmException
	 * @throws RemoteException
	 * @throws BbmFinderException
	 */
	protected void copyHOOFromOrgToSP(boolean isMultiWeek, CampaignHOO hoo) throws BbmEJBCreateException, BbmException,
			RemoteException, BbmFinderException {
<span class="nc" id="L447">		WorkResourceManager manager = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode());</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">		for (ID orgID : orgIDs) {</span>
<span class="nc" id="L449">			Organization org = OrganizationModelHandler.getOrganization(m_context, orgID);</span>
<span class="nc" id="L450">			Collection&lt;OrganizationHOO&gt; hooList = manager.getOrganizationHOOAssignments(orgID, null, null);</span>
<span class="nc" id="L451">			OrganizationHOO orghoo = null;</span>

<span class="nc bnc" id="L453" title="All 2 branches missed.">			if (hooList.size() &gt; 0) {</span>
<span class="nc" id="L454">				orghoo = hooList.iterator().next();</span>
			}

<span class="nc bnc" id="L457" title="All 2 branches missed.">			if (org.getTimeZone().equals(m_campaign.getTimeZone())</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">					&amp;&amp; org.getWeekStartDate() == (m_campaign.getWeekStart() / 1440 + 1)</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">					&amp;&amp; org.getDayBoundaryOffset() == (m_campaign.getWeekStart() % 1440)) {</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">				if (isMultiWeek) {</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">					for (CampaignHOO hoo1 : m_hoos) {</span>
<span class="nc" id="L462">						copyStartAndEndHOOFromOrg(orghoo, hoo1);</span>
<span class="nc" id="L463">					}</span>
				} else {
<span class="nc" id="L465">					copyStartAndEndHOOFromOrg(orghoo, hoo);</span>
				}
<span class="nc" id="L467">				break;</span>
			}
<span class="nc" id="L469">		}</span>
<span class="nc" id="L470">	}</span>

	/**
	 * Copy the org HOO's start and end times for each day to the SP HOO (but only for SP days that are not yet marked as
	 * active).
	 * @param orghoo
	 * @param hoo1
	 */
	protected void copyStartAndEndHOOFromOrg(OrganizationHOO orghoo, CampaignHOO hoo1) {
<span class="nc bnc" id="L479" title="All 2 branches missed.">		for (short i = 1; i &lt;= 7; i++) {</span>
			// only set the ones that are inactive
<span class="nc bnc" id="L481" title="All 2 branches missed.">			if (!hoo1.isActive(i)) {</span>
<span class="nc" id="L482">				hoo1.setDayOpen(i, orghoo.getDayOpen(i));</span>
<span class="nc" id="L483">				hoo1.setDayClose(i, orghoo.getDayClose(i));</span>
			}
		}
<span class="nc" id="L486">	}</span>

	/**
	 * check if org is used in child sp already in a distributed campaign situation.
	 * @param camManager
	 * @param orgIdColl
	 * @throws BbmFinderException
	 * @throws BbmObjectNotFoundException
	 * @throws RemoteException
	 * @throws BbmException
	 */
	protected void validateOrgSelection(CampaignManager camManager, Collection&lt;ID&gt; orgIdColl) throws BbmFinderException,
			BbmObjectNotFoundException, RemoteException, BbmException {
<span class="nc bnc" id="L499" title="All 6 branches missed.">		if (m_SP.getParentSPID() != null &amp;&amp; orgIDs != null &amp;&amp; orgIDs.size() &gt; 0) {</span>
<span class="nc" id="L500">			SchedulingPeriod parentSP = camManager.getSchedulingPeriodByID(m_SP.getParentSPID());</span>
<span class="nc" id="L501">			Collection&lt;ID&gt; ids = camManager.getLinkedOrgsforSP(parentSP.getID());</span>
<span class="nc" id="L502">			Collection&lt;ID&gt; badIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">			for (ID id : orgIDs) {</span>
<span class="nc bnc" id="L504" title="All 4 branches missed.">				if (ids.contains(id) &amp;&amp; !orgIdColl.contains(id)) {</span>
<span class="nc" id="L505">					badIDs.add(id);</span>
				}
<span class="nc" id="L507">			}</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">			if (badIDs.size() &gt; 0) {</span>
<span class="nc" id="L509">				orgIDs.removeAll(badIDs);</span>
<span class="nc" id="L510">				Collection&lt;Organization&gt; orgs = OrganizationModelHandler.getOrganizationsByIDs(m_context, badIDs);</span>
<span class="nc" id="L511">				String orgNames = null;</span>
<span class="nc" id="L512">				int iteration = 0;</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">				for (Organization org : orgs) {</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">					if (iteration != 0) {</span>
<span class="nc" id="L515">						orgNames += &quot;, &quot;;</span>
<span class="nc" id="L516">						orgNames += org.getName();</span>
					} else {
<span class="nc" id="L518">						orgNames = org.getName();</span>
					}
<span class="nc" id="L520">					iteration++;</span>
<span class="nc" id="L521">				}</span>
<span class="nc" id="L522">				String[] args = new String[1];</span>
<span class="nc" id="L523">				args[0] = orgNames;</span>
<span class="nc" id="L524">				addPageMessage(Message.ERROR_TYPE, FsWebBundleKey.INVALID_ORG_TO_SP_LINKING, FsWebBundleKey.BUNDLE_NAME,</span>
						args);
			}
		}
<span class="nc" id="L528">	}</span>

	/**
	 * @param isEditable
	 */
	protected void addDescriptionRowToForm(boolean isEditable) {
<span class="nc bnc" id="L534" title="All 2 branches missed.">		String description = m_isAddMode ? &quot;&quot; : getDescription();</span>

<span class="nc" id="L536">		String descUI =</span>
<span class="nc" id="L537">				getInput(SP_DESC_FN, description, FormInputPC.TYPE_STRING, FsWebBundleKey.SCHEDULINGPERIOD_DESC, isEditable,</span>
						false);
<span class="nc" id="L539">		m_formPC.addRow(getDescriptionLabel(), descUI);</span>
<span class="nc" id="L540">	}</span>

	/**
	 * 
	 */
	protected void addTimeZoneRowToForm() {
<span class="nc" id="L546">		m_formPC.addRow(getTimezoneLabel(), getTimezoneDropDown(JSUtil.ON_CHANGE));</span>
<span class="nc" id="L547">	}</span>

	/**
	 * 
	 */
	protected void addWeekStartDayRowToForm() {
<span class="nc" id="L553">		m_formPC.addRow(getWeekStartDayLabel(), getDaysOfWeekDropDown(JSUtil.ON_CHANGE));</span>
<span class="nc" id="L554">	}</span>

	/**
	 * @param weekStart
	 */
	protected void addDayBoundaryRowToForm(int weekStart) {
<span class="nc" id="L560">		m_formPC.addRow(getDayBoundaryOffsetLabel(), getDayBoundaryOffsetTimeUI(JSUtil.ON_CHANGE, (weekStart) % 1440));</span>

<span class="nc bnc" id="L562" title="All 2 branches missed.">		int dayBoundary = (weekStart &lt; 0 ? weekStart + 1440 : weekStart) % 1440;</span>
<span class="nc" id="L563">		addGenericHTML(HtmlUtil.makeHiddenInput(DAY_BOUNDARY, dayBoundary));</span>
<span class="nc" id="L564">	}</span>

	/**
	 * @param isEditable
	 */
	protected void addOrgSelectorRowToForm(boolean isEditable) {
<span class="nc" id="L570">		Collection&lt;ID&gt; orgIdCollection = null;</span>
<span class="nc bnc" id="L571" title="All 4 branches missed.">		if (null != getPageAction() &amp;&amp; PageAction.SP_REFRESH_HOO_WITH_ORG.equals(getPageAction())) {</span>
<span class="nc" id="L572">			orgIdCollection = orgIDs;</span>
		} else {
<span class="nc" id="L574">			orgIdCollection = getLinkedOrgsforSP();</span>
		}

<span class="nc bnc" id="L577" title="All 2 branches missed.">		if (orgIdCollection != null) {</span>
<span class="nc" id="L578">			m_orgSelectorPC.initIDs(orgIdCollection);</span>
		}

<span class="nc bnc" id="L581" title="All 4 branches missed.">		m_orgSelectorPC.setIsEditable(isEditable &amp;&amp; !m_campaign.getIsDistributed());</span>
<span class="nc" id="L582">		m_orgSelectorPC.setOnChange(ON_CHANGE_SCRIPT);</span>
<span class="nc" id="L583">		m_formPC.addRow(i18n(m_bundle, FsWebBundleKey.FS_ORGANIZATION), m_orgSelectorPC);</span>
<span class="nc" id="L584">	}</span>

	/**
	 * Add the HOO Section to the form. This section contains a row for each day of the week (M-F). Each row has a day of
	 * week label in the first column, and the second column is comprised of: An open/closed checkbox, a start time picker, a
	 * start time day of week abbreviation, an end time picker, and an end time day of week abbreviation.
	 * @param isEditable
	 * @param weekStartDayForCurTZ - weekStartDay ordinal relative to the currently selected time zone
	 * @param origWeekStartDay - weekStartDay ordinal relative to the campaign time zone
	 * @param timezoneOffSet
	 * @param bAddTimeZoneOffSet
	 * @param isMultiWeek - is the entire SP selected in the SP week dropdown? true=yes (zoomed-out), false=no (zoomed-in to
	 *            1 week)
	 * @param hoo - HOO for the currently selected week, or the first week if zoomed out to period.
	 * @throws RemoteException
	 * @throws BbmCreateException
	 */
	protected void addHOOSectionToForm(boolean isEditable, int weekStartDayForCurTZ, int origWeekStartDay,
			int timezoneOffSet, boolean bAddTimeZoneOffSet, boolean isMultiWeek, CampaignHOO hoo) throws BbmCreateException,
			RemoteException {

<span class="nc" id="L605">		Map&lt;CampaignHOO, Pair&lt;Integer, Integer&gt;&gt; partialWeekHOOExclusions =</span>
<span class="nc" id="L606">				SchedulingPeriodUtil.getPartialWeekHOOExclusions(m_campaign, m_SP, m_hoos, origWeekStartDay);</span>

<span class="nc bnc" id="L608" title="All 2 branches missed.">		for (short iDay = 1; iDay &lt; 8; iDay++) {</span>
<span class="nc" id="L609">			boolean isValidDay = SchedulingPeriodUtil.isValidHOOForDay(partialWeekHOOExclusions, hoo, iDay);</span>
<span class="nc bnc" id="L610" title="All 6 branches missed.">			checkboxPCs[iDay].setEnabled(isEditable &amp;&amp; (isMultiWeek ? true : isValidDay));</span>

			// get day of the week (in campaign time zone) for the iDay'th row in the UI
<span class="nc" id="L613">			short ihooIndex = (short) (iDay + origWeekStartDay - 1);</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">			if (ihooIndex &gt; 7) {</span>
<span class="nc" id="L615">				ihooIndex -= 7;</span>
			}

<span class="nc bnc" id="L618" title="All 4 branches missed.">			if (isMultiWeek &amp;&amp; isMultiValsForIsActive(ihooIndex, iDay, partialWeekHOOExclusions)) {</span>
<span class="nc" id="L619">				checkboxPCs[iDay].setMultiEdit(true);</span>
<span class="nc" id="L620">				checkboxPCs[iDay].setIsChecked(false);</span>
			} else {
<span class="nc bnc" id="L622" title="All 4 branches missed.">				checkboxPCs[iDay].setIsChecked(hoo.isActive(ihooIndex) &amp;&amp; isValidDay);</span>
			}

<span class="nc bnc" id="L625" title="All 4 branches missed.">			if (isMultiWeek &amp;&amp; isMultiValsForDayOpen(ihooIndex, iDay, partialWeekHOOExclusions)) {</span>
<span class="nc" id="L626">				startTimePCs[iDay].setIsMultiValue(true);</span>
			} else {
<span class="nc" id="L628">				startTimePCs[iDay].setIsMultiValue(false);</span>
<span class="nc bnc" id="L629" title="All 4 branches missed.">				if (hoo.isActive(ihooIndex) &amp;&amp; isValidDay) {</span>
					// day is active. Set start time picker's time to the SPHOO's start time converted to local time zone
<span class="nc bnc" id="L631" title="All 2 branches missed.">					int weekDayStart = 60 * hoo.getDayOpen(ihooIndex) + (bAddTimeZoneOffSet ? timezoneOffSet * 60 : 0);</span>
<span class="nc" id="L632">					startTimePCs[iDay].setTime(weekDayStart);</span>
<span class="nc" id="L633">				} else {</span>
					// day is not active. Set start time picker's time to midnight in the local time zone
<span class="nc bnc" id="L635" title="All 2 branches missed.">					int weekDayStart = timezoneOffSet &gt;= 0 ? timezoneOffSet : (timezoneOffSet * 60 + 1440 * 60);</span>
<span class="nc" id="L636">					startTimePCs[iDay].setTime(weekDayStart);</span>
				}
			}

<span class="nc bnc" id="L640" title="All 4 branches missed.">			if (isMultiWeek &amp;&amp; isMultiValsForDayClose(ihooIndex, iDay, partialWeekHOOExclusions)) {</span>
<span class="nc" id="L641">				endTimePCs[iDay].setIsMultiValue(true);</span>
			} else {
<span class="nc" id="L643">				endTimePCs[iDay].setIsMultiValue(false);</span>
<span class="nc bnc" id="L644" title="All 4 branches missed.">				if (hoo.isActive(ihooIndex) &amp;&amp; isValidDay) {</span>
					// day is active. Set end time picker's time to the SPHOO's end time converted to local time zone
<span class="nc bnc" id="L646" title="All 2 branches missed.">					int weekDayEnd = 60 * hoo.getDayClose(ihooIndex) + (bAddTimeZoneOffSet ? timezoneOffSet * 60 : 0);</span>
<span class="nc" id="L647">					endTimePCs[iDay].setTime(weekDayEnd);</span>
<span class="nc" id="L648">				} else {</span>
					// day is not active. Set end time picker's time to midnight in the local time zone
<span class="nc" id="L650">					endTimePCs[iDay].setTime(60 * 1440 + timezoneOffSet * 60);</span>
				}
			}

<span class="nc" id="L654">			startTimePCs[iDay].setOnChangeJS(this.getCoordinateUiJS());</span>
<span class="nc" id="L655">			endTimePCs[iDay].setOnChangeJS(this.getCoordinateUiJS());</span>

			// get day of the week (in current display time zone) for the iDay'th row in the UI
<span class="nc" id="L658">			short iWeekday = (short) (iDay + weekStartDayForCurTZ - 1);</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">			if (iWeekday &gt; 7) {</span>
<span class="nc" id="L660">				iWeekday -= 7;</span>
			}

<span class="nc" id="L663">			WeekdayName weekdayName = new WeekdayName(this);</span>
<span class="nc" id="L664">			String shortNames =</span>
<span class="nc" id="L665">					&quot; today=\&quot;&quot; + weekdayName.getShortName(iWeekday) + &quot;\&quot; tomorrow=\&quot;&quot;</span>
<span class="nc" id="L666">							+ weekdayName.getShortName(iWeekday + 1) + &quot;\&quot; &quot;;</span>
<span class="nc" id="L667">			StringBuffer buffer = new StringBuffer();</span>
<span class="nc" id="L668">			buffer.append(checkboxPCs[iDay]);</span>
<span class="nc" id="L669">			buffer.append(&quot;\n&lt;span id=\&quot;&quot; + RANGE_SPAN_PREFIX + iDay + &quot;\&quot;&quot; + shortNames + &quot;&gt;\n&quot;);</span>
<span class="nc" id="L670">			buffer.append(startTimePCs[iDay]);</span>
<span class="nc" id="L671">			buffer.append(&quot;&lt;span id=\&quot;&quot; + START_DAY_PREFIX + iDay + &quot;\&quot; class=\&quot;timePicker_day_span\&quot;&gt;&lt;/span&gt;\n&quot;);</span>
<span class="nc" id="L672">			buffer.append(endTimePCs[iDay]);</span>
<span class="nc" id="L673">			buffer.append(&quot;&lt;span id=\&quot;&quot; + END_DAY_PREFIX + iDay + &quot;\&quot; class=\&quot;timePicker_day_span\&quot;&gt;&lt;/span&gt;\n&quot;);</span>
<span class="nc" id="L674">			buffer.append(&quot;&lt;/span&gt;\n&quot;);</span>
<span class="nc" id="L675">			m_formHooPC.addRow(weekdayName.getName(iWeekday), buffer);</span>
		}

<span class="nc" id="L678">		addForm(m_formHooPC);</span>

<span class="nc" id="L680">		appendJSToJSMain(getCoordinateUiJS());</span>
<span class="nc" id="L681">	}</span>

	/**
	 * @param isEditable
	 */
	protected void addSkillBasedCheckboxRowToForm(boolean isEditable) {
		// Check box to set SchedulingPeriod.(is)SkillBased
<span class="nc" id="L688">		HtmlBooleanCheckbox cbSkillBased = new HtmlBooleanCheckbox();</span>
<span class="nc" id="L689">		cbSkillBased.setInputName(SP_SKILL_BASED);</span>
<span class="nc" id="L690">		cbSkillBased.setIsChecked(getSkillbased());</span>
<span class="nc bnc" id="L691" title="All 6 branches missed.">		cbSkillBased.setIsDisabled(!isEditable || CanUnSelectSkillBased() == false || m_SP.getParentSPID() != null);</span>
<span class="nc" id="L692">		m_formPC.addRow(i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_SKILL_BASED), cbSkillBased);</span>
<span class="nc" id="L693">	}</span>

	/**
	 * Add the Check box to set SchedulingPeriod.isUsingAllEmployees, which indicates (whether this SP uses all employees of
	 * linked organizations, or whether employees are manually selected.
	 * @param isEditable
	 * @throws CoreEJBCreateException
	 * @throws RemoteException
	 */
	protected void addUseAllEmployeesCheckboxRowToForm(boolean isEditable) throws CoreEJBCreateException, RemoteException {
<span class="nc" id="L703">		LicenseManager licenseManager = CoreManagerFactory.getLicenseManager();</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">		if (licenseManager.isLicensed(LicenseKeys.APP_RFS)) {</span>
<span class="nc" id="L705">			HtmlBooleanCheckbox isUsingAllEmployeesCheckbox = new HtmlBooleanCheckbox();</span>
<span class="nc" id="L706">			isUsingAllEmployeesCheckbox.setInputName(SP_USING_ALL_EMPLOYEES);</span>
<span class="nc" id="L707">			isUsingAllEmployeesCheckbox.setIsChecked(isUsingAllEmployees());</span>
<span class="nc bnc" id="L708" title="All 6 branches missed.">			isUsingAllEmployeesCheckbox.setIsDisabled(!isEditable || m_SP.getParentSPID() != null</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">					|| (m_campaign != null &amp;&amp; m_campaign.getIsDistributed()));</span>
			// If a user decided to remove feature, warn him
<span class="nc bnc" id="L711" title="All 2 branches missed.">			if (isUsingAllEmployeesCheckbox.isChecked()) {</span>
<span class="nc" id="L712">				isUsingAllEmployeesCheckbox.setOnClickJS(JSUtil.ON_CHANGE</span>
						+ &quot; if (!this.checked) {alert('Unchecking removes all employees from SP'); }&quot;);
			}
<span class="nc" id="L715">			m_formPC.addRow(i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_USING_ALL_EMPLOYEES), isUsingAllEmployeesCheckbox);</span>
		}
<span class="nc" id="L717">	}</span>

	/**
	 * Initialize Toolbar
	 */
	@Override
	protected void initToolbar() {
<span class="nc" id="L724">		boolean createEnabled = m_context.getUser().isAuthorized(PrivilegeKeys.FS_CREATECAMPAIGN);</span>
<span class="nc" id="L725">		boolean deleteEnabled = m_context.getUser().isAuthorized(PrivilegeKeys.FS_DELETECAMPAIGN);</span>
<span class="nc" id="L726">		boolean configEnabled = m_context.getUser().isAuthorized(PrivilegeKeys.FS_CONFIGURECAMPAIGN);</span>
<span class="nc bnc" id="L727" title="All 4 branches missed.">		boolean editEnabled = createEnabled || configEnabled;</span>

<span class="nc" id="L729">		String saveDisplay = i18n(m_common_bundle, CommonWebBundleKey.TOOLBAR_SAVE);</span>
<span class="nc" id="L730">		String deleteDisplay = i18n(m_common_bundle, CommonWebBundleKey.TOOLBAR_DELETE);</span>
<span class="nc" id="L731">		String resetDisplay = i18n(m_common_bundle, CommonWebBundleKey.TOOLBAR_RESET);</span>

<span class="nc bnc" id="L733" title="All 4 branches missed.">		if (m_SP != null &amp;&amp; m_SP.getParentSPID() != null) {</span>
<span class="nc" id="L734">			createEnabled = false;</span>
<span class="nc" id="L735">			deleteEnabled = false;</span>
		}

<span class="nc" id="L738">		m_toolbar.addSubmitTextButton(PageAction.NEW, i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_CAMPAIGN),</span>
				createEnabled);

<span class="nc bnc" id="L741" title="All 2 branches missed.">		if (isSPSelected()) {</span>
<span class="nc" id="L742">			String addDisplay = i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_CREATE_SP);</span>
<span class="nc" id="L743">			m_toolbar.addSubmitTextButton(PageAction.ADD, addDisplay, createEnabled);</span>
<span class="nc" id="L744">			m_toolbar.addValidateSubmitTextButton(PageAction.SAVE, saveDisplay, editEnabled);</span>
<span class="nc" id="L745">			m_toolbar.addDeleteTextButton(PageAction.DELETE, deleteDisplay, deleteEnabled);</span>
<span class="nc" id="L746">			toolbarAddResetButton(resetDisplay, editEnabled);</span>
		}
<span class="nc" id="L748">	}</span>

	@Override
	protected boolean isAuthorizedToConfigure() {
<span class="nc" id="L752">		boolean createEnabled = m_context.getUser().isAuthorized(PrivilegeKeys.FS_CREATECAMPAIGN);</span>
<span class="nc" id="L753">		boolean configEnabled = m_context.getUser().isAuthorized(PrivilegeKeys.FS_CONFIGURECAMPAIGN);</span>
<span class="nc bnc" id="L754" title="All 4 branches missed.">		boolean editEnabled = createEnabled || configEnabled;</span>
<span class="nc" id="L755">		return editEnabled;</span>
	}

	protected boolean CanUnSelectSkillBased() {
		// TODO eclingman: further research connection between being skilled
		// based
		// and media type. Should we add not being FACE-TO-FACE to the
		// condition?
<span class="nc" id="L763">		boolean ret = true;</span>
		try {
<span class="nc" id="L765">			CampaignManager campaignMgr = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L766">			Collection&lt;SPQueue&gt; spQueues = campaignMgr.getSPQueuesBySPID(m_SP.getID());</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">			for (SPQueue spqueue : spQueues) {</span>
<span class="nc" id="L768">				ID id = spqueue.getMediaID();</span>
<span class="nc bnc" id="L769" title="All 4 branches missed.">				if (!id.equals(Media.MEDIA_ID_PHONE) &amp;&amp; !id.equals(Media.MEDIA_ID_PROJECT)) {</span>
<span class="nc" id="L770">					ret = false;</span>
<span class="nc" id="L771">					break;</span>
				}
<span class="nc" id="L773">			}</span>
<span class="nc" id="L774">		} catch (Exception e) {</span>
<span class="nc" id="L775">			handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L776">		}</span>
<span class="nc" id="L777">		return ret;</span>
	}

	/**
	 * Compares the start and end of HOO for each day to make sure they are valid.
	 *
	 * @param timeZoneOffset - The number of minutes representing the difference beteween the view and campaiagn time zones
	 *            (e.g. 180 if view time zone was EST and campaign time zone was PST). This value can be negative.
	 * @param dayBoundary - the day boundary as a number of minutes from midnight. This is minutes from midnight in the view
	 *            time zone.
	 * @return true if HOO is valid
	 */
	public boolean validateHOO(int timeZoneOffset, int dayBoundary) {
<span class="nc" id="L790">		boolean result = true;</span>

<span class="nc bnc" id="L792" title="All 2 branches missed.">		for (short iWeekday = 1; iWeekday &lt; 8; iWeekday++) {</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">			if (m_hoo.isActive(iWeekday)) {</span>
<span class="nc" id="L794">				short adjustedStart = getAdjustedStartTime(m_hoo.getDayOpen(iWeekday), timeZoneOffset);</span>
<span class="nc" id="L795">				short adjustedEnd = getAdjustedEndTime(m_hoo.getDayClose(iWeekday), timeZoneOffset, dayBoundary);</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">				if (adjustedStart &gt;= adjustedEnd) {</span>
<span class="nc" id="L797">					result = false;</span>
<span class="nc" id="L798">					addPageMessage(Message.ERROR_TYPE, FsWebBundleKey.CAMPAIGN_SP_HOO_INVALID_RANGE,</span>
							FsWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L800">					break;</span>
				}
			}
		}

<span class="nc" id="L805">		return result;</span>
	}

	/**
	 * This method translates the time representing the start of HOO for a particular day, represented as an offset in
	 * minutes from midnight. It will translate this offset from midnight from the view time zone to the offset in midnight
	 * from the campaign time zone, which is how it is stored in the DB.
	 *
	 * @param originalStartTime - start of HOO for the day as a number of minutes from midnight in the view time zone
	 * @param timeZoneOffset - The number of minutes representing the difference beteween the view and campaiagn time zones
	 *            (e.g. 180 if view time zone was EST and campaign time zone was PST). This value can be negative.
	 * @return
	 */
	public static short getAdjustedStartTime(int originalStartTime, int timeZoneOffset) {
<span class="nc" id="L819">		short adjustedStart = (short) (originalStartTime - (short) timeZoneOffset);</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">		if (adjustedStart &lt; 0) {</span>
<span class="nc" id="L821">			adjustedStart += 1440;</span>
		}
<span class="nc bnc" id="L823" title="All 2 branches missed.">		if (adjustedStart &gt;= 1440) {</span>
<span class="nc" id="L824">			adjustedStart -= 1440;</span>
		}
<span class="nc" id="L826">		return adjustedStart;</span>
	}

	/**
	 * This method translates the time representing the end of HOO for a particular day, represented as an offset in minutes
	 * from midnight. It will translate this offset from midnight from the view time zone to the offset in midnight from the
	 * campaign time zone, which is how it is stored in the DB.
	 *
	 * @param originalEndTime - end of HOO for the day as a number of minutes from midnight in the view time zone
	 * @param timeZoneOffset - The number of minutes representing the difference beteween the view and campaign time zones
	 *            (e.g. 180 if view time zone was EST and campaign time zone was PST). This value can be negative.
	 * @param originalDayBoundary the day boundary as a number of minutes from midnight. This is minutes from midnight in the
	 *            view time zone.
	 * @return
	 */
	public static short getAdjustedEndTime(int originalEndTime, int timeZoneOffset, int originalDayBoundary) {
<span class="nc" id="L842">		short adjustedEnd = (short) (originalEndTime - (short) timeZoneOffset);</span>
<span class="nc" id="L843">		short adjustedDayBoundary = (short) (originalDayBoundary - (short) timeZoneOffset);</span>
		//
<span class="nc bnc" id="L845" title="All 2 branches missed.">		if (adjustedEnd &lt;= 0) {</span>
<span class="nc" id="L846">			adjustedEnd += 1440;</span>
		}
<span class="nc bnc" id="L848" title="All 2 branches missed.">		if (adjustedEnd &gt; 1440) {</span>
<span class="nc" id="L849">			adjustedEnd -= 1440;</span>
		}

<span class="nc bnc" id="L852" title="All 2 branches missed.">		if (adjustedDayBoundary &lt; 0) {</span>
<span class="nc" id="L853">			adjustedDayBoundary += 1440;</span>
		}
<span class="nc bnc" id="L855" title="All 2 branches missed.">		if (adjustedDayBoundary &gt;= 1440) {</span>
<span class="nc" id="L856">			adjustedDayBoundary -= 1440;</span>
		}

		// This can happen if the close time crosses over into the next day, in
		// this case the close time
		// will be greater than 1440 to symbolize this.
<span class="nc bnc" id="L862" title="All 2 branches missed.">		if (adjustedEnd &lt;= adjustedDayBoundary) {</span>
<span class="nc" id="L863">			adjustedEnd += 1440;</span>
		}
<span class="nc" id="L865">		return adjustedEnd;</span>
	}

	@Override
	protected void loadData() throws Exception {
<span class="nc bnc" id="L870" title="All 2 branches missed.">		if (isSPSelected()) {</span>
<span class="nc" id="L871">			Collection&lt;ID&gt; spIDs = getSelectedSchedulingPeriodIDs();</span>
<span class="nc" id="L872">			CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L873">			m_SP = camManager.getSchedulingPeriodByID(spIDs.iterator().next());</span>

<span class="nc bnc" id="L875" title="All 2 branches missed.">			if (m_SP != null) {</span>
<span class="nc" id="L876">				ID campaignID = m_SP.getCampaignID();</span>
<span class="nc" id="L877">				m_campaign = camManager.getCampaignByID(campaignID);</span>
<span class="nc" id="L878">				optimizationTargetTimeZone = getTimeZone();</span>

<span class="nc" id="L880">				m_hoos = camManager.getCampaignHOOAssignmentsBySP(m_SP.getID());</span>
<span class="nc bnc" id="L881" title="All 4 branches missed.">				if (m_hoos == null || m_hoos.size() == 0) {</span>
<span class="nc" id="L882">					m_hoos = new ArrayList&lt;CampaignHOO&gt;();</span>
<span class="nc" id="L883">					LocalDate start = m_SP.getStartTimeLocal();</span>
<span class="nc" id="L884">					LocalDate end = m_SP.getEndTimeLocal();</span>
<span class="nc" id="L885">					end.add(Calendar.HOUR, 1);</span>
<span class="nc" id="L886">					int numberofWeeks =</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">							SchedulingPeriodUtil.isWeeklyCampaign(m_campaign) ? getNumWeeksForWeeklySP(m_campaign, start,</span>
<span class="nc" id="L888">									end) : getNumWeeksForMonthlySP(m_campaign, start);</span>

<span class="nc bnc" id="L890" title="All 2 branches missed.">					for (int i = 0; i &lt; numberofWeeks; i++) {</span>
<span class="nc" id="L891">						m_hoos.add(new CampaignHOO());</span>
					}
				}
			}
		}
<span class="nc" id="L896">	}</span>

	/**
	 * Get the number of weeks in a Weekly SP.
	 * @param campaign - the campaign
	 * @param start - the start of the SP
	 * @param end - the end of the SP
	 */
	protected int getNumWeeksForWeeklySP(Campaign campaign, LocalDate start, LocalDate end) throws BbmCreateException,
			RemoteException {
<span class="nc" id="L906">		int numberofWeeks = 0;</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">		if (SchedulingPeriodUtil.isWeeklyCampaign(campaign)) {</span>
<span class="nc" id="L908">			numberofWeeks = (int) (end.getTime().getTime() - start.getTime().getTime()) / (7 * 24 * 60 * 60 * 1000);</span>
		}
<span class="nc" id="L910">		return numberofWeeks;</span>
	}

	/**
	 * Get the number of weeks in a Monthly SP.
	 * @param campaign - the campaign
	 * @param start - the start of the SP.
	 */
	protected int getNumWeeksForMonthlySP(Campaign campaign, LocalDate start) throws BbmCreateException, RemoteException {
<span class="nc" id="L919">		int numberofWeeks = 0;</span>
<span class="nc bnc" id="L920" title="All 2 branches missed.">		if (SchedulingPeriodUtil.isMonthlyCampaign(campaign)) {</span>
<span class="nc" id="L921">			List&lt;Pair&lt;LocalDate, LocalDate&gt;&gt; localDates =</span>
<span class="nc" id="L922">					SchedulingPeriodUtil.getWeeksForMonthlySP(start,</span>
<span class="nc" id="L923">							SchedulingPeriodUtil.getWeekStartDay(campaign.getWeekStart()));</span>
<span class="nc" id="L924">			numberofWeeks = localDates.size();</span>
		}
<span class="nc" id="L926">		return numberofWeeks;</span>
	}

	private String getInput(String fn, String value, int type, String rbKey, boolean isEditable, boolean isRequired) {
<span class="nc" id="L930">		m_formInputPC.reset();</span>
<span class="nc" id="L931">		m_formInputPC.setInputFN(fn);</span>
<span class="nc" id="L932">		m_formInputPC.setInputValue(value);</span>
<span class="nc" id="L933">		m_formInputPC.setInputType(type);</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">		m_formInputPC.setIsReadOnly(!isEditable);</span>
<span class="nc" id="L935">		m_formInputPC.setIsRequired(isRequired);</span>
<span class="nc" id="L936">		m_formInputPC.setInputFieldDesc(rbKey, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L937">		m_formInputPC.initForDisplay();</span>
<span class="nc" id="L938">		return m_formInputPC.getHtmlDisplay();</span>
	}

	/**
	 * Return form title
	 */
	public String getFormTitle() {
<span class="nc bnc" id="L945" title="All 4 branches missed.">		if (!hasSelectedID() &amp;&amp; !m_isAddMode) {</span>
<span class="nc" id="L946">			return &quot;&quot;;</span>
		}
<span class="nc" id="L948">		return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_GENERALSETTINGS);</span>
	}

	/**
	 * Return form title
	 */
	public String getHOOFormTitle() {
<span class="nc bnc" id="L955" title="All 4 branches missed.">		if (!hasSelectedID() &amp;&amp; !m_isAddMode) {</span>
<span class="nc" id="L956">			return &quot;&quot;;</span>
		}

<span class="nc" id="L959">		return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_SP_HOOS);</span>
	}

	@Override
	public void initForDisplay() {
<span class="nc bnc" id="L964" title="All 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L965">			return;</span>
		} else {
<span class="nc bnc" id="L967" title="All 2 branches missed.">			if (!m_isAddMode) {</span>
<span class="nc bnc" id="L968" title="All 2 branches missed.">				if (!isCampaignSelected()) {</span>
<span class="nc" id="L969">					addPageMessage(Message.INSTRUCTION_TYPE,</span>
<span class="nc" id="L970">							m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PLEASE_SELECT_A_CAMPAIGN));</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">				} else if (!isSPSelected()) {</span>
<span class="nc" id="L972">					addPageMessage(Message.INSTRUCTION_TYPE,</span>
<span class="nc" id="L973">							m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PLEASE_SELECT_A_SP));</span>
				}
			}
<span class="nc" id="L976">			super.initForDisplay();</span>
		}
<span class="nc" id="L978">	}</span>

	// Getters and Setters

	// Overriding this so that cached IDs are set properly
	@Override
	public void setSelectedID(String ids) {
<span class="nc" id="L985">		super.setSelectedID(ids);</span>
<span class="nc" id="L986">		setSelectedCampaignIDs(CampaignSchedulingPeriodSelectionUtil.extractIDs(getSelectedID(),</span>
				CampaignSchedulingPeriodSelectionUtil.CAMPAIGN_ID_PREFIX));
<span class="nc" id="L988">		setSelectedSchedulingPeriodIDs(CampaignSchedulingPeriodSelectionUtil.extractIDs(getSelectedID(),</span>
				CampaignSchedulingPeriodSelectionUtil.SP_ID_PREFIX));
<span class="nc" id="L990">	}</span>

	public Collection&lt;ID&gt; getSelectedCampaignIDs() {
<span class="nc" id="L993">		return StringUtil.parseIDStringToCollection(m_selectedCampaignIDs);</span>
	}

	public void setSelectedCampaignIDs(String selectedCampaignIDs) {
<span class="nc" id="L997">		m_selectedCampaignIDs = selectedCampaignIDs;</span>
<span class="nc" id="L998">	}</span>

	public Collection&lt;ID&gt; getSelectedSchedulingPeriodIDs() {
<span class="nc" id="L1001">		return StringUtil.parseIDStringToCollection(m_selectedSchedulingPeriodIDs);</span>
	}

	public void setSelectedSchedulingPeriodIDs(String selectedSchedulingPeriodIDs) {
<span class="nc" id="L1005">		m_selectedSchedulingPeriodIDs = selectedSchedulingPeriodIDs;</span>
<span class="nc" id="L1006">	}</span>

	/**
	 * Return True if an organization is selected
	 */
	public boolean isSPSelected() {
<span class="nc bnc" id="L1012" title="All 2 branches missed.">		return getSelectedSchedulingPeriodIDs().size() &gt; 0;</span>
	}

	public boolean isCampaignSelected() {
<span class="nc bnc" id="L1016" title="All 2 branches missed.">		return getSelectedCampaignIDs().size() &gt; 0;</span>
	}

	public String getDescription() {
<span class="nc bnc" id="L1020" title="All 2 branches missed.">		if (m_description == null) {</span>
<span class="nc" id="L1021">			return m_SP.getDescription();</span>
		} else {
<span class="nc" id="L1023">			return m_description;</span>
		}
	}

	public void setDescription(String desc) {
<span class="nc" id="L1028">		m_description = desc;</span>
<span class="nc" id="L1029">		m_SP.setDescription(desc);</span>
<span class="nc" id="L1030">	}</span>

	public void setSkillbased(boolean bSkillBased) {
<span class="nc" id="L1033">		m_skillbased = bSkillBased;</span>
<span class="nc" id="L1034">		m_SP.setSkillBased(bSkillBased);</span>
<span class="nc" id="L1035">	}</span>

	public boolean getSkillbased() {
<span class="nc bnc" id="L1038" title="All 2 branches missed.">		if (m_skillbased == null) {</span>
<span class="nc" id="L1039">			return m_SP.getSkillBased();</span>
		} else {
<span class="nc" id="L1041">			return m_skillbased;</span>
		}
	}

	public void setUsingAllEmployees(boolean isUsingAllEmployees) {
<span class="nc" id="L1046">		m_isUsingAllEmployees = isUsingAllEmployees;</span>
<span class="nc" id="L1047">		m_SP.setUsingAllEmployees(isUsingAllEmployees);</span>
<span class="nc" id="L1048">	}</span>

	public boolean isUsingAllEmployees() {
<span class="nc bnc" id="L1051" title="All 2 branches missed.">		if (m_isUsingAllEmployees == null) {</span>
<span class="nc" id="L1052">			return m_SP.isUsingAllEmployees();</span>
		} else {
<span class="nc" id="L1054">			return m_isUsingAllEmployees;</span>
		}
	}

	/**
	 * Read the list of orgs currently linked to this SP from the DB.
	 */
	public Collection&lt;ID&gt; getLinkedOrgsforSP() {
<span class="nc" id="L1062">		Collection&lt;ID&gt; orgIds = null;</span>

		try {
<span class="nc" id="L1065">			CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L1066">			orgIds = camManager.getLinkedOrgsforSP(m_SP.getID());</span>
<span class="nc" id="L1067">		} catch (Exception e) {</span>
<span class="nc" id="L1068">			e.printStackTrace();</span>
<span class="nc" id="L1069">			log.error(&quot;CampaignSPSettingsPageModel: error retrieving orgs linked to SPs in getOrgs() method&quot;);</span>
<span class="nc" id="L1070">		}</span>
<span class="nc" id="L1071">		return orgIds;</span>
	}

	public String getDescriptionLabel() {
<span class="nc" id="L1075">		return i18n(m_bundle, FsWebBundleKey.SCHEDULINGPERIOD_DESC);</span>
	}

	/**
	 * Return the localized Timezone label
	 */
	public String getTimezoneLabel() {
<span class="nc" id="L1082">		return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_TIMEZONE);</span>
	}

	/**
	 * Return the localized Week Start Day label
	 */
	public String getWeekStartDayLabel() {
<span class="nc" id="L1089">		return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_WEEK_START_DAY);</span>
	}

	/**
	 * Return the DropDown display of supported Time Zones with the current selected Time Zone choosen
	 */
	public String getTimezoneDropDown(String onChangeJS) {
<span class="nc" id="L1096">		String timezoneID = getTimezoneID();</span>
<span class="nc bnc" id="L1097" title="All 2 branches missed.">		String selectedTimezoneID = (timezoneID != null) ? timezoneID : &quot;&quot;;</span>

<span class="nc bnc" id="L1099" title="All 2 branches missed.">		if (m_isAddMode) {</span>
<span class="nc" id="L1100">			return HtmlUtil.getTimeZoneDropDown(SP_TIMEZONE_ID_FN, selectedTimezoneID, onChangeJS, m_localizer);</span>
		} else {
<span class="nc" id="L1102">			return m_localizer.formatTimeZone(selectedTimezoneID)</span>
<span class="nc" id="L1103">					+ HtmlUtil.makeHiddenInput(SP_TIMEZONE_ID_FN, selectedTimezoneID);</span>
		}
	}

	public String getDaysOfWeekDropDown(String onChangeJS) {
		// in the case of sub campaign of a distributed campaign, need to save
		// the hoo in the timezone
		// of the sub, because that's the true timezone (equvalent to parent's
		// timezone)
<span class="nc" id="L1112">		TimeZone trueTimeZone = optimizationTargetTimeZone;</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">		if (m_campaign.getParentID() != null) {</span>
<span class="nc" id="L1114">			trueTimeZone = m_campaign.getTimeZone();</span>
		}

<span class="nc" id="L1117">		TimeZone curTimeZone = TimeZoneOverrideUtil.getViewingTimeZone(m_context, optimizationTargetTimeZone);</span>
<span class="nc" id="L1118">		long dateLong = m_SP.getStartTime().getTime();</span>
<span class="nc" id="L1119">		int timezoneOffSet = (curTimeZone.getOffset(dateLong) - trueTimeZone.getOffset(dateLong)) / (60 * 1000);</span>

<span class="nc" id="L1121">		int weekstart = m_campaign.getWeekStart() + timezoneOffSet;</span>
<span class="nc" id="L1122">		int selectedDay = 0;</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">		if (weekstart &lt; 0) {// Previous Saturday.</span>
<span class="nc" id="L1124">			selectedDay = 7;</span>
		} else {
<span class="nc" id="L1126">			selectedDay = ((weekstart / 1440) % 7) + 1;</span>
		}

<span class="nc bnc" id="L1129" title="All 2 branches missed.">		if (m_isAddMode) {</span>
<span class="nc" id="L1130">			return HtmlUtil.getDayOfWeekDropDown(SP_WEEK_START_DAY_FN, selectedDay, onChangeJS, false, m_localizer);</span>
		} else {
<span class="nc" id="L1132">			return m_localizer.getWeekdayNames(true)[selectedDay]</span>
<span class="nc" id="L1133">					+ HtmlUtil.makeHiddenInput(SP_WEEK_START_DAY_FN, Integer.toString(selectedDay));</span>
		}
	}

	/**
	 * Return the Organization Time Zone ID
	 */
	public String getTimezoneID() {
<span class="nc" id="L1141">		ID campaignID = m_SP.getParentID();</span>
<span class="nc" id="L1142">		TimeZone timezone = null;</span>
		try {
<span class="nc" id="L1144">			CampaignManager camManager = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L1145">			Campaign campaign = camManager.getCampaignByID(campaignID);</span>
<span class="nc" id="L1146">			timezone = campaign.getDefaultViewTimeZone();</span>
<span class="nc bnc" id="L1147" title="All 2 branches missed.">			if (timezone == null) {</span>
<span class="nc" id="L1148">				timezone = campaign.getTimeZone();</span>
			}
<span class="nc" id="L1150">		} catch (Exception ex) {</span>
<span class="nc" id="L1151">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L1152">		}</span>
<span class="nc bnc" id="L1153" title="All 2 branches missed.">		return (timezone != null) ? timezone.getID() : &quot;&quot;;</span>
	}

	/**
	 * Return the TimeZone from the timezoneId
	 */
	public TimeZone getTimeZone() {
<span class="nc" id="L1160">		return TimeZone.getTimeZone(getTimezoneID());</span>
	}

	/**
	 * Return the localized Day Boundary Offset label
	 */
	public String getDayBoundaryOffsetLabel() {
<span class="nc" id="L1167">		return i18n(m_bundle, FsWebBundleKey.CAMPAIGN_DAY_BOUNDARY_OFFSET);</span>
	}

	/**
	 * Return Day Boundary Offset Time UI
	 */
	public String getDayBoundaryOffsetTimeUI(String onChange, int offset) {
<span class="nc" id="L1174">		m_timePickerPC.setTime(offset * 60); // seconds</span>
<span class="nc" id="L1175">		m_timePickerPC.setOnChangeJS(onChange);</span>
<span class="nc" id="L1176">		m_timePickerPC.setIsControlEnabled(m_isAddMode);</span>
<span class="nc" id="L1177">		return m_timePickerPC.getHtmlDisplay();</span>
	}

	public String getDaysOfWeekDropDownUI(String onChangeJS) {
<span class="nc" id="L1181">		int weekstart = m_campaign.getWeekStart();</span>
<span class="nc" id="L1182">		int selectedDay = ((weekstart / 1440) % 7) + 1;</span>

<span class="nc bnc" id="L1184" title="All 2 branches missed.">		if (m_isAddMode) {</span>
<span class="nc" id="L1185">			return HtmlUtil.getDayOfWeekDropDown(SP_WEEK_START_DAY_FN, selectedDay, onChangeJS, false, m_localizer);</span>
		} else {
<span class="nc" id="L1187">			return m_localizer.getWeekdayNames(true)[selectedDay]</span>
<span class="nc" id="L1188">					+ HtmlUtil.makeHiddenInput(SP_WEEK_START_DAY_FN, Integer.toString(selectedDay));</span>
		}
	}

	private final class WeekdayName {
<span class="nc" id="L1193">		private final String[] names = new String[8];// 1~7 are being used</span>
<span class="nc" id="L1194">		private final String[] shortNames = new String[8];// 1~7 are being used</span>

<span class="nc" id="L1196">		WeekdayName(PageComponent ownerPC) {</span>
			// Day of weeks should depend on Regional setting
<span class="nc" id="L1198">			names[Calendar.MONDAY] = m_localizer.getWeekdayNames(true)[Calendar.MONDAY];</span>
<span class="nc" id="L1199">			names[Calendar.TUESDAY] = m_localizer.getWeekdayNames(true)[Calendar.TUESDAY];</span>
<span class="nc" id="L1200">			names[Calendar.WEDNESDAY] = m_localizer.getWeekdayNames(true)[Calendar.WEDNESDAY];</span>
<span class="nc" id="L1201">			names[Calendar.THURSDAY] = m_localizer.getWeekdayNames(true)[Calendar.THURSDAY];</span>
<span class="nc" id="L1202">			names[Calendar.FRIDAY] = m_localizer.getWeekdayNames(true)[Calendar.FRIDAY];</span>
<span class="nc" id="L1203">			names[Calendar.SATURDAY] = m_localizer.getWeekdayNames(true)[Calendar.SATURDAY];</span>
<span class="nc" id="L1204">			names[Calendar.SUNDAY] = m_localizer.getWeekdayNames(true)[Calendar.SUNDAY];</span>
<span class="nc" id="L1205">			shortNames[Calendar.MONDAY] = m_localizer.getWeekdayNames(false)[Calendar.MONDAY];</span>
<span class="nc" id="L1206">			shortNames[Calendar.TUESDAY] = m_localizer.getWeekdayNames(false)[Calendar.TUESDAY];</span>
<span class="nc" id="L1207">			shortNames[Calendar.WEDNESDAY] = m_localizer.getWeekdayNames(false)[Calendar.WEDNESDAY];</span>
<span class="nc" id="L1208">			shortNames[Calendar.THURSDAY] = m_localizer.getWeekdayNames(false)[Calendar.THURSDAY];</span>
<span class="nc" id="L1209">			shortNames[Calendar.FRIDAY] = m_localizer.getWeekdayNames(false)[Calendar.FRIDAY];</span>
<span class="nc" id="L1210">			shortNames[Calendar.SATURDAY] = m_localizer.getWeekdayNames(false)[Calendar.SATURDAY];</span>
<span class="nc" id="L1211">			shortNames[Calendar.SUNDAY] = m_localizer.getWeekdayNames(false)[Calendar.SUNDAY];</span>
<span class="nc" id="L1212">		}</span>

		String getName(int iDay) {
<span class="nc bnc" id="L1215" title="All 2 branches missed.">			if (iDay &gt; 7) {</span>
<span class="nc" id="L1216">				iDay -= 7;</span>
			}
<span class="nc" id="L1218">			return names[iDay];</span>
		}

		String getShortName(int iDay) {
<span class="nc bnc" id="L1222" title="All 2 branches missed.">			if (iDay &gt; 7) {</span>
<span class="nc" id="L1223">				iDay -= 7;</span>
			}
<span class="nc" id="L1225">			return shortNames[iDay];</span>
		}
	}

	@Override
	public String getCustomJavaScript() {
<span class="nc" id="L1231">		StringBuffer sb = new StringBuffer();</span>

		/**
		 * cordinateUI() will enable/disable the start/end time pickers according to the checkbox state, and if disabled,
		 * reset the start/end time pickers to the day boundary time, and update the day of week labels to the today or
		 * tomorrow day appropriate for the time selections. For example, changing an end time to midnight might result in
		 * its day label automatically changing from &quot;Mon&quot; to &quot;Tue&quot;.
		 */
<span class="nc" id="L1239">		sb.append(&quot;function cordinateUI() {&quot;);</span>
<span class="nc" id="L1240">		sb.append(&quot;var dayBoundary=pageMediator.getValue('&quot; + DAY_BOUNDARY + &quot;')*60;\n&quot;);// seconds</span>
<span class="nc" id="L1241">		sb.append(&quot;var dayBoundaryStr=getFormattedTime(dayBoundary,false);\n&quot;);</span>
<span class="nc" id="L1242">		sb.append(&quot;var var1, var2, span,active;\n&quot;);</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">		for (short iDay = 1; iDay &lt; 8; iDay++) {</span>
<span class="nc" id="L1244">			sb.append(&quot;span=DOM2.getElementById('&quot;).append(RANGE_SPAN_PREFIX + iDay).append(&quot;');\n&quot;);</span>
<span class="nc" id="L1245">			sb.append(&quot;var1 = DOM2.getElementById('&quot;).append(IS_ACTIVE_PREFIX + iDay + &quot;__input_id&quot;).append(&quot;'); \n&quot;);</span>
<span class="nc" id="L1246">			sb.append(&quot;active= var1.checked; \n&quot;);</span>
<span class="nc" id="L1247">			sb.append(&quot;enableTimePicker('&quot;).append(START_TP_PREFIX + iDay).append(&quot;_0',active,false);\n&quot;);</span>
<span class="nc" id="L1248">			sb.append(&quot;enableTimePicker('&quot;).append(END_TP_PREFIX + iDay).append(&quot;_0',active,false);\n&quot;);</span>
<span class="nc" id="L1249">			sb.append(&quot;if(!active){pageMediator.setValue('&quot;).append(START_TP_PREFIX + iDay)</span>
<span class="nc" id="L1250">					.append(&quot;_0',dayBoundaryStr);pageMediator.setValue('&quot;).append(END_TP_PREFIX + iDay)</span>
<span class="nc" id="L1251">					.append(&quot;_0',dayBoundaryStr);}\n&quot;);</span>
<span class="nc" id="L1252">			sb.append(&quot;DOM2.getElementById('&quot;).append(START_DAY_PREFIX + iDay)</span>
<span class="nc" id="L1253">					.append(&quot;').innerHTML = ((getTimeFromTimeField('&quot;).append(START_TP_PREFIX + iDay)</span>
<span class="nc" id="L1254">					.append(&quot;_0') &gt;= 0) &amp;&amp; (getTimeFromTimeField('&quot;).append(START_TP_PREFIX + iDay)</span>
<span class="nc" id="L1255">					.append(&quot;_0')&lt;dayBoundary)) ? span.getAttribute(\&quot;tomorrow\&quot;) : ((getTimeFromTimeField('&quot;)</span>
<span class="nc" id="L1256">					.append(END_TP_PREFIX + iDay).append(&quot;_0') &gt;= 0) &amp;&amp; (getTimeFromTimeField('&quot;)</span>
<span class="nc" id="L1257">					.append(END_TP_PREFIX + iDay).append(&quot;_0')&lt;=dayBoundary)) ? span.getAttribute(\&quot;today\&quot;): '';\n&quot;);</span>
<span class="nc" id="L1258">			sb.append(&quot;DOM2.getElementById('&quot;).append(END_DAY_PREFIX + iDay)</span>
<span class="nc" id="L1259">					.append(&quot;').innerHTML = ((getTimeFromTimeField('&quot;).append(END_TP_PREFIX + iDay)</span>
<span class="nc" id="L1260">					.append(&quot;_0')&gt;= 0) &amp;&amp; (getTimeFromTimeField('&quot;).append(END_TP_PREFIX + iDay)</span>
<span class="nc" id="L1261">					.append(&quot;_0')&lt;=dayBoundary)) ? span.getAttribute(\&quot;tomorrow\&quot;) : '';\n&quot;);</span>
		}
<span class="nc" id="L1263">		sb.append(&quot;\n }\n\n&quot;);</span>

		// Add custom reset logic
<span class="nc" id="L1266">		sb.append(&quot;resetJSArray[resetJSArray.length] = \&quot;&quot; + getMediatorRef() + &quot;.refreshPageWithAction('&quot;</span>
				+ PageAction.NEW_ID + &quot;', true);\&quot;\n&quot;);

<span class="nc" id="L1269">		StringBuffer sbAlert = new StringBuffer();</span>

<span class="nc" id="L1271">		sbAlert.append(&quot;function showAlertIfPageIsDirty() {\n&quot;);</span>
<span class="nc" id="L1272">		sbAlert.append(&quot;if (pageMediator.isPageDirty()) {\n&quot;);</span>
<span class="nc" id="L1273">		sbAlert.append(&quot;if(!confirm(LOSE_CHANGES_WARNING))\n&quot;);</span>
<span class="nc" id="L1274">		sbAlert.append(&quot;  return false;\n&quot;);</span>
<span class="nc" id="L1275">		sbAlert.append(&quot;}\n&quot;);</span>
<span class="nc" id="L1276">		sbAlert.append(&quot;return true;\n&quot;);</span>
<span class="nc" id="L1277">		sbAlert.append(&quot;\n }&quot;);</span>

<span class="nc" id="L1279">		return super.getCustomJavaScript() + &quot; &quot; + sb.toString() + sbAlert.toString();</span>
	}

	private String getCoordinateUiJS() {
<span class="nc" id="L1283">		return &quot;cordinateUI();&quot;;</span>
	}

	/**
	 * Get the setEnabled JavaScript for the specified Time Picker.
	 * @param varName - the name of the time picker element.
	 * @boolean enabled - true to enable the picker, false to disable it.
	 */
	private static String enableTimePickerJS(String varName, boolean enabled) {
<span class="nc" id="L1292">		return &quot;enableTimePicker('&quot; + varName + &quot;_0', &quot; + enabled + &quot;, false);&quot;;</span>
	}

	/**
	 * See if different HOO's in the SP have different &quot;is active&quot; values for the given day of the week. We only consider
	 * HOO's for which the specified day is not excluded.
	 * @param ihooIndex - day of the week (in campaign time zone) to check (day of week for the dayIndex'th day)
	 * @param dayIndex - the day index to check.
	 * @param partialWeekHOOExclusions - a Map containing any partial weeks in the SP as keys, and the valid day index ranges
	 *            for those weeks.
	 * @return true if different HOO's in the SP have different &quot;is active&quot; values for the given day of the week.
	 */
	private boolean isMultiValsForIsActive(short ihooIndex, short dayIndex,
			Map&lt;CampaignHOO, Pair&lt;Integer, Integer&gt;&gt; partialWeekHOOExclusions) {
<span class="nc" id="L1306">		boolean ret = false;</span>
<span class="nc bnc" id="L1307" title="All 2 branches missed.">		if (m_hoos.size() &gt; 1) {</span>
<span class="nc" id="L1308">			CampaignHOO firstHOO = null;</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">			for (CampaignHOO curHoo : m_hoos) {</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">				if (SchedulingPeriodUtil.isValidHOOForDay(partialWeekHOOExclusions, curHoo, dayIndex)) {</span>
<span class="nc bnc" id="L1311" title="All 2 branches missed.">					if (firstHOO == null) {</span>
<span class="nc" id="L1312">						firstHOO = curHoo;</span>
<span class="nc bnc" id="L1313" title="All 2 branches missed.">					} else if (firstHOO.isActive(ihooIndex) != curHoo.isActive(ihooIndex)) {</span>
<span class="nc" id="L1314">						ret = true;</span>
<span class="nc" id="L1315">						break;</span>
					}
				}
<span class="nc" id="L1318">			}</span>
		}
<span class="nc" id="L1320">		return ret;</span>
	}

	/**
	 * See if different HOO's in the SP have different start time values for the given day of the week. We only consider
	 * HOO's for which the specified day is not excluded.
	 * @param ihooIndex - day of the week (in campaign time zone) to check (day of week for the dayIndex'th day)
	 * @param dayIndex - the day index to check.
	 * @param partialWeekHOOExclusions - a Map containing any partial weeks in the SP as keys, and the valid day index ranges
	 *            for those weeks.
	 * @return true if different HOO's in the SP have different start time values for the given day of the week.
	 */
	private boolean isMultiValsForDayOpen(short ihooIndex, short dayIndex,
			Map&lt;CampaignHOO, Pair&lt;Integer, Integer&gt;&gt; partialWeekHOOExclusions) {
<span class="nc" id="L1334">		boolean ret = false;</span>
<span class="nc bnc" id="L1335" title="All 2 branches missed.">		if (m_hoos.size() &gt; 1) {</span>
<span class="nc" id="L1336">			CampaignHOO firstHOO = null;</span>
<span class="nc bnc" id="L1337" title="All 2 branches missed.">			for (CampaignHOO curHoo : m_hoos) {</span>
<span class="nc bnc" id="L1338" title="All 2 branches missed.">				if (SchedulingPeriodUtil.isValidHOOForDay(partialWeekHOOExclusions, curHoo, dayIndex)) {</span>
<span class="nc bnc" id="L1339" title="All 2 branches missed.">					if (firstHOO == null) {</span>
<span class="nc" id="L1340">						firstHOO = curHoo;</span>
<span class="nc bnc" id="L1341" title="All 2 branches missed.">					} else if (firstHOO.getDayOpen(ihooIndex) != curHoo.getDayOpen(ihooIndex)) {</span>
<span class="nc" id="L1342">						ret = true;</span>
<span class="nc" id="L1343">						break;</span>
					}
				}
<span class="nc" id="L1346">			}</span>
		}
<span class="nc" id="L1348">		return ret;</span>
	}

	/**
	 * See if different HOO's in the SP have different end time values for the given day of the week. We only consider HOO's
	 * for which the specified day is not excluded.
	 * @param ihooIndex - day of the week (in campaign time zone) to check (day of week for the dayIndex'th day)
	 * @param dayIndex - the day of the week to check.
	 * @param partialWeekHOOExclusions - a Map containing any partial weeks in the SP as keys, and the valid day index ranges
	 *            for those weeks.
	 * @return true if different HOO's in the SP have different end time values for the given day of the week.
	 */
	private boolean isMultiValsForDayClose(short ihooIndex, short dayIndex,
			Map&lt;CampaignHOO, Pair&lt;Integer, Integer&gt;&gt; partialWeekHOOExclusions) {
<span class="nc" id="L1362">		boolean ret = false;</span>
<span class="nc bnc" id="L1363" title="All 2 branches missed.">		if (m_hoos.size() &gt; 1) {</span>
<span class="nc" id="L1364">			CampaignHOO firstHOO = null;</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">			for (CampaignHOO curHoo : m_hoos) {</span>
<span class="nc bnc" id="L1366" title="All 2 branches missed.">				if (SchedulingPeriodUtil.isValidHOOForDay(partialWeekHOOExclusions, curHoo, dayIndex)) {</span>
<span class="nc bnc" id="L1367" title="All 2 branches missed.">					if (firstHOO == null) {</span>
<span class="nc" id="L1368">						firstHOO = curHoo;</span>
<span class="nc bnc" id="L1369" title="All 2 branches missed.">					} else if (firstHOO.getDayClose(ihooIndex) != curHoo.getDayClose(ihooIndex)) {</span>
<span class="nc" id="L1370">						ret = true;</span>
<span class="nc" id="L1371">						break;</span>
					}
				}
<span class="nc" id="L1374">			}</span>
		}
<span class="nc" id="L1376">		return ret;</span>
	}

	public CampaignHOO getHoo() {
<span class="nc" id="L1380">		return m_hoo;</span>
	}

	public SchedulingPeriod getSP() {
<span class="nc" id="L1384">		return m_SP;</span>
	}

	public Collection&lt;ID&gt; getOrgIDs() {
<span class="nc" id="L1388">		return orgIDs;</span>
	}

	private String getSPNameInRegionalFormat(SchedulingPeriod sp) {
<span class="nc" id="L1392">		Localizer l = m_context.getLocalizer();</span>
<span class="nc" id="L1393">		String startStr = l.formatDate(sp.getStartTimeLocal(), RegionalFormatBundleKey.DATE_FORMAT);</span>
<span class="nc" id="L1394">		LocalDate end = new LocalDate(sp.getEndTimeLocal());</span>
<span class="nc" id="L1395">		end.add(Calendar.DAY_OF_YEAR, -1);</span>
<span class="nc" id="L1396">		String endStr = l.formatDate(end, RegionalFormatBundleKey.DATE_FORMAT);</span>

<span class="nc" id="L1398">		return startStr + &quot; - &quot; + endStr;</span>
	}

	public ResourceBundle getResourceBundle() {
<span class="nc" id="L1402">		return m_bundle;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>