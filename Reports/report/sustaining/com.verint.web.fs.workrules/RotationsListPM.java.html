<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RotationsListPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">RotationsListPM.java</span></div><h1>RotationsListPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.PaginationPair;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceRotation;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectIDListComparator;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.Rotation;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.workresource.WorkResourceModelHandler;
import com.bluepumpkin.web.fs.keys.FsJavaScriptFileID;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.fs.widgets.FindToolbarPageComponent;
import com.verint.web.fs.widgets.JumpToPagePaginationPC;
import com.verint.web.fs.workrules.assignment.RotationListPC;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.TimeZoneOverrideUtil;

import javax.servlet.http.HttpServletRequest;
import java.rmi.RemoteException;
import java.util.*;
import java.util.Map.Entry;

@SuppressWarnings(&quot;serial&quot;)
public class RotationsListPM extends WorkRulesListPM {
	public static final String ROTATION_LIST_SORTCOLUMN = RotationListPC.ROTATION_LIST_SORTCOLUMN;
	public static final String ROTATION_LIST_SORTORDER = RotationListPC.ROTATION_LIST_SORTORDER;
	public static final String ROTATIONLIST_ITEMINDEX = JumpToPagePaginationPC.ROTATIONLIST_ITEMINDEX;
<span class="nc" id="L44">	private List&lt;Rotation&gt; rotations = Collections.emptyList();</span>
<span class="nc" id="L45">	private HashMap&lt;ID, Organization&gt; orgsByID = new HashMap&lt;ID, Organization&gt;();</span>
	private RotationListPC pc_rotationList;
	private Map&lt;ID, List&lt;String&gt;&gt; rotationEmpNameMap;

	public RotationsListPM(RequestContext context) {
<span class="nc" id="L50">		super(context, JumpToPagePaginationPC.USED_IN_ROTATION_LIST_PAGE);</span>
<span class="nc" id="L51">		this.setJSMediator(FsJavaScriptFileID.WORK_PANE_LIST_ALT_DELETE_MEDIATOR);</span>

<span class="nc" id="L53">		option_showTimeZoneToggle = false;</span>
<span class="nc" id="L54">		setIsMultiRowSelectable(false);</span>

		// Replace the existing list component with a RotationListPC
<span class="nc" id="L57">		removeChildComponent(m_list);</span>
<span class="nc" id="L58">		pc_rotationList = new RotationListPC(m_context, rotations, orgsByID) {</span>
			@Override
			protected void setRowAttributes(DefaultMultiColumnNodeData rowData,
					Rotation rotation) {
<span class="nc" id="L62">				super.setRowAttributes(rowData, rotation);</span>
<span class="nc" id="L63">				RotationsListPM.this.setRowAttributes(rowData, rotation.getOrganizationID());</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">				if (rotationEmpNameMap.containsKey(rotation.getID())) {</span>
<span class="nc" id="L65">					List&lt;String&gt; empNames = rotationEmpNameMap.get(rotation.getID());</span>
<span class="nc" id="L66">					String msg = m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.DELETE_CONFIRMATION_WITH_ASSIGNMENTS, &quot;\n\n&quot; + StringUtil.join(empNames, &quot;\n&quot;));</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">					boolean truncated = empNames.size() &gt; 10;</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">					if (truncated) {</span>
<span class="nc" id="L69">						int extra = empNames.size() - 10;</span>
<span class="nc" id="L70">						empNames = empNames.subList(0, 10);</span>
<span class="nc" id="L71">						msg = m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.DELETE_CONFIRMATION_WITH_ASSIGNMENTS_X_MORE, &quot;\n\n&quot; + StringUtil.join(empNames, &quot;\n&quot;) + &quot;\n\n&quot;, extra);</span>
					}
<span class="nc" id="L73">					rowData.setNodeAttribute(&quot;deleteConfirmation&quot;, msg);</span>

				}
<span class="nc" id="L76">			}</span>
		};
<span class="nc" id="L78">		m_list = pc_rotationList;</span>
<span class="nc" id="L79">		addChildComponent(m_list);</span>

<span class="nc" id="L81">	}</span>

	@Override
	protected boolean isSortSupported() {
<span class="nc" id="L85">		return true;</span>
	}


<span class="nc" id="L89">	boolean isExtracted = false;</span>

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc bnc" id="L93" title="All 2 branches missed.">		if (isExtracted) {</span>
<span class="nc" id="L94">			return true;</span>
		}
<span class="nc" id="L96">		isExtracted = true;</span>
<span class="nc" id="L97">		return super.extractParameters(request);</span>
	}

	@Override
	protected void loadData() throws Exception {
<span class="nc" id="L102">		super.loadData();</span>
<span class="nc" id="L103">		int pageIndex = getPagePaginationIndex();</span>
<span class="nc" id="L104">		int pageSize = getPageIDSize();</span>
<span class="nc" id="L105">		int itemIndex = getEditIndex();</span>
<span class="nc" id="L106">		String pageAction = getPageAction();</span>
<span class="nc" id="L107">		String strItemIndex = (String) m_context.getAttribute(RequestContext.SESSION_SCOPE, ROTATIONLIST_ITEMINDEX);</span>
<span class="nc bnc" id="L108" title="All 6 branches missed.">		if (pageAction != null &amp;&amp; (pageAction.equals(PageAction.CANCEL) || pageAction.equals(PageAction.SAVE)</span>
<span class="nc bnc" id="L109" title="All 4 branches missed.">				|| pageAction.equals(PageAction.TABLE_SORT) || pageAction.equals(PageAction.CREATE_NEW))) {</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">			if (!StringUtil.isEmpty(strItemIndex)) {</span>
<span class="nc" id="L112">				itemIndex = Integer.parseInt(strItemIndex);</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">				pageIndex = (itemIndex / pageSize) + (itemIndex % pageSize &gt; 0 ? 1 : 0);</span>
			}
		}
<span class="nc" id="L116">		ID selectedOrgID = getSelectedIDObject();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">		if (selectedOrgID != null) {</span>
<span class="nc" id="L118">			WorkRuleManager wrm = WfmManagerFactory.getWorkRuleManager(m_context.isInWhatIfMode());</span>
			// Load Rotations
<span class="nc bnc" id="L120" title="All 2 branches missed.">			if (m_context.getUser().isAuthorized(PrivilegeKeys.FS_VIEWWORKRULES_ID, new ScopeID(selectedOrg.getID(), Scope.ORG_SCOPE))) {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">				if (isPaginationNavPressed()) {</span>
<span class="nc" id="L122">					ArrayList&lt;ID&gt; pageIDs = (ArrayList&lt;ID&gt;) getPageIDs();</span>
<span class="nc" id="L123">					rotations = new ArrayList&lt;Rotation&gt;(wrm.getRotationsByIDs(pageIDs));</span>
<span class="nc" id="L124">					Collections.sort(rotations, new ValueObjectIDListComparator(pageIDs));</span>
<span class="nc" id="L125">				} else {</span>
<span class="nc" id="L126">					PaginationPair&lt;Rotation&gt; rotationData = wrm.getRotationsForOrgAndAncestors(selectedOrgID, pageSize, pageIndex, pc_rotationList.getSortFields(), m_list.getHeader().isAscending(), getTextToFind(itemToFind));</span>
<span class="nc" id="L127">					rotations = new ArrayList&lt;Rotation&gt;(rotationData.getValues());</span>
<span class="nc" id="L128">					initPaginationIDs(rotationData.getIDs());</span>
<span class="nc" id="L129">					Collections.sort(rotations, new ValueObjectIDListComparator(new ArrayList&lt;ID&gt;(getPageIDs())));</span>
<span class="nc" id="L130">				}</span>

			} else {
<span class="nc" id="L133">				addPageMessage(Message.INFO_TYPE, FsWebBundleKey.FS_NOT_AUTHORIZED_TO_VIEW_WORK_RULES_IN_THIS_SCOPE, FsWebBundleKey.BUNDLE_NAME);</span>
			}
<span class="nc" id="L135">			pc_rotationList.setRotations(rotations);</span>

<span class="nc" id="L137">			loadEmployeeAssignmentNames();</span>

			// Load required Orgs
<span class="nc" id="L140">			HashSet&lt;ID&gt; ownerOrgIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">			for (Rotation rotation : rotations) {</span>
<span class="nc" id="L142">				ID ownerOrgID = rotation.getOrganizationID();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">				if (ownerOrgID != null) {</span>
<span class="nc" id="L144">					ownerOrgIDs.add(rotation.getOrganizationID());</span>
				}
<span class="nc" id="L146">			}</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">			if (selectedOrgID != null) {</span>
<span class="nc" id="L148">				ownerOrgIDs.add(selectedOrgID);</span>
			}
<span class="nc" id="L150">			orgsByID = ValueObjectUtil.getIDObjectMap(OrganizationModelHandler.getOrganizationsByIDs(m_context, ownerOrgIDs));</span>
<span class="nc" id="L151">			pc_rotationList.setOrgMap(orgsByID);</span>

			// Set the TimeZone on the list PC
<span class="nc" id="L154">			Organization o = orgsByID.get(selectedOrgID);</span>
<span class="nc bnc" id="L155" title="All 6 branches missed.">			if (o != null &amp;&amp; o.getTimeZone() != null &amp;&amp; !TimeZoneOverrideUtil.isTimeZoneOverridden(m_context)) {</span>
<span class="nc" id="L156">				pc_rotationList.setViewTimeZone(o.getTimeZone());</span>
			}
		}
<span class="nc" id="L159">	}</span>

	/**
	 * Loads the names of the assigned employees, formats the lists as strings, and stores them in the rotationEmpNameMap field.
	 *
	 * @throws BbmFinderException
	 * @throws RemoteException
	 * @throws BbmException
	 */
	private void loadEmployeeAssignmentNames() throws BbmFinderException, RemoteException, BbmException {
		// First get the object representation of the assignment for the rotations
<span class="nc" id="L170">		Map&lt;ID, ? extends Collection&lt;WorkResourceRotation&gt;&gt; rotationAssignmentMap = WorkRulesModelHandler.getRotationAssignmentsByRotationIDs(m_context, ValueObjectUtil.getIDFromObjects(rotations));</span>

		// Now Collect the employee IDs so we can get the names
<span class="nc" id="L173">		Set&lt;ID&gt; workResourceIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">		for (Collection&lt;WorkResourceRotation&gt; assignments : rotationAssignmentMap.values()) {</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">			for (WorkResourceRotation assignment : assignments) {</span>
<span class="nc" id="L176">				workResourceIDs.add(assignment.getWorkResourceID());</span>
<span class="nc" id="L177">			}</span>
<span class="nc" id="L178">		}</span>

		// Get the Name abstraction for all the employees
<span class="nc" id="L181">		HashMap&lt;ID, EmployeeName&gt; assignmentNames = WorkResourceModelHandler.getWorkResourceManager(m_context).getWorkResourceNamesByIDs(workResourceIDs);</span>

<span class="nc" id="L183">		rotationEmpNameMap = new HashMap&lt;ID, List&lt;String&gt;&gt;();</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">		for (Entry&lt;ID, ? extends Collection&lt;WorkResourceRotation&gt;&gt; assignmentEntry : rotationAssignmentMap.entrySet()) {</span>
<span class="nc" id="L185">			ID rotationID = assignmentEntry.getKey();</span>
<span class="nc" id="L186">			ArrayList&lt;String&gt; empNames = new ArrayList&lt;String&gt;(assignmentEntry.getValue().size());</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">			for (WorkResourceRotation assignment : assignmentEntry.getValue()) {</span>
<span class="nc" id="L188">				empNames.add(assignmentNames.get(assignment.getWorkResourceID()).getDisplayName(m_localizer));</span>
<span class="nc" id="L189">			}</span>
<span class="nc" id="L190">			rotationEmpNameMap.put(rotationID, empNames);</span>
<span class="nc" id="L191">		}</span>
<span class="nc" id="L192">	}</span>

	@Override
	protected boolean isAbleToAdd() {
<span class="nc" id="L196">		boolean canAdd = super.isAddActionEnabled();</span>
<span class="nc bnc" id="L197" title="All 4 branches missed.">		if (isByOrg &amp;&amp; selectedOrg == null) {</span>
<span class="nc" id="L198">			canAdd = false;</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">		} else if (isByOrg &amp;&amp; !m_context.getUser().isAuthorized(PrivilegeKeys.FS_ADDROTATIONS_ID, new ScopeID(selectedOrg.getID(), Scope.ORG_SCOPE))) {</span>
<span class="nc" id="L200">			canAdd = false;</span>
<span class="nc bnc" id="L201" title="All 4 branches missed.">		} else if (!isByOrg &amp;&amp; !m_context.getUser().isAuthorized(PrivilegeKeys.FS_ADDROTATIONS_ID)) {</span>
<span class="nc" id="L202">			canAdd = false;</span>
		}
<span class="nc" id="L204">		return canAdd;</span>
	}

	protected void initToolbar() {
<span class="nc" id="L208">		FindToolbarPageComponent findToolBar = new FindToolbarPageComponent(m_context, getToolbar(),</span>
				FIND_ITEM_FN, WorkRulesRH.FIND_ACTION,
<span class="nc" id="L210">				getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_FIND_ROTATIONS));</span>
<span class="nc" id="L211">		getToolbar().addToolbarComponent(findToolBar);</span>
<span class="nc" id="L212">		getToolbar().addDivider();</span>
<span class="nc" id="L213">		super.initToolbar();</span>
<span class="nc" id="L214">	}</span>

	private boolean hasPrivileges(ID privilegeID) {
<span class="nc bnc" id="L217" title="All 2 branches missed.">		if (isByOrg) {</span>
<span class="nc bnc" id="L218" title="All 4 branches missed.">			return selectedOrg != null &amp;&amp; m_context.getUser().isAuthorized(privilegeID, new ScopeID(selectedOrg.getID(), Scope.ORG_SCOPE));</span>
		} else {
<span class="nc" id="L220">			return m_context.getUser().isAuthorized(privilegeID);</span>
		}
	}

	@Override
	protected void setRowAttributes(MultiColumnNodeData rowData, ID orgID) {
<span class="nc" id="L226">		HashMap&lt;String, String&gt; nodeAttributes = rowData.getNodeAttributes();</span>
<span class="nc" id="L227">		boolean hasEditPrivs = hasPrivileges(PrivilegeKeys.FS_EDITROTATIONS_ID);</span>
<span class="nc" id="L228">		boolean hasDeletePrivs = hasPrivileges(PrivilegeKeys.FS_DELETEROTATIONS_ID);</span>
<span class="nc" id="L229">		boolean isEditable = isEditable(hasEditPrivs, orgID);</span>
<span class="nc" id="L230">		boolean isDeleteable = isEditable(hasDeletePrivs, orgID);</span>
<span class="nc" id="L231">		boolean isAddable = isEditable(hasPrivileges(PrivilegeKeys.FS_ADDROTATIONS_ID), orgID);</span>
<span class="nc" id="L232">		nodeAttributes.put(IS_EDITABLE, String.valueOf(isEditable));</span>
<span class="nc" id="L233">		nodeAttributes.put(IS_DELETEABLE, String.valueOf(isDeleteable));</span>
<span class="nc" id="L234">		nodeAttributes.put(IS_ADDABLE, String.valueOf(isAddable));</span>
<span class="nc" id="L235">		toggleBtnOnNodeSelect(rowData, WorkRulesRH.WORK_RULES_COPY_PAGE_ACTION, hasEditPrivs);</span>
<span class="nc" id="L236">		rowData.setNodeAttributes(nodeAttributes);</span>
<span class="nc" id="L237">	}</span>

	@Override
	protected void setDetailRowAttributes(MultiColumnNodeData mcnd, MultiColumnNodeData mcndDetail, ID orgID) {
<span class="nc" id="L241">		HashMap&lt;String, String&gt; nodeAttributes = mcndDetail.getNodeAttributes();</span>
<span class="nc" id="L242">		boolean hasEditPrivs = hasPrivileges(PrivilegeKeys.FS_EDITROTATIONS_ID);</span>
<span class="nc" id="L243">		nodeAttributes.put(IS_EDITABLE, mcnd.getNodeAttributes().get(IS_EDITABLE));</span>
<span class="nc" id="L244">		toggleBtnOnNodeSelect(mcndDetail, WorkRulesRH.WORK_RULES_COPY_PAGE_ACTION, hasEditPrivs);</span>
<span class="nc" id="L245">		nodeAttributes.put(IS_COPYABLE, mcnd.getNodeAttributes().get(IS_COPYABLE));</span>
<span class="nc" id="L246">		nodeAttributes.put(IS_DELETEABLE, mcnd.getNodeAttributes().get(IS_DELETEABLE));</span>
<span class="nc" id="L247">		nodeAttributes.put(IS_ADDABLE, mcnd.getNodeAttributes().get(IS_ADDABLE));</span>
<span class="nc" id="L248">		nodeAttributes.put(&quot;isDetail&quot;, &quot;true&quot;);</span>
<span class="nc" id="L249">	}</span>

	@Override
	protected void initHeader() {
		// Do nothing. This is taken care of by the RotationListPC
<span class="nc" id="L254">	}</span>

	@Override
	protected void initSelectableItems() {

<span class="nc" id="L259">	}</span>

	@Override
	protected void initContentTitle() {
<span class="nc" id="L263">		super.initContentTitle();</span>
<span class="nc" id="L264">		m_contentTitlePC.setPageTitle(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ROTATIONS));</span>
<span class="nc" id="L265">	}</span>

	public static RotationsListPM getInstance(RequestContext context) {
<span class="nc" id="L268">		return (RotationsListPM) PageModel.getInstance(context, RotationsListPM.class);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>