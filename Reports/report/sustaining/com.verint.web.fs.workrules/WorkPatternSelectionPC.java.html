<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WorkPatternSelectionPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">WorkPatternSelectionPC.java</span></div><h1>WorkPatternSelectionPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeType;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.workrules.assignment.WorkPatternListPopupPM;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.list.DynamicMultiColListWithToolbarPC;
import com.witness.web.uif.pagecomponent.table.DefaultHeaderData;
import com.witness.web.uif.pagecomponent.table.GenericHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.system.RequestContext;

import javax.servlet.http.HttpServletRequest;
import java.util.*;

/**
 * This component is a dynamic list of Work Patterns. It has a toolbar
 * which has buttons for manipulating the list.
 *
 * @author rfunderburg
 */
@SuppressWarnings(&quot;serial&quot;)
public class WorkPatternSelectionPC extends PageComponent {
<span class="nc" id="L36">	private ID data_selectedOrgID = null;</span>
<span class="nc" id="L37">	private List&lt;ShiftPattern&gt; data_workPatterns = new ArrayList&lt;ShiftPattern&gt;();</span>
	;
	private MyDynamicMultiColListPC pc_list;
<span class="nc" id="L40">	private Map&lt;ID, EmployeeType&gt; data_employeeTypeMap = new HashMap&lt;ID, EmployeeType&gt;();</span>
<span class="nc" id="L41">	private Map&lt;ID, Organization&gt; data_orgMap = new HashMap&lt;ID, Organization&gt;();</span>

	/**
	 * This subclass only exists so that we can change the visibility of the initJSVariables
	 * method, which is vital for component initialization.
	 */
	private static class MyDynamicMultiColListPC extends DynamicMultiColListWithToolbarPC {
		public MyDynamicMultiColListPC(RequestContext context) {
<span class="nc" id="L49">			super(context);</span>
<span class="nc" id="L50">			addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="nc" id="L51">		}</span>

		@Override
		protected void initJSVariables() {
<span class="nc" id="L55">			super.initJSVariables();</span>
<span class="nc" id="L56">		}</span>

		@SuppressWarnings(&quot;rawtypes&quot;)
		@Override
		protected Map getJSVariableMap() {
<span class="nc" id="L61">			return super.getJSVariableMap();</span>
		}
	}


	public WorkPatternSelectionPC(RequestContext context, String name) {
<span class="nc" id="L67">		super(context);</span>
<span class="nc" id="L68">		pc_list = new MyDynamicMultiColListPC(context);</span>
<span class="nc" id="L69">		pc_list.setName(name);</span>
<span class="nc" id="L70">		pc_list.setIsCreateButtonShown(false);</span>
<span class="nc" id="L71">	}</span>

	@Override
	public boolean validate() {
<span class="nc" id="L75">		return pc_list.validate();</span>
	}

	@Override
	public String getRequiredHTML() {
<span class="nc" id="L80">		return pc_list.getRequiredHTML();</span>
	}


	@Override
	public void setEnabled(boolean enabled) {
<span class="nc" id="L86">		pc_list.setEnabled(enabled);</span>
<span class="nc" id="L87">	}</span>

	@Override
	public void setVisible(boolean visible) {
<span class="nc" id="L91">		pc_list.setVisible(visible);</span>
<span class="nc" id="L92">	}</span>

	public void setData(ID selectedOrgID, Collection&lt;ShiftPattern&gt; workPatterns,
			Map&lt;ID, EmployeeType&gt; employeeTypeMap,
			Map&lt;ID, Organization&gt; orgMap) {
<span class="nc" id="L97">		data_selectedOrgID = selectedOrgID;</span>
<span class="nc" id="L98">		data_workPatterns.addAll(workPatterns);</span>
<span class="nc" id="L99">		data_employeeTypeMap.putAll(employeeTypeMap);</span>
<span class="nc" id="L100">		data_orgMap.putAll(orgMap);</span>
<span class="nc" id="L101">	}</span>

	@Override
	protected void initJSVariables() {
<span class="nc" id="L105">		super.initJSVariables();</span>
<span class="nc" id="L106">		pc_list.initJSVariables();</span>
<span class="nc" id="L107">	}</span>

	@SuppressWarnings({&quot;rawtypes&quot;, &quot;unchecked&quot;})
	@Override
	protected Map getJSVariableMap() {
<span class="nc" id="L112">		Map retVal = new HashMap();</span>
<span class="nc" id="L113">		retVal.putAll(super.getJSVariableMap());</span>
<span class="nc" id="L114">		retVal.putAll(pc_list.getJSVariableMap());</span>
<span class="nc" id="L115">		return retVal;</span>
	}

	@Override
	public void initValidators() {
<span class="nc" id="L120">		pc_list.initValidators();</span>
<span class="nc" id="L121">	}</span>

	@Override
	public void setName(String name) {
<span class="nc" id="L125">		pc_list.setName(name);</span>
<span class="nc" id="L126">	}</span>

	@Override
	public String getName() {
<span class="nc" id="L130">		return pc_list.getName();</span>
	}

	@Override
	public Collection&lt;String&gt; getRequireJavaScriptFiles() {
<span class="nc" id="L135">		LinkedList&lt;String&gt; files = new LinkedList&lt;String&gt;();</span>
<span class="nc" id="L136">		files.addAll(super.getRequireJavaScriptFiles());</span>
<span class="nc" id="L137">		files.addAll(pc_list.getRequireJavaScriptFiles());</span>
<span class="nc" id="L138">		return files;</span>
	}

	@Override
	public void initForDisplay() {
<span class="nc" id="L143">		super.initForDisplay();</span>
<span class="nc" id="L144">		initHeader();</span>
<span class="nc" id="L145">		initRows();</span>

<span class="nc" id="L147">		pc_list.getDynamicMultiColList().setIsRowNumberEnabled(true);</span>

<span class="nc" id="L149">		ToolbarPC toolbar = pc_list.getToolbar();</span>
<span class="nc" id="L150">		ToolbarTextButton addButton = toolbar.createPopupWindowButton(</span>
				WorkPatternSelectionPopupPM.POPUP_ID,
<span class="nc" id="L152">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_ADD),</span>
				true);
<span class="nc" id="L154">		toolbar.addToolbarElement(addButton);</span>

<span class="nc" id="L156">		addButton.setAttribute(WorkPatternSelectionPopupPM.POPUP_ARG_PARENT_TABLE, pc_list.getDynamicMultiColList().getName());</span>
<span class="nc" id="L157">		addButton.setAttribute(WorkPatternSelectionPopupPM.POPUP_ARG_ORG_ID, data_selectedOrgID.toString());</span>

		// Popup for the add button
<span class="nc" id="L160">		addPopupArgs(</span>
				WorkPatternSelectionPopupPM.POPUP_ID,
				WorkPatternSelectionPopupPM.POPUP_URL,
				&quot;&quot;, // Static params
				WorkPatternSelectionPopupPM.POPUP_ARGS, // dynamic param names
				&quot;1000,600,ctr,ctr&quot;, // window properties
				true, // isModal
				1); // num windows allowed

		// Popup for the info button
<span class="nc" id="L170">		addPopupArgs(</span>
				WorkPatternListPopupPM.POPUP_ID,
				WorkPatternListPopupPM.FORM_ACTION,
				&quot;&quot;, // Static params
				WorkPatternListPopupPM.POPUP_ARGS, // dynamic param names
				&quot;1000,600,ctr,ctr&quot;, // window properties
				false, // isModal
				1); // num windows allowed

<span class="nc" id="L179">		pc_list.initForDisplay();</span>
<span class="nc" id="L180">	}</span>

	private String getInfoButtonPopupJS() {
	/* This logic is based on the WorkRulesUtil.js function handleInfoPopup. However because this component
		 * uses a DynamicTable instead of a InsertableTable, the method to get the work pattern ids differs.
		 */

		//String
<span class="nc" id="L188">		TimeZone tz = data_orgMap.get(data_selectedOrgID).getTimeZone();</span>
<span class="nc" id="L189">		StringBuffer js = new StringBuffer();</span>
		// Set the selectedIDs attr on the button
<span class="nc" id="L191">		js.append(&quot;jQuery(this).attr('&quot;)</span>
<span class="nc" id="L192">				.append(WorkPatternListPopupPM.POPUP_ARG_SELECTED_IDS).append(&quot;',&quot;)</span>
<span class="nc" id="L193">				.append(pc_list.getDynamicMultiColList().getName()).append(&quot;.getRowIDs().join());&quot;);</span>
		// Set the is info popup attr on the button
<span class="nc" id="L195">		js.append(&quot;jQuery(this).attr('&quot;).append(WorkPatternListPopupPM.POPUP_ARG_IS_INFO_POPUP).append(&quot;', 'true');&quot;);</span>
		// set the time zone arg on the button
<span class="nc" id="L197">		js.append(&quot;jQuery(this).attr('&quot;).append(OTExtensionListPopupPM.ARG_TIME_ZONE).append(&quot;', '&quot;).append(tz.getID()).append(&quot;');&quot;);</span>
		// set the time zone date arg on the button
<span class="nc" id="L199">		js.append(&quot;jQuery(this).attr('&quot;).append(OTExtensionListPopupPM.ARG_TIME_ZONE_DATE).append(&quot;', &quot;).append(System.currentTimeMillis()).append(&quot;);&quot;);</span>
		// call the onSelect function of the header. This does the actual popup
<span class="nc" id="L201">		js.append(pc_list.getDynamicMultiColList().getHeader().getName()).append(&quot;.onSelect('&quot;).append(WorkPatternListPopupPM.POPUP_ID).append(&quot;', this);&quot;);</span>
<span class="nc" id="L202">		return js.toString();</span>
	}


	private void initHeader() {
<span class="nc" id="L207">		TableHeaderPC header = pc_list.getDynamicMultiColList().getHeader();</span>
<span class="nc" id="L208">		header.setHeaders(new ArrayList&lt;GenericHeaderData&gt;());</span>

<span class="nc" id="L210">		Localizer localizer = m_context.getLocalizer();</span>

<span class="nc" id="L212">		DefaultHeaderData dhd = new DefaultHeaderData(FsWebBundleKey.FS_NAME,</span>
<span class="nc" id="L213">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_NAME));</span>
		// Add info button to header
<span class="nc" id="L215">		dhd.addImageButton(</span>
				ImageFileID.TOOLTIP_BUTTON,
<span class="nc" id="L217">				m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_VIEW_WORK_PATTERN_DETAILS),</span>
<span class="nc" id="L218">				getInfoButtonPopupJS());</span>
<span class="nc" id="L219">		dhd.setSortable(false);</span>
<span class="nc" id="L220">		header.addColumnHeaderData(dhd);</span>
<span class="nc" id="L221">		header.addColumnHeaderData(FsWebBundleKey.FS_CONSISTENCY_TOLERANCE, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_CONSISTENCY_TOLERANCE), true);</span>
<span class="nc" id="L222">		header.addColumnHeaderData(FsWebBundleKey.FS_EMPLOYEE_TYPE, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_EMPLOYEE_TYPE), true);</span>
<span class="nc" id="L223">		header.addColumnHeaderData(FsWebBundleKey.FS_SHIFT_ORG_SELECTOR, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_SHIFT_ORG_SELECTOR), true);</span>
<span class="nc" id="L224">		header.addColumnHeaderData(UIFWebBundleKey.LIST_HEADER_DESCRIPTION, localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.LIST_HEADER_DESCRIPTION), true);</span>

<span class="nc" id="L226">		DefaultMultiColumnNodeData nd = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L227">		nd.add(&quot;Name&quot;);</span>
<span class="nc" id="L228">		nd.add(&quot;ConsistencyTolerance&quot;);</span>
<span class="nc" id="L229">		nd.add(&quot;EmployeeType&quot;);</span>
<span class="nc" id="L230">		nd.add(&quot;Organization&quot;);</span>
<span class="nc" id="L231">		nd.add(&quot;Description&quot;);</span>
<span class="nc" id="L232">		pc_list.getDynamicMultiColList().setTemplateNodeData(nd);</span>
<span class="nc" id="L233">	}</span>

	private void initRows() {
		@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L237">		List&lt;MultiColumnNodeData&gt; rows = pc_list.getDynamicMultiColList().getListModel();</span>
<span class="nc" id="L238">		rows.clear();</span>

<span class="nc bnc" id="L240" title="All 2 branches missed.">		if (data_workPatterns != null) {</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">			for (ShiftPattern shiftPattern : data_workPatterns) {</span>
<span class="nc" id="L242">				DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData(shiftPattern.getID());</span>

				//Name
<span class="nc bnc" id="L245" title="All 2 branches missed.">				if (shiftPattern.getDeletedOnDate() != null) {</span>
					//Work pattern was deleted before the view end date or sp end date if in campaign mode
<span class="nc" id="L247">					rowData.add(shiftPattern.getName() + &quot; (&quot; + getLocalizer().i18n(</span>
							FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_TRAINING_STATUS_DELETED) + &quot;)&quot;);
				} else {
<span class="nc" id="L250">					rowData.add(shiftPattern.getName());</span>
				}

				//Consistency Tolerance
<span class="nc" id="L254">				rowData.add(m_localizer.formatDurationInMins(shiftPattern.getConsistentStartsTolerance()));</span>

				//Employee Type
<span class="nc" id="L257">				EmployeeType et = data_employeeTypeMap.get(shiftPattern.getEmployeeTypeID());</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">				rowData.add(et == null ? &quot;&quot; : et.getDescription());</span>

				//Organization
<span class="nc" id="L261">				ID orgID = shiftPattern.getOrganizationID();</span>
<span class="nc" id="L262">				Organization org = null;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">				if (orgID != null) {</span>
<span class="nc" id="L264">					org = data_orgMap.get(shiftPattern.getOrganizationID());</span>
<span class="nc" id="L265">					rowData.add(org.getName());</span>
				} else {
<span class="nc" id="L267">					rowData.add(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.LOCAL));</span>
				}

				//Description
<span class="nc" id="L271">				rowData.add(shiftPattern.getDescription());</span>

<span class="nc" id="L273">				rows.add(rowData);</span>
<span class="nc" id="L274">			}</span>
		}

		// You would think this isn't necessary, but it is. The MultiColListPC sets some internal state when
		// this method is called.
<span class="nc" id="L279">		pc_list.getDynamicMultiColList().setListModel(rows);</span>
<span class="nc" id="L280">	}</span>

	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L283">		return pc_list.extractParameters(request);</span>
	}

	@Override
	public String getJavaScriptInitCode() {
<span class="nc" id="L288">		return pc_list.getJavaScriptInitCode();</span>
	}

	@Override
	public String getHtmlDisplay() {
<span class="nc" id="L293">		return pc_list.getHtmlDisplay();</span>
	}

	public List&lt;ID&gt; getExtractedWorkPatternIDs() {
<span class="nc" id="L297">		return pc_list.getDynamicMultiColList().getExtractedRowIDs();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>