<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WorkPatternExportPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">WorkPatternExportPopupPM.java</span></div><h1>WorkPatternExportPopupPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeType;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.*;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.organization.setup.employeetype.EmployeeTypeModelHandler;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.shift.ShiftUtil;
import com.witness.web.uif.data.DataSet;
import com.witness.web.uif.data.DataTable;
import com.witness.web.uif.data.DataTableColumn;
import com.witness.web.uif.data.DataTableRow;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.TimeZoneOverrideUtil;

import java.util.*;

public class WorkPatternExportPopupPM extends WorkRulesExportPopupPM {
	private static final long serialVersionUID = 1L;

	public static final String VIEW_ACTION = &quot;work_pattern_export&quot;;
	public static final String FORM_ACTION = &quot;work_pattern_export_download&quot;;

	private Collection&lt;EmployeeType&gt; allEmployeeTypes;
<span class="nc" id="L31">	private Organization m_organization = null;</span>
<span class="nc" id="L32">	private SchedulingPeriod m_schedulingPeriod = null;</span>
	protected TimeZone m_optimizationTargetTimeZone;
<span class="nc" id="L34">	protected Date m_timeZoneEffectiveDate = new Date();</span>

<span class="nc" id="L36">	private Map&lt;ID, Organization&gt; m_organizationMap = null;</span>
<span class="nc" id="L37">	private Map&lt;ID, Campaign&gt; m_campaignMap = null;</span>
<span class="nc" id="L38">	private Map&lt;ID, Activity&gt; m_activityMap = null;</span>
<span class="nc" id="L39">	private Map&lt;ID, EmployeeType&gt; m_employeeTypeMap = null;</span>
<span class="nc" id="L40">	private int displayDayOfWeekStart = 1;</span>

	public WorkPatternExportPopupPM(RequestContext context) {
<span class="nc" id="L43">		super(context);</span>

		// Disable comma delimiter because shift event additional activities field comma delimits multiple assignments.
<span class="nc" id="L46">		setIsCommaDelimiterEnabled(false);</span>
<span class="nc" id="L47">	}</span>

	public static WorkPatternExportPopupPM getInstance(RequestContext context) {
<span class="nc" id="L50">		return (WorkPatternExportPopupPM) getInstance(context, WorkPatternExportPopupPM.class);</span>
	}

	@Override
	public DataSet getDataSet() throws Exception {
<span class="nc" id="L55">		DataSet ds = new DataSet();</span>

		Collection&lt;ShiftPattern&gt; shiftPatterns;
<span class="nc bnc" id="L58" title="All 2 branches missed.">		if (m_isByOrganization) {  // Organization Mode</span>
<span class="nc" id="L59">			ID organizationId = new ID(m_organizationId);</span>
<span class="nc" id="L60">			m_organization = OrganizationModelHandler.getOrganization(m_context, organizationId);</span>
<span class="nc" id="L61">			m_optimizationTargetTimeZone = m_organization.getTimeZone();</span>
<span class="nc" id="L62">			m_timeZoneEffectiveDate = new Date();</span>
<span class="nc" id="L63">			allEmployeeTypes = EmployeeTypeModelHandler.getEmployeeTypes(m_context, organizationId);</span>
<span class="nc" id="L64">			shiftPatterns = WorkRulesModelHandler.getShiftPatternsByOrg(m_context, organizationId);</span>
<span class="nc" id="L65">		} else {  // Campaign Mode</span>
<span class="nc" id="L66">			ID schedulingPeriodId = new ID(m_schedulingPeriodId);</span>
<span class="nc" id="L67">			m_schedulingPeriod = CampaignModelHandler.getSchedulingPeriodByID(</span>
					m_context, schedulingPeriodId);
<span class="nc" id="L69">			m_timeZoneEffectiveDate = m_schedulingPeriod.getStartTime();</span>
<span class="nc" id="L70">			allEmployeeTypes = EmployeeTypeModelHandler.getEmployeeTypes(m_context,</span>
<span class="nc" id="L71">					WorkRulesModelHandler.getOrgIDsLinkedToSP(m_context, schedulingPeriodId));</span>
<span class="nc" id="L72">			shiftPatterns = WorkRulesModelHandler.getShiftPatternsBySchedulingPeriodCampaignOnly(m_context, m_schedulingPeriod);</span>
		}

<span class="nc" id="L75">		initMaps(shiftPatterns);</span>

		// Work Patterns Start
<span class="nc" id="L78">		DataTable table = new DataTable(i18n(m_fsResourceBundle, FsWebBundleKey.WORK_PATTERNS));</span>
<span class="nc" id="L79">		ds.add(table);</span>

<span class="nc bnc" id="L81" title="All 2 branches missed.">		if (m_isByOrganization) {</span>
<span class="nc" id="L82">			table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_ORGANIZATION)));</span>
		} else {
<span class="nc" id="L84">			table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_CAMPAIGN)));</span>
		}
<span class="nc" id="L86">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_NAME)));</span>
<span class="nc" id="L87">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_DESCRIPTION)));</span>
<span class="nc" id="L88">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_CONSISTENCY_TOLERANCE)));</span>
<span class="nc" id="L89">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_EMPLOYEE_TYPE)));</span>
<span class="nc" id="L90">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_PATTERN_TYPE)));</span>

<span class="nc bnc" id="L92" title="All 2 branches missed.">		for (ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="nc" id="L93">			DataTableRow row = table.newRow();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">			if (shiftPattern.getOrganizationID() == null) {</span>
<span class="nc" id="L95">				row.add(i18n(m_fsResourceBundle, FsWebBundleKey.LOCAL));</span>
			} else {
<span class="nc" id="L97">				row.add(m_organizationMap.get(shiftPattern.getOrganizationID()).getName());</span>
			}
<span class="nc" id="L99">			row.add(shiftPattern.getName());</span>
<span class="nc" id="L100">			row.add(shiftPattern.getDescription());</span>
<span class="nc" id="L101">			row.add(m_localizer.formatDurationInMins(shiftPattern.getConsistentStartsTolerance()));</span>
<span class="nc" id="L102">			row.add(m_employeeTypeMap.get(shiftPattern.getEmployeeTypeID()).getDescription());</span>
<span class="nc" id="L103">			row.add(ShiftUtil.getWorkPatternPeriodLocalizedValue(m_localizer, shiftPattern.getPeriod()));</span>
<span class="nc" id="L104">		}</span>
		// Work Patterns End

		// Work Patterns Work Days Start
<span class="nc" id="L108">		table = new DataTable(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_DAYS));</span>
<span class="nc" id="L109">		ds.add(table);</span>

<span class="nc" id="L111">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_PATTERN_NAME)));</span>
<span class="nc" id="L112">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_NAME)));</span>
<span class="nc" id="L113">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_DAYS)));</span>
<span class="nc" id="L114">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_CONSISTENT_SHIFT_EVENTS_HEADER)));</span>
<span class="nc" id="L115">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_MIN_CONSECUTIVE_DAYS_HEADER)));</span>
<span class="nc" id="L116">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_MAX_CONSECUTIVE_DAYS_HEADER)));</span>

		// The shift occurrences are stored relative to the start of week.
<span class="nc bnc" id="L119" title="All 2 branches missed.">		for (ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="nc" id="L120">			HashMap&lt;Shift, ShiftPatternShiftAttributes&gt; shiftInfo = shiftPattern.getShiftPatternShiftAttributes();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">			for (Shift shift : shiftInfo.keySet()) {</span>
<span class="nc" id="L122">				DataTableRow row = table.newRow();</span>
<span class="nc" id="L123">				row.add(shiftPattern.getName());</span>
<span class="nc" id="L124">				row.add(shift.getName());</span>

<span class="nc" id="L126">				StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L128">				ShiftPatternPeriod sp = shiftPattern.getPeriod();</span>
<span class="nc" id="L129">				int[] daysInPeriod = sp.getDaysInPeriod();</span>

<span class="nc" id="L131">				int maxDayInPeriod = 0;</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">				for (int entry : daysInPeriod) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">					if (entry &gt; maxDayInPeriod) {</span>
<span class="nc" id="L134">						maxDayInPeriod = entry;</span>
					}
				}

<span class="nc" id="L138">				ShiftPatternShiftAttributes shiftPatternAttr = shiftInfo.get(shift);</span>
<span class="nc" id="L139">				Set&lt;Integer&gt; occurrenceDays = new HashSet&lt;Integer&gt;();</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">				for (Integer entry : shiftPatternAttr.getOccurrenceDays()) {</span>
					// if the entry is not outside the bounds of the days in period, it is ok, otherwise filter it out.
<span class="nc bnc" id="L142" title="All 2 branches missed.">					if (entry &lt;= maxDayInPeriod) {</span>
<span class="nc" id="L143">						occurrenceDays.add(entry);</span>
					}
<span class="nc" id="L145">				}</span>
<span class="nc" id="L146">				sb.append(ShiftUtil.workDaysArrayToString(occurrenceDays.toArray(new Integer[0])));</span>

<span class="nc" id="L148">				row.add(sb.toString());</span>

				//Consistent Shift Activities
<span class="nc" id="L151">				row.add(getLocalizer().formatYesNo(shiftInfo.get(shift).isConsistentShiftActivities()));</span>

				//Min Consecutive Days
<span class="nc" id="L154">				row.add(Integer.toString(shiftInfo.get(shift).getMinConsecutiveDay()));</span>

				//Max Consecutive Days
<span class="nc" id="L157">				row.add(Integer.toString(shiftInfo.get(shift).getMaxConsecutiveDay()));</span>
<span class="nc" id="L158">			}</span>
<span class="nc" id="L159">		}</span>
		// Work Patterns Work Days End

		// Work Pattern Consistency Start
<span class="nc" id="L163">		table = new DataTable(i18n(m_fsResourceBundle, FsWebBundleKey.FS_CONSISTENCY));</span>
<span class="nc" id="L164">		ds.add(table);</span>

<span class="nc" id="L166">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_PATTERN_NAME)));</span>
<span class="nc" id="L167">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_NAME)));</span>
<span class="nc" id="L168">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_CONSISTENCY)));</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">		for (ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="nc" id="L171">			HashMap&lt;Shift, ShiftPatternShiftAttributes&gt; shiftInfo = shiftPattern.getShiftPatternShiftAttributes();</span>
<span class="nc" id="L172">			ShiftPatternPeriod sp = shiftPattern.getPeriod();</span>
<span class="nc" id="L173">			int[] daysInPeriod = sp.getDaysInPeriod();</span>

<span class="nc bnc" id="L175" title="All 2 branches missed.">			for (Shift shift : shiftInfo.keySet()) {</span>
				// Ignore possible days off for consistency.
<span class="nc bnc" id="L177" title="All 2 branches missed.">				if (shift.getID().toInt() == ShiftFieldInfo.POSSIBLE_DAYS_OFF_SHIFT_ID) {</span>
<span class="nc" id="L178">					continue;</span>
				}

<span class="nc" id="L181">				DataTableRow row = table.newRow();</span>
<span class="nc" id="L182">				row.add(shiftPattern.getName());</span>
<span class="nc" id="L183">				row.add(shift.getName());</span>
<span class="nc" id="L184">				HashMap&lt;Integer, Integer&gt; consistencyMap = shiftInfo.get(shift).getConsistentShiftGroupMap();</span>

<span class="nc" id="L186">				StringBuilder sb = new StringBuilder();</span>

<span class="nc bnc" id="L188" title="All 2 branches missed.">				for (int i = 0; i &lt; daysInPeriod.length; i++) {</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">					if (sb.length() &gt; 0) {</span>
<span class="nc" id="L190">						sb.append(&quot;,&quot;);    // We don't currently localize list delimiters.</span>
					}
<span class="nc" id="L192">					Object consistencyValue = consistencyMap.get(i + 1);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">					sb.append(String.valueOf(consistencyValue == null ? 0 : consistencyValue));</span>
				}

<span class="nc" id="L196">				row.add(sb.toString());</span>
<span class="nc" id="L197">			}</span>
<span class="nc" id="L198">		}</span>
		// Work Pattern Consistency End

		// VTO Events Start
<span class="nc" id="L202">		table = new DataTable(i18n(m_fsResourceBundle, FsWebBundleKey.FS_VTO_EVENTS));</span>
<span class="nc" id="L203">		ds.add(table);</span>

<span class="nc" id="L205">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_PATTERN_NAME)));</span>
<span class="nc" id="L206">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_VTO_EVENT)));</span>
<span class="nc" id="L207">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_START_TIMES)));</span>

<span class="nc bnc" id="L209" title="All 2 branches missed.">		for (ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="nc" id="L210">			HashMap&lt;Shift, ShiftPatternShiftAttributes&gt; shiftInfo = shiftPattern.getShiftPatternShiftAttributes();</span>

<span class="nc" id="L212">			LinkedHashMap&lt;VTOEvent, ShiftPattern.StartTime&gt; vtoEventStartTimeMap =</span>
<span class="nc" id="L213">					new LinkedHashMap&lt;VTOEvent, ShiftPattern.StartTime&gt;(shiftPattern.getVTOEventStartTimes());</span>
			// Filter out vto events deleted before view date
<span class="nc bnc" id="L215" title="All 2 branches missed.">			for (Iterator&lt;Map.Entry&lt;VTOEvent, ShiftPattern.StartTime&gt;&gt; iter = vtoEventStartTimeMap.entrySet().iterator(); iter.hasNext(); ) {</span>
<span class="nc" id="L216">				VTOEvent vto = iter.next().getKey();</span>
<span class="nc bnc" id="L217" title="All 4 branches missed.">				if (vto.getDeleteOnDate() != null &amp;&amp; vto.getDeleteOnDate().before(m_timeZoneEffectiveDate)) {</span>
<span class="nc" id="L218">					iter.remove();</span>
				}
<span class="nc" id="L220">			}</span>

<span class="nc bnc" id="L222" title="All 2 branches missed.">			for (VTOEvent vtoEvent : vtoEventStartTimeMap.keySet()) {</span>
<span class="nc" id="L223">				DataTableRow row = table.newRow();</span>

				// Work Pattern VTO Extension is Assigned to.
<span class="nc" id="L226">				row.add(shiftPattern.getName());</span>

				// Name
<span class="nc" id="L229">				row.add(vtoEvent.getName());</span>

				// Start Times
<span class="nc" id="L232">				row.add(WorkRulesUtil.getVTOEventStartTimeText(getLocalizer(), vtoEventStartTimeMap.get(vtoEvent)));</span>
<span class="nc" id="L233">			}</span>
<span class="nc" id="L234">		}</span>
		// VTO Events End

		// OT Extensions Start
<span class="nc" id="L238">		table = new DataTable(i18n(m_fsResourceBundle, FsWebBundleKey.FS_OT_EXTS));</span>
<span class="nc" id="L239">		ds.add(table);</span>

<span class="nc" id="L241">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_WORK_PATTERN_NAME)));</span>
<span class="nc" id="L242">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_OT_EXTENSION)));</span>
<span class="nc" id="L243">		table.addColumn(new DataTableColumn(i18n(m_fsResourceBundle, FsWebBundleKey.FS_START_TIMES)));</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">		for (ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="nc" id="L246">			HashMap&lt;Shift, ShiftPatternShiftAttributes&gt; shiftInfo = shiftPattern.getShiftPatternShiftAttributes();</span>

<span class="nc" id="L248">			LinkedHashMap&lt;ShiftOTExtension, ShiftPattern.StartTime&gt; otExtensionStartTimeMap =</span>
<span class="nc" id="L249">					new LinkedHashMap&lt;ShiftOTExtension, ShiftPattern.StartTime&gt;(shiftPattern.getOTExtensionStartTimes());</span>

			// Filter out shift overtime extensions deleted before the view date
<span class="nc bnc" id="L252" title="All 2 branches missed.">			for (Iterator&lt;Map.Entry&lt;ShiftOTExtension, ShiftPattern.StartTime&gt;&gt; iter = otExtensionStartTimeMap.entrySet().iterator(); iter.hasNext(); ) {</span>
<span class="nc" id="L253">				ShiftOTExtension otExtension = iter.next().getKey();</span>
<span class="nc bnc" id="L254" title="All 4 branches missed.">				if (otExtension.getDeleteOnDate() != null &amp;&amp; otExtension.getDeleteOnDate().before(m_timeZoneEffectiveDate)) {</span>
<span class="nc" id="L255">					iter.remove();</span>
				}
<span class="nc" id="L257">			}</span>

<span class="nc bnc" id="L259" title="All 2 branches missed.">			for (ShiftOTExtension otExtension : otExtensionStartTimeMap.keySet()) {</span>
<span class="nc" id="L260">				DataTableRow row = table.newRow();</span>

				// Work Pattern OT Extension is Assigned to
<span class="nc" id="L263">				row.add(shiftPattern.getName());</span>

				// OT Extension Name
<span class="nc" id="L266">				row.add(otExtension.getName());</span>

				// Start Times
<span class="nc" id="L269">				row.add(WorkRulesUtil.getOTExtensionStartTimeText(getLocalizer(), otExtensionStartTimeMap.get(otExtension)));</span>
<span class="nc" id="L270">			}</span>
<span class="nc" id="L271">		}</span>
		// OT Extensions End

<span class="nc" id="L274">		return ds;</span>
	}

	private void initMaps(Collection&lt;ShiftPattern&gt; shiftPatterns) throws Exception {
		// Collections of IDs of objects we will need for display
<span class="nc" id="L279">		Collection&lt;ID&gt; orgIDs = new HashSet&lt;&gt;();</span>
<span class="nc" id="L280">		Collection&lt;ID&gt; campaignIDs = new HashSet&lt;&gt;();</span>
<span class="nc" id="L281">		Collection&lt;ID&gt; activityIDs = new HashSet&lt;&gt;();</span>
<span class="nc" id="L282">		Collection&lt;ID&gt; empTypeIDs = new HashSet&lt;&gt;();</span>

<span class="nc bnc" id="L284" title="All 2 branches missed.">		for (ShiftPattern sp : shiftPatterns) {</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">			if (sp.getOrganizationID() != null) {</span>
<span class="nc" id="L286">				orgIDs.add(sp.getOrganizationID());</span>
			}
<span class="nc bnc" id="L288" title="All 2 branches missed.">			if (sp.getCampaignID() != null) {</span>
<span class="nc" id="L289">				campaignIDs.add(sp.getCampaignID());</span>
			}
<span class="nc bnc" id="L291" title="All 2 branches missed.">			if (sp.getEmployeeTypeID() != null) {</span>
<span class="nc" id="L292">				empTypeIDs.add(sp.getEmployeeTypeID());</span>
			}
<span class="nc bnc" id="L294" title="All 2 branches missed.">			for (Shift shift : sp.getShiftPatternShiftAttributes().keySet()) {</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">				if (shift.getOrganizationID() != null) {</span>
<span class="nc" id="L296">					orgIDs.add(shift.getOrganizationID());</span>
				}
<span class="nc bnc" id="L298" title="All 2 branches missed.">				if (shift.getCampaignID() != null) {</span>
<span class="nc" id="L299">					campaignIDs.add(shift.getCampaignID());</span>
				}
<span class="nc bnc" id="L301" title="All 2 branches missed.">				if (shift.getActivityID() != null) {</span>
<span class="nc" id="L302">					activityIDs.add(shift.getActivityID());</span>
				}
<span class="nc bnc" id="L304" title="All 2 branches missed.">				for (ShiftEvent se : shift.getShiftEvents()) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">					if (se.getOrganizationID() != null) {</span>
<span class="nc" id="L306">						orgIDs.add(se.getOrganizationID());</span>
					}
<span class="nc bnc" id="L308" title="All 2 branches missed.">					if (se.getCampaignID() != null) {</span>
<span class="nc" id="L309">						campaignIDs.add(se.getCampaignID());</span>
					}
<span class="nc bnc" id="L311" title="All 2 branches missed.">					if (se.getActivityID() != null) {</span>
<span class="nc" id="L312">						activityIDs.add(se.getActivityID());</span>
					}
<span class="nc" id="L314">				}</span>
<span class="nc" id="L315">			}</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">			for (VTOEvent vtoe : sp.getVTOEventStartTimes().keySet()) {</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">				if (vtoe.getOrganizationID() != null) {</span>
<span class="nc" id="L318">					orgIDs.add(vtoe.getOrganizationID());</span>
				}
<span class="nc bnc" id="L320" title="All 2 branches missed.">				if (vtoe.getCampaignID() != null) {</span>
<span class="nc" id="L321">					campaignIDs.add(vtoe.getCampaignID());</span>
				}
<span class="nc bnc" id="L323" title="All 2 branches missed.">				if (vtoe.getActivityID() != null) {</span>
<span class="nc" id="L324">					activityIDs.add(vtoe.getActivityID());</span>
				}
<span class="nc" id="L326">			}</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">			for (ShiftOTExtension sote : sp.getOTExtensionStartTimes().keySet()) {</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">				if (sote.getOrganizationID() != null) {</span>
<span class="nc" id="L329">					orgIDs.add(sote.getOrganizationID());</span>
				}
<span class="nc bnc" id="L331" title="All 2 branches missed.">				if (sote.getCampaignID() != null) {</span>
<span class="nc" id="L332">					campaignIDs.add(sote.getCampaignID());</span>
				}
<span class="nc bnc" id="L334" title="All 2 branches missed.">				if (sote.getActivityID() != null) {</span>
<span class="nc" id="L335">					activityIDs.add(sote.getActivityID());</span>
				}
<span class="nc" id="L337">			}</span>
<span class="nc" id="L338">		}</span>

<span class="nc" id="L340">		m_organizationMap = WorkRulesModelHandler.getOrgs(m_context, orgIDs);</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">		if (!m_isByOrganization) {</span>
<span class="nc" id="L342">			m_campaignMap = WorkRulesModelHandler.getCampaigns(m_context, campaignIDs);</span>
		}
<span class="nc" id="L344">		m_activityMap = WorkRulesModelHandler.getActivities(m_context, activityIDs);</span>
<span class="nc" id="L345">		m_employeeTypeMap = EmployeeTypeModelHandler.getEmployeeTypesByIDs(m_context, empTypeIDs);</span>
<span class="nc" id="L346">	}</span>

	/*
	 * Initializes the start of week for display headers as well as data since they may
	 * not both be aligned depending on viewing time zone.
	 */
	private void initStartOfWeekForDataDisplay() {
<span class="nc" id="L353">		Calendar workingCalendar = null;</span>
<span class="nc" id="L354">		int weekStartDayOfWeek = Calendar.SUNDAY;</span>
<span class="nc" id="L355">		int dayBoundaryOffset = 0;</span>

<span class="nc bnc" id="L357" title="All 2 branches missed.">		if (m_isByOrganization) {</span>
			// For organization the week start is the day of week + day boundary.
<span class="nc" id="L359">			workingCalendar = Calendar.getInstance(m_organization.getTimeZone());</span>

<span class="nc" id="L361">			weekStartDayOfWeek = m_organization.getWeekStartDate(); // 1 = Sunday.</span>
<span class="nc" id="L362">			dayBoundaryOffset = m_organization.getDayBoundaryOffset();</span>

			// Configure the working date to the start of week and day boundary hours.
<span class="nc" id="L365">			workingCalendar.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L366">			workingCalendar.set(Calendar.MINUTE, dayBoundaryOffset);</span>
<span class="nc" id="L367">			workingCalendar.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L368">			workingCalendar.set(Calendar.MILLISECOND, 0);</span>

<span class="nc bnc" id="L370" title="All 2 branches missed.">			while (workingCalendar.get(Calendar.DAY_OF_WEEK) != weekStartDayOfWeek) {</span>
<span class="nc" id="L371">				workingCalendar.add(Calendar.DAY_OF_WEEK, -1);</span>
			}
		} else // This is a local organization/information related to a campaign scope definition.
		{
<span class="nc" id="L375">			Campaign cam = m_campaignMap.get(m_schedulingPeriod.getCampaignID());</span>

<span class="nc" id="L377">			workingCalendar = Calendar.getInstance(m_optimizationTargetTimeZone);</span>
<span class="nc" id="L378">			weekStartDayOfWeek = 1; // Campaign always defined as minute offset from sunday.</span>

<span class="nc" id="L380">			dayBoundaryOffset = cam.getWeekStart(); // Minute offset from sunday 12am.</span>

<span class="nc" id="L382">			workingCalendar.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L383">			workingCalendar.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L384">			workingCalendar.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L385">			workingCalendar.set(Calendar.MILLISECOND, 0);</span>

<span class="nc bnc" id="L387" title="All 2 branches missed.">			while (workingCalendar.get(Calendar.DAY_OF_WEEK) != weekStartDayOfWeek) {</span>
<span class="nc" id="L388">				workingCalendar.add(Calendar.DAY_OF_WEEK, -1);</span>
			}

<span class="nc" id="L391">			workingCalendar.add(Calendar.MINUTE, dayBoundaryOffset);</span>
		}

<span class="nc bnc" id="L394" title="All 2 branches missed.">		if (TimeZoneOverrideUtil.isTimeZoneOverridden(m_context)) {</span>
<span class="nc" id="L395">			workingCalendar.setTimeZone(m_context.getViewingTimeZone());</span>
		} else {
<span class="nc" id="L397">			workingCalendar.setTimeZone(m_optimizationTargetTimeZone);</span>
		}

<span class="nc" id="L400">		displayDayOfWeekStart = workingCalendar.get(Calendar.DAY_OF_WEEK);</span>
<span class="nc" id="L401">	}</span>

	/**
	 * Gets the appropriate day of week cell for a dow index (monday = 1)
	 *
	 * @param shiftInfo
	 * @param dow       (Monday=1 per db schema)
	 * @return
	 */
	private String getDOWCellText(ShiftPatternShiftAttributes shiftInfo, /*DayOfWeek*/int dow) {
<span class="nc bnc" id="L411" title="All 2 branches missed.">		if (shiftInfo.getConsistentShiftGroupMap().get(dow) == null) {</span>
<span class="nc" id="L412">			return getLocalizer().formatYesNo(shiftInfo.getOccurrenceDays().contains(dow));</span>
		} else {
<span class="nc" id="L414">			return getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_CONSISTENT_START_TIMES_FORMAT,</span>
<span class="nc" id="L415">					new Object[]{getLocalizer().formatYesNo(shiftInfo.getOccurrenceDays().contains(dow)),</span>
<span class="nc" id="L416">							Integer.toString(shiftInfo.getConsistentShiftGroupMap().get(dow))});</span>
		}
	}

	@Override
	public String getDefaultFileName() {
<span class="nc" id="L422">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_WORK_PATTERN_FILE_NAME);</span>
	}

	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc" id="L429">		return FORM_ACTION;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>