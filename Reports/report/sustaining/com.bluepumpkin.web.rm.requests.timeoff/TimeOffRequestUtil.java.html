<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffRequestUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.timeoff</a> &gt; <span class="el_source">TimeOffRequestUtil.java</span></div><h1>TimeOffRequestUtil.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.timeoff;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.Set;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.DateTimeUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.rm.base.RmRuntimeException;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDay;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.TimeOffIntervalAllocationUtil;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.ejb.TimeOffIntervalAllocationManager;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.FlexReqMakeupGap;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.FlexRequestMakeup;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.ejb.rm.util.TORequestUtil;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestUtil;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagecomponent.table.GenericHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title: TimeOffRequestUtil Description: Time Off Request Util class Copyright: Copyright (c) 2002 Company: Blue Pumpkin
 * Software, Inc
 * @author David Su, dsu
 * @version 1.0
 *
 *          Created on November 8, 2002, 3:25 PM
 */
public final class TimeOffRequestUtil {
	private static final String TO_CHOICE_ID_FN = &quot;tOChoiceID&quot;;
	private static final int TIME_INTERVAL = 15; //Default
	private static final int STRING_CAPACITY = 100;
	/** Creates a new instance of TimeOffRequestUtil */
<span class="nc" id="L69">	private TimeOffRequestUtil() {</span>
<span class="nc" id="L70">	}</span>

	/**
	 * Add Time Off Workflow not Active Message
	 */
	public static void addTONotActiveMsg(PageModel model) {
<span class="nc" id="L76">		model.addPageMessage(Message.INFO_TYPE, RmWebBundleKey.TIMEOFF_WORKFLOW_NOT_ACTIVE, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L77">	}</span>

	/**
	 * Add Flex Time not Active Message
	 */
	public static void addFTNotActiveMsg(PageModel model) {
<span class="nc" id="L83">		model.addPageMessage(Message.INFO_TYPE, RmWebBundleKey.FLEXTIME_WORKFLOW_NOT_ACTIVE, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L84">	}</span>

	/**
	 * Initialize Time Off Choice List Container
	 */
	@SuppressWarnings({ &quot;rawtypes&quot;})
	public static void initTimeOffChoiceListPC(RequestContext context, MultiColListPC choiceListPC, TORequest request, Set&lt;ID&gt; selectedIDs,
			ResourceBundle coreBundle, ResourceBundle rmBundle, TimeOffChoiceListPCConfig config) {
<span class="nc" id="L92">		choiceListPC.setIsRowNumberEnabled(true);</span>
<span class="nc" id="L93">		choiceListPC.setHeightInPixels(150);</span>

<span class="nc" id="L95">		Localizer localizer = context.getLocalizer();</span>

		// Init Header
<span class="nc" id="L98">		initChoiceHeader(choiceListPC, coreBundle, rmBundle, config, localizer);</span>

		// Populate List Model
<span class="nc" id="L101">		List listModel = populateChoiceListModel(context, request, selectedIDs, rmBundle, config, localizer);</span>
<span class="nc" id="L102">		choiceListPC.setIsRowNumberEnabled(config.getIsRowNumberEnabled());</span>
<span class="nc" id="L103">		choiceListPC.setListModel(listModel);</span>
<span class="nc" id="L104">	}</span>

	private static void initChoiceHeader(MultiColListPC choiceListPC, ResourceBundle coreBundle, ResourceBundle rmBundle,
			TimeOffChoiceListPCConfig config, Localizer localizer) {
<span class="nc" id="L108">		TableHeaderPC headerPC = choiceListPC.getHeader();</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">		if (config.getIsSelectable()) {</span>
<span class="nc" id="L110">			headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(coreBundle, UIFWebBundleKey.SELECTED));</span>
		}

<span class="nc" id="L113">		headerPC.setIsRowNumberEnabled(config.getIsRowNumberEnabled());</span>
<span class="nc" id="L114">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, config.getTimeOffChoiceLabelBundleKey()));</span>
<span class="nc" id="L115">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(coreBundle, UIFWebBundleKey.LENGTH));</span>
<span class="nc" id="L116">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_LABEL));</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (config.getIsShowAlert()) {</span>
<span class="nc" id="L119">			headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_CHOICES_ALERTS));</span>
		}

<span class="nc" id="L122">	}</span>

	private static List populateChoiceListModel(RequestContext context, TORequest request, Set&lt;ID&gt; selectedIDs, ResourceBundle rmBundle,
			TimeOffChoiceListPCConfig config, Localizer localizer) {
<span class="nc" id="L126">		Collection&lt;TOChoice&gt; choiceList = request.getTOChoicesAdjustedForCalculatedVto();</span>
<span class="nc" id="L127">		Collection&lt;TOChoice&gt; approvedChoices = request.getApprovedChoices();</span>
<span class="nc" id="L128">		List listModel = Collections.emptyList();</span>

<span class="nc bnc" id="L130" title="All 2 branches missed.">		if (!choiceList.isEmpty()) {</span>
<span class="nc" id="L131">			listModel = new ArrayList(choiceList.size());</span>
<span class="nc" id="L132">			boolean isSelectedChoice = false;</span>
<span class="nc" id="L133">			boolean assignSelectedChoice = false;</span>
<span class="nc" id="L134">			String hdnLbl = &quot;&quot;;</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">			for (TOChoice choice : choiceList) {</span>
<span class="nc" id="L136">				hdnLbl = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_CHOICE_NUMBERED_MF, new Object[] { hdnLbl });</span>

<span class="nc bnc" id="L138" title="All 6 branches missed.">				boolean isDisabled = isChoiceViolatedSpecialRules(choice)? true:config.getIsShowSelectedInfo()&amp;&amp;!config.getIsSelectable();</span>
				//Will assign the first choice without special rule violation
<span class="nc bnc" id="L140" title="All 4 branches missed.">				if(!assignSelectedChoice &amp;&amp; !isDisabled) {</span>
<span class="nc" id="L141">					isSelectedChoice = true;</span>
<span class="nc" id="L142">					assignSelectedChoice = true;</span>
				}
<span class="nc bnc" id="L144" title="All 6 branches missed.">				boolean useCheckBoxes =(!approvedChoices.isEmpty()&amp;&amp;approvedChoices.size()&gt;=2)||request.isAdvancedVTORequest();</span>
<span class="nc" id="L145">				MultiColumnNodeData node = createChoiceNode(context, request, choice, selectedIDs,</span>
						isSelectedChoice,
						isDisabled, config,
						rmBundle, hdnLbl,useCheckBoxes);
<span class="nc" id="L149">				listModel.add(node);</span>
				//When assigning isSelectedChoice already, next other choices should not be selected choice
<span class="nc bnc" id="L151" title="All 4 branches missed.">				if(isSelectedChoice &amp;&amp; assignSelectedChoice) {</span>
<span class="nc" id="L152">					isSelectedChoice = false;</span>
				}
<span class="nc" id="L154">			}</span>
		}
<span class="nc" id="L156">		return listModel;</span>
	}

	private static boolean isChoiceViolatedSpecialRules(TOChoice choice){
<span class="nc" id="L160">		boolean result = false;</span>
<span class="nc" id="L161">		Collection&lt;ValidationResult&gt; listValidator = choice.getValidationResults(true);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">		for (Iterator&lt;ValidationResult&gt; vIter = listValidator.iterator(); vIter.hasNext();) {</span>
<span class="nc" id="L163">			ValidationResult vResult = vIter.next();</span>
<span class="nc" id="L164">			result = TORequestUtil.checkHasSomeSpecificHardRulesViolated(vResult);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">			if (result) {</span>
<span class="nc" id="L166">				break;</span>
			}
<span class="nc" id="L168">		}</span>
<span class="nc" id="L169">		return result;</span>
	}

	/**
	 * Create Time Off Choice Node
	 */
	private static MultiColumnNodeData createChoiceNode(RequestContext context, TORequest request,
			TOChoice choice,
			Set&lt;ID&gt; selectedIDs, boolean isFirstChoice, boolean isDisabled, TimeOffChoiceListPCConfig config, ResourceBundle rmBundle,
			String hiddenLabel,boolean useCheckBoxes ) {
<span class="nc" id="L179">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L180">		TimeZone tz = context.getViewingTimeZone();</span>
<span class="nc" id="L181">		Date startDate = choice.getStartDate();</span>
<span class="nc" id="L182">		Date endDate = choice.getEndDate();</span>
<span class="nc" id="L183">		boolean isApproved = request.isApproved();</span>

<span class="nc" id="L185">		DefaultMultiColumnNodeData node = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L186">		HtmlChoiceInput choiceInput = null;</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">		if (config.getIsShowSelectedInfo()) {</span>
<span class="nc" id="L188">			ID choiceID = choice.getID();</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">			boolean isChecked = (selectedIDs == null || selectedIDs.isEmpty()) ? isFirstChoice : selectedIDs.contains(choiceID);</span>
<span class="nc" id="L190">			choiceInput = HtmlChoiceInput.newInstance(TO_CHOICE_ID_FN, choiceID.toString(), hiddenLabel, isChecked, JSUtil.ON_CHANGE,</span>
					useCheckBoxes);
<span class="nc" id="L192">			choiceInput.setIsHiddenLabel(true);// Indicates this label is not for display but just for 508 compliance</span>
<span class="nc" id="L193">			choiceInput.setIsDisabled(isDisabled);</span>
<span class="nc bnc" id="L194" title="All 4 branches missed.">			if (isChecked &amp;&amp; isDisabled) {</span>
<span class="nc" id="L195">				choiceInput.setIsValueSubmittedWhenDisabled(true);</span>
			}
		}

<span class="nc" id="L199">		StringBuilder timePeriodSB = new StringBuilder(STRING_CAPACITY);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">		if (choiceInput != null) {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">			if(config.getIsSelectable()) {</span>
<span class="nc" id="L202">				node.add(choiceInput);</span>
			} else {
<span class="nc" id="L204">				timePeriodSB.append(choiceInput);</span>
			}
		}
<span class="nc" id="L207">		timePeriodSB.append(RequestUtil.getDateDisplay(context, startDate)).append(&quot; - &quot;)</span>
<span class="nc" id="L208">				.append(RequestUtil.getDateDisplay(context, endDate));</span>
<span class="nc" id="L209">		node.add(timePeriodSB, CSSUtil.STYLE_NOWRAP);</span>

<span class="nc" id="L211">		String[] choiceLenAndAlerts = getTimeOffChoiceLenAndAlerts(choice, localizer, tz, rmBundle, isApproved,</span>
<span class="nc" id="L212">				config.getIsEnforceCustomTimeOffHoursFormat());</span>
		// if not show alert, remove the alert data that is the last item in the 3 item array.
<span class="nc bnc" id="L214" title="All 2 branches missed.">		if (!config.getIsShowAlert()) {</span>
<span class="nc" id="L215">			choiceLenAndAlerts = new String[] { choiceLenAndAlerts[0], choiceLenAndAlerts[1] };</span>
		}

<span class="nc bnc" id="L218" title="All 2 branches missed.">		for (String data : choiceLenAndAlerts) {</span>
<span class="nc" id="L219">			node.add(data);</span>
		}

<span class="nc" id="L222">		return node;</span>
	}


	private static String getHoursAccountedForTOChoiceHtml(TOChoice choice, Localizer localizer, boolean isApproved,
			boolean enforceCustomTimeOffHoursFormat) {
<span class="nc bnc" id="L228" title="All 2 branches missed.">		TOHoursPerDay hoursPerDay = choice == null ? null : choice.getHoursPerDay();</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">		long scheduledMins = hoursPerDay == null ? 0 : hoursPerDay.getTotalMinutesFromScheduled();</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">		long defaultMins = hoursPerDay == null ? 0 : hoursPerDay.getTotalMinutesFromDefaulted();</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">		boolean hasScheduledMins = scheduledMins &gt; 0;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">		boolean hasDefaultMins = defaultMins &gt; 0;</span>
<span class="nc" id="L233">		String acountedLen = getHoursAccountedForTOChoice(choice, localizer, isApproved, enforceCustomTimeOffHoursFormat);</span>
<span class="nc" id="L234">		long accountedMinutes = (long) (choice.getLength() * 60);</span>

<span class="nc bnc" id="L236" title="All 6 branches missed.">		if (accountedMinutes &lt;= 0 || (!hasScheduledMins &amp;&amp; !hasDefaultMins)) {</span>
			// No tooltip or tooltip icon if both scheduled and default minutes are zero
<span class="nc" id="L238">			return acountedLen;</span>
		}

<span class="nc" id="L241">		String scheduleHoursTooltip = &quot;&quot;;</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">		if (hasScheduledMins) {</span>
<span class="nc" id="L243">			scheduleHoursTooltip = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_TOOLTIP_SCHEDULED,</span>
<span class="nc" id="L244">					TimeOffRequestUtil.formatDurationInMinutes(localizer, scheduledMins, enforceCustomTimeOffHoursFormat));</span>
		}

<span class="nc" id="L247">		String defaultHoursTooltip = &quot;&quot;;</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">		if (hasDefaultMins) {</span>
<span class="nc" id="L249">			defaultHoursTooltip = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_TOOLTIP_DEFAULT,</span>
<span class="nc" id="L250">					TimeOffRequestUtil.formatDurationInMinutes(localizer, defaultMins, enforceCustomTimeOffHoursFormat));</span>
		}

<span class="nc bnc" id="L253" title="All 4 branches missed.">		String tooltip = String.format(&quot;%s%s%s&quot;,</span>
		// these comments are to keep the eclipse buggy formatter happy
				scheduleHoursTooltip,
				// add a &lt;br&gt; if we have both scheduled and default minutes
				hasScheduledMins &amp;&amp; hasDefaultMins ? &quot;&lt;br&gt;&quot; : &quot;&quot;,
				// default hours
				defaultHoursTooltip);

<span class="nc" id="L261">		tooltip = appendReferenceScheduleHours(choice, tooltip, localizer);</span>
<span class="nc" id="L262">		String alertIcon = HtmlUtil.imageTag(ImageFileID.TOOLTIP_BUTTON, tooltip, true, true);</span>
<span class="nc" id="L263">		return String.format(&quot;%s %s&quot;, acountedLen, alertIcon);</span>
	}

	private static String appendReferenceScheduleHours(TOChoice choice, String tooltip, Localizer localizer) {
<span class="nc" id="L267">		ID refScheduleId = choice.getReferenceScheduleID();</span>
<span class="nc bnc" id="L268" title="All 4 branches missed.">		if (refScheduleId == null || refScheduleId.toInt() &lt; 0) {</span>
<span class="nc" id="L269">			return tooltip;</span>
		}

		try {
<span class="nc" id="L273">			TimeOffIntervalAllocationManager mgr = TimeOffIntervalAllocationUtil.getMgr();</span>
<span class="nc" id="L274">			Map&lt;Integer, Pair&lt;Integer, Integer&gt;&gt; refSchedules = mgr.getRefrenceSchedulesByDayOfWeek(choice);</span>
<span class="nc" id="L275">			return appendReferenceScheduleHours(tooltip, localizer, refSchedules);</span>

<span class="nc" id="L277">		} catch (Exception e) {</span>
<span class="nc" id="L278">			throw new RmRuntimeException(&quot;Could not get TimeOffInterval manager for reference schedule tooltip data&quot;, e);</span>
		}

	}

	static String appendReferenceScheduleHours(String tooltip, Localizer localizer, Map&lt;Integer, Pair&lt;Integer, Integer&gt;&gt; refSchedules) {

<span class="nc bnc" id="L285" title="All 2 branches missed.">		if (refSchedules.isEmpty()) {</span>
<span class="nc" id="L286">			return tooltip;</span>
		}

<span class="nc" id="L289">		String[] dowNames = localizer.getWeekdayNames(false);</span>
<span class="nc" id="L290">		StringBuilder refScheduleTooltip = new StringBuilder(&quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L291">		String header = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_TOOLTIP_REF_SCHEDULE_HEADER);</span>
<span class="nc" id="L292">		refScheduleTooltip.append(header + &quot;&lt;table&gt;&quot;);</span>

<span class="nc bnc" id="L294" title="All 2 branches missed.">		for (Map.Entry&lt;Integer, Pair&lt;Integer, Integer&gt;&gt; entry : refSchedules.entrySet()) {</span>
<span class="nc" id="L295">			int dow = entry.getKey();</span>
<span class="nc" id="L296">			Pair&lt;Integer, Integer&gt; startAndDuration = entry.getValue();</span>
<span class="nc" id="L297">			int start = startAndDuration.getFirst();</span>
<span class="nc" id="L298">			int end = start + startAndDuration.getSecond();</span>
<span class="nc" id="L299">			String dayText = String.format(&quot;&lt;tr&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;-&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt; &lt;/tr&gt;&quot;, dowNames[dow],</span>
<span class="nc" id="L300">					localizer.formatTimeInMins(start), localizer.formatTimeInMins(end));</span>
<span class="nc" id="L301">			refScheduleTooltip.append(dayText);</span>
<span class="nc" id="L302">		}</span>

<span class="nc" id="L304">		refScheduleTooltip.append(&quot;&lt;/table&gt;&quot;);</span>
<span class="nc" id="L305">		return tooltip + refScheduleTooltip;</span>
	}

	public static String[] getTimeOffChoiceLenAndAlerts(TOChoice choice, Localizer localizer, TimeZone tz, ResourceBundle rmBundle,
			boolean isApproved, boolean enforceCustomTimeOffHoursFormat) {

<span class="nc" id="L311">		return getTimeOffChoiceLenAndAlertsWithPrintAccountedHours( choice,  localizer,  tz,  rmBundle, isApproved, enforceCustomTimeOffHoursFormat, true);</span>
	}
	/**
	 * Returns a list with 3 elements: Time Of Choice Length, hours accounted, and Alerts
	 */
	public static String[] getTimeOffChoiceLenAndAlertsWithPrintAccountedHours(TOChoice choice, Localizer localizer, TimeZone tz, ResourceBundle rmBundle,
			boolean isApproved, boolean enforceCustomTimeOffHoursFormat, boolean printAccountedHours) {
<span class="nc" id="L318">		String[] result = new String[3];</span>
<span class="nc" id="L319">		int counter = 0;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">		if (choice == null) {</span>
<span class="nc" id="L321">			result[counter] = null;</span>
<span class="nc" id="L322">			counter++;</span>
<span class="nc" id="L323">			result[counter] = null;</span>
<span class="nc" id="L324">			counter++;</span>
<span class="nc" id="L325">			result[counter] = null;</span>
		} else {
			// length
<span class="nc" id="L328">			String len = getTOChoiceLen(choice, localizer, rmBundle);</span>
			// Waitlist ICON
<span class="nc bnc" id="L330" title="All 2 branches missed.">			if (choice.isWaitlist()) {</span>
<span class="nc" id="L331">				String imgSrc = ImageFileID.STATUS_WAITLIST;</span>
<span class="nc" id="L332">				String imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.STATUS_WAITLIST);</span>
<span class="nc" id="L333">				String waitlistIconHtmlStr = HtmlUtil.imageTag(imgSrc, imgAlt, true, true);</span>
<span class="nc" id="L334">				len = waitlistIconHtmlStr + &quot;&amp;nbsp;&quot; + len;</span>
			}
<span class="nc" id="L336">			result[counter] = len;</span>
<span class="nc" id="L337">			counter++;</span>

			// hours accounted

			// If there is an invalid choice in the setup dialog, we do not want to print anything since there
			// may be a valid choice which here is printed as 0.00--misleading. Compromise by not outputting anything.
<span class="nc bnc" id="L343" title="All 2 branches missed.">			if ( printAccountedHours ) {</span>
<span class="nc" id="L344">				String accountedHoursHtml = TimeOffRequestUtil.getHoursAccountedForTOChoiceHtml(choice, localizer, isApproved,</span>
						enforceCustomTimeOffHoursFormat);
<span class="nc" id="L346">				result[counter] = accountedHoursHtml;</span>
			}

<span class="nc" id="L349">			counter++;</span>
<span class="nc" id="L350">			Collection&lt;ValidationResult&gt; valResults = choice.getValidationResults(true);</span>
<span class="nc" id="L351">			String alertInfo = RequestUtil.createAlertIconsWithMsg(valResults, localizer, tz);</span>
<span class="nc" id="L352">			result[counter] = alertInfo;</span>
		}
<span class="nc" id="L354">		return result;</span>
	}

	/**
	 * Return the resource bundle Key to localize Debit Type
	 */
	public static String getDebitTypeRBKey(String debitType) {
<span class="nc" id="L361">		String result = debitType;</span>

<span class="nc bnc" id="L363" title="All 2 branches missed.">		if (TORequest.DEBITTYPE_DEBIT.equals(debitType)) {</span>
<span class="nc" id="L364">			result = RmWebBundleKey.TIMEOFF_DEBITTYPE_DEBIT;</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">		} else if (TORequest.DEBITTYPE_DEBIT_ONLY_IF.equals(debitType)) {</span>
<span class="nc" id="L366">			result = RmWebBundleKey.TIMEOFF_DEBITTYPE_DEBIT_ONLY_IF;</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">		} else if (TORequest.DEBITTYPE_DONT_DEBIT.equals(debitType)) {</span>
<span class="nc" id="L368">			result = RmWebBundleKey.TIMEOFF_DEBITTYPE_DONT_DEBIT;</span>
		}

<span class="nc" id="L371">		return result;</span>
	}

	/**
	 * Add Time Off Choice Header
	 *
	 * @param coreBundle - The Core Resource Bundle
	 * @param rmBundle - The Request Management Resource Bundle
	 * @param headerPC - The Header to add data to
	 * @param isMy - pass true for the &quot;My Requests&quot; page, false for the &quot;Employee Requests&quot; page
	 */
	public static void addTOChoiceHeader(ResourceBundle coreBundle, ResourceBundle rmBundle, Localizer localizer, TableHeaderPC headerPC,
			boolean isMy) {
<span class="nc bnc" id="L384" title="All 2 branches missed.">		if (isMy) {</span>
<span class="nc" id="L385">			addHeaderData(headerPC, coreBundle, localizer, UIFWebBundleKey.START_DATE, true);</span>
<span class="nc" id="L386">			addHeaderData(headerPC, coreBundle, localizer, UIFWebBundleKey.END_DATE, true);</span>
		}

<span class="nc" id="L389">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(coreBundle, UIFWebBundleKey.LENGTH), false);</span>
<span class="nc" id="L390">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_LABEL), false);</span>
<span class="nc" id="L391">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_CHOICES_ALERTS), false);</span>
<span class="nc" id="L392">	}</span>

	/**
	 * Add Flex Time Request-specific Column Headers to the list page
	 *
	 * @param coreBundle - The Core Resource Bundle
	 * @param rmBundle - The Request Management Resource Bundle
	 * @param headerPC - The Header to add data to
	 * @param isMy - pass true for the &quot;My Requests&quot; page, false for the &quot;Employee Requests&quot; page
	 */
	public static void addFTChoiceHeader(ResourceBundle rmBundle, Localizer localizer, TableHeaderPC headerPC, boolean isMy) {
<span class="nc bnc" id="L403" title="All 2 branches missed.">		if (isMy) {</span>
<span class="nc" id="L404">			addHeaderData(headerPC, rmBundle, localizer, RmWebBundleKey.TIMEOFF_START_DATE_LABEL, true);</span>
<span class="nc" id="L405">			addHeaderData(headerPC, rmBundle, localizer, RmWebBundleKey.TIMEOFF_END_DATE_LABEL, true);</span>
		}

<span class="nc" id="L408">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_LENGTH_LABEL), false);</span>
<span class="nc" id="L409">		headerPC.addColumnHeaderData(&quot;&quot;, localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_LABEL), false);</span>

<span class="nc bnc" id="L411" title="All 2 branches missed.">		if (isMy) {</span>
<span class="nc" id="L412">			addHeaderData(headerPC, rmBundle, localizer, RmWebBundleKey.MAKEUP_START_DATE_LABEL, true);</span>
<span class="nc" id="L413">			addHeaderData(headerPC, rmBundle, localizer, RmWebBundleKey.MAKEUP_END_DATE_LABEL, true);</span>
		}
<span class="nc" id="L415">	}</span>

	/**
	 * Convinience Method to add Header Data
	 */
	protected static void addHeaderData(TableHeaderPC header, ResourceBundle bundle, Localizer localizer, String rbKey, boolean isSortable) {
<span class="nc" id="L421">		GenericHeaderData hdrData = header.addColumnHeaderData(rbKey, localizer.i18n(bundle, rbKey), isSortable);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">		if (hdrData.getSortable()) {</span>
<span class="nc" id="L423">			String displayName = hdrData.getDisplayName();</span>
<span class="nc" id="L424">			hdrData.setDisplayName(displayName);</span>
		}
<span class="nc" id="L426">	}</span>

	/**
	 * Add TimeOff Choice Info to Multi Column Node Data
	 */
	public static void addTOChoiceInfo(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			ResourceBundle rmBundle, boolean isForTimeOff) {
<span class="nc" id="L433">		addTOChoiceInfo(request, context, rowData, rmBundle, false, true, false,isForTimeOff);</span>
<span class="nc" id="L434">	}</span>
	/**
	 * Add Flex Time Off Choice Info to Multi Column Node Data
	 */
	public static void addTOChoiceInfo(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			ResourceBundle rmBundle) {
<span class="nc" id="L440">		addTOChoiceInfo(request, context, rowData, rmBundle,false);</span>
<span class="nc" id="L441">	}</span>

	/**
	 * Add time off / flex time choice column data to a single request row.
	 * @param request
	 * @param context
	 * @param rowData
	 * @param rmBundle
	 * @param incStartEnd - should we include start date/end date column data?
	 * @param incAlerts - should we include the Choice Alerts column data?
	 * @param enforceCustomTimeOffHoursFormat
	 * @param isForTimeOff- true : for TimeOff, false: Flex time
	 */
	public static void addTOChoiceInfo(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			ResourceBundle rmBundle, boolean incStartEnd, boolean incAlerts, boolean enforceCustomTimeOffHoursFormat, boolean isForTimeOff) {
<span class="nc bnc" id="L456" title="All 2 branches missed.">		boolean align = request.getRequestChoiceList().size() &gt; 1 ? true : false;</span>
<span class="nc" id="L457">		Set&lt;ID&gt; approvedChoiceIds = request.getApprovedChoiceIDs();</span>
<span class="nc" id="L458">		boolean approvedStatus = request.isApproved();</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">		if (incStartEnd) {</span>
<span class="nc" id="L460">			addStartOrEndDateData(request, context, rowData, true,isForTimeOff);</span>
<span class="nc" id="L461">			addStartOrEndDateData(request, context, rowData, false,isForTimeOff);</span>
		}
<span class="nc" id="L463">		StringBuilder timePeriodLenSB = new StringBuilder(STRING_CAPACITY);</span>
<span class="nc" id="L464">		StringBuilder hoursAccountedSB = new StringBuilder(STRING_CAPACITY);</span>
<span class="nc" id="L465">		StringBuilder timePeriodAlertsSB = new StringBuilder(STRING_CAPACITY);</span>

<span class="nc" id="L467">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L468">		int numberOfChoice= request.getRequestChoiceList().size();</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">		for (Iterator&lt;TOChoice&gt; it = request.getRequestChoiceList().iterator(); it.hasNext();) {</span>
<span class="nc" id="L470">			TOChoice toChoice = it.next();</span>
			//No need to make the approved choices be bold for Anytime VTO Request
			// since only one single choice per submission but can have multi-choice approved and only show approved choices.
<span class="nc bnc" id="L473" title="All 8 branches missed.">			boolean isBoldText =  request.isAdvancedVTORequest()? false:</span>
						numberOfChoice &gt; 1 &amp;&amp; isForTimeOff &amp;&amp; approvedStatus
<span class="nc bnc" id="L475" title="All 2 branches missed.">						&amp;&amp; makeApprovedChoiceBeBold(approvedChoiceIds, toChoice.getID());</span>
<span class="nc" id="L476">			appendTimePeriodLen(toChoice, localizer, timePeriodLenSB, rmBundle, align, isBoldText);</span>
<span class="nc" id="L477">			appendHoursAccounted(toChoice, localizer, hoursAccountedSB, approvedStatus, enforceCustomTimeOffHoursFormat, align,</span>
					isBoldText);
<span class="nc bnc" id="L479" title="All 2 branches missed.">			if (incAlerts) {</span>
<span class="nc" id="L480">				appendTimeAlertsPeriod(toChoice, localizer, timePeriodAlertsSB, align);</span>
			}
<span class="nc" id="L482">		}</span>

<span class="nc" id="L484">		rowData.add(timePeriodLenSB);</span>
<span class="nc" id="L485">		rowData.add(hoursAccountedSB);</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">		if (incAlerts) {</span>
<span class="nc" id="L487">			rowData.add(timePeriodAlertsSB);</span>
		}
<span class="nc" id="L489">	}</span>
	/**
	 * Add flex time choice column data to a single request row.
	 * @param request
	 * @param context
	 * @param rowData
	 * @param rmBundle
	 * @param incStartEnd - should we include start date/end date column data?
	 * @param incAlerts - should we include the Choice Alerts column data?
	 * @param enforceCustomTimeOffHoursFormat
	 */
	public static void addTOChoiceInfo(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			ResourceBundle rmBundle, boolean incStartEnd, boolean incAlerts, boolean enforceCustomTimeOffHoursFormat){
<span class="nc" id="L502">		addTOChoiceInfo(request,context,rowData,rmBundle,incStartEnd,incAlerts,enforceCustomTimeOffHoursFormat,false);</span>
<span class="nc" id="L503">	}</span>
	/**
	 * With new group action &quot;Approve Time Off Choice without violation&quot; for Advanced RM License,
	 * Any choice of a TO request can be approved.It is not a first choice as before.
	 * Therefore, we need to make the approved Choice as bold as indicator for manager to know
	 * */
	private static boolean makeApprovedChoiceBeBold(Set&lt;ID&gt; approvedChoiceIds, ID choiceID) {
<span class="nc" id="L510">		boolean result = LicenseUtil.isAdvancedRMLicense();</span>
<span class="nc bnc" id="L511" title="All 6 branches missed.">		result = result &amp;&amp; approvedChoiceIds != null &amp;&amp; approvedChoiceIds.contains(choiceID) ? true : false;</span>
<span class="nc" id="L512">		return result;</span>
	}

	/**
	 * Add Flex Request Makeup column data to a single request row.
	 * @param request
	 * @param context
	 * @param rowData
	 * @param rmBundle
	 */
	public static void addMakeupInfo(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData) {
<span class="nc" id="L523">		addMakeupStartOrEndDateData(request, context, rowData, true);</span>
<span class="nc" id="L524">		addMakeupStartOrEndDateData(request, context, rowData, false);</span>
<span class="nc" id="L525">	}</span>

	/**
	 * Append Makeup Start Dates or Makeup End Dates of all Flex Time Makeups for one request to row_data
	 */
	public static void addMakeupStartOrEndDateData(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			boolean isStart) {
<span class="nc" id="L532">		StringBuilder timePeriodSB = new StringBuilder(STRING_CAPACITY);</span>
<span class="nc" id="L533">		Calendar cal = Calendar.getInstance(context.getViewingTimeZone());</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">		boolean align = request.getFlexRequestMakeupList().size() &gt; 1 ? true : false;</span>

<span class="nc bnc" id="L536" title="All 2 branches missed.">		for (FlexRequestMakeup makeup : request.getFlexRequestMakeupList()) {</span>

<span class="nc" id="L538">			appendTimePeriodDateForMakeup(context, isStart, timePeriodSB, cal, align, makeup);</span>
<span class="nc" id="L539">		}</span>
<span class="nc" id="L540">		rowData.add(timePeriodSB);</span>
<span class="nc" id="L541">	}</span>

	private static void appendTimePeriodDateForMakeup(RequestContext context, boolean isStart, StringBuilder timePeriodSB, Calendar cal,
			boolean align, FlexRequestMakeup makeup) {
<span class="nc" id="L545">		Date startTime = null;</span>
<span class="nc" id="L546">		Date endTime = null;</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">		if (makeup.getExtBeforeActivityID() != null) {</span>
<span class="nc" id="L548">			cal.setTime(makeup.getShiftStartTime());</span>
<span class="nc" id="L549">			cal.add(Calendar.MINUTE, -(makeup.getExtBeforeGap() + makeup.getExtBeforeDuration()));</span>
<span class="nc" id="L550">			startTime = cal.getTime();</span>
<span class="nc" id="L551">			cal.add(Calendar.MINUTE, makeup.getExtBeforeDuration());</span>
<span class="nc" id="L552">			endTime = cal.getTime();</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">			appendTimePeriodDate(isStart ? startTime : endTime, context, timePeriodSB, align);</span>
		}
<span class="nc bnc" id="L555" title="All 2 branches missed.">		if (makeup.getFlexReqMakeupGaps() != null) {</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">			for (FlexReqMakeupGap gap : makeup.getFlexReqMakeupGaps()) {</span>
<span class="nc" id="L557">				cal.setTime(gap.getExtGapStartTime());</span>
<span class="nc" id="L558">				cal.add(Calendar.MINUTE, (gap.getExtGapGap()));</span>
<span class="nc" id="L559">				startTime = cal.getTime();</span>
<span class="nc" id="L560">				cal.add(Calendar.MINUTE, (gap.getExtGapDuration()));</span>
<span class="nc" id="L561">				endTime = cal.getTime();</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">				appendTimePeriodDate(isStart ? startTime : endTime, context, timePeriodSB, align);</span>
<span class="nc" id="L563">			}</span>
		}
<span class="nc bnc" id="L565" title="All 2 branches missed.">		if (makeup.getExtAfterActivityID() != null) {</span>
<span class="nc" id="L566">			cal.setTime(makeup.getShiftEndTime());</span>
<span class="nc" id="L567">			cal.add(Calendar.MINUTE, (makeup.getExtAfterGap()));</span>
<span class="nc" id="L568">			startTime = cal.getTime();</span>
<span class="nc" id="L569">			cal.add(Calendar.MINUTE, (makeup.getExtAfterDuration()));</span>
<span class="nc" id="L570">			endTime = cal.getTime();</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">			appendTimePeriodDate(isStart ? startTime : endTime, context, timePeriodSB, align);</span>
		}
<span class="nc" id="L573">	}</span>

	/**
	 * Append Makeup Activity of all Flex Time Makeups for one request to row_data
	 */
	public static void addMakeupActivityData(TORequest request,DefaultMultiColumnNodeData row_data,
			Map&lt;ID, String&gt; activityId2Name) {
<span class="nc" id="L580">		StringBuilder buf = new StringBuilder(STRING_CAPACITY);</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">		boolean align = request.getFlexRequestMakeupList().size() &gt; 1 ? true : false;</span>

<span class="nc bnc" id="L583" title="All 2 branches missed.">		for (FlexRequestMakeup makeup : request.getFlexRequestMakeupList()) {</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">			if (makeup.getExtBeforeActivityID() != null) {</span>
<span class="nc" id="L585">				append(buf, activityId2Name.get(makeup.getExtBeforeActivityID()), align);</span>
			}
<span class="nc bnc" id="L587" title="All 2 branches missed.">			if (makeup.getFlexReqMakeupGaps() != null) {</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">				for (FlexReqMakeupGap gap : makeup.getFlexReqMakeupGaps()) {</span>
<span class="nc" id="L589">					append(buf, activityId2Name.get(gap.getExtGapActivityID()), align);</span>
<span class="nc" id="L590">				}</span>
			}
<span class="nc bnc" id="L592" title="All 2 branches missed.">			if (makeup.getExtAfterActivityID() != null) {</span>
<span class="nc" id="L593">				append(buf, activityId2Name.get(makeup.getExtAfterActivityID()), align);</span>
			}
<span class="nc" id="L595">		}</span>
<span class="nc" id="L596">		row_data.add(buf);</span>
<span class="nc" id="L597">	}</span>

	/**
	 * Append Start Dates or End Dates of all Time Off Choices for one request to rowData
	 */
	public static void addStartOrEndDateData(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			boolean isStart, boolean isForTimeOff) {
<span class="nc" id="L604">		StringBuilder timePeriodSB = new StringBuilder(STRING_CAPACITY);</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">		boolean align = request.getRequestChoiceList().size() &gt; 1 ? true : false;</span>
<span class="nc" id="L606">		Set&lt;ID&gt; approvedChoiceIds = request.getApprovedChoiceIDs();</span>
<span class="nc" id="L607">		boolean approvedStatus = request.isApproved();</span>
<span class="nc" id="L608">		int numberOfChoice= request.getRequestChoiceList().size();</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">		for (Iterator&lt;TOChoice&gt; it = request.getRequestChoiceList().iterator(); it.hasNext();) {</span>
<span class="nc" id="L610">			TOChoice toChoice = it.next();</span>
			//No need to make the approved choices be bold for Anytime VTO Request
			// since only one single choice per submission but can have multi-choice approved and only show approved choices.
<span class="nc bnc" id="L613" title="All 8 branches missed.">			boolean isBoldText = request.isAdvancedVTORequest()? false:</span>
					numberOfChoice &gt; 1 &amp;&amp; isForTimeOff &amp;&amp; approvedStatus
<span class="nc bnc" id="L615" title="All 2 branches missed.">					&amp;&amp; makeApprovedChoiceBeBold(approvedChoiceIds, toChoice.getID());</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">			if (isStart) {</span>
<span class="nc" id="L617">				appendTimePeriodDate(toChoice.getStartDate(), context, timePeriodSB, align, isBoldText);</span>
			} else {
<span class="nc" id="L619">				appendTimePeriodDate(toChoice.getEndDate(), context, timePeriodSB, align, isBoldText);</span>
			}
<span class="nc" id="L621">		}</span>

<span class="nc" id="L623">		rowData.add(timePeriodSB);</span>
<span class="nc" id="L624">	}</span>
	/**
	 * Append Start Dates or End Dates of Flex Time Choice for one request to rowData
	 */
	public static void addStartOrEndDateData(TORequest request, RequestContext context, DefaultMultiColumnNodeData rowData,
			boolean isStart) {
<span class="nc" id="L630">		addStartOrEndDateData(request,context,rowData,isStart,false);</span>
<span class="nc" id="L631">	}</span>

	/**
	 * Append Time Off Period of the specified Time Off Choice to StringBuffer
	 */
	private static void appendTimePeriodDate(Date date, RequestContext context, StringBuilder sb, boolean align) {
<span class="nc" id="L637">		appendTimePeriodDate(date, context, sb, align, false);</span>
<span class="nc" id="L638">	}</span>

	private static void appendTimePeriodDate(Date date, RequestContext context, StringBuilder sb, boolean align, boolean isBold) {
<span class="nc" id="L641">		String dateDisplay = RequestUtil.getDateDisplay(context, date);</span>
<span class="nc" id="L642">		append(sb, dateDisplay, align, isBold);</span>
<span class="nc" id="L643">	}</span>

	/**
	 * Append Time Off Period Length of the specified Time Off Choice to StringBuffer
	 */

	private static void appendTimePeriodLen(TOChoice choice, Localizer localizer, StringBuilder sb, ResourceBundle rmBundle, boolean align,
			boolean isBold) {
<span class="nc" id="L651">		append(sb, getTOChoiceLen(choice, localizer, rmBundle), align, isBold);</span>
<span class="nc" id="L652">	}</span>

	/**
	 * Append hours accounted of the specified Time Off Choice to StringBuffer
	 */

	private static void appendHoursAccounted(TOChoice choice, Localizer localizer, StringBuilder sb, boolean isApproved,
			boolean enforceCustomTimeOffHoursFormat, boolean align, boolean isBold) {
<span class="nc" id="L660">		append(sb, getHoursAccountedForTOChoice(choice, localizer, isApproved, enforceCustomTimeOffHoursFormat), align, isBold);</span>
<span class="nc" id="L661">	}</span>

	/**
	 * Return Formatted Time Off Choice Length
	 */
	public static String getTOChoiceLen(TOChoice choice, Localizer localizer, ResourceBundle rmBundle) {
<span class="nc bnc" id="L667" title="All 4 branches missed.">		if (choice.getStartDate() == null &amp;&amp; choice.getEndDate() == null) {</span>
<span class="nc" id="L668">			return &quot;&quot;;</span>
		}
<span class="nc" id="L670">		long minuteLen = (choice.getEndDate().getTime() - choice.getStartDate().getTime()) / (1000 * 60);</span>
<span class="nc" id="L671">		return getLengthStrFromMinutes(minuteLen, localizer, rmBundle);</span>
	}

	public static String getLengthStrFromMinutes(long minuteLen, Localizer localizer, ResourceBundle rmBundle) {
		// get string days, hours, minutes

<span class="nc" id="L677">		StringBuilder lengthBuf = new StringBuilder(256);</span>
<span class="nc" id="L678">		long days = minuteLen / (24 * 60);</span>

<span class="nc bnc" id="L680" title="All 2 branches missed.">		if (days != 0) {</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">			if (days &gt;= 7) {</span>
<span class="nc" id="L682">				lengthBuf.append(days / 7 + &quot; &quot; + localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_WEEKS) + &quot; &quot;);</span>
			}
<span class="nc bnc" id="L684" title="All 2 branches missed.">			if (days % 7 &gt;= 1) {</span>
<span class="nc" id="L685">				lengthBuf.append(Math.abs(days % 7) + &quot; &quot; + localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_DAYS) + &quot; &quot;);</span>
			}
		}
<span class="nc bnc" id="L688" title="All 2 branches missed.">		if (minuteLen % (24 * 60) != 0) {</span>
			// get hours
<span class="nc" id="L690">			long hours = Math.abs((minuteLen - days * 24 * 60) / 60);</span>
<span class="nc" id="L691">			lengthBuf.append(hours + &quot; &quot; + localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_HOURS) + &quot; &quot;);</span>
<span class="nc" id="L692">			long minutes = minuteLen - (hours * 60 + days * 24 * 60);</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">			if (minutes &gt; 0) {</span>
<span class="nc" id="L694">				lengthBuf.append(minutes + &quot; &quot; + localizer.i18n(rmBundle, RmWebBundleKey.TIMEOFF_MINUTES));</span>
			}
		}

<span class="nc" id="L698">		return lengthBuf.toString();</span>
	}

	/**
	 * Return Formatted hours accounted for Time Off Choice Length
	 */

	public static String getHoursAccountedForTOChoice(TOChoice choice, Localizer localizer, boolean isApproved,
			boolean enforceCustomTimeOffHoursFormat) {
<span class="nc bnc" id="L707" title="All 4 branches missed.">		if (enforceCustomTimeOffHoursFormat || enabledCustomTimeOffHoursFormat()) {</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">			return getMinutesDisplay(localizer, (long) (choice.getLength() * 60))</span>
<span class="nc" id="L709">					+ (isApproved ? &quot; ( &quot; + getMinutesDisplay(localizer, choice.getHoursPerDay().getOriginalMinutes()) + &quot; )&quot; : &quot;&quot;);</span>
		} else {
<span class="nc bnc" id="L711" title="All 2 branches missed.">			return localizer.formatNumber(choice.getLength(), 2)</span>
<span class="nc" id="L712">					+ (isApproved ? &quot; ( &quot; + localizer.formatNumber(choice.getHoursPerDay().getOriginalMinutes() / 60f, 2) + &quot; )&quot; : &quot;&quot;);</span>
		}
	}

	/**
	 * Display as HH:MM from the minutes while padding hours and minutes to two chars. Number of minutes should be divisible
	 * by 15. This doesn't handle negative durations yet. If you only need a simple duration with no padding use
	 * localizer.formatDurationInMins(mins). Ex: 90 minutes will show: 1:30
	 */
	public static String getMinutesDisplay(Localizer localizer, long minutes) {
<span class="nc bnc" id="L722" title="All 2 branches missed.">		if (minutes &lt; 0) {</span>
<span class="nc" id="L723">			throw new IllegalArgumentException(String.format(&quot;Negative minutes ('%d') is not supported.&quot;, minutes));</span>
		}
<span class="nc" id="L725">		String durationSeparator = localizer.i18n(RegionalFormatBundleKey.BUNDLE_NAME, RegionalFormatBundleKey.DURATION_SEPARATOR);</span>
<span class="nc" id="L726">		int hours = Double.valueOf(Math.floor((double) minutes / 60)).intValue();</span>
<span class="nc" id="L727">		long remainingMins = minutes - (hours * 60);</span>

<span class="nc" id="L729">		return String.format(&quot;%02d%s%02d&quot;, hours, durationSeparator, remainingMins);</span>
	}

	private static String formatDurationInMinutes(Localizer localizer, long minutes, boolean enforceCustomTimeOffHoursFormat) {
<span class="nc bnc" id="L733" title="All 4 branches missed.">		if (enforceCustomTimeOffHoursFormat || enabledCustomTimeOffHoursFormat()) {</span>
<span class="nc" id="L734">			return getMinutesDisplay(localizer, minutes);</span>
		}
<span class="nc" id="L736">		return localizer.formatNumber(minutes / 60f, 2);</span>
	}

	/**
	 * Append Time Off Period Alerts of the specified Time Off Choice to StringBuffer
	 */
	private static void appendTimeAlertsPeriod(TOChoice choice, Localizer localizer, StringBuilder sb, boolean align) {
<span class="nc" id="L743">		Collection&lt;ValidationResult&gt; valResults = choice.getValidationResults(true);</span>
<span class="nc" id="L744">		String alertIcons = RequestUtil.createAlertIcons(valResults, localizer, true, true);</span>
<span class="nc" id="L745">		append(sb, alertIcons, align);</span>
<span class="nc" id="L746">	}</span>

	/**
	 * Append Content to String Buffer
	 */
	private static void append(StringBuilder sb, String content, boolean align) {
<span class="nc" id="L752">		append(sb, content, align, false);</span>
<span class="nc" id="L753">	}</span>

	/**
	 * Append Content to String Buffer
	 */
	private static void append(StringBuilder sb, String content, boolean align, boolean isBold) {
<span class="nc bnc" id="L759" title="All 2 branches missed.">		if (sb.length() != 0) {</span>
<span class="nc" id="L760">			sb.append(&quot;&lt;br&gt;&quot;);</span>
		}
<span class="nc bnc" id="L762" title="All 2 branches missed.">		if (isBold) {</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">			if (align) {</span>
<span class="nc" id="L764">				sb.append(&quot;&lt;span style=\&quot;display:inline-block;font-weight: bold;height:20px;\&quot;&gt;&lt;nobr&gt;&quot;).append(content)</span>
<span class="nc" id="L765">						.append(&quot;&lt;/nobr&gt;&lt;/span&gt;&quot;);</span>
			} else {
<span class="nc" id="L767">				sb.append(&quot;&lt;span style=\&quot;font-weight: bold;\&quot;&gt;&lt;nobr&gt;&quot;).append(content).append(&quot;&lt;/nobr&gt;&lt;/span&gt;&quot;);</span>
			}
		} else {
<span class="nc bnc" id="L770" title="All 2 branches missed.">			if (align) {</span>
<span class="nc" id="L771">				sb.append(&quot;&lt;span style=\&quot;display:inline-block;height:20px;\&quot;&gt;&lt;nobr&gt;&quot;).append(content).append(&quot;&lt;/nobr&gt;&lt;/span&gt;&quot;);</span>
			} else {
<span class="nc" id="L773">				sb.append(&quot;&lt;nobr&gt;&quot;).append(content).append(&quot;&lt;/nobr&gt;&quot;);</span>
			}
		}
<span class="nc" id="L776">	}</span>

	public static boolean enabledCustomTimeOffHoursFormat() {

<span class="nc" id="L780">		boolean result = false;</span>
		try {
<span class="nc" id="L782">			String dbVal = BbmManagerFactory.getDBConfigManager().getValue(ConfigKey.RM_CUSTOM_TIMEOFF_HOURS_FORMAT);</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">			if (!StringUtil.isEmpty(dbVal)) {</span>
<span class="nc" id="L784">				result = Boolean.parseBoolean(dbVal);</span>
			}
<span class="nc" id="L786">		} catch (Exception ex) {</span>
			// ignoring any exception caught.
<span class="nc" id="L788">		}</span>

<span class="nc" id="L790">		return result;</span>
	}

	public static Date roundToNearestInterval(TimeZone tz, Date date, int timeInterval) {
<span class="nc" id="L794">		Date result = null;</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">		if (date == null) {</span>
<span class="nc" id="L796">			return null;</span>
		}
<span class="nc bnc" id="L798" title="All 2 branches missed.">		if (timeInterval == 1) {</span>
<span class="nc" id="L799">			result = date;</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">		} else if (timeInterval &lt;= 60) {</span>
<span class="nc" id="L801">			Calendar aCal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L802">			aCal.setTime(date);</span>
<span class="nc" id="L803">			int min = aCal.get(Calendar.MINUTE);</span>
<span class="nc" id="L804">			int remainder = min % timeInterval;</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">			if (remainder == 0) {</span>
<span class="nc" id="L806">				result = date;</span>
			} else {
<span class="nc bnc" id="L808" title="All 2 branches missed.">				int diff = (remainder &gt; (timeInterval / 2)) ? (timeInterval - remainder) : (0 - remainder);</span>
<span class="nc" id="L809">				min += diff;</span>
<span class="nc" id="L810">				aCal.set(Calendar.MINUTE, min);</span>
<span class="nc" id="L811">				result = aCal.getTime();</span>
			}
<span class="nc" id="L813">		}</span>
		//for day, time Interval =1440
		else {
<span class="nc" id="L816">			Calendar cal = Calendar.getInstance(tz);</span>
<span class="nc" id="L817">			cal.setTimeInMillis(date.getTime());</span>
<span class="nc" id="L818">			int hourOfDay = cal.get(Calendar.HOUR_OF_DAY);</span>
<span class="nc" id="L819">			int min = cal.get(Calendar.MINUTE);</span>
			//Get next day if this is PM time
<span class="nc bnc" id="L821" title="All 6 branches missed.">			if (hourOfDay &gt; 12 || (hourOfDay == 12 &amp;&amp; min &gt; 0)) {</span>
<span class="nc" id="L822">				LocalDate lDate = new LocalDate(date, tz);</span>
<span class="nc" id="L823">				result = DateTimeUtil.getNextLocalDateStart(lDate).getTime(tz);</span>
<span class="nc" id="L824">			} else {</span>
<span class="nc" id="L825">				result = DateTimeUtil.getDayStart(date, tz);</span>
			}
		}
		//Since the UI does not have seconds/milliseconds so need to clear out the seconds/milliseconds to avoid weird issue in rest API
<span class="nc" id="L829">		Calendar cal = Calendar.getInstance(tz);</span>
<span class="nc" id="L830">		cal.setTime(result);</span>
<span class="nc" id="L831">		cal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L832">		cal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L833">		result= cal.getTime();</span>

<span class="nc" id="L835">		return result;</span>
	}
	public static int getSettingTimeOffRoundInterval(RequestContext context, ID empID) throws RemoteException, BbmException{
<span class="nc" id="L838">		int timeInterval = TIME_INTERVAL;</span>
<span class="nc" id="L839">		OrganizationSetting orgSetting = TimeOffRequestsMH.getOrgSettingForEmployee(context, empID);</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">		if (orgSetting != null) {</span>
<span class="nc" id="L841">			timeInterval = orgSetting.getTimeOffRoundingOption();</span>
		}
<span class="nc" id="L843">		return timeInterval;</span>
	}
	public static String getRoundedMsg(Localizer localizer, int timeInterval) {
		String msg;
<span class="nc bnc" id="L847" title="All 2 branches missed.">		if (timeInterval &gt; 60) {</span>
<span class="nc" id="L848">			msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_CHOICES_ROUNDING_DAY_MSG);</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">		} else if (timeInterval == 60) {</span>
<span class="nc" id="L850">			msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_CHOICES_ROUNDING_HOUR_MSG);</span>
		} else {
<span class="nc" id="L852">			msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_CHOICES_ROUNDING_MSG, new Object[] { timeInterval });</span>
		}

<span class="nc" id="L855">		return msg;</span>
	}

<span class="nc" id="L858">	public static class TimeOffChoiceListPCConfig {</span>
<span class="nc" id="L859">		private boolean isShowSelectedInfo = false;</span>
<span class="nc" id="L860">		private boolean isSelectable = false;</span>
<span class="nc" id="L861">		private boolean isShowAlert = false;</span>
<span class="nc" id="L862">		private boolean isEnforceCustomTimeOffHoursFormat = false;</span>
<span class="nc" id="L863">		private boolean isRowNumberEnabled = true;</span>
<span class="nc" id="L864">		private String timeOffChoiceLabelBundleKey = RmWebBundleKey.TIMEOFF_CHOICES;</span>

		public boolean getIsShowSelectedInfo() {
<span class="nc" id="L867">			return this.isShowSelectedInfo;</span>
		}

		public TimeOffChoiceListPCConfig setIsShowSelectedInfo(boolean isShowSelectedInfo) {
<span class="nc" id="L871">			this.isShowSelectedInfo = isShowSelectedInfo;</span>
<span class="nc" id="L872">			return this;</span>
		}

		public boolean getIsSelectable() {
<span class="nc" id="L876">			return this.isSelectable;</span>
		}

		public TimeOffChoiceListPCConfig setIsSelectable(boolean isSelectable) {
<span class="nc" id="L880">			this.isSelectable = isSelectable;</span>
<span class="nc" id="L881">			return this;</span>
		}

		public boolean getIsShowAlert() {
<span class="nc" id="L885">			return this.isShowAlert;</span>
		}

		public TimeOffChoiceListPCConfig setIsShowAlert(boolean isShowAlert) {
<span class="nc" id="L889">			this.isShowAlert = isShowAlert;</span>
<span class="nc" id="L890">			return this;</span>
		}

		public boolean getIsEnforceCustomTimeOffHoursFormat() {
<span class="nc" id="L894">			return this.isEnforceCustomTimeOffHoursFormat;</span>
		}

		public TimeOffChoiceListPCConfig setIsEnforceCustomTimeOffHoursFormat(boolean isEnforceCustomTimeOffHoursFormat) {
<span class="nc" id="L898">			this.isEnforceCustomTimeOffHoursFormat = isEnforceCustomTimeOffHoursFormat;</span>
<span class="nc" id="L899">			return this;</span>
		}

		public boolean getIsRowNumberEnabled() {
<span class="nc" id="L903">			return this.isRowNumberEnabled;</span>
		}

		public TimeOffChoiceListPCConfig setIsRowNumberEnabled(boolean isRowNumberEnabled) {
<span class="nc" id="L907">			this.isRowNumberEnabled = isRowNumberEnabled;</span>
<span class="nc" id="L908">			return this;</span>
		}

		public String getTimeOffChoiceLabelBundleKey() {
<span class="nc" id="L912">			return this.timeOffChoiceLabelBundleKey;</span>
		}

		public TimeOffChoiceListPCConfig setTimeOffChoiceLabelBundleKey(String timeOffChoiceLabelBundleKey) {
<span class="nc" id="L916">			this.timeOffChoiceLabelBundleKey = timeOffChoiceLabelBundleKey;</span>
<span class="nc" id="L917">			return this;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>