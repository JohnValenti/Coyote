<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffCalendarPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.timeoff</a> &gt; <span class="el_source">TimeOffCalendarPC.java</span></div><h1>TimeOffCalendarPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.timeoff;

import java.rmi.RemoteException;
import java.text.DecimalFormat;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.bbm.workresource.OrganizationScopeManagerProxy;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TOPoolUtil;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOCalendarDayData;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOIntervalCalendar;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.DateUtil;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.keys.RmJavaScriptFileID;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.keys.PageKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.calendar.CalendarPC;
import com.witness.web.uif.pagecomponent.calendar.GenericCalendarDayRenderer;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.TimeZoneHelper;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlLinkUtil;

/**
 * Title:        TimeOffCalendarPC
 * Description:  Display Time Off Calendars
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       dsu (David Su)
 * @version 1.0
 *
 * Created on September 03, 2002, 4:00 PM
 */
public class TimeOffCalendarPC extends CollapsibleContainerPC {
	private static final String TIMEOFF_CAL_CACHE_KEY = &quot;TIMEOFF_CAL_CACHE_KEY&quot;;
	private static final String MGR_HOUR_PENDING_VIEW_REQUEST = RmKeys.RH_AG_REQUEST_TIMEOFF_LIST;
	private static final String VIEW_AGENTS_NAMES = &quot;POPUP_AGENTS_NAMES&quot;;
	public static final int DAILY_ALLOCATION = 0;
	public static final int INTERVAL_ALLOCATION = 1;
<span class="nc" id="L64">	public static final String DAILY_ALLOCATION_DROPDOWN_VALUE = Integer.toString(DAILY_ALLOCATION);</span>
<span class="nc" id="L65">	public static final String INTERVAL_ALLOCATION_DROPDOWN_VALUE = Integer.toString(INTERVAL_ALLOCATION);</span>

	private static final int MAX_CELL_FOR_COLUMN = 6;

	private final ResourceBundle m_bundle;
	private String m_sOrgID;
	private int m_numOfCals;
<span class="nc" id="L72">	private int m_dayCounter = 0;</span>
<span class="nc" id="L73">	private int m_firstDayOfWeek = Calendar.SUNDAY;</span>
<span class="nc" id="L74">	private boolean m_isDataForManager = false;</span>
<span class="nc" id="L75">	private boolean m_isLinkToRequestEnabled = false;</span>
<span class="nc" id="L76">	private boolean m_isLinkToSchedTOEnabled = false;</span>
<span class="nc" id="L77">	private boolean m_isDetailEnabled = false;</span>
<span class="nc" id="L78">	private boolean m_isLegendVisible = true;</span>
<span class="nc" id="L79">	private boolean m_isLegenBtnEnabled = false;</span>
<span class="nc" id="L80">	private boolean m_isEncapsulated = true;</span>
<span class="nc" id="L81">	private boolean m_showAvailableHours = false;</span>

	private Calendar m_navCalendar;
<span class="nc" id="L84">	private List m_calDataList = Collections.emptyList();</span>
<span class="nc" id="L85">	private TimeZone m_tz = null;</span>
	private OrganizationSetting m_orgSetting;
	private final DecimalFormat m_decimalFormat;

	private final CalendarPC m_calPC;
	private final TimeOffIntervalCalendarPC intervalCalendarPC;

	private final TimeOffCalendarLegendPC m_legendPC;
	private final ToolbarPC m_toolbar;

<span class="nc" id="L95">	private ID m_poolID = null;</span>
	
<span class="nc" id="L97">	private boolean m_isAgentCal = false; //is the agent viewing his Time Off Calendar? (true=yes, agent. false=no, manager).</span>
<span class="nc" id="L98">	private boolean m_isAgentTOPoolView = false; //is the agent viewing his TO Pool? (true=yes, his pool. false=no, viewing only his personal data)</span>
<span class="nc" id="L99">	private String timeOffAllocationType = &quot;0&quot;;</span>
	private transient TOIntervalCalendar timeOffIntervalCalendar;
<span class="nc" id="L101">	private boolean showTOPoolsToolTip = false;</span>

	
	/**
	 * Constructor
	 *
	 * @param context The RequestContext
	 */
	public TimeOffCalendarPC(RequestContext context, ToolbarPC toolbar) {
<span class="nc" id="L110">		this(context, 1, false, toolbar);</span>
<span class="nc" id="L111">	}</span>

	/**
	 * Constructor
	 *
	 * @param context The RequestContext
	 * @param numOfCals The number of Calendar to display
	 * @param isEncapsulated Specify whether component is encapsulated
	 */
	public TimeOffCalendarPC(RequestContext context, int numOfCals, boolean isEncapsulated, ToolbarPC toolbar) {
<span class="nc" id="L121">		super(context);</span>
<span class="nc" id="L122">		m_toolbar = toolbar;</span>

<span class="nc" id="L124">		m_decimalFormat = (DecimalFormat) DecimalFormat.getInstance(m_locale);</span>
<span class="nc" id="L125">		m_decimalFormat.setMaximumFractionDigits(2);</span>

<span class="nc" id="L127">		m_numOfCals = numOfCals;</span>
<span class="nc" id="L128">		m_tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L129">		m_bundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L131">		setName(&quot;timeOffCalendarPC_null&quot;);</span>
<span class="nc" id="L132">		setJSMediator(RmJavaScriptFileID.TIMEOFF_CAL_CONTAINER);</span>

<span class="nc" id="L134">		m_calPC = new CalendarPC(m_context, &quot;timeOffCal&quot;, CalendarPC.CALENDAR_TYPE_GENERIC);</span>
<span class="nc" id="L135">		m_calPC.setIsSubmitOnNavChange(true);</span>
<span class="nc" id="L136">		m_calPC.setIsIgnoreChangeConfirmation(true);</span>
<span class="nc" id="L137">		m_calPC.getCalendarHeader().setEnabled(false);</span>
		
		//508: We need day links so that tooltips can be assigned
<span class="nc" id="L140">		m_calPC.getCalendarDayRenderer().setEnableDayLink(true);</span>
<span class="nc" id="L141">		m_calPC.setDisplayOnlyRequiredWeeks(false);</span>
<span class="nc" id="L142">		addChildComponent(m_calPC);</span>
<span class="nc" id="L143">		m_legendPC = new TimeOffCalendarLegendPC(m_context, m_toolbar) {</span>
			@Override
			protected String getAriaAttributesForDialog() {
<span class="nc" id="L146">				return &quot;&quot;;</span>
			}
		};
<span class="nc" id="L149">		addChildComponent(m_legendPC);</span>

<span class="nc" id="L151">		intervalCalendarPC = new TimeOffIntervalCalendarPC(m_context);</span>
<span class="nc" id="L152">		addChildComponent(intervalCalendarPC);</span>

<span class="nc" id="L154">		m_navCalendar = newCalendar();</span>
<span class="nc" id="L155">		setIsEncapsulated(isEncapsulated);</span>
<span class="nc" id="L156">	}</span>

	private Calendar newCalendar() {
<span class="nc" id="L159">		Calendar cal = (Calendar) m_context.getAttribute(RequestContext.SESSION_SCOPE, TIMEOFF_CAL_CACHE_KEY);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">		if (cal == null) {</span>
<span class="nc" id="L161">			return newCalendar(m_tz, m_locale);</span>
		} else {
<span class="nc" id="L163">			cal = (Calendar) cal.clone();</span>
		}
<span class="nc" id="L165">		return cal;</span>
	}

	/**
	 * Gets a new Calendar for the first of the month in the specified time zone and locale.
	 */
	public static Calendar newCalendar(TimeZone timeZone, Locale locale) {
<span class="nc" id="L172">		Calendar cal = Calendar.getInstance(timeZone, locale);</span>
<span class="nc" id="L173">		adjustCalToFirstDayOfMonth(cal, cal);</span>
<span class="nc" id="L174">		return cal;</span>
	}

	private Calendar newCalFromNavCal() {
<span class="nc" id="L178">		Calendar cal = Calendar.getInstance(m_tz, m_locale);</span>
<span class="nc" id="L179">		adjustCalToFirstDayOfMonth(m_navCalendar, cal);</span>
<span class="nc" id="L180">		return cal;</span>
	}

	private static void adjustCalToFirstDayOfMonth(Calendar sourceCal, Calendar targetCal) {
<span class="nc" id="L184">		int year = sourceCal.get(Calendar.YEAR);</span>
<span class="nc" id="L185">		int month = sourceCal.get(Calendar.MONTH);</span>
<span class="nc" id="L186">		targetCal.set(year, month, 1, 0, 0, 0);</span>
<span class="nc" id="L187">		targetCal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L188">	}</span>

	/**
	 * Initialize For Display
	 */
	@Override
	public void initForDisplay() {
<span class="nc bnc" id="L195" title="All 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L196">			return;</span>
		} else {
<span class="nc" id="L198">			super.initForDisplay();</span>

			// Popup Scheduled TimeOff Agents Window
<span class="nc" id="L201">			addPopupArgs(VIEW_AGENTS_NAMES, RmKeys.RH_TIMEOFF_AGENTS_INFO, null, &quot;orgID,poolID,date,hourType,parentView,agentCal&quot;, &quot;400,300,ctr,ctr&quot;, true, 1);</span>

<span class="nc" id="L203">			initHeader();</span>
		}
<span class="nc" id="L205">	}</span>

	/**
	 * Specify whether it is encapsulated
	 */
	public void setIsEncapsulated(boolean bSwitch) {
<span class="nc" id="L211">		m_isEncapsulated = bSwitch;</span>

<span class="nc bnc" id="L213" title="All 2 branches missed.">		if (m_isEncapsulated) {</span>
<span class="nc" id="L214">			setStyleClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="nc" id="L215">			setToggleable(true);</span>
<span class="nc" id="L216">			setIsLegendVisible(false);</span>
		} else {
<span class="nc" id="L218">			setStyleClass(null);</span>
<span class="nc" id="L219">			setToggleable(false);</span>
<span class="nc" id="L220">			setIsLegendVisible(true);</span>
		}
<span class="nc" id="L222">	}</span>

	/**
	 * Return true if it is encapsulated
	 */
	public boolean isEncapsulated() {
<span class="nc" id="L228">		return m_isEncapsulated;</span>
	}

	/**
	 * Return true if we are showing Available hours (rather than allocated hours).
	 */
	public boolean isShowAvailableHours() {
<span class="nc" id="L235">		return m_showAvailableHours;</span>
	}

	/**
	 * Set whether we are showing Available hours (rather than allocated hours).
	 */
	public void setShowAvailableHours(boolean showAvailableHours) {
<span class="nc" id="L242">		m_showAvailableHours = showAvailableHours;</span>
<span class="nc" id="L243">	}</span>

	/**
	 * Fetch Data to render Calendar Content for the &quot;My Time Off Calendar&quot; page. Any other pages as well??
	 * @param empID - the ID of the logged-in user
	 * @param isTOPoolView - true means we will view time off for the agent's pool. False means for the agent only (&quot;Personal&quot;).
	 * @param pTOPoolID - the ID of the Time Off Pool for the agent (only for when isTOPoolView == true).
	 */
	public void fetchData(ID empID, boolean isTOPoolView, ID pTOPoolID, int allocationType, ID activityID) throws Exception {
<span class="nc" id="L252">		m_sOrgID = OrganizationModelHandler.getEmployeeOrgID(m_context, empID).toString();</span>
<span class="nc" id="L253">		m_isAgentTOPoolView = isTOPoolView;</span>
<span class="nc" id="L254">		m_poolID = pTOPoolID;</span>

<span class="nc bnc" id="L256" title="All 4 branches missed.">		m_isLinkToRequestEnabled = isTOPoolView &amp;&amp; m_context.getUser().isAuthorized(PrivilegeKeys.TOM_VIEWCALENDARLINKS_ID);</span>
<span class="nc" id="L257">		m_isLinkToSchedTOEnabled = m_isLinkToRequestEnabled;</span>

<span class="nc" id="L259">		fetchData(empID, new ID(m_sOrgID), m_poolID, false, isTOPoolView, allocationType, activityID);</span>
<span class="nc" id="L260">	}</span>

	public void fetchData(ID empID, boolean isTOPoolView, ID pTOPoolID, ID activityID) throws Exception {
<span class="nc" id="L263">		fetchData(empID, isTOPoolView, pTOPoolID, 0, activityID);</span>
<span class="nc" id="L264">	}</span>

	/**
	 * Fetch Data to render Calendar Content for the manager's &quot;Requests \ Time Off Calendar&quot; page
	 * @param empID - the ID of the logged-in user
	 * @param orgID - the ID of the organization selected in the selection pane
	 * @param pTOPoolID - the ID of the Time Off Pool which was selected from the pool list A value
	 *                    of null indicates that the user wishes to see all time off for the org.
	 */
	public void fetchDataForManager(ID empID, ID orgID, ID pTOPoolID, int allocationType) throws Exception {
<span class="nc" id="L274">		m_isLinkToRequestEnabled = m_context.getUser().isAuthorized(PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE_ID, OrganizationScopeManagerProxy.getScopeID(orgID));</span>
<span class="nc" id="L275">		m_isLinkToSchedTOEnabled = true;</span>
<span class="nc" id="L276">		m_sOrgID = orgID.toString();</span>
<span class="nc" id="L277">		m_poolID = pTOPoolID;</span>
<span class="nc" id="L278">		fetchData(empID, orgID, pTOPoolID, true, false, allocationType, null);</span>
<span class="nc" id="L279">	}</span>

	public void fetchDataForManager(ID empID, ID orgID, ID pTOPoolID) throws Exception {
<span class="nc" id="L282">		fetchDataForManager(empID, orgID, pTOPoolID, 0);</span>
<span class="nc" id="L283">	}</span>

	/**
	 * Actual Implementation of fetch Data
	 * @param empID - the ID of the logged-in user
	 * @param orgID - the ID of the organization.
	 * @param pTOPoolID - the ID of the Time Off Pool which was selected from the pool list for the manager's
	 *                    page. A value of null indicates that the user wishes to see all time off for the org.
	 * @param isDataForManager - is this time off calendar for the manager's page? true=yes, false=no (agent's page).
	 * @param isTOPoolView - When viewing the agent's page, this tells us whether to view time off for his pool (true), or only himself (false).
	 * @param allocationType - 0: daily Allocation, 1: intervalAllocation
	 */
	@SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
	private void fetchData(ID empID, ID orgID, ID pTOPoolID, boolean isDataForManager, boolean isTOPoolView, int allocationType, ID activityID) throws Exception {
<span class="nc" id="L297">		m_isDataForManager = isDataForManager;</span>

		// Retrieve Organization to use its time zone, etc
<span class="nc" id="L300">		Organization org = OrganizationModelHandler.getOrganization(m_context, orgID);</span>
<span class="nc" id="L301">		m_tz = org.getTimeZone();</span>
<span class="nc" id="L302">		m_firstDayOfWeek = org.getWeekStartDate();</span>

<span class="nc bnc" id="L304" title="All 2 branches missed.">		intervalCalendarPC.setMode(!m_isDataForManager, isTOPoolView);</span>
<span class="nc" id="L305">		intervalCalendarPC.setSelectedOrganization(orgID);</span>
<span class="nc" id="L306">		intervalCalendarPC.setSelectedPool(pTOPoolID);</span>

		
		// Calculate Start and End Date
<span class="nc" id="L310">		Calendar startCal = newCalFromNavCal();</span>
<span class="nc" id="L311">		Calendar endCal = newCalFromNavCal();</span>
		
<span class="nc" id="L313">		int dayBoundaryOffset = org.getDayBoundaryOffset();</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">		if (dayBoundaryOffset &gt; 0) {</span>
			// QC 41795 / QA 95083 DST issue: standardize setting of dayBoundaryOffset
<span class="nc" id="L316">			TOCalcUtil.setCalMinsOffsetFromMidnight(startCal, dayBoundaryOffset);</span>
<span class="nc" id="L317">			TOCalcUtil.setCalMinsOffsetFromMidnight(endCal, dayBoundaryOffset);</span>
		}
		// FOR INTERVAL_ALLOCATION
<span class="nc bnc" id="L320" title="All 2 branches missed.">		if(allocationType == INTERVAL_ALLOCATION) {</span>
<span class="nc" id="L321">			endCal.add(Calendar.MONTH, 1);</span>
<span class="nc" id="L322">			adjustCalendarsForTOIC(startCal, endCal);</span>
<span class="nc" id="L323">			Date startDate = startCal.getTime();</span>
<span class="nc" id="L324">			Date endDate = endCal.getTime();</span>
				// Fetch Time Off Data
<span class="nc bnc" id="L326" title="All 2 branches missed.">				if (isDataForManager) {</span>
					// manager needs poolID since the whole calendar data is from the selected pool's perspective.
<span class="nc" id="L328">					this.timeOffIntervalCalendar = TimeOffRequestsMH.getTOIntervalCalendarForManager(orgID, pTOPoolID, startDate, endDate);</span>
<span class="nc" id="L329">					splitTimeOffIntervalCalendarForUser(startCal, endCal);</span>
				} else {
<span class="nc" id="L331">					this.timeOffIntervalCalendar = TimeOffRequestsMH.getTOIntervalCalendarForEmp(empID, startDate, endDate, m_tz, isTOPoolView, pTOPoolID, activityID);</span>
<span class="nc" id="L332">					splitTimeOffIntervalCalendarForUser(startCal, endCal);</span>
				}
<span class="nc" id="L334">		} else { </span>
		//FOR DAILY_ALLOCATION
<span class="nc" id="L336">			endCal.add(Calendar.MONTH, m_numOfCals);</span>
<span class="nc" id="L337">			Date startDateRange = startCal.getTime();</span>
<span class="nc" id="L338">			Date endDateRange = endCal.getTime();</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">			if (isDataForManager) {</span>
				// manager needs poolID since the whole calendar data is from the selected pool's perspective.
<span class="nc" id="L341">				m_calDataList = TimeOffRequestsMH.getTOCalendarDataForManager(empID, orgID, pTOPoolID, startDateRange, endDateRange); </span>
			} else {
				
				
<span class="nc" id="L345">				m_calDataList = TimeOffRequestsMH.getTOCalendarDataForEmployee(empID, startDateRange, endDateRange, isTOPoolView,org, pTOPoolID, activityID);</span>
			} 
				
		}
		
<span class="nc" id="L350">	}</span>
	
	/**
	 * Determine whether to display Legend Button
	 */
	private void initHeader() {
<span class="nc bnc" id="L356" title="All 2 branches missed.">		if (m_isEncapsulated) {</span>
<span class="nc" id="L357">			String calNavControl = getNavigationControl();</span>

<span class="nc bnc" id="L359" title="All 2 branches missed.">			if (m_isLegenBtnEnabled) {</span>
<span class="nc" id="L360">				String legendButton = m_legendPC.getLegendButton().toString();</span>
<span class="nc" id="L361">				StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L362">				sb.append(&quot;\n&lt;table&gt;&lt;tr&gt;&lt;td&gt;&quot;).append(calNavControl).append(&quot;&lt;/td&gt;&lt;td&gt;&quot;).append(legendButton).append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;);</span>
<span class="nc" id="L363">				addHeaderControl(sb.toString());</span>
<span class="nc" id="L364">			} else {</span>
<span class="nc" id="L365">				addHeaderControl(calNavControl);</span>
			}
		}
<span class="nc" id="L368">	}</span>

	/**
	 * Set number of Calendars to display
	 */
	public void setNumOfCals(int numOfCals) {
<span class="nc" id="L374">		m_numOfCals = numOfCals;</span>
<span class="nc" id="L375">	}</span>

	/**
	 * Return the number of Calendars to display
	 */
	public int getNumOfCals() {
<span class="nc" id="L381">		return m_numOfCals;</span>
	}

	/**
	 * Set is agents calendar
	 * this is needed to decide the org list that should be used when drilling into the pending requests list
	 */
	public void setIsAgentCal(boolean isAgentCal) {
<span class="nc" id="L389">		m_isAgentCal = isAgentCal;</span>
<span class="nc" id="L390">	}</span>

	/**
	 * Return is agents calendar
	 */
	public boolean getIsAgentCal() {
<span class="nc" id="L396">		return m_isAgentCal;</span>
	}

	/**
	 * Set Organization Setting
	 */
	public void setOrgSetting(OrganizationSetting orgSetting) {
<span class="nc" id="L403">		m_orgSetting = orgSetting;</span>
<span class="nc" id="L404">	}</span>

	/**
	 * Return Organization Setting
	 */
	public OrganizationSetting getOrgSetting() {
<span class="nc" id="L410">		return m_orgSetting;</span>
	}

	/**
	 * Append Localize Image for Day Data if detail information is requested
	 */
	private void appendDayDataImgCell(StringBuilder sb, int rowSpan) {
<span class="nc" id="L417">		String img = i18n(m_bundle, RmWebBundleKey.TIMEOFF_DAY_DATA_IMG);</span>
<span class="nc" id="L418">		String alt = i18n(m_bundle, RmWebBundleKey.TIMEOFF_DAY_DATA_IMG_DESC);</span>

<span class="nc bnc" id="L420" title="All 2 branches missed.">		if (m_showAvailableHours) {</span>
<span class="nc" id="L421">			img = i18n(m_bundle, RmWebBundleKey.TIMEOFF_DAY_DATA2_IMG);</span>
<span class="nc" id="L422">			alt = i18n(m_bundle, RmWebBundleKey.TIMEOFF_DAY_DATA2_IMG_DESC);</span>
		}
<span class="nc" id="L424">		img = m_context.getStaticFileUrl(img);</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
			//508
<span class="nc" id="L427">			img = HtmlUtil.imageTag(img, alt, true, true);</span>
		} else {
<span class="nc" id="L429">			img = HtmlUtil.imageTag(img, alt);</span>
		}

<span class="nc" id="L432">		sb.append(&quot;&lt;td rowspan=\&quot;&quot;).append(rowSpan).append(&quot;\&quot; style=\&quot;padding-right:10px;\&quot;&gt;&quot;).append(img).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L433">	}</span>

	/**
	 * Append the HTML for all Calendars to the string buffer.
	 */
	private void appendCalendars(StringBuilder sb) {
<span class="nc" id="L439">		Calendar cal = newCalFromNavCal();</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">		boolean isSmallCal = !m_isDetailEnabled;</span>
<span class="nc" id="L441">		m_calPC.setIsSmallType(isSmallCal);</span>
<span class="nc" id="L442">		m_calPC.setFirstDayOfWeek(m_firstDayOfWeek);</span>

<span class="nc bnc" id="L444" title="All 2 branches missed.">		String cssClass = m_calPC.isSmallType() ? &quot;calDayLblNormalSmall&quot; : &quot;calDayLblNormal&quot;;</span>
<span class="nc" id="L445">		m_calPC.setDayLabelCSS(cssClass);</span>
		; //508

<span class="nc" id="L448">		int numOfRows = getNumOfRows();</span>
<span class="nc" id="L449">		int numOfCells = getNumOfCellsForRow();</span>

<span class="nc" id="L451">		sb.append(&quot;\n&lt;center&gt;\n&lt;table align=\&quot;center\&quot; id=\&quot;dailyCalendarGrid\&quot;&gt;\n&quot;);</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">		for (int i = 0; i &lt; numOfRows; i++) {</span>
<span class="nc" id="L453">			sb.append(&quot;&lt;tr&gt;&quot;);</span>

			// Add Day Data Image if necessary
<span class="nc bnc" id="L456" title="All 4 branches missed.">			if (i == 0 &amp;&amp; m_isDetailEnabled) {</span>
<span class="nc" id="L457">				appendDayDataImgCell(sb, numOfRows);</span>
			}

<span class="nc bnc" id="L460" title="All 2 branches missed.">			for (int j = 0; j &lt; numOfCells; j++) {</span>
<span class="nc" id="L461">				int index = i * numOfCells + j;</span>
<span class="nc" id="L462">				String calDisplay = getCalendarDisplay(m_calPC, cal, index);</span>
<span class="nc" id="L463">				sb.append(&quot;&lt;td&gt;&quot;).append(calDisplay).append(&quot;&lt;/td&gt;&quot;);</span>

				// Increament Calendar for Next Month
<span class="nc" id="L466">				cal.add(Calendar.MONTH, 1);</span>
			}
<span class="nc" id="L468">			sb.append(&quot;&lt;/tr&gt;&quot;);</span>
		}
<span class="nc" id="L470">		sb.append(&quot;\n&lt;/table&gt;\n&lt;/center&gt;\n&quot;);</span>
<span class="nc" id="L471">	}</span>

	/**
	 * Append the Calendars' legend to the string buffer.
	 */
	private void appendLegend(StringBuilder sb) {
<span class="nc bnc" id="L477" title="All 2 branches missed.">		if (m_orgSetting == null) {</span>
<span class="nc" id="L478">			return;</span>
		}

<span class="nc bnc" id="L481" title="All 2 branches missed.">		m_legendPC.setIsForEmployee(!m_isDataForManager);</span>
<span class="nc" id="L482">		m_legendPC.setOrgSetting(m_orgSetting);</span>
<span class="nc" id="L483">		m_legendPC.setIsUsedAsNormalPC(m_isLegendVisible);</span>

<span class="nc bnc" id="L485" title="All 2 branches missed.">		m_legendPC.setIsFooterEnabled(!m_isLegendVisible);</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">		m_legendPC.setIsHtmlAutoAdded(!m_isLegendVisible);</span>

<span class="nc bnc" id="L488" title="All 2 branches missed.">		if (m_isLegendVisible) {</span>
<span class="nc" id="L489">			sb.append(&quot;\n&lt;br&gt;&lt;center&gt;&quot;).append(m_legendPC).append(&quot;&lt;/center&gt;&lt;br&gt;\n&quot;);</span>
		}
<span class="nc" id="L491">	}</span>

	/**
	 * Return number of Cells per Row
	 */
	private int getNumOfCellsForRow() {
<span class="nc bnc" id="L497" title="All 2 branches missed.">		if (m_numOfCals &gt; MAX_CELL_FOR_COLUMN) {</span>
<span class="nc" id="L498">			return MAX_CELL_FOR_COLUMN;</span>
		} else {
<span class="nc" id="L500">			return m_numOfCals;</span>
		}
	}

	/**
	 * Determine the number of Rows required to display all Calendars
	 */
	private int getNumOfRows() {
<span class="nc bnc" id="L508" title="All 2 branches missed.">		if (m_numOfCals &lt; MAX_CELL_FOR_COLUMN) {</span>
<span class="nc" id="L509">			return 1;</span>
		}

<span class="nc" id="L512">		int numOfRow = (m_numOfCals / MAX_CELL_FOR_COLUMN);</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">		if (m_numOfCals % MAX_CELL_FOR_COLUMN != 0) {</span>
<span class="nc" id="L514">			numOfRow++;</span>
		}

<span class="nc" id="L517">		return numOfRow;</span>
	}

	/**
	 * Return Calendar Data and increment data counter
	 */
	private List getCalendarData(int dataSize) {
<span class="nc bnc" id="L524" title="All 2 branches missed.">		if (m_calDataList.isEmpty()) {</span>
<span class="nc" id="L525">			return Collections.emptyList();</span>
		}

<span class="nc" id="L528">		int start = m_dayCounter;</span>
<span class="nc" id="L529">		int end = m_dayCounter + dataSize;</span>
<span class="nc" id="L530">		m_dayCounter = end;</span>

<span class="nc bnc" id="L532" title="All 2 branches missed.">		if (end &gt; m_calDataList.size()) {</span>
<span class="nc" id="L533">			return Collections.emptyList();</span>
		}

<span class="nc" id="L536">		return m_calDataList.subList(start, end);</span>
	}

	/**
	 * Get Time to be passed around in HTML
	 *
	private long getTime(Calendar cal, int date) {
		cal.set(Calendar.DAY_OF_MONTH, date+1);
		return cal.getTime().getTime();
	}
	*/

	/**
	 * Return the &quot;Pending Time Off Requests&quot; link for Manager or agent, which takes the user to a reduced-functionality Employee Requests page, pre-filtered by Pending Time Off Requests.
	 * @param hPending - the pending hours to show for this day.
	 * @param date - the day to be shown in the the calendar.
	 * @param poolID - The time off pool ID for this day. Needed for agent's time off pool view, since he could change pools throughout the month.
	 * @param orgID  - The organization ID for this day. Needed for agent's time off pool view, since he could change orgs throughout the month.
	 * @return
	 */
	private String getHourPendingDisplayForMgr(String hPending, Date date, ID poolID, ID orgID) {

<span class="nc bnc" id="L558" title="All 2 branches missed.">		poolID = m_isAgentTOPoolView ? poolID : m_poolID;</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">		String sOrgID = m_isAgentTOPoolView ? orgID.toString() : m_sOrgID;</span>

		//set the flag for viewing message about access rights
		//set whether we are viewing the org's time off (true), or the pool's time off (false)
<span class="nc bnc" id="L563" title="All 4 branches missed.">		boolean isParentView = (!m_isAgentCal &amp;&amp; m_poolID == null);</span>

<span class="nc bnc" id="L565" title="All 4 branches missed.">		String requestURL = (m_isAgentCal ? RmKeys.RH_AG_VIEW_TIMEOFF_LIST : MGR_HOUR_PENDING_VIEW_REQUEST) + &quot;?pageAction=&quot; + RmPageAction.AGENTS_TIMEOFF_PENDING_ACTION + (poolID != null ? &quot;&amp;TOPOOLID=&quot; + poolID : &quot;&amp;orgID=&quot; + sOrgID)</span>
<span class="nc" id="L566">				+ &quot;&amp;date=&quot; + date.getTime() + &quot;&amp;isParentView=&quot; + String.valueOf(isParentView) + &quot;&amp;isAgentCal=&quot; + String.valueOf(m_isAgentCal) + &quot;&amp;isPendingTOView=true&quot; + &quot;&amp;viewMode=&quot; + PageKeys.DEFAULT_ALL;</span>
		
<span class="nc" id="L568">		return HtmlLinkUtil.createURLLink(hPending, requestURL, HtmlLinkUtil.PAGE_LINK, true);</span>
	}

	/**
	 * Return the &quot;Scheduled Time Off Agent Names&quot; link, which pops-up a dialog that lists all agents who have a scheduled time off on that day.
	 * @param poolID - The time off pool ID for this day. Needed for agent's time off pool view, since he could change pools throughout the month.
	 * @param orgID  - The organization ID for this day. Needed for agent's time off pool view, since he could change orgs throughout the month.
	 */
	private String createAgentsNameLink(String display, Date date, String hourType, ID poolID, ID orgID) {

<span class="nc bnc" id="L578" title="All 2 branches missed.">		poolID = m_isAgentTOPoolView ? poolID : m_poolID;</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">		String sOrgID = m_isAgentTOPoolView ? orgID.toString() : m_sOrgID;</span>

		//set the flag for viewing message about access rights
		//set whether we are viewing the org's time off (true), or the pool's time off (false)
<span class="nc bnc" id="L583" title="All 4 branches missed.">		boolean isParentView = (!m_isAgentCal &amp;&amp; m_poolID == null);</span>

		//&quot;orgID,poolID,date,hourType,parentView,agentCal&quot;
<span class="nc bnc" id="L586" title="All 4 branches missed.">		String popupJS = getName() + &quot;.handleAgentsPopup(&quot; + ((sOrgID == null) ? (&quot;null&quot;) : (&quot;'&quot; + sOrgID + &quot;'&quot;)) + &quot;, &quot; </span>
<span class="nc" id="L587">		+ ((poolID == null) ? (&quot;null&quot;) : (&quot;'&quot; + poolID.toString() + &quot;'&quot;)) + &quot;, &quot; + date.getTime() + &quot;, '&quot; + hourType + &quot;' ,'&quot; </span>
<span class="nc" id="L588">				+ String.valueOf(isParentView) + &quot;', '&quot; + String.valueOf(m_isAgentCal) + &quot;');&quot;;</span>
<span class="nc" id="L589">		return HtmlLinkUtil.createActiveLink(display, null, null, popupJS);</span>
	}

	/**
	 * Return Time Off Hours Text for a particular day's data.
	 */
	private String getTimeOffHoursText(TOCalendarDayData dayData) {
<span class="nc" id="L596">		float hourAlloc = dayData.getHourAvail(); //The backend uses the word &quot;available&quot; to mean &quot;allocated&quot;</span>
<span class="nc" id="L597">		float hourPending = dayData.getHourPending();</span>
<span class="nc" id="L598">		float hourScTO = dayData.getScheduledTO();</span>
<span class="nc" id="L599">		float hourAvail = dayData.getHourRemaining(); //The backend uses the word &quot;remaining&quot; to mean &quot;available&quot;</span>

<span class="nc" id="L601">		StringBuilder sb = new StringBuilder();</span>

		//set whether we are viewing the org's time off (true), or the pool's time off (false)
<span class="nc bnc" id="L604" title="All 4 branches missed.">		boolean isParentView = (!m_isAgentCal &amp;&amp; m_poolID == null);</span>

		// Available/Allocated Hours Info
<span class="nc" id="L607">		String hFirstVal = i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_NOT_APPLICABLE); //&quot;n/a&quot;;</span>

<span class="nc bnc" id="L609" title="All 4 branches missed.">		if (!isParentView &amp;&amp; dayData.getTOPoolID() != null)	{</span>
<span class="nc" id="L610">			hFirstVal = m_decimalFormat.format(hourAlloc);</span>

<span class="nc bnc" id="L612" title="All 2 branches missed.">			if (m_showAvailableHours) {</span>
<span class="nc" id="L613">				hFirstVal = m_decimalFormat.format(hourAvail);</span>
			}
		}

<span class="nc bnc" id="L617" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()){</span>
<span class="nc" id="L618">			String hourType = i18n(m_bundle, RmWebBundleKey.TIMEOFF_HOURS_ALLOCATED);</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">			if (m_showAvailableHours) {</span>
<span class="nc" id="L620">				hourType = i18n(m_bundle, RmWebBundleKey.TIMEOFF_HOURS_AVAILABLE);</span>
			}
<span class="nc" id="L622">			hourType = HtmlUtil.makeHiddenReadableText(hourType);</span>
<span class="nc" id="L623">			hFirstVal = HtmlUtil.getTabbableLabel(hFirstVal + hourType, null);</span>
		}

<span class="nc" id="L626">		sb.append(&quot;&lt;span class=\&quot;calDayTxt\&quot;&gt;&quot;).append(hFirstVal).append(&quot;, &quot;);</span>

		//QA45178: Silk 80391
<span class="nc" id="L629">		Date dt = dayData.getDate();</span>
		// Pending Hour Info
<span class="nc" id="L631">		String hPending = m_decimalFormat.format(hourPending);</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()){</span>
<span class="nc" id="L633">			String hourType = i18n(m_bundle, RmWebBundleKey.TIMEOFF_HOURS_PENDING);</span>
<span class="nc" id="L634">			hPending = hPending + HtmlUtil.makeHiddenReadableText(hourType);</span>
		}

<span class="nc bnc" id="L637" title="All 4 branches missed.">		if (hourPending &gt; 0 &amp;&amp; m_isLinkToRequestEnabled) {</span>
<span class="nc" id="L638">			hPending = getHourPendingDisplayForMgr(hPending, dt, dayData.getTOPoolID(), dayData.getOrgId());</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">		} else if (isAccessibilityComplianceMode()){</span>
<span class="nc" id="L640">			hPending = HtmlUtil.getTabbableLabel(hPending, null);</span>
		}

		// Scheduled Time Off Info
<span class="nc" id="L644">		String schTimeOff = m_decimalFormat.format(hourScTO);</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()){</span>
<span class="nc" id="L646">			String hourType = i18n(m_bundle, RmWebBundleKey.TIMEOFF_SCHEDULED_TO);</span>
<span class="nc" id="L647">			schTimeOff = schTimeOff + HtmlUtil.makeHiddenReadableText(hourType);</span>
		}

<span class="nc bnc" id="L650" title="All 4 branches missed.">		if (hourScTO &gt; 0 &amp;&amp; m_isLinkToSchedTOEnabled) {</span>
<span class="nc" id="L651">			schTimeOff = createAgentsNameLink(schTimeOff, dt, RmKeys.SCHEDULED_TO_TYPE, dayData.getTOPoolID(), dayData.getOrgId());</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">		} else if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L653">			schTimeOff = HtmlUtil.getTabbableLabel(schTimeOff, null);</span>
		}
		
<span class="nc" id="L656">		sb.append(hPending).append(&quot;, &quot;).append(schTimeOff).append(&quot;&lt;/span&gt;&quot;);</span>
<span class="nc" id="L657">		return sb.toString();</span>
	}

	/**
	 * Return Calendar Display for a single calendar.
	 */
	private String getCalendarDisplay(CalendarPC calPC, Calendar cal, int index) {
<span class="nc bnc" id="L664" title="All 2 branches missed.">		if (index &gt;= m_numOfCals) {</span>
<span class="nc" id="L665">			return &quot;&amp;nbsp;&quot;;</span>
		}

		// Adjust CalendarPC Date with Date and TimeZone information so that First of the Month
		// does not get shifted to previous month due to TimeZone convertion
<span class="nc" id="L670">		Date date = cal.getTime();</span>
<span class="nc" id="L671">		calPC.setDate(date);</span>
<span class="nc" id="L672">		calPC.setCalendarTimeZone(cal.getTimeZone());</span>

<span class="nc" id="L674">		Calendar timeoffCal = newCalendar();</span>
<span class="nc" id="L675">		timeoffCal.setTime(date);</span>

<span class="nc" id="L677">		int size = cal.getActualMaximum(Calendar.DAY_OF_MONTH);</span>
<span class="nc" id="L678">		List calDataList = getCalendarData(size);</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">		boolean hasCalData = !calDataList.isEmpty();</span>
		
		//Output the pool name. Get the list of pools for speed.
<span class="nc" id="L682">		String toPool = m_context.getLocalizer().i18n(m_bundle, RmWebBundleKey.TIME_OFF_POOL);</span>
<span class="nc" id="L683">		String toPoolNotApplicable = m_context.getLocalizer().i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_NOT_APPLICABLE);</span>
<span class="nc" id="L684">		String poolString=&quot;&quot;;</span>
		
		// We need all pools to output the pool string if multipool enabled.
<span class="nc" id="L687">		List&lt;TOPool&gt; listPools = Collections.emptyList();</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">		if(showTOPoolsToolTip){</span>
<span class="nc" id="L689">			listPools = TOPoolUtil.getAllTimeoffPools();</span>
		}
		
		
<span class="nc bnc" id="L693" title="All 4 branches missed.">		for (int i = 0; (i &lt; size &amp;&amp; hasCalData); i++) {</span>
<span class="nc" id="L694">			TOCalendarDayData dayData = (TOCalendarDayData) calDataList.get(i);</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">			if (m_isDetailEnabled) {</span>
<span class="nc" id="L696">				String text = getTimeOffHoursText(dayData);</span>
<span class="nc" id="L697">				HashMap prop = new HashMap(1);</span>
<span class="nc" id="L698">				prop.put(GenericCalendarDayRenderer.DAY_PROP_DATA, text);</span>
<span class="nc" id="L699">				calPC.setCalendarDayProp(i + 1, prop);</span>
			}

			// Set Color Key
<span class="nc bnc" id="L703" title="All 2 branches missed.">			if (m_orgSetting != null) {</span>
<span class="nc" id="L704">				int dType = dayData.getDayType();</span>
<span class="nc" id="L705">				String colorKey = TOCalendarDayData.DAY_TYPE_TO_SETTINGS_KEY[dType];</span>
<span class="nc" id="L706">				String color = m_orgSetting.getValue(colorKey);</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">				color = color.startsWith(&quot;#&quot;) ? color : &quot;#&quot; + color;</span>
<span class="nc" id="L708">				calPC.setDayColor(i + 1, color);</span>

				
				
				//Formulate the pool name
<span class="nc bnc" id="L713" title="All 2 branches missed.">				if(showTOPoolsToolTip){</span>
<span class="nc" id="L714">					poolString = &quot;\n&quot; + toPool + &quot;: &quot; + </span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">						(dayData.getTOPoolID()!=null? TOPoolUtil.getTOPoolName(listPools, dayData.getTOPoolID()) :</span>
							toPoolNotApplicable);
				}
				
				//508: Add the formatted date to the accessible label
<span class="nc" id="L720">				String label = m_context.getLocalizer().formatDate(dayData.getDate(), cal.getTimeZone(), RegionalFormatBundleKey.FULL_DATE_FORMAT) + &quot;, &quot; </span>
<span class="nc" id="L721">				+ getDayTypeString(dType) + poolString;</span>

				//Set the day number link properties for 508 Accessibility compliance
<span class="nc" id="L724">				calPC.setDayLinkProperties(i + 1, &quot;&quot;, label, &quot;text-decoration:none; cursor:default;&quot;);</span>
			}
		}

<span class="nc" id="L728">		return calPC.getHtmlDisplay();</span>
	}

	/**
	 * Return the TO Calendar Day Type string, such as (&quot;Blackout&quot;, &quot;Pending&quot;, etc).
	 * @param dType The day type integer.
	 * @return the TO Calendar Day Type string, such as (&quot;Blackout&quot;, &quot;Pending&quot;, etc).
	 */
	private String getDayTypeString(int dType) {
<span class="nc bnc" id="L737" title="All 8 branches missed.">		switch (dType) {</span>

		case TOCalendarDayData.TO_HOURS_AVAILABLE_DAY_TYPE:
<span class="nc" id="L740">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_AVAILABLE_LABEL);</span>
		case TOCalendarDayData.UNPAID_HOLIDAY_DAY_TYPE:
<span class="nc" id="L742">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_WORKING_LABEL);</span>
		case TOCalendarDayData.NON_OPERATION_DAY_TYPE:
<span class="nc" id="L744">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_NON_OPERATION_LABEL);</span>
		case TOCalendarDayData.PAID_HOLIDAY_DAY_TYPE:
<span class="nc" id="L746">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_NON_WORKING_LABEL);</span>
		case TOCalendarDayData.BLACKOUT_DAY_TYPE:
<span class="nc" id="L748">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_BLACKOUT_LABEL);</span>
		case TOCalendarDayData.PENDING_DAY_TYPE:
<span class="nc" id="L750">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_PENDING_LABEL);</span>
		case TOCalendarDayData.SCHEDULED_DAY_TYPE:
<span class="nc" id="L752">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_SCHEDULED_LABEL);</span>
		case TOCalendarDayData.NO_TO_HOURS_AVAILABLE_DAY_TYPE:
		default:
<span class="nc" id="L755">			return i18n(m_bundle, RmWebBundleKey.ORG_RM_SETTINGS_TO_NO_AVAILABLE_LABEL);</span>
		}
	}

	/**
	 * Specify whether Legend is visible
	 */
	public void setIsLegendVisible(boolean bSwitch) {
<span class="nc" id="L763">		m_isLegendVisible = bSwitch;</span>
<span class="nc" id="L764">	}</span>

	/**
	 * Return True if Legend is visible
	 */
	public boolean isLegendVisible() {
<span class="nc" id="L770">		return m_isLegendVisible;</span>
	}

	/**
	 * Enabled Legend Button
	 */
	public void setIsLegendButtonEnabled(boolean bSwitch) {
<span class="nc" id="L777">		m_isLegenBtnEnabled = bSwitch;</span>
<span class="nc" id="L778">	}</span>

	/**
	 * Return True if Legend Button is Enabled
	 */
	public boolean isLegendButtonEnabled() {
<span class="nc" id="L784">		return m_isLegenBtnEnabled;</span>
	}

	/**
	 * Specify whether Detail Calendar is enabled
	 */
	public void setIsDetailEnabled(boolean bSwitch) {
<span class="nc" id="L791">		m_isDetailEnabled = bSwitch;</span>
<span class="nc" id="L792">	}</span>

	/**
	 * Return True if Detail Calendar is enabled
	 */
	public boolean isDetailEnabled() {
<span class="nc" id="L798">		return m_isDetailEnabled;</span>
	}

	/**
	 * Return Calendar Navigation Control
	 */
	public String getNavigationControl() {
<span class="nc" id="L805">		return m_calPC.getNavigationControl(m_navCalendar);</span>
	}

	/**
	 * Return JavaScript Init Code
	 */
	@Override
	public String getJavaScriptInitCode() {
<span class="nc" id="L813">		String superJS = super.getJavaScriptInitCode();</span>

<span class="nc bnc" id="L815" title="All 2 branches missed.">		if (StringUtil.isEmpty(m_sOrgID)) {</span>
<span class="nc" id="L816">			return superJS;</span>
		} else {
<span class="nc bnc" id="L818" title="All 2 branches missed.">			return superJS + &quot;\n&quot; + getName() + &quot;.setOrgID('&quot; + m_sOrgID + &quot;');\n&quot; + ((m_poolID == null) ? &quot;&quot; : (&quot;\n&quot; + getName() + &quot;.setPoolID('&quot; + m_poolID + &quot;');\n&quot;));</span>
		}
	}

	/**
	 * Extract Parameters
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L827">		boolean success = super.extractParameters(request);</span>

<span class="nc" id="L829">		Calendar cal = m_calPC.extractNavigationControlDate();</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">		if (cal != null) {</span>
<span class="nc" id="L831">			m_navCalendar = cal;</span>
<span class="nc" id="L832">			m_context.setAttribute(RequestContext.SESSION_SCOPE, TIMEOFF_CAL_CACHE_KEY, cal.clone());</span>
		}
<span class="nc" id="L834">		return success;</span>
	}

	public String getIntervalCalendarHtml() {
<span class="nc" id="L838">		intervalCalendarPC.setOrganizationSetting(m_orgSetting);</span>
<span class="nc" id="L839">		intervalCalendarPC.setTimeOffIntervalCalendar(timeOffIntervalCalendar);</span>

<span class="nc" id="L841">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L842">		appendLegend(sb);</span>
<span class="nc" id="L843">		intervalCalendarPC.setLegendHtml(sb.toString());</span>

<span class="nc" id="L845">		return intervalCalendarPC.getHtmlDisplay();</span>
	}

	/**
	 * Adjusts the calendars to fetch more data if a time zone conversion is required.
	 * This always adjusts if we are displaying the employee's TOC because we don't know their TOP assignments at this point.
	 */
	private void adjustCalendarsForTOIC(Calendar startCal, Calendar endCal) {
<span class="nc bnc" id="L853" title="All 4 branches missed.">		if (this.m_isAgentCal || !m_tz.equals(m_context.getViewingTimeZone())) {</span>
<span class="nc" id="L854">			startCal.add(Calendar.DATE, -1);</span>
<span class="nc" id="L855">			endCal.add(Calendar.DATE, 1);</span>
		}
<span class="nc" id="L857">	}</span>

	/**
	 * Reverses the calendar adjustments if necessary.
	 */
	private void unAdjustCalendarsForTOIC(Calendar startCal, Calendar endCal) {
<span class="nc bnc" id="L863" title="All 4 branches missed.">		if (this.m_isAgentCal || !m_tz.equals(m_context.getViewingTimeZone())) {</span>
<span class="nc" id="L864">			startCal.add(Calendar.DATE, 1);</span>
<span class="nc" id="L865">			endCal.add(Calendar.DATE, -1);</span>
		}
<span class="nc" id="L867">	}</span>

	/**
	 * Splits the Time Off Interval Calendar into days for the user's time zone.
	 */
	private void splitTimeOffIntervalCalendarForUser(Calendar startCal, Calendar endCal) {
<span class="nc" id="L873">		unAdjustCalendarsForTOIC(startCal, endCal);</span>
<span class="nc" id="L874">		TimeZone userTz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L875">		Date userStartDate = DateUtil.convertClockTimeToTimeZone(startCal.getTime(), m_tz, userTz);</span>
<span class="nc" id="L876">		Date userEndDate = DateUtil.convertClockTimeToTimeZone(endCal.getTime(), m_tz, userTz);</span>
<span class="nc" id="L877">		this.timeOffIntervalCalendar.splitIntoDays(userTz, userStartDate, userEndDate);</span>
<span class="nc" id="L878">	}</span>

	public String getTimeOffAllocationType() {
<span class="nc" id="L881">		return timeOffAllocationType;</span>
	}

	public void setTimeOffAllocationType(String timeOffAllocationType) {
<span class="nc" id="L885">		this.timeOffAllocationType = timeOffAllocationType;</span>
<span class="nc" id="L886">	}</span>

	/**
	 * Return HTML Display
	 */
	@Override
	public String getHtmlDisplay() {
		// initialize Title
<span class="nc" id="L894">		String title = i18n(m_common_bundle, UIFWebBundleKey.TIMEZONE_ORGANIZATION) + &quot;:&quot; + TimeZoneHelper.getDisplayTimeZone(m_tz.getID(),</span>
				m_localizer);
<span class="nc" id="L896">		String ariaTitle = i18n(m_common_bundle, UIFWebBundleKey.TIMEZONE_ORGANIZATION) + &quot;:&quot; + m_localizer.formatTimeZone(m_tz.getID());</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">		if (m_isEncapsulated) {</span>
<span class="nc" id="L898">			title = i18n(m_bundle, RmWebBundleKey.RM_TIMEOFFCAL) + &quot; - &quot; + title;</span>
<span class="nc" id="L899">			ariaTitle = i18n(m_bundle, RmWebBundleKey.RM_TIMEOFFCAL) + &quot; - &quot; + ariaTitle;</span>
		}
<span class="nc" id="L901">		setTitle(title);</span>
<span class="nc" id="L902">		setWrapperAriaLabel(ariaTitle);</span>

		// Set up Display
<span class="nc" id="L905">		setTemplate(&quot;{0}&quot;);</span>
<span class="nc" id="L906">		StringBuilder sb = new StringBuilder(512);</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">		if (getTimeOffAllocationType().equals(INTERVAL_ALLOCATION_DROPDOWN_VALUE)) {</span>
<span class="nc" id="L908">			sb.append(getIntervalCalendarHtml());</span>
		} else {
<span class="nc" id="L910">			appendCalendars(sb);</span>
<span class="nc" id="L911">			appendLegend(sb);</span>
		}

<span class="nc" id="L914">		addComponent(sb);</span>
<span class="nc" id="L915">		return super.getHtmlDisplay();</span>
	}
	
	public TimeRange getStartEndDate(ID orgID, int allocationType) throws BbmException, RemoteException {
		// Retrieve Organization to use its time zone, etc
<span class="nc" id="L920">		Organization org = OrganizationModelHandler.getOrganization(m_context, orgID);</span>

		// Calculate Start and End Date
<span class="nc" id="L923">		Calendar startCal = newCalFromNavCal();</span>
<span class="nc" id="L924">		Calendar endCal = newCalFromNavCal();</span>

<span class="nc" id="L926">		int dayBoundaryOffset = org.getDayBoundaryOffset();</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">		if (dayBoundaryOffset &gt; 0) {</span>
			// QC 41795 / QA 95083 DST issue: standardize setting of dayBoundaryOffset
<span class="nc" id="L929">			TOCalcUtil.setCalMinsOffsetFromMidnight(startCal, dayBoundaryOffset);</span>
<span class="nc" id="L930">			TOCalcUtil.setCalMinsOffsetFromMidnight(endCal, dayBoundaryOffset);</span>
		}
		// FOR INTERVAL_ALLOCATION
<span class="nc bnc" id="L933" title="All 2 branches missed.">		if (allocationType == INTERVAL_ALLOCATION) {</span>
<span class="nc" id="L934">			endCal.add(Calendar.MONTH, 1);</span>
<span class="nc" id="L935">			adjustCalendarsForTOIC(startCal, endCal);</span>
<span class="nc" id="L936">			Date startDate = startCal.getTime();</span>
<span class="nc" id="L937">			Date endDate = endCal.getTime();</span>
<span class="nc" id="L938">			return new TimeRange(startDate, endDate);</span>

		} else {
			//FOR DAILY_ALLOCATION
<span class="nc" id="L942">			endCal.add(Calendar.MONTH, m_numOfCals);</span>
<span class="nc" id="L943">			Date startDateRange = startCal.getTime();</span>
<span class="nc" id="L944">			Date endDateRange = endCal.getTime();</span>
<span class="nc" id="L945">			return new TimeRange(startDateRange, endDateRange);</span>

		}
	}

	public void setShowTOPoolsToolTip(boolean doShowTOPoolsToolTip) {
<span class="nc" id="L951">		showTOPoolsToolTip = doShowTOPoolsToolTip;</span>
		
<span class="nc" id="L953">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>