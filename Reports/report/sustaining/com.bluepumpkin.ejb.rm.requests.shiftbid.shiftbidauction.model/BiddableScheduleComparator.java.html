<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BiddableScheduleComparator.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model</a> &gt; <span class="el_source">BiddableScheduleComparator.java</span></div><h1>BiddableScheduleComparator.java</h1><pre class="source lang-java linenums">/*
 * Created on Jun 16, 2004
 *
 * To change the template for this generated file go to
 * Window&amp;gt;Preferences&amp;gt;Java&amp;gt;Code Generation&amp;gt;Code and Comments
 */
package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model;

import java.text.Collator;
import java.util.Calendar;
import java.util.Collection;
import java.util.Comparator;
import java.util.Date;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignmentFields;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftEventAssignment;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTemplate;
import com.bluepumpkin.ejb.bbm.workresource.model.Phantom;
import com.bluepumpkin.ejb.core.base.SupportNavigation;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableSchedule;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableScheduleInstance;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.verint.ejb.wfm.WfmManagerFactory;
//import com.bluepumpkin.web.fs.schedule.ScheduleViewUtil;

/**
 * @author rrajendran
 *
 * To change the template for this generated type comment go to
 * Window&amp;gt;Preferences&amp;gt;Java&amp;gt;Code Generation&amp;gt;Code and Comments
 */
public class BiddableScheduleComparator implements Comparator {

<span class="nc" id="L44">	private static ScheduleAccessManager m_saMgr = null;</span>
<span class="nc" id="L45">    private BiddableScheduleComparator m_next = null;</span>
    
<span class="nc" id="L47">    private Calendar m_calWithTZ = null;</span>
<span class="nc" id="L48">    private Localizer m_localizer = null;</span>
<span class="nc" id="L49">    private Collator  m_collator = null;</span>
<span class="nc" id="L50">    int m_sortBy = -1;</span>
<span class="nc" id="L51">    int m_sortDir = -1;</span>
    
    /**
     * The SP week date ranges. 
     */
<span class="nc" id="L56">    TimeRange[] m_weekRanges = null;</span>
    
    /**
     * @param sortBy
     * @param sortDir
     * @param localizer only needed if sortBy criteria is {@link BiddableSchedule#SORTBY_PHANTOMNAME SORTBY_PHANTOMNAME}
     * @param calendar only needed if sortBy criteria is {@link BiddableSchedule#SORTBY_SUNDAY_STARTTIME SORTBY_SUNDAY_STARTTIME} or similar
     * @param weekRanges An array holding the date ranges for each week in the Scheduling Period.
     */
<span class="nc" id="L65">    public BiddableScheduleComparator(int sortBy, int sortDir, Localizer localizer, Calendar calWithTZ, TimeRange[] weekRanges) {</span>

<span class="nc" id="L67">        m_sortBy = sortBy;</span>
<span class="nc" id="L68">        m_sortDir = sortDir;    </span>
<span class="nc" id="L69">        m_localizer = localizer;</span>
<span class="nc" id="L70">        m_calWithTZ = calWithTZ;</span>
<span class="nc" id="L71">        m_weekRanges = weekRanges;</span>
<span class="nc" id="L72">    }</span>

    public void addComparator( BiddableScheduleComparator next )
    {
<span class="nc bnc" id="L76" title="All 2 branches missed.">    	if( next == null )</span>
<span class="nc" id="L77">    		return;</span>
    	
<span class="nc bnc" id="L79" title="All 4 branches missed.">    	if( this.m_sortBy == next.m_sortBy &amp;&amp; this.m_sortDir == next.m_sortDir )</span>
<span class="nc" id="L80">    		return;</span>

    	// chain comparators
<span class="nc bnc" id="L83" title="All 2 branches missed.">    	if( this.m_next == null )</span>
<span class="nc" id="L84">    		this.m_next = next;</span>
    	else
<span class="nc" id="L86">    		this.m_next.addComparator(next);</span>
<span class="nc" id="L87">    }</span>
    
    public synchronized String getTemplateName(  BiddableSchedule bidSched )
    {
    	try
    	{
<span class="nc" id="L93">    		Phantom ph = bidSched.getOptMethods().getFirstAvailBiddableSchedInst().getOptMethods().getEmployee();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">    		if( m_saMgr == null )</span>
    		{
    			{
<span class="nc" id="L97">    				m_saMgr = WfmManagerFactory.getScheduleAccessManager(); </span>
    			}
    		}
    		
<span class="nc" id="L101">    		ID id = ph.getEmployeeTemplateID();</span>
<span class="nc" id="L102">    		EmployeeTemplate emp = m_saMgr.getEmployeeTemplateByID(id);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">    		if( emp != null )</span>
    		{
<span class="nc" id="L105">    			return emp.getName() + ph.getName();</span>
    		}
    		else
    		{
<span class="nc" id="L109">    			return &quot;&quot;;</span>
    		}
    	}
<span class="nc" id="L112">    	catch( Exception ex )</span>
    	{
<span class="nc" id="L114">    		return &quot;&quot;;</span>
    	}
    }
    
    /**
     * Gets the description of the Biddable Schedule. If null, return an empty string.
     * 
     * @param bidSched Biddable Schedule
     * @return The description of the Biddable Schedule. If null, return an empty string.
     */
    protected String getDescription(BiddableSchedule bidSched) {
<span class="nc" id="L125">    	String desc = &quot;&quot;;</span>
    	try {
<span class="nc" id="L127">    		desc = bidSched.getDescription();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">    		if (desc == null) {</span>
<span class="nc" id="L129">    			desc = &quot;&quot;;</span>
    		}
<span class="nc" id="L131">    	} catch (Exception ex) {</span>
<span class="nc" id="L132">    		desc = &quot;&quot;;;</span>
<span class="nc" id="L133">    	}</span>
<span class="nc" id="L134">    	return desc;</span>
    }
    
    /* (non-Javadoc)
     * @see java.util.Comparator#compare(java.lang.Object, java.lang.Object)
     */
	@Override
	public int compare(Object arg0, Object arg1) {
<span class="nc" id="L142">        BiddableSchedule bidSched1 = (BiddableSchedule) arg0, bidSched2 = (BiddableSchedule) arg1;</span>
        
<span class="nc" id="L144">        int retval = -1;</span>
        
<span class="nc bnc" id="L146" title="All 2 branches missed.">		if (m_sortBy &lt; BiddableSchedule.SORTBY_SUNDAY_STARTTIME) {</span>
<span class="nc bnc" id="L147" title="All 9 branches missed.">			switch (m_sortBy) {</span>
			case BiddableSchedule.SORTBY_PHANTOMNAME:
<span class="nc bnc" id="L149" title="All 2 branches missed.">				m_collator = (m_collator == null) ? m_localizer.getCollator() : m_collator;</span>

<span class="nc" id="L151">				String phanName1 = this.getTemplateName(bidSched1);</span>
<span class="nc" id="L152">				String phanName2 = this.getTemplateName(bidSched2);</span>
<span class="nc" id="L153">				retval = m_collator.compare(phanName1, phanName2);</span>
<span class="nc" id="L154">				break;</span>

			case BiddableSchedule.SORTBY_PREFERENCE:
<span class="nc" id="L157">				retval = comparePreference(bidSched1, bidSched2);</span>
<span class="nc" id="L158">				break;</span>

			case BiddableSchedule.SORTBY_NUMBER_SUBMITTED:
<span class="nc" id="L161">				int bidSched1NumSubmitted = bidSched1.getOptMethods().getNumberOfBids();</span>
<span class="nc" id="L162">				int bidSched2NumSubmitted = bidSched2.getOptMethods().getNumberOfBids();</span>
<span class="nc" id="L163">				retval = bidSched1NumSubmitted - bidSched2NumSubmitted;</span>
<span class="nc" id="L164">				break;</span>

			case BiddableSchedule.SORTBY_BIDRANK:
<span class="nc" id="L167">				Pair bidSched1Rank = bidSched1.getOptMethods().getBidRankForShiftBidderWithBonus();</span>
<span class="nc" id="L168">				Pair bidSched2Rank = bidSched2.getOptMethods().getBidRankForShiftBidderWithBonus();</span>

<span class="nc" id="L170">				int bidSched1RankFirst = ((Integer) bidSched1Rank.getFirst()).intValue();</span>
<span class="nc" id="L171">				int bidSched1RankSecond = ((Integer) bidSched1Rank.getSecond()).intValue();</span>

<span class="nc" id="L173">				int bidSched2RankFirst = ((Integer) bidSched2Rank.getFirst()).intValue();</span>
<span class="nc" id="L174">				int bidSched2RankSecond = ((Integer) bidSched2Rank.getSecond()).intValue();</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">				if (bidSched1RankFirst &lt; bidSched2RankFirst)</span>
				{
<span class="nc" id="L178">					retval = -1;</span>
				}
<span class="nc bnc" id="L180" title="All 2 branches missed.">				else if (bidSched1RankFirst &gt; bidSched2RankFirst)</span>
				{
<span class="nc" id="L182">					retval = 1;</span>
				}
				else
				{
<span class="nc bnc" id="L186" title="All 2 branches missed.">					if (bidSched1RankSecond &lt; bidSched2RankSecond)</span>
					{
<span class="nc" id="L188">						retval = -1;</span>
					}
<span class="nc bnc" id="L190" title="All 2 branches missed.">					else if (bidSched1RankSecond &gt; bidSched2RankSecond)</span>
					{
<span class="nc" id="L192">						retval = 1;</span>
					}
					else
					{
<span class="nc" id="L196">						retval = 0;</span>
					}
				}
<span class="nc" id="L199">				break;</span>

			case BiddableSchedule.SORTBY_HOURS:
<span class="nc" id="L202">				BiddableScheduleInstance bidSchedInst1 = bidSched1.getOptMethods().getFirstAvailBiddableSchedInst();</span>
<span class="nc" id="L203">				int bidSched1Duration = bidSchedInst1.getOptMethods().getDuration();</span>

<span class="nc" id="L205">				BiddableScheduleInstance bidSchedInst2 = bidSched2.getOptMethods().getFirstAvailBiddableSchedInst();</span>
<span class="nc" id="L206">				int bidSched2Duration = bidSchedInst2.getOptMethods().getDuration();</span>

<span class="nc" id="L208">				retval = bidSched1Duration - bidSched2Duration;</span>
<span class="nc" id="L209">				break;</span>

			case BiddableSchedule.SORTBY_BONUSASSIGNED:
<span class="nc" id="L212">				retval = bidSched1.getBonusPoints() - bidSched2.getBonusPoints();</span>
<span class="nc" id="L213">				break;</span>

			case BiddableSchedule.SORTBY_NUMBER_AVAIALBLE:
<span class="nc" id="L216">				retval = bidSched1.getNumOfAvailableInstances() - bidSched2.getNumOfAvailableInstances();</span>
<span class="nc" id="L217">				break;</span>
			
			case BiddableSchedule.SORTBY_DESCRIPTION:
<span class="nc bnc" id="L220" title="All 2 branches missed.">				m_collator = (m_collator == null) ? m_localizer.getCollator() : m_collator;</span>
<span class="nc" id="L221">				String desc1 = getDescription(bidSched1);</span>
<span class="nc" id="L222">				String desc2 = getDescription(bidSched2);</span>
<span class="nc" id="L223">				retval = m_collator.compare(desc1, desc2);</span>
<span class="nc" id="L224">				break;</span>

			default:
<span class="nc" id="L227">				throw RequestUtil.createIllegalArgumentException((new Integer(m_sortBy)).toString(), null);</span>
            }
        }
        else
        {
            //This must be a day column. 
<span class="nc" id="L233">            int sortType = BiddableSchedule.getType(m_sortBy);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (sortType == BiddableSchedule.SORTBY_STARTTIME)</span>
            {
<span class="nc" id="L236">                retval = this.compareBidSchedule(bidSched1, bidSched2, BiddableSchedule.SORTBY_STARTTIME);</span>
            }
<span class="nc bnc" id="L238" title="All 2 branches missed.">            else if (sortType == BiddableSchedule.SORTBY_ENDTIME)</span>
            {
<span class="nc" id="L240">                retval = this.compareBidSchedule(bidSched1, bidSched2, BiddableSchedule.SORTBY_ENDTIME);</span>
            }
<span class="nc bnc" id="L242" title="All 2 branches missed.">            else if (sortType == BiddableSchedule.SORTBY_LENGTH)</span>
            {
<span class="nc" id="L244">                retval = this.compareBidSchedule(bidSched1, bidSched2, BiddableSchedule.SORTBY_LENGTH);</span>
            }
            else
            {
<span class="nc" id="L248">                throw RequestUtil.createIllegalArgumentException((new Integer(m_sortBy)).toString(), null);</span>
            }
        }
        
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if( retval == 0 )</span>
        {
<span class="nc bnc" id="L254" title="All 2 branches missed.">        	return this.m_next != null ? this.m_next.compare(arg0, arg1) : 0;</span>
        }
        else
        {
<span class="nc bnc" id="L258" title="All 2 branches missed.">           return (m_sortDir == SupportNavigation.SORT_ASCENDING)?retval:-retval;</span>
        }
    }

	private int comparePreference(BiddableSchedule bidSched1, BiddableSchedule bidSched2) {
<span class="nc" id="L263">		return RmUtil.integerCompare(getPreference(bidSched1), getPreference(bidSched2));</span>
	}

	private int getPreference(BiddableSchedule bidSched) {
<span class="nc" id="L267">		Integer pref = bidSched.gettUnsubmittedSortPreferenceForEmployee();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">		if (pref != null) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">			return pref &lt; 1 ? Integer.MAX_VALUE : pref;</span>
		}
<span class="nc" id="L271">		ShiftBidRequest bidSchedReq = bidSched.getOptMethods().getShiftBidRequestForShiftBidder();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">		if (bidSchedReq == null) {</span>
<span class="nc" id="L273">			return Integer.MAX_VALUE;</span>
		}
<span class="nc" id="L275">		return bidSchedReq.getPreference();</span>
	}

    private int compareBidSchedule( BiddableSchedule bidSched1, BiddableSchedule bidSched2, int mode)
    {
<span class="nc" id="L280">    	int retval = -1;</span>
    	
        // Note: If no shift found, then the bidSched must be ordered so that it appears
        // last in the sorted list.
<span class="nc" id="L284">    	BiddableScheduleInstance bidSchedInst1 = bidSched1.getOptMethods().getFirstAvailBiddableSchedInst();</span>
<span class="nc" id="L285">        BiddableScheduleInstance bidSchedInst2 = bidSched2.getOptMethods().getFirstAvailBiddableSchedInst();</span>

<span class="nc bnc" id="L287" title="All 4 branches missed.">        if (bidSchedInst1 == null &amp;&amp; bidSchedInst2 == null )</span>
<span class="nc" id="L288">        	retval = 0;</span>

<span class="nc bnc" id="L290" title="All 2 branches missed.">        if( retval != 0 )</span>
        {
	        // if the bidSched has no bidSchedInstances available.
<span class="nc bnc" id="L293" title="All 2 branches missed.">	        if (bidSchedInst1 == null) {</span>
	            // bidScheds with 'no shift' must appear last in ascending order. 
<span class="nc" id="L295">	            return 1;</span>
	        }
	        
	        // if the bidSched has no bidSchedInstances available.
<span class="nc bnc" id="L299" title="All 2 branches missed.">	        if (bidSchedInst2 == null) {</span>
	            // bidScheds with 'no shift' must appear last in ascending order. 
<span class="nc" id="L301">	            return -1;</span>
	        }
        
<span class="nc" id="L304">            int dayOfWeek = BiddableSchedule.getDayOfWeek(m_sortBy);</span>
<span class="nc" id="L305">            int weekNum = BiddableSchedule.getWeek(m_sortBy);</span>

<span class="nc" id="L307">            TimeRange weekRange = null;</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">            if (m_weekRanges != null)</span>
<span class="nc" id="L309">                weekRange = m_weekRanges[weekNum];</span>
            
<span class="nc" id="L311">	        ShiftAssignment bidSched1SA = </span>
<span class="nc" id="L312">	            bidSchedInst1.getOptMethods().getShiftAssignmentForDayOfWeek(dayOfWeek, weekRange, m_calWithTZ);</span>
	
<span class="nc" id="L314">	        ShiftAssignment bidSched2SA = </span>
<span class="nc" id="L315">	            bidSchedInst2.getOptMethods().getShiftAssignmentForDayOfWeek(dayOfWeek, weekRange, m_calWithTZ);</span>

<span class="nc bnc" id="L317" title="All 4 branches missed.">	        if( bidSched1SA == null &amp;&amp; bidSched2SA == null )</span>
<span class="nc" id="L318">	        	retval = 0;</span>
	        
<span class="nc bnc" id="L320" title="All 2 branches missed.">	        if( retval != 0 )</span>
	        {
		        // bidScheds with 'no shift' must appear last in ascending order. 
<span class="nc bnc" id="L323" title="All 2 branches missed.">		        if (bidSched1SA == null ) </span>
<span class="nc" id="L324">		        	retval = 1;</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">		        else if (bidSched2SA == null) </span>
<span class="nc" id="L326">		        	retval = -1;</span>
		        else
<span class="nc bnc" id="L328" title="All 4 branches missed.">			        switch( mode )</span>
			        {
			        	case BiddableSchedule.SORTBY_STARTTIME:
<span class="nc" id="L331">			        		retval = getDisplayStartTime(bidSched1SA).compareTo(getDisplayStartTime(bidSched2SA));</span>
<span class="nc" id="L332">			        		break;</span>
	
			        	case BiddableSchedule.SORTBY_ENDTIME: 
<span class="nc" id="L335">				        	retval = bidSched1SA.getEndTime().compareTo( bidSched2SA.getEndTime());</span>
<span class="nc" id="L336">				        	break;</span>
				        	
			        	case BiddableSchedule.SORTBY_LENGTH: 
<span class="nc" id="L339">				        	retval = getDisplayDuration(bidSched1SA) - getDisplayDuration(bidSched2SA);</span>
				        	break;
			        }
	        }
        }

<span class="nc" id="L345">        return retval;</span>
    }   
    
    /**
     * Get the display start time of a ShiftAssignment.
     * &lt;P&gt;
     *  @return  Date - event start time
     */
     public static Date getDisplayStartTime(ShiftAssignment sa)
     {
<span class="nc" id="L355">         Date startTime = sa.getFieldValueDate(ShiftAssignmentFields.STARTTIME);</span>
    
         //Hack to treat initial NO_ACTIVITY events as not part of the shift
<span class="nc" id="L358">         Collection shiftEventAssignments = sa.getChildren();</span>
<span class="nc bnc" id="L359" title="All 4 branches missed.">         if (shiftEventAssignments != null &amp;&amp; !shiftEventAssignments.isEmpty())</span>
         {
<span class="nc" id="L361">             Iterator it = shiftEventAssignments.iterator();</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">             while (it.hasNext())</span>
             {
<span class="nc" id="L364">                 ShiftEventAssignment sea = (ShiftEventAssignment)it.next();</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">                 if (sea.getActivityID().toInt() == Activity.NO_ACTIVITY &amp;&amp;</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                            sea.getStartTime().equals(sa.getStartTime())){</span>
<span class="nc" id="L367">                     startTime = sea.getEndTime();</span>
<span class="nc" id="L368">                     break;</span>
                 }
<span class="nc" id="L370">             }</span>
         }
<span class="nc" id="L372">         return startTime;</span>
     }

    /**
     * Get the display duration of a ShiftAssignment.
     * &lt;P&gt;
     *  @return int - duration (in minutes) of the event
     */
    public static int getDisplayDuration(ShiftAssignment sa)
    {
<span class="nc" id="L382">        int duration = sa.getFieldValueInt(ShiftAssignmentFields.DURATION);</span>
    
        //Hack to treat initial NO_ACTIVITY events as not part of the shift
<span class="nc" id="L385">        Collection shiftEventAssignments = sa.getChildren();</span>
<span class="nc bnc" id="L386" title="All 4 branches missed.">        if (shiftEventAssignments != null &amp;&amp; !shiftEventAssignments.isEmpty())</span>
        {
<span class="nc" id="L388">            Iterator it = shiftEventAssignments.iterator();</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">            while (it.hasNext())</span>
            {
<span class="nc" id="L391">                ShiftEventAssignment sea = (ShiftEventAssignment)it.next();</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">                if (sea.getActivityID().toInt() == Activity.NO_ACTIVITY &amp;&amp;</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">                          sea.getStartTime().equals(sa.getStartTime())){</span>
<span class="nc" id="L394">                    duration = duration - sea.getDuration();</span>
<span class="nc" id="L395">                    break;</span>
                }
<span class="nc" id="L397">            }</span>
        }
<span class="nc" id="L399">        return duration;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>