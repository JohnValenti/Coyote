<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ForecastProfileDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.ejb.bbm.forecast.ejb</a> &gt; <span class="el_source">ForecastProfileDAO.java</span></div><h1>ForecastProfileDAO.java</h1><pre class="source lang-java linenums">package com.verint.ejb.bbm.forecast.ejb;

import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueueFieldInfo;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.dao.OneToManyRelationship;
import com.bluepumpkin.ejb.bbm.dao.RichObjectDAO;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastInstanceFieldInfo;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.verint.ejb.bbm.forecast.model.ForecastProfile;
import com.verint.ejb.bbm.forecast.model.ForecastProfileFieldInfo;

public class ForecastProfileDAO extends RichObjectDAO&lt;ForecastProfile&gt; {
	
	// meta data information
<span class="fc" id="L29">	private static ForecastProfileFieldInfo m_fieldInfo = new ForecastProfileFieldInfo();</span>
	
	private ProfileComponentDAO m_pcDAO;
	
	@Override
	protected FieldInfo getFieldInfo() {
<span class="fc" id="L35">		return m_fieldInfo;</span>
	}
	
	public ForecastProfileDAO() {
<span class="fc" id="L39">		super();</span>
<span class="fc" id="L40">	}</span>
	
	public ForecastProfileDAO(Jdmo dmo) {
<span class="nc" id="L43">		super(dmo);</span>
<span class="nc" id="L44">	}</span>

	protected void buildDBRelationships() {
<span class="fc" id="L47">		m_pcDAO = new ProfileComponentDAO(m_dmo);</span>

<span class="fc" id="L49">		addRelationship(new OneToManyRelationship(this, m_pcDAO, getFieldInfo().getFieldIndexByName(&quot;ID&quot;),</span>
<span class="fc" id="L50">				m_pcDAO.getFieldInfo().getFieldIndexByName(&quot;FORECASTPROFILEID&quot;), ForecastProfileFieldInfo.PROFILECOMPONENT_RELATIONSHIP_KEY));</span>
		
<span class="fc" id="L52">	}</span>
	
	@Override
	protected Map&lt;Integer, ? extends FieldInfo&gt; getForeignKeyFieldInfo() {
<span class="fc" id="L56">		Map&lt;Integer, FieldInfo&gt; retVal = new HashMap&lt;Integer, FieldInfo&gt;(super.getForeignKeyFieldInfo());</span>
<span class="fc" id="L57">		retVal.put(ForecastProfileFieldInfo.FORECASTPROFILE_SPQUEUEID, new SPQueueFieldInfo());</span>
<span class="fc" id="L58">		retVal.put(ForecastProfileFieldInfo.FORECASTPROFILE_FORECASTINSTANCEID, new ForecastInstanceFieldInfo());</span>
<span class="fc" id="L59">		return retVal;</span>
	}

	@Override
	protected ForecastProfile createValueObject() {
<span class="fc" id="L64">		return new ForecastProfile();</span>
	}
	

	/**
	 * Finds forecast profile objects that fill the role defined by the parameters.
	 * The ForecastProfile table is used in different ways. 
	 * &lt;p&gt;
	 * &lt;ol&gt;
	 * &lt;li&gt;It is used for active forecasts. In this case, forecastInstanceID is null and 
	 * spQueueID is not null. For active forecasts, records that fill the same role have 
	 * null forecastInstanceID, the same spQueueID, and the same start date
	 * &lt;li&gt;It is used for forecast instances, including base forecast and named instances.
	 * In this case, forecastInstanceID is not null and spQueueID is not null. For instances,
	 * records that fill the same role have the same forecastInstanceID, the same spQueueID,
	 * and the same start date.
	 * &lt;li&gt;It is used for manually saved forecast profiles. In this case, forecastInstanceID is
	 * null and spQueueID is null. For manually saved forecast profiles, records that fill the
	 * same role will have null forecastInstanceID, null SPQueueID, and the same name.
	 * &lt;/ol&gt;
	 * @param spQueueID
	 * @param name
	 * @param forecastInstanceID
	 * @param startDate
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;ForecastProfile&gt; getObjectsWithRole(ID spQueueID, String name, ID forecastInstanceID, Date startDate) throws BbmFinderException {
<span class="fc" id="L92">		StringBuffer sql = new StringBuffer(&quot; &quot;);</span>

<span class="fc" id="L94">		sql.append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_SPQUEUEID));</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">		if (spQueueID == null) {</span>
<span class="nc" id="L96">			sql.append(&quot; IS NULL &quot;);</span>
		} else {
<span class="fc" id="L98">			sql.append(&quot; = &quot;).append(JdmoUtil.asSqlLiteral(convertSIDToDEID(spQueueID, new SPQueueFieldInfo())));</span>
		}

<span class="pc bpc" id="L101" title="1 of 2 branches missed.">		if (spQueueID == null) {</span>
<span class="nc" id="L102">			sql.append(&quot; AND &quot;);</span>
<span class="nc" id="L103">			sql.append(&quot;(&quot;);</span>
<span class="nc" id="L104">			sql.append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_NAME));</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">			if (name == null) {</span>
<span class="nc" id="L106">				sql.append(&quot; IS NULL &quot;);</span>
			} else {
<span class="nc" id="L108">				sql.append(&quot; = &quot;).append(JdmoUtil.asSqlLiteral(name));</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">				if (StringUtil.isEmpty(name))</span>
<span class="nc" id="L110">					sql.append(&quot; OR &quot;).append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_NAME)).append(&quot; IS NULL &quot;);</span>
			}
<span class="nc" id="L112">			sql.append(&quot;)&quot;);</span>
		}

<span class="fc" id="L115">		sql.append(&quot; AND &quot;);</span>
<span class="fc" id="L116">		sql.append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_FORECASTINSTANCEID));</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">		if (forecastInstanceID == null) {</span>
<span class="fc" id="L118">			sql.append(&quot; IS NULL &quot;);</span>
		} else {
<span class="fc" id="L120">			sql.append(&quot; = &quot;).append(JdmoUtil.asSqlLiteral(convertSIDToDEID(forecastInstanceID, new ForecastInstanceFieldInfo())));</span>
		}
		
<span class="pc bpc" id="L123" title="3 of 4 branches missed.">		if (spQueueID != null || forecastInstanceID != null) {</span>
<span class="fc" id="L124">			sql.append(&quot; AND &quot;);</span>
<span class="fc" id="L125">			sql.append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_STARTDATE));</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">			if (startDate == null) {</span>
<span class="nc" id="L127">				sql.append(&quot; IS NULL &quot;);</span>
			} else {
<span class="fc" id="L129">				sql.append(&quot; = &quot;).append(JdmoUtil.asSqlLiteral(startDate));</span>
			}
		}
<span class="fc" id="L132">		return getObjects(sql.toString());</span>
	}

	public Collection&lt;ForecastProfile&gt; getObjectsByForecastInstanceID(ID forecastInstanceID) throws BbmFinderException {
<span class="fc" id="L136">		forecastInstanceID = DAOUtil.mapIDToDEID(forecastInstanceID, new ForecastInstanceFieldInfo());</span>
<span class="fc" id="L137">		return getObjects(m_fieldInfo.getFieldName(m_fieldInfo.FORECASTPROFILE_FORECASTINSTANCEID) + &quot; = &quot; + JdmoUtil.asSqlLiteral(forecastInstanceID));</span>
	}
	
	//QC-117409 (from QC-115976) ESR 4113828 Port to 11.2
	/**
	 * Returns the objects matching the forecastInstanceID and the spQueueID
	 * @param forecastInstanceID
	 * @param spQueueIDs
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;ForecastProfile&gt; getObjectsByForecastInstanceAndSPQueueID(ID forecastInstanceID, Collection &lt;? extends ID&gt; spQueueIDs) 
		throws BbmFinderException {
<span class="nc" id="L150">		StringBuffer sql = new StringBuffer(&quot; &quot;);</span>
<span class="nc" id="L151">		sql.append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_FORECASTINSTANCEID));</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">		if (forecastInstanceID == null) {</span>
<span class="nc" id="L153">			sql.append(&quot; IS NULL &quot;);</span>
		} else {
<span class="nc" id="L155">			sql.append(&quot; = &quot;).append(JdmoUtil.asSqlLiteral(convertSIDToDEID(forecastInstanceID, new ForecastInstanceFieldInfo())));</span>
		}
		
<span class="nc bnc" id="L158" title="All 4 branches missed.">		if (spQueueIDs != null &amp;&amp; !spQueueIDs.isEmpty()) {</span>
<span class="nc" id="L159">			sql.append(&quot; AND &quot;);</span>
<span class="nc" id="L160">			sql.append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_SPQUEUEID));</span>
<span class="nc" id="L161">			sql.append(&quot; IN &quot;);</span>
			try {
<span class="nc" id="L163">				sql.append(getDMO().createInClause(convertSIDsToDEIDs(spQueueIDs, new SPQueueFieldInfo())));</span>
<span class="nc" id="L164">			} catch (JdmoException e) {</span>
<span class="nc" id="L165">				throw new BbmFinderException(e);</span>
<span class="nc" id="L166">			}</span>
			
		}
		
<span class="nc" id="L170">		return getObjects(sql.toString());</span>
	}

	
	public void deleteObjectsByInstanceAndSPQueues(ID forecastInstanceID, Collection&lt;? extends ID&gt; spQueueIDs) throws BbmRemoveException {
		try {
<span class="nc" id="L176">			Collection&lt;ID&gt; idCol = new HashSet&lt;ID&gt;();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">			for (ForecastProfile fp : getObjectsByForecastInstanceID(forecastInstanceID)) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">				if (spQueueIDs.contains(fp.getSPQueueID())) {</span>
<span class="nc" id="L179">					idCol.add(fp.getID());</span>
				}
<span class="nc" id="L181">			}</span>
<span class="nc" id="L182">			deleteObjects(idCol);</span>
<span class="nc" id="L183">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L184">			throw new BbmRemoveException(e);</span>
<span class="nc" id="L185">		}</span>
<span class="nc" id="L186">	}</span>
	
	public Collection&lt;ForecastProfile&gt; getActive(Collection&lt;ID&gt; spQueueIDs) throws BbmFinderException {
		try {
<span class="fc" id="L190">			return getObjects(&quot; FORECASTINSTANCEID IS NULL AND SPQUEUEID in &quot; +</span>
<span class="fc" id="L191">					getDMO().createInClause(convertSIDsToDEIDs(spQueueIDs, new SPQueueFieldInfo())));</span>
<span class="nc" id="L192">		} catch (Exception ex) {</span>
<span class="nc" id="L193">			throw new BbmFinderException(ex);</span>
		}
	}
	
	public Collection&lt;ForecastProfile&gt; getObjectsBySPQueueID(ID spQueueID) throws BbmFinderException {
<span class="nc" id="L198">		Collection&lt;ID&gt; deIDs = convertSIDsToDEIDs(Collections.singleton(spQueueID), new SPQueueFieldInfo());</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">		if (deIDs.isEmpty())</span>
<span class="nc" id="L200">			throw new BbmFinderException();</span>
<span class="nc" id="L201">		return getObjects(m_fieldInfo.getFieldName(m_fieldInfo.FORECASTPROFILE_SPQUEUEID) + &quot; = &quot; + JdmoUtil.asSqlLiteral(deIDs.iterator().next()));</span>
	}

	Collection&lt;ID&gt; convertSIDsToDEIDs(Collection&lt;? extends ID&gt; sIDs, FieldInfo fieldInfo) throws BbmFinderException {
<span class="fc" id="L205">		return DAOUtil.mapIDsToDEIDs(sIDs, fieldInfo).values();</span>
	}
	
	ID convertSIDToDEID(ID sID, FieldInfo fieldInfo) throws BbmFinderException {
<span class="fc" id="L209">		return DAOUtil.mapIDToDEID(sID, fieldInfo);</span>
	}


	public void deleteObjectsBySpQueueID(ID spQueueId) throws BbmRemoveException {
<span class="nc bnc" id="L214" title="All 2 branches missed.">		if (spQueueId == null)</span>
<span class="nc" id="L215">			return;</span>
		try {
<span class="nc" id="L217">			StringBuffer strSQL = new StringBuffer(30);</span>
<span class="nc" id="L218">			strSQL.append(&quot;delete from FORECASTPROFILE &quot;);</span>
<span class="nc" id="L219">			strSQL.append(&quot;where SID=(&quot;);</span>
<span class="nc" id="L220">			strSQL.append(&quot;select FORECASTPROFILE.SID from FORECASTPROFILE,SPQUEUE&quot;);</span>
<span class="nc" id="L221">			strSQL.append(&quot; where FORECASTPROFILE.SPQUEUEID=SPQUEUE.ID and SPQUEUE.SID=?)&quot;);</span>
			
<span class="nc" id="L223">			Object[] param = new Object[1];</span>
<span class="nc" id="L224">			param[0] = spQueueId;</span>
<span class="nc" id="L225">			getDMO().executePCommand(strSQL.toString(), param);</span>
<span class="nc" id="L226">		} catch(JdmoException e) {</span>
<span class="nc" id="L227">			throw new BbmRemoveException(e);</span>
<span class="nc" id="L228">		}</span>
<span class="nc" id="L229">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>