<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueAttributeFilterPickerPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute.filter</a> &gt; <span class="el_source">QueueAttributeFilterPickerPC.java</span></div><h1>QueueAttributeFilterPickerPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute.filter;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.workload.model.queueattribute.QueueAttributeFilter;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.witness.web.uif.jsp.HtmlTable;
import com.witness.web.uif.jsp.HtmlTableRow;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.filterbox.FilterBoxPC;
import com.witness.web.uif.pagecomponent.list.OptionData;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;

/**
 * Title:        NamedFilterBoxPC
 * Description:  Interface to access WITS Named Filter UI
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       Sankar Nair
 * @version      1.0
 */
public class QueueAttributeFilterPickerPC extends FilterBoxPC {
	
	private ResourceBundle  bbmBundle;
	
	/**
	 * Constructor
	 */
	public QueueAttributeFilterPickerPC(RequestContext context) {
<span class="fc" id="L44">		this(context, true, false);</span>
		
<span class="fc" id="L46">	}</span>
	
	
	
	public QueueAttributeFilterPickerPC(RequestContext context, boolean isInitDefaultFilter, boolean isDynRendering) {
<span class="fc" id="L51">		super(context);</span>
<span class="fc" id="L52">		setUseWrapper(false);</span>

//		addJSVariable(&quot;FILTER_BOX_NAME&quot;,&quot;\&quot;&quot; + QueueAttributeFilterUtil.NAMED_FILTER_NAME + &quot;\&quot;&quot; );
<span class="fc" id="L55">		setIsBottomRowEnabled(false);</span>
<span class="fc" id="L56">		setName(&quot;applicationMediator&quot;);</span>
		/*
		 * There is a possiblity that the filter which user selected previously
		 * is no more visible to user or is no more available in the system. So the below
		 * check is introduced to ensure that the wrong selected filter Id is not used by the application
		 */
<span class="fc" id="L62">		String selectedID = m_context.getUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER);</span>
<span class="fc" id="L63">		boolean found = false;</span>
		//No filter previously selected by user. Checking for Default filter of user
<span class="pc bpc" id="L65" title="2 of 6 branches missed.">		if(StringUtil.isEmptyOrWhiteSpace(selectedID)|| QueueAttributeFilter.DELETED_ID.toString().equals(selectedID) || QueueAttributeFilter.BLANK_ID.toString().equals(selectedID)) {</span>
			//m_context.setUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_DEFAULT_FILTER, &quot;51&quot;);
<span class="fc" id="L67">			selectedID = m_context.getUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_DEFAULT_FILTER);</span>
		}
<span class="pc bpc" id="L69" title="5 of 6 branches missed.">		if(StringUtil.isEmptyOrWhiteSpace(selectedID) || QueueAttributeFilter.DELETED_ID.toString().equals(selectedID) || QueueAttributeFilter.BLANK_ID.toString().equals(selectedID)) {</span>
<span class="fc" id="L70">			found = true;</span>
		} else {
			try {
<span class="nc" id="L73">				Collection&lt;QueueAttributeFilter&gt; filters = getVisibleFilters();</span>
<span class="nc" id="L74">				Iterator&lt;QueueAttributeFilter&gt; iter = filters.iterator();</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">				while(iter.hasNext()) {</span>
<span class="nc" id="L76">					QueueAttributeFilter filter = iter.next();</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">					if(filter.getID().equals(new ID(selectedID))) {</span>
<span class="nc" id="L78">						found = true;</span>
					}
<span class="nc" id="L80">				}</span>
<span class="nc" id="L81">			} catch (Exception e) {</span>
<span class="nc" id="L82">			}</span>
		}
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">		if(!found) {</span>
		    // QC 137971 - Do NOT change user property if it is DELETED to make sure when extractParameters() is called, we can detect and ignore request parameter
<span class="nc bnc" id="L86" title="All 2 branches missed.">		    if (!QueueAttributeFilter.DELETED_ID.toString().equals(m_context.getUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER))) {</span>
<span class="nc" id="L87">		        m_context.setUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER, QueueAttributeFilter.BLANK_ID.toString());</span>
		    }
<span class="nc" id="L89">			selectedID = QueueAttributeFilter.BLANK_ID.toString();</span>
		}
<span class="fc" id="L91">		super.setSelectedFilterName(selectedID);</span>
		//if(m_context.getUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER) == null)	{
//			m_listbox.setSelected(QueueAttributeFilter.BLANK_ID.toString());
//		}
<span class="fc" id="L95">		bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L96">		m_displayLabels = false;</span>
<span class="fc" id="L97">	}</span>


	/**
	 * Initialize Component For Display
	 */
	
	public void initForDisplay() {
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">		if (m_isInitializedForDisplay) return;</span>
		else {
<span class="fc" id="L107">			super.initForDisplay(); </span>
<span class="fc" id="L108">			QueueAttributeFilterUtil.addPopupArgs(this, true);</span>
		}
<span class="fc" id="L110">	}</span>
	
	
	/**
	 * Set Selected Filter
	 */
	public void setSelectedFilterName(String filterName) {
		//Current ID which is retrieved is a deleted ID. So we will reset the selection to no filter ID
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">		if(QueueAttributeFilter.DELETED_ID.toString().equals(m_context.getUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER))) {</span>
		//if(&quot;-1&quot;.equals(m_context.getUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER))) {
<span class="nc" id="L120">			filterName = QueueAttributeFilter.BLANK_ID.toString();</span>
<span class="nc" id="L121">			m_listbox.setSelected(filterName);</span>
		}
		// Ignore Selection Option Refresh
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">		if (REFRESH.equals(filterName)) return;</span>
<span class="fc" id="L125">		String lastEditedFilter = m_context.getUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER_LAST_EDITED);</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">		if(!StringUtil.isEmptyOrWhiteSpace(lastEditedFilter)) {</span>
<span class="nc" id="L127">			filterName = lastEditedFilter;</span>
<span class="nc" id="L128">			m_context.setUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER_LAST_EDITED, null);</span>
		}
<span class="fc" id="L130">		super.setSelectedFilterName(filterName);</span>
<span class="fc" id="L131">		m_context.setUserProperty(UserPreferenceKeys.QUEUE_ATTRIBUTE_FILTER, filterName);</span>
<span class="fc" id="L132">	}</span>

	private Collection&lt;QueueAttributeFilter&gt; getVisibleFilters() throws Exception {
<span class="fc" id="L135">		Collection orgIDsIDOnly = OrganizationModelHandler.getAllOrgsInUserScope(m_context, m_context.getUser());</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">		if(orgIDsIDOnly == null)</span>
<span class="nc" id="L137">			orgIDsIDOnly = Collections.EMPTY_LIST;</span>
<span class="fc" id="L138">		ArrayList&lt;ID&gt; orgIDList = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L139">		Iterator orgIter = orgIDsIDOnly.iterator();</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">		while(orgIter.hasNext()) {</span>
<span class="fc" id="L141">			Organization org = (Organization)orgIter.next();</span>
<span class="fc" id="L142">			orgIDList.add(org.getID());</span>
<span class="fc" id="L143">		}</span>
		
<span class="fc" id="L145">		return QueueAttributeFilterModelHandler.getPublicQueueAttributeFilterForUser(m_context.getUser().getID(), orgIDList);</span>
		
	}

	protected Collection getFilterOptions(boolean addBlankRow) {
		try {
<span class="fc" id="L151">			Collection filterNames = null;</span>
<span class="fc" id="L152">			ArrayList filter = new ArrayList();</span>
			
<span class="fc" id="L154">			Collection&lt;QueueAttributeFilter&gt; filters = getVisibleFilters();</span>
<span class="fc" id="L155">			Iterator&lt;QueueAttributeFilter&gt; iter = filters.iterator();</span>
			
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">			if(addBlankRow) {</span>
<span class="fc" id="L158">				filter.add(new StringsPair(QueueAttributeFilter.BLANK_ID.toString(), i18n(bbmBundle, BbmWebBundleKey.QUEUE_ATTRIBUTE_NO_FILTER)));</span>
<span class="fc" id="L159">				filter.add( FILTER_OPTION_DIVIDER );</span>
			}
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">			while(iter.hasNext()) {</span>
<span class="nc" id="L162">				QueueAttributeFilter item = iter.next();</span>
<span class="nc" id="L163">				filter.add(new StringsPair(item.getID().toString(), item.getName()));	</span>
<span class="nc" id="L164">			}</span>
<span class="fc" id="L165">			return filter;</span>
<span class="nc" id="L166">		} catch(Exception e) {</span>
<span class="nc" id="L167">			e.printStackTrace();</span>
<span class="nc" id="L168">			handleUnableToLoadDataError(log, e);</span>
		}
<span class="nc" id="L170">		return Collections.EMPTY_LIST;</span>
	}
	
	public void initFilter(String selectedFilter, boolean addActiveFilter) {
<span class="nc" id="L174">		initFilter(getFilterOptions(addActiveFilter), selectedFilter);</span>
<span class="nc" id="L175">	}</span>
	
	/**
	 * Initialize with Default Filters
	 */
	public void initFilter(boolean addActiveFilter) {
		// Add User filters
<span class="fc" id="L182">		Collection userFilter = getFilterOptions(addActiveFilter);</span>
<span class="fc" id="L183">		initFilter(userFilter, getSelectedFilterName());</span>
<span class="fc" id="L184">	}</span>
	
	public ID getQueueAttributeID() {
<span class="fc bfc" id="L187" title="All 2 branches covered.">		if(getSelectedFilterName() == null)</span>
<span class="fc" id="L188">			return QueueAttributeFilter.BLANK_ID;</span>
<span class="fc" id="L189">		return new ID(getSelectedFilterName()); </span>
	}

	/**
	 * Overwrite ExtractParameters to check for modifications in workpane context date hidden fields
	 * This date hiddent fields are required and specific to viewing context for employee filters enhancement.
	 * This date fields hold workpane context dates. These are populated using Javascript.
	 * @param request The HttpRequest
	 * @return true if no errors were encountered, otherwise false
	 */
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc" id="L200">		boolean success = super.extractParameters(request);</span>
<span class="fc" id="L201">		String namedFilter = getSelectedFilterName(); //By default the ID will be extracted as we are passing the strings pair</span>
<span class="fc" id="L202">		return success;</span>
	}
	
	
	/**
	 * Add Default Filter Options
	 *
	 * Options: REFRESH, CREATE, EDIT
	 */
	protected void addDefaultFilterOptions(List filters) {
<span class="fc" id="L212">		filters.add( FILTER_OPTION_DIVIDER );</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">		if (m_isRefreshOptionEnabled) {</span>
<span class="fc" id="L214">			filters.add( new OptionData( i18n(m_bundle, UIFWebBundleKey.FILTER_REFRESH), REFRESH));</span>
		}
<span class="fc" id="L216">		filters.add( createPopupFilterOption(m_bundle, UIFWebBundleKey.FILTER_CREATE_NAMED_FILTER) );</span>
<span class="fc" id="L217">		filters.add( createPopupFilterOption(m_bundle, UIFWebBundleKey.FILTER_EDIT_NAMED_FILTER));</span>
<span class="fc" id="L218">	}</span>
	
	protected short getListBoxDisplayMaxWidth() {
<span class="fc" id="L221">		return 260;//PageKeys.FILTER_MAX_WIDTH + 100;</span>
	}

	protected HtmlTableRow createTopRow() {
<span class="fc" id="L225">		ArrayList rowcells = new ArrayList();</span>
<span class="fc" id="L226">		rowcells.add( createLabelCell(getHeader()).toString() + m_listbox.toString());</span>
<span class="fc" id="L227">		return new HtmlTableRow(rowcells);</span>
	}
	
	
	public String getHtmlDisplay() {
		// initialize the filters in the listbox
<span class="fc" id="L233">		m_listbox.setOptions(getFilters());</span>

		
<span class="fc" id="L236">		HtmlTable outer_table = new HtmlTable(&quot;0&quot;, &quot;0&quot;, &quot;0&quot;);</span>
<span class="fc" id="L237">		outer_table.setWidth(&quot;104&quot;);</span>
<span class="fc" id="L238">		outer_table.add( createTopRow() );</span>

		// Generate HTML output
<span class="fc" id="L241">		StringBuffer buff = new StringBuffer(1024);</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">		if (useWrapper()) buff.append(&quot;\n&lt;div style=\&quot;margin-top:12px; margin-bottom:7px;\&quot;&gt;&quot;);</span>

		//buff.append(outer_table);
		//buff.append(createLabelCell(getHeader()).toString() + &quot; &quot; + m_listbox);
<span class="fc" id="L246">		buff.append(m_listbox.toString());</span>
<span class="fc" id="L247">		buff.append(HtmlUtil.makeHiddenInput(getName(), &quot;&quot;));</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">		if (useWrapper()) buff.append(&quot;\n&lt;/div&gt;&quot;);</span>

<span class="fc" id="L250">		return buff.toString();</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>