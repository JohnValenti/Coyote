<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MinMaxHoursPerDayHV.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.validation</a> &gt; <span class="el_source">MinMaxHoursPerDayHV.java</span></div><h1>MinMaxHoursPerDayHV.java</h1><pre class="source lang-java linenums">/*
 * Created on Sep 22, 2003
 *
 * To change this generated comment go to
 * Window&gt;Preferences&gt;Java&gt;Code Generation&gt;Code and Comments
 */
package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.validation;

import java.text.DateFormat;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;

import org.apache.log4j.Priority;

import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftEventAssignment;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;


<span class="nc" id="L35">public class MinMaxHoursPerDayHV implements Validator {</span>
<span class="nc" id="L36">    private static final Priority m_tracePriority = RequestUtil.m_defaultTracePriority;</span>

<span class="nc" id="L38">    private final static String m_className = MinMaxHoursPerDayHV.class.getName();</span>
<span class="nc" id="L39">    private static final Category m_cat = Log.initCategory(m_className);</span>

    public ValidationResult validate(Validatable validatable) throws Exception {
<span class="nc" id="L42">        m_cat.log(m_tracePriority, &quot;Validation Rule: &quot; + m_className + &quot; started&quot;);</span>

        try {
<span class="nc" id="L45">            ShiftBidRequest sbReq = (ShiftBidRequest) validatable;</span>
<span class="nc" id="L46">            ShiftBidRequestValidationCache sbReqValCache = sbReq.getValidationCacheSBR();</span>

            // rule only applies to multi shift auctions
<span class="nc" id="L49">            ShiftBidAuction shiftBidAuction = sbReq.getOptMethods().getShiftBidAuction();</span>

<span class="nc bnc" id="L51" title="All 2 branches missed.">            if (!shiftBidAuction.getIsMultiShift()) {</span>
<span class="nc" id="L52">            	return null;</span>
            }

<span class="nc" id="L55">            TimeZone empOrgTZ = sbReqValCache.getTimeZoneForOrg();</span>

<span class="nc" id="L57">            Calendar c = Calendar.getInstance(empOrgTZ);</span>
<span class="nc" id="L58">            int boundaryOffset = sbReqValCache.getOrg().getDayBoundaryOffset();</span>
<span class="nc" id="L59">            DateFormat dfShortInOrgTZ = DateFormat.getDateInstance(DateFormat.SHORT);</span>
<span class="nc" id="L60">            dfShortInOrgTZ.setTimeZone(empOrgTZ);</span>

<span class="nc" id="L62">            Map&lt;Date,Integer&gt; dateStrToShiftAssnMap = new HashMap&lt;Date, Integer&gt;();</span>
            // Pulling all assignments within this Bid as the validation is per Bid
            // And that's as per the requirement to create a fairness opportunity for all employees
<span class="nc" id="L65">            List&lt;ShiftAssignment&gt; shiftAssns = sbReq.getOptMethods().getShiftAssignments();</span>
<span class="nc" id="L66">            ValidationResult valResult = null;</span>

<span class="nc" id="L68">            int minHours = shiftBidAuction.getMinHoursPerDay();</span>
<span class="nc" id="L69">            int maxHours = shiftBidAuction.getMaxHoursPerDay();</span>

<span class="nc bnc" id="L71" title="All 4 branches missed.">            if(minHours==0 &amp;&amp; maxHours==0) {</span>
<span class="nc" id="L72">            	return null;</span>
            }

<span class="nc bnc" id="L75" title="All 2 branches missed.">            for (ShiftAssignment shiftAssn:shiftAssns) {</span>
            	//Get start of day
<span class="nc" id="L77">            	c.setTime(shiftAssn.getStartTime());</span>
<span class="nc" id="L78">            	c.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L79">        		c.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L80">        		c.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L81">        		c.add(Calendar.MINUTE, boundaryOffset);</span>
<span class="nc" id="L82">                Date d = c.getTime();</span>
<span class="nc" id="L83">                Integer duration = 0;</span>
                // check map to see if another shift assignment already exists for the same date.
<span class="nc bnc" id="L85" title="All 2 branches missed.">                if (dateStrToShiftAssnMap.containsKey(d)) {</span>
<span class="nc" id="L86">                	duration = dateStrToShiftAssnMap.get(d);</span>
                }

<span class="nc" id="L89">                duration = calculateDurationBasedOnPaidEvents(shiftAssn, duration);</span>

                //Check max
<span class="nc bnc" id="L92" title="All 4 branches missed.">                if (maxHours &gt; 0 &amp;&amp; duration&gt;(maxHours*60)) {</span>
<span class="nc" id="L93">                	valResult = ValidationUtil.setHardValidationResult(sbReq, RmEjbBundleKey.SBR_MAX_ORG_DAY,</span>
<span class="nc" id="L94">                			maxHours, new LocalDate(d, empOrgTZ), m_className);</span>
<span class="nc" id="L95">                	break;</span>
                }
<span class="nc" id="L97">                dateStrToShiftAssnMap.put(d, duration);</span>
<span class="nc" id="L98">            }</span>

<span class="nc bnc" id="L100" title="All 2 branches missed.">            if (minHours&gt;0) {</span>
            	//Check min
<span class="nc bnc" id="L102" title="All 2 branches missed.">            	for(Date day:dateStrToShiftAssnMap.keySet()) {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            		if(dateStrToShiftAssnMap.get(day)&lt;(minHours*60)) {</span>
<span class="nc" id="L104">            			valResult = ValidationUtil.setHardValidationResult(sbReq, RmEjbBundleKey.SBR_MIN_ORG_DAY,</span>
<span class="nc" id="L105">            					minHours, new LocalDate(day, empOrgTZ), m_className);</span>
<span class="nc" id="L106">                    	break;</span>
            		}
<span class="nc" id="L108">            	}</span>
            }

<span class="nc" id="L111">            return valResult;</span>
        }finally {
<span class="nc" id="L113">           m_cat.debug(&quot;Validation Rule: &quot; + m_className + &quot; done&quot;);</span>
        }
    }

    /*
     * Calculate the Paid hours duration only
     * If a shift Assignment has paid activity, then add SA duration and then deduct the unpaid Shift Event Assignment hours
     * If SA is unpaid, then directly add all the paid shift event assignment hours
     */
	protected Integer calculateDurationBasedOnPaidEvents(ShiftAssignment shiftAssn, Integer duration) {
<span class="nc" id="L123">		Collection&lt;ShiftEventAssignment&gt; sea = shiftAssn.getChildren();</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">		if (shiftAssn.getPaid()) {</span>
<span class="nc" id="L126">			duration += shiftAssn.getDuration();</span>
			// as we included the entire shift assignment, if there are shift events on top
			// verify if they are paid or not- if not, reduce the paid hours
<span class="nc bnc" id="L129" title="All 2 branches missed.">			for (ShiftEventAssignment shiftEventAssn:sea) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">				if (!shiftEventAssn.getPaid()) {</span>
<span class="nc" id="L131">					duration -= shiftEventAssn.getDuration();</span>
				}
<span class="nc" id="L133">			}</span>
		} else {
			//if shift assignment is not paid, then directly add the paid shift event durations
<span class="nc bnc" id="L136" title="All 2 branches missed.">			for (ShiftEventAssignment shiftEventAssn:sea) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">				if (shiftEventAssn.getPaid()) {</span>
<span class="nc" id="L138">					duration += shiftEventAssn.getDuration();</span>
				}
<span class="nc" id="L140">			}</span>
		}
<span class="nc" id="L142">		return duration;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>