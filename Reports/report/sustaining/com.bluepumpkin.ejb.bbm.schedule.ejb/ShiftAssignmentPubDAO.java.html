<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftAssignmentPubDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.schedule.ejb</a> &gt; <span class="el_source">ShiftAssignmentPubDAO.java</span></div><h1>ShiftAssignmentPubDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.schedule.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  DAO class for persistence of published ShiftAssignment objects
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, inc
 * @author       Greg Fichtenholtz
 * @version 1.0
 */
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignmentFields;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignmentPubFields;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftEventAssignment;
import com.bluepumpkin.ejb.bbm.schedule.util.ScheduleUtil;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.core.base.MultiUserException;

class ShiftAssignmentPubDAO extends EventAssignmentPubDAO&lt;ShiftAssignment&gt; {
	// meta data info.
<span class="nc" id="L38">	private static final FieldInfo FIELD_INFO = new ShiftAssignmentPubFields();</span>

	public ShiftAssignmentPubDAO() {
<span class="nc" id="L41">		super();</span>
<span class="nc" id="L42">	}</span>

	public ShiftAssignmentPubDAO(Jdmo dmo) {
<span class="nc" id="L45">		super(dmo);</span>
<span class="nc" id="L46">	}</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="nc" id="L50">		return FIELD_INFO;</span>
	}

	@Override
	protected ShiftAssignment createValueObject() {
<span class="nc" id="L55">		return new ShiftAssignment();</span>
	}

	/** override from base class */
	@Override
	protected DAOBase createChildDAO(int iType) {
		// only has one child object
<span class="nc bnc" id="L62" title="All 2 branches missed.">		if (iType == ShiftAssignmentFields.CHILD_SHIFT_EVENT) {</span>
<span class="nc" id="L63">			return new ShiftEventAssignmentPubDAO(m_dmo);</span>
		} else
<span class="nc" id="L65">			return null; // should never happen</span>
	}

	/**
	 * Overrides the base class to provide an instance of the DAO class that
	 * models unpublished shift assignments
	 */
	@Override
	protected ShiftAssignmentDAO getUnpublishedDAO() {
<span class="nc" id="L74">		return new ShiftAssignmentDAO(m_dmo);</span>
	}

	public HashMap&lt;ID, ShiftAssignment&gt; getLastShiftAssignments(Collection&lt;ID&gt; workResourceIDs) throws BbmFinderException {
		try {
<span class="nc" id="L79">			String inClauseForWorkResources = m_dmo.createInClause(workResourceIDs);</span>

<span class="nc" id="L81">			StringBuilder buf = new StringBuilder(200);</span>
<span class="nc" id="L82">			buf.append(&quot;A.WORKRESOURCEID IN &quot;);</span>
<span class="nc" id="L83">			buf.append(inClauseForWorkResources);</span>
<span class="nc" id="L84">			buf.append(&quot; AND A.STARTTIME &gt;= &quot;);</span>
<span class="nc" id="L85">			buf.append(&quot;(SELECT MAX(B.STARTTIME) FROM SHIFTASSIGNMENTPUB B &quot;);</span>
<span class="nc" id="L86">			buf.append(&quot; WHERE B.WORKRESOURCEID = A.WORKRESOURCEID &quot;);</span>
<span class="nc" id="L87">			buf.append(&quot;  AND B.WORKRESOURCEID IN &quot;);</span>
<span class="nc" id="L88">			buf.append(inClauseForWorkResources);</span>
<span class="nc" id="L89">			buf.append(&quot; )&quot;);</span>

<span class="nc" id="L91">			Collection&lt;ShiftAssignment&gt; listShifts = getObjects(buf.toString());</span>
<span class="nc" id="L92">			return ValueObjectUtil.indexBy(listShifts, ShiftAssignmentPubFields.WORKRESOURCEID);</span>
<span class="nc" id="L93">		} catch (JdmoException e) {</span>
<span class="nc" id="L94">			throw new BbmFinderException(e);</span>
		}
	}

	@Override
	public void deleteObjects(Collection&lt;? extends ID&gt; colIDs) throws BbmRemoveException {
<span class="nc bnc" id="L100" title="All 4 branches missed.">		if (colIDs == null || colIDs.isEmpty()) {</span>
<span class="nc" id="L101">			return;</span>
		}
		try {
			// delete child records in ShiftEventAssignmentPub first
<span class="nc" id="L105">			StringBuilder stmt = new StringBuilder(100);</span>
<span class="nc" id="L106">			stmt.append(&quot;DELETE SHIFTEVENTASSIGNMENTPUB WHERE SHIFTASSIGNMENTID IN &quot; + m_dmo.createInClause(colIDs));</span>
<span class="nc" id="L107">			m_dmo.execute(stmt.toString());</span>
			// delete records in ShiftAssignmentPub
<span class="nc" id="L109">			stmt = new StringBuilder(100);</span>
<span class="nc" id="L110">			stmt.append(&quot;DELETE SHIFTASSIGNMENTPUB WHERE ID IN &quot; + m_dmo.createInClause(colIDs));</span>
<span class="nc" id="L111">			m_dmo.execute(stmt.toString());</span>

<span class="nc" id="L113">		} catch (Exception ex) {</span>
<span class="nc" id="L114">			throw new BbmRemoveException(ex);</span>
<span class="nc" id="L115">		}</span>
<span class="nc" id="L116">	}</span>

	/** This is an override of the base class to set endtime based on duration */
	@Override
	public ID createObject(ShiftAssignment objValue, boolean bBatched) throws BbmCreateException {
<span class="nc" id="L121">		ShiftAssignment shift = objValue;</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">		if (objValue.isFieldValueSet(ShiftAssignmentFields.STARTTIME)</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">				&amp;&amp; objValue.isFieldValueSet(ShiftAssignmentFields.DURATION)) {</span>
<span class="nc" id="L124">			shift.setFieldValue(ShiftAssignmentFields.ENDTIME,</span>
<span class="nc" id="L125">					new Date(shift.getStartTime().getTime() + shift.getDuration() * ShiftAssignment.MILLIS_IN_ONE_MIN));</span>
		}
<span class="nc" id="L127">		return super.createObject(objValue, bBatched);</span>
	}

	// override the method defined in DAONode
	@Override
	public void updateObject(ShiftAssignment objValue) throws MultiUserException, BbmUpdateException {
<span class="nc" id="L133">		ShiftAssignment event = objValue;</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">		if (objValue.isFieldValueSet(ShiftAssignmentFields.STARTTIME)</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">				&amp;&amp; objValue.isFieldValueSet(ShiftAssignmentFields.DURATION)) {</span>
<span class="nc" id="L137">			event.setFieldValue(ShiftAssignmentFields.ENDTIME,</span>
<span class="nc" id="L138">					new Date(event.getStartTime().getTime() + event.getDuration() * ShiftAssignment.MILLIS_IN_ONE_MIN));</span>
		}

<span class="nc" id="L141">		super.updateObject(objValue);</span>
<span class="nc" id="L142">	}</span>

	public HashMap&lt;ID, Timestamp&gt; getLastPublishedShiftAssignmentStartTime(Collection&lt;ID&gt; workResourceIDs) throws BbmFinderException {
		try {
<span class="nc" id="L146">			HashMap&lt;ID, Timestamp&gt; map = new HashMap&lt;ID, Timestamp&gt;(workResourceIDs.size());</span>
<span class="nc" id="L147">			StringBuilder sb = new StringBuilder(200);</span>
<span class="nc" id="L148">			sb.append(&quot; select WORKRESOURCEID, MAX(STARTTIME) from SHIFTASSIGNMENTPUB &quot;);</span>
<span class="nc" id="L149">			sb.append(&quot; where WORKRESOURCEID IN &quot;).append(m_dmo.createInClause(workResourceIDs));</span>
<span class="nc" id="L150">			sb.append(&quot; group by WORKRESOURCEID&quot;);</span>

<span class="nc" id="L152">			JdmoRowset rs = m_dmo.createRowset(sb.toString());</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L154">				map.put(rs.getID(1), rs.getTimestamp(2));</span>
			}
<span class="nc" id="L156">			return map;</span>
<span class="nc" id="L157">		} catch (JdmoException e) {</span>
<span class="nc" id="L158">			throw new BbmFinderException(e);</span>
		}
	}

	

	/**
	 * Returns a collection of schedule events for multiple work resources
	 */
	public Collection&lt;Collection&lt;ShiftAssignment&gt;&gt; getEventsForWorkResources(Collection&lt;ID&gt; workResourceIDs, String strNativeTempName)
			throws BbmFinderException {

		// get shift events
<span class="nc" id="L171">		StringBuilder strSQL = new StringBuilder(200);</span>
<span class="nc" id="L172">		strSQL.append(&quot; shiftassignmentid in (select s.id from shiftassignmentpub s , &quot;</span>
				+ strNativeTempName
				+ &quot; t where s.workresourceid = t.workresourceid and s.starttime &lt; t.endtime and s.endtime &gt; t.starttime)&quot;);

<span class="nc" id="L176">		Collection&lt;ShiftEventAssignment&gt; shiftEvents = getShiftEventAssignment(strSQL.toString());</span>

		// get shifts
<span class="nc" id="L179">		strSQL = new StringBuilder(200);</span>
<span class="nc" id="L180">		strSQL.append(&quot; id in (select s.id from shiftassignmentpub s , &quot;</span>
				+ strNativeTempName
				+ &quot; t where s.workresourceid = t.workresourceid and s.starttime &lt; t.endtime and s.endtime &gt; t.starttime)&quot;);

<span class="nc" id="L184">		Collection&lt;ShiftAssignment&gt; shifts = getObjectsWithoutChild(strSQL.toString());</span>

<span class="nc" id="L186">		return buildAndGroupShiftAssignment(workResourceIDs, shifts, shiftEvents);</span>

	}

	static Collection&lt;Collection&lt;ShiftAssignment&gt;&gt; buildAndGroupShiftAssignment(Collection&lt;ID&gt; workResourceIDs, Collection&lt;ShiftAssignment&gt; shifts, Collection&lt;ShiftEventAssignment&gt; shiftEvents) {
		//associate the shift events with the shifts 
<span class="nc" id="L192">		ScheduleUtil.buildShiftAssignment(shifts, shiftEvents);</span>
		//and group it by work resource id
<span class="nc" id="L194">		return ScheduleDAOUtil.groupEventsByWorkResources(shifts, workResourceIDs);</span>
	}

	private Collection&lt;ShiftEventAssignment&gt; getShiftEventAssignment(String sql) throws BbmFinderException {
<span class="nc" id="L198">		ShiftEventAssignmentPubDAO dao = (ShiftEventAssignmentPubDAO) createChildDAO(ShiftAssignmentFields.CHILD_SHIFT_EVENT);</span>
<span class="nc" id="L199">		return dao.getObjects(sql);</span>
	}


	/**
	 * Get a list of publised ShiftAssignment by IDs of ShiftAssignment
	 *
	 * @param shiftAssignmentIds list of IDs of ShiftAssignment
	 * @return List&lt;ShiftAssignment&gt;
	 * @throws BbmFinderException
	 * @throws JdmoException
	 */
	public List&lt;ShiftAssignment&gt; getPublishedShiftAssignmentByIDs(List&lt;ID&gt; shiftAssignmentIds) throws BbmFinderException {
		try {
<span class="nc" id="L213">			Collection&lt;ShiftAssignment&gt; pubShiftAssg = this.getObjects(&quot; ID in &quot; + m_dmo.createInClause(shiftAssignmentIds));</span>
<span class="nc" id="L214">			return new ArrayList&lt;ShiftAssignment&gt;(pubShiftAssg);</span>
<span class="nc" id="L215">		} catch (JdmoException e) {</span>
<span class="nc" id="L216">			throw new BbmFinderException(e);</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>