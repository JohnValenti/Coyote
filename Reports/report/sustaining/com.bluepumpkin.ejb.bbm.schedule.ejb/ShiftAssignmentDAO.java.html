<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftAssignmentDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.schedule.ejb</a> &gt; <span class="el_source">ShiftAssignmentDAO.java</span></div><h1>ShiftAssignmentDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.schedule.ejb;

import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.jdmo.SPMultiUserChangedException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.schedule.model.BbmScheduleConflict;
import com.bluepumpkin.ejb.bbm.schedule.model.CalendarEventAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignmentFields;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftEventAssignment;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.OrganizationFieldInfo;
import com.bluepumpkin.ejb.core.base.MultiUserException;

public class ShiftAssignmentDAO extends EventAssignmentUnpubDAO&lt;ShiftAssignment&gt; implements ScheduleConflictChecker&lt;ShiftAssignment&gt; {
	// meta data info.
<span class="nc" id="L44">	private static FieldInfo m_fieldInfo = new ShiftAssignmentFields();</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="nc" id="L48">		return m_fieldInfo;</span>
	}

	public ShiftAssignmentDAO() {
<span class="nc" id="L52">		super();</span>
<span class="nc" id="L53">	}</span>

	public ShiftAssignmentDAO(Jdmo dmo) {
<span class="nc" id="L56">		super(dmo);</span>
<span class="nc" id="L57">	}</span>

	@Override
	protected ShiftAssignment createValueObject() {
<span class="nc" id="L61">		return new ShiftAssignment();</span>
	}

	/** override from base class */
	@Override
	protected DAOBase createChildDAO(int iType) {
		// only has one child object
<span class="nc" id="L68">		return new ShiftEventAssignmentDAO(m_dmo);</span>
	}

	/**
	 * This method will be overridden by the derived class to provide an instance
	 * of the DAO class that model the published event
	 */
	@Override
	protected ShiftAssignmentPubDAO getPublishedDAO() {
<span class="nc" id="L77">		return new ShiftAssignmentPubDAO(m_dmo);</span>
	}

	@Override
	protected void calcAndSetEventPrecedence(ShiftAssignment objValue) throws Exception {
<span class="nc" id="L82">		ShiftAssignment event = objValue;</span>
<span class="nc" id="L83">		int precedence = EventPrecedenceRule.getEventOverlayPrecedence(event);</span>
<span class="nc" id="L84">		event.setOverlayPrecedence(precedence);</span>

		// also set the precedence for all the children - ShiftEventAssignment
		// ??? is ShiftEventAssignment the only child type for a Shift
<span class="nc" id="L88">		Collection&lt;ShiftEventAssignment&gt; children = event.getChildren();</span>
<span class="nc" id="L89">		ShiftEventAssignment shiftEvent = null;</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">		for (Iterator&lt;ShiftEventAssignment&gt; i = children.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L91">			shiftEvent = i.next();</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">			if (shiftEvent.getActivityID() == null) {</span>
				// shiftEvent object is partially update object,
				// need to get Acticity ID from database since it is
				// used to get precendence
<span class="nc" id="L96">				ShiftEventAssignment oldEvent = (ShiftEventAssignment) createChildDAO(</span>
<span class="nc" id="L97">					ShiftAssignmentFields.CHILD_SHIFT_EVENT).getObjectByID(shiftEvent.getID());</span>
<span class="nc" id="L98">				shiftEvent.setActivityID(oldEvent.getActivityID());</span>
			}
<span class="nc" id="L100">			precedence = EventPrecedenceRule.getEventOverlayPrecedence(shiftEvent);</span>
<span class="nc" id="L101">			shiftEvent.setOverlayPrecedence(precedence);</span>
		}
<span class="nc" id="L103">	}</span>

	public HashMap&lt;ID, ShiftAssignment&gt; getLastShiftAssignments(Collection&lt;ID&gt; workResourceIDs) throws BbmFinderException {
		try {
<span class="nc" id="L107">			StringBuffer buf = new StringBuffer(200);</span>
<span class="nc" id="L108">			buf.append(&quot;A.WORKRESOURCEID IN &quot;);</span>
<span class="nc" id="L109">			buf.append(m_dmo.createInClause(workResourceIDs));</span>
<span class="nc" id="L110">			buf.append(&quot; AND A.STARTTIME &gt;= &quot;);</span>
<span class="nc" id="L111">			buf.append(&quot;(SELECT MAX(B.STARTTIME) FROM SHIFTASSIGNMENT B &quot;);</span>
<span class="nc" id="L112">			buf.append(&quot; WHERE B.WORKRESOURCEID = A.WORKRESOURCEID)&quot;);</span>

<span class="nc" id="L114">			Collection&lt;ShiftAssignment&gt; listShifts = getObjects(buf.toString());</span>
<span class="nc" id="L115">			return ValueObjectUtil.indexBy(listShifts, ShiftAssignmentFields.WORKRESOURCEID);</span>
<span class="nc" id="L116">		} catch (JdmoException e) {</span>
<span class="nc" id="L117">			throw new BbmFinderException(e);</span>
		}
	}

	/**
	 * This function is called right after a newly created shift assignment has
	 * been persisted to the database. It checks whether this new shift
	 * assignment created any conflicts in the employee's schedule. The
	 * following are possible conflicts: 1) Overlapping shift assignments 2)
	 * Overlapping shift event assignments 3) Shift Assignment Overlaps
	 * Unavailability Calendar Event Assignments 4) More than 1 shift assignment
	 * on same org day
	 *
	 * Note: we shall ignore conflictResolutions collection for now, because
	 * there is no requirement on schedule access manager EJB to provide a
	 * method that allows one to create an event and resolve conflicts at the
	 * same time.
	 */
	@Override
	public Collection&lt;BbmScheduleConflict&gt; getConflictsForNewScheduleObject(ShiftAssignment obj) throws BbmFinderException {
<span class="nc" id="L137">		return getConflictsForScheduleObjects(Collections.singleton(obj), true);</span>
	}

	@Override
	public Collection&lt;BbmScheduleConflict&gt; getConflictsForUpdatedScheduleObject(ShiftAssignment obj)
		throws BbmFinderException {
<span class="nc" id="L143">		return getConflictsForScheduleObjects(Collections.singleton(obj), false);</span>
	}

	public Collection&lt;BbmScheduleConflict&gt; getConflictsForNewScheduleObjects(Collection&lt;ShiftAssignment&gt; listEvents)
		throws BbmFinderException {
<span class="nc" id="L148">		return getConflictsForScheduleObjects(listEvents, true);</span>
	}

	public Collection&lt;BbmScheduleConflict&gt; getConflictsForUpdatedScheduleObjects(Collection&lt;ShiftAssignment&gt; listEvents)
		throws BbmFinderException {
<span class="nc" id="L153">		return getConflictsForScheduleObjects(listEvents, false);</span>
	}

	/**
	 * This method is called right after a set of newly created shift
	 * assignments has been persisted to the database. It checks whether these
	 * new shifts assignments created any conflicts in the employee's schedule.
	 * The following are possible conflicts: 1) Overlapping shift assignments 2)
	 * Overlapping shift event assignments 3) Shift Assignment Overlaps
	 * Unavailability Calendar Event Assignments 4) More than 1 shift assignment
	 * on same org day
	 */
	private Collection&lt;BbmScheduleConflict&gt; getConflictsForScheduleObjects(Collection&lt;ShiftAssignment&gt; listEvents,
																		   boolean isNewObject) throws BbmFinderException {
<span class="nc bnc" id="L167" title="All 4 branches missed.">		if (listEvents == null || listEvents.isEmpty()) {</span>
<span class="nc" id="L168">			return Collections.emptyList();</span>
		}

<span class="nc" id="L171">		List&lt;BbmScheduleConflict&gt; listConflicts = new ArrayList&lt;BbmScheduleConflict&gt;();</span>
		try {
			/*
			 * find the earliest start time, latest end time and the full set of
			 * work resources
			 */
<span class="nc" id="L177">			Date dtEarliestStart = null, dtLatestEnd = null;</span>
<span class="nc" id="L178">			Set&lt;ID&gt; setWorkResources = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L179">			Map&lt;ID, ShiftAssignment&gt; mapEvents = new HashMap&lt;ID, ShiftAssignment&gt;();</span>
<span class="nc" id="L180">			List&lt;Pair&lt;ID, Date&gt;&gt; listPairs = new ArrayList&lt;Pair&lt;ID, Date&gt;&gt;(listEvents.size());</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">			for (Iterator&lt;ShiftAssignment&gt; it = listEvents.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L183">				ShiftAssignment saNext = it.next();</span>
				// need to set precedence for later use
<span class="nc" id="L185">				calcAndSetEventPrecedence(saNext);</span>

<span class="nc" id="L187">				ID workResourceID = saNext.getWorkResourceIDs().iterator().next();</span>
<span class="nc bnc" id="L188" title="All 4 branches missed.">				if (dtEarliestStart == null || dtEarliestStart.after(saNext.getStartTime())) {</span>
<span class="nc" id="L189">					dtEarliestStart = saNext.getStartTime();</span>
				}

<span class="nc bnc" id="L192" title="All 4 branches missed.">				if (dtLatestEnd == null || dtLatestEnd.before(saNext.getEndTime())) {</span>
<span class="nc" id="L193">					dtLatestEnd = saNext.getEndTime();</span>
				}

<span class="nc" id="L196">				setWorkResources.add(workResourceID);</span>
<span class="nc" id="L197">				mapEvents.put(saNext.getID(), saNext);</span>
<span class="nc" id="L198">				listPairs.add(new Pair&lt;ID, Date&gt;(workResourceID, saNext.getStartTime()));</span>
<span class="nc" id="L199">			}</span>

			/* find out the organization for each shift assignment */
<span class="nc" id="L202">			WorkResourceManager workResourceManager = getWorkResourceManager();</span>
<span class="nc" id="L203">			List&lt;ID&gt; listOrgIDs = workResourceManager.getEmployeeOrganizations(listPairs);</span>
<span class="nc" id="L204">			Set&lt;ID&gt; setOrgIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">			for (Iterator&lt;ID&gt; it = listOrgIDs.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L206">				ID orgID = it.next();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">				if (orgID != null) {</span>
<span class="nc" id="L208">					setOrgIDs.add(orgID);</span>
				}
<span class="nc" id="L210">			}</span>
<span class="nc" id="L211">			Collection&lt;Organization&gt; listOrgs = workResourceManager.getOrganizationsByIDs(setOrgIDs);</span>
<span class="nc" id="L212">			Map&lt;ID, Organization&gt; mapOrgs = ValueObjectUtil.indexBy(listOrgs, OrganizationFieldInfo.ORGANIZATION_ID);</span>

			/**
			 * 1) check whether these new shift assignments overlap with other
			 * shift assignments 2) let's check whether any of the shift event
			 * assignments overlap 3) make sure there's only one shift
			 * assignment per 1 org day
			 *
			 * find the organization where the employee worked on the day of the
			 * shift assignment
			 */
			/**
			 * extend the earliest start time and latest end time by 1 day so
			 * that we can also use the results of the next query to check that
			 * there are no 2 shift assignments for the same employee on a given
			 * work day
			 */
<span class="nc" id="L229">			dtEarliestStart = new Date(dtEarliestStart.getTime() - ShiftAssignment.MILLIS_IN_ONE_DAY);</span>
<span class="nc" id="L230">			dtLatestEnd = new Date(dtLatestEnd.getTime() + ShiftAssignment.MILLIS_IN_ONE_DAY);</span>

<span class="nc" id="L232">			Collection&lt;Collection&lt;ShiftAssignment&gt;&gt; listShifts = getEventsForWorkResources(setWorkResources,</span>
				dtEarliestStart, dtLatestEnd);
<span class="nc" id="L234">			Map&lt;ID, Collection&lt;ShiftAssignment&gt;&gt; mapShifts = new HashMap&lt;ID, Collection&lt;ShiftAssignment&gt;&gt;();</span>
<span class="nc" id="L235">			Iterator&lt;Collection&lt;ShiftAssignment&gt;&gt; it = listShifts.iterator();</span>
<span class="nc" id="L236">			Iterator&lt;ID&gt; it2 = setWorkResources.iterator();</span>
<span class="nc bnc" id="L237" title="All 4 branches missed.">			while (it.hasNext() &amp;&amp; it2.hasNext()) {</span>
<span class="nc" id="L238">				Collection&lt;ShiftAssignment&gt; listWrkShifts = it.next();</span>
<span class="nc" id="L239">				ID workResourceID = it2.next();</span>

<span class="nc bnc" id="L241" title="All 4 branches missed.">				if (listWrkShifts != null &amp;&amp; !listWrkShifts.isEmpty()) {</span>
<span class="nc" id="L242">					mapShifts.put(workResourceID, listWrkShifts);</span>
				}
<span class="nc" id="L244">			}</span>

<span class="nc" id="L246">			Iterator&lt;ShiftAssignment&gt; itSA = listEvents.iterator();</span>
<span class="nc" id="L247">			it2 = listOrgIDs.iterator();</span>
<span class="nc" id="L248">			Calendar cal = null, calEnd = null;</span>
<span class="nc bnc" id="L249" title="All 4 branches missed.">			while (itSA.hasNext() &amp;&amp; it2.hasNext()) {</span>
<span class="nc" id="L250">				ShiftAssignment saNext = itSA.next();</span>
<span class="nc" id="L251">				ID orgID = it2.next();</span>
<span class="nc" id="L252">				ID workResourceID = saNext.getWorkResourceIDs().iterator().next();</span>

				/* find out org start day and org end day */
<span class="nc" id="L255">				int dayOffset = 0;</span>
<span class="nc" id="L256">				int startHour = 0;</span>
<span class="nc" id="L257">				Organization org = null;</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">				if (orgID != null) {</span>
<span class="nc" id="L259">					org = mapOrgs.get(orgID);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">					if (org != null) {</span>
						/* find the organization time zone */
<span class="nc" id="L262">						cal = Calendar.getInstance(org.getTimeZone());</span>
<span class="nc" id="L263">						dayOffset = org.getDayBoundaryOffset();</span>
					}
				}

				// QA 82170 - Agent has two shift assignments that start on same
				// day
				// for the shift has extension before or after we must adjust
				// the start and end time of the shift
<span class="nc" id="L271">				Date saNextStartTime = saNext.getStartTime();</span>
<span class="nc" id="L272">				Date saNextEndTime = saNext.getEndTime();</span>

<span class="nc bnc" id="L274" title="All 4 branches missed.">				if (saNext.getExtensionBefore() &gt; 0 &amp;&amp; cal != null) {</span>
<span class="nc" id="L275">					cal.setTime(saNextStartTime);</span>
<span class="nc" id="L276">					cal.add(Calendar.MINUTE, saNext.getExtensionBefore());</span>
<span class="nc" id="L277">					saNextStartTime = cal.getTime();</span>
				}

<span class="nc bnc" id="L280" title="All 4 branches missed.">				if (saNext.getExtensionAfter() &gt; 0 &amp;&amp; cal != null) {</span>
<span class="nc" id="L281">					cal.setTime(saNextEndTime);</span>
<span class="nc" id="L282">					cal.add(Calendar.MINUTE, -saNext.getExtensionAfter());</span>
<span class="nc" id="L283">					saNextEndTime = cal.getTime();</span>
				}

				/* find out org start day and org end day */
<span class="nc" id="L287">				Date orgDayStart = null, orgDayEnd = null;</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">				if (cal != null) {</span>
<span class="nc" id="L289">					orgDayStart = getOrgDayStart(dayOffset, cal, saNextStartTime);</span>
<span class="nc" id="L290">					orgDayEnd = getOrgDayEnd(dayOffset, cal, saNextStartTime);</span>
				}

				/*
				 * check there is no overlapping shifts and also that there's no
				 * 2 shift assignments on the same work day
				 */
<span class="nc" id="L297">				Collection&lt;ShiftAssignment&gt; listWrkShifts = mapShifts.get(workResourceID);</span>
<span class="nc bnc" id="L298" title="All 4 branches missed.">				if (listWrkShifts != null &amp;&amp; !listWrkShifts.isEmpty()) {</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">					for (ShiftAssignment saNext2 : listWrkShifts) {</span>
						// QA 82170 - Agent has two shift assignments that start
						// on same day
						// for the shift has extension before or after we must
						// adjust the start and end time of the shift
<span class="nc" id="L304">						Date saNext2StartTime = saNext2.getStartTime();</span>
<span class="nc" id="L305">						Date saNext2EndTime = saNext2.getEndTime();</span>

<span class="nc bnc" id="L307" title="All 4 branches missed.">						if (saNext2.getExtensionBefore() &gt; 0 &amp;&amp; cal != null) {</span>
<span class="nc" id="L308">							cal.setTime(saNext2StartTime);</span>
<span class="nc" id="L309">							cal.add(Calendar.MINUTE, saNext2.getExtensionBefore());</span>
<span class="nc" id="L310">							saNext2StartTime = cal.getTime();</span>
						}

<span class="nc bnc" id="L313" title="All 4 branches missed.">						if (saNext2.getExtensionAfter() &gt; 0 &amp;&amp; cal != null) {</span>
<span class="nc" id="L314">							cal.setTime(saNext2EndTime);</span>
<span class="nc" id="L315">							cal.add(Calendar.MINUTE, -saNext2.getExtensionAfter());</span>
<span class="nc" id="L316">							saNext2EndTime = cal.getTime();</span>
						}

						// if ((isNewObject ||
						// !saNext.getID().equals(saNext2.getID())) &amp;&amp;
						// saNext.getStartTime().before(saNext2.getEndTime()) &amp;&amp;
						// saNext.getEndTime().after(saNext2.getStartTime()))
						// {
						// listConflicts.add(new BbmScheduleConflict(saNext,
						// saNext2));
						// }

						// if ((isNewObject ||
						// !saNext.getID().equals(saNext2.getID())) &amp;&amp;
						// orgDayStart != null &amp;&amp; orgDayEnd != null &amp;&amp;
						// saNext2.getStartTime().compareTo(orgDayEnd) &lt; 0 &amp;&amp;
						// saNext2.getStartTime().compareTo(orgDayStart) &gt;= 0)
						// {
						// listConflicts.add(new BbmScheduleConflict(saNext,
						// saNext2, orgDayStart));
						// }

<span class="nc bnc" id="L338" title="All 4 branches missed.">						if ((isNewObject || !saNext.getID().equals(saNext2.getID()))</span>
<span class="nc bnc" id="L339" title="All 4 branches missed.">							&amp;&amp; saNextStartTime.before(saNext2EndTime) &amp;&amp; saNextEndTime.after(saNext2StartTime)) {</span>
<span class="nc" id="L340">							listConflicts.add(new BbmScheduleConflict(saNext, saNext2));</span>
						}

<span class="nc bnc" id="L343" title="All 8 branches missed.">						if ((isNewObject || !saNext.getID().equals(saNext2.getID())) &amp;&amp; orgDayStart != null</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">							&amp;&amp; orgDayEnd != null &amp;&amp; saNext2StartTime.compareTo(orgDayEnd) &lt; 0</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">							&amp;&amp; saNext2StartTime.compareTo(orgDayStart) &gt;= 0) {</span>
<span class="nc" id="L346">							listConflicts.add(new BbmScheduleConflict(saNext, saNext2, orgDayStart));</span>
						}
<span class="nc" id="L348">					}</span>
				}

				/* check there are no overlapping shift events */
<span class="nc" id="L352">				Collection&lt;ShiftEventAssignment&gt; listChildren = saNext.getChildren();</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">				if (listChildren.size() &gt; 1) {</span>
<span class="nc" id="L354">					Object[] arChildren = listChildren.toArray();</span>
<span class="nc" id="L355">					boolean bFoundOverlappingSE = false;</span>
<span class="nc bnc" id="L356" title="All 4 branches missed.">					for (int i = 0; i &lt; arChildren.length &amp;&amp; !bFoundOverlappingSE; i++) {</span>
<span class="nc" id="L357">						ShiftEventAssignment shiftEvent1 = (ShiftEventAssignment) arChildren[i];</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">						for (int j = i + 1; j &lt; arChildren.length; j++) {</span>
<span class="nc" id="L359">							ShiftEventAssignment shiftEvent2 = (ShiftEventAssignment) arChildren[j];</span>

<span class="nc bnc" id="L361" title="All 2 branches missed.">							if ((shiftEvent1.getOverlayPrecedence() == shiftEvent2.getOverlayPrecedence())</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">								&amp;&amp; shiftEvent1.getStartTime().before(shiftEvent2.getEndTime())</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">								&amp;&amp; shiftEvent1.getEndTime().after(shiftEvent2.getStartTime())) {</span>
<span class="nc" id="L364">								listConflicts.add(new BbmScheduleConflict(saNext));</span>
<span class="nc" id="L365">								bFoundOverlappingSE = true;</span>
<span class="nc" id="L366">								break;</span>
							}
						}
					}
				}
<span class="nc" id="L371">			}</span>

			/**
			 * 3) Shift Assignment Overlaps Unavailability Calendar Event
			 * Assignments
			 */
<span class="nc" id="L377">			CalendarEventAssignmentDAO daoCalendarEvent = getCalendarEventAssignmentDAO();</span>

<span class="nc" id="L379">			Collection&lt;Collection&lt;CalendarEventAssignment&gt;&gt; listCalEvents = daoCalendarEvent</span>
<span class="nc" id="L380">				.getAllAttendingEventsForWorkResources(setWorkResources, dtEarliestStart, dtLatestEnd);</span>
<span class="nc" id="L381">			Map&lt;ID, Collection&lt;CalendarEventAssignment&gt;&gt; mapCalEvents = new HashMap&lt;ID, Collection&lt;CalendarEventAssignment&gt;&gt;();</span>
<span class="nc" id="L382">			Iterator&lt;Collection&lt;CalendarEventAssignment&gt;&gt; it3 = listCalEvents.iterator();</span>
<span class="nc" id="L383">			it2 = setWorkResources.iterator();</span>
<span class="nc bnc" id="L384" title="All 4 branches missed.">			while (it3.hasNext() &amp;&amp; it2.hasNext()) {</span>
<span class="nc" id="L385">				Collection&lt;CalendarEventAssignment&gt; listWrkEvents = it3.next();</span>
<span class="nc" id="L386">				ID workResourceID = it2.next();</span>
<span class="nc bnc" id="L387" title="All 4 branches missed.">				if (listWrkEvents != null &amp;&amp; !listWrkEvents.isEmpty()) {</span>
<span class="nc" id="L388">					mapCalEvents.put(workResourceID, listWrkEvents);</span>
				}
<span class="nc" id="L390">			}</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">			for (ShiftAssignment saNext : listEvents) {</span>
<span class="nc" id="L392">				ID workResourceID = saNext.getWorkResourceIDs().iterator().next();</span>
<span class="nc" id="L393">				Collection&lt;CalendarEventAssignment&gt; listWrkEvents = mapCalEvents.get(workResourceID);</span>
<span class="nc bnc" id="L394" title="All 4 branches missed.">				if (listWrkEvents != null &amp;&amp; !listWrkEvents.isEmpty()) {</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">					for (CalendarEventAssignment ceNext : listWrkEvents) {</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">						if (saNext.getOverlayPrecedence() == ceNext.getOverlayPrecedence()</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">							&amp;&amp; saNext.getStartTime().before(ceNext.getEndTime())</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">							&amp;&amp; saNext.getEndTime().after(ceNext.getStartTime())) {</span>
<span class="nc" id="L399">							listConflicts.add(new BbmScheduleConflict(saNext, ceNext));</span>
						}
<span class="nc" id="L401">					}</span>
				}
<span class="nc" id="L403">			}</span>

			/**
			 * the last step is to find the find all of the employee names for
			 * all of the conflicts returned from this method call
			 */
<span class="nc" id="L409">			ScheduleDAOUtil.findEmployeeNames(listConflicts);</span>
<span class="nc" id="L410">		} catch (Exception e) {</span>
<span class="nc" id="L411">			throw new BbmFinderException(e);</span>
<span class="nc" id="L412">		}</span>
<span class="nc" id="L413">		return listConflicts;</span>
	}

	protected Date getOrgDayStart(int dayOffset, Calendar cal, Date saNextStartTime) {
		Date orgDayStart;

		/*
		 * now calculate when the org day that includes that shift
		 * start time actually starts
		 */
<span class="nc" id="L423">		cal.setTime(saNextStartTime);</span>
<span class="nc" id="L424">		cal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L425">		cal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L426">		cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L427">		cal.set(Calendar.MINUTE, dayOffset);</span>

		/* find the day start and the day end */
<span class="nc" id="L430">		orgDayStart = cal.getTime();</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">		if (saNextStartTime.before(orgDayStart)) {</span>
			/*
			 * to account for a weird case when the shift starts at
			 * 1am and the organization start time occurs at 2am we
			 * have this if clause
			 */
<span class="nc" id="L437">			cal.add(Calendar.DATE, -1);</span>
<span class="nc" id="L438">			orgDayStart = cal.getTime();</span>
		}
<span class="nc" id="L440">		return orgDayStart;</span>
	}

	protected Date getOrgDayEnd(int dayOffset, Calendar cal, Date saNextStartTime) {
<span class="nc" id="L444">		int startHour = 0;</span>
<span class="nc" id="L445">		cal.add(Calendar.DATE, 1);</span>

		// QC 106865: saving error when day boundary is on exact DST roll back transition
<span class="nc" id="L448">		Calendar calEnd = cal.getInstance(); // ........and next shift is</span>
		// starting on next day within 1
		// hour
<span class="nc" id="L451">		calEnd.setTime(saNextStartTime);</span>
<span class="nc" id="L452">		calEnd.add(Calendar.DATE, -1);     // Want to check day boundary</span>
		// for the previous day
<span class="nc" id="L454">		calEnd.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L455">		calEnd.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L456">		calEnd.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L457">		calEnd.set(Calendar.MINUTE, dayOffset);</span>

<span class="nc" id="L459">		startHour = calEnd.get(Calendar.HOUR_OF_DAY);</span>

<span class="nc bnc" id="L461" title="All 2 branches missed.">		if (cal.get(Calendar.HOUR_OF_DAY) &gt; startHour)</span>
		 {
			// hour
			// addition
<span class="nc" id="L465">			cal.add(Calendar.HOUR_OF_DAY, -1);</span>
		// End QC 106865: saving error when day boundary is on exact
		// DST roll back .....
		}

<span class="nc" id="L470">		cal.add(Calendar.MINUTE, -1); // set the org end at the last</span>
		// minute of the day fix
		// 95084
<span class="nc" id="L473">		return cal.getTime();</span>
	}

	public void unlockEvents(int eventTypeMask, Collection&lt;ID&gt; workResourceIDs, Date dtStart, Date dtEnd) throws BbmUpdateException {
<span class="nc" id="L477">		lockOrUnlockEvents(eventTypeMask, workResourceIDs, dtStart, dtEnd, false);</span>
<span class="nc" id="L478">	}</span>

	public void lockEvents(int eventTypeMask, Collection&lt;ID&gt; workResourceIDs, Date dtStart, Date dtEnd) throws BbmUpdateException {
<span class="nc" id="L481">		lockOrUnlockEvents(eventTypeMask, workResourceIDs, dtStart, dtEnd, true);</span>
<span class="nc" id="L482">	}</span>

	/**
	 * Locks or Unlocks events of a given type for a given set of work resources
	 * and time period
	 */
	private void lockOrUnlockEvents(int eventTypeMask, Collection&lt;ID&gt; workResourceIDs, Date dtStart, Date dtEnd,
									boolean bLock) throws BbmUpdateException {
		try {
<span class="nc bnc" id="L491" title="All 2 branches missed.">			if ((eventTypeMask &amp; Event.EVENT_TYPE_SHIFT_ASSIGNMENT) != 0) {</span>
<span class="nc" id="L492">				StringBuffer buf = new StringBuffer(200);</span>
<span class="nc" id="L493">				buf.append(&quot;UPDATE SHIFTASSIGNMENT &quot;);</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">				buf.append(&quot;SET ISLOCKED = &quot;).append(bLock ? &quot;1 &quot; : &quot;0 &quot;);</span>
<span class="nc" id="L495">				buf.append(&quot;WHERE ENDTIME &quot;);</span>
				// buf.append(m_dmo.dateAddMinutes(&quot;DURATION&quot;, &quot;STARTTIME&quot;));
<span class="nc" id="L497">				buf.append(&quot; &gt; '&quot; + JdmoUtil.formatDBString(dtStart));</span>
<span class="nc" id="L498">				buf.append(&quot;' AND STARTTIME &lt;= '&quot; + JdmoUtil.formatDBString(dtEnd));</span>
<span class="nc" id="L499">				buf.append(&quot;' AND WORKRESOURCEID IN &quot;);</span>
<span class="nc" id="L500">				buf.append(m_dmo.createInClause(workResourceIDs));</span>
<span class="nc" id="L501">				m_dmo.executeCommand(buf.toString());</span>
			}
<span class="nc bnc" id="L503" title="All 2 branches missed.">			if ((eventTypeMask &amp; Event.EVENT_TYPE_SHIFT_EVENT_ASSIGNMENT) != 0) {</span>
<span class="nc" id="L504">				ShiftEventAssignmentDAO daoChild = new ShiftEventAssignmentDAO(m_dmo);</span>
<span class="nc" id="L505">				daoChild.lockOrUnlockEvents(workResourceIDs, dtStart, dtEnd, bLock);</span>
			}
<span class="nc" id="L507">		} catch (JdmoException e) {</span>
<span class="nc" id="L508">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L509">		}</span>
<span class="nc" id="L510">	}</span>

	/**
	 * Deletes schedule events for a set of work resources in a given time
	 * window Note: no need to record the audit trail for this particular action
	 * ?
	 */
	public void deleteEventsForWorkResources(Collection&lt;ID&gt; workResourceIDs, Date startTime, Date endTime, ID campaignID,
											 boolean unlockedOnly, boolean byStartTime) throws BbmRemoveException {
		try {
<span class="nc" id="L520">			StringBuffer strWhere = new StringBuffer(200);</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">			if (byStartTime) {</span>
<span class="nc" id="L522">				strWhere.append(getWhereClauseForGetEventsQueryByStartTime(workResourceIDs, startTime, endTime));</span>
			} else {
<span class="nc" id="L524">				strWhere.append(getWhereClauseForGetEventsQuery(workResourceIDs, startTime, endTime));</span>
			}
<span class="nc bnc" id="L526" title="All 2 branches missed.">			if (campaignID != null) {</span>
<span class="nc" id="L527">				strWhere.append(&quot; AND A.SPID = &quot;).append(campaignID);</span>
			}
<span class="nc bnc" id="L529" title="All 2 branches missed.">			if (unlockedOnly) {</span>
<span class="nc" id="L530">				strWhere.append(&quot; AND A.ISLOCKED = 0&quot;);</span>
			}

<span class="nc" id="L533">			deleteEventsGivenWhereClause(strWhere.toString());</span>
<span class="nc" id="L534">		} catch (JdmoException e) {</span>
<span class="nc" id="L535">			throw new BbmRemoveException(e);</span>
<span class="nc" id="L536">		}</span>
<span class="nc" id="L537">	}</span>

	public void unlockShiftAssignmentsByIDs(Collection&lt;ID&gt; cShiftAssignmentIDs, boolean bShiftEventAssignmentsOnly)
		throws BbmUpdateException, BbmFinderException {
		try {
<span class="nc" id="L542">			String shiftAssignmentInClause = m_dmo.createInClause(cShiftAssignmentIDs);</span>

<span class="nc bnc" id="L544" title="All 2 branches missed.">			if (includesCustomShiftAssignment(shiftAssignmentInClause)) {</span>
<span class="nc" id="L545">				throw new BbmUpdateException(&quot;Unlocking custom shifts is not allowed&quot;);</span>
			}

<span class="nc bnc" id="L548" title="All 2 branches missed.">			if (!bShiftEventAssignmentsOnly) {</span>
<span class="nc" id="L549">				String sQuery = &quot;UPDATE SHIFTASSIGNMENT SET ISLOCKED = 0 WHERE ID IN &quot; + shiftAssignmentInClause;</span>
<span class="nc" id="L550">				m_dmo.execute(sQuery);</span>
			}

<span class="nc" id="L553">			String sQuery = &quot;UPDATE SHIFTEVENTASSIGNMENT SET ISLOCKED = 0 WHERE SHIFTASSIGNMENTID IN &quot;</span>
				+ shiftAssignmentInClause;
<span class="nc" id="L555">			m_dmo.execute(sQuery);</span>
<span class="nc" id="L556">		} catch (JdmoException e) {</span>
<span class="nc" id="L557">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L558">		}</span>
<span class="nc" id="L559">	}</span>

	private boolean includesCustomShiftAssignment(String shiftAssignmentInClause) throws BbmFinderException {
<span class="nc bnc" id="L562" title="All 2 branches missed.">		return !getObjects(&quot;SHIFTID IS NULL AND ID IN &quot; + shiftAssignmentInClause).isEmpty();</span>
	}

	public void unlinkShiftAssignmentFromCampaign(Collection&lt;ID&gt; workResourceIDs, ID spID) throws BbmUpdateException,
		MultiUserException {
		try {
<span class="nc bnc" id="L568" title="All 2 branches missed.">			if (spID == null) {</span>
				// no action required since the spID is null already
				// should never happen - just in case
<span class="nc" id="L571">				return;</span>
			}
<span class="nc" id="L573">			m_dmo.execute(getStmtForUnlinkShiftAssignment(&quot;SHIFTASSIGNMENT&quot;, workResourceIDs, spID));</span>
<span class="nc" id="L574">			m_dmo.execute(getStmtForUnlinkShiftAssignment(&quot;SHIFTASSIGNMENTPUB&quot;, workResourceIDs, spID));</span>
<span class="nc" id="L575">		} catch (SPMultiUserChangedException e) {</span>
<span class="nc" id="L576">			throw new MultiUserException(e.getUpdateUser(), true);</span>
<span class="nc" id="L577">		} catch (JdmoException e) {</span>
<span class="nc" id="L578">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L579">		}</span>
<span class="nc" id="L580">	}</span>

	private String getStmtForUnlinkShiftAssignment(String tableName, Collection&lt;ID&gt; workResourceIDs, ID spID)
		throws JdmoException {
<span class="nc" id="L584">		StringBuffer sb = new StringBuffer(200);</span>
<span class="nc" id="L585">		sb.append(&quot;UPDATE &quot;);</span>
<span class="nc" id="L586">		sb.append(tableName);</span>
<span class="nc" id="L587">		sb.append(&quot; SET SPID = NULL WHERE SPID = &quot;);</span>
<span class="nc" id="L588">		sb.append(spID.toString());</span>
<span class="nc bnc" id="L589" title="All 4 branches missed.">		if (workResourceIDs != null &amp;&amp; !workResourceIDs.isEmpty()) {</span>
<span class="nc" id="L590">			sb.append(&quot; AND WORKRESOURCEID IN &quot;);</span>
<span class="nc" id="L591">			sb.append(m_dmo.createInClause(workResourceIDs));</span>
		}
<span class="nc" id="L593">		return sb.toString();</span>
	}

	public void unlinkShiftAssignmentFromCampaign(Collection&lt;ID&gt; shiftAssignmentIDs) throws BbmUpdateException,
		MultiUserException {
		try {
<span class="nc bnc" id="L599" title="All 4 branches missed.">			if (shiftAssignmentIDs == null || shiftAssignmentIDs.isEmpty()) {</span>
<span class="nc" id="L600">				return;</span>
			}
<span class="nc" id="L602">			m_dmo.execute(getStmtForUnlinkShiftAssignment(&quot;SHIFTASSIGNMENT&quot;, shiftAssignmentIDs));</span>
<span class="nc" id="L603">			m_dmo.execute(getStmtForUnlinkShiftAssignment(&quot;SHIFTASSIGNMENTPUB&quot;, shiftAssignmentIDs));</span>
<span class="nc" id="L604">		} catch (SPMultiUserChangedException e) {</span>
<span class="nc" id="L605">			throw new MultiUserException(e.getUpdateUser(), true);</span>
<span class="nc" id="L606">		} catch (JdmoException e) {</span>
<span class="nc" id="L607">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L608">		}</span>
<span class="nc" id="L609">	}</span>

	private String getStmtForUnlinkShiftAssignment(String tableName, Collection&lt;ID&gt; shiftAssignmentIDs)
		throws JdmoException {
<span class="nc" id="L613">		StringBuffer sb = new StringBuffer(200);</span>
<span class="nc" id="L614">		sb.append(&quot;UPDATE &quot;);</span>
<span class="nc" id="L615">		sb.append(tableName);</span>
<span class="nc" id="L616">		sb.append(&quot; SET SPID = NULL WHERE ID IN &quot;);</span>
<span class="nc" id="L617">		sb.append(m_dmo.createInClause(shiftAssignmentIDs));</span>
<span class="nc" id="L618">		return sb.toString();</span>
	}

	public void unlinkShiftAssignmentFromCampaign(ID orgID, ID spID) throws BbmUpdateException, MultiUserException {
		try {
<span class="nc bnc" id="L623" title="All 2 branches missed.">			if (spID == null) {</span>
<span class="nc" id="L624">				return;</span>
			}
<span class="nc" id="L626">			m_dmo.execute(getStmtForUnlinkShiftAssignment(&quot;SHIFTASSIGNMENT&quot;, orgID, spID));</span>
<span class="nc" id="L627">			m_dmo.execute(getStmtForUnlinkShiftAssignment(&quot;SHIFTASSIGNMENTPUB&quot;, orgID, spID));</span>
<span class="nc" id="L628">		} catch (SPMultiUserChangedException e) {</span>
<span class="nc" id="L629">			throw new MultiUserException(e.getUpdateUser(), true);</span>
<span class="nc" id="L630">		} catch (JdmoException e) {</span>
<span class="nc" id="L631">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L632">		}</span>
<span class="nc" id="L633">	}</span>

	private String getStmtForUnlinkShiftAssignment(String tableName, ID orgID, ID spID) throws JdmoException {
<span class="nc" id="L636">		StringBuffer sb = new StringBuffer(200);</span>
<span class="nc" id="L637">		sb.append(&quot;UPDATE &quot;);</span>
<span class="nc" id="L638">		sb.append(tableName);</span>
<span class="nc" id="L639">		sb.append(&quot; SET SPID = NULL WHERE SPID = &quot;);</span>
<span class="nc" id="L640">		sb.append(spID.toString());</span>

<span class="nc bnc" id="L642" title="All 2 branches missed.">		if (orgID != null) {</span>
<span class="nc" id="L643">			sb.append(&quot; AND WORKRESOURCEID IN &quot;);</span>
<span class="nc" id="L644">			sb.append(&quot;(SELECT WORKRESOURCEID FROM WORKRESOURCEORGANIZATION &quot;);</span>
<span class="nc" id="L645">			sb.append(&quot; WHERE ORGANIZATIONID = &quot;).append(orgID.toString()).append(&quot;)&quot;);</span>
		}
<span class="nc" id="L647">		return sb.toString();</span>
	}

	/** This is an override of the base class to set endtime based on duration */
	@Override
	public ID createObject(ShiftAssignment objValue, boolean bBatched) throws BbmCreateException {
<span class="nc" id="L653">		ShiftAssignment shift = objValue;</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">		if (objValue.isFieldValueSet(ShiftAssignmentFields.STARTTIME)</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">			&amp;&amp; objValue.isFieldValueSet(ShiftAssignmentFields.DURATION)) {</span>
<span class="nc" id="L656">			shift.setFieldValue(ShiftAssignmentFields.ENDTIME,</span>
<span class="nc" id="L657">				new Date(shift.getStartTime().getTime() + shift.getDuration() * ShiftAssignment.MILLIS_IN_ONE_MIN));</span>
		}
<span class="nc" id="L659">		return super.createObject(objValue, bBatched);</span>
	}

	// override the method defined in DAONode
	@Override
	public void updateObject(ShiftAssignment objValue) throws MultiUserException, BbmUpdateException {
<span class="nc" id="L665">		ShiftAssignment event = objValue;</span>

<span class="nc bnc" id="L667" title="All 2 branches missed.">		if (objValue.isFieldValueSet(ShiftAssignmentFields.STARTTIME)</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">			&amp;&amp; objValue.isFieldValueSet(ShiftAssignmentFields.DURATION)) {</span>
<span class="nc" id="L669">			event.setFieldValue(ShiftAssignmentFields.ENDTIME,</span>
<span class="nc" id="L670">				new Date(event.getStartTime().getTime() + event.getDuration() * ShiftAssignment.MILLIS_IN_ONE_MIN));</span>
		}

<span class="nc" id="L673">		super.updateObject(objValue);</span>
<span class="nc" id="L674">	}</span>

	public HashMap&lt;ID, Timestamp&gt; getLastShiftAssignmentStartTime(Collection&lt;ID&gt; workResourceIDs) throws BbmFinderException {
		try {
<span class="nc" id="L678">			HashMap&lt;ID, Timestamp&gt; map = new HashMap&lt;ID, Timestamp&gt;(workResourceIDs.size());</span>
<span class="nc" id="L679">			StringBuffer sb = new StringBuffer(200);</span>
<span class="nc" id="L680">			sb.append(&quot; select WORKRESOURCEID, MAX(STARTTIME) from SHIFTASSIGNMENT &quot;);</span>
<span class="nc" id="L681">			sb.append(&quot; where WORKRESOURCEID IN &quot;).append(m_dmo.createInClause(workResourceIDs));</span>
<span class="nc" id="L682">			sb.append(&quot; group by WORKRESOURCEID&quot;);</span>

<span class="nc" id="L684">			JdmoRowset rs = m_dmo.createRowset(sb.toString());</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L686">				map.put(rs.getID(1), rs.getTimestamp(2));</span>
			}
<span class="nc" id="L688">			return map;</span>
<span class="nc" id="L689">		} catch (JdmoException e) {</span>
<span class="nc" id="L690">			throw new BbmFinderException(e);</span>
		}
	}

	public Collection&lt;ShiftAssignment&gt; getShiftAssignmentInSP(ID spID, Collection&lt;ID&gt; workResourceIDs, Date startTime, Date endTime)
		throws BbmFinderException {
<span class="nc" id="L696">		return getShiftAssignmentInSP(spID, workResourceIDs, startTime, endTime, false);</span>
	}

	public Collection&lt;ShiftAssignment&gt; getShiftAssignmentInSP(ID spID, Collection&lt;ID&gt; workResourceIDs, Date startTime, Date endTime,
															  boolean unlockedOnly) throws BbmFinderException {
<span class="nc" id="L701">		StringBuilder strWhere = new StringBuilder(200);</span>
		try {
<span class="nc" id="L703">			strWhere.append(getWhereClauseForGetEventsQuery(workResourceIDs, startTime, endTime));</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">			if (spID != null) {</span>
<span class="nc" id="L705">				strWhere.append(&quot; AND A.SPID = &quot;).append(spID);</span>
			}
<span class="nc bnc" id="L707" title="All 2 branches missed.">			if (unlockedOnly) {</span>
<span class="nc" id="L708">				strWhere.append(&quot; AND A.ISLOCKED = 0&quot;);</span>
			}
<span class="nc" id="L710">		} catch (JdmoException e) {</span>
<span class="nc" id="L711">			throw new BbmFinderException(e);</span>
<span class="nc" id="L712">		}</span>
<span class="nc" id="L713">		return getObjects(strWhere.toString());</span>
	}

	public Collection&lt;ShiftAssignment&gt; getShiftAssignments(Collection&lt;ID&gt; workResourceIDs, Date startTime, Date endTime)
		throws BbmFinderException {
<span class="nc" id="L718">		StringBuilder strWhere = new StringBuilder(200);</span>
		try {
<span class="nc" id="L720">			strWhere.append(getWhereClauseForGetEventsQuery(workResourceIDs, startTime, endTime));</span>
<span class="nc" id="L721">		} catch (JdmoException e) {</span>
<span class="nc" id="L722">			throw new BbmFinderException(e);</span>
<span class="nc" id="L723">		}</span>
<span class="nc" id="L724">		return getObjects(strWhere.toString());</span>
	}

	WorkResourceManager getWorkResourceManager() {
<span class="nc" id="L728">		CachePerEJBMethod cache = CachePerEJBMethod.getCache();</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">		if (cache != null) {</span>
<span class="nc" id="L730">			return cache.getWorkResourceManager();</span>
		} else {
			try {
<span class="nc" id="L733">				return BbmManagerFactory.getWorkResourceManager(false);</span>
<span class="nc" id="L734">			} catch (Exception e) {</span>
<span class="nc" id="L735">				return null;</span>
			}
		}
	}

	CalendarEventAssignmentDAO getCalendarEventAssignmentDAO() {
<span class="nc" id="L741">		return new CalendarEventAssignmentDAO(m_dmo);</span>
	}

	/**
	 * Get a list of unpublised ShiftAssignment by IDs of ShiftAssignment
	 *
	 * @param shiftAssignmentIds list of IDs of ShiftAssignment
	 * @return List&lt;ShiftAssignment&gt;
	 * @throws BbmFinderException
	 * @throws JdmoException
	 */
	public List&lt;ShiftAssignment&gt; getShiftAssignmentByIDs(List&lt;ID&gt; shiftAssignmentIds) throws BbmFinderException {
		try {
<span class="nc" id="L754">			Collection&lt;ShiftAssignment&gt; unpubShiftAssg = this.getObjects(&quot; ID in &quot; + m_dmo.createInClause(shiftAssignmentIds));</span>
<span class="nc" id="L755">			return new ArrayList&lt;ShiftAssignment&gt;(unpubShiftAssg);</span>
<span class="nc" id="L756">		} catch (JdmoException e) {</span>
<span class="nc" id="L757">			throw new BbmFinderException(e);</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>