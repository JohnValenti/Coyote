<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityMediaDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.activity.ejb</a> &gt; <span class="el_source">ActivityMediaDAO.java</span></div><h1>ActivityMediaDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.activity.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.ejb.bbm.Filter.Filter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityMedia;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityMediaFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityMediaFilterDAO;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityMediaFieldInfo;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.witness.ejb.core.licensing.LicenseKeys;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, inc
 *
 * @author
 * @version 1.0
 */

public class ActivityMediaDAO extends DAOBase&lt;ActivityMedia&gt; {

  private static final int SMALL_STRING_BUFFER = 30;
  private static final int LARGE_STRING_BUFFER = 100;

  // meta data information
<span class="nc" id="L42">  private static FieldInfo m_fieldInfo = new ActivityMediaFieldInfo();</span>

  protected FieldInfo getFieldInfo() {
<span class="nc" id="L45">    return m_fieldInfo;</span>
  }

  public ActivityMediaDAO() {
<span class="nc" id="L49">    super();</span>
<span class="nc" id="L50">  }</span>

  public ActivityMediaDAO(Jdmo dmo) {
<span class="nc" id="L53">    super(dmo);</span>
<span class="nc" id="L54">  }</span>

  protected ActivityMedia createValueObject() {
<span class="nc" id="L57">    return new ActivityMedia();</span>
  }

  protected Collection findMediaIdsForActivity(ID activityId)
      throws BbmFinderException {
<span class="nc" id="L62">    ActivityMediaFilter activityMediaFilter = new ActivityMediaFilter();</span>
<span class="nc" id="L63">    activityMediaFilter.setActivityId(activityId, Filter.OP_EQUAL);</span>
<span class="nc" id="L64">    ActivityMediaFilterDAO activityMediaFilterDAO = new ActivityMediaFilterDAO(activityMediaFilter);</span>
<span class="nc" id="L65">    Collection&lt;ActivityMedia&gt; activityMediaCollection = getObjects(activityMediaFilterDAO.getFilterText().toString());</span>
<span class="nc" id="L66">    Collection mediaIds = new ArrayList(activityMediaCollection.size());</span>
    
<span class="nc" id="L68">    boolean hasOutboundLicense = checkLicense(LicenseKeys.APP_MEDIA_OUTBOUND);</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">    for (ActivityMedia activityMedia : activityMediaCollection) {</span>
      //If the Media is Outbound and we don't have license then do not add it the available medias for this activity Id
<span class="nc bnc" id="L71" title="All 6 branches missed.">      if (!hasOutboundLicense &amp;&amp; activityMedia != null &amp;&amp; Media.MEDIA_ID_PHONE_OUTBOUND.equals(activityMedia.getMediaId())) {</span>
<span class="nc" id="L72">        continue;</span>
      }
<span class="nc bnc" id="L74" title="All 2 branches missed.">      if (activityMedia != null) {</span>
<span class="nc" id="L75">        mediaIds.add(activityMedia.getMediaId());</span>
      }
<span class="nc" id="L77">    }</span>
<span class="nc" id="L78">    return mediaIds;</span>
  }

  /**
   * &lt;B&gt;findMediaForActivities&lt;/B&gt;
   * &lt;p&gt;
   * find Media Ids per activity for a given collection of activities
   * &lt;p&gt;
   *
   * @param activityIds: collection of activity Ids
   * @return Map of activity ID (key) and collection of Media Ids (value)
   */
  public Map findMediaForActivities(Collection activityIds)
      throws BbmFinderException {

    try {
<span class="nc bnc" id="L94" title="All 4 branches missed.">      if (activityIds == null || activityIds.isEmpty()) {</span>
<span class="nc" id="L95">        return Collections.emptyMap();</span>
      }
<span class="nc" id="L97">      StringBuffer strWhere = new StringBuffer(SMALL_STRING_BUFFER);</span>
<span class="nc" id="L98">      strWhere.append(&quot;A.ACTIVITYID in &quot;).append(m_dmo.createInClause(activityIds));</span>
<span class="nc" id="L99">      strWhere.append(&quot; ORDER BY A.ACTIVITYID &quot;);</span>
<span class="nc" id="L100">      boolean hasOutboundLicense = checkLicense(LicenseKeys.APP_MEDIA_OUTBOUND);</span>
<span class="nc" id="L101">      Collection&lt;ActivityMedia&gt; activityMediaVOCollection = getObjects(strWhere.toString());</span>
<span class="nc" id="L102">      HashMap activityMediaIdsMap = new HashMap(activityIds.size());</span>
      ArrayList mediaIdsCollection;
<span class="nc bnc" id="L104" title="All 2 branches missed.">      for (ActivityMedia activityMedia : activityMediaVOCollection) {</span>
        //If the Media is Outbound and we dont have license then do not add it the available medias for this activity Id
<span class="nc bnc" id="L106" title="All 6 branches missed.">        if (!hasOutboundLicense &amp;&amp; activityMedia != null &amp;&amp; Media.MEDIA_ID_PHONE_OUTBOUND.equals(activityMedia.getMediaId())) {</span>
<span class="nc" id="L107">          continue;</span>
        }

<span class="nc bnc" id="L110" title="All 4 branches missed.">        if (activityMedia != null &amp;&amp; activityMediaIdsMap.containsKey(activityMedia.getActivityId())) {</span>
<span class="nc" id="L111">          mediaIdsCollection = (ArrayList) activityMediaIdsMap.get(activityMedia.getActivityId());</span>
<span class="nc" id="L112">          mediaIdsCollection.add(activityMedia.getMediaId());</span>
        } else {
<span class="nc" id="L114">          mediaIdsCollection = new ArrayList(1);</span>
<span class="nc" id="L115">          mediaIdsCollection.add(activityMedia.getMediaId());</span>
<span class="nc" id="L116">          activityMediaIdsMap.put(activityMedia.getActivityId(), mediaIdsCollection);</span>
        }
<span class="nc" id="L118">      }</span>
<span class="nc" id="L119">      return activityMediaIdsMap;</span>
<span class="nc" id="L120">    } catch (Exception e) {</span>
<span class="nc" id="L121">      throw new BbmFinderException(e);</span>
    }
  }

  /**
   * &lt;B&gt;findActivitiesForMedia&lt;/B&gt;
   * &lt;p&gt;
   * find Activity Ids per Media for a given collection of mediaIds
   * &lt;p&gt;
   *
   * @param mediaIds: collection of Media Ids
   * @return Map of Media ID (key) and collection of Activity Ids (value)
   */
  public Map findActivitiesForMedia(Collection&lt;ID&gt; mediaIds)
      throws BbmFinderException {

    try {
<span class="nc bnc" id="L138" title="All 4 branches missed.">      if (mediaIds == null || mediaIds.isEmpty()) {</span>
<span class="nc" id="L139">        return Collections.emptyMap();</span>
      }
<span class="nc" id="L141">      StringBuffer strWhere = new StringBuffer(SMALL_STRING_BUFFER);</span>
<span class="nc" id="L142">      strWhere.append(&quot;MEDIAID in &quot;).append(m_dmo.createInClause(mediaIds));</span>
      //strWhere.append(&quot; ORDER BY A.ACTIVITYID &quot;);
<span class="nc" id="L144">      boolean hasOutboundLicense = checkLicense(LicenseKeys.APP_MEDIA_OUTBOUND);</span>
<span class="nc" id="L145">      Collection&lt;ActivityMedia&gt; activityMediaVOCollection = getObjects(strWhere.toString());</span>
<span class="nc" id="L146">      HashMap mediaActivityIdsMap = new HashMap(mediaIds.size());</span>
      ArrayList activityIdsCollection;
<span class="nc bnc" id="L148" title="All 2 branches missed.">      for (ActivityMedia activityMedia : activityMediaVOCollection) {</span>
        //If the Media is Outbound and we dont have license then do not add it the available medias for this activity Id
<span class="nc bnc" id="L150" title="All 6 branches missed.">        if (!hasOutboundLicense &amp;&amp; activityMedia != null &amp;&amp; Media.MEDIA_ID_PHONE_OUTBOUND.equals(activityMedia.getMediaId())) {</span>
<span class="nc" id="L151">          continue;</span>
        }
<span class="nc bnc" id="L153" title="All 4 branches missed.">        if (activityMedia != null &amp;&amp; mediaActivityIdsMap.containsKey(activityMedia.getMediaId())) {</span>
<span class="nc" id="L154">          activityIdsCollection = (ArrayList) mediaActivityIdsMap.get(activityMedia.getMediaId());</span>
<span class="nc" id="L155">          activityIdsCollection.add(activityMedia.getActivityId());</span>
        } else {
<span class="nc" id="L157">          activityIdsCollection = new ArrayList(1);</span>
<span class="nc" id="L158">          activityIdsCollection.add(activityMedia.getActivityId());</span>
<span class="nc" id="L159">          mediaActivityIdsMap.put(activityMedia.getMediaId(), activityIdsCollection);</span>
        }
<span class="nc" id="L161">      }</span>
<span class="nc" id="L162">      return mediaActivityIdsMap;</span>
<span class="nc" id="L163">    } catch (Exception e) {</span>
<span class="nc" id="L164">      throw new BbmFinderException(e);</span>
    }
  }

  /**
   * &lt;B&gt;findActivitiesWithMedia&lt;/B&gt;
   * &lt;p&gt;
   * find all activities that are linked to at least one media.
   * &lt;p&gt;
   *
   * @return A Collection of all activity ID's that are in the ACTIVITYMEDIA table.
   */
  public Collection findActivitiesWithMedia() throws BbmFinderException {
<span class="nc" id="L177">    Jdmo dmo = null;</span>
    try {
<span class="nc" id="L179">      dmo = new Jdmo();</span>
<span class="nc" id="L180">      StringBuffer sb = new StringBuffer(LARGE_STRING_BUFFER);</span>
<span class="nc" id="L181">      sb.append(&quot;select distinct activityid from activitymedia&quot;);</span>
<span class="nc" id="L182">      JdmoRowset rs = dmo.createRowset(sb.toString());</span>
<span class="nc" id="L183">      ArrayList ids = new ArrayList();</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">      while (rs.next()) {</span>
<span class="nc" id="L185">        ids.add(rs.getID(1));</span>
      }
<span class="nc" id="L187">      return ids;</span>
<span class="nc" id="L188">    } catch (Exception e) {</span>
<span class="nc" id="L189">      throw new BbmFinderException(e);</span>
    } finally {
<span class="nc bnc" id="L191" title="All 4 branches missed.">      if (dmo != null) {</span>
<span class="nc" id="L192">        dmo.cleanUp();</span>
      }
    }
  }


  protected void unlinkAllActivityMedias(ID activityId)
      throws BbmRemoveException {
<span class="nc bnc" id="L200" title="All 2 branches missed.">    if (activityId == null) {</span>
<span class="nc" id="L201">      return;</span>
    }
    try {
<span class="nc" id="L204">      StringBuffer strSQL = new StringBuffer(SMALL_STRING_BUFFER);</span>
<span class="nc" id="L205">      strSQL.append(&quot;delete &quot;).append(getFieldInfo().getTableName());</span>
<span class="nc" id="L206">      strSQL.append(&quot; where &quot;).append(&quot;ACTIVITYID = &quot;).append(activityId.toString());</span>
<span class="nc" id="L207">      m_dmo.executeCommand(strSQL.toString());</span>
<span class="nc" id="L208">    } catch (JdmoException e) {</span>
<span class="nc" id="L209">      throw new BbmRemoveException(e);</span>
<span class="nc" id="L210">    }</span>
<span class="nc" id="L211">  }</span>

  //should move it to utility class
  public static boolean checkLicense(String licenseKey) throws BbmFinderException {
    boolean license;
    try {
<span class="nc" id="L217">      license = CoreManagerFactory.getLicenseManager().isLicensed(licenseKey);</span>
<span class="nc" id="L218">    } catch (Exception e) {</span>
<span class="nc" id="L219">      throw new BbmFinderException(e);</span>
<span class="nc" id="L220">    }</span>
<span class="nc" id="L221">    return license;</span>
  }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>