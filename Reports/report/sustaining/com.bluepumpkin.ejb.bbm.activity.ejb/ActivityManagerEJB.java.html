<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.activity.ejb</a> &gt; <span class="el_source">ActivityManagerEJB.java</span></div><h1>ActivityManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.activity.ejb;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import javax.naming.Context;
import javax.naming.InitialContext;

import com.bluepumpkin.common.cache.Cache;
import com.bluepumpkin.common.cache.CacheFactory;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.localization.LocalizationManager;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.NumberFactory;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.JNDINames;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategory;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategoryFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityGroup;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityMedia;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityProperties;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityQueue;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityValidationException;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.config.ConfigCacheUtil;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.config.ejb.DBConfigManager;
import com.bluepumpkin.ejb.bbm.dao.DAOEJBUtil;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.dao.MapUtil;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.ObjectType;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.SystemType;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TimeOffHoursManagerBridge;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.witness.ejb.bbm.delete.DeleteException;
import com.witness.ejb.bbm.delete.ejb.DeleteManager;
import com.witness.ejb.bbm.delete.model.DeletionResult;
import com.witness.ejb.core.gcr.ejb.GCRManager;
import com.witness.ejb.core.gcr.model.GCREntry;

<span class="nc" id="L61">public class ActivityManagerEJB extends SessionEJBBase {</span>

	private static final long serialVersionUID = 1L;
<span class="nc" id="L64">	private static final Category m_cat = Log.initCategory(ActivityManagerEJB.class.getName());</span>
	private DBConfigManager m_DBConfigManager;
<span class="nc" id="L66">	private boolean lastCheckStatus = true;</span>
<span class="nc" id="L67">	private Cache m_ActivityCache = null;</span>
<span class="nc" id="L68">	private static final String clsName = ActivityManagerEJB.class.getName();</span>

<span class="nc" id="L70">	private boolean WhatIfMode = false;</span>
<span class="nc" id="L71">	private TimeOffHoursManagerBridge m_timeOffHoursManagerBridge = null;</span>

	private DeleteManager deleteManager;

<span class="nc" id="L75">	private transient ActivityQueueDAOFactory activityQueueDAOFactory = new ActivityQueueDAOFactory();</span>
<span class="nc" id="L76">	private transient ActivityDAOFactory activityDAOFactory = new ActivityDAOFactory();</span>

	/**
	 * override the base class to provide the appropriate logging category
	 */
	@Override
	protected Category getCategory() {
<span class="nc" id="L83">		return m_cat;</span>
	}

	{
<span class="nc" id="L87">		super.init(clsName);</span>
<span class="nc" id="L88">	}</span>

	@Override
	public void onEjbCreate() {
		try {
			// First query environment to get WIF setting from DD
<span class="nc" id="L94">			Context initialContext = new InitialContext();</span>
<span class="nc" id="L95">			Boolean WIF = (Boolean) initialContext.lookup(&quot;java:comp/env/WIF&quot;);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">			if (WIF != null) {</span>
<span class="nc" id="L97">				WhatIfMode = WIF;</span>
			}
			// If not in WhatIfMode, then initialize Cache
<span class="nc bnc" id="L100" title="All 2 branches missed.">			if (!WhatIfMode) {</span>
<span class="nc" id="L101">				m_DBConfigManager = BbmManagerFactory.getDBConfigManager();</span>
				// If cache is enabled at first, instantiate cache
<span class="nc bnc" id="L103" title="All 2 branches missed.">				if (ConfigCacheUtil.isCacheEnabled(m_DBConfigManager, ConfigKey.ACTIVITY_CACHE_USAGE)) {</span>
<span class="nc" id="L104">					m_ActivityCache = CacheFactory.getCache(JNDINames.BBM_ACTIVITYMANAGER_EJBHOME,</span>
<span class="nc" id="L105">							ActivityManagerEJB.class.getClassLoader());</span>
<span class="nc" id="L106">					initCache();</span>
				} else {
<span class="nc" id="L108">					lastCheckStatus = false;</span>
				}
			}
<span class="nc" id="L111">			deleteManager = BbmManagerFactory.getDeleteManager(WhatIfMode);</span>
<span class="nc" id="L112">		} catch (Exception e) {</span>
<span class="nc" id="L113">			handleException(&quot;onEjbCreate&quot;, e, false);</span>
<span class="nc" id="L114">		}</span>
<span class="nc" id="L115">	}</span>

	private void initCache() throws BbmFinderException {
<span class="nc" id="L118">		Boolean init = (Boolean) m_ActivityCache.get(&quot;INITIALIZED&quot;);</span>
<span class="nc bnc" id="L119" title="All 4 branches missed.">		if (init != null &amp;&amp; init) {</span>
<span class="nc" id="L120">			return;</span>
		}
		// initialize the cache, load all activities
<span class="nc" id="L123">		ActivityFilter filter = new ActivityFilter(ActivityFilter.FILTER_NONE);</span>
<span class="nc" id="L124">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc bnc" id="L126" title="All 2 branches missed.">			for (Activity element : activityDao.findActivities(filter)) {</span>
<span class="nc" id="L127">				m_ActivityCache.put(element.getID(), element);</span>
<span class="nc" id="L128">			}</span>
<span class="nc" id="L129">			m_ActivityCache.put(&quot;INITIALIZED&quot;, Boolean.TRUE);</span>
		} finally {
<span class="nc" id="L131">			activityDao.cleanUp();</span>
<span class="nc" id="L132">		}</span>
<span class="nc" id="L133">	}</span>

	/**
	 * &lt;B&gt;findActivityById&lt;/B&gt;
	 * &lt;P&gt;
	 * returns an Activity for a given id
	 * &lt;P&gt;
	 *
	 * @param id
	 *            : activity id to search
	 * @return Activity
	 */
	public Activity findActivityById(ID id) throws BbmFinderException {
<span class="nc" id="L146">		methodStart(&quot;findActivityById&quot;, id);</span>
<span class="nc" id="L147">		ActivityDAO activityDao = null;</span>
		try {
<span class="nc bnc" id="L149" title="All 2 branches missed.">			if (cacheUsed()) {</span>
<span class="nc" id="L150">				initCache();</span>
<span class="nc" id="L151">				Activity act = (Activity) m_ActivityCache.get(id);</span>
<span class="nc bnc" id="L152" title="All 4 branches missed.">				if (act != null &amp;&amp; act.getID().equals(id)) {</span>
<span class="nc" id="L153">					return (Activity)(act.clone());</span>
				}
<span class="nc" id="L155">				m_cat.info(&quot;Failed to find Activity &quot; + id + &quot; in the cache.&quot;);</span>
			}
<span class="nc" id="L157">			activityDao = new ActivityDAO();</span>
<span class="nc" id="L158">			Activity act = activityDao.getObjectByID(id);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">			if (cacheUsed()) {</span>
<span class="nc" id="L160">				m_ActivityCache.put(id, act);</span>
<span class="nc" id="L161">				act = (Activity)(act.clone()); //for cache, always return cloned object.</span>
			}
<span class="nc" id="L163">			return act;</span>
<span class="nc" id="L164">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L165">			handleException(e, false);</span>
<span class="nc" id="L166">			throw e;</span>
<span class="nc" id="L167">		} catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L168">			handleException(e, false);</span>
<span class="nc" id="L169">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc bnc" id="L171" title="All 6 branches missed.">			if (activityDao != null) {</span>
<span class="nc" id="L172">				activityDao.cleanUp();</span>
			}
<span class="nc" id="L174">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities that meet given ActivityFilter criteria
	 * &lt;P&gt;
	 *
	 * @param activityFilter
	 *            : search criteria
	 * @return Collection of activities
	 */
	public Collection&lt;Activity&gt; findActivities(ActivityFilter activityFilter) throws BbmFinderException {
<span class="nc" id="L189">		methodStart(&quot;findActivities&quot;, activityFilter);</span>
<span class="nc" id="L190">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L192">			return activityDao.findActivities(activityFilter);</span>
<span class="nc" id="L193">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L194">			handleException(e, false);</span>
<span class="nc" id="L195">			throw e;</span>
		} finally {
<span class="nc" id="L197">			activityDao.cleanUp();</span>
<span class="nc" id="L198">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivitiesIds&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities Ids that meet given ActivityFilter criteria
	 * &lt;P&gt;
	 *
	 * @param activityFilter
	 *            : search criteria
	 * @return Collection of activities Ids
	 */
	public Collection&lt;ID&gt; findActivitiesIds(ActivityFilter activityFilter) throws BbmFinderException {
<span class="nc" id="L213">		methodStart(&quot;findActivitiesIds&quot;, activityFilter);</span>
<span class="nc" id="L214">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L216">			return activityDao.findActivitiesIds(activityFilter);</span>
<span class="nc" id="L217">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L218">			handleException(e, false);</span>
<span class="nc" id="L219">			throw e;</span>
		} finally {
<span class="nc" id="L221">			activityDao.cleanUp();</span>
<span class="nc" id="L222">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;getActivities&lt;/B&gt;
	 * &lt;P&gt;
	 *
	 * @param organizationIdCol
	 *            int value of id of employee to search
	 *            &lt;P&gt;
	 * @return collection of ActivityGroup objects
	 * @deprecated see getActivities(ID,boolean);
	 */
	@Deprecated
	public ActivityGroup getActivities(Collection&lt;ID&gt; organizationIdCol) throws BbmFinderException {
<span class="nc" id="L238">		methodStart(&quot;getActivities&quot;, organizationIdCol);</span>
		try {
<span class="nc" id="L240">			ActivityFilter activityFilter = new ActivityFilter();</span>
<span class="nc" id="L241">			activityFilter.setDeleted(false);</span>
<span class="nc" id="L242">			ActivityDAO activityDao = new ActivityDAO();</span>
<span class="nc" id="L243">			Collection activities = activityDao.findOrganizationActivities(organizationIdCol, activityFilter);</span>
<span class="nc" id="L244">			activityDao.cleanUp();</span>
<span class="nc" id="L245">			ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
<span class="nc" id="L246">			ActivityCategoryFilter activityCategoryFilter = new ActivityCategoryFilter();</span>
<span class="nc" id="L247">			activityCategoryFilter.setVisibleToToTimeCollection(true);</span>
<span class="nc" id="L248">			activityCategoryFilter.setDeleted(true);</span>
<span class="nc" id="L249">			Collection activityCategories = activityCategoryDao.findOrganizationActivityCategories(organizationIdCol,</span>
					activityCategoryFilter);
<span class="nc" id="L251">			activityCategoryDao.cleanUp();</span>
<span class="nc" id="L252">			return new ActivityGroup(activities, activityCategories);</span>
<span class="nc" id="L253">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L254">			handleException(e, false);</span>
<span class="nc" id="L255">			throw e;</span>
		} finally {
<span class="nc" id="L257">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;getActivities&lt;/B&gt;
	 * &lt;P&gt;
	 *
	 * @param organizationIdCol
	 *            int value of id of employee to search
	 * @param activityCategoriesToGet Categories to get, use constant in ActivityGroup ActivityGroup.ALL_ACTIVITYCATEGORIES = 0;
	 *        ActivityGroup.MYTIME_ACTIVITYCATEGORIES = 1;
	 *        &lt;P&gt;
	 * @return collection of ActivityGroup objects
	 */
	public ActivityGroup getActivities(Collection&lt;ID&gt; organizationIdCol, int activityCategoriesToGet)
			throws BbmFinderException {
<span class="nc" id="L274">		methodStart(&quot;getActivities&quot;, organizationIdCol, NumberFactory.newInteger(activityCategoriesToGet));</span>
		try {
<span class="nc" id="L276">			ActivityFilter activityFilter = new ActivityFilter();</span>
<span class="nc" id="L277">			activityFilter.setDeleted(false);</span>
<span class="nc" id="L278">			ActivityDAO activityDao = new ActivityDAO();</span>
<span class="nc" id="L279">			Collection activities = activityDao.findOrganizationActivities(organizationIdCol, activityFilter);</span>
<span class="nc" id="L280">			activityDao.cleanUp();</span>
<span class="nc" id="L281">			ActivityCategoryFilter activityCategoryFilter = new ActivityCategoryFilter();</span>
<span class="nc" id="L282">			activityCategoryFilter.setDeleted(false);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">			if (activityCategoriesToGet == ActivityGroup.MYTIME_ACTIVITYCATEGORIES) {</span>
				// --------------------------------------------------------
				// just get timecollection activity categories
				// --------------------------------------------------------
<span class="nc" id="L287">				activityCategoryFilter.setVisibleToToTimeCollection(true);</span>
			}
<span class="nc" id="L289">			ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
<span class="nc" id="L290">			Collection activityCategories = activityCategoryDao.findOrganizationActivityCategories(organizationIdCol,</span>
					activityCategoryFilter);
<span class="nc" id="L292">			activityCategoryDao.cleanUp();</span>
<span class="nc" id="L293">			return new ActivityGroup(activities, activityCategories);</span>
<span class="nc" id="L294">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L295">			handleException(e, false);</span>
<span class="nc" id="L296">			throw e;</span>
		} finally {
<span class="nc" id="L298">			methodFinish();</span>
		}
	}

	public ActivityGroup getActivities(Collection&lt;ID&gt; organizationIdCol, ID currentActivityCategoryId)
			throws BbmFinderException {
<span class="nc" id="L304">		methodStart(&quot;getActivities&quot;, organizationIdCol, currentActivityCategoryId);</span>
		try {
<span class="nc" id="L306">			ActivityFilter activityFilter = new ActivityFilter();</span>
<span class="nc" id="L307">			activityFilter.setDeleted(false);</span>
<span class="nc" id="L308">			ActivityDAO activityDao = new ActivityDAO();</span>
<span class="nc" id="L309">			Collection activities = activityDao.findOrganizationActivitiesByCategory(organizationIdCol,</span>
					currentActivityCategoryId, activityFilter);
<span class="nc" id="L311">			activityDao.cleanUp();</span>
<span class="nc" id="L312">			ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
<span class="nc" id="L313">			Collection activityCategories = activityCategoryDao.findActivityCategories(new ActivityCategoryFilter());</span>
<span class="nc" id="L314">			activityCategoryDao.cleanUp();</span>
<span class="nc" id="L315">			return new ActivityGroup(currentActivityCategoryId, activities, activityCategories);</span>

<span class="nc" id="L317">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L318">			handleException(e);</span>
<span class="nc" id="L319">			throw e;</span>
		} finally {
<span class="nc" id="L321">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivitiesIds&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities Ids that meet given ActivityFilter criteria Activities of parent organizations will also be
	 * returned
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            : id of organization to search for
	 * @param activityFilter
	 *            : search criteria
	 * @return Collection of activities Ids
	 */
	public Collection findOrganizationActivitiesIds(ID organizationId, ActivityFilter activityFilter)
			throws BbmFinderException {
<span class="nc" id="L340">		methodStart(&quot;findOrganizationActivitiesIds&quot;, organizationId, activityFilter);</span>
<span class="nc" id="L341">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L343">			return activityDao.findOrganizationActivitiesIds(organizationId, activityFilter);</span>
<span class="nc" id="L344">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L345">			handleException(e, false);</span>
<span class="nc" id="L346">			throw e;</span>
		} finally {
<span class="nc" id="L348">			activityDao.cleanUp();</span>
<span class="nc" id="L349">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given ids
	 * &lt;P&gt;
	 *
	 * @param ids
	 *            : Collection of id's to search for
	 * @return Collection of activities found
	 */
	public Collection&lt;Activity&gt; findActivities(Collection&lt;ID&gt; ids) throws BbmFinderException {
<span class="nc" id="L364">		methodStart(&quot;findActivities&quot;, ids);</span>
<span class="nc" id="L365">		ActivityDAO activityDao = null;</span>
		try {
<span class="nc bnc" id="L367" title="All 2 branches missed.">			if (cacheUsed()) {</span>
<span class="nc" id="L368">				initCache();</span>
<span class="nc" id="L369">				ArrayList&lt;Activity&gt; actCol = new ArrayList&lt;&gt;(ids.size());</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">				for (ID id : ids) {</span>
<span class="nc" id="L371">					Activity act = findActivityById(id);</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">					if (act != null) {</span>
<span class="nc" id="L373">						actCol.add(act);</span>
					}
<span class="nc" id="L375">				}</span>
<span class="nc" id="L376">				return actCol;</span>
			}
<span class="nc" id="L378">			activityDao = new ActivityDAO();</span>
<span class="nc" id="L379">			return activityDao.findActivities(ids);</span>
<span class="nc" id="L380">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L381">			handleException(e, false);</span>
<span class="nc" id="L382">			throw e;</span>
		} finally {
<span class="nc bnc" id="L384" title="All 6 branches missed.">			if (activityDao != null) {</span>
<span class="nc" id="L385">				activityDao.cleanUp();</span>
			}
<span class="nc" id="L387">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given organization and activityFilter Activities of parent organizations will also be
	 * returned
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            : id of organization to search for
	 * @param activityFilter
	 *            : search criteria
	 * @return Collection of activities found
	 */
	public Collection&lt;Activity&gt; findOrganizationActivities(ID organizationId, ActivityFilter activityFilter)
			throws BbmFinderException {
<span class="nc" id="L406">		methodStart(&quot;findOrganizationActivities&quot;, organizationId, activityFilter);</span>
<span class="nc" id="L407">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L409">			ArrayList&lt;ID&gt; orgCol = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L410">			orgCol.add(organizationId);</span>
<span class="nc" id="L411">			return activityDao.findOrganizationActivitiesCheckCategory(orgCol, activityFilter,true);</span>
<span class="nc" id="L412">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L413">			handleException(e, false);</span>
<span class="nc" id="L414">			throw e;</span>
		} finally {
<span class="nc" id="L416">			activityDao.cleanUp();</span>
<span class="nc" id="L417">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given organization and activityFilter Activities of parent organizations will also be
	 * returned
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            : id of organization to search for
	 * @param activityFilter
	 *            : search criteria
	 * @param flexType
	 *            : TO or Flex Request
	 * @return Collection of activities found
	 */
	public Collection&lt;Activity&gt; findOrganizationActivities(ID organizationId, ActivityFilter activityFilter, int flexType)
			throws BbmFinderException {
<span class="nc" id="L438">		methodStart(&quot;findOrganizationActivities&quot;, organizationId, activityFilter, flexType);</span>
<span class="nc" id="L439">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L441">			List&lt;ID&gt; orgCol = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L442">			orgCol.add(organizationId);</span>
<span class="nc" id="L443">			return activityDao.findOrganizationActivitiesCheckCategory(orgCol, activityFilter, true, flexType);</span>
<span class="nc" id="L444">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L445">			handleException(e, false);</span>
<span class="nc" id="L446">			throw e;</span>
		} finally {
<span class="nc" id="L448">			activityDao.cleanUp();</span>
<span class="nc" id="L449">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given organizations ids and activityFilter
	 * &lt;P&gt;
	 *
	 * @param orgIds
	 *            : a collection of organizations ids
	 * @param activityFilter
	 *            : search criteria
	 * @param findParentOrgs
	 *            : indicates if to find activities from parent orgs
	 * @return Collection of activities found
	 */
	public Collection&lt;Activity&gt; findOrganizationActivities(Collection&lt;ID&gt; orgIds, ActivityFilter activityFilter, boolean findParentOrgs)
	throws BbmFinderException
	{
<span class="nc" id="L470">		methodStart(&quot;findOrganizationActivities&quot;, orgIds, activityFilter, findParentOrgs);</span>
<span class="nc" id="L471">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L473">			return activityDao.findOrganizationActivities(orgIds, activityFilter, findParentOrgs);</span>
<span class="nc" id="L474">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L475">			handleException(e, false);</span>
<span class="nc" id="L476">			throw e;</span>
		} finally {
			
<span class="nc" id="L479">			activityDao.cleanUp();</span>
<span class="nc" id="L480">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given organizations ids, activityFilter, and flex type
	 * &lt;P&gt;
	 *
	 * @param orgIds
	 *            : a collection of organizations ids
	 * @param activityFilter
	 *            : search criteria
	 * @param findParentOrgs
	 *            : indicates if to find activities from parent orgs
	 * @return Collection of activities found
	 */
	public Collection&lt;Activity&gt; findOrganizationActivities(Collection&lt;ID&gt; orgIds, ActivityFilter activityFilter, boolean findParentOrgs,
			int flexType) throws BbmFinderException	{
<span class="nc" id="L500">		methodStart(&quot;findOrganizationActivities&quot;, orgIds, activityFilter, findParentOrgs);</span>
<span class="nc" id="L501">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L503">			return activityDao.findOrganizationActivities(orgIds, activityFilter, findParentOrgs, flexType);</span>
<span class="nc" id="L504">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L505">			handleException(e, false);</span>
<span class="nc" id="L506">			throw e;</span>
		} finally {
<span class="nc" id="L508">			activityDao.cleanUp();</span>
<span class="nc" id="L509">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given organizations ids
	 * &lt;P&gt;
	 *
	 * @param orgIds
	 *            : a collection of organizations ids
	 * @param findParentOrgs
	 *            : indicates if to find activities from parent orgs
	 * @return Collection of activities found
	 */
	public Collection&lt;Activity&gt; findOrganizationActivities(Collection&lt;ID&gt; orgIds, boolean findParentOrgs) throws BbmFinderException {
<span class="nc" id="L526">		return findOrganizationActivities(orgIds, null, findParentOrgs);</span>
	}

	/**
	 * &lt;B&gt;findOrganizationActivitiesByCategory&lt;/B&gt;
	 * &lt;P&gt;
	 * find activities for given organization and activityFilter Activities of parent organizations will also be
	 * returned
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            : id of organization to search for
	 * @param activityFilter
	 *            : search criteria
	 * @return Collection of activities found
	 */
	public Collection findOrganizationActivitiesByCategory(ID organizationId, ID activityCategoryId,
			ActivityFilter activityFilter) throws BbmFinderException {
<span class="nc" id="L544">		methodStart(&quot;findOrganizationActivitiesByCategory&quot;, organizationId, activityCategoryId, activityFilter);</span>
<span class="nc" id="L545">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L547">			ArrayList&lt;ID&gt; orgCol = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L548">			orgCol.add(organizationId);</span>
<span class="nc" id="L549">			return activityDao.findOrganizationActivitiesByCategory(orgCol, activityCategoryId, activityFilter);</span>
<span class="nc" id="L550">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L551">			handleException(e, false);</span>
<span class="nc" id="L552">			throw e;</span>
		} finally {
<span class="nc" id="L554">			activityDao.cleanUp();</span>
<span class="nc" id="L555">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivityCategoryById&lt;/B&gt;
	 * &lt;P&gt;
	 * returns an ActivityCategory for a given id
	 * &lt;P&gt;
	 *
	 * @param id
	 *            activity id to search
	 * @return Activity
	 */
	public ActivityCategory findActivityCategoryById(ID id) throws BbmFinderException {
<span class="nc" id="L570">		methodStart(&quot;findActivityById&quot;, id);</span>
<span class="nc" id="L571">		ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
		try {
<span class="nc" id="L573">			return activityCategoryDao.getObjectByID(id);</span>
<span class="nc" id="L574">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L575">			handleException(e, false);</span>
<span class="nc" id="L576">			throw e;</span>
<span class="nc" id="L577">		} catch (Exception e) {</span>
<span class="nc" id="L578">			handleException(e, false);</span>
<span class="nc" id="L579">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L581">			activityCategoryDao.cleanUp();</span>
<span class="nc" id="L582">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivityCategories&lt;/B&gt;
	 * &lt;P&gt;
	 * find activity categories for given ids
	 * &lt;P&gt;
	 *
	 * @param ids
	 *            : Collection of id's to search for
	 * @return Collection of activity categories found
	 */
	public Collection findActivityCategories(Collection ids) throws BbmException {
<span class="nc" id="L597">		methodStart(&quot;findActivityCategories&quot;, ids);</span>
<span class="nc" id="L598">		ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
		try {
<span class="nc" id="L600">			return activityCategoryDao.findActivityCategories(ids);</span>
<span class="nc" id="L601">		} catch (BbmException e) {</span>
<span class="nc" id="L602">			handleException(e, false);</span>
<span class="nc" id="L603">			throw e;</span>
		} finally {
<span class="nc" id="L605">			activityCategoryDao.cleanUp();</span>
<span class="nc" id="L606">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivityCategories&lt;/B&gt;
	 * &lt;P&gt;
	 * find activityCatgegories that meet given ActivityFilter criteria
	 * &lt;P&gt;
	 *
	 * @param activityCategoryFilter
	 *            : search criteria
	 * @return Collection of activityCatgegories
	 */
	public Collection findActivityCategories(ActivityCategoryFilter activityCategoryFilter) throws BbmFinderException {
<span class="nc" id="L621">		methodStart(&quot;findActivityCategories&quot;, activityCategoryFilter);</span>
<span class="nc" id="L622">		ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
		try {
<span class="nc" id="L624">			return activityCategoryDao.findActivityCategories(activityCategoryFilter);</span>
<span class="nc" id="L625">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L626">			handleException(e, false);</span>
<span class="nc" id="L627">			throw e;</span>
		} finally {
<span class="nc" id="L629">			activityCategoryDao.cleanUp();</span>
<span class="nc" id="L630">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivityCategories&lt;/B&gt;
	 * &lt;P&gt;
	 * find activityCategories for given organization and activityCategoryFilter Activities of parent organizations will
	 * also be returned
	 * &lt;P&gt;
	 *
	 * @param organizationId
	 *            : id of organization to search for
	 * @param activityCategoryFilter
	 *            : search criteria
	 * @return Collection of activityCategories found
	 */
	public Collection findOrganizationActivityCategories(ID organizationId,
			ActivityCategoryFilter activityCategoryFilter) throws BbmFinderException {
<span class="nc" id="L649">		methodStart(&quot;findOrganizationActivityCategories&quot;, organizationId, activityCategoryFilter);</span>
<span class="nc" id="L650">		ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
		try {
<span class="nc" id="L652">			ArrayList&lt;ID&gt; orgCol = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L653">			orgCol.add(organizationId);</span>
<span class="nc" id="L654">			return activityCategoryDao.findOrganizationActivityCategories(orgCol, activityCategoryFilter);</span>
<span class="nc" id="L655">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L656">			handleException(e, false);</span>
<span class="nc" id="L657">			throw e;</span>
		} finally {
<span class="nc" id="L659">			activityCategoryDao.cleanUp();</span>
<span class="nc" id="L660">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findOrganizationActivityCategories&lt;/B&gt;
	 * &lt;P&gt;
	 * find activityCategories for given organization and activityCategoryFilter Activities of parent organizations will
	 * also be returned
	 * &lt;P&gt;
	 *
	 * @param orgIdCol
	 *            Collection: id of organization to search for
	 * @param activityCategoryFilter
	 *            : search criteria
	 * @return Collection of activityCategories found
	 * @param needParent
	 *            , include parent org or not
	 */
	public Collection findOrganizationActivityCategories(Collection&lt;ID&gt; orgIdCol,
			ActivityCategoryFilter activityCategoryFilter, boolean needParent) throws BbmFinderException {
<span class="nc bnc" id="L681" title="All 2 branches missed.">		methodStart(&quot;findOrganizationActivityCategories&quot;, orgIdCol, activityCategoryFilter, needParent ? Boolean.TRUE</span>
				: Boolean.FALSE);
<span class="nc" id="L683">		Jdmo jdmo = new Jdmo();</span>
<span class="nc" id="L684">		ActivityCategoryDAO acDao = new ActivityCategoryDAO(jdmo);</span>
		try {
<span class="nc bnc" id="L686" title="All 2 branches missed.">			if (needParent) {</span>
<span class="nc" id="L687">				HashSet&lt;ID&gt; parentOrgs = DAOUtil.getParentOrganizationsCollection(orgIdCol, jdmo);</span>
<span class="nc" id="L688">				orgIdCol.addAll(parentOrgs);</span>
			}
<span class="nc" id="L690">			return acDao.findOrganizationActivityCategories(orgIdCol, activityCategoryFilter);</span>
<span class="nc" id="L691">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L692">			handleException(e, false);</span>
<span class="nc" id="L693">			throw e;</span>
		} finally {
<span class="nc" id="L695">			acDao.cleanUp();</span>
<span class="nc" id="L696">			jdmo.cleanUp();</span>
<span class="nc" id="L697">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findMediaForActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * find activityMedias for a given activity
	 * &lt;P&gt;
	 *
	 * @param activityId
	 *            : id of activity
	 * @return Collection of Media Ids found
	 */
	public Collection findMediaForActivity(ID activityId) throws BbmFinderException {
<span class="nc" id="L712">		methodStart(&quot;findMediaForActivity&quot;, activityId);</span>
<span class="nc" id="L713">		ActivityMediaDAO activityMediaDao = new ActivityMediaDAO();</span>
		try {
<span class="nc" id="L715">			return activityMediaDao.findMediaIdsForActivity(activityId);</span>
<span class="nc" id="L716">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L717">			handleException(e, false);</span>
<span class="nc" id="L718">			throw e;</span>
		} finally {
<span class="nc" id="L720">			activityMediaDao.cleanUp();</span>
<span class="nc" id="L721">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findMediaForActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find Media Ids per activity for a given collection of activities
	 * &lt;P&gt;
	 *
	 * @param activityIds
	 *            : collection of activity Ids
	 * @return Map of activity ID (key) and collection of Media Ids (value)
	 */
	public Map&lt;ID, Collection&lt;ID&gt;&gt; findMediaForActivities(Collection&lt;ID&gt; activityIds) throws BbmFinderException {
<span class="nc" id="L736">		methodStart(&quot;findAMediaForActivities&quot;, activityIds);</span>
<span class="nc" id="L737">		ActivityMediaDAO activityMediaDao = new ActivityMediaDAO();</span>
		try {
<span class="nc" id="L739">			return activityMediaDao.findMediaForActivities(activityIds);</span>
<span class="nc" id="L740">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L741">			handleException(e, false);</span>
<span class="nc" id="L742">			throw e;</span>
		} finally {
<span class="nc" id="L744">			activityMediaDao.cleanUp();</span>
<span class="nc" id="L745">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivitiesForMedia&lt;/B&gt;
	 * &lt;P&gt;
	 * find Activity Ids per Media for a given collection of mediaIds
	 * &lt;P&gt;
	 *
	 * @param mediaIds: collection of Media Ids
	 * @return Map of Media ID (key) and collection of Activity Ids (value)
	 */
	public Map findActivitiesForMedia(Collection&lt;ID&gt; mediaIds)
	        throws BbmFinderException {
<span class="nc" id="L760">		methodStart(&quot;findActivitiesForMedia&quot;, mediaIds);</span>
<span class="nc" id="L761">		ActivityMediaDAO activityMediaDao = new ActivityMediaDAO();</span>
		try {
<span class="nc" id="L763">			return activityMediaDao.findActivitiesForMedia(mediaIds);</span>
<span class="nc" id="L764">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L765">			handleException(e, false);</span>
<span class="nc" id="L766">			throw e;</span>
		} finally {
<span class="nc" id="L768">			activityMediaDao.cleanUp();</span>
<span class="nc" id="L769">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findActivitiesWithMedia&lt;/B&gt;
	 * &lt;P&gt;
	 * find all activities that are linked to at least one media.
	 * &lt;P&gt;
	 *
	 * @return A Collection of all activity ID's that are in the ACTIVITYMEDIA table.
	 */
	public Collection findActivitiesWithMedia() throws BbmFinderException {
<span class="nc" id="L782">		methodStart(&quot;findActivitiesWithMedia&quot;);</span>
<span class="nc" id="L783">		ActivityMediaDAO activityMediaDao = new ActivityMediaDAO();</span>
		try {
<span class="nc" id="L785">			return activityMediaDao.findActivitiesWithMedia();</span>
<span class="nc" id="L786">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L787">			handleException(e, false);</span>
<span class="nc" id="L788">			throw e;</span>
		} finally {
<span class="nc" id="L790">			activityMediaDao.cleanUp();</span>
<span class="nc" id="L791">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findQueueForActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * find activityQueues for a given activity
	 * &lt;P&gt;
	 *
	 * @param activityId
	 *            : id of activity
	 * @return Collection of Queue Ids found
	 */
	public Collection findQueueForActivity(ID activityId) throws BbmFinderException {
<span class="nc" id="L806">		methodStart(&quot;findQueueForActivity&quot;, activityId);</span>
<span class="nc" id="L807">		ActivityQueueDAO activityQueueDao = activityQueueDAOFactory.createDAO();</span>
		try {
<span class="nc" id="L809">			return activityQueueDao.findQueueIdsForActivity(activityId);</span>
<span class="nc" id="L810">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L811">			handleException(e, false);</span>
<span class="nc" id="L812">			throw e;</span>
		} finally {
<span class="nc" id="L814">			activityQueueDao.cleanUp();</span>
<span class="nc" id="L815">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;findQueueForActivities&lt;/B&gt;
	 * &lt;P&gt;
	 * find Queue Ids per activity for a given collection of activities
	 * &lt;P&gt;
	 *
	 * @param activityIds
	 *            : collection of activity Ids
	 * @return Map of activity ID (key) and collection of Queue Ids (value)
	 */
	public Map findQueueForActivities(Collection activityIds) throws BbmFinderException {
<span class="nc" id="L830">		methodStart(&quot;findAQueueForActivities&quot;, activityIds);</span>
<span class="nc" id="L831">		ActivityQueueDAO activityQueueDao = activityQueueDAOFactory.createDAO();</span>
		try {
<span class="nc" id="L833">			return activityQueueDao.findQueueForActivities(activityIds);</span>
<span class="nc" id="L834">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L835">			handleException(e, false);</span>
<span class="nc" id="L836">			throw e;</span>
		} finally {
<span class="nc" id="L838">			activityQueueDao.cleanUp();</span>
<span class="nc" id="L839">			methodFinish();</span>
		}
	}


	/**
	 * &lt;B&gt;findActivitiesDirectlyMappedToQueuesInDB&lt;/B&gt;
	 * &lt;P&gt;
	 * Find Activity Ids that are directly linked to the collection of queue IDs.
	 * This includes only activities that are directly mapped to the Queues in the
	 * &quot;Queue Hopping&quot; scenario.
	 * &lt;P&gt;
	 *
	 * @param queueIds: collection of Queue Ids
	 * @return Map of Queue ID (key) and collection of Activity Ids (value)
	 */
	public Map&lt;ID, List&lt;ID&gt;&gt; findActivitiesDirectlyMappedToQueuesInDB(Collection&lt;ID&gt; queueIds)
	throws BbmFinderException
	{
<span class="nc" id="L858">		methodStart(&quot;findActivityForQueues&quot;, queueIds);</span>
<span class="nc" id="L859">		ActivityQueueDAO activityQueueDao = activityQueueDAOFactory.createDAO();</span>
		try {
<span class="nc" id="L861">			return activityQueueDao.findActivityForQueues(queueIds);</span>
<span class="nc" id="L862">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L863">			handleException(e, false);</span>
<span class="nc" id="L864">			throw e;</span>
		} finally {
<span class="nc" id="L866">			activityQueueDao.cleanUp();</span>
<span class="nc" id="L867">			methodFinish();</span>
		}
	}


	/**
	 * &lt;B&gt;findPropertiesForActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * find properties for a given activity
	 * &lt;P&gt;
	 *
	 * @param activityId
	 *            : id of activity
	 * @return ActivityProperties found for ID
	 */
	public ActivityProperties findPropertiesForActivity(ID activityId) throws BbmFinderException {
<span class="nc" id="L883">		methodStart(&quot;findPropertiesForActivity&quot;, activityId);</span>
<span class="nc" id="L884">		ActivityPropertiesDAO activityPropertiesDAO = new ActivityPropertiesDAO();</span>
		try {
<span class="nc" id="L886">			return activityPropertiesDAO.findActivityProperties(activityId);</span>
<span class="nc" id="L887">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L888">			handleException(e, false);</span>
<span class="nc" id="L889">			throw e;</span>
		} finally {
<span class="nc" id="L891">			activityPropertiesDAO.cleanUp();</span>
<span class="nc" id="L892">			methodFinish();</span>
		}
	}

	/**
	 * find properties of a given list of Activity IDs
	 * 
	 * @param activityIds
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;ActivityProperties&gt; findPropertiesForActivities(Collection&lt;ID&gt; activityIds)
			throws BbmFinderException {
<span class="nc" id="L905">		methodStart(&quot;findPropertiesForActivities&quot;, activityIds);</span>
<span class="nc" id="L906">		ActivityPropertiesDAO activityPropertiesDAO = new ActivityPropertiesDAO();</span>
		try {
<span class="nc" id="L908">			return activityPropertiesDAO.findActivitiesProperties(activityIds);</span>
<span class="nc" id="L909">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L910">			handleException(e, false);</span>
<span class="nc" id="L911">			throw e;</span>
		} finally {
<span class="nc" id="L913">			activityPropertiesDAO.cleanUp();</span>
<span class="nc" id="L914">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * creates given Activity in db, and sets it's id
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to create
	 * @return Activity id
	 */
	public ID createActivity(Activity activity) throws BbmCreateException,
		ActivityValidationException, BbmFinderException {
<span class="nc" id="L930">		methodStart(&quot;createActivity&quot;, activity);</span>
<span class="nc" id="L931">		ActivityDAO activityDao = null;</span>
		try {
<span class="nc" id="L933">			activity.validate();</span>
<span class="nc" id="L934">			activityDao = new ActivityDAO();</span>
<span class="nc" id="L935">			ID actID = activityDao.createObject(activity);</span>
<span class="nc" id="L936">			activity.setID(actID);</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">			if (cacheUsed()) {</span>
<span class="nc" id="L938">				m_ActivityCache.put(actID, findActivityById(actID));</span>
			}
<span class="nc" id="L940">			return actID;</span>
<span class="nc" id="L941">		} catch (ActivityValidationException | BbmCreateException e) {</span>
<span class="nc" id="L942">			handleException(e, true);</span>
<span class="nc" id="L943">			throw e;</span>
		} finally {
<span class="nc bnc" id="L945" title="All 4 branches missed.">			if (activityDao != null) {</span>
<span class="nc" id="L946">				activityDao.cleanUp();</span>
			}
<span class="nc" id="L948">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * creates Activity with media
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to create
	 * @param mediasIds
	 *            : collection of media Ids of type ID to associate to the activity
	 * @return Activity id
	 */
	public ID createActivity(Activity activity, Collection&lt;ID&gt; mediasIds) throws BbmCreateException,
		ActivityValidationException, BbmFinderException {
<span class="nc" id="L966">		methodStart(&quot;createActivity&quot;, activity, mediasIds);</span>

<span class="nc" id="L968">		ActivityMediaDAO activityMediaDao = null;</span>

		try {
<span class="nc" id="L971">			ID activityId = createActivity(activity);</span>

			try {
<span class="nc bnc" id="L974" title="All 4 branches missed.">				if (mediasIds != null &amp;&amp; !mediasIds.isEmpty()) {</span>
<span class="nc" id="L975">					activity.validateWithAssociatedMedia();</span>
<span class="nc" id="L976">					activityMediaDao = new ActivityMediaDAO();</span>
<span class="nc" id="L977">					ActivityMedia activityMedia = new ActivityMedia();</span>
<span class="nc" id="L978">					activityMedia.setActivityId(activityId);</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">					for (ID mediaId : mediasIds) {</span>
<span class="nc" id="L980">						activityMedia.setMediaId(mediaId);</span>
<span class="nc" id="L981">						activityMediaDao.createObject(activityMedia, false);</span>
<span class="nc" id="L982">					}</span>
<span class="nc" id="L983">					activityMediaDao.executeBatch();</span>
				}
<span class="nc" id="L985">				return activityId;</span>
<span class="nc" id="L986">			} catch (ActivityValidationException | BbmCreateException e) {</span>
<span class="nc" id="L987">				handleException(e, true);</span>
<span class="nc" id="L988">				throw e;</span>
<span class="nc" id="L989">			} catch (JdmoException e) {</span>
<span class="nc" id="L990">				handleException(e, true);</span>
<span class="nc" id="L991">				throw new BbmCreateException(e);</span>
			}
		} finally {
<span class="nc bnc" id="L994" title="All 4 branches missed.">			if (activityMediaDao != null) {</span>
<span class="nc" id="L995">				activityMediaDao.cleanUp();</span>
			}
<span class="nc" id="L997">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * creates Activity with media
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to create
	 * @param mediasIds
	 *            : collection of media Ids of type ID to associate to the activity
	 * @return Activity id
	 */
	public ID createActivity(Activity activity, Collection&lt;ID&gt; mediasIds, ActivityProperties activityProperties) throws BbmCreateException,
		ActivityValidationException, BbmFinderException {
<span class="nc" id="L1015">		methodStart(&quot;createActivity&quot;, activity, mediasIds);</span>

<span class="nc" id="L1017">		ActivityMediaDAO activityMediaDao = null;</span>
<span class="nc" id="L1018">		ActivityPropertiesDAO activityPropertiesDAO = null;</span>

		try {
<span class="nc" id="L1021">			ID activityId = createActivity(activity);</span>

			try {
<span class="nc bnc" id="L1024" title="All 4 branches missed.">				if (mediasIds != null &amp;&amp; !mediasIds.isEmpty()) {</span>
<span class="nc" id="L1025">					activity.validateWithAssociatedMedia();</span>
<span class="nc" id="L1026">					activityMediaDao = new ActivityMediaDAO();</span>
<span class="nc" id="L1027">					ActivityMedia activityMedia = new ActivityMedia();</span>
<span class="nc" id="L1028">					activityMedia.setActivityId(activityId);</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">					for (ID mediaId : mediasIds) {</span>
<span class="nc" id="L1030">						activityMedia.setMediaId(mediaId);</span>
<span class="nc" id="L1031">						activityMediaDao.createObject(activityMedia, false);</span>
<span class="nc" id="L1032">					}</span>
<span class="nc" id="L1033">					activityMediaDao.executeBatch();</span>
				}

<span class="nc" id="L1036">				activityProperties.setActivityId(activityId);</span>
<span class="nc" id="L1037">				activityPropertiesDAO = new ActivityPropertiesDAO();</span>
<span class="nc" id="L1038">				activityPropertiesDAO.insertActivityProperties(activityProperties);</span>
<span class="nc" id="L1039">				return activityId;</span>
<span class="nc" id="L1040">			} catch (ActivityValidationException | BbmCreateException e) {</span>
<span class="nc" id="L1041">				handleException(e, true);</span>
<span class="nc" id="L1042">				throw e;</span>
<span class="nc" id="L1043">			} catch (JdmoException e) {</span>
<span class="nc" id="L1044">				handleException(e, true);</span>
<span class="nc" id="L1045">				throw new BbmCreateException(e);</span>
			}
		} finally {
<span class="nc bnc" id="L1048" title="All 4 branches missed.">			if (activityMediaDao != null) {</span>
<span class="nc" id="L1049">				activityMediaDao.cleanUp();</span>
            }
<span class="nc bnc" id="L1051" title="All 4 branches missed.">            if (activityPropertiesDAO != null) {</span>
<span class="nc" id="L1052">                activityPropertiesDAO.cleanUp();</span>
            }
<span class="nc" id="L1054">			methodFinish();</span>
		}
	}

	public ID createActivity(Activity activity, Collection&lt;ID&gt; mediaIds, SystemType externalSystemType)
		throws BbmCreateException, ActivityValidationException, BbmFinderException {
<span class="nc" id="L1060">		methodStart(&quot;createActivity&quot;, activity, externalSystemType);</span>

		// validate
<span class="nc bnc" id="L1063" title="All 2 branches missed.">		if (externalSystemType == null) {</span>
<span class="nc" id="L1064">			throw new BbmCreateException(&quot;externalSystemType is null&quot;);</span>
		}
<span class="nc bnc" id="L1066" title="All 2 branches missed.">		if (activity.getExternalID() == null) {</span>
<span class="nc" id="L1067">			throw new BbmCreateException(&quot;external ID is null&quot;);</span>
		}

		// create
		try {
<span class="nc" id="L1072">			ID activityID = createActivity(activity, mediaIds);</span>
<span class="nc" id="L1073">			boolean insert = true;</span>
<span class="nc" id="L1074">			MapUtil.setWfoToExternalID(externalSystemType, ObjectType.Activity, activity.getID(),</span>
<span class="nc" id="L1075">					activity.getExternalID(), new Jdmo(true), insert);</span>
<span class="nc" id="L1076">			return activityID;</span>
<span class="nc" id="L1077">		} catch (JdmoException e) {</span>
<span class="nc" id="L1078">			handleException(e); // log and rollback transaction</span>
<span class="nc" id="L1079">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L1081">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivityCategory&lt;/B&gt;
	 * &lt;P&gt;
	 * creates given ActivityCategory in db, and sets it's id
	 * &lt;P&gt;
	 *
	 * @param activityCategory
	 *            activityCategory to create
	 * @return ActivityCategory id
	 */
	public ID createActivityCategory(ActivityCategory activityCategory) throws BbmCreateException {
<span class="nc" id="L1096">		methodStart(&quot;createActivityCategory&quot;, activityCategory);</span>
<span class="nc" id="L1097">		ActivityCategoryDAO activityCategoryDao = new ActivityCategoryDAO();</span>
		try {
<span class="nc" id="L1099">			return activityCategoryDao.createObject(activityCategory);</span>
<span class="nc" id="L1100">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1101">			handleException(e, true);</span>
<span class="nc" id="L1102">			throw e;</span>
		} finally {
<span class="nc" id="L1104">			activityCategoryDao.cleanUp();</span>
<span class="nc" id="L1105">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivityMedia&lt;/B&gt;
	 * &lt;P&gt;
	 * creates given ActivityMedia in db, and sets it's id
	 * &lt;P&gt;
	 *
	 * @param activityMedia
	 *            : activityMedia to create
	 * @return ActivityMedia id
	 */
	public ID createActivityMedia(ActivityMedia activityMedia) throws BbmCreateException {
<span class="nc" id="L1120">		methodStart(&quot;createActivityMedia&quot;, activityMedia);</span>

<span class="nc" id="L1122">		ActivityMediaDAO activityMediaDao = null;</span>
		try {
<span class="nc" id="L1124">			Activity activity = findActivityById(activityMedia.getActivityId());</span>
<span class="nc" id="L1125">			activity.validateWithAssociatedMedia();</span>
<span class="nc" id="L1126">			activityMediaDao = new ActivityMediaDAO();</span>
<span class="nc" id="L1127">			return activityMediaDao.createObject(activityMedia);</span>
<span class="nc" id="L1128">		} catch (BbmFinderException | ActivityValidationException | BbmCreateException e) {</span>
<span class="nc" id="L1129">			handleException(e, true);</span>
<span class="nc" id="L1130">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc bnc" id="L1132" title="All 4 branches missed.">			if (activityMediaDao != null) {</span>
<span class="nc" id="L1133">				activityMediaDao.cleanUp();</span>
			}
<span class="nc" id="L1135">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivityMedia&lt;/B&gt;
	 * &lt;P&gt;
	 * creates association of multiple media to an activity
	 * &lt;P&gt;
	 *
	 * @param activityId
	 *            : activity Id
	 * @param mediaIds
	 *            : collection of media ids to associate with the activity
	 * @return collection of newly created ActivityMedia ids
	 */
	public Collection&lt;ID&gt; createActivityMedia(ID activityId, Collection&lt;ID&gt; mediaIds) throws BbmCreateException, 
		ActivityValidationException {
<span class="nc" id="L1153">		methodStart(&quot;createActivityMedia&quot;, activityId, mediaIds);</span>

<span class="nc" id="L1155">		ActivityMediaDAO activityMediaDao = null;</span>
		try {
<span class="nc bnc" id="L1157" title="All 6 branches missed.">			if (mediaIds == null || mediaIds.isEmpty() || activityId == null) {</span>
<span class="nc" id="L1158">				return Collections.emptyList();</span>
			}
<span class="nc" id="L1160">			Activity activity = findActivityById(activityId);</span>
<span class="nc" id="L1161">			activity.validateWithAssociatedMedia();</span>

<span class="nc" id="L1163">			activityMediaDao = new ActivityMediaDAO();</span>
<span class="nc" id="L1164">			ActivityMedia activityMedia = new ActivityMedia();</span>
<span class="nc" id="L1165">			activityMedia.setActivityId(activityId);</span>
<span class="nc" id="L1166">			ArrayList&lt;ID&gt; createdIds = new ArrayList&lt;&gt;(mediaIds.size());</span>
<span class="nc bnc" id="L1167" title="All 2 branches missed.">			for (ID mediaId : mediaIds) {</span>
<span class="nc" id="L1168">				activityMedia.setMediaId(mediaId);</span>
<span class="nc" id="L1169">				createdIds.add(activityMediaDao.createObject(activityMedia, false));</span>
<span class="nc" id="L1170">			}</span>
<span class="nc" id="L1171">			activityMediaDao.executeBatch();</span>
<span class="nc" id="L1172">			return createdIds;</span>
<span class="nc" id="L1173">		} catch (BbmFinderException | JdmoException e) {</span>
<span class="nc" id="L1174">			handleException(e, true);</span>
<span class="nc" id="L1175">			throw new BbmCreateException(e);</span>
<span class="nc" id="L1176">		} catch (ActivityValidationException | BbmCreateException e) {</span>
<span class="nc" id="L1177">			handleException(e, true);</span>
<span class="nc" id="L1178">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1180" title="All 6 branches missed.">			if (activityMediaDao != null) {</span>
<span class="nc" id="L1181">				activityMediaDao.cleanUp();</span>
			}
<span class="nc" id="L1183">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivityMedia&lt;/B&gt;
	 * &lt;P&gt;
	 * creates given ActivityQueue in db, and sets it's id
	 * &lt;P&gt;
	 *
	 * @param activityQueue
	 *            : activityQueue to create
	 * @return ActivityQueue id
	 */
	public ID createActivityQueue(ActivityQueue activityQueue) throws BbmCreateException {
<span class="nc" id="L1198">		methodStart(&quot;createActivityQueue&quot;, activityQueue);</span>

<span class="nc" id="L1200">		ActivityQueueDAO activityQueueDao = null;</span>
		try {
<span class="nc" id="L1202">			Activity activity = findActivityById(activityQueue.getActivityId());</span>
<span class="nc" id="L1203">			activity.validateWithAssociatedQueue();</span>
<span class="nc" id="L1204">			activityQueueDao = activityQueueDAOFactory.createDAO();</span>
<span class="nc" id="L1205">			return activityQueueDao.createObject(activityQueue);</span>
<span class="nc" id="L1206">		} catch (BbmFinderException | ActivityValidationException | BbmCreateException e) {</span>
<span class="nc" id="L1207">			handleException(e, true);</span>
<span class="nc" id="L1208">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc bnc" id="L1210" title="All 4 branches missed.">			if (activityQueueDao != null) {</span>
<span class="nc" id="L1211">				activityQueueDao.cleanUp();</span>
			}
<span class="nc" id="L1213">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;createActivityQueue&lt;/B&gt;
	 * &lt;P&gt;
	 * creates association of multiple queue to an activity
	 * &lt;P&gt;
	 *
	 * @param activityId
	 *            : activity Id
	 * @param queueIds
	 *            : collection of queue ids to associate with the activity
	 * @return collection of newly created ActivityQueue ids
	 */
	public Collection&lt;ID&gt; createActivityQueue(ID activityId, Collection&lt;ID&gt; queueIds) throws BbmCreateException, 
		ActivityValidationException {
<span class="nc" id="L1231">		methodStart(&quot;createActivityQueue&quot;, activityId, queueIds);</span>

<span class="nc" id="L1233">		ActivityQueueDAO activityQueueDao = null;</span>
		try {
<span class="nc bnc" id="L1235" title="All 6 branches missed.">			if (queueIds == null || queueIds.isEmpty() || activityId == null) {</span>
<span class="nc" id="L1236">				return Collections.emptyList();</span>
			}
<span class="nc" id="L1238">			Activity activity = findActivityById(activityId);</span>
<span class="nc" id="L1239">			activity.validateWithAssociatedQueue();</span>

<span class="nc" id="L1241">			activityQueueDao = activityQueueDAOFactory.createDAO();</span>
<span class="nc" id="L1242">			ActivityQueue activityQueue = new ActivityQueue();</span>
<span class="nc" id="L1243">			activityQueue.setActivityId(activityId);</span>
<span class="nc" id="L1244">			ArrayList&lt;ID&gt; createdIds = new ArrayList&lt;&gt;(queueIds.size());</span>
<span class="nc bnc" id="L1245" title="All 2 branches missed.">			for (ID queueId : queueIds) {</span>
<span class="nc" id="L1246">				activityQueue.setQueueId(queueId);</span>
<span class="nc" id="L1247">				createdIds.add(activityQueueDao.createObject(activityQueue, false));</span>
<span class="nc" id="L1248">			}</span>
<span class="nc" id="L1249">			activityQueueDao.executeBatch();</span>
<span class="nc" id="L1250">			return createdIds;</span>
<span class="nc" id="L1251">		} catch (BbmFinderException | JdmoException e) {</span>
<span class="nc" id="L1252">			handleException(e, true);</span>
<span class="nc" id="L1253">			throw new BbmCreateException(e);</span>
<span class="nc" id="L1254">		} catch (ActivityValidationException | BbmCreateException e) {</span>
<span class="nc" id="L1255">			handleException(e, true);</span>
<span class="nc" id="L1256">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1258" title="All 6 branches missed.">			if (activityQueueDao != null) {</span>
<span class="nc" id="L1259">				activityQueueDao.cleanUp();</span>
			}
<span class="nc" id="L1261">			methodFinish();</span>
		}
	}

	// function is used by RTAAServiceEJB to reset activity last updated date
	// this will force report dump to do full dump
	public void updateActivityLastUpdatedDate(Activity activity) throws BbmUpdateException, MultiUserException,
			ActivityValidationException {
<span class="nc" id="L1269">		methodStart(&quot;updateActivityLastUpdatedDate&quot;, activity);</span>
<span class="nc" id="L1270">		ActivityDAO activityDao = null;</span>
		try {
<span class="nc" id="L1272">			activity.validate();</span>
<span class="nc" id="L1273">			activityDao = new ActivityDAO();</span>
<span class="nc" id="L1274">			activity.setLastModifierName(m_sessionContext.getCallerPrincipal().getName());</span>
<span class="nc" id="L1275">			activity.setLastModifiedDate(new Date());</span>

<span class="nc" id="L1277">			activityDao.updateObject(activity);</span>
<span class="nc bnc" id="L1278" title="All 2 branches missed.">			if (cacheUsed()) {</span>
<span class="nc" id="L1279">				m_ActivityCache.put(activity.getID(), activity);</span>
			}
<span class="nc" id="L1281">		} catch (ActivityValidationException | BbmUpdateException | MultiUserException e) {</span>
<span class="nc" id="L1282">			handleException(e, true);</span>
<span class="nc" id="L1283">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1285" title="All 4 branches missed.">			if (activityDao != null) {</span>
<span class="nc" id="L1286">				activityDao.cleanUp();</span>
			}
<span class="nc" id="L1288">			methodFinish();</span>
<span class="nc" id="L1289">		}</span>
<span class="nc" id="L1290">	}</span>

	/**
	 * &lt;B&gt;updateActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * update given activity to db
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to update
	 */
	public void updateActivity(Activity activity) throws BbmUpdateException, MultiUserException,
			ActivityValidationException {
<span class="nc" id="L1303">		methodStart(&quot;updateActivity&quot;, activity);</span>
<span class="nc" id="L1304">		ActivityDAO activityDao = null;</span>
		try {
<span class="nc" id="L1306">			activity.validate();</span>
<span class="nc" id="L1307">			activityDao = new ActivityDAO();</span>

			// only update Last Modified Date when the adherence tolerance was changed.
<span class="nc" id="L1310">			Activity oldActivity = findActivityById(activity.getID());</span>

			// fix QC39049 10SP4+v11: throw exception if an activity is changed from &quot;use in shift&quot; to not and the
			// activity is used in any shift or shift event
<span class="nc bnc" id="L1314" title="All 4 branches missed.">			if (oldActivity.isUsedInShift() &amp;&amp; !activity.isUsedInShift()) {</span>
				// see if the activity is used in shift currently, if yes, throw exception
<span class="nc" id="L1316">				JdmoRowset rs = activityDao.getDMO().createRowset(&quot;select count(*) from shiftassignment where activityid = &quot; + activity.getID());</span>
<span class="nc" id="L1317">				rs.next();</span>
<span class="nc" id="L1318">				int count = rs.getInt(1);</span>
<span class="nc bnc" id="L1319" title="All 2 branches missed.">				if (count &gt; 0) {</span>
					// throw exception
<span class="nc" id="L1321">					throw new ActivityValidationException(</span>
							ActivityValidationException.ACTIVITY_INVALID_UNCHECK_USEDINSHIFT);
				}
			}

<span class="nc bnc" id="L1326" title="All 4 branches missed.">			if (oldActivity.isUsedInShiftEvent() &amp;&amp; !activity.isUsedInShiftEvent()) {</span>
				// see if the activity is used in shift currently, if yes, throw exception
<span class="nc" id="L1328">				JdmoRowset rs = activityDao.getDMO().createRowset(&quot;select count(*) from shifteventassignment where activityid = &quot; + activity.getID());</span>
<span class="nc" id="L1329">				rs.next();</span>
<span class="nc" id="L1330">				int count = rs.getInt(1);</span>
<span class="nc bnc" id="L1331" title="All 2 branches missed.">				if (count &gt; 0) {</span>
					// throw exception
<span class="nc" id="L1333">					throw new ActivityValidationException(</span>
							ActivityValidationException.ACTIVITY_INVALID_UNCHECK_USEDINSHIFT);
				}
			}
<span class="nc bnc" id="L1337" title="All 2 branches missed.">			if (activity.getAdherenceTolerance() != oldActivity.getAdherenceTolerance()) {</span>
<span class="nc" id="L1338">				activity.setLastModifierName(m_sessionContext.getCallerPrincipal().getName());</span>
<span class="nc" id="L1339">				activity.setLastModifiedDate(new Date());</span>
			} else {
<span class="nc" id="L1341">				activity.setLastModifierName(oldActivity.getLastModifierName());</span>
<span class="nc" id="L1342">				activity.setLastModifiedDate(oldActivity.getLastModifiedDate());</span>
			}

<span class="nc" id="L1345">			activityDao.updateObject(activity);</span>
<span class="nc bnc" id="L1346" title="All 2 branches missed.">			if (cacheUsed()) {</span>
<span class="nc" id="L1347">				m_ActivityCache.put(activity.getID(), activity);</span>
			}
<span class="nc" id="L1349">		} catch (BbmFinderException | JdmoException e) {</span>
<span class="nc" id="L1350">			handleException(e, true);</span>
<span class="nc" id="L1351">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L1352">		} catch (ActivityValidationException | BbmUpdateException | MultiUserException e) {</span>
<span class="nc" id="L1353">			handleException(e, true);</span>
<span class="nc" id="L1354">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1356" title="All 4 branches missed.">			if (activityDao != null) {</span>
<span class="nc" id="L1357">				activityDao.cleanUp();</span>
			}
<span class="nc" id="L1359">			methodFinish();</span>
<span class="nc" id="L1360">		}</span>
<span class="nc" id="L1361">	}</span>

	/**
	 * &lt;B&gt;updateActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * update activity including media types (unlink current media types)
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to update
	 * @param mediaIds
	 *            : new medias to link to activity
	 */
	/**
	 * @deprecated in 7.7
	 */
	@Deprecated
	public void updateActivity(Activity activity, Collection mediaIds) throws BbmUpdateException, MultiUserException,
			ActivityValidationException {
<span class="nc" id="L1380">		methodStart(&quot;updateActivity&quot;, activity, mediaIds);</span>

<span class="nc" id="L1382">		ActivityMediaDAO activityMediaDao = null;</span>
		try {
<span class="nc" id="L1384">			updateActivity(activity);</span>

			try {
<span class="nc" id="L1387">				activityMediaDao = new ActivityMediaDAO();</span>
				// unlink old media types
<span class="nc" id="L1389">				activityMediaDao.unlinkAllActivityMedias(activity.getID());</span>
				// link new media types
<span class="nc" id="L1391">				createActivityMedia(activity.getID(), mediaIds);</span>
<span class="nc" id="L1392">			} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1393">				handleException(e, true);</span>
<span class="nc" id="L1394">				throw e;</span>
<span class="nc" id="L1395">			} catch (BbmCreateException | BbmRemoveException e) {</span>
<span class="nc" id="L1396">				handleException(e, true);</span>
<span class="nc" id="L1397">				throw new BbmUpdateException(e);</span>
<span class="nc" id="L1398">			}</span>
		} finally {
<span class="nc bnc" id="L1400" title="All 4 branches missed.">			if (activityMediaDao != null) {</span>
<span class="nc" id="L1401">				activityMediaDao.cleanUp();</span>
			}
<span class="nc" id="L1403">			methodFinish();</span>
<span class="nc" id="L1404">		}</span>
<span class="nc" id="L1405">	}</span>

	public void updateActivity(Activity activity, Collection mediaIds, Collection queueIds) throws BbmUpdateException,
			MultiUserException, ActivityValidationException {
<span class="nc" id="L1409">		methodStart(&quot;updateActivity&quot;, activity, mediaIds, queueIds);</span>

<span class="nc" id="L1411">		ActivityMediaDAO activityMediaDao = null;</span>
<span class="nc" id="L1412">		ActivityQueueDAO activityQueueDao = null;</span>
		try {
<span class="nc" id="L1414">			updateActivity(activity);</span>

			try {
<span class="nc" id="L1417">				activityMediaDao = new ActivityMediaDAO();</span>
				// unlink old media types
<span class="nc" id="L1419">				activityMediaDao.unlinkAllActivityMedias(activity.getID());</span>
				// link new media types
<span class="nc" id="L1421">				createActivityMedia(activity.getID(), mediaIds);</span>

<span class="nc" id="L1423">				activityQueueDao = activityQueueDAOFactory.createDAO();</span>
				// unlink old queues
<span class="nc" id="L1425">				activityQueueDao.unlinkAllActivityQueues(activity.getID());</span>
				// link new queues
<span class="nc" id="L1427">				createActivityQueue(activity.getID(), queueIds);</span>

<span class="nc" id="L1429">			} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1430">				handleException(e, true);</span>
<span class="nc" id="L1431">				throw e;</span>
<span class="nc" id="L1432">			} catch (BbmCreateException | BbmRemoveException e) {</span>
<span class="nc" id="L1433">				handleException(e, true);</span>
<span class="nc" id="L1434">				throw new BbmUpdateException(e);</span>
<span class="nc" id="L1435">			}</span>
		} finally {
<span class="nc bnc" id="L1437" title="All 4 branches missed.">			if (activityMediaDao != null) {</span>
<span class="nc" id="L1438">				activityMediaDao.cleanUp();</span>
			}
<span class="nc bnc" id="L1440" title="All 4 branches missed.">			if (activityQueueDao != null) {</span>
<span class="nc" id="L1441">				activityQueueDao.cleanUp();</span>
			}
<span class="nc" id="L1443">			methodFinish();</span>
<span class="nc" id="L1444">		}</span>
<span class="nc" id="L1445">	}</span>

	/**
	 * &lt;B&gt;updateActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * update activity including media types (unlink current media types), queues and activity properties
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to update
	 * @param mediaIds
	 *            : new medias to link to activity
	 * @param queueIds
	 *            : new queues to link to activity
	 * @param activityProperties
	 *            : properties to link to activity
	 */
	public void updateActivity(Activity activity, Collection mediaIds, Collection queueIds, ActivityProperties activityProperties) throws BbmUpdateException,
		MultiUserException, ActivityValidationException {
<span class="nc" id="L1464">		methodStart(&quot;updateActivity&quot;, activity, mediaIds, queueIds, activityProperties);</span>

<span class="nc" id="L1466">		ActivityMediaDAO activityMediaDao = null;</span>
<span class="nc" id="L1467">		ActivityQueueDAO activityQueueDao = null;</span>
		try {
<span class="nc" id="L1469">			updateActivity(activity);</span>

			try {
<span class="nc" id="L1472">				activityMediaDao = new ActivityMediaDAO();</span>
				// unlink old media types
<span class="nc" id="L1474">				activityMediaDao.unlinkAllActivityMedias(activity.getID());</span>
				// link new media types
<span class="nc" id="L1476">				createActivityMedia(activity.getID(), mediaIds);</span>

<span class="nc" id="L1478">				activityQueueDao = activityQueueDAOFactory.createDAO();</span>
				// unlink old queues
<span class="nc" id="L1480">				activityQueueDao.unlinkAllActivityQueues(activity.getID());</span>
				// link new queues
<span class="nc" id="L1482">				createActivityQueue(activity.getID(), queueIds);</span>

				//Update Activity Properties
<span class="nc" id="L1485">				updateActivityProperties(activityProperties);</span>

<span class="nc" id="L1487">			} catch (ActivityValidationException e) {</span>
<span class="nc" id="L1488">				handleException(e, true);</span>
<span class="nc" id="L1489">				throw e;</span>
<span class="nc" id="L1490">			} catch (BbmCreateException | BbmRemoveException e) {</span>
<span class="nc" id="L1491">				handleException(e, true);</span>
<span class="nc" id="L1492">				throw new BbmUpdateException(e);</span>
<span class="nc" id="L1493">			}</span>
		} finally {
<span class="nc bnc" id="L1495" title="All 4 branches missed.">			if (activityMediaDao != null) {</span>
<span class="nc" id="L1496">				activityMediaDao.cleanUp();</span>
			}
<span class="nc bnc" id="L1498" title="All 4 branches missed.">			if (activityQueueDao != null) {</span>
<span class="nc" id="L1499">				activityQueueDao.cleanUp();</span>
			}
<span class="nc" id="L1501">			methodFinish();</span>
<span class="nc" id="L1502">		}</span>
<span class="nc" id="L1503">	}</span>

	/**
	 * &lt;B&gt;updateActivity&lt;/B&gt;
	 * &lt;P&gt;
	 * update activity including activity properties
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            : activity to update
	 * @param activityProperties
	 *            : properties to link to activity
	 */
	public void updateActivity(Activity activity, ActivityProperties activityProperties) throws BbmUpdateException, BbmCreateException,
		MultiUserException, ActivityValidationException {
<span class="nc" id="L1518">		methodStart(&quot;updateActivity&quot;, activity, activityProperties);</span>

		try {
<span class="nc" id="L1521">			updateActivity(activity);</span>

			try {
				//Update Activity Properties
<span class="nc" id="L1525">				updateActivityProperties(activityProperties);</span>
<span class="nc" id="L1526">			} catch (ActivityValidationException | BbmUpdateException | BbmCreateException e) {</span>
<span class="nc" id="L1527">				handleException(e, true);</span>
<span class="nc" id="L1528">				throw e;</span>
<span class="nc" id="L1529">			}</span>
		} finally {
<span class="nc" id="L1531">			methodFinish();</span>
<span class="nc" id="L1532">		}</span>
<span class="nc" id="L1533">	}</span>

	/**
	 * &lt;B&gt;updateActivityProperties&lt;/B&gt;
	 * &lt;P&gt;
	 * update activity properties
	 * &lt;P&gt;
	 *
	 * @param activityProperties
	 *            : properties to link to activity
	 */
	public void updateActivityProperties(ActivityProperties activityProperties) throws BbmUpdateException, BbmCreateException,
		MultiUserException, ActivityValidationException {
<span class="nc" id="L1546">		methodStart(&quot;updateActivityProperties&quot;, activityProperties);</span>

<span class="nc" id="L1548">		ActivityPropertiesDAO activityPropertiesDAO = null;</span>
		try {
<span class="nc" id="L1550">			Activity activity = findActivityById(activityProperties.getActivityId());</span>
<span class="nc" id="L1551">			activity.validate();</span>
<span class="nc" id="L1552">			activityPropertiesDAO = new ActivityPropertiesDAO();</span>

<span class="nc" id="L1554">			ActivityProperties testActivityProperties = activityPropertiesDAO.findActivityProperties(activityProperties.getActivityId());</span>
<span class="nc bnc" id="L1555" title="All 2 branches missed.">			if (testActivityProperties.getActivityId().equals(activityPropertiesDAO.getDontExistID())) {</span>
<span class="nc" id="L1556">				activityPropertiesDAO.insertActivityProperties(activityProperties);</span>
			} else {
<span class="nc" id="L1558">				activityPropertiesDAO.updateObject(activityProperties);</span>
			}
<span class="nc" id="L1560">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1561">			handleException(e, true);</span>
<span class="nc" id="L1562">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L1563">		} catch (ActivityValidationException | BbmUpdateException | BbmCreateException e) {</span>
<span class="nc" id="L1564">			handleException(e, true);</span>
<span class="nc" id="L1565">			throw e;</span>
		}finally {
<span class="nc bnc" id="L1567" title="All 4 branches missed.">			if (activityPropertiesDAO != null) {</span>
<span class="nc" id="L1568">				activityPropertiesDAO.cleanUp();</span>
			}
<span class="nc" id="L1570">			methodFinish();</span>
<span class="nc" id="L1571">		}</span>
<span class="nc" id="L1572">	}</span>
		/**
	 * &lt;B&gt;matchActivityWithExternalID&lt;/B&gt;
	 * &lt;P&gt;
	 * update activitymap to match existing activity id with external id
	 * &lt;P&gt;
	 *
	 * @param objValue
	 *            : activity to update
	 * @param externalSystemType
	 *            : system from which activity is pushed
	 * @param activityExternalId
	 *            : External ID of the activity that is pushed
	 *
	 */
	public void matchActivityWithExternalID(Activity objValue, SystemType externalSystemType, ID activityExternalId)
	  throws BbmUpdateException {

<span class="nc" id="L1590">		methodStart(&quot;matchActivityWithExternalID&quot;, objValue, externalSystemType, activityExternalId);</span>

		// validate
<span class="nc bnc" id="L1593" title="All 2 branches missed.">		if (externalSystemType == null) {</span>
<span class="nc" id="L1594">			throw new BbmUpdateException(&quot;externalSystemType is null&quot;);</span>
		}
<span class="nc bnc" id="L1596" title="All 2 branches missed.">		if (activityExternalId == null) {</span>
<span class="nc" id="L1597">			throw new BbmUpdateException(&quot;externalSourceId is null&quot;);</span>
		}
<span class="nc bnc" id="L1599" title="All 4 branches missed.">		if ((activityExternalId.isInt() &amp;&amp; !externalSystemType.isExtIdAnInt)) {</span>
<span class="nc" id="L1600">			throw new BbmUpdateException(&quot;For this external system, externalSourceId must be a string not an integer&quot;);</span>
		}
<span class="nc bnc" id="L1602" title="All 4 branches missed.">		if ((!activityExternalId.isInt() &amp;&amp; externalSystemType.isExtIdAnInt)) {</span>
<span class="nc" id="L1603">			throw new BbmUpdateException(&quot;For this external system, externalSourceId must be an integer not a string&quot;);</span>
		}

		// match external id for existing activity
		try {
<span class="nc" id="L1608">			boolean insert = true;</span>
<span class="nc" id="L1609">			MapUtil.setWfoToExternalID(externalSystemType, ObjectType.Activity, objValue.getID(), activityExternalId,</span>
					new Jdmo(true), insert);
     }
<span class="nc" id="L1612">      catch (JdmoException e)</span>
      {
<span class="nc" id="L1614">          handleException(e);</span>
<span class="nc" id="L1615">          throw new BbmUpdateException(e);</span>
      }
      finally
      {
<span class="nc" id="L1619">          methodFinish();</span>
<span class="nc" id="L1620">      }</span>

<span class="nc" id="L1622">	}</span>
	/**
	 * &lt;B&gt;updateActivityCategory&lt;/B&gt;
	 * &lt;P&gt;
	 * update given activityCategory to db
	 * &lt;P&gt;
	 *
	 * @param activityCategory
	 *            : activityCategory to update
	 */
	public void updateActivityCategory(ActivityCategory activityCategory) throws BbmUpdateException, MultiUserException {
<span class="nc" id="L1633">		methodStart(&quot;updateActivityCategory&quot;, activityCategory);</span>
<span class="nc" id="L1634">		ActivityCategoryDAO activityCategoryDAO = new ActivityCategoryDAO();</span>
		try {
<span class="nc" id="L1636">			activityCategoryDAO.updateObject(activityCategory);</span>
<span class="nc" id="L1637">		} catch (BbmUpdateException | MultiUserException e) {</span>
<span class="nc" id="L1638">			handleException(e, true);</span>
<span class="nc" id="L1639">			throw e;</span>
		} finally {
<span class="nc" id="L1641">			activityCategoryDAO.cleanUp();</span>
<span class="nc" id="L1642">			methodFinish();</span>
<span class="nc" id="L1643">		}</span>
<span class="nc" id="L1644">	}</span>

	public DeletionResult deleteActivity(ID activityID) throws DeleteException, RemoteException {
<span class="nc" id="L1647">		methodStart(&quot;deleteActivity&quot;, activityID);</span>
		try {
			//TODO: determine if we can get away with a default locale here
<span class="nc" id="L1650">			DeletionResult result = deleteManager.deleteObject(activityID, Activity.OBJECT_TYPE_ACTIVITY, null,</span>
<span class="nc" id="L1651">					LocalizationManager.getInstance().getLocaleContext(Locale.US, Locale.US, Locale.US));</span>
<span class="nc" id="L1652">			deleteActivityFromCache(activityID, false);</span>
<span class="nc" id="L1653">			return result;</span>
<span class="nc" id="L1654">		} catch (DeleteException | RemoteException e) {</span>
<span class="nc" id="L1655">			handleException(e);</span>
<span class="nc" id="L1656">			throw e;</span>
		} finally {
<span class="nc" id="L1658">			methodFinish();</span>
		}
	}



	/**
	 * To support deletion from Facade layer, it should refreshed the cache also
	 *
	 * @param activityID       
	 * @param markDeletionOnly remove Activity object or just market it
	 * @throws RemoteException
	 */
	public void deleteActivityFromCache(ID activityID, boolean markDeletionOnly) {
<span class="nc bnc" id="L1672" title="All 2 branches missed.">		methodStart(&quot;deleteActivityFromCache&quot;, activityID, markDeletionOnly ? Boolean.TRUE : Boolean.FALSE);</span>
		try {
<span class="nc bnc" id="L1674" title="All 2 branches missed.">			if (cacheUsed()) {</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">				if (markDeletionOnly) {</span>
<span class="nc" id="L1676">					Activity activity = (Activity) m_ActivityCache.get(activityID);</span>
<span class="nc bnc" id="L1677" title="All 2 branches missed.">					if (activity != null) {</span>
<span class="nc" id="L1678">						activity.setDeleted(true);</span>
						// the deleted actvity is renamed so new activty can be created with same name.
<span class="nc" id="L1680">						activity.setName(activity.getName()+&quot;-&quot;+activity.getID());</span>
<span class="nc" id="L1681">						m_ActivityCache.put(activityID, activity);</span>
					}
<span class="nc" id="L1683">				} else {</span>
<span class="nc" id="L1684">					m_ActivityCache.remove(activityID);</span>
				}
			}
		} finally {
<span class="nc" id="L1688">			methodFinish();</span>
<span class="nc" id="L1689">		}</span>
<span class="nc" id="L1690">	}</span>

	/**
	 * &lt;B&gt;deleteActivity&lt;/B&gt; deletes given activity from db
	 * &lt;P&gt;
	 *
	 * @param activity
	 *            activity to delete
	 *            &lt;P&gt;
	 * @return boolean if successful
	 */
	public void deleteActivityForTestOnly(Activity activity) throws BbmRemoveException {
<span class="nc" id="L1702">		methodStart(&quot;deleteActivityForTestOnly&quot;, activity);</span>
<span class="nc bnc" id="L1703" title="All 2 branches missed.">		if (activity == null) {</span>
<span class="nc" id="L1704">			return;</span>
		}
		try {
<span class="nc" id="L1707">			ArrayList&lt;Activity&gt; activitiesToDelete = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L1708">			activitiesToDelete.add(activity);</span>
<span class="nc" id="L1709">			deleteActivitiesForTestOnly(activitiesToDelete);</span>
		} finally {
<span class="nc" id="L1711">			methodFinish();</span>
<span class="nc" id="L1712">		}</span>
<span class="nc" id="L1713">	}</span>

	public void deleteActivitiesForTestOnly(Collection&lt;Activity&gt; activitiesToDelete) throws BbmRemoveException {
<span class="nc" id="L1716">		methodStart(&quot;deleteActivitiesForTestOnly&quot;, activitiesToDelete);</span>
<span class="nc bnc" id="L1717" title="All 4 branches missed.">		if (activitiesToDelete == null || activitiesToDelete.isEmpty()) {</span>
<span class="nc" id="L1718">			return;</span>
		}
<span class="nc" id="L1720">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;&gt;(activitiesToDelete.size());</span>
<span class="nc bnc" id="L1721" title="All 2 branches missed.">		for (Activity activity : activitiesToDelete) {</span>
<span class="nc" id="L1722">			ids.add(activity.getID());</span>
<span class="nc" id="L1723">		}</span>
<span class="nc" id="L1724">		ActivityDAO dao = new ActivityDAO();</span>
		try {
<span class="nc" id="L1726">			DAOEJBUtil.deleteObjects(dao, ids, this, &quot;deleteActivitiesForTestOnly&quot;);</span>
		} finally {
<span class="nc" id="L1728">			methodFinish();</span>
<span class="nc" id="L1729">		}</span>
<span class="nc" id="L1730">	}</span>

	public void deleteActivityCategoryForTestOnly(ActivityCategory activityCategory) throws BbmRemoveException {
<span class="nc" id="L1733">		methodStart(&quot;deleteActivityCategoryForTestOnly&quot;, activityCategory);</span>
<span class="nc bnc" id="L1734" title="All 2 branches missed.">		if (activityCategory == null) {</span>
<span class="nc" id="L1735">			return;</span>
		}
		try {
<span class="nc" id="L1738">			ArrayList&lt;ActivityCategory&gt; activityCategoriesToDelete = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L1739">			activityCategoriesToDelete.add(activityCategory);</span>
<span class="nc" id="L1740">			deleteActivityCategoriesForTestOnly(activityCategoriesToDelete);</span>
		} finally {
<span class="nc" id="L1742">			methodFinish();</span>
<span class="nc" id="L1743">		}</span>
<span class="nc" id="L1744">	}</span>

	public void deleteActivityCategoriesForTestOnly(Collection&lt;ActivityCategory&gt; activityCategories) throws BbmRemoveException {
<span class="nc" id="L1747">		methodStart(&quot;deleteActivityCategoriesForTestOnly&quot;, activityCategories);</span>
<span class="nc bnc" id="L1748" title="All 4 branches missed.">		if (activityCategories == null || activityCategories.isEmpty()) {</span>
<span class="nc" id="L1749">			return;</span>
		}
<span class="nc" id="L1751">		ActivityCategoryDAO dao = new ActivityCategoryDAO();</span>
<span class="nc" id="L1752">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;&gt;(activityCategories.size());</span>
<span class="nc bnc" id="L1753" title="All 2 branches missed.">		for (ActivityCategory activityCategory : activityCategories) {</span>
<span class="nc" id="L1754">			ids.add(activityCategory.getID());</span>
<span class="nc" id="L1755">		}</span>
		try {
<span class="nc" id="L1757">			DAOEJBUtil.deleteObjects(dao, ids, this, &quot;deleteActivityCategoriesForTestOnly&quot;);</span>
		} finally {
<span class="nc" id="L1759">			methodFinish();</span>
<span class="nc" id="L1760">		}</span>
<span class="nc" id="L1761">	}</span>

	public void deleteActivityMediaForTestOnly(ActivityMedia activityMedia) throws BbmRemoveException {
<span class="nc" id="L1764">		methodStart(&quot;deleteActivityMediaForTestOnly&quot;, activityMedia);</span>
<span class="nc bnc" id="L1765" title="All 2 branches missed.">		if (activityMedia == null) {</span>
<span class="nc" id="L1766">			return;</span>
		}
		try {
<span class="nc" id="L1769">			ArrayList&lt;ActivityMedia&gt; toDelete = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L1770">			toDelete.add(activityMedia);</span>
<span class="nc" id="L1771">			deleteActivityMediasForTestOnly(toDelete);</span>
		} finally {
<span class="nc" id="L1773">			methodFinish();</span>
<span class="nc" id="L1774">		}</span>
<span class="nc" id="L1775">	}</span>

	public void deleteActivityMediasForTestOnly(Collection&lt;ActivityMedia&gt; toDelete) throws BbmRemoveException {
<span class="nc" id="L1778">		methodStart(&quot;deleteActivityMediasForTestOnly&quot;, toDelete);</span>
<span class="nc bnc" id="L1779" title="All 4 branches missed.">		if (toDelete == null || toDelete.isEmpty()) {</span>
<span class="nc" id="L1780">			return;</span>
		}
<span class="nc" id="L1782">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;&gt;(toDelete.size());</span>
<span class="nc bnc" id="L1783" title="All 2 branches missed.">		for (ActivityMedia activityMedia : toDelete) {</span>
<span class="nc" id="L1784">			ids.add(activityMedia.getID());</span>
<span class="nc" id="L1785">		}</span>
<span class="nc" id="L1786">		ActivityMediaDAO dao = new ActivityMediaDAO();</span>
		try {
<span class="nc" id="L1788">			DAOEJBUtil.deleteObjects(dao, ids, this, &quot;deleteActivityMediasForTestOnly&quot;);</span>
		} finally {
<span class="nc" id="L1790">			methodFinish();</span>
<span class="nc" id="L1791">		}</span>
<span class="nc" id="L1792">	}</span>

	private boolean cacheUsed() {
<span class="nc bnc" id="L1795" title="All 2 branches missed.">		if (WhatIfMode) {</span>
<span class="nc" id="L1796">			return false;</span>
		}

		// If Cache is null, then cache is not used
		boolean currentStatus;
		try {
			// If cache is never instantiated, give it a chance to get initialized
			// If ConfigManager is cache aware, then always check it dynamically
<span class="nc bnc" id="L1804" title="All 4 branches missed.">			if (m_ActivityCache == null || m_DBConfigManager.cacheUsed()) {</span>
				// Access ConfigManager for the cache setting
<span class="nc bnc" id="L1806" title="All 2 branches missed.">				if (ConfigCacheUtil.isCacheEnabled(m_DBConfigManager, ConfigKey.ACTIVITY_CACHE_USAGE)) {</span>
					// If Cache is null, initialize it
<span class="nc bnc" id="L1808" title="All 2 branches missed.">					if (m_ActivityCache == null) {</span>
<span class="nc" id="L1809">						m_ActivityCache = CacheFactory.getCache(JNDINames.BBM_ACTIVITYMANAGER_EJBHOME,</span>
<span class="nc" id="L1810">								ActivityManagerEJB.class.getClassLoader());</span>
					}
<span class="nc" id="L1812">					currentStatus = true;</span>
				} else {
<span class="nc" id="L1814">					currentStatus = false;</span>
				}
			} else {
				// Or if m_TimeRecordCache is available, we think cache is enabled
<span class="nc bnc" id="L1818" title="All 2 branches missed.">				currentStatus = (m_ActivityCache != null);</span>
			}
<span class="nc" id="L1820">		} catch (Exception e) {</span>
<span class="nc" id="L1821">			currentStatus = false;</span>
<span class="nc" id="L1822">		}</span>
		// If there is state transition, we need flush cache content
<span class="nc bnc" id="L1824" title="All 2 branches missed.">		if (lastCheckStatus != currentStatus) {</span>
			// If from Cache turn on to off, or vice versa, we will flush cache content
<span class="nc bnc" id="L1826" title="All 2 branches missed.">			if (m_ActivityCache != null) {</span>
<span class="nc" id="L1827">				m_ActivityCache.clear();</span>
				try {
					// if cache enabled, preload content
<span class="nc bnc" id="L1830" title="All 2 branches missed.">					if (currentStatus) {</span>
<span class="nc" id="L1831">						initCache();</span>
					}
<span class="nc" id="L1833">				} catch (Exception e) {</span>
<span class="nc" id="L1834">					m_cat.error(e.getMessage());</span>
<span class="nc" id="L1835">				}</span>
			}
<span class="nc" id="L1837">			lastCheckStatus = currentStatus;</span>
		}
<span class="nc" id="L1839">		return currentStatus;</span>
	}

	/**
	 * get all activities that are not from seed data
	 *
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection getAllNonSeedActivities() throws BbmFinderException {
<span class="nc" id="L1849">		methodStart(&quot;getAllNonSeedActivities&quot;);</span>
<span class="nc" id="L1850">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L1852">			return activityDao.getAllNonSeedActivities();</span>
<span class="nc" id="L1853">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1854">			handleException(e, false);</span>
<span class="nc" id="L1855">			throw e;</span>
<span class="nc" id="L1856">		} catch (Exception e) {</span>
<span class="nc" id="L1857">			handleException(e, false);</span>
<span class="nc" id="L1858">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1860">			activityDao.cleanUp();</span>
<span class="nc" id="L1861">			methodFinish();</span>
		}
	}

	public Collection&lt;Activity&gt; getAllActivities() throws BbmFinderException {
<span class="nc" id="L1866">		methodStart(&quot;getAllActivities&quot;);</span>
<span class="nc" id="L1867">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L1869">			return activityDao.getAllObjects();</span>
<span class="nc" id="L1870">		} catch (BbmFinderException | RuntimeException e) {</span>
<span class="nc" id="L1871">			handleException(e, false);</span>
<span class="nc" id="L1872">			throw e;</span>
		} finally {
<span class="nc" id="L1874">			activityDao.cleanUp();</span>
<span class="nc" id="L1875">			methodFinish();</span>
		}
	}

	public Collection getTOBalanceForActivities(Collection empIDs, Collection activityIDs, Collection actCatIDs)
			throws BbmFinderException {
<span class="nc" id="L1881">		methodStart(&quot;getTOBalanceForActivities&quot;);</span>
<span class="nc" id="L1882">		ActivityTimeOffBalanceDAO dao = new ActivityTimeOffBalanceDAO();</span>
		try {
<span class="nc" id="L1884">			return dao.getTOBalanceForActivities(empIDs, activityIDs, actCatIDs);</span>
<span class="nc" id="L1885">		} catch (Exception e) {</span>
<span class="nc" id="L1886">			handleException(e, false);</span>
<span class="nc" id="L1887">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1889">			dao.cleanUp();</span>
<span class="nc" id="L1890">			methodFinish();</span>
		}
	}

	public void updateOrInsertActivityTOBalance(Collection activityTOBalCol) throws BbmFinderException {
<span class="nc" id="L1895">		methodStart(&quot;updateOrInsertActivityTOBalance&quot;);</span>
<span class="nc" id="L1896">		ActivityTimeOffBalanceDAO dao = new ActivityTimeOffBalanceDAO();</span>
		try {
<span class="nc" id="L1898">			dao.updateOrInsertActivityTOBalance(activityTOBalCol);</span>
<span class="nc" id="L1899">		} catch (Exception e) {</span>
<span class="nc" id="L1900">			handleException(e, false);</span>
<span class="nc" id="L1901">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1903">			dao.cleanUp();</span>
<span class="nc" id="L1904">			methodFinish();</span>
<span class="nc" id="L1905">		}</span>
<span class="nc" id="L1906">	}</span>

	public HashMap getActivityTOBalanceMap(Collection empIDs, Collection actIDs, Collection actCatIDs)
			throws BbmFinderException {
<span class="nc" id="L1910">		methodStart(&quot;getActivityTOBalanceMap&quot;);</span>
<span class="nc" id="L1911">		ActivityTimeOffBalanceDAO dao = null;</span>
		try {
<span class="nc" id="L1913">			dao = new ActivityTimeOffBalanceDAO();</span>
<span class="nc" id="L1914">			return dao.getActivityTOBalanceMap(empIDs, actIDs, actCatIDs);</span>
<span class="nc" id="L1915">		} catch (Exception e) {</span>
<span class="nc" id="L1916">			handleException(e, false);</span>
<span class="nc" id="L1917">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc bnc" id="L1919" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1920">				dao.cleanUp();</span>
			}
<span class="nc" id="L1922">			methodFinish();</span>
		}
	}

	public void deleteActivityTOBalance(Collection ids) throws BbmRemoveException {
<span class="nc" id="L1927">		methodStart(&quot;deleteActivityTOBalance&quot;);</span>
<span class="nc" id="L1928">		ActivityTimeOffBalanceDAO dao = new ActivityTimeOffBalanceDAO();</span>
		try {
<span class="nc" id="L1930">			dao.deleteObjects(ids);</span>
		} finally {
<span class="nc" id="L1932">			dao.cleanUp();</span>
<span class="nc" id="L1933">			methodFinish();</span>
<span class="nc" id="L1934">		}</span>
<span class="nc" id="L1935">	}</span>

	//Special Activities API START
	private TimeOffHoursManagerBridge getTimeOffHoursManagerBridge() throws Exception
	{
<span class="nc bnc" id="L1940" title="All 2 branches missed.">		if (m_timeOffHoursManagerBridge == null)</span>
		{
<span class="nc" id="L1942">		    String gcrType = &quot;TIMEOFFHOURSMANAGER_BRIDGE&quot;;</span>
<span class="nc" id="L1943">		    GCRManager m_gcrManager  = CoreManagerFactory.getGCRManagerRemote(WhatIfMode);</span>
<span class="nc" id="L1944">		    Collection entries = m_gcrManager.getGCREntryOfType(gcrType);</span>
<span class="nc" id="L1945">		    Class clazz = Class.forName(((GCREntry) (entries.iterator().next())).getHook());</span>
<span class="nc" id="L1946">		    m_timeOffHoursManagerBridge = (TimeOffHoursManagerBridge) clazz.newInstance();</span>
		}
<span class="nc" id="L1948">	    return m_timeOffHoursManagerBridge;</span>
	}

	public int getMaxDurationOverride(ID orgID, ID activityID) throws Exception
	{
<span class="nc" id="L1953">		TimeOffHoursManagerBridge bridge = getTimeOffHoursManagerBridge();</span>
<span class="nc" id="L1954">		return bridge.getMaxDurationOverride(orgID, activityID);</span>
    }

	public void setMaxDurationOverride(ID orgID, ID activityID, int value) throws Exception
	{
<span class="nc" id="L1959">		TimeOffHoursManagerBridge bridge = getTimeOffHoursManagerBridge();</span>
<span class="nc" id="L1960">		bridge.setMaxDurationOverride(orgID, activityID, value);</span>
<span class="nc" id="L1961">	}</span>

	public int getAdherenceToleranceOverride(ID orgID, ID activityID) throws Exception
	{
<span class="nc" id="L1965">		TimeOffHoursManagerBridge bridge = getTimeOffHoursManagerBridge();</span>
<span class="nc" id="L1966">		return bridge.getAdherenceToleranceOverride(orgID, activityID);</span>
	}

	public void setAdherenceToleranceOverride(ID orgID, ID activityID, int value) throws Exception
	{
<span class="nc" id="L1971">		TimeOffHoursManagerBridge bridge = getTimeOffHoursManagerBridge();</span>
<span class="nc" id="L1972">		bridge.setAdherenceToleranceOverride(orgID, activityID, value);</span>
<span class="nc" id="L1973">	}</span>

	public Activity getVacationOverride(ID orgID) throws Exception
	{
<span class="nc" id="L1977">		TimeOffHoursManagerBridge bridge = getTimeOffHoursManagerBridge();</span>
<span class="nc" id="L1978">		return bridge.getVacationOverride(orgID);</span>
	}

	public void setVacationOverride(ID orgID, ID vacationActivityID) throws Exception
	{
<span class="nc" id="L1983">		TimeOffHoursManagerBridge bridge = getTimeOffHoursManagerBridge();</span>
<span class="nc" id="L1984">		bridge.setVacationOverride(orgID, vacationActivityID);</span>
<span class="nc" id="L1985">	}</span>
	//Special Activities API END
	
	public Collection&lt;ID&gt; getDailyPoolAllotmentActivityIDs(boolean checkTimeOffWithAllotment) throws BbmFinderException {
<span class="nc" id="L1989">		methodStart(&quot;getDailyPoolAllotmentActivities&quot;);</span>
<span class="nc" id="L1990">		ActivityDAO activityDao = new ActivityDAO();</span>
		try {
<span class="nc" id="L1992">			return activityDao.getDailyPoolAllotmentActivityIDs(checkTimeOffWithAllotment);</span>
<span class="nc" id="L1993">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1994">			handleException(e, false);</span>
<span class="nc" id="L1995">			throw e;</span>
		} finally {
<span class="nc" id="L1997">			activityDao.cleanUp();</span>
<span class="nc" id="L1998">			methodFinish();</span>
		}
	}

	public void unlinkQueueActivities(Collection&lt;ID&gt; queueIds) throws BbmRemoveException {
<span class="nc" id="L2003">		methodStart(&quot;unlinkQueueActivities&quot;, queueIds);</span>

<span class="nc" id="L2005">		ActivityQueueDAO activityQueueDao = activityQueueDAOFactory.createDAO();</span>
		try {
<span class="nc" id="L2007">			activityQueueDao.unlinkQueueActivities(queueIds);</span>
<span class="nc" id="L2008">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L2009">			handleException(e, true);</span>
<span class="nc" id="L2010">			throw e;</span>
		} finally {
<span class="nc" id="L2012">			activityQueueDao.cleanUp();</span>
<span class="nc" id="L2013">			methodFinish();</span>
<span class="nc" id="L2014">		}</span>
<span class="nc" id="L2015">	}</span>

	public ID getActivityIdByName(String name) throws BbmFinderException {
<span class="nc" id="L2018">		methodStart(&quot;getActivityIdByName&quot;, name);</span>
<span class="nc" id="L2019">		ActivityDAO activityDAO = activityDAOFactory.createDAO();</span>
		ID activityId;
		try {
<span class="nc" id="L2022">			activityId = activityDAO.getActivityIdByName(name);</span>
<span class="nc" id="L2023">		} catch (JdmoException e) {</span>
<span class="nc" id="L2024">			handleException(e, false);</span>
<span class="nc" id="L2025">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L2027">			activityDAO.cleanUp();</span>
<span class="nc" id="L2028">			methodFinish();</span>
<span class="nc" id="L2029">		}</span>
<span class="nc" id="L2030">		return activityId;</span>
	}

	public void setActivityQueueDAOFactory(ActivityQueueDAOFactory activityQueueDAOFactory) {
<span class="nc" id="L2034">		this.activityQueueDAOFactory = activityQueueDAOFactory;</span>
<span class="nc" id="L2035">	}</span>

	public void setActivityDAOFactory(ActivityDAOFactory activityDAOFactory) {
<span class="nc" id="L2038">		this.activityDAOFactory = activityDAOFactory;</span>
<span class="nc" id="L2039">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>