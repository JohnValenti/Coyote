<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PropertyGetter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.util.orm</a> &gt; <span class="el_source">PropertyGetter.java</span></div><h1>PropertyGetter.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.util.orm;

import java.beans.Introspector;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;

import com.bluepumpkin.common.datatypes.ID;

class PropertyGetter&lt;T&gt; {

	//Property name (without the &quot;get&quot;) to BaseAccessor map
	Map&lt;String, BaseAccessor&gt; getterCache;
	String typeSimpleName;
	//getterList and getterPropertyNames are just so that we can access the properties through an index and avoid a map lookup. 
	//see getProperty with the index parameter
	List&lt;BaseAccessor&gt; getterList;
	List&lt;String&gt; getterPropertyNames;
	String tableName;
	Set&lt;String&gt; excludedProperties;
	Set&lt;String&gt; includedProperties;



	PropertyGetter(Class&lt;T&gt; entityClass) {
<span class="nc" id="L30">		this(entityClass, null, null);</span>
<span class="nc" id="L31">	}</span>

<span class="nc" id="L33">	PropertyGetter(Class&lt;T&gt; entityClass, Set&lt;String&gt; includedProperties, Set&lt;String&gt; excludedProperties) {</span>
<span class="nc" id="L34">		this.excludedProperties = excludedProperties;</span>
<span class="nc" id="L35">		this.includedProperties = includedProperties;</span>
<span class="nc" id="L36">		typeSimpleName = entityClass.getSimpleName();</span>
<span class="nc" id="L37">		getterCache = getGetters(entityClass);</span>
<span class="nc" id="L38">		javax.persistence.Table tableAnnotation = entityClass.getAnnotation(javax.persistence.Table.class);</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">		if (tableAnnotation != null) {</span>
<span class="nc" id="L40">			tableName = tableAnnotation.name();</span>
		}
<span class="nc" id="L42">		initializeListsFromCache();</span>
<span class="nc" id="L43">	}</span>

	private void initializeListsFromCache() {
<span class="nc" id="L46">		getterList = new ArrayList&lt;BaseAccessor&gt;(getterCache.size());</span>
<span class="nc" id="L47">		getterPropertyNames = new ArrayList&lt;String&gt;(getterCache.size());</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">		for (Map.Entry&lt;String, BaseAccessor&gt; entry : getterCache.entrySet()) {</span>
<span class="nc" id="L49">			getterList.add(entry.getValue());</span>
<span class="nc" id="L50">			getterPropertyNames.add(entry.getKey());</span>
<span class="nc" id="L51">		}</span>
<span class="nc" id="L52">	}</span>

	List&lt;String&gt; getGetterPropertyNames() {
<span class="nc" id="L55">		return getterPropertyNames;</span>
	}

	String getTypeSimpleName() {
<span class="nc" id="L59">		return typeSimpleName;</span>
	}

	String getTableName() {
<span class="nc bnc" id="L63" title="All 2 branches missed.">		if(tableName!=null) {</span>
<span class="nc" id="L64">			return tableName;</span>
		}
<span class="nc" id="L66">		return getTypeSimpleName();</span>
	}



	Object getProperty(Object target, String propertyName) throws IllegalAccessException, InvocationTargetException {
<span class="nc" id="L72">		BaseAccessor setter = getterCache.get(propertyName);</span>
<span class="nc" id="L73">		return setter.getProperty(target);</span>
	}

	Object getProperty(Object target, int propertyIndex) throws IllegalAccessException, InvocationTargetException {
<span class="nc" id="L77">		BaseAccessor setter = getterList.get(propertyIndex);</span>
<span class="nc" id="L78">		return setter.getProperty(target);</span>
	}

	Class&lt;?&gt; getPropertyType(int propertyIndex) {
<span class="nc" id="L82">		BaseAccessor setter = getterList.get(propertyIndex);</span>
<span class="nc" id="L83">		return setter.getGetterReturnType();</span>
	}

	private Map&lt;String, BaseAccessor&gt; getGetters(Class&lt;T&gt; theClass) {

<span class="nc" id="L88">		Map&lt;String, BaseAccessor&gt; result = new TreeMap&lt;String, BaseAccessor&gt;(String.CASE_INSENSITIVE_ORDER);</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">		for (Method method : OrmUtils.getMethods(theClass)) {</span>

<span class="nc" id="L92">			String propertyName = getPropertyName(method);</span>
<span class="nc bnc" id="L93" title="All 4 branches missed.">			if (propertyName != null &amp;&amp; !propertyName.isEmpty()) {</span>
<span class="nc" id="L94">				BaseAccessor accessor = getGetter(method);</span>
<span class="nc" id="L95">				result.put(propertyName, accessor);</span>
			}
<span class="nc" id="L97">		}</span>

<span class="nc" id="L99">		return result;</span>
	}

	private String getPropertyName(Method method) { // NOSONAR
<span class="nc" id="L103">		final String methodName = method.getName();</span>

<span class="nc bnc" id="L105" title="All 4 branches missed.">		if (methodName == null || !methodName.startsWith(&quot;get&quot;)) {</span>
<span class="nc" id="L106">			return null;</span>
		}

<span class="nc bnc" id="L109" title="All 2 branches missed.">		if (method.isAnnotationPresent(javax.persistence.Transient.class)) {</span>
<span class="nc" id="L110">			return null;</span>
		}

<span class="nc" id="L113">		String propertyName = Introspector.decapitalize(methodName.substring(3));</span>

<span class="nc bnc" id="L115" title="All 4 branches missed.">		if (includedProperties != null &amp;&amp; !includedProperties.contains(propertyName)) {</span>
<span class="nc" id="L116">			return null;</span>
		}

<span class="nc bnc" id="L119" title="All 4 branches missed.">		if (excludedProperties != null &amp;&amp; excludedProperties.contains(propertyName)) {</span>
<span class="nc" id="L120">			return null;</span>
		}

<span class="nc" id="L123">		return propertyName;</span>
	}

	private static BaseAccessor getGetter(Method m) {
<span class="nc" id="L127">		Class&lt;?&gt; returnType = m.getReturnType();</span>
		//custom getter for ID
<span class="nc bnc" id="L129" title="All 2 branches missed.">		if (returnType == ID.class) {</span>
<span class="nc" id="L130">			return new IDAccessor(m);</span>
		}
<span class="nc" id="L132">		return new BaseAccessor(m);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>