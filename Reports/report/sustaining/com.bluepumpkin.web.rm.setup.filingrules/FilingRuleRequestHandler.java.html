<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FilingRuleRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.setup.filingrules</a> &gt; <span class="el_source">FilingRuleRequestHandler.java</span></div><h1>FilingRuleRequestHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.setup.filingrules;

import java.rmi.RemoteException;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Set;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.setup.filingrules.model.RequestFilingRule;
import com.bluepumpkin.web.bbm.organization.OrganizationRequestHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.reflection.ParameterUtil;

/**
 * Title          FilingRuleRequestHandler
 * Description	  Handle request for the FilingRule page
 * Copyright      Copyright (c) 2002
 * Company        Blue Pumpkin Software, Inc
 * @author        Shubhangi Chavan
 * @version       1.0
 */
<span class="nc" id="L39">public class FilingRuleRequestHandler extends OrganizationRequestHandler {</span>
<span class="nc" id="L40">	private static final Category log = Log.initCategory(FilingRuleRequestHandler.class.getName());</span>
	private static final String LIST_PAGE = &quot;listPage&quot;;
	private static final String FORM_PAGE = &quot;editPage&quot;;

	private static final String APPLY_RULE = &quot;APPLY_RULE&quot;;
	private static final String NEW_TIMEOFF = &quot;NEW_TIME_OFF&quot;;
	private static final String NEW_TIMEOFF_WITHDRAW = &quot;NEW_TIMEOFF_WITHDRAW&quot;;
	private static final String NEW_SHIFTSWAP_WITHDRAW = &quot;NEW_SHIFTSWAP_WITHDRAW&quot;;
	protected static final String NEW_FLEXTIME = &quot;NEW_FLEX_TIME&quot;;
	private static final String NEW_SHIFTSWAP = &quot;NEW_SHIFT_SWAP&quot;;
	private static final String NEW_SHIFTBID = &quot;NEW_SHIFT_BID&quot;;
	private static final String NEW_CUSTOMSHIFT = &quot;NEW_CUSTOM_SHIFT&quot;;
<span class="nc" id="L52">	private static final String[] ACTION_NAMES = new String[] { APPLY_RULE, NEW_TIMEOFF, NEW_TIMEOFF_WITHDRAW, NEW_SHIFTSWAP_WITHDRAW,</span>
			NEW_FLEXTIME, NEW_SHIFTSWAP, NEW_SHIFTBID, NEW_CUSTOMSHIFT };
<span class="nc" id="L54">	private Set&lt;String&gt; blockGetActionsSet = new HashSet&lt;&gt;(Arrays.asList(ACTION_NAMES));</span>
	private static final String CREATE_RULE_TYPE = &quot;createRuleType&quot;;
	private static final String GET_METHOD = &quot;GET&quot;;
	private static final String APPSCAN_ERROR_LOG = &quot;CSRF security constraint violated. Cannot GET with a pageAction parameter&quot;;

	/**
	 * Process Request for the User page
	 * @param   context   RequestContext
	 * @throws Exception
	 */
	@Override
	public void processRequest(RequestContext context) throws Exception {
		// Process requested action
<span class="nc" id="L67">		String method = context.getRequest().getMethod();</span>
<span class="nc" id="L68">		String pageAction = getPageAction(context);</span>
<span class="nc bnc" id="L69" title="All 4 branches missed.">		boolean inValid =  GET_METHOD.equals(method) &amp;&amp; isBlockedPageAction(pageAction);</span>
<span class="nc" id="L70">		HttpServletResponse response = context.getResponse();</span>
		//Fix Appscan issue &quot;Body Parameter Accepted in Query&quot;
<span class="nc bnc" id="L72" title="All 2 branches missed.">		if (inValid) {</span>
<span class="nc" id="L73">			log.error(APPSCAN_ERROR_LOG);</span>
<span class="nc" id="L74">			response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L75">			return;</span>
		}
<span class="nc" id="L77">		validateIDParameter(context.getRequest(), &quot;selectedID&quot;);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">		if (isAction(context, PageAction.EDIT) ||</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">				isAction(context, PageAction.DIALOG_OK)) {</span>
<span class="nc" id="L80">			goToFormPage(context);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">		} else if (isAction(context, NEW_TIMEOFF)) {</span>
<span class="nc" id="L82">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_TIMEOFF);
<span class="nc" id="L85">			goToFormPage(context);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">		} else if (isAction(context, NEW_TIMEOFF_WITHDRAW)) {</span>
<span class="nc" id="L87">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_TIMEOFF_WITHDRAW);
<span class="nc" id="L90">			goToFormPage(context);</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">		} else if (isAction(context, NEW_SHIFTSWAP_WITHDRAW)) {</span>
<span class="nc" id="L92">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_SHIFTSWAP_WITHDRAW);
<span class="nc" id="L95">			goToFormPage(context);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">		} else if (isAction(context, NEW_FLEXTIME)) {</span>
<span class="nc" id="L97">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_FLEXTIME);
<span class="nc" id="L100">			goToFormPage(context);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">		} else if (isAction(context, NEW_SHIFTSWAP)) {</span>
<span class="nc" id="L102">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_SHIFTSWAP);
<span class="nc" id="L105">			goToFormPage(context);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">		} else if (isAction(context, NEW_SHIFTBID)) {</span>
<span class="nc" id="L107">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_SHIFTBID);
<span class="nc" id="L110">			goToFormPage(context);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">		} else if (isAction(context, NEW_CUSTOMSHIFT)) {</span>
<span class="nc" id="L112">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_CUSTSHIFT);
<span class="nc" id="L115">			goToFormPage(context);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">		} else if (isAction(context, PageAction.DELETE)) {</span>
<span class="nc" id="L117">			processDelete(context);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		} else if (isAction(context, APPLY_RULE)) {</span>
<span class="nc" id="L119">			processApplyRule(context);</span>
<span class="nc" id="L120">			setNextPage(context, LIST_PAGE);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">		} else if (isAction(context, PageAction.SAVE)) {</span>
<span class="nc" id="L122">			processSave(context);</span>
<span class="nc" id="L123">			setNextPage(context, LIST_PAGE);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">		} else if (isAction(context, PageAction.DONE) ||</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">				isAction(context, PageAction.NEW_ID)) {</span>
<span class="nc" id="L126">			setNextPage(context, LIST_PAGE);</span>
		} else {
<span class="nc" id="L128">			setNextPage(context, LIST_PAGE);</span>
		}
<span class="nc" id="L130">	}</span>
	boolean isBlockedPageAction(String pageAction) {
<span class="nc bnc" id="L132" title="All 2 branches missed.">		if (StringUtil.isEmpty(pageAction)) {</span>
<span class="nc" id="L133">			return false;</span>
		}

<span class="nc" id="L136">		return blockGetActionsSet.contains(pageAction);</span>
	}

	private void validateIDParameter(HttpServletRequest httpServletRequest, String parameter) {
		// selectedID
<span class="nc" id="L141">		ParameterUtil.assertOptionalCommaSeparatedLongValues(httpServletRequest, parameter);</span>
<span class="nc" id="L142">	}</span>
	/**
	 * Sets the page to be displayed
	 * @param   context   RequestContext
	 */
	private void goToFormPage(RequestContext context) {

		// Check if authorized then display Form page else display List Page
<span class="nc bnc" id="L150" title="All 2 branches missed.">		if (!isAuthorizedForOrg(context,</span>
				new String[] {
					PrivilegeKeys.TOM_SETFILINGRULES,
					PrivilegeKeys.SS_SETFILINGRULES,
					PrivilegeKeys.SB_SETFILINGRULES,
					PrivilegeKeys.CS_SETFILINGRULES,
					PrivilegeKeys.FT_SETFILINGRULES
				},
				true)) {
<span class="nc" id="L159">			setNextPage(context, LIST_PAGE);</span>
<span class="nc" id="L160">			return;</span>
		}

<span class="nc" id="L163">		setNextPage(context, FORM_PAGE);</span>
<span class="nc" id="L164">	}</span>

	/**
	 * Deletes a FilingRule
	 * @param context RequestContext	The Request context object
	 */
	private void processDelete(RequestContext context) {
		/*Steps to be followed
		1. set the next page, Check if Authorized
		2. Instantiate the List model since its a delete and the user
		should be shown the same page
		4. Retreive the Ids selected by the user for deletion use the
		the method of the list model that returns array of ID's
		5. Invoke the delete function of ModelHandler by passing
		appropriate parameters
		6. cache the model */
<span class="nc bnc" id="L180" title="All 2 branches missed.">		if (!isAuthorizedForOrg(context,</span>
				new String[] {
					PrivilegeKeys.TOM_SETFILINGRULES,
					PrivilegeKeys.SS_SETFILINGRULES,
					PrivilegeKeys.SB_SETFILINGRULES,
					PrivilegeKeys.CS_SETFILINGRULES,
					PrivilegeKeys.FT_SETFILINGRULES
				},
				true)) {
<span class="nc" id="L189">			return;</span>
		}

<span class="nc" id="L192">		FilingRuleListPageModel model = new FilingRuleListPageModel(context);</span>
<span class="nc" id="L193">		model.extractParameters(context.getRequest());</span>
<span class="nc" id="L194">		context.setPageModel(model);</span>

		try {
<span class="nc" id="L197">			setNextPage(context, LIST_PAGE);</span>

			// Security check
			//if (!isAuthorized(context, REQUIRED_PRIVILEGE))	return;

			// Extract Parameter


			// Process Delete
<span class="nc" id="L206">			ID[] ids = model.getSelectedFilingRuleIDs();</span>
			// Invoke the delete method of the Model Handler here
<span class="nc" id="L208">			FilingRuleModelHandler.deleteFilingRule(ids[0]);</span>
<span class="nc" id="L209">		} catch(Exception ex) {</span>
<span class="nc" id="L210">			handleException(model, ex, RmWebBundleKey.ORG_RM_FILING_RULE_DELETE_FAILURE,</span>
					RmWebLogBundleKey.ORG_RM_FILING_RULE_DELETE_FAILURE);
<span class="nc" id="L212">		}</span>
<span class="nc" id="L213">	}</span>


	/**
	 * Saves a Applied Flag for Filing Rules
	 * @param   context RequestContext
	 */
	private void processApplyRule(RequestContext context) {
<span class="nc bnc" id="L221" title="All 2 branches missed.">		if (!isAuthorizedForOrg(context,</span>
				new String[] {
					PrivilegeKeys.TOM_SETFILINGRULES,
					PrivilegeKeys.SS_SETFILINGRULES,
					PrivilegeKeys.SB_SETFILINGRULES,
					PrivilegeKeys.CS_SETFILINGRULES,
					PrivilegeKeys.FT_SETFILINGRULES
				},
				true)) {
<span class="nc" id="L230">			return;</span>
		}

<span class="nc" id="L233">		FilingRuleListPageModel model = new FilingRuleListPageModel(context);</span>
<span class="nc" id="L234">		model.extractParameters(context.getRequest());</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">		if (model.validate()) {</span>
			try {
<span class="nc" id="L237">				String appliedRuleIds[] = model.getAppliedRuleIds();</span>
<span class="nc" id="L238">				String totalRuleIds[] = model.getTotalRuleIds();</span>
<span class="nc" id="L239">				HashMap map = new HashMap(31);</span>
<span class="nc bnc" id="L240" title="All 4 branches missed.">				if (totalRuleIds != null &amp;&amp; totalRuleIds.length != 0) {</span>
<span class="nc" id="L241">					int l = totalRuleIds.length;</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">					for (int i = 0; i &lt; l; i++) {</span>
<span class="nc" id="L243">						map.put(new ID(totalRuleIds[i]), &quot;false&quot;);</span>
					}
				}
<span class="nc bnc" id="L246" title="All 4 branches missed.">				if (appliedRuleIds != null &amp;&amp; appliedRuleIds.length != 0) {</span>
<span class="nc" id="L247">					int l = appliedRuleIds.length;</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">					for (int i = 0; i &lt; l; i++) {</span>
<span class="nc" id="L249">						map.put(new ID(appliedRuleIds[i]), &quot;true&quot;);</span>
					}
				}
<span class="nc" id="L252">				FilingRuleModelHandler.saveApplied(model.getSelectedIDObject(),</span>
						map);
<span class="nc" id="L254">			}	catch(Exception ex) {</span>
<span class="nc" id="L255">				handleException(model, ex, RmWebBundleKey.ORG_RM_FILING_RULE_UPDATE_FAILURE,</span>
					RmWebLogBundleKey.ORG_RM_FILING_RULE_UPDATE_FAILURE);
<span class="nc" id="L257">			}</span>
		}
<span class="nc" id="L259">	}</span>

	/**
	 * Saves a Filing Rule
	 * @param  context RequestContext
	 * @throws RemoteException
	 * @throws MultiUserException
	 */
	private void processSave(RequestContext context)
			throws RemoteException, MultiUserException {
<span class="nc bnc" id="L269" title="All 2 branches missed.">		if (!isAuthorizedForOrg(context,</span>
				new String[] {
					PrivilegeKeys.TOM_SETFILINGRULES,
					PrivilegeKeys.SS_SETFILINGRULES,
					PrivilegeKeys.SB_SETFILINGRULES,
					PrivilegeKeys.CS_SETFILINGRULES,
					PrivilegeKeys.FT_SETFILINGRULES
				},
				true)) {
<span class="nc" id="L278">			return;</span>
		}

<span class="nc" id="L281">		FilingRuleEditPageModel model = new FilingRuleEditPageModel(context);</span>
<span class="nc" id="L282">		model.extractParameters(context.getRequest());</span>

		// Store page model in request object
<span class="nc" id="L285">		context.setPageModel(model);</span>
<span class="nc" id="L286">		RequestFilingRule rfr = model.getFilingRule();</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">		if(model.validate()) {</span>
			try {
<span class="nc" id="L289">				rfr.setID(model.getRuleID());</span>
<span class="nc" id="L290">				rfr.setOrganizationId(model.getSelectedIDObject());</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">				if (rfr.getID() == null) {</span>
<span class="nc" id="L292">					rfr.setApplied(true);</span>
<span class="nc" id="L293">					ID id = FilingRuleModelHandler.createFilingRule(rfr);</span>
<span class="nc" id="L294">					rfr.setID(id);</span>
<span class="nc" id="L295">				}</span>
				else {
<span class="nc" id="L297">					FilingRuleModelHandler.updateFilingRule(rfr);</span>
				}
<span class="nc" id="L299">			} catch(BbmCreateException ex) {</span>
<span class="nc" id="L300">				handleException(model, ex, RmWebBundleKey.ORG_RM_FILING_RULE_CREATE_FAILURE,</span>
						RmWebLogBundleKey.ORG_RM_FILING_RULE_CREATE_FAILURE);
<span class="nc" id="L302">			}	catch(BbmUpdateException ex) {</span>
<span class="nc" id="L303">				handleException(model, ex, RmWebBundleKey.ORG_RM_FILING_RULE_UPDATE_FAILURE,</span>
					RmWebLogBundleKey.ORG_RM_FILING_RULE_UPDATE_FAILURE);
<span class="nc" id="L305">			}</span>
		}
<span class="nc" id="L307">	}</span>

	private void handleException(PageModel model, Exception ex, String rbKey, String logRBKey) {
<span class="nc" id="L310">		model.addPageMessage(Message.ERROR_TYPE, rbKey, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L311">		log.l7dError(logRBKey, ex);</span>
<span class="nc" id="L312">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>