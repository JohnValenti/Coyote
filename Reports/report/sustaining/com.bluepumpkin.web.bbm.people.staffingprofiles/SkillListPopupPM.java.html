<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SkillListPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.people.staffingprofiles</a> &gt; <span class="el_source">SkillListPopupPM.java</span></div><h1>SkillListPopupPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.people.staffingprofiles;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.wfm.keys.WfmJavaScriptFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.container.ContainerPC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.PopupWindowPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.validator.InRangeFieldValidator;

public class SkillListPopupPM extends PopupWindowPM {
	private static final long serialVersionUID = 1L;

	public static final String FORM_ACTION = &quot;skill_list_popup&quot;;
	public static final String POPUP_ID = &quot;POPUP_SKILL&quot;;
	public static final String POPUP_ARGS = &quot;skillAssignmentIDs,isByOrg,isSelectionPopup,ownerID,selectedIDs&quot;;
	public static final String SELECTION_CLASSIFICATION_FN = &quot;selClassification&quot;;
	
	private SkillListPC m_listPC;
	private FormTwoColumnPC skillAssignmentFormPC;
	private ContainerPC m_containerPC;
	private Collection&lt;Skill&gt; skills;
	private boolean isByOrg;
	private ID ownerID;
	private TimeZone optimizationTargetTimeZone;
<span class="fc" id="L47">	private boolean isSelectionPopup = false;</span>
<span class="fc" id="L48">	private HashSet&lt;ID&gt; selectedIDs = new HashSet&lt;ID&gt;();</span>
	
<span class="fc" id="L50">	private Map&lt;ID, Organization&gt; orgMap = new HashMap&lt;ID, Organization&gt;();</span>
<span class="fc" id="L51">	private Map&lt;ID, Campaign&gt; campaignMap = new HashMap&lt;ID, Campaign&gt;();</span>
<span class="fc" id="L52">	private Map&lt;ID, Activity&gt; activityMap = new HashMap&lt;ID, Activity&gt;();</span>
	
	public SkillListPopupPM(RequestContext context) {
<span class="fc" id="L55">		super(context);</span>
<span class="fc" id="L56">		setIsIgnorePageDirty(true);</span>
<span class="fc" id="L57">		m_containerPC = new ContainerPC(context);</span>
<span class="fc" id="L58">		addChildComponent(m_containerPC);</span>
<span class="fc" id="L59">		addRequiredJavaScriptFile(WfmJavaScriptFileID.STAFFING_PROFILE_POPUP);</span>
<span class="fc" id="L60">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>

<span class="fc" id="L62">	}</span>
	
	public static SkillListPopupPM getInstance(RequestContext context) {
<span class="fc" id="L65">		return (SkillListPopupPM)getInstance(context, SkillListPopupPM.class);</span>
	}
	
	protected void initializeModel() {
<span class="fc bfc" id="L69" title="All 2 branches covered.">		if (m_isInitialized)</span>
<span class="fc" id="L70">			return;</span>
		else
<span class="fc" id="L72">			m_isInitialized = true;</span>
		try {
<span class="fc" id="L74">			loadData();</span>
<span class="fc" id="L75">			initContentTitle();</span>
<span class="fc" id="L76">			initList();</span>
//			initSkillAssignmentForm();
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">			if (isSelectionPopup) {</span>
<span class="fc" id="L79">				ToolbarTextButton addButton = m_toolbar.createCloseWindowButton(</span>
<span class="fc" id="L80">						&quot;addSkills&quot;, m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
								BbmWebBundleKey.FS_ADD_SKILLS), true);
<span class="fc" id="L82">				addButton.setCustomJS(m_toolbar.getName() + &quot;.disableButton('addSkills'); StaffingProfileSelectionUtil.addSkills();&quot;);</span>
<span class="fc" id="L83">				m_toolbar.addToolbarElement(addButton);</span>
<span class="fc" id="L84">				m_toolbar.addCloseWindowTextButton(&quot;cancel&quot;, m_localizer.i18n(</span>
						CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_CANCEL), true);
			}
<span class="nc" id="L87">		} catch (Exception ex) {</span>
<span class="nc" id="L88">			handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L89">		}</span>
<span class="fc" id="L90">	}</span>
	
	protected void initUtilityPane() {
<span class="fc" id="L93">		getUtilityPane().setIsHelpEnabled(false);</span>
<span class="fc" id="L94">	}</span>
	
	protected void initContentTitle() {
<span class="fc" id="L97">		m_contentTitlePC.setPageTitle(getLocalizer().i18n(</span>
				BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.FS_SKILLS));
<span class="fc" id="L99">	}</span>
	
	protected void loadData() throws Exception {
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">		if (ownerID != null) {</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">			if (isByOrg) {</span>
<span class="fc" id="L104">				Collection &lt;Skill&gt; tempSkillCol = WfmManagerFactory.getSkillManager(m_context.isInWhatIfMode()).getAvailableSkillsInOrg(ownerID);</span>
<span class="fc" id="L105">				skills = new ArrayList&lt;Skill&gt;();</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">				for (Iterator iterator = tempSkillCol.iterator(); iterator.hasNext();) {</span>
<span class="fc" id="L107">					Skill skill = (Skill) iterator.next();</span>
<span class="fc" id="L108">					Skill correctSkill = WfmManagerFactory.getSkillManager(m_context.isInWhatIfMode()).getSkillByStringID(skill.getID());</span>
<span class="fc" id="L109">					skills.add(correctSkill);</span>
<span class="fc" id="L110">				}</span>
			}
		} 

		// If we are assigning skills to some staffing profiles, filter out the skills that are already assigned to all staffing profiles 
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">		if (selectedIDs.size() &gt; 0) {</span>
<span class="nc" id="L116">			Iterator&lt;Skill&gt; iter = skills.iterator();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L118">				Skill skill = iter.next();</span>
<span class="nc" id="L119">				ID id = skill.getID();</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">				if (selectedIDs.contains(id)) iter.remove();</span>
<span class="nc" id="L121">			}</span>
		} 
<span class="fc" id="L123">	}</span>
	
	protected void initList() {
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">		if (skills != null) {</span>
<span class="fc" id="L127">			m_listPC = new SkillListPC(getRequestContext(), skills, optimizationTargetTimeZone, orgMap, </span>
					campaignMap, activityMap);
<span class="fc" id="L129">			addChildComponent(m_listPC);</span>
<span class="fc" id="L130">			m_listPC.getHeader().setSortable(true);</span>
<span class="fc" id="L131">			m_containerPC.addComponent(m_listPC);</span>
			
<span class="fc" id="L133">			skillAssignmentFormPC = new FormTwoColumnPC(m_context);</span>
<span class="fc" id="L134">			addChildComponent(skillAssignmentFormPC);</span>
<span class="fc" id="L135">			skillAssignmentFormPC.setTitle(&quot;&quot;);</span>
			
<span class="fc" id="L137">			FormInputPC proficiencyPC = new FormInputPC(m_context);</span>
<span class="fc" id="L138">			proficiencyPC.reset(&quot;txtProficiency&quot;, m_localizer.formatNumber(1.0, 1), FormInputPC.TYPE_NUMERIC, false);</span>
<span class="fc" id="L139">			proficiencyPC.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L140">			skillAssignmentFormPC.addRow(getProficiencyLabel(),	proficiencyPC.getHtmlDisplay());</span>
			
<span class="fc" id="L142">			InRangeFieldValidator proficiencyValidator = new InRangeFieldValidator(this, &quot;txtProficiency&quot;,</span>
					BbmWebBundleKey.FS_STAFFING_PROFILES_PROFICIENCY, BbmWebBundleKey.BUNDLE_NAME, 0.1, 9.9);
<span class="fc" id="L144">			proficiencyValidator.setValidateClientSideOnly(true);</span>
<span class="fc" id="L145">			addValidator(proficiencyValidator);</span>

<span class="fc" id="L147">			FormInputPC priorityPC = new FormInputPC(m_context);</span>
<span class="fc" id="L148">			this.addChildComponent(priorityPC);</span>
<span class="fc" id="L149">			priorityPC.reset(&quot;txtPriority&quot;, m_localizer.formatNumber(1), FormInputPC.TYPE_INTEGER, false);</span>
<span class="fc" id="L150">			priorityPC.setLowerLimit(1, true);</span>
<span class="fc" id="L151">			priorityPC.setUpperLimit(99, true);</span>
<span class="fc" id="L152">			priorityPC.setInputFieldDesc(BbmWebBundleKey.FS_STAFFING_PROFILES_SKILL_PRIORITY, BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L153">			priorityPC.setIsRequired(true);</span>
<span class="fc" id="L154">			priorityPC.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L155">			skillAssignmentFormPC.addRow(getPriorityLabel(), priorityPC.getHtmlDisplay());</span>
<span class="fc" id="L156">			skillAssignmentFormPC.addRow(getClassificationLabel(), </span>
<span class="fc" id="L157">					HtmlUtil.makeSelectInput(SELECTION_CLASSIFICATION_FN ,&quot;&quot;, </span>
							null, 
<span class="fc" id="L159">							getClassifications()));</span>
<span class="fc" id="L160">			m_containerPC.addComponent(skillAssignmentFormPC);</span>
		}
<span class="fc" id="L162">	}</span>
	
	public String getHtmlDisplay() {
<span class="fc" id="L165">		return m_containerPC.getHtmlDisplay();</span>
	}
	
	public void setOptimizationTargetTimeZoneID(String optimizationTargetTimeZoneID) {
<span class="nc" id="L169">		this.optimizationTargetTimeZone = TimeZone.getTimeZone(optimizationTargetTimeZoneID);</span>
<span class="nc" id="L170">	}</span>
	
	public void setIsByOrg(boolean isByOrg) {
<span class="fc" id="L173">		this.isByOrg = isByOrg;</span>
<span class="fc" id="L174">	}</span>
	
	public void setIsSelectionPopup(boolean isSelectionPopup) {
<span class="fc" id="L177">		this.isSelectionPopup = isSelectionPopup;</span>
<span class="fc" id="L178">	}</span>
	
	public void setOwnerID(String ownerID) {
<span class="fc" id="L181">		this.ownerID = new ID(ownerID);</span>
<span class="fc" id="L182">	}</span>
	
	public void setSelectedIDs(String selectedIDs) {
<span class="nc" id="L185">		this.selectedIDs = new HashSet&lt;ID&gt;(StringUtil.parseIDStringToCollection(selectedIDs));</span>
<span class="nc" id="L186">	}</span>
	
	private ArrayList&lt;StringsPair&gt; getClassifications () {
<span class="fc" id="L189">		ArrayList&lt;StringsPair&gt; colls = null;</span>
<span class="fc" id="L190">		colls = new ArrayList&lt;StringsPair&gt; (3);</span>
<span class="fc" id="L191">		colls.add(new StringsPair(&quot;0&quot;, m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.FS_STAFFING_PROFILES_SKILL_CLASSIFICATION_PRIMARY)));</span>
<span class="fc" id="L192">		colls.add(new StringsPair(&quot;1&quot;, m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.FS_STAFFING_PROFILES_SKILL_CLASSIFICATION_RESERVE1)));</span>
<span class="fc" id="L193">		colls.add(new StringsPair(&quot;2&quot;, m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.FS_STAFFING_PROFILES_SKILL_CLASSIFICATION_RESERVE2)));</span>
<span class="fc" id="L194">		return colls;</span>
	}
	
	private String getProficiencyLabel(){
<span class="fc" id="L198">		return m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.FS_STAFFING_PROFILES_SKILL_PROFICIENCY);</span>
	}
	
	private String getPriorityLabel(){
<span class="fc" id="L202">		return m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.FS_STAFFING_PROFILES_SKILL_PRIORITY);</span>
	}
	
	private String getClassificationLabel() {
<span class="fc" id="L206">		return m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.FS_STAFFING_PROFILES_SKILL_CLASSIFICATION);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>