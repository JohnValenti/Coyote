<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffBidSummaryPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.timeoffbid</a> &gt; <span class="el_source">TimeOffBidSummaryPM.java</span></div><h1>TimeOffBidSummaryPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.timeoffbid;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.setup.timeoffbid.model.TimeOffBid;
import com.bluepumpkin.web.bbm.campaign.sp.SchedulingPeriodUtil;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.data.wrapper.NumberWrapper;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagecomponent.selection.SelectableItems;
import com.witness.web.uif.pagecomponent.table.GenericHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.SummaryPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;

/**
 * File:         TimeOffBiddingSummaryPM
 * Description:  Page model for the extended list of time off bids
 * Copyright:    Copyright (c) 2016
 * Company:      Verint System, inc
 * @author       Truc Pham
 */
public class TimeOffBidSummaryPM extends SummaryPM { // NOSONAR
	/**
	 *
	 */
	private static final long serialVersionUID = 1L;

<span class="nc" id="L48">	private static String FORM_ACTION = &quot;time_off_bid_summary&quot;; // NOSONAR</span>

	private MultiColListPC timeOffBidListPC;
	private ResourceBundle rmBundle;
	private ResourceBundle bbmBundle;
<span class="nc" id="L53">	private Collection&lt;TimeOffBid&gt; timeOffBids = Collections.emptyList();</span>
<span class="nc" id="L54">	private Map&lt;ID, String&gt; activityIdNames = Collections.emptyMap();</span>
	private User viewingUser;
	private TimeZone viewingTimeZone;
	private String openLbl;
	private String closedLbl;
<span class="nc" id="L59">	private boolean isPageEnabled = true;</span>
	private TimeOffBid selectedTimeOffBid;
	/**
	 * Constructor
	 */
	public TimeOffBidSummaryPM(RequestContext context) {
<span class="nc" id="L65">		super(context);</span>
<span class="nc" id="L66">		setFormAction(FORM_ACTION);</span>
<span class="nc" id="L67">		rmBundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L68">		bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>

		// Init and add Multi Column List sub-component
<span class="nc" id="L71">		timeOffBidListPC = new MultiColListPC(context);</span>
<span class="nc" id="L72">		addChildComponent(timeOffBidListPC);</span>

<span class="nc" id="L74">		openLbl = i18n(m_common_bundle, UIFWebBundleKey.STATUS_OPEN);</span>
<span class="nc" id="L75">		closedLbl = i18n(m_common_bundle, UIFWebBundleKey.STATUS_CLOSED);</span>

<span class="nc" id="L77">		viewingUser = context.getUser();</span>
<span class="nc" id="L78">		viewingTimeZone = m_context.getViewingTimeZone();</span>
		// Add JavaScript Variables
<span class="nc" id="L80">		addJSVariable(DELETE_CONFIRMATION, rmBundle, RmWebBundleKey.RM_TIMEOFF_BID_DELETE_CONFIRM);</span>

<span class="nc" id="L82">	}</span>

	/**
	 * Return an instance of the model that is ready for rendering
	 */
	public static PageModel getInstance(RequestContext context) throws Exception { // NOSONAR
<span class="nc" id="L88">		return getInstance(context, TimeOffBidSummaryPM.class);</span>
	}

	/**
	 * Initialize Selectable Items
	 *
	 * @throws Exception
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	@Override
	protected void loadData() throws Exception {
		try {
<span class="nc bnc" id="L100" title="All 2 branches missed.">			if (m_context.getUser().getEmployeeID() == null) {</span>
<span class="nc" id="L101">				isPageEnabled = false;</span>
<span class="nc" id="L102">				return;</span>
			}
<span class="nc" id="L104">			Collection&lt;ID&gt; orgIDs = OrganizationModelHandler.getAllOrgIdsInUserScope(m_context, m_context.getUser());</span>
<span class="nc" id="L105">			timeOffBids = TimeOffBidModelHandler.getTimeOffBidsForOrgIDs(orgIDs);</span>
<span class="nc" id="L106">			activityIdNames = TimeOffBidModelHandler.getActivityIDNamesInBidsByOrgIds(orgIDs);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">			if (getSelectedIDObject() != null) {</span>
<span class="nc" id="L108">				selectedTimeOffBid = TimeOffBidModelHandler.getTimeOffBidByID(getSelectedIDObject());</span>
			}
<span class="nc" id="L110">		} catch (Exception ex) {</span>
<span class="nc" id="L111">			Message msg = handleUnableToLoadDataErrorAndLogAsDebug(log, ex);</span>
<span class="nc" id="L112">			msg.setAssociatedMessage(ex.getLocalizedMessage());</span>
<span class="nc" id="L113">		}</span>
<span class="nc" id="L114">	}</span>

	/**
	 * Initialize Content Title
	 */
	@Override
	protected void initContentTitle() {
<span class="nc" id="L121">		m_contentTitlePC.setPageTitle(i18n(rmBundle, RmWebBundleKey.RM_TIMEOFF_BID_SUMMARY));</span>
<span class="nc" id="L122">		m_contentTitlePC.setItemNameText(HtmlUtil.NBSP);</span>
<span class="nc" id="L123">	}</span>

	private GenericHeaderData addHeader(TableHeaderPC header, ResourceBundle bundle, String rbKey) {
<span class="nc" id="L126">		return header.addColumnHeaderData(rbKey, i18n(bundle, rbKey));</span>
	}

	/**
	 * Initialize Header
	 */
	@Override
	protected void initHeader() {
<span class="nc bnc" id="L134" title="All 2 branches missed.">		if (isPageEnabled) {</span>
<span class="nc" id="L135">			TableHeaderPC header = timeOffBidListPC.getHeader();</span>
<span class="nc" id="L136">			header.setSortable(true);</span>
<span class="nc" id="L137">			header.setDefaultSortColumn(BbmWebBundleKey.Name);</span>
<span class="nc" id="L138">			addHeader(header, bbmBundle, BbmWebBundleKey.Name);</span>
<span class="nc" id="L139">			addHeader(header, m_common_bundle, UIFWebBundleKey.STATUS);</span>
<span class="nc" id="L140">			addHeader(header, bbmBundle, BbmWebBundleKey.Organization);</span>
<span class="nc" id="L141">			addHeader(header, rmBundle, RmWebBundleKey.RM_TIMEOFF_BID_PERIOD);</span>
<span class="nc" id="L142">			addHeader(header, rmBundle, RmWebBundleKey.RM_TIMEOFF_BID_REQUEST_PERIOD);</span>
<span class="nc" id="L143">			addHeader(header, rmBundle, RmWebBundleKey.RM_TIMEOFF_BID_ACTIVITIES_ALLOWED);</span>
<span class="nc" id="L144">			addHeader(header, rmBundle, RmWebBundleKey.PEOPLE_BIDDING).setIsForNumeric(true);</span>

		}
<span class="nc" id="L147">	}</span>

	/**
	 * Initialize Selectable Items
	 */
	@SuppressWarnings(&quot;rawtypes&quot;)
	@Override
	protected void initSelectableItems() {
<span class="nc bnc" id="L155" title="All 4 branches missed.">		if (!isPageEnabled || timeOffBids.isEmpty()) {</span>
<span class="nc" id="L156">			return;</span>
		}

<span class="nc" id="L159">		ArrayList listModel = new ArrayList(timeOffBids.size());</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">		for (Iterator it = timeOffBids.iterator(); it.hasNext();) {</span>
<span class="nc" id="L161">			TimeOffBid auction = (TimeOffBid) it.next();</span>
<span class="nc" id="L162">			addRowData(auction, listModel);</span>

<span class="nc" id="L164">		}</span>
<span class="nc" id="L165">		timeOffBidListPC.setName(&quot;bidSummary&quot;);</span>
<span class="nc" id="L166">		timeOffBidListPC.addSelectedRowID(getSelectedID());</span>
<span class="nc" id="L167">		timeOffBidListPC.setListModel(listModel);</span>
<span class="nc" id="L168">		timeOffBidListPC.setIsAutoSortEnabled(true);</span>
<span class="nc" id="L169">	}</span>

	@Override
	protected boolean isSortSupported() {
<span class="nc" id="L173">		return true;</span>
	}

	/**
	 * Return the Selectable Items
	 */
	@Override
	public SelectableItems getSelectableItems() {
<span class="nc" id="L181">		return timeOffBidListPC;</span>
	}

	/**
	 * Initialize toolbar
	 */
	@Override
	protected void initToolbar() {
<span class="nc bnc" id="L189" title="All 2 branches missed.">		if (isPageEnabled) {</span>
<span class="nc" id="L190">			useDefaultToolbar(false);</span>
		}
<span class="nc" id="L192">		enableToolbarPagination();</span>
<span class="nc" id="L193">	}</span>

	/**
	 * is the add action enabled?
	 */
	@Override
	protected boolean isAddActionEnabled() {
<span class="nc bnc" id="L200" title="All 4 branches missed.">		return isPageEnabled &amp;&amp; viewingUser.isAuthorized(PrivilegeKeys.FS_EDITTIMEOFFBIDDING_ID);</span>
	}

	/**
	 * is the edit action enabled?
	 */
	@Override
	protected boolean isEditActionEnabled() {
<span class="nc bnc" id="L208" title="All 6 branches missed.">		return isPageEnabled &amp;&amp; viewingUser.isAuthorized(PrivilegeKeys.FS_EDITTIMEOFFBIDDING_ID) &amp;&amp; selectedTimeOffBid != null;</span>
	}

	/**
	 * is the delete action enabled?
	 */
	@Override
	protected boolean isDeleteActionEnabled() {
<span class="nc bnc" id="L216" title="All 4 branches missed.">		boolean selectedTimeoffBidClosed = (selectedTimeOffBid != null) &amp;&amp; selectedTimeOffBid.isStatusClosed();</span>
<span class="nc bnc" id="L217" title="All 6 branches missed.">		return isPageEnabled &amp;&amp; viewingUser.isAuthorized(PrivilegeKeys.FS_EDITTIMEOFFBIDDING_ID) &amp;&amp; selectedTimeoffBidClosed;</span>
	}

	//////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	//////////////////////////////////////////////////////////////////////////////
	@SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
	private void addRowData(TimeOffBid timeOffBid, Collection listModel) {
<span class="nc" id="L225">		String rowID = timeOffBid.getID().toString();</span>
<span class="nc" id="L226">		String name = HtmlUtil.escapeAttributeValue(timeOffBid.getName());</span>
<span class="nc" id="L227">		boolean isOpen = timeOffBid.isStatusOpen();</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">		String status = isOpen ? openLbl : closedLbl;</span>
<span class="nc" id="L229">		ID orgId = timeOffBid.getOrganizationId();</span>
<span class="nc" id="L230">		String orgName = getOrgNameOfBid(orgId);</span>
<span class="nc" id="L231">		Date bidStart = timeOffBid.getBidStartTime();</span>
<span class="nc" id="L232">		Date bidEnd = timeOffBid.getBidEndTime();</span>
<span class="nc" id="L233">		Date requestStart = timeOffBid.getRequestStartTime();</span>
<span class="nc" id="L234">		Date requestEnd = timeOffBid.getRequestEndTime();</span>

<span class="nc" id="L236">		DefaultMultiColumnNodeData node = new DefaultMultiColumnNodeData(rowID);</span>
<span class="nc" id="L237">		node.add(name);</span>
<span class="nc" id="L238">		node.add(status);</span>
<span class="nc" id="L239">		node.add(orgName);</span>
<span class="nc" id="L240">		node.add(SchedulingPeriodUtil.getDateRangeDisplay(bidStart, bidEnd, m_localizer, viewingTimeZone));</span>
<span class="nc" id="L241">		node.add(SchedulingPeriodUtil.getDateRangeDisplay(requestStart, requestEnd, m_localizer, viewingTimeZone));</span>
<span class="nc" id="L242">		node.add(getActivityNames(activityIdNames, timeOffBid.getId()));</span>
<span class="nc" id="L243">		node.add(new NumberWrapper(timeOffBid.getNumOfBidders(), m_localizer), CSSUtil.STYLE_NUMERIC);</span>
<span class="nc" id="L244">		listModel.add(node);</span>

<span class="nc" id="L246">		boolean isEditable = viewingUser.isAuthorized(PrivilegeKeys.FS_EDITTIMEOFFBIDDING_ID);</span>
<span class="nc" id="L247">		node.getNodeAttributes().put(IS_EDITABLE, String.valueOf(isEditable));</span>
<span class="nc bnc" id="L248" title="All 4 branches missed.">		node.getNodeAttributes().put(IS_DELETEABLE, String.valueOf(isEditable &amp;&amp; timeOffBid.isStatusClosed()));</span>
<span class="nc" id="L249">	}</span>

	private String getOrgNameOfBid(ID orgId) {
		try {
<span class="nc" id="L253">			Organization org = OrganizationModelHandler.getOrganization(m_context, orgId);</span>
<span class="nc" id="L254">			return org.getName();</span>
<span class="nc" id="L255">		} catch (Exception ex) {</span>
<span class="nc" id="L256">			Message msg = handleUnableToLoadDataErrorAndLogAsDebug(log, ex);</span>
<span class="nc" id="L257">			msg.setAssociatedMessage(ex.getLocalizedMessage());</span>
<span class="nc" id="L258">			return &quot;&quot;;</span>
		}
	}

	private String getActivityNames(Map&lt;ID, String&gt; activityIdNames, ID bidId) {
<span class="nc" id="L263">		Collection&lt;ID&gt; activityIds = null;</span>
		try {
<span class="nc" id="L265">			activityIds = TimeOffBidModelHandler.getActivityIDsByBidId(bidId);</span>
<span class="nc" id="L266">			return TimeOffBidUtil.displayActivityNames(activityIdNames, activityIds);</span>
<span class="nc" id="L267">		} catch (Exception ex) {</span>
<span class="nc" id="L268">			Message msg = handleUnableToLoadDataErrorAndLogAsDebug(log, ex);</span>
<span class="nc" id="L269">			msg.setAssociatedMessage(ex.getLocalizedMessage());</span>
<span class="nc" id="L270">			return &quot;&quot;;</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>