<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TOChoiceDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.timeoff.ejb</a> &gt; <span class="el_source">TOChoiceDAO.java</span></div><h1>TOChoiceDAO.java</h1><pre class="source lang-java linenums">/*
 * TOChoice.java
 *
 * Copyright (c) 2002, Blue Pumpkin Software, Inc.
 * All rights reserved.
 */
package com.bluepumpkin.ejb.rm.requests.timeoff.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.Iterator;
import java.util.Map;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoParam;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbLogBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb.TOHoursPerDayDAO;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.ejb.TimeOffIntervalPaidSegmentDAO;
import com.bluepumpkin.ejb.rm.util.JdmoBatchExecute;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoiceFieldInfo;



/**
 * DAO class for TOChoice
 */
public class TOChoiceDAO extends DAOBase {
    // TOChoiceFieldInfo for the DAO class.
<span class="nc" id="L43">    private static FieldInfo m_fieldInfo = new TOChoiceFieldInfo();</span>

<span class="nc" id="L45">    private static Category m_cat = Log.initCategory(TOChoiceDAO.class.getName());</span>

    /**
     * Constructor
     */
    public TOChoiceDAO() {
<span class="nc" id="L51">        super();</span>
<span class="nc" id="L52">    }</span>

    /** Constructor
     * @param - Jdmo - Jdmo object instance
     * @see Jdmo.
     */
    public TOChoiceDAO(Jdmo dmo) {
<span class="nc" id="L59">        super(dmo);</span>
<span class="nc" id="L60">    }</span>

    @Override
	protected FieldInfo getFieldInfo() {
<span class="nc" id="L64">        return m_fieldInfo;</span>
    }

    protected Category getCategory() {
<span class="nc" id="L68">        return m_cat;</span>
    }

    /** Creates the value object.
     *  @return - returns new Value object
     *  @see ValueObjectBase.
     *  @see TOChoice.
     */
    @Override
	protected ValueObjectBase createValueObject() {
<span class="nc" id="L78">        return (new TOChoice());</span>
    }

    /** Finds all Time off choice for the Time off request id passed as argument.
     *  @param - ID -  ID object for TimeOffRequest.
     *  @return - Collection of TOChoice Object.
     *  @see TOChoice.
     *        @throw BbmFinderException
     */
    public Collection findTOChoices(ID pTimeOffRequestID)
        throws BbmFinderException {

        //todo: use the fieldinfo
<span class="nc" id="L91">        return getObjects(&quot; WHERE TIMEOFFREQUESTID = &quot; + pTimeOffRequestID, &quot; ORDER BY RANK &quot;);</span>
    }

    /** Finds Time off choice for the Time off choice id object passed as argument.
     *  @param - ID -  ID object for Time off Choice.
     *  @return - TOChoice Object.
     *  @throw BbmFinderException
     */
    public TOChoice findTOChoiceById(ID pTOChoiceId) throws Exception {
<span class="nc" id="L100">        TOChoice result = null;</span>

<span class="nc" id="L102">            result = (TOChoice) getObjectByID(pTOChoiceId);</span>

<span class="nc" id="L104">        return result;</span>
    }

    /** Create new Time off choice for the Time off choice object passed as argument.
     *  @param - pTOChoice -  TOChoice object for Time off Choice.
     *  @return - ID object for created TOChoice.
     *        @throw BbmCreateException
     */
    public ID createTOChoice(TOChoice pTOChoice) throws Exception {
        // Add validity checking for fields in choice
        // -- request id is specified
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (pTOChoice.getTimeOffRequestID() == null) {</span>
<span class="nc" id="L116">            throw RequestUtil.createRmException(RmEjbLogBundleKey.REQUEST_ID_NULL, m_cat);</span>
        }

        // -- rank is specified
        // If rank is read from database and null, isFieldNull is true (shouldn't
        // happen since the column is NOT NULL), if the value object is constructed
        // by code and rank is never set, then getFieldValue() will return null.
        // I decided to check both here to be thorough.
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if ((pTOChoice.isFieldNull(TOChoiceFieldInfo.TIMEOFFREQUESTCHOICE_N_RANK)) ||</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                (pTOChoice.getFieldValue(TOChoiceFieldInfo.TIMEOFFREQUESTCHOICE_N_RANK) == null)) {</span>
<span class="nc" id="L126">            throw RequestUtil.createRmException(RmEjbLogBundleKey.RANK_NULL, m_cat);</span>
        }

        // -- start/stop times are specified and stop is not before start
<span class="nc" id="L130">        Date start = pTOChoice.getStartDate();</span>
<span class="nc" id="L131">        Date end = pTOChoice.getEndDate();</span>

<span class="nc bnc" id="L133" title="All 6 branches missed.">        if ((start == null) || (end == null) || (end.before(start))) {</span>
<span class="nc" id="L134">            throw RequestUtil.createRmException(RmEjbLogBundleKey.INVALID_TIME_RANGE, </span>
                    start, end, m_cat);
        }

        // Call base class method to create object
<span class="nc" id="L139">            ID l_TOChoiceId = createObject(pTOChoice);</span>

<span class="nc" id="L141">            return l_TOChoiceId;</span>
    }

    /** Update Time off choice database for the Time off choice object passed as argument.
     *  @param - pTOChoice -  TOChoice object for Time off Choice.
     *        @throw BbmUpdateException
     */
    public void updateChoice(TOChoice pTOChoice) throws Exception {
<span class="nc" id="L149">            updateObject(pTOChoice);</span>
<span class="nc" id="L150">    }</span>

    /** Delete Time off choice database for the Time off choice id object passed as argument.
     *  @param - pTOChoiceID -  ID object for Time off Choice.
     *  @see TOChoice.
     *        @throw BbmRemoveException
     */
    public void deleteChoice(ID pTOChoiceID) throws Exception {
<span class="nc" id="L158">            deleteObject(pTOChoiceID);</span>
<span class="nc" id="L159">    }</span>

    public Collection getTORequestIDsByDate(Date date) throws BbmFinderException
    {
        /*
         * SELECT ... FROM ... WHERE STARTTIME &gt; date.daystart AND STARTTIME &lt; date.dayend
         */
<span class="nc" id="L166">        StringBuffer whereClause = new StringBuffer();</span>
<span class="nc" id="L167">        whereClause.append(&quot; A.STARTTIME &gt;= '&quot;)</span>
<span class="nc" id="L168">                   .append(JdmoUtil.formatDBString( RequestUtil.getDateForDayStart(date, TimeZone.getDefault())))</span>
<span class="nc" id="L169">                   .append(&quot;' A.STARTTIME &lt;= '&quot;)</span>
<span class="nc" id="L170">                   .append(JdmoUtil.formatDBString( RequestUtil.getDateForDayEnd(date, TimeZone.getDefault())) )</span>
<span class="nc" id="L171">                   .append(&quot;'&quot;);</span>

<span class="nc" id="L173">        ArrayList toReqIDs = new ArrayList();</span>
<span class="nc" id="L174">        Collection toChoices = getObjects(whereClause.toString());</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        for (Iterator itr = toChoices.iterator(); itr.hasNext(); ) {</span>
<span class="nc" id="L176">            toReqIDs.add( ((TOChoice) itr.next()).getTimeOffRequestID() );</span>
        }

<span class="nc" id="L179">        return toReqIDs;</span>
    }
    protected DAOBase createChildDAO(int childType) {
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (childType == TOChoiceFieldInfo.TOHOURSPERDAY_CHILD_TYPE) {</span>
<span class="nc" id="L183">            return new TOHoursPerDayDAO(m_dmo);              </span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">        }else if (childType == TOChoiceFieldInfo.TIMEOFFINTERVALPAIDSEGMENTS_CHILD_TYPE) {</span>
<span class="nc" id="L185">            return new TimeOffIntervalPaidSegmentDAO(m_dmo);              </span>
        }else{        
<span class="nc" id="L187">        	throw new IllegalArgumentException(&quot;childType = &quot; + childType);</span>
        }
    }
    protected boolean needToLoadChildObjects(int childType) {
<span class="nc" id="L191">        boolean result = false;</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (childType == TOChoiceFieldInfo.TOHOURSPERDAY_CHILD_TYPE) {</span>
<span class="nc" id="L193">            result = true;</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">        }else if (childType == TOChoiceFieldInfo.TIMEOFFINTERVALPAIDSEGMENTS_CHILD_TYPE) {</span>
<span class="nc" id="L195">        	result = true;   </span>
        }
<span class="nc" id="L197">        return result;</span>
    }
    
   
    
    public void updateReferenceScheduleIDs(final Map&lt;ID, ID&gt; choiceToReferenceID) throws BbmUpdateException {
		try {
<span class="nc" id="L204">			JdmoBatchExecute&lt;ID&gt; batchExecute = new JdmoBatchExecute&lt;ID&gt;(m_dmo) {</span>
				@Override
				public void set(Map&lt;Integer, Object&gt; param, ID toChoiceID) {
<span class="nc" id="L207">					ID referenceScheduleId = choiceToReferenceID.get(toChoiceID);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">					param.put(1, referenceScheduleId==null? new JdmoParam(null, java.sql.Types.INTEGER):referenceScheduleId );</span>
<span class="nc" id="L209">					param.put(2, toChoiceID);</span>
					
					

<span class="nc" id="L213">				}</span>
			};

<span class="nc" id="L216">			batchExecute.executeBatch(&quot;update TIMEOFFREQUESTCHOICE set REFERENCESPID = ? where ID = ?&quot;, choiceToReferenceID.keySet());</span>

<span class="nc" id="L218">		} catch (JdmoException e) {</span>
<span class="nc" id="L219">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L220">		}</span>
<span class="nc" id="L221">    }</span>
		
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>