<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ServiceGoalsAppletRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.optimization.servicegoals</a> &gt; <span class="el_source">ServiceGoalsAppletRequestHandler.java</span></div><h1>ServiceGoalsAppletRequestHandler.java</h1><pre class="source lang-java linenums">/*
 * (c) 2009-2010 Verint Systems, Inc.
 */
package com.verint.web.fs.optimization.servicegoals;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.timeseries.ejb.TimeSeriesManager;
import com.bluepumpkin.ejb.bbm.timeseries.model.ClientServiceGoalTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.util.ForecastTraceUtil;
import com.bluepumpkin.ejb.bbm.timeseries.util.ServiceGoalsTraceUtil;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceOperator;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.MediaType;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.core.l10n.CoreWebLogBundleKey;
import com.verint.ejb.bbm.servicegoals.model.ASATimeSeriesDataItem;
import com.verint.ejb.bbm.servicegoals.model.MaxDialsTimeSeriesDataItem;
import com.verint.ejb.bbm.servicegoals.model.ServiceLevelPercentTimeSeriesDataItem;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.fs.optimization.CombinedQueuePartialResponse;
import com.verint.web.fs.optimization.MultiQueuePartialResponse;
import com.verint.web.fs.optimization.OptimizationAppletRequestHandler;
import com.verint.web.fs.optimization.OptimizationKeys;
import com.verint.web.fs.optimization.Response;
import com.verint.web.fs.optimization.SingleQueuePartialResponse;
import com.verint.web.fs.optimization.forecasting.ForecastingKeys;
import com.verint.web.fs.servicegoals.ServiceGoalsMH;
import com.witness.web.uif.system.RequestContext;

/**
 * The Class ServiceGoalsAppletRequestHandler. An instance of this class is reposible for providing service goals applet to
 * server communication.
 */
<span class="nc" id="L53">public class ServiceGoalsAppletRequestHandler extends OptimizationAppletRequestHandler {</span>
	
	/**
	 * Process Applet Request - to be overrided by derived classes
	 * @param context - The Request Context
	 * @param appletRequest - Map containing Applet Request Information
	 * @param appletResponse - Map containing Response to be send to Applet
	 */
	
	protected void processAppletRequest(RequestContext context, Map request, Map response) {
		try {
<span class="nc bnc" id="L64" title="All 2 branches missed.">		if (isAppletAction(request, ServiceGoalsKeys.PROC_GET_SINGLE_QUEUE_SERVICEGOALS_TRACECUBE)) {</span>
<span class="nc" id="L65">			getServiceGoals(context, request, response);</span>
		}
<span class="nc bnc" id="L67" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_GET_SINGLE_QUEUE_IMMEDIATE_MEDIA_SERVICEGOALS_MODEL)) {</span>
<span class="nc" id="L68">			getImmediateMediaFullSingleQueueModel(context, request, response);</span>
		}
<span class="nc bnc" id="L70" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_GET_COMBINED_QUEUE_IMMEDIATE_MEDIA_SERVICEGOALS_MODEL)) {</span>
<span class="nc" id="L71">			getImmediateMediaPartialCombinedQueueModel(context, request, response);</span>
		}
<span class="nc bnc" id="L73" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_GET_MULTI_QUEUE_IMMEDIATE_MEDIA_SERVICEGOALS_MODEL)) {</span>
<span class="nc" id="L74">			getImmediateMediaPartialMultiQueueModel(context, request, response);</span>
		}
<span class="nc bnc" id="L76" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_SAVE_SERVICE_GOALS_IMMEDIATE_MEDIA_SPQUEUE)) {</span>
<span class="nc" id="L77">			saveImmediateMediaSpQueueServiceGoals(context, request, response, false);</span>
		}
<span class="nc bnc" id="L79" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_GET_SINGLE_QUEUE_DEFERRED_MEDIA_SERVICEGOALS_MODEL)) {</span>
<span class="nc" id="L80">			getDeferredMediaFullSingleQueueModel(context, request, response);</span>
		}
<span class="nc bnc" id="L82" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_GET_COMBINED_QUEUE_DEFERRED_MEDIA_SERVICEGOALS_MODEL)) {</span>
<span class="nc" id="L83">			getDeferredMediaPartialCombinedQueueModel(context, request, response);</span>
		}
<span class="nc bnc" id="L85" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_GET_MULTI_QUEUE_DEFERRED_MEDIA_SERVICEGOALS_MODEL)) {</span>
<span class="nc" id="L86">			getDeferredMediaPartialMultiQueueModel(context, request, response);</span>
		}
<span class="nc bnc" id="L88" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_SAVE_SERVICE_GOALS_DEFERRED_MEDIA_SPQUEUE)) {</span>
<span class="nc" id="L89">			saveDeferredMediaSpQueueServiceGoals(context, request, response, false);</span>
		}
<span class="nc bnc" id="L91" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_GET_SINGLE_QUEUE_OUTBOUND_MEDIA_SERVICEGOALS_MODEL)) {</span>
<span class="nc" id="L92">			getOutboundMediaFullSingleQueueModel(context, request, response);</span>
		}
<span class="nc bnc" id="L94" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_GET_COMBINED_QUEUE_OUTBOUND_MEDIA_SERVICEGOALS_MODEL)) {</span>
<span class="nc" id="L95">			getOutboundMediaPartialCombinedQueueModel(context, request, response);</span>
		}
<span class="nc bnc" id="L97" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_GET_MULTI_QUEUE_OUTBOUND_MEDIA_SERVICEGOALS_MODEL)) {</span>
<span class="nc" id="L98">			getOutboundMediaPartialMultiQueueModel(context, request, response);</span>
		}
<span class="nc bnc" id="L100" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_SAVE_SERVICE_GOALS_OUTBOUND_MEDIA_SPQUEUE)) {</span>
<span class="nc" id="L101">			saveOutboundMediaSpQueueServiceGoals(context, request, response, false);</span>
		}
<span class="nc bnc" id="L103" title="All 2 branches missed.">		else if (isAppletAction(request, ServiceGoalsKeys.PROC_GET_FORECAST)) {</span>
<span class="nc" id="L104">			getForecast(context, request, response);</span>
		}
		else {
<span class="nc" id="L107">			super.processAppletRequest(context, request, response);</span>
		}
<span class="nc" id="L109">		} catch (Exception e) {</span>
<span class="nc" id="L110">			handleError(context, e,</span>
					CoreWebLogBundleKey.APPLET_PROCESS_REQUEST_ERROR,
					CoreWebBundleKey.APPLET_PROCESS_REQUEST_ERROR,
					CoreWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L114">		}</span>
<span class="nc" id="L115">	}</span>
	
	private void saveImmediateMediaSpQueueServiceGoals(RequestContext context, Map appletRequest, Map appletResponse, boolean storeResult){
<span class="nc" id="L118">		SPQueue spQueue = (SPQueue)appletRequest.get(ServiceGoalsKeys.PARAM_SP_QUEUE);</span>
<span class="nc" id="L119">		List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; serviceLevelTimeSeries = </span>
<span class="nc" id="L120">			(List&lt;ServiceLevelPercentTimeSeriesDataItem&gt;)appletRequest.get(ServiceGoalsKeys.PARAM_SERVICE_LEVEL_TIME_SERIES);</span>
<span class="nc" id="L121">		List&lt;ASATimeSeriesDataItem&gt; asaTimeSeries = </span>
<span class="nc" id="L122">			(List&lt;ASATimeSeriesDataItem&gt;)appletRequest.get(ServiceGoalsKeys.PARAM_ASA_TIME_SERIES);</span>
		
		try {
<span class="nc bnc" id="L125" title="All 2 branches missed.">			if (!spQueue.getServiceLevelGoalType()) {</span>
<span class="nc" id="L126">				ServiceGoalsMH.saveImmediateMediaModel(context, serviceLevelTimeSeries, spQueue);</span>
			}
			else {
<span class="nc" id="L129">				ServiceGoalsMH.saveImmediateMediaModelWithASA(context, asaTimeSeries, spQueue);</span>
			}
<span class="nc" id="L131">		} catch (Exception e) {</span>
<span class="nc" id="L132">			e.printStackTrace();</span>
<span class="nc" id="L133">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L134">		} </span>
<span class="nc" id="L135">	}</span>
	
	private void saveDeferredMediaSpQueueServiceGoals(RequestContext context, Map appletRequest, Map appletResponse, boolean storeResult){
<span class="nc" id="L138">		SPQueue spQueue = (SPQueue)appletRequest.get(ServiceGoalsKeys.PARAM_SP_QUEUE);</span>
<span class="nc" id="L139">		List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; serviceLevelTimeSeries = </span>
<span class="nc" id="L140">			(List&lt;ServiceLevelPercentTimeSeriesDataItem&gt;)appletRequest.get(ServiceGoalsKeys.PARAM_SERVICE_LEVEL_TIME_SERIES);</span>
<span class="nc" id="L141">		List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; deadlineGoalTimeSeries = </span>
<span class="nc" id="L142">			(List&lt;ServiceLevelPercentTimeSeriesDataItem&gt;)appletRequest.get(ServiceGoalsKeys.PARAM_DEADLINE_GOAL_TIME_SERIES);</span>
<span class="nc" id="L143">		List&lt;ASATimeSeriesDataItem&gt; deadlineTimeTimeSeries = </span>
<span class="nc" id="L144">			(List&lt;ASATimeSeriesDataItem&gt;)appletRequest.get(ServiceGoalsKeys.PARAM_DEADLINE_TIME_TIME_SERIES);</span>
		try {
<span class="nc bnc" id="L146" title="All 2 branches missed.">			if (!spQueue.getServiceLevelGoalType()) {</span>
<span class="nc" id="L147">				ServiceGoalsMH.saveDeferredMediaModel(context, serviceLevelTimeSeries, spQueue);</span>
			}
			else {
<span class="nc" id="L150">				ServiceGoalsMH.saveDeferredMediaModel(context, deadlineGoalTimeSeries, deadlineTimeTimeSeries, spQueue);</span>
			}
<span class="nc" id="L152">		} catch (Exception e) {</span>
<span class="nc" id="L153">			e.printStackTrace();</span>
<span class="nc" id="L154">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L155">		} </span>
<span class="nc" id="L156">	}</span>
	
	private void getImmediateMediaFullSingleQueueModel(RequestContext context, Map request, Map response) 
    {   
        try
        {
<span class="nc" id="L162">        	Response&lt;SingleServiceGoalsQueueDTO&gt; fullResponse = getFullResponseForSingleQueue(context, request, response);</span>
<span class="nc" id="L163">	        response.put(ServiceGoalsKeys.RETVAL_IMMEDIATE_MEDIA_SERVICE_GOALS_MODEL, fullResponse);</span>
        }
<span class="nc" id="L165">        catch(Exception e){</span>
<span class="nc" id="L166">        	notifyError(context, response, e);</span>
<span class="nc" id="L167">        }</span>
<span class="nc" id="L168">    }</span>
	
	private void getDeferredMediaFullSingleQueueModel(RequestContext context, Map request, Map response) 
    {   
        try
        {
<span class="nc" id="L174">        	Response&lt;SingleServiceGoalsQueueDTO&gt; fullResponse = getFullResponseForSingleQueue(context, request, response);</span>
<span class="nc" id="L175">	        response.put(ServiceGoalsKeys.RETVAL_DEFERRED_MEDIA_SERVICE_GOALS_MODEL, fullResponse);</span>
        }
<span class="nc" id="L177">        catch(Exception e){</span>
<span class="nc" id="L178">        	notifyError(context, response, e);</span>
<span class="nc" id="L179">        }</span>
<span class="nc" id="L180">    }</span>
	
	private Response&lt;MultiServiceGoalsQueueDTO&gt; getPartialResponseForMultiQueue(RequestContext context, Map request, Map response) throws Exception {
<span class="nc" id="L183">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L184">    	MultiQueuePartialResponse partialResponse = createMultiQueuePartialResponse(context, request);</span>
<span class="nc" id="L185">    	MediaType mediaType = MediaType.get(partialResponse.getMedia());</span>
<span class="nc" id="L186">    	Date adjustedEnd = new Date(partialResponse.getSp().getEndTime().getTime() - 60000);  // 1 minute before.</span>
<span class="nc" id="L187">    	List&lt;SingleServiceGoalsQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleServiceGoalsQueueDTO&gt;();</span>
<span class="nc" id="L188">    	TraceCube[] constituentServiceGoalsCubes = new TraceCube[partialResponse.getQueues().size()]; </span>
<span class="nc" id="L189">    	TraceCube[] constituentForecastCubes = new TraceCube[partialResponse.getQueues().size()]; </span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">    	for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {</span>
<span class="nc" id="L191">    		queueMediaMap.put(partialResponse.getQueues().get(i).getID(), partialResponse.getMedia().getID());</span>
<span class="nc" id="L192">			singleQueueDtos.add(new SingleServiceGoalsQueueDTO(partialResponse.getQueues().get(i), partialResponse.getSPQueues().get(i)));</span>
<span class="nc" id="L193">			ClientServiceGoalTraceCube serviceGoalsTraceCube = ServiceGoalsTraceUtil.getServiceGoalsTraceCube(partialResponse.getCampaign().getID(),</span>
<span class="nc" id="L194">					partialResponse.getQueues().get(i).getID(), partialResponse.getMedia().getID(),</span>
<span class="nc" id="L195">					partialResponse.getSp().getStartTime(), adjustedEnd, context.isInWhatIfMode());</span>
<span class="nc" id="L196">			ForecastTraceCube forecastTraceCube = getForecastTraceCube(partialResponse.getCampaign().getID(),</span>
<span class="nc" id="L197">					partialResponse.getQueues().get(i).getID(), partialResponse.getMedia().getID(),</span>
<span class="nc" id="L198">					partialResponse.getSp().getStartTime(), adjustedEnd, ForecastTraceUtil.getApplicableForecastTraceTypes(mediaType));</span>
<span class="nc" id="L199">			constituentServiceGoalsCubes[i] = serviceGoalsTraceCube;</span>
<span class="nc" id="L200">			constituentForecastCubes[i] = forecastTraceCube;</span>
		}

<span class="nc" id="L203">    	TraceCube aggregatedServiceGoals = TraceOperator.combineQueue(constituentServiceGoalsCubes, true, queueMediaMap);</span>
<span class="nc" id="L204">    	TraceUtil.setUndefinedValuesToZero(aggregatedServiceGoals);</span>
<span class="nc" id="L205">    	TraceCube aggregatedForecast = TraceOperator.combineQueue(constituentForecastCubes, true, queueMediaMap);</span>
<span class="nc" id="L206">    	TraceUtil.setUndefinedValuesToZero(aggregatedForecast);</span>
<span class="nc" id="L207">    	MultiServiceGoalsQueueDTO multiQueueDto = new MultiServiceGoalsQueueDTO(singleQueueDtos, </span>
    			(ClientServiceGoalTraceCube)aggregatedServiceGoals, (ForecastTraceCube)aggregatedForecast);
<span class="nc" id="L209">    	Response&lt;MultiServiceGoalsQueueDTO&gt; fullResponse = </span>
<span class="nc" id="L210">    		new Response&lt;MultiServiceGoalsQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L211">    				partialResponse.getCampaign(), </span>
<span class="nc" id="L212">    				partialResponse.getSp(), multiQueueDto, partialResponse.getHoursOfOperation());</span>
<span class="nc" id="L213">        return fullResponse;</span>
	}
	
	/**
	 * Gets the partial response for combined queue. This method is used for immediate and deferred media queues, since the data
	 * they encapsulate is the same.
	 * 
	 * @param context the context
	 * @param request the request
	 * @param response the response
	 * 
	 * @return the partial response for combined queue
	 * 
	 * @throws Exception the exception
	 */
	private Response&lt;CombinedServiceGoalsQueueDTO&gt; getPartialResponseForCombinedQueue(RequestContext context, Map request, Map response) throws Exception 
    {   
<span class="nc" id="L230">        HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L231">        CombinedQueuePartialResponse partialResponse = createCombinedQueuePartialResponse(context, request);</span>
<span class="nc" id="L232">        Date adjustedEnd = new Date(partialResponse.getSp().getEndTime().getTime() - 60000);  // 1 minute before.</span>
        	
<span class="nc" id="L234">        List&lt;SingleServiceGoalsQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleServiceGoalsQueueDTO&gt;();</span>
<span class="nc" id="L235">        TraceCube[] constituentServiceGoalsCubes = new TraceCube[partialResponse.getQueues().size()];</span>
<span class="nc" id="L236">        TraceCube[] constituentForecastCubes = new TraceCube[partialResponse.getQueues().size()];</span>
        TraceCube aggregatedServiceGoals;
        TraceCube aggregatedForecast;
        
<span class="nc" id="L240">        MediaType mediaType = MediaType.get(partialResponse.getMedia());</span>
<span class="nc" id="L241">        short[] applicableForecastTraceTypes = ForecastTraceUtil.getApplicableForecastTraceTypes(mediaType);</span>
        	
        //If it is an unskilled SP that means that we are pulling the trace cube from the combined queue only.
        //Constituent queues are not considered in this case.
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (!partialResponse.getSp().getSkillBased()) {</span>
<span class="nc" id="L246">        	aggregatedServiceGoals = ServiceGoalsTraceUtil.getServiceGoalsTraceCube(partialResponse.getCampaign().getID(), null,</span>
<span class="nc" id="L247">            		partialResponse.getMedia().getID(), partialResponse.getSp().getStartTime(), adjustedEnd, context.isInWhatIfMode());      </span>
<span class="nc" id="L248">        	aggregatedForecast = getForecastTraceCube(partialResponse.getCampaign().getID(), null,</span>
<span class="nc" id="L249">            		partialResponse.getMedia().getID(), partialResponse.getSp().getStartTime(), adjustedEnd, applicableForecastTraceTypes);</span>
        } else {	//skill-based, use aggregation of constituent queues to build the tracecube 
<span class="nc bnc" id="L251" title="All 2 branches missed.">            for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {</span>
<span class="nc" id="L252">            	queueMediaMap.put(partialResponse.getQueues().get(i).getID(), partialResponse.getMedia().getID());</span>
<span class="nc" id="L253">    			singleQueueDtos.add(new SingleServiceGoalsQueueDTO(partialResponse.getQueues().get(i), partialResponse.getSPQueues().get(i)));</span>
<span class="nc" id="L254">    			ClientServiceGoalTraceCube constituentServiceGoalsCube = ServiceGoalsTraceUtil.getServiceGoalsTraceCube(partialResponse.getCampaign().getID(),</span>
<span class="nc" id="L255">    						partialResponse.getQueues().get(i).getID(), partialResponse.getMedia().getID(),</span>
<span class="nc" id="L256">    						partialResponse.getSp().getStartTime(), adjustedEnd, context.isInWhatIfMode());</span>
<span class="nc" id="L257">    			ForecastTraceCube constituentForecastCube = getForecastTraceCube(partialResponse.getCampaign().getID(),</span>
<span class="nc" id="L258">						partialResponse.getQueues().get(i).getID(), partialResponse.getMedia().getID(),</span>
<span class="nc" id="L259">						partialResponse.getSp().getStartTime(), adjustedEnd, applicableForecastTraceTypes);</span>
<span class="nc" id="L260">    			constituentServiceGoalsCubes[i] = constituentServiceGoalsCube;</span>
<span class="nc" id="L261">    			constituentForecastCubes[i] = constituentForecastCube;</span>
    		}
<span class="nc" id="L263">            aggregatedServiceGoals = TraceOperator.combineQueue(constituentServiceGoalsCubes, true, queueMediaMap);</span>
<span class="nc" id="L264">            TraceUtil.setUndefinedValuesToZero(aggregatedServiceGoals);</span>
<span class="nc" id="L265">            aggregatedForecast =  TraceOperator.combineQueue(constituentForecastCubes, true, queueMediaMap);</span>
<span class="nc" id="L266">            TraceUtil.setUndefinedValuesToZero(aggregatedForecast);</span>
        }

<span class="nc" id="L269">        MultiServiceGoalsQueueDTO multiQueueDto = new MultiServiceGoalsQueueDTO(singleQueueDtos, </span>
        		(ClientServiceGoalTraceCube)aggregatedServiceGoals, (ForecastTraceCube)aggregatedForecast);
        CombinedServiceGoalsQueueDTO combinedQueueDto;
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (!partialResponse.getSp().getSkillBased()) {</span>
<span class="nc" id="L273">        	combinedQueueDto = new CombinedServiceGoalsQueueDTO(partialResponse.getSPQueue(), (ClientServiceGoalTraceCube)aggregatedServiceGoals, </span>
        			(ForecastTraceCube)aggregatedForecast, multiQueueDto);
        } else {
<span class="nc" id="L276">        	combinedQueueDto = new CombinedServiceGoalsQueueDTO(partialResponse.getSPQueue(), multiQueueDto);</span>
        }
<span class="nc" id="L278">        Response&lt;CombinedServiceGoalsQueueDTO&gt; fullResponse = </span>
<span class="nc" id="L279">        	new Response&lt;CombinedServiceGoalsQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L280">        				partialResponse.getCampaign(), </span>
<span class="nc" id="L281">        				partialResponse.getSp(), combinedQueueDto, partialResponse.getHoursOfOperation());</span>
<span class="nc" id="L282">	    return fullResponse;</span>
    }
	
	/**
	 * Gets the service goals response for single queue.
	 * 
	 * @param context the context
	 * @param request the request
	 * @param response the response
	 * 
	 * @return the service goals response for single queue
	 * 
	 * @throws Exception the exception
	 */
	private Response&lt;SingleServiceGoalsQueueDTO&gt; getFullResponseForSingleQueue(RequestContext context, Map request, Map response) throws Exception {
<span class="nc" id="L297">		SingleQueuePartialResponse partialResponse = createSingleQueuePartialResponse(context, request);</span>
<span class="nc" id="L298">    	Date adjustedEnd = new Date(partialResponse.getSp().getEndTime().getTime() - 60000);  // 1 minute before.</span>
<span class="nc" id="L299">    	MediaType mediaType = MediaType.get(partialResponse.getMedia());</span>
<span class="nc" id="L300">    	ClientServiceGoalTraceCube serviceGoals = ServiceGoalsTraceUtil.getServiceGoalsTraceCube(partialResponse.getCampaign().getID(), </span>
<span class="nc" id="L301">    			partialResponse.getQueue().getID(), partialResponse.getMedia().getID(),</span>
<span class="nc" id="L302">    			partialResponse.getSp().getStartTime(), adjustedEnd, context.isInWhatIfMode());</span>
<span class="nc" id="L303">    	SingleServiceGoalsQueueDTO queueDto = new </span>
<span class="nc" id="L304">    	SingleServiceGoalsQueueDTO(partialResponse.getQueue(), </span>
<span class="nc" id="L305">    				partialResponse.getSPQueue(), </span>
    				serviceGoals,
<span class="nc" id="L307">    				getForecastTraceCube(partialResponse.getCampaign().getID(), </span>
<span class="nc" id="L308">    			partialResponse.getQueue().getID(), partialResponse.getMedia().getID(),</span>
<span class="nc" id="L309">    			partialResponse.getSp().getStartTime(), adjustedEnd, </span>
<span class="nc" id="L310">    			ForecastTraceUtil.getApplicableForecastTraceTypes(mediaType)));</span>

<span class="nc" id="L312">    	Response&lt;SingleServiceGoalsQueueDTO&gt; fullResponse = </span>
<span class="nc" id="L313">    		new Response&lt;SingleServiceGoalsQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L314">    				partialResponse.getCampaign(), </span>
<span class="nc" id="L315">    				partialResponse.getSp(), queueDto, partialResponse.getHoursOfOperation());</span>
<span class="nc" id="L316">    	return fullResponse;</span>
	}

	private ForecastTraceCube getForecastTraceCube(ID campaignId, ID queueId, ID mediaId, 
			Date start, Date end, short[] forecastTraceTypes) throws BbmFinderException, RemoteException, BbmEJBCreateException, BbmTimeSeriesException {
<span class="nc" id="L321">    	ForecastTraceCube metaForecast = new ForecastTraceCube(forecastTraceTypes);</span>
    	
<span class="nc" id="L323">    	TimeSeriesManager timeSeriesManager = WfmManagerFactory.getTimeSeriesManager();</span>
<span class="nc" id="L324">    	Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">    	if (queueId != null) queueIds.add(queueId);</span>
    	
    	Collection&lt;TraceCube&gt; forecastTimeSeries;
<span class="nc bnc" id="L328" title="All 2 branches missed.">    	if (queueIds.size() &gt; 0) {</span>
<span class="nc" id="L329">        	forecastTimeSeries = timeSeriesManager.getRawMultipleQueuesTimeSeries(metaForecast, campaignId, </span>
        		queueIds, start, end, true);
    	} else {
<span class="nc" id="L332">            forecastTimeSeries = timeSeriesManager.getRawCombinedQueuesTimeSeries(metaForecast, campaignId, </span>
            	mediaId, start, end, true);    		
    	}
    	
<span class="nc bnc" id="L336" title="All 2 branches missed.">    	if (forecastTimeSeries == null) forecastTimeSeries = new ArrayList&lt;TraceCube&gt;();</span>
    	
<span class="nc" id="L338">    	ForecastTraceCube forecastCube = null;</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">    	if (forecastTimeSeries.size() == 0) {</span>
<span class="nc" id="L340">    		forecastCube = ForecastTraceUtil.createZeroForecastTraceCube(queueId, start, end, forecastTraceTypes);</span>
    	} else {
<span class="nc" id="L342">    		forecastCube = (ForecastTraceCube) forecastTimeSeries.iterator().next();</span>
<span class="nc" id="L343">    		TraceUtil.setUndefinedValuesToZero(forecastCube);</span>
    	}
    	
<span class="nc" id="L346">    	return forecastCube;</span>
	}
	
	private void getDeferredMediaPartialMultiQueueModel(RequestContext context, Map request, Map response) 
    {   
        try
        {
<span class="nc" id="L353">        	Response&lt;MultiServiceGoalsQueueDTO&gt; fullResponse = getPartialResponseForMultiQueue(context, request, response);</span>
<span class="nc" id="L354">	        response.put(ServiceGoalsKeys.RETVAL_DEFERRED_MEDIA_SERVICE_GOALS_MODEL, fullResponse);</span>
        }
<span class="nc" id="L356">        catch(Exception e){</span>
<span class="nc" id="L357">        	notifyError(context, response, e);</span>
<span class="nc" id="L358">        }</span>
<span class="nc" id="L359">    }</span>
	
	private void getImmediateMediaPartialMultiQueueModel(RequestContext context, Map request, Map response) 
    {   
        try
        {
<span class="nc" id="L365">        	Response&lt;MultiServiceGoalsQueueDTO&gt; fullResponse = getPartialResponseForMultiQueue(context, request, response);</span>
<span class="nc" id="L366">	        response.put(ServiceGoalsKeys.RETVAL_IMMEDIATE_MEDIA_SERVICE_GOALS_MODEL, fullResponse);</span>
        }
<span class="nc" id="L368">        catch(Exception e){</span>
<span class="nc" id="L369">        	notifyError(context, response, e);</span>
<span class="nc" id="L370">        }</span>
<span class="nc" id="L371">    }</span>

	private void getImmediateMediaPartialCombinedQueueModel(RequestContext context, Map request, Map response) 
    {   
        try
        {
<span class="nc" id="L377">        	Response&lt;CombinedServiceGoalsQueueDTO&gt; fullResponse = getPartialResponseForCombinedQueue(context, request, response);</span>
<span class="nc" id="L378">	        response.put(ServiceGoalsKeys.RETVAL_IMMEDIATE_MEDIA_SERVICE_GOALS_MODEL, fullResponse);</span>
        }
<span class="nc" id="L380">        catch(Exception e){</span>
<span class="nc" id="L381">        	notifyError(context, response, e);</span>
<span class="nc" id="L382">        }</span>
<span class="nc" id="L383">    }</span>
	
	private void getDeferredMediaPartialCombinedQueueModel(RequestContext context, Map request, Map response) 
    {   
        try
        {
<span class="nc" id="L389">        	Response&lt;CombinedServiceGoalsQueueDTO&gt; fullResponse = getPartialResponseForCombinedQueue(context, request, response);</span>
<span class="nc" id="L390">	        response.put(ServiceGoalsKeys.RETVAL_DEFERRED_MEDIA_SERVICE_GOALS_MODEL, fullResponse);</span>
        }
<span class="nc" id="L392">        catch(Exception e){</span>
<span class="nc" id="L393">        	notifyError(context, response, e);</span>
<span class="nc" id="L394">        }</span>
<span class="nc" id="L395">    }</span>
	
	/**
	 * Returns a Response&lt;SingleServiceGoalsQueueDTO&gt; object which will be used to
	 * create an OutboundMediaServiceGoals model with an OutboundMediaServiceGoalsSingleQueueModel.
	 */
	private void getOutboundMediaFullSingleQueueModel(RequestContext context, Map request, Map response) 
    {   
        try
        {
<span class="nc" id="L405">        	Response&lt;SingleServiceGoalsQueueDTO&gt; fullResponse = getFullResponseForSingleQueue(context, request, response);</span>
<span class="nc" id="L406">	        response.put(ServiceGoalsKeys.RETVAL_OUTBOUND_MEDIA_SERVICE_GOALS_MODEL, fullResponse);</span>
        }
<span class="nc" id="L408">        catch(Exception e){</span>
<span class="nc" id="L409">        	notifyError(context, response, e);</span>
<span class="nc" id="L410">        }</span>
<span class="nc" id="L411">    }</span>
	
	/**
	 * Returns a Response&lt;MultiServiceGoalsQueueDTO&gt; object which will be used to
	 * create an OutboundMediaServiceGoals model with a ServiceGoalsMultiQueueModel.
	 */
	private void getOutboundMediaPartialMultiQueueModel(RequestContext context, Map request, Map response) 
    {   
        try
        {
<span class="nc" id="L421">        	Response&lt;MultiServiceGoalsQueueDTO&gt; fullResponse = getPartialResponseForMultiQueue(context, request, response);</span>
<span class="nc" id="L422">	        response.put(ServiceGoalsKeys.RETVAL_OUTBOUND_MEDIA_SERVICE_GOALS_MODEL, fullResponse);</span>
        }
<span class="nc" id="L424">        catch(Exception e){</span>
<span class="nc" id="L425">        	notifyError(context, response, e);</span>
<span class="nc" id="L426">        }</span>
<span class="nc" id="L427">    }</span>

	/**
	 * Returns a Response&lt;CombinedServiceGoalsQueueDTO&gt; object which will be used to
	 * create an OutboundMediaServiceGoals model with a ServiceGoalsCombinedQueueModel.
	 */
	private void getOutboundMediaPartialCombinedQueueModel(RequestContext context, Map request, Map response) 
    {   
        try
        {
<span class="nc" id="L437">        	Response&lt;CombinedServiceGoalsQueueDTO&gt; fullResponse = getPartialResponseForCombinedQueue(context, request, response);</span>
<span class="nc" id="L438">	        response.put(ServiceGoalsKeys.RETVAL_OUTBOUND_MEDIA_SERVICE_GOALS_MODEL, fullResponse);</span>
        }
<span class="nc" id="L440">        catch(Exception e){</span>
<span class="nc" id="L441">        	notifyError(context, response, e);</span>
<span class="nc" id="L442">        }</span>
<span class="nc" id="L443">    }</span>
	
	/**
	 * Saves service goals for a single SP queue with an outbound media type.
	 */
	private void saveOutboundMediaSpQueueServiceGoals(RequestContext context, Map appletRequest, Map appletResponse, boolean storeResult){
<span class="nc" id="L449">		SPQueue spQueue = (SPQueue)appletRequest.get(ServiceGoalsKeys.PARAM_SP_QUEUE);</span>
<span class="nc" id="L450">		List&lt;MaxDialsTimeSeriesDataItem&gt; serviceLevelTimeSeries = </span>
<span class="nc" id="L451">			(List&lt;MaxDialsTimeSeriesDataItem&gt;)appletRequest.get(ServiceGoalsKeys.PARAM_MAX_DIALS_TIME_SERIES);	</span>
		try {
<span class="nc" id="L453">			ServiceGoalsMH.saveOutboundMediaModel(context, serviceLevelTimeSeries, spQueue);</span>
<span class="nc" id="L454">		} catch (Exception e) {</span>
<span class="nc" id="L455">			e.printStackTrace();</span>
<span class="nc" id="L456">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L457">		} </span>
<span class="nc" id="L458">	}</span>
	
	/**
	 * Gets the service goals. This method is used for deferred and immediate media queues.
	 * 
	 * @param context the context
	 * @param request the request
	 * @param response the response
	 * 
	 * @return the service goals
	 */
	private void getServiceGoals(RequestContext context, Map request, Map response) 
    {   
        try
        {
<span class="nc" id="L473">        	ID campaignId = (ID)request.get(OptimizationKeys.PARAM_CAMPAIGN_ID);</span>
<span class="nc" id="L474">        	ID queueId = (ID)request.get(OptimizationKeys.PARAM_QUEUE_ID);</span>
<span class="nc" id="L475">        	ID mediaId = (ID)request.get(OptimizationKeys.PARAM_MEDIA_ID);</span>
<span class="nc" id="L476">        	Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="nc" id="L477">        	Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>
<span class="nc" id="L478">        	Date adjustedEnd = new Date(end.getTime() - 60000);  // 1 minute before.</span>
        	
<span class="nc" id="L480">        	MediaType mediaType = MediaType.get(mediaId);</span>
        	
<span class="nc" id="L482">        	ClientServiceGoalTraceCube serviceGoals = ServiceGoalsTraceUtil.getServiceGoalsTraceCube(campaignId, queueId, </span>
<span class="nc" id="L483">        			mediaId, start, adjustedEnd, context.isInWhatIfMode());</span>
        	
<span class="nc" id="L485">        	response.put(ServiceGoalsKeys.RETVAL_SERVICE_GOALS_TRACECUBE, serviceGoals);</span>
        }
<span class="nc" id="L487">        catch(Exception e){</span>
<span class="nc" id="L488">        	notifyError(context, response, e);</span>
<span class="nc" id="L489">        }</span>
<span class="nc" id="L490">    }</span>
	

	private void getForecast(RequestContext context, Map request, Map response) 
    {   
        try
        {
<span class="nc" id="L497">        	TimeSeriesManager timeSeriesManager = WfmManagerFactory.getTimeSeriesManager();</span>
<span class="nc" id="L498">        	ID campaignId = (ID)request.get(OptimizationKeys.PARAM_CAMPAIGN_ID);</span>
<span class="nc" id="L499">        	ID queueId = (ID)request.get(OptimizationKeys.PARAM_QUEUE_ID);</span>
<span class="nc" id="L500">        	ID mediaId = (ID)request.get(OptimizationKeys.PARAM_MEDIA_ID);</span>
<span class="nc" id="L501">        	Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="nc" id="L502">        	Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>
<span class="nc" id="L503">        	Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L504">        	MediaType mediaType = MediaType.get(mediaId);</span>
<span class="nc" id="L505">        	queueIds.add(queueId);</span>
<span class="nc" id="L506">        	ForecastTraceCube result = null;</span>
<span class="nc" id="L507">        	ForecastTraceCube meta = new ForecastTraceCube(ForecastTraceUtil.getApplicableForecastTraceTypes(mediaType));</span>
<span class="nc" id="L508">        	Collection forecast = timeSeriesManager.getRawMultipleQueuesTimeSeries(meta, campaignId, </span>
        			queueIds, start, end);
<span class="nc bnc" id="L510" title="All 2 branches missed.">        	if (forecast.size() == 0) {</span>
<span class="nc" id="L511">        		result = ForecastTraceUtil.createZeroForecastTraceCube(queueId, start, end, meta.getTraceTypes());</span>
        	} else {
<span class="nc" id="L513">        		result = (ForecastTraceCube) forecast.iterator().next();</span>
<span class="nc" id="L514">        		TraceUtil.setUndefinedValuesToZero(result);</span>
        	}
<span class="nc" id="L516">        	response.put(ForecastingKeys.RETVAL_FORECAST_TRACECUBE, result);</span>
        }
<span class="nc" id="L518">        catch(Exception e){</span>
<span class="nc" id="L519">        	notifyError(context, response, e);</span>
<span class="nc" id="L520">        }</span>
<span class="nc" id="L521">    }</span>
	
	/**
	 * Overridden from OptimizationAppletRequestHandler as Service goals selections have special behavior
	 * for skilled SPs (combined not selectable) and project media also does not apply to service goals.
	 */
	protected void isSelectionValid(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L528">		ID spId = (ID)appletRequest.get(OptimizationKeys.PARAM_SP_ID);</span>
<span class="nc" id="L529">	    ID campaignId = (ID)appletRequest.get(OptimizationKeys.PARAM_CAMPAIGN_ID);</span>
<span class="nc" id="L530">	    ID mediaId = (ID)appletRequest.get(OptimizationKeys.PARAM_MEDIA_ID);</span>
<span class="nc" id="L531">	    ArrayList&lt;ID&gt; queueIds = (ArrayList&lt;ID&gt;)appletRequest.get(OptimizationKeys.PARAM_QUEUE_IDS);</span>
<span class="nc" id="L532">	    boolean valid = true;</span>
	    try {
<span class="nc" id="L534">	    	WorkloadManager workloadManager = WfmManagerFactory.getWorkloadManager(context.isInWhatIfMode());</span>
<span class="nc" id="L535">		    SchedulingPeriod sp = CampaignModelHandler.getSchedulingPeriodByID(context, spId);</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">		    if (sp == null) {</span>
<span class="nc" id="L537">		    	appletResponse.put(OptimizationKeys.CAMPAIGN_SP_SELECTION_VALIDITY, false);</span>
<span class="nc" id="L538">		    	return;</span>
		    }
<span class="nc" id="L540">		    Campaign campaign = CampaignModelHandler.getCampaign(context, campaignId);</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">		    if (campaign == null) {</span>
<span class="nc" id="L542">		    	appletResponse.put(OptimizationKeys.CAMPAIGN_SP_SELECTION_VALIDITY, false);</span>
<span class="nc" id="L543">		    	return;</span>
		    }
		    //Combined queue selection is not valid for skilled SPs in service goals
<span class="nc bnc" id="L546" title="All 6 branches missed.">		    if (sp.getSkillBased() &amp;&amp; (queueIds == null || queueIds.size() == 0)) {</span>
<span class="nc" id="L547">		    	appletResponse.put(OptimizationKeys.CAMPAIGN_SP_SELECTION_VALIDITY, false);</span>
<span class="nc" id="L548">		    	return;		    	</span>
		    }
		    //Project media or null media is not valid for service goals
<span class="nc bnc" id="L551" title="All 4 branches missed.">		    if (mediaId == null || MediaType.get(mediaId).equals(MediaType.PROJECT)) {</span>
<span class="nc" id="L552">		    	appletResponse.put(OptimizationKeys.CAMPAIGN_SP_SELECTION_VALIDITY, false);</span>
<span class="nc" id="L553">		    	return;    	</span>
		    }
<span class="nc bnc" id="L555" title="All 2 branches missed.">		    for (ID queueId : queueIds) {</span>
<span class="nc" id="L556">				Queue queue = workloadManager.getQueueByID(queueId);</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">				if (queue == null) {</span>
<span class="nc" id="L558">					valid = false;</span>
<span class="nc" id="L559">					break;</span>
				}
<span class="nc" id="L561">				SPQueue spQueue = CampaignModelHandler.getSPQueue(context, spId, queueId);</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">				if (spQueue == null) {</span>
<span class="nc" id="L563">					valid = false;</span>
<span class="nc" id="L564">					break;</span>
				}
<span class="nc" id="L566">			}</span>
<span class="nc" id="L567">	    } catch(Exception e) {</span>
<span class="nc" id="L568">	    	valid = false;</span>
<span class="nc" id="L569">	    	notifyError(context, appletResponse, e);</span>
<span class="nc" id="L570">	    }</span>
<span class="nc" id="L571">	    appletResponse.put(OptimizationKeys.CAMPAIGN_SP_SELECTION_VALIDITY, valid);</span>
<span class="nc" id="L572">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>