<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SPQueueDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.campaign.ejb</a> &gt; <span class="el_source">SPQueueDAO.java</span></div><h1>SPQueueDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.campaign.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  DAO object to serialize SP Queue object
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       Shirley Sasson
 * @version      1.0
 */

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.PaginationPair;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmTimePeriodOverlapException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueueFieldInfo;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueueIDMap;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueueSortField;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriodFieldInfo;
import com.bluepumpkin.ejb.bbm.config.ejb.DBConfigManager;
import com.bluepumpkin.ejb.bbm.dao.DAOBaseWithAutoIDMapping;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.skill.model.SkillFieldInfo;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workload.model.MediaFieldInfo;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.QueueFieldInfo;
import com.bluepumpkin.ejb.bbm.workload.model.QueueType;
import com.bluepumpkin.ejb.bbm.workresource.model.OrganizationFieldInfo;

public class SPQueueDAO extends DAOBaseWithAutoIDMapping&lt;SPQueue&gt; {
<span class="fc" id="L62">	private static FieldInfo m_fieldInfo = new SPQueueFieldInfo();</span>
	private static final boolean USE_PATIENCE_IN_UNSKILLED_ASA_CALCS;
	private static final String PROC_CREATEUPDATESPQUEUE_LIMITED_FIELDS = &quot;BP_BF_CREATEORUPDATESPQUEUES&quot;;

<span class="fc" id="L66">	private static final QueueFieldInfo qfi = new QueueFieldInfo();</span>
<span class="fc" id="L67">	private static final OrganizationFieldInfo ofi = new OrganizationFieldInfo();</span>
<span class="fc" id="L68">	private static final MediaFieldInfo mfi = new MediaFieldInfo();</span>

<span class="fc" id="L70">	private final String queueNameSortFieldKey = qfi.getTableName() + &quot;_&quot; + qfi.getFieldName(QueueFieldInfo.QUEUE_NAME);</span>
<span class="fc" id="L71">	private final String queueDescriptionSortFieldKey = qfi.getTableName() + &quot;_&quot;</span>
<span class="fc" id="L72">			+ qfi.getFieldName(QueueFieldInfo.QUEUE_DESCRIPTION);</span>
<span class="fc" id="L73">	private final String organizationSortFieldKey = qfi.getTableName() + &quot;_&quot;</span>
<span class="fc" id="L74">			+ qfi.getFieldName(QueueFieldInfo.QUEUE_ORGANIZATIONNAME);</span>
<span class="fc" id="L75">	private final String mediaSortFieldKey = qfi.getTableName() + &quot;_&quot; + qfi.getFieldName(QueueFieldInfo.QUEUE_MEDIANAME);</span>
<span class="fc" id="L76">	private final String queueTypeSortFieldKey = qfi.getTableName() + &quot;_&quot; + qfi.getFieldName(QueueFieldInfo.QUEUE_TYPE);</span>

	static {
<span class="fc" id="L79">		boolean usePatience = false;</span>
		try {
<span class="fc" id="L81">			DBConfigManager bpConfigManager = BbmManagerFactory.getDBConfigManager();</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">			usePatience = (bpConfigManager.getIntValue(&quot;IsNewErlangC&quot;) == 1);</span>
<span class="nc" id="L83">		} catch (BbmEJBCreateException bece) {</span>
<span class="nc" id="L84">			bece.printStackTrace();</span>
<span class="nc" id="L85">		} catch (RemoteException re) {</span>
<span class="nc" id="L86">			re.printStackTrace();</span>
		} finally {
<span class="pc" id="L88">			USE_PATIENCE_IN_UNSKILLED_ASA_CALCS = usePatience;</span>
<span class="pc" id="L89">		}</span>
<span class="fc" id="L90">	}</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="fc" id="L94">		return m_fieldInfo;</span>
	}

	/**
	 * default constructor
	 */
	public SPQueueDAO() {
<span class="fc" id="L101">		super();</span>
<span class="fc" id="L102">	}</span>
	
	public SPQueueDAO(Jdmo dmo){
<span class="fc" id="L105">		super(dmo);</span>
<span class="fc" id="L106">	}</span>

	@Override
	protected Map&lt;Integer, ? extends FieldInfo&gt; getForeignKeyFieldInfo() {
<span class="fc" id="L110">		Map&lt;Integer, FieldInfo&gt; retVal = new HashMap&lt;Integer, FieldInfo&gt;();</span>
<span class="fc" id="L111">		retVal.put(SPQueueFieldInfo.SPQUEUE_SPID, new SchedulingPeriodFieldInfo());</span>
<span class="fc" id="L112">		retVal.put(SPQueueFieldInfo.SPQUEUE_QUEUEID, new QueueFieldInfo());</span>
<span class="fc" id="L113">		retVal.put(SPQueueFieldInfo.SPQUEUE_MEDIAID, new MediaFieldInfo());</span>
<span class="fc" id="L114">		return retVal;</span>
	}

	@Override
	protected SPQueue createValueObject() {
<span class="fc" id="L119">		SPQueue spq = new SPQueue();</span>
<span class="fc" id="L120">		spq.setIsPatienceUsedinUnskilledASACalcs(USE_PATIENCE_IN_UNSKILLED_ASA_CALCS);</span>
<span class="fc" id="L121">		return spq;</span>
	}

	public ID createSPQueue(SPQueue objValue) throws BbmCreateException, BbmTimePeriodOverlapException {
<span class="fc" id="L125">		Jdmo jdmo = new Jdmo();</span>
		try {
			// get the sp de id from sid
<span class="fc" id="L128">			ID spID = null;</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">			if (objValue.getSpID() != null) {</span>
<span class="fc" id="L130">				spID = DAOUtil.mapIDToDEID(objValue.getSpID(), new SchedulingPeriodFieldInfo());</span>
			}

			// get the queue de id
<span class="fc" id="L134">			ID queueID = null;</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">			if (objValue.getQueueID() != null) {</span>
<span class="fc" id="L136">				queueID = DAOUtil.mapIDToDEID(objValue.getQueueID(), new QueueFieldInfo());</span>
			}

			// Check if this queue is used in another campaign for the same
			// dates
<span class="fc" id="L141">			String queueChkStmt = &quot;Select distinct campaign.name from SPQUEUE, SP SP1, SP SP2, CAMPAIGN &quot;</span>
					+ &quot;where SP1.CAMPAIGNID = CAMPAIGN.ID and SPQUEUE.SPID = SP1.ID and &quot;
					+ &quot;((SP2.FROMDATE &gt;=  SP1.FROMDATE and SP2.FROMDATE &lt; SP1.TODATE) &quot;
					+ &quot;or (SP2.TODATE &gt;  SP1.FROMDATE and SP2.TODATE &lt;= SP1.TODATE) &quot;
					+ &quot;or (SP2.FROMDATE &lt;= SP1.FROMDATE and SP2.TODATE &gt;= SP1.TODATE )) &quot;
					+ &quot;and spqueue.queueid = ? and sp2.id = ?&quot;;
<span class="fc" id="L147">			JdmoQuery jq1Chk = jdmo.createQuery(queueChkStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="fc" id="L148">			jq1Chk.setParID(1, queueID);</span>
<span class="fc" id="L149">			jq1Chk.setParID(2, spID);</span>
<span class="fc" id="L150">			JdmoRowset rsChk = jdmo.createRowset(jq1Chk, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">			if (rsChk.next()) {</span>
<span class="nc" id="L152">				String cpName = rsChk.getString(1);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">				while (rsChk.next()) {</span>
<span class="nc" id="L154">					cpName = cpName + &quot;, &quot; + rsChk.getString(1);</span>
				}
<span class="nc" id="L156">				Object[] args = new Object[1];</span>
<span class="nc" id="L157">				args[0] = cpName;</span>
<span class="nc" id="L158">				throw (new BbmTimePeriodOverlapException(BbmEjbBundleKey.BUNDLE_NAME,</span>
						BbmEjbBundleKey.INVALID_QUEUE_TO_SP_LINKING, args));
			}
<span class="fc" id="L161">			rsChk.close();</span>

			// get the media de id of the underlying queue
<span class="fc" id="L164">			StringBuffer pStmt = new StringBuffer(&quot;select MEDIAID from QUEUE where ID = ?&quot;);</span>
<span class="fc" id="L165">			JdmoQuery jq1 = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="fc" id="L166">			jq1.setParString(1, queueID.toString());</span>
<span class="fc" id="L167">			JdmoRowset rs = jdmo.createRowset(jq1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="fc" id="L168">			ID mediaID = null;</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">			if (rs.next()) {</span>
<span class="fc" id="L170">				mediaID = rs.getID(1);</span>
			}
<span class="fc" id="L172">			rs.close();</span>

<span class="pc bpc" id="L174" title="1 of 2 branches missed.">			if (queueID != null) {</span>
				// Check if entry for this media in database for this spid
<span class="fc" id="L176">				String stmt = &quot;select SID from SPQUEUE where SPID= '&quot; + spID.toString() + &quot;' AND MEDIAID = '&quot;</span>
<span class="fc" id="L177">						+ mediaID.toString() + &quot;'&quot;;</span>
<span class="fc" id="L178">				JdmoRowset rs2 = jdmo.createRowset(stmt);</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">				if (!rs2.next()) { // no media entry exists so create one.</span>
									// Create the first spqueue with a null
									// media and null queue.
<span class="fc" id="L182">					SPQueue spqObj = new SPQueue();</span>
<span class="fc" id="L183">					spqObj.setSpID(spID);</span>
<span class="fc" id="L184">					spqObj.setQueueID(null);</span>
<span class="fc" id="L185">					spqObj.setMediaID(mediaID);</span>
<span class="fc" id="L186">					createSPQueueDB(spqObj, spID, null, mediaID);</span>
				}
<span class="fc" id="L188">				rs2.close();</span>
			}
<span class="fc" id="L190">			ID spqueueID = (createSPQueueDB(objValue, spID, queueID, mediaID));</span>

			// create parent spqueue if necessary
			// first check if there is a parent sp
<span class="fc" id="L194">			SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO();</span>
<span class="fc" id="L195">			ArrayList&lt;ID&gt; spids = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L196">			spids.add(objValue.getSpID());</span>
<span class="fc" id="L197">			Collection&lt;SchedulingPeriod&gt; sps = spDAO.getObjectsByIDs(spids);</span>
<span class="fc" id="L198">			SchedulingPeriod sp = sps.iterator().next();</span>
<span class="fc" id="L199">			ID parentSPID = sp.getParentSPID();</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">			if (parentSPID != null) {</span>
<span class="fc" id="L201">				String parentqueue = &quot;SELECT COUNT(*) NUMQ FROM SPQUEUE &quot; + &quot;WHERE SPID = '&quot; + parentSPID</span>
						+ &quot;' AND QUEUEID IN (select parentqueueid from queue where id = '&quot; + queueID + &quot;')&quot;;
<span class="fc" id="L203">				JdmoRowset parentRow = m_dmo.createRowset(parentqueue);</span>
<span class="fc" id="L204">				int count = 0;</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">				if (parentRow.next()) {</span>
<span class="fc" id="L206">					count = parentRow.getInt(&quot;NUMQ&quot;);</span>
				}
<span class="fc" id="L208">				parentRow.close();</span>

<span class="fc bfc" id="L210" title="All 2 branches covered.">				if (count == 0) {</span>
					// find the parent queue
<span class="fc" id="L212">					String parentqueueid = &quot;select parentqueueid from queue where id = '&quot; + queueID + &quot;'&quot;;</span>
<span class="fc" id="L213">					parentRow = m_dmo.createRowset(parentqueueid);</span>
<span class="fc" id="L214">					ID parentQueueID = null;</span>
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">					if (parentRow.next()) {</span>
<span class="fc" id="L216">						parentQueueID = parentRow.getID(&quot;parentqueueid&quot;);</span>
					}
<span class="fc" id="L218">					parentRow.close();</span>

<span class="fc" id="L220">					SPQueue spqObj = new SPQueue();</span>
<span class="fc" id="L221">					spqObj.setSpID(parentSPID);</span>
<span class="fc" id="L222">					spqObj.setQueueID(parentQueueID);</span>
<span class="fc" id="L223">					spqObj.setMediaID(mediaID);</span>
<span class="fc" id="L224">					createSPQueueDB(spqObj, parentSPID, parentQueueID, mediaID);</span>

<span class="fc" id="L226">					String parentstmt = &quot;select SID from SPQUEUE where SPID= '&quot; + parentSPID + &quot;' AND MEDIAID = '&quot;</span>
<span class="fc" id="L227">							+ mediaID.toString() + &quot;'&quot; + &quot; AND QUEUEID IS NULL&quot;;</span>
<span class="fc" id="L228">					JdmoRowset parentrs2 = jdmo.createRowset(parentstmt);</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">					if (!parentrs2.next()) { // no media entry exists so create</span>
												// one.
												// Create the first spqueue with
												// a null media and null queue.
<span class="fc" id="L233">						SPQueue spqParentCombined = new SPQueue();</span>
<span class="fc" id="L234">						spqParentCombined.setSpID(parentSPID);</span>
<span class="fc" id="L235">						spqParentCombined.setQueueID(null);</span>
<span class="fc" id="L236">						spqParentCombined.setMediaID(mediaID);</span>
<span class="fc" id="L237">						createSPQueueDB(spqParentCombined, parentSPID, null, mediaID);</span>
					}
<span class="fc" id="L239">					parentrs2.close();</span>
				}
			}

<span class="fc" id="L243">			return spqueueID;</span>
<span class="nc" id="L244">		} catch (BbmTimePeriodOverlapException e) {</span>
<span class="nc" id="L245">			throw e;</span>
<span class="nc" id="L246">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L247">			throw e;</span>
<span class="nc" id="L248">		} catch (JdmoException e) {</span>
<span class="nc" id="L249">			throw new BbmCreateException(e);</span>
<span class="nc" id="L250">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L251">			throw new BbmCreateException(e);</span>
		} finally {
<span class="pc" id="L253">			jdmo.cleanUp();</span>
		}
	}

	public ID createSPQueueDB(SPQueue objValue, ID spID, ID queueID, ID mediaID) throws BbmCreateException {
<span class="fc" id="L258">		Jdmo jdmo = new Jdmo();</span>
		try {
			// get ID from DE
<span class="fc" id="L261">			String idStr = DAOUtil.getDEID(jdmo);</span>

			String spIDstr, queueIDstr, mediaStr;
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">			if (spID != null) {</span>
<span class="fc" id="L265">				spIDstr = JdmoUtil.asSqlLiteral(spID.toString());</span>
			} else {
<span class="nc" id="L267">				spIDstr = &quot;null&quot;;</span>
			}
<span class="fc bfc" id="L269" title="All 2 branches covered.">			if (queueID != null) {</span>
<span class="fc" id="L270">				queueIDstr = JdmoUtil.asSqlLiteral(queueID.toString());</span>
			} else {
<span class="fc" id="L272">				queueIDstr = &quot;null&quot;;</span>
			}
<span class="fc bfc" id="L274" title="All 2 branches covered.">			if (mediaID != null) {</span>
<span class="fc" id="L275">				mediaStr = JdmoUtil.asSqlLiteral(mediaID.toString());</span>
			} else {
<span class="fc" id="L277">				mediaStr = &quot;null&quot;;</span>
			}
<span class="fc" id="L279">			String pStmt1 = &quot;insert into SPQUEUE (ID, SPID, QUEUEID, MEDIAID, SERVICELEVELGOALTYPE, PATIENCE, MAXABANDONSPERCENT, SLANSWERWAITINGTIME, STARTINGBACKLOG, ACTUALORWORKINGHOUR, OVERLOADTHRESHOLD1, OVERLOADTHRESHOLD2, INTERIMBACKLOG, QUEUEPRIORITYGROUP, QPGTHRESHOLD, CREATED) values (&quot;</span>
<span class="fc" id="L280">					+ JdmoUtil.asSqlLiteral(idStr)</span>
					+ &quot;, &quot;
					+ spIDstr
					+ &quot;, &quot;
					+ queueIDstr
					+ &quot;, &quot;
					+ mediaStr
					+ &quot;, &quot;
<span class="fc" id="L288">					+ JdmoUtil.formatBool(objValue.getServiceLevelGoalType())</span>
					+ &quot;, &quot;
<span class="fc" id="L290">					+ new Integer(objValue.getPatience())</span>
					+ &quot;, &quot;
<span class="fc" id="L292">					+ new Float(objValue.getMaxAbandonsPercent())</span>
					+ &quot;, &quot;
<span class="fc" id="L294">					+ new Integer(objValue.getSlAnswerWaitingTime())</span>
					+ &quot;, &quot;
<span class="fc" id="L296">					+ new Float(objValue.getStartingBacklog())</span>
					+ &quot;, &quot;
<span class="fc" id="L298">					+ JdmoUtil.formatBool(objValue.getActualOrWorkingHour())</span>
					+ &quot;, &quot;
<span class="fc" id="L300">					+ new Integer(objValue.getOverloadThreshold1())</span>
					+ &quot;, &quot;
<span class="fc" id="L302">					+ new Integer(objValue.getOverloadThreshold2())</span>
					+ &quot;, &quot;
					+

<span class="fc" id="L306">					new Float(objValue.getInterimBacklog())</span>
					+ &quot;, &quot;
<span class="fc" id="L308">					+ new Integer(objValue.getQueuePriorityGroup())</span>
					+ &quot;, &quot;
<span class="fc" id="L310">					+ new Integer(objValue.getQPGThreshold()) + &quot;,&quot; + JdmoUtil.asSqlLiteral(new Date()) + &quot;)&quot;;</span>
<span class="fc" id="L311">			jdmo.executeCommand(pStmt1);</span>

<span class="fc" id="L313">			StringBuffer pStmt = new StringBuffer(&quot;select SID from SPQUEUE where ID=?&quot;);</span>
<span class="fc" id="L314">			JdmoQuery jq1 = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="fc" id="L315">			jq1.setParString(1, idStr);</span>
<span class="fc" id="L316">			JdmoRowset rs = jdmo.createRowset(jq1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="fc" id="L318">			ID spQueueID = null;</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">			if (rs.next()) {</span>
<span class="fc" id="L320">				spQueueID = rs.getID(1);</span>
			}
<span class="fc" id="L322">			rs.close();</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">			if (objValue.IsSkillsUpdated()) {</span>
<span class="nc" id="L324">				linkSkillsToSPQueue(spQueueID, objValue.getSkills());</span>
			}
<span class="fc" id="L326">			return spQueueID;</span>
<span class="nc" id="L327">		} catch (JdmoException e) {</span>
<span class="nc" id="L328">			throw new BbmCreateException(e);</span>
<span class="nc" id="L329">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L330">			throw e;</span>
		} finally {
<span class="pc" id="L332">			jdmo.cleanUp();</span>
		}
	}

	public void updateSPQueue(SPQueue objValue) throws BbmUpdateException {
<span class="nc" id="L337">		Jdmo jdmo = new Jdmo();</span>
		try {
			String deleteDate, backlogDeleteDate;
<span class="nc bnc" id="L340" title="All 2 branches missed.">			if (objValue.getDeleteOnDate() != null) {</span>
<span class="nc" id="L341">				deleteDate = JdmoUtil.asSqlLiteral(objValue.getDeleteOnDate());</span>
			} else {
<span class="nc" id="L343">				deleteDate = &quot;null&quot;;</span>
			}

<span class="nc bnc" id="L346" title="All 2 branches missed.">			if (objValue.getInterimBacklogDate() != null) {</span>
<span class="nc" id="L347">				backlogDeleteDate = JdmoUtil.asSqlLiteral(objValue.getInterimBacklogDate());</span>
			} else {
<span class="nc" id="L349">				backlogDeleteDate = &quot;null&quot;;</span>
			}

<span class="nc" id="L352">			String pStmt1 = &quot;update SPQUEUE SET SERVICELEVELGOALTYPE = &quot;</span>
<span class="nc" id="L353">					+ JdmoUtil.formatBool(objValue.getServiceLevelGoalType()) + &quot;, PATIENCE = &quot;</span>
<span class="nc" id="L354">					+ new Integer(objValue.getPatience()) + &quot;, MAXABANDONSPERCENT = &quot;</span>
<span class="nc" id="L355">					+ new Float(objValue.getMaxAbandonsPercent()) + &quot;, SLANSWERWAITINGTIME = &quot;</span>
<span class="nc" id="L356">					+ new Integer(objValue.getSlAnswerWaitingTime()) + &quot;, STARTINGBACKLOG = &quot;</span>
<span class="nc" id="L357">					+ new Float(objValue.getStartingBacklog()) + &quot;, ACTUALORWORKINGHOUR = &quot;</span>
<span class="nc" id="L358">					+ JdmoUtil.formatBool(objValue.getActualOrWorkingHour()) + &quot;, DELETEONDATE = &quot; + deleteDate</span>
<span class="nc" id="L359">					+ &quot;, OVERLOADTHRESHOLD1 = &quot; + new Integer(objValue.getOverloadThreshold1()) + &quot;, OVERLOADTHRESHOLD2 = &quot;</span>
<span class="nc" id="L360">					+ new Integer(objValue.getOverloadThreshold2()) + &quot;, INTERIMBACKLOG = &quot;</span>
<span class="nc" id="L361">					+ new Float(objValue.getInterimBacklog()) + &quot;, INTERIMBACKLOGDATE = &quot; + backlogDeleteDate</span>
<span class="nc" id="L362">					+ &quot;, QUEUEPRIORITYGROUP = &quot; + new Integer(objValue.getQueuePriorityGroup()) + &quot;, QPGTHRESHOLD = &quot;</span>
<span class="nc" id="L363">					+ new Integer(objValue.getQPGThreshold()) + &quot;, MODIFIED = &quot; + JdmoUtil.asSqlLiteral(new Date())</span>
<span class="nc" id="L364">					+ &quot;  where SID = &quot; + JdmoUtil.asSqlLiteral(objValue.getID());</span>
<span class="nc" id="L365">			jdmo.executeCommand(pStmt1);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">			if (objValue.IsSkillsUpdated()) {</span>
<span class="nc" id="L367">				linkSkillsToSPQueue(objValue.getID(), objValue.getSkills());</span>
			}
<span class="nc" id="L369">		} catch (JdmoException e) {</span>
<span class="nc" id="L370">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L371">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L372">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L374">			jdmo.cleanUp();</span>
<span class="nc" id="L375">		}</span>
<span class="nc" id="L376">	}</span>

	/**
	 * Creates the list of the spqueues. This method is specifically written for
	 * Branch Forecasting uses cases where only a few fields are updates. Only
	 * the SPID, QueueID, Media Id, service goal type, patience, sl answering
	 * time and the first skill are used.
	 */
	public SPQueueIDMap createSPQueuesWithLimitedFields(Collection&lt;SPQueue&gt; spqueues) throws JdmoException {
<span class="nc" id="L385">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L387">			return new SPQueueIDMap(createOrUpdateSPQueuesWithLimitedFields(jdmo, spqueues));</span>
		} finally {
<span class="nc" id="L389">			jdmo.cleanUp();</span>
		}
	}
	
	/**
	 * Updates the list of the spqueues. This method is specifically written for
	 * Branch Forecasting uses cases where only a few fields are updates. Only
	 * the SPID, QueueID, Media Id, service goal type, patience, sl answering
	 * time and the first skill are used.
	 */
	public void updateSPQueuesWithLimitedFields(Collection&lt;SPQueue&gt; spqueues) throws JdmoException {
<span class="nc" id="L400">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L402">			createOrUpdateSPQueuesWithLimitedFields(jdmo, spqueues);</span>
		} finally {
<span class="nc" id="L404">			jdmo.cleanUp();</span>
<span class="nc" id="L405">		}</span>
<span class="nc" id="L406">	}</span>
	
	private JdmoRowset createOrUpdateSPQueuesWithLimitedFields(Jdmo jdmo, Collection&lt;SPQueue&gt; spqueues) throws JdmoException {
<span class="nc" id="L409">		JdmoQuery jQuery = jdmo.createQuery(PROC_CREATEUPDATESPQUEUE_LIMITED_FIELDS, Jdmo.STORPROC_QUERY);</span>
<span class="nc" id="L410">		jQuery.setParString(1, buildSPQueueDataForBulkUpdate(spqueues));</span>
<span class="nc" id="L411">		return jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
	}

	/**
	 * Builds the String in the format needed to call teh stored procedure to do
	 * bulk update of limited fields of SPQueue. Only the SPID, QueueID, Media
	 * Id, service goal type, patience, sl answering time and the first skill
	 * are used.
	 */
	String buildSPQueueDataForBulkUpdate(Collection&lt;SPQueue&gt; spqueues) {
<span class="nc" id="L421">		Map&lt;ID, String&gt; mediaStringIdbySID = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L422">		String seperator = &quot;,&quot;;</span>
<span class="nc" id="L423">		String rootStart = &quot;&lt;SPQ&gt;&quot;;</span>
<span class="nc" id="L424">		String elementStart = &quot;&lt;S&gt;&quot;;</span>
<span class="nc" id="L425">		String rootEnd = &quot;&lt;/SPQ&gt;&quot;;</span>
<span class="nc" id="L426">		String elementEnd = &quot;&lt;/S&gt;&quot;;</span>
<span class="nc" id="L427">		StringBuilder spqStringBuilder = new StringBuilder();</span>
<span class="nc" id="L428">		spqStringBuilder.append(rootStart);</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">		for (SPQueue spq : spqueues) {</span>
<span class="nc" id="L430">			spqStringBuilder.append(elementStart);</span>
<span class="nc" id="L431">			spqStringBuilder.append(spq.getSpID());</span>
<span class="nc" id="L432">			spqStringBuilder.append(seperator);</span>
<span class="nc" id="L433">			spqStringBuilder.append(spq.getQueueID());</span>
<span class="nc" id="L434">			spqStringBuilder.append(seperator);</span>
<span class="nc" id="L435">			String media = mediaStringIdbySID.get(spq.getMediaID());</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">			if (media == null) {</span>
<span class="nc" id="L437">				media = Media.convertMediaIdToString(spq.getMediaID());</span>
<span class="nc" id="L438">				mediaStringIdbySID.put(spq.getMediaID(), media);</span>
			}
<span class="nc" id="L440">			spqStringBuilder.append(media);</span>
<span class="nc" id="L441">			spqStringBuilder.append(seperator);</span>
<span class="nc" id="L442">			spqStringBuilder.append(JdmoUtil.formatBool(spq.getServiceLevelGoalType()));</span>
<span class="nc" id="L443">			spqStringBuilder.append(seperator);</span>
<span class="nc" id="L444">			spqStringBuilder.append(spq.getPatience());</span>
<span class="nc" id="L445">			spqStringBuilder.append(seperator);</span>
<span class="nc" id="L446">			spqStringBuilder.append(spq.getSlAnswerWaitingTime());</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">			if (spq.getSkills().size() &gt; 0) {</span>
<span class="nc" id="L448">				spqStringBuilder.append(seperator);</span>
<span class="nc" id="L449">				spqStringBuilder.append(spq.getSkills().iterator().next());</span>
			}
<span class="nc" id="L451">			spqStringBuilder.append(elementEnd);</span>
<span class="nc" id="L452">		}</span>
<span class="nc" id="L453">		spqStringBuilder.append(rootEnd);</span>
<span class="nc" id="L454">		return spqStringBuilder.toString();</span>
	}

	/**
	 * 
	 * Returns the SPQueue object
	 * 
	 * @param spQueueID
	 * @return
	 * @throws BbmFinderException
	 * @throws JdmoException
	 */
	public SPQueue getSPQueue(ID spQueueID) throws BbmFinderException, BbmObjectNotFoundException, JdmoException {
<span class="fc" id="L467">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="fc" id="L469">			SPQueue spq = dao.getObjectByID(spQueueID);</span>
<span class="fc" id="L470">			ID sidSPID = DAOUtil.mapIDToSID(spq.getSpID(), new SchedulingPeriodFieldInfo());</span>
<span class="fc" id="L471">			spq.setSpID(sidSPID);</span>
<span class="fc" id="L472">			ID sidMediaID = DAOUtil.mapIDToSID(spq.getMediaID(), new MediaFieldInfo());</span>
<span class="fc" id="L473">			spq.setDEMediaID(spq.getMediaID());</span>
<span class="fc" id="L474">			spq.setMediaID(sidMediaID);</span>
<span class="fc" id="L475">			spq.setSkillsFromDB(getSkillIDsForSPQueue(spQueueID));</span>
<span class="fc" id="L476">			return spq;</span>

<span class="nc" id="L478">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L479">			throw e;</span>
<span class="nc" id="L480">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L481">			throw e;</span>
		} finally {
<span class="pc" id="L483">			dao.cleanUp();</span>
		}
	}

	/**
	 * Returns the SID field of the SPQueue (legacy)
	 * 
	 * @param spID
	 * @param queueID
	 * @return
	 * @throws JdmoException
	 */
	public static ID getSPQueueID(ID spID, ID queueID) throws JdmoException {
<span class="fc" id="L496">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="fc" id="L498">			StringBuffer pStmt = new StringBuffer();</span>
<span class="fc" id="L499">			pStmt.append(&quot;select SPQUEUE.SID from SPQUEUE, SP, QUEUE &quot;);</span>
<span class="fc" id="L500">			pStmt.append(&quot;where SPQUEUE.SPID=SP.ID&quot;);</span>
<span class="fc" id="L501">			pStmt.append(&quot; and  SPQUEUE.QUEUEID=QUEUE.ID&quot;);</span>
<span class="fc" id="L502">			pStmt.append(&quot; and  QUEUE.SID=?&quot;);</span>
<span class="fc" id="L503">			pStmt.append(&quot; and  SP.SID=?&quot;);</span>

<span class="fc" id="L505">			JdmoQuery jq = dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="fc" id="L506">			jq.setParID(1, queueID);</span>
<span class="fc" id="L507">			jq.setParID(2, spID);</span>
<span class="fc" id="L508">			JdmoRowset rs = dmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="fc" id="L509">			ID spQueueID = null;</span>
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">			if (rs.next()) {</span>
<span class="fc" id="L511">				spQueueID = new ID(rs.getInt(1));</span>
			}
<span class="fc" id="L513">			rs.close();</span>
<span class="fc" id="L514">			return spQueueID;</span>
		} finally {
<span class="pc" id="L516">			dmo.cleanUp();</span>
		}
	}

	/*
	 * Returns the actual ID field of the SPQueue (getSPqueueID was already
	 * take)
	 */
	public static boolean hasSPQueues(ID spID) throws JdmoException {
<span class="nc" id="L525">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L527">			StringBuffer pStmt = new StringBuffer();</span>
<span class="nc" id="L528">			pStmt.append(&quot;select SPQUEUE.SID from SPQUEUE, SP &quot;);</span>
<span class="nc" id="L529">			pStmt.append(&quot; where SPQUEUE.SPID=SP.ID &quot;);</span>
<span class="nc" id="L530">			pStmt.append(&quot; and  SP.SID=?&quot;);</span>

<span class="nc" id="L532">			JdmoQuery jq = dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L533">			jq.setParID(1, spID);</span>
<span class="nc" id="L534">			JdmoRowset rs = dmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L535">			ID spQueueID = null;</span>
<span class="nc" id="L536">			boolean bHasSpQueue = false;</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L538">				bHasSpQueue = true;</span>
			}
<span class="nc" id="L540">			rs.close();</span>
<span class="nc" id="L541">			return bHasSpQueue;</span>
		} finally {
<span class="nc" id="L543">			dmo.cleanUp();</span>
		}
	}

	/*
	 * Returns the actual ID field of the SPQueue (getSPqueueID was already
	 * take)
	 */
	public static ID getSPQueueStringID(ID spID, ID queueID) throws JdmoException {
<span class="nc" id="L552">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L554">			StringBuffer pStmt = new StringBuffer();</span>
<span class="nc" id="L555">			pStmt.append(&quot;select SPQUEUE.SID from SPQUEUE, SP, QUEUE &quot;);</span>
<span class="nc" id="L556">			pStmt.append(&quot;where SPQUEUE.SPID=SP.ID&quot;);</span>
<span class="nc" id="L557">			pStmt.append(&quot; and  SPQUEUE.QUEUEID=QUEUE.ID&quot;);</span>
<span class="nc" id="L558">			pStmt.append(&quot; and  QUEUE.SID=?&quot;);</span>
<span class="nc" id="L559">			pStmt.append(&quot; and  SP.SID=?&quot;);</span>

<span class="nc" id="L561">			JdmoQuery jq = dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L562">			jq.setParID(1, queueID);</span>
<span class="nc" id="L563">			jq.setParID(2, spID);</span>
<span class="nc" id="L564">			JdmoRowset rs = dmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L565">			ID spQueueID = null;</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L567">				spQueueID = new ID(rs.getString(1));</span>
			}
<span class="nc" id="L569">			rs.close();</span>
<span class="nc" id="L570">			return spQueueID;</span>
		} finally {
<span class="nc" id="L572">			dmo.cleanUp();</span>
		}
	}

	/**
	 * Returns whether patience is to be used in ASA calculations for unskilled
	 * SPs instead of abandons.
	 */
	public static boolean isPatienceUsedInUnskilledASACalcs() {
<span class="nc" id="L581">		return USE_PATIENCE_IN_UNSKILLED_ASA_CALCS;</span>
	}

	/*
	 * public static void deleteSPQueue(ID spQueueId) throws JdmoException { if
	 * (spQueueId == null) return; Jdmo jdmo = new Jdmo(); try { Object[] param
	 * = new Object[1]; param[0] = spQueueId; // remove skills attached to
	 * spqueue jdmo.executePCommand(
	 * &quot;delete from SPQUEUESKILL where SPQUEUEID = (SELECT ID FROM SPQUEUE WHERE SID=?)&quot;
	 * , param); // remove spqueue
	 * jdmo.executePCommand(&quot;delete from SPQUEUE where SID=?&quot;, param); } finally
	 * { jdmo.cleanUp(); } }
	 */
	// Deletes spqueue and the skills attached to the spqueue
	public void deleteSPQueue(ID spQueueId) throws BbmRemoveException {
<span class="nc" id="L596">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L598">			String query = &quot;select id, SPID, MEDIAID from SPQUEUE where sid = &quot; + spQueueId.toString();</span>
<span class="nc" id="L599">			JdmoRowset r = m_dmo.createRowset(query);</span>
<span class="nc" id="L600">			ID SPID = null;</span>
<span class="nc" id="L601">			ID MediaID = null;</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L603">				SPID = r.getID(&quot;SPID&quot;);</span>
<span class="nc" id="L604">				MediaID = r.getID(&quot;MEDIAID&quot;);</span>
				break;
			}

			// delete parent queue in case this is a child queue
			// first check if there are other child queue has the same parent
<span class="nc" id="L610">			String subQueues = &quot;select count(*) as count from spqueue, Queue, sp where SPQUEUE.QUEUEID = QUEUE.ID AND SPQUEUE.SPID = SP.ID &quot;</span>
					+ &quot;AND parentqueueid in (&quot;
					+ &quot;select parentqueueid from QUEUE, SPQUEUE &quot;
					+ &quot;where SPQUEUE.QUEUEID = QUEUE.ID AND SPQUEUE.SID = &quot;
					+ spQueueId
					+ &quot;) AND SP.PARENTSPID in (&quot;
					+ &quot; select SP.PARENTSPID from SP, SPQUEUE &quot;
					+ &quot;where SPQUEUE.SPID = SP.ID AND SPQUEUE.SID = &quot;
					+ spQueueId + &quot;)&quot;;
<span class="nc" id="L619">			JdmoRowset subRow = m_dmo.createRowset(subQueues);</span>
<span class="nc" id="L620">			int count = 0;</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">			if (subRow.next()) {</span>
<span class="nc" id="L622">				count = subRow.getInt(&quot;count&quot;);</span>
			}
<span class="nc" id="L624">			subRow.close();</span>

			// there are no other queues, delete the parent
<span class="nc bnc" id="L627" title="All 2 branches missed.">			if (count == 1) {</span>
<span class="nc" id="L628">				String whereParent = &quot;select spqueue.ID ID from spqueue, Queue, sp where SPQUEUE.QUEUEID = QUEUE.ID AND SPQUEUE.SPID = SP.ID &quot;</span>
						+ &quot;AND queueid in (&quot;
						+ &quot;select parentqueueid from QUEUE, SPQUEUE &quot;
						+ &quot;where SPQUEUE.QUEUEID = QUEUE.ID AND SPQUEUE.SID = &quot;
						+ spQueueId
						+ &quot;) AND SP.ID in (&quot;
						+ &quot; select SP.PARENTSPID from SP, SPQUEUE &quot;
						+ &quot;where SPQUEUE.SPID = SP.ID AND SPQUEUE.SID = &quot;
						+ spQueueId + &quot;)&quot;;
<span class="nc" id="L637">				DAOUtil.deleteObjects(dmo, &quot;SPQUEUE&quot;, whereParent);</span>
			}

<span class="nc" id="L640">			String where = &quot;select id from SPQUEUE where sid = &quot; + spQueueId.toString();</span>
<span class="nc" id="L641">			DAOUtil.deleteObjects(dmo, &quot;SPQUEUE&quot;, where);</span>
<span class="nc" id="L642">			deleteAllSkillsForSPQueue(spQueueId);</span>

<span class="nc bnc" id="L644" title="All 4 branches missed.">			if (SPID != null &amp;&amp; MediaID != null) {</span>
<span class="nc" id="L645">				Collection&lt;SPQueue&gt; spQueues = null;</span>
				try {
<span class="nc" id="L647">					spQueues = getNonCombinedSPQueuesByMediaAndSP(SPID, MediaID);</span>
<span class="nc" id="L648">				} catch (BbmFinderException ex) {</span>

<span class="nc" id="L650">				}</span>
<span class="nc bnc" id="L651" title="All 4 branches missed.">				if (spQueues != null &amp;&amp; spQueues.size() == 0) {</span>
<span class="nc" id="L652">					where = &quot;select id from SPQUEUE where QUEUEID is NULL AND SPID = '&quot; + SPID.toString()</span>
<span class="nc" id="L653">							+ &quot;' AND MediaID = '&quot; + MediaID.toString() + &quot;'&quot;;</span>
<span class="nc" id="L654">					DAOUtil.deleteObjects(dmo, &quot;SPQUEUE&quot;, where);</span>
				}
			}

<span class="nc" id="L658">		} catch (JdmoException ex) {</span>
<span class="nc" id="L659">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc" id="L661">			dmo.cleanUp();</span>
<span class="nc" id="L662">		}</span>
<span class="nc" id="L663">	}</span>

	public Collection&lt;SPQueue&gt; getSPQueuesBySPID(ID SPSID) throws BbmObjectNotFoundException, BbmFinderException {
<span class="fc" id="L666">		return getSPQueuesBySPIDsFixed(Arrays.asList(SPSID));</span>
	}

	public Collection&lt;SPQueue&gt; getSPQueuesBySPIDsFixed(Collection&lt;ID&gt; SpSIDs) throws BbmObjectNotFoundException,
			BbmFinderException {

		// Use a map to avoid dupes (two objects with the same id are the same)
<span class="fc" id="L673">		Map&lt;ID, SPQueue&gt; hSPQueues = new HashMap&lt;ID, SPQueue&gt;();</span>
<span class="fc" id="L674">		JdmoRowset r = null;</span>
		try {
<span class="fc" id="L676">			String query = &quot;SELECT spq.ID, spq.SID, spq.SPID, spq.QUEUEID, spq.MEDIAID, spq.SERVICELEVELGOALTYPE, &quot;</span>
					+ &quot;spq.PATIENCE, spq.MAXABANDONSPERCENT, spq.SLANSWERWAITINGTIME, spq.STARTINGBACKLOG, &quot;
					+ &quot;spq.ACTUALORWORKINGHOUR, spq.DELETEONDATE, spq.OVERLOADTHRESHOLD1, spq.OVERLOADTHRESHOLD2, &quot;
					+ &quot;spq.ISQUALITYGOALPERCENTAGE, spq.QUALITYGOALREQUIREMENT, spq.MINIMUMQUALITYSCORE, spq.CONNECTGOAL, &quot;
					+ &quot;SPQ.FTETHRESHOLDOVER,SPQ.FTETHRESHOLDOVERPERCENT,SPQ.FTETHRESHOLDUNDER,SPQ.FTETHRESHOLDUNDERPERCENT,SPQ.LEASTTIMEINTERVAL, &quot;
					+ &quot;s.SID SpSID, m.SID MediaSID, q.SID QueueSID from SP s, SPQUEUE spq, MEDIA m, QUEUE q &quot;
<span class="fc" id="L682">					+ &quot;WHERE s.sid in &quot; + getDMO().createInClause(SpSIDs) + &quot; AND &quot;</span>
					+ &quot;spq.spid = s.id and spq.mediaid = m.id and spq.queueid = q.id&quot;;
<span class="fc" id="L684">			r = m_dmo.createRowset(query);</span>
<span class="fc bfc" id="L685" title="All 2 branches covered.">			while (r.next()) {</span>

<span class="fc" id="L687">				ID DEid = r.getID(&quot;ID&quot;);</span>
<span class="fc" id="L688">				ID theID = r.getID(&quot;SID&quot;);</span>
<span class="fc" id="L689">				ID spSID = r.getID(&quot;SpSID&quot;);</span>
<span class="fc" id="L690">				ID DEMediaID = r.getID(&quot;MEDIAID&quot;);</span>
<span class="fc" id="L691">				ID theMediaID = r.getID(&quot;MediaSID&quot;);</span>
<span class="fc" id="L692">				ID DEQueueID = r.getID(&quot;QueueID&quot;);</span>
<span class="fc" id="L693">				ID theQueueID = r.getID(&quot;QueueSID&quot;);</span>
<span class="fc" id="L694">				int patience = r.getInt(&quot;PATIENCE&quot;);</span>
<span class="fc" id="L695">				float maxAbandonsPercent = r.getFloat(&quot;MAXABANDONSPERCENT&quot;);</span>
<span class="fc" id="L696">				int SLAnswerWaitingTime = r.getInt(&quot;SLANSWERWAITINGTIME&quot;);</span>
<span class="fc" id="L697">				float startingBackLog = r.getFloat(&quot;STARTINGBACKLOG&quot;);</span>
<span class="fc" id="L698">				boolean actualOrWorkingHour = r.getBoolean(&quot;ACTUALORWORKINGHOUR&quot;);</span>
<span class="fc" id="L699">				Date deleteOnDate = r.getTimestamp(&quot;DELETEONDATE&quot;);</span>
<span class="fc" id="L700">				int overloadThreshold1 = r.getInt(&quot;OVERLOADTHRESHOLD1&quot;);</span>
<span class="fc" id="L701">				int overloadThreshold2 = r.getInt(&quot;OVERLOADTHRESHOLD2&quot;);</span>
<span class="fc" id="L702">				boolean isQualityGoalPercentage = r.getBoolean(&quot;ISQUALITYGOALPERCENTAGE&quot;);</span>
<span class="fc" id="L703">				int qualityGoalRequirement = r.getInt(&quot;QUALITYGOALREQUIREMENT&quot;);</span>
<span class="fc" id="L704">				int minimumQualityScore = r.getInt(&quot;MINIMUMQUALITYSCORE&quot;);</span>
<span class="fc" id="L705">				int connectGoal = r.getInt(&quot;CONNECTGOAL&quot;);</span>

<span class="fc" id="L707">				SPQueue pSPQueue = new SPQueue();</span>
<span class="fc" id="L708">				pSPQueue.setIsPatienceUsedinUnskilledASACalcs(USE_PATIENCE_IN_UNSKILLED_ASA_CALCS);</span>
<span class="fc" id="L709">				pSPQueue.setID(theID);</span>
<span class="fc" id="L710">				pSPQueue.setFieldValue(SPQueueFieldInfo.SPQUEUE_ID, DEid);</span>
<span class="fc" id="L711">				pSPQueue.setSpID(spSID);</span>
<span class="fc" id="L712">				pSPQueue.setQueueID(theQueueID);</span>
<span class="fc" id="L713">				pSPQueue.setDEQueueID(DEQueueID);</span>
<span class="fc" id="L714">				pSPQueue.setMediaID(theMediaID);</span>
<span class="fc" id="L715">				pSPQueue.setDEMediaID(DEMediaID);</span>
<span class="fc" id="L716">				pSPQueue.setPatience(patience);</span>
<span class="fc" id="L717">				pSPQueue.setMaxAbandonsPercent(maxAbandonsPercent);</span>
<span class="fc" id="L718">				pSPQueue.setServiceLevelGoalType(r.getBoolean(&quot;SERVICELEVELGOALTYPE&quot;));</span>
<span class="fc" id="L719">				pSPQueue.setSlAnswerWaitingTime(SLAnswerWaitingTime);</span>
<span class="fc" id="L720">				pSPQueue.setStartingBacklog(startingBackLog);</span>
<span class="fc" id="L721">				pSPQueue.setActualOrWorkingHour(actualOrWorkingHour);</span>
<span class="fc" id="L722">				pSPQueue.setDeleteOnDate(deleteOnDate);</span>
<span class="fc" id="L723">				pSPQueue.setOverloadThreshold1(overloadThreshold1);</span>
<span class="fc" id="L724">				pSPQueue.setOverloadThreshold2(overloadThreshold2);</span>
<span class="fc" id="L725">				pSPQueue.setIsQualityGoalPercentage(isQualityGoalPercentage);</span>
<span class="fc" id="L726">				pSPQueue.setQualityGoalRequirement(qualityGoalRequirement);</span>
<span class="fc" id="L727">				pSPQueue.setMinimumQualityScore(minimumQualityScore);</span>
<span class="fc" id="L728">				pSPQueue.setConnectGoal(connectGoal);</span>
<span class="fc" id="L729">				pSPQueue.setFTEThresholdOver(r.getInt(&quot;FTETHRESHOLDOVER&quot;));</span>
<span class="fc" id="L730">				pSPQueue.setFTEThresholdOverPercentage(r.getBoolean(&quot;FTETHRESHOLDOVERPERCENT&quot;));</span>
<span class="fc" id="L731">				pSPQueue.setFTEThresholdUnder(r.getInt(&quot;FTETHRESHOLDUNDER&quot;));</span>
<span class="fc" id="L732">				pSPQueue.setFTEThresholdUnderPercentage(r.getBoolean(&quot;FTETHRESHOLDUNDERPERCENT&quot;));</span>
<span class="fc" id="L733">				pSPQueue.setLeastTimeInterval(r.getInt(&quot;LEASTTIMEINTERVAL&quot;));</span>
<span class="fc" id="L734">				hSPQueues.put(theID, pSPQueue);</span>
<span class="fc" id="L735">			}</span>
			//load the skills for all the spqueues together rathen than make a call for each of them. 
			// This nearly triples the performance of this method for a get of few hundred SPQueues.
<span class="fc" id="L738">			loadSkillIDsIntoSPQueues(hSPQueues.values());</span>
			
<span class="fc" id="L740">			return new ArrayList&lt;SPQueue&gt;(hSPQueues.values());</span>

<span class="nc" id="L742">		} catch (JdmoException e) {</span>
<span class="nc" id="L743">			e.printStackTrace();</span>
<span class="nc" id="L744">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L746">			try {</span>
<span class="pc" id="L747">				r.close();</span>
<span class="nc" id="L748">			} catch (JdmoException e) {</span>
<span class="pc" id="L749">			}</span>
<span class="pc" id="L750">			m_dmo.cleanUp();</span>

		}
	}

	/**
	 * Persists the skills of each of the given spqueues (creates records in the
	 * spqueueskill table).
	 * 
	 * @param spQueueSkillIDMap
	 *            SPQueue ID (DEID) -&gt; Colleciton of linked skill IDs associated
	 *            to the spqueue (DEIDs)
	 */
	protected void linkSkillsToSPQueues(Map&lt;ID, Collection&lt;ID&gt;&gt; spQueueSkillIDMap) throws BbmCreateException {
		try {
<span class="nc bnc" id="L765" title="All 4 branches missed.">			if (spQueueSkillIDMap == null || spQueueSkillIDMap.isEmpty()) {</span>
<span class="nc" id="L766">				return;</span>
			}
<span class="nc" id="L768">			deleteAllSkillsForSPQueues(spQueueSkillIDMap.keySet());</span>
<span class="nc" id="L769">			HashMap&lt;String, ID&gt; columnValueMap = new HashMap&lt;String, ID&gt;();</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">			for (ID spQueueID : spQueueSkillIDMap.keySet()) {// TODO: map IDs to</span>
																// DEIDs?
<span class="nc bnc" id="L772" title="All 2 branches missed.">				for (ID skillID : spQueueSkillIDMap.get(spQueueID)) {</span>
<span class="nc" id="L773">					columnValueMap.put(&quot;SKILLID&quot;, skillID);</span>
<span class="nc" id="L774">					columnValueMap.put(&quot;SPQUEUEID&quot;, spQueueID);</span>
<span class="nc" id="L775">					getDMO().addBatchInsert(&quot;SPQUEUESKILL&quot;, columnValueMap);</span>
<span class="nc" id="L776">					columnValueMap.clear();</span>
<span class="nc" id="L777">				}</span>
<span class="nc" id="L778">			}</span>
<span class="nc" id="L779">			getDMO().executeBatch();</span>
<span class="nc" id="L780">		} catch (JdmoException ex) {</span>
<span class="nc" id="L781">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L782">		} catch (BbmRemoveException ex) {</span>
<span class="nc" id="L783">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L784">		}</span>
<span class="nc" id="L785">	}</span>

	public void linkSkillsToSPQueue(ID spQueueID, Collection&lt;ID&gt; colSkillIDs) throws BbmCreateException {
<span class="fc" id="L788">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="fc" id="L790">			deleteAllSkillsForSPQueue(spQueueID);</span>
<span class="pc bpc" id="L791" title="1 of 4 branches missed.">			if (colSkillIDs == null || colSkillIDs.size() &lt; 1) {</span>
<span class="fc" id="L792">				return;</span>
			}
<span class="fc bfc" id="L794" title="All 2 branches covered.">			for (ID skillID : colSkillIDs) {</span>
<span class="fc" id="L795">				linkSkillToSPQueue(spQueueID, skillID);</span>
<span class="fc" id="L796">			}</span>
<span class="nc" id="L797">		} catch (BbmCreateException ex) {</span>
<span class="nc" id="L798">			throw ex;</span>
<span class="nc" id="L799">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L800">			throw new BbmCreateException(e);</span>
		} finally {
<span class="pc" id="L802">			jdmo.cleanUp();</span>
<span class="fc" id="L803">		}</span>
<span class="fc" id="L804">	}</span>

	private void linkSkillToSPQueue(ID spQueueID, ID skillID) throws BbmCreateException {
<span class="fc" id="L807">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="fc" id="L809">			String idStr = DAOUtil.getDEID(jdmo);</span>
<span class="fc" id="L810">			ID skillDEID = DAOUtil.mapIDToDEID(skillID, new SkillFieldInfo());</span>
<span class="fc" id="L811">			ID spqueueDEID = DAOUtil.mapIDToDEID(spQueueID, new SPQueueFieldInfo());</span>
<span class="fc" id="L812">			ID createdID = new ID(idStr);</span>
<span class="fc" id="L813">			String strCreate = &quot;INSERT into SPQUEUESKILL (ID, SKILLID, SPQUEUEID) values ('&quot; + createdID + &quot;', '&quot;</span>
					+ skillDEID + &quot;', '&quot; + spqueueDEID + &quot;')&quot;;
<span class="fc" id="L815">			jdmo.executeCommand(strCreate.toString());</span>
<span class="nc" id="L816">		} catch (JdmoException ex) {</span>
<span class="nc" id="L817">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L818">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L819">			throw new BbmCreateException(e);</span>
		} finally {
<span class="pc" id="L821">			jdmo.cleanUp();</span>
<span class="fc" id="L822">		}</span>
<span class="fc" id="L823">	}</span>

	/**
	 * Removes all of the skills associated to each of the given SP Queues.
	 * 
	 * @param spQueueIDs
	 *            - The IDs of the spqueues from which we want to clear the
	 *            linked skills (DEIDs)
	 */
	private void deleteAllSkillsForSPQueues(Collection&lt;ID&gt; spQueueIDs) throws BbmRemoveException {
<span class="nc" id="L833">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L835">			String where = &quot;select ID from SPQUEUESKILL where SPQUEUEID IN &quot; + getDMO().createInClause(spQueueIDs);</span>
<span class="nc" id="L836">			DAOUtil.deleteObjects(dmo, &quot;SPQUEUESKILL&quot;, where);</span>
<span class="nc" id="L837">		} catch (JdmoException ex) {</span>
<span class="nc" id="L838">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc" id="L840">			dmo.cleanUp();</span>
<span class="nc" id="L841">		}</span>
<span class="nc" id="L842">	}</span>

	private void deleteAllSkillsForSPQueue(ID spQueueID) throws BbmRemoveException {
<span class="fc" id="L845">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="fc" id="L847">			String where = &quot;select ID from SPQUEUESKILL where SPQUEUEID = (SELECT ID from SPQUEUE WHERE SID = &quot; + spQueueID</span>
					+ &quot;)&quot;;
<span class="fc" id="L849">			DAOUtil.deleteObjects(dmo, &quot;SPQUEUESKILL&quot;, where);</span>
<span class="nc" id="L850">		} catch (JdmoException ex) {</span>
<span class="nc" id="L851">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="pc" id="L853">			dmo.cleanUp();</span>
<span class="fc" id="L854">		}</span>
<span class="fc" id="L855">	}</span>

	/**
	 * Returns a list of combined SPQueues associated to (i.e. having the same
	 * SP and media ID of) the given list of spQueues.
	 */
	public Collection&lt;SPQueue&gt; getCombinedSPQueues(Collection&lt;SPQueue&gt; spQueues) throws BbmFinderException {
<span class="fc" id="L862">		HashSet&lt;ID&gt; mediaIDs = new HashSet&lt;ID&gt;();</span>
<span class="fc" id="L863">		HashSet&lt;ID&gt; spIDs = new HashSet&lt;ID&gt;();</span>
		try {
<span class="fc bfc" id="L865" title="All 2 branches covered.">			for (SPQueue spQueue : spQueues) {</span>
<span class="pc bpc" id="L866" title="1 of 2 branches missed.">				if (spQueue.getSpID() != null) {</span>
<span class="fc" id="L867">					spIDs.add(spQueue.getSpID());</span>
				}
<span class="pc bpc" id="L869" title="1 of 2 branches missed.">				if (spQueue.getMediaID() != null) {</span>
<span class="fc" id="L870">					mediaIDs.add(spQueue.getMediaID());</span>
				}
<span class="fc" id="L872">			}</span>
<span class="fc" id="L873">			Map&lt;ID, ID&gt; mediaIDMap = DAOUtil.mapIDsToDEIDs(mediaIDs, new MediaFieldInfo());</span>
<span class="fc" id="L874">			Map&lt;ID, ID&gt; spIDMap = DAOUtil.mapIDsToDEIDs(spIDs, new SchedulingPeriodFieldInfo());</span>
<span class="fc" id="L875">			return getObjects(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_SPID) + &quot; IN &quot;</span>
<span class="fc" id="L876">					+ getDMO().createInClause(spIDMap.values()) + &quot; AND &quot;</span>
<span class="fc" id="L877">					+ getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID) + &quot; IS NULL AND &quot;</span>
<span class="fc" id="L878">					+ getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_MEDIAID) + &quot; IN &quot;</span>
<span class="fc" id="L879">					+ getDMO().createInClause(mediaIDMap.values()));</span>
<span class="nc" id="L880">		} catch (JdmoException e) {</span>
<span class="nc" id="L881">			throw new BbmFinderException(e);</span>
		}
	}

	/*
	 * Returns the combined SPQueue object given a scheduling period ID and a
	 * media ID
	 */
	public SPQueue getCombinedSPQueue(ID spID, ID mediaID) throws BbmFinderException {
<span class="fc" id="L890">		spID = DAOUtil.mapIDToDEID(spID, new SchedulingPeriodFieldInfo());</span>
<span class="fc" id="L891">		mediaID = DAOUtil.mapIDToDEID(mediaID, new MediaFieldInfo());</span>

<span class="fc" id="L893">		Collection&lt;SPQueue&gt; spQueues = getObjects(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_MEDIAID)</span>
<span class="fc" id="L894">				+ JdmoUtil.getEqualityOperator(mediaID, true) + JdmoUtil.asSqlLiteral(mediaID) + &quot; AND &quot;</span>
<span class="fc" id="L895">				+ getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_SPID) + &quot; = &quot; + JdmoUtil.asSqlLiteral(spID) + &quot; AND &quot;</span>
<span class="fc" id="L896">				+ getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID) + &quot; IS NULL&quot;);</span>
<span class="pc bpc" id="L897" title="1 of 4 branches missed.">		if (spQueues != null &amp;&amp; spQueues.size() &gt; 0) {</span>
<span class="fc" id="L898">			return spQueues.iterator().next();</span>
		}
<span class="fc" id="L900">		return null;</span>
	}

	/*
	 * Returns the non-combined SPQueues belonging to the given SP with the
	 * specified media ID. If a null media ID is specified, it will return all
	 * non-combined SPQueues in belonging to the SP.
	 */
	public Collection&lt;SPQueue&gt; getNonCombinedSPQueuesByMediaAndSP(ID spID, ID mediaID) throws BbmFinderException {

<span class="fc" id="L910">		spID = DAOUtil.mapIDToDEID(spID, new SchedulingPeriodFieldInfo());</span>
<span class="fc" id="L911">		mediaID = DAOUtil.mapIDToDEID(mediaID, new MediaFieldInfo());</span>
<span class="fc" id="L912">		StringBuffer query = new StringBuffer();</span>
<span class="pc bpc" id="L913" title="1 of 2 branches missed.">		if (mediaID != null) {</span>
<span class="fc" id="L914">			query.append(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_MEDIAID)).append(&quot; = &quot;)</span>
<span class="fc" id="L915">					.append(JdmoUtil.asSqlLiteral(mediaID)).append(&quot; AND &quot;);</span>
		}
<span class="fc" id="L917">		query.append(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_SPID)).append(&quot; = &quot;)</span>
<span class="fc" id="L918">				.append(JdmoUtil.asSqlLiteral(spID)).append(&quot; AND &quot;)</span>
<span class="fc" id="L919">				.append(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID)).append(&quot; IS NOT NULL&quot;);</span>
<span class="fc" id="L920">		return getObjects(query.toString());</span>
	}

	// This returns a collection of SP Queues given their sids
	public Collection&lt;SPQueue&gt; getSPQueuesByIDs(Collection&lt;? extends ID&gt; spQueueIDs) throws BbmFinderException {
<span class="fc" id="L925">		return getObjectsByIDs(spQueueIDs);</span>
	}

	/**
	 * Returns a collection of SPQueues corresponding to the Scheduling Periods
	 * having the specified SIDs.
	 *
	 * @Deprecated this works very differently from getSPQueuesBySPID()and is
	 *             probably no good The main difference that I can see is that
	 *             getSPQueuesBySPID (and consequently getSPQueuesBySPIDsFixed)
	 *             is that these other methods will load the associated skill
	 *             IDs as part of the SPQueue value objects, whereas this method
	 *             does not.
	 */
	@Deprecated
	public Collection&lt;SPQueue&gt; getSPQueuesBySPIDs(Collection&lt;? extends ID&gt; spIDs) throws BbmFinderException {
<span class="fc" id="L941">		SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO();</span>
		try {
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L944">			Collection&lt;SchedulingPeriod&gt; sps = spDAO.getObjectsByIDs(spIDs);</span>
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L946">			Collection&lt;ID&gt; spDEIDs = ValueObjectUtil.getFieldObjectCol(SchedulingPeriodFieldInfo.SP_DEID, sps);</span>
<span class="fc" id="L947">			return super.getObjects(&quot;SPID IN &quot; + getDMO().createInClause(spDEIDs));</span>
<span class="nc" id="L948">		} catch (JdmoException e) {</span>
<span class="nc" id="L949">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L951">			spDAO.cleanUp();</span>
		}
	}

	/**
	 * Returns a map containing the skill IDs linked to the given SPQueue IDs.
	 * Key - spQueueID, Value - Collection of Skill IDs linked to the SPQueue.
	 */
	private HashMap&lt;ID, Collection&lt;ID&gt;&gt; getSkillIDsForSPQueues(Collection&lt;ID&gt; spQueueIDs) throws BbmFinderException {
<span class="pc bpc" id="L960" title="1 of 2 branches missed.">		if (spQueueIDs == null) {</span>
<span class="nc" id="L961">			return new HashMap&lt;ID, Collection&lt;ID&gt;&gt;();</span>
		}

<span class="fc" id="L964">		Jdmo jdmo = new Jdmo();</span>
<span class="fc" id="L965">		HashMap&lt;ID, Collection&lt;ID&gt;&gt; result = new HashMap&lt;ID, Collection&lt;ID&gt;&gt;();</span>
<span class="fc" id="L966">		JdmoRowset rs = null;</span>
		try {
<span class="fc" id="L968">			StringBuffer pStmt = new StringBuffer();</span>
<span class="fc" id="L969">			pStmt.append(&quot; select spq.SID SPQUEUEID, s.SID SKILLID from &quot;);</span>
<span class="fc" id="L970">			pStmt.append(&quot; SPQUEUESKILL q,SKILL s,SPQUEUE spq &quot;);</span>
<span class="fc" id="L971">			pStmt.append(&quot; where q.SKILLID=s.ID and &quot;);</span>
<span class="fc" id="L972">			pStmt.append(&quot; q.SPQUEUEID=spq.id and &quot;);</span>
<span class="fc" id="L973">			pStmt.append(&quot; spq.sid IN &quot;);</span>
<span class="fc" id="L974">			pStmt.append(jdmo.createInClause(spQueueIDs));</span>

<span class="fc" id="L976">			JdmoQuery jq1 = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="fc" id="L977">			rs = jdmo.createRowset(jq1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="fc bfc" id="L979" title="All 2 branches covered.">			while (rs.next()) {</span>
<span class="fc" id="L980">				ID skillID = rs.getID(&quot;SKILLID&quot;);</span>
<span class="fc" id="L981">				ID spQueueID = rs.getID(&quot;SPQUEUEID&quot;);</span>
<span class="pc bpc" id="L982" title="1 of 2 branches missed.">				if (result.containsKey(spQueueID) == false) {</span>
<span class="fc" id="L983">					result.put(spQueueID, new HashSet&lt;ID&gt;());</span>
				}
<span class="fc" id="L985">				result.get(spQueueID).add(skillID);</span>
<span class="fc" id="L986">			}</span>
<span class="fc" id="L987">			return result;</span>
<span class="nc" id="L988">		} catch (Exception ex) {</span>
<span class="nc" id="L989">			throw new BbmFinderException(ex);</span>
		} finally {
<span class="nc" id="L991">			try {</span>
<span class="pc" id="L992">				rs.close();</span>
<span class="nc" id="L993">			} catch (JdmoException e) {</span>
<span class="pc" id="L994">			}</span>
<span class="pc" id="L995">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Returns a collection of skill IDs linked to the given SPQueue.
	 */
	private Collection&lt;ID&gt; getSkillIDsForSPQueue(ID spQueueID) throws BbmFinderException {
<span class="fc" id="L1003">		HashMap&lt;ID, Collection&lt;ID&gt;&gt; result = getSkillIDsForSPQueues(Collections.singleton(spQueueID));</span>
<span class="pc bpc" id="L1004" title="2 of 6 branches missed.">		if (result == null || result.containsKey(spQueueID) == false || result.get(spQueueID) == null) {</span>
<span class="fc" id="L1005">			return Collections.emptyList();</span>
		}
<span class="fc" id="L1007">		return result.get(spQueueID);</span>
	}

	/**
	 * Loads the skill IDs that are linked to the given SPQueues and stores the
	 * associated skill IDs on the related SPQueue value objects. These can
	 * later be retrieved from the SPQueue via SPQueue.getSkills()
	 */
	private void loadSkillIDsIntoSPQueues(Collection&lt;SPQueue&gt; spQueues) throws BbmFinderException {
<span class="fc" id="L1016">		Collection&lt;ID&gt; spQueueIDs = ValueObjectUtil.getIDFromObjects(spQueues);</span>
<span class="fc" id="L1017">		HashMap&lt;ID, Collection&lt;ID&gt;&gt; spQueueSkillIDMap = getSkillIDsForSPQueues(spQueueIDs);</span>
<span class="fc bfc" id="L1018" title="All 2 branches covered.">		for (SPQueue spQueue : spQueues) {</span>
<span class="fc" id="L1019">			Collection&lt;ID&gt; skillIDs = spQueueSkillIDMap.get(spQueue.getID());</span>
<span class="fc bfc" id="L1020" title="All 2 branches covered.">			if (skillIDs != null) {</span>
<span class="fc" id="L1021">				spQueue.setSkillsFromDB(skillIDs);</span>
			} else {
<span class="fc" id="L1023">				spQueue.setSkillsFromDB(new ArrayList&lt;ID&gt;());</span>
			}
<span class="fc" id="L1025">		}</span>
<span class="fc" id="L1026">	}</span>

	public Collection&lt;String&gt; getSkillNamesMappedToQueue(ID idQueue, ID spID) throws BbmFinderException {

<span class="nc bnc" id="L1030" title="All 4 branches missed.">		if (idQueue == null || spID == null) {</span>
<span class="nc" id="L1031">			return new ArrayList&lt;String&gt;();</span>
		}
<span class="nc" id="L1033">		List&lt;String&gt; retVal = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L1035">		ID deSPID = DAOUtil.mapIDToDEID(spID, new SchedulingPeriodFieldInfo());</span>
<span class="nc" id="L1036">		ID deIDQueue = DAOUtil.mapIDToDEID(idQueue, new QueueFieldInfo());</span>
<span class="nc" id="L1037">		JdmoRowset r = null;</span>
		try {
<span class="nc" id="L1039">			String query = &quot;Select distinct s.NAME &quot; + &quot;from SKILL s, SPQUEUESKILL sqs, SPQUEUE spq &quot;</span>
<span class="nc" id="L1040">					+ &quot;where queueid in (select id from queue where parentqueueid = &quot; + JdmoUtil.asSqlLiteral(deIDQueue)</span>
					+ &quot;)&quot; + &quot; and sqs.SPQUEUEID = spq.ID and sqs.SKILLID = s.ID and s.DELETEONDATE IS NULL&quot;
<span class="nc" id="L1042">					+ &quot; and spid in (select id from sp where parentspid = &quot; + JdmoUtil.asSqlLiteral(deSPID) + &quot;)&quot;;</span>

<span class="nc" id="L1044">			r = m_dmo.createRowset(query);</span>

<span class="nc bnc" id="L1046" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L1047">				String name = r.getString(&quot;NAME&quot;);</span>
<span class="nc" id="L1048">				retVal.add(name);</span>
<span class="nc" id="L1049">			}</span>
<span class="nc" id="L1050">			return retVal;</span>

<span class="nc" id="L1052">		} catch (JdmoException e) {</span>
<span class="nc" id="L1053">			e.printStackTrace();</span>
<span class="nc" id="L1054">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1056">			try {</span>
<span class="nc" id="L1057">				r.close();</span>
<span class="nc" id="L1058">			} catch (JdmoException e) {</span>
<span class="nc" id="L1059">			}</span>
<span class="nc" id="L1060">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * Given an SP ID, return a Map that maps each queue SID to its skill SID.
	 * If the SP has a queue that is not linked to a skill, then the queue is
	 * not included in the map. We assume that an SP queue can only be linked to
	 * a single skill.
	 * 
	 * @param spID
	 *            - the SID of the scheduling period.
	 * @return A Map that maps each queue SID to its skill SID.
	 * @throws BbmFinderException
	 */
	public Map&lt;ID, ID&gt; getQueueIDToSkillMap(ID spID) throws BbmFinderException {
<span class="pc bpc" id="L1076" title="1 of 2 branches missed.">		if (spID == null) {</span>
<span class="nc" id="L1077">			return new HashMap&lt;ID, ID&gt;();</span>
		}

<span class="fc" id="L1080">		Map&lt;ID, ID&gt; result = new HashMap&lt;ID, ID&gt;();</span>

<span class="fc" id="L1082">		String query = &quot;select Q.SID QSID, S.SID SSID &quot; + &quot;from SPQUEUESKILL SPQS &quot;</span>
				+ &quot;join SPQUEUE SPQ on SPQ.ID = SPQS.SPQUEUEID &quot; + &quot;join QUEUE Q on Q.ID = SPQ.QUEUEID &quot;
				+ &quot;join SKILL S on S.ID = SPQS.SKILLID &quot; + &quot;join SP on SP.SID=&quot; + spID + &quot; &quot; + &quot;where SPQ.SPID=SP.ID&quot;;
<span class="fc" id="L1085">		JdmoRowset r = null;</span>
		try {
<span class="fc" id="L1087">			r = m_dmo.createRowset(query);</span>
<span class="fc bfc" id="L1088" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L1089">				ID queueID = r.getID(&quot;QSID&quot;);</span>
<span class="fc" id="L1090">				ID skillID = r.getID(&quot;SSID&quot;);</span>
<span class="fc" id="L1091">				result.put(queueID, skillID);</span>
<span class="fc" id="L1092">			}</span>

<span class="fc" id="L1094">			r.close();</span>
<span class="fc" id="L1095">			return result;</span>
<span class="nc" id="L1096">		} catch (JdmoException e) {</span>
<span class="nc" id="L1097">			e.printStackTrace();</span>
<span class="nc" id="L1098">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1100">			try {</span>
<span class="pc" id="L1101">				r.close();</span>
<span class="nc" id="L1102">			} catch (JdmoException e) {</span>
<span class="pc" id="L1103">			}</span>
<span class="pc" id="L1104">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * Returns a collection of SPQueues associated with the given Queues
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public Collection&lt;SPQueue&gt; getSPQueuesByQueues(Collection&lt;Queue&gt; queues) throws BbmFinderException {
<span class="nc" id="L1113">		SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO();</span>
<span class="nc" id="L1114">		QueueFieldInfo queueFieldInfo = new QueueFieldInfo();</span>
		try {
<span class="nc" id="L1116">			Collection&lt;ID&gt; queueSIDs = ValueObjectUtil.getFieldObjectCol(QueueFieldInfo.QUEUE_SID, queues);</span>
<span class="nc" id="L1117">			Collection&lt;ID&gt; queueDEIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">			for (ID sid : queueSIDs) {</span>
<span class="nc" id="L1119">				queueDEIDs.add(DAOUtil.mapIDToDEID(sid, queueFieldInfo));</span>
<span class="nc" id="L1120">			}</span>
<span class="nc" id="L1121">			return super.getObjects(&quot;QUEUEID IN &quot; + getDMO().createInClause(queueDEIDs));</span>
<span class="nc" id="L1122">		} catch (JdmoException e) {</span>
<span class="nc" id="L1123">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1125">			spDAO.cleanUp();</span>
		}
	}

	/**
	 * Returns a complete list of IDs and the first chunk of data to be
	 * displayed. Does not return combined SPQueues.
	 */
	public PaginationPair&lt;SPQueue&gt; getCompletePaginationDataSetForSchedulingPeriod(ID spID, boolean isAscendingSort,
			int pageIDSize, int pageIndex, LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap, Collection&lt;ID&gt; filteredIDs)
			throws BbmFinderException {
<span class="fc" id="L1136">		StringBuffer whereClause = new StringBuffer();</span>
<span class="fc" id="L1137">		whereClause.append(&quot; A.SPID IN (SELECT ID FROM SP WHERE SID = &quot; + spID + &quot;) AND A.QUEUEID IS NOT NULL&quot;);</span>
<span class="fc" id="L1138">		return super.getCompletePaginationDataSet(whereClause.toString(), isAscendingSort, pageIDSize, pageIndex,</span>
				sortFieldMap, filteredIDs);
	}

	@Override
	protected void buildSortQuery(List&lt;DBSortField&gt; sortFields, StringBuffer selectQuery, StringBuffer fromQuery,
			StringBuffer whereQuery, StringBuffer groupByQuery, StringBuffer orderByQuery) {
<span class="fc bfc" id="L1145" title="All 2 branches covered.">		for (DBSortField sortField : sortFields) {</span>
<span class="pc bpc" id="L1146" title="5 of 7 branches missed.">			switch ((SPQueueSortField) sortField) {</span>
			case ID:
<span class="fc" id="L1148">				orderByQuery.append(getFieldInfo().getIDFieldName());</span>
<span class="fc" id="L1149">				break;</span>
			case QUEUE_NAME:
<span class="fc" id="L1151">				selectQuery.append(generateSimpleSortClauseForLinkedForeignTable(qfi, &quot;B&quot;,</span>
<span class="fc" id="L1152">						qfi.getFieldName(QueueFieldInfo.QUEUE_ID), qfi.getFieldName(QueueFieldInfo.QUEUE_NAME),</span>
<span class="fc" id="L1153">						getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID)));</span>
<span class="fc" id="L1154">				orderByQuery.append(queueNameSortFieldKey);</span>
<span class="fc" id="L1155">				break;</span>
			case DESCRIPTION:
<span class="nc" id="L1157">				selectQuery.append(generateSimpleSortClauseForLinkedForeignTable(qfi, &quot;C&quot;,</span>
<span class="nc" id="L1158">						qfi.getFieldName(QueueFieldInfo.QUEUE_ID), qfi.getFieldName(QueueFieldInfo.QUEUE_DESCRIPTION),</span>
<span class="nc" id="L1159">						getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID)));</span>
<span class="nc" id="L1160">				orderByQuery.append(queueDescriptionSortFieldKey);</span>
<span class="nc" id="L1161">				break;</span>
			case ORGANIZATION:
<span class="nc" id="L1163">				selectQuery.append(&quot;, (SELECT D.&quot;).append(ofi.getFieldName(OrganizationFieldInfo.ORGANIZATION_NAME))</span>
<span class="nc" id="L1164">						.append(&quot; FROM &quot;).append(ofi.getTableName()).append(&quot; D WHERE D.&quot;).append(ofi.getIDFieldName())</span>
<span class="nc" id="L1165">						.append(&quot; = (SELECT E.&quot;).append(qfi.getFieldName(QueueFieldInfo.QUEUE_ORGANIZATIONID))</span>
<span class="nc" id="L1166">						.append(&quot; FROM &quot;).append(qfi.getTableName()).append(&quot; E WHERE E.&quot;)</span>
<span class="nc" id="L1167">						.append(qfi.getFieldName(QueueFieldInfo.QUEUE_ID)).append(&quot; = A.&quot;)</span>
<span class="nc" id="L1168">						.append(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID)).append(&quot;)) AS &quot;)</span>
<span class="nc" id="L1169">						.append(organizationSortFieldKey);</span>
<span class="nc" id="L1170">				orderByQuery.append(organizationSortFieldKey);</span>
<span class="nc" id="L1171">				break;</span>
			case MEDIA:
<span class="nc" id="L1173">				selectQuery.append(&quot;, (SELECT F.&quot;).append(mfi.getFieldName(MediaFieldInfo.MEDIA_NAME)).append(&quot; FROM &quot;)</span>
<span class="nc" id="L1174">						.append(mfi.getTableName()).append(&quot; F WHERE F.&quot;)</span>
<span class="nc" id="L1175">						.append(mfi.getFieldName(MediaFieldInfo.MEDIA_STRID)).append(&quot; = (SELECT G.&quot;)</span>
<span class="nc" id="L1176">						.append(qfi.getFieldName(QueueFieldInfo.QUEUE_MEDIAID)).append(&quot; FROM &quot;).append(qfi.getTableName())</span>
<span class="nc" id="L1177">						.append(&quot; G WHERE G.&quot;).append(qfi.getFieldName(QueueFieldInfo.QUEUE_ID)).append(&quot; = A.&quot;)</span>
<span class="nc" id="L1178">						.append(getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID)).append(&quot;)) AS &quot;)</span>
<span class="nc" id="L1179">						.append(mediaSortFieldKey);</span>
<span class="nc" id="L1180">				orderByQuery.append(mediaSortFieldKey);</span>
<span class="nc" id="L1181">				break;</span>
			case TYPE:
<span class="nc" id="L1183">				selectQuery.append(generateSimpleSortClauseForLinkedForeignTable(qfi, &quot;F&quot;,</span>
<span class="nc" id="L1184">						qfi.getFieldName(QueueFieldInfo.QUEUE_ID), qfi.getFieldName(QueueFieldInfo.QUEUE_TYPE),</span>
<span class="nc" id="L1185">						getFieldInfo().getFieldName(SPQueueFieldInfo.SPQUEUE_QUEUEID)));</span>
<span class="nc" id="L1186">				orderByQuery.append(queueTypeSortFieldKey);</span>
<span class="nc" id="L1187">				break;</span>
			default:
				break;
			}
<span class="fc" id="L1191">		}</span>
<span class="fc" id="L1192">	}</span>

	@Override
	protected Object getPaginationDataFieldValue(JdmoRowset rowData, DBSortField sortField) throws JdmoException {
<span class="nc" id="L1196">		SPQueueSortField spqSortField = (SPQueueSortField) sortField;</span>
<span class="nc bnc" id="L1197" title="All 6 branches missed.">		switch (spqSortField) {</span>
		case QUEUE_NAME:
<span class="nc" id="L1199">			return rowData.getString(queueNameSortFieldKey);</span>
		case DESCRIPTION:
<span class="nc" id="L1201">			return rowData.getString(queueDescriptionSortFieldKey);</span>
		case ORGANIZATION:
<span class="nc" id="L1203">			return rowData.getString(organizationSortFieldKey);</span>
		case MEDIA:
<span class="nc" id="L1205">			return rowData.getString(mediaSortFieldKey);</span>
		case TYPE:
<span class="nc" id="L1207">			return QueueType.fromInt(rowData.getInt(queueTypeSortFieldKey));</span>
		default:
<span class="nc" id="L1209">			return null;</span>
		}
	}

	/**
	 * The following object retrieval methods are overriden from
	 * DAOBaseWithAutoIDMapping: getObjectsByParentID, getObjectsByParentIDs,
	 * getObjectsByParentIDs, getObjectByID, getObjects, getObjectsByIDs, and
	 * getObjectsGivenFullSqlQueryStr. These are overridden because a lot of
	 * client code expects a collection of associated skill IDs to be included
	 * as part of the SPQueue value object. TODO: The best approach here would
	 * be to refactor SPQueueDAO to extend from RichObjectDAO, and load the
	 * skills in automatically (rather than the skill IDs). However, this would
	 * require changing/testing a lot of client code which was outside the scope
	 * of this bugfix.
	 */
	@Override
	public Collection&lt;SPQueue&gt; getObjectsByParentID(ID idParent) throws BbmFinderException {
<span class="nc" id="L1227">		Collection&lt;SPQueue&gt; retVal = super.getObjectsByParentID(idParent);</span>
<span class="nc" id="L1228">		Collection&lt;ID&gt; spQueueIDs = ValueObjectUtil.getIDFromObjects(retVal);</span>
<span class="nc" id="L1229">		HashMap&lt;ID, Collection&lt;ID&gt;&gt; spQueueSkillIDMap = getSkillIDsForSPQueues(spQueueIDs);</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">		for (SPQueue spQueue : retVal) {</span>
<span class="nc" id="L1231">			Collection&lt;ID&gt; skillIDs = spQueueSkillIDMap.get(spQueue.getID());</span>
<span class="nc bnc" id="L1232" title="All 2 branches missed.">			if (skillIDs != null) {</span>
<span class="nc" id="L1233">				spQueue.setSkillsFromDB(skillIDs);</span>
			} else {
<span class="nc" id="L1235">				spQueue.setSkillsFromDB(new ArrayList&lt;ID&gt;());</span>
			}
<span class="nc" id="L1237">		}</span>
<span class="nc" id="L1238">		return retVal;</span>
	}

	@Override
	public Collection&lt;SPQueue&gt; getObjectsByParentIDs(Collection arrParentIDs, String parentIDsInClause)
			throws BbmFinderException {
<span class="nc" id="L1244">		Collection&lt;SPQueue&gt; retVal = super.getObjectsByParentIDs(arrParentIDs, parentIDsInClause);</span>
<span class="nc" id="L1245">		loadSkillIDsIntoSPQueues(retVal);</span>
<span class="nc" id="L1246">		return retVal;</span>
	}

	@Override
	public Collection&lt;SPQueue&gt; getObjectsByParentIDs(Collection arrParentIDs) throws BbmFinderException {
<span class="nc" id="L1251">		Collection&lt;SPQueue&gt; retVal = super.getObjectsByParentIDs(arrParentIDs);</span>
<span class="nc" id="L1252">		loadSkillIDsIntoSPQueues(retVal);</span>
<span class="nc" id="L1253">		return retVal;</span>
	}

	@Override
	public SPQueue getObjectByID(ID id) throws BbmObjectNotFoundException, BbmFinderException {
<span class="fc" id="L1258">		SPQueue spQueue = super.getObjectByID(id);</span>
<span class="fc" id="L1259">		loadSkillIDsIntoSPQueues(Collections.singleton(spQueue));</span>
<span class="fc" id="L1260">		return super.getObjectByID(id);</span>
	}

	@Override
	public Collection&lt;SPQueue&gt; getObjects(String strWhere, String strAfterWhere) throws BbmFinderException {
<span class="nc" id="L1265">		Collection&lt;SPQueue&gt; retVal = super.getObjects(strWhere, strAfterWhere);</span>
<span class="nc" id="L1266">		loadSkillIDsIntoSPQueues(retVal);</span>
<span class="nc" id="L1267">		return retVal;</span>
	}

	@Override
	public Collection&lt;SPQueue&gt; getObjects(String strWhere) throws BbmFinderException {
<span class="fc" id="L1272">		Collection&lt;SPQueue&gt; retVal = super.getObjects(strWhere);</span>
<span class="fc" id="L1273">		loadSkillIDsIntoSPQueues(retVal);</span>
<span class="fc" id="L1274">		return retVal;</span>
	}

	@Override
	public Collection&lt;SPQueue&gt; getObjectsByIDs(Collection&lt;? extends ID&gt; arrIDs) throws BbmFinderException {
<span class="fc" id="L1279">		Collection&lt;SPQueue&gt; retVal = super.getObjectsByIDs(arrIDs);</span>
<span class="fc" id="L1280">		loadSkillIDsIntoSPQueues(retVal);</span>
<span class="fc" id="L1281">		return retVal;</span>
	}

	@Override
	public Collection&lt;SPQueue&gt; getObjectsGivenFullSqlQueryStr(String fullSqlQuery) throws BbmFinderException {
<span class="fc" id="L1286">		Collection&lt;SPQueue&gt; retVal = super.getObjectsGivenFullSqlQueryStr(fullSqlQuery);</span>
<span class="fc" id="L1287">		loadSkillIDsIntoSPQueues(retVal);</span>
<span class="fc" id="L1288">		return retVal;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>