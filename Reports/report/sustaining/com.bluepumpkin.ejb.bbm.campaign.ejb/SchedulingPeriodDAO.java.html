<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SchedulingPeriodDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.campaign.ejb</a> &gt; <span class="el_source">SchedulingPeriodDAO.java</span></div><h1>SchedulingPeriodDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.campaign.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  dao object to serialize SchedulingPeriod object
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       lixin zhang
 * @version      1.0
 */

import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.ListIterator;
import java.util.Map;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.model.BbmCloningConflict;
import com.bluepumpkin.ejb.bbm.campaign.model.BbmCloningConflictException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignFieldInfo;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOO;
import com.bluepumpkin.ejb.bbm.campaign.model.CloneSPOptions;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueueFieldInfo;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriodFieldInfo;
import com.bluepumpkin.ejb.bbm.dao.DAOEffectivity;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriodUtil;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.util.MonthlySPUtil;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.core.base.MultiUserException;



public class SchedulingPeriodDAO extends DAOEffectivity&lt;SchedulingPeriod&gt; {

<span class="fc" id="L64">	private static FieldInfo m_fieldInfo = new SchedulingPeriodFieldInfo();</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="fc" id="L68">		return m_fieldInfo;</span>
	}

	public SchedulingPeriodDAO() {
<span class="fc" id="L72">		super();</span>
<span class="fc" id="L73">	}</span>

	public SchedulingPeriodDAO(Jdmo dmo) {
<span class="fc" id="L76">		super(dmo);</span>
<span class="fc" id="L77">	}</span>

	@Override
	protected SchedulingPeriod createValueObject() {
<span class="fc" id="L81">		return (new SchedulingPeriod());</span>
	}

	public ID createSchedulingPeriod(SchedulingPeriod schedulingPeriod) throws BbmCreateException {

<span class="fc" id="L86">		Jdmo jdmo = new Jdmo();</span>
<span class="fc" id="L87">		ID createdID = new ID();</span>
<span class="fc" id="L88">		JdmoRowset rsSID = null;</span>
<span class="fc" id="L89">		JdmoRowset rsSubCamps = null;</span>
<span class="fc" id="L90">		SPQueueDAO SPQueuedao = new SPQueueDAO();</span>
		try {
<span class="fc" id="L92">			TimeZone zone = CampaignDAO.getTimeZoneByCampaignID(schedulingPeriod.getCampaignID());</span>
<span class="fc" id="L93">			Date startGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(schedulingPeriod.getStartTimeLocal(),</span>
					zone);
<span class="fc" id="L95">			Date endGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(schedulingPeriod.getEndTimeLocal(), zone);</span>

			// get ID from DE
<span class="fc" id="L98">			String idStr = DAOUtil.getDEID(jdmo);</span>
<span class="fc" id="L99">			ID DEIDCampaignID = getDEIDFromSID(&quot;CAMPAIGN&quot;, schedulingPeriod.getCampaignID());</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">			int nSkillBased = (schedulingPeriod.getSkillBased()) ? 1 : 0;</span>

<span class="fc" id="L102">			String strCreate = &quot;INSERT INTO sp (id, campaignid, name, description, isskillbased, fromdate, todate,&quot;</span>
					+ &quot;is24hour,weekstart,fteshifts,fteworkhours,ftepaidhours,iscrossboundaries,&quot;
					+ &quot;mintimebetweenshift,ftephonehours,ftewage,minphantoms,maxphantoms,alloweditingofar,ismanualarmode,isusingallemployees) VALUES ('&quot;
<span class="fc" id="L105">					+ idStr + &quot;','&quot; + DEIDCampaignID + &quot;','&quot; + JdmoUtil.formatDBString(schedulingPeriod.getName())</span>
<span class="fc" id="L106">					+ &quot;','&quot; + JdmoUtil.formatDBString(schedulingPeriod.getDescription()) + &quot;',&quot; + nSkillBased + &quot;,'&quot;</span>
<span class="fc" id="L107">					+ JdmoUtil.formatDBString(startGMTDt) + &quot;','&quot; + JdmoUtil.formatDBString(endGMTDt)</span>
<span class="fc" id="L108">					+ &quot;', 0, 1440, 5, 480, 450, 0, 0, 420, 0, &quot; + schedulingPeriod.getMinPhantoms() + &quot;, &quot;</span>
<span class="fc" id="L109">					+ schedulingPeriod.getMaxPhantoms() + &quot;, 0, &quot;</span>
<span class="fc" id="L110">					+ JdmoUtil.formatBool(schedulingPeriod.isManualFteRequirementsMode()) + &quot;, &quot;</span>
<span class="fc" id="L111">					+ JdmoUtil.formatBool(schedulingPeriod.isUsingAllEmployees()) + &quot;)&quot;;</span>
<span class="fc" id="L112">			jdmo.executeCommand(strCreate.toString());</span>

			// find SID and return
<span class="fc" id="L115">			String stmt = &quot;SELECT sid FROM sp WHERE id ='&quot; + idStr + &quot;'&quot;;</span>
<span class="fc" id="L116">			rsSID = m_dmo.createRowset(stmt);</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">			if (rsSID.next()) {</span>
<span class="fc" id="L118">				createdID = rsSID.getID(1);</span>
			}

<span class="fc" id="L121">			ID DESubCampID = null;</span>
<span class="fc" id="L122">			String stmtSubCamps = &quot;SELECT id, SID FROM campaign WHERE parentcampaignid = '&quot; + DEIDCampaignID + &quot;'&quot;;</span>
<span class="fc" id="L123">			rsSubCamps = m_dmo.createRowset(stmtSubCamps);</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">			while (rsSubCamps.next()) {</span>
<span class="fc" id="L125">				DESubCampID = rsSubCamps.getID(1);</span>
<span class="fc" id="L126">				ID subCampID = rsSubCamps.getID(2);</span>
<span class="fc" id="L127">				zone = CampaignDAO.getTimeZoneByCampaignID(subCampID);</span>
<span class="fc" id="L128">				startGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(schedulingPeriod.getStartTimeLocal(),</span>
						zone);
<span class="fc" id="L130">				endGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(schedulingPeriod.getEndTimeLocal(), zone);</span>

<span class="fc" id="L132">				String subidStr = DAOUtil.getDEID(jdmo);</span>
<span class="fc" id="L133">				String strCreateSub = &quot;INSERT INTO sp (id, campaignid, parentspid, name, description, isskillbased, fromdate, todate,&quot;</span>
						+ &quot;is24hour,weekstart,fteshifts,fteworkhours,ftepaidhours,iscrossboundaries,&quot;
						+ &quot;mintimebetweenshift,ftephonehours,ftewage,minphantoms,maxphantoms,alloweditingofar,ismanualarmode,isusingallemployees) VALUES ('&quot;
						+ subidStr
						+ &quot;','&quot;
						+ DESubCampID
						+ &quot;','&quot;
						+ idStr
						+ &quot;','&quot;
<span class="fc" id="L142">						+ JdmoUtil.formatDBString(schedulingPeriod.getName())</span>
						+ &quot;','&quot;
<span class="fc" id="L144">						+ JdmoUtil.formatDBString(schedulingPeriod.getDescription())</span>
						+ &quot;',&quot;
						+ nSkillBased
						+ &quot;,'&quot;
<span class="fc" id="L148">						+ JdmoUtil.formatDBString(startGMTDt)</span>
						+ &quot;','&quot;
<span class="fc" id="L150">						+ JdmoUtil.formatDBString(endGMTDt)</span>
						+ &quot;', 0, 1440, 5, 480, 450, 0, 0, 420, 0, &quot;
<span class="fc" id="L152">						+ schedulingPeriod.getMinPhantoms()</span>
						+ &quot;, &quot;
<span class="fc" id="L154">						+ schedulingPeriod.getMaxPhantoms() + &quot;, 0, 0, 0)&quot;;</span>
<span class="fc" id="L155">				jdmo.executeCommand(strCreateSub.toString());</span>

				// find SID and return
<span class="fc" id="L158">				JdmoRowset rsSubSID = null;</span>
<span class="fc" id="L159">				String subStmt = &quot;SELECT sid FROM sp WHERE id ='&quot; + subidStr + &quot;'&quot;;</span>
<span class="fc" id="L160">				rsSubSID = m_dmo.createRowset(subStmt);</span>
<span class="fc" id="L161">				ID createdSubID = new ID();</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">				if (rsSubSID.next()) {</span>
<span class="fc" id="L163">					createdSubID = rsSubSID.getID(1);</span>
				}
				try {
<span class="fc" id="L166">					rsSubSID.close();</span>
<span class="nc" id="L167">				} catch (Exception e) {</span>
<span class="fc" id="L168">				}</span>

<span class="fc" id="L170">				SPQueue spqSubObj = new SPQueue();</span>
<span class="fc" id="L171">				spqSubObj.setSpID(createdSubID);</span>
<span class="fc" id="L172">				spqSubObj.setQueueID(null);</span>
<span class="fc" id="L173">				spqSubObj.setMediaID(null);</span>
<span class="fc" id="L174">				SPQueuedao.createSPQueueDB(spqSubObj, new ID(subidStr), null, null);</span>
<span class="fc" id="L175">			}</span>

			// Link the orgs.
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">			if (schedulingPeriod.IsOrgsLoaded()) {</span>
<span class="nc" id="L179">				linkOrgsToSP(schedulingPeriod.getParentSPID(), createdID, schedulingPeriod.getOrgs());</span>
			}

			// Create the first spqueue with a null media and null queue.
<span class="fc" id="L183">			SPQueue spqObj = new SPQueue();</span>
<span class="fc" id="L184">			spqObj.setSpID(createdID);</span>
<span class="fc" id="L185">			spqObj.setQueueID(null);</span>
<span class="fc" id="L186">			spqObj.setMediaID(null);</span>
<span class="fc" id="L187">			SPQueuedao.createSPQueueDB(spqObj, new ID(idStr), null, null);</span>
<span class="nc" id="L188">		} catch (JdmoException ex) {</span>
<span class="nc" id="L189">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L190">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L191">			throw new BbmCreateException(e);</span>
<span class="nc" id="L192">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L193">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L195">			try {</span>
<span class="pc" id="L196">				rsSID.close();</span>
<span class="nc" id="L197">			} catch (Exception e) {</span>
<span class="pc" id="L198">			}</span>
			try {
<span class="pc" id="L200">				rsSubCamps.close();</span>
<span class="nc" id="L201">			} catch (Exception e) {</span>
<span class="pc" id="L202">			}</span>
<span class="pc bpc" id="L203" title="3 of 4 branches missed.">			if (jdmo != null) {</span>
<span class="pc" id="L204">				jdmo.cleanUp();</span>
			}
<span class="pc bpc" id="L206" title="3 of 4 branches missed.">			if (SPQueuedao != null) {</span>
<span class="pc" id="L207">				SPQueuedao.cleanUp();</span>
			}
		}
<span class="fc" id="L210">		return createdID;</span>

	}

	protected ID getDEIDFromSID(String TableName, ID sidValue) throws JdmoException {
<span class="fc" id="L215">		ID DEID = null;</span>
<span class="fc" id="L216">		String stmt = &quot;SELECT id FROM &quot; + TableName + &quot; WHERE sid='&quot; + sidValue + &quot;'&quot;;</span>
<span class="fc" id="L217">		JdmoRowset rs = m_dmo.createRowset(stmt);</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">		if (rs.next()) {</span>
<span class="fc" id="L219">			DEID = rs.getID(1);</span>
		}
<span class="fc" id="L221">		return DEID;</span>
	}

	protected ID getSIDFromDEID(String TableName, ID idValue) throws JdmoException {
<span class="fc" id="L225">		ID SID = null;</span>
<span class="fc" id="L226">		String stmt = &quot;SELECT sid FROM &quot; + TableName + &quot; WHERE id='&quot; + idValue + &quot;'&quot;;</span>
<span class="fc" id="L227">		JdmoRowset rs = m_dmo.createRowset(stmt);</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">		if (rs.next()) {</span>
<span class="fc" id="L229">			SID = rs.getID(1);</span>
		}
<span class="fc" id="L231">		return SID;</span>
	}

	public void updateSchedulingPeriods(Collection&lt;SchedulingPeriod&gt; colObjValues) throws MultiUserException,
			BbmUpdateException {
		try {
			// updateObjects(colObjValues);
<span class="fc" id="L238">			SchedulingPeriod objValue = null;</span>
<span class="fc" id="L239">			HashMap&lt;String, Object&gt; nameValues = new HashMap&lt;String, Object&gt;(5);</span>
<span class="fc" id="L240">			ID prevSPID = null;</span>
<span class="fc" id="L241">			ID prevSPSID = null;</span>
			ID DEIDSchedulingPeriod;
<span class="fc bfc" id="L243" title="All 2 branches covered.">			for (Iterator&lt;SchedulingPeriod&gt; i = colObjValues.iterator(); i.hasNext();) {</span>
<span class="fc" id="L244">				objValue = i.next();</span>
<span class="fc" id="L245">				ID idSchedulingPeriod = objValue.getID();</span>
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">				if (idSchedulingPeriod == prevSPSID) {</span>
<span class="nc" id="L247">					DEIDSchedulingPeriod = prevSPID;</span>
				} else {
<span class="fc" id="L249">					DEIDSchedulingPeriod = getDEIDFromSID(&quot;SP&quot;, idSchedulingPeriod);</span>
<span class="fc" id="L250">					prevSPSID = idSchedulingPeriod;</span>
<span class="fc" id="L251">					prevSPID = DEIDSchedulingPeriod;</span>
				}
<span class="fc" id="L253">				nameValues.put(&quot;ID&quot;, JdmoUtil.asSqlLiteral(DEIDSchedulingPeriod.toString()));</span>
<span class="fc bfc" id="L254" title="All 2 branches covered.">				if (objValue.getParentSPID() != null) {</span>
<span class="fc" id="L255">					nameValues.put(&quot;PARENTSPID&quot;, JdmoUtil.formatDBString(objValue.getParentSPID().toString()));</span>
				}
<span class="fc" id="L257">				nameValues.put(&quot;DESCRIPTION&quot;, objValue.getDescription());</span>
<span class="fc" id="L258">				nameValues.put(&quot;ISSKILLBASED&quot;, JdmoUtil.formatBool(objValue.getSkillBased()));</span>
<span class="fc" id="L259">				nameValues.put(&quot;MINPHANTOMS&quot;, objValue.getMinPhantoms());</span>
<span class="fc" id="L260">				nameValues.put(&quot;MAXPHANTOMS&quot;, objValue.getMaxPhantoms());</span>
<span class="fc" id="L261">				nameValues.put(&quot;ISUSINGALLEMPLOYEES&quot;, JdmoUtil.formatBool(objValue.isUsingAllEmployees()));</span>
<span class="fc" id="L262">				nameValues.put(&quot;ISMANUALARMODE&quot;, JdmoUtil.formatBool(objValue.isManualFteRequirementsMode()));</span>
<span class="fc" id="L263">				m_dmo.addBatchUpdate(&quot;SP&quot;, nameValues);</span>
				// linkOrgsToSP() nulls out the batch in m_dmo (specifically
				// m_dmo.m_stmt becomes null
				// So we have to invoke() executeBatch() immediately rather than
				// after the
				// loop, which slows execution slightly .
<span class="fc" id="L269">				m_dmo.executeBatch();</span>

				// Link the orgs.
<span class="fc bfc" id="L272" title="All 2 branches covered.">				if (objValue.IsOrgsLoaded()) {</span>
<span class="fc" id="L273">					linkOrgsToSP(objValue.getParentSPID(), idSchedulingPeriod, objValue.getOrgs());</span>
				}

				// update child sps
<span class="fc bfc" id="L277" title="All 2 branches covered.">				if (objValue.getParentSPID() == null) {</span>
<span class="fc" id="L278">					String strUpdateChildren = &quot;Update SP set ISSKILLBASED = &quot;</span>
<span class="fc" id="L279">							+ JdmoUtil.formatBool(objValue.getSkillBased()) + &quot; WHERE PARENTSPID = &quot;</span>
<span class="fc" id="L280">							+ JdmoUtil.asSqlLiteral(DEIDSchedulingPeriod.toString());</span>
<span class="fc" id="L281">					m_dmo.executeCommand(strUpdateChildren);</span>
				}
<span class="fc" id="L283">			}</span>
<span class="nc" id="L284">		} catch (JdmoException ex) {</span>
<span class="nc" id="L285">			throw new BbmUpdateException(ex);</span>
<span class="nc" id="L286">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L287">			throw new BbmUpdateException(e.getBundleName(), e.getMsgID(), e.getParamObject());</span>
<span class="fc" id="L288">		}</span>
<span class="fc" id="L289">	}</span>

	/** delete a campaign's organization assignment given the assignment id */
	public void deleteSchedulingPeriods(Collection&lt;ID&gt; colIDs) throws BbmRemoveException {
<span class="nc" id="L293">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L295">			String where = &quot;select ID from SP where SID in &quot; + m_dmo.createInClause(colIDs);</span>
			// delete children sp too.
<span class="nc" id="L297">			where += &quot; OR PARENTSPID in (select ID from SP where SID in &quot; + m_dmo.createInClause(colIDs) + &quot;)&quot;;</span>
<span class="nc" id="L298">			DAOUtil.deleteObjects(jdmo, &quot;SP&quot;, where);</span>
			// deleteObjects(colIDs);
<span class="nc" id="L300">		} catch (JdmoException ex) {</span>
<span class="nc" id="L301">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc bnc" id="L303" title="All 4 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L304">				jdmo.cleanUp();</span>
			}
		}
<span class="nc" id="L307">	}</span>

	/**
	 * get existing scheduling periods for a campaign
	 *
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null dates are not allowed
	 *
	 * @return a collection of SchedulingPeriod objects which hold the
	 *         assignment information
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, Date dtStart, Date dtEnd, ID idSP,
			Collection&lt;ID&gt; cSP) throws BbmFinderException {
<span class="fc" id="L320">		return getSchedulingPeriods(idCampaign, null, dtStart, dtEnd, idSP, cSP);</span>
	}

	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID campaignSID, ID idOrg, Date dtStart, Date dtEnd, ID idSP,
			Collection&lt;ID&gt; cSP) throws BbmFinderException {

<span class="fc" id="L326">		List&lt;SchedulingPeriod&gt; aSPs = new ArrayList&lt;SchedulingPeriod&gt;();</span>
<span class="fc" id="L327">		JdmoRowset r = null;</span>
		try {

			// Queury the database
<span class="pc bpc" id="L331" title="1 of 4 branches missed.">			if (idSP != null &amp;&amp; !idSP.isInt()) {</span>
<span class="nc" id="L332">				idSP = DAOUtil.mapIDToSID(idSP, new SchedulingPeriodFieldInfo());</span>
			}

<span class="fc" id="L335">			String query = &quot;SELECT sp.id AS deid, &quot; + &quot;  sp.sid, &quot; + &quot;  sp.parentspid, &quot; + &quot;  sp.fromdate, &quot;</span>
					+ &quot;  sp.todate, &quot; + &quot;  sp.isskillbased, &quot; + &quot;  sp.minphantoms, &quot; + &quot;  sp.maxphantoms, &quot; + &quot;  sp.name, &quot;
					+ &quot;  sp.description, &quot; + &quot;  sp.alloweditingofar, &quot; + &quot;  sp.ismanualarmode, &quot;
					+ &quot;  sp.isusingallemployees, &quot; + &quot;  campaign.sid as csid &quot; + &quot;FROM sp, campaign &quot;;

<span class="pc bpc" id="L340" title="1 of 2 branches missed.">			if (idOrg != null) {</span>
<span class="nc" id="L341">				query += &quot;,spcallcenter &quot;;</span>
			}

<span class="fc bfc" id="L344" title="All 2 branches covered.">			if (idSP != null) {</span>
<span class="fc" id="L345">				query += &quot; WHERE campaign.id = sp.campaignid AND sp.sid = &quot; + idSP;</span>
<span class="fc bfc" id="L346" title="All 2 branches covered.">			} else if (campaignSID != null) {</span>
<span class="pc bpc" id="L347" title="1 of 4 branches missed.">				if (dtStart != null &amp;&amp; dtEnd != null) {</span>
<span class="fc" id="L348">					query += (&quot; WHERE campaign.id = sp.campaignid AND campaign.sid = &quot; + campaignSID + &quot; and fromdate &lt; '&quot;</span>
<span class="fc" id="L349">							+ JdmoUtil.formatDBString(dtEnd) + &quot;' and todate &gt; '&quot; + JdmoUtil.formatDBString(dtStart) + &quot;'&quot;);</span>
				} else {
<span class="fc" id="L351">					query += (&quot; WHERE campaign.id = sp.campaignid AND campaign.sid = &quot; + campaignSID);</span>
				}
			} else {
<span class="fc" id="L354">				query += &quot; WHERE campaign.id = campaignid AND sp.sid IN &quot; + m_dmo.createInClause(cSP);</span>
			}

<span class="pc bpc" id="L357" title="1 of 2 branches missed.">			if (idOrg != null) {</span>
<span class="nc" id="L358">				query += &quot; AND spcallcenter.spid = sp.id AND spcallcenter.organizationid=&quot; + idOrg;</span>
			}

<span class="fc" id="L361">			query += &quot; ORDER BY fromdate ASC&quot;;</span>
<span class="fc" id="L362">			r = m_dmo.createRowset(query);</span>

			// Convert result set to scheduling period entities
<span class="fc bfc" id="L365" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L366">				ID idCampaign1 = r.getID(&quot;CSID&quot;);</span>
<span class="fc" id="L367">				TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(idCampaign1);</span>

<span class="fc" id="L369">				SchedulingPeriod sp = getSchedulingPeriodFromRowset(r, tz);</span>

				// Add to result collection
<span class="fc" id="L372">				aSPs.add(sp);</span>
<span class="fc" id="L373">			}</span>

<span class="fc" id="L375">			return aSPs;</span>

<span class="nc" id="L377">		} catch (JdmoException e) {</span>
<span class="nc" id="L378">			e.printStackTrace();</span>
<span class="nc" id="L379">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L381">			try {</span>
<span class="pc" id="L382">				r.close();</span>
<span class="nc" id="L383">			} catch (Exception e) {</span>
<span class="pc" id="L384">			}</span>
<span class="pc" id="L385">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 *
	 * @param campaignSID
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID campaignSID) throws BbmFinderException {

<span class="nc" id="L397">		TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(campaignSID);</span>

<span class="nc" id="L399">		List&lt;SchedulingPeriod&gt; result = new ArrayList&lt;SchedulingPeriod&gt;();</span>

<span class="nc" id="L401">		JdmoRowset r = null;</span>
		try {

			// Queury the database
<span class="nc" id="L405">			String query = &quot;SELECT sp.id AS deid, &quot; + &quot;  sp.sid, &quot; + &quot;  sp.parentspid, &quot; + &quot;  sp.fromdate, &quot;</span>
					+ &quot;  sp.todate, &quot; + &quot;  sp.isskillbased, &quot; + &quot;  sp.minphantoms, &quot; + &quot;  sp.maxphantoms, &quot; + &quot;  sp.name, &quot;
					+ &quot;  sp.description, &quot; + &quot;  sp.alloweditingofar, &quot; + &quot;  sp.ismanualarmode, &quot;
					+ &quot;  sp.isusingallemployees, &quot; + &quot;  c.sid as csid &quot; + &quot;FROM sp sp &quot; + &quot;LEFT JOIN campaign c &quot;
					+ &quot;  ON c.id = sp.campaignid&quot; + &quot;WHERE c.sid = &quot; + campaignSID + &quot;ORDER BY fromdate ASC&quot;;
<span class="nc" id="L410">			r = m_dmo.createRowset(query);</span>

			// Convert result set to scheduling period entities
<span class="nc bnc" id="L413" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L414">				SchedulingPeriod sp = getSchedulingPeriodFromRowset(r, tz);</span>

				// Add to result collection
<span class="nc" id="L417">				result.add(sp);</span>
<span class="nc" id="L418">			}</span>

<span class="nc" id="L420">			return result;</span>

<span class="nc" id="L422">		} catch (JdmoException e) {</span>
<span class="nc" id="L423">			e.printStackTrace();</span>
<span class="nc" id="L424">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L426">			try {</span>
<span class="nc" id="L427">				r.close();</span>
<span class="nc" id="L428">			} catch (Exception e) {</span>
<span class="nc" id="L429">			}</span>
<span class="nc" id="L430">			m_dmo.cleanUp();</span>
		}
	}

	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, Date dtDate, int nNumberToGet, int eTimeFrame)
			throws BbmFinderException {

<span class="fc" id="L437">		List&lt;SchedulingPeriod&gt; resultSchedulingPeriods = new ArrayList&lt;SchedulingPeriod&gt;();</span>
<span class="fc" id="L438">		List&lt;ID&gt; aIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L439">		JdmoRowset r = null;</span>
		try {
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">			if (eTimeFrame == SchedulingPeriod.PastAndFuture) {</span>
<span class="fc" id="L442">				nNumberToGet /= 2;</span>
			}

			int i; // loop counter for nNumberToGet
<span class="pc bpc" id="L446" title="2 of 4 branches missed.">			if (eTimeFrame == SchedulingPeriod.PastOnly || eTimeFrame == SchedulingPeriod.PastAndFuture) {</span>
				// query past scheduling periods
<span class="fc" id="L448">				String query = &quot;SELECT sp.sid, &quot; + &quot;   sp.id AS deid, &quot; + &quot;   parentspid, &quot; + &quot;   sp.name, &quot;</span>
						+ &quot;   sp.description, &quot; + &quot;   sp.minphantoms, &quot; + &quot;   sp.maxphantoms, &quot; + &quot;   fromdate, &quot;
						+ &quot;   todate, &quot; + &quot;   isskillbased, &quot; + &quot;   sp.alloweditingofar, &quot; + &quot;   sp.ismanualarmode, &quot;
						+ &quot;   sp.isusingallemployees, &quot; + &quot;   campaign.sid AS csid &quot; + &quot;FROM sp,campaign &quot;
						+ &quot;WHERE campaign.id = campaignid AND campaign.sid = &quot; + idCampaign + &quot;   AND fromdate &lt;= '&quot;
<span class="fc" id="L453">						+ JdmoUtil.formatDBString(dtDate) + &quot;' ORDER BY fromdate DESC&quot;;</span>
<span class="fc" id="L454">				r = m_dmo.createRowset(query);</span>

				// Create skill entities from result set
<span class="fc" id="L457">				i = 0;</span>
<span class="pc bpc" id="L458" title="1 of 4 branches missed.">				while (r.next() &amp;&amp; i++ &lt; nNumberToGet) {</span>
<span class="fc" id="L459">					SchedulingPeriod sp = getSchedulingPeriodFromRowset(r, null);</span>

					//aIDs.add(idSP1);
<span class="fc" id="L462">					aIDs.add(sp.getID());</span>
<span class="fc" id="L463">					resultSchedulingPeriods.add(sp);</span>
<span class="fc" id="L464">				}</span>

<span class="fc" id="L466">				r.close();</span>
			}
<span class="pc bpc" id="L468" title="2 of 4 branches missed.">			if (eTimeFrame == SchedulingPeriod.FutureOnly || eTimeFrame == SchedulingPeriod.PastAndFuture) {</span>

				// query future scheduling periods
<span class="fc" id="L471">				String query = &quot;SELECT sp.sid, &quot; + &quot;   sp.id AS deid, &quot; + &quot;   parentspid, &quot; + &quot;   sp.name, &quot;</span>
						+ &quot;   sp.description, &quot; + &quot;   fromdate, &quot; + &quot;   todate, &quot; + &quot;   isskillbased, &quot; + &quot;   minphantoms, &quot;
						+ &quot;   maxphantoms, &quot; + &quot;   sp.alloweditingofar, &quot;
						+ &quot;   sp.ismanualarmode, &quot;
						+ &quot;   sp.isusingallemployees, &quot;
						+ &quot;   campaign.sid AS csid &quot; + &quot;FROM sp,campaign &quot;
						+ &quot;WHERE campaign.id = campaignid and campaign.sid = &quot; + idCampaign + &quot;   AND fromdate &gt;= '&quot;
<span class="fc" id="L478">						+ JdmoUtil.formatDBString(dtDate) + &quot;'ORDER BY fromdate ASC&quot;;</span>
<span class="fc" id="L479">				r = m_dmo.createRowset(query);</span>

				// Create scheduling period entities from result set
<span class="fc" id="L482">				i = 0;</span>
<span class="pc bpc" id="L483" title="1 of 4 branches missed.">				while (r.next() &amp;&amp; i++ &lt; nNumberToGet) {</span>
<span class="fc" id="L484">					SchedulingPeriod sp = getSchedulingPeriodFromRowset(r, null);</span>

<span class="pc bpc" id="L486" title="1 of 2 branches missed.">					if (!aIDs.contains(sp.getID())) {</span>
<span class="fc" id="L487">						resultSchedulingPeriods.add(sp);</span>
					}
<span class="fc" id="L489">				}</span>
			}
<span class="fc" id="L491">			return resultSchedulingPeriods;</span>

<span class="nc" id="L493">		} catch (JdmoException e) {</span>
<span class="nc" id="L494">			e.printStackTrace();</span>
<span class="nc" id="L495">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L497">			try {</span>
<span class="pc" id="L498">				r.close();</span>
<span class="nc" id="L499">			} catch (Exception e) {</span>
<span class="pc" id="L500">			}</span>
<span class="pc" id="L501">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * Creates a SchedulingPeriod object from the information in the current row of
	 * the given JdmoRowset.  If a TimeZone object is passed as well, the scheduling
	 * period will have its Start/End local times set as well.
	 * @param rowSet - The current record will be used to create the object
	 * @param tz - (optional) If non-null, will set the start/end local time fields on the returned object.
	 * @return A SchedulingPeriod value object that is set with the values in the current record in JdmoRowset.
	 */
	SchedulingPeriod getSchedulingPeriodFromRowset(JdmoRowset rowSet, TimeZone tz) throws JdmoException, BbmFinderException {
<span class="fc" id="L514">		ID deid = ID.fromString(rowSet.getString(&quot;DEID&quot;));</span>
<span class="fc" id="L515">		ID idSP = rowSet.getID(&quot;SID&quot;);</span>
<span class="fc" id="L516">		ID idCampaign = rowSet.getID(&quot;CSID&quot;);</span>
<span class="fc" id="L517">		Date dtStart = rowSet.getTimestamp(&quot;FROMDATE&quot;);</span>
<span class="fc" id="L518">		Date dtEnd = rowSet.getTimestamp(&quot;TODATE&quot;);</span>
<span class="fc" id="L519">		boolean bSkillBased = rowSet.getBoolean(&quot;ISSKILLBASED&quot;);</span>
<span class="fc" id="L520">		String strName = rowSet.getString(&quot;NAME&quot;);</span>
<span class="fc" id="L521">		String strDesc = rowSet.getString(&quot;DESCRIPTION&quot;);</span>
<span class="fc" id="L522">		int minPhantoms = rowSet.getInt(&quot;MINPHANTOMS&quot;);</span>
<span class="fc" id="L523">		int maxPhantoms = rowSet.getInt(&quot;MAXPHANTOMS&quot;);</span>
<span class="fc" id="L524">		ID parentSPID = rowSet.getID(&quot;PARENTSPID&quot;);</span>
<span class="fc" id="L525">		boolean allowEditingOfAR = rowSet.getBoolean(&quot;ALLOWEDITINGOFAR&quot;);</span>
<span class="fc" id="L526">		boolean isManualARMode = rowSet.getBoolean(&quot;ISMANUALARMODE&quot;);</span>
<span class="fc" id="L527">		boolean isUsingAllEmployees = rowSet.getBoolean(&quot;ISUSINGALLEMPLOYEES&quot;);</span>

<span class="fc" id="L529">		SchedulingPeriod sp = new SchedulingPeriod();</span>
<span class="fc" id="L530">		sp.setDEID(deid);</span>
<span class="fc" id="L531">		sp.setID(idSP);</span>
<span class="fc" id="L532">		sp.setStartTime(dtStart);</span>
<span class="fc" id="L533">		sp.setEndTime(dtEnd);</span>
<span class="fc" id="L534">		sp.setCampaignID(idCampaign);</span>
<span class="fc" id="L535">		sp.setSkillBased(bSkillBased);</span>
<span class="fc" id="L536">		sp.setName(strName);</span>
<span class="fc" id="L537">		sp.setDescription(strDesc);</span>
<span class="fc" id="L538">		sp.setMinPhantoms(minPhantoms);</span>
<span class="fc" id="L539">		sp.setMaxPhantoms(maxPhantoms);</span>
<span class="fc" id="L540">		sp.setParentSPID(parentSPID);</span>
<span class="fc" id="L541">		sp.setIsEditingOfFteRequirementsAllowed(allowEditingOfAR);</span>
<span class="fc" id="L542">		sp.setManualFteRequirementsMode(isManualARMode);</span>
<span class="fc" id="L543">		sp.setUsingAllEmployees(isUsingAllEmployees);</span>

<span class="fc bfc" id="L545" title="All 2 branches covered.">		if (tz != null) {</span>
<span class="fc" id="L546">			sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), tz));</span>
<span class="fc" id="L547">			sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), tz));</span>
		}

<span class="fc" id="L550">		return sp;</span>
	}

	/**
	 * Returns the scheduling period for the given scheduling period ID. Returns
	 * null if no scheduling period with the given ID was found.
	 */
	public SchedulingPeriod getSchedulingPeriodByID(ID spSID) throws BbmFinderException, BbmObjectNotFoundException {
<span class="fc" id="L558">		Collection&lt;SchedulingPeriod&gt; sps = getSchedulingPeriodsByIDs(Collections.singleton(spSID));</span>
<span class="pc bpc" id="L559" title="2 of 4 branches missed.">		if (sps != null &amp;&amp; sps.isEmpty() == false) {</span>
<span class="fc" id="L560">			return sps.iterator().next();</span>
		}
<span class="nc" id="L562">		return null;</span>
	}

	/**
	 * Returns a collection of scheduling periods for the given scheduling
	 * period IDs. Returns an empty collection if no scheduling periods were
	 * found with any of the given IDs.
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByIDs(Collection&lt;ID&gt; spIDs) throws BbmFinderException {
		// load sp, but local time not set yet
<span class="fc" id="L572">		Collection&lt;SchedulingPeriod&gt; sps = getObjectsByIDs(spIDs);</span>
<span class="fc" id="L573">		Collection&lt;ID&gt; campaignDEIDs = ValueObjectUtil.getFieldObjectCol(SchedulingPeriodFieldInfo.SP_CAMPAIGNID, sps);</span>

		// Set the SID of the campaign on each SP value object (replacing the
		// campaign DEID, which should
		// be hidden from client code).
<span class="fc" id="L578">		Map&lt;ID, ID&gt; campaignDEIDToSIDMap = DAOUtil.mapIDsToSIDs(campaignDEIDs, new CampaignFieldInfo());</span>
<span class="fc bfc" id="L579" title="All 2 branches covered.">		for (SchedulingPeriod sp : sps) {</span>
<span class="fc" id="L580">			sp.setCampaignID(campaignDEIDToSIDMap.get(sp.getCampaignID()));</span>
<span class="fc" id="L581">		}</span>

		// retrieve time zone, in order to calculate local time
<span class="fc" id="L584">		CampaignDAO dao = new CampaignDAO(getDMO());</span>

<span class="fc" id="L586">		Map&lt;ID, TimeZone&gt; tzMap = dao.getTimeZonesByCampaignIDs(ValueObjectUtil.getFieldObjectCol(</span>
				SchedulingPeriodFieldInfo.SP_CAMPAIGNID, sps));

		// set local time on each SP
<span class="fc bfc" id="L590" title="All 2 branches covered.">		for (SchedulingPeriod sp : sps) {</span>
<span class="fc" id="L591">			TimeZone tz = tzMap.get(sp.getCampaignID());</span>
<span class="fc" id="L592">			sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), tz));</span>
<span class="fc" id="L593">			sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), tz));</span>
<span class="fc" id="L594">		}</span>

<span class="fc" id="L596">		return sps;</span>
	}

	/**
	 * Returns the scheduling periods associated to the given SPQueues. The
	 * returned value is a map of scheduling period -&gt; collection of SP Queues
	 * belonging to the scheduling period.
	 *
	 * @param spQueues
	 *            - the SPQueues for which we would like to retrieve their
	 *            associated scheduling periods.
	 * @return Map of scheduling period -&gt; collection of associated SPQueues
	 */
	public Map&lt;SchedulingPeriod, Collection&lt;SPQueue&gt;&gt; getSchedulingPeriodsForSPQueues(Collection&lt;SPQueue&gt; spQueues)
			throws BbmFinderException {
<span class="fc" id="L611">		Map&lt;SchedulingPeriod, Collection&lt;SPQueue&gt;&gt; retVal = new HashMap&lt;SchedulingPeriod, Collection&lt;SPQueue&gt;&gt;();</span>
<span class="fc" id="L612">		HashSet&lt;ID&gt; spIDs = new HashSet&lt;ID&gt;(ValueObjectUtil.getFieldObjectCol(SPQueueFieldInfo.SPQUEUE_SPID, spQueues));</span>
<span class="fc" id="L613">		Collection&lt;SchedulingPeriod&gt; sps = getSchedulingPeriodsByIDs(spIDs);</span>
<span class="fc" id="L614">		Map&lt;ID, SchedulingPeriod&gt; spIDMap = ValueObjectUtil.getIDObjectMap(sps);</span>
<span class="fc bfc" id="L615" title="All 2 branches covered.">		for (SPQueue spQueue : spQueues) {</span>
<span class="fc bfc" id="L616" title="All 2 branches covered.">			if (retVal.containsKey(spIDMap.get(spQueue.getSpID())) == false) {</span>
<span class="fc" id="L617">				retVal.put(spIDMap.get(spQueue.getSpID()), new ArrayList&lt;SPQueue&gt;());</span>
			}
<span class="fc" id="L619">			retVal.get(spIDMap.get(spQueue.getSpID())).add(spQueue);</span>
<span class="fc" id="L620">		}</span>
<span class="fc" id="L621">		return retVal;</span>
	}

	public void linkWorkResourcesToSchedulingPeriod(ID spID, Collection&lt;ID&gt; wkrsIDs) throws BbmCreateException {
		try {
<span class="pc bpc" id="L626" title="2 of 4 branches missed.">			if (wkrsIDs == null || wkrsIDs.isEmpty()) {</span>
<span class="nc" id="L627">				return;</span>
			}
<span class="fc" id="L629">			ID id = null;</span>
<span class="fc" id="L630">			HashMap&lt;String, Object&gt; nameValues = new HashMap&lt;String, Object&gt;();</span>
<span class="fc bfc" id="L631" title="All 2 branches covered.">			for (Iterator&lt;ID&gt; i = wkrsIDs.iterator(); i.hasNext();) {</span>
<span class="fc" id="L632">				id = i.next();</span>
<span class="fc" id="L633">				nameValues.clear();</span>
<span class="fc" id="L634">				nameValues.put(&quot;SPID&quot;, spID.toString());</span>
<span class="fc" id="L635">				nameValues.put(&quot;WORKRESOURCEID&quot;, id);</span>
<span class="fc" id="L636">				m_dmo.addBatchInsert(&quot;SPWORKRESOURCE&quot;, nameValues);</span>
			}
<span class="fc" id="L638">			m_dmo.executeBatch();</span>
<span class="fc" id="L639">		} catch (JdmoException e) {</span>
<span class="fc" id="L640">			throw new BbmCreateException(e);</span>
<span class="fc" id="L641">		}</span>

<span class="fc" id="L643">	}</span>

	public ID getParentSchedulingPeriodID(ID subSPID) throws BbmFinderException {
<span class="fc" id="L646">		JdmoRowset r = null;</span>
		try {
<span class="fc" id="L648">			String query = &quot;SELECT SID FROM SP WHERE ID in (SELECT PARENTSPID FROM SP WHERE SID = &quot; + subSPID + &quot;)&quot;;</span>
<span class="fc" id="L649">			r = m_dmo.createRowset(query);</span>

<span class="fc bfc" id="L651" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L652">				return r.getID(&quot;SID&quot;);</span>
			}
<span class="fc" id="L654">			return null;</span>
<span class="nc" id="L655">		} catch (JdmoException e) {</span>
<span class="nc" id="L656">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L658">			try {</span>
<span class="pc" id="L659">				r.close();</span>
<span class="nc" id="L660">			} catch (Exception e) {</span>
<span class="pc" id="L661">			}</span>
		}
	}

	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(Campaign campaign) throws BbmFinderException {

		try {
<span class="fc" id="L668">			List&lt;Campaign&gt; campaigns = new ArrayList&lt;Campaign&gt;();</span>
<span class="fc" id="L669">			campaigns.add(campaign);</span>
<span class="fc" id="L670">			return getSchedulingPeriods(campaigns);</span>
<span class="nc" id="L671">		} catch (Exception e) {</span>
<span class="nc" id="L672">			throw new BbmFinderException(e);</span>
		}
	}

	/**
	 * Returns a Collection of SchedulingPeriods belonging to the input
	 * collection of Campaigns
	 *
	 * @param campaigns
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(Collection&lt;Campaign&gt; campaigns) throws BbmFinderException {

<span class="pc bpc" id="L686" title="2 of 4 branches missed.">		if (campaigns == null || campaigns.size() == 0) {</span>
<span class="nc" id="L687">			return new ArrayList&lt;SchedulingPeriod&gt;();</span>
		}
<span class="fc" id="L689">		Collection&lt;ID&gt; campaignIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L690" title="All 2 branches covered.">		for (Campaign campaign : campaigns) {</span>
<span class="fc" id="L691">			campaignIDs.add(campaign.getID());</span>
<span class="fc" id="L692">		}</span>

<span class="fc" id="L694">		return getSchedulingPeriodsByCampaignIDs(campaignIDs, campaigns);</span>
	}

	/**
	 * @deprecated instead @see getSchedulingPeriodsByCampaignIDs(Collection&lt;ID&gt;
	 *             campaignIDs,Date minDate, Date maxDate) Returns a Collection
	 *             of SchedulingPeriods belonging to the input collection of
	 *             Campaigns
	 *
	 * @param campaignIDs
	 *            the campaigns whose scheduling periods are to be loaded
	 * @param campaigns
	 *            can be empty, although startTimeLocal, endTimeLocal will not
	 *            be set
	 * @return
	 * @throws BbmFinderException
	 */
	@Deprecated
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByCampaignIDs(Collection&lt;ID&gt; campaignIDs,
			Collection&lt;Campaign&gt; campaigns) throws BbmFinderException {
		try {
<span class="fc" id="L715">			ArrayList&lt;SchedulingPeriod&gt; sps = new ArrayList&lt;SchedulingPeriod&gt;();</span>

<span class="fc" id="L717">			StringBuffer sb = new StringBuffer(100);</span>
<span class="fc" id="L718">			sb.append(&quot;SELECT sp.sid AS ID, campaign.sid AS CAMPAIGNID, sp.fromdate AS FROMDATE, sp.todate AS TODATE, sp.ISSKILLBASED, sp.ISMANUALARMODE, sp.isusingallemployees, sp.id AS deid &quot;);</span>
<span class="fc" id="L719">			sb.append(&quot;FROM sp, campaign WHERE sp.campaignid = campaign.id AND campaign.sid in &quot;);</span>
<span class="fc" id="L720">			sb.append(m_dmo.createInClause(campaignIDs));</span>

<span class="fc" id="L722">			JdmoRowset rs = m_dmo.createRowset(sb.toString());</span>
<span class="fc bfc" id="L723" title="All 2 branches covered.">			while (rs.next()) {</span>
<span class="fc" id="L724">				SchedulingPeriod sp = new SchedulingPeriod();</span>
<span class="fc" id="L725">				sp.setID(rs.getID(1));</span>
<span class="fc" id="L726">				sp.setCampaignID(rs.getID(2));</span>
<span class="fc" id="L727">				sp.setStartTime(rs.getTimestamp(3));</span>
<span class="fc" id="L728">				sp.setEndTime(rs.getTimestamp(4));</span>
<span class="fc" id="L729">				sp.setSkillBased(rs.getBoolean(5));</span>
<span class="fc" id="L730">				Campaign campaign = getCampaignByID(campaigns, sp.getCampaignID());</span>

<span class="pc bpc" id="L732" title="1 of 2 branches missed.">				if (campaign != null) {</span>
<span class="fc" id="L733">					TimeZone tz = campaign.getTimeZone();</span>
<span class="fc" id="L734">					sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), tz));</span>
<span class="fc" id="L735">					sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), tz));</span>
				}
<span class="fc" id="L737">				sp.setManualFteRequirementsMode(rs.getBoolean(6));</span>
<span class="fc" id="L738">				sp.setUsingAllEmployees(rs.getBoolean(7));</span>
<span class="fc" id="L739">				sp.setDEID(ID.fromString(rs.getString(8)));</span>
<span class="fc" id="L740">				sps.add(sp);</span>
<span class="fc" id="L741">			}</span>
<span class="fc" id="L742">			return sps;</span>
<span class="nc" id="L743">		} catch (Exception e) {</span>
<span class="nc" id="L744">			throw new BbmFinderException(e);</span>
		}
	}

	/**
	 * @returns the campaigns' associated scheduling periods that fall within
	 *          the date range
	 * @throws BbmFinderException
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByCampaignIDs(Collection&lt;ID&gt; campaignIDs, Date minDate,
			Date maxDate) throws BbmFinderException {
<span class="nc" id="L755">		ArrayList&lt;SchedulingPeriod&gt; sps = new ArrayList&lt;SchedulingPeriod&gt;();</span>
<span class="nc" id="L756">		JdmoRowset rs = null;</span>
		try {
<span class="nc" id="L758">			String query = &quot;SELECT c.sid AS c_sid, sp.sid AS sp_sid, sp.fromdate AS FROMDATE, sp.todate AS TODATE, sp.ISSKILLBASED, tzmap.javatzident, sp.ISMANUALARMODE, sp.isusingallemployees, sp.id AS sp_deid \n&quot;</span>
					+ &quot;FROM campaign c \n&quot;
					+ &quot;INNER JOIN sp sp \n&quot;
					+ &quot;	ON sp.campaignid = c.id \n&quot;
					+ &quot;	AND sp.fromdate &lt;= '&quot;
<span class="nc" id="L763">					+ JdmoUtil.formatDBString(maxDate)</span>
					+ &quot;' \n&quot;
					+ &quot;	AND sp.todate &gt;= '&quot;
<span class="nc" id="L766">					+ JdmoUtil.formatDBString(minDate)</span>
					+ &quot;' \n&quot;
					+ &quot;LEFT JOIN TIMEZONE tz \n&quot;
					+ &quot;	on tz.ID = c.TIMEZONEID \n&quot;
					+ &quot;LEFT JOIN TIMEZONEMAP tzmap \n&quot;
<span class="nc" id="L771">					+ &quot;	on tzmap.WINTZSTDNAME = tz.STANDARDNAME \n&quot; + &quot;WHERE c.sid IN &quot; + m_dmo.createInClause(campaignIDs);</span>
<span class="nc" id="L772">			rs = m_dmo.createRowset(query);</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L774">				SchedulingPeriod sp = new SchedulingPeriod();</span>
<span class="nc" id="L775">				sp.setCampaignID(rs.getID(1));</span>
<span class="nc" id="L776">				sp.setID(rs.getID(2));</span>
<span class="nc" id="L777">				sp.setStartTime(rs.getTimestamp(3));</span>
<span class="nc" id="L778">				sp.setEndTime(rs.getTimestamp(4));</span>
<span class="nc" id="L779">				sp.setSkillBased(rs.getBoolean(5));</span>
<span class="nc" id="L780">				String timeZoneID = rs.getString(6);</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">				if (timeZoneID != null) {</span>
<span class="nc" id="L782">					TimeZone timeZone = TimeZone.getTimeZone(timeZoneID);</span>
<span class="nc" id="L783">					sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), timeZone));</span>
<span class="nc" id="L784">					sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), timeZone));</span>
				}
<span class="nc" id="L786">				sp.setManualFteRequirementsMode(rs.getBoolean(7));</span>
<span class="nc" id="L787">				sp.setUsingAllEmployees(rs.getBoolean(8));</span>
<span class="nc" id="L788">				sp.setDEID(ID.fromString(rs.getString(9)));</span>
<span class="nc" id="L789">				sps.add(sp);</span>
<span class="nc" id="L790">			}</span>
<span class="nc" id="L791">			return sps;</span>
<span class="nc" id="L792">		} catch (Exception e) {</span>
<span class="nc" id="L793">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L795">			try {</span>
<span class="nc" id="L796">				rs.close();</span>
<span class="nc" id="L797">			} catch (Exception e) {</span>
<span class="nc" id="L798">			}</span>
<span class="nc" id="L799">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * @param campaignIDs
	 *            the campaign IDs whose scheduling periods counts we want to
	 *            know
	 * @return A map from campaign's SID to the count of scheduling periods
	 *         attached to it
	 * @throws BbmFinderException
	 */
	public Map&lt;ID, Integer&gt; getCampaignIDAttachedSchedulingPeriodCountMap(Collection&lt;ID&gt; campaignIDs)
			throws BbmFinderException {

<span class="fc" id="L814">		Map&lt;ID, Integer&gt; campaignIDAttachedSchedulingPeriodCountMap = new HashMap&lt;ID, Integer&gt;();</span>

		// Build the query, noting that case statement is needed so that
		// campaigns with no sps aren't counted as having one by mistake.
		String query;
		try {
<span class="fc" id="L820">			query = &quot;SELECT c.sid, SUM(CASE WHEN sp.ID is not null THEN 1 ELSE 0 END) AS schedulingPeriodCount \n&quot;</span>
					+ &quot;FROM campaign c \n&quot; + &quot;LEFT JOIN sp sp \n&quot; + &quot;  ON sp.campaignid = c.id \n&quot; + &quot;WHERE c.sid in &quot;
<span class="fc" id="L822">					+ m_dmo.createInClause(campaignIDs) + &quot;GROUP BY c.sid&quot;;</span>
<span class="nc" id="L823">		} catch (JdmoException e) {</span>
<span class="nc" id="L824">			throw new BbmFinderException(e);</span>
<span class="fc" id="L825">		}</span>

		// Execute the query, converting the result set to a map
<span class="fc" id="L828">		JdmoRowset rs = null;</span>
		try {
<span class="fc" id="L830">			rs = m_dmo.createRowset(query);</span>
<span class="fc bfc" id="L831" title="All 2 branches covered.">			while (rs.next()) {</span>
<span class="fc" id="L832">				ID campaignSID = rs.getID(&quot;sid&quot;);</span>
<span class="fc" id="L833">				Integer schedulingPeriodCount = rs.getInt(&quot;schedulingPeriodCount&quot;);</span>
<span class="fc" id="L834">				campaignIDAttachedSchedulingPeriodCountMap.put(campaignSID, schedulingPeriodCount);</span>
<span class="fc" id="L835">			}</span>
<span class="nc" id="L836">		} catch (JdmoException e) {</span>
<span class="nc" id="L837">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L839">			try {</span>
<span class="pc bpc" id="L840" title="3 of 4 branches missed.">				if (rs != null) {</span>
<span class="pc" id="L841">					rs.close();</span>
				}
<span class="nc" id="L843">			} catch (Exception e) {</span>
<span class="pc" id="L844">			}</span>
<span class="nc" id="L845">		}</span>
<span class="fc" id="L846">		return campaignIDAttachedSchedulingPeriodCountMap;</span>
	}

	/**
	 * @Deprecated not safe when white space is in the ID see getCampaignByID
	 * @param campaigns
	 * @param campaignID
	 * @return
	 */
	@Deprecated
	private Campaign getCampaignFromCollection(Collection&lt;Campaign&gt; campaigns, ID campaignID) {
<span class="nc bnc" id="L857" title="All 2 branches missed.">		for (Campaign campaign : campaigns) {</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">			if (campaign.getID().equals(campaignID)) {</span>
<span class="nc" id="L859">				return campaign;</span>
			}
<span class="nc" id="L861">		}</span>
<span class="nc" id="L862">		return null;</span>
	}

	private Campaign getCampaignByID(Collection&lt;Campaign&gt; campaigns, ID campaignID) {
<span class="pc bpc" id="L866" title="1 of 2 branches missed.">		for (Campaign campaign : campaigns) {</span>
<span class="fc bfc" id="L867" title="All 2 branches covered.">			if (campaign.getID().toString().trim().equals(campaignID.toString().trim())) {</span>
<span class="fc" id="L868">				return campaign;</span>
			}
<span class="fc" id="L870">		}</span>
<span class="nc" id="L871">		return null;</span>
	}

	public void linkOrgsToSP(ID parentSPID, ID SPID, Collection&lt;ID&gt; colOrgIDs) throws BbmCreateException {
<span class="fc" id="L875">		Jdmo jdmo = new Jdmo();</span>
		try {
			// check if orgs are already linked to other subcampaign
<span class="fc bfc" id="L878" title="All 2 branches covered.">			if (parentSPID != null) {</span>
<span class="fc" id="L879">				Collection&lt;ID&gt; ids = getSubSPIDs(parentSPID);</span>
<span class="fc bfc" id="L880" title="All 2 branches covered.">				for (ID subID : ids) {</span>
<span class="pc bpc" id="L881" title="1 of 4 branches missed.">					if (subID != null &amp;&amp; !subID.equals(SPID)) {</span>
<span class="fc" id="L882">						Collection&lt;ID&gt; orgs = getLinkedOrgsforSP(subID);</span>
<span class="fc bfc" id="L883" title="All 2 branches covered.">						for (ID subOrgID : orgs) {</span>
<span class="pc bpc" id="L884" title="1 of 2 branches missed.">							if (colOrgIDs.contains(subOrgID)) {</span>
<span class="nc" id="L885">								String orgName = null;</span>
<span class="nc" id="L886">								String queryOrg = &quot;select NAME from Organization where ID =&quot; + subOrgID;</span>
<span class="nc" id="L887">								JdmoRowset rowSet = m_dmo.createRowset(queryOrg);</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">								while (rowSet.next()) {</span>
<span class="nc" id="L889">									orgName = rowSet.getString(&quot;NAME&quot;);</span>
									break;
								}
<span class="nc bnc" id="L892" title="All 2 branches missed.">								if (orgName != null) {</span>
<span class="nc" id="L893">									Object[] args = new Object[1];</span>
<span class="nc" id="L894">									args[0] = orgName;</span>
<span class="nc" id="L895">									throw new BbmCreateException(BbmEjbBundleKey.BUNDLE_NAME,</span>
											BbmEjbBundleKey.INVALID_ORG_TO_SP_LINKING, args);
								}
							}
<span class="fc" id="L899">						}</span>
					}
<span class="fc" id="L901">				}</span>
			}

<span class="fc" id="L904">			Collection&lt;ID&gt; curOrgs = getLinkedOrgsforSP(SPID);</span>
<span class="fc" id="L905">			HashSet&lt;ID&gt; newOrgs = new HashSet&lt;ID&gt;();</span>
<span class="fc" id="L906">			HashSet&lt;ID&gt; deleteOrgs = new HashSet&lt;ID&gt;();</span>
<span class="fc bfc" id="L907" title="All 2 branches covered.">			for (ID id : curOrgs) {</span>
<span class="fc bfc" id="L908" title="All 2 branches covered.">				if (!colOrgIDs.contains(id)) {</span>
<span class="fc" id="L909">					deleteOrgs.add(id);</span>
				}
<span class="fc" id="L911">			}</span>
<span class="fc bfc" id="L912" title="All 2 branches covered.">			for (ID id : colOrgIDs) {</span>
<span class="fc bfc" id="L913" title="All 2 branches covered.">				if (!curOrgs.contains(id)) {</span>
<span class="fc" id="L914">					newOrgs.add(id);</span>
				}
<span class="fc" id="L916">			}</span>

			JdmoQuery jQuery;
<span class="fc" id="L919">			ID spDEID = getDEIDFromSID(&quot;SP&quot;, SPID);</span>

<span class="fc bfc" id="L921" title="All 2 branches covered.">			if (deleteOrgs.size() &gt; 0) {</span>
<span class="fc" id="L922">				jdmo.insertIDs(&quot;orgIdsTempTable&quot;, deleteOrgs);</span>
<span class="fc" id="L923">				jQuery = jdmo.createQuery(&quot;PTE_DELETE_ORGS_FROM_SP&quot;, Jdmo.STORPROC_QUERY_NORS);</span>
<span class="fc" id="L924">				jQuery.setParString(1, spDEID.toString()); // source start</span>
<span class="fc" id="L925">				jdmo.execute(jQuery);</span>
			}

<span class="fc bfc" id="L928" title="All 2 branches covered.">			for (ID orgID : newOrgs) {</span>
<span class="fc" id="L929">				linkOrgToSP(SPID, orgID);</span>
<span class="fc" id="L930">			}</span>

<span class="nc" id="L932">		} catch (JdmoException ex) {</span>
<span class="nc" id="L933">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L934">		} catch (BbmFinderException ex) {</span>
<span class="nc" id="L935">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L936">		} catch (BbmCreateException ex) {</span>
<span class="nc" id="L937">			throw ex;</span>
		} finally {
<span class="pc bpc" id="L939" title="3 of 4 branches missed.">			if (jdmo != null) {</span>
<span class="pc" id="L940">				jdmo.cleanUp();</span>
			}
		}
<span class="fc" id="L943">	}</span>

	private void linkOrgToSP(ID SPID, ID orgID) throws BbmCreateException {
<span class="fc" id="L946">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="fc" id="L948">			String idStr = DAOUtil.getDEID(jdmo);</span>
<span class="fc" id="L949">			ID spDEID = getDEIDFromSID(&quot;SP&quot;, SPID);</span>
<span class="fc" id="L950">			ID createdID = new ID(idStr);</span>
<span class="fc" id="L951">			String strCreate = &quot;INSERT into SPCALLCENTER (ID, ORGANIZATIONID, SPID) values ('&quot; + createdID + &quot;', '&quot; + orgID</span>
					+ &quot;', '&quot; + spDEID + &quot;')&quot;;
<span class="fc" id="L953">			jdmo.executeCommand(strCreate.toString());</span>
<span class="nc" id="L954">		} catch (JdmoException ex) {</span>
<span class="nc" id="L955">			throw new BbmCreateException(ex);</span>
		} finally {
<span class="pc bpc" id="L957" title="3 of 4 branches missed.">			if (jdmo != null) {</span>
<span class="pc" id="L958">				jdmo.cleanUp();</span>
			}
		}
<span class="fc" id="L961">	}</span>

	public Collection&lt;ID&gt; getLinkedOrgsforSP(ID SPID) throws BbmFinderException {

<span class="fc" id="L965">		List&lt;ID&gt; organizatonIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L966">		boolean isParentCampaign = false;</span>
<span class="fc" id="L967">		JdmoRowset r = null;</span>
		try {

			// Decide whether this is a parent of another scheduling period
<span class="fc" id="L971">			ID DEID = getDEIDFromSID(&quot;SP&quot;, SPID);</span>
<span class="fc" id="L972">			String queryParentSP = &quot;SELECT ID FROM SP WHERE PARENTSPID = '&quot; + DEID + &quot;'&quot;;</span>
<span class="fc" id="L973">			JdmoRowset rowSet = m_dmo.createRowset(queryParentSP);</span>
<span class="fc bfc" id="L974" title="All 2 branches covered.">			while (rowSet.next()) {</span>
<span class="fc" id="L975">				isParentCampaign = true;</span>
				break;
			}

			// Query for linked organizatons
<span class="fc" id="L980">			String query = &quot;SELECT ORGANIZATIONID FROM SPCALLCENTER WHERE SPID = '&quot; + DEID + &quot;'&quot;;</span>
			// it's possible it's a parent sp of an distributed campaign, this
			// query will return empty sets for
			// non-distributed and child sp.
<span class="fc bfc" id="L984" title="All 2 branches covered.">			if (isParentCampaign) {</span>
<span class="fc" id="L985">				query = &quot;SELECT ORGANIZATIONID FROM SPCALLCENTER WHERE SPID IN (SELECT ID FROM SP WHERE PARENTSPID = '&quot;</span>
						+ DEID + &quot;')&quot;;
			}

<span class="fc" id="L989">			r = m_dmo.createRowset(query);</span>

<span class="fc bfc" id="L991" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L992">				ID orgID = new ID(r.getString(&quot;ORGANIZATIONID&quot;));</span>
<span class="fc" id="L993">				organizatonIDs.add(orgID);</span>
<span class="fc" id="L994">			}</span>

<span class="fc" id="L996">			return organizatonIDs;</span>
<span class="nc" id="L997">		} catch (JdmoException e) {</span>
<span class="nc" id="L998">			e.printStackTrace();</span>
<span class="nc" id="L999">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1001">			try {</span>
<span class="pc" id="L1002">				r.close();</span>
<span class="nc" id="L1003">			} catch (Exception e) {</span>
<span class="pc" id="L1004">			}</span>
<span class="pc" id="L1005">			m_dmo.cleanUp();</span>
		}
	}

	public void unlinkWorkResourcesToSchedulingPeriod(ID SPID, ID SPDEID, Collection&lt;ID&gt; wkrsIDs) throws BbmRemoveException {
<span class="nc" id="L1010">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L1012" title="All 4 branches missed.">			if (wkrsIDs == null || wkrsIDs.isEmpty()) {</span>
<span class="nc" id="L1013">				return;</span>
			}
<span class="nc" id="L1015">			String strQuery = &quot;DELETE From SPWORKRESOURCE where SPID = '&quot; + SPDEID.toString() + &quot;' and WORKRESOURCEID in &quot;</span>
<span class="nc" id="L1016">					+ m_dmo.createInClause(wkrsIDs);</span>
<span class="nc" id="L1017">			jdmo.executeCommand(strQuery.toString());</span>

<span class="nc" id="L1019">			strQuery = &quot;update SHIFTASSIGNMENT set SPID = NULL where SPID = &quot; + SPID.toString() + &quot; and WORKRESOURCEID in &quot;</span>
<span class="nc" id="L1020">					+ m_dmo.createInClause(wkrsIDs);</span>
<span class="nc" id="L1021">			jdmo.executeCommand(strQuery.toString());</span>
<span class="nc" id="L1022">		} catch (JdmoException ex) {</span>
<span class="nc" id="L1023">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc bnc" id="L1025" title="All 6 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L1026">				jdmo.cleanUp();</span>
			}
		}

<span class="nc" id="L1030">	}</span>

	public void unlinkShiftAssignmentToSP(ID workresourceId, Date orgChangeDt) throws BbmRemoveException {
<span class="nc" id="L1033">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L1035" title="All 2 branches missed.">			if (workresourceId == null) {</span>
<span class="nc" id="L1036">				return;</span>
			}

<span class="nc" id="L1039">			String strQuery = &quot;update SHIFTASSIGNMENT &quot; + &quot; set SPID = NULL where &quot; + &quot; WORKRESOURCEID = &quot;</span>
<span class="nc" id="L1040">					+ workresourceId.toInt() + &quot; AND SPID IN (SELECT SID FROM SP WHERE FROMDATE &gt;= '&quot;</span>
<span class="nc" id="L1041">					+ JdmoUtil.formatDBString(orgChangeDt) + &quot;')&quot;;</span>

<span class="nc" id="L1043">			jdmo.executeCommand(strQuery.toString());</span>
<span class="nc" id="L1044">		} catch (JdmoException ex) {</span>
<span class="nc" id="L1045">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc bnc" id="L1047" title="All 6 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L1048">				jdmo.cleanUp();</span>
			}
		}

<span class="nc" id="L1052">	}</span>

	public ID CloneSP(TimeZone tz, SchedulingPeriod newSP, Collection&lt;CampaignHOO&gt; spHOOs, CloneSPOptions copyFlags,
			boolean bIgnoreWarnings) throws JdmoException, BbmCloningConflictException, BbmFinderException {
<span class="fc" id="L1056">		ID idTargetSP = null;</span>
		try {
<span class="fc" id="L1058">			Date startGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(newSP.getStartTimeLocal(), tz);</span>
<span class="fc" id="L1059">			Date endGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(newSP.getEndTimeLocal(), tz);</span>
<span class="fc" id="L1060">			newSP.setStartTime(startGMTDt);</span>
<span class="fc" id="L1061">			newSP.setEndTime(endGMTDt);</span>

<span class="fc" id="L1063">			List&lt;ID&gt; copyFromSPIDs = new ArrayList&lt;ID&gt;();</span>
<span class="fc" id="L1064">			int i = 0;</span>
<span class="fc bfc" id="L1065" title="All 2 branches covered.">			for (CampaignHOO spHOO : spHOOs) {</span>
<span class="fc" id="L1066">				copyFromSPIDs.add(i++, spHOO.getSPID());</span>
<span class="fc" id="L1067">			}</span>
<span class="fc" id="L1068">			int numWeeks = i;</span>
<span class="fc bfc" id="L1069" title="All 2 branches covered.">			boolean bMultiWeek = numWeeks &gt; 1;</span>
<span class="fc" id="L1070">			List&lt;BbmCloningConflict&gt; conflicts = new ArrayList&lt;BbmCloningConflict&gt;();</span>
			BbmCloningConflict conflict;
<span class="fc" id="L1072">			conflict = CheckQueuesInOtherCampaignShowStopper(copyFromSPIDs, startGMTDt, endGMTDt);</span>
<span class="pc bpc" id="L1073" title="1 of 2 branches missed.">			if (conflict != null) {</span>
<span class="nc" id="L1074">				conflicts.add(conflict);</span>
			}
<span class="fc bfc" id="L1076" title="All 2 branches covered.">			if (bMultiWeek) {</span>
<span class="fc" id="L1077">				conflict = CheckOrgsMatchShowStopper(copyFromSPIDs);</span>
<span class="pc bpc" id="L1078" title="1 of 2 branches missed.">				if (conflict != null) {</span>
<span class="nc" id="L1079">					conflicts.add(conflict);</span>
				}
<span class="fc" id="L1081">				conflict = CheckQueuesMatchShowStopper(copyFromSPIDs);</span>
<span class="pc bpc" id="L1082" title="1 of 2 branches missed.">				if (conflict != null) {</span>
<span class="nc" id="L1083">					conflicts.add(conflict);</span>
				}
<span class="fc" id="L1085">				conflict = CheckAllSkillBasedSameWarning(copyFromSPIDs);</span>
<span class="pc bpc" id="L1086" title="1 of 2 branches missed.">				if (conflict != null) {</span>
<span class="nc" id="L1087">					conflicts.add(conflict);</span>
				}

			}
			// if show stopper conflicts exist we skip the warning ones.
<span class="pc bpc" id="L1092" title="2 of 4 branches missed.">			if (conflicts.isEmpty() &amp;&amp; !bIgnoreWarnings) {</span>
<span class="fc" id="L1093">				conflict = CheckShiftAssignmentsExistWarning(copyFromSPIDs, numWeeks, startGMTDt, endGMTDt);</span>

<span class="pc bpc" id="L1095" title="1 of 2 branches missed.">				if (conflict != null) {</span>
<span class="nc" id="L1096">					conflicts.add(conflict);</span>
				}
			}
<span class="pc bpc" id="L1099" title="2 of 4 branches missed.">			if (conflicts != null &amp;&amp; !conflicts.isEmpty()) {</span>
<span class="nc" id="L1100">				BbmCloningConflictException ex = new BbmCloningConflictException(conflicts);</span>
<span class="nc" id="L1101">				throw ex;</span>
			}
<span class="fc" id="L1103">			boolean first = true;</span>
			ID newSPDEID;

<span class="fc" id="L1106">			LocalDate startLD = new LocalDate(newSP.getEndTimeLocal());</span>
<span class="fc" id="L1107">			LocalDate endLD = new LocalDate(newSP.getEndTimeLocal());</span>

<span class="fc" id="L1109">			Calendar currentDate = Calendar.getInstance(tz);</span>
<span class="fc" id="L1110">			currentDate.setTime(newSP.getEndTime());</span>

<span class="fc" id="L1112">			ArrayList&lt;CampaignHOO&gt; al = new ArrayList&lt;CampaignHOO&gt;(spHOOs);</span>
<span class="fc" id="L1113">			ListIterator&lt;CampaignHOO&gt; litr = al.listIterator(al.size());</span>
<span class="fc" id="L1114">			Campaign campaign = new CampaignDAO(getDMO()).getCampaignByID(newSP.getCampaignID(), false);</span>
<span class="fc bfc" id="L1115" title="All 2 branches covered.">			while (litr.hasPrevious()) {</span>
<span class="fc" id="L1116">				CampaignHOO spHOO = litr.previous();</span>
<span class="fc" id="L1117">				endLD = new LocalDate(startLD);</span>
<span class="pc bpc" id="L1118" title="1 of 2 branches missed.">				if (campaign.isMonthly()) {</span>
					// some weeks of monthly SPs may have less than 7 days
<span class="nc" id="L1120">					int numOfDaysToStartWeek = MonthlySPUtil.getNumOfDaysToWeekStartDate(tz, currentDate.getTime(),</span>
<span class="nc" id="L1121">							MonthlySPUtil.getWeekStartDay(campaign.getWeekStart()), startGMTDt);</span>
<span class="nc" id="L1122">					currentDate.add(Calendar.DATE, - numOfDaysToStartWeek);</span>
<span class="nc" id="L1123">					startLD.add(Calendar.DATE, - numOfDaysToStartWeek);</span>
<span class="nc" id="L1124">				} else {</span>
<span class="fc" id="L1125">					startLD.add(Calendar.DATE, -7);</span>
				}
<span class="fc" id="L1127">				newSPDEID = cloneWeek(newSP.getCampaignID(), spHOO, newSP, copyFlags, tz, startLD, endLD);</span>
<span class="fc bfc" id="L1128" title="All 2 branches covered.">				if (first) {</span>
<span class="fc" id="L1129">					first = false;</span>
<span class="fc" id="L1130">					newSP.setDEID(newSPDEID);</span>
				}
<span class="fc" id="L1132">				endLD = startLD;</span>
<span class="fc" id="L1133">			}</span>
<span class="fc" id="L1134">			idTargetSP = getSIDFromDEID(&quot;SP&quot;, newSP.getDEID());</span>
		} finally {
<span class="pc" id="L1136">			m_dmo.cleanUp();</span>
<span class="fc" id="L1137">		}</span>
<span class="fc" id="L1138">		return idTargetSP;</span>
	}

	private int DSTTransitionPeriod(Date startDt, Date endDt, TimeZone tz) {
		// 0-none,1-ends(extrahour),2-begins(lesshour)
<span class="fc" id="L1143">		int DSTFlag = 0;</span>
<span class="pc bpc" id="L1144" title="1 of 2 branches missed.">		if (tz.inDaylightTime(startDt) != tz.inDaylightTime(endDt)) {</span>

<span class="nc bnc" id="L1146" title="All 2 branches missed.">			if (tz.inDaylightTime(endDt)) {</span>
<span class="nc" id="L1147">				DSTFlag = 2;</span>
			} else {
<span class="nc" id="L1149">				DSTFlag = 1;</span>
			}
		}
<span class="fc" id="L1152">		return DSTFlag;</span>
	}

	private boolean isDateBeginDSTTransition(Date startDt, TimeZone tz) {
<span class="nc" id="L1156">		Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L1157">		cal.setTime(startDt);</span>
<span class="nc" id="L1158">		cal.add(Calendar.HOUR_OF_DAY, -1);</span>
<span class="nc" id="L1159">		Date nextStartDt = cal.getTime();</span>
<span class="nc bnc" id="L1160" title="All 2 branches missed.">		if (tz.inDaylightTime(nextStartDt) != tz.inDaylightTime(startDt)) {</span>
<span class="nc" id="L1161">			return true;</span>
		}

<span class="nc" id="L1164">		return false;</span>
	}

	private Date getDSTTransitionDateTime(Date startDt, Date endDt, TimeZone tz) {
<span class="nc" id="L1168">		Date DSTGMTdt = new Date();</span>
<span class="nc" id="L1169">		DSTGMTdt = endDt;</span>
		Date nextStartDt;
<span class="nc bnc" id="L1171" title="All 4 branches missed.">		while (startDt.before(endDt) || startDt.equals(endDt)) {</span>
<span class="nc" id="L1172">			nextStartDt = addHour(startDt, 1);</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">			if (tz.inDaylightTime(nextStartDt) != tz.inDaylightTime(startDt)) {</span>
<span class="nc" id="L1174">				DSTGMTdt = addHour(startDt, 1);</span>
<span class="nc" id="L1175">				break;</span>
			}
<span class="nc" id="L1177">			startDt = nextStartDt;</span>
		}
<span class="nc" id="L1179">		return DSTGMTdt;</span>
	}

	private Date addHour(Date aBPDate, int hours) {
<span class="nc" id="L1183">		TimeZone GMT_TIMEZONE = TimeZone.getTimeZone(&quot;GMT&quot;);</span>
<span class="nc" id="L1184">		Calendar aCalendar = new GregorianCalendar(GMT_TIMEZONE);</span>
<span class="nc" id="L1185">		aCalendar.setTime(aBPDate);</span>
<span class="nc" id="L1186">		aCalendar.add(Calendar.HOUR_OF_DAY, hours);</span>
<span class="nc" id="L1187">		Date aNewBPDate = aCalendar.getTime();</span>
<span class="nc" id="L1188">		return aNewBPDate;</span>
	}

	private ID cloneWeek(ID campaignID, CampaignHOO sourceSPHOO, SchedulingPeriod targetSP, CloneSPOptions copyFlags,
			TimeZone tz, LocalDate startLD, LocalDate endLD) throws JdmoException {
<span class="fc" id="L1193">		ID weekSPID = new ID();</span>
		JdmoQuery jQuery;
		try {
<span class="fc" id="L1196">			Date targetWeekStartGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(startLD, tz);</span>
<span class="fc" id="L1197">			Date targetWeekEndGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(endLD, tz);</span>
<span class="fc" id="L1198">			Date targetWeekStartDt = TimeZoneUtil.toDate(startLD);</span>
<span class="fc" id="L1199">			LocalDate sourceStartLD = new LocalDate(sourceSPHOO.getStartTime(), tz);</span>
<span class="fc" id="L1200">			LocalDate sourceEndLD = new LocalDate(sourceSPHOO.getEndTime(), tz);</span>
<span class="fc" id="L1201">			Date sourceWeekStartGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(sourceStartLD, tz);</span>
<span class="fc" id="L1202">			Date sourceWeekEndGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(sourceEndLD, tz);</span>
<span class="fc" id="L1203">			int nDSTFlag = SchedulingPeriod.NoDST;</span>
<span class="fc bfc" id="L1204" title="All 2 branches covered.">			int nCopyAssignments = (copyFlags.isCopyAssignments()) ? 1 : 0;</span>
<span class="pc bpc" id="L1205" title="1 of 2 branches missed.">			int nCopyProjectData = (copyFlags.isCopyProjectData()) ? 1 : 0;</span>

<span class="fc" id="L1207">			ID deSPID = new ID(getDEIDFromSID(&quot;SP&quot;, sourceSPHOO.getSPID()));</span>
			String sqlQry;
<span class="fc" id="L1209">			sqlQry = &quot;SELECT COUNT(*) NUMENT FROM SPQUEUEGOALSERIES WHERE SPQUEUEID IN (SELECT ID FROM SPQUEUE WHERE SPID = '&quot;</span>
<span class="fc" id="L1210">					+ deSPID.toString();</span>
<span class="fc" id="L1211">			sqlQry += &quot;' AND MEDIAID IS NOT NULL) GROUP BY SPQUEUEID&quot;;</span>
<span class="fc" id="L1212">			JdmoRowset r = m_dmo.createRowset(sqlQry);</span>
<span class="fc" id="L1213">			int srcDataPointsCount = 0;</span>
<span class="pc bpc" id="L1214" title="1 of 2 branches missed.">			if (r.next()) {</span>
<span class="fc" id="L1215">				srcDataPointsCount = r.getInt(&quot;NUMENT&quot;);</span>
			}
<span class="fc" id="L1217">			r.close();</span>

			// DST 0 - none, 1 - ends(extrahour), 2 - begins(lesshour)
<span class="fc" id="L1220">			int nSourceDSTFlag = 0;</span>
<span class="pc bpc" id="L1221" title="1 of 2 branches missed.">			if (srcDataPointsCount % 167 == 0) {</span>
<span class="nc" id="L1222">				nSourceDSTFlag = 2;// minus one source</span>
<span class="pc bpc" id="L1223" title="1 of 2 branches missed.">			} else if (srcDataPointsCount % 169 == 0)</span>
			 {
<span class="nc" id="L1225">				nSourceDSTFlag = 1;// extra one source)</span>
			}

<span class="fc" id="L1228">			int nTargetDSTFlag = DSTTransitionPeriod(targetWeekStartGMTDt, targetWeekEndGMTDt, tz);</span>
			// 1 - x source, 2 - x dest, 3 - x 1st dest, 4 - minus source, 5 -
			// minus dest, 6 - minus both, 7 - x both

<span class="pc bpc" id="L1232" title="3 of 4 branches missed.">			switch (nSourceDSTFlag) {</span>
			case 1:
<span class="nc" id="L1234">				nDSTFlag = SchedulingPeriod.SourceEndsDST;</span>
<span class="nc bnc" id="L1235" title="All 2 branches missed.">				if (nTargetDSTFlag == 1) {</span>
<span class="nc" id="L1236">					nDSTFlag = SchedulingPeriod.BothEndDST;</span>
				}
				break;
			case 2:
<span class="nc" id="L1240">				nDSTFlag = SchedulingPeriod.SourceBeginsDST;</span>
<span class="nc bnc" id="L1241" title="All 2 branches missed.">				if (nTargetDSTFlag == 2) {</span>
<span class="nc" id="L1242">					nDSTFlag = SchedulingPeriod.BothBeginDST;</span>
				}
				break;
			case 0:
<span class="pc bpc" id="L1246" title="1 of 2 branches missed.">				if (nTargetDSTFlag == 0) {</span>
<span class="fc" id="L1247">					nDSTFlag = SchedulingPeriod.NoDST;</span>
				}
<span class="pc bpc" id="L1249" title="1 of 2 branches missed.">				if (nTargetDSTFlag == 1) {</span>
<span class="nc" id="L1250">					nDSTFlag = SchedulingPeriod.TargetEndsDST;</span>
				}
<span class="pc bpc" id="L1252" title="1 of 2 branches missed.">				if (nTargetDSTFlag == 2) {</span>
<span class="nc" id="L1253">					nDSTFlag = SchedulingPeriod.TargetBeginsDST;</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">					if (isDateBeginDSTTransition(targetWeekStartDt, tz)) {</span>
<span class="nc" id="L1255">						nDSTFlag = SchedulingPeriod.Target1stPointBeginsDST;</span>
					}
				}
			}
<span class="fc" id="L1259">			Date DSTStartGMT = targetWeekStartGMTDt;</span>
<span class="pc bpc" id="L1260" title="3 of 4 branches missed.">			switch (nDSTFlag) {</span>
			case SchedulingPeriod.SourceEndsDST:
			case SchedulingPeriod.SourceBeginsDST:
<span class="nc" id="L1263">				DSTStartGMT = getDSTTransitionDateTime(sourceWeekStartGMTDt, sourceWeekEndGMTDt, tz);</span>
<span class="nc" id="L1264">				break;</span>
			case SchedulingPeriod.TargetEndsDST:
			case SchedulingPeriod.TargetBeginsDST:
<span class="nc" id="L1267">				DSTStartGMT = getDSTTransitionDateTime(targetWeekStartGMTDt, targetWeekEndGMTDt, tz);</span>
<span class="nc" id="L1268">				break;</span>
			case SchedulingPeriod.Target1stPointBeginsDST:
<span class="nc" id="L1270">				DSTStartGMT = targetWeekStartGMTDt;</span>
				break;
			}

<span class="fc" id="L1274">			String pStmt = &quot;CLONESP&quot;;</span>
<span class="fc" id="L1275">			jQuery = m_dmo.createQuery(pStmt.toString(), Jdmo.STORPROC_QUERY);</span>
<span class="fc" id="L1276">			jQuery.setParString(1, deSPID.toString()); // source sp ID</span>
<span class="fc" id="L1277">			jQuery.setParString(2, JdmoUtil.formatDBString(sourceSPHOO.getStartTime())); // source</span>
<span class="fc" id="L1278">			jQuery.setParString(3, JdmoUtil.formatDBString(sourceSPHOO.getEndTime())); // source</span>
																							// start
<span class="fc" id="L1280">			jQuery.setParString(4, targetSP.getName()); // target name</span>
<span class="fc" id="L1281">			jQuery.setParString(5, JdmoUtil.formatDBString(targetSP.getStartTime())); // target</span>
																						// sp
																						// start
<span class="fc" id="L1284">			jQuery.setParString(6, JdmoUtil.formatDBString(targetSP.getEndTime())); // target</span>
																					// sp
																					// end
<span class="fc" id="L1287">			jQuery.setParString(7, JdmoUtil.formatDBString(targetWeekStartGMTDt)); // target</span>
																					// week
																					// start
<span class="fc" id="L1290">			jQuery.setParString(8, JdmoUtil.formatDBString(targetWeekEndGMTDt)); // target</span>
																					// week
																					// end
<span class="fc" id="L1293">			jQuery.setParString(9, JdmoUtil.formatDBString(targetWeekStartGMTDt)); // target</span>
																					// service
																					// goals
<span class="fc" id="L1296">			ID targetSPDEID = targetSP.getDEID();</span>
<span class="pc bpc" id="L1297" title="1 of 4 branches missed.">			if (targetSPDEID == null || targetSPDEID.toString() == &quot;&quot;) {</span>
<span class="fc" id="L1298">				jQuery.setParNull(10, Jdmo.DB_TYPE_SQL_SERVER);</span>
			}
			else {
<span class="fc" id="L1301">				jQuery.setParString(10, targetSPDEID.toString()); // multi-week</span>
			}
																	// SPs will
																	// have IDs
																	// after
																	// first
																	// created
<span class="fc" id="L1308">			jQuery.setParInt(11, 0); // debug flag</span>
<span class="fc" id="L1309">			jQuery.setParInt(12, nCopyAssignments); // copy employee overrides</span>
<span class="fc" id="L1310">			jQuery.setParInt(13, nDSTFlag); // DST Flag</span>
<span class="fc" id="L1311">			jQuery.setParString(14, JdmoUtil.formatDBString(DSTStartGMT)); // DST</span>
																			// Hour
<span class="fc" id="L1313">			jQuery.setParString(15, DAOUtil.getDEID(m_dmo, false));</span>

<span class="fc" id="L1315">			jQuery.setParInt(16, nCopyProjectData); // copy project data</span>

<span class="fc" id="L1317">			JdmoRowset rs = m_dmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="fc bfc" id="L1318" title="All 2 branches covered.">			if (rs.next()) {</span>
<span class="fc" id="L1319">				weekSPID = rs.getID(1);</span>
			}
<span class="fc" id="L1321">			rs.close();</span>
<span class="nc" id="L1322">		} catch (JdmoException e) {</span>
<span class="nc" id="L1323">			throw e;</span>
<span class="fc" id="L1324">		}</span>
<span class="fc" id="L1325">		return weekSPID;</span>
	}

	private BbmCloningConflict CheckShiftAssignmentsExistWarning(List&lt;ID&gt; copyFromSPIDs, int numWeeks, Date dtStart,
			Date dtEnd) throws JdmoException {
<span class="fc" id="L1330">		BbmCloningConflict conflict = null;</span>
<span class="fc" id="L1331">		conflict = null;</span>
<span class="fc" id="L1332">		boolean bFoundError = false;</span>
		try {
<span class="fc" id="L1334">			boolean bSAExistsHandled = false;</span>
<span class="fc bfc" id="L1335" title="All 2 branches covered.">			for (int i = 0; i &lt; numWeeks; i++) {</span>
<span class="pc bpc" id="L1336" title="1 of 2 branches missed.">				if (bSAExistsHandled) {</span>
<span class="nc" id="L1337">					break;</span>
				}
				// Given a source SP (via its ID), destination starttime and
				// endtime,
				// checks if any of the source SP's employees already
				// have shiftassignments for non-null SPs that start in the
				// destination period
				String strSQLFm;
<span class="fc" id="L1345">				strSQLFm = &quot;select distinct 1 as SAEXIST &quot;;</span>
<span class="fc" id="L1346">				strSQLFm += &quot; from SPWORKRESOURCE spe, SHIFTASSIGNMENT sa &quot;;</span>
<span class="fc" id="L1347">				strSQLFm += &quot; where spe.WORKRESOURCEID = sa.WORKRESOURCEID &quot;;</span>
<span class="fc" id="L1348">				strSQLFm += &quot; and sa.SPID is not null&quot;;</span>
<span class="fc" id="L1349">				strSQLFm += &quot; and spe.SPID = (select id from sp where sid = &quot; + copyFromSPIDs.get(i);</span>
<span class="fc" id="L1350">				strSQLFm += &quot; and sa.STARTTIME &gt;= '&quot; + JdmoUtil.formatDBString(dtStart);</span>
<span class="fc" id="L1351">				strSQLFm += &quot;' and sa.STARTTIME &lt;= '&quot; + JdmoUtil.formatDBString(dtEnd) + &quot;')&quot;;</span>
<span class="fc" id="L1352">				JdmoRowset r = m_dmo.createRowset(strSQLFm);</span>
<span class="pc bpc" id="L1353" title="1 of 2 branches missed.">				if (r.next()) {</span>
<span class="nc" id="L1354">					bSAExistsHandled = true;</span>
				}
<span class="fc" id="L1356">				r.close();</span>
			}
<span class="pc bpc" id="L1358" title="1 of 2 branches missed.">			if (bSAExistsHandled) {</span>
<span class="nc" id="L1359">				bFoundError = true;</span>
				// populate conflict
			}

<span class="nc" id="L1363">		} catch (JdmoException e) {</span>
<span class="nc" id="L1364">			throw e;</span>
		} finally {
<span class="pc" id="L1366">			m_dmo.cleanUp();</span>
<span class="fc" id="L1367">		}</span>
<span class="pc bpc" id="L1368" title="1 of 2 branches missed.">		if (bFoundError) {</span>
<span class="nc" id="L1369">			conflict = new BbmCloningConflict(BbmCloningConflict.CONFLICT_SHIFT_ASSIGNMENTS_EXIST);</span>
		}
<span class="fc" id="L1371">		return conflict;</span>
	}

	private BbmCloningConflict CheckAllSkillBasedSameWarning(List&lt;ID&gt; copyFromSPIDs) throws JdmoException {
<span class="fc" id="L1375">		BbmCloningConflict conflict = null;</span>
<span class="fc" id="L1376">		conflict = null;</span>
<span class="fc" id="L1377">		boolean bFoundError = false;</span>
		try {
			// IsSkilled flag
			String strIsSkilledSQL;
<span class="fc" id="L1381">			strIsSkilledSQL = &quot;select distinct sp.ISSKILLBASED &quot;;</span>
<span class="fc" id="L1382">			strIsSkilledSQL += &quot;from sp &quot;;</span>
<span class="fc" id="L1383">			strIsSkilledSQL += &quot;where sp.id in (select id from sp where sid in &quot; + m_dmo.createInClause(copyFromSPIDs) + &quot;)&quot;;</span>

<span class="fc" id="L1385">			JdmoRowset r = m_dmo.createRowset(strIsSkilledSQL);</span>

<span class="pc bpc" id="L1387" title="1 of 2 branches missed.">			if (r.next()) {</span>
<span class="pc bpc" id="L1388" title="1 of 2 branches missed.">				if (r.next()) {</span>
<span class="nc" id="L1389">					bFoundError = true;</span>
				}
			}
<span class="fc" id="L1392">			r.close();</span>

<span class="nc" id="L1394">		} catch (JdmoException e) {</span>
<span class="nc" id="L1395">			throw e;</span>
		} finally {
<span class="pc" id="L1397">			m_dmo.cleanUp();</span>
<span class="fc" id="L1398">		}</span>
<span class="pc bpc" id="L1399" title="1 of 2 branches missed.">		if (bFoundError) {</span>
<span class="nc" id="L1400">			conflict = new BbmCloningConflict(BbmCloningConflict.CONFLICT_MULTIWEEK_SKILLBASED_DOESNT_MATCH);</span>
		}
<span class="fc" id="L1402">		return conflict;</span>
	}

	// User is not allowed to clone.
	private BbmCloningConflict CheckOrgsMatchShowStopper(List&lt;ID&gt; copyFromSPIDs) throws JdmoException {
<span class="fc" id="L1407">		BbmCloningConflict conflict = null;</span>
<span class="fc" id="L1408">		conflict = null;</span>
<span class="fc" id="L1409">		boolean bFoundError = false;</span>
		try {

			String strOrgSQL;
<span class="fc" id="L1413">			strOrgSQL = &quot;select count (distinct org.ID) as count from Organization org, SP, SPCALLCENTER spC &quot;;</span>
<span class="fc" id="L1414">			strOrgSQL += &quot;where spC.SPID = SP.ID and spC.ORGANIZATIONID = org.ID &quot;;</span>
<span class="fc" id="L1415">			strOrgSQL += &quot;and sp.id = (select id from sp where sid = &quot; + copyFromSPIDs.get(1) + &quot;)&quot;;</span>

			String strMultiOrgSQL;
<span class="fc" id="L1418">			strMultiOrgSQL = &quot;select count (distinct org.ID) as count from Organization org, SP, SPCALLCENTER spC &quot;;</span>
<span class="fc" id="L1419">			strMultiOrgSQL += &quot;where spC.SPID = SP.ID and spC.ORGANIZATIONID = org.ID &quot;;</span>
<span class="fc" id="L1420">			strMultiOrgSQL += &quot;and sp.id in (select id from sp where sid in &quot; + m_dmo.createInClause(copyFromSPIDs) + &quot;)&quot;;</span>

<span class="fc" id="L1422">			JdmoRowset r = m_dmo.createRowset(strOrgSQL);</span>
<span class="fc" id="L1423">			int count1 = 0;</span>
<span class="pc bpc" id="L1424" title="1 of 2 branches missed.">			if (r.next()) {</span>
<span class="fc" id="L1425">				count1 = r.getInt(&quot;count&quot;);</span>
			}
<span class="fc" id="L1427">			r.close();</span>

<span class="fc" id="L1429">			JdmoRowset r2 = m_dmo.createRowset(strMultiOrgSQL);</span>
<span class="fc" id="L1430">			int count2 = 0;</span>
<span class="pc bpc" id="L1431" title="1 of 2 branches missed.">			if (r2.next()) {</span>
<span class="fc" id="L1432">				count2 = r2.getInt(&quot;count&quot;);</span>
			}
<span class="fc" id="L1434">			r2.close();</span>

<span class="pc bpc" id="L1436" title="1 of 2 branches missed.">			if (count1 != count2) {</span>
<span class="nc" id="L1437">				bFoundError = true;</span>
				// populate conflict
			}

<span class="nc" id="L1441">		} catch (JdmoException e) {</span>
<span class="nc" id="L1442">			throw e;</span>
		} finally {
<span class="pc" id="L1444">			m_dmo.cleanUp();</span>
<span class="fc" id="L1445">		}</span>
<span class="pc bpc" id="L1446" title="1 of 2 branches missed.">		if (bFoundError) {</span>
<span class="nc" id="L1447">			conflict = new BbmCloningConflict(BbmCloningConflict.CONFLICT_MULTIWEEK_ORGS_DONT_MATCH);</span>
		}
<span class="fc" id="L1449">		return conflict;</span>
	}

	// User is not allowed to clone.
	private BbmCloningConflict CheckQueuesMatchShowStopper(List&lt;ID&gt; copyFromSPIDs) {
<span class="fc" id="L1454">		BbmCloningConflict conflict = null;</span>
<span class="fc" id="L1455">		conflict = null;</span>
<span class="fc" id="L1456">		boolean bFoundError = false;</span>
		try {

			String strQueueSQL;
<span class="fc" id="L1460">			strQueueSQL = &quot;select count (distinct SPQUEUE.QUEUEID) as count from SPQUEUE where SPQUEUE.SPID = (select id from sp where sid = &quot;</span>
<span class="fc" id="L1461">					+ copyFromSPIDs.get(0) + &quot;)&quot;;</span>

			String strMultiQueueSQL;
<span class="fc" id="L1464">			strMultiQueueSQL = &quot;select count (distinct SPQUEUE.QUEUEID) as count from SPQUEUE where SPQUEUE.SPID in (select id from sp where sid in &quot;</span>
<span class="fc" id="L1465">					+ m_dmo.createInClause(copyFromSPIDs) + &quot;)&quot;;</span>

<span class="fc" id="L1467">			JdmoRowset r = m_dmo.createRowset(strQueueSQL);</span>
<span class="fc" id="L1468">			int count1 = 0;</span>
<span class="pc bpc" id="L1469" title="1 of 2 branches missed.">			if (r.next()) {</span>
<span class="fc" id="L1470">				count1 = r.getInt(&quot;count&quot;);</span>
			}
<span class="fc" id="L1472">			r.close();</span>

<span class="fc" id="L1474">			JdmoRowset r2 = m_dmo.createRowset(strMultiQueueSQL);</span>
<span class="fc" id="L1475">			int count2 = 0;</span>
<span class="pc bpc" id="L1476" title="1 of 2 branches missed.">			if (r2.next()) {</span>
<span class="fc" id="L1477">				count2 = r2.getInt(&quot;count&quot;);</span>
			}
<span class="fc" id="L1479">			r2.close();</span>

<span class="pc bpc" id="L1481" title="1 of 2 branches missed.">			if (count1 != count2) {</span>
<span class="nc" id="L1482">				bFoundError = true;</span>
				// populate conflict
			}

<span class="nc" id="L1486">		} catch (JdmoException e) {</span>
			// throw e;
		} finally {
<span class="pc" id="L1489">			m_dmo.cleanUp();</span>
<span class="pc" id="L1490">		}</span>
<span class="pc bpc" id="L1491" title="1 of 2 branches missed.">		if (bFoundError) {</span>
<span class="nc" id="L1492">			conflict = new BbmCloningConflict(BbmCloningConflict.CONFLICT_MULTIWEEK_QUEUES_DONT_MATCH);</span>
		}
<span class="fc" id="L1494">		return conflict;</span>
	}

	// User is not allowed to clone.
	private BbmCloningConflict CheckQueuesInOtherCampaignShowStopper(Collection&lt;ID&gt; spIDs, Date startGMTDt, Date endGMTDt)
			throws JdmoException {
<span class="fc" id="L1500">		BbmCloningConflict conflict = null;</span>
<span class="fc" id="L1501">		conflict = null;</span>
<span class="fc" id="L1502">		boolean bFoundError = false;</span>
<span class="fc" id="L1503">		List&lt;String&gt; names = new ArrayList&lt;String&gt;();</span>
		try {
			String strQueuesSQLFm;
<span class="fc" id="L1506">			strQueuesSQLFm = &quot;select distinct name from queue where id in &quot;;</span>
<span class="fc" id="L1507">			strQueuesSQLFm += &quot;(select queueid from spqueue where &quot;;</span>
<span class="fc" id="L1508">			strQueuesSQLFm += &quot; (queueid in &quot;;</span>
<span class="fc" id="L1509">			strQueuesSQLFm += &quot; (select queueid from spqueue where queueid is not null and spid in (select id from sp where sid in &quot;</span>
<span class="fc" id="L1510">					+ m_dmo.createInClause(spIDs) + &quot;)))&quot;;</span>
<span class="fc" id="L1511">			strQueuesSQLFm += &quot; and &quot;;</span>
<span class="fc" id="L1512">			strQueuesSQLFm += &quot; (spid in &quot;;</span>
<span class="fc" id="L1513">			strQueuesSQLFm += &quot; (select id from sp where FROMDATE &lt; '&quot; + JdmoUtil.formatDBString(endGMTDt)</span>
<span class="fc" id="L1514">					+ &quot;' AND TODATE &gt; '&quot; + JdmoUtil.formatDBString(startGMTDt) + &quot;')))&quot;;</span>

<span class="fc" id="L1516">			JdmoRowset r = m_dmo.createRowset(strQueuesSQLFm);</span>
<span class="pc bpc" id="L1517" title="1 of 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L1518">				bFoundError = true;</span>
<span class="nc" id="L1519">				String campaignName = new String(r.getString(&quot;NAME&quot;));</span>
<span class="nc" id="L1520">				names.add(campaignName);</span>
<span class="nc" id="L1521">			}</span>
<span class="fc" id="L1522">			r.close();</span>

<span class="nc" id="L1524">		} catch (JdmoException e) {</span>
<span class="nc" id="L1525">			throw e;</span>
		} finally {
<span class="pc" id="L1527">			m_dmo.cleanUp();</span>
<span class="fc" id="L1528">		}</span>
<span class="pc bpc" id="L1529" title="1 of 2 branches missed.">		if (bFoundError) {</span>
<span class="nc" id="L1530">			conflict = new BbmCloningConflict(BbmCloningConflict.CONFLICT_QUEUES_IN_OTHER_CAMPAIGN, names);</span>
		}
<span class="fc" id="L1532">		return conflict;</span>
	}

	/**
	 * Returns the child scheduling period IDs of the SP having the specified
	 * numeric or alphanumeric ID.
	 *
	 * @param parentSPID
	 *            the ID of the parent SP--may be SID or DEID (numeric or
	 *            alphanumeric)
	 * @return a collection of IDs of the child SPs
	 * @throws JdmoException
	 * @throws BbmFinderException
	 *             if the specified ID cannot be mapped to a DEID
	 */
	public Collection&lt;ID&gt; getSubSPIDsFromParentSPID(ID parentSPID) throws JdmoException, BbmFinderException {
<span class="fc" id="L1548">		return getSubSPIDs(DAOUtil.mapIDToDEID(parentSPID, m_fieldInfo));</span>
	}

	/**
	 * Returns the child scheduling period IDs of the SP having the specified
	 * alphanumeric ID.
	 *
	 * @param parentSPID
	 *            the ID of the parent SP--must be a DEID (alphanumeric)
	 * @return a collection of IDs of the child SPs
	 * @throws JdmoException
	 */
	private Collection&lt;ID&gt; getSubSPIDs(ID parentSPID) throws JdmoException {
<span class="fc" id="L1561">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;ID&gt;();</span>

		// ID DEID = getDEIDFromSID(&quot;SP&quot;, parentSPID);
<span class="fc" id="L1564">		String query = &quot;SELECT SID FROM SP WHERE PARENTSPID = '&quot; + parentSPID + &quot;'&quot;;</span>

<span class="fc" id="L1566">		JdmoRowset r = m_dmo.createRowset(query);</span>

<span class="fc bfc" id="L1568" title="All 2 branches covered.">		while (r.next()) {</span>
<span class="fc" id="L1569">			ID id = new ID(r.getID(&quot;SID&quot;));</span>
<span class="fc" id="L1570">			ids.add(id);</span>
<span class="fc" id="L1571">		}</span>

<span class="fc" id="L1573">		r.close();</span>
<span class="fc" id="L1574">		return ids;</span>
	}

	/**
	 * Updates a collection of scheduling periods that have their campaign IDs
	 * set as SIDs. This method is an unfortunate side effect of the dual ID
	 * problem. It is here because the standard method, DAOBase.updateObjects,
	 * will not work for Scheduling Periods that have campaign SIDs loaded
	 * instead of DEIDs as the campaign DEID is what is stored in the DB as a
	 * foreign key. This method should not be exposed to the webtier as we want
	 * to hide the concept of dual IDs from the webtier.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public void updateSchedulingPeriodsWithCampaignSIDs(Collection&lt;SchedulingPeriod&gt; schedulingPeriods) throws BbmException {
		try {
<span class="nc" id="L1589">			Collection&lt;ID&gt; campaignSIDs = ValueObjectUtil.getFieldObjectCol(SchedulingPeriodFieldInfo.SP_CAMPAIGNID,</span>
					schedulingPeriods);
			// Get the DEID campaign ID for each scheduling period
<span class="nc" id="L1592">			Map&lt;ID, ID&gt; campaignIDtoDEIDMap = DAOUtil.mapIDsToDEIDs(campaignSIDs, new CampaignFieldInfo());</span>
<span class="nc" id="L1593">			Map&lt;ID, ID&gt; campaignDEIDtoIDMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc bnc" id="L1594" title="All 2 branches missed.">			for (SchedulingPeriod sp : schedulingPeriods) {</span>
				// Set the DEID of the campaign ID for each scheduling period
				// before updating
<span class="nc" id="L1597">				campaignDEIDtoIDMap.put(campaignIDtoDEIDMap.get(sp.getCampaignID()), sp.getCampaignID());</span>
<span class="nc" id="L1598">				sp.setCampaignID(campaignIDtoDEIDMap.get(sp.getCampaignID()));</span>
<span class="nc" id="L1599">			}</span>
<span class="nc" id="L1600">			super.updateObjects(schedulingPeriods);</span>
			// Swap the SID back onto the SP before exiting
<span class="nc bnc" id="L1602" title="All 2 branches missed.">			for (SchedulingPeriod sp : schedulingPeriods) {</span>
<span class="nc" id="L1603">				sp.setCampaignID(campaignDEIDtoIDMap.get(sp.getCampaignID()));</span>
<span class="nc" id="L1604">			}</span>
<span class="nc" id="L1605">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1606">			throw new BbmException(e);</span>
<span class="nc" id="L1607">		} catch (MultiUserException e) {</span>
<span class="nc" id="L1608">			throw new BbmException(e);</span>
<span class="nc" id="L1609">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1610">			throw new BbmException(e);</span>
<span class="nc" id="L1611">		}</span>
<span class="nc" id="L1612">	}</span>

	public Collection&lt;SchedulingPeriod&gt; getCommonSchedulingPeriods(ID campaignID, Collection&lt;ID&gt; employeeIDs, Date date, int nNumberToGet) throws BbmFinderException {

<span class="nc bnc" id="L1616" title="All 4 branches missed.">		if (employeeIDs == null || employeeIDs.isEmpty()) {</span>
<span class="nc" id="L1617">			return Collections.emptyList();</span>
		}

		try {
<span class="nc" id="L1621">			JdmoQuery query = m_dmo.createQuery(&quot;RM_GET_COMMON_SP_FOR_EMPLOYEES&quot;, Jdmo.STORPROC_QUERY);</span>

<span class="nc" id="L1623">			String xml = com.verint.ejb.wfm.util.DAOUtil.converIdsToXml(employeeIDs);</span>
<span class="nc" id="L1624">			query.setParSqlXml(1, xml);</span>
<span class="nc" id="L1625">			query.setParInt(2, campaignID.toInt());</span>
<span class="nc" id="L1626">			query.setParTimestamp(3, new Timestamp(date.getTime()));</span>
<span class="nc" id="L1627">			query.setParInt(4, nNumberToGet);</span>

<span class="nc" id="L1629">			JdmoRowset rs = m_dmo.createRowset(query, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L1630">			List&lt;SchedulingPeriod&gt; result = new ArrayList&lt;SchedulingPeriod&gt;(nNumberToGet);</span>

<span class="nc bnc" id="L1632" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1633">				SchedulingPeriod sp = getSchedulingPeriodFromRowset(rs, null);</span>
<span class="nc" id="L1634">				result.add(sp);</span>
<span class="nc" id="L1635">			}</span>

<span class="nc" id="L1637">			rs.close();</span>
<span class="nc" id="L1638">			return result;</span>

<span class="nc" id="L1640">		} catch (JdmoException e) {</span>
<span class="nc" id="L1641">			throw new BbmFinderException(e);</span>
		}

	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>