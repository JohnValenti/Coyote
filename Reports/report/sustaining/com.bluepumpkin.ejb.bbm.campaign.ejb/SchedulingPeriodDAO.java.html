<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SchedulingPeriodDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.campaign.ejb</a> &gt; <span class="el_source">SchedulingPeriodDAO.java</span></div><h1>SchedulingPeriodDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.campaign.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  dao object to serialize SchedulingPeriod object
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 *
 * @author lixin zhang
 * @version 1.0
 */

import java.sql.Timestamp;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.jdmo.*;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.*;
import com.bluepumpkin.ejb.bbm.campaign.model.*;
import com.bluepumpkin.ejb.bbm.dao.DAOEffectivity;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriodUtil;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.timeseries.util.DSTConversionUtil;
import com.bluepumpkin.ejb.bbm.util.MonthlySPUtil;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.core.base.MultiUserException;

import java.util.*;

public class SchedulingPeriodDAO extends DAOEffectivity&lt;SchedulingPeriod&gt; {

<span class="nc" id="L34">	private static FieldInfo m_fieldInfo = new SchedulingPeriodFieldInfo();</span>

	public SchedulingPeriodDAO() {
<span class="nc" id="L37">		super();</span>
<span class="nc" id="L38">	}</span>

	public SchedulingPeriodDAO(Jdmo dmo) {
<span class="nc" id="L41">		super(dmo);</span>
<span class="nc" id="L42">	}</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="nc" id="L46">		return m_fieldInfo;</span>
	}

	@Override
	protected SchedulingPeriod createValueObject() {
<span class="nc" id="L51">		return (new SchedulingPeriod());</span>
	}

	public ID createSchedulingPeriod(SchedulingPeriod schedulingPeriod) throws BbmCreateException {

<span class="nc" id="L56">		Jdmo jdmo = new Jdmo();</span>
<span class="nc" id="L57">		ID createdID = new ID();</span>
<span class="nc" id="L58">		JdmoRowset rsSID = null;</span>
<span class="nc" id="L59">		JdmoRowset rsSubCamps = null;</span>
<span class="nc" id="L60">		SPQueueDAO SPQueuedao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L62">			TimeZone zone = CampaignDAO.getTimeZoneByCampaignID(schedulingPeriod.getCampaignID());</span>
<span class="nc" id="L63">			Date startGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(schedulingPeriod.getStartTimeLocal(),</span>
					zone);
<span class="nc" id="L65">			Date endGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(schedulingPeriod.getEndTimeLocal(), zone);</span>

			// get ID from DE
<span class="nc" id="L68">			String idStr = DAOUtil.getDEID(jdmo);</span>
<span class="nc" id="L69">			ID DEIDCampaignID = getDEIDFromSID(&quot;CAMPAIGN&quot;, schedulingPeriod.getCampaignID());</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">			int nSkillBased = (schedulingPeriod.getSkillBased()) ? 1 : 0;</span>

<span class="nc" id="L72">			String strCreate = &quot;INSERT INTO sp (id, campaignid, name, description, isskillbased, fromdate, todate,&quot;</span>
					+ &quot;is24hour,weekstart,fteshifts,fteworkhours,ftepaidhours,iscrossboundaries,&quot;
					+ &quot;mintimebetweenshift,ftephonehours,ftewage,minphantoms,maxphantoms,alloweditingofar,ismanualarmode,isusingallemployees) VALUES ('&quot;
<span class="nc" id="L75">					+ idStr + &quot;','&quot; + DEIDCampaignID + &quot;','&quot; + JdmoUtil.formatDBString(schedulingPeriod.getName())</span>
<span class="nc" id="L76">					+ &quot;','&quot; + JdmoUtil.formatDBString(schedulingPeriod.getDescription()) + &quot;',&quot; + nSkillBased + &quot;,'&quot;</span>
<span class="nc" id="L77">					+ JdmoUtil.formatDBString(startGMTDt) + &quot;','&quot; + JdmoUtil.formatDBString(endGMTDt)</span>
<span class="nc" id="L78">					+ &quot;', 0, 1440, 5, 480, 450, 0, 0, 420, 0, &quot; + schedulingPeriod.getMinPhantoms() + &quot;, &quot;</span>
<span class="nc" id="L79">					+ schedulingPeriod.getMaxPhantoms() + &quot;, 0, &quot;</span>
<span class="nc" id="L80">					+ JdmoUtil.formatBool(schedulingPeriod.isManualFteRequirementsMode()) + &quot;, &quot;</span>
<span class="nc" id="L81">					+ JdmoUtil.formatBool(schedulingPeriod.isUsingAllEmployees()) + &quot;)&quot;;</span>
<span class="nc" id="L82">			jdmo.executeCommand(strCreate);</span>

			// find SID and return
<span class="nc" id="L85">			String stmt = &quot;SELECT sid FROM sp WHERE id ='&quot; + idStr + &quot;'&quot;;</span>
<span class="nc" id="L86">			rsSID = m_dmo.createRowset(stmt);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">			if (rsSID.next()) {</span>
<span class="nc" id="L88">				createdID = rsSID.getID(1);</span>
			}

<span class="nc" id="L91">			ID DESubCampID = null;</span>
<span class="nc" id="L92">			String stmtSubCamps = &quot;SELECT id, SID FROM campaign WHERE parentcampaignid = '&quot; + DEIDCampaignID + &quot;'&quot;;</span>
<span class="nc" id="L93">			rsSubCamps = m_dmo.createRowset(stmtSubCamps);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">			while (rsSubCamps.next()) {</span>
<span class="nc" id="L95">				DESubCampID = rsSubCamps.getID(1);</span>
<span class="nc" id="L96">				ID subCampID = rsSubCamps.getID(2);</span>
<span class="nc" id="L97">				zone = CampaignDAO.getTimeZoneByCampaignID(subCampID);</span>
<span class="nc" id="L98">				startGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(schedulingPeriod.getStartTimeLocal(),</span>
						zone);
<span class="nc" id="L100">				endGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(schedulingPeriod.getEndTimeLocal(), zone);</span>

<span class="nc" id="L102">				String subidStr = DAOUtil.getDEID(jdmo);</span>
<span class="nc" id="L103">				String strCreateSub = &quot;INSERT INTO sp (id, campaignid, parentspid, name, description, isskillbased, fromdate, todate,&quot;</span>
						+ &quot;is24hour,weekstart,fteshifts,fteworkhours,ftepaidhours,iscrossboundaries,&quot;
						+ &quot;mintimebetweenshift,ftephonehours,ftewage,minphantoms,maxphantoms,alloweditingofar,ismanualarmode,isusingallemployees) VALUES ('&quot;
						+ subidStr
						+ &quot;','&quot;
						+ DESubCampID
						+ &quot;','&quot;
						+ idStr
						+ &quot;','&quot;
<span class="nc" id="L112">						+ JdmoUtil.formatDBString(schedulingPeriod.getName())</span>
						+ &quot;','&quot;
<span class="nc" id="L114">						+ JdmoUtil.formatDBString(schedulingPeriod.getDescription())</span>
						+ &quot;',&quot;
						+ nSkillBased
						+ &quot;,'&quot;
<span class="nc" id="L118">						+ JdmoUtil.formatDBString(startGMTDt)</span>
						+ &quot;','&quot;
<span class="nc" id="L120">						+ JdmoUtil.formatDBString(endGMTDt)</span>
						+ &quot;', 0, 1440, 5, 480, 450, 0, 0, 420, 0, &quot;
<span class="nc" id="L122">						+ schedulingPeriod.getMinPhantoms()</span>
						+ &quot;, &quot;
<span class="nc" id="L124">						+ schedulingPeriod.getMaxPhantoms() + &quot;, 0, 0, 0)&quot;;</span>
<span class="nc" id="L125">				jdmo.executeCommand(strCreateSub);</span>

				// find SID and return
<span class="nc" id="L128">				JdmoRowset rsSubSID = null;</span>
<span class="nc" id="L129">				String subStmt = &quot;SELECT sid FROM sp WHERE id ='&quot; + subidStr + &quot;'&quot;;</span>
<span class="nc" id="L130">				rsSubSID = m_dmo.createRowset(subStmt);</span>
<span class="nc" id="L131">				ID createdSubID = new ID();</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">				if (rsSubSID.next()) {</span>
<span class="nc" id="L133">					createdSubID = rsSubSID.getID(1);</span>
				}
				try {
<span class="nc" id="L136">					rsSubSID.close();</span>
<span class="nc" id="L137">				} catch (Exception e) {</span>
<span class="nc" id="L138">				}</span>

<span class="nc" id="L140">				SPQueue spqSubObj = new SPQueue();</span>
<span class="nc" id="L141">				spqSubObj.setSpID(createdSubID);</span>
<span class="nc" id="L142">				spqSubObj.setQueueID(null);</span>
<span class="nc" id="L143">				spqSubObj.setMediaID(null);</span>
<span class="nc" id="L144">				SPQueuedao.createSPQueueDB(spqSubObj, new ID(subidStr), null, null);</span>
<span class="nc" id="L145">			}</span>

			// Link the orgs.
<span class="nc bnc" id="L148" title="All 2 branches missed.">			if (schedulingPeriod.IsOrgsLoaded()) {</span>
<span class="nc" id="L149">				linkOrgsToSP(schedulingPeriod.getParentSPID(), createdID, schedulingPeriod.getOrgs());</span>
			}

			// Create the first spqueue with a null media and null queue.
<span class="nc" id="L153">			SPQueue spqObj = new SPQueue();</span>
<span class="nc" id="L154">			spqObj.setSpID(createdID);</span>
<span class="nc" id="L155">			spqObj.setQueueID(null);</span>
<span class="nc" id="L156">			spqObj.setMediaID(null);</span>
<span class="nc" id="L157">			SPQueuedao.createSPQueueDB(spqObj, new ID(idStr), null, null);</span>
<span class="nc" id="L158">		} catch (JdmoException ex) {</span>
<span class="nc" id="L159">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L160">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L161">			throw new BbmCreateException(e);</span>
<span class="nc" id="L162">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L163">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L165">			try {</span>
<span class="nc" id="L166">				rsSID.close();</span>
<span class="nc" id="L167">			} catch (Exception e) {</span>
<span class="nc" id="L168">			}</span>
			try {
<span class="nc" id="L170">				rsSubCamps.close();</span>
<span class="nc" id="L171">			} catch (Exception e) {</span>
<span class="nc" id="L172">			}</span>
<span class="nc bnc" id="L173" title="All 4 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L174">				jdmo.cleanUp();</span>
			}
<span class="nc bnc" id="L176" title="All 4 branches missed.">			if (SPQueuedao != null) {</span>
<span class="nc" id="L177">				SPQueuedao.cleanUp();</span>
			}
		}
<span class="nc" id="L180">		return createdID;</span>

	}

	protected ID getDEIDFromSID(String TableName, ID sidValue) throws JdmoException {
<span class="nc" id="L185">		ID DEID = null;</span>
<span class="nc" id="L186">		String stmt = &quot;SELECT id FROM &quot; + TableName + &quot; WHERE sid='&quot; + sidValue + &quot;'&quot;;</span>
<span class="nc" id="L187">		JdmoRowset rs = m_dmo.createRowset(stmt);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L189">			DEID = rs.getID(1);</span>
		}
<span class="nc" id="L191">		return DEID;</span>
	}

	protected ID getSIDFromDEID(String TableName, ID idValue) throws JdmoException {
<span class="nc" id="L195">		ID SID = null;</span>
<span class="nc" id="L196">		String stmt = &quot;SELECT sid FROM &quot; + TableName + &quot; WHERE id='&quot; + idValue + &quot;'&quot;;</span>
<span class="nc" id="L197">		JdmoRowset rs = m_dmo.createRowset(stmt);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L199">			SID = rs.getID(1);</span>
		}
<span class="nc" id="L201">		return SID;</span>
	}

	public void updateSchedulingPeriods(Collection&lt;SchedulingPeriod&gt; colObjValues) throws MultiUserException,
			BbmUpdateException {
		try {
			// updateObjects(colObjValues);
<span class="nc" id="L208">			SchedulingPeriod objValue = null;</span>
<span class="nc" id="L209">			HashMap&lt;String, Object&gt; nameValues = new HashMap&lt;String, Object&gt;(5);</span>
<span class="nc" id="L210">			ID prevSPID = null;</span>
<span class="nc" id="L211">			ID prevSPSID = null;</span>
			ID DEIDSchedulingPeriod;
<span class="nc bnc" id="L213" title="All 2 branches missed.">			for (Iterator&lt;SchedulingPeriod&gt; i = colObjValues.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L214">				objValue = i.next();</span>
<span class="nc" id="L215">				ID idSchedulingPeriod = objValue.getID();</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">				if (idSchedulingPeriod == prevSPSID) {</span>
<span class="nc" id="L217">					DEIDSchedulingPeriod = prevSPID;</span>
				} else {
<span class="nc" id="L219">					DEIDSchedulingPeriod = getDEIDFromSID(&quot;SP&quot;, idSchedulingPeriod);</span>
<span class="nc" id="L220">					prevSPSID = idSchedulingPeriod;</span>
<span class="nc" id="L221">					prevSPID = DEIDSchedulingPeriod;</span>
				}
<span class="nc" id="L223">				nameValues.put(&quot;ID&quot;, JdmoUtil.asSqlLiteral(DEIDSchedulingPeriod.toString()));</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">				if (objValue.getParentSPID() != null) {</span>
<span class="nc" id="L225">					nameValues.put(&quot;PARENTSPID&quot;, JdmoUtil.formatDBString(objValue.getParentSPID().toString()));</span>
				}
<span class="nc" id="L227">				nameValues.put(&quot;DESCRIPTION&quot;, objValue.getDescription());</span>
<span class="nc" id="L228">				nameValues.put(&quot;ISSKILLBASED&quot;, JdmoUtil.formatBool(objValue.getSkillBased()));</span>
<span class="nc" id="L229">				nameValues.put(&quot;MINPHANTOMS&quot;, objValue.getMinPhantoms());</span>
<span class="nc" id="L230">				nameValues.put(&quot;MAXPHANTOMS&quot;, objValue.getMaxPhantoms());</span>
<span class="nc" id="L231">				nameValues.put(&quot;ISUSINGALLEMPLOYEES&quot;, JdmoUtil.formatBool(objValue.isUsingAllEmployees()));</span>
<span class="nc" id="L232">				nameValues.put(&quot;ISMANUALARMODE&quot;, JdmoUtil.formatBool(objValue.isManualFteRequirementsMode()));</span>
<span class="nc" id="L233">				m_dmo.addBatchUpdate(&quot;SP&quot;, nameValues);</span>
				// linkOrgsToSP() nulls out the batch in m_dmo (specifically
				// m_dmo.m_stmt becomes null
				// So we have to invoke() executeBatch() immediately rather than
				// after the
				// loop, which slows execution slightly .
<span class="nc" id="L239">				m_dmo.executeBatch();</span>

				// Link the orgs.
<span class="nc bnc" id="L242" title="All 2 branches missed.">				if (objValue.IsOrgsLoaded()) {</span>
<span class="nc" id="L243">					linkOrgsToSP(objValue.getParentSPID(), idSchedulingPeriod, objValue.getOrgs());</span>
				}

				// update child sps
<span class="nc bnc" id="L247" title="All 2 branches missed.">				if (objValue.getParentSPID() == null) {</span>
<span class="nc" id="L248">					String strUpdateChildren = &quot;Update SP set ISSKILLBASED = &quot;</span>
<span class="nc" id="L249">							+ JdmoUtil.formatBool(objValue.getSkillBased()) + &quot; WHERE PARENTSPID = &quot;</span>
<span class="nc" id="L250">							+ JdmoUtil.asSqlLiteral(DEIDSchedulingPeriod.toString());</span>
<span class="nc" id="L251">					m_dmo.executeCommand(strUpdateChildren);</span>
				}
<span class="nc" id="L253">			}</span>
<span class="nc" id="L254">		} catch (JdmoException ex) {</span>
<span class="nc" id="L255">			throw new BbmUpdateException(ex);</span>
<span class="nc" id="L256">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L257">			throw new BbmUpdateException(e.getBundleName(), e.getMsgID(), e.getParamObject());</span>
<span class="nc" id="L258">		}</span>
<span class="nc" id="L259">	}</span>

	/**
	 * delete a campaign's organization assignment given the assignment id
	 */
	public void deleteSchedulingPeriods(Collection&lt;ID&gt; colIDs) throws BbmRemoveException {
<span class="nc" id="L265">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L267">			String where = &quot;select ID from SP where SID in &quot; + m_dmo.createInClause(colIDs);</span>
			// delete children sp too.
<span class="nc" id="L269">			where += &quot; OR PARENTSPID in (select ID from SP where SID in &quot; + m_dmo.createInClause(colIDs) + &quot;)&quot;;</span>
<span class="nc" id="L270">			DAOUtil.deleteObjects(jdmo, &quot;SP&quot;, where);</span>
			// deleteObjects(colIDs);
<span class="nc" id="L272">		} catch (JdmoException ex) {</span>
<span class="nc" id="L273">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc bnc" id="L275" title="All 4 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L276">				jdmo.cleanUp();</span>
			}
		}
<span class="nc" id="L279">	}</span>

	/**
	 * get existing scheduling periods for a campaign
	 *
	 * @return a collection of SchedulingPeriod objects which hold the
	 * assignment information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null dates are not allowed
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, Date dtStart, Date dtEnd, ID idSP,
			Collection&lt;ID&gt; cSP) throws BbmFinderException {
<span class="nc" id="L291">		return getSchedulingPeriods(idCampaign, null, dtStart, dtEnd, idSP, cSP);</span>
	}

	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID campaignSID, ID idOrg, Date dtStart, Date dtEnd, ID idSP,
			Collection&lt;ID&gt; cSP) throws BbmFinderException {

<span class="nc" id="L297">		List&lt;SchedulingPeriod&gt; aSPs = new ArrayList&lt;SchedulingPeriod&gt;();</span>
<span class="nc" id="L298">		JdmoRowset r = null;</span>
		try {

			// Queury the database
<span class="nc bnc" id="L302" title="All 4 branches missed.">			if (idSP != null &amp;&amp; !idSP.isInt()) {</span>
<span class="nc" id="L303">				idSP = DAOUtil.mapIDToSID(idSP, new SchedulingPeriodFieldInfo());</span>
			}

<span class="nc" id="L306">			String query = &quot;SELECT sp.id AS deid, &quot; + &quot;  sp.sid, &quot; + &quot;  sp.parentspid, &quot; + &quot;  sp.fromdate, &quot;</span>
					+ &quot;  sp.todate, &quot; + &quot;  sp.isskillbased, &quot; + &quot;  sp.minphantoms, &quot; + &quot;  sp.maxphantoms, &quot; + &quot;  sp.name, &quot;
					+ &quot;  sp.description, &quot; + &quot;  sp.alloweditingofar, &quot; + &quot;  sp.ismanualarmode, &quot;
					+ &quot;  sp.isusingallemployees, &quot; + &quot;  campaign.sid as csid &quot; + &quot;FROM sp, campaign &quot;;

<span class="nc bnc" id="L311" title="All 2 branches missed.">			if (idOrg != null) {</span>
<span class="nc" id="L312">				query += &quot;,spcallcenter &quot;;</span>
			}

<span class="nc bnc" id="L315" title="All 2 branches missed.">			if (idSP != null) {</span>
<span class="nc" id="L316">				query += &quot; WHERE campaign.id = sp.campaignid AND sp.sid = &quot; + idSP;</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">			} else if (campaignSID != null) {</span>
<span class="nc bnc" id="L318" title="All 4 branches missed.">				if (dtStart != null &amp;&amp; dtEnd != null) {</span>
<span class="nc" id="L319">					query += (&quot; WHERE campaign.id = sp.campaignid AND campaign.sid = &quot; + campaignSID + &quot; and fromdate &lt; '&quot;</span>
<span class="nc" id="L320">							+ JdmoUtil.formatDBString(dtEnd) + &quot;' and todate &gt; '&quot; + JdmoUtil.formatDBString(dtStart) + &quot;'&quot;);</span>
				} else {
<span class="nc" id="L322">					query += (&quot; WHERE campaign.id = sp.campaignid AND campaign.sid = &quot; + campaignSID);</span>
				}
			} else {
<span class="nc" id="L325">				query += &quot; WHERE campaign.id = campaignid AND sp.sid IN &quot; + m_dmo.createInClause(cSP);</span>
			}

<span class="nc bnc" id="L328" title="All 2 branches missed.">			if (idOrg != null) {</span>
<span class="nc" id="L329">				query += &quot; AND spcallcenter.spid = sp.id AND spcallcenter.organizationid=&quot; + idOrg;</span>
			}

<span class="nc" id="L332">			query += &quot; ORDER BY fromdate ASC&quot;;</span>
<span class="nc" id="L333">			r = m_dmo.createRowset(query);</span>

			// Convert result set to scheduling period entities
<span class="nc bnc" id="L336" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L337">				ID idCampaign1 = r.getID(&quot;CSID&quot;);</span>
<span class="nc" id="L338">				TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(idCampaign1);</span>

<span class="nc" id="L340">				SchedulingPeriod sp = getSchedulingPeriodFromRowset(r, tz);</span>

				// Add to result collection
<span class="nc" id="L343">				aSPs.add(sp);</span>
<span class="nc" id="L344">			}</span>

<span class="nc" id="L346">			return aSPs;</span>

<span class="nc" id="L348">		} catch (JdmoException e) {</span>
<span class="nc" id="L349">			e.printStackTrace();</span>
<span class="nc" id="L350">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L352">			try {</span>
<span class="nc" id="L353">				r.close();</span>
<span class="nc" id="L354">			} catch (Exception e) {</span>
<span class="nc" id="L355">			}</span>
<span class="nc" id="L356">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * @param campaignSID
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID campaignSID) throws BbmFinderException {

<span class="nc" id="L367">		TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(campaignSID);</span>

<span class="nc" id="L369">		List&lt;SchedulingPeriod&gt; result = new ArrayList&lt;SchedulingPeriod&gt;();</span>

<span class="nc" id="L371">		JdmoRowset r = null;</span>
		try {

			// Queury the database
<span class="nc" id="L375">			String query = &quot;SELECT sp.id AS deid, &quot; + &quot;  sp.sid, &quot; + &quot;  sp.parentspid, &quot; + &quot;  sp.fromdate, &quot;</span>
					+ &quot;  sp.todate, &quot; + &quot;  sp.isskillbased, &quot; + &quot;  sp.minphantoms, &quot; + &quot;  sp.maxphantoms, &quot; + &quot;  sp.name, &quot;
					+ &quot;  sp.description, &quot; + &quot;  sp.alloweditingofar, &quot; + &quot;  sp.ismanualarmode, &quot;
					+ &quot;  sp.isusingallemployees, &quot; + &quot;  c.sid as csid &quot; + &quot;FROM sp sp &quot; + &quot;LEFT JOIN campaign c &quot;
					+ &quot;  ON c.id = sp.campaignid&quot; + &quot;WHERE c.sid = &quot; + campaignSID + &quot;ORDER BY fromdate ASC&quot;;
<span class="nc" id="L380">			r = m_dmo.createRowset(query);</span>

			// Convert result set to scheduling period entities
<span class="nc bnc" id="L383" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L384">				SchedulingPeriod sp = getSchedulingPeriodFromRowset(r, tz);</span>

				// Add to result collection
<span class="nc" id="L387">				result.add(sp);</span>
<span class="nc" id="L388">			}</span>

<span class="nc" id="L390">			return result;</span>

<span class="nc" id="L392">		} catch (JdmoException e) {</span>
<span class="nc" id="L393">			e.printStackTrace();</span>
<span class="nc" id="L394">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L396">			try {</span>
<span class="nc" id="L397">				r.close();</span>
<span class="nc" id="L398">			} catch (Exception e) {</span>
<span class="nc" id="L399">			}</span>
<span class="nc" id="L400">			m_dmo.cleanUp();</span>
		}
	}

	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, Date dtDate, int nNumberToGet, int eTimeFrame)
			throws BbmFinderException {

<span class="nc" id="L407">		List&lt;SchedulingPeriod&gt; resultSchedulingPeriods = new ArrayList&lt;SchedulingPeriod&gt;();</span>
<span class="nc" id="L408">		List&lt;ID&gt; aIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L409">		JdmoRowset r = null;</span>
		try {
<span class="nc bnc" id="L411" title="All 2 branches missed.">			if (eTimeFrame == SchedulingPeriod.PastAndFuture) {</span>
<span class="nc" id="L412">				nNumberToGet /= 2;</span>
			}

			int i; // loop counter for nNumberToGet
<span class="nc bnc" id="L416" title="All 4 branches missed.">			if (eTimeFrame == SchedulingPeriod.PastOnly || eTimeFrame == SchedulingPeriod.PastAndFuture) {</span>
				// query past scheduling periods
<span class="nc" id="L418">				String query = &quot;SELECT sp.sid, &quot; + &quot;   sp.id AS deid, &quot; + &quot;   parentspid, &quot; + &quot;   sp.name, &quot;</span>
						+ &quot;   sp.description, &quot; + &quot;   sp.minphantoms, &quot; + &quot;   sp.maxphantoms, &quot; + &quot;   fromdate, &quot;
						+ &quot;   todate, &quot; + &quot;   isskillbased, &quot; + &quot;   sp.alloweditingofar, &quot; + &quot;   sp.ismanualarmode, &quot;
						+ &quot;   sp.isusingallemployees, &quot; + &quot;   campaign.sid AS csid &quot; + &quot;FROM sp,campaign &quot;
						+ &quot;WHERE campaign.id = campaignid AND campaign.sid = &quot; + idCampaign + &quot;   AND fromdate &lt;= '&quot;
<span class="nc" id="L423">						+ JdmoUtil.formatDBString(dtDate) + &quot;' ORDER BY fromdate DESC&quot;;</span>
<span class="nc" id="L424">				r = m_dmo.createRowset(query);</span>

				// Create skill entities from result set
<span class="nc" id="L427">				i = 0;</span>
<span class="nc bnc" id="L428" title="All 4 branches missed.">				while (r.next() &amp;&amp; i++ &lt; nNumberToGet) {</span>
<span class="nc" id="L429">					SchedulingPeriod sp = getSchedulingPeriodFromRowset(r, null);</span>

					//aIDs.add(idSP1);
<span class="nc" id="L432">					aIDs.add(sp.getID());</span>
<span class="nc" id="L433">					resultSchedulingPeriods.add(sp);</span>
<span class="nc" id="L434">				}</span>

<span class="nc" id="L436">				r.close();</span>
			}
<span class="nc bnc" id="L438" title="All 4 branches missed.">			if (eTimeFrame == SchedulingPeriod.FutureOnly || eTimeFrame == SchedulingPeriod.PastAndFuture) {</span>

				// query future scheduling periods
<span class="nc" id="L441">				String query = &quot;SELECT sp.sid, &quot; + &quot;   sp.id AS deid, &quot; + &quot;   parentspid, &quot; + &quot;   sp.name, &quot;</span>
						+ &quot;   sp.description, &quot; + &quot;   fromdate, &quot; + &quot;   todate, &quot; + &quot;   isskillbased, &quot; + &quot;   minphantoms, &quot;
						+ &quot;   maxphantoms, &quot; + &quot;   sp.alloweditingofar, &quot;
						+ &quot;   sp.ismanualarmode, &quot;
						+ &quot;   sp.isusingallemployees, &quot;
						+ &quot;   campaign.sid AS csid &quot; + &quot;FROM sp,campaign &quot;
						+ &quot;WHERE campaign.id = campaignid and campaign.sid = &quot; + idCampaign + &quot;   AND fromdate &gt;= '&quot;
<span class="nc" id="L448">						+ JdmoUtil.formatDBString(dtDate) + &quot;'ORDER BY fromdate ASC&quot;;</span>
<span class="nc" id="L449">				r = m_dmo.createRowset(query);</span>

				// Create scheduling period entities from result set
<span class="nc" id="L452">				i = 0;</span>
<span class="nc bnc" id="L453" title="All 4 branches missed.">				while (r.next() &amp;&amp; i++ &lt; nNumberToGet) {</span>
<span class="nc" id="L454">					SchedulingPeriod sp = getSchedulingPeriodFromRowset(r, null);</span>

<span class="nc bnc" id="L456" title="All 2 branches missed.">					if (!aIDs.contains(sp.getID())) {</span>
<span class="nc" id="L457">						resultSchedulingPeriods.add(sp);</span>
					}
<span class="nc" id="L459">				}</span>
			}
<span class="nc" id="L461">			return resultSchedulingPeriods;</span>

<span class="nc" id="L463">		} catch (JdmoException e) {</span>
<span class="nc" id="L464">			e.printStackTrace();</span>
<span class="nc" id="L465">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L467">			try {</span>
<span class="nc" id="L468">				r.close();</span>
<span class="nc" id="L469">			} catch (Exception e) {</span>
<span class="nc" id="L470">			}</span>
<span class="nc" id="L471">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * Creates a SchedulingPeriod object from the information in the current row of
	 * the given JdmoRowset.  If a TimeZone object is passed as well, the scheduling
	 * period will have its Start/End local times set as well.
	 *
	 * @param rowSet - The current record will be used to create the object
	 * @param tz     - (optional) If non-null, will set the start/end local time fields on the returned object.
	 * @return A SchedulingPeriod value object that is set with the values in the current record in JdmoRowset.
	 */
	SchedulingPeriod getSchedulingPeriodFromRowset(JdmoRowset rowSet, TimeZone tz) throws JdmoException, BbmFinderException {
<span class="nc" id="L485">		ID deid = ID.fromString(rowSet.getString(&quot;DEID&quot;));</span>
<span class="nc" id="L486">		ID idSP = rowSet.getID(&quot;SID&quot;);</span>
<span class="nc" id="L487">		ID idCampaign = rowSet.getID(&quot;CSID&quot;);</span>
<span class="nc" id="L488">		Date dtStart = rowSet.getTimestamp(&quot;FROMDATE&quot;);</span>
<span class="nc" id="L489">		Date dtEnd = rowSet.getTimestamp(&quot;TODATE&quot;);</span>
<span class="nc" id="L490">		boolean bSkillBased = rowSet.getBoolean(&quot;ISSKILLBASED&quot;);</span>
<span class="nc" id="L491">		String strName = rowSet.getString(&quot;NAME&quot;);</span>
<span class="nc" id="L492">		String strDesc = rowSet.getString(&quot;DESCRIPTION&quot;);</span>
<span class="nc" id="L493">		int minPhantoms = rowSet.getInt(&quot;MINPHANTOMS&quot;);</span>
<span class="nc" id="L494">		int maxPhantoms = rowSet.getInt(&quot;MAXPHANTOMS&quot;);</span>
<span class="nc" id="L495">		ID parentSPID = rowSet.getID(&quot;PARENTSPID&quot;);</span>
<span class="nc" id="L496">		boolean allowEditingOfAR = rowSet.getBoolean(&quot;ALLOWEDITINGOFAR&quot;);</span>
<span class="nc" id="L497">		boolean isManualARMode = rowSet.getBoolean(&quot;ISMANUALARMODE&quot;);</span>
<span class="nc" id="L498">		boolean isUsingAllEmployees = rowSet.getBoolean(&quot;ISUSINGALLEMPLOYEES&quot;);</span>

<span class="nc" id="L500">		SchedulingPeriod sp = new SchedulingPeriod();</span>
<span class="nc" id="L501">		sp.setDEID(deid);</span>
<span class="nc" id="L502">		sp.setID(idSP);</span>
<span class="nc" id="L503">		sp.setStartTime(dtStart);</span>
<span class="nc" id="L504">		sp.setEndTime(dtEnd);</span>
<span class="nc" id="L505">		sp.setCampaignID(idCampaign);</span>
<span class="nc" id="L506">		sp.setSkillBased(bSkillBased);</span>
<span class="nc" id="L507">		sp.setName(strName);</span>
<span class="nc" id="L508">		sp.setDescription(strDesc);</span>
<span class="nc" id="L509">		sp.setMinPhantoms(minPhantoms);</span>
<span class="nc" id="L510">		sp.setMaxPhantoms(maxPhantoms);</span>
<span class="nc" id="L511">		sp.setParentSPID(parentSPID);</span>
<span class="nc" id="L512">		sp.setIsEditingOfFteRequirementsAllowed(allowEditingOfAR);</span>
<span class="nc" id="L513">		sp.setManualFteRequirementsMode(isManualARMode);</span>
<span class="nc" id="L514">		sp.setUsingAllEmployees(isUsingAllEmployees);</span>

<span class="nc bnc" id="L516" title="All 2 branches missed.">		if (tz != null) {</span>
<span class="nc" id="L517">			sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), tz));</span>
<span class="nc" id="L518">			sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), tz));</span>
		}

<span class="nc" id="L521">		return sp;</span>
	}

	/**
	 * Returns the scheduling period for the given scheduling period ID. Returns
	 * null if no scheduling period with the given ID was found.
	 */
	public SchedulingPeriod getSchedulingPeriodByID(ID spSID) throws BbmFinderException, BbmObjectNotFoundException {
<span class="nc" id="L529">		Collection&lt;SchedulingPeriod&gt; sps = getSchedulingPeriodsByIDs(Collections.singleton(spSID));</span>
<span class="nc bnc" id="L530" title="All 4 branches missed.">		if (sps != null &amp;&amp; sps.isEmpty() == false) {</span>
<span class="nc" id="L531">			return sps.iterator().next();</span>
		}
<span class="nc" id="L533">		return null;</span>
	}

	/**
	 * Returns a collection of scheduling periods for the given scheduling
	 * period IDs. Returns an empty collection if no scheduling periods were
	 * found with any of the given IDs.
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByIDs(Collection&lt;ID&gt; spIDs) throws BbmFinderException {
		// load sp, but local time not set yet
<span class="nc" id="L543">		Collection&lt;SchedulingPeriod&gt; sps = getObjectsByIDs(spIDs);</span>
<span class="nc" id="L544">		Collection&lt;ID&gt; campaignDEIDs = ValueObjectUtil.getFieldObjectCol(SchedulingPeriodFieldInfo.SP_CAMPAIGNID, sps);</span>

		// Set the SID of the campaign on each SP value object (replacing the
		// campaign DEID, which should
		// be hidden from client code).
<span class="nc" id="L549">		Map&lt;ID, ID&gt; campaignDEIDToSIDMap = DAOUtil.mapIDsToSIDs(campaignDEIDs, new CampaignFieldInfo());</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">		for (SchedulingPeriod sp : sps) {</span>
<span class="nc" id="L551">			sp.setCampaignID(campaignDEIDToSIDMap.get(sp.getCampaignID()));</span>
<span class="nc" id="L552">		}</span>

		// retrieve time zone, in order to calculate local time
<span class="nc" id="L555">		CampaignDAO dao = new CampaignDAO(getDMO());</span>

<span class="nc" id="L557">		Map&lt;ID, TimeZone&gt; tzMap = dao.getTimeZonesByCampaignIDs(ValueObjectUtil.getFieldObjectCol(</span>
				SchedulingPeriodFieldInfo.SP_CAMPAIGNID, sps));

		// set local time on each SP
<span class="nc bnc" id="L561" title="All 2 branches missed.">		for (SchedulingPeriod sp : sps) {</span>
<span class="nc" id="L562">			TimeZone tz = tzMap.get(sp.getCampaignID());</span>
<span class="nc" id="L563">			sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), tz));</span>
<span class="nc" id="L564">			sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), tz));</span>
<span class="nc" id="L565">		}</span>

<span class="nc" id="L567">		return sps;</span>
	}

	/**
	 * Returns the scheduling periods associated to the given SPQueues. The
	 * returned value is a map of scheduling period -&gt; collection of SP Queues
	 * belonging to the scheduling period.
	 *
	 * @param spQueues - the SPQueues for which we would like to retrieve their
	 *                 associated scheduling periods.
	 * @return Map of scheduling period -&gt; collection of associated SPQueues
	 */
	public Map&lt;SchedulingPeriod, Collection&lt;SPQueue&gt;&gt; getSchedulingPeriodsForSPQueues(Collection&lt;SPQueue&gt; spQueues)
			throws BbmFinderException {
<span class="nc" id="L581">		Map&lt;SchedulingPeriod, Collection&lt;SPQueue&gt;&gt; retVal = new HashMap&lt;SchedulingPeriod, Collection&lt;SPQueue&gt;&gt;();</span>
<span class="nc" id="L582">		HashSet&lt;ID&gt; spIDs = new HashSet&lt;ID&gt;(ValueObjectUtil.getFieldObjectCol(SPQueueFieldInfo.SPQUEUE_SPID, spQueues));</span>
<span class="nc" id="L583">		Collection&lt;SchedulingPeriod&gt; sps = getSchedulingPeriodsByIDs(spIDs);</span>
<span class="nc" id="L584">		Map&lt;ID, SchedulingPeriod&gt; spIDMap = ValueObjectUtil.getIDObjectMap(sps);</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">		for (SPQueue spQueue : spQueues) {</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">			if (retVal.containsKey(spIDMap.get(spQueue.getSpID())) == false) {</span>
<span class="nc" id="L587">				retVal.put(spIDMap.get(spQueue.getSpID()), new ArrayList&lt;SPQueue&gt;());</span>
			}
<span class="nc" id="L589">			retVal.get(spIDMap.get(spQueue.getSpID())).add(spQueue);</span>
<span class="nc" id="L590">		}</span>
<span class="nc" id="L591">		return retVal;</span>
	}

	public void linkWorkResourcesToSchedulingPeriod(ID spID, Collection&lt;ID&gt; wkrsIDs) throws BbmCreateException {
		try {
<span class="nc bnc" id="L596" title="All 4 branches missed.">			if (wkrsIDs == null || wkrsIDs.isEmpty()) {</span>
<span class="nc" id="L597">				return;</span>
			}
<span class="nc" id="L599">			ID id = null;</span>
<span class="nc" id="L600">			HashMap&lt;String, Object&gt; nameValues = new HashMap&lt;String, Object&gt;();</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">			for (Iterator&lt;ID&gt; i = wkrsIDs.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L602">				id = i.next();</span>
<span class="nc" id="L603">				nameValues.clear();</span>
<span class="nc" id="L604">				nameValues.put(&quot;SPID&quot;, spID.toString());</span>
<span class="nc" id="L605">				nameValues.put(&quot;WORKRESOURCEID&quot;, id);</span>
<span class="nc" id="L606">				m_dmo.addBatchInsert(&quot;SPWORKRESOURCE&quot;, nameValues);</span>
			}
<span class="nc" id="L608">			m_dmo.executeBatch();</span>
<span class="nc" id="L609">		} catch (JdmoException e) {</span>
<span class="nc" id="L610">			throw new BbmCreateException(e);</span>
<span class="nc" id="L611">		}</span>

<span class="nc" id="L613">	}</span>

	public ID getParentSchedulingPeriodID(ID subSPID) throws BbmFinderException {
<span class="nc" id="L616">		JdmoRowset r = null;</span>
		try {
<span class="nc" id="L618">			String query = &quot;SELECT SID FROM SP WHERE ID in (SELECT PARENTSPID FROM SP WHERE SID = &quot; + subSPID + &quot;)&quot;;</span>
<span class="nc" id="L619">			r = m_dmo.createRowset(query);</span>

<span class="nc bnc" id="L621" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L622">				return r.getID(&quot;SID&quot;);</span>
			}
<span class="nc" id="L624">			return null;</span>
<span class="nc" id="L625">		} catch (JdmoException e) {</span>
<span class="nc" id="L626">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L628">			try {</span>
<span class="nc" id="L629">				r.close();</span>
<span class="nc" id="L630">			} catch (Exception e) {</span>
<span class="nc" id="L631">			}</span>
		}
	}

	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(Campaign campaign) throws BbmFinderException {

		try {
<span class="nc" id="L638">			List&lt;Campaign&gt; campaigns = new ArrayList&lt;Campaign&gt;();</span>
<span class="nc" id="L639">			campaigns.add(campaign);</span>
<span class="nc" id="L640">			return getSchedulingPeriods(campaigns);</span>
<span class="nc" id="L641">		} catch (Exception e) {</span>
<span class="nc" id="L642">			throw new BbmFinderException(e);</span>
		}
	}

	/**
	 * Returns a Collection of SchedulingPeriods belonging to the input
	 * collection of Campaigns
	 *
	 * @param campaigns
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(Collection&lt;Campaign&gt; campaigns) throws BbmFinderException {

<span class="nc bnc" id="L656" title="All 4 branches missed.">		if (campaigns == null || campaigns.size() == 0) {</span>
<span class="nc" id="L657">			return new ArrayList&lt;SchedulingPeriod&gt;();</span>
		}
<span class="nc" id="L659">		Collection&lt;ID&gt; campaignIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">		for (Campaign campaign : campaigns) {</span>
<span class="nc" id="L661">			campaignIDs.add(campaign.getID());</span>
<span class="nc" id="L662">		}</span>

<span class="nc" id="L664">		return getSchedulingPeriodsByCampaignIDs(campaignIDs, campaigns);</span>
	}

	/**
	 * @param campaignIDs the campaigns whose scheduling periods are to be loaded
	 * @param campaigns   can be empty, although startTimeLocal, endTimeLocal will not
	 *                    be set
	 * @return
	 * @throws BbmFinderException
	 * @deprecated instead @see getSchedulingPeriodsByCampaignIDs(Collection&lt;ID&gt;
	 * campaignIDs,Date minDate, Date maxDate) Returns a Collection
	 * of SchedulingPeriods belonging to the input collection of
	 * Campaigns
	 */
	@Deprecated
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByCampaignIDs(Collection&lt;ID&gt; campaignIDs,
			Collection&lt;Campaign&gt; campaigns) throws BbmFinderException {
		try {
<span class="nc" id="L682">			ArrayList&lt;SchedulingPeriod&gt; sps = new ArrayList&lt;SchedulingPeriod&gt;();</span>

<span class="nc" id="L684">			StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L685">			sb.append(&quot;SELECT sp.sid AS ID, campaign.sid AS CAMPAIGNID, sp.fromdate AS FROMDATE, sp.todate AS TODATE, sp.ISSKILLBASED, sp.ISMANUALARMODE, sp.isusingallemployees, sp.id AS deid &quot;);</span>
<span class="nc" id="L686">			sb.append(&quot;FROM sp, campaign WHERE sp.campaignid = campaign.id AND campaign.sid in &quot;);</span>
<span class="nc" id="L687">			sb.append(m_dmo.createInClause(campaignIDs));</span>

<span class="nc" id="L689">			JdmoRowset rs = m_dmo.createRowset(sb.toString());</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L691">				SchedulingPeriod sp = new SchedulingPeriod();</span>
<span class="nc" id="L692">				sp.setID(rs.getID(1));</span>
<span class="nc" id="L693">				sp.setCampaignID(rs.getID(2));</span>
<span class="nc" id="L694">				sp.setStartTime(rs.getTimestamp(3));</span>
<span class="nc" id="L695">				sp.setEndTime(rs.getTimestamp(4));</span>
<span class="nc" id="L696">				sp.setSkillBased(rs.getBoolean(5));</span>
<span class="nc" id="L697">				Campaign campaign = getCampaignByID(campaigns, sp.getCampaignID());</span>

<span class="nc bnc" id="L699" title="All 2 branches missed.">				if (campaign != null) {</span>
<span class="nc" id="L700">					TimeZone tz = campaign.getTimeZone();</span>
<span class="nc" id="L701">					sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), tz));</span>
<span class="nc" id="L702">					sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), tz));</span>
				}
<span class="nc" id="L704">				sp.setManualFteRequirementsMode(rs.getBoolean(6));</span>
<span class="nc" id="L705">				sp.setUsingAllEmployees(rs.getBoolean(7));</span>
<span class="nc" id="L706">				sp.setDEID(ID.fromString(rs.getString(8)));</span>
<span class="nc" id="L707">				sps.add(sp);</span>
<span class="nc" id="L708">			}</span>
<span class="nc" id="L709">			return sps;</span>
<span class="nc" id="L710">		} catch (Exception e) {</span>
<span class="nc" id="L711">			throw new BbmFinderException(e);</span>
		}
	}

	/**
	 * @throws BbmFinderException
	 * @returns the campaigns' associated scheduling periods that fall within
	 * the date range
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByCampaignIDs(Collection&lt;ID&gt; campaignIDs, Date minDate,
			Date maxDate) throws BbmFinderException {
<span class="nc" id="L722">		ArrayList&lt;SchedulingPeriod&gt; sps = new ArrayList&lt;SchedulingPeriod&gt;();</span>
<span class="nc" id="L723">		JdmoRowset rs = null;</span>
		try {
<span class="nc" id="L725">			String query = &quot;SELECT c.sid AS c_sid, sp.sid AS sp_sid, sp.fromdate AS FROMDATE, sp.todate AS TODATE, sp.ISSKILLBASED, tzmap.javatzident, sp.ISMANUALARMODE, sp.isusingallemployees, sp.id AS sp_deid \n&quot;</span>
					+ &quot;FROM campaign c \n&quot;
					+ &quot;INNER JOIN sp sp \n&quot;
					+ &quot;	ON sp.campaignid = c.id \n&quot;
					+ &quot;	AND sp.fromdate &lt;= '&quot;
<span class="nc" id="L730">					+ JdmoUtil.formatDBString(maxDate)</span>
					+ &quot;' \n&quot;
					+ &quot;	AND sp.todate &gt;= '&quot;
<span class="nc" id="L733">					+ JdmoUtil.formatDBString(minDate)</span>
					+ &quot;' \n&quot;
					+ &quot;LEFT JOIN TIMEZONE tz \n&quot;
					+ &quot;	on tz.ID = c.TIMEZONEID \n&quot;
					+ &quot;LEFT JOIN TIMEZONEMAP tzmap \n&quot;
<span class="nc" id="L738">					+ &quot;	on tzmap.WINTZSTDNAME = tz.STANDARDNAME \n&quot; + &quot;WHERE c.sid IN &quot; + m_dmo.createInClause(campaignIDs);</span>
<span class="nc" id="L739">			rs = m_dmo.createRowset(query);</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L741">				SchedulingPeriod sp = new SchedulingPeriod();</span>
<span class="nc" id="L742">				sp.setCampaignID(rs.getID(1));</span>
<span class="nc" id="L743">				sp.setID(rs.getID(2));</span>
<span class="nc" id="L744">				sp.setStartTime(rs.getTimestamp(3));</span>
<span class="nc" id="L745">				sp.setEndTime(rs.getTimestamp(4));</span>
<span class="nc" id="L746">				sp.setSkillBased(rs.getBoolean(5));</span>
<span class="nc" id="L747">				String timeZoneID = rs.getString(6);</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">				if (timeZoneID != null) {</span>
<span class="nc" id="L749">					TimeZone timeZone = TimeZone.getTimeZone(timeZoneID);</span>
<span class="nc" id="L750">					sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), timeZone));</span>
<span class="nc" id="L751">					sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), timeZone));</span>
				}
<span class="nc" id="L753">				sp.setManualFteRequirementsMode(rs.getBoolean(7));</span>
<span class="nc" id="L754">				sp.setUsingAllEmployees(rs.getBoolean(8));</span>
<span class="nc" id="L755">				sp.setDEID(ID.fromString(rs.getString(9)));</span>
<span class="nc" id="L756">				sps.add(sp);</span>
<span class="nc" id="L757">			}</span>
<span class="nc" id="L758">			return sps;</span>
<span class="nc" id="L759">		} catch (Exception e) {</span>
<span class="nc" id="L760">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L762">			try {</span>
<span class="nc" id="L763">				rs.close();</span>
<span class="nc" id="L764">			} catch (Exception e) {</span>
<span class="nc" id="L765">			}</span>
<span class="nc" id="L766">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * @param campaignIDs the campaign IDs whose scheduling periods counts we want to
	 *                    know
	 * @return A map from campaign's SID to the count of scheduling periods
	 * attached to it
	 * @throws BbmFinderException
	 */
	public Map&lt;ID, Integer&gt; getCampaignIDAttachedSchedulingPeriodCountMap(Collection&lt;ID&gt; campaignIDs)
			throws BbmFinderException {

<span class="nc" id="L780">		Map&lt;ID, Integer&gt; campaignIDAttachedSchedulingPeriodCountMap = new HashMap&lt;ID, Integer&gt;();</span>

		// Build the query, noting that case statement is needed so that
		// campaigns with no sps aren't counted as having one by mistake.
		String query;
		try {
<span class="nc" id="L786">			query = &quot;SELECT c.sid, SUM(CASE WHEN sp.ID is not null THEN 1 ELSE 0 END) AS schedulingPeriodCount \n&quot;</span>
					+ &quot;FROM campaign c \n&quot; + &quot;LEFT JOIN sp sp \n&quot; + &quot;  ON sp.campaignid = c.id \n&quot; + &quot;WHERE c.sid in &quot;
<span class="nc" id="L788">					+ m_dmo.createInClause(campaignIDs) + &quot;GROUP BY c.sid&quot;;</span>
<span class="nc" id="L789">		} catch (JdmoException e) {</span>
<span class="nc" id="L790">			throw new BbmFinderException(e);</span>
<span class="nc" id="L791">		}</span>

		// Execute the query, converting the result set to a map
<span class="nc" id="L794">		JdmoRowset rs = null;</span>
		try {
<span class="nc" id="L796">			rs = m_dmo.createRowset(query);</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L798">				ID campaignSID = rs.getID(&quot;sid&quot;);</span>
<span class="nc" id="L799">				Integer schedulingPeriodCount = rs.getInt(&quot;schedulingPeriodCount&quot;);</span>
<span class="nc" id="L800">				campaignIDAttachedSchedulingPeriodCountMap.put(campaignSID, schedulingPeriodCount);</span>
<span class="nc" id="L801">			}</span>
<span class="nc" id="L802">		} catch (JdmoException e) {</span>
<span class="nc" id="L803">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L805">			try {</span>
<span class="nc bnc" id="L806" title="All 4 branches missed.">				if (rs != null) {</span>
<span class="nc" id="L807">					rs.close();</span>
				}
<span class="nc" id="L809">			} catch (Exception e) {</span>
<span class="nc" id="L810">			}</span>
<span class="nc" id="L811">		}</span>
<span class="nc" id="L812">		return campaignIDAttachedSchedulingPeriodCountMap;</span>
	}

	/**
	 * @param campaigns
	 * @param campaignID
	 * @return
	 * @Deprecated not safe when white space is in the ID see getCampaignByID
	 */
	@Deprecated
	private Campaign getCampaignFromCollection(Collection&lt;Campaign&gt; campaigns, ID campaignID) {
<span class="nc bnc" id="L823" title="All 2 branches missed.">		for (Campaign campaign : campaigns) {</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">			if (campaign.getID().equals(campaignID)) {</span>
<span class="nc" id="L825">				return campaign;</span>
			}
<span class="nc" id="L827">		}</span>
<span class="nc" id="L828">		return null;</span>
	}

	private Campaign getCampaignByID(Collection&lt;Campaign&gt; campaigns, ID campaignID) {
<span class="nc bnc" id="L832" title="All 2 branches missed.">		for (Campaign campaign : campaigns) {</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">			if (campaign.getID().toString().trim().equals(campaignID.toString().trim())) {</span>
<span class="nc" id="L834">				return campaign;</span>
			}
<span class="nc" id="L836">		}</span>
<span class="nc" id="L837">		return null;</span>
	}

	public void linkOrgsToSP(ID parentSPID, ID SPID, Collection&lt;ID&gt; colOrgIDs) throws BbmCreateException {
<span class="nc" id="L841">		Jdmo jdmo = new Jdmo();</span>
		try {
			// check if orgs are already linked to other subcampaign
<span class="nc bnc" id="L844" title="All 2 branches missed.">			if (parentSPID != null) {</span>
<span class="nc" id="L845">				Collection&lt;ID&gt; ids = getSubSPIDs(parentSPID);</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">				for (ID subID : ids) {</span>
<span class="nc bnc" id="L847" title="All 4 branches missed.">					if (subID != null &amp;&amp; !subID.equals(SPID)) {</span>
<span class="nc" id="L848">						Collection&lt;ID&gt; orgs = getLinkedOrgsforSP(subID);</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">						for (ID subOrgID : orgs) {</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">							if (colOrgIDs.contains(subOrgID)) {</span>
<span class="nc" id="L851">								String orgName = null;</span>
<span class="nc" id="L852">								String queryOrg = &quot;select NAME from Organization where ID =&quot; + subOrgID;</span>
<span class="nc" id="L853">								JdmoRowset rowSet = m_dmo.createRowset(queryOrg);</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">								while (rowSet.next()) {</span>
<span class="nc" id="L855">									orgName = rowSet.getString(&quot;NAME&quot;);</span>
									break;
								}
<span class="nc bnc" id="L858" title="All 2 branches missed.">								if (orgName != null) {</span>
<span class="nc" id="L859">									Object[] args = new Object[1];</span>
<span class="nc" id="L860">									args[0] = orgName;</span>
<span class="nc" id="L861">									throw new BbmCreateException(BbmEjbBundleKey.BUNDLE_NAME,</span>
											BbmEjbBundleKey.INVALID_ORG_TO_SP_LINKING, args);
								}
							}
<span class="nc" id="L865">						}</span>
					}
<span class="nc" id="L867">				}</span>
			}

<span class="nc" id="L870">			Collection&lt;ID&gt; curOrgs = getLinkedOrgsforSP(SPID);</span>
<span class="nc" id="L871">			HashSet&lt;ID&gt; newOrgs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L872">			HashSet&lt;ID&gt; deleteOrgs = new HashSet&lt;ID&gt;();</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">			for (ID id : curOrgs) {</span>
<span class="nc bnc" id="L874" title="All 2 branches missed.">				if (!colOrgIDs.contains(id)) {</span>
<span class="nc" id="L875">					deleteOrgs.add(id);</span>
				}
<span class="nc" id="L877">			}</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">			for (ID id : colOrgIDs) {</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">				if (!curOrgs.contains(id)) {</span>
<span class="nc" id="L880">					newOrgs.add(id);</span>
				}
<span class="nc" id="L882">			}</span>

			JdmoQuery jQuery;
<span class="nc" id="L885">			ID spDEID = getDEIDFromSID(&quot;SP&quot;, SPID);</span>

<span class="nc bnc" id="L887" title="All 2 branches missed.">			if (deleteOrgs.size() &gt; 0) {</span>
<span class="nc" id="L888">				jdmo.insertIDs(&quot;orgIdsTempTable&quot;, deleteOrgs);</span>
<span class="nc" id="L889">				jQuery = jdmo.createQuery(&quot;PTE_DELETE_ORGS_FROM_SP&quot;, Jdmo.STORPROC_QUERY_NORS);</span>
<span class="nc" id="L890">				jQuery.setParString(1, spDEID.toString()); // source start</span>
<span class="nc" id="L891">				jdmo.execute(jQuery);</span>
			}

<span class="nc bnc" id="L894" title="All 2 branches missed.">			for (ID orgID : newOrgs) {</span>
<span class="nc" id="L895">				linkOrgToSP(SPID, orgID);</span>
<span class="nc" id="L896">			}</span>

<span class="nc" id="L898">		} catch (JdmoException ex) {</span>
<span class="nc" id="L899">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L900">		} catch (BbmFinderException ex) {</span>
<span class="nc" id="L901">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L902">		} catch (BbmCreateException ex) {</span>
<span class="nc" id="L903">			throw ex;</span>
		} finally {
<span class="nc bnc" id="L905" title="All 4 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L906">				jdmo.cleanUp();</span>
			}
		}
<span class="nc" id="L909">	}</span>

	private void linkOrgToSP(ID SPID, ID orgID) throws BbmCreateException {
<span class="nc" id="L912">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L914">			String idStr = DAOUtil.getDEID(jdmo);</span>
<span class="nc" id="L915">			ID spDEID = getDEIDFromSID(&quot;SP&quot;, SPID);</span>
<span class="nc" id="L916">			ID createdID = new ID(idStr);</span>
<span class="nc" id="L917">			String strCreate = &quot;INSERT into SPCALLCENTER (ID, ORGANIZATIONID, SPID) values ('&quot; + createdID + &quot;', '&quot; + orgID</span>
					+ &quot;', '&quot; + spDEID + &quot;')&quot;;
<span class="nc" id="L919">			jdmo.executeCommand(strCreate);</span>
<span class="nc" id="L920">		} catch (JdmoException ex) {</span>
<span class="nc" id="L921">			throw new BbmCreateException(ex);</span>
		} finally {
<span class="nc bnc" id="L923" title="All 4 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L924">				jdmo.cleanUp();</span>
			}
		}
<span class="nc" id="L927">	}</span>

	public Collection&lt;ID&gt; getLinkedOrgsforSP(ID SPID) throws BbmFinderException {

<span class="nc" id="L931">		List&lt;ID&gt; organizatonIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L932">		boolean isParentCampaign = false;</span>
<span class="nc" id="L933">		JdmoRowset r = null;</span>
		try {

			// Decide whether this is a parent of another scheduling period
<span class="nc" id="L937">			ID DEID = getDEIDFromSID(&quot;SP&quot;, SPID);</span>
<span class="nc" id="L938">			String queryParentSP = &quot;SELECT ID FROM SP WHERE PARENTSPID = '&quot; + DEID + &quot;'&quot;;</span>
<span class="nc" id="L939">			JdmoRowset rowSet = m_dmo.createRowset(queryParentSP);</span>
<span class="nc bnc" id="L940" title="All 2 branches missed.">			while (rowSet.next()) {</span>
<span class="nc" id="L941">				isParentCampaign = true;</span>
				break;
			}

			// Query for linked organizatons
<span class="nc" id="L946">			String query = &quot;SELECT ORGANIZATIONID FROM SPCALLCENTER WHERE SPID = '&quot; + DEID + &quot;'&quot;;</span>
			// it's possible it's a parent sp of an distributed campaign, this
			// query will return empty sets for
			// non-distributed and child sp.
<span class="nc bnc" id="L950" title="All 2 branches missed.">			if (isParentCampaign) {</span>
<span class="nc" id="L951">				query = &quot;SELECT ORGANIZATIONID FROM SPCALLCENTER WHERE SPID IN (SELECT ID FROM SP WHERE PARENTSPID = '&quot;</span>
						+ DEID + &quot;')&quot;;
			}

<span class="nc" id="L955">			r = m_dmo.createRowset(query);</span>

<span class="nc bnc" id="L957" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L958">				ID orgID = new ID(r.getString(&quot;ORGANIZATIONID&quot;));</span>
<span class="nc" id="L959">				organizatonIDs.add(orgID);</span>
<span class="nc" id="L960">			}</span>

<span class="nc" id="L962">			return organizatonIDs;</span>
<span class="nc" id="L963">		} catch (JdmoException e) {</span>
<span class="nc" id="L964">			e.printStackTrace();</span>
<span class="nc" id="L965">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L967">			try {</span>
<span class="nc" id="L968">				r.close();</span>
<span class="nc" id="L969">			} catch (Exception e) {</span>
<span class="nc" id="L970">			}</span>
<span class="nc" id="L971">			m_dmo.cleanUp();</span>
		}
	}

	public Collection&lt;ID&gt; getLinkedOrgsforSP(ID SPID, Collection &lt;ID&gt; orgs) throws BbmFinderException {

<span class="nc" id="L977">		List&lt;ID&gt; organizatonIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L978">		boolean isParentCampaign = false;</span>
<span class="nc" id="L979">		JdmoRowset r = null;</span>
		try {

			// Decide whether this is a parent of another scheduling period
<span class="nc" id="L983">			ID DEID = getDEIDFromSID(&quot;SP&quot;, SPID);</span>
<span class="nc" id="L984">			String queryParentSP = &quot;SELECT ID FROM SP WHERE PARENTSPID = '&quot; + DEID + &quot;'&quot;;</span>
<span class="nc" id="L985">			JdmoRowset rowSet = m_dmo.createRowset(queryParentSP);</span>
<span class="nc bnc" id="L986" title="All 2 branches missed.">			while (rowSet.next()) {</span>
<span class="nc" id="L987">				isParentCampaign = true;</span>
				break;
			}

			// Query for linked organizatons
<span class="nc" id="L992">			String query = &quot;SELECT ORGANIZATIONID FROM SPCALLCENTER WHERE SPID = '&quot; + DEID + &quot;'&quot;;</span>
			// it's possible it's a parent sp of an distributed campaign, this
			// query will return empty sets for
			// non-distributed and child sp.
<span class="nc bnc" id="L996" title="All 2 branches missed.">			if (isParentCampaign) {</span>
<span class="nc" id="L997">				query = &quot;SELECT ORGANIZATIONID FROM SPCALLCENTER WHERE SPID IN (SELECT ID FROM SP WHERE PARENTSPID = '&quot;</span>
						+ DEID + &quot;')&quot;;
			}
			
			// Adds the orgs to filter
<span class="nc" id="L1002">			query += &quot; AND ORGANIZATIONID in &quot; + m_dmo.createInClause(orgs);</span>

<span class="nc" id="L1004">			r = m_dmo.createRowset(query);</span>

<span class="nc bnc" id="L1006" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L1007">				ID orgID = new ID(r.getString(&quot;ORGANIZATIONID&quot;));</span>
<span class="nc" id="L1008">				organizatonIDs.add(orgID);</span>
<span class="nc" id="L1009">			}</span>

<span class="nc" id="L1011">			return organizatonIDs;</span>
<span class="nc" id="L1012">		} catch (JdmoException e) {</span>
<span class="nc" id="L1013">			e.printStackTrace();</span>
<span class="nc" id="L1014">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1016">			try {</span>
<span class="nc" id="L1017">				r.close();</span>
<span class="nc" id="L1018">			} catch (Exception e) {</span>
<span class="nc" id="L1019">			}</span>
<span class="nc" id="L1020">			m_dmo.cleanUp();</span>
		}
	}

	public void unlinkWorkResourcesToSchedulingPeriod(ID SPID, ID SPDEID, Collection&lt;ID&gt; wkrsIDs) throws BbmRemoveException {
<span class="nc" id="L1025">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L1027" title="All 4 branches missed.">			if (wkrsIDs == null || wkrsIDs.isEmpty()) {</span>
<span class="nc" id="L1028">				return;</span>
			}
<span class="nc" id="L1030">			String strQuery = &quot;DELETE From SPWORKRESOURCE where SPID = '&quot; + SPDEID.toString() + &quot;' and WORKRESOURCEID in &quot;</span>
<span class="nc" id="L1031">					+ m_dmo.createInClause(wkrsIDs);</span>
<span class="nc" id="L1032">			jdmo.executeCommand(strQuery);</span>

<span class="nc" id="L1034">			strQuery = &quot;update SHIFTASSIGNMENT set SPID = NULL where SPID = &quot; + SPID.toString() + &quot; and WORKRESOURCEID in &quot;</span>
<span class="nc" id="L1035">					+ m_dmo.createInClause(wkrsIDs);</span>
<span class="nc" id="L1036">			jdmo.executeCommand(strQuery);</span>
<span class="nc" id="L1037">		} catch (JdmoException ex) {</span>
<span class="nc" id="L1038">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc bnc" id="L1040" title="All 6 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L1041">				jdmo.cleanUp();</span>
			}
		}

<span class="nc" id="L1045">	}</span>

	public void unlinkShiftAssignmentToSP(ID workresourceId, Date orgChangeDt) throws BbmRemoveException {
<span class="nc" id="L1048">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L1050" title="All 2 branches missed.">			if (workresourceId == null) {</span>
<span class="nc" id="L1051">				return;</span>
			}

<span class="nc" id="L1054">			String strQuery = &quot;update SHIFTASSIGNMENT &quot; + &quot; set SPID = NULL where &quot; + &quot; WORKRESOURCEID = &quot;</span>
<span class="nc" id="L1055">					+ workresourceId.toInt() + &quot; AND SPID IN (SELECT SID FROM SP WHERE FROMDATE &gt;= '&quot;</span>
<span class="nc" id="L1056">					+ JdmoUtil.formatDBString(orgChangeDt) + &quot;')&quot;;</span>

<span class="nc" id="L1058">			jdmo.executeCommand(strQuery);</span>
<span class="nc" id="L1059">		} catch (JdmoException ex) {</span>
<span class="nc" id="L1060">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc bnc" id="L1062" title="All 6 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L1063">				jdmo.cleanUp();</span>
			}
		}

<span class="nc" id="L1067">	}</span>

	public ID CloneSP(TimeZone tz, SchedulingPeriod newSP, Collection&lt;CampaignHOO&gt; spHOOs, CloneSPOptions copyFlags,
			boolean bIgnoreWarnings) throws JdmoException, BbmCloningConflictException, BbmFinderException {
<span class="nc" id="L1071">		ID idTargetSP = null;</span>
		try {
<span class="nc" id="L1073">			Date startGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(newSP.getStartTimeLocal(), tz);</span>
<span class="nc" id="L1074">			Date endGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(newSP.getEndTimeLocal(), tz);</span>
<span class="nc" id="L1075">			newSP.setStartTime(startGMTDt);</span>
<span class="nc" id="L1076">			newSP.setEndTime(endGMTDt);</span>

<span class="nc" id="L1078">			List&lt;ID&gt; copyFromSPIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L1079">			int i = 0;</span>
<span class="nc bnc" id="L1080" title="All 2 branches missed.">			for (CampaignHOO spHOO : spHOOs) {</span>
<span class="nc" id="L1081">				copyFromSPIDs.add(i++, spHOO.getSPID());</span>
<span class="nc" id="L1082">			}</span>
<span class="nc" id="L1083">			int numWeeks = i;</span>
<span class="nc bnc" id="L1084" title="All 2 branches missed.">			boolean bMultiWeek = numWeeks &gt; 1;</span>
<span class="nc" id="L1085">			List&lt;BbmCloningConflict&gt; conflicts = new ArrayList&lt;BbmCloningConflict&gt;();</span>
			BbmCloningConflict conflict;
<span class="nc" id="L1087">			conflict = CheckQueuesInOtherCampaignShowStopper(copyFromSPIDs, startGMTDt, endGMTDt);</span>
<span class="nc bnc" id="L1088" title="All 2 branches missed.">			if (conflict != null) {</span>
<span class="nc" id="L1089">				conflicts.add(conflict);</span>
			}
<span class="nc bnc" id="L1091" title="All 2 branches missed.">			if (bMultiWeek) {</span>
<span class="nc" id="L1092">				conflict = CheckOrgsMatchShowStopper(copyFromSPIDs);</span>
<span class="nc bnc" id="L1093" title="All 2 branches missed.">				if (conflict != null) {</span>
<span class="nc" id="L1094">					conflicts.add(conflict);</span>
				}
<span class="nc" id="L1096">				conflict = CheckQueuesMatchShowStopper(copyFromSPIDs);</span>
<span class="nc bnc" id="L1097" title="All 2 branches missed.">				if (conflict != null) {</span>
<span class="nc" id="L1098">					conflicts.add(conflict);</span>
				}
<span class="nc" id="L1100">				conflict = CheckAllSkillBasedSameWarning(copyFromSPIDs);</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">				if (conflict != null) {</span>
<span class="nc" id="L1102">					conflicts.add(conflict);</span>
				}

			}
			// if show stopper conflicts exist we skip the warning ones.
<span class="nc bnc" id="L1107" title="All 4 branches missed.">			if (conflicts.isEmpty() &amp;&amp; !bIgnoreWarnings) {</span>
				// Apply end date adjustment to prevent clone conflict exceptions when employees from
				// source SP have shift assignments that start exactly at the destination SP's end time
<span class="nc" id="L1110">				conflict = CheckShiftAssignmentsExistWarning(copyFromSPIDs, numWeeks, startGMTDt,</span>
<span class="nc" id="L1111">						DSTConversionUtil.adjustWeekEndGMTDateToMinBefore(endGMTDt, tz));</span>
<span class="nc bnc" id="L1112" title="All 2 branches missed.">				if (conflict != null) {</span>
<span class="nc" id="L1113">					conflicts.add(conflict);</span>
				}
			}
<span class="nc bnc" id="L1116" title="All 4 branches missed.">			if (conflicts != null &amp;&amp; !conflicts.isEmpty()) {</span>
<span class="nc" id="L1117">				BbmCloningConflictException ex = new BbmCloningConflictException(conflicts);</span>
<span class="nc" id="L1118">				throw ex;</span>
			}
<span class="nc" id="L1120">			boolean first = true;</span>
			ID newSPDEID;

<span class="nc" id="L1123">			LocalDate startLD = new LocalDate(newSP.getEndTimeLocal());</span>
<span class="nc" id="L1124">			LocalDate endLD = new LocalDate(newSP.getEndTimeLocal());</span>

<span class="nc" id="L1126">			Calendar currentDate = Calendar.getInstance(tz);</span>
<span class="nc" id="L1127">			currentDate.setTime(newSP.getEndTime());</span>

<span class="nc" id="L1129">			ArrayList&lt;CampaignHOO&gt; al = new ArrayList&lt;CampaignHOO&gt;(spHOOs);</span>
<span class="nc" id="L1130">			ListIterator&lt;CampaignHOO&gt; litr = al.listIterator(al.size());</span>
<span class="nc" id="L1131">			Campaign campaign = new CampaignDAO(getDMO()).getCampaignByID(newSP.getCampaignID(), false);</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">			while (litr.hasPrevious()) {</span>
<span class="nc" id="L1133">				CampaignHOO spHOO = litr.previous();</span>
<span class="nc" id="L1134">				endLD = new LocalDate(startLD);</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">				if (campaign.isMonthly()) {</span>
					// some weeks of monthly SPs may have less than 7 days
<span class="nc" id="L1137">					int numOfDaysToStartWeek = MonthlySPUtil.getNumOfDaysToWeekStartDate(tz, currentDate.getTime(),</span>
<span class="nc" id="L1138">							MonthlySPUtil.getWeekStartDay(campaign.getWeekStart()), startGMTDt);</span>
<span class="nc" id="L1139">					currentDate.add(Calendar.DATE, -numOfDaysToStartWeek);</span>
<span class="nc" id="L1140">					startLD.add(Calendar.DATE, -numOfDaysToStartWeek);</span>
<span class="nc" id="L1141">				} else {</span>
<span class="nc" id="L1142">					startLD.add(Calendar.DATE, -7);</span>
				}
<span class="nc" id="L1144">				newSPDEID = cloneWeek(newSP.getCampaignID(), spHOO, newSP, copyFlags, tz, startLD, endLD);</span>
<span class="nc bnc" id="L1145" title="All 2 branches missed.">				if (first) {</span>
<span class="nc" id="L1146">					first = false;</span>
<span class="nc" id="L1147">					newSP.setDEID(newSPDEID);</span>
				}
<span class="nc" id="L1149">				endLD = startLD;</span>
<span class="nc" id="L1150">			}</span>
<span class="nc" id="L1151">			idTargetSP = getSIDFromDEID(&quot;SP&quot;, newSP.getDEID());</span>
		} finally {
<span class="nc" id="L1153">			m_dmo.cleanUp();</span>
<span class="nc" id="L1154">		}</span>
<span class="nc" id="L1155">		return idTargetSP;</span>
	}

	private int DSTTransitionPeriod(Date startDt, Date endDt, TimeZone tz) {
		// 0-none,1-ends(extrahour),2-begins(lesshour)
<span class="nc" id="L1160">		int DSTFlag = 0;</span>
<span class="nc bnc" id="L1161" title="All 2 branches missed.">		if (tz.inDaylightTime(startDt) != tz.inDaylightTime(endDt)) {</span>

<span class="nc bnc" id="L1163" title="All 2 branches missed.">			if (tz.inDaylightTime(endDt)) {</span>
<span class="nc" id="L1164">				DSTFlag = 2;</span>
			} else {
<span class="nc" id="L1166">				DSTFlag = 1;</span>
			}
		}
<span class="nc" id="L1169">		return DSTFlag;</span>
	}

	private boolean isDateBeginDSTTransition(Date startDt, TimeZone tz) {
<span class="nc" id="L1173">		Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L1174">		cal.setTime(startDt);</span>
<span class="nc" id="L1175">		cal.add(Calendar.HOUR_OF_DAY, -1);</span>
<span class="nc" id="L1176">		Date nextStartDt = cal.getTime();</span>
<span class="nc bnc" id="L1177" title="All 2 branches missed.">		if (tz.inDaylightTime(nextStartDt) != tz.inDaylightTime(startDt)) {</span>
<span class="nc" id="L1178">			return true;</span>
		}

<span class="nc" id="L1181">		return false;</span>
	}

	private Date getDSTTransitionDateTime(Date startDt, Date endDt, TimeZone tz) {
<span class="nc" id="L1185">		Date DSTGMTdt = new Date();</span>
<span class="nc" id="L1186">		DSTGMTdt = endDt;</span>
		Date nextStartDt;
<span class="nc bnc" id="L1188" title="All 4 branches missed.">		while (startDt.before(endDt) || startDt.equals(endDt)) {</span>
<span class="nc" id="L1189">			nextStartDt = addHour(startDt, 1);</span>
<span class="nc bnc" id="L1190" title="All 2 branches missed.">			if (tz.inDaylightTime(nextStartDt) != tz.inDaylightTime(startDt)) {</span>
<span class="nc" id="L1191">				DSTGMTdt = addHour(startDt, 1);</span>
<span class="nc" id="L1192">				break;</span>
			}
<span class="nc" id="L1194">			startDt = nextStartDt;</span>
		}
<span class="nc" id="L1196">		return DSTGMTdt;</span>
	}

	private Date addHour(Date aBPDate, int hours) {
<span class="nc" id="L1200">		TimeZone GMT_TIMEZONE = TimeZone.getTimeZone(&quot;GMT&quot;);</span>
<span class="nc" id="L1201">		Calendar aCalendar = new GregorianCalendar(GMT_TIMEZONE);</span>
<span class="nc" id="L1202">		aCalendar.setTime(aBPDate);</span>
<span class="nc" id="L1203">		aCalendar.add(Calendar.HOUR_OF_DAY, hours);</span>
<span class="nc" id="L1204">		Date aNewBPDate = aCalendar.getTime();</span>
<span class="nc" id="L1205">		return aNewBPDate;</span>
	}

	private ID cloneWeek(ID campaignID, CampaignHOO sourceSPHOO, SchedulingPeriod targetSP, CloneSPOptions copyFlags,
			TimeZone tz, LocalDate startLD, LocalDate endLD) throws JdmoException {
<span class="nc" id="L1210">		ID weekSPID = new ID();</span>
		JdmoQuery jQuery;
		try {
<span class="nc" id="L1213">			Date targetWeekStartGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(startLD, tz);</span>
<span class="nc" id="L1214">			Date targetWeekEndGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(endLD, tz);</span>
<span class="nc" id="L1215">			Date targetWeekStartDt = TimeZoneUtil.toDate(startLD);</span>
<span class="nc" id="L1216">			LocalDate sourceStartLD = new LocalDate(sourceSPHOO.getStartTime(), tz);</span>
<span class="nc" id="L1217">			LocalDate sourceEndLD = new LocalDate(sourceSPHOO.getEndTime(), tz);</span>
<span class="nc" id="L1218">			Date sourceWeekStartGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(sourceStartLD, tz);</span>
<span class="nc" id="L1219">			Date sourceWeekEndGMTDt = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(sourceEndLD, tz);</span>
<span class="nc" id="L1220">			int nDSTFlag = SchedulingPeriod.NoDST;</span>
<span class="nc bnc" id="L1221" title="All 2 branches missed.">			int nCopyAssignments = (copyFlags.isCopyAssignments()) ? 1 : 0;</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">			int nCopyProjectData = (copyFlags.isCopyProjectData()) ? 1 : 0;</span>

<span class="nc" id="L1224">			ID deSPID = new ID(getDEIDFromSID(&quot;SP&quot;, sourceSPHOO.getSPID()));</span>
			String sqlQry;
<span class="nc" id="L1226">			sqlQry = &quot;SELECT COUNT(*) NUMENT FROM SPQUEUEGOALSERIES WHERE SPQUEUEID IN (SELECT ID FROM SPQUEUE WHERE SPID = '&quot;</span>
<span class="nc" id="L1227">					+ deSPID.toString();</span>
<span class="nc" id="L1228">			sqlQry += &quot;' AND MEDIAID IS NOT NULL) GROUP BY SPQUEUEID&quot;;</span>
<span class="nc" id="L1229">			JdmoRowset r = m_dmo.createRowset(sqlQry);</span>
<span class="nc" id="L1230">			int srcDataPointsCount = 0;</span>
<span class="nc bnc" id="L1231" title="All 2 branches missed.">			if (r.next()) {</span>
<span class="nc" id="L1232">				srcDataPointsCount = r.getInt(&quot;NUMENT&quot;);</span>
			}
<span class="nc" id="L1234">			r.close();</span>

			// DST 0 - none, 1 - ends(extrahour), 2 - begins(lesshour)
<span class="nc" id="L1237">			int nSourceDSTFlag = 0;</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">			if (srcDataPointsCount % 167 == 0) {</span>
<span class="nc" id="L1239">				nSourceDSTFlag = 2;// minus one source</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">			} else if (srcDataPointsCount % 169 == 0) {</span>
<span class="nc" id="L1241">				nSourceDSTFlag = 1;// extra one source)</span>
			}

<span class="nc" id="L1244">			int nTargetDSTFlag = DSTTransitionPeriod(targetWeekStartGMTDt, targetWeekEndGMTDt, tz);</span>
			// 1 - x source, 2 - x dest, 3 - x 1st dest, 4 - minus source, 5 -
			// minus dest, 6 - minus both, 7 - x both

<span class="nc bnc" id="L1248" title="All 4 branches missed.">			switch (nSourceDSTFlag) {</span>
				case 1:
<span class="nc" id="L1250">					nDSTFlag = SchedulingPeriod.SourceEndsDST;</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">					if (nTargetDSTFlag == 1) {</span>
<span class="nc" id="L1252">						nDSTFlag = SchedulingPeriod.BothEndDST;</span>
					}
					break;
				case 2:
<span class="nc" id="L1256">					nDSTFlag = SchedulingPeriod.SourceBeginsDST;</span>
<span class="nc bnc" id="L1257" title="All 2 branches missed.">					if (nTargetDSTFlag == 2) {</span>
<span class="nc" id="L1258">						nDSTFlag = SchedulingPeriod.BothBeginDST;</span>
					}
					break;
				case 0:
<span class="nc bnc" id="L1262" title="All 2 branches missed.">					if (nTargetDSTFlag == 0) {</span>
<span class="nc" id="L1263">						nDSTFlag = SchedulingPeriod.NoDST;</span>
					}
<span class="nc bnc" id="L1265" title="All 2 branches missed.">					if (nTargetDSTFlag == 1) {</span>
<span class="nc" id="L1266">						nDSTFlag = SchedulingPeriod.TargetEndsDST;</span>
					}
<span class="nc bnc" id="L1268" title="All 2 branches missed.">					if (nTargetDSTFlag == 2) {</span>
<span class="nc" id="L1269">						nDSTFlag = SchedulingPeriod.TargetBeginsDST;</span>
<span class="nc bnc" id="L1270" title="All 2 branches missed.">						if (isDateBeginDSTTransition(targetWeekStartDt, tz)) {</span>
<span class="nc" id="L1271">							nDSTFlag = SchedulingPeriod.Target1stPointBeginsDST;</span>
						}
					}
			}
<span class="nc" id="L1275">			Date DSTStartGMT = targetWeekStartGMTDt;</span>
<span class="nc bnc" id="L1276" title="All 4 branches missed.">			switch (nDSTFlag) {</span>
				case SchedulingPeriod.SourceEndsDST:
				case SchedulingPeriod.SourceBeginsDST:
<span class="nc" id="L1279">					DSTStartGMT = getDSTTransitionDateTime(sourceWeekStartGMTDt, sourceWeekEndGMTDt, tz);</span>
<span class="nc" id="L1280">					break;</span>
				case SchedulingPeriod.TargetEndsDST:
				case SchedulingPeriod.TargetBeginsDST:
<span class="nc" id="L1283">					DSTStartGMT = getDSTTransitionDateTime(targetWeekStartGMTDt, targetWeekEndGMTDt, tz);</span>
<span class="nc" id="L1284">					break;</span>
				case SchedulingPeriod.Target1stPointBeginsDST:
<span class="nc" id="L1286">					DSTStartGMT = targetWeekStartGMTDt;</span>
					break;
			}

<span class="nc" id="L1290">			String pStmt = &quot;CLONESP&quot;;</span>
<span class="nc" id="L1291">			jQuery = m_dmo.createQuery(pStmt, Jdmo.STORPROC_QUERY);</span>
<span class="nc" id="L1292">			jQuery.setParString(1, deSPID.toString()); // source sp ID</span>
<span class="nc" id="L1293">			jQuery.setParString(2, JdmoUtil.formatDBString(sourceSPHOO.getStartTime())); // source</span>
<span class="nc" id="L1294">			jQuery.setParString(3, JdmoUtil.formatDBString(sourceSPHOO.getEndTime())); // source</span>
			// start
<span class="nc" id="L1296">			jQuery.setParString(4, targetSP.getName()); // target name</span>
<span class="nc" id="L1297">			jQuery.setParString(5, JdmoUtil.formatDBString(targetSP.getStartTime())); // target</span>
			// sp
			// start
<span class="nc" id="L1300">			jQuery.setParString(6, JdmoUtil.formatDBString(targetSP.getEndTime())); // target</span>
			// sp
			// end
<span class="nc" id="L1303">			jQuery.setParString(7, JdmoUtil.formatDBString(targetWeekStartGMTDt)); // target</span>
			// week
			// start
<span class="nc" id="L1306">			jQuery.setParString(8, JdmoUtil.formatDBString(targetWeekEndGMTDt)); // target</span>
			// week
			// end
<span class="nc" id="L1309">			jQuery.setParString(9, JdmoUtil.formatDBString(targetWeekStartGMTDt)); // target</span>
			// service
			// goals
<span class="nc" id="L1312">			ID targetSPDEID = targetSP.getDEID();</span>
<span class="nc bnc" id="L1313" title="All 4 branches missed.">			if (targetSPDEID == null || targetSPDEID.toString() == &quot;&quot;) {</span>
<span class="nc" id="L1314">				jQuery.setParNull(10, Jdmo.DB_TYPE_SQL_SERVER);</span>
			} else {
<span class="nc" id="L1316">				jQuery.setParString(10, targetSPDEID.toString()); // multi-week</span>
			}
			// SPs will
			// have IDs
			// after
			// first
			// created
<span class="nc" id="L1323">			jQuery.setParInt(11, 0); // debug flag</span>
<span class="nc" id="L1324">			jQuery.setParInt(12, nCopyAssignments); // copy employee overrides</span>
<span class="nc" id="L1325">			jQuery.setParInt(13, nDSTFlag); // DST Flag</span>
<span class="nc" id="L1326">			jQuery.setParString(14, JdmoUtil.formatDBString(DSTStartGMT)); // DST</span>
			// Hour
<span class="nc" id="L1328">			jQuery.setParString(15, DAOUtil.getDEID(m_dmo, false));</span>

<span class="nc" id="L1330">			jQuery.setParInt(16, nCopyProjectData); // copy project data</span>

<span class="nc" id="L1332">			JdmoRowset rs = m_dmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1334">				weekSPID = rs.getID(1);</span>
			}
<span class="nc" id="L1336">			rs.close();</span>
<span class="nc" id="L1337">		} catch (JdmoException e) {</span>
<span class="nc" id="L1338">			throw e;</span>
<span class="nc" id="L1339">		}</span>
<span class="nc" id="L1340">		return weekSPID;</span>
	}

	private BbmCloningConflict CheckShiftAssignmentsExistWarning(List&lt;ID&gt; copyFromSPIDs, int numWeeks, Date dtStart,
			Date dtEnd) throws JdmoException {
<span class="nc" id="L1345">		BbmCloningConflict conflict = null;</span>
<span class="nc" id="L1346">		conflict = null;</span>
<span class="nc" id="L1347">		boolean bFoundError = false;</span>
		try {
<span class="nc" id="L1349">			boolean bSAExistsHandled = false;</span>
<span class="nc bnc" id="L1350" title="All 2 branches missed.">			for (int i = 0; i &lt; numWeeks; i++) {</span>
<span class="nc bnc" id="L1351" title="All 2 branches missed.">				if (bSAExistsHandled) {</span>
<span class="nc" id="L1352">					break;</span>
				}
				// Given a source SP (via its ID), destination starttime and
				// endtime,
				// checks if any of the source SP's employees already
				// have shiftassignments for non-null SPs that start in the
				// destination period
				String strSQLFm;
<span class="nc" id="L1360">				strSQLFm = &quot;select distinct 1 as SAEXIST &quot;;</span>
<span class="nc" id="L1361">				strSQLFm += &quot; from SPWORKRESOURCE spe, SHIFTASSIGNMENT sa &quot;;</span>
<span class="nc" id="L1362">				strSQLFm += &quot; where spe.WORKRESOURCEID = sa.WORKRESOURCEID &quot;;</span>
<span class="nc" id="L1363">				strSQLFm += &quot; and sa.SPID is not null&quot;;</span>
<span class="nc" id="L1364">				strSQLFm += &quot; and spe.SPID = (select id from sp where sid = &quot; + copyFromSPIDs.get(i);</span>
<span class="nc" id="L1365">				strSQLFm += &quot; and sa.STARTTIME &gt;= '&quot; + JdmoUtil.formatDBString(dtStart);</span>
<span class="nc" id="L1366">				strSQLFm += &quot;' and sa.STARTTIME &lt;= '&quot; + JdmoUtil.formatDBString(dtEnd) + &quot;')&quot;;</span>
<span class="nc" id="L1367">				JdmoRowset r = m_dmo.createRowset(strSQLFm);</span>
<span class="nc bnc" id="L1368" title="All 2 branches missed.">				if (r.next()) {</span>
<span class="nc" id="L1369">					bSAExistsHandled = true;</span>
				}
<span class="nc" id="L1371">				r.close();</span>
			}
<span class="nc bnc" id="L1373" title="All 2 branches missed.">			if (bSAExistsHandled) {</span>
<span class="nc" id="L1374">				bFoundError = true;</span>
				// populate conflict
			}

<span class="nc" id="L1378">		} catch (JdmoException e) {</span>
<span class="nc" id="L1379">			throw e;</span>
		} finally {
<span class="nc" id="L1381">			m_dmo.cleanUp();</span>
<span class="nc" id="L1382">		}</span>
<span class="nc bnc" id="L1383" title="All 2 branches missed.">		if (bFoundError) {</span>
<span class="nc" id="L1384">			conflict = new BbmCloningConflict(BbmCloningConflict.CONFLICT_SHIFT_ASSIGNMENTS_EXIST);</span>
		}
<span class="nc" id="L1386">		return conflict;</span>
	}

	private BbmCloningConflict CheckAllSkillBasedSameWarning(List&lt;ID&gt; copyFromSPIDs) throws JdmoException {
<span class="nc" id="L1390">		BbmCloningConflict conflict = null;</span>
<span class="nc" id="L1391">		conflict = null;</span>
<span class="nc" id="L1392">		boolean bFoundError = false;</span>
		try {
			// IsSkilled flag
			String strIsSkilledSQL;
<span class="nc" id="L1396">			strIsSkilledSQL = &quot;select distinct sp.ISSKILLBASED &quot;;</span>
<span class="nc" id="L1397">			strIsSkilledSQL += &quot;from sp &quot;;</span>
<span class="nc" id="L1398">			strIsSkilledSQL += &quot;where sp.id in (select id from sp where sid in &quot; + m_dmo.createInClause(copyFromSPIDs) + &quot;)&quot;;</span>

<span class="nc" id="L1400">			JdmoRowset r = m_dmo.createRowset(strIsSkilledSQL);</span>

<span class="nc bnc" id="L1402" title="All 2 branches missed.">			if (r.next()) {</span>
<span class="nc bnc" id="L1403" title="All 2 branches missed.">				if (r.next()) {</span>
<span class="nc" id="L1404">					bFoundError = true;</span>
				}
			}
<span class="nc" id="L1407">			r.close();</span>

<span class="nc" id="L1409">		} catch (JdmoException e) {</span>
<span class="nc" id="L1410">			throw e;</span>
		} finally {
<span class="nc" id="L1412">			m_dmo.cleanUp();</span>
<span class="nc" id="L1413">		}</span>
<span class="nc bnc" id="L1414" title="All 2 branches missed.">		if (bFoundError) {</span>
<span class="nc" id="L1415">			conflict = new BbmCloningConflict(BbmCloningConflict.CONFLICT_MULTIWEEK_SKILLBASED_DOESNT_MATCH);</span>
		}
<span class="nc" id="L1417">		return conflict;</span>
	}

	// User is not allowed to clone.
	private BbmCloningConflict CheckOrgsMatchShowStopper(List&lt;ID&gt; copyFromSPIDs) throws JdmoException {
<span class="nc" id="L1422">		BbmCloningConflict conflict = null;</span>
<span class="nc" id="L1423">		conflict = null;</span>
<span class="nc" id="L1424">		boolean bFoundError = false;</span>
		try {

			String strOrgSQL;
<span class="nc" id="L1428">			strOrgSQL = &quot;select count (distinct org.ID) as count from Organization org, SP, SPCALLCENTER spC &quot;;</span>
<span class="nc" id="L1429">			strOrgSQL += &quot;where spC.SPID = SP.ID and spC.ORGANIZATIONID = org.ID &quot;;</span>
<span class="nc" id="L1430">			strOrgSQL += &quot;and sp.id = (select id from sp where sid = &quot; + copyFromSPIDs.get(1) + &quot;)&quot;;</span>

			String strMultiOrgSQL;
<span class="nc" id="L1433">			strMultiOrgSQL = &quot;select count (distinct org.ID) as count from Organization org, SP, SPCALLCENTER spC &quot;;</span>
<span class="nc" id="L1434">			strMultiOrgSQL += &quot;where spC.SPID = SP.ID and spC.ORGANIZATIONID = org.ID &quot;;</span>
<span class="nc" id="L1435">			strMultiOrgSQL += &quot;and sp.id in (select id from sp where sid in &quot; + m_dmo.createInClause(copyFromSPIDs) + &quot;)&quot;;</span>

<span class="nc" id="L1437">			JdmoRowset r = m_dmo.createRowset(strOrgSQL);</span>
<span class="nc" id="L1438">			int count1 = 0;</span>
<span class="nc bnc" id="L1439" title="All 2 branches missed.">			if (r.next()) {</span>
<span class="nc" id="L1440">				count1 = r.getInt(&quot;count&quot;);</span>
			}
<span class="nc" id="L1442">			r.close();</span>

<span class="nc" id="L1444">			JdmoRowset r2 = m_dmo.createRowset(strMultiOrgSQL);</span>
<span class="nc" id="L1445">			int count2 = 0;</span>
<span class="nc bnc" id="L1446" title="All 2 branches missed.">			if (r2.next()) {</span>
<span class="nc" id="L1447">				count2 = r2.getInt(&quot;count&quot;);</span>
			}
<span class="nc" id="L1449">			r2.close();</span>

<span class="nc bnc" id="L1451" title="All 2 branches missed.">			if (count1 != count2) {</span>
<span class="nc" id="L1452">				bFoundError = true;</span>
				// populate conflict
			}

<span class="nc" id="L1456">		} catch (JdmoException e) {</span>
<span class="nc" id="L1457">			throw e;</span>
		} finally {
<span class="nc" id="L1459">			m_dmo.cleanUp();</span>
<span class="nc" id="L1460">		}</span>
<span class="nc bnc" id="L1461" title="All 2 branches missed.">		if (bFoundError) {</span>
<span class="nc" id="L1462">			conflict = new BbmCloningConflict(BbmCloningConflict.CONFLICT_MULTIWEEK_ORGS_DONT_MATCH);</span>
		}
<span class="nc" id="L1464">		return conflict;</span>
	}

	// User is not allowed to clone.
	private BbmCloningConflict CheckQueuesMatchShowStopper(List&lt;ID&gt; copyFromSPIDs) {
<span class="nc" id="L1469">		BbmCloningConflict conflict = null;</span>
<span class="nc" id="L1470">		conflict = null;</span>
<span class="nc" id="L1471">		boolean bFoundError = false;</span>
		try {

			String strQueueSQL;
<span class="nc" id="L1475">			strQueueSQL = &quot;select count (distinct SPQUEUE.QUEUEID) as count from SPQUEUE where SPQUEUE.SPID = (select id from sp where sid = &quot;</span>
<span class="nc" id="L1476">					+ copyFromSPIDs.get(0) + &quot;)&quot;;</span>

			String strMultiQueueSQL;
<span class="nc" id="L1479">			strMultiQueueSQL = &quot;select count (distinct SPQUEUE.QUEUEID) as count from SPQUEUE where SPQUEUE.SPID in (select id from sp where sid in &quot;</span>
<span class="nc" id="L1480">					+ m_dmo.createInClause(copyFromSPIDs) + &quot;)&quot;;</span>

<span class="nc" id="L1482">			JdmoRowset r = m_dmo.createRowset(strQueueSQL);</span>
<span class="nc" id="L1483">			int count1 = 0;</span>
<span class="nc bnc" id="L1484" title="All 2 branches missed.">			if (r.next()) {</span>
<span class="nc" id="L1485">				count1 = r.getInt(&quot;count&quot;);</span>
			}
<span class="nc" id="L1487">			r.close();</span>

<span class="nc" id="L1489">			JdmoRowset r2 = m_dmo.createRowset(strMultiQueueSQL);</span>
<span class="nc" id="L1490">			int count2 = 0;</span>
<span class="nc bnc" id="L1491" title="All 2 branches missed.">			if (r2.next()) {</span>
<span class="nc" id="L1492">				count2 = r2.getInt(&quot;count&quot;);</span>
			}
<span class="nc" id="L1494">			r2.close();</span>

<span class="nc bnc" id="L1496" title="All 2 branches missed.">			if (count1 != count2) {</span>
<span class="nc" id="L1497">				bFoundError = true;</span>
				// populate conflict
			}

<span class="nc" id="L1501">		} catch (JdmoException e) {</span>
			// throw e;
		} finally {
<span class="nc" id="L1504">			m_dmo.cleanUp();</span>
<span class="nc" id="L1505">		}</span>
<span class="nc bnc" id="L1506" title="All 2 branches missed.">		if (bFoundError) {</span>
<span class="nc" id="L1507">			conflict = new BbmCloningConflict(BbmCloningConflict.CONFLICT_MULTIWEEK_QUEUES_DONT_MATCH);</span>
		}
<span class="nc" id="L1509">		return conflict;</span>
	}

	// User is not allowed to clone.
	private BbmCloningConflict CheckQueuesInOtherCampaignShowStopper(Collection&lt;ID&gt; spIDs, Date startGMTDt, Date endGMTDt)
			throws JdmoException {
<span class="nc" id="L1515">		BbmCloningConflict conflict = null;</span>
<span class="nc" id="L1516">		conflict = null;</span>
<span class="nc" id="L1517">		boolean bFoundError = false;</span>
<span class="nc" id="L1518">		List&lt;String&gt; names = new ArrayList&lt;String&gt;();</span>
		try {
			String strQueuesSQLFm;
<span class="nc" id="L1521">			strQueuesSQLFm = &quot;select distinct name from queue where id in &quot;;</span>
<span class="nc" id="L1522">			strQueuesSQLFm += &quot;(select queueid from spqueue where &quot;;</span>
<span class="nc" id="L1523">			strQueuesSQLFm += &quot; (queueid in &quot;;</span>
<span class="nc" id="L1524">			strQueuesSQLFm += &quot; (select queueid from spqueue where queueid is not null and spid in (select id from sp where sid in &quot;</span>
<span class="nc" id="L1525">					+ m_dmo.createInClause(spIDs) + &quot;)))&quot;;</span>
<span class="nc" id="L1526">			strQueuesSQLFm += &quot; and &quot;;</span>
<span class="nc" id="L1527">			strQueuesSQLFm += &quot; (spid in &quot;;</span>
<span class="nc" id="L1528">			strQueuesSQLFm += &quot; (select id from sp where FROMDATE &lt; '&quot; + JdmoUtil.formatDBString(endGMTDt)</span>
<span class="nc" id="L1529">					+ &quot;' AND TODATE &gt; '&quot; + JdmoUtil.formatDBString(startGMTDt) + &quot;')))&quot;;</span>

<span class="nc" id="L1531">			JdmoRowset r = m_dmo.createRowset(strQueuesSQLFm);</span>
<span class="nc bnc" id="L1532" title="All 2 branches missed.">			while (r.next()) {</span>
<span class="nc" id="L1533">				bFoundError = true;</span>
<span class="nc" id="L1534">				String campaignName = new String(r.getString(&quot;NAME&quot;));</span>
<span class="nc" id="L1535">				names.add(campaignName);</span>
<span class="nc" id="L1536">			}</span>
<span class="nc" id="L1537">			r.close();</span>

<span class="nc" id="L1539">		} catch (JdmoException e) {</span>
<span class="nc" id="L1540">			throw e;</span>
		} finally {
<span class="nc" id="L1542">			m_dmo.cleanUp();</span>
<span class="nc" id="L1543">		}</span>
<span class="nc bnc" id="L1544" title="All 2 branches missed.">		if (bFoundError) {</span>
<span class="nc" id="L1545">			conflict = new BbmCloningConflict(BbmCloningConflict.CONFLICT_QUEUES_IN_OTHER_CAMPAIGN, names);</span>
		}
<span class="nc" id="L1547">		return conflict;</span>
	}

	/**
	 * Returns the child scheduling period IDs of the SP having the specified
	 * numeric or alphanumeric ID.
	 *
	 * @param parentSPID the ID of the parent SP--may be SID or DEID (numeric or
	 *                   alphanumeric)
	 * @return a collection of IDs of the child SPs
	 * @throws JdmoException
	 * @throws BbmFinderException if the specified ID cannot be mapped to a DEID
	 */
	public Collection&lt;ID&gt; getSubSPIDsFromParentSPID(ID parentSPID) throws JdmoException, BbmFinderException {
<span class="nc" id="L1561">		return getSubSPIDs(DAOUtil.mapIDToDEID(parentSPID, m_fieldInfo));</span>
	}

	/**
	 * Returns the child scheduling period IDs of the SP having the specified
	 * alphanumeric ID.
	 *
	 * @param parentSPID the ID of the parent SP--must be a DEID (alphanumeric)
	 * @return a collection of IDs of the child SPs
	 * @throws JdmoException
	 */
	private Collection&lt;ID&gt; getSubSPIDs(ID parentSPID) throws JdmoException {
<span class="nc" id="L1573">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;ID&gt;();</span>

		// ID DEID = getDEIDFromSID(&quot;SP&quot;, parentSPID);
<span class="nc" id="L1576">		String query = &quot;SELECT SID FROM SP WHERE PARENTSPID = '&quot; + parentSPID + &quot;'&quot;;</span>

<span class="nc" id="L1578">		JdmoRowset r = m_dmo.createRowset(query);</span>

<span class="nc bnc" id="L1580" title="All 2 branches missed.">		while (r.next()) {</span>
<span class="nc" id="L1581">			ID id = new ID(r.getID(&quot;SID&quot;));</span>
<span class="nc" id="L1582">			ids.add(id);</span>
<span class="nc" id="L1583">		}</span>

<span class="nc" id="L1585">		r.close();</span>
<span class="nc" id="L1586">		return ids;</span>
	}

	/**
	 * Updates a collection of scheduling periods that have their campaign IDs
	 * set as SIDs. This method is an unfortunate side effect of the dual ID
	 * problem. It is here because the standard method, DAOBase.updateObjects,
	 * will not work for Scheduling Periods that have campaign SIDs loaded
	 * instead of DEIDs as the campaign DEID is what is stored in the DB as a
	 * foreign key. This method should not be exposed to the webtier as we want
	 * to hide the concept of dual IDs from the webtier.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public void updateSchedulingPeriodsWithCampaignSIDs(Collection&lt;SchedulingPeriod&gt; schedulingPeriods) throws BbmException {
		try {
<span class="nc" id="L1601">			Collection&lt;ID&gt; campaignSIDs = ValueObjectUtil.getFieldObjectCol(SchedulingPeriodFieldInfo.SP_CAMPAIGNID,</span>
					schedulingPeriods);
			// Get the DEID campaign ID for each scheduling period
<span class="nc" id="L1604">			Map&lt;ID, ID&gt; campaignIDtoDEIDMap = DAOUtil.mapIDsToDEIDs(campaignSIDs, new CampaignFieldInfo());</span>
<span class="nc" id="L1605">			Map&lt;ID, ID&gt; campaignDEIDtoIDMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc bnc" id="L1606" title="All 2 branches missed.">			for (SchedulingPeriod sp : schedulingPeriods) {</span>
				// Set the DEID of the campaign ID for each scheduling period
				// before updating
<span class="nc" id="L1609">				campaignDEIDtoIDMap.put(campaignIDtoDEIDMap.get(sp.getCampaignID()), sp.getCampaignID());</span>
<span class="nc" id="L1610">				sp.setCampaignID(campaignIDtoDEIDMap.get(sp.getCampaignID()));</span>
<span class="nc" id="L1611">			}</span>
<span class="nc" id="L1612">			super.updateObjects(schedulingPeriods);</span>
			// Swap the SID back onto the SP before exiting
<span class="nc bnc" id="L1614" title="All 2 branches missed.">			for (SchedulingPeriod sp : schedulingPeriods) {</span>
<span class="nc" id="L1615">				sp.setCampaignID(campaignDEIDtoIDMap.get(sp.getCampaignID()));</span>
<span class="nc" id="L1616">			}</span>
<span class="nc" id="L1617">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1618">			throw new BbmException(e);</span>
<span class="nc" id="L1619">		} catch (MultiUserException e) {</span>
<span class="nc" id="L1620">			throw new BbmException(e);</span>
<span class="nc" id="L1621">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1622">			throw new BbmException(e);</span>
<span class="nc" id="L1623">		}</span>
<span class="nc" id="L1624">	}</span>

	public Collection&lt;SchedulingPeriod&gt; getCommonSchedulingPeriods(ID campaignID, Collection&lt;ID&gt; employeeIDs, Date date, int nNumberToGet) throws BbmFinderException {

<span class="nc bnc" id="L1628" title="All 4 branches missed.">		if (employeeIDs == null || employeeIDs.isEmpty()) {</span>
<span class="nc" id="L1629">			return Collections.emptyList();</span>
		}

		try {
<span class="nc" id="L1633">			JdmoQuery query = m_dmo.createQuery(&quot;RM_GET_COMMON_SP_FOR_EMPLOYEES&quot;, Jdmo.STORPROC_QUERY);</span>

<span class="nc" id="L1635">			String xml = com.verint.ejb.wfm.util.DAOUtil.converIdsToXml(employeeIDs);</span>
<span class="nc" id="L1636">			query.setParSqlXml(1, xml);</span>
<span class="nc" id="L1637">			query.setParInt(2, campaignID.toInt());</span>
<span class="nc" id="L1638">			query.setParTimestamp(3, new Timestamp(date.getTime()));</span>
<span class="nc" id="L1639">			query.setParInt(4, nNumberToGet);</span>

<span class="nc" id="L1641">			JdmoRowset rs = m_dmo.createRowset(query, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L1642">			List&lt;SchedulingPeriod&gt; result = new ArrayList&lt;SchedulingPeriod&gt;(nNumberToGet);</span>

<span class="nc bnc" id="L1644" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1645">				SchedulingPeriod sp = getSchedulingPeriodFromRowset(rs, null);</span>
<span class="nc" id="L1646">				result.add(sp);</span>
<span class="nc" id="L1647">			}</span>

<span class="nc" id="L1649">			rs.close();</span>
<span class="nc" id="L1650">			return result;</span>

<span class="nc" id="L1652">		} catch (JdmoException e) {</span>
<span class="nc" id="L1653">			throw new BbmFinderException(e);</span>
		}

	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>