<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.campaign.ejb</a> &gt; <span class="el_source">CampaignManagerEJB.java</span></div><h1>CampaignManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.campaign.ejb;

import java.rmi.RemoteException;
import java.text.MessageFormat;
import java.util.*;
import javax.naming.Context;
import javax.naming.InitialContext;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.PaginationPair;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoDuplicateKeyException;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.localization.LocaleContext;
import com.bluepumpkin.common.localization.LocalizationManager;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.CollectionUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.am.ops.gcr.LSGInfoExtractor;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.ActivitySPResourceConstraint;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.activity.model.EventUtils;
import com.bluepumpkin.ejb.bbm.base.BbmCreateDuplicateKeyException;
import com.bluepumpkin.ejb.bbm.campaign.model.*;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmTimePeriodOverlapException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.dao.MapUtil;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.ObjectType;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.SystemType;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriodUtil;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.BbmScheduleConflictException;
import com.bluepumpkin.ejb.bbm.timeseries.ejb.TimeSeriesManager;
import com.bluepumpkin.ejb.bbm.timeseries.model.RequireTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.util.MonthlySPUtil;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.vo.HOOPeriod;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.QueueDAO;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTemplate;
import com.bluepumpkin.ejb.bbm.workresource.model.Phantom;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.verint.ejb.bbm.forecast.ejb.ForecastTimeSeriesManager;
import com.verint.ejb.bbm.forecast.model.ForecastProfileProject;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.gcr.ejb.GCRManager;
import com.witness.ejb.core.gcr.model.GCREntry;

<span class="nc" id="L74">public class CampaignManagerEJB extends SessionEJBBase {</span>

	private static final long serialVersionUID = 1L;

<span class="nc" id="L78">	private static Category LOG = Log.initCategory(CampaignManagerEJB.class.getName());</span>

	private WorkResourceManager m_workResourceManager;
	private WorkloadManager m_workloadManager;
	private ScheduleAccessManager m_scheduleAccessManager;
	private ForecastTimeSeriesManager forecastTimeSeriesManager;
	private CampaignManager campaignManager;
<span class="nc" id="L85">	private boolean m_isWhatIf = false;</span>

	@Override
	public void onEjbCreate() {
		try {
			// First query environment to get WIF setting from DD
<span class="nc" id="L91">			Context initialContext = new InitialContext();</span>
<span class="nc" id="L92">			Boolean WIF = (Boolean) initialContext.lookup(&quot;java:comp/env/WIF&quot;);</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">			if (WIF != null) {</span>
<span class="nc" id="L94">				m_isWhatIf = WIF.booleanValue();</span>
			}

<span class="nc" id="L97">			m_workloadManager = WfmManagerFactory.getWorkloadManager(m_isWhatIf);</span>
<span class="nc" id="L98">			m_workResourceManager = BbmManagerFactory.getWorkResourceManager(m_isWhatIf);</span>
<span class="nc" id="L99">			m_scheduleAccessManager = WfmManagerFactory.getScheduleAccessManager(m_isWhatIf);</span>
<span class="nc" id="L100">			forecastTimeSeriesManager = WfmManagerFactory.getForecastTimeSeriesManager(m_isWhatIf);</span>
<span class="nc" id="L101">			campaignManager = WfmManagerFactory.getCampaignManager(m_isWhatIf);</span>
<span class="nc" id="L102">		} catch (Exception e) {</span>
<span class="nc" id="L103">			handleException(&quot;onEjbCreate&quot;, e, false);</span>
<span class="nc" id="L104">		}</span>
<span class="nc" id="L105">	}</span>

	/**
	 * override the base class to provide the appropriate logging category
	 */
	@Override
	protected Category getCategory() {
<span class="nc" id="L112">		return LOG;</span>
	}
	{
<span class="nc" id="L115">		super.init(CampaignManagerEJB.class.getName());</span>
<span class="nc" id="L116">	}</span>

	/**
	 * get campaign object given its SID
	 */
	public Campaign getCampaignByID(ID id) throws BbmObjectNotFoundException, BbmFinderException {
<span class="nc" id="L122">		methodStart(&quot;getCampaignByID&quot;, id);</span>
<span class="nc" id="L123">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="nc" id="L125">			ArrayList&lt;ID&gt; aIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L126">			aIDs.add(id);</span>
<span class="nc" id="L127">			Collection&lt;Campaign&gt; cpgCol = dao.getCampaign(aIDs, false);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">			if (cpgCol.isEmpty()) {</span>
<span class="nc" id="L129">				return null;</span>
			}
<span class="nc" id="L131">			return cpgCol.iterator().next();</span>
<span class="nc" id="L132">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L133">			handleException(e, false);</span>
			// no rollback, since finder not support transaction
<span class="nc" id="L135">			throw e;</span>
<span class="nc" id="L136">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L137">			handleException(e, false);</span>
<span class="nc" id="L138">			throw e;</span>
		} finally {
<span class="nc" id="L140">			dao.cleanUp();</span>
<span class="nc" id="L141">			methodFinish();</span>
		}
	}

	public ID getCampaignIDByName(String name) throws BbmFinderException {
<span class="nc" id="L146">		methodStart(&quot;getQueueIDByName&quot;, name);</span>
		try {
<span class="nc" id="L148">			return CampaignDAO.getCampaignIDByName(name);</span>
<span class="nc" id="L149">		} catch (JdmoException e) {</span>
<span class="nc" id="L150">			handleException(e, false);</span>
<span class="nc" id="L151">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L153">			methodFinish();</span>
		}
	}

	/**
	 * get campaign object given the combined queue id
	 */
	public Campaign getCampaignByCombinedQueueID(ID idCombinedQueue) throws BbmObjectNotFoundException, BbmFinderException {
<span class="nc" id="L161">		methodStart(&quot;getCampaignByCombinedQueueID&quot;, idCombinedQueue);</span>
<span class="nc" id="L162">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="nc" id="L164">			return dao.getCampaignByCombinedQueueID(idCombinedQueue);</span>
<span class="nc" id="L165">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L166">			handleException(e, false);</span>
			// no rollback, since finder not support transaction
<span class="nc" id="L168">			throw e;</span>
<span class="nc" id="L169">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L170">			handleException(e, false);</span>
<span class="nc" id="L171">			throw e;</span>
		} finally {
<span class="nc" id="L173">			dao.cleanUp();</span>
<span class="nc" id="L174">			methodFinish();</span>
		}
	}

	/**
	 * get campaigns given their SIDs
	 */
	public Collection&lt;Campaign&gt; getCampaignsByIDs(Collection&lt;ID&gt; campaignSIDs) throws BbmFinderException {
<span class="nc" id="L182">		methodStart(&quot;getCampaignByIDs&quot;, campaignSIDs);</span>
<span class="nc" id="L183">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="nc" id="L185">			return dao.getCampaign(campaignSIDs, false);</span>
<span class="nc" id="L186">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L187">			handleException(e, false);</span>
			// no rollback, since finder not support transaction
<span class="nc" id="L189">			throw e;</span>
<span class="nc" id="L190">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L191">			handleException(e, false);</span>
<span class="nc" id="L192">			throw e;</span>
		} finally {
<span class="nc" id="L194">			dao.cleanUp();</span>
<span class="nc" id="L195">			methodFinish();</span>
		}
	}

	public Map&lt;ID, Integer&gt; getCampaignSIDAttachedSchedulingPeriodCountMap(Collection&lt;ID&gt; campaignSIDs)
			throws BbmFinderException {
<span class="nc" id="L201">		methodStart(&quot;getCampaignIDAttachedSchedulingPeriodCountMap&quot;, campaignSIDs);</span>
<span class="nc" id="L202">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L204">			return dao.getCampaignIDAttachedSchedulingPeriodCountMap(campaignSIDs);</span>
<span class="nc" id="L205">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L206">			handleException(e, false);</span>
<span class="nc" id="L207">			throw e;</span>
		} finally {
<span class="nc" id="L209">			dao.cleanUp();</span>
<span class="nc" id="L210">			methodFinish();</span>
		}
	}

	public Map&lt;ID, ActivitySPResourceConstraint&gt; getActivitySPResourceConstraintMap(ID schedulingPeriodSID)
			throws BbmFinderException {
<span class="nc" id="L216">		methodStart(&quot;getActivitySPResourceConstraintsBySP&quot;, schedulingPeriodSID);</span>
<span class="nc" id="L217">		ActivitySPResourceConstraintDAO dao = new ActivitySPResourceConstraintDAO();</span>
		try {
<span class="nc" id="L219">			List&lt;ActivitySPResourceConstraint&gt; constraints = dao.getActivitySPResourceConstraintsBySP(schedulingPeriodSID);</span>
<span class="nc" id="L220">			Map&lt;ID, ActivitySPResourceConstraint&gt; results = new HashMap&lt;ID, ActivitySPResourceConstraint&gt;();</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">			for (ActivitySPResourceConstraint constraint : constraints) {</span>
<span class="nc" id="L222">				results.put(constraint.getActivityID(), constraint);</span>
<span class="nc" id="L223">			}</span>
<span class="nc" id="L224">			return results;</span>

<span class="nc" id="L226">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L227">			handleException(e, false);</span>
<span class="nc" id="L228">			throw e;</span>
		} finally {
<span class="nc" id="L230">			dao.cleanUp();</span>
<span class="nc" id="L231">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; createActivitySPResourceConstraints(
			List&lt;ActivitySPResourceConstraint&gt; newActivitySPResourceConstraints) throws BbmCreateException,
			BbmCreateDuplicateKeyException {
<span class="nc" id="L238">		methodStart(&quot;createActivitySPResourceConstraints&quot;, newActivitySPResourceConstraints);</span>
<span class="nc" id="L239">		ActivitySPResourceConstraintDAO dao = new ActivitySPResourceConstraintDAO();</span>
		try {
<span class="nc" id="L241">			return dao.createObjects(newActivitySPResourceConstraints);</span>
<span class="nc" id="L242">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L243">			handleException(e); // log and rollback transaction</span>
<span class="nc" id="L244">			throw e;</span>
		} finally {
<span class="nc" id="L246">			dao.cleanUp();</span>
<span class="nc" id="L247">			methodFinish();</span>
		}
	}

	public void updateActivitySPResourceConstraints(List&lt;ActivitySPResourceConstraint&gt; activitySPResourceConstraints)
			throws BbmUpdateException, MultiUserException {
<span class="nc" id="L253">		methodStart(&quot;updateActivitySPResourceConstraints&quot;, activitySPResourceConstraints);</span>
<span class="nc" id="L254">		ActivitySPResourceConstraintDAO dao = new ActivitySPResourceConstraintDAO();</span>
		try {
<span class="nc" id="L256">			dao.updateObjects(activitySPResourceConstraints);</span>
<span class="nc" id="L257">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L258">			handleException(e);</span>
<span class="nc" id="L259">			throw e;</span>
<span class="nc" id="L260">		} catch (MultiUserException e) {</span>
<span class="nc" id="L261">			handleException(e);</span>
<span class="nc" id="L262">			throw e;</span>
		} finally {
<span class="nc" id="L264">			dao.cleanUp();</span>
<span class="nc" id="L265">			methodFinish();</span>
<span class="nc" id="L266">		}</span>
<span class="nc" id="L267">	}</span>

	/**
	 * get all campaigns
	 */
	public Collection&lt;Campaign&gt; getCampaigns() throws BbmFinderException {
<span class="nc" id="L273">		methodStart(&quot;getCampaigns&quot;);</span>
<span class="nc" id="L274">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="nc" id="L276">			return dao.getCampaign(null, false);</span>
<span class="nc" id="L277">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L278">			handleException(e, false);</span>
<span class="nc" id="L279">			throw e;</span>
		} finally {
<span class="nc" id="L281">			dao.cleanUp();</span>
<span class="nc" id="L282">			methodFinish();</span>
		}
	}

	/**
	 * insert a campaign object into database
	 */
	public ID createCampaign(Campaign objValue) throws BbmCreateException, BbmCreateDuplicateKeyException {
<span class="nc" id="L290">		methodStart(&quot;createCampaign&quot;);</span>
<span class="nc" id="L291">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="nc" id="L293">			return dao.createCampaign(objValue);</span>
<span class="nc" id="L294">		} catch (JdmoDuplicateKeyException e) {</span>
<span class="nc" id="L295">			handleException(e, false); // log but don't rollback transaction</span>
<span class="nc" id="L296">			throw new BbmCreateDuplicateKeyException(e);</span>
<span class="nc" id="L297">		} catch (JdmoException e) {</span>
<span class="nc" id="L298">			handleException(e, false); // log but don't rollback transaction</span>
<span class="nc" id="L299">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L301">			dao.cleanUp();</span>
<span class="nc" id="L302">			methodFinish();</span>
		}
	}

	public ID createCampaign(Campaign campaign, SystemType externalSystemType) throws BbmCreateException,
			BbmCreateDuplicateKeyException {

<span class="nc" id="L309">		methodStart(&quot;createCampaign&quot;);</span>
		try {
<span class="nc" id="L311">			ID campaignSID = createCampaign(campaign);</span>
<span class="nc" id="L312">			campaign.setID(campaignSID);</span>
<span class="nc" id="L313">			boolean insert = true;</span>
<span class="nc" id="L314">			MapUtil.setWfoToExternalID(externalSystemType, ObjectType.Campaign, campaign.getID(), campaign.getExternalID(),</span>
					new Jdmo(true), insert);
<span class="nc" id="L316">			return campaignSID;</span>
<span class="nc" id="L317">		} catch (BbmCreateException e) { // from createCampaign(campaign);</span>
<span class="nc" id="L318">			handleException(e); // log and rollback transaction</span>
<span class="nc" id="L319">			throw e;</span>
<span class="nc" id="L320">		} catch (JdmoException e) { // from mapUtil</span>
<span class="nc" id="L321">			handleException(e); // log and rollback transaction</span>
<span class="nc" id="L322">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L324">			methodFinish();</span>
		}

	}

	/**
	 * Warning: Identity based on SID not ID
	 */
	public void updateCampaigns(Collection&lt;Campaign&gt; campaignCol) throws BbmUpdateException {
<span class="nc" id="L333">		methodStart(&quot;updateCampaigns&quot;);</span>
<span class="nc" id="L334">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="nc" id="L336">			dao.updateCampaigns(campaignCol);</span>
<span class="nc" id="L337">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L338">			handleException(e);</span>
<span class="nc" id="L339">			throw e;</span>
		} finally {
<span class="nc" id="L341">			dao.cleanUp();</span>
<span class="nc" id="L342">			methodFinish();</span>
<span class="nc" id="L343">		}</span>
<span class="nc" id="L344">	}</span>

	public void matchCampaignWithExternalID(Campaign objValue, SystemType externalSystemType, ID campaignExternalID)
			throws RemoteException, BbmUpdateException {
<span class="nc" id="L348">		methodStart(&quot;matchCampaignWithExternalID&quot;, objValue, externalSystemType, campaignExternalID);</span>

		// validate
<span class="nc bnc" id="L351" title="All 2 branches missed.">		if (externalSystemType == null) {</span>
<span class="nc" id="L352">			throw new BbmUpdateException(&quot;externalSystemType is null&quot;);</span>
		}
<span class="nc bnc" id="L354" title="All 2 branches missed.">		if (campaignExternalID == null) {</span>
<span class="nc" id="L355">			throw new BbmUpdateException(&quot;externalSourceId is null&quot;);</span>
		}
<span class="nc bnc" id="L357" title="All 4 branches missed.">		if ((campaignExternalID.isInt() &amp;&amp; !externalSystemType.isExtIdAnInt)) {</span>
<span class="nc" id="L358">			throw new BbmUpdateException(&quot;For this external system, externalSourceId must be a string not an integer&quot;);</span>
		}
<span class="nc bnc" id="L360" title="All 4 branches missed.">		if ((!campaignExternalID.isInt() &amp;&amp; externalSystemType.isExtIdAnInt)) {</span>
<span class="nc" id="L361">			throw new BbmUpdateException(&quot;For this external system, externalSourceId must be an integer not a string&quot;);</span>
		}

		// match external id for campaign
		try {
<span class="nc" id="L366">			boolean insert = true;</span>
<span class="nc" id="L367">			MapUtil.setWfoToExternalID(externalSystemType, ObjectType.Campaign, objValue.getID(), campaignExternalID,</span>
					new Jdmo(true), insert);
<span class="nc" id="L369">		} catch (JdmoException e) {</span>
<span class="nc" id="L370">			handleException(e);</span>
<span class="nc" id="L371">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L373">			methodFinish();</span>
<span class="nc" id="L374">		}</span>

<span class="nc" id="L376">	}</span>

	/**
	 * get an given campaign's organization assignments
	 *
	 * @return a collection of CampaignOrg objects which hold the assignment
	 * information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;CampaignOrg&gt; getCampaignOrgAssignments(ID idCampaign, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L387">		methodStart(&quot;getCampaignOrgAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L388">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="nc" id="L390">			return dao.getCampaignOrgAssignments(idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L391">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L392">			handleException(e, false);</span>
<span class="nc" id="L393">			throw e;</span>
		} finally {
<span class="nc" id="L395">			dao.cleanUp();</span>
<span class="nc" id="L396">			methodFinish();</span>
		}
	}

	/**
	 * get campaign org assignment given its id
	 */
	public CampaignOrg getCampaignOrgAssignmentByID(ID idAssignment) throws BbmObjectNotFoundException, BbmFinderException {
<span class="nc" id="L404">		methodStart(&quot;getCampaignOrgAssignmentByID&quot;, idAssignment);</span>
<span class="nc" id="L405">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="nc" id="L407">			return dao.getCampaignOrgAssignmentByID(idAssignment);</span>
<span class="nc" id="L408">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L409">			handleException(e, false);</span>
<span class="nc" id="L410">			throw e;</span>
<span class="nc" id="L411">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L412">			handleException(e, false);</span>
<span class="nc" id="L413">			throw e;</span>
		} finally {
<span class="nc" id="L415">			dao.cleanUp();</span>
<span class="nc" id="L416">			methodFinish();</span>
		}
	}

	/**
	 * Given a collection of orgIDs, return all campaign IDs linked to any of
	 * those orgs, for any time period.
	 */
	public Collection&lt;ID&gt; getAllCampaignIDsLinkedToOrgs(Collection orgIDs) throws BbmFinderException {
<span class="nc" id="L425">		methodStart(&quot;getAllCampaignIDsLinkedToOrgs&quot;, orgIDs);</span>
<span class="nc" id="L426">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="nc" id="L428">			return dao.getAllCampaignIDsLinkedToOrgs(orgIDs);</span>
<span class="nc" id="L429">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L430">			handleException(e, false);</span>
<span class="nc" id="L431">			throw e;</span>
		} finally {
<span class="nc" id="L433">			dao.cleanUp();</span>
<span class="nc" id="L434">			methodFinish();</span>
		}
	}

	/**
	 * create a list of campaign organization assignments
	 *
	 * @return a list of ids of the created objects, if failed in creation of
	 * any object, raise exception
	 */
	public Collection&lt;ID&gt; createCampaignOrgAssignments(Collection&lt;CampaignOrg&gt; colAssignments) throws BbmCreateException {
<span class="nc" id="L445">		methodStart(&quot;createCampaignOrgAssignments&quot;, colAssignments);</span>
<span class="nc" id="L446">		ArrayList&lt;ID&gt; arrResult = new ArrayList&lt;ID&gt;();</span>

<span class="nc" id="L448">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="nc" id="L450">			Iterator&lt;CampaignOrg&gt; it = colAssignments.iterator();</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">			while (it.hasNext()) {</span>
<span class="nc" id="L452">				arrResult.add(dao.createCampaignOrgAssignment(it.next()));</span>
			}
<span class="nc" id="L454">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L455">			handleException(e);</span>
<span class="nc" id="L456">			throw e;</span>
		} finally {
<span class="nc" id="L458">			dao.cleanUp();</span>
<span class="nc" id="L459">			methodFinish();</span>
<span class="nc" id="L460">		}</span>

<span class="nc" id="L462">		return arrResult;</span>
	}

	/**
	 * return a list of skill Names associated with a spqueue
	 */
	public Collection&lt;String&gt; getSkillNamesMappedToQueue(ID idQueue, ID spID) throws BbmFinderException {
<span class="nc" id="L469">		methodStart(&quot;getSkillNamesMappedToQueue&quot;);</span>
<span class="nc" id="L470">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L472">			return dao.getSkillNamesMappedToQueue(idQueue, spID);</span>
		} finally {
<span class="nc" id="L474">			dao.cleanUp();</span>
<span class="nc" id="L475">			methodFinish();</span>
		}
	}

	/**
	 * Given an SP ID, return a Map that maps each queue SID to its skill SID.
	 * If the SP has a queue that is not linked to a skill, then the queue is
	 * not included in the map. We assume that an SP queue can only be linked to
	 * a single skill.
	 *
	 * @param spID - the SID of the scheduling period.
	 * @return A Map that maps each queue SID to its skill SID.
	 * @throws BbmFinderException TODO: change this to return Map&lt;ID, ID&gt; not HashMap&lt;ID, ID&gt;
	 */
	public HashMap&lt;ID, ID&gt; getQueueIDToSkillMap(ID spID) throws BbmFinderException {
<span class="nc" id="L490">		methodStart(&quot;getQueueIDToSkillMap&quot;);</span>
<span class="nc" id="L491">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {

<span class="nc" id="L494">			Map&lt;ID, ID&gt; queueIDToSkillMap = dao.getQueueIDToSkillMap(spID);</span>
<span class="nc" id="L495">			return new HashMap&lt;ID, ID&gt;(queueIDToSkillMap); // TODo remove when</span>
			// signature changed
		} finally {
<span class="nc" id="L498">			dao.cleanUp();</span>
<span class="nc" id="L499">			methodFinish();</span>
		}
	}

	/**
	 * save a campaign's organization assignment
	 */
	public void updateCampaignOrgAssignment(CampaignOrg objValue) throws MultiUserException, BbmUpdateException {
<span class="nc" id="L507">		methodStart(&quot;updateCampaignOrgAssignment&quot;, objValue);</span>
<span class="nc" id="L508">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="nc" id="L510">			dao.updateCampaignOrgAssignment(objValue);</span>
<span class="nc" id="L511">		} catch (MultiUserException e) {</span>
<span class="nc" id="L512">			handleException(e);</span>
<span class="nc" id="L513">			throw e;</span>
<span class="nc" id="L514">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L515">			handleException(e);</span>
<span class="nc" id="L516">			throw e;</span>
		} finally {
<span class="nc" id="L518">			dao.cleanUp();</span>
<span class="nc" id="L519">			methodFinish();</span>
<span class="nc" id="L520">		}</span>
<span class="nc" id="L521">	}</span>

	/**
	 * delete a campaign's organization assignments given the assignment ids
	 */
	public void deleteCampaignOrgAssignments(Collection&lt;ID&gt; colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L527">		methodStart(&quot;deleteCampaignOrgAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L528">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="nc" id="L530">			dao.deleteCampaignOrgAssignments(colIDAssignments);</span>
<span class="nc" id="L531">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L532">			handleException(e);</span>
<span class="nc" id="L533">			throw e;</span>
		} finally {
<span class="nc" id="L535">			dao.cleanUp();</span>
<span class="nc" id="L536">			methodFinish();</span>
<span class="nc" id="L537">		}</span>
<span class="nc" id="L538">	}</span>

	/**
	 * Because each scheduling period has a choice of biz rule, we need to
	 * implement this method piecewise Only scheduling periods
	 *
	 * @return a collection of CampaignWorkResource objects which hold the
	 * assignment information including start and end dates
	 */
	public Collection&lt;CampaignWorkResource&gt; getCampaignWorkResourceAssignments(ID campaignID, Date startDate, Date endDate)
			throws BbmFinderException {
<span class="nc" id="L549">		methodStart(&quot;getCampaignWorkResourceAssignments&quot;, campaignID, startDate, endDate);</span>

		try {
			// break down the campaign into its scheduling periods
<span class="nc" id="L553">			Collection&lt;SchedulingPeriod&gt; schedulingPeriods = getSchedulingPeriods(campaignID, startDate, endDate);</span>

			// for each scheduling period find resources based on that period's
			// biz rule
<span class="nc" id="L557">			Collection&lt;CampaignWorkResource&gt; result = new ArrayList&lt;CampaignWorkResource&gt;();</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">			for (SchedulingPeriod schedulingPeriod : schedulingPeriods) {</span>
<span class="nc" id="L559">				result.addAll(getCampaignWorkResourceAssignments(schedulingPeriod));</span>
<span class="nc" id="L560">			}</span>

<span class="nc" id="L562">			return result;</span>
<span class="nc" id="L563">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L564">			handleException(e, false);</span>
<span class="nc" id="L565">			throw e;</span>
		} finally {
<span class="nc" id="L567">			methodFinish();</span>
		}
	}

	/**
	 * Because each scheduling period has a choice of biz rule, we need to
	 * implement this method piecewise Only scheduling periods
	 *
	 * @return a collection of CampaignWorkResource objects which hold the
	 *         assignment information including start and end dates
	 */
	public Collection&lt;CampaignWorkResource&gt; getCampaignWorkResourceAssignments(ID campaignID, Date startDate, Date endDate,
			Collection&lt;ID&gt; orgIDs, ID employeeType) throws BbmFinderException {
<span class="nc" id="L580">		methodStart(&quot;getCampaignWorkResourceAssignments&quot;, campaignID, startDate, endDate, orgIDs, employeeType);</span>

		try {
			// break down the campaign into its scheduling periods
<span class="nc" id="L584">			Collection&lt;SchedulingPeriod&gt; schedulingPeriods = getSchedulingPeriods(campaignID, startDate, endDate);</span>

			// for each scheduling period find resources based on that period's
			// biz rule
<span class="nc" id="L588">			Collection&lt;CampaignWorkResource&gt; result = new ArrayList&lt;CampaignWorkResource&gt;();</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">			for (SchedulingPeriod schedulingPeriod : schedulingPeriods) {</span>
<span class="nc" id="L590">				result.addAll(getCampaignWorkResourceAssignments(schedulingPeriod, orgIDs, employeeType));</span>
<span class="nc" id="L591">			}</span>

<span class="nc" id="L593">			return result;</span>
<span class="nc" id="L594">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L595">			handleException(e, false);</span>
<span class="nc" id="L596">			throw e;</span>
		} finally {
<span class="nc" id="L598">			methodFinish();</span>
		}
	}

	public Collection&lt;CampaignWorkResource&gt; getCampaignWorkResourceAssignments(SchedulingPeriod schedulingPeriod)
			throws BbmFinderException {
<span class="nc" id="L604">		methodStart(&quot;getCampaignWorkResourceAssignments&quot;, schedulingPeriod);</span>

<span class="nc" id="L606">		CampaignWorkResourceDAO dao = null;</span>
		try {
<span class="nc" id="L608">			dao = new CampaignWorkResourceDAO();</span>
<span class="nc" id="L609">			Collection&lt;CampaignWorkResource&gt; schedulingPeriodResources = new ArrayList&lt;CampaignWorkResource&gt;();</span>

<span class="nc bnc" id="L611" title="All 2 branches missed.">			if (schedulingPeriod.isUsingAllEmployees()) {</span>
<span class="nc" id="L612">				schedulingPeriodResources = dao.getCampaignWorkResourceAssignmentsByLinkedOrganizations(schedulingPeriod);</span>
			} else {
<span class="nc" id="L614">				schedulingPeriodResources = dao.getCampaignWorkResourceAssignmentsByLinkedEmployees(schedulingPeriod);</span>
			}
<span class="nc" id="L616">			return schedulingPeriodResources;</span>
<span class="nc" id="L617">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L618">			handleException(e, false);</span>
<span class="nc" id="L619">			throw e;</span>
		} finally {
<span class="nc bnc" id="L621" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L622">				dao.cleanUp();</span>
			}
<span class="nc" id="L624">			methodFinish();</span>
		}
	}

	public Collection&lt;CampaignWorkResource&gt; getCampaignWorkResourceAssignments(SchedulingPeriod schedulingPeriod,
			Collection&lt;ID&gt; orgIDs, ID employeeType) throws BbmFinderException {
<span class="nc" id="L630">		methodStart(&quot;getCampaignWorkResourceAssignments&quot;, schedulingPeriod, orgIDs, employeeType);</span>

<span class="nc" id="L632">		CampaignWorkResourceDAO dao = null;</span>
		try {
<span class="nc" id="L634">			dao = new CampaignWorkResourceDAO();</span>
<span class="nc" id="L635">			Collection&lt;CampaignWorkResource&gt; schedulingPeriodResources = new ArrayList&lt;CampaignWorkResource&gt;();</span>

<span class="nc bnc" id="L637" title="All 2 branches missed.">			if (schedulingPeriod.isUsingAllEmployees()) {</span>
<span class="nc" id="L638">				schedulingPeriodResources = dao.getCampaignWorkResourceAssignmentsByLinkedOrganizations(schedulingPeriod, orgIDs, employeeType);</span>
			} else {
<span class="nc" id="L640">				schedulingPeriodResources = dao.getCampaignWorkResourceAssignmentsByLinkedEmployees(schedulingPeriod, orgIDs, employeeType);</span>
			}
<span class="nc" id="L642">			return schedulingPeriodResources;</span>
<span class="nc" id="L643">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L644">			handleException(e, false);</span>
<span class="nc" id="L645">			throw e;</span>
		} finally {
<span class="nc bnc" id="L647" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L648">				dao.cleanUp();</span>
			}
<span class="nc" id="L650">			methodFinish();</span>
		}
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	public Collection&lt;ID&gt; getWorkResourceIDsBySchedulingPeriod(SchedulingPeriod schedulingPeriod) throws BbmFinderException {
<span class="nc" id="L656">		methodStart(&quot;getWorkResourceIDs&quot;, schedulingPeriod);</span>
		try {

<span class="nc" id="L659">			Collection&lt;CampaignWorkResource&gt; campaignWorkResources = getCampaignWorkResourceAssignments(schedulingPeriod);</span>

			// Extract employee ids from collection
<span class="nc" id="L662">			List&lt;ID&gt; workResourceIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">			for (CampaignWorkResource campaignWorkResource : campaignWorkResources) {</span>
<span class="nc" id="L664">				workResourceIDs.add(campaignWorkResource.getWorkResourceID());</span>
<span class="nc" id="L665">			}</span>
<span class="nc" id="L666">			return workResourceIDs;</span>
<span class="nc" id="L667">		} catch (Exception e) {</span>
<span class="nc" id="L668">			handleException(e, false);</span>
<span class="nc" id="L669">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L671">			methodFinish();</span>
		}
	}

	/**
	 * get the pooler assignments for the given set of Scheduling Periods.
	 *
	 * @return a collection of work resource IDs which are poolers at any of the
	 * given scheduling periods.
	 * @spIDs a collection of IDs of scheduling periods for which we want to
	 * retrieve the pooling assignments.
	 */
	public Collection&lt;ID&gt; getSPPoolerAssignments(Collection&lt;ID&gt; spIDs) throws BbmFinderException {
<span class="nc" id="L684">		methodStart(&quot;getSPPoolerAssignments&quot;, spIDs);</span>
<span class="nc" id="L685">		CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
		try {
<span class="nc" id="L687">			return dao.getSPPoolerAssignments(spIDs);</span>
<span class="nc" id="L688">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L689">			handleException(e, false);</span>
<span class="nc" id="L690">			throw e;</span>
		} finally {
<span class="nc" id="L692">			dao.cleanUp();</span>
<span class="nc" id="L693">			methodFinish();</span>
		}
	}

	/**
	 * get the pooler assignments for the given Scheduling Period between the
	 * given date range.
	 *
	 * @return a collection of work resource IDs which are poolers at the given
	 * scheduling period during the given time frame.
	 * @spID sp id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;ID&gt; getSPPoolerAssignments(ID spID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L707">		methodStart(&quot;getSPPoolerAssignments&quot;, spID, dtStart, dtEnd);</span>
<span class="nc" id="L708">		CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
		try {
<span class="nc" id="L710">			return dao.getSPPoolerAssignments(spID, dtStart, dtEnd);</span>
<span class="nc" id="L711">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L712">			handleException(e, false);</span>
<span class="nc" id="L713">			throw e;</span>
		} finally {
<span class="nc" id="L715">			dao.cleanUp();</span>
<span class="nc" id="L716">			methodFinish();</span>
		}
	}

	/**
	 * For a collection of work resource ids (usually employee ids) and a date
	 * range, return a map of work resource ids to the campaigns they are
	 * assigned to. Different logic based on weather constituent scheduling
	 * period.isUsingAllEmployees() is true or false
	 *
	 * @param startDate null treated as unlimited
	 * @param endDate   null treated as unlimited
	 */
	public Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; getWorkResourceCampaignAssignments(Collection&lt;ID&gt; workResourceIDs,
			Date startDate, Date endDate) throws BbmFinderException {
<span class="nc" id="L731">		methodStart(&quot;getWorkResourceCampaignAssignments&quot;, workResourceIDs, startDate, endDate);</span>

<span class="nc" id="L733">		CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
		try {
<span class="nc" id="L735">			Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; manualAssignmentMap = dao</span>
<span class="nc" id="L736">					.getCampaignWorkResourceAssignmentsByLinkedEmployees(workResourceIDs, startDate, endDate);</span>
<span class="nc" id="L737">			Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; byOrganizationAssignmentMap = dao</span>
<span class="nc" id="L738">					.getCampaignWorkResourceAssignmentsByLinkedOrganizations(workResourceIDs, startDate, endDate);</span>
<span class="nc" id="L739">			Map&lt;ID, List&lt;CampaignWorkResource&gt;&gt; mergedAssignmentMap = CollectionUtil.mergeIdCollectionMaps(</span>
					manualAssignmentMap, byOrganizationAssignmentMap);
<span class="nc" id="L741">			return mergedAssignmentMap;</span>
<span class="nc" id="L742">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L743">			handleException(e, false);</span>
<span class="nc" id="L744">			throw e;</span>
		} finally {
<span class="nc" id="L746">			dao.cleanUp();</span>
<span class="nc" id="L747">			methodFinish();</span>
		}
	}

	/**
	 * For one work resource id and a date range, return a list of campaigns
	 * they are assigned to. Special case of multiple work resource ids.
	 *
	 * @param startDate null treated as unlimited
	 * @param endDate   null treated as unlimited
	 * @return A list of CampaignWorkResource objects which hold the assignment
	 * information
	 */
	public List&lt;CampaignWorkResource&gt; getWorkResourceCampaignAssignments(ID workResourceID, Date startDate, Date endDate)
			throws BbmFinderException {
<span class="nc" id="L762">		methodStart(&quot;getWorkResourceCampaignAssignments&quot;, workResourceID, startDate, endDate);</span>
		try {
<span class="nc" id="L764">			List&lt;CampaignWorkResource&gt; campaignWorkResources = getWorkResourceCampaignAssignments(</span>
<span class="nc" id="L765">					Arrays.asList(workResourceID), startDate, endDate).get(workResourceID);</span>
<span class="nc" id="L766">			return campaignWorkResources;</span>
		} finally {
<span class="nc" id="L768">			methodFinish();</span>
		}
	}

	/**
	 * get a given campaign's queue assignments
	 *
	 * @return a collection of CampaignQueue objects which hold the assignment
	 * information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;CampaignQueue&gt; getCampaignQueueAssignments(ID idCampaign, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L781">		methodStart(&quot;getCampaignQueueAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L782">		CampaignQueueDAO dao = new CampaignQueueDAO();</span>
		try {
<span class="nc" id="L784">			return dao.getCampaignQueueAssignments(idCampaign, null, dtStart, dtEnd, false);</span>
<span class="nc" id="L785">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L786">			handleException(e, false);</span>
<span class="nc" id="L787">			throw e;</span>
		} finally {
<span class="nc" id="L789">			dao.cleanUp();</span>
<span class="nc" id="L790">			methodFinish();</span>
		}
	}

	public Collection&lt;CampaignQueue&gt; getCampaignQueueAssignmentsAndCombinedQueues(ID idCampaign, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L796">		methodStart(&quot;getCampaignQueueAssignmentsAndCombinedQueues&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L797">		CampaignQueueDAO dao = new CampaignQueueDAO();</span>
		try {
<span class="nc" id="L799">			return dao.getCampaignQueueAssignments(idCampaign, null, dtStart, dtEnd, true);</span>
<span class="nc" id="L800">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L801">			handleException(e, false);</span>
<span class="nc" id="L802">			throw e;</span>
		} finally {
<span class="nc" id="L804">			dao.cleanUp();</span>
<span class="nc" id="L805">			methodFinish();</span>
		}
	}

	public Collection&lt;CampaignQueue&gt; getCampaignQueueAndLinkedSubQueueAssignments(ID idCampaign, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L811">		methodStart(&quot;getCampaignQueueAndLinkedSubQueueAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L812">		CampaignQueueDAO dao = new CampaignQueueDAO();</span>
		try {
<span class="nc" id="L814">			return dao.getCampaignQueueAndLinkedSubQueueAssignments(idCampaign, null, dtStart, dtEnd);</span>
<span class="nc" id="L815">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L816">			handleException(e, false);</span>
<span class="nc" id="L817">			throw e;</span>
		} finally {
<span class="nc" id="L819">			dao.cleanUp();</span>
<span class="nc" id="L820">			methodFinish();</span>
		}
	}

	public Collection&lt;CampaignQueue&gt; getQueueCampaignAssignments(ID idQueue, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L825">		methodStart(&quot;getQueueCampaignAssignments&quot;, idQueue, dtStart, dtEnd);</span>
<span class="nc" id="L826">		CampaignQueueDAO dao = new CampaignQueueDAO();</span>
		try {
<span class="nc" id="L828">			return dao.getQueueCampaignAssignments(idQueue, dtStart, dtEnd);</span>
<span class="nc" id="L829">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L830">			handleException(e, false);</span>
<span class="nc" id="L831">			throw e;</span>
		} finally {
<span class="nc" id="L833">			dao.cleanUp();</span>
<span class="nc" id="L834">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; getSubCampaignIDs(ID idCampaign) throws BbmFinderException {
<span class="nc" id="L839">		methodStart(&quot;getSubCampaignIDs&quot;, idCampaign);</span>
<span class="nc" id="L840">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="nc" id="L842">			return dao.getSubCampaignIDs(idCampaign);</span>
<span class="nc" id="L843">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L844">			handleException(e, false);</span>
<span class="nc" id="L845">			throw e;</span>
		} finally {
<span class="nc" id="L847">			dao.cleanUp();</span>
<span class="nc" id="L848">			methodFinish();</span>
		}
	}

	public Collection getCampaignQueueAssignments(ID idCampaign, ID idMedia, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L854">		methodStart(&quot;getCampaignQueueAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L855">		CampaignQueueDAO dao = new CampaignQueueDAO();</span>
		try {
<span class="nc" id="L857">			return dao.getCampaignQueueAssignments(idCampaign, idMedia, dtStart, dtEnd, false);</span>
<span class="nc" id="L858">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L859">			handleException(e, false);</span>
<span class="nc" id="L860">			throw e;</span>
		} finally {
<span class="nc" id="L862">			dao.cleanUp();</span>
<span class="nc" id="L863">			methodFinish();</span>
		}
	}

	/**
	 * get a given campaign's hours's of operation (HOO)
	 *
	 * @param idCampaign      : campaign id
	 * @param dtStart         :
	 * @param dtEnd           : the time period, null date means a open period
	 * @param includeSubCamps : true if you want to include SPHOO's from sub-campaigns as
	 *                        well.
	 * @return a collection of CampaignHOO objects which hold the assignment
	 * information
	 */
	public Collection&lt;CampaignHOO&gt; getCampaignHOOAssignments(ID idCampaign, Date dtStart, Date dtEnd, boolean includeSubCamps)
			throws BbmFinderException {
<span class="nc" id="L880">		methodStart(&quot;getCampaignHOOAssignments&quot;, idCampaign, dtStart, dtEnd, includeSubCamps);</span>
<span class="nc" id="L881">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L883">			return dao.getCampaignHOOAssignments(idCampaign, dtStart, dtEnd, includeSubCamps);</span>
<span class="nc" id="L884">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L885">			handleException(e, false);</span>
<span class="nc" id="L886">			throw e;</span>
		} finally {
<span class="nc" id="L888">			dao.cleanUp();</span>
<span class="nc" id="L889">			methodFinish();</span>
		}
	}

	/**
	 * get a given campaign's hours's of operation (HOO)
	 *
	 * @return a collection of CampaignHOO objects which hold the assignment
	 * information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;CampaignHOO&gt; getCampaignHOOAssignments(ID idCampaign, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L903">		methodStart(&quot;getCampaignHOOAssignments&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L904">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L906">			return dao.getCampaignHOOAssignments(idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L907">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L908">			handleException(e, false);</span>
<span class="nc" id="L909">			throw e;</span>
		} finally {
<span class="nc" id="L911">			dao.cleanUp();</span>
<span class="nc" id="L912">			methodFinish();</span>
		}
	}

	/**
	 * get a given campaign's hours's of operation (HOO)
	 *
	 * @return a collection of CampaignHOO objects which hold the assignment
	 * information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public List&lt;CampaignHOO&gt; getCampaignHOOAssignmentsBySP(ID idSP) throws BbmFinderException {
<span class="nc" id="L925">		methodStart(&quot;getCampaignHOOAssignmentsBySP&quot;, idSP);</span>
<span class="nc" id="L926">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L928">			return dao.getCampaignHOOAssignmentsBySP(idSP);</span>
<span class="nc" id="L929">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L930">			handleException(e, false);</span>
<span class="nc" id="L931">			throw e;</span>
		} finally {
<span class="nc" id="L933">			dao.cleanUp();</span>
<span class="nc" id="L934">			methodFinish();</span>
		}
	}

	/**
	 * fetch a collection of HOO for the given campaign and using campaign TZ to
	 * prepare the HOOPeriod object. HOOPeriod differ from HOO since it is not a
	 * template but a daily definition of HOO in the given period.
	 */
	public HOOPeriod getHOOPeriod(ID idCampaign, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L944">		methodStart(&quot;getHOOPeriod&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L945">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L947">			return dao.getHOOPeriod(idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L948">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L949">			handleException(e, false);</span>
<span class="nc" id="L950">			throw e;</span>
		} finally {
<span class="nc" id="L952">			dao.cleanUp();</span>
<span class="nc" id="L953">			methodFinish();</span>
		}
	}

	/**
	 * create a campaign's HOO assignment
	 */
	public ID createCampaignHOOAssignment(CampaignHOO objValue) throws BbmCreateException {
<span class="nc" id="L961">		methodStart(&quot;createCampaignHOOAssignment&quot;, objValue);</span>
<span class="nc" id="L962">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L964">			return dao.createCampaignHOOAssignment(objValue);</span>
<span class="nc" id="L965">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L966">			handleException(e);</span>
<span class="nc" id="L967">			throw e;</span>
		} finally {
<span class="nc" id="L969">			dao.cleanUp();</span>
<span class="nc" id="L970">			methodFinish();</span>
		}
	}

	/**
	 * save a campaign's HOO assignment
	 */
	public void updateCampaignHOOAssignment(CampaignHOO objValue) throws BbmUpdateException {
<span class="nc" id="L978">		methodStart(&quot;updateCampaignHOOAssignment&quot;, objValue);</span>
<span class="nc" id="L979">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L981">			dao.updateCampaignHOOAssignment(objValue);</span>
<span class="nc" id="L982">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L983">			handleException(e);</span>
<span class="nc" id="L984">			throw e;</span>
		} finally {
<span class="nc" id="L986">			dao.cleanUp();</span>
<span class="nc" id="L987">			methodFinish();</span>
<span class="nc" id="L988">		}</span>
<span class="nc" id="L989">	}</span>

	/**
	 * delete a campaign's HOO assignments given the assignment ids
	 */
	public void deleteCampaignHOOAssignments(Collection colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L995">		methodStart(&quot;deleteCampaignHOOAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L996">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L998">			dao.deleteCampaignHOOAssignments(colIDAssignments);</span>
<span class="nc" id="L999">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1000">			handleException(e);</span>
<span class="nc" id="L1001">			throw e;</span>
		} finally {
<span class="nc" id="L1003">			dao.cleanUp();</span>
<span class="nc" id="L1004">			methodFinish();</span>
<span class="nc" id="L1005">		}</span>
<span class="nc" id="L1006">	}</span>

	/**
	 * return a hashmap of (idCampaign, idName)
	 */
	public HashMap getCampaignNamesByIDs(Collection colCampaignIDs) throws BbmFinderException {
<span class="nc" id="L1012">		methodStart(&quot;getCampaignNamesByIDs&quot;, colCampaignIDs);</span>
		try {
<span class="nc" id="L1014">			return CampaignDAO.getCampaignNamesByIDs(colCampaignIDs);</span>
<span class="nc" id="L1015">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1016">			handleException(e, false);</span>
<span class="nc" id="L1017">			throw e;</span>
		} finally {
<span class="nc" id="L1019">			methodFinish();</span>
		}
	}

	/**
	 * Creates a scheduling period
	 *
	 * @return ID of the created scheduling period
	 * @objValue the scheduling period value object
	 */
	public ID createSchedulingPeriod(SchedulingPeriod objValue) throws BbmCreateException {
<span class="nc" id="L1030">		methodStart(&quot;createSchedulingPeriod&quot;, objValue);</span>
<span class="nc" id="L1031">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1033">			return dao.createSchedulingPeriod(objValue);</span>
<span class="nc" id="L1034">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1035">			handleException(e, false);</span>
<span class="nc" id="L1036">			throw e;</span>
<span class="nc" id="L1037">		} catch (Exception e) {</span>
<span class="nc" id="L1038">			handleException(e);</span>
<span class="nc" id="L1039">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc bnc" id="L1041" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1042">				dao.cleanUp();</span>
			}
<span class="nc" id="L1044">			methodFinish();</span>
		}
	}

	/**
	 * Updates a collection of scheduling periods
	 *
	 * @return void
	 * @colObjValues the scheduling period collection of value objects
	 */
	public void updateSchedulingPeriods(Collection&lt;SchedulingPeriod&gt; colObjValues) throws BbmUpdateException,
			MultiUserException {
<span class="nc" id="L1056">		methodStart(&quot;updateSchedulingPeriods&quot;);</span>
<span class="nc" id="L1057">		SchedulingPeriodDAO dao = null;</span>
		try {
<span class="nc" id="L1059">			dao = new SchedulingPeriodDAO();</span>
<span class="nc" id="L1060">			dao.updateSchedulingPeriods(colObjValues);</span>
<span class="nc" id="L1061">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1062">			handleException(e, false);</span>
<span class="nc" id="L1063">			throw e;</span>
<span class="nc" id="L1064">		} catch (Exception e) {</span>
<span class="nc" id="L1065">			handleException(e);</span>
<span class="nc" id="L1066">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc bnc" id="L1068" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1069">				dao.cleanUp();</span>
			}
<span class="nc" id="L1071">			methodFinish();</span>
<span class="nc" id="L1072">		}</span>
<span class="nc" id="L1073">	}</span>

	/**
	 * Deletes a collection of scheduling periods
	 *
	 * @return void
	 * @colIDs collection of ids of scheduling periods to be deleted
	 */
	public void deleteSchedulingPeriods(Collection&lt;ID&gt; colIDs) throws BbmRemoveException, MultiUserException {
<span class="nc" id="L1082">		methodStart(&quot;deleteSchedulingPeriods&quot;);</span>
<span class="nc" id="L1083">		SchedulingPeriodDAO dao = null;</span>
		try {
<span class="nc" id="L1085">			dao = new SchedulingPeriodDAO();</span>
<span class="nc" id="L1086">			dao.deleteSchedulingPeriods(colIDs);</span>
<span class="nc" id="L1087">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1088">			handleException(e, false);</span>
<span class="nc" id="L1089">			throw e;</span>
<span class="nc" id="L1090">		} catch (Exception e) {</span>
<span class="nc" id="L1091">			handleException(e);</span>
<span class="nc" id="L1092">			throw new BbmRemoveException(e);</span>
		} finally {
<span class="nc bnc" id="L1094" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1095">				dao.cleanUp();</span>
			}
<span class="nc" id="L1097">			methodFinish();</span>
<span class="nc" id="L1098">		}</span>
<span class="nc" id="L1099">	}</span>

	/**
	 * get scheduling periods for a campaign
	 *
	 * @return a collection of SchedulingPeriod objects which hold the
	 * assignment information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L1111">		methodStart(&quot;getSchedulingPeriods&quot;, idCampaign, dtStart, dtEnd);</span>
<span class="nc" id="L1112">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1114">			return dao.getSchedulingPeriods(idCampaign, dtStart, dtEnd, null, null);</span>
<span class="nc" id="L1115">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1116">			handleException(e, false);</span>
<span class="nc" id="L1117">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1119" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1120">				dao.cleanUp();</span>
			}
<span class="nc" id="L1122">			methodFinish();</span>
		}
	}

	/**
	 * get scheduling periods for a campaign and linked to a org
	 *
	 * @return a collection of SchedulingPeriod objects which hold the
	 * assignment information
	 * @idCampaign campaign id
	 * @idOrg organization id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, ID idOrg, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L1137">		methodStart(&quot;getSchedulingPeriods&quot;, idCampaign, idOrg, dtStart, dtEnd);</span>
<span class="nc" id="L1138">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1140">			return dao.getSchedulingPeriods(idCampaign, idOrg, dtStart, dtEnd, null, null);</span>
<span class="nc" id="L1141">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1142">			handleException(e, false);</span>
<span class="nc" id="L1143">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1145" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1146">				dao.cleanUp();</span>
			}
<span class="nc" id="L1148">			methodFinish();</span>
		}
	}

	/**
	 * get a campaign workresource assignment object by id
	 */
	public CampaignWorkResource getCampaignWorkResourceAssignmentByID(ID idAssignment) throws BbmFinderException {
<span class="nc" id="L1156">		methodStart(&quot;getCampaignWorkResourceAssignmentByID&quot;, idAssignment);</span>
<span class="nc" id="L1157">		CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
		try {
<span class="nc" id="L1159">			return dao.getCampaignWorkResourceAssignmentByID(idAssignment);</span>
<span class="nc" id="L1160">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1161">			handleException(e, false);</span>
<span class="nc" id="L1162">			throw e;</span>
		} finally {
<span class="nc" id="L1164">			dao.cleanUp();</span>
<span class="nc" id="L1165">			methodFinish();</span>
		}
	}

	/**
	 * get campaign workresource assignments given their ids
	 */
	public Collection getCampaignWorkResourceAssignmentsByIDs(Collection colAssignmentIDs) throws BbmFinderException {
<span class="nc" id="L1173">		methodStart(&quot;getCampaignWorkResourceAssignmentsByIDs&quot;, colAssignmentIDs);</span>
<span class="nc" id="L1174">		CampaignWorkResourceDAO dao = new CampaignWorkResourceDAO();</span>
		try {
<span class="nc" id="L1176">			return dao.getCampaignWorkResourceAssignmentsByIDs(colAssignmentIDs);</span>
<span class="nc" id="L1177">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1178">			handleException(e, false);</span>
<span class="nc" id="L1179">			throw e;</span>
		} finally {
<span class="nc" id="L1181">			dao.cleanUp();</span>
<span class="nc" id="L1182">			methodFinish();</span>
		}
	}

	/**
	 * get a campaignHOO object by id
	 */
	public CampaignHOO getCampaignHOOAssignmentByID(ID idAssignment) throws BbmFinderException {
<span class="nc" id="L1190">		methodStart(&quot;getCampaignHOOAssignmentByID&quot;, idAssignment);</span>
<span class="nc" id="L1191">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L1193">			return dao.getCampaignHOOAssignmentByID(idAssignment);</span>
<span class="nc" id="L1194">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1195">			handleException(e, false);</span>
<span class="nc" id="L1196">			throw e;</span>
		} finally {
<span class="nc" id="L1198">			dao.cleanUp();</span>
<span class="nc" id="L1199">			methodFinish();</span>
		}
	}

	/**
	 * Returns the SchedulingPeriod matching the given ID.  This Scheduling Period will have its
	 * local start and end times set.
	 * @param idSP - The integer ID of the scheduling period.
	 * @return The Scheduling Period object matching the given ID.
	 * @throws BbmFinderException
	 * @throws BbmObjectNotFoundException
	 */
	public SchedulingPeriod getSchedulingPeriodByID(ID idSP) throws BbmFinderException, BbmObjectNotFoundException {
<span class="nc" id="L1212">		methodStart(&quot;getSchedulingPeriodByID&quot;, idSP);</span>
<span class="nc" id="L1213">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1215">			Collection&lt;SchedulingPeriod&gt; schedulingPeriods = dao.getSchedulingPeriods(null, null, null, idSP, null);</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">			if (schedulingPeriods.isEmpty()) {</span>
<span class="nc" id="L1217">				return null;</span>
			}
<span class="nc" id="L1219">			SchedulingPeriod sp = schedulingPeriods.iterator().next();</span>

<span class="nc" id="L1221">			Campaign campaign = this.getCampaignByID(sp.getCampaignID());</span>
<span class="nc" id="L1222">			TimeZone tz = campaign.getTimeZone();</span>
<span class="nc" id="L1223">			sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), tz));</span>
<span class="nc" id="L1224">			sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), tz));</span>

<span class="nc" id="L1226">			return sp;</span>
<span class="nc" id="L1227">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1228">			handleException(e, false);</span>
<span class="nc" id="L1229">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1231" title="All 6 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1232">				dao.cleanUp();</span>
			}
<span class="nc" id="L1234">			methodFinish();</span>
		}
	}

	/**
	 * get scheduling period by id
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByID(Collection&lt;ID&gt; cSP) throws BbmFinderException, BbmObjectNotFoundException {
<span class="nc" id="L1242">		methodStart(&quot;getSchedulingPeriodsByID&quot;, cSP);</span>
<span class="nc" id="L1243">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1245">			return dao.getSchedulingPeriods(null, null, null, null, cSP);</span>
<span class="nc" id="L1246">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1247">			handleException(e, false);</span>
<span class="nc" id="L1248">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1250" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1251">				dao.cleanUp();</span>
			}
<span class="nc" id="L1253">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; getSchedulingPeriodOrgs(ID sp, Collection&lt;ID&gt; orgs) throws BbmFinderException, BbmObjectNotFoundException {
<span class="nc" id="L1258">		methodStart(&quot;getSchedulingPeriodOrgs&quot;, sp, orgs);</span>
<span class="nc" id="L1259">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1261">			return dao.getLinkedOrgsforSP(sp, orgs);</span>
<span class="nc" id="L1262">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1263">			handleException(e, false);</span>
<span class="nc" id="L1264">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1266" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1267">				dao.cleanUp();</span>
			}
<span class="nc" id="L1269">			methodFinish();</span>
		}
	}

	/**
	 * create campaign HOO based on its linked organization HOO.
	 * &lt;p&gt;
	 * 1. do not create any campaignHOO if the campaign already has an hours of
	 * operation. 2. set campaign HOO to be the same as the organization HOO if
	 * they have the same time zone.
	 *
	 * @return the campaignHOO ID if created successfully
	 */
	public ID createCampaignHOOFromOrg(ID idCampaign, ID idOrg) throws BbmCreateException {
<span class="nc" id="L1283">		methodStart(&quot;createCampaignHOOFromOrg&quot;, idCampaign, idOrg);</span>
<span class="nc" id="L1284">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L1286">			return dao.createCampaignHOOFromOrg(idCampaign, idOrg);</span>
<span class="nc" id="L1287">		} catch (Exception e) {</span>
<span class="nc" id="L1288">			handleException(e);</span>
<span class="nc" id="L1289">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L1291">			dao.cleanUp();</span>
<span class="nc" id="L1292">			methodFinish();</span>
		}
	}

	public Map getSchedulingParameters(ID idSchedulingPeriod) throws BbmFinderException {
<span class="nc" id="L1297">		methodStart(&quot;getSchedulingParameters&quot;, idSchedulingPeriod);</span>
		try {
<span class="nc" id="L1299">			return new SPParamDAO().getSchedulingParameters(idSchedulingPeriod);</span>
<span class="nc" id="L1300">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1301">			handleException(e);</span>
<span class="nc" id="L1302">			throw e;</span>
		} finally {
<span class="nc" id="L1304">			methodFinish();</span>
		}
	}

	public void setSchedulingParameters(ID idSchedulingPeriod, Map mParameters, String sEmployees) throws BbmCreateException {
<span class="nc" id="L1309">		methodStart(&quot;setSchedulingParameters&quot;, idSchedulingPeriod, mParameters, sEmployees);</span>
		try {
<span class="nc" id="L1311">			new SPParamDAO().setSchedulingParameters(idSchedulingPeriod, mParameters, sEmployees);</span>
<span class="nc" id="L1312">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1313">			handleException(e);</span>
<span class="nc" id="L1314">			throw e;</span>
		} finally {
<span class="nc" id="L1316">			methodFinish();</span>
<span class="nc" id="L1317">		}</span>
<span class="nc" id="L1318">	}</span>

	public ID getMostRecentSPWithParameters(Date dtStart, ID idCampaign) throws BbmFinderException {
<span class="nc" id="L1321">		methodStart(&quot;getMostRecentSPWithParameters&quot;, dtStart, idCampaign);</span>
		try {
<span class="nc" id="L1323">			return new SPParamDAO().getMostRecentSPWithParameters(dtStart, idCampaign);</span>
<span class="nc" id="L1324">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1325">			handleException(e);</span>
<span class="nc" id="L1326">			throw e;</span>
		} finally {
<span class="nc" id="L1328">			methodFinish();</span>
		}
	}

	public Pair getDirtyStatus(ID idSchedulingPeriod) throws BbmFinderException {
<span class="nc" id="L1333">		methodStart(&quot;getDirtyStatus&quot;, idSchedulingPeriod);</span>
		try {
<span class="nc" id="L1335">			return new SPParamDAO().getDirtyStatus(idSchedulingPeriod);</span>
<span class="nc" id="L1336">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1337">			handleException(e);</span>
<span class="nc" id="L1338">			throw e;</span>
		} finally {
<span class="nc" id="L1340">			methodFinish();</span>
		}
	}

	public Collection&lt;SchedulingPeriod&gt; getCommonSchedulingPeriods(ID campaignID, Collection&lt;ID&gt; employeeIDs, Date date, int nNumberToGet) throws BbmFinderException {

<span class="nc" id="L1346">		methodStart(&quot;getCommonSchedulingPeriods&quot;, campaignID, date);</span>
<span class="nc" id="L1347">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1349">			Collection&lt;SchedulingPeriod&gt; schedulingPeriods = dao.getCommonSchedulingPeriods(campaignID, employeeIDs, date, nNumberToGet);</span>
<span class="nc" id="L1350">			return convertSchedulingPeriodDatesToCampaignTZ(campaignID, schedulingPeriods);</span>

<span class="nc" id="L1352">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1353">			handleException(e);</span>
<span class="nc" id="L1354">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1356" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1357">				dao.cleanUp();</span>
			}
<span class="nc" id="L1359">			methodFinish();</span>
		}

	}

	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(ID idCampaign, Date dtDate, int nNumberToGet, int eTimeFrame)
			throws BbmFinderException {
<span class="nc" id="L1366">		methodStart(&quot;getSchedulingPeriods&quot;, idCampaign, dtDate);</span>
<span class="nc" id="L1367">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1369">			Collection&lt;SchedulingPeriod&gt; schedulingPeriods = dao.getSchedulingPeriods(idCampaign, dtDate, nNumberToGet,</span>
					eTimeFrame);

			// Configure the local time for the campaign time zone.
<span class="nc" id="L1373">			return convertSchedulingPeriodDatesToCampaignTZ(idCampaign, schedulingPeriods);</span>
<span class="nc" id="L1374">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1375">			handleException(e);</span>
<span class="nc" id="L1376">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1378" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1379">				dao.cleanUp();</span>
			}
<span class="nc" id="L1381">			methodFinish();</span>
		}
	}

	private Collection&lt;SchedulingPeriod&gt; convertSchedulingPeriodDatesToCampaignTZ(ID idCampaign, Collection&lt;SchedulingPeriod&gt; schedulingPeriods) throws BbmObjectNotFoundException, BbmFinderException {
<span class="nc" id="L1386">		Campaign campaign = this.getCampaignByID(idCampaign);</span>
<span class="nc" id="L1387">		TimeZone tz = campaign.getTimeZone();</span>
<span class="nc bnc" id="L1388" title="All 2 branches missed.">		for (SchedulingPeriod sp : schedulingPeriods) {</span>
<span class="nc" id="L1389">			sp.setStartTimeLocal(new LocalDate(sp.getStartTime(), tz));</span>
<span class="nc" id="L1390">			sp.setEndTimeLocal(new LocalDate(sp.getEndTime(), tz));</span>
<span class="nc" id="L1391">		}</span>
<span class="nc" id="L1392">		return schedulingPeriods;</span>
	}

	/**
	 * Gets the SP object from the SP table (as opposed to the getSP() method,
	 * which gets a SchedulingPeriod object).
	 *
	 * @param spID - The SP ID
	 * @return An SP object.
	 * @throws BbmFinderException
	 */
	public SP getRealSP(ID spID) throws BbmFinderException {
<span class="nc" id="L1404">		methodStart(&quot;getRealSP&quot;);</span>
		try {
<span class="nc" id="L1406">			return SPDAO.getSPByID(spID);</span>
<span class="nc" id="L1407">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1408">			handleException(e);</span>
<span class="nc" id="L1409">			throw e;</span>
		} finally {
<span class="nc" id="L1411">			methodFinish();</span>
		}
	}

	/**
	 * Update the SP object from the SP table (as opposed to the
	 * SchedulingPeriod object). We only update the following fields for now:
	 * FTESHIFTS, FTEWORKHOURS, FTEPAIDHOURS, FTEPHONEHOURS, FTEWAGE.
	 *
	 * @param spID - The SP ID
	 * @return An SP object.
	 * @throws BbmFinderException
	 */
	public void updateRealSP(SP sp) throws BbmUpdateException {
<span class="nc" id="L1425">		methodStart(&quot;updateRealSP&quot;);</span>
		try {
<span class="nc" id="L1427">			SPDAO.updateRealSP(sp);</span>
<span class="nc" id="L1428">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1429">			handleException(e, false);</span>
<span class="nc" id="L1430">			throw e;</span>
<span class="nc" id="L1431">		} catch (Exception e) {</span>
<span class="nc" id="L1432">			handleException(e);</span>
<span class="nc" id="L1433">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L1435">			methodFinish();</span>
<span class="nc" id="L1436">		}</span>
<span class="nc" id="L1437">	}</span>

	/**
	 * Get a SchedulingPeriod object given the SP ID.
	 *
	 * @param spID - The SP ID
	 * @return A SchedulingPeriod object.
	 * @throws BbmFinderException
	 */
	public SchedulingPeriod getSP(ID spID) throws BbmFinderException {
<span class="nc" id="L1447">		methodStart(&quot;getSP&quot;);</span>
<span class="nc" id="L1448">		SchedulingPeriodDAO dao = null;</span>
		try {
<span class="nc" id="L1450">			dao = new SchedulingPeriodDAO();</span>
<span class="nc" id="L1451">			return dao.getSchedulingPeriodByID(spID);</span>
<span class="nc" id="L1452">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1453">			handleException(e);</span>
<span class="nc" id="L1454">			throw e;</span>
		} finally {
<span class="nc" id="L1456">			methodFinish();</span>
<span class="nc bnc" id="L1457" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1458">				dao.cleanUp();</span>
			}
		}
	}

	/**
	 * Creates a sp queue
	 *
	 * @return ID of the created sp queue
	 * @objValue the sp queue value object
	 */
	public ID createSPQueue(SPQueue objValue) throws BbmCreateException, BbmTimePeriodOverlapException {
<span class="nc" id="L1470">		methodStart(&quot;createSPQueue&quot;);</span>
<span class="nc" id="L1471">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1473">			return dao.createSPQueue(objValue);</span>
<span class="nc" id="L1474">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1475">			handleException(e);</span>
<span class="nc" id="L1476">			throw e;</span>
<span class="nc" id="L1477">		} catch (BbmTimePeriodOverlapException e) {</span>
<span class="nc" id="L1478">			handleException(e);</span>
<span class="nc" id="L1479">			throw e;</span>
		} finally {
<span class="nc" id="L1481">			dao.cleanUp();</span>
<span class="nc" id="L1482">			methodFinish();</span>
		}
	}

	/**
	 * Updates an sp queue
	 *
	 * @throws MultiUserException
	 * @objValue the sp queue value object
	 */
	public void updateSPQueue(SPQueue objValue) throws BbmUpdateException, MultiUserException {
<span class="nc" id="L1493">		methodStart(&quot;updateSPQueue&quot;);</span>
<span class="nc" id="L1494">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1496">			dao.updateObject(objValue);</span>
<span class="nc bnc" id="L1497" title="All 2 branches missed.">			if (objValue.IsSkillsUpdated()) {</span>
<span class="nc" id="L1498">				dao.linkSkillsToSPQueue(objValue.getID(), objValue.getSkills());</span>
			}
<span class="nc" id="L1500">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1501">			handleException(e);</span>
<span class="nc" id="L1502">			throw e;</span>
<span class="nc" id="L1503">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1504">			handleException(e);</span>
<span class="nc" id="L1505">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L1507">			dao.cleanUp();</span>
<span class="nc" id="L1508">			methodFinish();</span>
<span class="nc" id="L1509">		}</span>
<span class="nc" id="L1510">	}</span>

	/**
	 * Updates the given collection of spqueues, and the skills associated to
	 * them (spqueueskills).
	 */
	public void updateSPQueues(Collection&lt;SPQueue&gt; spQueues) throws BbmUpdateException, MultiUserException {
<span class="nc" id="L1517">		methodStart(&quot;updateSPQueues&quot;);</span>
<span class="nc" id="L1518">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1520">			dao.updateObjects(spQueues);</span>
<span class="nc" id="L1521">			Map&lt;ID, Collection&lt;ID&gt;&gt; spQueueSkillMap = new HashMap&lt;ID, Collection&lt;ID&gt;&gt;();</span>
<span class="nc bnc" id="L1522" title="All 2 branches missed.">			for (SPQueue spQueue : spQueues) {</span>
<span class="nc bnc" id="L1523" title="All 2 branches missed.">				if (spQueue.IsSkillsUpdated()) {</span>
<span class="nc" id="L1524">					spQueueSkillMap.put(spQueue.getDEID(), spQueue.getSkills());</span>
				}
<span class="nc" id="L1526">			}</span>
<span class="nc bnc" id="L1527" title="All 2 branches missed.">			if (spQueueSkillMap.isEmpty() == false) {</span>
<span class="nc" id="L1528">				dao.linkSkillsToSPQueues(spQueueSkillMap);</span>
			}
<span class="nc" id="L1530">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1531">			handleException(e);</span>
<span class="nc" id="L1532">			throw e;</span>
<span class="nc" id="L1533">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1534">			handleException(e);</span>
<span class="nc" id="L1535">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L1537">			dao.cleanUp();</span>
<span class="nc" id="L1538">			methodFinish();</span>
<span class="nc" id="L1539">		}</span>
<span class="nc" id="L1540">	}</span>

	/**
	 * Creates the SPQueues. This method is specifically written to optimize
	 * the bulk push from the Branch Forecasting. This only reads the following
	 * fields of the SPqueue while creating the spqueues- spid, queueid, media
	 * id, service level type, patience, sl anwer waiting time.
	 */
	public SPQueueIDMap createSPQueuesWithLimitedFields(Collection&lt;SPQueue&gt; spQueues) throws BbmCreateException {
<span class="nc" id="L1549">		methodStart(&quot;createSPQueuesWithLimitedFields&quot;, spQueues);</span>
<span class="nc" id="L1550">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1552">			return dao.createSPQueuesWithLimitedFields(spQueues);</span>
<span class="nc" id="L1553">		} catch (JdmoException e) {</span>
<span class="nc" id="L1554">			handleException(e);</span>
<span class="nc" id="L1555">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L1557">			dao.cleanUp();</span>
<span class="nc" id="L1558">			methodFinish();</span>
		}
	}

	/**
	 * Updates the SPQueues. This method is specifically written to optimize
	 * the bulk push from the Branch Forecasting. This only reads the following
	 * fields of the SPqueue while updating the spqueues- spid, queueid, media
	 * id, service level type, patience, sl anwer waiting time.
	 *
	 */
	public void updateSPQueuesWithLimitedFields(Collection&lt;SPQueue&gt; spQueues) throws BbmUpdateException {
<span class="nc" id="L1570">		methodStart(&quot;updateSPQueuesWithLimitedFields&quot;, spQueues);</span>
<span class="nc" id="L1571">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1573">			dao.updateSPQueuesWithLimitedFields(spQueues);</span>
<span class="nc" id="L1574">		} catch (JdmoException e) {</span>
<span class="nc" id="L1575">			handleException(e);</span>
<span class="nc" id="L1576">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L1578">			dao.cleanUp();</span>
<span class="nc" id="L1579">			methodFinish();</span>
<span class="nc" id="L1580">		}</span>
<span class="nc" id="L1581">	}</span>

	/**
	 * Deleted a sp queue
	 *
	 * @spQueueID the ID of the sp queue to delete
	 */
	public void deleteSPQueue(ID spQueueID) throws BbmRemoveException {
<span class="nc" id="L1589">		methodStart(&quot;deleteSPQueue&quot;);</span>
<span class="nc" id="L1590">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1592">			dao.deleteSPQueue(spQueueID);</span>
<span class="nc" id="L1593">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1594">			handleException(e);</span>
<span class="nc" id="L1595">			throw e;</span>
		} finally {
<span class="nc" id="L1597">			dao.cleanUp();</span>
<span class="nc" id="L1598">			methodFinish();</span>
<span class="nc" id="L1599">		}</span>
<span class="nc" id="L1600">	}</span>

	public Collection&lt;SPQueue&gt; getSPQueues(Collection&lt;ID&gt; spQueueIDs) throws BbmFinderException {
<span class="nc" id="L1603">		methodStart(&quot;getSPQueues&quot;);</span>
<span class="nc" id="L1604">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1606">			return dao.getObjectsByIDs(spQueueIDs);</span>
<span class="nc" id="L1607">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1608">			handleException(e);</span>
<span class="nc" id="L1609">			throw e;</span>
		} finally {
<span class="nc" id="L1611">			dao.cleanUp();</span>
<span class="nc" id="L1612">			methodFinish();</span>
		}
	}

	public SPQueue getSPQueue(ID spQueueID) throws BbmFinderException {
<span class="nc" id="L1617">		methodStart(&quot;getSPQueue&quot;);</span>
<span class="nc" id="L1618">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1620">			return dao.getSPQueue(spQueueID);</span>
<span class="nc" id="L1621">		} catch (JdmoException e) {</span>
<span class="nc" id="L1622">			handleException(e);</span>
<span class="nc" id="L1623">			throw new BbmFinderException(e);</span>
<span class="nc" id="L1624">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L1625">			handleException(e);</span>
<span class="nc" id="L1626">			throw e;</span>
<span class="nc" id="L1627">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1628">			handleException(e);</span>
<span class="nc" id="L1629">			throw e;</span>
		} finally {
<span class="nc" id="L1631">			dao.cleanUp();</span>
<span class="nc" id="L1632">			methodFinish();</span>
		}
	}

	public SPQueue getSPQueue(ID spID, ID queueID) throws BbmFinderException {
<span class="nc" id="L1637">		methodStart(&quot;getSPQueue&quot;);</span>
<span class="nc" id="L1638">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1640">			ID id = SPQueueDAO.getSPQueueID(spID, queueID);</span>
<span class="nc" id="L1641">			return dao.getSPQueue(id);</span>
<span class="nc" id="L1642">		} catch (JdmoException e) {</span>
<span class="nc" id="L1643">			handleException(e);</span>
<span class="nc" id="L1644">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1646">			dao.cleanUp();</span>
<span class="nc" id="L1647">			methodFinish();</span>
		}
	}

	// SpQueueIDs are SIDs
	public Collection&lt;SPQueue&gt; getSPQueuesByIDs(Collection&lt;ID&gt; spQueueIDs) throws BbmFinderException {
<span class="nc" id="L1653">		methodStart(&quot;getSPQueuesByIDs&quot;);</span>
<span class="nc" id="L1654">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1656">			return dao.getSPQueuesByIDs(spQueueIDs);</span>
		} finally {
<span class="nc" id="L1658">			dao.cleanUp();</span>
<span class="nc" id="L1659">			methodFinish();</span>
		}
	}

	public SPQueue getCombinedSPQueue(ID spID, ID mediaID) throws BbmFinderException {
<span class="nc" id="L1664">		methodStart(&quot;getCombinedSPQueue&quot;, spID, mediaID);</span>
<span class="nc" id="L1665">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1667">			return dao.getCombinedSPQueue(spID, mediaID);</span>
<span class="nc" id="L1668">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1669">			handleException(e);</span>
<span class="nc" id="L1670">			throw e;</span>
		} finally {
<span class="nc" id="L1672">			dao.cleanUp();</span>
<span class="nc" id="L1673">			methodFinish();</span>
		}
	}

	/**
	 * Returns a list of combined SPQueues associated to (i.e. having the same
	 * SP and media ID of) the given list of spQueues.
	 */
	public Collection&lt;SPQueue&gt; getCombinedSPQueues(Collection&lt;SPQueue&gt; spQueues) throws BbmFinderException {
<span class="nc" id="L1682">		methodStart(&quot;getCombinedSPQueues&quot;, spQueues);</span>
<span class="nc" id="L1683">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1685">			return dao.getCombinedSPQueues(spQueues);</span>
<span class="nc" id="L1686">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1687">			handleException(e);</span>
<span class="nc" id="L1688">			throw e;</span>
		} finally {
<span class="nc" id="L1690">			dao.cleanUp();</span>
<span class="nc" id="L1691">			methodFinish();</span>
		}
	}

	/**
	 * @deprecated
	 */
	@Deprecated
	public Collection&lt;SPQueue&gt; getSPQueuesBySPIDs(Collection&lt;ID&gt; SPIDs) throws BbmFinderException {
<span class="nc" id="L1700">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1702">			return dao.getSPQueuesBySPIDs(SPIDs);</span>
<span class="nc" id="L1703">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1704">			handleException(e);</span>
<span class="nc" id="L1705">			throw e;</span>
<span class="nc" id="L1706">		} catch (Exception e) {</span>
<span class="nc" id="L1707">			handleException(e);</span>
<span class="nc" id="L1708">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1710">			dao.cleanUp();</span>
<span class="nc" id="L1711">			methodFinish();</span>
		}
	}

	/**
	 * Returns all non-combined SPQueues linked to the given Scheduling Periods.  For combined SPQueues in an SP, please
	 * use {@link CampaignManagerEJB#getCombinedSPQueue(ID, ID)}
	 */
	public Collection&lt;SPQueue&gt; getSPQueuesBySPIDsFixed(Collection&lt;ID&gt; SPSIDs) throws BbmFinderException {
<span class="nc" id="L1720">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1722">			return dao.getSPQueuesBySPIDsFixed(SPSIDs);</span>
<span class="nc" id="L1723">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1724">			handleException(e);</span>
<span class="nc" id="L1725">			throw e;</span>
<span class="nc" id="L1726">		} catch (Exception e) {</span>
<span class="nc" id="L1727">			handleException(e);</span>
<span class="nc" id="L1728">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1730">			dao.cleanUp();</span>
<span class="nc" id="L1731">			methodFinish();</span>
		}
	}

	/**
	 * Returns a paginated set of SPQueues for the given scheduling period. The
	 * returned value includes the following: a chunk of SPQueue value objects,
	 * representing the sp queues on the first viewed page, and a sorted list of
	 * SPQueue IDs that are sorted by the given sort fields in the comparators
	 * map.
	 */
	public PaginationPair&lt;SPQueue&gt; getPaginatedSPQueuesForSchedulingPeriod(ID spID, boolean isAscendingSort, int pageIDSize,
			int pageIndex, LinkedHashMap&lt;DBSortField, Comparator&gt; comparators, Collection&lt;ID&gt; filteredIDs)
			throws BbmFinderException {
<span class="nc" id="L1745">		methodStart(&quot;getPaginatedSPQueuesForSchedulingPeriod&quot;, spID, isAscendingSort, pageIDSize, pageIndex, comparators);</span>
<span class="nc" id="L1746">		SPQueueDAO spqDAO = new SPQueueDAO();</span>

		try {
<span class="nc" id="L1749">			return spqDAO.getCompletePaginationDataSetForSchedulingPeriod(spID, isAscendingSort, pageIDSize, pageIndex,</span>
					comparators, filteredIDs);
<span class="nc" id="L1751">		} catch (BbmFinderException ex) {</span>
<span class="nc" id="L1752">			handleException(ex);</span>
<span class="nc" id="L1753">			throw ex;</span>
		} finally {
<span class="nc" id="L1755">			spqDAO.cleanUp();</span>
<span class="nc" id="L1756">			methodFinish();</span>
		}
	}

	/*
	 * Returns the non-combined SPQueues belonging to the given SP with the
	 * specified media ID. If a null media ID is specified, it will return all
	 * non-combined SPQueues in belonging to the SP.
	 */
	public Collection&lt;SPQueue&gt; getNonCombinedSPQueuesByMediaAndSP(ID spID, ID mediaID) throws BbmFinderException {
<span class="nc" id="L1766">		methodStart(&quot;getNonCombinedSPQueuesByMediaAndSP&quot;, spID, mediaID);</span>
<span class="nc" id="L1767">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L1769">			return dao.getNonCombinedSPQueuesByMediaAndSP(spID, mediaID);</span>
<span class="nc" id="L1770">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1771">			handleException(e);</span>
<span class="nc" id="L1772">			throw e;</span>
		} finally {
<span class="nc" id="L1774">			dao.cleanUp();</span>
<span class="nc" id="L1775">			methodFinish();</span>
		}
	}

	/**
	 * Deleted collection of campaigns
	 *
	 * @colCampaignIDs the IDs of the campaigns to delete
	 */
	public void deleteCampaigns(Collection&lt;ID&gt; colCampaignIDs) throws BbmRemoveException {
<span class="nc" id="L1785">		methodStart(&quot;deleteCampaigns&quot;);</span>
		try {
<span class="nc" id="L1787">			CampaignDAO.deleteCampaigns(colCampaignIDs);</span>
<span class="nc" id="L1788">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1789">			handleException(e);</span>
<span class="nc" id="L1790">			throw e;</span>
		} finally {
<span class="nc" id="L1792">			methodFinish();</span>
<span class="nc" id="L1793">		}</span>
<span class="nc" id="L1794">	}</span>

	public void deleteAllCampaigns() throws BbmRemoveException {
<span class="nc" id="L1797">		methodStart(&quot;deleteAllCampaigns&quot;);</span>
		try {
<span class="nc" id="L1799">			CampaignDAO.deleteAllCampaigns();</span>
<span class="nc" id="L1800">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1801">			handleException(e);</span>
<span class="nc" id="L1802">			throw e;</span>
		} finally {
<span class="nc" id="L1804">			methodFinish();</span>
<span class="nc" id="L1805">		}</span>
<span class="nc" id="L1806">	}</span>

	public void unlinkWorkResourcesToSchedulingPeriod(ID spID, ID SPDEID, Collection wkrsIDs) throws BbmRemoveException {
<span class="nc" id="L1809">		methodStart(&quot;unlinkWorkResourcesToSchedulingPeriod&quot;, spID, SPDEID, wkrsIDs);</span>
<span class="nc" id="L1810">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1812">			dao.unlinkWorkResourcesToSchedulingPeriod(spID, SPDEID, wkrsIDs);</span>
<span class="nc" id="L1813">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1814">			handleException(e, false);</span>
<span class="nc" id="L1815">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1817" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1818">				dao.cleanUp();</span>
			}
<span class="nc" id="L1820">			methodFinish();</span>
<span class="nc" id="L1821">		}</span>
<span class="nc" id="L1822">	}</span>

	public void linkWorkResourcesToSchedulingPeriod(ID spID, Collection wkrsIDs) throws BbmCreateException {
<span class="nc" id="L1825">		methodStart(&quot;linkWorkResourcesToSchedulingPeriod&quot;, spID, wkrsIDs);</span>
<span class="nc" id="L1826">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1828">			dao.linkWorkResourcesToSchedulingPeriod(spID, wkrsIDs);</span>
<span class="nc" id="L1829">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1830">			handleException(e, false);</span>
<span class="nc" id="L1831">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1833" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1834">				dao.cleanUp();</span>
			}
<span class="nc" id="L1836">			methodFinish();</span>
<span class="nc" id="L1837">		}</span>
<span class="nc" id="L1838">	}</span>

	/**
	 * get parent scheduling period by id
	 */
	public ID getParentSchedulingPeriodID(ID idSubSP) throws BbmFinderException {
<span class="nc" id="L1844">		methodStart(&quot;getParentSchedulingPeriodByID&quot;, idSubSP);</span>
<span class="nc" id="L1845">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L1847">			return dao.getParentSchedulingPeriodID(idSubSP);</span>
<span class="nc" id="L1848">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1849">			handleException(e, false);</span>
<span class="nc" id="L1850">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1852" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1853">				dao.cleanUp();</span>
			}
<span class="nc" id="L1855">			methodFinish();</span>
		}
	}

	// this API will returns all the shift ID defined for this campaign or
	// inherited from the org linked to campaign
	public Collection&lt;ID&gt; getShift(ID campaignSID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L1862">		methodStart(&quot;getShift&quot;, campaignSID, dtStart, dtEnd);</span>
<span class="nc" id="L1863">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L1865">			HashSet&lt;ID&gt; shifts = new HashSet&lt;ID&gt;();</span>
			// first find the shifts inherited from orgs that links to this
			// campaign and the shifts defined for this
			// campaign
<span class="nc" id="L1869">			shifts.addAll(getShiftForCampaign(dmo, campaignSID, dtStart, dtEnd));</span>
			// for distributed campaign, if the current campaign is parent, it
			// can access all the shifts defined for the
			// children
<span class="nc" id="L1873">			StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L1874">			sb.append(&quot;select sid from campaign where parentcampaignid in (select id from campaign where sid =&quot;)</span>
<span class="nc" id="L1875">					.append(campaignSID).append(&quot;)&quot;);</span>
<span class="nc" id="L1876">			JdmoRowset rs = dmo.createRowset(sb.toString());</span>
<span class="nc" id="L1877">			ArrayList&lt;ID&gt; relatedSID = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L1878" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1879">				relatedSID.add(rs.getID(1)); // all children</span>
			}

			// for distributed campaign, if it is child, it can access all the
			// shifts defined for its parent
<span class="nc" id="L1884">			Campaign current = this.getCampaignByID(campaignSID);</span>
<span class="nc bnc" id="L1885" title="All 2 branches missed.">			if (current.getParentID() != null) {</span>
<span class="nc" id="L1886">				relatedSID.add(current.getParentID());</span>
			}

<span class="nc bnc" id="L1889" title="All 2 branches missed.">			for (Iterator&lt;ID&gt; i = relatedSID.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L1890">				shifts.addAll(getShiftForCampaign(dmo, i.next(), dtStart, dtEnd));</span>
			}

			// remove predefined SHIFT_OFF fromt the list
<span class="nc" id="L1894">			ID shiftID = null;</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">			for (Iterator&lt;ID&gt; i = shifts.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L1896">				shiftID = i.next();</span>
<span class="nc bnc" id="L1897" title="All 2 branches missed.">				if (shiftID.toInt() == 1) {</span>
<span class="nc" id="L1898">					i.remove();</span>
				}
			}
<span class="nc" id="L1901">			return new ArrayList&lt;ID&gt;(shifts);</span>
<span class="nc" id="L1902">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1903">			handleException(e, false);</span>
<span class="nc" id="L1904">			throw e;</span>
<span class="nc" id="L1905">		} catch (Exception e) {</span>
<span class="nc" id="L1906">			handleException(e, false);</span>
<span class="nc" id="L1907">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1909">			dmo.cleanUp();</span>
<span class="nc" id="L1910">			methodFinish();</span>
		}
	}

	private Collection&lt;ID&gt; getShiftForCampaign(Jdmo dmo, ID campaignSID, Date dtStart, Date dtEnd) throws Exception {
<span class="nc" id="L1915">		Collection orgIDs = getCampaignOrgs(dmo, campaignSID, dtStart, dtEnd);</span>
<span class="nc" id="L1916">		orgIDs.addAll(m_workResourceManager.getOrganizationsParentsByIDs(orgIDs));</span>

<span class="nc" id="L1918">		StringBuffer sbWhere = new StringBuffer(200);</span>
<span class="nc" id="L1919">		sbWhere.append(&quot;( CAMPAIGNID IN (SELECT ID FROM CAMPAIGN WHERE SID = &quot;).append(campaignSID).append(&quot;)&quot;);</span>
<span class="nc bnc" id="L1920" title="All 2 branches missed.">		if (!orgIDs.isEmpty()) {</span>
<span class="nc" id="L1921">			sbWhere.append(&quot; OR ORGANIZATIONID IN &quot;).append(dmo.createInClause(new HashSet(orgIDs)));</span>
		}
<span class="nc" id="L1923">		sbWhere.append(&quot;)&quot;);</span>
		// fix QC60132, not return deleted shifts
<span class="nc" id="L1925">		sbWhere.append(&quot; AND DELETEONDATE IS NULL order by name&quot;);</span>

<span class="nc" id="L1927">		JdmoRowset rs = dmo.createRowset(&quot;select sid from shift where &quot; + sbWhere.toString());</span>
<span class="nc" id="L1928">		Collection&lt;ID&gt; shiftIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L1929" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L1930">			shiftIDs.add(rs.getID(1));</span>
		}
<span class="nc" id="L1932">		return shiftIDs;</span>
	}

	public Collection&lt;ID&gt; getOrganizationsForCampaign(ID campaignSID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L1936">		methodStart(&quot;getOrganizationsForCampaign&quot;, campaignSID, dtStart, dtEnd);</span>
<span class="nc" id="L1937">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L1939">			return getCampaignOrgs(dmo, campaignSID, dtStart, dtEnd);</span>
<span class="nc" id="L1940">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1941">			handleException(e, false);</span>
<span class="nc" id="L1942">			throw e;</span>
		} finally {
<span class="nc" id="L1944">			dmo.cleanUp();</span>
<span class="nc" id="L1945">			methodFinish();</span>
		}
	}

	private Collection&lt;ID&gt; getCampaignOrgs(Jdmo dmo, ID campaignSID, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L1950">		CampaignOrgDAO dao = new CampaignOrgDAO(dmo);</span>
<span class="nc" id="L1951">		Campaign campaign = getCampaignByID(campaignSID);</span>
<span class="nc" id="L1952">		Collection&lt;CampaignOrg&gt; campOrgs = dao.getCampaignOrgAssignments(campaignSID, dtStart, dtEnd,</span>
<span class="nc" id="L1953">				campaign.getIsDistributed());</span>
<span class="nc" id="L1954">		ArrayList&lt;ID&gt; orgIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L1955">		CampaignOrg assignment = null;</span>
<span class="nc bnc" id="L1956" title="All 2 branches missed.">		for (Iterator&lt;CampaignOrg&gt; i = campOrgs.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L1957">			assignment = i.next();</span>
<span class="nc" id="L1958">			orgIDs.add(assignment.getOrganizationID());</span>
		}
<span class="nc" id="L1960">		return orgIDs;</span>
	}

	/**
	 * this API is created by angela in v11, to retrieve all the SPs for a
	 * campaign.
	 *
	 * @param campaign
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(Campaign campaign) throws BbmFinderException {
<span class="nc" id="L1972">		methodStart(&quot;getSchedulingPeriods&quot;);</span>
<span class="nc" id="L1973">		SchedulingPeriodDAO dao = null;</span>
		try {
<span class="nc" id="L1975">			dao = new SchedulingPeriodDAO();</span>
<span class="nc" id="L1976">			return dao.getSchedulingPeriods(campaign);</span>
<span class="nc" id="L1977">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1978">			handleException(e);</span>
<span class="nc" id="L1979">			throw e;</span>
		} finally {
<span class="nc bnc" id="L1981" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L1982">				dao.cleanUp();</span>
			}
<span class="nc" id="L1984">			methodFinish();</span>
		}
	}

	/**
	 * getFTECalculator for the specified collection of employees/phantoms and
	 * events in the SP.
	 *
	 * @param idSP            - The SP SID.
	 * @param hasProjectQueue - Is there a Project queue linked to the SP?
	 * @param wrIds           - the selected employee/phantom ID's. Only these will be
	 *                        considered for the FTE calculations. If you pass null here, we
	 *                        will assume all emploees/phantoms/events in the entire SP.
	 * @param defaultWage     - The default wage to use when the employee's wage is $0.0,
	 *                        for calculating the &quot;Total Scheduled Cost&quot;.
	 */
	public FTECalculator getFTECalculator(ID idSP, boolean hasProjectQueue, Collection&lt;ID&gt; wrIds, double defaultWage)
			throws BbmFinderException {
<span class="nc" id="L2002">		methodStart(&quot;getFTECalculator&quot;, idSP, wrIds);</span>
		try {
<span class="nc" id="L2004">			ScheduleAccessManager mScheduleAccess = WfmManagerFactory.getScheduleAccessManager(m_isWhatIf);</span>
<span class="nc" id="L2005">			ActivityManager mActivity = WfmManagerFactory.getActivityManager(m_isWhatIf);</span>
<span class="nc" id="L2006">			TimeSeriesManager mTimeSeries = WfmManagerFactory.getTimeSeriesManager(m_isWhatIf);</span>
<span class="nc" id="L2007">			WorkloadManager mWorkLoad = WfmManagerFactory.getWorkloadManager(m_isWhatIf);</span>
<span class="nc" id="L2008">			ForecastTimeSeriesManager mForcastTimeSeries = WfmManagerFactory.getForecastTimeSeriesManager(m_isWhatIf);</span>

<span class="nc" id="L2010">			SchedulingPeriod pPeriod = getSchedulingPeriodByID(idSP);</span>
<span class="nc" id="L2011">			Date dtStart = pPeriod.getStartTime();</span>
<span class="nc" id="L2012">			Date dtEnd = pPeriod.getEndTime();</span>

<span class="nc" id="L2014">			ID campaignID = pPeriod.getCampaignID();</span>
<span class="nc" id="L2015">			Campaign pCampaign = getCampaignByID(campaignID);</span>

<span class="nc" id="L2017">			Collection&lt;CampaignHOO&gt; cHOOs = getCampaignHOOAssignments(pPeriod.getID(), dtStart, dtEnd);</span>

<span class="nc" id="L2019">			Collection&lt;CampaignWorkResource&gt; cWorkResourceAssignments = getCampaignWorkResourceAssignments(campaignID,</span>
					dtStart, dtEnd);
<span class="nc" id="L2021">			TreeSet&lt;ID&gt; cEmployeeIDs = new TreeSet&lt;&gt;();</span>
<span class="nc bnc" id="L2022" title="All 2 branches missed.">			for (Iterator j = cWorkResourceAssignments.iterator(); j.hasNext(); ) {</span>
<span class="nc" id="L2023">				CampaignWorkResource cAssignment = (CampaignWorkResource) j.next();</span>

				// retain only the Employees that are in workResIds
<span class="nc bnc" id="L2026" title="All 4 branches missed.">				if (wrIds == null || wrIds.contains(cAssignment.getWorkResourceID())) {</span>
<span class="nc" id="L2027">					cEmployeeIDs.add(cAssignment.getWorkResourceID());</span>
				}
<span class="nc" id="L2029">			}</span>
<span class="nc" id="L2030">			Collection cEmployees = m_workResourceManager.getEmployeesByIDs(cEmployeeIDs, dtStart,</span>
					Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);

<span class="nc" id="L2033">			Collection&lt;Phantom&gt; cPhantoms = mScheduleAccess.getPhantoms(idSP);</span>

			// retain only the Phantoms that are in workResIds
<span class="nc" id="L2036">			Collection&lt;Phantom&gt; cPhantomsRetained = new ArrayList&lt;&gt;(cPhantoms.size());</span>
<span class="nc bnc" id="L2037" title="All 2 branches missed.">			for (Iterator pIt = cPhantoms.iterator(); pIt.hasNext(); ) {</span>
<span class="nc" id="L2038">				Phantom phantom = (Phantom) pIt.next();</span>
<span class="nc bnc" id="L2039" title="All 4 branches missed.">				if (wrIds == null || wrIds.contains(phantom.getID())) {</span>
<span class="nc" id="L2040">					cPhantomsRetained.add(phantom);</span>
				}
<span class="nc" id="L2042">			}</span>

<span class="nc" id="L2044">			ArrayList&lt;ID&gt; aWorkResourceIDs = new ArrayList&lt;&gt;(cEmployeeIDs);</span>
<span class="nc" id="L2045">			Collection&lt;EmployeeTemplate&gt; cEmpTemplates = new ArrayList&lt;&gt;(cPhantomsRetained.size());</span>
<span class="nc" id="L2046">			Map&lt;ID, ID&gt; hPhantomsIdsToEmpTemplateIDs = new LinkedHashMap&lt;&gt;(cPhantomsRetained.size());</span>

			// temporary Set for keeping track of employee templates added to cEmpTemplates
<span class="nc" id="L2049">			Set&lt;EmployeeTemplate&gt; empTemplatesSet = new HashSet&lt;&gt;();</span>

<span class="nc" id="L2051">			Iterator&lt;Phantom&gt; phantomIt = cPhantomsRetained.iterator();</span>
<span class="nc bnc" id="L2052" title="All 2 branches missed.">			while (phantomIt.hasNext()) {</span>
<span class="nc" id="L2053">				Phantom phantom = phantomIt.next();</span>

				// aWorkResourceIDs contains employeeIDs followed by phantomIDs
<span class="nc" id="L2056">				aWorkResourceIDs.add(phantom.getID());</span>
<span class="nc" id="L2057">				EmployeeTemplate empTemplate = m_scheduleAccessManager.getEmployeeTemplateByID(</span>
<span class="nc" id="L2058">					phantom.getEmployeeTemplateID());</span>
<span class="nc" id="L2059">				cEmpTemplates.add(empTemplate);</span>
<span class="nc" id="L2060">				empTemplatesSet.add(empTemplate);</span>
<span class="nc" id="L2061">				hPhantomsIdsToEmpTemplateIDs.put(phantom.getID(), phantom.getEmployeeTemplateID());</span>
<span class="nc" id="L2062">			}</span>

			// Get any remaining Staffing Profiles linked to this SP that have
			// not been scheduled.
<span class="nc" id="L2066">			Collection allEmpTemplatesInSP = m_scheduleAccessManager.getEmployeeTemplatesInSP(idSP);</span>
<span class="nc bnc" id="L2067" title="All 2 branches missed.">			for (Iterator spTempIt = allEmpTemplatesInSP.iterator(); spTempIt.hasNext(); ) {</span>
<span class="nc" id="L2068">				EmployeeTemplate et = (EmployeeTemplate) spTempIt.next();</span>
<span class="nc bnc" id="L2069" title="All 2 branches missed.">				if (!empTemplatesSet.contains(et)) {</span>
<span class="nc" id="L2070">					cEmpTemplates.add(et);</span>
<span class="nc" id="L2071">					empTemplatesSet.add(et);</span>
				}
<span class="nc" id="L2073">			}</span>

			Collection cSchedules;
<span class="nc" id="L2076">			cSchedules = mScheduleAccess.getEventsForWorkResources(aWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L2077">			Map&lt;ID, Collection&lt;Event&gt;&gt; wrIdsToEventsMap = new HashMap&lt;ID, Collection&lt;Event&gt;&gt;();</span>
<span class="nc" id="L2078">			Iterator scheduleIt = cSchedules.iterator();</span>
<span class="nc bnc" id="L2079" title="All 2 branches missed.">			for (Iterator it = aWorkResourceIDs.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2080">				ID id = (ID) it.next();</span>
<span class="nc" id="L2081">				Collection schedulesForCurEmp = (Collection) scheduleIt.next();</span>
<span class="nc" id="L2082">				wrIdsToEventsMap.put(id, schedulesForCurEmp);</span>
<span class="nc" id="L2083">			}</span>

			// get the set of Activity ID's from the schedules.

<span class="nc" id="L2087">			TreeSet activityIdSet = new TreeSet();</span>
<span class="nc bnc" id="L2088" title="All 2 branches missed.">			for (Iterator schedIt = cSchedules.iterator(); schedIt.hasNext(); ) {</span>
<span class="nc" id="L2089">				Collection cAssignments = (Collection) schedIt.next();</span>
<span class="nc bnc" id="L2090" title="All 2 branches missed.">				if (cAssignments != null) {</span>
					// flatten the Event collection first.
<span class="nc" id="L2092">					Collection colFlattenedEvents = EventUtils.convertEventsToTimelineForSingleEmployee(cAssignments, null,</span>
							null, null, true);

<span class="nc bnc" id="L2095" title="All 2 branches missed.">					for (Iterator assignmentIt = colFlattenedEvents.iterator(); assignmentIt.hasNext(); ) {</span>
<span class="nc" id="L2096">						Event pEvent = (Event) assignmentIt.next();</span>
<span class="nc" id="L2097">						activityIdSet.add(pEvent.getActivityID());</span>

<span class="nc bnc" id="L2099" title="All 2 branches missed.">						for (Iterator childEventIt = pEvent.getChildren().iterator(); childEventIt.hasNext(); ) {</span>
<span class="nc" id="L2100">							pEvent = (Event) childEventIt.next();</span>
<span class="nc" id="L2101">							activityIdSet.add(pEvent.getActivityID());</span>
						}
<span class="nc" id="L2103">					}</span>
				}
<span class="nc" id="L2105">			}</span>

			// retrieve the ActivityMedia's and ActivityQueue's
<span class="nc" id="L2108">			Map&lt;ID, Collection&lt;ID&gt;&gt; activityIdToMediaIds = mActivity.findMediaForActivities(activityIdSet);</span>
<span class="nc" id="L2109">			Map mActivityQueues = mActivity.findQueueForActivities(activityIdSet);</span>

			// Get required TraceCube for the combined queue
<span class="nc" id="L2112">			short[] types = {Trace.FTE};</span>
<span class="nc" id="L2113">			TraceCube tRequirements = new RequireTraceCube(null, dtStart, dtEnd, types);</span>
<span class="nc bnc" id="L2114" title="All 2 branches missed.">			ID mediaID = pPeriod.getSkillBased() ? null : Media.MEDIA_ID_PHONE;</span>
<span class="nc" id="L2115">			Collection cubeCol = mTimeSeries.getRawCombinedQueuesTimeSeries(tRequirements, campaignID, mediaID, dtStart,</span>
					dtEnd);
<span class="nc bnc" id="L2117" title="All 2 branches missed.">			if (cubeCol != null) {</span>
<span class="nc bnc" id="L2118" title="All 2 branches missed.">				for (Iterator it = cubeCol.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2119">					tRequirements = (TraceCube) it.next();</span>
				}
			}

			// Get the data for Project Statistics
<span class="nc" id="L2124">			Collection&lt;ForecastProfileProject&gt; forecastProfileProjects = null;</span>
			// a map of project queue DEID to queue name
<span class="nc" id="L2126">			Map projectQueueIdNameMap = null;</span>
			// a map of project queue DEID to SID
<span class="nc" id="L2128">			Map projectQueueIdSIDMap = null;</span>
<span class="nc bnc" id="L2129" title="All 2 branches missed.">			if (hasProjectQueue) {</span>
				// Get the SPQueue ID's.
<span class="nc" id="L2131">				ArrayList spQueueIDs = null;</span>
<span class="nc" id="L2132">				Collection spQueues = getNonCombinedSPQueuesByMediaAndSP(idSP, Media.MEDIA_ID_PROJECT);</span>
<span class="nc bnc" id="L2133" title="All 4 branches missed.">				if (spQueues != null &amp;&amp; !spQueues.isEmpty()) {</span>
<span class="nc" id="L2134">					spQueueIDs = new ArrayList(spQueues.size());</span>
<span class="nc bnc" id="L2135" title="All 2 branches missed.">					for (Iterator spqIt = spQueues.iterator(); spqIt.hasNext(); ) {</span>
<span class="nc" id="L2136">						spQueueIDs.add(((SPQueue) spqIt.next()).getID());</span>
					}
				}

<span class="nc bnc" id="L2140" title="All 4 branches missed.">				if (spQueueIDs != null &amp;&amp; spQueueIDs.size() &gt; 0) {</span>
					// Get the ForecastProfileProject's for these SPQueueIDs
<span class="nc" id="L2142">					forecastProfileProjects = mForcastTimeSeries.getActiveProjects(spQueueIDs);</span>

					// Get the project queue names
<span class="nc bnc" id="L2145" title="All 4 branches missed.">					if (forecastProfileProjects != null &amp;&amp; forecastProfileProjects.size() &gt; 0) {</span>
<span class="nc" id="L2146">						HashSet queueDEIDs = new HashSet();</span>

<span class="nc bnc" id="L2148" title="All 2 branches missed.">						for (Iterator projectIt = forecastProfileProjects.iterator(); projectIt.hasNext(); ) {</span>
<span class="nc" id="L2149">							ForecastProfileProject project = (ForecastProfileProject) projectIt.next();</span>
<span class="nc" id="L2150">							queueDEIDs.add(project.getQueueID());</span>
<span class="nc" id="L2151">						}</span>

						// Get a Pair: a map of project queue DEID to queue
						// name, and a map of project queue DEID to SID.
<span class="nc" id="L2155">						Pair queueMapPair = mWorkLoad.getQueueNameSIDMapsByDEIDs(queueDEIDs);</span>
<span class="nc" id="L2156">						projectQueueIdNameMap = (Map) queueMapPair.getFirst();</span>
<span class="nc" id="L2157">						projectQueueIdSIDMap = (Map) queueMapPair.getSecond();</span>
					}
				}
			}

<span class="nc" id="L2162">			LinkedHashMap hEmployeeIDsToWages = new LinkedHashMap(cEmployees.size());</span>
<span class="nc bnc" id="L2163" title="All 2 branches missed.">			for (Iterator it = cEmployees.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2164">				Employee emp = (Employee) it.next();</span>
<span class="nc" id="L2165">				hEmployeeIDsToWages.put(emp.getID(), emp.getWage());</span>
<span class="nc" id="L2166">			}</span>

<span class="nc" id="L2168">			FTECalculator fteCalculator = new FTECalculator(hEmployeeIDsToWages, hPhantomsIdsToEmpTemplateIDs,</span>
					cEmpTemplates, tRequirements, activityIdToMediaIds, dtStart, dtEnd, forecastProfileProjects, projectQueueIdNameMap,
					projectQueueIdSIDMap, mActivityQueues, idSP, wrIdsToEventsMap, defaultWage);

<span class="nc" id="L2172">			return fteCalculator;</span>

<span class="nc" id="L2174">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2175">			handleException(e);</span>
<span class="nc" id="L2176">			throw e;</span>
<span class="nc" id="L2177">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L2178">			handleException(e);</span>
<span class="nc" id="L2179">			throw new BbmFinderException(e);</span>
<span class="nc" id="L2180">		} catch (RemoteException e) {</span>
<span class="nc" id="L2181">			handleException(e);</span>
<span class="nc" id="L2182">			throw new BbmFinderException(e);</span>
<span class="nc" id="L2183">		} catch (BbmTimeSeriesException e) {</span>
<span class="nc" id="L2184">			handleException(e);</span>
<span class="nc" id="L2185">			throw new BbmFinderException(e);</span>
<span class="nc" id="L2186">		} catch (JdmoException e) {</span>
<span class="nc" id="L2187">			handleException(e);</span>
<span class="nc" id="L2188">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L2190">			methodFinish();</span>
		}
	}

	/**
	 * Returns a collection of SchedulingPeriods associated with the campaigns
	 *
	 * @param campaigns
	 * @return schedulingPeriods
	 * @throws BbmFinderException
	 */
	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(Collection&lt;Campaign&gt; campaigns) throws BbmFinderException {
<span class="nc" id="L2202">		methodStart(&quot;getSchedulingPeriods&quot;);</span>
<span class="nc" id="L2203">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L2205">			return dao.getSchedulingPeriods(campaigns);</span>
<span class="nc" id="L2206">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2207">			handleException(e, false);</span>
<span class="nc" id="L2208">			throw e;</span>
		} finally {
<span class="nc" id="L2210">			dao.cleanUp();</span>
<span class="nc" id="L2211">			methodFinish();</span>
		}
	}

	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByCampaignID(ID campaignSID) throws BbmFinderException {
<span class="nc" id="L2216">		methodStart(&quot;getSchedulingPeriodsByCampaignID&quot;);</span>
<span class="nc" id="L2217">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L2219">			return dao.getSchedulingPeriods(campaignSID);</span>
<span class="nc" id="L2220">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2221">			handleException(e, false);</span>
<span class="nc" id="L2222">			throw e;</span>
		} finally {
<span class="nc" id="L2224">			dao.cleanUp();</span>
<span class="nc" id="L2225">			methodFinish();</span>
		}
	}

	public Collection&lt;SchedulingPeriod&gt; getSchedulingPeriodsByCampaignIDs(Collection&lt;ID&gt; campaignIDs, Date minDate,
			Date maxDate) throws BbmFinderException {
<span class="nc" id="L2231">		methodStart(&quot;getSchedulingPeriodsByCampaignIDs&quot;);</span>
<span class="nc" id="L2232">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L2234">			return dao.getSchedulingPeriodsByCampaignIDs(campaignIDs, minDate, maxDate);</span>
<span class="nc" id="L2235">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2236">			handleException(e, false);</span>
<span class="nc" id="L2237">			throw e;</span>
		} finally {
<span class="nc" id="L2239">			dao.cleanUp();</span>
<span class="nc" id="L2240">			methodFinish();</span>
		}
	}

	public Collection&lt;CampaignHOO&gt; getCampaignHOOsByCampaignIDs(Collection&lt;ID&gt; campaignIDs, Date minDate, Date maxDate)
			throws BbmFinderException {
<span class="nc" id="L2246">		methodStart(&quot;getCampaignHOOs&quot;);</span>
<span class="nc" id="L2247">		CampaignHOODAO dao = new CampaignHOODAO();</span>
		try {
<span class="nc" id="L2249">			return dao.getCampaignHOOsByCampaignIDs(campaignIDs, minDate, maxDate);</span>
<span class="nc" id="L2250">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2251">			handleException(e, false);</span>
<span class="nc" id="L2252">			throw e;</span>
		} finally {
<span class="nc" id="L2254">			dao.cleanUp();</span>
<span class="nc" id="L2255">			methodFinish();</span>
		}
	}

	/**
	 * Returns shrinkage and modeling factor data for the specified scheduling
	 * period. If no such data exist, then entries are created for hourly data,
	 * initialized to all zeros.
	 *
	 * @param spID
	 * @return
	 * @throws BbmCreateException
	 * @throws BbmFinderException
	 */
	public Collection&lt;SPShrinkage&gt; getOrCreateSPShrinkageBySPID(ID spID) throws BbmCreateException, BbmFinderException {
<span class="nc" id="L2270">		methodStart(&quot;getOrCreateSPShrinkageBySPID&quot;, spID);</span>
<span class="nc" id="L2271">		SPShrinkageDAO dao = new SPShrinkageDAO();</span>
		try {
<span class="nc" id="L2273">			String loginUserName = m_sessionContext.getCallerPrincipal().getName();</span>
<span class="nc" id="L2274">			return dao.getOrCreateShrinkageBySPID(spID, loginUserName);</span>
<span class="nc" id="L2275">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2276">			handleException(e, false);</span>
<span class="nc" id="L2277">			throw e;</span>
<span class="nc" id="L2278">		} catch (BbmCreateException bce) {</span>
<span class="nc" id="L2279">			handleException(bce);</span>
<span class="nc" id="L2280">			throw bce;</span>
		} finally {
<span class="nc" id="L2282">			dao.cleanUp();</span>
<span class="nc" id="L2283">			methodFinish();</span>
		}
	}

	/**
	 * Updates the database with the specified collection of SPShrinkage
	 * records. It is assumed that each record represents an already-created row
	 * in the database.
	 * &lt;p&gt;
	 * TODO: Once SPShrinkage is updated, FTE Requirements should be calculated
	 * for the affected SPQueues. This needs to occur in a separate transaction
	 * since FTE reqs are calc'd asynchronously via a JMS queue. Right now, the
	 * call to calculate FTE Requirements after shrinkage is done manually in
	 * the client but this should be moved to this method.
	 *
	 * @param spShrinkageCol
	 * @throws BbmCreateException
	 * @throws BbmUpdateException
	 * @throws MultiUserException
	 */
	public void updateSPShrinkage(Collection&lt;SPShrinkage&gt; spShrinkageCol) throws BbmUpdateException, MultiUserException {
<span class="nc" id="L2304">		methodStart(&quot;updateSPShrinkage&quot;, spShrinkageCol);</span>
<span class="nc" id="L2305">		SPShrinkageDAO dao = new SPShrinkageDAO();</span>
<span class="nc" id="L2306">		SPQueueDAO spQueueDAO = new SPQueueDAO();</span>
		try {
<span class="nc" id="L2308">			dao.updateObjects(spShrinkageCol);</span>
<span class="nc" id="L2309">		} catch (MultiUserException mue) {</span>
<span class="nc" id="L2310">			handleException(mue);</span>
<span class="nc" id="L2311">			throw new BbmUpdateException(mue);</span>
<span class="nc" id="L2312">		} catch (BbmUpdateException bue) {</span>
<span class="nc" id="L2313">			handleException(bue);</span>
<span class="nc" id="L2314">			throw bue;</span>
		} finally {
<span class="nc" id="L2316">			dao.cleanUp();</span>
<span class="nc" id="L2317">			spQueueDAO.cleanUp();</span>
<span class="nc" id="L2318">			methodFinish();</span>
<span class="nc" id="L2319">		}</span>
<span class="nc" id="L2320">	}</span>

	/**
	 * Returns all of the SPQueues associated to the Scheduling Periods in the
	 * collection of SPShrinkage value objects
	 *
	 * @param spShrinkageCol
	 * @return
	 * @throws BbmFinderException
	 */
	public Collection&lt;SPQueue&gt; getSPQueuesFromSPShrinkage(Collection&lt;SPShrinkage&gt; spShrinkageCol) throws BbmFinderException {
<span class="nc" id="L2331">		methodStart(&quot;getSPQueueIDsFromSPShrinkage&quot;, spShrinkageCol);</span>
<span class="nc" id="L2332">		SPQueueDAO spQueueDAO = new SPQueueDAO();</span>
		try {
			// First retrieve the Scheduling Period IDs from the SPShrinkage
			// objects
<span class="nc" id="L2336">			Collection&lt;ID&gt; spIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc bnc" id="L2337" title="All 2 branches missed.">			for (SPShrinkage spShrinkage : spShrinkageCol) {</span>
<span class="nc" id="L2338">				spIDs.add(spShrinkage.getSPID());</span>
<span class="nc" id="L2339">			}</span>
			// Then return the SPQueues belonging to those Scheduling periods.
<span class="nc" id="L2341">			return new HashSet&lt;SPQueue&gt;(spQueueDAO.getSPQueuesBySPIDs(spIDs));</span>
		} finally {
<span class="nc" id="L2343">			spQueueDAO.cleanUp();</span>
<span class="nc" id="L2344">			methodFinish();</span>
		}
	}

	public SchedulingState getSchedulingState(ID spSID, String modeChar) throws BbmFinderException {
<span class="nc" id="L2349">		methodStart(&quot;getSchedulingState&quot;, spSID);</span>
<span class="nc" id="L2350">		SchedulingStateDAO dao = new SchedulingStateDAO();</span>
		try {
<span class="nc" id="L2352">			String mode = &quot; and MODE='&quot; + modeChar + &quot;'&quot;;</span>
<span class="nc" id="L2353">			Collection col = dao.getObjects(&quot;SPID=&quot; + spSID + mode);</span>
<span class="nc bnc" id="L2354" title="All 4 branches missed.">			if (col != null &amp;&amp; !col.isEmpty()) {</span>
<span class="nc" id="L2355">				return (SchedulingState) col.iterator().next();</span>
			}
<span class="nc" id="L2357">			return null; // should never happen!</span>
<span class="nc" id="L2358">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2359">			handleException(e, false);</span>
<span class="nc" id="L2360">			throw e;</span>
		} finally {
<span class="nc" id="L2362">			dao.cleanUp();</span>
<span class="nc" id="L2363">			methodFinish();</span>
		}
	}

	public Map&lt;ID, Date&gt; getAllSchedulingStateLastUpdatedTimes()
			throws BbmFinderException {
<span class="nc" id="L2369">		methodStart(&quot;getAllSchedulingStateLastUpdatedTimes&quot;);</span>
<span class="nc" id="L2370">		SchedulingStateDAO dao = new SchedulingStateDAO();</span>

		try {
<span class="nc" id="L2373">			return dao.getTimeLastUpdatedBySPs();</span>
		} finally {
<span class="nc" id="L2375">			dao.cleanUp();</span>
<span class="nc" id="L2376">			methodFinish();</span>
		}
	}

	public Date getSchedulingStateLastUpdatedTime(ID spId, String mode)
			throws BbmFinderException {
<span class="nc" id="L2382">		methodStart(&quot;getSchedulingStateLastUpdatedTime&quot;);</span>
<span class="nc" id="L2383">		SchedulingStateDAO dao = new SchedulingStateDAO();</span>

		try {
<span class="nc" id="L2386">			return dao.getTimeLastUpdated(spId, mode);</span>
		} finally {
<span class="nc" id="L2388">			dao.cleanUp();</span>
<span class="nc" id="L2389">			methodFinish();</span>
		}
	}

	public void clearSchedulingState(ID spSID, String modeChar) throws BbmRemoveException {
<span class="nc" id="L2394">		methodStart(&quot;clearSchedulingState&quot;, spSID);</span>
<span class="nc" id="L2395">		SchedulingStateDAO dao = new SchedulingStateDAO();</span>
		try {
<span class="nc" id="L2397">			String mode = &quot;and MODE='&quot; + modeChar + &quot;'&quot;;</span>
<span class="nc" id="L2398">			dao.deleteObjects(&quot;select id from SPSCHEDSTATE where spid =&quot; + spSID.toString() + mode);</span>
<span class="nc" id="L2399">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L2400">			handleException(e, false);</span>
<span class="nc" id="L2401">			throw e;</span>
		} finally {
<span class="nc" id="L2403">			dao.cleanUp();</span>
<span class="nc" id="L2404">			methodFinish();</span>
<span class="nc" id="L2405">		}</span>
<span class="nc" id="L2406">	}</span>

	public void clearSchedulingStateWarnings(Collection ids) throws BbmFinderException {
<span class="nc" id="L2409">		methodStart(&quot;clearSchedulingStateWarnings&quot;, ids);</span>
<span class="nc" id="L2410">		SchedulingStateDAO dao = new SchedulingStateDAO();</span>
		try {
<span class="nc" id="L2412">			dao.deleteWarnings(ids);</span>
<span class="nc" id="L2413">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2414">			handleException(e, false);</span>
<span class="nc" id="L2415">			throw e;</span>
		} finally {
<span class="nc" id="L2417">			dao.cleanUp();</span>
<span class="nc" id="L2418">			methodFinish();</span>
<span class="nc" id="L2419">		}</span>
<span class="nc" id="L2420">	}</span>

	// cancel - 1; stop and save - 1, continue - 2
	public void makeSchedulingRequest(SchedulingRequest request) throws BbmCreateException {
<span class="nc" id="L2424">		methodStart(&quot;makeSchedulingRequest&quot;, request);</span>
<span class="nc" id="L2425">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L2427">			dmo.execute(&quot;insert into SPSCHEDREQUEST (REQUEST, SPID, MODE) values (&quot; + request.getRequest() + &quot;, &quot;</span>
<span class="nc" id="L2428">					+ request.getSPSID() + &quot;, '&quot; + request.getMode() + &quot;')&quot;);</span>
<span class="nc" id="L2429">		} catch (JdmoException e) {</span>
<span class="nc" id="L2430">			handleException(e, false);</span>
<span class="nc" id="L2431">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L2433">			dmo.cleanUp();</span>
<span class="nc" id="L2434">			methodFinish();</span>
<span class="nc" id="L2435">		}</span>
<span class="nc" id="L2436">	}</span>

	/**
	 * Clears any scheduling request for the given SPID and mode. Only use if
	 * you have reason to believe the FS client has died without removing the
	 * request entry.
	 */
	public void clearSchedulingRequest(SchedulingRequest request) throws BbmRemoveException {
<span class="nc" id="L2444">		methodStart(&quot;makeSchedulingRequest&quot;, request);</span>
<span class="nc" id="L2445">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L2447">			dmo.execute(&quot;delete from SPSCHEDREQUEST where SPID = &quot; + request.getSPSID() + &quot; and MODE = '&quot;</span>
<span class="nc" id="L2448">					+ request.getMode() + &quot;'&quot;);</span>
<span class="nc" id="L2449">		} catch (JdmoException e) {</span>
<span class="nc" id="L2450">			handleException(e, false);</span>
<span class="nc" id="L2451">			throw new BbmRemoveException(e);</span>
		} finally {
<span class="nc" id="L2453">			dmo.cleanUp();</span>
<span class="nc" id="L2454">			methodFinish();</span>
<span class="nc" id="L2455">		}</span>
<span class="nc" id="L2456">	}</span>

	public Collection getSPScheduleSession(ID spSID) throws BbmFinderException, RemoteException {
<span class="nc" id="L2459">		methodStart(&quot;getSPScheduleSession&quot;, spSID);</span>
<span class="nc" id="L2460">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L2462">			SchedulingPeriod sp = this.getSchedulingPeriodByID(spSID);</span>
<span class="nc" id="L2463">			Date start = TimeZoneUtil.previousWeek(sp.getStartTime());</span>
<span class="nc" id="L2464">			Date end = TimeZoneUtil.addWeek(sp.getEndTime());</span>
<span class="nc" id="L2465">			Collection sps = this.getSchedulingPeriods(sp.getCampaignID(), start, end);</span>
<span class="nc" id="L2466">			ArrayList sessions = new ArrayList(3);</span>
<span class="nc bnc" id="L2467" title="All 4 branches missed.">			if (sps != null &amp;&amp; !sps.isEmpty()) {</span>
<span class="nc" id="L2468">				HashMap spIDMap = ValueObjectUtil.getIDObjectMap(sps);</span>
<span class="nc" id="L2469">				StringBuffer sb = new StringBuffer(200);</span>
<span class="nc" id="L2470">				sb.append(&quot;select username, sp.sid from bpsession, sp where sp.id = bpsession.spid and useraction ='scheduling' and SP.SID in &quot;);</span>
<span class="nc" id="L2471">				sb.append(dmo.createInClause(spIDMap.keySet()));</span>
<span class="nc" id="L2472">				JdmoRowset rs = dmo.createRowset(sb.toString());</span>
<span class="nc" id="L2473">				SchedulingSession session = null;</span>
<span class="nc" id="L2474">				ID spID = null;</span>
<span class="nc bnc" id="L2475" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L2476">					session = new SchedulingSession();</span>
<span class="nc" id="L2477">					session.setUserName(rs.getString(1));</span>
<span class="nc" id="L2478">					spID = rs.getID(2);</span>
<span class="nc" id="L2479">					session.setSchedulingPeriod((SchedulingPeriod) spIDMap.get(spID));</span>
<span class="nc" id="L2480">					sessions.add(session);</span>
				}
			}
<span class="nc" id="L2483">			return sessions;</span>
<span class="nc" id="L2484">		} catch (JdmoException e) {</span>
<span class="nc" id="L2485">			handleException(e, false);</span>
<span class="nc" id="L2486">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L2488">			dmo.cleanUp();</span>
<span class="nc" id="L2489">			methodFinish();</span>
		}
	}

	/**
	 * Removes any scheduling BPSESSION entry for the specified SPID. Only use
	 * if you have reason to believe the FS client has died without removing the
	 * session entry.
	 */
	public void clearSPScheduleSession(ID spSID) throws BbmFinderException, BbmRemoveException, RemoteException {
<span class="nc" id="L2499">		methodStart(&quot;clearSPScheduleSession&quot;, spSID);</span>
<span class="nc" id="L2500">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L2502">			SchedulingPeriod sp = this.getSchedulingPeriodByID(spSID);</span>
<span class="nc bnc" id="L2503" title="All 2 branches missed.">			if (sp != null) {</span>
				// Not good that we have to use DEID
<span class="nc" id="L2505">				dmo.execute(&quot;delete from bpsession where useraction = 'scheduling' and SPID = '&quot; + sp.getDEID() + &quot;'&quot;);</span>
			}
<span class="nc" id="L2507">			return;</span>
<span class="nc" id="L2508">		} catch (JdmoException e) {</span>
<span class="nc" id="L2509">			handleException(e, false);</span>
<span class="nc" id="L2510">			throw new BbmRemoveException(e);</span>
		} finally {
<span class="nc" id="L2512">			dmo.cleanUp();</span>
<span class="nc" id="L2513">			methodFinish();</span>
		}
	}

	public Collection&lt;SPQueue&gt; getSPQueuesBySPID(ID SPID) throws BbmObjectNotFoundException, BbmFinderException {
<span class="nc" id="L2518">		methodStart(&quot;getSPQueuesBySPID&quot;);</span>
<span class="nc" id="L2519">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L2521">			return dao.getSPQueuesBySPID(SPID);</span>
<span class="nc" id="L2522">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2523">			handleException(e, false);</span>
<span class="nc" id="L2524">			throw e;</span>
		} finally {
<span class="nc" id="L2526">			dao.cleanUp();</span>
<span class="nc" id="L2527">			methodFinish();</span>
		}
	}

	/**
	 * Returns the TimeZone associated with the specified SPQueue ID.
	 *
	 * @param spQueueID
	 * @return
	 * @throws BbmObjectNotFoundException
	 * @throws BbmFinderException
	 */
	private TimeZone getTimeZoneBySPQueueID(ID spQueueID) throws BbmFinderException {
<span class="nc" id="L2540">		SPQueue spqueue = getSPQueue(spQueueID);</span>
<span class="nc" id="L2541">		SchedulingPeriod sp = getSP(spqueue.getSpID());</span>
<span class="nc" id="L2542">		return getTimeZoneByCampaignID(sp.getCampaignID());</span>
	}

	public Collection&lt;ID&gt; getLinkedOrgsforSP(ID schedID) throws BbmFinderException {
<span class="nc" id="L2546">		methodStart(&quot;getLinkedOrgsforSP&quot;, schedID);</span>
<span class="nc" id="L2547">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L2549">			return (dao.getLinkedOrgsforSP(schedID));</span>
<span class="nc" id="L2550">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2551">			handleException(e, false);</span>
<span class="nc" id="L2552">			throw e;</span>
		} finally {
<span class="nc" id="L2554">			dao.cleanUp();</span>
<span class="nc" id="L2555">			methodFinish();</span>
		}
	}

	public TimeZone getTimeZoneByCampaignID(ID campaignID) throws BbmFinderException {
<span class="nc" id="L2560">		methodStart(&quot;getTimeZoneByCampaignID&quot;, campaignID);</span>
<span class="nc" id="L2561">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="nc" id="L2563">			return (dao.getTimeZoneByCampaignID(campaignID));</span>
<span class="nc" id="L2564">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2565">			handleException(e, false);</span>
<span class="nc" id="L2566">			throw e;</span>
		} finally {
<span class="nc" id="L2568">			dao.cleanUp();</span>
<span class="nc" id="L2569">			methodFinish();</span>
		}
	}

	/**
	 * Returns a map from child SPQueue ID to child campaign time zone for all
	 * children of the specified parent SPQueue ID.
	 *
	 * @param parentSPQueueID
	 * @return
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	public Map&lt;ID, TimeZone&gt; getChildSPQueueTimeZonesByParentSPQueueID(ID parentSPQueueID) throws BbmFinderException,
			RemoteException {

<span class="nc" id="L2585">		Map&lt;ID, TimeZone&gt; timeZoneMap = new HashMap&lt;ID, TimeZone&gt;();</span>
<span class="nc" id="L2586">		Collection&lt;SPQueue&gt; childSPQueues = getChildSpQueuesOfDistributedSpQueue(parentSPQueueID);</span>
<span class="nc bnc" id="L2587" title="All 2 branches missed.">		for (SPQueue childSPQueue : childSPQueues) {</span>
<span class="nc" id="L2588">			timeZoneMap.put(childSPQueue.getID(), getTimeZoneBySPQueueID(childSPQueue.getID()));</span>
<span class="nc" id="L2589">		}</span>
<span class="nc" id="L2590">		return timeZoneMap;</span>
	}

	/**
	 * Clones the given Scheduling Period.  The cloning operation is performed in a series of steps:
	 * - The CLONESP stored procedure is executed for the target SP.  This procedure is quite extensive and is
	 * responsible for copying a large set of data including but not limited to: absolute/manually modified forecast
	 * profiles, service goals, spqueues, shrinkage, and hours of operation.
	 * - Employee min/max hours, skills, and work pattern assignments are copied to the new scheduling period (if
	 * this option was checked)
	 *  - If this SP is part of a distributed campaign, then the above steps are performed again for each additional
	 *  sub/child campaign
	 *  - If the source SP contained a forecast profile with relative history weeks, then the forecasts and FTE requirements
	 *  will be calculated for the new SP based on the relative dates for the new SP.  This step is also performed for the
	 *  sub/child SPs in the case of a distributed campaign.
	 *
	 * @param newSP - Essentially an empty SP, but it needs to have the time interval set to match the date range of the
	 *              target SP.
	 * @param spHOOs - The hours of the operation of the source SP, which will be cloned to the new SP.
	 * @param copyFlags - A set of boolean arguments to indicate whether or not certain types of data are to be cloned.
	 * @param bIgnoreWarnings - If false, will throw a BbmConflictException if any conflicts are detected before the
	 *                        stored procedure is executed (see SchedulingPeriodDAO.CloneSP method)
	 * @param localeCtx - Used to create a localized description for the newly cloned SP, e.g.
	 *                  &quot;This scheduling period is cloned from 01/04/2016To02/03/2016.&quot;
	 * @return - The ID of the newly cloned SP.
	 */
	public ID cloneSchedulingPeriod(SchedulingPeriod newSP, Collection&lt;CampaignHOO&gt; spHOOs, CloneSPOptions copyFlags,
			boolean bIgnoreWarnings, LocaleContext localeCtx) throws JdmoException, BbmException, RemoteException {

<span class="nc" id="L2619">		ClonedSchedulingPeriodResult clonedSps =</span>
<span class="nc" id="L2620">				campaignManager.cloneBaseDataForSchedulingPeriod(newSP, spHOOs, copyFlags, bIgnoreWarnings, localeCtx);</span>

<span class="nc" id="L2622">		cloneForecastDataForSchedulingPeriods(clonedSps);</span>

<span class="nc" id="L2624">		return clonedSps.getClonedSchedulingPeriod().getID();</span>
	}

	/**
	 * Clones the forecast data for the newly created scheduling periods.  This is mainly to support forecasts
	 * with relative profiles, which are not supported by the CLONESP stored procedure and need to be handled
	 * by the EJB due to their complexity.
	 *
	 * @param clonedSps - A ClonedSchedulingPeriodResult containing the newly cloned SP as well as its children
	 *                  if it belongs to a distributed campaign.
	 */
	private void cloneForecastDataForSchedulingPeriods(ClonedSchedulingPeriodResult clonedSps)
			throws JdmoException, BbmException, RemoteException {

		//We currently only clone the forecast data for the parent scheduling period in a distributed campaign.
		//We don't currently clone the Forecast Allocation Time series, and because that needs to be set manually
		//it doesn't make sense to clone the forecast data for the child SPs.
<span class="nc" id="L2641">		forecastTimeSeriesManager.recalculateForecastDataForClonedSp(clonedSps.getClonedSchedulingPeriod());</span>
<span class="nc" id="L2642">	}</span>

	/**
	 * This method is NOT intended to be executed by client code.  If you are a client, you should use
	 * CampaignManager.cloneSchedulingPeriod instead.
	 *
	 * This method has a &quot;RequiresNew&quot; attribute set to ensure that it runs in its own transaction.  This is done
	 * so that post clone operations can be performed asynchronously but still utilize the persisted objects created
	 * during the clone operation.
	 *
	 * @param newSP - Essentially an empty SP, but it needs to have the time interval set to match the date range of the
	 *              target SP.
	 * @param spHOOs - The hours of the operation of the source SP, which will be cloned to the new SP.
	 * @param copyFlags - A set of boolean arguments to indicate whether or not certain types of data are to be cloned.
	 * @param bIgnoreWarnings - If false, will throw a BbmConflictException if any conflicts are detected before the
	 *                        stored procedure is executed (see SchedulingPeriodDAO.CloneSP method)
	 * @param localeCtx - Used to create a localized description for the newly cloned SP, e.g.
	 *                  &quot;This scheduling period is cloned from 01/04/2016To02/03/2016.&quot;
	 * @return A ClonedSchedulingPeriodResult containing the newly cloned SP and Child SP (for distributed) objects.
	 */
	public ClonedSchedulingPeriodResult cloneBaseDataForSchedulingPeriod(SchedulingPeriod newSP,
			Collection&lt;CampaignHOO&gt; spHOOs, CloneSPOptions copyFlags, boolean bIgnoreWarnings, LocaleContext localeCtx)
			throws JdmoException, BbmException, RemoteException {

<span class="nc" id="L2666">		methodStart(&quot;cloneSchedulingPeriod&quot;, newSP, spHOOs, copyFlags, bIgnoreWarnings, localeCtx);</span>
		ID idTargetSP;
<span class="nc" id="L2668">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
<span class="nc" id="L2669">		CampaignDAO camDao = new CampaignDAO();</span>
<span class="nc" id="L2670">		CampaignHOODAO camHOODao = new CampaignHOODAO();</span>
<span class="nc" id="L2671">		SchedulingPeriod sp = null;</span>
<span class="nc" id="L2672">		List&lt;SchedulingPeriod&gt; childSps = new ArrayList&lt;SchedulingPeriod&gt;();</span>
		try {
<span class="nc" id="L2674">			ID campaignID = newSP.getCampaignID();</span>
<span class="nc" id="L2675">			TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(campaignID);</span>
<span class="nc" id="L2676">			boolean bCopyAssignments = copyFlags.isCopyAssignments();</span>
<span class="nc" id="L2677">			idTargetSP = dao.CloneSP(tz, newSP, spHOOs, copyFlags, bIgnoreWarnings);</span>

<span class="nc" id="L2679">			Campaign campaign = camDao.getCampaignByID(newSP.getCampaignID(), false);</span>
<span class="nc" id="L2680">			String strSPname = copyShiftAssignmentsAndEffectiveDates(dao, campaign, newSP, spHOOs, bCopyAssignments, tz,</span>
					idTargetSP);

<span class="nc" id="L2683">			sp = dao.getSchedulingPeriodByID(idTargetSP);</span>

			// Set description: This scheduling period is cloned from &lt;date&gt; to &lt;date&gt;
<span class="nc" id="L2686">			Localizer localizer = LocalizationManager.getInstance().getLocalizer(localeCtx);</span>
<span class="nc" id="L2687">			String messageTemplate = localizer.i18n(BbmEjbBundleKey.BUNDLE, BbmEjbBundleKey.SCHEDULINGPERIOD_CLONED_DESC);</span>
<span class="nc" id="L2688">			Object[] args = new Object[]{strSPname};</span>
<span class="nc" id="L2689">			String descStr = MessageFormat.format(messageTemplate, args);</span>
<span class="nc" id="L2690">			sp.setDescription(descStr);</span>

<span class="nc" id="L2692">			dao.updateSchedulingPeriods(Collections.singleton(sp));</span>

<span class="nc" id="L2694">			Collection&lt;ID&gt; subIDs = camDao.getSubCampaignIDs(campaignID);</span>
<span class="nc bnc" id="L2695" title="All 2 branches missed.">			for (ID subID : subIDs) {</span>
<span class="nc" id="L2696">				SchedulingPeriod subSP = new SchedulingPeriod();</span>
<span class="nc" id="L2697">				subSP.setCampaignID(subID);</span>
<span class="nc" id="L2698">				subSP.setName(sp.getName());</span>
<span class="nc" id="L2699">				subSP.setStartTimeLocal(newSP.getStartTimeLocal());</span>
<span class="nc" id="L2700">				subSP.setEndTimeLocal(newSP.getEndTimeLocal());</span>
<span class="nc" id="L2701">				childSps.add(subSP);</span>

<span class="nc" id="L2703">				TimeZone subtz = CampaignDAO.getTimeZoneByCampaignID(subID);</span>

<span class="nc" id="L2705">				Collection&lt;CampaignHOO&gt; subSPHOOs = new ArrayList&lt;CampaignHOO&gt;();</span>
<span class="nc bnc" id="L2706" title="All 2 branches missed.">				for (CampaignHOO spHOO : spHOOs) {</span>
<span class="nc" id="L2707">					LocalDate ld1 = new LocalDate(spHOO.getStartTime(), tz);</span>
<span class="nc" id="L2708">					Date d1 = ld1.getTime(tz);</span>
<span class="nc" id="L2709">					Collection&lt;CampaignHOO&gt; subHOOs = camHOODao.getCampaignHOOAssignments(subID, spHOO.getStartTime(),</span>
<span class="nc" id="L2710">							spHOO.getEndTime());</span>
<span class="nc bnc" id="L2711" title="All 2 branches missed.">					for (CampaignHOO spHOO2 : subHOOs) {</span>
<span class="nc" id="L2712">						LocalDate ld2 = new LocalDate(spHOO2.getStartTime(), subtz);</span>
<span class="nc" id="L2713">						Date d2 = ld2.getTime(subtz);</span>

<span class="nc bnc" id="L2715" title="All 2 branches missed.">						if (d1.equals(d2)) {</span>
<span class="nc" id="L2716">							subSPHOOs.add(spHOO2);</span>
						}
<span class="nc" id="L2718">					}</span>
<span class="nc" id="L2719">				}</span>
				// new construct the hoos
<span class="nc bnc" id="L2721" title="All 2 branches missed.">				if (subSPHOOs.size() == 0) {</span>
<span class="nc" id="L2722">					continue;</span>
				}

<span class="nc" id="L2725">				ID targetSubSPID = dao.CloneSP(subtz, subSP, subSPHOOs, copyFlags, bIgnoreWarnings);</span>

				SchedulingPeriod subSP2;
<span class="nc" id="L2728">				String strSubSPname = copyShiftAssignmentsAndEffectiveDates(dao, campaign, subSP, subSPHOOs,</span>
						bCopyAssignments, tz, targetSubSPID);

<span class="nc" id="L2731">				subSP2 = dao.getSchedulingPeriodByID(targetSubSPID);</span>

<span class="nc" id="L2733">				Object[] argsSub = new Object[]{strSubSPname};</span>
<span class="nc" id="L2734">				String descSubStr = MessageFormat.format(messageTemplate, argsSub);</span>
<span class="nc" id="L2735">				subSP2.setDescription(descSubStr);</span>
<span class="nc" id="L2736">				subSP2.setParentSPID(sp.getDEID());</span>
<span class="nc" id="L2737">				dao.updateSchedulingPeriods(Collections.singleton(subSP2));</span>
<span class="nc" id="L2738">			}</span>
<span class="nc" id="L2739">		} catch (JdmoException e) {</span>
<span class="nc" id="L2740">			handleException(e);</span>
<span class="nc" id="L2741">			throw e;</span>
<span class="nc" id="L2742">		} catch (MultiUserException e) {</span>
			// Don't need to re-throw exception because this is for
			// updating SP Description after clone SP
<span class="nc" id="L2745">			handleException(e);</span>
<span class="nc" id="L2746">		} catch (BbmUpdateException e) {</span>
			// Don't need to re-throw exception because this is for
			// updating SP Description after clone SP
<span class="nc" id="L2749">			handleException(e);</span>
<span class="nc" id="L2750">		} catch (RemoteException e) {</span>
<span class="nc" id="L2751">			handleException(e);</span>
<span class="nc" id="L2752">			throw e;</span>
<span class="nc" id="L2753">		} catch (BbmException e) {</span>
<span class="nc" id="L2754">			handleException(e);</span>
<span class="nc" id="L2755">			throw e;</span>
		} finally {
<span class="nc" id="L2757">			dao.cleanUp();</span>
<span class="nc" id="L2758">			camDao.cleanUp();</span>
<span class="nc" id="L2759">			camHOODao.cleanUp();</span>
<span class="nc" id="L2760">			methodFinish();</span>
<span class="nc" id="L2761">		}</span>
<span class="nc" id="L2762">		return new ClonedSchedulingPeriodResult(sp, childSps);</span>
	}

	private String copyShiftAssignmentsAndEffectiveDates(SchedulingPeriodDAO dao, Campaign campaign, SchedulingPeriod newSP,
			Collection&lt;CampaignHOO&gt; spHOOs, boolean bCopyAssignments, TimeZone tz, ID idTargetSP)
			throws BbmFinderException, RemoteException, BbmScheduleConflictException {

<span class="nc" id="L2769">		boolean bClearDestinationSP = false;</span>
<span class="nc" id="L2770">		LocalDate startLD = new LocalDate(newSP.getEndTimeLocal());</span>
<span class="nc" id="L2771">		LocalDate endLD = new LocalDate(newSP.getEndTimeLocal());</span>
		Date targetWeekStart, sourceWeekStart;
		ID idSourceSP;
<span class="nc" id="L2774">		ArrayList&lt;CampaignHOO&gt; CampHOOAL = new ArrayList&lt;CampaignHOO&gt;(spHOOs);</span>
<span class="nc" id="L2775">		ListIterator&lt;CampaignHOO&gt; litr = CampHOOAL.listIterator(CampHOOAL.size());</span>
<span class="nc" id="L2776">		ArrayList&lt;ID&gt; spIds = new ArrayList();</span>
<span class="nc" id="L2777">		StringBuilder strSPname = new StringBuilder();</span>
<span class="nc" id="L2778">		SchedulingPeriod sp = null;</span>

<span class="nc" id="L2780">		Date startGMTDt = newSP.getStartTime();</span>
<span class="nc" id="L2781">		Calendar currentDate = Calendar.getInstance(tz);</span>
<span class="nc" id="L2782">		currentDate.setTime(newSP.getEndTime());</span>

<span class="nc bnc" id="L2784" title="All 2 branches missed.">		while (litr.hasPrevious()) {</span>
<span class="nc" id="L2785">			CampaignHOO spHOO = litr.previous();</span>
<span class="nc" id="L2786">			endLD = new LocalDate(startLD);</span>

<span class="nc bnc" id="L2788" title="All 2 branches missed.">			if (campaign.isMonthly()) {</span>
				// some weeks of monthly SPs may have less than 7 days
<span class="nc" id="L2790">				int numOfDaysToStartWeek = MonthlySPUtil.getNumOfDaysToWeekStartDate(tz, currentDate.getTime(), MonthlySPUtil.getWeekStartDay(campaign.getWeekStart()), startGMTDt);</span>
<span class="nc" id="L2791">				currentDate.add(Calendar.DATE, -numOfDaysToStartWeek);</span>
<span class="nc" id="L2792">				startLD.add(Calendar.DATE, -numOfDaysToStartWeek);</span>
<span class="nc" id="L2793">			} else {</span>
<span class="nc" id="L2794">				startLD.add(Calendar.DATE, -7);</span>
			}

<span class="nc" id="L2797">			targetWeekStart = TimePeriodUtil.convertToGMTFromLocalDateTimeInTimeZone(startLD, tz);</span>
<span class="nc" id="L2798">			sourceWeekStart = spHOO.getStartTime();</span>
<span class="nc" id="L2799">			idSourceSP = spHOO.getSPID();</span>

<span class="nc bnc" id="L2801" title="All 2 branches missed.">			if (spIds.isEmpty()) {</span>
<span class="nc" id="L2802">				spIds.add(idSourceSP);</span>
<span class="nc" id="L2803">				sp = dao.getSchedulingPeriodByID(idSourceSP);</span>
<span class="nc" id="L2804">				strSPname.append(sp.getName());</span>
<span class="nc bnc" id="L2805" title="All 2 branches missed.">			} else if (!spIds.contains(idSourceSP)) {</span>
				// check for duplicate sp id
<span class="nc" id="L2807">				spIds.add(idSourceSP);</span>
<span class="nc" id="L2808">				sp = dao.getSchedulingPeriodByID(idSourceSP);</span>
<span class="nc" id="L2809">				strSPname.append(&quot;, &quot;).append(sp.getName());</span>
			}

<span class="nc" id="L2812">			m_scheduleAccessManager.copyShiftAssignments(idSourceSP, sourceWeekStart, idTargetSP, targetWeekStart, bClearDestinationSP);</span>
<span class="nc bnc" id="L2813" title="All 2 branches missed.">			if (bCopyAssignments) {</span>
<span class="nc" id="L2814">				m_scheduleAccessManager.copyEffectiveDates(idSourceSP, sourceWeekStart, idTargetSP, targetWeekStart);</span>
			}
<span class="nc" id="L2816">			endLD = startLD;</span>
<span class="nc" id="L2817">		}</span>

<span class="nc" id="L2819">		return strSPname.toString();</span>
	}

	/**
	 * &lt;B&gt;createSPEmpTemplate&lt;/B&gt;
	 * &lt;p&gt;
	 * creates given SPEmpTemplate in db, and sets it's id
	 * &lt;p&gt;
	 *
	 * @param spEmpTemp : SPEmpTemplate to create
	 * @return SPEmpTemplate id
	 */
	public ID createSPEmpTemplate(SPEmpTemplate spEmpTemp) throws BbmCreateException {
<span class="nc" id="L2832">		methodStart(&quot;createSPEmpTemplate&quot;, spEmpTemp);</span>
<span class="nc" id="L2833">		SPEmpTemplateDAO spEmpTemplateDao = null;</span>
<span class="nc" id="L2834">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L2836">			spEmpTemplateDao = new SPEmpTemplateDAO();</span>
<span class="nc" id="L2837">			spEmpTemp.setDEID(new ID(DAOUtil.getDEID(dmo)));</span>
<span class="nc" id="L2838">			spEmpTemplateDao.setIDs(spEmpTemp);</span>
<span class="nc" id="L2839">			ID spEmpTempID = spEmpTemplateDao.createObject(spEmpTemp);</span>
<span class="nc" id="L2840">			spEmpTemp.setDEID(spEmpTempID);</span>
			// find SID and return
<span class="nc" id="L2842">			ID createdID = spEmpTempID;</span>
<span class="nc" id="L2843">			String stmt = &quot;SELECT SID FROM SPEMPTEMPLATE WHERE ID ='&quot; + spEmpTempID + &quot;'&quot;;</span>
<span class="nc" id="L2844">			JdmoRowset rs = dmo.createRowset(stmt);</span>
<span class="nc bnc" id="L2845" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L2846">				createdID = rs.getID(1);</span>
			}
<span class="nc" id="L2848">			rs.close();</span>
<span class="nc" id="L2849">			return createdID;</span>
<span class="nc" id="L2850">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L2851">			handleException(e, true);</span>
<span class="nc" id="L2852">			throw e;</span>
<span class="nc" id="L2853">		} catch (JdmoException e) {</span>
<span class="nc" id="L2854">			handleException(e, true);</span>
<span class="nc" id="L2855">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc bnc" id="L2857" title="All 4 branches missed.">			if (spEmpTemplateDao != null) {</span>
<span class="nc" id="L2858">				spEmpTemplateDao.cleanUp();</span>
			}
<span class="nc" id="L2860">			dmo.cleanUp();</span>
<span class="nc" id="L2861">			methodFinish();</span>
		}
	}

	/**
	 * &lt;B&gt;updateSPEmpTemplate&lt;/B&gt;
	 * &lt;p&gt;
	 * creates given SPEmpTemplate in db, and sets it's id
	 * &lt;p&gt;
	 *
	 * @param colSPEmpTemplateIDs
	 *            : list of SPEmpTemplate to create
	 * @return SPEmpTemplate id
	 */
	public void updateSPEmpTemplate(Collection&lt;SPEmpTemplate&gt; colSPEmpTemplateIDs) throws BbmUpdateException,
			MultiUserException {
<span class="nc" id="L2877">		methodStart(&quot;updateSPEmpTemplate&quot;);</span>
<span class="nc" id="L2878">		SPEmpTemplateDAO spEmpTemplateDao = null;</span>
		try {
<span class="nc bnc" id="L2880" title="All 2 branches missed.">			for (SPEmpTemplate spEmpTemp : colSPEmpTemplateIDs) {</span>
				// spEmpTemp.validate();
<span class="nc" id="L2882">				spEmpTemplateDao = new SPEmpTemplateDAO();</span>
<span class="nc" id="L2883">				spEmpTemplateDao.setIDs(spEmpTemp);</span>
<span class="nc" id="L2884">				spEmpTemplateDao.updateObject(spEmpTemp);</span>
				// if (cacheUsed()) {
				// m_ActivityCache.put(activity.getID(), activity);
				// }
<span class="nc" id="L2888">			}</span>
<span class="nc" id="L2889">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L2890">			handleException(e, true);</span>
<span class="nc" id="L2891">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L2892">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L2893">			handleException(e, true);</span>
<span class="nc" id="L2894">			throw e;</span>
<span class="nc" id="L2895">		} catch (MultiUserException e) {</span>
<span class="nc" id="L2896">			handleException(e, true);</span>
<span class="nc" id="L2897">			throw e;</span>
		} finally {
<span class="nc bnc" id="L2899" title="All 4 branches missed.">			if (spEmpTemplateDao != null) {</span>
<span class="nc" id="L2900">				spEmpTemplateDao.cleanUp();</span>
			}
<span class="nc" id="L2902">			methodFinish();</span>
<span class="nc" id="L2903">		}</span>
<span class="nc" id="L2904">	}</span>

	public void deleteSPEmpTemplate(Collection&lt;ID&gt; colSPEmpTemplateIDs) throws BbmRemoveException {
<span class="nc" id="L2907">		methodStart(&quot;deleteSPEmpTemplate&quot;);</span>
<span class="nc bnc" id="L2908" title="All 4 branches missed.">		if (colSPEmpTemplateIDs == null || colSPEmpTemplateIDs.isEmpty()) {</span>
<span class="nc" id="L2909">			return;</span>
		}
<span class="nc" id="L2911">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc" id="L2913">			String where = &quot;select ID from SPEMPTEMPLATE where SID in &quot; + dmo.createInClause(colSPEmpTemplateIDs);</span>
<span class="nc" id="L2914">			DAOUtil.deleteObjects(dmo, &quot;SPEMPTEMPLATE&quot;, where);</span>
<span class="nc" id="L2915">			DAOUtil.deleteObjects(dmo, &quot;SPEMPTEMPLATE&quot;, colSPEmpTemplateIDs);</span>

<span class="nc" id="L2917">		} catch (Exception ex) {</span>
<span class="nc" id="L2918">			throw new BbmRemoveException(ex);</span>
		} finally {
<span class="nc" id="L2920">			dmo.cleanUp();</span>
<span class="nc" id="L2921">		}</span>
<span class="nc" id="L2922">	}</span>

	/**
	 * Get the SPEmpTemplates that belong to this scheduling period
	 *
	 * @param spid
	 * @return
	 * @throws BbmFinderException
	 */
	private Collection getSPEmpTemplatesBySPID(ID spid) throws BbmFinderException {
<span class="nc" id="L2932">		methodStart(&quot;getSPEmpTemplatesBySP&quot;);</span>
<span class="nc" id="L2933">		SPEmpTemplateDAO dao = new SPEmpTemplateDAO();</span>
		try {
<span class="nc" id="L2935">			return dao.getSPEmpTemplatesBySP(spid);</span>
<span class="nc" id="L2936">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2937">			handleException(e);</span>
<span class="nc" id="L2938">			throw e;</span>
		} finally {
<span class="nc" id="L2940">			dao.cleanUp();</span>
<span class="nc" id="L2941">			methodFinish();</span>
		}
	}

	public Collection getSPEmpTemplatesBySP(ID spid) throws BbmFinderException {
<span class="nc" id="L2946">		methodStart(&quot;getSPEmpTemplatesBySP&quot;);</span>
<span class="nc" id="L2947">		SPEmpTemplateDAO dao = new SPEmpTemplateDAO();</span>
<span class="nc" id="L2948">		SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO();</span>
<span class="nc" id="L2949">		Collection&lt;SPEmpTemplate&gt; spEmpTemplate = new ArrayList&lt;SPEmpTemplate&gt;();</span>
<span class="nc" id="L2950">		SchedulingPeriod childSp = spDAO.getSchedulingPeriodByID(spid);</span>
<span class="nc" id="L2951">		ID parentSPID = DAOUtil.mapIDToSID(childSp.getParentSPID(), spDAO.getFieldInfo());// childSp.getParentSPID();</span>

		try {
<span class="nc bnc" id="L2954" title="All 2 branches missed.">			if (parentSPID == null) {</span>
				// cur SP is parent, add from Sub SP
<span class="nc" id="L2956">				Collection&lt;ID&gt; subSPIDs = getSubSPIDsFromParentSPID(spid);</span>
<span class="nc" id="L2957">				long nNumSPs = subSPIDs.size();</span>
<span class="nc bnc" id="L2958" title="All 2 branches missed.">				for (Iterator it = subSPIDs.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2959">					ID subID = (ID) it.next();</span>
<span class="nc" id="L2960">					spEmpTemplate.addAll(getSPEmpTemplatesBySPID(subID));</span>
<span class="nc" id="L2961">				}</span>

				// add from current SP
<span class="nc" id="L2964">				spEmpTemplate.addAll(getSPEmpTemplatesBySPID(spid));</span>
<span class="nc" id="L2965">			} else {</span>
				// cur SP is child, add from parent SP
<span class="nc bnc" id="L2967" title="All 2 branches missed.">				if (parentSPID != null) {</span>
					// parentSPID is a DEID, however getSPEmpTemplatesBySPID
					// expects an SID. It would be
					// ideal to have the parent SP ID set automatically with an
					// SID, but I'm not sure what
					// the ramifications of doing so would be to the other areas
					// in the code that reference
					// SchedulingPeriodDAO.getSchedulingPeriodByID()
<span class="nc" id="L2975">					ID parentSPSID = DAOUtil.mapIDToSID(parentSPID, new SchedulingPeriodFieldInfo());</span>
<span class="nc" id="L2976">					spEmpTemplate.addAll(getSPEmpTemplatesBySPID(parentSPSID));</span>
				}

				// add from sub sp if any?
<span class="nc" id="L2980">				Collection&lt;ID&gt; subSPIDs = getSubSPIDsFromParentSPID(spid);</span>
<span class="nc" id="L2981">				long nNumSPs = subSPIDs.size();</span>
<span class="nc bnc" id="L2982" title="All 2 branches missed.">				for (Iterator it = subSPIDs.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L2983">					ID subID = (ID) it.next();</span>
<span class="nc bnc" id="L2984" title="All 2 branches missed.">					if (subID != spid) {</span>
<span class="nc" id="L2985">						spEmpTemplate.addAll(getSPEmpTemplatesBySPID(subID));</span>
					}
<span class="nc" id="L2987">				}</span>
				// add from current SP
<span class="nc" id="L2989">				spEmpTemplate.addAll(getSPEmpTemplatesBySPID(spid));</span>

			}
<span class="nc" id="L2992">			return spEmpTemplate;</span>
<span class="nc" id="L2993">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L2994">			handleException(e);</span>
<span class="nc" id="L2995">			throw e;</span>
		} finally {
<span class="nc" id="L2997">			dao.cleanUp();</span>
<span class="nc" id="L2998">			spDAO.cleanUp();</span>
<span class="nc" id="L2999">			methodFinish();</span>
		}
	}

	/**
	 * Returns the child scheduling period IDs of the SP having the specified
	 * numeric or alphanumeric ID.
	 *
	 * @param parentSPID the ID of the parent SP--may be SID or DEID (numeric or
	 *                   alphanumeric)
	 * @return a collection of IDs of the child SPs
	 * @throws JdmoException
	 * @throws BbmFinderException if the specified ID cannot be mapped to a DEID
	 */
	public Collection&lt;ID&gt; getSubSPIDsFromParentSPID(ID parentSPID) throws BbmFinderException {
<span class="nc" id="L3014">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L3016">			return dao.getSubSPIDsFromParentSPID(parentSPID);</span>
<span class="nc" id="L3017">		} catch (BbmFinderException bfe) {</span>
<span class="nc" id="L3018">			handleException(bfe);</span>
<span class="nc" id="L3019">			throw bfe;</span>
<span class="nc" id="L3020">		} catch (Exception e) {</span>
<span class="nc" id="L3021">			handleException(e);</span>
<span class="nc" id="L3022">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L3024">			dao.cleanUp();</span>
		}
	}

	/**
	 * Returns a map whose keys are SPQueue IDs and whose values are the
	 * corresponding SPQueues. The map will contain all the SPQueues associated
	 * with the specified campaign, collection of queues, and time range.
	 * &lt;p/&gt;
	 * Returns an empty map if {@code campaignID} is {@code null}.
	 *
	 * @param campaignID
	 * @param queueIDs
	 * @param start
	 * @param end
	 * @return
	 * @throws RemoteException
	 * @throws BbmFinderException
	 */
	public Map&lt;ID, SPQueue&gt; getIDToSPQueueMapping(ID campaignID, Collection&lt;? extends ID&gt; queueIDs, Date start, Date end)
			throws BbmFinderException {
<span class="nc" id="L3045">        methodStart(&quot;getIDToSPQueueMapping&quot;, campaignID, queueIDs, start, end);</span>

<span class="nc" id="L3047">		Map&lt;ID, SPQueue&gt; idToSPQueueMapping = new HashMap&lt;ID, SPQueue&gt;();</span>
<span class="nc" id="L3048">		Jdmo dmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L3050" title="All 2 branches missed.">			if (campaignID != null) {</span>
<span class="nc" id="L3051">				SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO(dmo);</span>
<span class="nc" id="L3052">				Collection&lt;SchedulingPeriod&gt; colSP = spDAO.getSchedulingPeriods(campaignID, start, end, null, null);</span>
<span class="nc" id="L3053">				SPQueueDAO dao = new SPQueueDAO(dmo);</span>
<span class="nc" id="L3054">				Collection&lt;SPQueue&gt; colSPQs = dao.getSPQueuesBySPIDsFixed(ValueObjectUtil.getIDFromObjects(colSP));</span>
<span class="nc bnc" id="L3055" title="All 2 branches missed.">				for (SPQueue spQ : colSPQs) {</span>
<span class="nc bnc" id="L3056" title="All 2 branches missed.">					if (queueIDs.contains(spQ.getQueueID())) {</span>
<span class="nc" id="L3057">						idToSPQueueMapping.put(spQ.getID(), spQ);</span>
					}
<span class="nc" id="L3059">				}</span>
			}
<span class="nc" id="L3061">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L3062">			handleException(e, false);</span>
<span class="nc" id="L3063">			throw e;</span>
		} finally {
<span class="nc bnc" id="L3065" title="All 4 branches missed.">			if (dmo != null) {</span>
<span class="nc" id="L3066">				dmo.cleanUp();</span>
			}
<span class="nc" id="L3068">			methodFinish();</span>
<span class="nc" id="L3069">		}</span>
<span class="nc" id="L3070">		return idToSPQueueMapping;</span>
	}

	/**
	 * Returns a map whose keys are SPQueue IDs and whose values are the
	 * corresponding SPQueues. The map will contain all the SPQueues associated
	 * with the specified campaign, queue, and time range.
	 * &lt;p/&gt;
	 * Returns an empty map if {@code campaignID} is {@code null} or if the
	 * queue ID does not share any SPQueues with the specified campaign.
	 *
	 * @param campaignID
	 * @param queueID
	 * @param start
	 * @param end
	 * @return
	 * @throws RemoteException
	 * @throws BbmFinderException
	 */
	public Map&lt;ID, SPQueue&gt; getIDToSPQueueMapping(ID campaignID, ID queueID, Date start, Date end)
			throws RemoteException, BbmFinderException {
<span class="nc" id="L3091">		return getIDToSPQueueMapping(campaignID, new ArrayList(Arrays.asList(queueID)), start, end);</span>
	}

	/**
	 * Returns a list of all the child SpQueues of the parent distributed
	 * SpQueue.
	 *
	 * @param distributedSpQueueId
	 * @return
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	public Collection&lt;SPQueue&gt; getChildSpQueuesOfDistributedSpQueue(ID distributedSpQueueId) throws BbmFinderException,
			RemoteException {
<span class="nc" id="L3105">		Collection&lt;SPQueue&gt; childSpQueues = new ArrayList&lt;SPQueue&gt;();</span>
<span class="nc" id="L3106">		SPQueue spq = getSPQueue(distributedSpQueueId);</span>
<span class="nc bnc" id="L3107" title="All 2 branches missed.">		boolean isCombined = spq.getQueueID() == null;</span>
<span class="nc" id="L3108">		Collection&lt;ID&gt; childQueueIds = null;</span>
<span class="nc bnc" id="L3109" title="All 2 branches missed.">		if (!isCombined) {</span>
<span class="nc" id="L3110">			childQueueIds = m_workloadManager.getSubQueues(Collections.singleton(spq.getQueueID()));</span>
		}
<span class="nc" id="L3112">		Collection&lt;ID&gt; childSpIds = getSubSPIDsFromParentSPID(spq.getSpID());</span>
<span class="nc" id="L3113">		Collection&lt;SPQueue&gt; candidateSpQueues = getSPQueuesBySPIDs(childSpIds);</span>
<span class="nc bnc" id="L3114" title="All 2 branches missed.">		for (SPQueue spQueue : candidateSpQueues) {</span>
			// We handle combined single media but not combined-combined
<span class="nc bnc" id="L3116" title="All 8 branches missed.">			if ((isCombined &amp;&amp; spQueue.getQueueID() == null &amp;&amp; spQueue.getMediaID() != null)</span>
<span class="nc bnc" id="L3117" title="All 2 branches missed.">					|| ((!isCombined) &amp;&amp; childQueueIds.contains(spQueue.getQueueID()))) {</span>
<span class="nc" id="L3118">				childSpQueues.add(spQueue);</span>
			}
<span class="nc" id="L3120">		}</span>
<span class="nc" id="L3121">		return childSpQueues;</span>
	}

	/**
	 * If the queue associated with {@code childSpQueueId} is deferred or
	 * immediate and a child queue of a parent distributed queue, then this
	 * method returns the parent SPQueue. Otherwise it returns {@code null}.
	 * {@code childSpQueueId} may be associated either with a single or combined
	 * queue.
	 *
	 * @param childSpQueueId
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	public SPQueue getDistributedParentSpQueue(ID childSpQueueId) throws BbmFinderException, RemoteException {
<span class="nc" id="L3136">		SPQueueDAO spqDao = new SPQueueDAO();</span>
<span class="nc" id="L3137">		SchedulingPeriodDAO spDAO = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L3139">			SPQueue childSpQueue = spqDao.getObjectByID(childSpQueueId);</span>
			// Only process immediate and deferred queues
<span class="nc bnc" id="L3141" title="All 4 branches missed.">			if (Media.isMediaImmediate(childSpQueue.getMediaID()) || Media.isMediaDeferred(childSpQueue.getMediaID())) {</span>

<span class="nc" id="L3143">				SchedulingPeriod childSp = spDAO.getSchedulingPeriodByID(childSpQueue.getSpID());</span>
<span class="nc" id="L3144">				Campaign campaign = getCampaignByID(childSp.getCampaignID());</span>
<span class="nc" id="L3145">				ID parentCampaignID = campaign.getParentCampaignID();</span>
				// Only process if the current campaign has a parent...
<span class="nc bnc" id="L3147" title="All 2 branches missed.">				if (parentCampaignID != null) {</span>
<span class="nc" id="L3148">					Campaign parentCampaign = getCampaignByID(parentCampaignID);</span>
					// ... and the parent is distributed
<span class="nc bnc" id="L3150" title="All 2 branches missed.">					if (parentCampaign.getIsDistributed()) {</span>
<span class="nc bnc" id="L3151" title="All 2 branches missed.">						if (childSpQueue.getQueueID() == null) {</span>
							// combined queue
<span class="nc" id="L3153">							return getCombinedSPQueue(childSp.getParentID(), childSpQueue.getMediaID());</span>
						} else {
							// single queue
<span class="nc" id="L3156">							QueueDAO queueDao = new QueueDAO(); // Doesn't need</span>
							// cleanup call.
<span class="nc" id="L3158">							Queue queue = queueDao.getObjects(Collections.singleton(childSpQueue.getQueueID())).iterator()</span>
<span class="nc" id="L3159">									.next();</span>
<span class="nc" id="L3160">							ID parentQueueId = queue.getParentID();</span>
<span class="nc" id="L3161">							return getSPQueue(DAOUtil.mapIDToSID(childSp.getParentSPID(), spDAO.getFieldInfo()),</span>
									parentQueueId);
						}
					}
				}
			}
<span class="nc" id="L3167">		} catch (BbmFinderException bfe) {</span>
<span class="nc" id="L3168">			handleException(bfe);</span>
<span class="nc" id="L3169">			throw bfe;</span>
<span class="nc" id="L3170">		} catch (Exception e) {</span>
<span class="nc" id="L3171">			handleException(&quot;getDistributedParentSpQueue&quot;, e, false);</span>
<span class="nc" id="L3172">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L3174">			spqDao.cleanUp();</span>
<span class="nc" id="L3175">			spDAO.cleanUp();</span>
<span class="nc" id="L3176">		}</span>
<span class="nc" id="L3177">		return null;</span>
	}

	/**
	 * Returns a map of Scheduling Period IDs to their associated campaign's
	 * name.
	 *
	 * @param spIDs - The scheduling period IDs for which we'd like to look up
	 *              their associated campaign's name.
	 * @throws BbmFinderException
	 */
	public Map&lt;ID, String&gt; getCampaignNamesLinkedToSPs(Collection&lt;ID&gt; spIDs) throws RemoteException, BbmFinderException {
<span class="nc" id="L3189">		methodStart(&quot;getCampaignNamesLinkedToSPs&quot;, spIDs);</span>
<span class="nc" id="L3190">		CampaignDAO dao = new CampaignDAO();</span>
		try {
<span class="nc" id="L3192">			return dao.getCampaignNamesLinkedToSPs(spIDs);</span>
		} finally {
<span class="nc" id="L3194">			dao.cleanUp();</span>
<span class="nc" id="L3195">			methodFinish();</span>
		}
	}

	public void unlinkEmployeeShiftAssignments(Employee emp) throws BbmFinderException, BbmRemoveException {
<span class="nc" id="L3200">		methodStart(&quot;unlinkEmployeeShiftAssignments&quot;);</span>

<span class="nc" id="L3202">		SchedulingPeriodDAO dao = new SchedulingPeriodDAO();</span>
		try {
<span class="nc" id="L3204">			dao.unlinkShiftAssignmentToSP(emp.getID(), emp.getOrgChangedDate());</span>
		} finally {
<span class="nc" id="L3206">			dao.cleanUp();</span>
<span class="nc" id="L3207">			methodFinish();</span>
<span class="nc" id="L3208">		}</span>
<span class="nc" id="L3209">	}</span>

	/**
	 * get an given organization's campaign assignments
	 *
	 * @param idOrg   organization id
	 * @param dtStart
	 * @param dtEnd   the time period, null date means a open period
	 * @return a collection of CampaignOrg objects which hold the assignment
	 * information
	 */
	public Collection getOrgCampaignAssignments(ID idOrg, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L3221">		methodStart(&quot;getOrgCampaignAssignments&quot;, idOrg, dtStart, dtEnd);</span>
<span class="nc" id="L3222">		CampaignOrgDAO dao = new CampaignOrgDAO();</span>
		try {
<span class="nc" id="L3224">			return dao.getOrgCampaignAssignments(idOrg, dtStart, dtEnd);</span>
<span class="nc" id="L3225">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L3226">			handleException(e, false);</span>
<span class="nc" id="L3227">			throw e;</span>
		} finally {
<span class="nc" id="L3229">			dao.cleanUp();</span>
<span class="nc" id="L3230">			methodFinish();</span>
		}
	}

	public Collection&lt;SPQueue&gt; getSPQueuesByQueues(Collection&lt;Queue&gt; queues) throws BbmFinderException {
<span class="nc" id="L3235">		methodStart(&quot;getSPQueuesByQueues&quot;);</span>
<span class="nc" id="L3236">		SPQueueDAO dao = new SPQueueDAO();</span>
		try {
<span class="nc" id="L3238">			return dao.getSPQueuesByQueues(queues);</span>
		} finally {
<span class="nc" id="L3240">			dao.cleanUp();</span>
<span class="nc" id="L3241">			methodFinish();</span>
		}
	}

	public void cloneLSGTemplateForNewSP(ID idTargetSP, Collection&lt;CampaignHOO&gt; spHOOs) throws BbmCreateException {
<span class="nc bnc" id="L3246" title="All 6 branches missed.">		if (idTargetSP == null || spHOOs == null || spHOOs.isEmpty()) {</span>
<span class="nc" id="L3247">			return;</span>
		}
<span class="nc" id="L3249">		SPQueueDAO dao = null;</span>
<span class="nc" id="L3250">		SchedulingPeriodDAO spDao = null;</span>
		try {
<span class="nc" id="L3252">			dao = new SPQueueDAO();</span>
<span class="nc" id="L3253">			spDao = new SchedulingPeriodDAO();</span>
<span class="nc" id="L3254">			Collection&lt;SPQueue&gt; spQueues = dao.getSPQueuesBySPID(idTargetSP);</span>
<span class="nc" id="L3255">			Set&lt;ID&gt; previousSPIDs = new HashSet&lt;ID&gt;();</span>

<span class="nc bnc" id="L3257" title="All 2 branches missed.">			for (CampaignHOO campaignHOO : spHOOs) {</span>
<span class="nc bnc" id="L3258" title="All 2 branches missed.">				if (!previousSPIDs.contains(campaignHOO.getSPID())) {</span>
<span class="nc" id="L3259">					previousSPIDs.add(campaignHOO.getSPID());</span>
				}
<span class="nc" id="L3261">			}</span>

<span class="nc" id="L3263">			List&lt;SchedulingPeriod&gt; sortedPreviousSPs = new ArrayList&lt;SchedulingPeriod&gt;(spDao.getObjectsByIDs(previousSPIDs));</span>
<span class="nc" id="L3264">			Collections.sort(sortedPreviousSPs, new Comparator&lt;SchedulingPeriod&gt;() {</span>
				@Override
				public int compare(SchedulingPeriod o1, SchedulingPeriod o2) {
<span class="nc" id="L3267">					return o2.getStartTime().compareTo(o1.getStartTime());</span>
				}
			});
<span class="nc" id="L3270">			Map&lt;ID, ID&gt; queueIDToSPQueues = new HashMap&lt;ID, ID&gt;();</span>

<span class="nc bnc" id="L3272" title="All 2 branches missed.">			for (SchedulingPeriod sortedPreviousSP : sortedPreviousSPs) {</span>
<span class="nc" id="L3273">				Collection&lt;SPQueue&gt; spQueuesTemp = dao.getSPQueuesBySPID(sortedPreviousSP.getID());</span>
<span class="nc bnc" id="L3274" title="All 2 branches missed.">				for (SPQueue oQueue : spQueuesTemp) {</span>
<span class="nc bnc" id="L3275" title="All 2 branches missed.">					if (!queueIDToSPQueues.containsKey(oQueue.getQueueID())) {</span>
<span class="nc" id="L3276">						queueIDToSPQueues.put(oQueue.getQueueID(), oQueue.getDEID());</span>
					}
<span class="nc bnc" id="L3278" title="All 2 branches missed.">					if (queueIDToSPQueues.size() == spQueues.size()) {</span>
<span class="nc" id="L3279">						break;</span>
					}
<span class="nc" id="L3281">				}</span>
<span class="nc bnc" id="L3282" title="All 2 branches missed.">				if (queueIDToSPQueues.size() == spQueues.size()) {</span>
<span class="nc" id="L3283">					break;</span>
				}
<span class="nc" id="L3285">			}</span>

<span class="nc" id="L3287">			Map&lt;ID, ID&gt; previousSPQueueIdToNewSPQueueID = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc bnc" id="L3288" title="All 2 branches missed.">			for (SPQueue spQueue : spQueues) {</span>
<span class="nc" id="L3289">				ID oldSPQueueID = queueIDToSPQueues.get(spQueue.getQueueID());</span>
<span class="nc bnc" id="L3290" title="All 2 branches missed.">				if (oldSPQueueID != null) {</span>
<span class="nc" id="L3291">					previousSPQueueIdToNewSPQueueID.put(oldSPQueueID, spQueue.getDEID());</span>
				}
<span class="nc" id="L3293">			}</span>
<span class="nc" id="L3294">			getLSInfoExtractor().cloneLsgTemplateFromCurrentSPQueueIDToClonedSPQueueID(previousSPQueueIdToNewSPQueueID);</span>
<span class="nc" id="L3295">		} catch (Exception e) {</span>
<span class="nc" id="L3296">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc bnc" id="L3298" title="All 4 branches missed.">			if (dao != null) {</span>
<span class="nc" id="L3299">				dao.cleanUp();</span>
			}
<span class="nc bnc" id="L3301" title="All 4 branches missed.">			if (spDao != null) {</span>
<span class="nc" id="L3302">				spDao.cleanUp();</span>
			}
		}
<span class="nc" id="L3305">	}</span>

	private LSGInfoExtractor getLSInfoExtractor() throws Exception {
<span class="nc" id="L3308">		final GCRManager m_gcrManager = CoreManagerFactory.getGCRManagerRemote(m_isWhatIf);</span>
<span class="nc" id="L3309">		final String gcrType = &quot;OPERATIONS_LSG_MANAGER&quot;;</span>
<span class="nc" id="L3310">		final Collection entries = m_gcrManager.getGCREntryOfType(gcrType);</span>
<span class="nc" id="L3311">		final Class clazz = Class.forName(((GCREntry) (entries.iterator().next())).getHook());</span>
<span class="nc" id="L3312">		return (LSGInfoExtractor) clazz.newInstance();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>