<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ForecastingAppletRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.optimization.forecasting</a> &gt; <span class="el_source">ForecastingAppletRequestHandler.java</span></div><h1>ForecastingAppletRequestHandler.java</h1><pre class="source lang-java linenums">/*
 * (c) 2009-2012 Verint Systems, Inc.
 */
package com.verint.web.fs.optimization.forecasting;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.pulse.ejb.TrackingManager;
import com.bluepumpkin.ejb.bbm.pulse.model.PulseNoteBO;
import com.bluepumpkin.ejb.bbm.timeseries.ejb.TimeSeriesManager;
import com.bluepumpkin.ejb.bbm.timeseries.model.ActualTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.BacklogType;
import com.bluepumpkin.ejb.bbm.timeseries.model.ClientForecastTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastInstance;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceOperator;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.QueueList;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.core.l10n.CoreWebLogBundleKey;
import com.bluepumpkin.web.fs.Log;
import com.bluepumpkin.web.fs.keys.FsKeys;
import com.bluepumpkin.web.fs.pulse.keys.PulseKeys;
import com.verint.ejb.bbm.forecast.ForecastTraceCubeUtil;
import com.verint.ejb.bbm.forecast.ejb.ForecastTimeSeriesManager;
import com.verint.ejb.bbm.forecast.model.ForecastProfile;
import com.verint.ejb.bbm.forecast.model.ForecastProfileList;
import com.verint.ejb.bbm.forecast.model.ForecastProfileProject;
import com.verint.ejb.bbm.forecast.model.ProfileComponent.Type;
import com.verint.ejb.bbm.forecast.model.ProfileTimeSeries;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.fs.optimization.CombinedQueuePartialResponse;
import com.verint.web.fs.optimization.MultiQueuePartialResponse;
import com.verint.web.fs.optimization.OptimizationAppletRequestHandler;
import com.verint.web.fs.optimization.OptimizationKeys;
import com.verint.web.fs.optimization.SingleQueuePartialResponse;
import com.verint.web.fs.optimization.forecasting.l10n.ForecastingWebBundleKey;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.web.uif.system.RequestContext;

<span class="nc" id="L68">public class ForecastingAppletRequestHandler extends OptimizationAppletRequestHandler {</span>

<span class="nc" id="L70">	private static final Category cat = Log.initCategory(ForecastingAppletRequestHandler.class.getName());</span>

	/**
	 * Process Applet Request - to be overridden by derived classes
	 * @param context - The Request Context
	 * @param request - Map containing Applet Request Information
	 * @param response - Map containing Response to be send to Applet
	 */
	@Override
	protected void processAppletRequest(RequestContext context, Map&lt;? extends Object, ? extends Object&gt; request,
			Map&lt;Object, Object&gt; response) {
		try {
<span class="nc bnc" id="L82" title="All 2 branches missed.">			if (isAppletAction(request, ForecastingKeys.PROC_GET_VOLUME_AHT_HISTORY)) {</span>
<span class="nc" id="L83">				getVolumeAndAHTHistory(context, request, response);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_OUTBOUND_HISTORY)) {</span>
<span class="nc" id="L85">				getOutboundHistory(context, request, response);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_VOLUME_AHT_FORECAST)) {</span>
<span class="nc" id="L87">				getVolumeAndAHTForecast(context, request, response);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_OUTBOUND_FORECAST)) {</span>
<span class="nc" id="L89">				getOutboundMediaForecast(context, request, response);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_SINGLE_QUEUE_OUTBOUND_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L91">				getOutboundMediaFullSingleQueueModel(context, request, response);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_COMBINED_QUEUE_OUTBOUND_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L93">				getOutboundMediaPartialCombinedQueueModel(context, request, response);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_MULTI_QUEUE_OUTBOUND_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L95">				getOutboundMediaPartialMultiQueueModel(context, request, response);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_SINGLE_QUEUE_IMMEDIATE_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L97">				getImmediateMediaFullSingleQueueModel(context, request, response);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_COMBINED_QUEUE_IMMEDIATE_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L99">				getImmediateMediaPartialCombinedQueueModel(context, request, response);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_MULTI_QUEUE_IMMEDIATE_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L101">				getImmediateMediaPartialMultiQueueModel(context, request, response);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_SINGLE_QUEUE_DEFERRED_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L103">				getDeferredMediaFullSingleQueueModel(context, request, response);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_COMBINED_QUEUE_DEFERRED_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L105">				getDeferredMediaPartialCombinedQueueModel(context, request, response);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_MULTI_QUEUE_DEFERRED_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L107">				getDeferredMediaPartialMultiQueueModel(context, request, response);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_FORECAST_PROFILES)) {</span>
<span class="nc" id="L109">				getForecastProfiles(context, request, response);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_FORECAST_PROFILE)) {</span>
<span class="nc" id="L111">				saveForecastProfile(context, request, response);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_OUTBOUND_FORECAST_PROFILE)) {</span>
<span class="nc" id="L113">				saveOutboundForecastProfile(context, request, response);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_PROFILE_LISTS_FOR_SAVED_PROFILE)) {</span>
<span class="nc" id="L115">				getForecastProfileListsForManuallyModifiedAbsoluteForecastProfile(context, request, response);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_DELETE_FORECAST_PROFILE)) {</span>
<span class="nc" id="L117">				deleteForecastProfile(context, request, response);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_PROFILE_TIMESERIES_BY_PROFILE_ID)) {</span>
<span class="nc" id="L119">				getProfileTimeSeriesForProfileID(context, request, response);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_NOTES)) {</span>
<span class="nc" id="L121">				getNotes(context, request, response);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_IMMEDIATE_MEDIA_FORECAST_AS_BASE)) {</span>
<span class="nc" id="L123">				saveImmediateMediaForecastAsBase(context, request, response);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_IMMEDIATE_MEDIA_FORECAST_AS_ACTIVE)) {</span>
<span class="nc" id="L125">				saveImmediateMediaForecastAsActive(context, request, response);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_IMMEDIATE_MEDIA_FORECAST_INSTANCE)) {</span>
<span class="nc" id="L127">				saveImmediateMediaForecastInstance(context, request, response);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_DEFERRED_MEDIA_FORECAST_AS_BASE)) {</span>
<span class="nc" id="L129">				saveDeferredMediaForecastAsBase(context, request, response);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_DEFERRED_MEDIA_FORECAST_AS_ACTIVE)) {</span>
<span class="nc" id="L131">				saveDeferredMediaForecastAsActive(context, request, response);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_DEFERRED_MEDIA_FORECAST_INSTANCE)) {</span>
<span class="nc" id="L133">				saveDeferredMediaForecastInstance(context, request, response);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_OUTBOUND_MEDIA_FORECAST_AS_BASE)) {</span>
<span class="nc" id="L135">				saveOutboundMediaForecastAsBase(context, request, response);</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_OUTBOUND_MEDIA_FORECAST_AS_ACTIVE)) {</span>
<span class="nc" id="L137">				saveOutboundMediaForecastAsActive(context, request, response);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_OUTBOUND_MEDIA_FORECAST_INSTANCE)) {</span>
<span class="nc" id="L139">				saveOutboundMediaForecastInstance(context, request, response);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_FORECAST_INSTANCES_FOR_SP)) {</span>
<span class="nc" id="L141">				getForecastInstancesForSP(context, request, response);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_FORECAST_INSTANCES_FOR_SPQUEUE)) {</span>
<span class="nc" id="L143">				getForecastInstancesForSPQueue(context, request, response);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_IS_BASE_FORECAST_SET)) {</span>
<span class="nc" id="L145">				isBaseForecastSet(context, request, response);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_SCHEDULING_PERIODS_FOR_CAMPAIGN)) {</span>
<span class="nc" id="L147">				getSchedulingPeriodsForCampaign(context, request, response);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_FETCH_STARTING_BACKLOG_FOR_SPQUEUES)) {</span>
<span class="nc" id="L149">				fetchStartingBacklogForSPQueues(context, request, response);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_FETCH_ACTUAL_STARTING_BACKLOG_FOR_SPQUEUES_AT_DATE)) {</span>
<span class="nc" id="L151">				fetchActualStartingBacklogForSPQueuesAtDate(context, request, response);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_OUTBOUND_CALLS_HISTORY_LIST)) {</span>
<span class="nc" id="L153">				getHistoricalOutboundCallLists(context, request, response);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_COMBINED_QUEUE_PROJECT_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L155">				getProjectMediaPartialCombinedQueueModel(context, request, response);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_MULTI_QUEUE_PROJECT_MEDIA_FORECAST_MODEL)) {</span>
<span class="nc" id="L157">				getProjectMediaPartialMultiQueueModel(context, request, response);	</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">			} else if(isAppletAction(request, ForecastingKeys.PROC_GET_SINGLE_QUEUE_PROJECT_MEDIA_FORECAST_MODEL)){</span>
<span class="nc" id="L159">				getProjectMediaFullSingleQueueModel(context, request, response);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_SAVE_PROJECT_MEDIA_FORECAST_AS_ACTIVE)) {</span>
<span class="nc" id="L161">				saveProjectMediaForecast(context, request, response);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_STRATEGIC_FORECAST)) {</span>
<span class="nc" id="L163">				getStrategicForecast(context, request, response);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_DELETE_FORECAST_INSTANCE)) {</span>
<span class="nc" id="L165">				deleteForecastInstance(context, request, response);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.IS_PROFILE_SECURITY_ENABLED)) {</span>
<span class="nc" id="L167">				isProfileSecurityEnabled(context, request, response);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">			} else if (isAppletAction(request, ForecastingKeys.PROC_GET_DAYS_WITH_HISTORY)) {</span>
<span class="nc" id="L169">				getDaysWithHistory(context, request, response);</span>
			} else {
<span class="nc" id="L171">				super.processAppletRequest(context, request, response);</span>
			}
<span class="nc" id="L173">		} catch (Exception e) {</span>
<span class="nc" id="L174">			handleError(context, e,</span>
					CoreWebLogBundleKey.APPLET_PROCESS_REQUEST_ERROR,
					CoreWebBundleKey.APPLET_PROCESS_REQUEST_ERROR,
					CoreWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L178">		}</span>
<span class="nc" id="L179">	}</span>
	private void isBaseForecastSet(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L183">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L184">			Collection&lt;? extends ID&gt; ids = (Collection&lt;? extends ID&gt;) request.get(ForecastingKeys.PARAM_SPQUEUE_IDS);</span>
<span class="nc" id="L185">			Map&lt;ID, Boolean&gt; retVal = ftsm.isBaseForecastSet(ids);</span>
<span class="nc" id="L186">			response.put(ForecastingKeys.RETVAL_ID_BOOLEAN_MAP, retVal);</span>
<span class="nc" id="L187">		} catch (RemoteException e) {</span>
<span class="nc" id="L188">			throw new BbmException(e);</span>
<span class="nc" id="L189">		}</span>
<span class="nc" id="L190">	}</span>

	private void getForecastInstancesForSPQueue(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L195">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L196">			ID spQueueID = (ID)request.get(ForecastingKeys.PARAM_SPQUEUE_ID);</span>
<span class="nc" id="L197">			Collection&lt;ForecastInstance&gt; retVal = ftsm.getForecastInstancesForSPQueue(spQueueID);</span>
<span class="nc" id="L198">			response.put(ForecastingKeys.RETVAL_FORECAST_INSTANCE_COL, retVal);</span>
<span class="nc" id="L199">		} catch (RemoteException e) {</span>
<span class="nc" id="L200">			throw new BbmException(e);</span>
<span class="nc" id="L201">		}</span>
<span class="nc" id="L202">	}</span>

	private void getForecastInstancesForSP(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L207">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L208">			ID spID = (ID)request.get(ForecastingKeys.PARAM_SP_ID);</span>
<span class="nc" id="L209">			Collection&lt;ForecastInstance&gt; retVal = ftsm.getForecastInstancesForSP(spID);</span>
<span class="nc" id="L210">			response.put(ForecastingKeys.RETVAL_FORECAST_INSTANCE_COL, retVal);</span>
<span class="nc" id="L211">		} catch (RemoteException e) {</span>
<span class="nc" id="L212">			throw new BbmException(e);</span>
<span class="nc" id="L213">		}</span>
<span class="nc" id="L214">	}</span>
	
	private boolean checkIfUnknownCallVolumeIncluded() throws BbmEJBCreateException, RemoteException {
<span class="nc" id="L217">		return BbmManagerFactory.getDBConfigManager().getBooleanValue(ConfigKey.FORECASTING_INCLUDEUNKNOWNCV);</span>
	}

	private void isProfileSecurityEnabled(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L223">			response.put(ForecastingKeys.RETVAL, checkIfProfileSecurityEnabled());</span>
<span class="nc" id="L224">		} catch (RemoteException e) {</span>
<span class="nc" id="L225">			throw new BbmException(e);</span>
<span class="nc" id="L226">		}</span>
<span class="nc" id="L227">	}</span>
	
	private boolean checkIfProfileSecurityEnabled() throws BbmEJBCreateException, RemoteException {
<span class="nc" id="L230">		int enabled = BbmManagerFactory.getDBConfigManager().getIntValue(ConfigKey.ENABLEPROFILESECURITY);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">		return (enabled==1);</span>
	}

	private void saveImmediateMediaForecastInstance(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L237">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L238">			String name = (String) request.get(ForecastingKeys.PARAM_FORECAST_NAME);</span>
<span class="nc" id="L239">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="nc" id="L240">			Map&lt;? extends ID, ? extends TraceCube&gt; forecastDataBySPQueueID = (Map&lt;? extends ID, ? extends TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="nc" id="L241">			ftsm.saveImmediateMediaForecastInstance(name, profiles, forecastDataBySPQueueID, false);</span>
<span class="nc" id="L242">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L243">		} catch (RemoteException e) {</span>
<span class="nc" id="L244">			throw new BbmException(e);</span>
<span class="nc" id="L245">		}</span>
<span class="nc" id="L246">	}</span>

	private void saveImmediateMediaForecastAsActive(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L251">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L252">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>

<span class="nc" id="L254">			Map&lt;? extends ID, ? extends TraceCube&gt; forecastDataBySPQueueID = (Map&lt;? extends ID, ? extends TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
			// set profiles ID = null in order to delete the Active instance and create again. Otherwise, existing instance would be updated as active
<span class="nc" id="L256">			Collection&lt;ForecastProfile&gt; clonedProfiles = cloneProfiles(profiles);</span>
<span class="nc" id="L257">			ftsm.saveImmediateMediaForecastAsActive(clonedProfiles, forecastDataBySPQueueID);</span>
<span class="nc" id="L258">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L259">		} catch (RemoteException e) {</span>
<span class="nc" id="L260">			throw new BbmException(e);</span>
<span class="nc" id="L261">		}catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L262">			throw new BbmException(e);</span>
<span class="nc" id="L263">		}</span>
		
<span class="nc" id="L265">	}</span>

	private void saveImmediateMediaForecastAsBase(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L270">			String name = context.getLocalizer().i18n(ForecastingWebBundleKey.BUNDLE_NAME, ForecastingWebBundleKey.BASE_FORECAST_INSTANCE_NAME);</span>
<span class="nc" id="L271">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L272">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="nc" id="L273">			Map&lt;? extends ID, ? extends TraceCube&gt; forecastDataBySPQueueID = (Map&lt;? extends ID, ? extends TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="nc" id="L274">			ftsm.saveImmediateMediaForecastAsBase(name, profiles, forecastDataBySPQueueID);</span>
<span class="nc" id="L275">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L276">		} catch (RemoteException e) {</span>
<span class="nc" id="L277">			throw new BbmException(e);</span>
<span class="nc" id="L278">		}</span>
<span class="nc" id="L279">	}</span>

	private void saveDeferredMediaForecastAsBase(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L284">			String name = context.getLocalizer().i18n(ForecastingWebBundleKey.BUNDLE_NAME, ForecastingWebBundleKey.BASE_FORECAST_INSTANCE_NAME);</span>
<span class="nc" id="L285">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L286">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="nc" id="L287">			Map&lt;? extends ID, ? extends TraceCube&gt; forecastDataBySPQueueID = (Map&lt;? extends ID, ? extends TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="nc" id="L288">			Collection&lt;SPQueue&gt; spQueues = (Collection&lt;SPQueue&gt;) request.get(ForecastingKeys.PARAM_SPQUEUES);</span>
<span class="nc" id="L289">			ftsm.saveDeferredMediaForecastAsBase(name, profiles, forecastDataBySPQueueID, spQueues);</span>
<span class="nc" id="L290">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L291">		} catch (RemoteException e) {</span>
<span class="nc" id="L292">			throw new BbmException(e);</span>
<span class="nc" id="L293">		}</span>
<span class="nc" id="L294">	}</span>

	private void saveDeferredMediaForecastInstance(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L299">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L300">			String name = (String) request.get(ForecastingKeys.PARAM_FORECAST_NAME);</span>
<span class="nc" id="L301">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="nc" id="L302">			Map&lt;? extends ID, ? extends TraceCube&gt; forecastDataBySPQueueID = (Map&lt;? extends ID, ? extends TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="nc" id="L303">			Collection&lt;SPQueue&gt; spQueues = (Collection&lt;SPQueue&gt;) request.get(ForecastingKeys.PARAM_SPQUEUES);</span>
<span class="nc" id="L304">			ftsm.saveDeferredMediaForecastInstance(name, profiles, forecastDataBySPQueueID, spQueues, false);</span>
<span class="nc" id="L305">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L306">		} catch (RemoteException e) {</span>
<span class="nc" id="L307">			throw new BbmException(e);</span>
<span class="nc" id="L308">		}</span>
<span class="nc" id="L309">	}</span>

	private void saveDeferredMediaForecastAsActive(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L314">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L315">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="nc" id="L316">			Map&lt;? extends ID, ? extends TraceCube&gt; forecastDataBySPQueueID = (Map&lt;? extends ID, ? extends TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="nc" id="L317">			Collection&lt;SPQueue&gt; spQueues = (Collection&lt;SPQueue&gt;) request.get(ForecastingKeys.PARAM_SPQUEUES);</span>
			// set profiles ID = null in order to delete the Active instance and create again. Otherwise, existing instance would be updated as active
<span class="nc" id="L319">			Collection&lt;ForecastProfile&gt; clonedProfiles = cloneProfiles(profiles);</span>
<span class="nc" id="L320">			ftsm.saveDeferredMediaForecastAsActive(clonedProfiles, forecastDataBySPQueueID, spQueues);</span>
<span class="nc" id="L321">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L322">		} catch (RemoteException e) {</span>
<span class="nc" id="L323">			throw new BbmException(e);</span>
<span class="nc" id="L324">		}catch (CloneNotSupportedException e){</span>
<span class="nc" id="L325">			throw new BbmException(e);</span>
<span class="nc" id="L326">		}</span>
<span class="nc" id="L327">	}</span>
	
	private void saveOutboundMediaForecastAsBase(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L332">			String name = context.getLocalizer().i18n(ForecastingWebBundleKey.BUNDLE_NAME, ForecastingWebBundleKey.BASE_FORECAST_INSTANCE_NAME);</span>
<span class="nc" id="L333">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L334">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="nc" id="L335">			Map&lt;ID, TraceCube&gt; forecastDataBySPQueueID = (Map&lt;ID, TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="nc" id="L336">			Map&lt;ForecastProfile, Collection&lt;ForecastProfileList&gt;&gt; forecastProfileLists = (Map&lt;ForecastProfile, Collection&lt;ForecastProfileList&gt;&gt;) </span>
<span class="nc" id="L337">				request.get(ForecastingKeys.PARAM_FORECASTPROFILE_TO_FORECASTEDLISTS_MAP);</span>
<span class="nc" id="L338">			ftsm.saveOutboundMediaForecastAsBase(name, profiles,</span>
<span class="nc" id="L339">					ForecastTraceCubeUtil.convertOutboundClientForecastIntoSavableFormat(forecastDataBySPQueueID),</span>
					forecastProfileLists);
<span class="nc" id="L341">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L342">		} catch (RemoteException e) {</span>
<span class="nc" id="L343">			throw new BbmException(e);</span>
<span class="nc" id="L344">		}</span>
<span class="nc" id="L345">	}</span>

	private void saveOutboundMediaForecastInstance(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L350">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L351">			String name = (String) request.get(ForecastingKeys.PARAM_FORECAST_NAME);</span>
<span class="nc" id="L352">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="nc" id="L353">			Map&lt;ID, TraceCube&gt; forecastDataBySPQueueID = (Map&lt;ID, TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="nc" id="L354">			Map&lt;ForecastProfile, Collection&lt;ForecastProfileList&gt;&gt; forecastProfileLists = (Map&lt;ForecastProfile, Collection&lt;ForecastProfileList&gt;&gt;) </span>
<span class="nc" id="L355">			request.get(ForecastingKeys.PARAM_FORECASTPROFILE_TO_FORECASTEDLISTS_MAP);</span>
<span class="nc" id="L356">			ftsm.saveOutboundMediaForecastInstance(name, profiles,</span>
<span class="nc" id="L357">					ForecastTraceCubeUtil.convertOutboundClientForecastIntoSavableFormat(forecastDataBySPQueueID),</span>
					forecastProfileLists, false);
<span class="nc" id="L359">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L360">		} catch (RemoteException e) {</span>
<span class="nc" id="L361">			throw new BbmException(e);</span>
<span class="nc" id="L362">		}</span>
<span class="nc" id="L363">	}</span>

	private void saveOutboundMediaForecastAsActive(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L368">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L369">			Collection&lt;ForecastProfile&gt; profiles = (Collection&lt;ForecastProfile&gt;) request.get(ForecastingKeys.PARAM_FORECAST_PROFILE_COL);</span>
<span class="nc" id="L370">			Map&lt;ID, TraceCube&gt; forecastDataBySPQueueID = (Map&lt;ID, TraceCube&gt;) request.get(ForecastingKeys.PARAM_ID_TO_TRACECUBE_MAP);</span>
<span class="nc" id="L371">			Map&lt;ForecastProfile, Collection&lt;ForecastProfileList&gt;&gt; forecastProfileLists = (Map&lt;ForecastProfile, Collection&lt;ForecastProfileList&gt;&gt;) </span>
<span class="nc" id="L372">				request.get(ForecastingKeys.PARAM_FORECASTPROFILE_TO_FORECASTEDLISTS_MAP);</span>
			// set profiles ID = null in order to delete the Active instance and create again. Otherwise, existing instance would be updated as active
<span class="nc" id="L374">			Collection&lt;ForecastProfile&gt; clonedProfiles = cloneProfiles(profiles);</span>
<span class="nc" id="L375">			ftsm.saveOutboundMediaForecastAsActive(clonedProfiles,</span>
<span class="nc" id="L376">					ForecastTraceCubeUtil.convertOutboundClientForecastIntoSavableFormat(forecastDataBySPQueueID),</span>
					forecastProfileLists);
<span class="nc" id="L378">			response.put(ForecastingKeys.RETVAL, FsKeys.SUCCESS);</span>
<span class="nc" id="L379">		} catch (RemoteException e) {</span>
<span class="nc" id="L380">			throw new BbmException(e);</span>
<span class="nc" id="L381">		} catch (CloneNotSupportedException e){</span>
<span class="nc" id="L382">			throw new BbmException(e);</span>
<span class="nc" id="L383">		}</span>
<span class="nc" id="L384">	}</span>
	
	private Collection&lt;ForecastProfile&gt; cloneProfiles(Collection&lt;ForecastProfile&gt; original) throws CloneNotSupportedException {
<span class="nc" id="L387">		Collection&lt;ForecastProfile&gt; clonedProfiles = new ArrayList&lt;ForecastProfile&gt;();</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">		for (ForecastProfile profile : original) {</span>
<span class="nc" id="L389">			clonedProfiles.add(profile.cloneForecastProfileValueFields());</span>
<span class="nc" id="L390">		}</span>
<span class="nc" id="L391">		return clonedProfiles;</span>
	}

	private void getDeferredMediaFullSingleQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L399">			response.put(ForecastingKeys.RETVAL_DEFERRED_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L400">					getFullVolumeAndAHTSingleQueueModelResponse( </span>
							context, request, response));
		}
<span class="nc" id="L403">		catch(Exception e){</span>
<span class="nc" id="L404">			notifyError(context, response, e);</span>
<span class="nc" id="L405">		}</span>
<span class="nc" id="L406">	}</span>

	private void getDeferredMediaPartialCombinedQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L413">			response.put(ForecastingKeys.RETVAL_DEFERRED_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L414">					getPartialCombinedQueueModelResponse(new short[]{Trace.CV, Trace.AHT, Trace.CV_VH}, context, request, response));</span>
		}
<span class="nc" id="L416">		catch(Exception e){</span>
<span class="nc" id="L417">			notifyError(context, response, e);</span>
<span class="nc" id="L418">		}</span>
<span class="nc" id="L419">	}</span>

	private void getDeferredMediaPartialMultiQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L426">			response.put(ForecastingKeys.RETVAL_DEFERRED_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L427">					getPartialMultiQueueModelResponse(new short[]{Trace.CV, Trace.AHT, Trace.CV_VH}, context, request, response));</span>
		}
<span class="nc" id="L429">		catch(Exception e){</span>
<span class="nc" id="L430">			notifyError(context, response, e);</span>
<span class="nc" id="L431">		}</span>
<span class="nc" id="L432">	}</span>
	
	private void getOutboundMediaFullSingleQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L439">			response.put(ForecastingKeys.RETVAL_OUTBOUND_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L440">					doGetOutboundMediaFullSingleQueueModel(context, request, response));</span>
		}
<span class="nc" id="L442">		catch(Exception e){</span>
<span class="nc" id="L443">			notifyError(context, response, e);</span>
<span class="nc" id="L444">		}</span>
<span class="nc" id="L445">	}</span>

	private void getImmediateMediaFullSingleQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L452">			response.put(ForecastingKeys.RETVAL_IMMEDIATE_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L453">					getFullVolumeAndAHTSingleQueueModelResponse(context,</span>
							request, response));
		}
<span class="nc" id="L456">		catch(Exception e){</span>
<span class="nc" id="L457">			notifyError(context, response, e);</span>
<span class="nc" id="L458">		}</span>
<span class="nc" id="L459">	}</span>

	private void getImmediateMediaPartialCombinedQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L466">			response.put(ForecastingKeys.RETVAL_IMMEDIATE_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L467">					getPartialCombinedQueueModelResponse(new short[]{Trace.CV, Trace.AHT, Trace.CV_VH}, context, request, response));</span>
		}
<span class="nc" id="L469">		catch(Exception e){</span>
<span class="nc" id="L470">			notifyError(context, response, e);</span>
<span class="nc" id="L471">		}</span>
<span class="nc" id="L472">	}</span>
	
	private void getOutboundMediaPartialCombinedQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L479">			response.put(ForecastingKeys.RETVAL_OUTBOUND_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L480">					getOutboundPartialCombinedQueueModelResponse(context, request, response));</span>
		}
<span class="nc" id="L482">		catch(Exception e){</span>
<span class="nc" id="L483">			notifyError(context, response, e);</span>
<span class="nc" id="L484">		}</span>
<span class="nc" id="L485">	}</span>
	
	private void getOutboundMediaPartialMultiQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L492">			response.put(ForecastingKeys.RETVAL_OUTBOUND_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L493">					getOutboundPartialMultiQueueModelResponse(context, request, response));</span>
		}
<span class="nc" id="L495">		catch(Exception e){</span>
<span class="nc" id="L496">			notifyError(context, response, e);</span>
<span class="nc" id="L497">		}</span>
<span class="nc" id="L498">	}</span>

	private void getImmediateMediaPartialMultiQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L505">			response.put(ForecastingKeys.RETVAL_IMMEDIATE_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L506">					getPartialMultiQueueModelResponse(new short[]{Trace.CV, Trace.AHT, Trace.CV_VH}, context, request, response));</span>
		}
<span class="nc" id="L508">		catch(Exception e){</span>
<span class="nc" id="L509">			notifyError(context, response, e);</span>
<span class="nc" id="L510">		}</span>
<span class="nc" id="L511">	}</span>
	
	/**
	 * This method is only intended to be used for outbound media.
	 */
	private void getHistoricalOutboundCallLists(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L521">			ID queueId = (ID)request.get(OptimizationKeys.PARAM_QUEUE_ID);</span>
<span class="nc" id="L522">			WorkloadManager workloadManager = WfmManagerFactory.getWorkloadManager(context.isInWhatIfMode());</span>
<span class="nc" id="L523">			Collection&lt;QueueList&gt; queueHistoryList = workloadManager.getQueueHistoryList(queueId);</span>
<span class="nc" id="L524">			response.put(ForecastingKeys.RETVAL_OUTBOUND_CALLS_HISTORY_LIST, queueHistoryList);</span>
		}
<span class="nc" id="L526">		catch(Exception e){</span>
<span class="nc" id="L527">			notifyError(context, response, e);</span>
<span class="nc" id="L528">		}</span>
<span class="nc" id="L529">	}</span>

	/**
	 * This method is only intended to be used for immediate and deferred media.
	 */
	private void getVolumeAndAHTHistory(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) {
		try {
<span class="nc" id="L537">			ID campaignId = (ID)request.get(OptimizationKeys.PARAM_CAMPAIGN_ID);</span>
<span class="nc" id="L538">			Collection&lt;Queue&gt; queues = (Collection&lt;Queue&gt;)request.get(OptimizationKeys.PARAM_QUEUES);</span>
<span class="nc" id="L539">			Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="nc" id="L540">			Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>

<span class="nc" id="L542">			ForecastTimeSeriesManager manager =</span>
<span class="nc" id="L543">					WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L544">			Map&lt;ID, ActualTraceCube&gt; history = manager.getVolumeAndAhtHistory(queues, campaignId, start, end);</span>
<span class="nc" id="L545">			response.put(ForecastingKeys.RETVAL_HISTORY_TRACECUBE, history);</span>
<span class="nc" id="L546">		} catch(Exception e) {</span>
<span class="nc" id="L547">			notifyError(context, response, e);</span>
<span class="nc" id="L548">		}</span>
<span class="nc" id="L549">	}</span>
	
	/**
	 * This method is only intended to be used for outbound media.
	 */
	private void getOutboundHistory(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) {
		try {
<span class="nc" id="L557">			ID campaignId = (ID)request.get(OptimizationKeys.PARAM_CAMPAIGN_ID);</span>
<span class="nc" id="L558">			Collection&lt;Queue&gt; queues = (Collection&lt;Queue&gt;)request.get(OptimizationKeys.PARAM_QUEUES);</span>
<span class="nc" id="L559">			Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="nc" id="L560">			Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>

<span class="nc" id="L562">			ForecastTimeSeriesManager manager =</span>
<span class="nc" id="L563">					WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L564">			Map&lt;ID, ActualTraceCube&gt; history =</span>
<span class="nc" id="L565">					manager.getOutboundHistory(queues, campaignId, start, end);</span>
<span class="nc" id="L566">			response.put(ForecastingKeys.RETVAL_HISTORY_TRACECUBE, history);</span>
<span class="nc" id="L567">		} catch(Exception e) {</span>
<span class="nc" id="L568">			notifyError(context, response, e);</span>
<span class="nc" id="L569">		}</span>
<span class="nc" id="L570">	}</span>

	private void getDaysWithHistory(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) {
		try {
<span class="nc" id="L575">			Collection&lt;ID&gt; queueIds = (Collection&lt;ID&gt;)request.get(OptimizationKeys.PARAM_QUEUE_IDS);</span>
<span class="nc" id="L576">			Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="nc" id="L577">			Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>

<span class="nc" id="L579">			TimeSeriesManager manager =</span>
<span class="nc" id="L580">					WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L581">			List&lt;Date&gt; history = manager.getDaysWithHistoryForQueues(queueIds, start, end);</span>
<span class="nc" id="L582">			response.put(ForecastingKeys.RETVAL_DAYS_WITH_HISTORY, history);</span>
<span class="nc" id="L583">		} catch(Exception e) {</span>
<span class="nc" id="L584">			notifyError(context, response, e);</span>
<span class="nc" id="L585">		}</span>
<span class="nc" id="L586">	}</span>

	/**
	 * This method is only intended to be used for immediate and deferred media.
	 */
	private void getVolumeAndAHTForecast(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) {
		try {
<span class="nc" id="L594">			TimeSeriesManager timeSeriesManager = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L595">			ID campaignId = (ID)request.get(OptimizationKeys.PARAM_CAMPAIGN_ID);</span>
<span class="nc" id="L596">			ID queueId = (ID)request.get(OptimizationKeys.PARAM_QUEUE_ID);</span>
<span class="nc" id="L597">			Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="nc" id="L598">			Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>
<span class="nc" id="L599">			Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L600">			queueIds.add(queueId);</span>
<span class="nc" id="L601">			ForecastTraceCube result = null;</span>
<span class="nc" id="L602">			ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L603">			ForecastTraceCube meta = getMetaForecastTraceCube(new short[]{Trace.CV, Trace.AHT, Trace.CV_VH}, instanceId);</span>
<span class="nc" id="L604">			Collection forecast = timeSeriesManager.getRawMultipleQueuesTimeSeries(meta, campaignId,</span>
					queueIds, start, end);
<span class="nc bnc" id="L606" title="All 2 branches missed.">			if (forecast.size() == 0) {</span>
<span class="nc" id="L607">				result = createZeroForecast(queueId, start, end);</span>
			} else {
<span class="nc" id="L609">				result = (ForecastTraceCube) forecast.iterator().next();</span>
<span class="nc" id="L610">				TraceUtil.setUndefinedValuesToZero(result);</span>
			}
<span class="nc" id="L612">			response.put(ForecastingKeys.RETVAL_FORECAST_TRACECUBE, result);</span>
<span class="nc" id="L613">		} catch(Exception e){</span>
<span class="nc" id="L614">			notifyError(context, response, e);</span>
<span class="nc" id="L615">		}</span>
<span class="nc" id="L616">	}</span>
	

	
	private void getOutboundMediaForecast(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) {
		try {
<span class="nc" id="L623">			ID campaignId = (ID)request.get(OptimizationKeys.PARAM_CAMPAIGN_ID);</span>
<span class="nc" id="L624">			ID queueId = (ID)request.get(OptimizationKeys.PARAM_QUEUE_ID);</span>
<span class="nc" id="L625">			Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="nc" id="L626">			Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>
<span class="nc" id="L627">			ID forecastInstanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L628">			TraceCube forecast = doGetOutboundMediaForecast(queueId, campaignId, start, end, context.isInWhatIfMode(),</span>
					forecastInstanceId);
<span class="nc bnc" id="L630" title="All 2 branches missed.">			if (forecast == null) {</span>
<span class="nc" id="L631">				forecast = createZeroForecast(queueId, start, end);</span>
			} else {
<span class="nc" id="L633">				TraceUtil.setUndefinedValuesToZero(forecast);</span>
			}
<span class="nc" id="L635">			response.put(ForecastingKeys.RETVAL_FORECAST_TRACECUBE, forecast);</span>
<span class="nc" id="L636">		} catch(Exception e){</span>
<span class="nc" id="L637">			notifyError(context, response, e);</span>
<span class="nc" id="L638">		}</span>
<span class="nc" id="L639">	}</span>

	private ForecastTraceCube getMetaForecastTraceCube(short[] traceTypes, ID instanceId) {
<span class="nc bnc" id="L642" title="All 2 branches missed.">		if (instanceId != null) {</span>
<span class="nc" id="L643">			return getForecastTraceCubeWithInstance(instanceId, traceTypes);</span>
		} else {
<span class="nc" id="L645">			return new ForecastTraceCube(traceTypes);</span>
		}
	}
	
	private void getForecastProfiles(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L652">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L653">			appletResponse.put(ForecastingKeys.RETVAL_FORECAST_PROFILES, ftsm.getManuallySavedForecastProfiles());</span>
<span class="nc" id="L654">		} catch (Exception e) {</span>
<span class="nc" id="L655">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L656">		}</span>
<span class="nc" id="L657">	}</span>

	private void getProfileTimeSeriesForProfileID(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L662">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L663">			ID id = (ID) appletRequest.get(ForecastingKeys.PARAM_FORECAST_PROFILE_ID);</span>
<span class="nc" id="L664">			appletResponse.put(ForecastingKeys.RETVAL_PROFILE_TIMESERIES_COL, ftsm.getProfileTimeSeriesByProfileID(id));</span>
<span class="nc" id="L665">		} catch (Exception e) {</span>
<span class="nc" id="L666">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L667">		}</span>
<span class="nc" id="L668">	}</span>

	private void saveForecastProfile(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L673">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L674">			ForecastProfile fp = (ForecastProfile)appletRequest.get(ForecastingKeys.PARAM_FORECAST_PROFILE);</span>
<span class="nc" id="L675">			ftsm.saveForecastProfile(</span>
					fp,
<span class="nc" id="L677">					(Collection&lt;ProfileTimeSeries&gt;)appletRequest.get(ForecastingKeys.PARAM_PROFILE_TIMESERIES_COL));</span>
<span class="nc" id="L678">			appletResponse.put(ForecastingKeys.RETVAL_FORECAST_PROFILE, fp);</span>
<span class="nc" id="L679">		} catch (Exception e) {</span>
<span class="nc" id="L680">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L681">		}</span>
<span class="nc" id="L682">	}</span>
	
	/**
	 * Takes a forecast profile for outbound media and persists it to the database, including the profile's
	 * forecast profile lists and profile time series (if the profile is manually modified, otherwise it
	 * will not persist either the lists or timeseries).
	 */
	private void saveOutboundForecastProfile(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L692">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L693">			ForecastProfile fp = (ForecastProfile)appletRequest.get(ForecastingKeys.PARAM_FORECAST_PROFILE);</span>
<span class="nc" id="L694">			Collection&lt;ProfileTimeSeries&gt; pts = (Collection&lt;ProfileTimeSeries&gt;)appletRequest.get(ForecastingKeys.PARAM_PROFILE_TIMESERIES_COL);</span>
<span class="nc" id="L695">			Collection&lt;ForecastProfileList&gt; fpl = (Collection&lt;ForecastProfileList&gt;)appletRequest.get(ForecastingKeys.PARAM_FORECAST_PROFILE_LISTS);</span>
<span class="nc" id="L696">			Date spWeekStartDate = (Date)appletRequest.get(ForecastingKeys.PARAM_START_DATE);</span>
<span class="nc" id="L697">			Type type = (Type)appletRequest.get(ForecastingKeys.PARAM_PROFILE_COMPONENT_TYPE);</span>
			
<span class="nc" id="L699">			ftsm.saveOutboundForecastProfile(fp, pts, fpl, spWeekStartDate, type);</span>
<span class="nc" id="L700">			appletResponse.put(ForecastingKeys.RETVAL_FORECAST_PROFILE, fp);</span>
<span class="nc" id="L701">		} catch (Exception e) {</span>
<span class="nc" id="L702">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L703">		}</span>
<span class="nc" id="L704">	}</span>
	
	/**
	 * Returns the ForecastProfileLists that were saved as part of a manually modified ForecastProfile for outbound media.
	 * Note that ForecastProfiles that were not manually modified will not have any ForecastProfileLists: these instead are
	 * generated from history lists (QueueList) that intersect with the historical weeks of the profile.
	 */
	private void getForecastProfileListsForManuallyModifiedAbsoluteForecastProfile(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L714">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L715">			ForecastProfile fp = (ForecastProfile)appletRequest.get(ForecastingKeys.PARAM_FORECAST_PROFILE);</span>
<span class="nc" id="L716">			Date spWeekStartDate = (Date)appletRequest.get(ForecastingKeys.PARAM_START_DATE);</span>
<span class="nc" id="L717">			Map&lt;ID, Collection&lt;ForecastProfileList&gt;&gt; lists = ftsm.getForecastProfileListsByProfile(Collections.singletonList(fp));</span>
<span class="nc bnc" id="L718" title="All 4 branches missed.">			if (lists != null &amp;&amp; lists.containsKey(fp.getID())) {</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">				for (ForecastProfileList list : lists.get(fp.getID())) {	</span>
<span class="nc" id="L720">					int daysFromReferenceDate = TimeZoneUtil.numberOfDaysRound(</span>
<span class="nc" id="L721">							ForecastProfileList.getReferenceDateForManuallyModifiedProfiles().getTime(), list.getStartTime());</span>
<span class="nc" id="L722">					int lengthOfFplInDays = TimeZoneUtil.numberOfDaysRound(list.getStartTime(), list.getEndTime());</span>
					
<span class="nc" id="L724">					Calendar fplStartDate = Calendar.getInstance();</span>
<span class="nc" id="L725">					fplStartDate.setTime(spWeekStartDate);</span>
<span class="nc" id="L726">					fplStartDate.add(Calendar.DATE, daysFromReferenceDate);</span>
<span class="nc" id="L727">					Calendar fplEndDate = (Calendar)fplStartDate.clone();</span>
<span class="nc" id="L728">					fplEndDate.add(Calendar.DATE, lengthOfFplInDays);</span>
<span class="nc" id="L729">					list.setStartTime(fplStartDate.getTime());</span>
<span class="nc" id="L730">					list.setEndTime(fplEndDate.getTime());</span>
<span class="nc" id="L731">				}</span>
				
<span class="nc" id="L733">				appletResponse.put(ForecastingKeys.RETVAL_FORECAST_PROFILE_LISTS, lists.get(fp.getID()));</span>
			}
<span class="nc" id="L735">		} catch (Exception e) {</span>
<span class="nc" id="L736">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L737">		}</span>
<span class="nc" id="L738">	}</span>

	private void deleteForecastProfile(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L743">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L744">			ftsm.deleteForecastProfile((ID) appletRequest.get(ForecastingKeys.PARAM_FORECAST_PROFILE_ID));</span>
			// The ServerRequest object will indicate failure by returning a null value for the retVal, so by setting anything
			// we indicate success
<span class="nc" id="L747">			appletResponse.put(ForecastingKeys.RETVAL, &quot;success!&quot;);</span>
<span class="nc" id="L748">		} catch (Exception e) {</span>
<span class="nc" id="L749">			notifyError(context, appletResponse, e);</span>
<span class="nc" id="L750">		}</span>
<span class="nc" id="L751">	}</span>
	
	/**
	 * Get the notes for a set of queues in a given time period	 
	 */
	private void getNotes(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
<span class="nc" id="L758">		Collection&lt;ID&gt; queueIDs = (Collection&lt;ID&gt;)appletRequest.get(ForecastingKeys.PARAM_QUEUE_IDS);</span>
<span class="nc" id="L759">		Date startDate = (Date)appletRequest.get(ForecastingKeys.PARAM_START_DATE);</span>
<span class="nc" id="L760">		Date endDate = (Date)appletRequest.get(ForecastingKeys.PARAM_END_DATE);</span>

		try {
<span class="nc" id="L763">			TrackingManager tm = WfmManagerFactory.getPulseTrackingManager();</span>
<span class="nc" id="L764">			Collection&lt;PulseNoteBO&gt; notes = tm.getPulseNotes(queueIDs, startDate, endDate);</span>
<span class="nc" id="L765">			appletResponse.put(ForecastingKeys.RETVAL_NOTES, notes);</span>
		} 
<span class="nc" id="L767">		catch (Exception ex) {</span>
<span class="nc" id="L768">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L769">		}</span>
<span class="nc" id="L770">	}</span>

	private static ForecastTraceCube createZeroForecast(ID queueId, Date start, Date end) throws BbmTimeSeriesException {
<span class="nc" id="L773">		short[] types = new short[] {Trace.CV, Trace.AHT, Trace.CV_VH};</span>
<span class="nc" id="L774">		ForecastTraceCube result = new ForecastTraceCube(queueId, start, end, types);</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">		for (short type : types) {</span>
<span class="nc" id="L776">			result.initTraceValue(type, 0);</span>
		}
<span class="nc" id="L778">		return result;</span>
	}
	
	private TraceCube doGetOutboundMediaForecast(ID queueId, ID campaignId, Date startTime, Date endTime, boolean inWhatIf,
			ID forecastInstanceId) throws BbmEJBCreateException, BbmTimeSeriesException, BbmFinderException,
			RemoteException {
<span class="nc" id="L784">		TimeSeriesManager timeSeriesManager = WfmManagerFactory.getTimeSeriesManager(inWhatIf);</span>
<span class="nc" id="L785">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L786">		queueIds.add(queueId);</span>
		ForecastTraceCube result;
<span class="nc" id="L788">		ForecastTraceCube meta = getMetaForecastTraceCube(new short[] {Trace.CRATE, Trace.AHT, Trace.RPCRATE, Trace.RPCAHT},</span>
				forecastInstanceId);
<span class="nc" id="L790">		Collection forecast = timeSeriesManager.getRawMultipleQueuesTimeSeries(meta, campaignId,</span>
				queueIds, startTime, endTime);
<span class="nc bnc" id="L792" title="All 2 branches missed.">		if (forecast.size() == 0) {</span>
<span class="nc" id="L793">			result = createZeroForecast(queueId, startTime, endTime);</span>
		} else {
<span class="nc" id="L795">			result = (ForecastTraceCube) forecast.iterator().next();</span>
<span class="nc" id="L796">			TraceUtil.setUndefinedValuesToZero(result);</span>
		}
<span class="nc" id="L798">		return new ClientForecastTraceCube(result);</span>
	}
	
	private TraceCube getOutboundMediaCombinedForecast(List&lt;Queue&gt; queues, SchedulingPeriod sp, Campaign campaign, Media media, ID instanceId, boolean inWhatIf) 
			throws BbmEJBCreateException, BbmTimeSeriesException, BbmFinderException, RemoteException {
<span class="nc" id="L803">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(inWhatIf);</span>
<span class="nc" id="L804">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>

<span class="nc" id="L806">		ForecastTraceCube meta = getMetaForecastTraceCube(</span>
				new short[] {Trace.CRATE, Trace.AHT, Trace.RPCRATE, Trace.RPCAHT}, instanceId);
<span class="nc" id="L808">		Collection forecast = tsm.getRawCombinedQueuesTimeSeries(meta, campaign.getID(), </span>
<span class="nc" id="L809">				media.getID(), sp.getStartTime(), new Date(sp.getEndTime().getTime() -1));</span>

<span class="nc bnc" id="L811" title="All 2 branches missed.">		boolean noForecast = (forecast.size() == 0);</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">		for (int i = 0; i &lt;= queues.size() - 1; i++) {</span>
<span class="nc" id="L813">			queueMediaMap.put(queues.get(i).getID(), media.getID());</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">			if (noForecast) {</span>
<span class="nc" id="L815">				forecast.add(createZeroForecast(queues.get(i).getID(), sp.getStartTime(), new Date(sp.getEndTime().getTime() - 1)));</span>
			}
		}

<span class="nc" id="L819">		ForecastTraceCube[] constituentForecasts = (ForecastTraceCube[])forecast.toArray(new ForecastTraceCube[forecast.size()]);</span>
<span class="nc" id="L820">		ClientForecastTraceCube[] constituentClientForecasts = new ClientForecastTraceCube[constituentForecasts.length];</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">		for (int i = 0; i &lt; constituentForecasts.length; i++) {</span>
<span class="nc" id="L822">			constituentClientForecasts[i] = new ClientForecastTraceCube(constituentForecasts[i]);</span>
		}
<span class="nc" id="L824">		ClientForecastTraceCube aggregatedForecast = (ClientForecastTraceCube)TraceOperator.combineQueue(constituentClientForecasts, true, queueMediaMap);</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">		if (!noForecast)</span>
<span class="nc" id="L826">			TraceUtil.setUndefinedValuesToZero(aggregatedForecast);</span>
<span class="nc" id="L827">		return aggregatedForecast;</span>
	}
	
	private ForecastResponse&lt;SingleOutboundForecastQueueDTO&gt; doGetOutboundMediaFullSingleQueueModel(
			RequestContext context, Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response)
	throws Exception {
<span class="nc" id="L833">		SingleQueuePartialResponse partialResponse = createSingleQueuePartialResponse(context, request);</span>
<span class="nc" id="L834">		Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForSingleQueueModelResponse(context, partialResponse, request);</span>
<span class="nc" id="L835">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L836">		Map&lt;ID, Collection&lt;ForecastProfileList&gt;&gt; forecastedLists = ftsm.getForecastProfileListsByProfile(profiles);</span>
<span class="nc" id="L837">		ID forecastInstanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L838">		TraceCube forecast = doGetOutboundMediaForecast(partialResponse.getQueue().getID(), </span>
<span class="nc" id="L839">				partialResponse.getCampaign().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L840">				new Date(partialResponse.getSp().getEndTime().getTime() - 1), context.isInWhatIfMode(), forecastInstanceId);</span>
<span class="nc" id="L841">		SingleOutboundForecastQueueDTO queueDto = new </span>
<span class="nc" id="L842">		SingleOutboundForecastQueueDTO(partialResponse.getQueue(), </span>
<span class="nc" id="L843">				partialResponse.getSPQueue(), new ArrayList&lt;ForecastProfile&gt;(profiles), </span>
				forecast, forecastedLists);
<span class="nc" id="L845">		ForecastResponse&lt;SingleOutboundForecastQueueDTO&gt; fullResponse = </span>
<span class="nc" id="L846">			new ForecastResponse&lt;SingleOutboundForecastQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L847">					partialResponse.getCampaign(), </span>
<span class="nc" id="L848">					partialResponse.getSp(), queueDto, partialResponse.getHoursOfOperation()</span>
			);
<span class="nc" id="L850">		return fullResponse;</span>
	}

	/**
	 * This method is only intended to be used for immediate and deferred media.
	 */
	private VolumeAndAHTForecastResponse&lt;SingleForecastQueueDTO&gt; getFullVolumeAndAHTSingleQueueModelResponse(
			RequestContext context, Map request, Map response)
	throws Exception {
<span class="nc" id="L859">		SingleQueuePartialResponse partialResponse = createSingleQueuePartialResponse(context, request);</span>
<span class="nc" id="L860">		Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForSingleQueueModelResponse(context, partialResponse,</span>
				request);
<span class="nc" id="L862">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L863">		ForecastTraceCube meta = getMetaForecastTraceCube(new short[] {Trace.CV, Trace.AHT, Trace.CV_VH} , instanceId);</span>
<span class="nc" id="L864">		TimeSeriesManager timeSeriesManager = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L865">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L866">		queueIds.add(partialResponse.getQueue().getID());</span>

		// Trace cubes use an inclusive end date, so subtract 1 millisecond from the sp end time.
<span class="nc" id="L869">		Date endDate = new Date(partialResponse.getSp().getEndTime().getTime() - 1);</span>
		
<span class="nc" id="L871">		Collection&lt;TraceCube&gt; forecast = timeSeriesManager.getRawMultipleQueuesTimeSeries(meta,</span>
<span class="nc" id="L872">				partialResponse.getCampaign().getID(),</span>
<span class="nc" id="L873">				queueIds, partialResponse.getSp().getStartTime(), endDate);</span>
<span class="nc bnc" id="L874" title="All 2 branches missed.">		ForecastTraceCube forecastCube = forecast.size() != 0 ? (ForecastTraceCube)forecast.iterator().next() : </span>
<span class="nc" id="L875">			createZeroForecast(partialResponse.getQueue().getID(), partialResponse.getSp().getStartTime(), endDate);</span>
<span class="nc" id="L876">		TraceUtil.setUndefinedValuesToZero(forecastCube);</span>
<span class="nc" id="L877">		SingleForecastQueueDTO queueDto = new </span>
<span class="nc" id="L878">		SingleForecastQueueDTO(partialResponse.getQueue(), </span>
<span class="nc" id="L879">				partialResponse.getSPQueue(), new ArrayList&lt;ForecastProfile&gt;(profiles), </span>
				forecastCube);

<span class="nc" id="L882">		VolumeAndAHTForecastResponse&lt;SingleForecastQueueDTO&gt; fullResponse = </span>
<span class="nc" id="L883">			new VolumeAndAHTForecastResponse&lt;SingleForecastQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L884">					partialResponse.getCampaign(), </span>
<span class="nc" id="L885">					partialResponse.getSp(), queueDto, partialResponse.getHoursOfOperation(),</span>
<span class="nc" id="L886">					checkIfUnknownCallVolumeIncluded()</span>
			);
<span class="nc" id="L888">		return fullResponse;</span>
	}

	protected Collection&lt;ForecastProfile&gt; getForecastProfilesForSingleQueueModelResponse(RequestContext context,
			SingleQueuePartialResponse partialResponse, Map request) throws Exception {
<span class="nc bnc" id="L893" title="All 2 branches missed.">		if (request.containsKey(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS)) {</span>
<span class="nc" id="L894">			return getForecastProfilesForSingleQueueModelResponseWithInstance(context, partialResponse, request);</span>
		} else {
<span class="nc" id="L896">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L897">			return ftsm.getActiveForecastProfilesBySPQueueIDs(</span>
<span class="nc" id="L898">					Collections.singleton(partialResponse.getSPQueue().getID()));</span>
		}
	}

	protected Collection&lt;ForecastProfile&gt; getForecastProfilesForCombinedQueueModelResponse(RequestContext context,
			CombinedQueuePartialResponse partialResponse, Map request, int queueIndex) throws Exception {
<span class="nc bnc" id="L904" title="All 2 branches missed.">		if (request.containsKey(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS)) {</span>
<span class="nc" id="L905">			return getForecastProfilesForCombinedQueueModelResponseWithInstance(context, partialResponse, request,</span>
					queueIndex);
		} else {
<span class="nc" id="L908">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L909">			return ftsm.getActiveForecastProfilesBySPQueueIDs(</span>
<span class="nc" id="L910">					Collections.singleton(partialResponse.getSPQueues().get(queueIndex).getID()));</span>
		}
	}

	protected Collection&lt;ForecastProfile&gt; getForecastProfilesForMultiQueueModelResponse(RequestContext context,
			MultiQueuePartialResponse partialResponse, Map request, int queueIndex) throws Exception {
<span class="nc bnc" id="L916" title="All 2 branches missed.">		if (request.containsKey(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS)) {</span>
<span class="nc" id="L917">			return getForecastProfilesForMultiQueueModelResponseWithInstance(context, partialResponse, request, queueIndex);</span>
		} else {
<span class="nc" id="L919">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L920">			return ftsm.getActiveForecastProfilesBySPQueueIDs(</span>
<span class="nc" id="L921">					Collections.singleton(partialResponse.getSPQueues().get(queueIndex).getID()));</span>
		}
	}

	/**
	 * This method is only intended to be used for immediate and deferred media.
	 * &lt;p&gt;
	 * &lt;em&gt;Note:&lt;/em&gt; Since this method cannot easily be refactored into a utility
	 * class this request handler is being instantiated directly and this method
	 * called directly by the {@code CalendarAllocationAppletRH} class.
	 */
	public VolumeAndAHTForecastResponse&lt;CombinedForecastQueueDTO&lt;?&gt;&gt;
		getPartialCombinedQueueModelResponse(short[] traceTypes, RequestContext context,
				Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
				throws Exception {
<span class="nc" id="L936">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L937">		CombinedQueuePartialResponse partialResponse = createCombinedQueuePartialResponse(context, request);</span>
<span class="nc" id="L938">		List&lt;SingleForecastQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleForecastQueueDTO&gt;();</span>
<span class="nc" id="L939">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L940">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L941">		ForecastTraceCube meta = getMetaForecastTraceCube(traceTypes, instanceId); //new ForecastTraceCube(new short[] {Trace.CV, Trace.AHT, Trace.CV_VH});</span>
<span class="nc" id="L942">		Collection forecast = tsm.getRawCombinedQueuesTimeSeries(meta, partialResponse.getCampaign().getID(), </span>
<span class="nc" id="L943">				partialResponse.getMedia().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L944">				new Date(partialResponse.getSp().getEndTime().getTime() -1));</span>

<span class="nc bnc" id="L946" title="All 2 branches missed.">		boolean noForecast = (forecast.size() == 0);</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">		for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {</span>
<span class="nc" id="L948">			Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForCombinedQueueModelResponse(context,</span>
					partialResponse, request, i);

<span class="nc" id="L951">			SingleForecastQueueDTO singleQueueDto = new SingleForecastQueueDTO(</span>
<span class="nc" id="L952">					partialResponse.getQueues().get(i), partialResponse.getSPQueues().get(i),</span>
					new ArrayList&lt;ForecastProfile&gt;(profiles));
<span class="nc" id="L954">			singleQueueDtos.add(singleQueueDto);</span>
<span class="nc" id="L955">			queueMediaMap.put(singleQueueDto.getQueue().getID(), partialResponse.getMedia().getID());</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">			if (noForecast) {</span>
<span class="nc" id="L957">				forecast.add(createZeroForecast(singleQueueDto.getQueue().getID(),</span>
<span class="nc" id="L958">						partialResponse.getSp().getStartTime(), new Date(partialResponse.getSp().getEndTime().getTime() - 1)));</span>
			}
		}

<span class="nc" id="L962">		TraceCube[] constituentForecasts = (TraceCube[])forecast.toArray(new TraceCube[forecast.size()]); </span>
<span class="nc" id="L963">		TraceCube aggregatedForecast = TraceOperator.combineQueue(constituentForecasts, true, queueMediaMap);</span>
<span class="nc bnc" id="L964" title="All 2 branches missed.">		if (!noForecast)</span>
<span class="nc" id="L965">			adjustVolumeAhtForecastTraceValues(aggregatedForecast);</span>
<span class="nc" id="L966">		MultiForecastQueueDTO multiQueueDto = new MultiForecastQueueDTO(singleQueueDtos, aggregatedForecast);</span>
<span class="nc" id="L967">		CombinedForecastQueueDTO queueDto = new CombinedForecastQueueDTO(partialResponse.getSPQueue(), multiQueueDto);</span>
<span class="nc" id="L968">		VolumeAndAHTForecastResponse&lt;CombinedForecastQueueDTO&lt;?&gt;&gt; fullResponse = </span>
			new VolumeAndAHTForecastResponse&lt;CombinedForecastQueueDTO&lt;?&gt;&gt;(
<span class="nc" id="L970">					partialResponse.getMedia(), </span>
<span class="nc" id="L971">					partialResponse.getCampaign(), </span>
<span class="nc" id="L972">					partialResponse.getSp(), queueDto, partialResponse.getHoursOfOperation(),</span>
<span class="nc" id="L973">					checkIfUnknownCallVolumeIncluded());</span>
<span class="nc" id="L974">		return fullResponse;</span>
	}

	private ForecastResponse&lt;CombinedForecastQueueDTO&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt;&gt;
	getOutboundPartialCombinedQueueModelResponse(RequestContext context, Map&lt;? extends Object, ? extends Object&gt; request,
			Map&lt;Object, Object&gt; response) throws Exception {
<span class="nc" id="L980">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L981">		CombinedQueuePartialResponse partialResponse = createCombinedQueuePartialResponse(context, request);</span>
<span class="nc" id="L982">		List&lt;SingleOutboundForecastQueueDTO&gt; singleQueueDtos = new ArrayList&lt;&gt;();</span>
		
<span class="nc" id="L984">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L985">		TraceCube forecast = getOutboundMediaCombinedForecast(partialResponse.getQueues(), partialResponse.getSp(),</span>
<span class="nc" id="L986">				partialResponse.getCampaign(), partialResponse.getMedia(), instanceId, context.isInWhatIfMode());</span>
		
<span class="nc bnc" id="L988" title="All 2 branches missed.">		for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {</span>
<span class="nc" id="L989">			Collection&lt;ForecastProfile&gt; profiles =</span>
<span class="nc" id="L990">					getForecastProfilesForCombinedQueueModelResponse(context, partialResponse, request, i);</span>

<span class="nc" id="L992">			Map&lt;ID, Collection&lt;ForecastProfileList&gt;&gt; forecastedLists = ftsm.getForecastProfileListsByProfile(profiles);</span>

<span class="nc" id="L994">			SingleOutboundForecastQueueDTO singleQueueDto = new SingleOutboundForecastQueueDTO(</span>
<span class="nc" id="L995">					partialResponse.getQueues().get(i),</span>
<span class="nc" id="L996">					partialResponse.getSPQueues().get(i), new ArrayList&lt;&gt;(profiles),</span>
					forecastedLists);
			
<span class="nc" id="L999">			singleQueueDtos.add(singleQueueDto);</span>
		}
<span class="nc" id="L1001">		MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt; multiQueueDto = new MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;(singleQueueDtos, forecast);</span>
<span class="nc" id="L1002">		CombinedForecastQueueDTO&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt; queueDto = </span>
<span class="nc" id="L1003">			new CombinedForecastQueueDTO&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt;(partialResponse.getSPQueue(), multiQueueDto);</span>
<span class="nc" id="L1004">		ForecastResponse&lt;CombinedForecastQueueDTO&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt;&gt; fullResponse = </span>
<span class="nc" id="L1005">			new ForecastResponse&lt;CombinedForecastQueueDTO&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt;&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L1006">					partialResponse.getCampaign(), </span>
<span class="nc" id="L1007">					partialResponse.getSp(), </span>
					queueDto, 
<span class="nc" id="L1009">					partialResponse.getHoursOfOperation());</span>
<span class="nc" id="L1010">		return fullResponse;</span>
	}

	/**
	 * This method is only intended to be used for immediate and deferred media.
	 */
	private VolumeAndAHTForecastResponse&lt;MultiForecastQueueDTO&gt; getPartialMultiQueueModelResponse(short[] traceTypes,
			RequestContext context, Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response)
			throws Exception {
<span class="nc" id="L1019">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1020">		MultiQueuePartialResponse partialResponse = createMultiQueuePartialResponse(context, request);</span>
<span class="nc" id="L1021">		List&lt;SingleForecastQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleForecastQueueDTO&gt;();</span>
<span class="nc" id="L1022">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L1023">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L1024">		ForecastTraceCube meta = getMetaForecastTraceCube(traceTypes, instanceId);</span>

<span class="nc" id="L1026">		Collection&lt;TraceCube&gt; forecastData = getForecastTraceDataForMultiQueuePartialResponse(partialResponse, meta, tsm);</span>

<span class="nc bnc" id="L1028" title="All 2 branches missed.">		boolean noForecast = (forecastData.size() == 0);</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">		for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {</span>
<span class="nc" id="L1030">			Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForMultiQueueModelResponse(context,</span>
					partialResponse, request, i);
<span class="nc" id="L1032">			SingleForecastQueueDTO singleQueueDto = new SingleForecastQueueDTO(</span>
<span class="nc" id="L1033">					partialResponse.getQueues().get(i), partialResponse.getSPQueues().get(i),</span>
					new ArrayList&lt;ForecastProfile&gt;(profiles));
<span class="nc" id="L1035">			singleQueueDtos.add(singleQueueDto);</span>
<span class="nc" id="L1036">			queueMediaMap.put(singleQueueDto.getQueue().getID(), partialResponse.getMedia().getID());</span>
<span class="nc bnc" id="L1037" title="All 2 branches missed.">			if (noForecast) {</span>
<span class="nc" id="L1038">				forecastData.add(createZeroForecast(singleQueueDto.getQueue().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1039">						new Date(partialResponse.getSp().getEndTime().getTime() - 1)));</span>
			}
		}
<span class="nc" id="L1042">		TraceCube[] constituentForecasts = (TraceCube[])forecastData.toArray(new TraceCube[forecastData.size()]);</span>
<span class="nc" id="L1043">		TraceCube aggregatedForecast = TraceOperator.combineQueue(constituentForecasts, true, queueMediaMap);</span>
<span class="nc bnc" id="L1044" title="All 2 branches missed.">		if (!noForecast) {</span>
<span class="nc" id="L1045">			adjustVolumeAhtForecastTraceValues(aggregatedForecast);</span>
		}
<span class="nc" id="L1047">		MultiForecastQueueDTO multiQueueDto = new MultiForecastQueueDTO(singleQueueDtos, aggregatedForecast);</span>
<span class="nc" id="L1048">		VolumeAndAHTForecastResponse&lt;MultiForecastQueueDTO&gt; fullResponse = </span>
<span class="nc" id="L1049">			new VolumeAndAHTForecastResponse&lt;MultiForecastQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L1050">					partialResponse.getCampaign(), </span>
<span class="nc" id="L1051">					partialResponse.getSp(), multiQueueDto, partialResponse.getHoursOfOperation(),</span>
<span class="nc" id="L1052">					checkIfUnknownCallVolumeIncluded());</span>
<span class="nc" id="L1053">		return fullResponse;</span>
	}
	

	private ForecastResponse&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt; getOutboundPartialMultiQueueModelResponse(RequestContext context, 
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws Exception {
<span class="nc" id="L1059">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1060">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1061">		MultiQueuePartialResponse partialResponse = createMultiQueuePartialResponse(context, request);</span>
<span class="nc" id="L1062">		List&lt;SingleForecastQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleForecastQueueDTO&gt;();</span>
<span class="nc" id="L1063">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L1064">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L1065">		ForecastTraceCube meta = getMetaForecastTraceCube(new short[] {Trace.CRATE, Trace.AHT, Trace.RPCRATE, Trace.RPCAHT}, instanceId);</span>

<span class="nc" id="L1067">		Collection&lt;TraceCube&gt; forecastData = getForecastTraceDataForMultiQueuePartialResponse(partialResponse, meta, tsm);</span>

<span class="nc bnc" id="L1069" title="All 2 branches missed.">		boolean noForecast = (forecastData.size() == 0);</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">		for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {</span>
<span class="nc" id="L1071">			Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForMultiQueueModelResponse(context,</span>
					partialResponse, request, i);
			
<span class="nc" id="L1074">			Map&lt;ID, Collection&lt;ForecastProfileList&gt;&gt; forecastedLists = ftsm.getForecastProfileListsByProfile(profiles);</span>

<span class="nc" id="L1076">			SingleOutboundForecastQueueDTO singleQueueDto = new SingleOutboundForecastQueueDTO(partialResponse.getQueues().get(i), </span>
<span class="nc" id="L1077">					partialResponse.getSPQueues().get(i), new ArrayList&lt;ForecastProfile&gt;(profiles), </span>
					forecastedLists);
			
<span class="nc" id="L1080">			singleQueueDtos.add(singleQueueDto);</span>
<span class="nc" id="L1081">			queueMediaMap.put(singleQueueDto.getQueue().getID(), partialResponse.getMedia().getID());</span>
<span class="nc bnc" id="L1082" title="All 2 branches missed.">			if (noForecast) {</span>
<span class="nc" id="L1083">				forecastData.add(createZeroForecast(singleQueueDto.getQueue().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1084">						new Date(partialResponse.getSp().getEndTime().getTime() - 1)));</span>
			}
		}
		
<span class="nc" id="L1088">		ForecastTraceCube[] constituentForecasts = (ForecastTraceCube[])forecastData.toArray(new ForecastTraceCube[forecastData.size()]);</span>
<span class="nc" id="L1089">		ClientForecastTraceCube[] constituentClientForecasts = new ClientForecastTraceCube[constituentForecasts.length];</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">		for (int i = 0; i &lt; constituentForecasts.length; i++) {</span>
<span class="nc" id="L1091">			constituentClientForecasts[i] = new ClientForecastTraceCube(constituentForecasts[i]);</span>
		}
<span class="nc" id="L1093">		ClientForecastTraceCube aggregatedForecast = (ClientForecastTraceCube)TraceOperator.combineQueue(constituentClientForecasts, true, queueMediaMap);</span>
<span class="nc bnc" id="L1094" title="All 2 branches missed.">		if (!noForecast) {</span>
<span class="nc" id="L1095">			TraceUtil.setUndefinedValuesToZero(aggregatedForecast);</span>
		}

<span class="nc" id="L1098">		MultiForecastQueueDTO multiQueueDto = new MultiForecastQueueDTO(singleQueueDtos, aggregatedForecast);</span>
<span class="nc" id="L1099">		ForecastResponse&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt; fullResponse = </span>
<span class="nc" id="L1100">			new ForecastResponse&lt;MultiForecastQueueDTO&lt;SingleOutboundForecastQueueDTO&gt;&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L1101">					partialResponse.getCampaign(), </span>
<span class="nc" id="L1102">					partialResponse.getSp(), multiQueueDto, partialResponse.getHoursOfOperation());</span>
<span class="nc" id="L1103">		return fullResponse;</span>
	}

	private void getSchedulingPeriodsForCampaign(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) {
		try {
<span class="nc" id="L1109">			CampaignManager cm = WfmManagerFactory.getCampaignManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1110">			Campaign campaign = (Campaign)appletRequest.get(ForecastingKeys.PARAM_CAMPAIGN);</span>
<span class="nc" id="L1111">			appletResponse.put(ForecastingKeys.RETVAL, cm.getSchedulingPeriods(campaign));</span>
<span class="nc" id="L1112">		} catch (Exception ex) {</span>
<span class="nc" id="L1113">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1114">		}</span>
<span class="nc" id="L1115">	}</span>

	/**
	 * Returns a map of SPQueues with integer values specifying the starting backlog for those SPQueues.
	 * The starting backlog is determined by the target Scheduling Period that is handed in to this method.
	 * The starting backlog will either be pulled from the PREDICTEDTIMESERIES table (for forecasted backlog) or
	 * the QUEUEHISTORYTIMESERIES table (for Actual backlog).  The starting backlog will be pulled from the
	 * latest backlog value from the target SP matching the work queue from the input spQueue.  However, we will
	 * only look back 24 hours from the end date of the target SP (and queue) to find an ending backlog value.
	 * If no backlog is present during the last 24 hours of the SP then the starting backlog will be set as 
	 * 0 for that spQueue.  If the targetSP does not have a matching work queue, the starting backlog for the
	 * spQueue will be set to 0.
	 * @return Map&lt;SPQueue, Integer&gt; - The SPQueue key is from the collection of spQueues handed into the method.
	 * The Integer value represents the starting backlog for that spQueue, determined by looking at the forecasted
	 * or actual ending backlog values of the targetSP for the matching work queues.
	 */
	private void fetchStartingBacklogForSPQueues(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) throws BbmException {
		try {
<span class="nc" id="L1134">			TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>

<span class="nc" id="L1136">			Collection&lt;SPQueue&gt; spQueues = (Collection&lt;SPQueue&gt;)appletRequest.get(ForecastingKeys.PARAM_SPQUEUES);</span>
<span class="nc" id="L1137">			SchedulingPeriod targetSP = (SchedulingPeriod)appletRequest.get(ForecastingKeys.PARAM_SP);</span>
<span class="nc" id="L1138">			BacklogType backlogType = (BacklogType)appletRequest.get(ForecastingKeys.PARAM_BACKLOG_TYPE);</span>

<span class="nc" id="L1140">			appletResponse.put(ForecastingKeys.RETVAL,</span>
<span class="nc" id="L1141">					tsm.fetchStartingBacklogForSPQueues(spQueues, targetSP, backlogType));</span>
<span class="nc" id="L1142">		} catch (RemoteException ex) {</span>
<span class="nc" id="L1143">			throw new BbmException(ex);</span>
<span class="nc" id="L1144">		}</span>
<span class="nc" id="L1145">	}</span>

	private void fetchActualStartingBacklogForSPQueuesAtDate(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object, Object&gt; appletResponse) throws BbmException {
		try {
<span class="nc" id="L1150">			TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>

<span class="nc" id="L1152">			Collection&lt;SPQueue&gt; spQueues = (Collection&lt;SPQueue&gt;)appletRequest.get(ForecastingKeys.PARAM_SPQUEUES);</span>
<span class="nc" id="L1153">			ID campaignId = (ID)appletRequest.get(ForecastingKeys.PARAM_CAMPAIGN_ID);</span>
<span class="nc" id="L1154">			Date date = (Date)appletRequest.get(ForecastingKeys.PARAM_START_DATE);</span>

<span class="nc" id="L1156">			appletResponse.put(ForecastingKeys.RETVAL,</span>
<span class="nc" id="L1157">					tsm.fetchActualStartingBacklogForSPQueuesAtDate(spQueues, campaignId, date));</span>
<span class="nc" id="L1158">		} catch (RemoteException ex) {</span>
<span class="nc" id="L1159">			throw new BbmException(ex);</span>
<span class="nc" id="L1160">		}</span>
<span class="nc" id="L1161">	}</span>

	// with forecast instance
	private Collection&lt;ForecastProfile&gt; getForecastProfilesForSingleQueueModelResponseWithInstance(RequestContext context,
			SingleQueuePartialResponse partialResponse, Map request) throws Exception {
<span class="nc" id="L1166">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1167">		ID forecastinstanceID = null;</span>
<span class="nc" id="L1168">		forecastinstanceID = (ID) request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>

<span class="nc bnc" id="L1170" title="All 2 branches missed.">		if (forecastinstanceID != null) {</span>
<span class="nc" id="L1171">			return ftsm.getForecastProfilesByForecastInstanceIDAndSPQueueIDs</span>
<span class="nc" id="L1172">			(forecastinstanceID, Collections.singleton(partialResponse.getSPQueue().getID()));</span>
		} else {
<span class="nc" id="L1174">			return getForecastProfilesForSingleQueueModelResponse(context, partialResponse, request);</span>
		}
	}

	private Collection&lt;ForecastProfile&gt; getForecastProfilesForCombinedQueueModelResponseWithInstance(RequestContext context,
			CombinedQueuePartialResponse partialResponse, Map request, int i) throws Exception {
<span class="nc" id="L1180">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1181">		ID forecastinstanceID = null;</span>
<span class="nc" id="L1182">		forecastinstanceID = (ID) request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">		if (forecastinstanceID != null) {</span>
<span class="nc" id="L1184">			return ftsm.getForecastProfilesByForecastInstanceIDAndSPQueueIDs(forecastinstanceID,</span>
<span class="nc" id="L1185">					Collections.singleton(partialResponse.getSPQueues().get(i).getID()));</span>
		} else {
<span class="nc" id="L1187">			return getForecastProfilesForCombinedQueueModelResponseWithInstance(context, partialResponse, request, i);</span>
		}
	}

	private Collection&lt;ForecastProfile&gt; getForecastProfilesForMultiQueueModelResponseWithInstance(RequestContext context,
			MultiQueuePartialResponse partialResponse, Map request, int i) throws Exception {
<span class="nc" id="L1193">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1194">		ID forecastinstanceID = null;</span>
<span class="nc" id="L1195">		forecastinstanceID = (ID) request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">		if(forecastinstanceID != null) {</span>
<span class="nc" id="L1197">			return ftsm.getForecastProfilesByForecastInstanceIDAndSPQueueIDs(forecastinstanceID,</span>
<span class="nc" id="L1198">					Collections.singleton(partialResponse.getSPQueues().get(i).getID()));</span>
		}
		else {
<span class="nc" id="L1201">			return getForecastProfilesForMultiQueueModelResponseWithInstance(context, partialResponse, request, i);</span>
		}
	}


	private ForecastTraceCube getForecastTraceCubeWithInstance(ID instanceId, short[] traceTypes) {
<span class="nc" id="L1207">		ForecastTraceCube meta =  new ForecastTraceCube(traceTypes);</span>
<span class="nc" id="L1208">		String instanceIDString = instanceId.toString();</span>
<span class="nc" id="L1209">		meta.setForecastInstanceID(instanceIDString);</span>
<span class="nc" id="L1210">		return meta;</span>

	}
	
	protected void deleteForecastInstance(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L1217">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1218">			ID  instanceID = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L1219">			Collection&lt;ID&gt; spQueueIDs = (Collection&lt;ID&gt;) request.get(ForecastingKeys.PARAM_SPQUEUE_IDS);</span>
<span class="nc" id="L1220">			ftsm.deleteForecastInstance(instanceID, spQueueIDs);</span>

<span class="nc" id="L1222">			response.put(ForecastingKeys.RETVAL, &quot;Success!&quot;);</span>
<span class="nc" id="L1223">		} catch (Exception e) {</span>
<span class="nc" id="L1224">			throw new BbmException(e);</span>
<span class="nc" id="L1225">		}</span>
<span class="nc" id="L1226">	}</span>

	private ProjectForecastingResponse&lt;SingleProjectForecastQueueDTO&gt; getFullSingleProjectQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response)
	throws Exception {
		
<span class="nc" id="L1232">		Collection &lt;ForecastProfileProject&gt; lstProjectProfiles = null;</span>
		
<span class="nc" id="L1234">		SingleQueuePartialResponse partialResponse = createSingleQueuePartialResponse(context, request);</span>
<span class="nc" id="L1235">		Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForSingleQueueModelResponse(context, partialResponse, request);</span>
<span class="nc" id="L1236">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L1237">		ForecastTraceCube meta = getMetaForecastTraceCube(new short[] {Trace.CV, Trace.AHT, Trace.CV_VH}, instanceId); //new ForecastTraceCube(new short[] {Trace.CV, Trace.AHT, Trace.CV_VH});</span>
<span class="nc" id="L1238">		TimeSeriesManager timeSeriesManager = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
		
<span class="nc" id="L1240">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L1241">		queueIds.add(partialResponse.getQueue().getID());</span>
<span class="nc" id="L1242">		Collection&lt;ID&gt; spQueueIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L1243">		spQueueIds.add(partialResponse.getSPQueue().getID());</span>
<span class="nc" id="L1244">		Collection forecast = timeSeriesManager.getRawMultipleQueuesTimeSeries(meta, partialResponse.getCampaign().getID(),</span>
<span class="nc" id="L1245">				queueIds, partialResponse.getSp().getStartTime(), new Date(partialResponse.getSp().getEndTime().getTime() - 1));</span>
<span class="nc bnc" id="L1246" title="All 2 branches missed.">		ForecastTraceCube forecastCube = forecast.size() != 0 ? (ForecastTraceCube)forecast.iterator().next() : </span>
<span class="nc" id="L1247">			createZeroForecast(partialResponse.getQueue().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1248">					new Date(partialResponse.getSp().getEndTime().getTime() - 1));</span>
<span class="nc" id="L1249">		TraceUtil.setUndefinedValuesToZero(forecastCube);</span>
		
<span class="nc" id="L1251">		lstProjectProfiles = this.getProjectProfiles(context,spQueueIds);</span>

<span class="nc" id="L1253">		SingleProjectForecastQueueDTO queueDto = new SingleProjectForecastQueueDTO(partialResponse.getQueue(), </span>
<span class="nc" id="L1254">				partialResponse.getSPQueue(), new ArrayList&lt;ForecastProfile&gt;(profiles), new ArrayList&lt;ForecastProfileProject&gt;(lstProjectProfiles), forecastCube);</span>

		
<span class="nc" id="L1257">		ProjectForecastingResponse&lt;SingleProjectForecastQueueDTO&gt; fullResponse = </span>
<span class="nc" id="L1258">			new ProjectForecastingResponse&lt;SingleProjectForecastQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L1259">					partialResponse.getCampaign(), </span>
<span class="nc" id="L1260">					partialResponse.getSp(), queueDto, partialResponse.getHoursOfOperation(),</span>
<span class="nc" id="L1261">					checkIfUnknownCallVolumeIncluded()</span>
			);
<span class="nc" id="L1263">		return fullResponse;</span>
	}
	
	private Collection &lt;ForecastProfileProject&gt; getProjectProfiles(RequestContext context,Collection&lt;ID&gt; spQueueIDs) throws Exception{
		
<span class="nc" id="L1268">		Collection&lt;ForecastProfileProject&gt; lstProjectProfiles = null;</span>
<span class="nc" id="L1269">		ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
		
<span class="nc" id="L1271">		lstProjectProfiles = ftsm.getActiveProjects(spQueueIDs);</span>
		
<span class="nc" id="L1273">		return lstProjectProfiles;</span>
	}
	private void getProjectMediaFullSingleQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L1280">			response.put(ForecastingKeys.RETVAL_PROJECT_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L1281">					getFullSingleProjectQueueModel(context, request, response));</span>
		}
<span class="nc" id="L1283">		catch(Exception e){</span>
<span class="nc" id="L1284">			notifyError(context, response, e);</span>
<span class="nc" id="L1285">		}</span>
<span class="nc" id="L1286">	}</span>
	/**
	 * Insert the strategic forecast for the specified queue ID and time interval into
	 * the response map.
	 * 
	 * @param context
	 * @param request
	 * @param response
	 */
	private void getStrategicForecast(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) {
		try {
<span class="nc" id="L1298">			ID queueId = (ID)request.get(OptimizationKeys.PARAM_QUEUE_ID);</span>
<span class="nc" id="L1299">			Date start = (Date)request.get(OptimizationKeys.PARAM_START_DATE);</span>
<span class="nc" id="L1300">			Date end = (Date)request.get(OptimizationKeys.PARAM_END_DATE);</span>

<span class="nc" id="L1302">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1303">			response.put(ForecastingKeys.RETVAL_STRATEGIC_FORECAST, ftsm.getStrategicForecast(queueId, start, end));</span>
<span class="nc" id="L1304">		} catch (Exception e) {</span>
<span class="nc" id="L1305">			notifyError(context, response, e);</span>
<span class="nc" id="L1306">		}</span>
<span class="nc" id="L1307">	}</span>
	private ProjectForecastingResponse&lt;MultiProjectForecastQueueDTO&gt; getPartialMultiProjectQueueModelResponse(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response)
	throws Exception {
		
<span class="nc" id="L1312">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L1313">		MultiQueuePartialResponse partialResponse = createMultiQueuePartialResponse(context, request);</span>
<span class="nc" id="L1314">		List&lt;SingleProjectForecastQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleProjectForecastQueueDTO&gt;();</span>
<span class="nc" id="L1315">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1316">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
<span class="nc" id="L1317">		ForecastTraceCube meta = getMetaForecastTraceCube(new short[] {Trace.CV, Trace.AHT, Trace.CV_VH}, instanceId);</span>

<span class="nc" id="L1319">		Collection forecast = tsm.getRawCombinedQueuesTimeSeries(meta, partialResponse.getCampaign().getID(),</span>
<span class="nc" id="L1320">				partialResponse.getMedia().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1321">				partialResponse.getSp().getEndTime());</span>
		
<span class="nc" id="L1323">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L1324" title="All 2 branches missed.">		boolean noForecast = (forecast.size() == 0);</span>
		
<span class="nc bnc" id="L1326" title="All 2 branches missed.">		for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {</span>
<span class="nc" id="L1327">			queueIds.add(partialResponse.getSPQueues().get(i).getID());</span>
<span class="nc" id="L1328">			Collection&lt;ForecastProfileProject&gt; lstProjectprofiles = this.getProjectProfiles(context,queueIds);</span>
<span class="nc" id="L1329">			Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForMultiQueueModelResponse(context,</span>
					partialResponse, request, i);
<span class="nc" id="L1331">			SingleProjectForecastQueueDTO singleQueueDto = new SingleProjectForecastQueueDTO(</span>
<span class="nc" id="L1332">					partialResponse.getQueues().get(i), partialResponse.getSPQueues().get(i),</span>
					new ArrayList&lt;ForecastProfile&gt;(profiles),new ArrayList&lt;ForecastProfileProject&gt;(lstProjectprofiles),null);
<span class="nc" id="L1334">			singleQueueDtos.add(singleQueueDto);</span>
<span class="nc" id="L1335">			queueMediaMap.put(singleQueueDto.getQueue().getID(), partialResponse.getMedia().getID());</span>
<span class="nc bnc" id="L1336" title="All 2 branches missed.">			if (noForecast) {</span>
<span class="nc" id="L1337">				forecast.add(createZeroForecast(singleQueueDto.getQueue().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1338">						new Date(partialResponse.getSp().getEndTime().getTime() - 1)));</span>
			}
<span class="nc" id="L1340">			queueIds.remove(partialResponse.getSPQueues().get(i).getID());</span>
		}

<span class="nc" id="L1343">		MultiProjectForecastQueueDTO multiQueueDto = new MultiProjectForecastQueueDTO(singleQueueDtos);</span>
<span class="nc" id="L1344">		ProjectForecastingResponse&lt;MultiProjectForecastQueueDTO&gt; fullResponse = </span>
<span class="nc" id="L1345">			new ProjectForecastingResponse&lt;MultiProjectForecastQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L1346">					partialResponse.getCampaign(), </span>
<span class="nc" id="L1347">					partialResponse.getSp(), multiQueueDto, partialResponse.getHoursOfOperation(),</span>
<span class="nc" id="L1348">					checkIfUnknownCallVolumeIncluded());</span>
<span class="nc" id="L1349">		return fullResponse;</span>
	}
	private void getProjectMediaPartialMultiQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L1356">			response.put(ForecastingKeys.RETVAL_PROJECT_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L1357">					getPartialMultiProjectQueueModelResponse(context, request, response));</span>
		}
<span class="nc" id="L1359">		catch(Exception e){</span>
<span class="nc" id="L1360">			notifyError(context, response, e);</span>
<span class="nc" id="L1361">		}</span>
<span class="nc" id="L1362">	}</span>
	private ProjectForecastingResponse&lt;CombinedProjectForecastQueueDTO&gt; getPartialCombinedProjectQueueModelResponse(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	throws Exception { 
		
<span class="nc" id="L1367">		ID instanceId = (ID)request.get(ForecastingKeys.PARAM_FORECAST_INSTANCE_IDS);</span>
<span class="nc" id="L1368">		TimeSeriesManager tsm = WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1369">		CombinedQueuePartialResponse partialResponse = createCombinedQueuePartialResponse(context, request);</span>
<span class="nc" id="L1370">		List&lt;SingleProjectForecastQueueDTO&gt; singleQueueDtos = new ArrayList&lt;SingleProjectForecastQueueDTO&gt;();</span>
<span class="nc" id="L1371">		HashMap&lt;ID, ID&gt; queueMediaMap = new HashMap&lt;ID, ID&gt;();</span>
		
<span class="nc" id="L1373">		ForecastTraceCube meta = getMetaForecastTraceCube(new short[] {Trace.CV, Trace.AHT, Trace.CV_VH}, instanceId);		</span>
<span class="nc" id="L1374">		Collection forecast = tsm.getRawCombinedQueuesTimeSeries(meta, partialResponse.getCampaign().getID(),</span>
<span class="nc" id="L1375">			partialResponse.getMedia().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1376">			new Date(partialResponse.getSp().getEndTime().getTime() - 1));</span>

<span class="nc bnc" id="L1378" title="All 2 branches missed.">		boolean noForecast = (forecast.size() == 0);</span>
<span class="nc" id="L1379">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
		
<span class="nc bnc" id="L1381" title="All 2 branches missed.">		for (int i = 0; i &lt;= partialResponse.getQueues().size() - 1; i++) {   </span>
<span class="nc" id="L1382">			queueIds.add(partialResponse.getSPQueues().get(i).getID());</span>
<span class="nc" id="L1383">			Collection&lt;ForecastProfile&gt; profiles = getForecastProfilesForCombinedQueueModelResponse(context,</span>
					partialResponse, request, i);
<span class="nc" id="L1385">			Collection&lt;ForecastProfileProject&gt; lstProjectprofiles = this.getProjectProfiles(context,queueIds);</span>
<span class="nc" id="L1386">			SingleProjectForecastQueueDTO singleQueueDto = new SingleProjectForecastQueueDTO(</span>
<span class="nc" id="L1387">					partialResponse.getQueues().get(i), partialResponse.getSPQueues().get(i),</span>
					new ArrayList&lt;ForecastProfile&gt;(profiles),new ArrayList&lt;ForecastProfileProject&gt;(lstProjectprofiles),null);
<span class="nc" id="L1389">			singleQueueDtos.add(singleQueueDto);</span>
<span class="nc" id="L1390">			queueMediaMap.put(singleQueueDto.getQueue().getID(), partialResponse.getMedia().getID());</span>
<span class="nc bnc" id="L1391" title="All 2 branches missed.">			if (noForecast) {</span>
<span class="nc" id="L1392">				forecast.add(createZeroForecast(singleQueueDto.getQueue().getID(), partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1393">						new Date(partialResponse.getSp().getEndTime().getTime() - 1)));</span>
			}
<span class="nc" id="L1395">			queueIds.remove(partialResponse.getSPQueues().get(i).getID());</span>
		}

<span class="nc" id="L1398">		TraceCube[] constituentForecasts = (TraceCube[])forecast.toArray(new TraceCube[forecast.size()]); </span>
<span class="nc" id="L1399">		TraceCube aggretagedForecast = TraceOperator.combineQueue(constituentForecasts, true, queueMediaMap);</span>
<span class="nc bnc" id="L1400" title="All 2 branches missed.">		if (!noForecast){}</span>
<span class="nc" id="L1401">			TraceUtil.setUndefinedValuesToZero(aggretagedForecast);</span>
			
<span class="nc" id="L1403">		MultiProjectForecastQueueDTO multiQueueDto = new MultiProjectForecastQueueDTO(singleQueueDtos);</span>
<span class="nc" id="L1404">		CombinedProjectForecastQueueDTO queueDto = new CombinedProjectForecastQueueDTO(partialResponse.getSPQueue(), multiQueueDto);</span>
		
<span class="nc" id="L1406">		ProjectForecastingResponse&lt;CombinedProjectForecastQueueDTO&gt; fullResponse = new ProjectForecastingResponse&lt;CombinedProjectForecastQueueDTO&gt;(partialResponse.getMedia(), </span>
<span class="nc" id="L1407">					partialResponse.getCampaign(), </span>
<span class="nc" id="L1408">					partialResponse.getSp(), queueDto, partialResponse.getHoursOfOperation(),</span>
<span class="nc" id="L1409">					checkIfUnknownCallVolumeIncluded());</span>
<span class="nc" id="L1410">		return fullResponse;</span>
	}

	private void getProjectMediaPartialCombinedQueueModel(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) 
	{   
		try
		{
<span class="nc" id="L1418">			response.put(ForecastingKeys.RETVAL_PROJECT_MEDIA_FORECAST_MODEL,</span>
<span class="nc" id="L1419">					getPartialCombinedProjectQueueModelResponse(context, request, response));</span>
		}
<span class="nc" id="L1421">		catch(Exception e){</span>
<span class="nc" id="L1422">			notifyError(context, response, e);</span>
<span class="nc" id="L1423">		}</span>
<span class="nc" id="L1424">	}</span>
	
	private void saveProjectMediaForecast(RequestContext context,
			Map&lt;? extends Object, ? extends Object&gt; request, Map&lt;Object, Object&gt; response) throws BbmException {
		try {
<span class="nc" id="L1429">			ForecastTimeSeriesManager ftsm = WfmManagerFactory.getForecastTimeSeriesManager(context.isInWhatIfMode());</span>
<span class="nc" id="L1430">			Map&lt;ForecastProfile, Collection&lt;ForecastProfileProject&gt;&gt; projectsByForecastProfile =</span>
<span class="nc" id="L1431">				(Map&lt;ForecastProfile, Collection&lt;ForecastProfileProject&gt;&gt;) request.get(ForecastingKeys.PARAM_PROJECTS_BY_FORECAST_PROFILE);</span>
<span class="nc" id="L1432">			ftsm.saveProjectMediaForecastAsActive(projectsByForecastProfile);</span>

<span class="nc" id="L1434">			response.put(ForecastingKeys.RETVAL, &quot;Success!&quot;);</span>
<span class="nc" id="L1435">		} catch (RemoteException e) {</span>
<span class="nc" id="L1436">			throw new BbmException(e);</span>
<span class="nc" id="L1437">		}</span>
<span class="nc" id="L1438">	}</span>
	
    /**
     * Returns true if the monthly forecast / work rules license is present.
     */
	private Boolean checkMonthlyLicense(RequestContext context, Map appletResponse) {
<span class="nc" id="L1444">    	Boolean hasLicense = null;</span>
        try 
		{
<span class="nc" id="L1447">        	String licenseKey = LicenseKeys.APP_MONTHLY_FORECAST_AND_RULES;</span>
<span class="nc" id="L1448">           	hasLicense = new Boolean(CoreManagerFactory.getLicenseManager().isLicensed(licenseKey));</span>
		} 
<span class="nc" id="L1450">        catch (Exception ex) </span>
		{
<span class="nc" id="L1452">        	notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1453">        }</span>
<span class="nc" id="L1454">        return hasLicense;</span>
    }
	
	/**
	 * We need to add the check for the monthly license as part of the Forecasting Applet's init data.
	 * checkMonthlyLicense() will get called and the result from that method will be put in the
	 * Forecasting Applet's cached applet init info.
	 */
	protected Object getAppletInitData(RequestContext context, Map appletRequest,
			Map appletResponse, String command) {
		try {
<span class="nc bnc" id="L1465" title="All 2 branches missed.">			if (ForecastingKeys.PROC_CHECK_MONTHLY_LICENSE.equals(command)) {</span>
<span class="nc" id="L1466">				return checkMonthlyLicense(context, appletRequest);</span>
			}
<span class="nc bnc" id="L1468" title="All 2 branches missed.">			else if (PulseKeys.FORECAST_ID.equals(command)) {</span>
<span class="nc" id="L1469">				String forecastIDString = (String)(context.getAttribute(RequestContext.ONE_TIME_USE_SESSION_SCOPE, &quot;FORECAST_PROFILE_ID_KEY&quot;)); //tbd PageKeys.FORECAST_PROFILE_ID_KEY</span>
<span class="nc bnc" id="L1470" title="All 4 branches missed.">				ID id = (forecastIDString==null||forecastIDString.isEmpty()) ? null : new ID(forecastIDString);</span>
<span class="nc" id="L1471">				return id;</span>
			}
		}
<span class="nc" id="L1474">		catch (Exception ex) {</span>
<span class="nc" id="L1475">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1476">		}</span>
<span class="nc" id="L1477">		return null;</span>
	}

	/**
	 * Retrieves the forecast trace data for each queue in the partialResponse object.  The trace data returned will
	 * only contain data for the trace types that are specified in the given metaTraceCube.  The date range of the trace
	 * data returned will span the start/end dates of the Scheduling Period defined in the partialResponse.
	 */
	private static Collection&lt;TraceCube&gt; getForecastTraceDataForMultiQueuePartialResponse(MultiQueuePartialResponse partialResponse,
			ForecastTraceCube metaTraceCube, TimeSeriesManager tsm) throws RemoteException, BbmFinderException {
<span class="nc" id="L1487">		Collection&lt;ID&gt; queueIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">		for (Queue queue : partialResponse.getQueues()) {</span>
<span class="nc" id="L1489">			queueIDs.add(queue.getID());</span>
<span class="nc" id="L1490">		}</span>
<span class="nc" id="L1491">		Collection&lt;TraceCube&gt; forecastData = tsm.getRawMultipleQueuesTimeSeries(metaTraceCube,</span>
<span class="nc" id="L1492">				partialResponse.getCampaign().getID(), queueIDs, partialResponse.getSp().getStartTime(),</span>
<span class="nc" id="L1493">				new Date(partialResponse.getSp().getEndTime().getTime() - 1));</span>

<span class="nc" id="L1495">		return forecastData;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>