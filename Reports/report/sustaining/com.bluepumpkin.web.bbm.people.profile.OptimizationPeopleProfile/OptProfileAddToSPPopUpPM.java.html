<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OptProfileAddToSPPopUpPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.people.profile.OptimizationPeopleProfile</a> &gt; <span class="el_source">OptProfileAddToSPPopUpPM.java</span></div><h1>OptProfileAddToSPPopUpPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.people.profile.OptimizationPeopleProfile;

/**
 * Title: OptProfileAddToSPPopUpPM
 * Description: PeopleSkillEdit Pop Up Page Model
 * Copyright (c) 2010 Company: Verint Systems
 *
 * @author Amit Kumar
 * @version 1.0
 */

import java.rmi.RemoteException;
import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignOrg;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignWorkResource;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriodFieldInfo;
import com.bluepumpkin.ejb.bbm.employeefilter.model.Filter;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeOrganizationDependFields;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeType;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.employee.EmployeeListConfig;
import com.bluepumpkin.web.bbm.employee.EmployeeListConfigFP;
import com.bluepumpkin.web.bbm.employee.EmployeeListModelHandler;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.people.filter.PeopleFilterModelHandler;
import com.bluepumpkin.web.bbm.people.filter.PeopleFilterParams;
import com.bluepumpkin.web.bbm.workload.queue.selection.QueueFilterUtil;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.listconfig.ListConfigSelectorPC;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.PopupWindowListPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.html.HtmlChoiceInput;

public class OptProfileAddToSPPopUpPM extends PopupWindowListPM {
	private static final long serialVersionUID = 1L;

<span class="nc" id="L70">	protected static final Category log	= Log.initCategory(OptProfileAddToSPPopUpPM.class.getName());</span>

	private static final String NAME_HD_KEY = &quot;NAME_HD_KEY&quot;;
	public static final String TABLE_NAME = &quot;tbl&quot;;
	public static final String SUCCESS = &quot;SUCCESS&quot;;
	public static final String MODEL_KEY = &quot;OptProfileAddToSPPopUpPM_ModelKEY&quot;;

	protected MultiColListPC m_EmployeeDetailsPC;
	protected HashMap&lt;ID, Employee&gt; m_MapEmp;
	protected Campaign m_Campaign;
	protected SchedulingPeriod m_SP;
<span class="nc" id="L81">	protected Collection&lt;ID&gt; m_poolers = Collections.emptyList();</span>
	protected Filter m_Filter;
	private ListConfigSelectorPC m_lcSelectorPC;
<span class="nc" id="L84">	private Collection&lt;Employee&gt; m_employeeList = Collections.emptyList();</span>
<span class="nc" id="L85">	private Map&lt;ID, EmployeeType&gt; employeeTypes = null;</span>

	public OptProfileAddToSPPopUpPM(RequestContext context) {
<span class="nc" id="L88">		super(context);</span>

<span class="nc" id="L90">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
		// Initialize List Configuration Selector
<span class="nc" id="L92">		m_lcSelectorPC = new ListConfigSelectorPC(m_context, EmployeeListConfig.class);</span>
<span class="nc" id="L93">		addChildComponent(m_lcSelectorPC);</span>

<span class="nc" id="L95">		m_EmployeeDetailsPC = new MultiColListPC(m_context);</span>
<span class="nc" id="L96">		m_EmployeeDetailsPC.setName(TABLE_NAME);</span>
<span class="nc" id="L97">		m_EmployeeDetailsPC.setIsBorderEnabled(true);</span>
<span class="nc" id="L98">		addChildComponent(m_EmployeeDetailsPC);</span>

<span class="nc" id="L100">		m_MapEmp = new HashMap&lt;ID, Employee&gt;();</span>

		// Component specific required JavaScript Files
<span class="nc" id="L103">		addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE_GENERIC);</span>
<span class="nc" id="L104">		addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_SELECTION);</span>
<span class="nc" id="L105">		addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_APPLICATION);</span>
<span class="nc" id="L106">	}</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L112">		PageModel model = (PageModel)context.getRequest().getAttribute(MODEL_KEY);</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">		if (model != null) {</span>
<span class="nc" id="L114">			context.setPageModel(model);</span>
		}

<span class="nc" id="L117">		model = getInstance(context, OptProfileAddToSPPopUpPM.class);</span>
<span class="nc" id="L118">		context.getRequest().setAttribute(MODEL_KEY, model);</span>
<span class="nc" id="L119">		return model;</span>
	}

	/**
	 */
	@Override
	public String getCustomJavaScript() {
<span class="nc" id="L126">		return super.getCustomJavaScript() + getShowPoolerInitJS() + getOKClickForPoolerJS() + getSelectAllJS();</span>
	}

	@Override
	protected void initializeModel() {
<span class="nc bnc" id="L131" title="All 2 branches missed.">		if (!m_isInitialized) {</span>
<span class="nc" id="L132">			m_isInitialized = true;</span>
<span class="nc" id="L133">			super.initializeModel();</span>
			try {
<span class="nc" id="L135">				m_lcSelectorPC.init();</span>
<span class="nc" id="L136">				loadData();</span>
<span class="nc" id="L137">				initContentTitle();</span>
<span class="nc" id="L138">				initToolbar();</span>
<span class="nc" id="L139">				initHeader();</span>
<span class="nc" id="L140">				initSelectableItems();</span>
<span class="nc" id="L141">			} catch (Exception e) {</span>
<span class="nc" id="L142">				getLog().l7dError(BbmWebBundleKey.UNABLE_TO_LOAD_DATA, e);</span>
<span class="nc" id="L143">		 		addPageMessage(Message.ERROR_TYPE, CoreWebBundleKey.UNABLE_TO_LOAD_DATA,</span>
		 			CoreWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L145">			}</span>
		}
<span class="nc" id="L147">	}</span>

	@Override
	protected void initToolbar() {
<span class="nc" id="L151">		super.initializeModel();</span>
<span class="nc" id="L152">		String onClickJS = &quot;selectAllJS();&quot;;</span>
<span class="nc" id="L153">		ToolbarTextButton allBtn = m_toolbar.addJSTextButton(</span>
				&quot;SelectAllRows&quot;,
<span class="nc" id="L155">				m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.CAMPAIGN_EMPLOYEES_SELECT_ALL),</span>
				true, &quot;&quot;);

<span class="nc" id="L158">		m_toolbar.addSubmitTextButton(PageAction.ADD,</span>
<span class="nc" id="L159">				m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.ADD), true);</span>

<span class="nc" id="L161">		allBtn.setCustomJS(onClickJS);</span>

<span class="nc" id="L163">		m_toolbar.addCloseWindowTextButton(&quot;cancel&quot;, m_localizer.i18n(</span>
				CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_CANCEL),
				true);
<span class="nc" id="L166">	}</span>

	/**
	 * Return the JavaScript init code required by Page model.
	 *
	 * Default behavior is to retrieve sub-component JavaScript Init code
	 */
	@Override
	public String getJavaScriptInitCode() {
<span class="nc" id="L175">		StringBuilder jsInitCode = new StringBuilder(512);</span>

		// Add sub-component JavaScript code first
<span class="nc" id="L178">		jsInitCode.append(super.getJavaScriptInitCode()).append(&quot;\n&quot;);</span>

<span class="nc bnc" id="L180" title="All 4 branches missed.">		if (this.getPageAction() != null &amp;&amp; this.getPageAction().equals(PageAction.ADD)) {</span>
<span class="nc" id="L181">			jsInitCode.append(&quot;// set values\n&quot;)</span>
<span class="nc" id="L182">					.append(&quot;window.notifyOpener=true;\n&quot;)</span>
<span class="nc" id="L183">					.append(&quot;window.refreshOpener = true;\n&quot;)</span>
<span class="nc" id="L184">					.append(&quot;window.opener.top.workpaneMediator.refreshSelectionPane(); &quot;)</span>
<span class="nc" id="L185">					.append(&quot;window.close();\n&quot;);</span>
		}
<span class="nc" id="L187">		jsInitCode.append(&quot;poolingRuleInitJS(); \n&quot;);</span>
<span class="nc" id="L188">		return jsInitCode.toString();</span>
	}

	@Override
	protected void initUtilityPane() {
<span class="nc" id="L193">		getUtilityPane().setIsHelpEnabled(false);</span>
<span class="nc" id="L194">	}</span>

	@Override
	protected void initContentTitle() {
<span class="nc" id="L198">		Object[] args = new Object[1];</span>
<span class="nc" id="L199">		args[0] = m_context.getSystemManagerFactory().getVerticalizationManager()</span>
<span class="nc" id="L200">				.getVerticalizedString(m_context, DefaultVerticalizationManager.WORKER);</span>
<span class="nc" id="L201">		String formattedTitle = MessageFormat.format(</span>
<span class="nc" id="L202">				m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.OPTIMIZATION_PEOPLE_POFILE_ADD_EMP_TO_SP), args);</span>

<span class="nc" id="L204">		m_contentTitlePC.setPageTitle(formattedTitle);</span>
<span class="nc" id="L205">		String itemName = getContentTitleItemName();</span>
<span class="nc" id="L206">		m_contentTitlePC.setItemName(itemName);</span>

		// List Config
<span class="nc" id="L209">		m_contentTitlePC.addActiveComponent(</span>
<span class="nc" id="L210">				m_lcSelectorPC.getLabel(),</span>
<span class="nc" id="L211">				m_lcSelectorPC.getControl(), true);</span>
<span class="nc" id="L212">	}</span>

	private String getContentTitleItemName() {
<span class="nc" id="L215">		StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L217">		sb.append(&quot;   &quot;);</span>
<span class="nc" id="L218">		String sLabel = i18n(m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME), BbmWebBundleKey.CAMPAIGN_EMPLOYEES_SHOW_POOLER);</span>

<span class="nc bnc" id="L220" title="All 2 branches missed.">		if (hasPoolingLicense()) {</span>
<span class="nc" id="L221">			sb.append(HtmlChoiceInput.makeChkBoxInput(&quot;poolingRule__showPooler&quot;, &quot;true&quot;, sLabel, false, &quot;getOKClickForPoolerJS()&quot;)); //508</span>
		}

<span class="nc" id="L224">		return sb.toString();</span>
	}

	@Override
	public String getHtmlDisplay() {
<span class="nc" id="L229">		return m_EmployeeDetailsPC.getHtmlDisplay();</span>
	}

	private boolean hasPoolingLicense() {
		try {
<span class="nc" id="L234">			return CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_CAMP_POOLING);</span>
<span class="nc" id="L235">		} catch (Exception ex) {</span>
<span class="nc" id="L236">			handleUnableToLoadDataError(getLog(), ex);</span>
		}
<span class="nc" id="L238">		return false;</span>
	}

	@Override
	protected void loadData() throws Exception {
<span class="nc" id="L243">		ArrayList&lt;ID&gt; campaignSPEmployees = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L244">		ArrayList&lt;ID&gt; campaignSPOrgs = new ArrayList&lt;ID&gt;();</span>
		try {
<span class="nc" id="L246">			m_SP = CampaignModelHandler.getSchedulingPeriodByID(</span>
<span class="nc" id="L247">					m_context, QueueFilterUtil.retrieveSchedulingPeriodID(m_context));</span>

<span class="nc bnc" id="L249" title="All 2 branches missed.">			if (m_SP != null) {</span>
<span class="nc" id="L250">				m_Campaign = CampaignModelHandler.getCampaign(m_context, m_SP.getCampaignID());</span>

				//TODO: filter already added employees and employees who dont belong to linked org
<span class="nc bnc" id="L253" title="All 2 branches missed.">				if (m_Campaign != null) {</span>
<span class="nc" id="L254">					Collection&lt;CampaignWorkResource&gt; campaignEmployees = OptProfileAddToSPPopUpMH.getCampaignWorkResourceAssignments(</span>
<span class="nc" id="L255">							m_context, m_Campaign.getID(), m_SP.getStartTime(), m_SP.getEndTime());</span>

<span class="nc bnc" id="L257" title="All 2 branches missed.">					for (CampaignWorkResource cwr : campaignEmployees) {</span>
<span class="nc" id="L258">						campaignSPEmployees.add(cwr.getWorkResourceID());</span>
<span class="nc" id="L259">					}</span>

<span class="nc" id="L261">					m_poolers = OptProfileAddToSPPopUpMH.getCampaignPoolerAssignments(m_context,</span>
<span class="nc" id="L262">							m_SP.getFieldValueID(SchedulingPeriodFieldInfo.SP_ID), m_SP.getStartTime(), m_SP.getEndTime());</span>

<span class="nc" id="L264">					Collection&lt;CampaignOrg&gt; campOrgs = CampaignModelHandler.getCampaignOrgAssignments(m_context, m_Campaign.getID(),</span>
<span class="nc" id="L265">							m_SP.getStartTime(), m_SP.getEndTime());</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">					for (CampaignOrg campaignOrg : campOrgs) {</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">						if (campaignOrg != null) {</span>
<span class="nc" id="L268">							campaignSPOrgs.add(campaignOrg.getOrganizationID());</span>
						}
<span class="nc" id="L270">					}</span>
<span class="nc" id="L271">					campaignSPOrgs.retainAll(getOrgIDsThatUserHasModifyPeopleRights());</span>
				}
			}
<span class="nc" id="L274">			setSelectedID(&quot;&quot;);</span>

<span class="nc" id="L276">		} catch (RemoteException e) {</span>
<span class="nc" id="L277">			e.printStackTrace();</span>
<span class="nc" id="L278">			handleUnableToLoadDataError(getLog(), e);</span>
<span class="nc" id="L279">		} catch (BbmException e) {</span>
<span class="nc" id="L280">			e.printStackTrace();</span>
<span class="nc" id="L281">			handleUnableToLoadDataError(getLog(), e);</span>
<span class="nc" id="L282">		}</span>

<span class="nc" id="L284">		String filterName = &quot;&quot;;</span>
<span class="nc" id="L285">		Boolean isDefaultFilterInitialized = (Boolean) m_context</span>
<span class="nc" id="L286">				.getAttribute(RequestContext.SESSION_SCOPE, &quot;isDFilterInit&quot;);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">		if (isDefaultFilterInitialized == null</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">				|| !isDefaultFilterInitialized.booleanValue()) {</span>
<span class="nc" id="L289">			filterName = m_context</span>
<span class="nc" id="L290">					.getUserProperty(UserPreferenceKeys.USER_DEFAULT_FILTER);</span>
		} else {
<span class="nc" id="L292">			filterName = m_context</span>
<span class="nc" id="L293">					.getUserProperty(UserPreferenceKeys.EMP_FILTER);</span>
		}
<span class="nc bnc" id="L295" title="All 2 branches missed.">		if (EmployeeModelHandler.isAllFilter(filterName)) {</span>
<span class="nc" id="L296">			User user = m_context.getUser();</span>
<span class="nc" id="L297">			m_Filter = EmployeeModelHandler.createAllFilterWithID(user.getID(), filterName);</span>
<span class="nc" id="L298">		} else{</span>
<span class="nc" id="L299">			m_Filter = PeopleFilterModelHandler.getFilterByName(m_context, filterName);</span>
		}

		// Code to Enable Pagination
<span class="nc" id="L303">		int editIndex = 0;</span>
<span class="nc" id="L304">		int pageIDSize = Integer.MAX_VALUE;</span>
<span class="nc" id="L305">		EmployeeListModelHandler.EmployeeCollection result =</span>
<span class="nc" id="L306">            EmployeeListModelHandler.getEmployeeCollection(</span>
                m_context,
<span class="nc" id="L308">                getFilterParams(),</span>
                null,
<span class="nc" id="L310">                getSortFieldID(),</span>
<span class="nc" id="L311">                isAscendingSort(),</span>
                false,
<span class="nc" id="L313">                m_SP.getStartTime(),</span>
<span class="nc" id="L314">                m_SP.getEndTime(),</span>
                editIndex,
                null, //null to return all the employees in filter instead of sp employee
                pageIDSize,
                true,
                true,
                campaignSPOrgs,
<span class="nc" id="L321">                m_SP.getID());</span>

		//get all employee types from scopes of campaign's orgs
<span class="nc" id="L324">		employeeTypes = OptProfileAddToSPPopUpMH.getEmployeeTypesFromOrgs(campaignSPOrgs, m_context);</span>
<span class="nc" id="L325">		m_employeeList = result.getPageEmployees();</span>

<span class="nc bnc" id="L327" title="All 2 branches missed.">		for (Iterator it = m_employeeList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L328">			Employee emp = (Employee) it.next();</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">			if (emp.getStartTime().getTime() &gt;= m_SP.getEndTime().getTime()){</span>
<span class="nc" id="L330">				it.remove();</span>
<span class="nc" id="L331">				continue;</span>
			}

<span class="nc" id="L334">			boolean bContinue = false;</span>
			//remove all employees already part of SP
<span class="nc bnc" id="L336" title="All 2 branches missed.">			for (ID id : campaignSPEmployees) {</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">				if (emp.getID().equals(id)) {</span>
<span class="nc" id="L338">					it.remove();</span>
<span class="nc" id="L339">					bContinue = true;</span>
				}
<span class="nc" id="L341">			}</span>

<span class="nc bnc" id="L343" title="All 2 branches missed.">			if (m_poolers.contains(emp.getID())) {</span>
<span class="nc" id="L344">				bContinue = true;</span>
			}

<span class="nc bnc" id="L347" title="All 2 branches missed.">			if (!bContinue) {</span>
				//check if the employee belongs to an org in SP. If not remove him.
<span class="nc" id="L349">				Collection&lt;EmployeeOrganizationDependFields&gt; orgHistory = emp.getOrganizationDependFieldsHistroy();</span>
<span class="nc" id="L350">				EmployeeOrganizationDependFields wra = null;</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">				for (EmployeeOrganizationDependFields segment: orgHistory) {</span>
<span class="nc bnc" id="L352" title="All 6 branches missed.">					if (segment.getStartTime().before(m_SP.getEndTime()) &amp;&amp; (segment.getEndTime() == null || segment.getEndTime().after(m_SP.getStartTime()))) {</span>
<span class="nc" id="L353">						wra = segment;</span>
<span class="nc" id="L354">						break;</span>
					}
<span class="nc" id="L356">				}</span>

<span class="nc" id="L358">				boolean bfoundOrg = false;</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">				if (wra != null) {</span>
<span class="nc" id="L360">					bfoundOrg = campaignSPOrgs.contains(wra.getOrganizationID());</span>
				}

<span class="nc bnc" id="L363" title="All 2 branches missed.">				if (!bfoundOrg) {</span>
<span class="nc" id="L364">					it.remove();</span>
				}
			}
<span class="nc" id="L367">		}</span>
<span class="nc" id="L368">	}</span>

	protected Collection getOrgIDsThatUserHasModifyPeopleRights() {
<span class="nc" id="L371">		return m_context.getUser().getAuthorizedScopes(PrivilegeKeys.FS_VIEWORGSCHEDULES, Scope.ORG_SCOPE);</span>
	}

	/**
	 * Return current Selected Filter
	 */
	public PeopleFilterParams getFilterParams() {
<span class="nc bnc" id="L378" title="All 2 branches missed.">		if (m_Filter.getTimePeriodType() == Filter.TIMEPERIODTYPE_CONTEXT) {</span>
<span class="nc" id="L379">			return new PeopleFilterParams(m_Filter.getFilterName(), m_SP.getStartTime(), m_SP.getEndTime());</span>
		} else {
<span class="nc" id="L381">			return new PeopleFilterParams(m_Filter.getFilterName(), null, null);</span>
		}
	}

	/**
	 * Return Sort Field ID
	 */
	public int getSortFieldID() {
<span class="nc" id="L389">		int id = Filter.LASTNAME;</span>

<span class="nc" id="L391">		String fpKey = m_EmployeeDetailsPC.getHeader().getSortColumn();</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">		if (!StringUtil.isEmpty(fpKey)) {</span>
<span class="nc" id="L393">			Map fpMap = m_lcSelectorPC.getListConfig().getFPMap();</span>
<span class="nc" id="L394">			EmployeeListConfigFP lcFP = (EmployeeListConfigFP) fpMap.get(fpKey);</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">			if (lcFP != null) {</span>
<span class="nc" id="L396">				id = lcFP.getSortID();</span>
			}
		}

<span class="nc" id="L400">		return id;</span>
	}

	/**
	 * Return true is It is an ascending sort
	 */
	public boolean isAscendingSort() {
<span class="nc" id="L407">		return m_EmployeeDetailsPC.getHeader().isAscending();</span>
	}

	@Override
	protected void initHeader() {
<span class="nc" id="L412">		TableHeaderPC header = m_EmployeeDetailsPC.getHeader();</span>
<span class="nc" id="L413">		header.setPartialSortable(true);</span>
<span class="nc" id="L414">		header.setDefaultSortColumn(NAME_HD_KEY);</span>

<span class="nc" id="L416">		String sNameHdr = i18n(m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME), BbmWebBundleKey.PEOPLE_NAME_HEADER);</span>
<span class="nc" id="L417">		header.addColumnHeaderData(NAME_HD_KEY, sNameHdr, true);</span>
<span class="nc" id="L418">		header.addColumnHeaderData(m_lcSelectorPC);</span>
<span class="nc" id="L419">	}</span>

	@Override
	protected void initSelectableItems() {
<span class="nc" id="L423">		int index = 0;</span>
<span class="nc" id="L424">		List listModel = new ArrayList(m_employeeList.size());</span>
<span class="nc" id="L425">		List selectedFPs = m_lcSelectorPC.getListConfig().getSelectedFPs();</span>
<span class="nc" id="L426">		int colSpan = selectedFPs.size() + 1;</span>
<span class="nc" id="L427">		String notViableMsg = i18n(m_common_bundle, UIFWebBundleKey.NOT_VIEWABLE);</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">		for (Iterator it = m_employeeList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L429">			Employee emp = (Employee) it.next();</span>

			// employee object has been deleted or cannot be viewed
<span class="nc bnc" id="L432" title="All 4 branches missed.">			if (emp == null || !emp.isViewable()) {</span>
<span class="nc" id="L433">				DefaultMultiColumnNodeData data = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L434">				data.add(notViableMsg, null, colSpan);</span>
<span class="nc" id="L435">				data.setSelectable(true);</span>
<span class="nc" id="L436">				listModel.add(data);</span>
<span class="nc" id="L437">				continue;</span>
			}

<span class="nc" id="L440">			EmployeeSPListRow row = new EmployeeSPListRow(m_context, m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME),</span>
<span class="nc" id="L441">					emp, index++, m_EmployeeDetailsPC.getName(), selectedFPs, false, true, this.employeeTypes);</span>
<span class="nc" id="L442">			String rowID = emp.getID().toString();</span>
<span class="nc" id="L443">			DefaultMultiColumnNodeData data = new DefaultMultiColumnNodeData(rowID, row.getValueList());</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">			if (m_poolers.contains(emp.getID())) {</span>
<span class="nc" id="L445">				data.setNodeAttribute(&quot;isPooler&quot;, Boolean.toString(true));</span>
			} else {
<span class="nc" id="L447">				data.setNodeAttribute(&quot;isPooler&quot;, Boolean.toString(false));</span>
			}
<span class="nc" id="L449">			listModel.add(data);</span>
<span class="nc" id="L450">		}</span>

<span class="nc" id="L452">		m_EmployeeDetailsPC.setSearchableColNum(0);</span>
<span class="nc" id="L453">		m_EmployeeDetailsPC.setListModel(listModel);</span>
<span class="nc" id="L454">	}</span>

	/**
	 * This JS is used to force the effective dates to snap to the view period if a duration spinner is modified
	 * when in campaign mode (essentially it will match the view period of the currently selected SP).
	 */
	private String getShowPoolerInitJS() {
<span class="nc" id="L461">		StringBuilder js = new StringBuilder();</span>
<span class="nc" id="L462">		js.append(&quot;function poolingRuleInitJS() {\n&quot;);</span>
<span class="nc" id="L463">		js.append(&quot;jQuery('tr[isPooler=\&quot;true\&quot;]').hide();&quot;);</span>
<span class="nc" id="L464">		js.append(&quot;}\n&quot;);</span>

<span class="nc" id="L466">		return js.toString();</span>
	}

	private String getOKClickForPoolerJS() {
<span class="nc" id="L470">		StringBuilder js = new StringBuilder();</span>
<span class="nc" id="L471">		    js.append(&quot;function getOKClickForPoolerJS() {\n&quot;);</span>
<span class="nc" id="L472">			js.append(&quot;if(jQuery('input[name=poolingRule__showPooler]').is(':checked')) { \n&quot;);</span>
<span class="nc" id="L473">			js.append(&quot;jQuery('tr[isPooler=\&quot;true\&quot;]').show(); \n&quot;);</span>
<span class="nc" id="L474">			js.append(&quot;}else{ \n&quot;);</span>
<span class="nc" id="L475">			js.append(&quot;jQuery('tr[isPooler=\&quot;true\&quot;]').hide(); } \n&quot;);</span>
<span class="nc" id="L476">			js.append(&quot;}\n&quot;);</span>
<span class="nc" id="L477">		return js.toString();</span>
	}

	private String getSelectAllJS() {
<span class="nc" id="L481">		StringBuilder js = new StringBuilder();</span>
<span class="nc" id="L482">		    js.append(&quot;function selectAllJS() {\n&quot;);</span>
<span class="nc" id="L483">			js.append(&quot;jQuery('tr:visible[isPooler]').each(\n&quot;);</span>
<span class="nc" id="L484">			js.append(&quot;function(){var strID = this.id;\n&quot;);</span>
<span class="nc" id="L485">			js.append(&quot;var str= strID.substring(3);\n&quot;);</span>
<span class="nc" id="L486">			js.append(&quot;tbl.selectRowWithID(str);&quot;);</span>
<span class="nc" id="L487">			js.append(&quot;document.getElementByIdOrName('selectedID').value=tbl.getMultiExpandoAttribute('uid');}\n&quot;);</span>
<span class="nc" id="L488">			js.append(&quot;)\n&quot;);</span>
<span class="nc" id="L489">			js.append(&quot;}\n&quot;);</span>
<span class="nc" id="L490">		return js.toString();</span>
	}

	protected Category getLog() {
<span class="nc" id="L494">		return log;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>