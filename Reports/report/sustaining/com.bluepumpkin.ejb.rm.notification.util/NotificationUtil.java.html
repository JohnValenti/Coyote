<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>NotificationUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.notification.util</a> &gt; <span class="el_source">NotificationUtil.java</span></div><h1>NotificationUtil.java</h1><pre class="source lang-java linenums">/*
 * Created on Apr 17, 2004
 *
 * To change the template for this generated file go to
 * Window&amp;gt;Preferences&amp;gt;Java&amp;gt;Code Generation&amp;gt;Code and Comments
 */
package com.bluepumpkin.ejb.rm.notification.util;

import java.io.IOException;
import java.io.StringReader;
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.xml.parsers.DocumentBuilder;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;

import weblogic.apache.xerces.parsers.DOMParser;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.localization.DefaultLocalizationManager;
import com.bluepumpkin.ejb.bbm.notifydelivery.model.NotifyDeliveryMedia;
import com.bluepumpkin.ejb.bbm.notifydelivery.model.NotifyMessageTarget;
import com.bluepumpkin.ejb.bbm.notifydelivery.model.NotifyRuleDelivery;
import com.bluepumpkin.ejb.bbm.notifyrules.model.ActionDetail;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftOTExtension;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestFieldInfo;
import com.bluepumpkin.ejb.rm.requests.custshift.model.CustShiftReq;
import com.bluepumpkin.ejb.rm.requests.custshift.model.CustShiftReqFieldInfo;
import com.bluepumpkin.ejb.rm.requests.custshift.model.CustShiftReqGap;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.FlexReqMakeupGap;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.FlexRequestMakeup;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.util.CustomShiftEJBUtil;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.bbm.util.NetworkUtil;
import com.witness.ejb.core.base.CoreFinderException;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.UserManager;
import com.witness.ejb.core.security.model.User;

/**
 * @author rrajendran
 *
 * To change the template for this generated type comment go to
 * Window&amp;gt;Preferences&amp;gt;Java&amp;gt;Code Generation&amp;gt;Code and Comments
 */
<span class="nc" id="L86">public class NotificationUtil {</span>

	public static final String m_xmlAttrDescription = &quot;description&quot;;
	public static final String m_xmlElemSwapType = &quot;swaptype&quot;;
	public static final String m_xmlAttrValue = &quot;value&quot;;
	public static final String m_xmlElemEmployeeName = &quot;employeename&quot;;
	public static final String m_xmlElemRequestType = &quot;requestType&quot;;
	public static final String m_xmlElemActivity = &quot;activity&quot;;
	public static final String m_xmlElemStartTime = &quot;starttime&quot;;
	public static final String m_xmlElemEndTime = &quot;endtime&quot;;
	public static final String m_xmlElemRequestAggregate = &quot;requestaggregate&quot;;
	public static final String m_xmlElemRequest = &quot;request&quot;;
	public static final String m_xmlElemSubmittedOn = &quot;submittedon&quot;;
	public static final String m_xmlElemStatus = &quot;status&quot;;
	public static final String m_xmlElemSwapItemType = &quot;swapitemtype&quot;;
	public static final String m_xmlElemRequestName = &quot;requestname&quot;;
	public static final String m_xmlElemAuctionNameName = &quot;auctionname&quot;;
	public static final String m_xmlElemAuctionStartTime = &quot;auctionstarttime&quot;;
	public static final String m_xmlElemAuctionEndTime = &quot;auctionendtime&quot;;
	public static final String m_xmlElemShiftAssignment = &quot;shiftassignment&quot;;
	public static final String m_xmlElemTOChoice = &quot;tochoice&quot;;
	public static final String m_xmlElemCSType = &quot;CSTYPE&quot;;
	public static final String m_xmlElemDuration = &quot;duration&quot;;
	public static final String m_xmlElemShift = &quot;shift&quot;;
	public static final String m_xmlElemOvertime = &quot;overtime&quot;;
	public static final String m_xmlElemOvertimeBefore = &quot;overtimebefore&quot;;
	public static final String m_xmlElemOvertimeAfter = &quot;overtimeafter&quot;;
	public static final String m_xmlElemExtensionDuring = &quot;extensionduring&quot;;
	public static final String m_xmlElemExtension = &quot;extension&quot;;
	public static final String m_xmlElemType = &quot;type&quot;;
	public static final String xmlElemGap = &quot;gap&quot;;
	public static final String xmlElemMakeUps = &quot;makeups&quot;;
	public static final String xmlElemMakeUp = &quot;makeup&quot;;
	public static final String m_xmlElemExtensionGap = &quot;extensiongap&quot;;
    public static final String xmlElementRequestStatusChange = &quot;requeststatuschange&quot;;


<span class="nc" id="L123">	private static ResourceBundle m_rmEjbResBundleInAppDefLocale = null;</span>
	static {
<span class="nc" id="L125">		m_rmEjbResBundleInAppDefLocale = DefaultLocalizationManager.getDefaultInstance().getLocalizer().</span>
<span class="nc" id="L126">			getBundle(RmEjbBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L127">	}</span>

	/**
	 * Used to retrieve an XML representation of the request for &quot;request notification&quot;
	 *
	 * @param parser
	 * @param localizer
	 * @param Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer
	 * @return
	 */
	public static Element getXMLLocalizedFrag(Element element, RequestAggregate reqAgg, Document doc,
		Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer,  String requestStatus) throws Exception {

		/*
		&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
		&lt;requeststatuschange description=&quot;Shift Swap Request Notification&quot;&gt;
			&lt;request&gt;
				&lt;submittedon description=&quot;Submitted On&quot; value=&quot;1/1/2001&quot; /&gt;
				&lt;status description=&quot;Request Status&quot; value=&quot;pending&quot; /&gt;
			&lt;/request&gt;

			&lt;swaptype description=&quot;Swap Type&quot; value=&quot;two-way&quot; /&gt;

			&lt;shiftswapitem&gt;
				&lt;employeename description=&quot;Employee Name&quot; value=&quot;employee1&quot; /&gt;
				&lt;starttime description=&quot;Start Time&quot; value=&quot;1/1/2001&quot; /&gt;
				&lt;endtime description=&quot;End Time&quot; value=&quot;1/2/2001&quot; /&gt;
				&lt;swapitemtype description=&quot;Swap Item Type&quot; value=&quot;shift&quot; /&gt;
			&lt;/shiftswapitem&gt;

		&lt;/requeststatuschange&gt;
		*/

		/*
		&lt;requeststatuschange&gt;
			&lt;requestaggregate description=&quot;Timeoff Request&quot;&gt;

				&lt;request&gt;
					&lt;submittedon description=&quot;Submitted On&quot; value=&quot;1/1/2001&quot; /&gt;
					&lt;status description=&quot;Request Status&quot; value=&quot;pending&quot; /&gt;
				&lt;/request&gt;

				&lt;activity description=&quot;&quot; name=&quot;&quot;&gt;
				&lt;employeename description=&quot;Employee Name&quot; value=&quot;employee1&quot; /&gt;

				&lt;tochoice description=&quot;Approved TOChoice | TOChoice #xx&quot; value=&quot;&quot;&gt;
					&lt;starttime description=&quot;Start Time&quot; value=&quot;1/1/2001&quot; /&gt;
					&lt;endtime description=&quot;End Time&quot; value=&quot;1/2/2001&quot; /&gt;
				&lt;/tochoice&gt;
			&lt;/requestaggregate&gt;
		&lt;/requeststatuschange&gt;
		 */

		/*
		&lt;requeststatuschange&gt;
			&lt;requestaggregate description=&quot;Timeoff Request&quot;&gt;
				&lt;request&gt;
					&lt;submittedon description=&quot;Submitted On&quot; value=&quot;1/1/2001&quot; /&gt;
					&lt;status description=&quot;Request Status&quot; value=&quot;pending&quot; /&gt;
				&lt;/request&gt;

				&lt;requestname description=&quot;&quot; value=&quot;&quot;/&gt;
				&lt;employeename description=&quot;Employee Name&quot; value=&quot;employee1&quot; /&gt;
				&lt;auctionstarttime description=&quot;&quot; value=&quot;&quot;/&gt;
				&lt;auctionendtime description=&quot;&quot; value=&quot;&quot;/&gt;

				&lt;shiftassignment&gt;
					&lt;starttime description=&quot;Start Time&quot; value=&quot;1/1/2001&quot; /&gt;
					&lt;endtime description=&quot;End Time&quot; value=&quot;1/2/2001&quot; /&gt;
				&lt;/shiftassignment&gt;

			&lt;/requestaggregate&gt;
		&lt;/requeststatuschange&gt;



		 */


		/* verify if the request type is TO or Flex and update the request type to call the right template
		 * as both TO and Flex are stored as TO in DB.
		 * adding the conversion here in notification part instead of at call level is to avoid
		 * the rest of the calls to reqAgg object (if any) being impacted
		 */

<span class="nc bnc" id="L212" title="All 2 branches missed.">		if(reqAgg.isFlexTimeRequest()) {</span>
<span class="nc" id="L213">			reqAgg.getAggregatedRequest().setFieldValue(RequestFieldInfo.REQUEST_S_REQUESTTYPE, Request.REQUESTTYPE_FLEXTIME);</span>
		}

		//create &lt;requestaggregate&gt;
<span class="nc bnc" id="L217" title="All 2 branches missed.">        Element rootElem = RequestUtil.createElemAndAppendAsChild(element, element==null?doc:null, m_xmlElemRequestAggregate, null,</span>
                m_xmlAttrDescription,
<span class="nc" id="L219">                m_rmEjbResBundleInAppDefLocale.getString(getBundleKey(reqAgg.getRequestType())));</span>



		//create &lt;request&gt;
<span class="nc" id="L224">		createAndAppendXMLLocalizedFragForRequest(reqAgg.getAggregatedRequest(), rootElem,</span>
			mapIDToTZLocalizer, requestStatus);

<span class="nc bnc" id="L227" title="All 2 branches missed.">		if (reqAgg.isShiftSwapRequest()) {</span>
<span class="nc" id="L228">			createAndAppendXMLLocalizedFromForSSReq((ShiftSwapRequest) reqAgg, rootElem, mapIDToTZLocalizer);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">		} else if (reqAgg.isTimeOffRequest()) {</span>
<span class="nc" id="L230">			createAndAppendXMLLocalizedFromForTOReq((TORequest) reqAgg, rootElem, mapIDToTZLocalizer);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">		} else if (reqAgg.isShiftBidRequest()) {</span>
<span class="nc" id="L232">			createAndAppendXMLLocalizedFromForSBReq((ShiftBidRequest) reqAgg, rootElem, mapIDToTZLocalizer);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">		} else if (reqAgg.isCustShiftRequest()) {</span>
<span class="nc" id="L234">			createAndAppendXMLLocalizedFromForCSReq((CustShiftReq) reqAgg, rootElem, mapIDToTZLocalizer);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">		} else if (reqAgg.isFlexTimeRequest()) {</span>
<span class="nc" id="L236">			createAndAppendXMLLocalizedFromForFlexReq((TORequest) reqAgg, rootElem, mapIDToTZLocalizer);</span>
		}

<span class="nc" id="L239">		return rootElem;</span>
	}

    /**
     * Given a request type or request status string, return the corresponding RmEjbBundleKey string.
     * @param source The string that needs to be translated.
     * @return the RmEjbBundleKey string corresponding to the source parameter.
     */
    public static String getBundleKey(String source)
    {
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (source.equals(Request.REQUESTTYPE_TIMEOFF)) {</span>
<span class="nc" id="L250">            return RmEjbBundleKey.TIME_OFF;</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">        } else if (source.equals(Request.REQUESTTYPE_FLEXTIME)) {</span>
<span class="nc" id="L252">        	 return RmEjbBundleKey.FLEX_TIME;</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        } else if (source.equals(Request.REQUESTTYPE_SHIFTSWAP)) {</span>
<span class="nc" id="L254">            return RmEjbBundleKey.SHIFT_SWAP;</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        } else if (source.equals(Request.REQUESTTYPE_SHIFTBID)) {</span>
<span class="nc" id="L256">            return RmEjbBundleKey.SHIFT_BID;</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        } else if (source.equals(Request.REQUESTTYPE_CUSTSHIFT)) {</span>
<span class="nc" id="L258">            return RmEjbBundleKey.CUSTOM_SHIFT;</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_PENDING)) {</span>
<span class="nc" id="L260">            return RmEjbBundleKey.STATUS_PENDING;</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L262">            return RmEjbBundleKey.STATUS_APPROVED;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_DENIED)) {</span>
<span class="nc" id="L264">            return RmEjbBundleKey.STATUS_DENIED;</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_ESCALATED)) {</span>
<span class="nc" id="L266">            return RmEjbBundleKey.STATUS_ESCALATED;</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_NEGOTIATION)) {</span>
<span class="nc" id="L268">            return RmEjbBundleKey.STATUS_NEGOTIATION;</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_TENTATIVE)) {</span>
<span class="nc" id="L270">            return RmEjbBundleKey.STATUS_TENTATIVE;</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WITHDRAWN)) {</span>
<span class="nc" id="L272">            return RmEjbBundleKey.STATUS_WITHDRAWN;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_INVALID)) {</span>
<span class="nc" id="L274">            return RmEjbBundleKey.STATUS_INVALID;</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WAITLIST)) {</span>
<span class="nc" id="L276">            return RmEjbBundleKey.STATUS_WAITLIST;</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WITHDRAW_REQUEST)) {</span>
<span class="nc" id="L278">            return RmEjbBundleKey.STATUS_WITHDRAW_REQUEST;</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WITHDRAW_REJECT)) {</span>
<span class="nc" id="L280">            return RmEjbBundleKey.STATUS_WITHDRAW_REJECT;</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WITHDRAW_ACCEPT)) {</span>
<span class="nc" id="L282">            return RmEjbBundleKey.STATUS_WITHDRAW_ACCEPT;</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WITHDRAW_CANCEL)) {</span>
<span class="nc" id="L284">            return RmEjbBundleKey.STATUS_WITHDRAW_CANCEL;</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        } else if (source.equals(RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION)) {</span>
<span class="nc" id="L286">        	return RmEjbBundleKey.STATUS_WITHDRAW_NEGOTIATION;</span>
        }
<span class="nc" id="L288">        return source;</span>
    }

	/**
	 * @param request
	 * @param rootElem
	 * @param localizer
	 * @param Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer
	 */
	private static void createAndAppendXMLLocalizedFromForSBReq(ShiftBidRequest sbReq, Element parentElem,
		Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer) throws Exception {

<span class="nc" id="L300">		ID sbReqEmpID = sbReq.getEmployeeID();</span>
<span class="nc" id="L301">		TimeZone empTZ = getTimeZone(sbReqEmpID, mapIDToTZLocalizer);</span>
<span class="nc" id="L302">		Localizer userLocalizer = getLocalizer(sbReqEmpID, mapIDToTZLocalizer);</span>

<span class="nc" id="L304">		String empName = RequestUtil.getLocalizedEmpNameByID(sbReqEmpID, userLocalizer);</span>

		//create &lt;employeename&gt;
<span class="nc" id="L307">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemEmployeeName, null, m_xmlAttrDescription,</span>
<span class="nc" id="L308">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.EMPLOYEE), m_xmlAttrValue, empName);</span>

		//create &lt;requestname&gt;
<span class="nc" id="L311">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemRequestName, null, m_xmlAttrDescription,</span>
<span class="nc" id="L312">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.REQUEST_NAME), m_xmlAttrValue, sbReq.getName());</span>
		//create &lt;auctionname&gt;
<span class="nc" id="L314">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemAuctionNameName, null, m_xmlAttrDescription,</span>
<span class="nc" id="L315">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.AUCTION_NAME), m_xmlAttrValue,</span>
<span class="nc" id="L316">			sbReq.getOptMethods().getShiftBidAuction().getName());</span>
		//create &lt;auctionstarttime&gt;
<span class="nc" id="L318">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemAuctionStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L319">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.AUCTION_START), m_xmlAttrValue,</span>
<span class="nc" id="L320">				userLocalizer.formatDateTime(sbReq.getOptMethods().getShiftBidAuction().getStartTime(), empTZ) + &quot; &quot; </span>
<span class="nc" id="L321">				+ userLocalizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;auctionendtime&gt;
<span class="nc" id="L323">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemAuctionEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L324">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.AUCTION_END), m_xmlAttrValue,</span>
<span class="nc" id="L325">				userLocalizer.formatDateTime(sbReq.getOptMethods().getShiftBidAuction().getEndTime(), empTZ) </span>
<span class="nc" id="L326">				+ &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>

		//create &lt;shiftassignment&gt; elements
<span class="nc" id="L329">		Collection shiftAssns = sbReq.getOptMethods().getShiftAssignments();</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">		for (Iterator iter = shiftAssns.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L331">			ShiftAssignment shiftAssn = (ShiftAssignment) iter.next();</span>

			// create a &lt;shiftassignment&gt; element
<span class="nc" id="L334">			createAndAppendXMLLocalizedFromForShiftAssn(shiftAssn, sbReqEmpID, parentElem, userLocalizer, mapIDToTZLocalizer);</span>
<span class="nc" id="L335">		}</span>
<span class="nc" id="L336">	}</span>

	private static Localizer getLocalizer(ID id, Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer) {
<span class="nc" id="L339">		Pair&lt;TimeZone, Localizer&gt; pair = mapIDToTZLocalizer.get(id);</span>
<span class="nc" id="L340">		Localizer lz = pair.getSecond();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">		return (lz == null)? DefaultLocalizationManager.getDefaultInstance().getLocalizer() : lz;</span>
	}

	private static TimeZone getTimeZone(ID id, Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer) {

<span class="nc" id="L346">		Pair&lt;TimeZone, Localizer&gt; pair = mapIDToTZLocalizer.get(id);</span>
<span class="nc" id="L347">		TimeZone tz = pair.getFirst();</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">		return (tz == null)? TimeZone.getDefault() : tz;</span>
	}

	/**
	 * @param shiftAssn
	 * @param parentElem
	 * @param localizer
	 * @param Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer
	 */
	private static Element createAndAppendXMLLocalizedFromForShiftAssn(ShiftAssignment shiftAssn, ID empID,
		Element parentElem, Localizer localizer, Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer) {

		//create &lt;shiftassignment&gt;
<span class="nc" id="L361">		Element shiftAssnElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemShiftAssignment, null);</span>

<span class="nc" id="L363">		TimeZone empTZ = getTimeZone(empID, mapIDToTZLocalizer);</span>
<span class="nc" id="L364">		Localizer userLocalizer = getLocalizer(empID, mapIDToTZLocalizer);</span>

		//create &lt;shiftassignment&gt;&lt;starttime&gt;
<span class="nc" id="L367">		RequestUtil.createElemAndAppendAsChild(shiftAssnElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L368">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_START_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L369">			userLocalizer.formatDateTime(shiftAssn.getStartTime(), empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;shiftassignment&gt;&lt;endtime&gt;
<span class="nc" id="L371">		RequestUtil.createElemAndAppendAsChild(shiftAssnElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L372">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_END_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L373">			userLocalizer.formatDateTime(shiftAssn.getEndTime(), empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>

<span class="nc" id="L375">		return shiftAssnElem;</span>
	}

	/**
	 * @param request
	 * @param rootElem
	 * @param localizer
	 * @param Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer
	 */
	private static void createAndAppendXMLLocalizedFromForTOReq(TORequest toReq, Element parentElem,
		Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer) throws Exception {

		//create &lt;employeename&gt;
<span class="nc" id="L388">		ID toReqEmpID = toReq.getEmployeeID();</span>
<span class="nc" id="L389">		Localizer userLocalizer = getLocalizer(toReqEmpID, mapIDToTZLocalizer);</span>
<span class="nc" id="L390">		String empName = RequestUtil.getLocalizedEmpNameByID(toReqEmpID, userLocalizer);</span>

<span class="nc" id="L392">		String actName = RequestUtil.getActivityNameByID(toReq.getTimeOffType());</span>

<span class="nc" id="L394">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemEmployeeName, null, m_xmlAttrDescription,</span>
<span class="nc" id="L395">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.EMPLOYEE), m_xmlAttrValue, empName);</span>
		//create &lt;activity&gt;
<span class="nc" id="L397">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemActivity, null, m_xmlAttrDescription,</span>
<span class="nc" id="L398">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.TIME_OFF_TYPE), m_xmlAttrValue, actName);</span>

<span class="nc" id="L400">		Collection&lt;TOChoice&gt; toChoices = toReq.getTOChoicesAdjustedForCalculatedVto();</span>
<span class="nc" id="L401">		boolean isRequestApproved = toReq.isApproved();</span>

		//create &lt;tochoice&gt; elements
<span class="nc bnc" id="L404" title="All 2 branches missed.">		for (TOChoice toChoice : toChoices) {</span>

			// create a &lt;tochoice&gt; element
<span class="nc bnc" id="L407" title="All 4 branches missed.">			createAndAppendXMLLocalizedFromForTOChoice(toChoice, toReqEmpID, isRequestApproved &amp;&amp; toChoice.isApproved(), parentElem,</span>
					userLocalizer, mapIDToTZLocalizer);
<span class="nc" id="L409">		}</span>
<span class="nc" id="L410">	}</span>
	/**
	 * @param request
	 * @param rootElem
	 * @param localizer
	 * @param Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer
	 */
	private static void createAndAppendXMLLocalizedFromForFlexReq(TORequest toReq, Element parentElem,
		Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer) throws Exception {

<span class="nc" id="L420">		createAndAppendXMLLocalizedFromForTOReq(toReq, parentElem,  mapIDToTZLocalizer );</span>

		//create &lt;makeups&gt; element
<span class="nc" id="L423">		Element makeUpsElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, xmlElemMakeUps, null);</span>

<span class="nc" id="L425">		ID empID = toReq.getEmployeeID();</span>
<span class="nc" id="L426">		TimeZone empTZ = getTimeZone(empID, mapIDToTZLocalizer);</span>
<span class="nc" id="L427">		Localizer userLocalizer = getLocalizer(empID, mapIDToTZLocalizer);</span>
<span class="nc" id="L428">		Calendar cal = Calendar.getInstance(empTZ);</span>

<span class="nc bnc" id="L430" title="All 2 branches missed.">		for (FlexRequestMakeup makeup : toReq.getFlexRequestMakeupList()) {</span>
			// Makeup before shift
<span class="nc bnc" id="L432" title="All 2 branches missed.">			if (makeup.getExtBeforeActivityID() != null) {</span>
<span class="nc" id="L433">				cal.setTime(makeup.getShiftStartTime());</span>
<span class="nc" id="L434">				cal.add(Calendar.MINUTE, - (makeup.getExtBeforeGap() + makeup.getExtBeforeDuration()));</span>
<span class="nc" id="L435">				Date start = cal.getTime();</span>
<span class="nc" id="L436">				cal.add(Calendar.MINUTE, makeup.getExtBeforeDuration());</span>
<span class="nc" id="L437">				Date end = cal.getTime();</span>
<span class="nc" id="L438">				createAndAppendXMLLocalizedFromForMakeUp(makeup.getExtBeforeActivityID(), start, end, makeUpsElem, userLocalizer, empTZ, userLocalizer);</span>
			}
			// Makeup within shift gaps
<span class="nc bnc" id="L441" title="All 2 branches missed.">			for (FlexReqMakeupGap gapMakeups: makeup.getFlexReqMakeupGaps()) {</span>
<span class="nc" id="L442">				cal.setTime(gapMakeups.getExtGapStartTime());</span>
<span class="nc" id="L443">				cal.add(Calendar.MINUTE, gapMakeups.getExtGapGap());</span>
<span class="nc" id="L444">				Date start = cal.getTime();</span>
<span class="nc" id="L445">				cal.add(Calendar.MINUTE, gapMakeups.getExtGapDuration());</span>
<span class="nc" id="L446">				Date end = cal.getTime();</span>
<span class="nc" id="L447">				createAndAppendXMLLocalizedFromForMakeUp(gapMakeups.getExtGapActivityID(), start, end, makeUpsElem, userLocalizer, empTZ, userLocalizer);</span>
<span class="nc" id="L448">			}</span>
			// Makeup after shift
<span class="nc bnc" id="L450" title="All 2 branches missed.">			if (makeup.getExtAfterActivityID() != null) {</span>
<span class="nc" id="L451">				cal.setTime(makeup.getShiftEndTime());</span>
<span class="nc" id="L452">				cal.add(Calendar.MINUTE, makeup.getExtAfterGap());</span>
<span class="nc" id="L453">				Date start = cal.getTime();</span>
<span class="nc" id="L454">				cal.add(Calendar.MINUTE, makeup.getExtAfterDuration());</span>
<span class="nc" id="L455">				Date end = cal.getTime();</span>
<span class="nc" id="L456">				createAndAppendXMLLocalizedFromForMakeUp(makeup.getExtAfterActivityID(), start, end, makeUpsElem, userLocalizer, empTZ, userLocalizer);</span>
			}
<span class="nc" id="L458">		}</span>
<span class="nc" id="L459">	}</span>

	private static void createAndAppendXMLLocalizedFromForMakeUp(ID activityId, Date start, Date end,
		Element parentElem, Localizer localizer, TimeZone empTZ, Localizer userLocalizer) 
				throws BbmObjectNotFoundException, BbmEJBCreateException, BbmFinderException, RemoteException {
<span class="nc" id="L464">		String actName = RequestUtil.getActivityNameByID(activityId);</span>

		//create &lt;makeup&gt; element
<span class="nc" id="L467">		Element makeUpElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, xmlElemMakeUp, null,</span>
<span class="nc" id="L468">				m_xmlAttrDescription, m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.FLEX_MAKEUP));</span>
		//create &lt;makeup start time&gt;
<span class="nc" id="L470">		RequestUtil.createElemAndAppendAsChild(makeUpElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L471">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.FLEX_MAKEUP_START_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L472">			userLocalizer.formatDateTime(start, empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;makeup end time&gt;
<span class="nc" id="L474">		RequestUtil.createElemAndAppendAsChild(makeUpElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L475">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.FLEX_MAKEUP_END_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L476">			userLocalizer.formatDateTime(end, empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;makeup activity&gt;
<span class="nc" id="L478">		RequestUtil.createElemAndAppendAsChild(makeUpElem, null, m_xmlElemActivity, null, m_xmlAttrDescription,</span>
<span class="nc" id="L479">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.FLEX_MAKEUP_ACTIVITY), m_xmlAttrValue, actName);</span>
<span class="nc" id="L480">	}</span>

	/**
	 * @param request
	 * @param rootElem
	 * @param localizer
	 * @param Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer
	 */
	private static void createAndAppendXMLLocalizedFromForCSReq(CustShiftReq csr, Element parentElem, Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer) throws Exception {

		//create &lt;employeename&gt;
<span class="nc" id="L491">		ID empID = csr.getEmployeeID();</span>
<span class="nc" id="L492">		TimeZone empTZ = getTimeZone(empID, mapIDToTZLocalizer);</span>
<span class="nc" id="L493">		Localizer userLocalizer = getLocalizer(empID, mapIDToTZLocalizer);</span>
<span class="nc" id="L494">		String empName = RequestUtil.getLocalizedEmpNameByID(empID, userLocalizer);</span>
<span class="nc" id="L495">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemEmployeeName, null, m_xmlAttrDescription,</span>
<span class="nc" id="L496">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.EMPLOYEE), m_xmlAttrValue, empName);</span>
<span class="nc" id="L497">		String reqSubType =m_rmEjbResBundleInAppDefLocale.getString(CustomShiftEJBUtil.getRequestSubTypeStringKey(csr.getSubType()));</span>
<span class="nc" id="L498">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemRequestType, null, m_xmlAttrDescription,</span>
<span class="nc" id="L499">				        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.REQUEST_TYPE_LABEL), m_xmlAttrValue, reqSubType);</span>



<span class="nc" id="L503">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L504">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.REQUEST_START_DATE), m_xmlAttrValue,</span>
<span class="nc" id="L505">		        userLocalizer.formatDateTime(csr.getCSRequestDisplayRange().getStartDate(), empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;shift&gt;&lt;endTime&gt; element
<span class="nc" id="L507">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L508">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.REQUEST_END_DATE), m_xmlAttrValue,</span>
<span class="nc" id="L509">		        userLocalizer.formatDateTime(csr.getCSRequestDisplayRange().getEndDate(), empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>

		// create &lt;shift&gt; element
<span class="nc" id="L512">		ID shiftID = csr.getShiftID();</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">		if (shiftID != null) {</span>
<span class="nc" id="L514">			createAndAppendXMLLocalizedShiftElementForCSReq(csr, parentElem, empTZ, userLocalizer);</span>
		}
		// create &lt;extensionbefore&gt; element
<span class="nc bnc" id="L517" title="All 2 branches missed.">		if (hasExtBefore(csr)) {</span>
<span class="nc" id="L518">			createAndAppendXMLLocalizedOvertimeElementForCSReq(csr, parentElem, userLocalizer,true);</span>
		}
		// create &lt;extensionduring&gt; element
<span class="nc bnc" id="L521" title="All 2 branches missed.">		if (hasExtDuring(csr)) {</span>
<span class="nc" id="L522">			createAndAppendXMLLocalizedExtDuringElementForCSReq(csr, parentElem,empTZ, userLocalizer);</span>
		}
		// create &lt;extensionafter&gt; element
<span class="nc bnc" id="L525" title="All 2 branches missed.">		if (hasExtAfter(csr)) {</span>
<span class="nc" id="L526">			createAndAppendXMLLocalizedOvertimeElementForCSReq(csr, parentElem, userLocalizer,false);</span>
		}
<span class="nc" id="L528">	}</span>

	/**
	 * @param rootElem
	 * @param request
	 * @boolean isSupervisor
	 */
	public static void createAndAppendXMLLocalizedFragForRequestURL(Element parentElem, RequestAggregate reqAgg, boolean isSupervisor) throws Exception {
<span class="nc bnc" id="L536" title="All 2 branches missed.">		String screen = isSupervisor?&quot;screen=AGENTS_REQUESTS&quot;:&quot;screen=MYSCHEDULE_REQUESTS&quot;;</span>
<span class="nc" id="L537">		String url = NetworkUtil.createURLToWebServerWithRequestHandler(&quot;signin&quot;, screen</span>
<span class="nc" id="L538">				+ &quot;&amp;reqID=&quot;+reqAgg.getID().toString() + &quot;&amp;requestType=&quot; + reqAgg.getRequestType());</span>

		//create &lt;url&gt; element
<span class="nc" id="L541">		RequestUtil.createElemAndAppendAsChild(parentElem, null, &quot;url&quot;, null, m_xmlAttrDescription,</span>
<span class="nc" id="L542">				m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.VIEW_REQUEST), m_xmlAttrValue, url);</span>
<span class="nc" id="L543">	}</span>

	/**
	 * @param toChoice
	 * @param parentElem
	 * @param localizer
	 * @param Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer
	 */
	private static void createAndAppendXMLLocalizedFromForTOChoice(TOChoice toChoice, ID empID, boolean isApproved,
		Element parentElem, Localizer localizer, Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer) {

<span class="nc" id="L554">		TimeZone empTZ = getTimeZone(empID, mapIDToTZLocalizer);</span>
<span class="nc" id="L555">		Localizer userLocalizer = getLocalizer(empID, mapIDToTZLocalizer);</span>

<span class="nc" id="L557">        String choiceDescription =null;</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">        if (isApproved) {</span>
<span class="nc" id="L559">            choiceDescription = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.APPROVED_CHOICE);</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">        } else if (toChoice.isWaitlist()) {</span>
<span class="nc" id="L561">            choiceDescription = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.WAITLISTED_CHOICE);</span>
        }else{
<span class="nc" id="L563">           choiceDescription = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.CHOICE);</span>
        }
		//create &lt;tochoice&gt; element
		//
		//Mark it as either &quot;Approved choice&quot; or &quot;choice&quot;
<span class="nc" id="L568">		Element toChoiceElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemTOChoice, null,</span>
<span class="nc" id="L569">			m_xmlAttrDescription,choiceDescription , m_xmlAttrValue, String.valueOf(toChoice.getUserRank()));</span>

		//create &lt;tochoice&gt;&lt;starttime&gt;
<span class="nc" id="L572">		RequestUtil.createElemAndAppendAsChild(toChoiceElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L573">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.START_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L574">			userLocalizer.formatDateTime(toChoice.getStartDate(), empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;tochoice&gt;&lt;endtime&gt;
<span class="nc" id="L576">		RequestUtil.createElemAndAppendAsChild(toChoiceElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L577">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.END_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L578">			userLocalizer.formatDateTime(toChoice.getEndDate(), empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>
<span class="nc" id="L579">	}</span>

	private static void createAndAppendXMLLocalizedFromForSSReq(ShiftSwapRequest ssReq, Element parentElem,
		Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer) throws Exception {

		// create &lt;swaptype&gt; element
<span class="nc" id="L585">		RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemSwapType, null, m_xmlAttrDescription,</span>
<span class="nc" id="L586">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SWAP_TYPE),</span>
<span class="nc" id="L587">			m_xmlAttrValue, getLocalizationSwapType(ssReq.getSwapType()));</span>

		// create &lt;swapitem&gt; elements
<span class="nc" id="L590">		List ssItems = ssReq.getShiftSwapItems();</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">		for (Iterator iter = ssItems.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L592">			ShiftSwapItem ssItem = (ShiftSwapItem) iter.next();</span>

<span class="nc" id="L594">			createAndAppendXMLLocalizedFragForSSItem(parentElem, ssItem, mapIDToTZLocalizer);</span>
<span class="nc" id="L595">		}</span>
<span class="nc" id="L596">	}</span>

	/**
	 * @param rootElement
	 * @param localizer
	 * @param Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer
	 * @return
	 */
	private static void createAndAppendXMLLocalizedFragForRequest(Request req, Element parentElem,
			Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer, String requestStatus) {

<span class="nc" id="L607">		ID empID = req.getEmployeeID();</span>
<span class="nc" id="L608">		TimeZone empTZ = getTimeZone(empID, mapIDToTZLocalizer);</span>
<span class="nc" id="L609">		Localizer userLocalizer = getLocalizer(empID, mapIDToTZLocalizer);</span>



		//create &lt;request&gt; element
<span class="nc" id="L614">		Element reqElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemRequest, null);</span>
		//create &lt;submittedon&gt; element
<span class="nc" id="L616">		Element submittedonElem = RequestUtil.createElemAndAppendAsChild(reqElem, null, m_xmlElemSubmittedOn, null,</span>
<span class="nc" id="L617">			m_xmlAttrDescription, m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SUBMITTED_ON), m_xmlAttrValue,</span>
<span class="nc" id="L618">			userLocalizer.formatDateTime(req.getSubmittedOn(), empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;status&gt; element
<span class="nc" id="L620">		Element statusElem = RequestUtil.createElemAndAppendAsChild(reqElem, null, m_xmlElemStatus, null,</span>
<span class="nc" id="L621">			m_xmlAttrDescription, m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.STATUS), m_xmlAttrValue,</span>
<span class="nc" id="L622">            m_rmEjbResBundleInAppDefLocale.getString(getBundleKey(requestStatus)));</span>
<span class="nc" id="L623">	}</span>

	/**
	 * @param ssItem
	 * @return
	 */
	private static Element createAndAppendXMLLocalizedFragForSSItem(Element parentElem, ShiftSwapItem ssItem,
		Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer) throws Exception {

		//get tz for employee;
<span class="nc" id="L633">		ID empID = ssItem.getEmployeeID();</span>
<span class="nc" id="L634">		TimeZone empTZ = getTimeZone(empID, mapIDToTZLocalizer);</span>
<span class="nc" id="L635">		Localizer userLocalizer = getLocalizer(empID, mapIDToTZLocalizer);</span>


<span class="nc" id="L638">		String empName = RequestUtil.getLocalizedEmpNameByID(empID, userLocalizer);</span>

		//create &lt;shiftswapitem&gt; element.
<span class="nc" id="L641">		Element ssitemElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, &quot;shiftswapitem&quot;, null);</span>
		//create &lt;shiftswapitem&gt;&lt;employeename&gt; element
<span class="nc" id="L643">		RequestUtil.createElemAndAppendAsChild(ssitemElem, null, m_xmlElemEmployeeName, null,</span>
<span class="nc" id="L644">			m_xmlAttrDescription, m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.EMPLOYEE), m_xmlAttrValue, empName);</span>
		//create &lt;shiftswapitem&gt;&lt;starttime&gt; element
<span class="nc" id="L646">		RequestUtil.createElemAndAppendAsChild(ssitemElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L647">		m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_START), m_xmlAttrValue,</span>
<span class="nc" id="L648">		userLocalizer.formatDateTime(ssItem.getStartDate(), empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;shiftswapitem&gt;&lt;endTime&gt; element
<span class="nc" id="L650">		RequestUtil.createElemAndAppendAsChild(ssitemElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L651">		m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_END), m_xmlAttrValue,</span>
<span class="nc" id="L652">		userLocalizer.formatDateTime(ssItem.getEndDate(), empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;shiftswapitem&gt;&lt;swaptype&gt; element
<span class="nc" id="L654">		RequestUtil.createElemAndAppendAsChild(ssitemElem, null, m_xmlElemSwapItemType, null, m_xmlAttrDescription,</span>
<span class="nc" id="L655">			m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SWAP_ITEM_TYPE), m_xmlAttrValue, getLocalizationShiftSwapType(ssItem.getShiftType()));</span>

<span class="nc" id="L657">		return ssitemElem;</span>
	}

	/* private methods used for customized messages */


	/**
	 * this function is duplicate with one in NotifiyDeliveryManager. It is put here for customized messages.
	 * The NotifiyDeliveryManager.java or Notification Framework should be changed for customized messages
	 * instead of coding here
    */
	public static HashMap getCustomizedMessagesMap(NotifyRule rule, ActionDetail actionDetail,
			WorkResourceManager wrm, RequestAggregate reqAgg, Element rootElem, DocumentBuilder parser, HashMap messageMap,
			Localizer localizer, Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer,  String requestStatus, boolean isEmailDelivery)
	throws BbmFinderException, RemoteException, IOException, SAXException, CoreFinderException, Exception {

<span class="nc bnc" id="L673" title="All 4 branches missed.">		if (actionDetail == null || actionDetail.getObjects().isEmpty())</span>
		 {
<span class="nc" id="L675">			return messageMap; //messageMap is used to collection messages, at any point, it can not be set to null.</span>
		}

<span class="nc" id="L678">		HashMap mapCustomizedMsg = messageMap;</span>

<span class="nc" id="L680">		Collection deliveries = rule.getDeliveryConfiguration();</span>
<span class="nc" id="L681">		NotifyRuleDelivery delivery = null;</span>
<span class="nc" id="L682">		NotifyMessageTarget target = null;</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">		for (Iterator i = deliveries.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L684">			delivery = (NotifyRuleDelivery)i.next();</span>
<span class="nc bnc" id="L685" title="All 4 branches missed.">			if (delivery.getDeliveryMediaID().equals(NotifyDeliveryMedia.NOTIFY_DELIVERY_MEDIA_EMAIL_ID) &amp;&amp; isEmailDelivery) {</span>
<span class="nc" id="L686">				target = delivery.getNotifyMessageTarget();</span>
<span class="nc" id="L687">				break;</span>
			}
<span class="nc bnc" id="L689" title="All 4 branches missed.">			if (delivery.getDeliveryMediaID().equals(NotifyDeliveryMedia.NOTIFY_DELIVERY_MEDIA_POPUP_ID) &amp;&amp; !isEmailDelivery) {</span>
<span class="nc" id="L690">				target = delivery.getNotifyMessageTarget();</span>
<span class="nc" id="L691">				break;</span>
			}
		}

<span class="nc bnc" id="L695" title="All 2 branches missed.">		if (target != null) {</span>
<span class="nc" id="L696">			UserManager userManager = CoreManagerFactory.getUserManager(false);</span>
			/* let's find all the employee names, we'll need them later */
<span class="nc" id="L698">			HashMap mapNames = wrm.getEmployeeNamesByIDs(actionDetail.getObjects());</span>

<span class="nc bnc" id="L700" title="All 2 branches missed.">			if (target.isEmployeeNotified()){</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">				for (Iterator it = actionDetail.getObjects().iterator(); it.hasNext();) {</span>
<span class="nc" id="L702">					ID workResourceID = (ID)it.next();</span>

<span class="nc" id="L704">					Element existingActionDetailForEmployee = (Element)mapCustomizedMsg.get(workResourceID);</span>

<span class="nc bnc" id="L706" title="All 2 branches missed.">					if (existingActionDetailForEmployee == null){</span>
						//create header and add to that
<span class="nc" id="L708">						Document doc = parser.newDocument();</span>
<span class="nc" id="L709">						existingActionDetailForEmployee = doc.createElement(xmlElementRequestStatusChange);</span>
<span class="nc" id="L710">						doc.appendChild(existingActionDetailForEmployee);</span>
					}

<span class="nc" id="L713">					Element thisDetail = getXMLLocalizedFrag(existingActionDetailForEmployee, reqAgg, null,</span>
							mapIDToTZLocalizer, requestStatus);
<span class="nc" id="L715">					NotificationUtil.createAndAppendXMLLocalizedFragForRequestURL(thisDetail, reqAgg, false);</span>

<span class="nc" id="L717">					mapCustomizedMsg.put(workResourceID, existingActionDetailForEmployee);</span>
<span class="nc" id="L718">				}</span>
			}
			// Direct supervisors
<span class="nc bnc" id="L721" title="All 2 branches missed.">			if (target.isManagerNotified()) {</span>
<span class="nc" id="L722">				HashMap mapEmployees = wrm.getEmployeesReportingSupervisors(actionDetail.getObjects(), null);</span>

<span class="nc" id="L724">				boolean isNotified = false;</span>
<span class="nc" id="L725">				ID oldSupervisorID = null;</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">				for (Iterator it = actionDetail.getObjects().iterator(); it.hasNext();) {</span>
<span class="nc" id="L727">					ID workResourceID = (ID) it.next();</span>
<span class="nc" id="L728">					ID supervisorID = (ID) mapEmployees.get(workResourceID);</span>

<span class="nc bnc" id="L730" title="All 2 branches missed.">					if (isNotified) {</span>
<span class="nc bnc" id="L731" title="All 4 branches missed.">						if (oldSupervisorID != null &amp;&amp; supervisorID.equals(oldSupervisorID)) {</span>
<span class="nc" id="L732">							continue;</span>
						}
					}

<span class="nc" id="L736">					oldSupervisorID = supervisorID;</span>
<span class="nc" id="L737">					isNotified = true;</span>

<span class="nc bnc" id="L739" title="All 2 branches missed.">					if (supervisorID != null) {</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">						if (!workResourceID.equals(supervisorID)) {</span>

<span class="nc" id="L742">							Element existingActionDetailForSupervisor = (Element)mapCustomizedMsg.get(supervisorID);</span>

<span class="nc bnc" id="L744" title="All 2 branches missed.">							if (existingActionDetailForSupervisor == null){</span>
								//create header and add to that
<span class="nc" id="L746">								Document doc = parser.newDocument();</span>
<span class="nc" id="L747">							existingActionDetailForSupervisor = doc.createElement(xmlElementRequestStatusChange);</span>
<span class="nc" id="L748">								doc.appendChild(existingActionDetailForSupervisor);</span>
							}

<span class="nc" id="L751">							Element thisDetail = getXMLLocalizedFrag(existingActionDetailForSupervisor, reqAgg, null,</span>
									mapIDToTZLocalizer, requestStatus);

<span class="nc" id="L754">							User supervisor = userManager.getUserByEmployeeID(supervisorID);</span>
<span class="nc bnc" id="L755" title="All 4 branches missed.">	        				if (supervisor != null &amp;&amp; isAuthorized(supervisor, reqAgg)) {</span>
	        					   // append employee's action detail to supervisor's (with supervisor's privileges)
<span class="nc" id="L757">		        				   NotificationUtil.createAndAppendXMLLocalizedFragForRequestURL(thisDetail, reqAgg, true);</span>
	        				   }

<span class="nc" id="L760">							mapCustomizedMsg.put(supervisorID, existingActionDetailForSupervisor);</span>
    				   }
    			   }
<span class="nc" id="L763">    		   }</span>
    	   }

    	   // additional users by role
<span class="nc" id="L767">    	   HashSet setEmployeeIDs = new HashSet();</span>
<span class="nc" id="L768">    	   ID roleID = target.getRoleID();</span>
<span class="nc" id="L769">    	   Collection listUsers = null;</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">		   if (roleID != null) {</span>
<span class="nc" id="L771">			   	ArrayList scopes = new ArrayList(1);</span>
<span class="nc" id="L772">       			scopes.add(rule.getScopeID());</span>
<span class="nc" id="L773">				listUsers = userManager.getUsersHavingRoleDirectlyOnScope(roleID, scopes, Organization.SCOPE_TYPE);</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">				for (Iterator it = listUsers.iterator(); it.hasNext();) {</span>
<span class="nc" id="L775">					User user = (User) it.next();</span>
			        /*
				     * check that the user is associated with an employee,
				     * otherwise
				     */
<span class="nc" id="L780">			            ID employeeID = user.getEmployeeID();</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">			            if (employeeID == null) {</span>
<span class="nc" id="L782">							continue;</span>
						}
<span class="nc" id="L784">			            setEmployeeIDs.add(employeeID);</span>
<span class="nc" id="L785">				}</span>
		   }

		   // additional users by login names
<span class="nc" id="L789">		   Collection listUserIDs = target.getUserIDs();</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">		   if (!listUserIDs.isEmpty()) {</span>
<span class="nc" id="L791">		       HashMap mapUsers = userManager.getUsersByIDs(listUserIDs);</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">		       for (Iterator it = mapUsers.values().iterator(); it.hasNext();) {</span>
<span class="nc" id="L793">		           User user = (User) it.next();</span>
		           /*
			        * check that the user is associated with an employee,
			        * otherwise
			        */
<span class="nc" id="L798">		           ID employeeID = user.getEmployeeID();</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">		           if (employeeID == null) {</span>
<span class="nc" id="L800">					continue;</span>
				}
<span class="nc" id="L802">		           setEmployeeIDs.add(employeeID);</span>
<span class="nc" id="L803">		       }</span>
		   }

<span class="nc bnc" id="L806" title="All 2 branches missed.">		   if (!setEmployeeIDs.isEmpty()) {</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">			   for (Iterator it = setEmployeeIDs.iterator(); it.hasNext();) {</span>
<span class="nc" id="L808">	                ID workResourceID = (ID) it.next();</span>
	                //if (!mapCustomizedMsg.containsKey(workResourceID)) {
<span class="nc" id="L810">	                	Element existingActionDetailForAddtionalUser = (Element)mapCustomizedMsg.get(workResourceID);</span>

<span class="nc bnc" id="L812" title="All 2 branches missed.">						if (existingActionDetailForAddtionalUser == null){</span>
							//create header and add to that
<span class="nc" id="L814">							Document doc = parser.newDocument();</span>
<span class="nc" id="L815">						existingActionDetailForAddtionalUser = doc.createElement(xmlElementRequestStatusChange);</span>
<span class="nc" id="L816">							doc.appendChild(existingActionDetailForAddtionalUser);</span>
						}

<span class="nc" id="L819">						Element thisDetail = getXMLLocalizedFrag(existingActionDetailForAddtionalUser, reqAgg, null,</span>
								mapIDToTZLocalizer, requestStatus);

<span class="nc" id="L822">						User additionalUser = userManager.getUserByEmployeeID(workResourceID);</span>

<span class="nc bnc" id="L824" title="All 4 branches missed.">	     				   if (additionalUser != null &amp;&amp; isAuthorized(additionalUser, reqAgg)) {</span>
	        				   // append employee's action detail to supervisor's (with supervisor's privileges)
<span class="nc" id="L826">	        				   NotificationUtil.createAndAppendXMLLocalizedFragForRequestURL(thisDetail, reqAgg, true);</span>
	    				   }
<span class="nc" id="L828">	                		mapCustomizedMsg.put(workResourceID, existingActionDetailForAddtionalUser);</span>
	               // }
<span class="nc" id="L830">			   }</span>

	    	}

		   	// Additional E-Mail targets (special target)
		   	// combine messages for all employees into one, no url in this case
<span class="nc" id="L836">		   	String specialTarget = target.getSpecialTargets();</span>
<span class="nc bnc" id="L837" title="All 4 branches missed.">	        if (specialTarget != null &amp;&amp; specialTarget.length() &gt; 0) {</span>

<span class="nc" id="L839">	        	Element existingActionDetailForSpecialTarget = (Element)mapCustomizedMsg.get(specialTarget);</span>

<span class="nc bnc" id="L841" title="All 2 branches missed.">				if (existingActionDetailForSpecialTarget == null){</span>
					//create header and add to that
<span class="nc" id="L843">					Document doc = parser.newDocument();</span>
<span class="nc" id="L844">					existingActionDetailForSpecialTarget = doc.createElement(xmlElementRequestStatusChange);</span>
<span class="nc" id="L845">					doc.appendChild(existingActionDetailForSpecialTarget);</span>
				}

<span class="nc" id="L848">				Element thisDetail = getXMLLocalizedFrag(existingActionDetailForSpecialTarget, reqAgg, null,</span>
						mapIDToTZLocalizer, requestStatus);

<span class="nc" id="L851">            		mapCustomizedMsg.put(specialTarget, existingActionDetailForSpecialTarget);</span>
	        }
		}
<span class="nc" id="L854">		return mapCustomizedMsg;</span>
	}

	public static Element xmlToElement (String stringXml) throws IOException, SAXException {
<span class="nc" id="L858">		DOMParser parser = new DOMParser();</span>
<span class="nc" id="L859">	    InputSource source = new InputSource(new StringReader(stringXml));</span>
<span class="nc" id="L860">	    parser.parse(source);</span>
<span class="nc" id="L861">	    Document doc = parser.getDocument();</span>
<span class="nc" id="L862">	    return doc.getDocumentElement();</span>
	}

	private static void appendCustomizedMessageNode(Element header, Document doc) throws BbmFinderException, RemoteException {
<span class="nc" id="L866">		NodeList nodeList = header.getElementsByTagName(NotifyRule.CUSTOMIZE_MESSAGE);</span>
<span class="nc bnc" id="L867" title="All 4 branches missed.">		if (nodeList == null || nodeList.getLength() == 0){ // no CUSTOMIZE_MESSAGE string in action detail</span>
<span class="nc" id="L868">			Node childNode = doc.createElement(NotifyRule.CUSTOMIZE_MESSAGE);</span>
<span class="nc" id="L869">			childNode.appendChild(doc.createTextNode(&quot;yes&quot;));</span>
<span class="nc" id="L870">			header.appendChild(childNode);</span>
		}
<span class="nc" id="L872">	}</span>


	public static boolean isAuthorized(User user, RequestAggregate reqAgg){
<span class="nc bnc" id="L876" title="All 2 branches missed.">		return (reqAgg.getRequestType().equals(Request.REQUESTTYPE_TIMEOFF) &amp;&amp;</span>
<span class="nc bnc" id="L877" title="All 2 branches missed.">						user.isAuthorized(PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE_ID)) ||</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">				(reqAgg.getRequestType().equals(Request.REQUESTTYPE_FLEXTIME) &amp;&amp;</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">						user.isAuthorized(PrivilegeKeys.FT_VIEWREQUESTSFOREMPLOYEE_ID)) ||</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">				(reqAgg.getRequestType().equals(Request.REQUESTTYPE_SHIFTSWAP) &amp;&amp;</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">						user.isAuthorized(PrivilegeKeys.SS_VIEWREQUESTSFOREMPLOYEE_ID)) ||</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">				(reqAgg.getRequestType().equals(Request.REQUESTTYPE_SHIFTBID) &amp;&amp;</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">						user.isAuthorized(PrivilegeKeys.SB_VIEWSHIFTBIDSFOREMP_ID))||</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">				(reqAgg.getRequestType().equals(Request.REQUESTTYPE_CUSTSHIFT) &amp;&amp;</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">						user.isAuthorized(PrivilegeKeys.CS_VIEWREQUESTSFOREMPLOYEE_ID));</span>
	}

	/**
	 * @param shift
	 * @return
	 */
	private static Element createAndAppendXMLLocalizedFragForCSItem(Element parentElem, ShiftAssignment shift,
	               Localizer localizer, Map&lt;ID, Pair&lt;TimeZone, Localizer&gt;&gt; mapIDToTZLocalizer, ID empID, String shiftType) 
	            		   throws Exception {//NOSONAR
		//create &lt;shift&gt; element.

<span class="nc" id="L897">		TimeZone empTZ = getTimeZone(empID, mapIDToTZLocalizer);</span>
<span class="nc" id="L898">		Localizer userLocalizer = getLocalizer(empID, mapIDToTZLocalizer);</span>

<span class="nc" id="L900">		Element shiftElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemShift, null);</span>
		//create &lt;shift&gt;&lt;CSType&gt; element
<span class="nc" id="L902">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemCSType, null, m_xmlAttrDescription,</span>
<span class="nc" id="L903">		        m_rmEjbResBundleInAppDefLocale.getString(shiftType), m_xmlAttrValue,&quot; &quot;);</span>

		//create &lt;shift&gt;&lt;starttime&gt; element
<span class="nc" id="L906">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L907">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_START), m_xmlAttrValue,</span>
<span class="nc" id="L908">		        userLocalizer.formatDateTime(shift.getStartTime(), empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>
		//create &lt;shift&gt;&lt;endTime&gt; element
<span class="nc" id="L910">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L911">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_END), m_xmlAttrValue,</span>
<span class="nc" id="L912">		        userLocalizer.formatDateTime(shift.getEndTime(), empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()));</span>

<span class="nc" id="L914">		return shiftElem;</span>
	}

	private static Element createAndAppendXMLLocalizedShiftElementForCSReq(CustShiftReq csr, Element parentElem,
		TimeZone empTZ, Localizer userLocalizer) throws Exception {
<span class="nc" id="L919">		Element shiftElem = null;</span>
<span class="nc" id="L920">		shiftElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemShift, null);</span>
		//&lt;shift&gt; element
<span class="nc" id="L922">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemCSType, null, m_xmlAttrDescription,</span>
<span class="nc" id="L923">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT), m_xmlAttrValue,&quot; &quot;);</span>

		//&lt;shift&gt;&lt;starttime&gt; element
<span class="nc" id="L926">		Date startTime = csr.getShiftStartTime();</span>
<span class="nc" id="L927">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemStartTime, null, m_xmlAttrDescription,</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_START_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L929">		        startTime != null ? userLocalizer.formatDateTime(startTime, empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()) : &quot;&quot;);</span>
		//&lt;shift&gt;&lt;endTime&gt; element
<span class="nc" id="L931">		Date endTime = csr.getShiftEndTime();</span>
<span class="nc" id="L932">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemEndTime, null, m_xmlAttrDescription,</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT_END_TIME), m_xmlAttrValue,</span>
<span class="nc" id="L934">		        endTime != null ? userLocalizer.formatDateTime(endTime, empTZ) + &quot; &quot; + userLocalizer.formatTimeZone(empTZ.getID()) : &quot;&quot;);</span>
		//&lt;duration&gt; element
<span class="nc" id="L936">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemDuration, null, m_xmlAttrDescription,</span>
<span class="nc" id="L937">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.DURATION), m_xmlAttrValue,</span>
<span class="nc" id="L938">		        userLocalizer.formatDurationInMins(csr.getShiftDurationinMinutes()));</span>
		//&lt;shift&gt; element
<span class="nc" id="L940">		WorkRuleManager wrm = WfmManagerFactory.getWorkRuleManager();</span>
<span class="nc" id="L941">		ID shiftID = csr.getShiftID();</span>
<span class="nc" id="L942">		Shift shift = null;</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">		if (shiftID != null) {</span>
<span class="nc" id="L944">			shift = wrm.getShift(shiftID);</span>
		}
<span class="nc" id="L946">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemShift, null, m_xmlAttrDescription,</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFT), m_xmlAttrValue,</span>
<span class="nc" id="L948">		        shift != null ? shift.getName(): &quot;&quot;);</span>
		//&lt;activity&gt; element
<span class="nc" id="L950">		ID activityID = csr.getActivityID();</span>
<span class="nc" id="L951">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemActivity, null, m_xmlAttrDescription,</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.ACTIVITY), m_xmlAttrValue,</span>
<span class="nc" id="L953">		        activityID != null ? RequestUtil.getActivityNameByID(activityID) : &quot;&quot;);</span>
		//&lt;overtime&gt; element
<span class="nc" id="L955">		RequestUtil.createElemAndAppendAsChild(shiftElem, null, m_xmlElemOvertime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L956">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.OVERTIME), m_xmlAttrValue,</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">		        csr.isOT() ? userLocalizer.i18n(m_rmEjbResBundleInAppDefLocale, RmEjbBundleKey.YES) :</span>
<span class="nc" id="L958">		        	userLocalizer.i18n(m_rmEjbResBundleInAppDefLocale,RmEjbBundleKey.NO));</span>

<span class="nc" id="L960">		return shiftElem;</span>
	}

	private static Element createAndAppendXMLLocalizedOvertimeElementForCSReq(CustShiftReq csr, Element parentElem,
			Localizer userLocalizer, boolean isBefore) throws Exception {
<span class="nc bnc" id="L965" title="All 2 branches missed.">		boolean hasExtension = isBefore ? hasExtBefore(csr) : hasExtAfter(csr);</span>

		// &lt;extension&gt; element
<span class="nc" id="L968">		Element extensionElem = null;</span>
<span class="nc" id="L969">		extensionElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemExtension, null);</span>
		// &lt;extensionbefore&gt; or &lt;extensionafter&gt; element
<span class="nc bnc" id="L971" title="All 2 branches missed.">		String extBeforeOrAfter = isBefore ? m_xmlElemOvertimeBefore : m_xmlElemOvertimeAfter;</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">		String bundleKey = isBefore ? RmEjbBundleKey.EXTENSION_BEFORE : RmEjbBundleKey.EXTENSION_AFTER;</span>
<span class="nc" id="L973">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, extBeforeOrAfter, null, m_xmlAttrDescription,</span>
<span class="nc" id="L974">		        m_rmEjbResBundleInAppDefLocale.getString(bundleKey), m_xmlAttrValue,&quot; &quot;);</span>

		// &lt;type&gt; element
<span class="nc" id="L977">		String extName = &quot;&quot;;</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">		if (hasExtension) {</span>
<span class="nc" id="L979">			ID otExtensionID = null;</span>
<span class="nc bnc" id="L980" title="All 2 branches missed.">			otExtensionID =	isBefore ? csr.getExtBeforeID() : csr.getExtAfterID();</span>
<span class="nc" id="L981">			WorkRuleManager wrm = WfmManagerFactory.getWorkRuleManager();</span>
<span class="nc" id="L982">			ShiftOTExtension sotExt = null;</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">			if (otExtensionID != null) {</span>
<span class="nc" id="L984">				sotExt = wrm.getShiftOTExtensionByID(otExtensionID);</span>
			}
<span class="nc bnc" id="L986" title="All 2 branches missed.">			if (sotExt != null) {</span>
<span class="nc" id="L987">				extName = sotExt.getName();</span>
			}
		}
<span class="nc" id="L990">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemType, null, m_xmlAttrDescription,</span>
<span class="nc" id="L991">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.TYPE), m_xmlAttrValue, extName);</span>
		// &lt;activity&gt; element
<span class="nc" id="L993">		String activityName = &quot;&quot;;</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">		if (hasExtension) {</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">			ID extActivityID = isBefore ? csr.getExtBeforeActivityID() : csr.getExtAfterActivityID();</span>
<span class="nc bnc" id="L996" title="All 2 branches missed.">			if (extActivityID != null) {</span>
<span class="nc" id="L997">				activityName = RequestUtil.getActivityNameByID(extActivityID);</span>
			}
		}
<span class="nc" id="L1000">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemActivity, null, m_xmlAttrDescription,</span>
<span class="nc" id="L1001">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.ACTIVITY), m_xmlAttrValue, activityName);</span>
		// &lt;duration&gt; element
<span class="nc" id="L1003">		String strDuration = &quot;&quot;;</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">		if (hasExtension) {</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">			int extDuration = isBefore ? csr.getExtBeforeDuration() : csr.getExtAfterDuration();</span>
<span class="nc" id="L1006">			strDuration = userLocalizer.formatDurationInMins(extDuration);</span>
		}
<span class="nc" id="L1008">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemDuration, null, m_xmlAttrDescription,</span>
<span class="nc" id="L1009">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.DURATION), m_xmlAttrValue, strDuration);</span>
		// &lt;gap&gt; element
<span class="nc" id="L1011">		String strGap = &quot;&quot;;</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">		if (hasExtension) {</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">			int extGap = isBefore ? csr.getExtBeforeGap() : csr.getExtAfterGap();</span>
<span class="nc" id="L1014">			strGap = userLocalizer.formatDurationInMins(extGap);</span>
		}
<span class="nc" id="L1016">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, xmlElemGap, null, m_xmlAttrDescription,</span>
<span class="nc" id="L1017">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.GAP), m_xmlAttrValue, strGap);</span>
		// &lt;overtime&gt; element
<span class="nc" id="L1019">		String strIsOT = &quot;&quot;;</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">		if (hasExtension) {</span>
<span class="nc bnc" id="L1021" title="All 2 branches missed.">			boolean isOT = isBefore ? csr.getExtBeforeIsOT() : csr.getExtAfterIsOT();</span>
<span class="nc bnc" id="L1022" title="All 2 branches missed.">			strIsOT = isOT ? userLocalizer.i18n(m_rmEjbResBundleInAppDefLocale, RmEjbBundleKey.YES) :</span>
<span class="nc" id="L1023">				userLocalizer.i18n(m_rmEjbResBundleInAppDefLocale,RmEjbBundleKey.NO);</span>
		}
<span class="nc" id="L1025">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemOvertime, null, m_xmlAttrDescription,</span>
<span class="nc" id="L1026">		        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.OVERTIME), m_xmlAttrValue, strIsOT);</span>


<span class="nc" id="L1029">		return extensionElem;</span>
	}

	private static Element createAndAppendXMLLocalizedExtDuringElementForCSReq(CustShiftReq csr, Element parentElem,
			TimeZone empTZ, Localizer userLocalizer) throws Exception {

		// &lt;extension&gt; element
<span class="nc" id="L1036">		Element extensionElem = RequestUtil.createElemAndAppendAsChild(parentElem, null, m_xmlElemExtension, null);</span>
		// &lt;extensionduring&gt; element
<span class="nc" id="L1038">		String bundleKey = RmEjbBundleKey.EXTENSION_DURING;</span>
<span class="nc" id="L1039">		RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemExtensionDuring, null, m_xmlAttrDescription,</span>
<span class="nc" id="L1040">		        m_rmEjbResBundleInAppDefLocale.getString(bundleKey), m_xmlAttrValue,&quot; &quot;);</span>

		// fetch the child object to build the extension during XML
<span class="nc" id="L1043">		Collection&lt;CustShiftReqGap&gt; gaps = csr.getChildObjects(CustShiftReqFieldInfo.CUSTREQGAP_CHILD_TYPE);</span>
		// in general, we support only one ext into each gap.
		// But adding for loop to support future enhancements (if any) to allow multiple requests into each gap
<span class="nc bnc" id="L1046" title="All 2 branches missed.">		for (CustShiftReqGap gap : gaps) {</span>

			// &lt;gap&gt; element
<span class="nc" id="L1049">			String strGap = &quot;&quot;;</span>
<span class="nc" id="L1050">			String start = userLocalizer.formatDate(new LocalDate(gap.getExtGapStartTime(),empTZ), RegionalFormatBundleKey.TIME_FORMAT);</span>
<span class="nc" id="L1051">			String end = userLocalizer.formatDate(new LocalDate(gap.getExtGapEndTime(),empTZ), RegionalFormatBundleKey.TIME_FORMAT);</span>
<span class="nc" id="L1052">			strGap = start + &quot; - &quot; + end;</span>

<span class="nc" id="L1054">			RequestUtil.createElemAndAppendAsChild(extensionElem, null, xmlElemGap, null, m_xmlAttrDescription,</span>
<span class="nc" id="L1055">			        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.GAP), m_xmlAttrValue, strGap);</span>
			// &lt;type&gt; element
<span class="nc" id="L1057">			String extName = &quot;&quot;;</span>
<span class="nc" id="L1058">			ID otExtensionID = gap.getShiftOTGapID();</span>
<span class="nc" id="L1059">			WorkRuleManager wrm = WfmManagerFactory.getWorkRuleManager();</span>
<span class="nc" id="L1060">			ShiftOTExtension sotExt = null;</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">			if (otExtensionID != null) {</span>
<span class="nc" id="L1062">				sotExt = wrm.getShiftOTExtensionByID(otExtensionID);</span>
			}
<span class="nc bnc" id="L1064" title="All 2 branches missed.">			if (sotExt != null) {</span>
<span class="nc" id="L1065">				extName = sotExt.getName();</span>
			}
<span class="nc" id="L1067">			RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemType, null, m_xmlAttrDescription,</span>
<span class="nc" id="L1068">			        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.TYPE), m_xmlAttrValue, extName);</span>
			// &lt;activity&gt; element
<span class="nc" id="L1070">			String activityName = RequestUtil.getActivityNameByID(gap.getExtGapActivityID());</span>
<span class="nc" id="L1071">			RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemActivity, null, m_xmlAttrDescription,</span>
<span class="nc" id="L1072">			        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.ACTIVITY), m_xmlAttrValue, activityName);</span>
			// &lt;duration&gt; element
<span class="nc" id="L1074">			RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemDuration, null, m_xmlAttrDescription,</span>
<span class="nc" id="L1075">			        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.DURATION), m_xmlAttrValue, userLocalizer.formatDurationInMins(gap.getExtGapDuration()));</span>
			// &lt;extensiongap&gt; element
<span class="nc" id="L1077">			RequestUtil.createElemAndAppendAsChild(extensionElem, null, m_xmlElemExtensionGap, null, m_xmlAttrDescription,</span>
<span class="nc" id="L1078">			        m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.EXTENSION_GAP), m_xmlAttrValue, userLocalizer.formatDurationInMins(gap.getExtGapGap()));</span>
<span class="nc" id="L1079">		}</span>

<span class="nc" id="L1081">		return extensionElem;</span>
	}

	/**
	 * Returns true if the CustShiftReq has a non-zero length extension before the shift,
	 * and a non-null Activity.
	 */
	private static boolean hasExtBefore(CustShiftReq csr) {
<span class="nc bnc" id="L1089" title="All 4 branches missed.">		if (csr.getExtBeforeDuration() == 0 || csr.getExtBeforeActivityID() == null) {</span>
<span class="nc" id="L1090">			return false;</span>
		}

<span class="nc" id="L1093">		return true;</span>
	}

	/**
	 * Returns true if the CustShiftReq has a non-zero length extension during the shift,
	 * and a non-null Activity.
	 */
	private static boolean hasExtDuring(CustShiftReq csr) {
<span class="nc bnc" id="L1101" title="All 2 branches missed.">		return !csr.getChildObjects(CustShiftReqFieldInfo.CUSTREQGAP_CHILD_TYPE).isEmpty();</span>
	}

	/**
	 * Returns true if the CustShiftReq has a non-zero length extension after the shift,
	 * and a non-null Activity.
	 */
	public static boolean hasExtAfter(CustShiftReq csr) {
<span class="nc bnc" id="L1109" title="All 4 branches missed.">		if (csr.getExtAfterDuration() == 0 || csr.getExtAfterActivityID() == null) {</span>
<span class="nc" id="L1110">			return false;</span>
		}

<span class="nc" id="L1113">		return true;</span>
	}

	public static String getLocalizationSwapType(String swapType) {
<span class="nc" id="L1117">		String i18NSwapType = &quot;&quot;;</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">		if (swapType.equals(ShiftSwapRequest.SHIFTSWAP_TYPE_ONEWAY)) {</span>
<span class="nc" id="L1119">			i18NSwapType = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SWAPTYPE_ONEWAY);</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">		} else if (swapType.equals(ShiftSwapRequest.SHIFTSWAP_TYPE_TWOWAY)) {</span>
<span class="nc" id="L1121">			i18NSwapType = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SWAPTYPE_TWOWAY);</span>
		}
<span class="nc" id="L1123">		return i18NSwapType;</span>
	}

	public static String getLocalizationShiftSwapType(String shiftSwapType) {
<span class="nc" id="L1127">		String i18NShiftSwapType = &quot;&quot;;</span>
<span class="nc bnc" id="L1128" title="All 2 branches missed.">		if (shiftSwapType.equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT)) {</span>
<span class="nc" id="L1129">			i18NShiftSwapType = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFTTYPE_SHIFT);</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">		} else if (shiftSwapType.equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF)) {</span>
<span class="nc" id="L1131">			i18NShiftSwapType = m_rmEjbResBundleInAppDefLocale.getString(RmEjbBundleKey.SHIFTTYPE_DAYOFF);</span>
		}

<span class="nc" id="L1134">		return i18NShiftSwapType;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>