<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SchedulingPeriodSelectorPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.campaign.sp</a> &gt; <span class="el_source">SchedulingPeriodSelectorPopupPM.java</span></div><h1>SchedulingPeriodSelectorPopupPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.campaign.sp;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.Iterator;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.helper.date.DatePickerPopupPM;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.verint.web.wfm.keys.WfmJavaScriptFileID;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.date.DateRangePickerPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.SelectorPopupWindowPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title:        SchedulingPeriodSelectorPopupPM
 * Description:  Page Model for Scheduling Period Selector
 * Copyright:    Copyright (c) 2003
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, DSu
 * @version      1.0
 *
 * Created on Oct 12, 2003, 5:13:26 PM
 */
public class SchedulingPeriodSelectorPopupPM extends SelectorPopupWindowPM {
<span class="nc" id="L53">	private static final Category LOG = Log.initCategory(SchedulingPeriodSelectorPopupPM.class.getName());</span>
<span class="nc" id="L54">	private static final Comparator&lt;SchedulingPeriod&gt; SP_COMPARATOR = new SchedulingPeriodComparator(SchedulingPeriodComparator.SORT_DESC);</span>

	private static final String AFTER_MAIN_JS = &quot;\n&quot; +
			&quot;function afterMain() {\n&quot; +
			&quot;  var spID = pageMediator.getOpenerHiddenValue();\n&quot; +
			&quot;  if (spID) &quot; + JSUtil.REFRESH_IGNORE_CHANGES + &quot;\n&quot; +
			&quot;}&quot;;

	private static final String SP_CHANGE_JS = &quot;pageMediator.handleSPChange(this);&quot;;
	private static final String POPUP_DATE_PICKER = &quot;POPUP_DATE_PICKER&quot;;

	private static final String SP_FN = &quot;sPID&quot;;
	private static final String CAMPAIGN_FN = &quot;campaignID&quot;;
	private static final String DATES_FN = &quot;dates&quot;;
	private static final String SDATE_FN = &quot;sDate&quot;;
	private static final String EDATE_FN = &quot;eDate&quot;;
	private static final String NEW_DATE_FN = &quot;newDate&quot;;
	private static final String SP_MODE_FN = SchedulingPeriodSelectorPC.SP_MODE_FN;
	private static final String IS_DATE_ENABLED_FN = SchedulingPeriodSelectorPC.IS_DATE_ENABLED_FN;
	private static final String CAMP_PRIV_ID_FN = SchedulingPeriodSelectorPC.CAMP_PRIV_ID_FN;

	private static final String SDATE_ARR = &quot;sDateArr&quot;;
	private static final String EDATE_ARR = &quot;eDateArr&quot;;
	private static final String IS_SELECTOR_INIT = &quot;isSelectorInit&quot;;

	private static final int SP_SIZE = 10;

	private final FormTwoColumnPC m_formPC;
	private final DatePickerPC m_dPC;
	private final DateRangePickerPC m_drPC;

	private ID m_spID;
	private ID m_camID;
	private ID m_camPrivID;
	private Date m_newDate;
	private LocalDate m_sDate;
	private LocalDate m_eDate;
<span class="nc" id="L91">	private int m_spMode = SchedulingPeriod.PastAndFuture;</span>
<span class="nc" id="L92">	private boolean m_isDateEnabled = true;</span>
<span class="nc" id="L93">	private boolean m_isSelectorInit = false;</span>
<span class="nc" id="L94">	private boolean m_isFoundSPforDate = false;</span>
<span class="nc" id="L95">	private boolean m_hasWarning = false;</span>
	private SchedulingPeriod m_sp;
	private TimeZone m_tz;
	private final ResourceBundle m_bbm_bundle;
<span class="nc" id="L99">	private Collection&lt;Campaign&gt; m_camList = Collections.emptyList();</span>
<span class="nc" id="L100">	private Collection&lt;SchedulingPeriod&gt; m_spList = Collections.emptyList();</span>

	/**
	 * Constructor
	 */
	public SchedulingPeriodSelectorPopupPM(RequestContext context) {
<span class="nc" id="L106">		super(context);</span>

<span class="nc" id="L108">		m_tz = context.getViewingTimeZone();</span>
<span class="nc" id="L109">		m_bbm_bundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L111">		m_formPC = new FormTwoColumnPC(context);</span>
<span class="nc" id="L112">		addChildComponent(m_formPC);</span>

<span class="nc" id="L114">		m_dPC = new DatePickerPC(context, null);</span>
<span class="nc" id="L115">		addChildComponent(m_dPC);</span>

<span class="nc" id="L117">		m_drPC = new DateRangePickerPC(context, DATES_FN);</span>
<span class="nc" id="L118">		addChildComponent(m_drPC);</span>

<span class="nc" id="L120">		init(getRequestHandler(),</span>
				WfmJavaScriptFileID.MEDIATOR_SP_SELECTOR,
				BbmWebBundleKey.BUNDLE_NAME,
				BbmWebBundleKey.SP_SELECTOR);
<span class="nc" id="L124">	}</span>

	protected String getRequestHandler() {
<span class="nc" id="L127">		return SchedulingPeriodSelectorPC.REQUEST_HANDLER;</span>
	}

	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L131">		return getInstance(context, SchedulingPeriodSelectorPopupPM.class);</span>
	}

	/**
	 * Initialize Component For Display
	 */
	@Override
	public void initForDisplay() {
<span class="nc bnc" id="L139" title="All 2 branches missed.">		if (m_isInitializedForDisplay) return;</span>
		else {
<span class="nc" id="L141">			super.initForDisplay();</span>

<span class="nc" id="L143">			addJSVariable(IS_DATE_ENABLED_FN, String.valueOf(m_isDateEnabled));</span>
<span class="nc" id="L144">			addGenericHTML(HtmlUtil.makeHiddenInput(IS_DATE_ENABLED_FN, m_isDateEnabled));</span>
<span class="nc" id="L145">			addGenericHTML(HtmlUtil.makeHiddenInput(SP_MODE_FN, m_spMode));</span>
<span class="nc" id="L146">			addGenericHTML(HtmlUtil.makeHiddenInput(CAMP_PRIV_ID_FN, m_camPrivID));</span>
<span class="nc" id="L147">			addGenericHTML(HtmlUtil.makeHiddenInput(IS_SELECTOR_INIT, m_isSelectorInit));</span>
<span class="nc" id="L148">			addGenericHTML(HtmlUtil.makeHiddenInput(SDATE_FN, &quot;&quot;));</span>
<span class="nc" id="L149">			addGenericHTML(HtmlUtil.makeHiddenInput(EDATE_FN, &quot;&quot;));</span>

			// Keep track of Selected Date
<span class="nc" id="L152">			long iNewDate = getNewDate();</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">			String sNewDate = iNewDate&gt;0 ? String.valueOf(iNewDate) : &quot;&quot;;</span>
<span class="nc" id="L154">			addGenericHTML(HtmlUtil.makeHiddenInput(NEW_DATE_FN, sNewDate));</span>

<span class="nc" id="L156">			DatePickerPopupPM.addPopupArg(this, POPUP_DATE_PICKER, PageAction.REFRESH, NEW_DATE_FN);</span>

			// Generate Warning that no SP available for selected Date
<span class="nc bnc" id="L159" title="All 4 branches missed.">			if (m_newDate!=null &amp;&amp; !m_isFoundSPforDate) {</span>
<span class="nc" id="L160">				String dateDsp = m_localizer.formatDate(m_newDate,</span>
						TimeZoneUtil.GMT_TIMEZONE, RegionalFormatBundleKey.DATE_FORMAT); 
<span class="nc" id="L162">				addPageMessage(Message.WARNING_TYPE, BbmWebBundleKey.NO_SP_FOR_DATE,</span>
						BbmWebBundleKey.BUNDLE_NAME, new String[]{dateDsp});
			}
		}
<span class="nc" id="L166">	}</span>

	/**
	 * Reset Scheduling Period Information
	 */
	private void resetSPInfo() {
<span class="nc" id="L172">		m_sDate = null;</span>
<span class="nc" id="L173">		m_eDate = null;</span>
<span class="nc" id="L174">		m_spID = null;</span>
<span class="nc" id="L175">		m_sp = null;</span>
<span class="nc" id="L176">	}</span>

	/**
	 * Initialize Model with Data
	 */
	@Override
	protected void initializeModel() {
<span class="nc bnc" id="L183" title="All 2 branches missed.">		if (m_isInitialized) return; else m_isInitialized = true;</span>

		try {
<span class="nc bnc" id="L186" title="All 2 branches missed.">			if (m_newDate!=null) {</span>
				// Other date is selected therefore need to reset some values
<span class="nc" id="L188">				resetSPInfo();</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">			} else if (m_spID!=null) {</span>
<span class="nc" id="L190">				m_sp = CampaignModelHandler.getSchedulingPeriodByID(m_context, m_spID);</span>
			}

			// Load Campaign List filtered by privilege if available otherwise use default (FS_VIEWCAMPAIGN_ID)
<span class="nc bnc" id="L194" title="All 2 branches missed.">			if (m_camPrivID==null) {</span>
<span class="nc" id="L195">				m_camList = CampaignModelHandler.getCampaignsForUser(m_context, m_context.getUser());</span>
			} else {
<span class="nc" id="L197">				Collection camIDList = m_context.getUser().getAuthorizedScopes(m_camPrivID, Campaign.SCOPE_TYPE);</span>
<span class="nc" id="L198">				m_camList = CampaignModelHandler.getCampaignsByIDs(m_context, camIDList);</span>
			}

			// Find Selected Campaign ID
<span class="nc bnc" id="L202" title="All 2 branches missed.">			if (m_camID==null) 	m_camID = findSelectedCampaignID(m_sp, m_camList);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">			if (m_camID!=null) {</span>
				// Get Selected Campaign Related Information
<span class="nc" id="L205">				Campaign campaign = findCampaign(m_camID, m_camList);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">				if (campaign!=null) m_tz = campaign.getTimeZone();</span>

<span class="nc" id="L208">				Date date = m_newDate;</span>
<span class="nc bnc" id="L209" title="All 4 branches missed.">				if (date==null) date = m_sp==null ? new Date() : m_sp.getStartTime();</span>
<span class="nc" id="L210">				m_spList = getSchedulingPeriods(date, SP_SIZE);</span>
			}
<span class="nc" id="L212">		} catch(Exception ex) {</span>
<span class="nc" id="L213">			handleUnableToLoadDataError(LOG, ex);</span>
		} finally {
<span class="nc" id="L215">			m_formPC.setIsBorderEnabled(true);</span>
<span class="nc" id="L216">			initCampaignRow();</span>
<span class="nc" id="L217">			initSPRow();</span>
<span class="nc" id="L218">			initDateRow();</span>
<span class="nc" id="L219">			setDisplayPC(m_formPC);</span>
<span class="nc" id="L220">		}</span>
<span class="nc" id="L221">	}</span>




	protected Collection&lt;SchedulingPeriod&gt; getSchedulingPeriods(Date date, int nNumberToGet) throws RemoteException, BbmException {
<span class="nc" id="L227">		return CampaignModelHandler.getSchedulingPeriods(m_context, m_camID, date, nNumberToGet, m_spMode);</span>
	}

	@Override
	public String getCustomJavaScript() {
<span class="nc bnc" id="L232" title="All 4 branches missed.">		if (m_isSelectorInit || m_hasWarning) {</span>
<span class="nc" id="L233">			return super.getCustomJavaScript();</span>
		} else {
<span class="nc" id="L235">			return super.getCustomJavaScript() + AFTER_MAIN_JS;</span>
		}
	}

	/**
	 * Retrieve request parameters from request object to the page model object.
	 *
	 * Method naming convention must be &quot;setPARAM_NAME(...)&quot; where PARAM_NAME
	 * must be same name as form field parameter but with first letter uppercase.
	 *
	 * e.g form field name = &quot;userID&quot; then model must contain a method named
	 * setUserID(String id).
	 *
	 * NOTE: This method recurse through all sub-components
	 *
	 * @param request The HttpRequest
	 * @return true if no errors were encountered, otherwise false
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L255">		boolean success = super.extractParameters(request);</span>

<span class="nc bnc" id="L257" title="All 2 branches missed.">		if (m_spID != null) {</span>
<span class="nc" id="L258">			m_sDate = m_dPC.extractLocalDate(SDATE_FN);</span>
<span class="nc" id="L259">			m_eDate = m_dPC.extractLocalDate(EDATE_FN);</span>
		}

<span class="nc" id="L262">		return success;</span>
	}

	//////////////////////////////////////////////////////////////////////////////
	// Code to initialize Form Rows
	//////////////////////////////////////////////////////////////////////////////
	private void disableSetButton(String rbKey) {
<span class="nc bnc" id="L269" title="All 2 branches missed.">		if (isSetBtnEnabled()) {</span>
<span class="nc" id="L270">			addPageMessage(Message.WARNING_TYPE, rbKey,	BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L271">			setIsSetBtnEnabled(false);</span>
		}
<span class="nc" id="L273">		m_hasWarning = true;</span>
<span class="nc" id="L274">	}</span>

	private void initCampaignRow() {
<span class="nc" id="L277">		String campDD = &quot;&quot;;</span>

<span class="nc bnc" id="L279" title="All 2 branches missed.">		if (m_camList.isEmpty()) {</span>
<span class="nc" id="L280">			disableSetButton(BbmWebBundleKey.NO_CAMPAIGN_AVAIL);</span>
		} else {
<span class="nc bnc" id="L282" title="All 2 branches missed.">			String selectedID = m_camID==null?null:m_camID.toString();</span>
<span class="nc" id="L283">			Collection options = CampaignModelHandler.createDropDownValueList(m_camList, selectedID, m_localizer, true);</span>
<span class="nc" id="L284">			campDD = HtmlUtil.makeSelectInput(CAMPAIGN_FN, selectedID, JSUtil.REFRESH_IGNORE_CHANGES, options);</span>
		}

        // Jeff Thelen: Grab custom strings for GMT clients. This handles internationalization.
<span class="nc" id="L288">        m_formPC.addRow(verticalize(m_bbm_bundle, BbmWebBundleKey.CAMPAIGN),	campDD);</span>
<span class="nc" id="L289">	}</span>

	private void initSPRow() {
<span class="nc" id="L292">		String spDD=&quot;&quot;;</span>

<span class="nc bnc" id="L294" title="All 2 branches missed.">		if (m_spList.isEmpty()) {</span>
<span class="nc" id="L295">			disableSetButton(BbmWebBundleKey.NO_SP_FOR_CAMPAIGN);</span>
		} else {
<span class="nc" id="L297">			ArrayList&lt;SchedulingPeriod&gt; sortedSPList = new ArrayList&lt;SchedulingPeriod&gt;(m_spList);</span>
<span class="nc" id="L298">			Collections.sort(sortedSPList, SP_COMPARATOR);</span>

<span class="nc" id="L300">			StringBuffer sDateArrSB = new StringBuffer(100);</span>
<span class="nc" id="L301">			StringBuffer eDateArrSB = new StringBuffer(100);</span>

			// Find out selected ID
<span class="nc" id="L304">			String selectedID = null;</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">			if (hasMatchingSP(m_spID, m_spList)) {</span>
<span class="nc" id="L306">				selectedID = m_spID.toString();</span>
			} else {
<span class="nc" id="L308">				resetSPInfo();</span>
			}

<span class="nc" id="L311">			ArrayList&lt;StringsPair&gt; options = new ArrayList&lt;StringsPair&gt;(sortedSPList.size());</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">			for(Iterator&lt;SchedulingPeriod&gt; it=sortedSPList.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L313">				SchedulingPeriod sp = it.next();</span>

				// Add Date to Date Array
<span class="nc" id="L316">				appendSPDatesToDateArray(sp, sDateArrSB, eDateArrSB);</span>

				// Find selected Scheduling Period
<span class="nc bnc" id="L319" title="All 2 branches missed.">				if (m_sp == null) {</span>
<span class="nc" id="L320">					m_sp = sp;</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">				} else if (sp.getID().equals(m_spID)) {</span>
<span class="nc" id="L322">					m_sp = sp;</span>
				}

				// Create Option
<span class="nc" id="L326">				String key = sp.getID().toString();</span>
<span class="nc" id="L327">				String val = SchedulingPeriodUtil.getSPDisplay(sp, m_localizer, m_tz);</span>
<span class="nc" id="L328">				options.add(new StringsPair(key, val));</span>

				// Determine New selected SP based on Selected Date
<span class="nc bnc" id="L331" title="All 6 branches missed.">				if (!m_isFoundSPforDate &amp;&amp; m_newDate!=null &amp;&amp; isSelectedSP(sp, m_newDate)) {</span>
					// Keep the first one that is found
<span class="nc" id="L333">					selectedID = key;</span>
<span class="nc" id="L334">					m_isFoundSPforDate = true;</span>
<span class="nc" id="L335">					m_sp = sp;</span>
				}
<span class="nc" id="L337">			}</span>
<span class="nc" id="L338">			options.add(new StringsPair(POPUP_DATE_PICKER, i18n(m_bundle, BbmWebBundleKey.VIEW_OTHER_SP)));</span>
<span class="nc" id="L339">			spDD = HtmlUtil.makeSelectInput(SP_FN, selectedID, SP_CHANGE_JS, options);</span>

			// Add Date Array JavaScript Variables
<span class="nc" id="L342">			addJSDateArray(sDateArrSB, eDateArrSB);</span>
		}

<span class="nc" id="L345">		m_formPC.addRow(i18n(m_common_bundle, UIFWebBundleKey.SCHEDULE_PERIOD), spDD);</span>
<span class="nc" id="L346">	}</span>

	private static Calendar getDate(Date date, TimeZone tz) {
<span class="nc" id="L349">		Calendar tmpCal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L350">		tmpCal.setTime(date);</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">		if (tz.equals(TimeZoneUtil.GMT_TIMEZONE)) return tmpCal;</span>

<span class="nc" id="L353">		Calendar result = Calendar.getInstance(tz);</span>
<span class="nc" id="L354">		result.set(</span>
<span class="nc" id="L355">				tmpCal.get(Calendar.YEAR),</span>
<span class="nc" id="L356">				tmpCal.get(Calendar.MONTH),</span>
<span class="nc" id="L357">				tmpCal.get(Calendar.DAY_OF_MONTH),</span>
<span class="nc" id="L358">				tmpCal.get(Calendar.HOUR_OF_DAY),</span>
<span class="nc" id="L359">				tmpCal.get(Calendar.MINUTE),</span>
<span class="nc" id="L360">				tmpCal.get(Calendar.SECOND));</span>
<span class="nc" id="L361">		result.set(Calendar.MILLISECOND, tmpCal.get(Calendar.MILLISECOND));</span>
<span class="nc" id="L362">		return result;</span>
	}

	private boolean isSelectedSP(SchedulingPeriod sp, Date date) {
		// Convert selected Date to Campaign TZ to compare agains SP
<span class="nc" id="L367">		Calendar aCal = getDate(date, m_tz);</span>
<span class="nc" id="L368">		Calendar sCal = getDate(sp.getStartTime(), TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L369">		Calendar eCal = getDate(sp.getEndTime(), TimeZoneUtil.GMT_TIMEZONE);</span>

<span class="nc bnc" id="L371" title="All 4 branches missed.">		return (!aCal.before(sCal) &amp;&amp; !aCal.after(eCal));</span>
	}

	private void initDateRow() {
<span class="nc bnc" id="L375" title="All 2 branches missed.">		if (!m_spList.isEmpty()) {</span>
<span class="nc" id="L376">			Date lowerDate = m_sp.getStartTime();</span>
<span class="nc" id="L377">			Date upperDate = SchedulingPeriodUtil.getAdjustedSPEndDate(m_sp, m_tz);</span>

<span class="nc" id="L379">			LocalDate startDate = m_sDate;</span>
<span class="nc" id="L380">			LocalDate endDate = m_eDate;</span>
<span class="nc bnc" id="L381" title="All 4 branches missed.">			if (startDate==null || endDate==null) {</span>
				// Using SP Dates so Use Campaign Time Zone
<span class="nc" id="L383">				m_drPC.setTimeZone(m_tz);</span>
<span class="nc" id="L384">				m_drPC.getStartDatePickerPC().setDate(lowerDate);</span>
<span class="nc" id="L385">				m_drPC.getEndDatePickerPC().setDate(upperDate);</span>
			} else {
				// Using Passed Dates so Use GMT
<span class="nc" id="L388">				m_drPC.setTimeZone(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L389">				m_drPC.getStartDatePickerPC().setDate(startDate);</span>
<span class="nc" id="L390">				m_drPC.getEndDatePickerPC().setDate(endDate);</span>
			}

			// Lower and Upper limit is Campaign TZ
<span class="nc" id="L394">			m_drPC.setLowerAndUpperLimit(lowerDate, upperDate, m_tz);</span>
<span class="nc" id="L395">		} else {</span>
			// Do not show Date Range Picker is there is no SPs
<span class="nc" id="L397">			m_isDateEnabled = false;</span>
		}

<span class="nc" id="L400">		m_drPC.initForDisplay();</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">		if (m_isDateEnabled) {</span>
<span class="nc" id="L402">			m_formPC.addRow(i18n(m_common_bundle, UIFWebBundleKey.DATE_RANGE), m_drPC);</span>
		} else {
<span class="nc" id="L404">			StringBuffer sb = new StringBuffer(200);</span>
<span class="nc" id="L405">			sb.append(&quot;&lt;div style=\&quot;visibility:hidden\&quot;&gt;&quot;).append(m_drPC).append(&quot;&lt;/div&gt;&quot;);</span>
<span class="nc" id="L406">			addGenericHTML(sb.toString());</span>
		}
<span class="nc" id="L408">	}</span>

	//////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	//////////////////////////////////////////////////////////////////////////////
	/**
	 * Find Scheduling Period that matches specified spID otherwise return first
	 * available SP;
	 */
	private static boolean hasMatchingSP(ID spID, Collection&lt;SchedulingPeriod&gt; spList) {
<span class="nc" id="L418">		boolean result = false;</span>

<span class="nc bnc" id="L420" title="All 2 branches missed.">		for(Iterator&lt;SchedulingPeriod&gt; it = spList.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L421">			SchedulingPeriod sp = it.next();</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">			if (sp.getID().equals(spID)) {</span>
<span class="nc" id="L423">				result = true;</span>
<span class="nc" id="L424">				break;</span>
			}
<span class="nc" id="L426">		}</span>

<span class="nc" id="L428">		return result;</span>
	}

	/**
	 * Generate Date Arrays so that Selecting SP will use this date values
	 * to populate selector from opener
	 */
	private void addJSDateArray(StringBuffer sDateArrSB, StringBuffer eDateArrSB) {
<span class="nc" id="L436">		sDateArrSB.insert(0, &quot;new Array(&quot;);</span>
<span class="nc" id="L437">		eDateArrSB.insert(0, &quot;new Array(&quot;);</span>
<span class="nc" id="L438">		sDateArrSB.append(&quot;)&quot;);</span>
<span class="nc" id="L439">		eDateArrSB.append(&quot;)&quot;);</span>

<span class="nc" id="L441">		addJSVariable(SDATE_ARR, sDateArrSB.toString());</span>
<span class="nc" id="L442">		addJSVariable(EDATE_ARR, eDateArrSB.toString());</span>
<span class="nc" id="L443">	}</span>

	private void appendSPDatesToDateArray(SchedulingPeriod sp,
			StringBuffer sDateArrSB, StringBuffer eDateArrSB) {
<span class="nc" id="L447">		Date sDate = sp.getStartTime();</span>
<span class="nc" id="L448">		Date eDate = SchedulingPeriodUtil.getAdjustedSPEndDate(sp, m_tz);</span>
<span class="nc" id="L449">		String sDateStr = convertToString(sDate);</span>
<span class="nc" id="L450">		String eDateStr = convertToString(eDate);</span>

<span class="nc bnc" id="L452" title="All 2 branches missed.">		if (sDateArrSB.length()!=0) sDateArrSB.append(&quot;,&quot;);</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">		if (eDateArrSB.length()!=0) eDateArrSB.append(&quot;,&quot;);</span>

<span class="nc" id="L455">		sDateArrSB.append(&quot;'&quot;).append(sDateStr).append(&quot;'&quot;);</span>
<span class="nc" id="L456">		eDateArrSB.append(&quot;'&quot;).append(eDateStr).append(&quot;'&quot;);</span>
<span class="nc" id="L457">	}</span>

	private String convertToString(Date date) {
<span class="nc bnc" id="L460" title="All 2 branches missed.">		if (date==null) return &quot;&quot;;</span>

<span class="nc" id="L462">		m_dPC.setTimeZone(m_tz);</span>
<span class="nc" id="L463">		m_dPC.setDate(date);</span>
<span class="nc" id="L464">		m_dPC.initForDisplay();</span>
<span class="nc" id="L465">		return m_dPC.getDateDisplay();</span>
	}


	private static ID findSelectedCampaignID(SchedulingPeriod sp, Collection&lt;Campaign&gt; camList) {
<span class="nc" id="L470">		ID camID = null;</span>

<span class="nc bnc" id="L472" title="All 2 branches missed.">		if (sp!=null) {</span>
<span class="nc" id="L473">			camID = sp.getCampaignID();</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">		} else if (!camList.isEmpty()) {</span>
<span class="nc" id="L475">			Campaign campaign = camList.iterator().next();</span>
<span class="nc" id="L476">			camID = campaign.getID();</span>
		}

<span class="nc" id="L479">		return camID;</span>
	}

	private static Campaign findCampaign(ID campaignID, Collection&lt;Campaign&gt; camList) {
<span class="nc" id="L483">		Campaign campaign = null;</span>

<span class="nc bnc" id="L485" title="All 2 branches missed.">		for(Iterator&lt;Campaign&gt; it = camList.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L486">			Campaign tmp = it.next();</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">			if (campaignID.equals(tmp.getID())) {</span>
<span class="nc" id="L488">				campaign = tmp;</span>
<span class="nc" id="L489">				break;</span>
			}
<span class="nc" id="L491">		}</span>

<span class="nc" id="L493">		return campaign;</span>
	}

	//////////////////////////////////////////////////////////////////////////////
	// Setter/Getter
	//////////////////////////////////////////////////////////////////////////////
<span class="nc" id="L499">	public void setSPMode(int mode) { m_spMode = mode; }</span>
<span class="nc" id="L500">	public int getSPMode() { return m_spMode; }</span>

<span class="nc" id="L502">	public void setIsSelectorInit(boolean bValue) { m_isSelectorInit = bValue; }</span>
<span class="nc" id="L503">	public boolean getIsSelectorInit() { return m_isSelectorInit; }</span>

<span class="nc" id="L505">	public void setSPID(ID id) { m_spID = id; }</span>
<span class="nc" id="L506">	public ID getSPID() { return m_spID; }</span>

<span class="nc" id="L508">	public void setCampaignID(ID id) { m_camID = id;	}</span>
<span class="nc" id="L509">	public ID getCampaignID() { return m_camID; }</span>

<span class="nc" id="L511">	public void setCampPrivID(ID id) { m_camPrivID = id; }</span>
<span class="nc" id="L512">	public ID getCampPrivID() { return m_camPrivID; }</span>

<span class="nc" id="L514">	public void setIsDateEnabled(boolean bValue) { m_isDateEnabled = bValue; }</span>
<span class="nc" id="L515">	public boolean isDateEnabled() { return m_isDateEnabled; }</span>

<span class="nc" id="L517">	public void setNewDate(long value) { m_newDate = new Date(value); }</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">	public long getNewDate() { return (m_newDate!=null)? m_newDate.getTime() : -1; }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>