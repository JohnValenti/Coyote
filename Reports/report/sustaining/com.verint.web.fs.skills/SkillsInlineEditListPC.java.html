<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SkillsInlineEditListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.skills</a> &gt; <span class="el_source">SkillsInlineEditListPC.java</span></div><h1>SkillsInlineEditListPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.skills;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignmentFieldInfo;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.people.profile.ProfileAdminPC;
import com.bluepumpkin.web.bbm.people.profile.ProfilePageModel;
import com.bluepumpkin.web.bbm.skill.SkillModelHandler;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.fs.keys.FsJavaScriptFileID;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.workrules.assignment.EffectivityMultiColListPC;
import com.witness.web.uif.data.popup.PopupArgument;
import com.witness.web.uif.data.popup.PopupUtil;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.list.InsertableMultiColListPC;
import com.witness.web.uif.pagecomponent.picker.date.DateRangePickerPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpaneMultiColPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.SortUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.js.JSUtil;
import com.witness.web.uif.util.js.JSValidatorUtil;
import com.witness.web.uif.validator.InRangeFieldValidator;

import javax.servlet.http.HttpServletRequest;
import java.text.NumberFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.*;

//TODO: Because of the similarity between this class and WorkPatternInlineEditListPC, it is desirable to move a good portion of
//the logic into a base class.  Due to time constraints, this was not possible at time of creation.
public class SkillsInlineEditListPC extends EffectivityMultiColListPC {
	private static final long serialVersionUID = 1L;

	//key = employee ID, value = collection of skill assignments assigned to the employee in the view period
<span class="nc" id="L60">	private Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; assignmentMap = new HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt;();</span>
	//This is a collection of the assignments that are to be displayed in the list
	private Collection&lt;SkillAssignment&gt; displayedAssignments;
	//key = skill assignment ID, value = associated skill assignment
<span class="nc" id="L64">	private HashMap&lt;ID, SkillAssignment&gt; modifiedAssignments = new HashMap&lt;ID, SkillAssignment&gt;();</span>
	private Date viewStartDate;
	private Date viewEndDate;
	private SchedulingPeriod schedulingPeriod;
	private Campaign campaign;
	private boolean didTimePeriodChange;
<span class="nc" id="L70">	private StringBuffer jsInitCode = new StringBuffer();</span>
	private Collection&lt;ID&gt; selectedEmployeeIDs;
	private PageModel parentPageModel;

<span class="nc" id="L74">	private boolean isProficiencyVisible = true;</span>
<span class="nc" id="L75">	private boolean isProficiencyEditable = true;</span>

	/**
	 * Constructs a list which contains skill name, effective dates (rendered as start / end date pickers with a popup button
	 * for changing the dates), proficiency, priority, and classification controls.  Intended to be used to assign skills
	 * to employees and to modify assigned skills.
	 *
	 * @param context                - the request context
	 * @param name                   - name of this component
	 * @param assignmentMap          - key = employee id, value = collection of skill assigments for this employee.  Used to display
	 *                               previously assigned skills.
	 * @param viewStartDate          - Start date of the view period.  Assumes that the time component of the start date is adjusted to the
	 *                               day boundary of the campaign, if in campaign mode, otherwise it is at midnight GMT. FIXME: should be a local date
	 * @param viewEndDate            - End date of the view period.  Assumes that the time component of the end date is adjusted to the
	 *                               day boundary of the campaign, if in campaign mode, otherwise it is at midnight GMT. FIXME: should be a local date
	 * @param schedulingPeriod       - Selected scheduling period value object, if in campaign mode (can be null otherwise).
	 * @param campaign               - Selected campaign value object, if in campaign mode (can be null otherwise).
	 * @param didTimePeriodChange    - If the viewing time period changed (and hence we have a postback) we need to indicate this
	 *                               to the component so that it will avoid processing the updated skills information.
	 * @param selectedEmployeeIDs    - The list of employees that we are currently editing skill assignments for.
	 * @param parentPageModel        - Unforunately, components can not add their own JS validators, they need to be added to a page model.
	 *                               The page model containing this component should hand itself in so that the JS validators on this component can be rendered to
	 *                               the page.  This should be refactored and removed eventually.
	 * @param onPostRemoveRowBatchJS - JS code that is executed after a skill is removed from the list.
	 */
	public SkillsInlineEditListPC(RequestContext context, String name, Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; assignmentMap,
			Date viewStartDate, Date viewEndDate, SchedulingPeriod schedulingPeriod, Campaign campaign, boolean didTimePeriodChange,
			Collection&lt;ID&gt; selectedEmployeeIDs, PageModel parentPageModel, String onPostRemoveRowBatchJS,
			boolean isProficiencyEditable, boolean isProficiencyVisible) {
<span class="nc" id="L104">		super(context);</span>

<span class="nc" id="L106">		setName(name);</span>
<span class="nc" id="L107">		this.assignmentMap = assignmentMap;</span>
<span class="nc" id="L108">		this.viewStartDate = viewStartDate;</span>
<span class="nc" id="L109">		this.viewEndDate = viewEndDate;</span>
<span class="nc" id="L110">		this.schedulingPeriod = schedulingPeriod;</span>
<span class="nc" id="L111">		this.campaign = campaign;</span>
<span class="nc" id="L112">		this.didTimePeriodChange = didTimePeriodChange;</span>
<span class="nc" id="L113">		this.selectedEmployeeIDs = selectedEmployeeIDs;</span>
		//TODO: Yikes!  Right now, only the page model's validators get rendered to the page.
		//This should be refactored so that each component's validators are added to the page,
		// rather than having to pass in the page model.
<span class="nc" id="L117">		this.parentPageModel = parentPageModel;</span>

<span class="nc" id="L119">		this.isProficiencyVisible = isProficiencyVisible;</span>
<span class="nc" id="L120">		this.isProficiencyEditable = isProficiencyEditable;</span>

<span class="nc" id="L122">		ToolbarPC toolbar = new ToolbarPC(m_context);</span>
<span class="nc" id="L123">		toolbar.setName(&quot;skillsToolbar&quot;);</span>
<span class="nc" id="L124">		ToolbarTextButton addButton = toolbar.createPopupWindowButton(SkillsListPopupPM.POPUP_ID,</span>
<span class="nc" id="L125">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_ADD), true);</span>
<span class="nc" id="L126">		addButton.setAttribute(&quot;viewStartDate&quot;, Long.toString(viewStartDate.getTime()));</span>
<span class="nc" id="L127">		addButton.setAttribute(&quot;viewEndDate&quot;, Long.toString(viewEndDate.getTime()));</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">		if (schedulingPeriod != null) {</span>
<span class="nc" id="L129">			addButton.setAttribute(&quot;schedulingPeriodID&quot;, schedulingPeriod.getID().toString());</span>
		}
<span class="nc" id="L131">		addButton.setAttribute(&quot;onClick&quot;, getFilterJSForAddButton(getName(), toolbar.getName(),</span>
				SkillsListPopupPM.POPUP_ID));

<span class="nc" id="L134">		toolbar.addToolbarElement(addButton);</span>
<span class="nc" id="L135">		ToolbarTextButton removeButton = new ToolbarTextButton(toolbar, &quot;removeSkill&quot;,</span>
<span class="nc" id="L136">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_REMOVE),</span>
				InsertableMultiColListPC.REMOVE_ROW_BUTTON_ACTION, ToolbarTextButton.BLUE_BUTTON, false);
<span class="nc" id="L138">		toolbar.addToolbarElement(removeButton);</span>
<span class="nc" id="L139">		setOnPostRowRemoveBatchJS(onPostRemoveRowBatchJS);</span>

<span class="nc" id="L141">		setIsBorderEnabled(true);</span>
<span class="nc" id="L142">		setToolbar(toolbar);</span>

<span class="nc" id="L144">		addPopupArgs(SkillsListPopupPM.POPUP_ID, SkillsListPopupPM.FORM_ACTION, &quot;&quot;,</span>
				SkillsListPopupPM.POPUP_ARGS, &quot;1000,600,ctr,ctr&quot;, true, 1);

		//If we don't have any rows for the list on initial load, we still need to get the required
		// js files from the inline components that may be added dynamically
<span class="nc" id="L149">		ClassificationDropDownSelection dummyClassificationSelectionPC =</span>
<span class="nc" id="L150">				new ClassificationDropDownSelection(getRequestContext(),</span>
<span class="nc" id="L151">						getName() + &quot;_dummyClassificationSelectionPC&quot;);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">		for (String js : dummyClassificationSelectionPC.getRequireJavaScriptFiles()) {</span>
<span class="nc" id="L153">			addRequiredJavaScriptFile(js);</span>
<span class="nc" id="L154">		}</span>

<span class="nc" id="L156">		displayedAssignments = getSkillAssignmentsToDisplay();</span>

<span class="nc" id="L158">		extractParameters(m_context.getRequest());</span>
		//The DateFormat JS needs to be added because the date pickers on the page aren't adding it themselves for a
		// reason I could not determine.
<span class="nc" id="L161">		addRequiredJavaScriptFile(JavaScriptFileID.UTIL_DATETIMEFORMAT);</span>
<span class="nc" id="L162">		addRequiredJavaScriptFile(FsJavaScriptFileID.EFFECTIVITY_UTIL);</span>

		//We need to add these JS variables for the field validators to work properly
<span class="nc" id="L165">		JSValidatorUtil.addVDJSVars(this);</span>
<span class="nc" id="L166">	}</span>

	public String getJavaScriptInitCode() {
<span class="nc" id="L169">		StringBuffer js = new StringBuffer(super.getJavaScriptInitCode());</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">		if (getToolbar() != null) {</span>
<span class="nc" id="L171">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.setToolbar(&quot;).append(getToolbar().getName()).append(&quot;);&quot;);</span>
<span class="nc" id="L172">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.addButtonEnableAttribute('isDeleteable', 'removeSkill');\n&quot;);</span>
		}
<span class="nc" id="L174">		return js.toString();</span>
	}

<span class="nc" id="L177">	private boolean isHeaderInitialized = false;</span>

	private void initHeader() {
<span class="nc bnc" id="L180" title="All 2 branches missed.">		if (isHeaderInitialized) {</span>
<span class="nc" id="L181">			return;</span>
		}
<span class="nc" id="L183">		isHeaderInitialized = true;</span>

<span class="nc" id="L185">		TableHeaderPC header = getHeader();</span>
<span class="nc" id="L186">		Localizer localizer = m_context.getLocalizer();</span>
<span class="nc" id="L187">		header.addColumnHeaderData(FsWebBundleKey.SKILLNAME, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.SKILLNAME));</span>
<span class="nc" id="L188">		header.addColumnHeaderData(FsWebBundleKey.FS_START_DATE_END_DATE, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_START_DATE_END_DATE));</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">		if (isProficiencyVisible) {</span>
<span class="nc" id="L191">			header.addColumnHeaderData(FsWebBundleKey.EMPLOYEE_SKILL_PROFICIENCY, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.EMPLOYEE_SKILL_PROFICIENCY));</span>
		}

<span class="nc" id="L194">		header.addColumnHeaderData(FsWebBundleKey.EMPLOYEE_SKILL_PRIORITY, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.EMPLOYEE_SKILL_PRIORITY));</span>
<span class="nc" id="L195">		header.addColumnHeaderData(FsWebBundleKey.EMPLOYEE_SKILL_CLASSIFICATION, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.EMPLOYEE_SKILL_CLASSIFICATION));</span>
<span class="nc" id="L196">	}</span>

<span class="nc" id="L198">	private boolean isRowsInited = false;</span>

	private void initRows(boolean rebuildDisplayedAssignmentList) {
<span class="nc bnc" id="L201" title="All 4 branches missed.">		if (isRowsInited &amp;&amp; !rebuildDisplayedAssignmentList) {</span>
<span class="nc" id="L202">			return;</span>
		}
<span class="nc" id="L204">		isRowsInited = true;</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">		if (rebuildDisplayedAssignmentList) {</span>
<span class="nc" id="L207">			super.getListModel().clear();</span>
<span class="nc" id="L208">			displayedAssignments = getSkillAssignmentsToDisplay();</span>
		}

<span class="nc" id="L211">		List&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>

<span class="nc" id="L213">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">		for (SkillAssignment assignment : displayedAssignments) {</span>
<span class="nc" id="L215">			rows.add(getNodeData(assignment, false));</span>
<span class="nc" id="L216">			ids.add(assignment.getSkillID());</span>
<span class="nc" id="L217">		}</span>

		//Sort the rows by item name
<span class="nc" id="L220">		SortUtil.sort(rows, getHeader().getColumnIndexByName(FsWebBundleKey.SKILLNAME),</span>
<span class="nc" id="L221">				true, m_context.getLocalizer());</span>

<span class="nc" id="L223">		this.setRowIDs(StringUtil.createDelimitedString(ids.toArray(new ID[ids.size()])));</span>
<span class="nc" id="L224">	}</span>

	public String getRowHtml(SkillAssignment assignment) {
<span class="nc" id="L227">		StringBuffer html = new StringBuffer();</span>
<span class="nc" id="L228">		super.appendHtmlRowData(html, getNodeData(assignment, true), 0, 0);</span>
<span class="nc" id="L229">		html.append(HtmlUtil.makeHiddenInput(getPopupRadioOptionFN(getName(), assignment.getSkillID()), &quot;&quot;));</span>
<span class="nc" id="L230">		html.append(HtmlUtil.makeHiddenInput(getEditedStartDateFN(getName(), assignment.getSkillID()), &quot;&quot;));</span>
<span class="nc" id="L231">		html.append(HtmlUtil.makeHiddenInput(getEditedEndDateFN(getName(), assignment.getSkillID()), &quot;&quot;));</span>

		//Create the javascript to instantiate the objects for the inline controls
<span class="nc" id="L234">		html.append(HtmlUtil.jsTag(jsInitCode.toString(), false));</span>
<span class="nc" id="L235">		jsInitCode.setLength(0);</span>

<span class="nc" id="L237">		return html.toString();</span>
	}

	protected DefaultMultiColumnNodeData getNodeData(SkillAssignment assignment, boolean isAjaxRequest) {
<span class="nc" id="L241">		DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(</span>
<span class="nc" id="L242">				assignment.getSkillID().toString());</span>

		//Name
<span class="nc bnc" id="L245" title="All 2 branches missed.">		if (assignment.isMultiEditCommon()) {</span>
<span class="nc" id="L246">			nodeData.add(assignment.getSkill().getName());</span>
		} else {
<span class="nc" id="L248">			nodeData.add(MULTI_VALUE_DATA + assignment.getSkill().getName());</span>
		}

		//Proficiency if field is visible/editable.

<span class="nc" id="L253">		FormInputPC proficiencyPC = getProficiencyPC(assignment);</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">		if (isProficiencyVisible) {</span>
<span class="nc" id="L255">			InRangeFieldValidator proficiencyValidator = new InRangeFieldValidator(this,</span>
<span class="nc" id="L256">					getProficiencyPCName(getName(), assignment.getSkillID()),</span>
					FsWebBundleKey.EMPLOYEE_SKILL_PROFICIENCY, FsWebBundleKey.BUNDLE_NAME, 0.00, 9.9);
<span class="nc" id="L258">			proficiencyValidator.setValidateClientSideOnly(true);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">			if (isAjaxRequest) {</span>
<span class="nc" id="L260">				jsInitCode.append(JSValidatorUtil.getAddFieldValidatorJS(proficiencyValidator, m_localizer));</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">			} else if (parentPageModel != null) {</span>
<span class="nc" id="L262">				parentPageModel.addValidator(proficiencyValidator);</span>
			}
<span class="nc" id="L264">			addChildComponent(proficiencyPC);</span>
		}
<span class="nc" id="L266">		proficiencyPC.setVisible(isProficiencyVisible);</span>

		//Priority
<span class="nc" id="L269">		FormInputPC priorityPC = getPriorityPC(assignment);</span>
<span class="nc" id="L270">		InRangeFieldValidator priorityValidator = new InRangeFieldValidator(this,</span>
<span class="nc" id="L271">				getPriorityPCName(getName(), assignment.getSkillID()),</span>
				FsWebBundleKey.EMPLOYEE_SKILL_PRIORITY, FsWebBundleKey.BUNDLE_NAME, 1, 99);
<span class="nc" id="L273">		priorityValidator.setValidateClientSideOnly(true);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">		if (isAjaxRequest) {</span>
<span class="nc" id="L275">			jsInitCode.append(JSValidatorUtil.getAddFieldValidatorJS(priorityValidator, m_localizer));</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">		} else if (parentPageModel != null) {</span>
<span class="nc" id="L277">			parentPageModel.addValidator(priorityValidator);</span>
		}
<span class="nc" id="L279">		addChildComponent(priorityPC);</span>

		//Classification
<span class="nc" id="L282">		ClassificationDropDownSelection classificationDDPC = getClassificationDDPC(assignment);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">		if (isAjaxRequest) {</span>
<span class="nc" id="L284">			jsInitCode.append(classificationDDPC.getJavaScriptInitCode());</span>
		}
<span class="nc" id="L286">		addChildComponent(classificationDDPC);</span>

		//Start / End Date control
<span class="nc" id="L289">		nodeData.add(getEffectiveDateControl(assignment, proficiencyPC, priorityPC, classificationDDPC));</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">		if (isProficiencyVisible) {</span>
<span class="nc" id="L291">			nodeData.add(proficiencyPC);</span>
		}
<span class="nc" id="L293">		nodeData.add(priorityPC);</span>
<span class="nc" id="L294">		nodeData.add(classificationDDPC);</span>

<span class="nc" id="L296">		setRowAttributes(nodeData, assignment);</span>
<span class="nc" id="L297">		return nodeData;</span>
	}

	protected void setRowAttributes(DefaultMultiColumnNodeData mcnd, SkillAssignment assignment) {
<span class="nc bnc" id="L301" title="All 2 branches missed.">		if (!assignment.isMultiEditCommon()) {</span>
<span class="nc" id="L302">			mcnd.setNodeAttribute(ROW_ATTRIBUTE_MULTI_EDIT_NOT_COMMON, String.valueOf(true));</span>
		}
<span class="nc" id="L304">		mcnd.setNodeAttribute(WorkpaneMultiColPM.IS_DELETEABLE, String.valueOf(true));</span>
<span class="nc" id="L305">		mcnd.setNodeAttribute(SkillsListPopupPM.POPUP_ARG_SKILL_ID, assignment.getSkillID().toString());</span>
<span class="nc bnc" id="L306" title="All 4 branches missed.">		if (assignment.getSkill().getMediaID().equals(Media.MEDIA_ID_CHAT) &amp;&amp; assignment.isMultiEditCommon()) {</span>
<span class="nc" id="L307">			mcnd.setNodeAttribute(&quot;isCommonChatSkill&quot;, String.valueOf(true));</span>
		}
<span class="nc" id="L309">		mcnd.setNodeAttribute(&quot;priorityFN&quot;, getPriorityPCName(getName(), assignment.getSkillID()));</span>
<span class="nc" id="L310">		mcnd.setNodeAttribute(&quot;proficiencyFN&quot;, getProficiencyPCName(getName(), assignment.getSkillID()));</span>
<span class="nc" id="L311">	}</span>

	private FormInputPC getProficiencyPC(SkillAssignment assignment) {
<span class="nc" id="L314">		FormInputPC prof_InputPC = new FormInputPC(m_context);</span>
<span class="nc" id="L315">		prof_InputPC.setAutoExtractParamEnabled(true);</span>
<span class="nc" id="L316">		prof_InputPC.setInputFN(getProficiencyPCName(getName(), assignment.getSkillID()));</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">		prof_InputPC.setIsReadOnly(!isProficiencyEditable);</span>
<span class="nc" id="L318">		prof_InputPC.setIsRequired(true);</span>
<span class="nc" id="L319">		prof_InputPC.setInputFieldDesc(FsWebBundleKey.EMPLOYEE_SKILL_PROFICIENCY, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L320">		prof_InputPC.setSize(5);</span>
		//If we are in campaign mode (i.e. have a scheduling period ID), then we need to force the
		//effective dates to snap to the SP view period when the drop down is changed.
<span class="nc bnc" id="L323" title="All 2 branches missed.">		if (schedulingPeriod != null) {</span>
<span class="nc" id="L324">			prof_InputPC.setOnChangeJS(&quot;EffectivityUtil.snapAssignmentEffectiveDatesToViewPeriod('&quot; +</span>
<span class="nc" id="L325">					getStartDateDisplay() + &quot;','&quot; +</span>
<span class="nc" id="L326">					getEndDateDisplay() + &quot;','&quot; +</span>
<span class="nc" id="L327">					getStartDatePCName(getName(), assignment.getSkillID()) + &quot;','&quot; +</span>
<span class="nc" id="L328">					getEndDatePCName(getName(), assignment.getSkillID()) + &quot;');&quot;);</span>
		}
<span class="nc" id="L330">		prof_InputPC.initForDisplay();</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">		if (didTimePeriodChange == false) {</span>
<span class="nc" id="L332">			prof_InputPC.extractParameters(m_context.getRequest());</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">			if (!MULTI_VALUE_DATA.equals(prof_InputPC.getInputValue())) {</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">				if (prof_InputPC.getInputValue() != null) {</span>

					double extractedProficiency;
<span class="nc" id="L337">					String proficiency = &quot;&quot;;</span>
					try {
<span class="nc" id="L339">						NumberFormat numberFormat = m_localizer.getNumberFormatter(1);</span>
<span class="nc" id="L340">						proficiency = prof_InputPC.getInputValue();</span>
<span class="nc" id="L341">						extractedProficiency = numberFormat.parse(proficiency).doubleValue();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">						if (extractedProficiency != assignment.getProficiency()) {</span>
<span class="nc" id="L343">							assignment.setProficiency(extractedProficiency);</span>
<span class="nc" id="L344">							assignment.setIsProficiencyModified(true);</span>
							//Only add to modified assignments if this is not a newly added assignment
<span class="nc bnc" id="L346" title="All 2 branches missed.">							if (assignment.getID() != null) {</span>
<span class="nc" id="L347">								modifiedAssignments.put(assignment.getID(), assignment);</span>
							}
						}
<span class="nc" id="L350">					} catch (ParseException ex) {</span>
<span class="nc" id="L351">						handleExtractParamException(&quot;SkillsInlineEditListPC.getProficiencyPC()&quot;, &quot;extractedProficiency&quot;, proficiency, ex);</span>
<span class="nc" id="L352">					}</span>


<span class="nc" id="L355">				} else {  //PC was null after extract params which means there was a new page load</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">					if (isProficiencyMultiEdit(assignment)) {</span>
<span class="nc" id="L357">						prof_InputPC.setInputValue(MULTI_VALUE_DATA);</span>
					} else {
<span class="nc" id="L359">						prof_InputPC.setInputValue(m_localizer.formatNumber(assignment.getProficiency(), 1));</span>
					}
				}
			}
		} else {  //Time period changed, do not extract params and load data from skill assignment
<span class="nc bnc" id="L364" title="All 2 branches missed.">			if (isProficiencyMultiEdit(assignment)) {</span>
<span class="nc" id="L365">				prof_InputPC.setInputValue(MULTI_VALUE_DATA);</span>
			} else {
<span class="nc" id="L367">				prof_InputPC.setInputValue(m_localizer.formatNumber(assignment.getProficiency(), 1));</span>
			}
		}
<span class="nc" id="L370">		return prof_InputPC;</span>
	}

	private FormInputPC getPriorityPC(SkillAssignment assignment) {
<span class="nc" id="L374">		FormInputPC priority_InputPC = new FormInputPC(m_context);</span>
<span class="nc" id="L375">		priority_InputPC.setAutoExtractParamEnabled(true);</span>
<span class="nc" id="L376">		priority_InputPC.setInputFN(getPriorityPCName(getName(), assignment.getSkillID()));</span>
<span class="nc" id="L377">		priority_InputPC.setIsReadOnly(false);</span>
<span class="nc" id="L378">		priority_InputPC.setIsRequired(true);</span>
<span class="nc" id="L379">		priority_InputPC.setInputFieldDesc(FsWebBundleKey.EMPLOYEE_SKILL_PRIORITY, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L380">		priority_InputPC.setSize(5);</span>
		//If we are in campaign mode (i.e. have a scheduling period ID), then we need to force the
		//effective dates to snap to the SP view period when the drop down is changed.
<span class="nc bnc" id="L383" title="All 2 branches missed.">		if (schedulingPeriod != null) {</span>
<span class="nc" id="L384">			priority_InputPC.setOnChangeJS(&quot;EffectivityUtil.snapAssignmentEffectiveDatesToViewPeriod('&quot; +</span>
<span class="nc" id="L385">					getStartDateDisplay() + &quot;','&quot; +</span>
<span class="nc" id="L386">					getEndDateDisplay() + &quot;','&quot; +</span>
<span class="nc" id="L387">					getStartDatePCName(getName(), assignment.getSkillID()) + &quot;','&quot; +</span>
<span class="nc" id="L388">					getEndDatePCName(getName(), assignment.getSkillID()) + &quot;');&quot;);</span>
		}
<span class="nc" id="L390">		priority_InputPC.initForDisplay();</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">		if (didTimePeriodChange == false) {</span>
<span class="nc" id="L392">			priority_InputPC.extractParameters(m_context.getRequest());</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">			if (!MULTI_VALUE_DATA.equals(priority_InputPC.getInputValue())) {</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">				if (priority_InputPC.getInputValue() != null) {</span>
<span class="nc" id="L395">					int extractedPriority = Integer.parseInt(priority_InputPC.getInputValue());</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">					if (extractedPriority != assignment.getPriority()) {</span>
<span class="nc" id="L397">						assignment.setPriority(extractedPriority);</span>
<span class="nc" id="L398">						assignment.setIsPriorityModified(true);</span>
						//Only add to modified assignments if this is not a newly added assignment
<span class="nc bnc" id="L400" title="All 2 branches missed.">						if (assignment.getID() != null) {</span>
<span class="nc" id="L401">							modifiedAssignments.put(assignment.getID(), assignment);</span>
						}
					}
<span class="nc" id="L404">				} else {  //PC was null after extract params which means there was a new page load</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">					if (isPriorityMultiEdit(assignment)) {</span>
<span class="nc" id="L406">						priority_InputPC.setInputValue(MULTI_VALUE_DATA);</span>
					} else {
<span class="nc" id="L408">						priority_InputPC.setInputValue(m_localizer.formatNumber(assignment.getPriority()));</span>
					}
				}
			}
		} else {  //Time period changed, do not extract params and load data from skill assignment
<span class="nc bnc" id="L413" title="All 2 branches missed.">			if (isPriorityMultiEdit(assignment)) {</span>
<span class="nc" id="L414">				priority_InputPC.setInputValue(MULTI_VALUE_DATA);</span>
			} else {
<span class="nc" id="L416">				priority_InputPC.setInputValue(m_localizer.formatNumber(assignment.getPriority()));</span>
			}
		}
<span class="nc" id="L419">		return priority_InputPC;</span>
	}

	/**
	 * Returns the classification drop down control as well as extracts the params from it if this happens to be a postback
	 */
	private ClassificationDropDownSelection getClassificationDDPC(SkillAssignment assignment) {
<span class="nc" id="L426">		ClassificationDropDownSelection classificationDDPC = new ClassificationDropDownSelection(</span>
<span class="nc" id="L427">				getRequestContext(), getClassificationDDPCName(getName(), assignment.getSkillID()));</span>

<span class="nc bnc" id="L429" title="All 2 branches missed.">		if (isClassificationMultiEdit(assignment)) {</span>
<span class="nc" id="L430">			classificationDDPC.setMultiEdit(true);</span>
		}

<span class="nc" id="L433">		classificationDDPC.extractParameters(getRequestContext().getRequest());</span>
<span class="nc bnc" id="L434" title="All 4 branches missed.">		if (classificationDDPC.isEdited() &amp;&amp; classificationDDPC.getSelections() != null &amp;&amp;</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">				!classificationDDPC.getSelections().isEmpty()) {</span>
<span class="nc" id="L436">			assignment.setIsClassificationModified(true);</span>
<span class="nc" id="L437">			classificationDDPC.setMultiEdit(false);</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">			if (modifiedAssignments.containsKey(assignment.getID())) {</span>
<span class="nc" id="L439">				modifiedAssignments.get(assignment.getID()).setClassification(</span>
<span class="nc" id="L440">						classificationDDPC.getSelections().iterator().next());</span>
			} else {
<span class="nc" id="L442">				assignment.setClassification(classificationDDPC.getSelections().iterator().next());</span>
				//Only add to modified assignments if this is not a newly added assignment
<span class="nc bnc" id="L444" title="All 2 branches missed.">				if (assignment.getID() != null) {</span>
<span class="nc" id="L445">					modifiedAssignments.put(assignment.getID(), assignment);</span>
				}
			}
		} else {
<span class="nc" id="L449">			classificationDDPC.setSelectedIDs(Collections.singleton(Integer.toString(assignment.getClassification())));</span>
		}

		//If we are in campaign mode (i.e. have a scheduling period ID), then we need to force the
		//effective dates to snap to the SP view period when the drop down is changed.
<span class="nc bnc" id="L454" title="All 2 branches missed.">		if (schedulingPeriod != null) {</span>
<span class="nc" id="L455">			classificationDDPC.setOnChangeJS(&quot;EffectivityUtil.snapAssignmentEffectiveDatesToViewPeriod('&quot; +</span>
<span class="nc" id="L456">					getStartDateDisplay() + &quot;','&quot; +</span>
<span class="nc" id="L457">					getEndDateDisplay() + &quot;','&quot; +</span>
<span class="nc" id="L458">					getStartDatePCName(getName(), assignment.getSkillID()) + &quot;','&quot; +</span>
<span class="nc" id="L459">					getEndDatePCName(getName(), assignment.getSkillID()) + &quot;');&quot;);</span>
		}
<span class="nc" id="L461">		return classificationDDPC;</span>
	}

	/**
	 * Returns the effective date control as well as extracts the params from it if this happens to be a postback
	 */
	private String getEffectiveDateControl(SkillAssignment assignment, FormInputPC proficiencyPC,
			FormInputPC priorityPC, ClassificationDropDownSelection classificationDDPC) {
<span class="nc" id="L469">		StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L470">		DateRangePickerPC dateRangePC = new DateRangePickerPC(getRequestContext(),</span>
<span class="nc" id="L471">				getDateRangePCName(getName(), assignment.getSkillID()));</span>
<span class="nc" id="L472">		dateRangePC.setTimeZone(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L473">		dateRangePC.setIsMultiValueSupported(true);</span>
<span class="nc" id="L474">		dateRangePC.setIsControlEnabled(false);</span>
<span class="nc" id="L475">		dateRangePC.getEndDatePickerPC().setIsDateValueInclusive(false);</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">		if (isStartDateMultiEdit(assignment)) {</span>
<span class="nc" id="L477">			dateRangePC.getStartDatePickerPC().setIsMultiValue(true);</span>
		} else {
<span class="nc" id="L479">			dateRangePC.getStartDatePickerPC().setDate(assignment.getLocalStartTime());</span>
		}
<span class="nc bnc" id="L481" title="All 2 branches missed.">		if (isEndDateMultiEdit(assignment)) {</span>
<span class="nc" id="L482">			dateRangePC.getEndDatePickerPC().setIsMultiValue(true);</span>
		} else {
<span class="nc bnc" id="L484" title="All 2 branches missed.">			if (assignment.getLocalEndTime() != null) {</span>
<span class="nc" id="L485">				LocalDate endDateDisplay = new LocalDate(assignment.getLocalEndTime());</span>
<span class="nc" id="L486">				adjustEndDateForDisplay(endDateDisplay);</span>
<span class="nc" id="L487">				dateRangePC.getEndDatePickerPC().setDate(endDateDisplay);</span>
			}
		}
<span class="nc" id="L490">		dateRangePC.getEndDatePickerPC().setIsDateValueOptional(true);</span>

<span class="nc bnc" id="L492" title="All 6 branches missed.">		if (classificationDDPC.isEdited() || assignment.isPriorityModified() || assignment.isProficiencyModified() ||</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">				assignment.getLocalStartTime() == null) {</span>
<span class="nc" id="L494">			dateRangePC.extractParameters(getRequestContext().getRequest());</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">			if (dateRangePC.getStartDatePickerPC().getLocalDate() != null) {</span>
<span class="nc" id="L496">				assignment.setLocalStartTime(dateRangePC.getStartDatePickerPC().getLocalDate());</span>
				//If after extracting the params the date is not null, this means a date has been input and it is no longer multi-value.
				//This should probably be done in the date picker itself but I don't know what the ramifications would be of changing it there.
<span class="nc" id="L499">				dateRangePC.getStartDatePickerPC().setIsMultiValue(false);</span>
			}
<span class="nc bnc" id="L501" title="All 2 branches missed.">			if (dateRangePC.getEndDatePickerPC().getLocalDate() != null) {</span>
<span class="nc" id="L502">				assignment.setLocalEndTime(dateRangePC.getEndDatePickerPC().getLocalDate());</span>
<span class="nc" id="L503">				dateRangePC.getEndDatePickerPC().setIsMultiValue(false);</span>
			} else {
<span class="nc" id="L505">				assignment.setLocalEndTime(null);</span>
			}
<span class="nc bnc" id="L507" title="All 2 branches missed.">			if (dateRangePC.getEndDatePickerPC().isMultiValue()) {</span>
<span class="nc" id="L508">				assignment.setFieldMultiValue(SkillAssignmentFieldInfo.SKILLASSIGNMENT_ENDTIME);</span>
			}
<span class="nc" id="L510">			classificationDDPC.setIsEdited(false);</span>
		}

<span class="nc" id="L513">		sb.append(makePopupEffDateBtn(assignment, proficiencyPC, priorityPC, classificationDDPC));</span>
<span class="nc" id="L514">		sb.append(dateRangePC.getHtmlDisplay());</span>
<span class="nc" id="L515">		return sb.toString();</span>
	}

	public String getHtmlDisplay() {
<span class="nc" id="L519">		StringBuffer html = new StringBuffer();</span>
<span class="nc" id="L520">		html.append(super.getHtmlDisplay());</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">		for (SkillAssignment assignment : displayedAssignments) {</span>
<span class="nc" id="L522">			html.append(HtmlUtil.makeHiddenInput(getPopupRadioOptionFN(getName(), assignment.getSkillID()), &quot;&quot;));</span>
<span class="nc" id="L523">			html.append(HtmlUtil.makeHiddenInput(getEditedStartDateFN(getName(), assignment.getSkillID()), &quot;&quot;));</span>
<span class="nc" id="L524">			html.append(HtmlUtil.makeHiddenInput(getEditedEndDateFN(getName(), assignment.getSkillID()), &quot;&quot;));</span>
<span class="nc" id="L525">		}</span>
<span class="nc" id="L526">		return html.toString();</span>
	}

<span class="nc" id="L529">	private boolean isExtracted = false;</span>

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc bnc" id="L533" title="All 2 branches missed.">		if (isExtracted) {</span>
<span class="nc" id="L534">			return true;</span>
		}
<span class="nc" id="L536">		isExtracted = true;</span>
<span class="nc" id="L537">		boolean retVal = true;</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">		if (didTimePeriodChange == false) {</span>
<span class="nc" id="L539">			retVal = super.extractParameters(request);</span>
		}

		// removed
<span class="nc bnc" id="L543" title="All 2 branches missed.">		for (ID removedID : getRemovedRowIDCollection()) {</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">			for (SkillAssignment assignment : displayedAssignments) {</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">				if (removedID.equals(assignment.getSkillID())) {</span>
<span class="nc" id="L546">					displayedAssignments.remove(assignment);</span>
<span class="nc" id="L547">					break;</span>
				}
<span class="nc" id="L549">			}</span>
<span class="nc" id="L550">		}</span>

		// added
		try {
<span class="nc" id="L554">			Collection&lt;ID&gt; addedIDs = getAddedRowIDCollection();</span>
			Collection&lt;Skill&gt; addedSkills;
<span class="nc bnc" id="L556" title="All 4 branches missed.">			if (addedIDs != null &amp;&amp; addedIDs.size() &gt; 0) {</span>
<span class="nc" id="L557">				addedSkills = SkillModelHandler.getSkillsByIDs(addedIDs);</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">				for (Skill skill : addedSkills) {</span>
<span class="nc" id="L559">					removeAssignmentFromList(skill.getID());    //we want to remove any existing assignments with the same ID as the newly added ones will trump these</span>
<span class="nc" id="L560">					SkillAssignment assignment = new SkillAssignment();</span>
					//Set the selected employees here because we will eventually be sending these IDs to the
					//  effectivity popup window so we can view employee history
<span class="nc" id="L563">					assignment.setMultiEditIDs(selectedEmployeeIDs);</span>
<span class="nc" id="L564">					assignment.setMultiEditCommon(true);</span>
<span class="nc" id="L565">					assignment.setSkillDEID(ID.fromString(skill.getIDStr()));</span>
<span class="nc" id="L566">					assignment.setSkillID(skill.getID());</span>
<span class="nc" id="L567">					assignment.setSkill(skill);</span>
<span class="nc" id="L568">					assignment.setProficiency(1.0);</span>
<span class="nc" id="L569">					assignment.setPriority(1);</span>
<span class="nc" id="L570">					assignment.setReserve(0);</span>
<span class="nc" id="L571">					displayedAssignments.add(assignment); // This will be updated in the initRows method call below</span>
<span class="nc" id="L572">				}</span>
			}
<span class="nc" id="L574">		} catch (Exception ex) {</span>
<span class="nc" id="L575">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L576">		}</span>

<span class="nc" id="L578">		initHeader();</span>
<span class="nc" id="L579">		initRows(false);</span>

<span class="nc" id="L581">		return retVal;</span>
	}

	/**
	 * Removes a skill assignment from the list of assigments with the given skill id
	 */
	private void removeAssignmentFromList(ID skillID) {
<span class="nc bnc" id="L588" title="All 2 branches missed.">		for (Iterator&lt;SkillAssignment&gt; iter = displayedAssignments.iterator(); iter.hasNext(); ) {</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">			if (iter.next().getSkillID().equals(skillID)) {</span>
<span class="nc" id="L590">				iter.remove();</span>
<span class="nc" id="L591">				break;</span>
			}
		}
<span class="nc" id="L594">	}</span>

	private String makePopupEffDateBtn(SkillAssignment assignment, FormInputPC proficiencyPC, FormInputPC priorityPC,
			ClassificationDropDownSelection classificationDDPC) {
<span class="nc" id="L598">		StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L600">		sb.append(HtmlUtil.imageTag(ImageFileID.EDIT, ImageFileID.EDIT_WIDTH,</span>
<span class="nc" id="L601">				ImageFileID.EDIT_HEIGHT, getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.EDIT),</span>
				false))
<span class="nc" id="L603">				.append(&quot; onClick=\&quot;&quot;).append(getToolbar().getName()).append(&quot;.onSelect('&quot;)</span>
<span class="nc" id="L604">				.append(getEffectivityPopupID(getName(), assignment.getSkillID())).append(&quot;',this)\&quot; &quot;).append(&quot;actionType=\&quot;POPUP_WINDOW_TYPE\&quot;&quot;);</span>

<span class="nc" id="L606">		sb.append(SkillsEffectivityPopupPM.ARG_EMPLOYEE_IDS).append(&quot;=\&quot;&quot;).append(</span>
<span class="nc" id="L607">				assignment.getMultiEditIDsInString()).append(&quot;\&quot; &quot;);</span>

<span class="nc" id="L609">		sb.append(SkillsEffectivityPopupPM.ARG_PROFICIENCY_FN).append(&quot;=\&quot;&quot;).append(</span>
<span class="nc" id="L610">				proficiencyPC.getInputFN()).append(&quot;\&quot; &quot;);</span>

		// proficiency visible and/or editable.
<span class="nc" id="L613">		sb.append(SkillsEffectivityPopupPM.ARG_IS_PROFICIENCY_VISIBLE).append(&quot;=\&quot;&quot;).append(</span>
<span class="nc" id="L614">				proficiencyPC.isVisible()).append(&quot;\&quot; &quot;);</span>
		;
<span class="nc" id="L616">		sb.append(SkillsEffectivityPopupPM.ARG_IS_PROFICIENCY_EDITABLE).append(&quot;=\&quot;&quot;).append(</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">				!proficiencyPC.isReadOnly()).append(&quot;\&quot; &quot;);</span>
		;

<span class="nc" id="L620">		sb.append(SkillsEffectivityPopupPM.ARG_PRIORITY_FN).append(&quot;=\&quot;&quot;).append(</span>
<span class="nc" id="L621">				priorityPC.getInputFN()).append(&quot;\&quot; &quot;);</span>
<span class="nc" id="L622">		sb.append(SkillsEffectivityPopupPM.ARG_CLASSIFICATION_DD_FN).append(&quot;=\&quot;&quot;).append(</span>
<span class="nc" id="L623">				classificationDDPC.getInputName()).append(&quot;\&quot; &quot;);</span>
<span class="nc" id="L624">		sb.append(SkillsEffectivityPopupPM.ARG_SKILL_ID).append(&quot;=\&quot;&quot;).append(</span>
<span class="nc" id="L625">				assignment.getSkillID()).append(&quot;\&quot; &quot;);</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">		if (schedulingPeriod != null) {</span>
<span class="nc" id="L627">			sb.append(SkillsEffectivityPopupPM.ARG_SCHEDULING_PERIOD_ID).append(&quot;=\&quot;&quot;).append(</span>
<span class="nc" id="L628">					schedulingPeriod.getID()).append(&quot;\&quot; &quot;);</span>
		}

		//Dates
<span class="nc" id="L632">		LocalDate viewEndLocalDate = new LocalDate(viewEndDate, TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L633">		viewEndLocalDate.add(Calendar.DAY_OF_YEAR, -1);</span>
<span class="nc" id="L634">		sb.append(SkillsEffectivityPopupPM.ARG_VIEW_END_DATE).append(&quot;=\&quot;&quot;).append(viewEndLocalDate.getTime(TimeZoneUtil.GMT_TIMEZONE).getTime()).append(&quot;\&quot; &quot;);</span>
		//Use the assignment start date if it isn't null.  In multi-edit scenarios it will be null,
		//  so we will use the viewStartDate in those cases.
<span class="nc bnc" id="L637" title="All 2 branches missed.">		if (assignment.getLocalStartTime() != null) {</span>
<span class="nc" id="L638">			sb.append(SkillsEffectivityPopupPM.ARG_CUR_PERIOD_START_DATE).append(&quot;=\&quot;&quot;).append(assignment.getLocalStartTime().getTime(TimeZoneUtil.GMT_TIMEZONE).getTime()).append(&quot;\&quot; &quot;);</span>
		} else {
<span class="nc" id="L640">			sb.append(SkillsEffectivityPopupPM.ARG_CUR_PERIOD_START_DATE).append(&quot;=\&quot;&quot;).append(viewStartDate.getTime()).append(&quot;\&quot; &quot;);</span>
		}
<span class="nc bnc" id="L642" title="All 2 branches missed.">		if (assignment.getLocalEndTime() != null) {</span>
<span class="nc" id="L643">			LocalDate curPeriodEndLocalDate = new LocalDate(assignment.getLocalEndTime());</span>
<span class="nc" id="L644">			curPeriodEndLocalDate.add(Calendar.DAY_OF_YEAR, -1);</span>
<span class="nc" id="L645">			sb.append(SkillsEffectivityPopupPM.ARG_CUR_PERIOD_END_DATE).append(&quot;=\&quot;&quot;).append(curPeriodEndLocalDate.getTime(TimeZoneUtil.GMT_TIMEZONE).getTime()).append(&quot;\&quot; &quot;);</span>
		}
<span class="nc" id="L647">		SimpleDateFormat sdf = new SimpleDateFormat(m_context.getLocalizer().getDateInputFormat(), m_context.getLocalizer().getLocaleContext().getRegionalFormatLocale());</span>
<span class="nc" id="L648">		sb.append(ProfilePageModel.SHOW_AS_DATE_FN).append(&quot;=\&quot;&quot;).append(sdf.format(viewStartDate)).append(&quot;\&quot; &quot;);</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">		if (assignment.getLocalStartTime() != null) {</span>
<span class="nc" id="L650">			sb.append(ProfileAdminPC.EFF_START_DATE_FN).append(&quot;=\&quot;&quot;).append(assignment.getLocalStartTime().getTime(TimeZoneUtil.GMT_TIMEZONE).getTime()).append(&quot;\&quot; &quot;);</span>
		} else {
<span class="nc" id="L652">			sb.append(ProfileAdminPC.EFF_START_DATE_FN).append(&quot;=\&quot;&quot;).append(viewStartDate.getTime()).append(&quot;\&quot; &quot;);</span>
		}

<span class="nc" id="L655">		sb.append(SkillsEffectivityPopupPM.ARG_PARENT_TABLE_NAME).append(&quot;=\&quot;&quot;).append(getName()).append(&quot;\&quot; &quot;);</span>

<span class="nc" id="L657">		sb.append(&quot;border=\&quot;0\&quot; align=\&quot;absmiddle\&quot; style=\&quot;&quot;).append(</span>
<span class="nc" id="L658">				CSSUtil.STYLE_CLICKABLE).append(&quot;\&quot;&gt;&quot;);</span>

<span class="nc" id="L660">		PopupArgument popupArg = addPopupArgs(getEffectivityPopupID(getName(), assignment.getSkillID()), SkillsEffectivityPopupPM.FORM_ACTION,</span>
<span class="nc" id="L661">				getPopupRadioOptionFN(getName(), assignment.getSkillID()) + &quot;,&quot; +</span>
<span class="nc" id="L662">						getEditedStartDateFN(getName(), assignment.getSkillID()) + &quot;,&quot; +</span>
<span class="nc" id="L663">						getEditedEndDateFN(getName(), assignment.getSkillID()) + &quot;,&quot; +</span>
<span class="nc" id="L664">						proficiencyPC.getInputFN() + &quot;,&quot; +</span>
<span class="nc" id="L665">						String.valueOf(proficiencyPC.isVisible()) + &quot;,&quot; +</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">						String.valueOf(!proficiencyPC.isReadOnly()) + &quot;,&quot; +</span>
<span class="nc" id="L667">						priorityPC.getInputFN() + &quot;,&quot; +</span>
<span class="nc" id="L668">						classificationDDPC.getInputName(),</span>
				SkillsEffectivityPopupPM.POPUP_ARGS + &quot;,&quot; + ProfilePageModel.SHOW_AS_DATE_FN + &quot;,&quot; +
						ProfileAdminPC.EFF_START_DATE_FN + &quot;,&quot; + ProfileAdminPC.EFF_END_DATE_FN,
				&quot;650,500,ctr,ctr&quot;, true, 1);
<span class="nc" id="L672">		jsInitCode.append(PopupUtil.getJSForPopupArg(popupArg));</span>

<span class="nc" id="L674">		return sb.toString();</span>
	}

	private static String getPCNamePrefix(String listName, ID skillID) {
<span class="nc" id="L678">		return listName + skillID.toString();</span>
	}

	private static String getDateRangePCName(String listName, ID skillID) {
<span class="nc" id="L682">		return JSUtil.getJSSuffix(getPCNamePrefix(listName, skillID) + &quot;_dateRangePC&quot;);</span>
	}

	public static String getClassificationDDPCName(String listName, ID skillID) {
<span class="nc" id="L686">		return JSUtil.getJSSuffix(getPCNamePrefix(listName, skillID) + &quot;_classificationDDPC&quot;);</span>
	}

	public static String getProficiencyPCName(String listName, ID skillID) {
<span class="nc" id="L690">		return JSUtil.getJSSuffix(getPCNamePrefix(listName, skillID) + &quot;_proficiencyPC&quot;);</span>
	}

	public static String getPriorityPCName(String listName, ID skillID) {
<span class="nc" id="L694">		return JSUtil.getJSSuffix(getPCNamePrefix(listName, skillID) + &quot;_priorityPC&quot;);</span>
	}

	public static String getStartDatePCName(String listName, ID skillID) {
<span class="nc" id="L698">		return DateRangePickerPC.createStartDateFN(getDateRangePCName(listName, skillID));</span>
	}

	public static String getEndDatePCName(String listName, ID skillID) {
<span class="nc" id="L702">		return DateRangePickerPC.createEndDateFN(getDateRangePCName(listName, skillID));</span>
	}

	public static String getPopupRadioOptionFN(String listName, ID skillID) {
<span class="nc" id="L706">		return listName + skillID.toString() + &quot;_radioOption&quot;;</span>
	}

	public static String getEditedStartDateFN(String listName, ID skillID) {
<span class="nc" id="L710">		return listName + skillID.toString() + &quot;_editedStartDateFN&quot;;</span>
	}

	public static String getEditedEndDateFN(String listName, ID skillID) {
<span class="nc" id="L714">		return listName + skillID.toString() + &quot;_editedEndDateFN&quot;;</span>
	}

	private String getEffectivityPopupID(String listName, ID skillID) {
<span class="nc" id="L718">		return SkillsEffectivityPopupPM.POPUP_ID + &quot;_&quot; + listName + &quot;_&quot; + skillID.toString();</span>
	}

	private boolean isStartDateMultiEdit(SkillAssignment assignment) {
<span class="nc" id="L722">		return assignment.isFieldMultiValue(</span>
				SkillAssignmentFieldInfo.SKILLASSIGNMENT_STARTTIME);
	}

	private boolean isEndDateMultiEdit(SkillAssignment assignment) {
<span class="nc" id="L727">		return assignment.isFieldMultiValue(</span>
				SkillAssignmentFieldInfo.SKILLASSIGNMENT_ENDTIME);
	}

	private boolean isProficiencyMultiEdit(SkillAssignment assignment) {
<span class="nc" id="L732">		return assignment.isFieldMultiValue(</span>
				SkillAssignmentFieldInfo.SKILLASSIGNMENT_PROFICIENCY);
	}

	private boolean isPriorityMultiEdit(SkillAssignment assignment) {
<span class="nc" id="L737">		return assignment.isFieldMultiValue(</span>
				SkillAssignmentFieldInfo.SKILLASSIGNMENT_PRIORITY);
	}

	private boolean isClassificationMultiEdit(SkillAssignment assignment) {
<span class="nc" id="L742">		return assignment.isFieldMultiValue(</span>
				SkillAssignmentFieldInfo.SKILLASSIGNMENT_RESERVELEVEL);
	}

	/**
	 * Saves the changes made to the assignments in the list.
	 */
	public boolean save(Map&lt;ID, Employee&gt; employeeMap)
			throws BbmException {
		try {
			//This map will contain the ids of the work patterns that have been removed from the list (in the keyset).
			//The value collection contains a pair of local dates representing the dates representing when the effective
			//  assignment was removed
<span class="nc" id="L755">			Map&lt;ID, Pair&lt;LocalDate, LocalDate&gt;&gt; removedAssignmentDates = getRemovedRowMetadata();</span>
			//The collection of assignments that are to be removed
<span class="nc" id="L757">			Collection&lt;SkillAssignment&gt; assignmentsToRemove = new ArrayList&lt;SkillAssignment&gt;();</span>
			//The collection of assignments that are to be added
<span class="nc" id="L759">			Collection&lt;SkillAssignment&gt; assignmentsToAdd = new ArrayList&lt;SkillAssignment&gt;();</span>

<span class="nc bnc" id="L761" title="All 2 branches missed.">			for (ID employeeID : assignmentMap.keySet()) {</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">				for (SkillAssignment assignment : assignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">					if (removedAssignmentDates.keySet().contains(assignment.getSkillID())) {</span>
<span class="nc" id="L764">						Pair&lt;LocalDate, LocalDate&gt; assignmentGapDates = removedAssignmentDates.get(assignment.getSkillID());</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">						if (assignmentGapDates == null) {  //First radio option (or remove button), remove assignment</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">							if (schedulingPeriod == null) {</span>
<span class="nc" id="L767">								assignmentsToRemove.add(assignment);</span>
							} else {
								// If in campaign mode, we need to remove this window and not the visible record.
<span class="nc" id="L770">								Employee emp = employeeMap.get(assignment.getWorkResourceID());</span>
								//Adjust the view dates by subtracting the campaign's day boundary.  The view dates
								//start/end at the time specified by the campaign's day boundary, but the skill assignments
								//are stored at midnight of the user org's time zone.
<span class="nc" id="L774">								LocalDate endDate = new LocalDate(viewEndDate, TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L775">								endDate.add(Calendar.MINUTE, -campaign.getDayBoundaryOffset());</span>
<span class="nc" id="L776">								LocalDate startDate = new LocalDate(viewStartDate, TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L777">								startDate.add(Calendar.MINUTE, -campaign.getDayBoundaryOffset());</span>
<span class="nc" id="L778">								SkillAssignment assignmentToSubtract = (SkillAssignment) assignment.clone();</span>
<span class="nc" id="L779">								assignmentToSubtract.setStartTime(startDate.getTime(emp.getTimeZone(viewStartDate)));</span>
<span class="nc" id="L780">								assignmentToSubtract.setEndTime(endDate.getTime(emp.getTimeZone(viewEndDate)));</span>
<span class="nc" id="L781">								adjustStartDateOfAssignmentToCoverStartOfViewPeriod(assignmentToSubtract, viewStartDate, campaign);</span>
<span class="nc" id="L782">								adjustEndDateOfAssignmentToLieInsideViewPeriod(assignmentToSubtract, viewEndDate, campaign);</span>
<span class="nc" id="L783">								assignmentsToRemove.add(assignmentToSubtract);</span>
<span class="nc" id="L784">							}</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">						} else if (assignmentGapDates.getSecond() == null) {</span>
							//3rd radio option, assignment ends at current date.  Create a new assignment with start date
							//  and null end date to &quot;subtract&quot; from user's assignments
<span class="nc" id="L788">							SkillAssignment assignmentToSubtract = (SkillAssignment) assignment.clone();</span>
<span class="nc" id="L789">							assignmentToSubtract.setStartTime(assignmentGapDates.getFirst().getTime(</span>
<span class="nc" id="L790">									employeeMap.get(assignment.getWorkResourceID()).getTimeZone(assignmentGapDates.getFirst())));</span>
<span class="nc" id="L791">							assignmentToSubtract.setEndTime(null);</span>
<span class="nc" id="L792">							assignmentsToRemove.add(assignmentToSubtract);</span>
<span class="nc" id="L793">						} else {  //2nd radio option, we need to create a new assignment with start/end dates that we will be &quot;subtracting&quot;</span>
<span class="nc" id="L794">							Employee emp = employeeMap.get(assignment.getWorkResourceID());</span>
<span class="nc" id="L795">							LocalDate subtractEndLocalDate = new LocalDate(assignmentGapDates.getSecond());</span>
							//Display end date, so effective assignment in DB is actually 1 day forward
<span class="nc" id="L797">							subtractEndLocalDate.add(Calendar.DATE, 1);</span>
<span class="nc" id="L798">							Date subtractEndDate = subtractEndLocalDate.getTime(emp.getTimeZone(assignmentGapDates.getSecond()));</span>
<span class="nc" id="L799">							SkillAssignment assignmentToSubtract = (SkillAssignment) assignment.clone();</span>
<span class="nc" id="L800">							assignmentToSubtract.setStartTime(assignmentGapDates.getFirst().getTime(</span>
<span class="nc" id="L801">									employeeMap.get(assignment.getWorkResourceID()).getTimeZone(assignmentGapDates.getFirst())));</span>
<span class="nc" id="L802">							assignmentToSubtract.setEndTime(subtractEndDate);</span>
<span class="nc" id="L803">							adjustStartDateOfAssignmentToCoverStartOfViewPeriod(assignmentToSubtract, viewStartDate, campaign);</span>
<span class="nc" id="L804">							adjustEndDateOfAssignmentToLieInsideViewPeriod(assignmentToSubtract, viewEndDate, campaign);</span>
<span class="nc" id="L805">							assignmentsToRemove.add(assignmentToSubtract);</span>
						}
					}
<span class="nc" id="L808">				}</span>
<span class="nc" id="L809">			}</span>

<span class="nc" id="L811">			assignmentsToAdd.addAll(getModifiedSkillAssignments(assignmentMap, employeeMap));</span>
<span class="nc" id="L812">			assignmentsToAdd.addAll(getAddedSkillAssignments(assignmentMap, employeeMap));</span>

<span class="nc" id="L814">			SkillsAssignmentMH.saveSkillAssignments(m_context, assignmentsToRemove, assignmentsToAdd);</span>
<span class="nc" id="L815">		} catch (Exception ex) {</span>
<span class="nc" id="L816">			throw new BbmException(ex);</span>
<span class="nc" id="L817">		}</span>

		//Clear out the removed/added IDs when finished to avoid saving/deleting duplicates
<span class="nc" id="L820">		setAddedRowIDs(&quot;&quot;);</span>
<span class="nc" id="L821">		setRemovedRowIDs(&quot;&quot;);</span>

<span class="nc" id="L823">		return true;</span>
	}

	private Collection&lt;SkillAssignment&gt; getAddedSkillAssignments(
			Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; skillAssignmentMap,
			Map&lt;ID, Employee&gt; employeeMap) throws BbmException {
		//Only one copy of each assignment is stored on the page (even if multiple employees are selected), so
		// we need to add the other assignments that will belong to every selected employee
<span class="nc" id="L831">		Collection&lt;SkillAssignment&gt; addedAssignments = getAddedSkillAssignments();</span>
<span class="nc" id="L832">		ArrayList&lt;SkillAssignment&gt; newAddedAssignments = new ArrayList&lt;SkillAssignment&gt;();</span>

		//We need to pull the work pattern assignments for the selected employees to see if any of these
		// newly assigned work patterns were previously assigned in the past.  If so, we set the start date
		// of this new assignment to the end date of the previous assignment.
<span class="nc" id="L837">		HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; pastSkillAssignments =</span>
<span class="nc" id="L838">				SkillsAssignmentMH.getSkillAssignmentsForEmployees(m_context,</span>
<span class="nc" id="L839">						new ArrayList&lt;ID&gt;(employeeMap.keySet()), null, viewEndDate);</span>

<span class="nc bnc" id="L841" title="All 2 branches missed.">		for (ID employeeID : skillAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">			for (SkillAssignment addedAssignment : addedAssignments) {</span>
<span class="nc" id="L843">				SkillAssignment assignment = new SkillAssignment();</span>
<span class="nc" id="L844">				assignment.setSkillID(addedAssignment.getSkillID());</span>
<span class="nc" id="L845">				assignment.setWorkResourceID(employeeID);</span>
<span class="nc" id="L846">				assignment.setPriority(addedAssignment.getPriority());</span>
<span class="nc" id="L847">				assignment.setProficiency(addedAssignment.getProficiency());</span>
<span class="nc" id="L848">				assignment.setClassification(addedAssignment.getClassification());</span>
<span class="nc" id="L849">				setDatesForSkillAssignment(assignment, addedAssignment,</span>
<span class="nc" id="L850">						pastSkillAssignments.get(employeeID), employeeMap.get(employeeID), viewStartDate);</span>
<span class="nc" id="L851">				newAddedAssignments.add(assignment);</span>
<span class="nc" id="L852">			}</span>
<span class="nc" id="L853">		}</span>

<span class="nc" id="L855">		return newAddedAssignments;</span>
	}

	public ArrayList&lt;SkillAssignment&gt; getAddedSkillAssignments() {
<span class="nc" id="L859">		ArrayList&lt;SkillAssignment&gt; retVal = new ArrayList&lt;SkillAssignment&gt;();</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">		for (ID id : getAddedRowIDCollection()) {</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">			for (SkillAssignment assignment : displayedAssignments) {</span>
<span class="nc bnc" id="L862" title="All 2 branches missed.">				if (id.equals(assignment.getSkillID())) {</span>
<span class="nc" id="L863">					retVal.add(assignment);</span>
<span class="nc" id="L864">					break;</span>
				}
<span class="nc" id="L866">			}</span>
<span class="nc" id="L867">		}</span>
<span class="nc" id="L868">		return retVal;</span>
	}

	private Collection&lt;SkillAssignment&gt; getModifiedSkillAssignments(
			Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; skillAssignmentMap,
			Map&lt;ID, Employee&gt; employeeMap) {
		//Only one copy of each assignment is stored on the page (even if multiple employees are selected), so
		// we need to modify the other assignments that belong to every selected employee
<span class="nc" id="L876">		Collection&lt;SkillAssignment&gt; modifiedAssignments = getModifiedSkillAssignments();</span>
<span class="nc" id="L877">		ArrayList&lt;SkillAssignment&gt; employeeModifiedAssignments = new ArrayList&lt;SkillAssignment&gt;();</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">		for (SkillAssignment modifiedAssignment : modifiedAssignments) {</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">			for (ID employeeID : skillAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">				for (SkillAssignment existingAssignment : skillAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">					if (modifiedAssignment.getSkillID().equals(existingAssignment.getSkillID())) {</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">						if (modifiedAssignment.isPriorityModified()) {</span>
<span class="nc" id="L883">							existingAssignment.setPriority(modifiedAssignment.getPriority());</span>
						}
<span class="nc bnc" id="L885" title="All 2 branches missed.">						if (modifiedAssignment.isProficiencyModified()) {</span>
<span class="nc" id="L886">							existingAssignment.setProficiency(modifiedAssignment.getProficiency());</span>
						}
<span class="nc bnc" id="L888" title="All 2 branches missed.">						if (modifiedAssignment.isClassificationModified()) {</span>
<span class="nc" id="L889">							existingAssignment.setClassification(modifiedAssignment.getClassification());</span>
						}
<span class="nc bnc" id="L891" title="All 4 branches missed.">						if (modifiedAssignment.isPriorityModified() || modifiedAssignment.isProficiencyModified() ||</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">								modifiedAssignment.isClassificationModified()) {</span>
<span class="nc" id="L893">							Employee emp = employeeMap.get(employeeID);</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">							if (emp.getStartTimeLocal().after(modifiedAssignment.getLocalStartTime())) {</span>
<span class="nc" id="L895">								TimeZone empTimeZone = emp.getTimeZone(emp.getStartTime());</span>
<span class="nc" id="L896">								existingAssignment.setStartTime(emp.getStartTimeLocal().getTime(empTimeZone));</span>
<span class="nc" id="L897">							} else {</span>
<span class="nc" id="L898">								TimeZone empTimeZone = emp.getTimeZone(modifiedAssignment.getLocalStartTime());</span>
<span class="nc" id="L899">								existingAssignment.setStartTime(modifiedAssignment.getLocalStartTime().getTime(empTimeZone));</span>
							}
<span class="nc bnc" id="L901" title="All 2 branches missed.">							if (modifiedAssignment.getLocalEndTime() != null) {</span>
<span class="nc" id="L902">								LocalDate adjustedEndDate = new LocalDate(modifiedAssignment.getLocalEndTime());</span>
<span class="nc" id="L903">								adjustedEndDate.add(Calendar.DAY_OF_YEAR, 1);</span>
								TimeZone empTimeZone;
<span class="nc bnc" id="L905" title="All 2 branches missed.">								if (emp.getEndTimeLocal() == null ||</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">										emp.getEndTimeLocal().after(modifiedAssignment.getLocalEndTime())) {</span>
<span class="nc" id="L907">									empTimeZone = emp.getTimeZone(modifiedAssignment.getLocalEndTime());</span>
								} else {
<span class="nc" id="L909">									empTimeZone = emp.getTimeZone(emp.getEndTime());</span>
								}
<span class="nc" id="L911">								existingAssignment.setEndTime(adjustedEndDate.getTime(empTimeZone));</span>
<span class="nc" id="L912">							} else {</span>
<span class="nc" id="L913">								existingAssignment.setEndTime(null);</span>
							}

							//If the employee's assignment start lies after the SP's start, we need to adjust the assignment back
							//one day (unless the employee's hire date is after the SP start date).
<span class="nc bnc" id="L918" title="All 4 branches missed.">							if (schedulingPeriod != null &amp;&amp; emp.getStartTime().after(schedulingPeriod.getStartTime()) == false) {</span>
<span class="nc" id="L919">								adjustStartDateOfAssignmentToCoverStartOfViewPeriod(existingAssignment, viewStartDate, campaign);</span>
							}
<span class="nc" id="L921">							adjustEndDateOfAssignmentToLieInsideViewPeriod(existingAssignment, viewEndDate, campaign);</span>
						}
<span class="nc" id="L923">						employeeModifiedAssignments.add(existingAssignment);</span>
<span class="nc" id="L924">						break;</span>
					}
<span class="nc" id="L926">				}</span>
<span class="nc" id="L927">			}</span>
<span class="nc" id="L928">		}</span>
<span class="nc" id="L929">		return employeeModifiedAssignments;</span>
	}

	private Collection&lt;SkillAssignment&gt; getModifiedSkillAssignments() {
<span class="nc" id="L933">		return new ArrayList&lt;SkillAssignment&gt;(modifiedAssignments.values());</span>
	}

	public Collection&lt;SkillAssignment&gt; getRemovedSkillAssignments(Map&lt;ID,
			Collection&lt;SkillAssignment&gt;&gt; skillAssignmentMap) {
<span class="nc" id="L938">		Collection&lt;ID&gt; removedSkillIDs = getRemovedRowIDCollection();</span>
<span class="nc" id="L939">		Collection&lt;SkillAssignment&gt; removedAssignments = new ArrayList&lt;SkillAssignment&gt;();</span>

<span class="nc bnc" id="L941" title="All 2 branches missed.">		for (ID employeeID : skillAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">			for (SkillAssignment assignment : skillAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">				if (removedSkillIDs.contains(assignment.getSkillID())) {</span>
<span class="nc" id="L944">					removedAssignments.add(assignment);</span>
				}
<span class="nc" id="L946">			}</span>
<span class="nc" id="L947">		}</span>

<span class="nc" id="L949">		return removedAssignments;</span>
	}

	/**
	 * This method looks at the past assignments of skills and then sets the appropriate date of the
	 * newly assigned skill based on this information.
	 *
	 * @param newEmployeeAssignment - The actual SkillAssignment that will be persisted for the employee.
	 * @param addedAssignment       - This is the skill assignment that is returned from the page.  In a multi-edit
	 *                              scenario, it could represent different values for different employees so this is not the actual assignment
	 *                              that is persisted.  We do use it to determine which values / dates were edited and will update newEmployeeAssignment
	 *                              accordingly.
	 * @param pastAssignments       - The past skill assignments for this employee.  Used to determine the correct start/end date
	 *                              for newEmployeeAssignment if the same skill has already been assigned in the past/future.
	 * @param employee              - The employee for which this assignment will be persisted.
	 * @param viewStartDate         - the current start date of the view period (either the start of the SP in campaign mode
	 *                              or an arbitrary start window in org mode).
	 */
	private void setDatesForSkillAssignment(SkillAssignment newEmployeeAssignment, SkillAssignment addedAssignment,
			Collection&lt;SkillAssignment&gt; pastAssignments, Employee employee, Date viewStartDate) {

		//We need to check to see if the assignment start time is explicitly set ahead of the view start time.
		//This will happen if the user's hire date is after the view/SP start date.
		//After determining the start times, we check this flag and if the assignment start is still
		//ahead of the SP (due to a difference in time zone between the employee's org and the SP) then
		//we may need to make further adjustments to the assignment start.
<span class="nc" id="L975">		boolean assignmentStartExplicitlySetAfterViewStart = false;</span>

		//Find the correct start date of the new assignment for the given employee
<span class="nc bnc" id="L978" title="All 2 branches missed.">		if (addedAssignment.getLocalStartTime() != null) {</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">			if (employee.getStartTimeLocal().after(addedAssignment.getLocalStartTime())) {</span>
<span class="nc" id="L980">				TimeZone empTimeZone = employee.getTimeZone(employee.getStartTime());</span>
<span class="nc" id="L981">				newEmployeeAssignment.setStartTime(employee.getStartTimeLocal().getTime(empTimeZone));</span>
<span class="nc" id="L982">				assignmentStartExplicitlySetAfterViewStart = true;</span>
<span class="nc" id="L983">			} else {</span>
<span class="nc" id="L984">				TimeZone empTimeZone = employee.getTimeZone(addedAssignment.getLocalStartTime());</span>
<span class="nc" id="L985">				newEmployeeAssignment.setStartTime(addedAssignment.getLocalStartTime().getTime(empTimeZone));</span>
<span class="nc" id="L986">			}</span>
		} else {  //If we are adding new work patterns in a multi-edit scenario, the addedAssignment object
			//will have a null start time.  In this case, we need to determine the appropriate start time based on
			//any previous assignments of the same skill that the employee may have had.
<span class="nc bnc" id="L990" title="All 4 branches missed.">			if (pastAssignments != null &amp;&amp; pastAssignments.size() &gt; 0) {</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">				for (SkillAssignment pastAssignment : pastAssignments) {</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">					if (pastAssignment.getSkillID().equals(newEmployeeAssignment.getSkillID())) {</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">						if (pastAssignment.getEndTime() == null) {    //This means this new assignment is simply a continuation of a past assignment</span>
<span class="nc" id="L994">							newEmployeeAssignment.setStartTime(pastAssignment.getStartTime());</span>
<span class="nc" id="L995">							newEmployeeAssignment.setLocalStartTime(new LocalDate(pastAssignment.getStartTime(),</span>
<span class="nc" id="L996">									employee.getTimeZone(pastAssignment.getStartTime())));</span>
						} else {  //The new assignment is separate (non-continuous) from any past assignment
<span class="nc" id="L998">							newEmployeeAssignment.setStartTime(pastAssignment.getEndTime());</span>
<span class="nc" id="L999">							newEmployeeAssignment.setLocalStartTime(new LocalDate(pastAssignment.getEndTime(),</span>
<span class="nc" id="L1000">									employee.getTimeZone(pastAssignment.getStartTime())));</span>
						}
					}
<span class="nc bnc" id="L1003" title="All 2 branches missed.">					if (newEmployeeAssignment.getStartTime() == null) {  //If there were no previous assignments for this work pattern, set start date of assignment to the employee start date.</span>
						//(We technically should never have an hours assignment without a start date, this is just here as a safety check).
<span class="nc" id="L1005">						newEmployeeAssignment.setStartTime(employee.getStartTime());</span>
					}
<span class="nc" id="L1007">				}</span>
			} else {  //If there were no previous assignments for this work pattern, set start date of assignment to the employee start date
<span class="nc" id="L1009">				newEmployeeAssignment.setStartTime(employee.getStartTime());</span>
			}
		}

		//Find the correct end date of the new assignment for the given employee
<span class="nc" id="L1014">		LocalDate viewStartDateLocal = new LocalDate(viewStartDate, TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">		if (addedAssignment.getLocalEndTime() != null) {</span>
<span class="nc" id="L1016">			LocalDate adjustedEndDate = new LocalDate(addedAssignment.getLocalEndTime());</span>
<span class="nc" id="L1017">			adjustedEndDate.add(Calendar.DAY_OF_YEAR, 1);</span>
<span class="nc bnc" id="L1018" title="All 2 branches missed.">			if (employee.getEndTimeLocal() != null &amp;&amp;</span>
<span class="nc bnc" id="L1019" title="All 2 branches missed.">					employee.getEndTimeLocal().before(adjustedEndDate)) {</span>
<span class="nc" id="L1020">				newEmployeeAssignment.setEndTime(employee.getEndTime());</span>
			} else {
<span class="nc" id="L1022">				TimeZone empTimeZone = employee.getTimeZone(addedAssignment.getLocalEndTime());</span>
<span class="nc" id="L1023">				newEmployeeAssignment.setEndTime(adjustedEndDate.getTime(empTimeZone));</span>
			}
<span class="nc bnc" id="L1025" title="All 6 branches missed.">		} else if (pastAssignments != null &amp;&amp; !pastAssignments.isEmpty() &amp;&amp; isEndDateMultiEdit(addedAssignment)) {</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">			for (SkillAssignment pastAssignment : pastAssignments) {</span>
<span class="nc bnc" id="L1027" title="All 2 branches missed.">				if (pastAssignment.getSkillID().equals(newEmployeeAssignment.getSkillID())) {</span>
<span class="nc bnc" id="L1028" title="All 4 branches missed.">					if (pastAssignment.getStartTime() != null &amp;&amp; pastAssignment.getStartTime().after(viewStartDateLocal.getTime(employee.getTimeZone(viewStartDate)))) {</span>
<span class="nc bnc" id="L1029" title="All 4 branches missed.">						if (newEmployeeAssignment.getEndTime() == null || newEmployeeAssignment.getEndTime().after(pastAssignment.getStartTime())) {</span>
<span class="nc" id="L1030">							newEmployeeAssignment.setEndTime(pastAssignment.getStartTime());</span>
						}
					}
				}
<span class="nc" id="L1034">			}</span>
		} else {  //No end date for assignment, set it to the employee termination date if there is one
<span class="nc bnc" id="L1036" title="All 2 branches missed.">			if (employee.getEndTime() != null) {</span>
<span class="nc" id="L1037">				newEmployeeAssignment.setEndTime(employee.getEndTime());</span>
			}
		}

		/**
		 * The assignment's absolute start time can land after the SP's absolute start time due to one of
		 * a couple reasons:
		 * 1 - The employee's hire date is after the SP's start date (which we are not concerned about here).
		 * 2 - The employee org is in a time zone that is behind the SP's time zone (e.g. the SP time zone
		 * is +5:00 GMT, and the employee org's timezone is -8:00 GMT).  Because assignments are stored with
		 * a start date that is midnight at the employee org's timezone, in this scenario the absolute time of
		 * the assignment's start date will be after the absolute time of the SP's start date.  This causes an issue
		 * with the scheduler and the scheduler will not pick up the assignment unless the assignment covers the
		 * start of the SP.  We need to adjust the start date back one day in this case to ensure that the assignment
		 * covers the start.  Similarly, we do the same thing to the end date to avoid the assignment being applied to
		 * a future SP.
		 */
<span class="nc bnc" id="L1054" title="All 4 branches missed.">		if (schedulingPeriod != null &amp;&amp; assignmentStartExplicitlySetAfterViewStart == false) {</span>
<span class="nc" id="L1055">			adjustStartDateOfAssignmentToCoverStartOfViewPeriod(newEmployeeAssignment, viewStartDate, campaign);</span>
		}
<span class="nc bnc" id="L1057" title="All 2 branches missed.">		if (schedulingPeriod != null) {</span>
<span class="nc" id="L1058">			adjustEndDateOfAssignmentToLieInsideViewPeriod(newEmployeeAssignment, viewEndDate, campaign);</span>
		}
<span class="nc" id="L1060">	}</span>

	private String getStartDateDisplay() {
<span class="nc bnc" id="L1063" title="All 2 branches missed.">		return viewStartDate == null ? &quot;&quot; :</span>
<span class="nc" id="L1064">				m_localizer.formatDate(viewStartDate, TimeZoneUtil.GMT_TIMEZONE, RegionalFormatBundleKey.DATE_FORMAT);</span>
	}

	private String getEndDateDisplay() {
<span class="nc" id="L1068">		String endDateDisplay = &quot;&quot;;</span>
<span class="nc bnc" id="L1069" title="All 2 branches missed.">		if (viewEndDate != null) {</span>
<span class="nc" id="L1070">			LocalDate viewPeriodEndDisplay = new LocalDate(viewEndDate, TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L1071">			adjustEndDateForDisplay(viewPeriodEndDisplay);</span>
<span class="nc" id="L1072">			endDateDisplay = m_localizer.formatDate(viewPeriodEndDisplay, RegionalFormatBundleKey.DATE_FORMAT);</span>
		}
<span class="nc" id="L1074">		return endDateDisplay;</span>
	}

	/**
	 * This is just to adjust for the way the effectivity end date is stored in DB and how
	 * it needs to be displayed to the user.
	 * Ex: Say an effectivity period set from 03/20/2007 to 03/22/2007. End date is stored as
	 * 03/23/2007 00:00:00. To display it to user need to subtract one day to make it 03/22/2007.
	 *
	 * @param endDate
	 */
	private static void adjustEndDateForDisplay(LocalDate endDate) {
<span class="nc bnc" id="L1086" title="All 2 branches missed.">		if (endDate != null) {</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">			if (endDate.get(Calendar.MINUTE) == 59) {</span>
				// Need to compensate for last effetive assignment end date
				// which is stored at the last minute of the date
<span class="nc" id="L1090">				endDate.add(Calendar.MINUTE, 1);</span>
			}

			// Need to subtract a day on end date to show to the user correctly
<span class="nc" id="L1094">			endDate.add(Calendar.DATE, -1);</span>
		}
<span class="nc" id="L1096">	}</span>

	private Collection&lt;SkillAssignment&gt; getSkillAssignmentsToDisplay() {
		//key = ID of corresponding skill belonging to the assignment (not the assignment itself)
		//  We only want to display one of each skill in the assignment list
<span class="nc" id="L1101">		HashMap&lt;ID, SkillAssignment&gt; skillAssignments = new HashMap&lt;ID, SkillAssignment&gt;();</span>
		//key = skill ID, value = collection of employee ids assigned to this skill
<span class="nc" id="L1103">		HashMap&lt;ID, HashSet&lt;ID&gt;&gt; skillEmployeeMap = new HashMap&lt;ID, HashSet&lt;ID&gt;&gt;();</span>

<span class="nc bnc" id="L1105" title="All 2 branches missed.">		for (ID employeeID : assignmentMap.keySet()) {</span>
<span class="nc bnc" id="L1106" title="All 2 branches missed.">			for (SkillAssignment assignment : assignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">				if (skillAssignments.keySet().contains(assignment.getSkillID())) {</span>
<span class="nc" id="L1108">					SkillAssignment existingAssignment = skillAssignments.get(assignment.getSkillID());</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">					if (existingAssignment.getWorkResourceID().equals(employeeID) == false) {</span>
<span class="nc bnc" id="L1110" title="All 4 branches missed.">						if (existingAssignment.getProficiency() != assignment.getProficiency() &amp;&amp; isProficiencyEditable) {</span>
<span class="nc" id="L1111">							existingAssignment.setFieldMultiValue(</span>
									SkillAssignmentFieldInfo.SKILLASSIGNMENT_PROFICIENCY);
						}
<span class="nc bnc" id="L1114" title="All 2 branches missed.">						if (existingAssignment.getPriority() != assignment.getPriority()) {</span>
<span class="nc" id="L1115">							existingAssignment.setFieldMultiValue(</span>
									SkillAssignmentFieldInfo.SKILLASSIGNMENT_PRIORITY);
						}
<span class="nc bnc" id="L1118" title="All 2 branches missed.">						if (existingAssignment.getClassification() != assignment.getClassification()) {</span>
<span class="nc" id="L1119">							existingAssignment.setFieldMultiValue(</span>
									SkillAssignmentFieldInfo.SKILLASSIGNMENT_RESERVELEVEL);
						}
<span class="nc bnc" id="L1122" title="All 2 branches missed.">						if (existingAssignment.getLocalStartTime().equals(assignment.getLocalStartTime()) == false) {</span>
<span class="nc" id="L1123">							existingAssignment.setFieldMultiValue(</span>
									SkillAssignmentFieldInfo.SKILLASSIGNMENT_STARTTIME);
						}
<span class="nc bnc" id="L1126" title="All 2 branches missed.">						if (existingAssignment.getLocalEndTime() != null &amp;&amp;</span>
<span class="nc bnc" id="L1127" title="All 2 branches missed.">								existingAssignment.getLocalEndTime().equals(assignment.getLocalEndTime()) == false) {</span>
<span class="nc" id="L1128">							existingAssignment.setFieldMultiValue(</span>
									SkillAssignmentFieldInfo.SKILLASSIGNMENT_ENDTIME);
						}
					}
<span class="nc" id="L1132">				} else {</span>
					try {
<span class="nc" id="L1134">						skillAssignments.put(assignment.getSkillID(), (SkillAssignment) assignment.clone());</span>
<span class="nc" id="L1135">					} catch (CloneNotSupportedException e) {</span>
						//This should never happen since we know SkillAssignments are Cloneable.
<span class="nc" id="L1137">						e.printStackTrace();</span>
<span class="nc" id="L1138">					}</span>
				}

<span class="nc" id="L1141">				HashSet&lt;ID&gt; associatedEmployeeIDs = skillEmployeeMap.get(assignment.getSkillID());</span>
<span class="nc bnc" id="L1142" title="All 2 branches missed.">				if (associatedEmployeeIDs == null) {</span>
<span class="nc" id="L1143">					associatedEmployeeIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L1144">					skillEmployeeMap.put(assignment.getSkillID(), associatedEmployeeIDs);</span>
				}
<span class="nc" id="L1146">				associatedEmployeeIDs.add(employeeID);</span>
<span class="nc" id="L1147">			}</span>
<span class="nc" id="L1148">		}</span>
<span class="nc bnc" id="L1149" title="All 2 branches missed.">		for (SkillAssignment assignment : skillAssignments.values()) {</span>
			//Indicate if multiple employees have this skill assigned.  This is
			// different from setting multi edit common, which identifies that ALL selected
			// employees have this skill assigned.  SetMultiEditIDs will indicate to the
			// effectivity popup that more than one employee is assigned and to therefore disable
			// the history control.
<span class="nc" id="L1155">			assignment.setMultiEditIDs(skillEmployeeMap.get(assignment.getSkillID()));</span>
			//Set multieditcommon to indicate that all selected employees have this skill assigned
<span class="nc" id="L1157">			assignment.setMultiEditCommon(</span>
<span class="nc" id="L1158">					skillEmployeeMap.get(assignment.getSkillID()).containsAll(selectedEmployeeIDs));</span>
<span class="nc" id="L1159">		}</span>

<span class="nc" id="L1161">		return new ArrayList&lt;SkillAssignment&gt;(skillAssignments.values());</span>
	}

	/**
	 * Updates the map of skill assignments for this component.
	 * This is required after a save operation because some of the assignments may have changed
	 * during the save operation.
	 */
	public void refreshSkillAssignmentMap(Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; skillAssignmentMap) {
<span class="nc" id="L1170">		assignmentMap = skillAssignmentMap;</span>
<span class="nc" id="L1171">		initRows(true);</span>
<span class="nc" id="L1172">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>