<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SkillsEmployeeAssignmentPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.skills</a> &gt; <span class="el_source">SkillsEmployeeAssignmentPM.java</span></div><h1>SkillsEmployeeAssignmentPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.skills;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.ArrayUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.skill.SkillModelHandler;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.employee.assignment.WfmEmployeeAssignmentPM;
import com.verint.web.fs.employee.assignment.WfmEmployeeAssignmentPM;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.CacheUtil;
import com.witness.web.uif.util.js.JSDateTimeUtil;
import com.witness.web.uif.util.js.JSValidatorUtil;
import com.witness.web.uif.validator.InRangeFieldValidator;

import java.rmi.RemoteException;
import java.text.NumberFormat;
import java.text.ParseException;
import java.util.*;

public class SkillsEmployeeAssignmentPM extends WfmEmployeeAssignmentPM {
	private static final long serialVersionUID = 1L;
	public static final String START_DATE = &quot;startDate&quot;;
	public static final String END_DATE = &quot;endDate&quot;;
	
<span class="nc" id="L50">	protected boolean isByOrg = true;</span>
	protected SchedulingPeriod selectedSP;
	protected Campaign selectedCampaign;

	//key = employee ID, value = collection of skill assignments
	private Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; skillAssignmentMap;
	private boolean didTimePeriodChange;
	private String m_proficiency;
	private Map&lt;ID, Integer&gt; m_chatSessionMap;
<span class="nc" id="L59">	private boolean isViewPeriodValidForAllEmployees = true;</span>

	private SkillsInlineEditListPC pc_skill;
	private FormInputPC employeeProficiencyPC;
	private FormInputPC employeeChatPC;
	//We need to get the added/removed skill assignments when the pc_skill component
	//extracts its params so we can determine whether or not to disable employeeChatPC
	private Collection&lt;SkillAssignment&gt; addedSkillAssignments;
	private Collection&lt;SkillAssignment&gt; removedSkillAssignments;

	private static final String PROFICIENCY_FN = &quot;proficiencyFN&quot;;
	private static final String NUM_CHAT_FN = &quot;skillsAssignmentNumChatFN&quot;;

	static final String EMPLOYEE_ID_LIST_CONTEXT_KEY = &quot;com.verint.web.fs.skills.employeeIDs&quot;;

	private Map&lt;ID, List&lt;Integer&gt;&gt; authorizedViewFields;    // Authorized fields for viewing
	private Map&lt;ID, List&lt;Integer&gt;&gt; authorizedEditFields;    // Authorized fields for editing

	public SkillsEmployeeAssignmentPM(RequestContext context) {
<span class="nc" id="L78">		super(context, PageModel.FRAMED_MODEL);</span>

<span class="nc" id="L80">		didTimePeriodChange = SkillsEmployeeAssignmentRH.didTimePeriodChange(context);</span>

<span class="nc" id="L82">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="nc" id="L83">		addJSVariable(JSDateTimeUtil.getDateFormatJSVariables(m_localizer));</span>
		//We need to add these JS variables for the field validators to work properly
<span class="nc" id="L85">		JSValidatorUtil.addVDJSVars(this);</span>
<span class="nc" id="L86">	}</span>

	public static SkillsEmployeeAssignmentPM getInstance(RequestContext context) {
<span class="nc" id="L89">		return (SkillsEmployeeAssignmentPM) PageModel.getInstance(context, SkillsEmployeeAssignmentPM.class);</span>
	}

	@Override
	protected void initForm() {
<span class="nc" id="L94">		initContextDateFieldNames(START_DATE_FN, END_DATE_FN);</span>
		
<span class="nc bnc" id="L96" title="All 2 branches missed.">		if (getSelectedIDSize() &gt; 0) {</span>
<span class="nc" id="L97">			viewStartDate = pc_timePeriod.getSelectedDateRange().getFirst();</span>
<span class="nc" id="L98">			viewEndDate = pc_timePeriod.getSelectedDateRange().getSecond();</span>

			//Setting list of employeeIDs in context for the associated popup window (the list may be too large
			//  to use as a query string param)
<span class="nc" id="L102">			CacheUtil.setCachedValue(m_context, CacheUtil.CACHE_MODE_SESSION, EMPLOYEE_ID_LIST_CONTEXT_KEY,</span>
<span class="nc" id="L103">					StringUtil.createDelimitedString(getSelectedIDs(), StringUtil.DELIM));</span>

<span class="nc bnc" id="L105" title="All 2 branches missed.">			if (getSelectedIDSize() &gt; 1) {</span>
<span class="nc" id="L106">				setIsMultiObjEditEnabled(true);</span>
			}

			try {
				//Loading this data here instead of loadData because we need the date range from the date selector
<span class="nc" id="L111">				employeeMap = EmployeeModelHandler.getEmployeeMap(m_context, getSelectedIDsAsCollection(),</span>
<span class="nc" id="L112">						viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>

				//If the user tries to bypass the UI and forge an HTTP request with employee IDs that they don't have access to, check
				//for that here and clear the selection if that is detected.
<span class="nc bnc" id="L116" title="All 2 branches missed.">				if (!userHasPermissionToViewAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L117">					employeeMap.clear();</span>
<span class="nc" id="L118">					addPageMessage(Message.INSTRUCTION_TYPE, getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
							BbmWebBundleKey.SELECT_EMPLOYEE));
<span class="nc" id="L120">					return;</span>
				}

				// Initialize the data required to determine if fields are viewable/editable.
<span class="nc" id="L124">				initializeSecureFieldMetaData();</span>

<span class="nc bnc" id="L126" title="All 2 branches missed.">				if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L127">					addPageMessage(Message.WARNING_TYPE,</span>
							FsWebBundleKey.FS_SKILLS_NOT_ALL_EMPLOYEES_EDITABLE, FsWebBundleKey.BUNDLE_NAME);
				}

<span class="nc" id="L131">				ArrayList&lt;String&gt; invalidEmployeeNames = new ArrayList&lt;&gt;();</span>
				//Check to see if all employees start/end dates overlap with the view period.  If not, display
				// a message to the user and do not render the page.
<span class="nc bnc" id="L134" title="All 2 branches missed.">				for (Employee emp : employeeMap.values()) {</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">					if (emp.getStartTimeLocal().after(viewEndDate) ||</span>
<span class="nc bnc" id="L136" title="All 4 branches missed.">							(emp.getEndTimeLocal() != null &amp;&amp; emp.getEndTimeLocal().before(viewStartDate))) {</span>
<span class="nc" id="L137">						isViewPeriodValidForAllEmployees = false;</span>
<span class="nc" id="L138">						invalidEmployeeNames.add(m_localizer.formatName(emp));</span>
					}
<span class="nc" id="L140">				}</span>

<span class="nc bnc" id="L142" title="All 2 branches missed.">				if (isViewPeriodValidForAllEmployees) {</span>
<span class="nc" id="L143">					loadSkills();</span>

<span class="nc bnc" id="L145" title="All 2 branches missed.">					for (ID employeeID : getSelectedIDsAsCollection()) {</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">						if (!skillAssignmentMap.keySet().contains(employeeID)) {</span>
<span class="nc" id="L147">							Set&lt;SkillAssignment&gt; set = Collections.emptySet();</span>
<span class="nc" id="L148">							skillAssignmentMap.put(employeeID, set);</span>
						}
<span class="nc" id="L150">					}</span>
<span class="nc" id="L151">					m_proficiency = SkillsAssignmentMH.getProficiencyForEmployees(m_context, getSelectedIDsAsCollection(),</span>
<span class="nc" id="L152">							viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
<span class="nc" id="L153">					m_chatSessionMap = SkillsAssignmentMH.getNumberOfChatSessionsForEmployees(m_context, getSelectedIDsAsCollection(), true);</span>
				} else {
<span class="nc" id="L155">					StringBuilder namesStr = new StringBuilder();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">					for (String empName : invalidEmployeeNames) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">						if (!StringUtil.isEmpty(namesStr.toString())) {</span>
<span class="nc" id="L158">							namesStr.append(&quot;; &quot;);</span>
						}
<span class="nc" id="L160">						namesStr.append(empName);</span>
<span class="nc" id="L161">					}</span>
<span class="nc" id="L162">					addPageMessage(Message.ERROR_TYPE, FsWebBundleKey.FS_VIEW_DATE_OUT_OF_RANGE_FOR_EMP_WORK_RULE_ASSIGNMENT,</span>
<span class="nc" id="L163">							FsWebBundleKey.BUNDLE_NAME, new String[]{namesStr.toString()});</span>
				}

<span class="nc bnc" id="L166" title="All 2 branches missed.">				if (isViewPeriodValidForAllEmployees) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">					if (selectedSP != null) {</span>
<span class="nc" id="L168">						pc_skill = new SkillsInlineEditListPC(m_context, &quot;skillTable&quot;,</span>
<span class="nc" id="L169">								skillAssignmentMap, viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc" id="L170">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), selectedSP, selectedCampaign, didTimePeriodChange,</span>
<span class="nc" id="L171">								getSelectedIDsAsCollection(), this, getOnSkillRemovedJS(),</span>
<span class="nc" id="L172">								isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY),</span>
<span class="nc" id="L173">								isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>
					} else {
<span class="nc" id="L175">						pc_skill = new SkillsInlineEditListPC(m_context, &quot;skillTable&quot;,</span>
<span class="nc" id="L176">								skillAssignmentMap, viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc" id="L177">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), null, null,</span>
<span class="nc" id="L178">								didTimePeriodChange, getSelectedIDsAsCollection(), this, getOnSkillRemovedJS(),</span>
<span class="nc" id="L179">								isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY),</span>
<span class="nc" id="L180">								isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>
					}
<span class="nc" id="L182">					addedSkillAssignments = pc_skill.getAddedSkillAssignments();</span>
<span class="nc" id="L183">					removedSkillAssignments = pc_skill.getRemovedSkillAssignments(skillAssignmentMap);</span>

					//Add proficiency/number of chat sessions form
<span class="nc" id="L186">					FormTwoColumnPC m_formPC = new FormTwoColumnPC(m_context);</span>
<span class="nc" id="L187">					m_formPC.setName(&quot;proficiencyChatForm&quot;);</span>
<span class="nc" id="L188">					m_formPC.setIsBorderEnabled(true);</span>

<span class="nc" id="L190">					employeeProficiencyPC = new FormInputPC(m_context);</span>
<span class="nc" id="L191">					employeeProficiencyPC.setAutoExtractParamEnabled(true);</span>
<span class="nc" id="L192">					employeeProficiencyPC.setInputFN(PROFICIENCY_FN);</span>
<span class="nc" id="L193">					employeeProficiencyPC.setIsReadOnly(false);</span>
<span class="nc" id="L194">					employeeProficiencyPC.setIsRequired(false);</span>
<span class="nc" id="L195">					employeeProficiencyPC.setInputFieldDesc(FsWebBundleKey.EMPLOYEE_PROFICIENCY, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L196">					employeeProficiencyPC.setSize(5);</span>
<span class="nc" id="L197">					employeeProficiencyPC.initForDisplay();</span>

<span class="nc bnc" id="L199" title="All 2 branches missed.">					employeeProficiencyPC.setEnabled(userHasPermissionToEditAllSelectedEmployees(employeeMap.values())</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">							&amp;&amp; isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>
<span class="nc" id="L201">					employeeProficiencyPC.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY));</span>

<span class="nc" id="L203">					employeeProficiencyPC.extractParameters(m_context.getRequest());</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">					if (StringUtil.isEmpty(employeeProficiencyPC.getInputValue())) {</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">						if (MULTI_VALUE_DATA.equals(m_proficiency)) {</span>
<span class="nc" id="L206">							employeeProficiencyPC.setInputValue(m_proficiency);</span>
						} else {
<span class="nc" id="L208">							NumberFormat formatter = NumberFormat.getInstance(m_localizer.getLocaleContext().getRegionalFormatLocale());</span>
<span class="nc" id="L209">							formatter.setMaximumFractionDigits(1);</span>
<span class="nc" id="L210">							double proficiency = Double.parseDouble(m_proficiency); // This value is with decimal always it seems.</span>
<span class="nc" id="L211">							employeeProficiencyPC.setInputValue(formatter.format(proficiency));</span>
						}
					}

<span class="nc bnc" id="L215" title="All 2 branches missed.">					if (isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY)) {</span>
<span class="nc" id="L216">						String title_proficiency = m_localizer.i18n(</span>
								FsWebBundleKey.BUNDLE_NAME,
								FsWebBundleKey.EMPLOYEE_PROFICIENCY);
<span class="nc" id="L219">						m_formPC.addRow(title_proficiency, employeeProficiencyPC.getHtmlDisplay());</span>
<span class="nc" id="L220">						m_formPC.addChildComponent(employeeProficiencyPC);</span>
<span class="nc" id="L221">						InRangeFieldValidator empProfValidator = new InRangeFieldValidator(this, PROFICIENCY_FN,</span>
								FsWebBundleKey.EMPLOYEE_PROFICIENCY, FsWebBundleKey.BUNDLE_NAME, 0.00, 9.9);
<span class="nc" id="L223">						empProfValidator.setValidateClientSideOnly(true);</span>
<span class="nc" id="L224">						addValidator(empProfValidator);</span>
					}

<span class="nc" id="L227">					employeeChatPC = new FormInputPC(m_context);</span>
<span class="nc" id="L228">					employeeChatPC.setAutoExtractParamEnabled(true);</span>
<span class="nc" id="L229">					employeeChatPC.setInputFN(NUM_CHAT_FN);</span>
<span class="nc" id="L230">					employeeChatPC.setIsRequired(false);</span>
<span class="nc" id="L231">					employeeChatPC.setInputFieldDesc(FsWebBundleKey.EMPLOYEE_NUM_CHAT, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L232">					employeeChatPC.setSize(5);</span>
<span class="nc" id="L233">					employeeChatPC.initForDisplay();</span>
<span class="nc" id="L234">					employeeChatPC.extractParameters(m_context.getRequest());</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">					if (isNumberOfChatSessionsDisabled()) {</span>
<span class="nc" id="L236">						employeeChatPC.setIsReadOnly(true);</span>
<span class="nc" id="L237">						employeeChatPC.setEnabled(false);</span>
					}
<span class="nc bnc" id="L239" title="All 2 branches missed.">					if (StringUtil.isEmpty(employeeChatPC.getInputValue())) {</span>
<span class="nc" id="L240">						employeeChatPC.setInputValue(getNumberOfChatSessionsForEmployees(m_chatSessionMap,</span>
								employeeMap, m_localizer));
					}

					// If overall editability is disabled, it trumps any enabled setting prior to this.
<span class="nc bnc" id="L245" title="All 2 branches missed.">					if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L246">						employeeChatPC.setEnabled(false);</span>
					}

<span class="nc" id="L249">					InRangeFieldValidator empChatValidator = new InRangeFieldValidator(this,</span>
							NUM_CHAT_FN, FsWebBundleKey.EMPLOYEE_NUM_CHAT, FsWebBundleKey.BUNDLE_NAME, 1, 99);
<span class="nc" id="L251">					empChatValidator.setValidateClientSideOnly(true);</span>
<span class="nc" id="L252">					addValidator(empChatValidator);</span>
<span class="nc" id="L253">					String title_numchat = m_localizer.i18n(</span>
							FsWebBundleKey.BUNDLE_NAME,
							FsWebBundleKey.EMPLOYEE_NUM_CHAT);
<span class="nc" id="L256">					m_formPC.addRow(title_numchat, employeeChatPC.getHtmlDisplay());</span>
<span class="nc" id="L257">					m_formPC.addChildComponent(employeeChatPC);</span>
<span class="nc" id="L258">					addForm(m_formPC);</span>

					//Skill Assignment Container
<span class="nc" id="L261">					CollapsibleContainerPC skillAssignmentContainer = new CollapsibleContainerPC(m_context);</span>
<span class="nc" id="L262">					skillAssignmentContainer.setName(&quot;skillAssignmentContainer&quot;);</span>
<span class="nc" id="L263">					skillAssignmentContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
							FsWebBundleKey.SKILLASSIGNED));
<span class="nc" id="L265">					skillAssignmentContainer.setIsBorderEnabled(true);</span>
<span class="nc" id="L266">					pc_skill.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="nc" id="L267">					pc_skill.setIsInnerTable(true);</span>
<span class="nc" id="L268">					pc_skill.setIsBorderEnabled(false);</span>
<span class="nc" id="L269">					pc_skill.setIsCancelSelectEventPropagation(false);</span>
<span class="nc" id="L270">					pc_skill.setPreRowRemoveJS(getPreSkillRemovedJS());</span>
<span class="nc" id="L271">					pc_skill.setOnRowAddJS(getOnRowAddJS());</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">					if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L273">						pc_skill.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L274">						pc_skill.setEnabled(false);</span>
					}

<span class="nc" id="L277">					skillAssignmentContainer.addComponent(pc_skill);</span>
<span class="nc" id="L278">					addChildComponent(skillAssignmentContainer);</span>
<span class="nc" id="L279">					addForm(skillAssignmentContainer);</span>
				}
<span class="nc" id="L281">			} catch (Exception e) {</span>
<span class="nc" id="L282">				handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L283">			}</span>
		} else {
<span class="nc" id="L285">			addPageMessage(Message.INSTRUCTION_TYPE, getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
					BbmWebBundleKey.SELECT_EMPLOYEE));
		}
<span class="nc" id="L288">	}</span>

	protected void loadSkills() throws BbmException, RemoteException {
<span class="nc bnc" id="L291" title="All 4 branches missed.">		if (selectedSP != null &amp;&amp; selectedCampaign != null) {</span>
<span class="nc" id="L292">			skillAssignmentMap = getEmpSkillAssignments(</span>
<span class="nc" id="L293">					viewStartDate.getTime(selectedCampaign.getTimeZone()),</span>
<span class="nc" id="L294">					viewEndDate.getTime(selectedCampaign.getTimeZone()));</span>
		} else {
<span class="nc" id="L296">			skillAssignmentMap = getEmpSkillAssignments(</span>
<span class="nc" id="L297">					viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc" id="L298">					viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
		}

		//We need to retrieve the skills in a separate call
		//TODO: This should really be a ValueObjectRich so it can be done in the back end but
		// I was unaware of how this would impact the FS client.
		// (These assignments also already extend DAOEffectivity which makes things more difficult)
<span class="nc" id="L305">		HashSet&lt;SkillAssignment&gt; assignments = new HashSet&lt;SkillAssignment&gt;();</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">		for (ID employeeID : skillAssignmentMap.keySet()) {</span>
			//We only want to display the earliest skill assignment within the view period if the employee
			//  has multiple skill assignments for the same skill in the view period
<span class="nc" id="L309">			HashMap&lt;ID, SkillAssignment&gt; filteredAssignmentMap = new HashMap&lt;ID, SkillAssignment&gt;();</span>

<span class="nc bnc" id="L311" title="All 2 branches missed.">			for (SkillAssignment assignment : skillAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">				if (isSkillAssignmentCurrent(assignment)) {</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">					if (assignment.getStartTime() != null) {</span>
<span class="nc" id="L314">						assignment.setLocalStartTime(new LocalDate(assignment.getStartTime(),</span>
<span class="nc" id="L315">								employeeMap.get(employeeID).getTimeZone(assignment.getStartTime())));</span>
					}
<span class="nc bnc" id="L317" title="All 2 branches missed.">					if (assignment.getEndTime() != null) {</span>
<span class="nc" id="L318">						assignment.setLocalEndTime(new LocalDate(assignment.getEndTime(),</span>
<span class="nc" id="L319">								employeeMap.get(employeeID).getTimeZone(assignment.getEndTime())));</span>
					}
<span class="nc bnc" id="L321" title="All 2 branches missed.">					if (filteredAssignmentMap.get(assignment.getSkillID()) == null) {</span>
<span class="nc" id="L322">						filteredAssignmentMap.put(assignment.getSkillID(), assignment);</span>
					} else {
<span class="nc" id="L324">						SkillAssignment otherAssignment = filteredAssignmentMap.get(assignment.getSkillID());</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">						if (assignment.getStartTime().before(otherAssignment.getStartTime())) {</span>
<span class="nc" id="L326">							filteredAssignmentMap.put(assignment.getSkillID(), assignment);</span>
						}
					}
				}
<span class="nc" id="L330">			}</span>
<span class="nc" id="L331">			ArrayList&lt;SkillAssignment&gt; filteredAssignments = new ArrayList&lt;SkillAssignment&gt;(filteredAssignmentMap.values());</span>
<span class="nc" id="L332">			skillAssignmentMap.put(employeeID, filteredAssignments);</span>
<span class="nc" id="L333">			assignments.addAll(filteredAssignments);</span>
<span class="nc" id="L334">		}</span>
<span class="nc" id="L335">		ArrayList&lt;ID&gt; skillIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">		for (SkillAssignment assignment : assignments) {</span>
<span class="nc" id="L337">			skillIDs.add(assignment.getSkillID());</span>
<span class="nc" id="L338">		}</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">		if (!skillIDs.isEmpty()) {</span>
<span class="nc" id="L340">			Collection&lt;Skill&gt; tempSkills = SkillModelHandler.getSkillsByIDs(skillIDs);</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">			for (ID employeeID : skillAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">				for (SkillAssignment assignment : skillAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">					for (Skill skill : tempSkills) {</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">						if (skill.getID().equals(assignment.getSkillID())) {</span>
<span class="nc" id="L345">							assignment.setSkill(skill);</span>
<span class="nc" id="L346">							break;</span>
						}
<span class="nc" id="L348">					}</span>
<span class="nc" id="L349">				}</span>
<span class="nc" id="L350">			}</span>
		}
<span class="nc" id="L352">	}</span>

	protected Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; getEmpSkillAssignments(Date start, Date end) throws BbmFinderException {
<span class="nc" id="L355">		return SkillsAssignmentMH.getSkillAssignmentsForEmployees(m_context,</span>
<span class="nc" id="L356">				getSelectedIDsAsCollection(), start,</span>
				end);
	}

	public void saveSkillsAssignments() throws BbmException, RemoteException {
<span class="nc bnc" id="L361" title="All 2 branches missed.">		if (pc_skill.save(employeeMap)) {</span>
			//On successful save, we need to refresh the work pattern map for the workPatternPC so that
			//merged assignments will be displayed
<span class="nc" id="L364">			loadSkills();</span>
<span class="nc" id="L365">			pc_skill.refreshSkillAssignmentMap(skillAssignmentMap);</span>
		}
<span class="nc" id="L367">	}</span>

	public void saveEmployeeProficiency() throws BbmException, MultiUserException, RemoteException {
		try {
<span class="nc bnc" id="L371" title="All 2 branches missed.">			if (!StringUtil.isEmpty(employeeProficiencyPC.getInputValue()) &amp;&amp;</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">					!employeeProficiencyPC.getInputValue().equals(MULTI_VALUE_DATA)) {</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">				if (isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_PROFICIENCY)) {</span>
<span class="nc" id="L374">					SkillsAssignmentMH.saveEmployeeProficiency(m_context, getSelectedIDsAsCollection(),</span>
<span class="nc" id="L375">							viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc" id="L376">							NumberFormat.getInstance(m_localizer.getLocaleContext().getRegionalFormatLocale()).parse(employeeProficiencyPC.getInputValue()).doubleValue());</span>
				}
			}
<span class="nc" id="L379">		} catch (ParseException e) {</span>
<span class="nc" id="L380">			throw new BbmException(e);</span>
<span class="nc" id="L381">		}</span>
<span class="nc" id="L382">	}</span>

	/**
	 * Saves employee chat sessions only if all selected employees have an assigned chat skill for the
	 * current view period.
	 */
	public void saveEmployeeChatSessions() throws BbmException, RemoteException {
<span class="nc bnc" id="L389" title="All 2 branches missed.">		if (isNumberOfChatSessionsDisabled()) {</span>
<span class="nc" id="L390">			return;    //Don't save chat sessions if the field is disabled (i.e. aren't valid for the given view period)</span>
		}
<span class="nc bnc" id="L392" title="All 2 branches missed.">		if (!StringUtil.isEmpty(employeeChatPC.getInputValue()) &amp;&amp;</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">				!employeeChatPC.getInputValue().equals(MULTI_VALUE_DATA)) {</span>
<span class="nc" id="L394">			SkillsAssignmentMH.saveNumberOfChatSessionsForEmployees(m_context, getSelectedIDsAsCollection(),</span>
<span class="nc" id="L395">					Integer.parseInt(employeeChatPC.getInputValue()));</span>
		}
<span class="nc" id="L397">	}</span>

	public static String getOnRowAddJS() {
<span class="nc" id="L400">		StringBuilder js = new StringBuilder();</span>
<span class="nc" id="L401">		js.append(&quot;var $generalProficiencyInput = jQuery('input[name=&quot; + PROFICIENCY_FN + &quot;]');&quot;);</span>
<span class="nc" id="L402">		js.append(&quot;var rowAdded = skillTable.getRowByUID(id);&quot;);</span>
<span class="nc" id="L403">		js.append(&quot;var proficiencyId = skillTable.getRowAttribute(rowAdded, 'proficiencyFN');&quot;);</span>
<span class="nc" id="L404">		js.append(&quot;var num = $generalProficiencyInput.val();&quot;);</span>
<span class="nc" id="L405">		js.append(&quot;jQuery('input[name=' + proficiencyId + ']').val(num.toFixed ? num.toFixed(1) : num);&quot;);</span>
<span class="nc" id="L406">		return js.toString();</span>
	}

	public static String getOnChatSkillAddedJS(String numChatSessionsValue) {
<span class="nc" id="L410">		StringBuilder js = new StringBuilder();</span>
<span class="nc" id="L411">		js.append(&quot;var empAssignmentNumChatSessionsInputElement = jQuery('input[name=&quot; + NUM_CHAT_FN + &quot;]');&quot;);</span>
<span class="nc" id="L412">		js.append(&quot;empAssignmentNumChatSessionsInputElement.removeClass('&quot; + FormInputPC.INPUT_TEXT_READ_ONLY_STYLE + &quot;');&quot;);</span>
<span class="nc" id="L413">		js.append(&quot;empAssignmentNumChatSessionsInputElement.addClass('&quot; + FormInputPC.DEFAULT_STYLE + &quot;');&quot;);</span>
<span class="nc" id="L414">		js.append(&quot;empAssignmentNumChatSessionsInputElement.removeAttr('readOnly');&quot;);</span>
<span class="nc" id="L415">		js.append(&quot;empAssignmentNumChatSessionsInputElement.val('&quot; + numChatSessionsValue + &quot;');&quot;);</span>
<span class="nc" id="L416">		return js.toString();</span>
	}

	private static String getOnSkillRemovedJS() {
<span class="nc" id="L420">		StringBuilder js = new StringBuilder();</span>
<span class="nc" id="L421">		js.append(&quot;var chatSkillRows = skillTable.getRowCountWithAttribute('isCommonChatSkill');&quot;);</span>
<span class="nc" id="L422">		js.append(&quot;if (chatSkillRows == 0) {&quot;);</span>
<span class="nc" id="L423">		js.append(&quot;var empAssignmentNumChatSessionsInputElement = jQuery('input[name=&quot; + NUM_CHAT_FN + &quot;]');&quot;);</span>
<span class="nc" id="L424">		js.append(&quot;empAssignmentNumChatSessionsInputElement.removeClass('&quot; + FormInputPC.DEFAULT_STYLE + &quot;');&quot;);</span>
<span class="nc" id="L425">		js.append(&quot;empAssignmentNumChatSessionsInputElement.addClass('&quot; + FormInputPC.INPUT_TEXT_READ_ONLY_STYLE + &quot;');&quot;);</span>
<span class="nc" id="L426">		js.append(&quot;empAssignmentNumChatSessionsInputElement.attr('readOnly', 'true');&quot;);</span>
<span class="nc" id="L427">		js.append(&quot;}&quot;);</span>
<span class="nc" id="L428">		return js.toString();</span>
	}

	private static String getPreSkillRemovedJS() {
<span class="nc" id="L432">		StringBuilder js = new StringBuilder();</span>
<span class="nc" id="L433">		js.append(&quot;var rowToRemove = skillTable.getRowByUID(id);&quot;);</span>
<span class="nc" id="L434">		js.append(&quot;removeValidators(skillTable.getRowAttribute(rowToRemove, 'priorityFN'));&quot;);</span>
<span class="nc" id="L435">		js.append(&quot;removeValidators(skillTable.getRowAttribute(rowToRemove, 'proficiencyFN'));&quot;);</span>
<span class="nc" id="L436">		return js.toString();</span>
	}

	/**
	 * Returns true if any of the selected employees do not have any chat skills assigned for the current view period.
	 */
	private boolean isNumberOfChatSessionsDisabled() {
		//Return true if any of the added assignments are chat skills
<span class="nc bnc" id="L444" title="All 2 branches missed.">		if (addedSkillAssignments != null) {</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">			for (SkillAssignment addedAssignment : addedSkillAssignments) {</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">				if (addedAssignment.getSkill().getMediaID().equals(Media.MEDIA_ID_CHAT)) {</span>
<span class="nc" id="L447">					return false;</span>
				}
<span class="nc" id="L449">			}</span>
		}
<span class="nc bnc" id="L451" title="All 2 branches missed.">		if (removedSkillAssignments == null) {</span>
<span class="nc" id="L452">			removedSkillAssignments = new ArrayList&lt;&gt;();</span>
		}
<span class="nc bnc" id="L454" title="All 2 branches missed.">		for (Collection&lt;SkillAssignment&gt; employeeAssignments : skillAssignmentMap.values()) {</span>
<span class="nc" id="L455">			boolean employeeHasChatSkill = false;</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">			for (SkillAssignment assignment : employeeAssignments) {</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">				if (assignment.getSkill().getMediaID().equals(Media.MEDIA_ID_CHAT) &amp;&amp;</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">						removedSkillAssignments.contains(assignment) == false) {</span>
<span class="nc" id="L459">					employeeHasChatSkill = true;</span>
<span class="nc" id="L460">					break;</span>
				}
<span class="nc" id="L462">			}</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">			if (employeeHasChatSkill == false) {</span>
<span class="nc" id="L464">				return true;</span>
			}
<span class="nc" id="L466">		}</span>

<span class="nc" id="L468">		return false;</span>
	}

	/**
	 * Returns a string representation of the number of chat sessions assigned to all selected employees.
	 * If employees do not have any chat sessions assigned, they will be treated as though they have 1 chat session
	 * assigned.  If the selected employees do not all have the same number of assigned chat sessions, then
	 * an asterisk &quot;*&quot; representing multi-value will be returned.
	 */
	public static String getNumberOfChatSessionsForEmployees(Map&lt;ID, Integer&gt; chatSessionMap, Map&lt;ID, Employee&gt; employeeMap,
			Localizer localizer) {
<span class="nc bnc" id="L479" title="All 4 branches missed.">		if (chatSessionMap == null || chatSessionMap.size() == 0) {</span>
<span class="nc" id="L480">			return localizer.formatNumber(1);</span>
		}
<span class="nc bnc" id="L482" title="All 2 branches missed.">		if (chatSessionMap.size() != employeeMap.size()) {</span>
<span class="nc" id="L483">			return MULTI_VALUE_DATA;</span>
		}
<span class="nc" id="L485">		int numberOfChatSessions = chatSessionMap.values().iterator().next();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">		for (Integer empChatSessions : chatSessionMap.values()) {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">			if (numberOfChatSessions != empChatSessions) {</span>
<span class="nc" id="L488">				return MULTI_VALUE_DATA;</span>
			}
<span class="nc" id="L490">		}</span>

<span class="nc" id="L492">		return localizer.formatNumber(numberOfChatSessions);</span>
	}

	/**
	 * Determines if the current skill assignment is &quot;current&quot;, in other words it applies to the current
	 * view period.  This is true if the start date of the assignment lies before or at the view period start date
	 * and the assignment end date is either null or lies after the view period start date.  Skill assignments are also
	 * current if they lie between the view start and end dates.
	 */
	private boolean isSkillAssignmentCurrent(SkillAssignment assignment) {
<span class="nc bnc" id="L502" title="All 2 branches missed.">		if (selectedCampaign == null) {</span>
			TimeZone empTimeZone;
<span class="nc" id="L504">			Employee emp = employeeMap.get(assignment.getWorkResourceID());</span>
			//Determine time zone of employee at record start
<span class="nc bnc" id="L506" title="All 2 branches missed.">			if (emp.getStartTime().after(assignment.getStartTime())) {</span>
<span class="nc" id="L507">				empTimeZone = emp.getTimeZone(emp.getStartTime());</span>
			} else {
<span class="nc" id="L509">				empTimeZone = emp.getTimeZone(assignment.getStartTime());</span>
			}
<span class="nc" id="L511">			LocalDate localEffectiveStart = new LocalDate(assignment.getStartTime(), empTimeZone);</span>
<span class="nc" id="L512">			LocalDate localEffectiveEnd = null;</span>
			//Determine time zone of employee at record end
<span class="nc bnc" id="L514" title="All 2 branches missed.">			if (assignment.getEndTime() != null) {</span>
<span class="nc bnc" id="L515" title="All 4 branches missed.">				if (emp.getEndTime() == null || emp.getEndTime().after(assignment.getEndTime())) {</span>
<span class="nc" id="L516">					empTimeZone = emp.getTimeZone(assignment.getEndTime());</span>
				} else {
<span class="nc" id="L518">					empTimeZone = emp.getTimeZone(emp.getEndTime());</span>
				}
<span class="nc" id="L520">				localEffectiveEnd = new LocalDate(assignment.getEndTime(), empTimeZone);</span>
			}
<span class="nc bnc" id="L522" title="All 6 branches missed.">			return ((localEffectiveStart.before(viewStartDate) || localEffectiveStart.equals(viewStartDate))</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">					&amp;&amp; (localEffectiveEnd == null || localEffectiveEnd.after(viewStartDate))) ||</span>
<span class="nc bnc" id="L524" title="All 4 branches missed.">					(localEffectiveStart.after(viewStartDate) &amp;&amp; localEffectiveStart.before(viewEndDate));</span>
		} else {
<span class="nc" id="L526">			Date absoluteViewStartDate = viewStartDate.getTime(selectedCampaign.getTimeZone());</span>
<span class="nc" id="L527">			Date absoluteViewEndDate = viewEndDate.getTime(selectedCampaign.getTimeZone());</span>
<span class="nc bnc" id="L528" title="All 4 branches missed.">			return ((assignment.getStartTime().before(absoluteViewStartDate) || assignment.getStartTime().equals(absoluteViewStartDate))</span>
<span class="nc bnc" id="L529" title="All 4 branches missed.">					&amp;&amp; (assignment.getEndTime() == null || assignment.getEndTime().after(absoluteViewStartDate))) ||</span>
<span class="nc bnc" id="L530" title="All 4 branches missed.">					(assignment.getStartTime().after(absoluteViewStartDate) &amp;&amp; assignment.getStartTime().before(absoluteViewEndDate));</span>
		}
	}

	/**
	 * Initializes the secure field meta data for use in determining viewability/editability of certain fields.
	 */
	private void initializeSecureFieldMetaData() {
<span class="nc" id="L538">		authorizedViewFields = new HashMap&lt;&gt;();</span>
<span class="nc" id="L539">		authorizedEditFields = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L541" title="All 2 branches missed.">		for (Employee emp : employeeMap.values()) {</span>
<span class="nc" id="L542">			int[] viewableFields =</span>
<span class="nc" id="L543">					m_context.getUser().getAuthorizedFields(</span>
							PrivilegeKeys.CORE_VIEWSECUREFIELD,
<span class="nc" id="L545">							new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE));</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">			if (viewableFields == null) {</span>
<span class="nc" id="L547">				viewableFields = new int[0];</span>
			}

<span class="nc" id="L550">			int[] editableFields =</span>
<span class="nc" id="L551">					m_context.getUser().getAuthorizedFields(</span>
							PrivilegeKeys.CORE_EDITSECUREFIELD,
<span class="nc" id="L553">							new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE));</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">			if (editableFields == null) {</span>
<span class="nc" id="L555">				editableFields = new int[0];</span>
			}

<span class="nc" id="L558">			authorizedViewFields.put(emp.getID(), ArrayUtil.asList(viewableFields));</span>
<span class="nc" id="L559">			authorizedEditFields.put(emp.getID(), ArrayUtil.asList(editableFields));</span>
<span class="nc" id="L560">		}</span>
<span class="nc" id="L561">	}</span>

	/**
	 * Returns whether a field is EDITABLE based on the current user and employees/scope selected.
	 *
	 * @param secureFieldInfoId Secure field info {@link com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo SecureFieldInfo}
	 * @return boolean
	 */
	private boolean isFieldEditable(int secureFieldInfoId) {
		// If the field is not viewable then we don't even need to check
		// further for editability.
<span class="nc bnc" id="L572" title="All 2 branches missed.">		if (!isFieldViewable(secureFieldInfoId)) {</span>
<span class="nc" id="L573">			return false;</span>
		}

<span class="nc bnc" id="L576" title="All 2 branches missed.">		for (Employee emp : employeeMap.values()) {</span>
			// Just looking for any employee in the selection that doesn't permit EDITING
			// because we can't permit more access than the lowest permitted or actions
			// can be taken that shouldn't be allowed for some of the employees.
<span class="nc bnc" id="L580" title="All 2 branches missed.">			if (authorizedEditFields.containsKey(emp.getID())) {</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">				if (!authorizedEditFields.get(emp.getID()).contains(secureFieldInfoId)) {</span>
					// This field is not EDITABLE for this employee and scope so
					// we cannot permit the field to be EDITABLE for the selected
					// employees.
<span class="nc" id="L585">					return false;</span>
				}
			} // If the employee doesn't have any secured field information let's assume they can be accessed.
<span class="nc" id="L588">		}</span>
<span class="nc" id="L589">		return true;</span>
	}

	/**
	 * Returns whether a field is VIEWABLE based on the current user and employees/scope selected.
	 *
	 * @param secureFieldInfoId Secure field info {@link com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo SecureFieldInfo}
	 * @return boolean
	 */
	private boolean isFieldViewable(int secureFieldInfoId) {
<span class="nc bnc" id="L599" title="All 2 branches missed.">		for (Employee emp : employeeMap.values()) {</span>
			// Just looking for any employee in the selection that doesn't permit VIEWING
			// because we can't permit more access than the lowest permitted or actions
			// can be taken that shouldn't be allowed for some of the employees.
<span class="nc bnc" id="L603" title="All 2 branches missed.">			if (authorizedViewFields.containsKey(emp.getID())) {</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">				if (!authorizedViewFields.get(emp.getID()).contains(secureFieldInfoId)) {</span>
					// This field is not VIEWABLE for this employee and scope so
					// we cannot permit the field to be VIEWABLE for the selected
					// employees.
<span class="nc" id="L608">					return false;</span>
				}
			} // If the employee doesn't have any secured field information let's assume they can be accessed.
<span class="nc" id="L611">		}</span>
<span class="nc" id="L612">		return true;</span>
	}

	@Override
	protected String getPageTitle() {
<span class="nc" id="L617">		return i18n(m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME), BbmWebBundleKey.PEOPLE_SKILLS_LIST_PAGE_TITLE);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>