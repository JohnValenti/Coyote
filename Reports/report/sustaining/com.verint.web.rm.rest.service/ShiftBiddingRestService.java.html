<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftBiddingRestService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.rm.rest.service</a> &gt; <span class="el_source">ShiftBiddingRestService.java</span></div><h1>ShiftBiddingRestService.java</h1><pre class="source lang-java linenums">package com.verint.web.rm.rest.service;

import java.util.ArrayList;
import java.util.List;

import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.Context;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.web.rm.Log;
import com.verint.web.rest.exception.checked.WFOException;
import com.verint.web.rest.security.WFOSecurity;
import com.verint.web.rest.service.AbstractWFOService;
import com.verint.web.rm.rest.entity.RequestProcessEntity;
import com.verint.web.rm.rest.entity.StatusEntity;
import com.verint.web.rm.rest.entity.shiftbidding.AuctionListEntity;
import com.verint.web.rm.rest.entity.shiftbidding.BiddableScheduleListEntity;
import com.verint.web.rm.rest.entity.shiftbidding.ShiftBidRequestParamEntity;
import com.verint.web.rm.rest.entity.shiftbidding.ShiftBidRequestResponseEntity;
import com.verint.web.rm.rest.facade.shiftbidding.IShiftBiddingFacade;
import com.verint.web.rm.rest.util.RmUtils;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.system.RequestContext;

@Path(&quot;/shiftbidding/&quot;)
@Produces(&quot;application/json&quot;)
@WFOSecurity(licenses = { LicenseKeys.APP_RM_SB })
public class ShiftBiddingRestService extends AbstractWFOService {
<span class="nc" id="L41">	private static final Category LOG = Log.initCategory(ShiftBiddingRestService.class.getName());</span>

	@Context
	private HttpServletRequest request;
	@Context
	private HttpServletResponse response;
	@Context
	private ServletContext sc;

	private IShiftBiddingFacade shiftBiddingFacade;

<span class="nc" id="L52">	public ShiftBiddingRestService() { // NOSONAR</span>
<span class="nc" id="L53">	}</span>

	public RequestContext getRequestContext() {
<span class="nc" id="L56">		return new RequestContext(request, response, sc);</span>
	}

	public void setShiftBiddingFacade(IShiftBiddingFacade shiftBiddingFacade) {
<span class="nc" id="L60">		this.shiftBiddingFacade = shiftBiddingFacade;</span>
<span class="nc" id="L61">	}</span>

	/**
	 * Creates a new shift bid request. Currently this creates the request for the current user.
	 *
	 * Example:
	 * $.ajax({type: 'POST', url: 'http://localhost:7001/wfo/rest/rm-api/shiftbidding/createRequest', data: JSON.stringify(
	 * {'auctionID':'51','isBonusUsed':false,'name':'REST Create Request1', 'preference': 1, scheduleIDs:[51], 'shiftBidderID': 51}),
	 * 'contentType': 'application/json' });
	 */
	@POST
	@Path(&quot;/createRequest&quot;)
	@Consumes(&quot;application/json&quot;)
	public ShiftBidRequestResponseEntity createRequest(ShiftBidRequestParamEntity requestParams) throws WFOException {
		try {
<span class="nc" id="L76">			RequestContext context = getRequestContext();</span>
<span class="nc" id="L77">			RmUtils.assertIsAuthorized(context, PrivilegeKeys.SB_MODIFYPERSONALBIDS_ID);</span>

<span class="nc" id="L79">			ShiftBidRequest shiftBidRequest = getRequestForCreation(context, requestParams);</span>

<span class="nc" id="L81">			String comment = requestParams.getComment();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">			if (comment != null) {</span>
<span class="nc" id="L83">				comment = comment.trim();</span>
			}

<span class="nc" id="L86">			return shiftBiddingFacade.createRequest(context, shiftBidRequest, comment);</span>
<span class="nc" id="L87">		} catch (Exception ex) {</span>
<span class="nc" id="L88">			throw RmUtils.handleServiceException(ex, LOG);</span>
		}
	}

	/**
	 * Edits an existing shift bid request. Currently this is only supported for the current user.
	 *
	 * Example:
	 * $.ajax({type: 'POST', url: 'http://localhost:7001/wfo/rest/rm-api/shiftbidding/editRequest', data: JSON.stringify(
	 * {'id':3401, 'auctionID':'51','isBonusUsed':false,'name':'REST Create Request-edit', 'preference': 2, scheduleIDs:[51],
	 * 'shiftBidderID': 51}), 'contentType': 'application/json' });
	 */
	@POST
	@Path(&quot;/editRequest&quot;)
	@Consumes(&quot;application/json&quot;)
	public ShiftBidRequestResponseEntity editRequest(ShiftBidRequestParamEntity requestParams) throws WFOException {
		try {
<span class="nc" id="L105">			RequestContext context = getRequestContext();</span>
<span class="nc" id="L106">			Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L107">			RmUtils.assertIsAuthorized(context, PrivilegeKeys.SB_MODIFYPERSONALBIDS_ID);</span>

<span class="nc" id="L109">			ShiftBidRequest shiftBidRequest = getRequest(context, requestParams);</span>
<span class="nc" id="L110">			String comment = requestParams.getComment();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">			if (comment != null) {</span>
<span class="nc" id="L112">				comment = comment.trim();</span>
			}

<span class="nc" id="L115">			ID requestID = RmUtils.getID(localizer, requestParams.getId(), RmUtils.ID_FN);</span>
<span class="nc" id="L116">			RmUtils.assertNonZeroParameter(localizer, requestID.toInt(), RmUtils.ID_FN);</span>
<span class="nc" id="L117">			shiftBidRequest.setID(requestID);</span>

<span class="nc" id="L119">			return shiftBiddingFacade.editRequest(context, shiftBidRequest, comment);</span>
<span class="nc" id="L120">		} catch (Exception ex) {</span>
<span class="nc" id="L121">			throw RmUtils.handleServiceException(ex, LOG);</span>
		}
	}

	/**
	 * Gets the Open auctions for the current user.
	 *
	 * Example:
	 * http://localhost:7001/wfo/rest/rm-api/shiftbidding/getMyAuctions
	 */
	@GET
	@Path(&quot;/getMyAuctions&quot;)
	public AuctionListEntity getMyAuctions() throws WFOException {
		try {
<span class="nc" id="L135">			RequestContext context = getRequestContext();</span>
<span class="nc" id="L136">			RmUtils.assertIsAuthorized(context, PrivilegeKeys.SB_VIEWPERSONALBIDS_ID, PrivilegeKeys.SB_MODIFYPERSONALBIDS_ID);</span>

<span class="nc" id="L138">			return shiftBiddingFacade.getMyAuctions(context);</span>
<span class="nc" id="L139">		} catch (Exception ex) {</span>
<span class="nc" id="L140">			throw RmUtils.handleServiceException(ex, LOG);</span>
		}
	}

	/**
	 * Gets the biddable schedules for the current employee and specified auction.
	 *
	 * Parameters:
	 * auctionID: The ID of the auction.
	 *
	 * Example:
	 * http://localhost:7001/wfo/rest/rm-api/shiftbidding/getBiddableSchedules?auctionID=201
	 */
	@GET
	@Path(&quot;/getBiddableSchedules&quot;)
	public BiddableScheduleListEntity getBiddableSchedules() throws WFOException {
		try {
<span class="nc" id="L157">			RequestContext context = getRequestContext();</span>
<span class="nc" id="L158">			RmUtils.assertIsAuthorized(context, PrivilegeKeys.SB_VIEWPERSONALBIDS_ID, PrivilegeKeys.SB_MODIFYPERSONALBIDS_ID);</span>

<span class="nc" id="L160">			ID auctionID = RmUtils.getID(context, RmUtils.AUCTION_ID_FN);</span>
<span class="nc" id="L161">			ID employeeID = context.getUser().getEmployeeID();</span>

<span class="nc" id="L163">			return shiftBiddingFacade.getBiddableSchedules(context, auctionID, employeeID);</span>
<span class="nc" id="L164">		} catch (Exception ex) {</span>
<span class="nc" id="L165">			throw RmUtils.handleServiceException(ex, LOG);</span>
		}
	}

	/**
	 * Gets the shift bid request details.
	 *
	 * Parameters:
	 * requestID: The ID of the shift bid request.
	 *
	 * Example:
	 * http://localhost:7001/wfo/rest/rm-api/shiftbidding/getRequest?requestID=3001
	 */
	@GET
	@Path(&quot;/getRequest&quot;)
	public ShiftBidRequestResponseEntity getRequest() throws WFOException {
		try {
<span class="nc" id="L182">			RequestContext context = getRequestContext();</span>
<span class="nc" id="L183">			RmUtils.assertIsAuthorized(context, PrivilegeKeys.SB_VIEWPERSONALBIDS_ID, PrivilegeKeys.SB_MODIFYPERSONALBIDS_ID);</span>

<span class="nc" id="L185">			ID requestID = RmUtils.getID(context, RmUtils.REQUEST_ID_FN);</span>

<span class="nc" id="L187">			return shiftBiddingFacade.getRequest(context, requestID);</span>
<span class="nc" id="L188">		} catch (Exception ex) {</span>
<span class="nc" id="L189">			throw RmUtils.handleServiceException(ex, LOG);</span>
		}
	}

	/**
	 * Performs an action on an existing request.
	 *
	 * Example:
	 * $.ajax({type: 'POST', url: 'http://localhost:7001/wfo/rest/rm-api/shiftbidding/processRequest', data: JSON.stringify(
	 * {'requestID':3551,'actionCode':7,'comment':'withdraw'}),
	 * 'contentType': 'application/json' });
	 */
	@POST
	@Path(&quot;/processRequest&quot;)
	@Consumes(&quot;application/json&quot;)
	public ShiftBidRequestResponseEntity processRequest(RequestProcessEntity requestParams) throws WFOException {
		try {
<span class="nc" id="L206">			RequestContext context = getRequestContext();</span>
<span class="nc" id="L207">			Localizer localizer = context.getLocalizer();</span>

<span class="nc" id="L209">			ID requestID = new ID(requestParams.getId());</span>
<span class="nc" id="L210">			RmUtils.assertNonZeroParameter(localizer, requestID.toInt(), RmUtils.REQUEST_ID_FN);</span>

<span class="nc" id="L212">			int actionCode = requestParams.getActionCode();</span>
<span class="nc" id="L213">			String comment = requestParams.getComment();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">			if (comment != null) {</span>
<span class="nc" id="L215">				comment = comment.trim();</span>
			}

<span class="nc" id="L218">			return shiftBiddingFacade.processRequest(context, requestID, actionCode, comment);</span>
<span class="nc" id="L219">		} catch (Exception ex) {</span>
<span class="nc" id="L220">			throw RmUtils.handleServiceException(ex, LOG);</span>
		}
	}

	/**
	 * Updates the requests' preference only.
	 * Example:
	 * $.ajax({type: 'POST', url: 'http://localhost:7001/wfo/rest/rm-api/shiftbidding/updatePreferences', data: JSON.stringify(
	 * [{'id':3001, 'preference': 2}, {'id':3002, 'preference': 2}]
	 * ), 'contentType': 'application/json' });
	 */
	@POST
	@Path(&quot;/updatePreferences&quot;)
	@Consumes(&quot;application/json&quot;)
	public StatusEntity updatePreferences(List&lt;ShiftBidRequestParamEntity&gt; requestEntities)
			throws WFOException {
		try {
<span class="nc" id="L237">			RequestContext context = getRequestContext();</span>
<span class="nc" id="L238">			Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L239">			RmUtils.assertIsAuthorized(context, PrivilegeKeys.SB_MODIFYPERSONALBIDS_ID);</span>

<span class="nc" id="L241">			List&lt;ShiftBidRequest&gt; requests = new ArrayList&lt;ShiftBidRequest&gt;();</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">			for (ShiftBidRequestParamEntity requestEntity : requestEntities) {</span>
<span class="nc" id="L243">				ShiftBidRequest shiftBidRequest = new ShiftBidRequest(ShiftBidRequest.DL_BASIC);</span>
<span class="nc" id="L244">				ID requestID = RmUtils.getID(localizer, requestEntity.getId(), RmUtils.ID_FN);</span>
<span class="nc" id="L245">				RmUtils.assertNonZeroParameter(localizer, requestID.toInt(), RmUtils.ID_FN);</span>
<span class="nc" id="L246">				shiftBidRequest.setID(requestID);</span>

<span class="nc" id="L248">				int preference = requestEntity.getPreference();</span>
<span class="nc" id="L249">				RmUtils.assertNonZeroParameter(localizer, preference, RmUtils.PREFERENCE_FN);</span>
<span class="nc" id="L250">				shiftBidRequest.setPreference(preference);</span>

<span class="nc" id="L252">				requests.add(shiftBidRequest);</span>
<span class="nc" id="L253">			}</span>

<span class="nc" id="L255">			return shiftBiddingFacade.updatePreferences(context, requests);</span>
<span class="nc" id="L256">		} catch (Exception ex) {</span>
<span class="nc" id="L257">			throw RmUtils.handleServiceException(ex, LOG);</span>
		}
	}

	private ShiftBidRequest getRequestForCreation(RequestContext context, ShiftBidRequestParamEntity requestParams)
			throws RmHardValidationException, Exception {
<span class="nc" id="L263">		Localizer localizer = context.getLocalizer();</span>

<span class="nc" id="L265">		ShiftBidRequest shiftBidRequest = getRequest(context, requestParams);</span>

<span class="nc" id="L267">		int iAuctionID = requestParams.getAuctionID();</span>
<span class="nc" id="L268">		RmUtils.assertNonZeroParameter(localizer, iAuctionID, RmUtils.AUCTION_ID_FN);</span>
<span class="nc" id="L269">		ID auctionID = ID.fromInt(iAuctionID);</span>
<span class="nc" id="L270">		shiftBidRequest.setShiftBidAuctionID(auctionID);</span>

		// Shift Bidder
<span class="nc" id="L273">		int iShiftBidderID = requestParams.getShiftBidderID();</span>
<span class="nc" id="L274">		RmUtils.assertNonZeroParameter(localizer, iShiftBidderID, RmUtils.SHIFT_BIDDER_ID_FN);</span>
<span class="nc" id="L275">		ID shiftBidderID = ID.fromInt(iShiftBidderID);</span>
<span class="nc" id="L276">		shiftBidRequest.setShiftBidderID(shiftBidderID);</span>

<span class="nc" id="L278">		List&lt;ID&gt; scheduleIDs = RmUtils.getIDList(requestParams.getScheduleIDs());</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">		if (scheduleIDs.isEmpty()) {</span>
<span class="nc" id="L280">			throw RmUtils.getParameterIsRequiredException(localizer, RmUtils.SCHEDULE_IDS_FN);</span>
		}
<span class="nc" id="L282">		shiftBidRequest.setBiddableScheduleIDs(scheduleIDs);</span>

<span class="nc" id="L284">		return shiftBidRequest;</span>
	}

	/**
	 * Gets a shift bid request from the specified params. This populates the common fields between create and edit requests.
	 */
	private ShiftBidRequest getRequest(RequestContext context, ShiftBidRequestParamEntity requestParams)
			throws RmHardValidationException, Exception { // NOSONAR
<span class="nc" id="L292">		Localizer localizer = context.getLocalizer();</span>

<span class="nc" id="L294">		ShiftBidRequest shiftBidRequest = new ShiftBidRequest(ShiftBidRequest.DL_BASIC);</span>
		// set this to the current employee because we only support agents right now.
<span class="nc" id="L296">		shiftBidRequest.setEmployeeID(context.getUser().getEmployeeID());</span>
<span class="nc" id="L297">		shiftBidRequest.setIsBonusUsed(requestParams.isBonusUsed());</span>

<span class="nc" id="L299">		String name = requestParams.getName();</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">		if (name != null) {</span>
<span class="nc" id="L301">			name = name.trim();</span>
		}
<span class="nc" id="L303">		RmUtils.assertRequired(localizer, name, RmUtils.NAME_FN);</span>
<span class="nc" id="L304">		shiftBidRequest.setName(name);</span>

<span class="nc" id="L306">		int preference = requestParams.getPreference();</span>
<span class="nc" id="L307">		RmUtils.assertNonZeroParameter(localizer, preference, RmUtils.PREFERENCE_FN);</span>
<span class="nc" id="L308">		shiftBidRequest.setPreference(preference);</span>

<span class="nc" id="L310">		return shiftBidRequest;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>