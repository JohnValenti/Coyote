<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SwapUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests</a> &gt; <span class="el_source">SwapUtil.java</span></div><h1>SwapUtil.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests;

import java.rmi.RemoteException;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.DateTimeUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.core.base.CoreException;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.ShiftSwapPosting;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.people.skill.PeopleSkillUtil;
import com.bluepumpkin.web.fs.schedule.ScheduleViewUtil;
import com.bluepumpkin.web.rm.IHavePageMessage;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.keys.RmImageFileID;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.data.wrapper.DateWrapper;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.dialog.DialogToolbarMenuPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlLinkUtil;

/**
 * Title:        SwapUtil
 * Description:  Utility Class used by Shift Swap and Swap Board
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, dsu
 * @version      1.0
 *
 * Created on November 12, 2002, 5:08 PM
 */
public class SwapUtil {
<span class="nc" id="L62">	private static Category m_log = Log.initCategory(SwapUtil.class.getName());</span>
	
	private static final String SKILL_POPUP_FUNC_START = &quot;pageMediator.popupAgentsSkills( new Array('&quot;;
	//QC(96672) changes 
	private static final String SKILL_POPUP_FUNC_START_New = &quot;pageMediator.popupAgentsSkillsNew( new Array('&quot;;
	private static final String SKILL_POPUP_FUNC_END = &quot;') );&quot;;
	//QC(96672) changes 
	private static final String SKILL_POPUP_FUNC_END_New = &quot;);&quot;;
	
	private static final String TIME_OFF = ShiftSwapItem.SWAPITEMTYPE_TIMEOFF;
	private static final String SHIFT = ShiftSwapItem.SWAPITEMTYPE_SHIFT;

	/** Creates a new instance of ShiftSwapRequestUtil */
<span class="nc" id="L75">	private SwapUtil() {}</span>
  
  /**
   * Add Shift Swap Not Enabled Message
   */
  public static void addSSNotEnabledMsg(PageModel model) {
<span class="nc" id="L81">    model.addPageMessage(Message.INFO_TYPE, </span>
      RmWebBundleKey.SHIFT_SWAP_NOT_ENABLED, RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L83">  }  </span>
  
  /**
   * Return true if Skill Link is enabled for the current User and Employee ID
   */
  public static boolean isSkillLinkEnabled(User user, ID empID, Map eOrgMap) {
<span class="nc" id="L89">    return PeopleSkillUtil.isAuthToViewEmpSkillInfo(user, empID, eOrgMap);</span>
  }
		
	/**
	 * Create Skill Popup Link if User has privilege
	 * 
	 * @param user The Current User
	 * @param empID The employee ID used to find display Name
	 * @param eNameMap The Map containing employee ID and EmployeeName
	 * @param eOrgMap The Map containing employee and organization IDs
	 * @param localizer The localizer used to localized Employee Name
	 * @param empIDs The list of employee IDs separated by &quot;','&quot; including the quotes
	 */
	public static String createSkillPopupLink(User user, ID empID, Map eNameMap, 
	Map eOrgMap, String empIDs, Localizer localizer) {
<span class="nc" id="L104">		EmployeeName empName = (EmployeeName)eNameMap.get(empID);	</span>
<span class="nc" id="L105">		String eNameDisplay = localizer.formatName(empName);</span>
<span class="nc" id="L106">		String result = eNameDisplay;</span>
		
<span class="nc bnc" id="L108" title="All 2 branches missed.">		if (isSkillLinkEnabled(user, empID, eOrgMap)) {</span>
<span class="nc" id="L109">      String alt = localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.BBM_PEOPLE_SKILLS);</span>
<span class="nc" id="L110">			String onClickJS = SKILL_POPUP_FUNC_START + empIDs + SKILL_POPUP_FUNC_END;</span>
<span class="nc" id="L111">			result = HtmlLinkUtil.createActiveLink(eNameDisplay, alt, &quot;&quot;, onClickJS);</span>
		}
		
<span class="nc" id="L114">		return result;</span>
	}
	
	/**
	 * add Agent Name with onClickJS popup Skills
	 */
	public static void addAgentName(User user, ShiftSwapPosting ssPosting, 
	Map eNameMap, Map eOrgMap, Localizer localizer, DefaultMultiColumnNodeData row_data) {
<span class="nc" id="L122">		ID empID = ssPosting.getEmployeeID();</span>
<span class="nc" id="L123">		ShiftSwapItem item = ssPosting.getShiftSwapItem() ;</span>
<span class="nc" id="L124">	    Date shiftDate = item.getStartDate()   ;</span>
<span class="nc" id="L125">	    long shiftStartDate = shiftDate.getTime();</span>
<span class="nc" id="L126">		String empIDStr = empID.toString();</span>
<span class="nc" id="L127">		String data =  createSkillPopupLinkNew(user, empID, eNameMap, eOrgMap, empIDStr, localizer,shiftStartDate,shiftStartDate)  ;</span>
<span class="nc" id="L128">		row_data.add( data );</span>
<span class="nc" id="L129">	}	</span>

	
	/**
	 * Create Agent Names with onClickJS popup Skills
	 */
	public static String createAgentNames(User user, ShiftSwapRequest ssRequest, 
	Map eNameMap, Map eOrgMap, Localizer localizer) {
<span class="nc" id="L137">		List empIDList = ssRequest.getEmployees();</span>
<span class="nc bnc" id="L138" title="All 4 branches missed.">		if (empIDList==null || empIDList.isEmpty()) return &quot;&quot;;</span>
		
<span class="nc" id="L140">		ID empID1 = (ID)empIDList.get(0);</span>
<span class="nc" id="L141">		ID empID2 = (ID)empIDList.get(1);</span>
		//QC(96672) changes --  getting the shift date of agents swaping their shifts .
<span class="nc" id="L143">        List items = ssRequest.getShiftSwapItems();</span>
<span class="nc" id="L144">		ShiftSwapItem item1 = (ShiftSwapItem)items.get(0);</span>
<span class="nc" id="L145">	    ShiftSwapItem item2 = (ShiftSwapItem)items.get(1);</span>
<span class="nc" id="L146">	    Map map = new HashMap() ;</span>
<span class="nc" id="L147">	    ID item1empId = item1.getEmployeeID();</span>
<span class="nc" id="L148">	    ID item2empId = item2.getEmployeeID();</span>
<span class="nc" id="L149">        map.put(item1empId, item2.getStartDate()) ;</span>
<span class="nc" id="L150">        map.put(item2empId, item1.getStartDate()) ;</span>
<span class="nc" id="L151">        long empID1ShiftDate = ((Date) map.get(empID1)).getTime();</span>
<span class="nc" id="L152">        long empID2ShiftDate = ((Date) map.get(empID2)).getTime();</span>

<span class="nc" id="L154">		String sLink1 = &quot;&quot;;</span>
<span class="nc" id="L155">		String sLink2 = &quot;&quot;;</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">		if ( isSkillLinkEnabled(user, empID1, eOrgMap) &amp;&amp;</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">		     isSkillLinkEnabled(user, empID2, eOrgMap)) {</span>
<span class="nc" id="L158">			String empIDStr = empID1 + &quot;','&quot; + empID2;</span>
			//QC(96672) changes -- passed shift date as arg to  createSkillPopupLinkNew fuction which will in turn add the shift date in the request params
<span class="nc" id="L160">			sLink1 = createSkillPopupLinkNew(user, empID1, eNameMap, eOrgMap, empIDStr, localizer,empID1ShiftDate,empID2ShiftDate);</span>
<span class="nc" id="L161">			sLink2 = createSkillPopupLinkNew(user, empID2, eNameMap, eOrgMap, empIDStr, localizer,empID1ShiftDate,empID2ShiftDate);</span>
<span class="nc" id="L162">		} else {</span>
			//QC(96672)changes 
<span class="nc" id="L164">			sLink1 = createSkillPopupLinkNew(user, empID1, eNameMap, eOrgMap, empID1.toString(), localizer,empID1ShiftDate,empID2ShiftDate);</span>
<span class="nc" id="L165">			sLink2 = createSkillPopupLinkNew(user, empID2, eNameMap, eOrgMap, empID2.toString(), localizer,empID1ShiftDate,empID2ShiftDate);</span>
		}
		
<span class="nc" id="L168">	  return createTwoRow(sLink1, sLink2);</span>
	}	
		
	/**
	 * Add Shift Dates for Shift Swap Posting
	 */
	public static void addShiftDates(ShiftSwapPosting ssPosting, 
	Localizer localizer, TimeZone tz, ResourceBundle bundle,
	DefaultMultiColumnNodeData row_data) {		
<span class="nc" id="L177">		String m_dayLabel = localizer.i18n(bundle, UIFWebBundleKey.DAY);</span>
<span class="nc" id="L178">	  String m_offLabel = localizer.i18n(bundle, UIFWebBundleKey.OFF);</span>
	
<span class="nc" id="L180">		Date startDate = ssPosting.getDisplayStartDate();</span>
<span class="nc" id="L181">		DateWrapper dw = new DateWrapper(startDate, localizer, tz, RegionalFormatBundleKey.DATE_FORMAT);</span>
<span class="nc" id="L182">		row_data.add( dw, CSSUtil.STYLE_NOWRAP );</span>

		//ShiftType		
<span class="nc" id="L185">		Date endDate = ssPosting.getEndDate();		</span>
<span class="nc" id="L186">		String shiftType = ssPosting.getShiftSwapItem().getShiftType();</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">		if (TIME_OFF.equals(shiftType)) {</span>
<span class="nc" id="L188">			row_data.add(m_dayLabel);</span>
<span class="nc" id="L189">			row_data.add(m_offLabel);</span>
		}	else {
<span class="nc" id="L191">			row_data.add( timeSecs(startDate, localizer, tz) );</span>
<span class="nc" id="L192">			row_data.add( timeSecs(endDate, localizer, tz) );</span>
		}		
<span class="nc" id="L194">	}	</span>
	
	/**
	 * Add Shift Dates
	 */
	public static void addShiftDates(ShiftSwapRequest ssRequest, 
			ResourceBundle bundle, Localizer localizer, TimeZone tz,
			DefaultMultiColumnNodeData row_data) {
<span class="nc" id="L202">		String m_dayLabel = localizer.i18n(bundle, UIFWebBundleKey.DAY);</span>
<span class="nc" id="L203">		String m_offLabel = localizer.i18n(bundle, UIFWebBundleKey.OFF);</span>

		//Shift &amp; Start &amp; End Date
<span class="nc" id="L206">		Date startDate1 = (Date) (ssRequest.getDisplayStartDates()).get(0);</span>
<span class="nc" id="L207">		Date startDate2 = (Date) (ssRequest.getDisplayStartDates()).get(1);</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">		if (TIME_OFF.equals(ssRequest.getShiftTypes().get(0)) &amp;&amp; SHIFT.equals(ssRequest.getShiftTypes().get(1))) {</span>
<span class="nc" id="L209">			startDate1 = startDate2;</span>
<span class="nc bnc" id="L210" title="All 4 branches missed.">		} else if (SHIFT.equals(ssRequest.getShiftTypes().get(0)) &amp;&amp; TIME_OFF.equals(ssRequest.getShiftTypes().get(1))) {</span>
<span class="nc" id="L211">			startDate2 = startDate1;</span>
		}
<span class="nc" id="L213">		row_data.add(format(startDate1, startDate2, localizer, tz, RegionalFormatBundleKey.DATE_FORMAT));</span>

		//ShiftTypes
<span class="nc" id="L216">		Date endDate1 = (Date) (ssRequest.getEndDates()).get(0);</span>
<span class="nc" id="L217">		Date endDate2 = (Date) (ssRequest.getEndDates()).get(1);</span>
<span class="nc" id="L218">		String shiftType1 = (String) ssRequest.getShiftTypes().get(0);</span>
<span class="nc" id="L219">		String shiftType2 = (String) ssRequest.getShiftTypes().get(1);</span>
<span class="nc bnc" id="L220" title="All 4 branches missed.">		if (TIME_OFF.equals(shiftType1) &amp;&amp; SHIFT.equals(shiftType2)) {</span>
<span class="nc" id="L221">			row_data.add(m_dayLabel + &quot;&lt;br&gt;&quot; + timeSecs(startDate2, localizer, tz));</span>
<span class="nc" id="L222">			row_data.add(m_offLabel + &quot;&lt;br&gt;&quot; + timeSecs(endDate2, localizer, tz));</span>
<span class="nc bnc" id="L223" title="All 4 branches missed.">		} else if (SHIFT.equals(shiftType1) &amp;&amp; TIME_OFF.equals(shiftType2)) {</span>
<span class="nc" id="L224">			row_data.add(timeSecs(startDate1, localizer, tz) + &quot;&lt;br&gt;&quot; + m_dayLabel);</span>
<span class="nc" id="L225">			row_data.add(timeSecs(endDate1, localizer, tz) + &quot;&lt;br&gt;&quot; + m_offLabel);</span>
		} else {
<span class="nc" id="L227">			row_data.add(format(startDate1, startDate2, localizer, tz, RegionalFormatBundleKey.TIME_FORMAT));</span>
<span class="nc" id="L228">			row_data.add(format(endDate1, endDate2, localizer, tz, RegionalFormatBundleKey.TIME_FORMAT));</span>
		}
<span class="nc" id="L230">	}</span>
    
  /**
   * Format Shift Date
   * 
   * @param ssItem The Shift Swap Item
   * @param localizer Localzier
	 * @param tz TimeZone
   * @return the formatted display
   */ 
  public static String formatShiftDate(ShiftSwapItem ssItem, Localizer localizer, TimeZone tz) {
<span class="nc" id="L241">    String result = &quot;&quot;;</span>
    
<span class="nc" id="L243">    String shiftType = ssItem.getShiftType();</span>
<span class="nc" id="L244">    Date startDate = ssItem.getDisplayStartDate();</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">    if (TIME_OFF.equals(shiftType)) {</span>
<span class="nc" id="L246">      result = localizer.formatDate(startDate, tz, RegionalFormatBundleKey.DATE_FORMAT);</span>
    } else {
<span class="nc" id="L248">      Date endDate = ssItem.getEndDate();</span>
<span class="nc" id="L249">      result = localizer.formatDate(startDate, tz, RegionalFormatBundleKey.DATE_FORMAT) +</span>
<span class="nc" id="L250">        &quot; &quot; + localizer.formatDate(startDate, tz, RegionalFormatBundleKey.TIME_FORMAT) +</span>
<span class="nc" id="L251">        &quot;-&quot; + localizer.formatDate(endDate,  tz, RegionalFormatBundleKey.TIME_FORMAT);</span>
    }
<span class="nc" id="L253">    return result;</span>
  }
	
	/**
	 * Add Post Expiration Date
	 */
	public static void addPostExpirationDate(ShiftSwapPosting ssPosting,
	Localizer localizer, TimeZone tz, DefaultMultiColumnNodeData row_data) {
		//Post Expiration Date
<span class="nc" id="L262">		Date expireDate = ssPosting.getExpirationDate();</span>
<span class="nc" id="L263">		DateWrapper dw = new DateWrapper(expireDate, localizer, tz, RegionalFormatBundleKey.DATE_FORMAT,  RegionalFormatBundleKey.TIME_FORMAT);</span>
<span class="nc" id="L264">		row_data.add( dw, CSSUtil.STYLE_NOWRAP );</span>
<span class="nc" id="L265">	}</span>
	
	/**
	 * Add Post Expiration Date
	 */
	public static void addPostExpirationDate(ShiftSwapRequest ssRequest, 
	Localizer localizer, TimeZone tz, DefaultMultiColumnNodeData row_data) {
		//Post Expiration Date
<span class="nc" id="L273">		Date expireDate1 = (Date)(ssRequest.getExpirationDates()).get(0);</span>
<span class="nc" id="L274">		Date expireDate2 = (Date)(ssRequest.getExpirationDates()).get(1);</span>
<span class="nc" id="L275">		row_data.add(formatDateTime(expireDate1, expireDate2, localizer, tz, RegionalFormatBundleKey.DATE_FORMAT, RegionalFormatBundleKey.TIME_SEC_FORMAT));</span>
<span class="nc" id="L276">	}		</span>
	
	
	/**
	 * Add Confirm Data
	 */
	public static void addConfirmData(ShiftSwapPosting ssPosting,
			Localizer localizer, DefaultMultiColumnNodeData row_data) {
<span class="nc" id="L284">		String data = localizer.formatYesNo(ssPosting.getNegotiation());</span>
<span class="nc" id="L285">		row_data.add( data );</span>
<span class="nc" id="L286">	}	</span>
	
	/**
	 * Add Partial info
	 */
	public static void addIsPartial(ShiftSwapPosting ssPosting,
			Localizer localizer, DefaultMultiColumnNodeData row_data) {
<span class="nc" id="L293">		String data = localizer.formatYesNo(ssPosting.getIsPartial());</span>
<span class="nc" id="L294">		row_data.add( data );</span>
<span class="nc" id="L295">	}</span>
	
	/**
	 * Add Is partial Shift Data
	 */
	public static void addIsPartialData(ShiftSwapRequest ssRequest,
		Localizer localizer, DefaultMultiColumnNodeData row_data) {
<span class="nc" id="L302">		Boolean b1 = new Boolean(ssRequest.getShiftSwapItems().get(0).getIsPartial());</span>
<span class="nc" id="L303">		Boolean b2 = new Boolean(ssRequest.getShiftSwapItems().get(1).getIsPartial());</span>
<span class="nc" id="L304">		String data = localizer.formatYesNo(b1.booleanValue()) + &quot;&lt;br&gt;&quot; +</span>
<span class="nc" id="L305">			localizer.formatYesNo(b2.booleanValue());</span>
<span class="nc" id="L306">		row_data.add( data );</span>
<span class="nc" id="L307">	}</span>
	
	/**
	 * Add Confirm Data
	 */
	public static void addConfirmData(ShiftSwapRequest ssRequest,
			Localizer localizer, DefaultMultiColumnNodeData row_data) {
<span class="nc" id="L314">		Boolean b1 = (Boolean)ssRequest.getNegotiations().get(0);</span>
<span class="nc" id="L315">		Boolean b2 = (Boolean)ssRequest.getNegotiations().get(1);		</span>
<span class="nc" id="L316">		String data = localizer.formatYesNo(b1.booleanValue()) + &quot;&lt;br&gt;&quot; +</span>
<span class="nc" id="L317">			localizer.formatYesNo(b2.booleanValue());</span>
<span class="nc" id="L318">		row_data.add( data );</span>
<span class="nc" id="L319">	}</span>
	
	/**
	 * Add Seniority Data for emp1 and emp2 to the Seniority column of the Shift Swap Requests list
	 */
	public static void addSeniorityData(ShiftSwapRequest ssRequest,
		Localizer localizer, DefaultMultiColumnNodeData row_data, TimeZone tz) 
	{
<span class="nc" id="L327">		ID empID1 = ssRequest.getShiftSwapItems().get(0).getEmployeeID();</span>
<span class="nc" id="L328">		ID empID2 = ssRequest.getShiftSwapItems().get(1).getEmployeeID();</span>
		
<span class="nc" id="L330">		String data = &quot;&amp;nbsp;&quot;;</span>
<span class="nc bnc" id="L331" title="All 4 branches missed.">		if (empID1 != null &amp;&amp; empID2 != null)</span>
		{
<span class="nc" id="L333">			Employee emp1 = getBasicEmployee(empID1);</span>
<span class="nc" id="L334">			Employee emp2 = getBasicEmployee(empID2);</span>
			
<span class="nc bnc" id="L336" title="All 4 branches missed.">			if (emp1 != null &amp;&amp; emp2 != null)</span>
			{
<span class="nc" id="L338">				Date date1 = emp1.getStartTime();</span>
<span class="nc" id="L339">				Date date2 = emp2.getStartTime();</span>
			
<span class="nc" id="L341">				data = new DateWrapper(date1, localizer, tz, RegionalFormatBundleKey.DATE_FORMAT) + &quot;&lt;br&gt;&quot; +</span>
				       new DateWrapper(date2, localizer, tz, RegionalFormatBundleKey.DATE_FORMAT);
			}
		}
<span class="nc" id="L345">		row_data.add( data );</span>
<span class="nc" id="L346">	}</span>
	
	/**
	 * Add Rank Data for emp1 and emp2 to the Rank column of the Shift Swap Requests list
	 */
	public static void addRankData(ShiftSwapRequest ssRequest,
		Localizer localizer, DefaultMultiColumnNodeData row_data) 
	{
<span class="nc" id="L354">		ID empID1 = ssRequest.getShiftSwapItems().get(0).getEmployeeID();</span>
<span class="nc" id="L355">		ID empID2 = ssRequest.getShiftSwapItems().get(1).getEmployeeID();</span>
		
<span class="nc" id="L357">		String data = &quot;&amp;nbsp;&quot;;</span>
<span class="nc bnc" id="L358" title="All 4 branches missed.">		if (empID1 != null &amp;&amp; empID2 != null)</span>
		{
<span class="nc" id="L360">			Employee emp1 = getEmployee(empID1, Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);</span>
<span class="nc" id="L361">			Employee emp2 = getEmployee(empID2, Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);</span>
			
<span class="nc bnc" id="L363" title="All 4 branches missed.">			if (emp1 != null &amp;&amp; emp2 != null)</span>
			{
<span class="nc" id="L365">				int rank1 = emp1.getRank();</span>
<span class="nc" id="L366">				int rank2 = emp2.getRank();</span>
			
<span class="nc" id="L368">				data = &quot;&quot; + rank1 + &quot;&lt;br&gt;&quot; + rank2;</span>
			}
		}
<span class="nc" id="L371">		row_data.add( data );</span>
<span class="nc" id="L372">	}</span>
	
	/**
	 * Get an employee, using Employee.DETAIL_LEVEL_EMPLOYEE_BASIC
	 */
	public static Employee getEmployee(ID empID, int detailLevel)
	{
<span class="nc" id="L379">		Employee emp = null;</span>
        try 
        {
<span class="nc" id="L382">            emp = ValidationUtil.getEmployeeByID(empID, null, detailLevel);</span>
        }
<span class="nc" id="L384">        catch (Exception ex)</span>
        {
<span class="nc" id="L386">        }</span>
<span class="nc" id="L387">        return emp;</span>
	}
	
	/**
	 * Get an employee, using Employee.DETAIL_LEVEL_EMPLOYEE_BASIC
	 */
	public static Employee getBasicEmployee(ID empID)
	{
<span class="nc" id="L395">		Employee emp = null;</span>
        try 
        {
<span class="nc" id="L398">            emp = ValidationUtil.getEmployeeByID(empID, null, Employee.DETAIL_LEVEL_EMPLOYEE_BASIC);</span>
        }
<span class="nc" id="L400">        catch (Exception ex)</span>
        {
<span class="nc" id="L402">        }</span>
<span class="nc" id="L403">        return emp;</span>
	}

	/**
	 * Add Swap Type Image
	 */
	public static void addSwapTypeImage(String swapType, 
	ResourceBundle bundle, Localizer localizer, DefaultMultiColumnNodeData row_data) {
		//Swap Type Image
<span class="nc" id="L412">		String swapImage=&quot;&quot;;</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">		if (ShiftSwapRequest.SHIFTSWAP_TYPE_ONEWAY.equals(swapType)) {</span>
<span class="nc" id="L414">			String alt = localizer.i18n(bundle, RmWebBundleKey.SWAPTYPE_ONEWAY);</span>
<span class="nc" id="L415">			swapImage = HtmlUtil.imageTag(RmImageFileID.SWAP_BOARD_ONEWAY, null, null, alt);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">		} else if (ShiftSwapRequest.SHIFTSWAP_TYPE_TWOWAY.equals(swapType)) {</span>
<span class="nc" id="L417">			String alt = localizer.i18n(bundle, RmWebBundleKey.SWAPTYPE_TWOWAY);</span>
<span class="nc" id="L418">			swapImage = HtmlUtil.imageTag(RmImageFileID.SWAP_BOARD_TWOWAY, null, null, alt);</span>
		}
		
<span class="nc" id="L421">	  String data = &quot;&lt;center&gt;&quot; + swapImage + &quot;&lt;/center&gt;&quot;;</span>
<span class="nc" id="L422">		row_data.add( data );</span>
<span class="nc" id="L423">	}	</span>
	
	/**
	 * Create Two Row of display where each row does not have breaks
	 */
	public static String createTwoRow(String item1, String item2) {		
<span class="nc" id="L429">		return &quot;&lt;nobr&gt;&quot; + item1 + &quot;&lt;/nobr&gt;&lt;br&gt;&lt;nobr&gt;&quot; + item2 + &quot;&lt;/nobr&gt;&quot;;</span>
	}	
	
	/**
	 * Return Time with Second for specififed date
	 */
	private static String timeSecs(Date date, Localizer localizer, TimeZone tz) {
<span class="nc" id="L436">		return localizer.formatDate(date,tz, RegionalFormatBundleKey.TIME_SEC_FORMAT);</span>
	}
	
	/**
	 * Format the Specified dates in Two Rows
	 */
	private static String format(Date date1, Date date2, Localizer localizer, TimeZone tz,
			String patternKey) {
<span class="nc" id="L444">		String d1 = localizer.formatDate(date1, tz, patternKey);</span>
<span class="nc" id="L445">		String d2 = localizer.formatDate(date2, tz, patternKey);</span>
<span class="nc" id="L446">		return createTwoRow(d1, d2);</span>
	}

	/**
	 * Format the Specified dates in Two Rows
	 */
	private static String formatDateTime(Date date1, Date date2, Localizer localizer, TimeZone tz,
			String datePatternKey, String timePatternKey) {
<span class="nc" id="L454">		String d1 = localizer.formatDate(date1, tz, datePatternKey, timePatternKey);</span>
<span class="nc" id="L455">		String d2 = localizer.formatDate(date2, tz, datePatternKey, timePatternKey);</span>
<span class="nc" id="L456">		return createTwoRow(d1, d2);</span>
	}


	/**
	 * Return true if Shift Swap Item contains a Time Off Shift
	 */
	public static boolean isTimeOffShift(ShiftSwapItem item) {
<span class="nc" id="L464">		String shiftType = item.getShiftType();</span>
<span class="nc" id="L465">		return ShiftSwapItem.SWAPITEMTYPE_TIMEOFF.equals(shiftType);</span>
	}
	
	/**
	 * Return true if shift Type is Time Off
	 */
	public static boolean isTimeOffShift(String shiftType) {
<span class="nc" id="L472">		return ShiftSwapItem.SWAPITEMTYPE_TIMEOFF.equals(shiftType);</span>
	}	

	public static boolean isShift(ShiftSwapItem item) {
<span class="nc" id="L476">		return ShiftSwapItem.SWAPITEMTYPE_SHIFT.equalsIgnoreCase(item.getShiftType());</span>
	}

	public static boolean isShift(String shiftType) {
<span class="nc" id="L480">		return ShiftSwapItem.SWAPITEMTYPE_SHIFT.equalsIgnoreCase(shiftType);</span>
	}

	public static boolean isOneWay(String swapType) {
<span class="nc" id="L484">		return ShiftSwapRequest.SHIFTSWAP_TYPE_ONEWAY.equalsIgnoreCase(swapType);</span>
	}

	public static boolean isTwoWay(String swapType) {
<span class="nc" id="L488">		return ShiftSwapRequest.SHIFTSWAP_TYPE_TWOWAY.equalsIgnoreCase(swapType);</span>
	}

	/**
	 * Adjust Shift Swap Item Dates with Scheduled Shift or Day Off 
	 * Start and End Dates
	 *
	 * It automatically adds error message to page model if any.
	 */
	public static boolean adjustShiftSwapItemDates(ShiftSwapItem item, Date shiftDate, 
	Localizer localizer, TimeZone tz, IHavePageMessage model) {
<span class="nc" id="L499">		boolean success = true;</span>

		try {
<span class="nc" id="L502">			ID empID = item.getEmployeeID();</span>
<span class="nc" id="L503">			Event event = RequestsMH.findShiftAssignmentEvent(empID, shiftDate, tz);</span>
			
<span class="nc" id="L505">			boolean isTimeOffShift = isTimeOffShift(item);</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">			success = isTimeOffShift</span>
<span class="nc" id="L507">			  ? adjustShiftSwapItemForDayOff(item, shiftDate, tz, event)</span>
<span class="nc" id="L508">				: adjustShiftSwapItemForShift(item, event);</span>
				
<span class="nc bnc" id="L510" title="All 2 branches missed.">			if (!success) {</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">				String rbKey = isTimeOffShift</span>
				  ? RmWebBundleKey.NO_DAYOFF_ON_DATE : RmWebBundleKey.NO_SHIFT_ON_DATE;
				
<span class="nc" id="L514">				String[] args = new String[] {</span>
<span class="nc" id="L515">					localizer.formatDate(shiftDate, tz, RegionalFormatBundleKey.DATE_FORMAT)</span>
				};
<span class="nc" id="L517">				model.addPageMessage(Message.ERROR_TYPE, rbKey, </span>
				  RmWebBundleKey.BUNDLE_NAME, args);
			}
<span class="nc" id="L520">		} catch (Exception ex) {</span>
<span class="nc" id="L521">			success=false;</span>
<span class="nc" id="L522">			m_log.l7dError(RmWebLogBundleKey.ERROR_FINDING_SHIFT, ex);</span>
<span class="nc" id="L523">			model.addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.ERROR_FINDING_SHIFT,</span>
				RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L525">		}</span>
						
<span class="nc" id="L527">		return success;</span>
	}
		
	/**
	 * Adjust Shift Swap Item Dates with Scheduled Shift Start and End Dates
	 */
	public static boolean adjustShiftSwapItemForShift(ShiftSwapItem item, Event event) {
<span class="nc bnc" id="L534" title="All 2 branches missed.">		boolean success = (event != null);</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">		if (success) {</span>
<span class="nc" id="L536">			item.setStartDate( ScheduleViewUtil.getDisplayStartTime((ShiftAssignment)event) );</span>
<span class="nc" id="L537">			item.setEndDate( event.getEndTime() );</span>
		} 
		
<span class="nc" id="L540">    return success;</span>
	}	
	
	/**
	 * Adjust Shift Swap item Start and End Date for Day Off
	 */
	public static boolean adjustShiftSwapItemForDayOff(ShiftSwapItem item, Date shiftDate, TimeZone tz, Event event) {
<span class="nc bnc" id="L547" title="All 2 branches missed.">		boolean success = (event == null);</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">		if (success) {</span>
<span class="nc" id="L549">			Date dayStart = DateTimeUtil.getDayStart(shiftDate, tz);</span>
<span class="nc" id="L550">			Date dayEnd = DateTimeUtil.getDayEnd(shiftDate, tz);</span>
<span class="nc" id="L551">			item.setStartDate(dayStart);</span>
<span class="nc" id="L552">			item.setEndDate(dayEnd);</span>
		}
		
<span class="nc" id="L555">		return success;</span>
	}
  
  /**
   * Create Shift Swap Menu PC
   */
  public static DialogToolbarMenuPC createShiftSwapMenu(RequestContext context, ToolbarPC toolbar, String name) {
<span class="nc" id="L562">    DialogToolbarMenuPC newSwapMenuPC = new DialogToolbarMenuPC(context, toolbar);</span>
<span class="nc" id="L563">    newSwapMenuPC.setName(name);</span>

<span class="nc" id="L565">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L566">    ResourceBundle bundle = localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>
    
    // Initialize Title
<span class="nc" id="L569">    String title = localizer.i18n(bundle, RmWebBundleKey.REQUEST_TYPE_SHIFT_SWAP);</span>
<span class="nc" id="L570">    newSwapMenuPC.setHeader(title);</span>

    // Initialize Menu Buttons
<span class="nc" id="L573">    newSwapMenuPC.addPopupWindowButton(RmPageAction.POPUP_SWAPBOARD_POSTING_FORM_ACTION,</span>
<span class="nc" id="L574">      localizer.i18n(bundle, RmWebBundleKey.CREATE_NEW_POSTING), true);</span>

<span class="nc" id="L576">    newSwapMenuPC.addPopupWindowButton(RmPageAction.POPUP_SHIFTSWAP_REQUEST_FORM_ACTION,</span>
<span class="nc" id="L577">      localizer.i18n(bundle, RmWebBundleKey.CREATE_NEW_REQUEST), true);</span>
    
<span class="nc" id="L579">    return newSwapMenuPC;</span>
  }
  
	/**
	 * Can the current user submit the shift swap request to the manager?
	 * We must check that isNegotiationRequired is FALSE for the SECOND ShiftSwapItem
	 * @param request The Shift Swap Request object
	 * @return true if the current user can submit the shift swap request to the manager, false otherwise.
	 */
	public static boolean canUserSubmitShiftSwapToManager(ID empID, ShiftSwapRequest request) 
	{
<span class="nc" id="L590">		List ssItems = request.getShiftSwapItems();</span>
<span class="nc" id="L591">		ShiftSwapItem ssItem1 = (ShiftSwapItem)ssItems.get(0);</span>
<span class="nc" id="L592">		ShiftSwapItem ssItem2 = (ShiftSwapItem)ssItems.get(1);</span>

		//item2 should be the ShiftSwapItem for the other employee
<span class="nc bnc" id="L595" title="All 2 branches missed.">		if (!empID.equals(ssItem1.getEmployeeID()) &amp;&amp;</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">			 empID.equals(ssItem2.getEmployeeID())) </span>
		{
<span class="nc" id="L598">			ssItem2 = ssItem1;</span>
		}
<span class="nc bnc" id="L600" title="All 2 branches missed.">		return !ssItem2.getNegotiation();</span>
	}
	
	
	//QC(96672) changes -- created duplicate of createSkillPopupLink() function 
	public static String createSkillPopupLinkNew(User user, ID empID, Map eNameMap, 
			Map eOrgMap, String empIDs, Localizer localizer,long emp1ShiftDate , long emp2ShiftDate) {
<span class="nc" id="L607">				EmployeeName empName = (EmployeeName)eNameMap.get(empID);	</span>
<span class="nc" id="L608">				String eNameDisplay = localizer.formatName(empName);</span>
<span class="nc" id="L609">				String result = eNameDisplay;</span>
				
<span class="nc bnc" id="L611" title="All 2 branches missed.">				if (isSkillLinkEnabled(user, empID, eOrgMap)) {</span>
<span class="nc" id="L612">		      String alt = localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.BBM_PEOPLE_SKILLS);</span>
<span class="nc" id="L613">					String onClickJS = SKILL_POPUP_FUNC_START_New + empIDs +&quot;'),&quot;+emp1ShiftDate +&quot;,&quot;+emp2ShiftDate + SKILL_POPUP_FUNC_END_New;</span>
<span class="nc" id="L614">					result = HtmlLinkUtil.createActiveLink(eNameDisplay, alt, &quot;&quot;, onClickJS);</span>
				}
				
<span class="nc" id="L617">				return result;</span>
			}

	/**
	 * Gets the employee items from the request where the firstEmployeeID's item is the first of the pair.
	 */
	public static Pair&lt;ShiftSwapItem, ShiftSwapItem&gt; getEmployeeItems(ShiftSwapRequest request, ID firstEmployeeID) {
<span class="nc" id="L624">		List&lt;ShiftSwapItem&gt; ssItems = request.getShiftSwapItems();</span>
<span class="nc" id="L625">		ShiftSwapItem ssItem1 = ssItems.get(0);</span>
<span class="nc" id="L626">		ShiftSwapItem ssItem2 = ssItems.get(1);</span>

<span class="nc bnc" id="L628" title="All 2 branches missed.">		if (firstEmployeeID.equals(ssItem1.getEmployeeID())) {</span>
<span class="nc" id="L629">			return new Pair&lt;ShiftSwapItem, ShiftSwapItem&gt;(ssItem1, ssItem2);</span>
		}
<span class="nc" id="L631">		return new Pair&lt;ShiftSwapItem, ShiftSwapItem&gt;(ssItem2, ssItem1);</span>
	}

	/**
	 * Gets the negotiation counts for the shift swap items in the request.  First Count is for the first item.
	 * The second count is for the second item.
	 */
	public static Pair&lt;Integer, Integer&gt; getNegotiationCounts(Localizer localizer, ShiftSwapRequest request)
			throws RemoteException, CoreException {
		// logic from ShiftSwapRequestFormPopupPM.addNegotiatioCommentRow
<span class="nc" id="L641">		ID emp1ID = request.getFirstEmployeeID();</span>
<span class="nc" id="L642">		ID emp2ID = request.getSecondEmployeeID();</span>
<span class="nc" id="L643">		int emp1Count = 0;</span>
<span class="nc" id="L644">		int emp2Count = 0;</span>

		// get the &quot;Updated&quot; note string
<span class="nc" id="L647">		String sUpdatedNote = localizer.i18n(RmEjbBundleKey.BUNDLE_NAME, RmEjbBundleKey.UPDATED);</span>

<span class="nc" id="L649">		Map&lt;ID, User&gt; userMap = RequestsMH.getUserMapForRequest(request);</span>
<span class="nc" id="L650">		Collection&lt;RequestAuditTrail&gt; auditTrails = request.getAuditTrail();</span>

<span class="nc bnc" id="L652" title="All 2 branches missed.">		for (RequestAuditTrail rat : auditTrails) {</span>
<span class="nc" id="L653">			User user = userMap.get(rat.getBpUserId());</span>
<span class="nc bnc" id="L654" title="All 4 branches missed.">			if (rat.getNote().equals(sUpdatedNote) &amp;&amp; user != null) {</span>
				// It seems like this old logic won't work once these are properly localized
<span class="nc" id="L656">				ID employeeID = user.getEmployeeID();</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">				if (employeeID.equals(emp1ID)) {</span>
<span class="nc" id="L658">					emp1Count++;</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">				} else if (emp2ID.equals(employeeID)) {</span>
<span class="nc" id="L660">					emp2Count++;</span>
				}
			}
<span class="nc" id="L663">		}</span>
<span class="nc" id="L664">		return new Pair&lt;Integer, Integer&gt;(emp1Count, emp2Count);</span>
	}

	public static boolean isWithdrawalNegotiation(ShiftSwapRequest request) {
<span class="nc bnc" id="L668" title="All 2 branches missed.">		return request.getWithdrawInfo() != null</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">				&amp;&amp; request.getWithdrawInfo().getRequestStatus().equalsIgnoreCase(RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>