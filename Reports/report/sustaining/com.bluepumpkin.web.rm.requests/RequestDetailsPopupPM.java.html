<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestDetailsPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests</a> &gt; <span class="el_source">RequestDetailsPopupPM.java</span></div><h1>RequestDetailsPopupPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.util.ThreadLocalCache;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.container.MultiColCollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.html.CSSUtil;

/**
 * Title:		     RequestDetailsPopupPM
 * Description:  Base calss for Request Details Popup Page
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, inc
 * @author       David Su
 * @version      1.0
 */
public abstract class RequestDetailsPopupPM extends RequestFormPopupPM
		implements ContainersInRowsPM {
	private static final String HISTORY_TABLE_NAME = &quot;historyTable&quot;;

	protected ContainerList m_containerList;
	protected FormTwoColumnPC m_mainContainerPC;
	protected MultiColListPC m_auditTrailListPC;

<span class="nc" id="L49">	protected Collection m_auditTrails = Collections.emptyList();</span>
<span class="nc" id="L50">	protected Map m_empNameMap = Collections.emptyMap();</span>
<span class="nc" id="L51">	protected Map m_userMap = Collections.emptyMap();</span>
<span class="nc" id="L52">	protected boolean m_isAuthorized = false;</span>

	/**
	 * Constructor
	 */
	public RequestDetailsPopupPM(RequestContext context, String formAction) {
<span class="nc" id="L58">		super(context, formAction);</span>

<span class="nc" id="L60">		m_containerList = new ContainerList(this, 3);</span>
<span class="nc" id="L61">	}</span>

	/**
	 * Initialize Model with Data
	 */
	@Override
	protected void initializeModel() {
<span class="nc bnc" id="L68" title="All 2 branches missed.">		if (m_isInitialized) {</span>
<span class="nc" id="L69">			return;</span>
		}

<span class="nc" id="L72">		boolean cacheEnabled = false;</span>

<span class="nc" id="L74">		m_isInitialized = true;</span>

		try	{
<span class="nc" id="L77">			cacheEnabled = ThreadLocalCache.enable();</span>
<span class="nc" id="L78">			ID requestID = getRequestID();</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">			if (requestID!=null) {</span>
<span class="nc" id="L80">				m_request = fetchRequest(requestID);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">				if (m_request == null)</span>
<span class="nc" id="L82">					this.addPageMessage(Message.ERROR_TYPE, i18n(m_bundle, RmWebBundleKey.REQUEST_NOT_FOUND_ERROR));</span>
<span class="nc" id="L83">				loadRequestDetailInfo(m_request);</span>
			}
<span class="nc" id="L85">		} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L86">			Message msg = handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L87">			msg.setAssociatedMessage(ex.getLocalizedMessage(m_localizer, m_context.getViewingTimeZone()));			</span>
<span class="nc" id="L88">		} catch (Exception ex) {</span>
<span class="nc" id="L89">			handleUnableToLoadDataError(log, ex);</span>
		} finally {
<span class="nc" id="L91">			ThreadLocalCache.clear(cacheEnabled);</span>
<span class="nc" id="L92">			initContentTitle();</span>
<span class="nc bnc" id="L93" title="All 8 branches missed.">			if (m_isAuthorized) {</span>
<span class="nc" id="L94">				initContent();</span>
			}
<span class="nc" id="L96">			initToolbar();</span>
<span class="nc" id="L97">		}</span>
<span class="nc" id="L98">	}</span>

	/**
	 * Fetch Sepecific Request for given ID
	 */
	protected abstract RequestAggregate fetchRequest(ID requestID) throws RmHardValidationException, Exception;

	/**
	 * Load Request Detail Information
	 */
	protected void loadRequestDetailInfo(RequestAggregate request) throws Exception {
<span class="nc" id="L109">		m_isAuthorized = RequestUtil.isAuthToView(m_context, request);</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">		if (m_isAuthorized) {</span>
<span class="nc" id="L112">			m_valResults = request.getValidationResults(true);</span>
<span class="nc" id="L113">			m_auditTrails = request.getAuditTrail();</span>

<span class="nc" id="L115">			m_userMap = RequestsMH.getUserMapForRequest(request);</span>
<span class="nc" id="L116">			m_empNameMap = RequestsMH.getEmpNameMap(m_context, m_userMap, request);</span>
<span class="nc" id="L117">			loadSpecifiedData();</span>
		}
<span class="nc" id="L119">	}</span>

	/**
	 * Load Specific Data
	 */
	protected abstract void loadSpecifiedData() throws Exception;

	/**
	 * Initialize Content
	 */
	protected abstract void initContent();

	/**
	 * Return Content Title Item Name
	 */
	protected abstract String getContentTitleItemName();


	/**
	 * Prepare content title for rendering
	 */
	protected void initContentTitle(){
<span class="nc" id="L141">		String pageTitle = i18n(m_common_bundle, UIFWebBundleKey.VIEW_DETAILS);</span>
<span class="nc" id="L142">		String itemName = getContentTitleItemName();</span>

<span class="nc" id="L144">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="nc" id="L145">		m_contentTitlePC.setItemName(itemName);</span>
<span class="nc" id="L146">	}</span>

	/**
	 * Prepare toolbar for rendering
	 */
	@Override
	protected void initToolbar(){
<span class="nc" id="L153">		m_toolbar.addCloseWindowTextButton(</span>
				PageAction.DONE,
<span class="nc" id="L155">				i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_DONE),</span>
				true);
<span class="nc" id="L157">	}</span>

	/** 
	 * Create New List PC. Overrides parent class.
	 */
	@Override
	protected MultiColListPC createNewList() {
<span class="nc" id="L164">		MultiColListPC listPC = new MultiColListPC(m_context);</span>
<span class="nc" id="L165">		listPC.setEnabled(false);</span>
<span class="nc" id="L166">		listPC.setIsBorderEnabled(true);</span>
<span class="nc" id="L167">		m_containerList.add(listPC);</span>
<span class="nc" id="L168">		return listPC;</span>
	}

	/**
	 * Create the collapsible Alert List PC. Overrides parent class.
	 */
	@Override
	protected MultiColCollapsibleContainerPC createAlertsList() {
<span class="nc" id="L176">		MultiColCollapsibleContainerPC listPC = super.createAlertsList();</span>
<span class="nc" id="L177">		m_containerList.add(listPC);</span>
<span class="nc" id="L178">		listPC.getMultiColListPC().setRowSelectable(false);</span>
<span class="nc" id="L179">		return listPC;</span>
	}	

	/**
	 * Initialize Main List
	 */
	protected void initMainList() {
<span class="nc" id="L186">		m_mainContainerPC = new FormTwoColumnPC(m_context);</span>
<span class="nc" id="L187">		m_containerList.add(m_mainContainerPC);</span>

<span class="nc" id="L189">		m_mainContainerPC.setWrapperCSSClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="nc" id="L190">		m_mainContainerPC.setLastRowType(FormTwoColumnPC.LAST_ROW_NONE);</span>
<span class="nc" id="L191">	}</span>

	/**
	 * Initialize Audit Trail List
	 */
	protected void initAuditTrailList() {
<span class="nc" id="L197">		m_auditTrailListPC = createComplianceModeList(i18n(m_bundle, RmWebBundleKey.STATUS_HISTORY_GRID));</span>
<span class="nc" id="L198">		m_containerList.add(m_auditTrailListPC);</span>
<span class="nc" id="L199">		m_auditTrailListPC.setHeightInPixels(200);</span>
<span class="nc" id="L200">		m_auditTrailListPC.setName(HISTORY_TABLE_NAME);</span>
<span class="nc" id="L201">		TableHeaderPC header = m_auditTrailListPC.getHeader();</span>
<span class="nc" id="L202">        header.addColumnHeaderData(&quot;&quot;, i18n(m_common_bundle, UIFWebBundleKey.DATE)); //508: moved date to first column</span>
<span class="nc" id="L203">		header.addColumnHeaderData(&quot;&quot;, i18n(m_common_bundle, UIFWebBundleKey.STATUS));</span>
<span class="nc" id="L204">		header.addColumnHeaderData(&quot;&quot;, i18n(m_common_bundle, UIFWebBundleKey.MODIFIED_BY));</span>
<span class="nc" id="L205">		header.addColumnHeaderData(&quot;&quot;, i18n(m_common_bundle, UIFWebBundleKey.COMMENTS));</span>

<span class="nc" id="L207">		List listModel = Collections.emptyList();</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">		if (!m_auditTrails.isEmpty()) {</span>
<span class="nc" id="L209">			listModel = new ArrayList(m_auditTrails.size());</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">			for (Iterator it=m_auditTrails.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L211">				RequestAuditTrail rat = (RequestAuditTrail)it.next();</span>
<span class="nc" id="L212">				MultiColumnNodeData node = createAuditTrailNode(rat);</span>
<span class="nc" id="L213">				listModel.add(node);</span>
<span class="nc" id="L214">			}</span>
		}

<span class="nc" id="L217">		m_auditTrailListPC.setTableAttribute(&quot;summary&quot;, i18n(m_bundle, RmWebBundleKey.AUDIT_TRAIL_TABLE));</span>
<span class="nc" id="L218">		m_auditTrailListPC.setListModel(listModel);</span>
<span class="nc" id="L219">	}</span>

	/**
	 * Return Employee Name
	 */
	protected String getEmployeeName(ID empID) {
<span class="nc" id="L225">		return getEmployeeName(empID, m_empNameMap);</span>
	}

	/**
	 * Return Audit Trail Modified By Name
	 */
	protected String getModifiedBy(ID userID) {
<span class="nc" id="L232">		String result = &quot;&quot;;</span>

<span class="nc" id="L234">		User user = (User)m_userMap.get(userID);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">		if (user!=null) {</span>
<span class="nc" id="L236">			result = user.getUserName();</span>

			// Replace User name if associated employee name is available
<span class="nc" id="L239">			ID empID = user.getEmployeeID();</span>
<span class="nc" id="L240">			EmployeeName eName = (EmployeeName)m_empNameMap.get(empID);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">			if (eName!=null) result = m_localizer.formatName(eName);</span>
		}

<span class="nc" id="L244">		return result;</span>
	}

	/**
	 * Create Audit Trail Node
	 */
	protected MultiColumnNodeData createAuditTrailNode(RequestAuditTrail rat) {
<span class="nc" id="L251">		DefaultMultiColumnNodeData node = new DefaultMultiColumnNodeData();</span>

        //508: moved date to first column
<span class="nc" id="L254">        String date = localizeDate(rat.getModifiedAt());</span>
<span class="nc" id="L255">        node.add(date, CSSUtil.STYLE_NORMAL_LEFT);</span>

<span class="nc bnc" id="L257" title="All 2 branches missed.">        String statusIcon = RequestUtil.createStatusIcon(rat.getStatus(), !isManagerMode(), m_localizer,null);</span>
<span class="nc" id="L258">		node.add(statusIcon);</span>

<span class="nc" id="L260">		String modifiedBy = getModifiedBy(rat.getBpUserId());</span>
<span class="nc" id="L261">		node.add(modifiedBy);</span>

<span class="nc" id="L263">		node.add(rat.getNote());</span>
<span class="nc" id="L264">		return node;</span>
	}

	/**
	 * Return localized Date
	 */
	protected String localizeDate(Date date) {
<span class="nc" id="L271">		return RequestUtil.getDateDisplay(m_context, date);</span>
	}


	/** Return List of Containers
	 *
	 * NOTE: Items in the Collection will be treated either as Page Components or
	 *       just a basic Object.
	 */
	@Override
	public Collection getContainers() {
<span class="nc" id="L282">		return m_containerList;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>