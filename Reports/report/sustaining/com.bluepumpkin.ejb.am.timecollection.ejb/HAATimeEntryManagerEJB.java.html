<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>HAATimeEntryManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.am.timecollection.ejb</a> &gt; <span class="el_source">HAATimeEntryManagerEJB.java</span></div><h1>HAATimeEntryManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.am.timecollection.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.NumberFactory;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.am.Log;
import com.bluepumpkin.ejb.am.base.AmException;
import com.bluepumpkin.ejb.am.l10n.AmEjbLogBundleKey;
import com.bluepumpkin.ejb.am.timecollection.model.ELEntry;
import com.bluepumpkin.ejb.am.timecollection.model.HAATimeEntry;
import com.bluepumpkin.ejb.am.timecollection.model.RawTimeEntry;
import com.bluepumpkin.ejb.am.timecollection.model.RawTimeEntryHandler;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;

/**
 * Title:        Blue Pumpkin Software Activity Management
 *
 * Description:  EJB Implementation for Time Collection
 *
 * Copyright:    Copyright (c) 2003
 * Company:      Blue Pumpkin Software, Inc
 * @author       Sheng Song
 * @version 2.0
 */

<span class="nc" id="L40">public class HAATimeEntryManagerEJB extends SessionEJBBase {</span>
	private static final String TABLENAME = &quot;HAATIMEENTRY&quot;;
<span class="nc" id="L42">	private static final String [] FIELDSTRING = {&quot;ID&quot;, &quot;DATASOURCEFAILUREID&quot;, &quot;EMPLOYEEID&quot;, &quot;ACTIVITYID&quot;, &quot;PUNCHTYPECODE&quot;, &quot;PUNCHTIME&quot;, &quot;PUNCHTIMESTAMP&quot;};</span>

	private static final String ELTABLENAME = &quot;ELEARNINGTIMEENTRY&quot;;
<span class="nc" id="L45">	private static final String [] ELFIELDSTRING = {&quot;ID&quot;, &quot;DATASOURCEID&quot;, &quot;EMPLOYEEID&quot;, &quot;ACTIVITYID&quot;, &quot;STARTTIME&quot;, &quot;ENDTIME&quot;};</span>
	private static final String elQueryString = &quot;select EMPLOYEEID, ACTIVITYID, STARTTIME from ELEARNINGTIMEENTRY where DATASOURCEID=? order by EMPLOYEEID, PUNCHTIMESTAMP&quot;;

	private static final String queryString = &quot;select EMPLOYEEID, ACTIVITYID, PUNCHTIMESTAMP, PUNCHTYPECODE  from HAATIMEENTRY where DATASOURCEFAILUREID=? order by EMPLOYEEID, PUNCHTIMESTAMP&quot;;
	private static final String deleteString = &quot;delete HAATIMEENTRY where DATASOURCEFAILUREID=?&quot;;

<span class="nc" id="L51">	private static boolean FixZeroDuration = true;</span>

<span class="nc" id="L53">	private static String clsName = HAATimeEntryManagerEJB.class.getName();</span>
<span class="nc" id="L54">	private static Category m_cat = Log.initCategory(clsName);</span>
	protected Category getCategory() {
<span class="nc" id="L56">		return m_cat;</span>
	}

	{
<span class="nc" id="L60">		super.init(clsName);</span>
<span class="nc" id="L61">	}</span>
	public void ejbCreate() {
		try {
			// Fix Zero duration entry?
<span class="nc" id="L65">			String valueStr = BbmManagerFactory.getDBConfigManager().getValue(ConfigKey.TIMERECORDS_EXPOSE_ZERO_DURATION);</span>
<span class="nc bnc" id="L66" title="All 4 branches missed.">			if (valueStr != null &amp;&amp; valueStr.equalsIgnoreCase(&quot;false&quot;)) {</span>
<span class="nc" id="L67">				FixZeroDuration = false;</span>
			} else {
<span class="nc" id="L69">				FixZeroDuration = true;</span>
			}
<span class="nc" id="L71">		} catch (Exception e) {</span>
			// log problem but continue operation with default values
			// alos set m_isConfigDataLoaded to false so next ejb will try to load agian
<span class="nc" id="L74">			m_cat.l7dError(AmEjbLogBundleKey.TIMECOLLECTOR_FAILURE_BP_CONFIG, e);</span>
<span class="nc" id="L75">		}</span>
<span class="nc" id="L76">	}</span>

	/**
	 * Remove all HAAEntries based on one ACDFailure record ID
	 * @param ID, dataSourceFailureID
	 * @throws AmException
	 */
	public void deleteHAATimeEntries(ID dataSourceFailureID) throws AmException {
<span class="nc" id="L84">		methodStart(&quot;deleteHAATimeEntries&quot;, dataSourceFailureID);</span>
<span class="nc" id="L85">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L87">			jdmo.executePCommand(deleteString, new Object[]{dataSourceFailureID});</span>
<span class="nc" id="L88">		} catch(JdmoException e) {</span>
<span class="nc" id="L89">			handleException(e);</span>
<span class="nc" id="L90">			throw new AmException(e);</span>
		} finally {
<span class="nc" id="L92">			jdmo.cleanUp();</span>
<span class="nc" id="L93">			methodFinish();</span>
<span class="nc" id="L94">		}</span>
<span class="nc" id="L95">	}</span>

	/**
	 * Retrieve all HAAEntries associated with one ACDFailure record, and categorize them via EmployeeID as RawTimeEntry
	 * @param ID, dataSourceFailureID
	 * @return HashMap (EmployeeID, ArrayList)
	 * @throws AmException
	 */
	public HashMap getHAATimeEntries(ID dataSourceFailureID) throws AmException {
<span class="nc" id="L104">		methodStart(&quot;getHAATimeEntries&quot;, dataSourceFailureID);</span>
<span class="nc" id="L105">		HashMap empHAAMap = new HashMap();</span>
<span class="nc" id="L106">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L108">			JdmoQuery jQuery = jdmo.createQuery(queryString, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L109">			jQuery.setParID(1, dataSourceFailureID);</span>
<span class="nc" id="L110">			JdmoRowset rs =  jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L112">				ID empID = rs.getID(1);</span>
<span class="nc" id="L113">				ArrayList HAAEntries = (ArrayList)empHAAMap.get(empID);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">				if (HAAEntries == null)</span>
<span class="nc" id="L115">					HAAEntries = new ArrayList();</span>
<span class="nc" id="L116">				RawTimeEntry entry = new RawTimeEntry(empID, rs.getID(2), null, null, rs.getInt(4), new Date(rs.getLong(3)));</span>
<span class="nc" id="L117">				HAAEntries.add(entry);</span>
<span class="nc" id="L118">				empHAAMap.put(empID, HAAEntries);</span>
<span class="nc" id="L119">			}</span>
			// normalize HAA entries
<span class="nc bnc" id="L121" title="All 2 branches missed.">			for (Iterator it = empHAAMap.keySet().iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L122">				ID empID = (ID)it.next();</span>
<span class="nc" id="L123">				ArrayList HAAEntries = (ArrayList)empHAAMap.get(empID);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">				if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L125">					m_cat.debug(&quot;Before normalization, raw entries are &quot;+HAAEntries);</span>
				}
				// normalize HAA entries
<span class="nc" id="L128">				empHAAMap.put(empID, RawTimeEntryHandler.normalizeEntries(HAAEntries, FixZeroDuration));</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">				if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L130">					m_cat.debug(&quot;After normalization, raw entries are &quot;+HAAEntries);</span>
				}
<span class="nc" id="L132">			}</span>
<span class="nc" id="L133">			return empHAAMap;</span>
<span class="nc" id="L134">		} catch(JdmoException e) {</span>
<span class="nc" id="L135">			handleException(e);</span>
<span class="nc" id="L136">			throw new AmException(e);</span>
		} finally {
<span class="nc" id="L138">			jdmo.cleanUp();</span>
<span class="nc" id="L139">			methodFinish();</span>
		}
	}

	/**
	 * Create bunch of HAA TimeEntries
	 * @param Collection, HAATimeEntries
	 * @return ID Collection
	 * @throws AmException
	 */
	public Collection createHAATimeEntries(ID dataSourceFailureID, Collection HAATimeEntries) throws AmException
	{
<span class="nc" id="L151">		methodStart(&quot;createHAATimeEntries&quot;, HAATimeEntries);</span>
<span class="nc" id="L152">		ArrayList paramValCol = new ArrayList(HAATimeEntries.size());</span>
<span class="nc" id="L153">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L155" title="All 2 branches missed.">			for (Iterator iter = HAATimeEntries.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L156">				HAATimeEntry element = (HAATimeEntry)iter.next();</span>
<span class="nc" id="L157">				Object[] params = new Object[FIELDSTRING.length];</span>
<span class="nc" id="L158">				params[0] = null;</span>
<span class="nc" id="L159">				params[1] = dataSourceFailureID;</span>
<span class="nc" id="L160">				params[2] = element.getEmployeeID();</span>
<span class="nc" id="L161">				params[3] = element.getActivityID();</span>
<span class="nc" id="L162">				params[4] = NumberFactory.newInteger(element.getPunchTypeCode());</span>
<span class="nc" id="L163">				params[5] = element.getPunchTime();</span>
<span class="nc" id="L164">				params[6] = new Long(element.getPunchTime().getTime());</span>
<span class="nc" id="L165">				paramValCol.add(params);</span>
<span class="nc" id="L166">			}</span>
<span class="nc" id="L167">			return jdmo.insertBatchAndExecute(TABLENAME, FIELDSTRING, paramValCol);</span>
<span class="nc" id="L168">		} catch(JdmoException e) {</span>
<span class="nc" id="L169">			handleException(e);</span>
<span class="nc" id="L170">			throw new AmException(e);</span>
		} finally {
<span class="nc" id="L172">			jdmo.cleanUp();</span>
<span class="nc" id="L173">			methodFinish();</span>
		}
	}

	/**
	 * Create on HAA Entry
	 * @param ID, DataSourceFailureID
	 * @param HAATimeEntry
	 * @return ID
	 * @throws AmException
	 */
	public ID createHAATimeEntry(ID dataSourceFailureID, HAATimeEntry timeEntry) throws AmException
	{
<span class="nc" id="L186">		methodStart(&quot;createHAATimeEntries&quot;, timeEntry);</span>
<span class="nc" id="L187">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L189">			HashMap map = new HashMap();</span>
<span class="nc" id="L190">			map.put(&quot;EMPLOYEEID&quot;, timeEntry.getEmployeeID());</span>
<span class="nc" id="L191">			map.put(&quot;DATASOURCEFAILUREID&quot;, dataSourceFailureID);</span>
<span class="nc" id="L192">			map.put(&quot;ACTIVITYID&quot;, timeEntry.getActivityID());</span>
<span class="nc" id="L193">			map.put(&quot;PUNCHTYPECODE&quot;, NumberFactory.newInteger(timeEntry.getPunchTypeCode()));</span>
<span class="nc" id="L194">			map.put(&quot;PUNCHTIME&quot;, timeEntry.getPunchTime());</span>
<span class="nc" id="L195">			map.put(&quot;PUNCHTIMESTAMP&quot;, new Long(timeEntry.getPunchTime().getTime()));</span>
<span class="nc" id="L196">			ID id = jdmo.addBatchInsert(TABLENAME, map);</span>
<span class="nc" id="L197">			jdmo.executeBatch();</span>
<span class="nc" id="L198">			return id;</span>
<span class="nc" id="L199">		} catch(JdmoException e) {</span>
<span class="nc" id="L200">			handleException(e);</span>
<span class="nc" id="L201">			throw new AmException(e);</span>
		} finally {
<span class="nc" id="L203">			jdmo.cleanUp();</span>
<span class="nc" id="L204">			methodFinish();</span>
		}
	}

	/**
	 * Create EL entries for a group of employees
	 * @param empELMap
	 * @throws AmException
	 * @throws RemoteException
	 */
	public void createELEntries(ID dsID, Map empELMap) throws AmException
	{
<span class="nc" id="L216">		methodStart(&quot;createELEntries&quot;, empELMap);</span>
<span class="nc" id="L217">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L219" title="All 2 branches missed.">			for (Iterator keyIT = empELMap.keySet().iterator(); keyIT.hasNext(); ) {</span>
<span class="nc" id="L220">				ID empID = (ID)keyIT.next();</span>
<span class="nc" id="L221">				Collection ELEntries = (Collection)empELMap.get(empID);</span>
<span class="nc" id="L222">				ArrayList paramValCol = new ArrayList(ELEntries.size());</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">				for (Iterator iter = ELEntries.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L224">					ELEntry element = (ELEntry)iter.next();</span>
<span class="nc" id="L225">					Object[] params = new Object[ELFIELDSTRING.length];</span>
<span class="nc" id="L226">					params[0] = null;</span>
<span class="nc" id="L227">					params[1] = dsID;</span>
<span class="nc" id="L228">					params[2] = element.getEmployeeID();</span>
<span class="nc" id="L229">					params[3] = element.getActivityID();</span>
<span class="nc" id="L230">					params[4] = element.getStartTime();</span>
<span class="nc" id="L231">					params[5] = element.getEndTime();</span>
<span class="nc" id="L232">					paramValCol.add(params);</span>
<span class="nc" id="L233">				}</span>
<span class="nc" id="L234">				jdmo.insertBatchAndExecute(ELTABLENAME, ELFIELDSTRING, paramValCol);</span>
<span class="nc" id="L235">			}</span>
<span class="nc" id="L236">		} catch(JdmoException e) {</span>
<span class="nc" id="L237">			handleException(e);</span>
<span class="nc" id="L238">			throw new AmException(e);</span>
		} finally {
<span class="nc" id="L240">			jdmo.cleanUp();</span>
<span class="nc" id="L241">			methodFinish();</span>
<span class="nc" id="L242">		}</span>
<span class="nc" id="L243">	}</span>

	/**
	 * Retrieve all ELEntries associated with one datasource ID and categorize them via EmployeeID
	 * @param ID, dsID
	 * @return HashMap (EmployeeID, ArrayList)
	 * @throws AmException
	 * @throws RemoteException
	 */
	public HashMap getELEntries(ID dsID) throws AmException
	{
<span class="nc" id="L254">		methodStart(&quot;getELEntries&quot;, dsID);</span>
<span class="nc" id="L255">		Jdmo jdmo = new Jdmo();</span>
<span class="nc" id="L256">		HashMap empELMap = new HashMap();</span>
		try {
<span class="nc" id="L258">			JdmoQuery jQuery = jdmo.createQuery(elQueryString, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L259">			jQuery.setParID(1, dsID);</span>
<span class="nc" id="L260">			JdmoRowset rs =  jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L262">				ID empID = rs.getID(1);</span>
<span class="nc" id="L263">				ArrayList ELEntries = (ArrayList)empELMap.get(empID);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">				if (ELEntries == null)</span>
<span class="nc" id="L265">					ELEntries = new ArrayList();</span>
<span class="nc" id="L266">				RawTimeEntry entry = new ELEntry(empID, rs.getID(2), null, null, TimeZoneUtil.toDate(rs.getTimestamp(3)), TimeZoneUtil.toDate(rs.getTimestamp(4)));</span>
<span class="nc" id="L267">				ELEntries.add(entry);</span>
<span class="nc" id="L268">				empELMap.put(empID, ELEntries);</span>
<span class="nc" id="L269">			}</span>
<span class="nc" id="L270">			return empELMap;</span>
<span class="nc" id="L271">		} catch(JdmoException e) {</span>
<span class="nc" id="L272">			handleException(e);</span>
<span class="nc" id="L273">			throw new AmException(e);</span>
		} finally {
<span class="nc" id="L275">			jdmo.cleanUp();</span>
<span class="nc" id="L276">			methodFinish();</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>