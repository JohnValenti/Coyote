<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueQueueListPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload.queue.mapping</a> &gt; <span class="el_source">QueueQueueListPM.java</span></div><h1>QueueQueueListPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload.queue.mapping;

import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.QueuePaginationData;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrgWorkpaneListPageModel;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.workload.WorkloadModelHandler;
import com.verint.web.wfm.keys.WfmJavaScriptFileID;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.UserPreferencesUtil;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title: JobTitleListPageModel Description: Display the list of Job Title
 * Copyright: Copyright (c) 2001 Company: Blue Pumpkin Software, inc
 * 
 * @author David Su
 * @version 1.0
 */
public class QueueQueueListPM extends OrgWorkpaneListPageModel {
<span class="nc" id="L45">    private static final Category log = Log.initCategory(QueueQueueListPM.class.getName());</span>

    private static final String LIST_NAME_SORT = &quot;NAME&quot;;
    private static final String LIST_DESCRIPTION_SORT = &quot;DESCRIPTION&quot;;
    private static final String LIST_MEDIA_TITLE_SORT = &quot;MEDIANAME&quot;;
    private static final String LIST_TYPE_TITLE_SORT = &quot;TYPENAME&quot;;
    private static final String LIST_MAPPING_TITLE_SORT = &quot;DSG&quot;;
    private static final String LIST_ORGANIZATION_SORT = &quot;ORGANIZATIONNAME&quot;;

    public static final String CAN_CONFIGURE = &quot;CAN_CONFIGURE&quot;;

    private Collection m_QueueList;
    private HashMap m_allQueuesMap;

<span class="nc" id="L59">    private boolean m_bIsScoped = true; // assume scoped</span>

<span class="nc" id="L61">    private final Map m_groupNameMap = Collections.emptyMap();</span>
<span class="nc" id="L62">    private final Map m_queueGroupMap = Collections.emptyMap();</span>

<span class="nc" id="L64">    private int totalNoOfPages = 1;</span>

    /**
     * Constructor
     */
    public QueueQueueListPM(RequestContext context) {
<span class="nc" id="L70">        super(context);</span>

<span class="nc" id="L72">        setName(&quot;queueQueue&quot;);</span>
<span class="nc" id="L73">        setJSMediator(WfmJavaScriptFileID.MEDIATOR_ORG_QUEUE_LIST_WORKPANE);</span>
<span class="nc" id="L74">        this.setIsPaginatingSelectedIDs(false);</span>
<span class="nc" id="L75">        setPageIDSize(UserPreferencesUtil.getDefaultPageRows(context));</span>
<span class="nc" id="L76">    }</span>

    /**
     * Return instance of Model which is ready to be rendered
     */
    public static PageModel getInstance(RequestContext context) {
<span class="nc" id="L82">        return getInstance(context, QueueQueueListPM.class);</span>
    }

    /**
     * Loads all the Job Title value objects for the selected Organization ID
     *
     * @return true if load was successful
     */
    private boolean loadQueues() {

        try {

            // determine if current user has access to selected Org..
<span class="nc bnc" id="L95" title="All 2 branches missed.">            if (m_context.getUser().isAuthorized(PrivilegeKeys.CORE_VIEWORGANIZATION, new ScopeID(getSelectedIDObject(), Scope.ORG_SCOPE))) {</span>
<span class="nc" id="L96">                final int from = (getPagePaginationIndex() * getPageIDSize()) + 1;</span>
<span class="nc" id="L97">                final List&lt;ID&gt; queueTypes = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L98">                queueTypes.add(ID.fromInt(Queue.QUEUE_TYPE_DISTRIBUTED));</span>
<span class="nc" id="L99">                queueTypes.add(ID.fromInt(Queue.QUEUE_TYPE_VIRTUAL));</span>
<span class="nc" id="L100">                final QueuePaginationData queuePaginationData = WorkloadModelHandler.getPaginatedParentQueuesByRecursedOrgID(m_context, getSelectedIDObject(), getSortColumn(), getSortOrder(), from, from + (getPageIDSize() - 1), false, queueTypes);</span>
<span class="nc" id="L101">                this.m_QueueList = queuePaginationData.getQueues();</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">                if ((queuePaginationData.getTotal() % getPageIDSize()) == 0) {</span>
<span class="nc" id="L103">                    this.totalNoOfPages = queuePaginationData.getTotal() / getPageIDSize();</span>
                } else {
<span class="nc" id="L105">                    this.totalNoOfPages = (queuePaginationData.getTotal() / getPageIDSize()) + 1;</span>
                }
<span class="nc bnc" id="L107" title="All 2 branches missed.">                if (totalNoOfPages &lt;= getPagePaginationIndex()) {</span>
<span class="nc" id="L108">                    setPagePaginationIndex(this.totalNoOfPages);</span>
                }
<span class="nc" id="L110">            } else {</span>
<span class="nc" id="L111">                addPageMessage(Message.INFO_TYPE, getNotAuthorizedToViewMsg());</span>
<span class="nc" id="L112">                m_bIsScoped = false;</span>
<span class="nc" id="L113">                return false;</span>

            }
<span class="nc" id="L116">            return true;</span>
<span class="nc" id="L117">        } catch (final Exception ex) {</span>
<span class="nc" id="L118">            handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L119">            return false;</span>
        }
    }

    /**
     * Initialize List
     */
    @Override
    protected void initList() {
<span class="nc" id="L128">        super.initList();</span>

        // Setup Headers
<span class="nc" id="L131">        final TableHeaderPC header = m_list.getHeader();</span>
<span class="nc" id="L132">        header.setSortable(true);</span>

<span class="nc" id="L134">        header.addColumnHeaderData(LIST_NAME_SORT, i18n(m_common_bundle, UIFWebBundleKey.LIST_HEADER_NAME), true);</span>
<span class="nc" id="L135">        header.addColumnHeaderData(LIST_DESCRIPTION_SORT, i18n(m_common_bundle, UIFWebBundleKey.LIST_HEADER_DESCRIPTION), false);</span>
        // header.addColumnHeaderData(LIST_ORGANIZATION_SORT, i18n(m_amBundle,
        // AmWebBundleKey.ORGANIZATION), true);
<span class="nc" id="L138">        header.addColumnHeaderData(LIST_ORGANIZATION_SORT, i18n(m_bbmBundle, BbmWebBundleKey.Organization), true);</span>
<span class="nc" id="L139">        header.addColumnHeaderData(LIST_MEDIA_TITLE_SORT, i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_LABEL_MEDIA), true);</span>
<span class="nc" id="L140">        header.addColumnHeaderData(LIST_TYPE_TITLE_SORT, i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_LABEL_TYPE), true);</span>
<span class="nc" id="L141">        header.addColumnHeaderData(LIST_MAPPING_TITLE_SORT, i18n(m_bbmBundle, BbmWebBundleKey.BBM_ORG_WORKLOADS_QUEUEQUEUE_MAPPING), false);</span>

        // Setup basic table property
<span class="nc" id="L144">        m_list.setIsAutoSortEnabled(true);</span>
<span class="nc" id="L145">        m_list.setMultiRowSelectable(false);</span>
<span class="nc" id="L146">        header.setSortColumn(getDefaultSortColumn());</span>
<span class="nc" id="L147">        setSortColumn(header.getSortColumn());</span>
<span class="nc" id="L148">        setSortOrder(header.getSortOrder());</span>
<span class="nc" id="L149">    }</span>

    public void setDefaultSortColumn() {
<span class="nc" id="L152">        final String a = getSortColumn();</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (m_list != null) {</span>
<span class="nc" id="L154">            final TableHeaderPC header = m_list.getHeader();</span>
<span class="nc bnc" id="L155" title="All 6 branches missed.">            if (header != null &amp;&amp; header.getSortColumn() != null &amp;&amp; header.getSortColumn().matches(&quot;^\\w+$&quot;)) {</span>
<span class="nc" id="L156">                m_context.setAttribute(RequestContext.SESSION_SCOPE, getSortColumnSessionName(), header.getSortColumn());</span>
            }
        }
<span class="nc" id="L159">    }</span>

    @Override
    public void setSortColumn(String column) {
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (column.matches(&quot;^\\w+$&quot;)) {</span>
<span class="nc" id="L164">            super.setSortColumn(column);</span>
        }
<span class="nc" id="L166">    }</span>

    @Override
    protected String getDefaultSortColumn() {
<span class="nc" id="L170">        final String sessionSortColumn = (String) m_context.getAttribute(RequestContext.SESSION_SCOPE, getSortColumnSessionName());</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (!StringUtil.isEmpty(sessionSortColumn)) {</span>
<span class="nc" id="L172">            return sessionSortColumn;</span>
        }

<span class="nc" id="L175">        return LIST_NAME_SORT;</span>
    }

    /**
     * get the sort column sesson key
     */
    private String getSortColumnSessionName() {
<span class="nc" id="L182">        final StringBuffer sessionName = new StringBuffer(64);</span>
<span class="nc" id="L183">        sessionName.append(getClass().getName()).append(&quot;sortColumn&quot;);</span>
<span class="nc" id="L184">        return sessionName.toString();</span>
    }

    /**
     * Create the list model
     */
    @Override
    protected void createListModel() {

<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (!loadQueues()) {</span>
<span class="nc" id="L194">            return;</span>
        }

        // String selected =
        // (String)m_context.getAttribute(RequestContext.SESSION_SCOPE,
        // &quot;CACHED_QUEUE_ID&quot;);
        // this.setPerformActionOnID(selected);

<span class="nc bnc" id="L202" title="All 4 branches missed.">        final boolean isAuth = m_bIsScoped &amp;&amp; isAuthorizedToConfigure();</span>
<span class="nc" id="L203">        final ID nSelectedOrgID = getSelectedIDObject();</span>

<span class="nc" id="L205">        final ArrayList listModel = new ArrayList();</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">        for (final Iterator it = m_QueueList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L207">            final Queue queue = (Queue) it.next();</span>

            // Create the row data
<span class="nc" id="L210">            final ID queueID = queue.getID();</span>
<span class="nc" id="L211">            final int qType = queue.getQueueType();</span>
<span class="nc" id="L212">            boolean isDeleteable = true;</span>
            try {
<span class="nc bnc" id="L214" title="All 4 branches missed.">                isDeleteable = !(WorkloadModelHandler.isQueueParent(m_context, queueID) || WorkloadModelHandler.isQueueLinkedToCampaign(queueID));</span>
<span class="nc" id="L215">            } catch (final Exception e) {</span>
<span class="nc" id="L216">                isDeleteable = false;</span>
<span class="nc" id="L217">            }</span>
<span class="nc" id="L218">            final String rowID = queueID.toString();</span>
<span class="nc" id="L219">            final DefaultMultiColumnNodeData row_data = new DefaultMultiColumnNodeData(rowID);</span>

<span class="nc" id="L221">            row_data.add(queue.getName());</span>
<span class="nc" id="L222">            row_data.add(queue.getDescription());</span>
<span class="nc" id="L223">            row_data.add(queue.getOrganizationName());</span>
<span class="nc" id="L224">            row_data.add(queue.getMediaName());</span>
<span class="nc" id="L225">            row_data.add(getQueueTypeName(queue.getQueueType()));</span>
<span class="nc" id="L226">            row_data.add(getParentMappingsStr(queue.getID()));</span>

            // Set if the row should be editable or not. Row should be
            // editable if the
            // selected org is the owner of the activity

<span class="nc" id="L232">            final HashMap rowAttributes = row_data.getNodeAttributes();</span>
<span class="nc bnc" id="L233" title="All 4 branches missed.">            if (isAuth &amp;&amp; nSelectedOrgID.equals(queue.getOrganizationID())) {</span>
<span class="nc" id="L234">                rowAttributes.put(IS_EDITABLE, &quot;true&quot;);</span>
<span class="nc" id="L235">                rowAttributes.put(IS_DELETEABLE, String.valueOf(isDeleteable));</span>

            } else {

<span class="nc" id="L239">                rowAttributes.put(IS_DELETEABLE, &quot;false&quot;);</span>
<span class="nc" id="L240">                rowAttributes.put(IS_EDITABLE, &quot;false&quot;);</span>
            }
<span class="nc" id="L242">            rowAttributes.put(IS_COPYABLE, &quot;false&quot;);</span>
<span class="nc" id="L243">            rowAttributes.put(COPY_ITEM_NAME, queue.getName());</span>

            // Add row data to list model
<span class="nc" id="L246">            listModel.add(row_data);</span>

            // Check if row should be selected, assuming only one should be
            // selected
<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (OrganizationModelHandler.UNREASONABLE_ORG_ID.equals(m_selectedRowOrgID)) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                if (this.isRowSelected(queue.getID())) {</span>
<span class="nc" id="L252">                    m_list.addSelectedRowID(rowID);</span>
<span class="nc" id="L253">                    m_selectedRowOrgID = queue.getOrganizationID();</span>
                }
            }

<span class="nc" id="L257">        } // end for</span>

<span class="nc" id="L259">        m_list.setListModel(listModel);</span>

<span class="nc" id="L261">    }</span>

    /**
     * Get entity name. Used for title.
     */
    @Override
    protected String getTitleEntityType() {
<span class="nc" id="L268">        return i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_LIST_TITLE);</span>
    }

    /**
     * Return URL for HTML Form Action
     */
    @Override
    public String getFormAction() {
        // System.out.println(&quot;returning Form action&quot;);
<span class="nc" id="L277">        return &quot;queuequeue_mapping&quot;;</span>
    }

    @Override
    protected void initToolbar() {

        // verticalise queue
<span class="nc" id="L284">        final Object[] args = new Object[1];</span>
<span class="nc" id="L285">        args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUESMALL);</span>

        // String addLabel = MessageFormat.format( i18n(m_bbmBundle,
        // BbmWebBundleKey.QUEUE_CREATE_ACTION), args);
        // String copyLabel = MessageFormat.format( i18n(m_bbmBundle,
        // BbmWebBundleKey.QUEUE_COPY_ACTION), args);
<span class="nc" id="L291">        final String editLabel = MessageFormat.format(i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_EDIT_ACTION), args);</span>
<span class="nc" id="L292">        final String deleteLabel = MessageFormat.format(i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_DELETE_ACTION), args);</span>

<span class="nc bnc" id="L294" title="All 4 branches missed.">        final boolean isAuth = m_bIsScoped &amp;&amp; isAuthorizedToConfigure();</span>
<span class="nc bnc" id="L295" title="All 4 branches missed.">        final boolean isBtnEnabled = isAuth &amp;&amp; !StringUtil.isEmpty(this.getPerformActionOnID());</span>
        // boolean isDelBtnEnabled = isBtnEnabled &amp;&amp;
        // !WorkloadModelHandler.isQueueParent(m_context, queueID);

<span class="nc" id="L299">        m_toolbar.setPagePagination(getPagePaginationIndex(), totalNoOfPages);</span>
<span class="nc" id="L300">        m_toolbar.getPagination().setButtonCustomJS(JSUtil.REFRESH_PAGE, JSUtil.REFRESH_PAGE);</span>

        // m_toolbar.addSubmitTextButton(PageAction.ADD, addLabel, isAuth);
<span class="nc" id="L303">        m_toolbar.addSubmitTextButton(PageAction.EDIT, editLabel, isBtnEnabled);</span>
        // m_toolbar.addSubmitTextButton(PageAction.QUEUE_COPY_ACTION,
        // copyLabel, isBtnEnabled);
<span class="nc" id="L306">        m_toolbar.addDeleteTextButton(PageAction.DELETE, deleteLabel, isBtnEnabled);</span>

<span class="nc" id="L308">    }</span>

    @Override
    protected boolean isSortSupported() {
<span class="nc" id="L312">        return m_list.isAutoSortEnabled();</span>
    }

    private String getQueueTypeName(int type) {
<span class="nc bnc" id="L316" title="All 5 branches missed.">        switch (type) {</span>
            case Queue.QUEUE_TYPE_NORMAL:
<span class="nc" id="L318">                return m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_TYPE_NORMAL);</span>
            case Queue.QUEUE_TYPE_VIRTUAL:
<span class="nc" id="L320">                return m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_TYPE_VIRTUAL);</span>
            case Queue.QUEUE_TYPE_DISTRIBUTED:
<span class="nc" id="L322">                return m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_TYPE_DISTRIBUTED);</span>
            case Queue.QUEUE_TYPE_PROCESS:
<span class="nc" id="L324">                return m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_TYPE_PROCESS);</span>

            default: // should never come here.
<span class="nc" id="L327">                return &quot;&quot;;</span>
        }

    }

    /*
     * private String getMappingsStr(ID queueID){ String mappingStr = &quot;&amp;nbsp;&quot;;
     * 
     * //return mappingStr;
     * 
     * ArrayList groupColl = (ArrayList)m_queueGroupMap.get(queueID); if
     * (groupColl != null &amp;&amp; !groupColl.isEmpty()){ StringBuffer str = new
     * StringBuffer(50); for (int i=0; i&lt;groupColl.size(); i++){ String value =
     * (String)m_groupNameMap.get(groupColl.get(i)); str.append(value); if
     * (i&lt;groupColl.size()-1) str.append(&quot;, &quot;); } mappingStr = str.toString(); }
     * 
     * return mappingStr; }
     */

    private String getParentMappingsStr(ID queueID) {
        // this isn't very optimized at the moment.

<span class="nc" id="L349">        String mappingStr = &quot;&amp;nbsp;&quot;;</span>

<span class="nc bnc" id="L351" title="All 2 branches missed.">        if (queueID != null) {</span>

            try {
<span class="nc" id="L354">                final Collection mappedQueues = WorkloadModelHandler.getSubQueues(m_context, queueID);</span>

<span class="nc bnc" id="L356" title="All 4 branches missed.">                if ((mappedQueues != null) &amp;&amp; (mappedQueues.size() &gt; 0)) {</span>
<span class="nc" id="L357">                    final StringBuffer str = new StringBuffer(50);</span>
<span class="nc" id="L358">                    int i = 0;</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">                    for (final Iterator it = mappedQueues.iterator(); it.hasNext();) {</span>
<span class="nc" id="L360">                        final ID qID = (ID) it.next();</span>
<span class="nc" id="L361">                        final Queue thisQueue = WorkloadModelHandler.getQueueByID(m_context, qID);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">                        if (thisQueue != null) {</span>
<span class="nc" id="L363">                            final String value = thisQueue.getName();</span>
<span class="nc" id="L364">                            str.append(value);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">                            if (i &lt; (mappedQueues.size() - 1)) {</span>
<span class="nc" id="L366">                                str.append(&quot;, &quot;);</span>
                            }

                        }
<span class="nc" id="L370">                        mappingStr = str.toString();</span>
<span class="nc" id="L371">                        i++;</span>
<span class="nc" id="L372">                    }</span>
                }
<span class="nc" id="L374">            } catch (final Exception ex) {</span>
<span class="nc" id="L375">            }</span>

        }

<span class="nc" id="L379">        return mappingStr;</span>
    }

    /**
     * Return the Selected Queue IDs
     */
    public ID[] getSelectedQueueIDs() {
<span class="nc" id="L386">        return m_performActionOnIDs;</span>
    }

    @Override
    protected boolean isAuthorizedToConfigure() {
<span class="nc" id="L391">        return (m_context.getUser().isAuthorized(PrivilegeKeys.FS_CONFIGUREQUEUES));</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>