<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MyFlexTimeRequestsPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.flextime</a> &gt; <span class="el_source">MyFlexTimeRequestsPM.java</span></div><h1>MyFlexTimeRequestsPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.flextime;

import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.flextime.validation.FTValidationCache;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.MyRequestsPM;
import com.bluepumpkin.web.rm.requests.timeoff.TimeOffRequestUtil;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.data.wrapper.DateWrapper;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;

public class MyFlexTimeRequestsPM extends MyRequestsPM {
	private static final long serialVersionUID = 1L;
<span class="nc" id="L35">	private Map&lt;ID, String&gt; m_toTypeMap = Collections.emptyMap();</span>
<span class="nc" id="L36">	private FlexTimeRequestsMH flexTimeRequestMH = new FlexTimeRequestsMH();</span>

	/**
	 * Constructs a schedule view page model shell.
	 */
	public MyFlexTimeRequestsPM(RequestContext context) {
<span class="nc" id="L42">		super(context, Request.REQUESTTYPE_FLEXTIME);</span>

<span class="nc" id="L44">	}</span>

	/**
	 * Add Page Not Enabled Message
	 */
	@Override
	protected void addPageNotEnabledMsg() {
<span class="nc" id="L51">		TimeOffRequestUtil.addFTNotActiveMsg(this);</span>
<span class="nc" id="L52">	}</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L58">		return getInstance(context, MyFlexTimeRequestsPM.class);</span>
	}

	/**
	 * Populate Model
	 */
	@Override
	protected void loadData() throws Exception {
<span class="nc bnc" id="L66" title="All 2 branches missed.">		if (isAuthToViewFTRqts()) {</span>
			try {
<span class="nc" id="L68">				Map&lt;String, ?&gt; dataMap = flexTimeRequestMH.getMyFlexRequestData(m_context, m_empID, m_isIncludeExpired);</span>
<span class="nc" id="L69">				m_orgSetting = (OrganizationSetting) dataMap.get(RmKeys.DATA_MY_TO_ORG_SETTING);</span>

<span class="nc" id="L71">				m_isPageEnabled = m_orgSetting.getAgentTimeOffWorkflowActive();</span>

<span class="nc" id="L73">				m_requestList = (Collection&lt;TORequest&gt;) dataMap.get(RmKeys.DATA_MY_TO_REQUESTS);</span>
<span class="nc" id="L74">				m_toTypeMap = (Map&lt;ID, String&gt;) dataMap.get(RmKeys.DATA_MY_TO_TYPES);</span>

<span class="nc" id="L76">			} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L77">				Message msg = handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L78">				msg.setAssociatedMessage(ex.getLocalizedMessage(m_localizer, m_context.getViewingTimeZone()));</span>
<span class="nc" id="L79">			}</span>
		}
<span class="nc" id="L81">	}</span>

	/**
	 * Initialize Selectable Items
	 */
	@Override
	protected void initSelectableItems() {
<span class="nc" id="L88">		isDateSort = false;</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">		if (!isAuthToViewFTRqts()) {</span>
<span class="nc" id="L90">			return;</span>
		}

<span class="nc bnc" id="L93" title="All 2 branches missed.">		if (!m_isPageEnabled) {</span>
<span class="nc" id="L94">			return;</span>
		}

<span class="nc" id="L97">		sortListByDateColumn();</span>

		// Initialize Flex Time Request List
<span class="nc" id="L100">		super.initSelectableItems();</span>

<span class="nc" id="L102">		m_list.setIsBorderEnabled(true);</span>
<span class="nc" id="L103">	}</span>

	/**
	 * added for sorting date columns as dates instead of as strings. (created based on API:
	 * TimeOffRequestUtil.addTOChoiceInfo(toRequest, m_context, row_data, m_bundle))
	 */
	protected void sortListByDateColumn() {
<span class="nc" id="L110">		int[] sortColumnIndexes = m_list.getHeader().getSortColumnIndexes();</span>
		// 3: Time Off Start Date
		// 4: Time Off End Date
		// 7 : Makeup Start Date
		// 8 : Makeup End Date
<span class="nc bnc" id="L115" title="All 12 branches missed.">		if (sortColumnIndexes != null &amp;&amp; sortColumnIndexes.length &gt; 0</span>
				&amp;&amp; (sortColumnIndexes[0] == 3 || sortColumnIndexes[0] == 4 || sortColumnIndexes[0] == 7 || sortColumnIndexes[0] == 8)) {

			// 3: Time Off Start Date
<span class="nc bnc" id="L119" title="All 2 branches missed.">			if (sortColumnIndexes[0] == 3) {</span>
<span class="nc" id="L120">				Collections.sort((List&lt;TORequest&gt;) m_requestList, new Comparator&lt;TORequest&gt;() {</span>
					@Override
					public int compare(TORequest req1, TORequest req2) {
<span class="nc" id="L123">						Pair&lt;ID, TimeRange&gt; pair1 = (Pair&lt;ID, TimeRange&gt;) req1.getEmpIDTimeRangePairs().iterator().next();</span>
<span class="nc" id="L124">						Pair&lt;ID, TimeRange&gt; pair2 = (Pair&lt;ID, TimeRange&gt;) req2.getEmpIDTimeRangePairs().iterator().next();</span>
<span class="nc" id="L125">						return (pair1.getSecond().getStartDate().compareTo(pair2.getSecond().getStartDate()));</span>
					}
				});
			}

			// 4: Time Off End Date
<span class="nc bnc" id="L131" title="All 2 branches missed.">			if (sortColumnIndexes[0] == 4) {</span>
<span class="nc" id="L132">				Collections.sort((List&lt;TORequest&gt;) m_requestList, new Comparator&lt;TORequest&gt;() {</span>
					@Override
					public int compare(TORequest req1, TORequest req2) {
<span class="nc" id="L135">						Pair&lt;ID, TimeRange&gt; pair1 = (Pair&lt;ID, TimeRange&gt;) req1.getEmpIDTimeRangePairs().iterator().next();</span>
<span class="nc" id="L136">						Pair&lt;ID, TimeRange&gt; pair2 = (Pair&lt;ID, TimeRange&gt;) req2.getEmpIDTimeRangePairs().iterator().next();</span>
<span class="nc" id="L137">						return (pair1.getSecond().getEndDate().compareTo(pair2.getSecond().getEndDate()));</span>
					}
				});
			}

			// 7 : Makeup Start Date
<span class="nc bnc" id="L143" title="All 2 branches missed.">			if (sortColumnIndexes[0] == 7) {</span>
<span class="nc" id="L144">				Collections.sort((List&lt;TORequest&gt;) m_requestList, new Comparator&lt;TORequest&gt;() {</span>
					@Override
					public int compare(TORequest req1, TORequest req2) {
						try {
<span class="nc" id="L148">							Date d1 = Collections.min(new FTValidationCache(req1).getMakeupDurations()).getStartDate();</span>
<span class="nc" id="L149">							Date d2 = Collections.min(new FTValidationCache(req2).getMakeupDurations()).getStartDate();</span>
<span class="nc" id="L150">							return d1.compareTo(d2);</span>
<span class="nc" id="L151">						} catch (Exception e) {</span>
<span class="nc" id="L152">							throw new IllegalArgumentException(e);</span>
						}
					}
				});
			}

			// 8 : Makeup End Date
<span class="nc bnc" id="L159" title="All 2 branches missed.">			if (sortColumnIndexes[0] == 8) {</span>
<span class="nc" id="L160">				Collections.sort((List&lt;TORequest&gt;) m_requestList, new Comparator&lt;TORequest&gt;() {</span>
					@Override
					public int compare(TORequest req1, TORequest req2) {
						try {
<span class="nc" id="L164">							Date d1 = Collections.max(new FTValidationCache(req1).getMakeupDurations()).getEndDate();</span>
<span class="nc" id="L165">							Date d2 = Collections.max(new FTValidationCache(req2).getMakeupDurations()).getEndDate();</span>
<span class="nc" id="L166">							return d1.compareTo(d2);</span>
<span class="nc" id="L167">						} catch (Exception e) {</span>
<span class="nc" id="L168">							throw new IllegalArgumentException(e);</span>
						}
					}
				});
			}

			// check if desc order
<span class="nc bnc" id="L175" title="All 2 branches missed.">			if (!m_list.getHeader().isAscending()) {</span>
<span class="nc" id="L176">				Collections.reverse((List&lt;TORequest&gt;) m_requestList);</span>
			}

			// mark so autosort will not be enabled in myRequestsPM
<span class="nc" id="L180">			isDateSort = true;</span>
		}
<span class="nc" id="L182">	}</span>

	/**
	 * Initialize List Header
	 */
	@Override
	protected void initHeader() {
<span class="nc" id="L189">		TableHeaderPC header = m_list.getHeader();</span>
<span class="nc" id="L190">		header.setPartialSortable(true);</span>

<span class="nc" id="L192">		addHeaderData(header, m_common_bundle, UIFWebBundleKey.STATUS, true);</span>
<span class="nc" id="L193">		addHeaderData(header, m_common_bundle, UIFWebBundleKey.TYPE, true);</span>
<span class="nc" id="L194">		addHeaderData(header, m_common_bundle, UIFWebBundleKey.SUBMITTED, true);</span>

<span class="nc" id="L196">		TimeOffRequestUtil.addFTChoiceHeader(m_bundle, m_localizer, header, true);</span>
<span class="nc" id="L197">		addCommonHeaderData();</span>
<span class="nc" id="L198">	}</span>

	/**
	 * Create Row Data From Request
	 */
	@Override
	protected MultiColumnNodeData createRowData(RequestAggregate request) {
<span class="nc" id="L205">		TORequest toRequest = (TORequest) request;</span>

<span class="nc" id="L207">		String rowID = request.getID().toString();</span>
<span class="nc" id="L208">		DefaultMultiColumnNodeData row_data = new DefaultMultiColumnNodeData(rowID);</span>

<span class="nc" id="L210">		String status = createStatusIcon(request);</span>
<span class="nc" id="L211">		row_data.add(status);</span>

<span class="nc" id="L213">		String toType = getTOType(toRequest);</span>
<span class="nc" id="L214">		row_data.add(toType);</span>

<span class="nc" id="L216">		DateWrapper submittedDT = createDataWrapper(request.getSubmittedOn());</span>
<span class="nc" id="L217">		row_data.add(submittedDT);</span>

		// Add Time Off data
<span class="nc" id="L220">		TimeOffRequestUtil.addTOChoiceInfo(toRequest, m_context, row_data, m_bundle, true, false, true);</span>

		// Add Makeup start/end data
<span class="nc" id="L223">		TimeOffRequestUtil.addMakeupInfo(toRequest, m_context, row_data);</span>

<span class="nc" id="L225">		addCommonListData(request, row_data);</span>
<span class="nc" id="L226">		return row_data;</span>
	}

	/**
	 * Return Request Validation Results
	 */
	@Override
	protected Collection getValidationResults(RequestAggregate request) {
<span class="nc" id="L234">		return request.getValidationResults(false);</span>
	}

	/**
	 * Return Time Off Type Display
	 */
	private String getTOType(TORequest request) {
<span class="nc" id="L241">		ID toTypeID = request.getTimeOffType();</span>
<span class="nc" id="L242">		return m_toTypeMap.get(toTypeID);</span>
	}

	/**
	 * Add Create Request Button
	 */
	@Override
	protected void addCreateRequestButton() {
<span class="nc bnc" id="L250" title="All 4 branches missed.">		boolean isBtnEnabled = m_isPageEnabled &amp;&amp; isAuthToEditFTRqts();</span>
<span class="nc" id="L251">		String newRequestLabel = i18n(m_bundle, RmWebBundleKey.CREATE_NEW_REQUEST);</span>
<span class="nc" id="L252">		m_toolbar.addPopupWindowTextButton(RmPageAction.POPUP_FLEXTIME_REQUEST_FORM_ACTION, newRequestLabel, isBtnEnabled);</span>
<span class="nc" id="L253">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>