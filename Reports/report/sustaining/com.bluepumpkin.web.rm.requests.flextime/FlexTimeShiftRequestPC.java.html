<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FlexTimeShiftRequestPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.flextime</a> &gt; <span class="el_source">FlexTimeShiftRequestPC.java</span></div><h1>FlexTimeShiftRequestPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.flextime;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.ResourceBundle;
import java.util.Set;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.FlexRequestMakeup;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.keys.RmJavaScriptFileID;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.custshift.CustomShiftRequestFormPopupPM;
import com.bluepumpkin.web.rm.requests.flextime.ShiftAssignmentDetailData.ShiftAssignmentInfo;
import com.bluepumpkin.web.rm.requests.flextime.ShiftAssignmentDetailData.ShiftExtension;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.calendar.CalendarPC;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.list.DynamicMultiColListWithToolbarPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.table.DefaultHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;
import com.witness.web.uif.util.js.JSValidatorUtil;
import com.witness.web.uif.util.reflection.ParameterUtil;

public class FlexTimeShiftRequestPC extends CollapsibleContainerPC {
	private static final long serialVersionUID = 1L;
<span class="nc" id="L49">	private static final Category LOG = Log.initCategory(FlexTimeShiftRequestPC.class.getName());</span>

	// Shift Assignment

	private static final String SHIFT_DATE_FN = &quot;shiftDate&quot;;

	private static final String SHIFT_ASSIGNMENT_ID_FN = &quot;shiftAssignmentId&quot;;

	// Shift Extension Before

	private static final String BEFORE_ACTIVITY_FN = &quot;beforeActivity&quot;;

	private static final String BEFORE_ACTIVITY_EDITABLE_FN = &quot;beforeActivityEditable&quot;;

	private static final String BEFORE_GAP_FN = &quot;beforeGap&quot;;

	private static final String BEFORE_DURATION_FN = &quot;beforeDuration&quot;;

	// Shift Extension After

	private static final String AFTER_ACTIVITY_FN = &quot;afterActivity&quot;;

	private static final String AFTER_ACTIVITY_EDITABLE_FN = &quot;afterActivityEditable&quot;;

	private static final String AFTER_GAP_FN = &quot;afterGap&quot;;

	private static final String AFTER_DURATION_FN = &quot;afterDuration&quot;;


	private ResourceBundle bundle;
	private FlexTimeRequestsMH modelHandler;

	private List&lt;Date&gt; paramDates;
	private String[] paramBeforeActivities;
	private String[] paramBeforeActivitiesEditable;
	private String[] paramBeforeGaps;
	private String[] paramBeforeDurations;
	private String[] paramAfterActivities;
	private String[] paramAfterActivitiesEditable;
	private String[] paramAfterGaps;
	private String[] paramAfterDurations;
	private String[] paramShiftAssignmentIds;
	private boolean paramValid;

	private TORequest timeoffRequest;
	private boolean viewOnlyMode;
	private ID employeeID;

	// Request Management Settings per organization
	private OrganizationSetting orgSettings;

	public FlexTimeShiftRequestPC(RequestContext context, String name, TORequest timeoffRequest, boolean viewOnlyMode) {
<span class="nc" id="L101">		super(context);</span>
<span class="nc" id="L102">		setName(name);</span>

<span class="nc" id="L104">		this.bundle = getLocalizer().getBundle(RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L105">		modelHandler = new FlexTimeRequestsMH();</span>

<span class="nc" id="L107">		this.timeoffRequest = timeoffRequest;</span>
<span class="nc" id="L108">		this.viewOnlyMode = viewOnlyMode;</span>

<span class="nc" id="L110">		setTitle(i18n(bundle, RmWebBundleKey.FLEX_SHIFT_REQUEST));</span>

<span class="nc" id="L112">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="nc" id="L113">		addRequiredJavaScriptFile(RmJavaScriptFileID.CUSTOM_FLEX_TIME_SHIFT_REQUEST);</span>

		//We need to add these JS variables for the field validators to work properly
<span class="nc" id="L116">		JSValidatorUtil.addVDJSVars(this);</span>

<span class="nc" id="L118">	}</span>

	private boolean isViewOnlyMode() {
<span class="nc" id="L121">		return viewOnlyMode;</span>
	}

	private DynamicMultiColListWithToolbarPC createShiftRequestTable(RequestContext context, String name, ID employeeID) throws Exception {
<span class="nc" id="L125">		DynamicMultiColListWithToolbarPC table = new DynamicMultiColListWithToolbarPC(context);</span>

<span class="nc" id="L127">		table.setName(name);</span>
<span class="nc" id="L128">		table.setJSMediator(RmJavaScriptFileID.MEDIATOR_FLEXTIME_MAKEUP_DYNAMICLIST);</span>

		// buttons
<span class="nc" id="L131">		table.setIsMoveUpButtonShown(false);</span>
<span class="nc" id="L132">		table.setIsMoveDownButtonShown(false);</span>

<span class="nc bnc" id="L134" title="All 2 branches missed.">		if (isViewOnlyMode()) {</span>
<span class="nc" id="L135">			table.setIsCreateButtonShown(false);</span>
<span class="nc" id="L136">			table.setIsDeleteButtonShown(false);</span>
		} else {

			// template row
<span class="nc" id="L140">			table.getDynamicMultiColList().setTemplateNodeData(createDataRow(context, 0, null, true, employeeID, null, null));</span>
		}

		// header row
<span class="nc" id="L144">		createHeaderRow(table.getDynamicMultiColList().getHeader());</span>

<span class="nc" id="L146">		return table;</span>
	}

	private void createHeaderRow(TableHeaderPC header) {
<span class="nc" id="L150">		List&lt;DefaultHeaderData&gt; hdrList1 = new ArrayList&lt;DefaultHeaderData&gt;();</span>
<span class="nc" id="L151">		List&lt;DefaultHeaderData&gt; hdrList2 = new ArrayList&lt;DefaultHeaderData&gt;();</span>
		DefaultHeaderData col;

<span class="nc" id="L154">		col  = new DefaultHeaderData(&quot;col1&quot;, i18n(bundle, RmWebBundleKey.FLEX_SHIFT_REQUEST_DATE));</span>
<span class="nc" id="L155">		col.setRowSpan(2);</span>
<span class="nc" id="L156">		hdrList1.add(col);</span>

<span class="nc" id="L158">		col  = new DefaultHeaderData(&quot;col2&quot;, i18n(bundle, RmWebBundleKey.FLEX_SHIFT_REQUEST_SHIFT));</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">		if (!isViewOnlyMode()) {</span>
<span class="nc" id="L160">			col.setColSpan(4);</span>
		} else {
<span class="nc" id="L162">			col.setColSpan(2);</span>
		}
<span class="nc" id="L164">		hdrList1.add(col);</span>

<span class="nc" id="L166">		col  = new DefaultHeaderData(&quot;col3&quot;, i18n(bundle, RmWebBundleKey.FLEX_EXTENSION_BEFORE));</span>
<span class="nc" id="L167">		col.setColSpan(3);</span>
<span class="nc" id="L168">		hdrList1.add(col);</span>

<span class="nc" id="L170">		col  = new DefaultHeaderData(&quot;col4&quot;, i18n(bundle, RmWebBundleKey.FLEX_EXTENSION_AFTER));</span>
<span class="nc" id="L171">		col.setColSpan(3);</span>
<span class="nc" id="L172">		hdrList1.add(col);</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">		if (!isViewOnlyMode()) {</span>
<span class="nc" id="L175">			col  = new DefaultHeaderData(&quot;col5&quot;, i18n(bundle, RmWebBundleKey.FLEX_SHIFT_REQUEST_SHIFT_NAME));</span>
<span class="nc" id="L176">			hdrList2.add(col);</span>
		}

<span class="nc" id="L179">		col  = new DefaultHeaderData(&quot;col6&quot;, i18n(bundle, RmWebBundleKey.FLEX_SHIFT_REQUEST_SHIFT_START));</span>
<span class="nc" id="L180">		hdrList2.add(col);</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">		if (!isViewOnlyMode()) {</span>
<span class="nc" id="L183">			col  = new DefaultHeaderData(&quot;col7&quot;, i18n(bundle, RmWebBundleKey.FLEX_SHIFT_REQUEST_SHIFT_ACTIVITY));</span>
<span class="nc" id="L184">			hdrList2.add(col);</span>
		}

<span class="nc" id="L187">		col  = new DefaultHeaderData(&quot;col8&quot;, i18n(bundle, RmWebBundleKey.FLEX_SHIFT_REQUEST_SHIFT_DURATION));</span>
<span class="nc" id="L188">		hdrList2.add(col);</span>

<span class="nc" id="L190">		col  = new DefaultHeaderData(&quot;col9&quot;, i18n(bundle, RmWebBundleKey.FLEX_EXTENSION_BEFORE_ACTIVITY));</span>
<span class="nc" id="L191">		hdrList2.add(col);</span>

<span class="nc" id="L193">		col  = new DefaultHeaderData(&quot;col10&quot;, i18n(bundle, RmWebBundleKey.FLEX_EXTENSION_BEFORE_DURATION));</span>
<span class="nc" id="L194">		hdrList2.add(col);</span>

<span class="nc" id="L196">		col  = new DefaultHeaderData(&quot;col11&quot;, i18n(bundle, RmWebBundleKey.FLEX_EXTENSION_BEFORE_GAP));</span>
<span class="nc" id="L197">		hdrList2.add(col);</span>

<span class="nc" id="L199">		col  = new DefaultHeaderData(&quot;col12&quot;, i18n(bundle, RmWebBundleKey.FLEX_EXTENSION_AFTER_ACTIVITY));</span>
<span class="nc" id="L200">		hdrList2.add(col);</span>

<span class="nc" id="L202">		col  = new DefaultHeaderData(&quot;col13&quot;, i18n(bundle, RmWebBundleKey.FLEX_EXTENSION_AFTER_DURATION));</span>
<span class="nc" id="L203">		hdrList2.add(col);</span>

<span class="nc" id="L205">		col  = new DefaultHeaderData(&quot;col14&quot;, i18n(bundle, RmWebBundleKey.FLEX_EXTENSION_AFTER_GAP));</span>
<span class="nc" id="L206">		hdrList2.add(col);</span>

<span class="nc" id="L208">		header.setHeaders(hdrList2);</span>
<span class="nc" id="L209">		header.incActiveHeaderLevel();</span>
<span class="nc" id="L210">		header.setHeaders(hdrList1);</span>
<span class="nc" id="L211">	}</span>

	private DefaultMultiColumnNodeData createDataRow(RequestContext context, int rowIndex, FlexRequestMakeup makeup, boolean isPendingRequest, ID requestForEmployeeID, int[] outExtensionLength, Set&lt;String&gt; outputErrorMessages) throws Exception {
<span class="nc" id="L214">		DefaultMultiColumnNodeData node = new DefaultMultiColumnNodeData(String.valueOf(rowIndex));</span>

<span class="nc bnc" id="L216" title="All 2 branches missed.">		if (isViewOnlyMode()) {</span>
<span class="nc" id="L217">			node.setSelectable(false);</span>
		}

		// SHIFT ASSIGNMENT
<span class="nc bnc" id="L221" title="All 2 branches missed.">		Date selectedDate = (makeup != null) ? makeup.getShiftStartTime() : new Date();</span>
<span class="nc" id="L222">		short weekStartDate = modelHandler.getWeekStartDateForEmpOrg(context, context.getUser().getEmployeeID());</span>
<span class="nc" id="L223">		ShiftAssignmentDetailData db = modelHandler.getShiftAssignmentDetail(context, context.getUser().getEmployeeID(), requestForEmployeeID, selectedDate);</span>

<span class="nc" id="L225">		ShiftAssignmentInfo shiftAssignmentInfo = getShift(context, makeup, db);</span>
<span class="nc" id="L226">		ShiftExtension before = getBeforeExtension(context, makeup, db);</span>
<span class="nc" id="L227">		boolean beforeExtensionEditable = isBeforeExtensionEditable(makeup, db);</span>
<span class="nc" id="L228">		ShiftExtension after = getAfterExtension(context, makeup, db);</span>
<span class="nc" id="L229">		boolean afterExtensionEditable = isAfterExtensionEditable(makeup, db);</span>

		// See EditShiftDialog.java

		// col1: FLEX_SHIFT_REQUEST_DATE
<span class="nc" id="L234">		node.add(createShiftDatePickerHtml(context, weekStartDate, selectedDate, rowIndex, requestForEmployeeID));</span>

<span class="nc bnc" id="L236" title="All 2 branches missed.">		if (!isViewOnlyMode()) {</span>
			// col5: FLEX_SHIFT_REQUEST_SHIFT_NAME
<span class="nc" id="L238">			node.add(createShiftName(context, rowIndex, shiftAssignmentInfo.getShiftName()) + createShiftAssignmentID(shiftAssignmentInfo.getShiftAssignmentId()));</span>
		}

		// col6: FLEX_SHIFT_REQUEST_SHIFT_START
<span class="nc" id="L242">		node.add(createShiftStartTime(context, rowIndex, shiftAssignmentInfo.getShiftStartTime()));</span>

<span class="nc bnc" id="L244" title="All 2 branches missed.">		if (!isViewOnlyMode()) {</span>
			// col7: FLEX_SHIFT_REQUEST_SHIFT_ACTIVITY
<span class="nc" id="L246">			node.add(createShiftActivityName(context, rowIndex, shiftAssignmentInfo.getShiftActivityName()));</span>
		}

		// col8: FLEX_SHIFT_REQUEST_SHIFT_DURATION
<span class="nc" id="L250">		node.add(createShiftDuration(context, rowIndex, shiftAssignmentInfo.getShiftDurationMinutes()));</span>

		// col9: FLEX_EXTENSION_BEFORE_ACTIVITY
<span class="nc" id="L253">		node.add(createBeforeActivity(context, rowIndex, db.getExtensionActivities(), before.getActivityId(), beforeExtensionEditable) + createBeforeActivityEditable(beforeExtensionEditable));</span>

		// col10: FLEX_EXTENSION_BEFORE_DURATION
<span class="nc" id="L256">		node.add(createBeforeDuration(context, rowIndex, before.getLength(), beforeExtensionEditable));</span>

		// col11: FLEX_EXTENSION_BEFORE_GAP
<span class="nc" id="L259">		node.add(createBeforeGap(context, rowIndex, before.getGap(), beforeExtensionEditable));</span>


		// col12: FLEX_EXTENSION_AFTER_ACTIVITY
<span class="nc" id="L263">		node.add(createAfterActivity(context, rowIndex, db.getExtensionActivities(), after.getActivityId(), afterExtensionEditable) + createAfterActivityEditable(afterExtensionEditable));</span>

		// col13: FLEX_EXTENSION_AFTER_DURATION
<span class="nc" id="L266">		node.add(createAfterDuration(context, rowIndex, after.getLength(), afterExtensionEditable));</span>

		// col14: FLEX_EXTENSION_AFTER_GAP
<span class="nc" id="L269">		node.add(createAfterGap(context, rowIndex, after.getGap(), afterExtensionEditable));</span>

<span class="nc bnc" id="L271" title="All 2 branches missed.">		if (isPendingRequest) {</span>
<span class="nc" id="L272">			updateOutputErrorMessages(makeup, db, outputErrorMessages);</span>
		}

<span class="nc bnc" id="L275" title="All 8 branches missed.">		boolean makeupBeforeExtensionRequested = makeup != null &amp;&amp; makeup.getShiftAssignmentID() != null &amp;&amp; db.getShiftAssignmentInfo() != null &amp;&amp; makeup.getExtBeforeActivityID() != null;</span>
<span class="nc bnc" id="L276" title="All 8 branches missed.">		boolean makeupAfterExtensionRequested = makeup != null &amp;&amp; makeup.getShiftAssignmentID() != null &amp;&amp; db.getShiftAssignmentInfo() != null &amp;&amp; makeup.getExtAfterActivityID() != null;</span>
<span class="nc" id="L277">		updateOutExtensionLength(makeup, before.getLength(), after.getLength(), makeupBeforeExtensionRequested, makeupAfterExtensionRequested, outExtensionLength);</span>

<span class="nc" id="L279">		return node;</span>
	}

	private boolean isAfterExtensionEditable(FlexRequestMakeup makeup, ShiftAssignmentDetailData db) {
<span class="nc bnc" id="L283" title="All 8 branches missed.">		return makeup == null &amp;&amp; db.getShiftAssignmentInfo() != null &amp;&amp; isAfterExtensionEditable(db.getShiftAssignment())</span>
<span class="nc bnc" id="L284" title="All 6 branches missed.">				|| makeup != null &amp;&amp; makeup.getShiftAssignmentID() != null &amp;&amp; db.getShiftAssignmentInfo() != null &amp;&amp; isAfterExtensionEditable(db.getShiftAssignment());</span>
	}

	private boolean isBeforeExtensionEditable(FlexRequestMakeup makeup, ShiftAssignmentDetailData db) {
<span class="nc bnc" id="L288" title="All 8 branches missed.">		return makeup == null &amp;&amp; db.getShiftAssignmentInfo() != null &amp;&amp; isBeforeExtensionEditable(db.getShiftAssignment())</span>
<span class="nc bnc" id="L289" title="All 6 branches missed.">				|| makeup != null &amp;&amp; makeup.getShiftAssignmentID() != null &amp;&amp; db.getShiftAssignmentInfo() != null &amp;&amp; isBeforeExtensionEditable(db.getShiftAssignment());</span>
	}

	/**
	 * Checks if the Extension Before Shift columns should be editable, according to the shift assignment and the org settings.
	 */
	private boolean isBeforeExtensionEditable(ShiftAssignment sa) {
<span class="nc bnc" id="L296" title="All 6 branches missed.">		return (orgSettings == null || orgSettings.getAllowMakeupBeforeShift()) &amp;&amp; modelHandler.isBeforeExtensionEditable(sa);</span>
	}

	/**
	 * Checks if the Extension After Shift columns should be editable, according to the shift assignment and the org settings.
	 */
	private boolean isAfterExtensionEditable(ShiftAssignment sa) {
<span class="nc bnc" id="L303" title="All 6 branches missed.">		return (orgSettings == null || orgSettings.getAllowMakeupAfterShift()) &amp;&amp; modelHandler.isAfterExtensionEditable(sa);</span>
	}

	private ShiftAssignmentInfo getShift(RequestContext context, FlexRequestMakeup makeup, ShiftAssignmentDetailData db) {
		ShiftAssignmentInfo result;
<span class="nc bnc" id="L308" title="All 2 branches missed.">		if (isViewOnlyMode()) {</span>
<span class="nc" id="L309">			result = new ShiftAssignmentInfo();</span>
<span class="nc" id="L310">			result.setShiftStartTime(modelHandler.formatShiftStartTime(context, makeup.getShiftStartTime()));</span>
<span class="nc" id="L311">			result.setShiftDurationMinutes(modelHandler.getShiftDuration(makeup));</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">		} else if (makeup == null) {</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">			if (db.getShiftAssignmentInfo() != null) {</span>
<span class="nc" id="L314">				result = db.getShiftAssignmentInfo();</span>
			} else {
<span class="nc" id="L316">				result = new ShiftAssignmentInfo();</span>
			}
<span class="nc bnc" id="L318" title="All 4 branches missed.">		} else if (makeup.getShiftAssignmentID() == null || db.getShiftAssignmentInfo() == null) {</span>
<span class="nc" id="L319">			result = new ShiftAssignmentInfo();</span>
		} else {
<span class="nc" id="L321">			result = db.getShiftAssignmentInfo();</span>
		}
<span class="nc" id="L323">		return result;</span>
	}

	private ShiftExtension getAfterExtension(RequestContext context, FlexRequestMakeup makeup, ShiftAssignmentDetailData db) throws Exception {
		ShiftExtension result;

<span class="nc bnc" id="L329" title="All 2 branches missed.">		if (isViewOnlyMode()) {</span>
<span class="nc" id="L330">			result = new ShiftExtension(makeup.getExtAfterActivityID(), makeup.getExtAfterDuration(), makeup.getExtAfterGap());</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">		} else if (makeup == null) {</span>
			// template row

<span class="nc bnc" id="L334" title="All 2 branches missed.">			if (db.getShiftAssignmentInfo() != null) {</span>
				// AFTER
<span class="nc" id="L336">				result = db.getAfterExtension();</span>
			} else {
				// AFTER
<span class="nc" id="L339">				result = new ShiftExtension();</span>
			}
<span class="nc bnc" id="L341" title="All 4 branches missed.">		} else if (makeup.getShiftAssignmentID() == null || db.getShiftAssignmentInfo() == null) {</span>
			// AFTER
<span class="nc" id="L343">			result = new ShiftExtension();</span>
		} else {
<span class="nc bnc" id="L345" title="All 2 branches missed.">			if (modelHandler.isAfterExtensionEditable(db.getShiftAssignment())) {</span>
				// get from request or user input
<span class="nc" id="L347">				result = new ShiftExtension(makeup.getExtAfterActivityID(), makeup.getExtAfterDuration(), makeup.getExtAfterGap());</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">			} else if (makeup.getExtAfterActivityID() == null) {</span>
				// get from calendar
<span class="nc" id="L350">				result = modelHandler.getAfterExtension(context, db.getShiftAssignment());</span>
			} else {
				// get from request or user input
<span class="nc" id="L353">				result = new ShiftExtension(makeup.getExtAfterActivityID(), makeup.getExtAfterDuration(), makeup.getExtAfterGap());</span>
			}

		}
<span class="nc" id="L357">		return result;</span>
	}

	private ShiftExtension getBeforeExtension(RequestContext context, FlexRequestMakeup makeup, ShiftAssignmentDetailData db) throws Exception {
		ShiftExtension result;
<span class="nc bnc" id="L362" title="All 2 branches missed.">		if (isViewOnlyMode()) {</span>
<span class="nc" id="L363">			result = new ShiftExtension(makeup.getExtBeforeActivityID(), makeup.getExtBeforeDuration(), makeup.getExtBeforeGap());</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">		} else if (makeup == null) {</span>
			// template row

<span class="nc bnc" id="L367" title="All 2 branches missed.">			if (db.getShiftAssignmentInfo() != null) {</span>
<span class="nc" id="L368">				result = db.getBeforeExtension();</span>
			} else {
<span class="nc" id="L370">				result = new ShiftExtension();</span>
			}
<span class="nc bnc" id="L372" title="All 4 branches missed.">		} else if (makeup.getShiftAssignmentID() == null || db.getShiftAssignmentInfo() == null) {</span>
<span class="nc" id="L373">			result = new ShiftExtension();</span>
		} else {
<span class="nc bnc" id="L375" title="All 2 branches missed.">			if (modelHandler.isBeforeExtensionEditable(db.getShiftAssignment())) {</span>
				// get from request or user input
<span class="nc" id="L377">				result = new ShiftExtension(makeup.getExtBeforeActivityID(), makeup.getExtBeforeDuration(), makeup.getExtBeforeGap());</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">			} else if (makeup.getExtBeforeActivityID() == null) {</span>
				// get from calendar
<span class="nc" id="L380">				result = modelHandler.getBeforeExtension(context, db.getShiftAssignment());</span>
			} else {
				// get from request or user input
<span class="nc" id="L383">				result = new ShiftExtension(makeup.getExtBeforeActivityID(), makeup.getExtBeforeDuration(), makeup.getExtBeforeGap());</span>
			}
		}
<span class="nc" id="L386">		return result;</span>
	}

	private void updateOutExtensionLength(FlexRequestMakeup makeup, int beforeLength, int afterLength, boolean makeupBeforeExtensionRequested, boolean makeupAfterExtensionRequested, int[] outExtensionLength) {
<span class="nc bnc" id="L390" title="All 6 branches missed.">		if (outExtensionLength != null &amp;&amp; outExtensionLength.length &gt; 0 &amp;&amp; makeup != null) {</span>
<span class="nc" id="L391">			outExtensionLength[0] = 0;</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">			if (makeupBeforeExtensionRequested) {</span>
<span class="nc" id="L393">				outExtensionLength[0] += beforeLength;</span>
			}
<span class="nc bnc" id="L395" title="All 2 branches missed.">			if (makeupAfterExtensionRequested) {</span>
<span class="nc" id="L396">				outExtensionLength[0] += afterLength;</span>
			}
		}
<span class="nc" id="L399">	}</span>

	private void updateOutputErrorMessages(FlexRequestMakeup makeup, ShiftAssignmentDetailData db, Set&lt;String&gt; outputErrorMessages) {
<span class="nc bnc" id="L402" title="All 2 branches missed.">		if (outputErrorMessages != null) {</span>
<span class="nc bnc" id="L403" title="All 6 branches missed.">			if (makeup != null &amp;&amp; (makeup.getShiftAssignmentID() == null || db.getShiftAssignmentInfo() == null)) {</span>
				// row input from user, but no shift assignment found for the date
<span class="nc bnc" id="L405" title="All 4 branches missed.">				if (makeup.getShiftAssignmentID() != null &amp;&amp; db.getShiftAssignmentInfo() == null) {</span>
<span class="nc" id="L406">					outputErrorMessages.add(i18n(bundle, RmWebBundleKey.FLEX_REQUEST_NO_LONGER_VALID_ERROR_MESSAGE));</span>
				}
<span class="nc bnc" id="L408" title="All 6 branches missed.">			} else if (makeup != null &amp;&amp; makeup.getShiftAssignmentID() != null &amp;&amp; db.getShiftAssignmentInfo() != null) {</span>
<span class="nc bnc" id="L409" title="All 4 branches missed.">				if (!modelHandler.isBeforeExtensionEditable(db.getShiftAssignment()) &amp;&amp; makeup.getExtBeforeActivityID() != null) {</span>
<span class="nc" id="L410">					outputErrorMessages.add(i18n(bundle, RmWebBundleKey.FLEX_REQUEST_NO_LONGER_VALID_ERROR_MESSAGE));</span>
				}
<span class="nc bnc" id="L412" title="All 4 branches missed.">				if (!modelHandler.isAfterExtensionEditable(db.getShiftAssignment()) &amp;&amp; makeup.getExtAfterActivityID() != null) {</span>
<span class="nc" id="L413">					outputErrorMessages.add(i18n(bundle, RmWebBundleKey.FLEX_REQUEST_NO_LONGER_VALID_ERROR_MESSAGE));</span>
				}
			}
		}
<span class="nc" id="L417">	}</span>

	private String createShiftAssignmentID(ID shiftAssignmentId) {
<span class="nc bnc" id="L420" title="All 2 branches missed.">		return HtmlUtil.makeHiddenInput(SHIFT_ASSIGNMENT_ID_FN, shiftAssignmentId != null ? shiftAssignmentId.toString() : &quot;&quot;);</span>
	}

	private DatePickerPC createShiftDatePicker(RequestContext context, int firstDayOfWeek, Date date, int rowIndex, ID requestedFor) {
<span class="nc" id="L424">		DatePickerPC datePickerPC = new DatePickerPC(context, SHIFT_DATE_FN, context.getViewingTimeZone(), false);</span>
<span class="nc" id="L425">		datePickerPC.setFirstDayOfWeek(firstDayOfWeek);</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">		if (date != null) {</span>
<span class="nc" id="L427">			datePickerPC.setDate(date);</span>
		}
<span class="nc" id="L429">		datePickerPC.setDateInputIndex(rowIndex);</span>
<span class="nc" id="L430">		datePickerPC.setIsTimeEnabled(false);</span>
		// lower limit
<span class="nc" id="L432">		Calendar cal = Calendar.getInstance(context.getViewingTimeZone());</span>
		// yesterday's date
<span class="nc" id="L434">		cal.add(Calendar.DATE, -1);</span>
<span class="nc" id="L435">		datePickerPC.setLowerLimit(cal.getTime());</span>
		// upper date limit to 12/31/2078
<span class="nc" id="L437">		cal.set(2078, 11, 31, 23, 59, 59);</span>
<span class="nc" id="L438">		datePickerPC.setUpperLimit(cal.getTime());</span>
<span class="nc" id="L439">		datePickerPC.setOnChangeJS(JSUtil.SET_PAGEDIRTY + &quot;jQuery(document).trigger('flexMakeupDateUpdatedEvent');&quot;);</span>
<span class="nc" id="L440">		return datePickerPC;</span>
	}

	private String createShiftDatePickerHtml(RequestContext context, int firstDayOfWeek, Date date, int rowIndex, ID requestedFor) {
		String datePicker;

<span class="nc" id="L446">		DatePickerPC datePickerPC = createShiftDatePicker(context, firstDayOfWeek, date, rowIndex, requestedFor);</span>

<span class="nc bnc" id="L448" title="All 2 branches missed.">		if (isViewOnlyMode()) {</span>
<span class="nc" id="L449">			datePicker = datePickerPC.getDateDisplay();</span>
		} else {
<span class="nc" id="L451">			datePicker = datePickerPC.getHtmlDisplay();</span>
		}
<span class="nc" id="L453">		return datePicker;</span>
	}

	private String createShiftStartTime(RequestContext context, int rowIndex, String startTime) {
<span class="nc" id="L457">		return startTime;</span>
	}

	private String createShiftDuration(RequestContext context, int rowIndex, int durationMinutes) {
<span class="nc bnc" id="L461" title="All 2 branches missed.">		return (durationMinutes &gt; 0) ? context.getLocalizer().formatDurationInMins(durationMinutes) : &quot;&quot;;</span>
	}

	private String createShiftActivityName(RequestContext context, int rowIndex, String shiftActivityName) {
<span class="nc bnc" id="L465" title="All 2 branches missed.">		return (shiftActivityName != null) ? shiftActivityName : &quot;&quot;;</span>
	}

	private String createShiftName(RequestContext context, int rowIndex, String name) {
<span class="nc bnc" id="L469" title="All 2 branches missed.">		return (name != null) ? name : &quot;&quot;;</span>
	}

	private String createBeforeActivity(RequestContext context, int rowIndex, List&lt;Activity&gt; extBeforeActivities, ID beforeActivityId, boolean beforeExtensionEditable) {
		String html;
<span class="nc bnc" id="L474" title="All 2 branches missed.">		if (isViewOnlyMode()) {</span>
<span class="nc" id="L475">			html = getExtensionActivityOptionName(extBeforeActivities, beforeActivityId);</span>
		} else {
<span class="nc bnc" id="L477" title="All 2 branches missed.">			html = HtmlUtil.makeSelectInput(BEFORE_ACTIVITY_FN, String.valueOf(rowIndex), new String[]{beforeActivityId != null ? beforeActivityId.toString() : CustomShiftRequestFormPopupPM.NONE_ID.toString()},</span>
<span class="nc" id="L478">				null, createExtensionActivityOptions(context, extBeforeActivities), null, false, false, beforeExtensionEditable);</span>
		}
<span class="nc" id="L480">		return html;</span>
	}

	private String createBeforeActivityEditable(boolean beforeActivityEditable) {
<span class="nc" id="L484">		return HtmlUtil.makeHiddenInput(BEFORE_ACTIVITY_EDITABLE_FN, beforeActivityEditable);</span>
	}

	private static List&lt;StringsPair&gt; getDurationOptions(int startMinutes, int endMinutes, int increment, Localizer localizer) {
<span class="nc" id="L488">		int numToGet = (endMinutes - startMinutes) / increment + 1;</span>
<span class="nc" id="L489">		List&lt;StringsPair&gt; options = new ArrayList&lt;StringsPair&gt;(numToGet);</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">		for (int i = 0; i &lt; numToGet; i++) {</span>
<span class="nc" id="L491">			int nextMinutes = startMinutes + i * increment;</span>
<span class="nc" id="L492">			String displayString = localizer.formatDurationInMins(nextMinutes);</span>
<span class="nc" id="L493">			options.add(new StringsPair(String.valueOf(nextMinutes), displayString));</span>
		}
<span class="nc" id="L495">		return options;</span>
	}

	private String createBeforeDuration(RequestContext context, int rowIndex, int durationMinutes, boolean beforeExtensionEditable) {
		String html;
<span class="nc bnc" id="L500" title="All 2 branches missed.">		if (isViewOnlyMode()) {</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">			html = (durationMinutes &gt; 0) ? context.getLocalizer().formatDurationInMins(durationMinutes) : &quot;&quot;;</span>
		} else {
<span class="nc" id="L503">			List&lt;StringsPair&gt; options = getDurationOptions(0, 1440, 1, context.getLocalizer());</span>
<span class="nc" id="L504">			html = HtmlUtil.makeSelectInput(BEFORE_DURATION_FN, String.valueOf(rowIndex), new String[]{String.valueOf(durationMinutes)},</span>
					JSUtil.SET_PAGEDIRTY + &quot;jQuery(document).trigger('extensionLengthUpdatedEvent');&quot;, options, null, false, false, beforeExtensionEditable);
		}
<span class="nc" id="L507">		return html;</span>
	}

	private String createBeforeGap(RequestContext context, int rowIndex, int durationMinutes, boolean beforeExtensionEditable) {
		String html;
<span class="nc bnc" id="L512" title="All 2 branches missed.">		if (isViewOnlyMode()) {</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">			html = (durationMinutes &gt; 0) ? context.getLocalizer().formatDurationInMins(durationMinutes) : &quot;&quot;;</span>
		} else {
<span class="nc" id="L515">			List&lt;StringsPair&gt; options = getDurationOptions(0, 1440, 1, context.getLocalizer());</span>
<span class="nc" id="L516">			html = HtmlUtil.makeSelectInput(BEFORE_GAP_FN, String.valueOf(rowIndex), new String[]{String.valueOf(durationMinutes)},</span>
					null, options, null, false, false, beforeExtensionEditable);
		}
<span class="nc" id="L519">		return html;</span>
	}

	private List&lt;StringsPair&gt; createExtensionActivityOptions(RequestContext context, Collection&lt;Activity&gt; extActivities) {
<span class="nc" id="L523">		List&lt;StringsPair&gt; options = new ArrayList&lt;StringsPair&gt;();</span>
<span class="nc bnc" id="L524" title="All 4 branches missed.">		if (extActivities != null &amp;&amp; !extActivities.isEmpty()) {</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">			for (Activity act : extActivities) {</span>
<span class="nc" id="L526">				StringsPair option = new StringsPair(act.getID().toString(), act.getName());</span>
<span class="nc" id="L527">				options.add(option);</span>
<span class="nc" id="L528">			}</span>
		} else {
<span class="nc" id="L530">			options.add(new StringsPair(CustomShiftRequestFormPopupPM.NONE_ID.toString(), &quot;&amp;lt;&quot; + context.getLocalizer().i18n(bundle, RmWebBundleKey.FLEX_EXTENSION_ACTIVITY_NONE) + &quot;&amp;gt;&quot;));</span>
		}
<span class="nc" id="L532">		return options;</span>
	}
	private String getExtensionActivityOptionName(Collection&lt;Activity&gt; extActivities, ID selectedActivityId) {
<span class="nc" id="L535">		String name = &quot;&quot;;</span>
<span class="nc bnc" id="L536" title="All 6 branches missed.">		if (selectedActivityId != null &amp;&amp; extActivities != null &amp;&amp; !extActivities.isEmpty()) {</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">			for (Activity act : extActivities) {</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">				if (act.getID().toString().equals(selectedActivityId.toString())) {</span>
<span class="nc" id="L539">					name = act.getName();</span>
				}
<span class="nc" id="L541">			}</span>
		}
<span class="nc" id="L543">		return name;</span>
	}
	private String createAfterActivity(RequestContext context, int rowIndex, List&lt;Activity&gt; extAfterActivities, ID afterActivityId, boolean afterExtensionEditable) {
		String html;
<span class="nc bnc" id="L547" title="All 2 branches missed.">		if (isViewOnlyMode()) {</span>
<span class="nc" id="L548">			html = getExtensionActivityOptionName(extAfterActivities, afterActivityId);</span>
		} else {
<span class="nc bnc" id="L550" title="All 2 branches missed.">			html = HtmlUtil.makeSelectInput(AFTER_ACTIVITY_FN, String.valueOf(rowIndex), new String[]{afterActivityId != null ? afterActivityId.toString() : CustomShiftRequestFormPopupPM.NONE_ID.toString()},</span>
<span class="nc" id="L551">				null, createExtensionActivityOptions(context, extAfterActivities), null, false, false, afterExtensionEditable);</span>
		}
<span class="nc" id="L553">		return html;</span>
	}

	private String createAfterActivityEditable(boolean afterActivityEditable) {
<span class="nc" id="L557">		return HtmlUtil.makeHiddenInput(AFTER_ACTIVITY_EDITABLE_FN, afterActivityEditable);</span>
	}

	private String createAfterDuration(RequestContext context, int rowIndex, int durationMinutes, boolean afterExtensionEditable) {
		String html;
<span class="nc bnc" id="L562" title="All 2 branches missed.">		if (isViewOnlyMode()) {</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">			html = (durationMinutes &gt; 0) ? context.getLocalizer().formatDurationInMins(durationMinutes) : &quot;&quot;;</span>
		} else {
<span class="nc" id="L565">			List&lt;StringsPair&gt; options = getDurationOptions(0, 1440, 1, context.getLocalizer());</span>
<span class="nc" id="L566">			html = HtmlUtil.makeSelectInput(AFTER_DURATION_FN, String.valueOf(rowIndex), new String[]{String.valueOf(durationMinutes)},</span>
					JSUtil.SET_PAGEDIRTY + &quot;jQuery(document).trigger('extensionLengthUpdatedEvent');&quot;, options, null, false, false, afterExtensionEditable);
		}
<span class="nc" id="L569">		return html;</span>
	}

	private String createAfterGap(RequestContext context, int rowIndex, int durationMinutes, boolean afterExtensionEditable) {
		String html;
<span class="nc bnc" id="L574" title="All 2 branches missed.">		if (isViewOnlyMode()) {</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">			html = (durationMinutes &gt; 0) ? context.getLocalizer().formatDurationInMins(durationMinutes) : &quot;&quot;;</span>
		} else {
<span class="nc" id="L577">			List&lt;StringsPair&gt; options = getDurationOptions(0, 1440, 1, context.getLocalizer());</span>
<span class="nc" id="L578">			html = HtmlUtil.makeSelectInput(AFTER_GAP_FN, String.valueOf(rowIndex), new String[]{String.valueOf(durationMinutes)},</span>
					null, options, null, false, false, afterExtensionEditable);
		}
<span class="nc" id="L581">		return html;</span>
	}

	private int calculateDurationValue(String value) {
		int result;
<span class="nc bnc" id="L586" title="All 2 branches missed.">		if (value == null) {</span>
<span class="nc" id="L587">			result = 0;</span>
		} else {
<span class="nc" id="L589">			result = Integer.parseInt(value);</span>
		}
<span class="nc" id="L591">		return result;</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L597">		boolean result = super.extractParameters(request);</span>

		// Extract shift dates, before extensions, after extensions to timeoffRequest.flexRequestMakeupList
<span class="nc" id="L600">		paramDates = createShiftDatePicker(getRequestContext(), CalendarPC.DEFAULT_FIRST_DAY_OF_WEEK, null, 0, null).getDates();</span>
<span class="nc" id="L601">		paramBeforeActivities = ParameterUtil.getParameters(request, BEFORE_ACTIVITY_FN);</span>
<span class="nc" id="L602">		paramBeforeActivitiesEditable = ParameterUtil.getParameters(request, BEFORE_ACTIVITY_EDITABLE_FN);</span>
<span class="nc" id="L603">		paramBeforeGaps = ParameterUtil.getParameters(request, BEFORE_GAP_FN);</span>
<span class="nc" id="L604">		paramBeforeDurations = ParameterUtil.getParameters(request, BEFORE_DURATION_FN);</span>
<span class="nc" id="L605">		paramAfterActivities = ParameterUtil.getParameters(request, AFTER_ACTIVITY_FN);</span>
<span class="nc" id="L606">		paramAfterActivitiesEditable = ParameterUtil.getParameters(request, AFTER_ACTIVITY_EDITABLE_FN);</span>
<span class="nc" id="L607">		paramAfterGaps = ParameterUtil.getParameters(request, AFTER_GAP_FN);</span>
<span class="nc" id="L608">		paramAfterDurations = ParameterUtil.getParameters(request, AFTER_DURATION_FN);</span>
<span class="nc" id="L609">		paramShiftAssignmentIds = request.getParameterValues(SHIFT_ASSIGNMENT_ID_FN); //$NON-NLS-1$</span>
<span class="nc" id="L610">		boolean isManagerMode = RmKeys.RP_MODE_MGR.equals(ParameterUtil.getParameter(request, &quot;pageMode&quot;));</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">		ID requestedForID = !isManagerMode ? m_context.getUser().getEmployeeID() : timeoffRequest.getEmployeeID();</span>

<span class="nc" id="L613">		paramValid = true;</span>

		// If the table is submitted, extract rows
<span class="nc bnc" id="L616" title="All 2 branches missed.">		if (!paramDates.isEmpty()) {</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">			if (paramDates.size() == 1) {</span>
				// Need at least one row
<span class="nc" id="L619">				paramValid = false;</span>
<span class="nc" id="L620">				addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.FLEX_SHIFT_EMPTY_ERROR, RmWebBundleKey.BUNDLE_NAME);</span>
			} else {
				try {
<span class="nc" id="L623">					Collection&lt;FlexRequestMakeup&gt; flexMakeups = extractFlexMakeupsParameters(this.getRequestContext(), requestedForID);</span>
<span class="nc" id="L624">					timeoffRequest.setFlexRequestMakeupList(flexMakeups);</span>
<span class="nc" id="L625">				} catch (Exception e) {</span>
<span class="nc" id="L626">					LOG.warn(e, e);</span>
<span class="nc" id="L627">					paramValid = false;</span>
<span class="nc" id="L628">					addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.FLEX_SHIFT_INVALID_INPUT_ERROR, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L629">				}</span>
			}
		}

<span class="nc bnc" id="L633" title="All 4 branches missed.">		return result &amp;&amp; paramValid;</span>
	}

	private Collection&lt;FlexRequestMakeup&gt; extractFlexMakeupsParameters(RequestContext context, ID requestedForID) throws Exception {

		// For the rows with newly changed date (i.e. assignment id = null), query assignment info and update request params accordingly
<span class="nc bnc" id="L639" title="All 2 branches missed.">		for (int i = 1; i &lt; paramDates.size(); i++) {</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">			if (&quot;null&quot;.equals(paramShiftAssignmentIds[i])) {</span>
<span class="nc" id="L641">				ShiftAssignmentDetailData db = modelHandler.getShiftAssignmentDetail(context, context.getUser().getEmployeeID(), requestedForID, paramDates.get(i));</span>
<span class="nc" id="L642">				updateRequestParameterForSelectedDate(db, i);</span>
			}
		}

		// Update flexMakeups object using request parameters

<span class="nc" id="L648">		Collection&lt;FlexRequestMakeup&gt; flexMakeups = new ArrayList&lt;FlexRequestMakeup&gt;();</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">		for (int i = 1; i &lt; paramDates.size(); i++) {</span>
<span class="nc" id="L650">			FlexRequestMakeup flexMakeup = new FlexRequestMakeup();</span>
<span class="nc" id="L651">			ShiftAssignmentDetailData db = null;</span>

			// If new date is selected, find shift assignment for that date
<span class="nc bnc" id="L654" title="All 2 branches missed.">			if (!StringUtil.isEmpty(paramShiftAssignmentIds[i])) {</span>

				// If existing assignment found for the date
<span class="nc" id="L657">				ShiftAssignmentDetailData tmp = modelHandler.getShiftAssignmentDetail(context, context.getUser().getEmployeeID(), requestedForID, paramDates.get(i));</span>

				// use shift info if the shift assignment hasn't been changed
<span class="nc bnc" id="L660" title="All 4 branches missed.">				if (tmp.getShiftAssignmentInfo() != null &amp;&amp; ID.fromInt(Integer.parseInt(paramShiftAssignmentIds[i])).equals(tmp.getShiftAssignmentInfo().getShiftAssignmentId())) {</span>
<span class="nc" id="L661">					db = tmp;</span>
				}
			}

<span class="nc bnc" id="L665" title="All 2 branches missed.">			if (db != null) {</span>
				// found valid published assignment on the date, and it hasn't been changed since the time user viewing it
<span class="nc" id="L667">				flexMakeup.setShiftAssignmentID(db.getShiftAssignmentInfo().getShiftAssignmentId());</span>

<span class="nc" id="L669">				flexMakeup.setSPID(modelHandler.getSPID(context, requestedForID, paramDates.get(i)));</span>

<span class="nc" id="L671">				Pair&lt;Date, Date&gt; mainShiftStartEnd = modelHandler.getMainShiftStartEnd(context, db.getShiftAssignment());</span>
<span class="nc" id="L672">				flexMakeup.setShiftStartTime(mainShiftStartEnd.getFirst());</span>
<span class="nc" id="L673">				flexMakeup.setShiftEndTime(mainShiftStartEnd.getSecond());</span>

<span class="nc bnc" id="L675" title="All 6 branches missed.">				if (Boolean.valueOf(paramBeforeActivitiesEditable[i]) &amp;&amp; !StringUtil.isEmpty(paramBeforeActivities[i]) &amp;&amp; !CustomShiftRequestFormPopupPM.NONE_ID.toString().equals(paramBeforeActivities[i])) {</span>
<span class="nc" id="L676">					flexMakeup.setExtBeforeActivityID(ID.fromInt(Integer.parseInt(paramBeforeActivities[i])));</span>
<span class="nc" id="L677">					flexMakeup.setExtBeforeGap(calculateDurationValue(paramBeforeGaps[i]));</span>
<span class="nc" id="L678">					flexMakeup.setExtBeforeDuration(calculateDurationValue(paramBeforeDurations[i]));</span>
				}
<span class="nc bnc" id="L680" title="All 6 branches missed.">				if (Boolean.valueOf(paramAfterActivitiesEditable[i]) &amp;&amp; !StringUtil.isEmpty(paramAfterActivities[i]) &amp;&amp; !CustomShiftRequestFormPopupPM.NONE_ID.toString().equals(paramAfterActivities[i])) {</span>
<span class="nc" id="L681">					flexMakeup.setExtAfterActivityID(ID.fromInt(Integer.parseInt(paramAfterActivities[i])));</span>
<span class="nc" id="L682">					flexMakeup.setExtAfterGap(calculateDurationValue(paramAfterGaps[i]));</span>
<span class="nc" id="L683">					flexMakeup.setExtAfterDuration(calculateDurationValue(paramAfterDurations[i]));</span>
				}

<span class="nc" id="L686">				modelHandler.setMakeupStartAndEnd(flexMakeup, context);</span>

<span class="nc" id="L688">			} else {</span>
				// no assignment found on the date or the original published assignment has been changed
<span class="nc" id="L690">				flexMakeup.setShiftAssignmentID(null);</span>
<span class="nc" id="L691">				flexMakeup.setShiftStartTime(paramDates.get(i));</span>
<span class="nc" id="L692">				flexMakeup.setStartTime(paramDates.get(i));</span>
			}

<span class="nc" id="L695">			flexMakeups.add(flexMakeup);</span>

		}
<span class="nc" id="L698">		return flexMakeups;</span>
	}



	private void updateRequestParameterForSelectedDate(ShiftAssignmentDetailData db, int rowIndex)
			throws Exception {
<span class="nc bnc" id="L705" title="All 2 branches missed.">		if (db.getShiftAssignmentInfo() != null) {</span>

			// SHIFT ASSIGNMENT
<span class="nc" id="L708">			ShiftAssignmentInfo shiftAssignmentInfo = db.getShiftAssignmentInfo();</span>
<span class="nc" id="L709">			ShiftExtension beforeExtension = db.getBeforeExtension();</span>
<span class="nc" id="L710">			ShiftExtension afterExtension = db.getAfterExtension();</span>
<span class="nc" id="L711">			paramShiftAssignmentIds[rowIndex] = shiftAssignmentInfo.getShiftAssignmentId().toString();</span>

<span class="nc" id="L713">			paramBeforeActivitiesEditable[rowIndex] = String.valueOf(isBeforeExtensionEditable(db.getShiftAssignment()));</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">			if (beforeExtension.getActivityId() != null) {</span>
<span class="nc" id="L715">				paramBeforeActivities[rowIndex] = String.valueOf(beforeExtension.getActivityId());</span>
			} else {
<span class="nc" id="L717">				paramBeforeActivities[rowIndex] = CustomShiftRequestFormPopupPM.NONE_ID.toString();</span>
			}
<span class="nc" id="L719">			paramBeforeGaps[rowIndex] = String.valueOf(beforeExtension.getGap());</span>
<span class="nc" id="L720">			paramBeforeDurations[rowIndex] = String.valueOf(beforeExtension.getLength());</span>

<span class="nc" id="L722">			paramAfterActivitiesEditable[rowIndex] = String.valueOf(isAfterExtensionEditable(db.getShiftAssignment()));</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">			if (afterExtension.getActivityId() != null) {</span>
<span class="nc" id="L724">				paramAfterActivities[rowIndex] = String.valueOf(afterExtension.getActivityId());</span>
			} else {
<span class="nc" id="L726">				paramAfterActivities[rowIndex] = CustomShiftRequestFormPopupPM.NONE_ID.toString();</span>
			}
<span class="nc" id="L728">			paramAfterGaps[rowIndex] = String.valueOf(afterExtension.getGap());</span>
<span class="nc" id="L729">			paramAfterDurations[rowIndex] = String.valueOf(afterExtension.getLength());</span>

<span class="nc" id="L731">		} else {</span>
			// no valid assignment found
<span class="nc" id="L733">			paramShiftAssignmentIds[rowIndex] = &quot;&quot;;</span>
<span class="nc" id="L734">			paramBeforeActivitiesEditable[rowIndex] = &quot;false&quot;;</span>
<span class="nc" id="L735">			paramAfterActivitiesEditable[rowIndex] = &quot;false&quot;;</span>
		}
<span class="nc" id="L737">	}</span>


	@Override
	public boolean validate() {
<span class="nc bnc" id="L742" title="All 4 branches missed.">		return super.validate() &amp;&amp; paramValid;</span>
	}

	// To be called by page model to simulate initializeModel event
	public void initializeModel(TORequest timeoffRequest, ID employeeID, OrganizationSetting orgSettings) {
<span class="nc" id="L747">		this.timeoffRequest = timeoffRequest;</span>
<span class="nc" id="L748">		this.employeeID = employeeID;</span>
<span class="nc" id="L749">		this.orgSettings = orgSettings;</span>
<span class="nc" id="L750">	}</span>

	// To be called by page model to simulate initializeContent event
	public void initializeContent() throws Exception {
		// initialize shiftRequestTable
<span class="nc" id="L755">		DynamicMultiColListWithToolbarPC shiftRequestTable = createShiftRequestTable(getRequestContext(), getName() + &quot;_shifttable&quot;, employeeID);</span>

		// update shiftRequestTable rows
<span class="nc" id="L758">		int[] outExtensionLength = new int[1];</span>
<span class="nc" id="L759">		Set&lt;String&gt; outputErrorMessages = new LinkedHashSet&lt;String&gt;();</span>

<span class="nc" id="L761">		shiftRequestTable.getDynamicMultiColList().setListModel(createRows(getRequestContext(), timeoffRequest, employeeID, outExtensionLength, outputErrorMessages));</span>

<span class="nc bnc" id="L763" title="All 2 branches missed.">		if (!isViewOnlyMode()) {</span>
<span class="nc" id="L764">			String lengthTotal = getLocalizer().i18n(bundle, RmWebBundleKey.FLEX_SHIFT_MAKEUP_TOTAL).replace(&quot;{0}&quot;, &quot;&lt;span id='makeupTotal'&gt;&quot; + modelHandler.formatMakeupLength(getRequestContext(), outExtensionLength[0]) + &quot;&lt;/span&gt;&quot;);</span>
<span class="nc" id="L765">			shiftRequestTable.getToolbar().addToolbarComponent(</span>
					&quot;&lt;td&gt;&lt;span id='makeupTotalMessage' style='font-family:arial;font-size:12px;font-weight: bold;white-space:nowrap;margin-right:30px;'&gt;&quot; + lengthTotal + &quot;&lt;/span&gt;&lt;/td&gt;&quot;);
		}

		// Show error messages found when displaying makeup rows for PENDING requests
<span class="nc bnc" id="L770" title="All 2 branches missed.">		if (!isViewOnlyMode()) {</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">			for (String outputErrorMessage : outputErrorMessages) {</span>
<span class="nc" id="L772">				addPageMessage(Message.ERROR_TYPE, outputErrorMessage);</span>
<span class="nc" id="L773">			}</span>
		}

<span class="nc" id="L776">		addComponent(shiftRequestTable);</span>

<span class="nc" id="L778">	}</span>

	private List&lt;DefaultMultiColumnNodeData&gt; createRows(RequestContext context, TORequest timeoffRequest, ID employeeID, int[] outExtensionLength, Set&lt;String&gt; outputErrorMessages) throws Exception {
<span class="nc" id="L781">		List&lt;DefaultMultiColumnNodeData&gt; list = new ArrayList&lt;DefaultMultiColumnNodeData&gt;();</span>

		// See QueueVCTFormPageModel for the usage of rowIndex
<span class="nc" id="L784">		int rowIndex = 1;</span>
<span class="nc bnc" id="L785" title="All 4 branches missed.">		if (timeoffRequest.getID() == null &amp;&amp; timeoffRequest.getFlexRequestMakeupList().isEmpty()) {</span>
<span class="nc" id="L786">			list.add(createDataRow(context, rowIndex ++, null, timeoffRequest.isPending(), employeeID, outExtensionLength, outputErrorMessages));</span>
		} else {
<span class="nc bnc" id="L788" title="All 2 branches missed.">			for (FlexRequestMakeup makeup : timeoffRequest.getFlexRequestMakeupList()) {</span>
<span class="nc" id="L789">				int[] subTotal = new int[1];</span>
<span class="nc" id="L790">				list.add(createDataRow(context, rowIndex ++, makeup, timeoffRequest.isPending(), employeeID, subTotal, outputErrorMessages));</span>
<span class="nc" id="L791">				outExtensionLength[0] += subTotal[0];</span>
<span class="nc" id="L792">			}</span>
		}

<span class="nc" id="L795">		return list;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>