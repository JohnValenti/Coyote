<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WSAutoScheduleRequestDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.ejb.bbm.schedule.model</a> &gt; <span class="el_source">WSAutoScheduleRequestDAO.java</span></div><h1>WSAutoScheduleRequestDAO.java</h1><pre class="source lang-java linenums">package com.verint.ejb.bbm.schedule.model;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriodFieldInfo;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.core.base.MultiUserException;

public class WSAutoScheduleRequestDAO extends DAOBase&lt;WSAutoScheduleRequest&gt; {

<span class="nc" id="L23">	private static FieldInfo m_fieldInfo = new WSAutoScheduleRequestFieldInfo();</span>
	
	public WSAutoScheduleRequestDAO() {
<span class="nc" id="L26">		super();</span>
<span class="nc" id="L27">	}</span>

	public WSAutoScheduleRequestDAO(Jdmo dmo) {
<span class="nc" id="L30">		super(dmo);</span>
<span class="nc" id="L31">	}</span>

	protected FieldInfo getFieldInfo() {
<span class="nc" id="L34">		return m_fieldInfo;</span>
	}

	@Override
	protected WSAutoScheduleRequest createValueObject() {
<span class="nc" id="L39">		return new WSAutoScheduleRequest();</span>
	}

	/**
	 * Create the scheduling requests and returns the ID of the scheduling
	 * Request &lt;b&gt;Note: &lt;/b&gt; Cleanup the dao after use. Else will result in
	 * connection leak.
	 * 
	 * @param request
	 * @return
	 * @throws JdmoException
	 */
	public ID createSchedulingRequest(WSAutoScheduleRequest request, String modifiedBy) throws JdmoException {
<span class="nc" id="L52">		ID createdID = null;</span>
<span class="nc" id="L53">		Object statusMessageTypeObj = request</span>
<span class="nc" id="L54">				.getFieldValue(WSAutoScheduleRequestFieldInfo.STATUSMESSAGETYPE);</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">		String statusMessageType = statusMessageTypeObj != null ? statusMessageTypeObj</span>
<span class="nc" id="L56">				.toString() : null;</span>

<span class="nc" id="L58">		String strCreate = &quot;INSERT INTO &quot;</span>
<span class="nc" id="L59">				+ request.getFieldInfo().getTableName()</span>
				+ &quot; ( SPID, MODE, SCHEDULESTATUS, PROGRESS, STATUSMESSAGETYPE,STATUSMESSAGE, DATECREATED, MODIFIEDBY ) values ('&quot;
<span class="nc" id="L61">				+ request.getFieldValueInt(WSAutoScheduleRequestFieldInfo.SPID)</span>
				+ &quot;','&quot;
<span class="nc" id="L63">				+ request.getMode()</span>
				+ &quot;','&quot;
<span class="nc" id="L65">				+ request.getSchedulingStatus()</span>
				+ &quot;',&quot;
<span class="nc bnc" id="L67" title="All 2 branches missed.">				+ (request.getProgress() &gt; 0 ? request.getProgress() + &quot;,&quot;</span>
						: &quot;null,&quot;)
<span class="nc" id="L69">				+ JdmoUtil.asSqlLiteral(statusMessageType)</span>
				+ &quot;,&quot;
<span class="nc" id="L71">				+ JdmoUtil.asSqlLiteral(request.getStatusMessage())</span>
				+  &quot;,&quot;
<span class="nc bnc" id="L73" title="All 2 branches missed.">				+ JdmoUtil.asSqlLiteral(Calendar.getInstance().getTime())</span>
				+ &quot;,&quot; 
				+ ((modifiedBy != null)?
					&quot;'&quot; + modifiedBy + &quot;'&quot;:&quot;null&quot;)
				+&quot;)&quot;;

<span class="nc" id="L79">		int result = m_dmo.executeCommand(strCreate);</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">		if (result &gt; 0) {</span>

			// find SID and return
<span class="nc" id="L83">			String stmt = &quot;SELECT MAX(ID) FROM &quot;</span>
<span class="nc" id="L84">					+ request.getFieldInfo().getTableName()</span>
					+ &quot; WHERE SPID =&quot;
					+ request
<span class="nc" id="L87">							.getFieldValueInt(WSAutoScheduleRequestFieldInfo.SPID)</span>
<span class="nc" id="L88">					+ &quot; AND SCHEDULESTATUS = '&quot; + request.getSchedulingStatus()</span>
					+ &quot;'&quot;;
<span class="nc" id="L90">			JdmoRowset rs = m_dmo.createRowset(stmt);</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L92">				createdID = rs.getID(1);</span>
			}
<span class="nc" id="L94">			rs.close();</span>
		}
<span class="nc" id="L96">		return createdID;</span>
	}

	/**
	 * Updates the scheduling request &lt;b&gt;Note: &lt;/b&gt; Cleanup the dao after use.
	 * Else will result in connection leak.
	 * 
	 * 
	 * @param request
	 * @throws JdmoException
	 */
	public void updateSchedulingRequest(WSAutoScheduleRequest request) throws JdmoException {
<span class="nc bnc" id="L108" title="All 2 branches missed.">		if (request.getFieldValue(WSAutoScheduleRequestFieldInfo.LASTUPDATED) == null) {</span>
<span class="nc" id="L109">			request.setFieldValue(WSAutoScheduleRequestFieldInfo.LASTUPDATED, Calendar.getInstance().getTime());</span>
		}
		try {
<span class="nc" id="L112">			updateObject(request);</span>
<span class="nc" id="L113">		} catch (MultiUserException e) {</span>
<span class="nc" id="L114">			throw new JdmoException(e);</span>
<span class="nc" id="L115">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L116">			throw new JdmoException(e);</span>
<span class="nc" id="L117">		}</span>

<span class="nc" id="L119">	}</span>

	/**
	 * Updates the scheduling state of all the scheduling requests for the given
	 * spIds and the present schedulestate as the 'currentStatus' with the
	 * 'newStatus' &lt;b&gt;Note: &lt;/b&gt; Cleanup the dao after use. Else will result in
	 * connection leak.
	 * 
	 * @param spIDs
	 * @param currentStatus
	 * @param newStatus
	 * @throws JdmoException
	 */
	public void updateScheduleStatusForSPs(List&lt;ID&gt; spIDs, String currentStatus, String newStatus, String errorMessage)
			throws JdmoException {
<span class="nc bnc" id="L134" title="All 2 branches missed.">		if (!spIDs.isEmpty()) {</span>
<span class="nc" id="L135">			StringBuilder strUpdateBuffer = new StringBuilder();</span>
<span class="nc" id="L136">			strUpdateBuffer.append(&quot;UPDATE &quot;);</span>
<span class="nc" id="L137">			strUpdateBuffer.append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L138">			strUpdateBuffer.append(&quot; SET SCHEDULESTATUS = &quot;);</span>
<span class="nc" id="L139">			strUpdateBuffer.append(JdmoUtil.asSqlLiteral(newStatus));</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">			if (!StringUtil.isEmpty(errorMessage)) {</span>
<span class="nc" id="L141">				strUpdateBuffer.append(&quot; , STATUSMESSAGE = &quot;);</span>
<span class="nc" id="L142">				strUpdateBuffer.append(JdmoUtil.asSqlLiteral(errorMessage));</span>
			}
<span class="nc" id="L144">			strUpdateBuffer.append(&quot;, LASTUPDATED = &quot;);</span>
<span class="nc" id="L145">			strUpdateBuffer.append(JdmoUtil.asSqlLiteral(Calendar.getInstance().getTime()));</span>
<span class="nc" id="L146">			strUpdateBuffer.append(&quot; where SPID in &quot;);</span>
<span class="nc" id="L147">			strUpdateBuffer.append(getDMO().createInClause(spIDs));</span>
<span class="nc" id="L148">			strUpdateBuffer.append(&quot; and SCHEDULESTATUS = &quot;);</span>
<span class="nc" id="L149">			strUpdateBuffer.append(JdmoUtil.asSqlLiteral(currentStatus));</span>

<span class="nc" id="L151">			m_dmo.executeCommand(strUpdateBuffer.toString());</span>
		}
<span class="nc" id="L153">	}</span>

	/**
	 * Updates the scheduling state of all the given scheduling requests with
	 * the 'newStatus' if the currentStatus is null, Otherwise updates the
	 * status of requests that have the ScheduleStatus as the currentStatus
	 * &lt;b&gt;Note: &lt;/b&gt; Cleanup the dao after use. Else will result in connection
	 * leak.
	 * 
	 * @param requestIDs
	 * @param newStatus
	 * @param message
	 * @throws JdmoException
	 */
	public void updateScheduleStatus(List&lt;ID&gt; requestIDs, String currentStatus, String newStatus, String message)
			throws JdmoException {
<span class="nc bnc" id="L169" title="All 2 branches missed.">		if (!requestIDs.isEmpty()) {</span>
<span class="nc" id="L170">			StringBuilder strUpdateBuffer = new StringBuilder();</span>
<span class="nc" id="L171">			strUpdateBuffer.append(&quot;UPDATE &quot;);</span>
<span class="nc" id="L172">			strUpdateBuffer.append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L173">			strUpdateBuffer.append(&quot; SET SCHEDULESTATUS = &quot;);</span>
<span class="nc" id="L174">			strUpdateBuffer.append(JdmoUtil.asSqlLiteral(newStatus));</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">			if (!StringUtil.isEmpty(message)) {</span>
<span class="nc" id="L176">				strUpdateBuffer.append(&quot; , STATUSMESSAGE = &quot;);</span>
<span class="nc" id="L177">				strUpdateBuffer.append(JdmoUtil.asSqlLiteral(message));</span>
			}
<span class="nc" id="L179">			strUpdateBuffer.append(&quot;, LASTUPDATED = &quot;);</span>
<span class="nc" id="L180">			strUpdateBuffer.append(JdmoUtil.asSqlLiteral(Calendar.getInstance().getTime()));</span>
<span class="nc" id="L181">			strUpdateBuffer.append(&quot; where ID in &quot;);</span>
<span class="nc" id="L182">			strUpdateBuffer.append(getDMO().createInClause(requestIDs));</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">			if (currentStatus != null) {</span>
<span class="nc" id="L184">				strUpdateBuffer.append(&quot; and SCHEDULESTATUS =  &quot;);</span>
<span class="nc" id="L185">				strUpdateBuffer.append(JdmoUtil.asSqlLiteral(currentStatus));</span>
			}

<span class="nc" id="L188">			m_dmo.executeCommand(strUpdateBuffer.toString());</span>
		}
<span class="nc" id="L190">	}</span>

	/**
	 * Returns all the scheduling requests of the given status &lt;b&gt;Note: &lt;/b&gt;
	 * Cleanup the dao after use. Else will result in connection leak. *
	 * 
	 * @param status
	 * @return
	 * @throws BbmFinderException
	 */
	public List&lt;WSAutoScheduleRequest&gt; getRequestsByStatus(String status) throws BbmFinderException {
<span class="nc" id="L201">		StringBuilder strWhere = new StringBuilder();</span>
<span class="nc" id="L202">		strWhere.append(&quot;A.&quot;).append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.SCHEDULESTATUS));</span>
<span class="nc" id="L203">		strWhere.append(&quot; = '&quot;).append(status).append(&quot;'&quot;);</span>
<span class="nc" id="L204">		return (List&lt;WSAutoScheduleRequest&gt;) getObjects(strWhere.toString(), &quot;order by A.ID&quot;);</span>

	}

	/**
	 * Returns all the scheduling requests of the given Ids and the given status
	 * &lt;b&gt;Note: &lt;/b&gt; Cleanup the dao after use. Else will result in connection
	 * leak.
	 * 
	 * @param status
	 * @param requestID
	 * @return
	 * @throws BbmFinderException
	 */
	public List&lt;WSAutoScheduleRequest&gt; getRequestsByStatus(String status,
			List&lt;ID&gt; requestIDs) throws BbmFinderException {
		try {
<span class="nc" id="L221">			StringBuilder strWhere = new StringBuilder();</span>
<span class="nc" id="L222">			strWhere.append(&quot;A.SCHEDULESTATUS = '&quot;).append(status).append(&quot;'&quot;);</span>
<span class="nc" id="L223">			strWhere.append(&quot; and A.ID in &quot;);</span>
<span class="nc" id="L224">			strWhere.append(getDMO().createInClause(requestIDs));</span>
<span class="nc" id="L225">			return (List&lt;WSAutoScheduleRequest&gt;) getObjects(</span>
<span class="nc" id="L226">					strWhere.toString(), &quot;order by A.ID&quot;);</span>
<span class="nc" id="L227">		} catch (JdmoException any) {</span>
<span class="nc" id="L228">			throw new BbmFinderException(any);</span>
		}
	}

	/**
	 * Returns all the scheduling requests of the given sp Id and the given
	 * status&lt;b&gt;Note: &lt;/b&gt; Cleanup the dao after use. Else will result in
	 * connection leak.
	 * 
	 * @param status
	 * @param requestID
	 * @return
	 * @throws BbmFinderException
	 */
	public List&lt;WSAutoScheduleRequest&gt; getRequestsByStatusAndSP(String status, ID spID) throws BbmFinderException {
<span class="nc" id="L243">		StringBuilder strWhere = new StringBuilder();</span>
<span class="nc" id="L244">		strWhere.append(&quot;A.SCHEDULESTATUS = '&quot;).append(status).append(&quot;'&quot;);</span>
<span class="nc" id="L245">		strWhere.append(&quot; and A.SPID = &quot;);</span>
<span class="nc" id="L246">		strWhere.append(spID.toInt());</span>
<span class="nc" id="L247">		return (List&lt;WSAutoScheduleRequest&gt;) getObjects(strWhere.toString(), &quot;order by A.ID&quot;);</span>

	}

	/**
	 * Returns the latest Request for the given scheduling period &lt;b&gt;Note: &lt;/b&gt;
	 * Cleanup the dao after use. Else will result in connection leak.
	 * 
	 * @param spId
	 * @return
	 * @throws BbmFinderException
	 */
	public WSAutoScheduleRequest getLatestRequestForSP(int spId) throws BbmFinderException {

<span class="nc" id="L261">		StringBuilder strWhere = new StringBuilder();</span>
<span class="nc" id="L262">		strWhere.append(&quot;A.ID = &quot;)</span>
<span class="nc" id="L263">				.append(&quot;(select MAX(ID) from &quot; + m_fieldInfo.getTableName() + &quot; where SPID=&quot; + spId + &quot;)&quot;);</span>
<span class="nc" id="L264">		List&lt;WSAutoScheduleRequest&gt; requests = (List&lt;WSAutoScheduleRequest&gt;) getObjects(new String(strWhere));</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">		if (requests.size() == 1) {</span>
<span class="nc" id="L266">			return requests.get(0);</span>
		}

<span class="nc" id="L269">		return null;</span>
	}

	/**
	 * Returns the Requests of the 'status' that are before the spID
	 * 
	 * @param spID
	 * @param status
	 * @param isSameCampaign
	 *            if this is true, this method returns only requests that have
	 *            the same campaign as the sp
	 * @return
	 */
	public List&lt;ID&gt; getRequestsBeforeSPByStatus(int spID, String[] status, boolean isSameCampaign)
			throws JdmoException {
		// Could be converted to stored proc latter
		// select A.ID, A.SPID, A.SCHEDULESTATUS from WSAUTOSCHEDULEREQUEST A,
		// SP B
		// where A.SCHEDULESTATUS IN ('N','P')
		// AND A.SPID = B.SID
		// AND B.CAMPAIGNID in (select CAMPAIGNID from SP where SID = @spid)
		// AND B.TODATE &lt;= (select MIN(FROMDATE) from SP where SID = @spid)
<span class="nc" id="L291">		SchedulingPeriodFieldInfo spInfo = new SchedulingPeriodFieldInfo();</span>
<span class="nc" id="L292">		StringBuilder sb = new StringBuilder();</span>
		// build the query
<span class="nc" id="L294">		sb.append(&quot;select A.&quot;);</span>
<span class="nc" id="L295">		sb.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.ID));</span>
<span class="nc" id="L296">		sb.append(&quot; from &quot;);</span>
<span class="nc" id="L297">		sb.append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L298">		sb.append(&quot; A,  &quot;);</span>
<span class="nc" id="L299">		sb.append(spInfo.getTableName());</span>
<span class="nc" id="L300">		sb.append(&quot; B where &quot;);</span>
<span class="nc bnc" id="L301" title="All 4 branches missed.">		if (status != null &amp;&amp; status.length &gt; 0) {</span>
<span class="nc" id="L302">			sb.append(&quot;A.&quot;);</span>
<span class="nc" id="L303">			sb.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.SCHEDULESTATUS));</span>
<span class="nc" id="L304">			sb.append(&quot; in (&quot;);</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">			for (int i = 0; i &lt; status.length; i++) {</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">				if (i &gt; 0) {</span>
<span class="nc" id="L307">					sb.append(&quot;, &quot;);</span>
				}
<span class="nc" id="L309">				sb.append(&quot;'&quot; + status[i] + &quot;'&quot;);</span>
			}
<span class="nc" id="L311">			sb.append(&quot;)&quot;);</span>
		}
<span class="nc" id="L313">		sb.append(&quot; AND A.&quot;);</span>
<span class="nc" id="L314">		sb.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.SPID));</span>
<span class="nc" id="L315">		sb.append(&quot; = B.&quot;);</span>
<span class="nc" id="L316">		sb.append(spInfo.getFieldName(SchedulingPeriodFieldInfo.SP_ID));</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">		if (isSameCampaign) {</span>
<span class="nc" id="L318">			sb.append(&quot; AND B.&quot;);</span>
<span class="nc" id="L319">			sb.append(spInfo.getFieldName(SchedulingPeriodFieldInfo.SP_CAMPAIGNID));</span>
<span class="nc" id="L320">			sb.append(&quot; IN (SELECT &quot;);</span>
<span class="nc" id="L321">			sb.append(spInfo.getFieldName(SchedulingPeriodFieldInfo.SP_CAMPAIGNID));</span>
<span class="nc" id="L322">			sb.append(&quot; FROM &quot;);</span>
<span class="nc" id="L323">			sb.append(spInfo.getTableName());</span>
<span class="nc" id="L324">			sb.append(&quot; WHERE &quot;);</span>
<span class="nc" id="L325">			sb.append(spInfo.getFieldName(SchedulingPeriodFieldInfo.SP_ID));</span>
<span class="nc" id="L326">			sb.append(&quot; =  &quot; + spID + &quot;)&quot;);</span>
		}
<span class="nc" id="L328">		sb.append(&quot; AND B.&quot;);</span>
<span class="nc" id="L329">		sb.append(spInfo.getFieldName(SchedulingPeriodFieldInfo.SP_ENDTIME));</span>
<span class="nc" id="L330">		sb.append(&quot; &lt;= (SELECT MIN(&quot;);</span>
<span class="nc" id="L331">		sb.append(spInfo.getFieldName(SchedulingPeriodFieldInfo.SP_STARTTIME));</span>
<span class="nc" id="L332">		sb.append(&quot;) FROM &quot;);</span>
<span class="nc" id="L333">		sb.append(spInfo.getTableName());</span>
<span class="nc" id="L334">		sb.append(&quot; WHERE &quot;);</span>
<span class="nc" id="L335">		sb.append(spInfo.getFieldName(SchedulingPeriodFieldInfo.SP_ID));</span>
<span class="nc" id="L336">		sb.append(&quot; =  &quot; + spID + &quot;)&quot;);</span>

<span class="nc" id="L338">		String query = sb.toString();</span>

<span class="nc" id="L340">		JdmoRowset results = m_dmo.createRowset(query);</span>
<span class="nc" id="L341">		List&lt;ID&gt; earlierSPRequests = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">		while (results.next()) {</span>
<span class="nc" id="L343">			earlierSPRequests.add((ID) results.getID(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.ID)));</span>

		}
<span class="nc" id="L346">		return earlierSPRequests;</span>
	}
	
	/**
	 * Returns all requests created before the specified time with the given
	 * status not connected to the ScheduleMessage
	 * 
	 * @param status
	 * @throws JdmoException
	 */
	public List&lt;ID&gt; getRequestIDsNotLinkedToMessageByStatus(String[] statuses, Date createdBefore)
			throws JdmoException {
<span class="nc" id="L358">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L359">		sb.append(&quot;SELECT &quot;);</span>
<span class="nc" id="L360">		sb.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.ID));</span>
<span class="nc" id="L361">		sb.append(&quot; FROM &quot;);</span>
<span class="nc" id="L362">		sb.append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L363">		sb.append(&quot; WHERE &quot;);</span>
<span class="nc bnc" id="L364" title="All 4 branches missed.">		if (statuses != null &amp;&amp; statuses.length &gt; 0) {</span>
<span class="nc" id="L365">			sb.append(m_fieldInfo</span>
<span class="nc" id="L366">					.getFieldName(WSAutoScheduleRequestFieldInfo.SCHEDULESTATUS));</span>
<span class="nc" id="L367">			sb.append(&quot; IN (&quot;);</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">			for (int i = 0; i &lt; statuses.length; i++) {</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">				if (i &gt; 0) {</span>
<span class="nc" id="L370">					sb.append(&quot;, &quot;);</span>
				}
<span class="nc" id="L372">				sb.append(JdmoUtil.asSqlLiteral(statuses[i]));</span>
			}
<span class="nc" id="L374">			sb.append(&quot;)&quot;);</span>
<span class="nc" id="L375">			sb.append(&quot; AND &quot;);</span>
		}
<span class="nc bnc" id="L377" title="All 2 branches missed.">		if (createdBefore != null) {</span>
<span class="nc" id="L378">			sb.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.DATECREATED));</span>
<span class="nc" id="L379">			sb.append(&quot; &lt; &quot;);</span>
<span class="nc" id="L380">			sb.append(JdmoUtil.asSqlLiteral(createdBefore));</span>
<span class="nc" id="L381">			sb.append(&quot; AND &quot;);</span>
		}
<span class="nc" id="L383">		sb.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.ID));</span>
<span class="nc" id="L384">		sb.append(&quot; NOT IN (SELECT REQUESTID FROM SCHEDULEMESSAGEREQUESTMAPPING)&quot;);</span>
		
<span class="nc" id="L386">		JdmoRowset results = m_dmo.createRowset(sb.toString());</span>
<span class="nc" id="L387">		List&lt;ID&gt; requestIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">		while (results.next()) {</span>
<span class="nc" id="L389">			requestIDs.add(results.getID(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.ID)));</span>

		}
<span class="nc" id="L392">		return requestIDs;</span>
	}
	
	/**
	 * Increments the error retry count for all the requests of the given status
	 * @param status
	 * @throws JdmoException
	 */
	public void incrementErrorRetryCountForRequests(String status) throws JdmoException {
<span class="nc" id="L401">		StringBuilder strUpdateBuffer = new StringBuilder();</span>
<span class="nc" id="L402">		strUpdateBuffer.append(&quot;UPDATE &quot;);</span>
<span class="nc" id="L403">		strUpdateBuffer.append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L404">		strUpdateBuffer.append(&quot; SET &quot;);</span>
<span class="nc" id="L405">		strUpdateBuffer.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.ERRORRETRYCOUNT));</span>
<span class="nc" id="L406">		strUpdateBuffer.append(&quot; = COALESCE(&quot;);</span>
<span class="nc" id="L407">		strUpdateBuffer.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.ERRORRETRYCOUNT));</span>
<span class="nc" id="L408">		strUpdateBuffer.append(&quot;, 0) +1&quot;);</span>
<span class="nc" id="L409">		strUpdateBuffer.append(&quot;, LASTUPDATED = &quot;);</span>
<span class="nc" id="L410">		strUpdateBuffer.append(JdmoUtil.asSqlLiteral(Calendar.getInstance().getTime()));</span>
<span class="nc" id="L411">		strUpdateBuffer.append(&quot; WHERE &quot;);</span>
<span class="nc" id="L412">		strUpdateBuffer.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.SCHEDULESTATUS));</span>
<span class="nc" id="L413">		strUpdateBuffer.append(&quot; = &quot;);</span>
<span class="nc" id="L414">		strUpdateBuffer.append(JdmoUtil.asSqlLiteral(status));</span>
<span class="nc" id="L415">		m_dmo.executeCommand(strUpdateBuffer.toString());</span>
		
<span class="nc" id="L417">	}</span>
	
	/**
	 * Updates the status and status message for the requests whose status is
	 * the currentStatus and have an error retry count &gt; the maxErrorRetry count
	 */
	public void updateStatusForMaxErrorRetry(int maxErrorRetry, String currentStatus, String newStatus,
			String statusMessage) throws JdmoException {
<span class="nc" id="L425">		StringBuilder strUpdateBuffer = new StringBuilder();</span>
<span class="nc" id="L426">		strUpdateBuffer.append(&quot;UPDATE &quot;);</span>
<span class="nc" id="L427">		strUpdateBuffer.append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L428">		strUpdateBuffer.append(&quot; SET &quot;);</span>
<span class="nc" id="L429">		strUpdateBuffer.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.SCHEDULESTATUS));</span>
<span class="nc" id="L430">		strUpdateBuffer.append(&quot; = &quot;);</span>
<span class="nc" id="L431">		strUpdateBuffer.append(JdmoUtil.asSqlLiteral(newStatus));</span>
<span class="nc" id="L432">		strUpdateBuffer.append(&quot;, &quot;);</span>
<span class="nc" id="L433">		strUpdateBuffer.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.STATUSMESSAGE));</span>
<span class="nc" id="L434">		strUpdateBuffer.append(&quot; = COALESCE(&quot;);</span>
<span class="nc" id="L435">		strUpdateBuffer.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.STATUSMESSAGE));</span>
<span class="nc" id="L436">		strUpdateBuffer.append(&quot;, '') + &quot;);</span>
<span class="nc" id="L437">		strUpdateBuffer.append(JdmoUtil.asSqlLiteral(statusMessage));</span>
<span class="nc" id="L438">		strUpdateBuffer.append(&quot;, LASTUPDATED = &quot;);</span>
<span class="nc" id="L439">		strUpdateBuffer.append(JdmoUtil.asSqlLiteral(Calendar.getInstance().getTime()));</span>
<span class="nc" id="L440">		strUpdateBuffer.append(&quot; WHERE &quot;);</span>
<span class="nc" id="L441">		strUpdateBuffer.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.SCHEDULESTATUS));</span>
<span class="nc" id="L442">		strUpdateBuffer.append(&quot; = &quot;);</span>
<span class="nc" id="L443">		strUpdateBuffer.append(JdmoUtil.asSqlLiteral(currentStatus));</span>
<span class="nc" id="L444">		strUpdateBuffer.append(&quot; AND &quot;);</span>
<span class="nc" id="L445">		strUpdateBuffer.append(m_fieldInfo.getFieldName(WSAutoScheduleRequestFieldInfo.ERRORRETRYCOUNT));</span>
<span class="nc" id="L446">		strUpdateBuffer.append(&quot; &gt; &quot;);</span>
<span class="nc" id="L447">		strUpdateBuffer.append(JdmoUtil.asSqlLiteral(maxErrorRetry));</span>
<span class="nc" id="L448">		m_dmo.executeCommand(strUpdateBuffer.toString());</span>
<span class="nc" id="L449">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>