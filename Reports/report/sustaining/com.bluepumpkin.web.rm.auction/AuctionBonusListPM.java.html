<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AuctionBonusListPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.auction</a> &gt; <span class="el_source">AuctionBonusListPM.java</span></div><h1>AuctionBonusListPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.auction;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.TimeZone;
import java.util.HashSet;
import javax.servlet.http.HttpServletRequest;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.bluepumpkin.ejb.bbm.campaign.CampaignScopeManagerProxy;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.ejb.bbm.campaign.CampaignScopeManagerProxy;
import com.bluepumpkin.web.bbm.organization.tree.OrganizationTreeHelper;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.data.wrapper.NumberWrapper;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarUtil;
import com.witness.web.uif.pagemodel.WorkpaneListPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.auction.filter.BidOptionsFilterUtil;
import com.witness.web.uif.keys.UserPreferenceKeys;

/**
 * Title:        AuctionBonusListPM
 * Description:  Base Class for Auction List with Bonus Input
 * Copyright:    Copyright (c) 2003
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, DSu
 * @version      1.0
 *
 * Created on Aug 7, 2003, 10:16:13 AM
 */
public abstract class AuctionBonusListPM extends WorkpaneListPM implements AuctionPM {
	protected static final String BONUS_PREFIX_FN = &quot;bonusPF&quot;;
	protected static final String ORG_ID_FN = &quot;orgID&quot;;

	protected ResourceBundle m_bundle;
	protected FormInputPC m_formInputPC;
	protected TimeZone m_tz;
	protected String m_pageTitleRBKey;

	protected ID m_orgID;
<span class="nc" id="L53">	protected boolean m_isPageEnabled = true;</span>
	protected ShiftBidAuction m_auction;
<span class="nc" id="L55">	protected Collection m_listData = Collections.emptyList();</span>
<span class="nc" id="L56">	protected Collection m_orgList = Collections.emptyList();</span>

<span class="nc" id="L58">	protected Map m_bonusMap = Collections.emptyMap();</span>

	/**
	 * Constructor
	 */
	public AuctionBonusListPM(RequestContext context, String formAction, String pageTitleRBKey) {
<span class="nc" id="L64">		super(context, FRAMED_MODEL);</span>
<span class="nc" id="L65">		setFormAction(formAction);</span>
<span class="nc" id="L66">		m_list.setIsZebra(true);</span>
<span class="nc" id="L67">		m_pageTitleRBKey = pageTitleRBKey;</span>
<span class="nc" id="L68">		m_tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L69">		m_bundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L70">		setIsAutoSortEnabled(true);		</span>

<span class="nc" id="L72">		m_formInputPC = new FormInputPC(context);</span>
<span class="nc" id="L73">		addChildComponent(m_formInputPC);</span>
<span class="nc" id="L74">	}</span>

	/**
	 * Add Select Auction Message
	 */
	protected void addSelectAuctionMsg() {
<span class="nc" id="L80">		addPageMessage(Message.RESPONSE_TYPE, RmWebBundleKey.SELECT_AUCTION_MSG,</span>
				RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L82">	}</span>

	/**
	 * Return Bonus Map
	 */
	public Map getBonusMap() { 
<span class="nc" id="L88">		return m_bonusMap;</span>
	}

	@Override
	public void setIsPageEnabled(boolean bValue) { 
<span class="nc" id="L93">		m_isPageEnabled = bValue;</span>
<span class="nc" id="L94">	}</span>

	/**
	 * Set Organization ID
	 */
	public void setOrgID(ID id) { 
<span class="nc" id="L100">		m_orgID = id;</span>
<span class="nc" id="L101">	}</span>

	/**
	 * Retrieve request parameters from request object to the page model object.
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L108">		boolean success =  super.extractParameters(request);</span>

<span class="nc" id="L110">		m_bonusMap = FormInputPC.extractIDKeyParamMap(request, BONUS_PREFIX_FN);</span>

<span class="nc" id="L112">		return success;</span>
	}

	/**
	 * Initialize Content Title
	 */
	@Override
	protected void initContentTitle() {
<span class="nc" id="L120">		String pageTitle = i18n(m_bundle, m_pageTitleRBKey);</span>
<span class="nc" id="L121">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">		if (m_auction == null) {</span>
<span class="nc" id="L123">			return;</span>
		}

<span class="nc" id="L126">		String name = m_auction.getName();</span>
<span class="nc" id="L127">		AuctionUtil.initContentTitle(m_context, m_isPageEnabled, name, null, m_contentTitlePC, null);</span>

		// Add Organization Selector
<span class="nc bnc" id="L130" title="All 4 branches missed.">		if (m_orgList.size()&gt;1 &amp;&amp; m_isPageEnabled) {</span>
<span class="nc" id="L131">			String lbl = i18n(m_common_bundle, UIFWebBundleKey.FROM);</span>
<span class="nc" id="L132">			String orgSelector = getOrgSelector();</span>
<span class="nc" id="L133">			m_contentTitlePC.addActiveComponent(lbl, orgSelector, true);</span>
		}
<span class="nc" id="L135">	}</span>

	/**
	 * Initialize Toolbar
	 */
	@Override
	protected void initToolbar() {
<span class="nc bnc" id="L142" title="All 4 branches missed.">		boolean isEditable = isEditActionEnabled() &amp;&amp; hasEditableField();</span>

<span class="nc" id="L144">		ToolbarUtil.addValidateSaveBtn(m_toolbar, isEditable);</span>
<span class="nc" id="L145">		ToolbarUtil.addResetBtn(m_toolbar, isEditable);</span>

<span class="nc" id="L147">        enableToolbarPagination();</span>
<span class="nc" id="L148">	}</span>

	//////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	//////////////////////////////////////////////////////////////////////////////
	protected String getOrgSelector() {
<span class="nc bnc" id="L154" title="All 2 branches missed.">		String selectedVal = (m_orgID!=null)?m_orgID.toString():null;</span>

<span class="nc" id="L156">		ArrayList options = new ArrayList(m_orgList.size()+1);</span>
<span class="nc" id="L157">		options.add( new StringsPair(&quot;&quot;, i18n(m_common_bundle, UIFWebBundleKey.ALL)) );</span>
		
<span class="nc" id="L159">		Collection tmpList = null;</span>
		
		// Get user preference whether the org list should be indented or not.
<span class="nc" id="L162">		boolean isOrgListHierarchical = &quot;true&quot;.equals(</span>
<span class="nc" id="L163">				m_context.getUserProperty(UserPreferenceKeys.USER_SHOW_ORG_LIST_HIERARCHICAL));</span>
		
<span class="nc bnc" id="L165" title="All 2 branches missed.">		if(isOrgListHierarchical)</span>
		{
			// Hierarchical or indented org list
<span class="nc" id="L168">			tmpList = OrganizationTreeHelper.createIndentedOrgNameList(m_orgList, m_localizer);</span>
		}
		else 
		{
			// Straight list of organization (not indented) in user's scope
<span class="nc" id="L173">			tmpList = OrganizationTreeHelper.createOrgNameList(m_orgList, m_localizer);</span>
		}		
		
<span class="nc" id="L176">		options.addAll( tmpList );</span>

<span class="nc" id="L178">		return HtmlUtil.makeSelectInput(ORG_ID_FN, selectedVal, JSUtil.REFRESH_PAGE, options);</span>
	}
	
	/**
	 * Get the list of orgs to appear in the org dropdown selector in the page title area.
	 * @param context
	 * @return - a collection of orgs in the auction. If the user preference for viewing orgs
	 * 		     in hierarchical order is set, then we will also get the ancestor orgs so they appear in a 
	 * 		     hierarchy. 
	 * @throws Exception
	 */
	public static Collection getOrgList(RequestContext context, ShiftBidAuction auction) throws Exception
	{
		// Get user preference whether the org list should be indented or not.
<span class="nc" id="L192">		boolean isOrgListHierarchical = &quot;true&quot;.equals(</span>
<span class="nc" id="L193">				context.getUserProperty(UserPreferenceKeys.USER_SHOW_ORG_LIST_HIERARCHICAL));</span>
		
		//Get Organization ID's linked to the auction's SP
<span class="nc" id="L196">		Collection auctionFilteredOrgIDs = null;</span>
<span class="nc" id="L197">		Collection auctionOrgIDs = BidOptionsFilterUtil.getOrgIDs(context, auction);</span>
<span class="nc bnc" id="L198" title="All 4 branches missed.">		if (LicenseUtil.isAdvancedRMLicense() &amp;&amp; auction.getIsFullPeriodSchedule()) {</span>
<span class="nc" id="L199">			auctionFilteredOrgIDs = BidOptionsFilterUtil.getFilteredOrgIDs(context, auction, auctionOrgIDs);</span>
		} else {
<span class="nc" id="L201">			auctionFilteredOrgIDs = auctionOrgIDs;</span>
		}
<span class="nc" id="L203">		Collection auctionOrgs = OrganizationModelHandler.getOrganizationsByIDs(context, auctionFilteredOrgIDs);</span>
		
<span class="nc bnc" id="L205" title="All 2 branches missed.">		if (isOrgListHierarchical)</span>
		{
<span class="nc" id="L207">			HashSet allOrgs = null;</span>
			// Hierarchical or indented org list
<span class="nc bnc" id="L209" title="All 4 branches missed.">			if (auction.getOrganizationId() == 0 &amp;&amp; auctionFilteredOrgIDs.size() == auctionOrgIDs.size()) {</span>
<span class="nc" id="L210">				Collection parentOrgs = OrganizationModelHandler.getOrganizationsParentsByIDsExceptSystem(context, auctionOrgIDs);</span>
<span class="nc" id="L211">				allOrgs = new HashSet(auctionOrgs.size() + parentOrgs.size());</span>
<span class="nc" id="L212">				allOrgs.addAll(parentOrgs);</span>
<span class="nc" id="L213">			} else {</span>
<span class="nc" id="L214">				allOrgs = new HashSet(auctionOrgs.size());</span>
			}
<span class="nc" id="L216">			allOrgs.addAll(auctionOrgs);</span>
<span class="nc" id="L217">			return allOrgs;</span>
		}					
		else
		{
			// Straight list of organization (not indented) in the auction
<span class="nc" id="L222">			return auctionOrgs;</span>
		}
	}


	/**
	 * Create Bonus UI
	 */
	protected NumberWrapper getBonusUI(String rowID, int bonus, boolean isEditable) {
<span class="nc" id="L231">		String sBonus = &quot;&quot;;</span>

<span class="nc bnc" id="L233" title="All 2 branches missed.">		if (isEditable) {</span>
<span class="nc" id="L234">			String fn = BONUS_PREFIX_FN + rowID;</span>
<span class="nc" id="L235">			m_formInputPC.reset();</span>
<span class="nc" id="L236">			m_formInputPC.setSize(5);</span>
<span class="nc" id="L237">			m_formInputPC.setInputFieldDesc(UIFWebBundleKey.BONUS, UIFWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L238">			m_formInputPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="nc" id="L239">			m_formInputPC.setInputValue( String.valueOf(bonus) );</span>
<span class="nc" id="L240">			m_formInputPC.setLowerLimit(0);</span>
<span class="nc" id="L241">			m_formInputPC.setInputFN(fn);</span>
<span class="nc" id="L242">			m_formInputPC.initForDisplay();</span>
<span class="nc" id="L243">			sBonus = m_formInputPC.getHtmlDisplay();</span>
<span class="nc" id="L244">		} else {</span>
<span class="nc" id="L245">			sBonus = AuctionUtil.columnCellFormatForAlignment(AuctionUtil.COLUMN_CELL_ALIGNMENT, m_localizer.formatNumber(bonus));</span>
		}
<span class="nc" id="L247">		return new NumberWrapper(bonus, sBonus);</span>
	}

	/**
	 * is the edit action enabled?
	 */
	@Override
	protected boolean isEditActionEnabled() {
<span class="nc bnc" id="L255" title="All 2 branches missed.">		if (m_auction == null) {</span>
<span class="nc" id="L256">			return false;</span>
		}
<span class="nc" id="L258">		ID camID = m_auction.getOptMethods().getCampaign().getID();</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">		return !m_listData.isEmpty() &amp;&amp;</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">				m_context.getUser().isAuthorized(PrivilegeKeys.SB_MODIFYAUCTIONS, CampaignScopeManagerProxy.getScopeID(camID));</span>
	}

	/**
	 * Return true to indicate that Page has editable fields
	 */
	protected abstract boolean hasEditableField();
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>