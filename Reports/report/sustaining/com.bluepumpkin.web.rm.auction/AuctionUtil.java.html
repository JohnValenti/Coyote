<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AuctionUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.auction</a> &gt; <span class="el_source">AuctionUtil.java</span></div><h1>AuctionUtil.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.auction;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.CalendarRange;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.DateTimeUtil;
import com.bluepumpkin.ejb.bbm.campaign.CampaignScopeManagerProxy;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.base.RmRuntimeException;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableSchedule;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidder;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.fs.schedule.ScheduleViewUtil;
import com.bluepumpkin.web.fs.shift.ShiftUtil;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.auction.filter.BidOptionsFilterPC;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.bluepumpkin.web.rm.setup.settings.SettingsModelHandler;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.data.wrapper.BasicWrapper;
import com.witness.web.uif.data.wrapper.NumberWrapper;
import com.witness.web.uif.jsp.HtmlElement;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.contenttitle.ContentTitlePC;
import com.witness.web.uif.pagecomponent.dialog.DialogToolbarMenuPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpanePageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlLinkUtil;

/**
 * Title:        AuctionUtil
 * Description:  Common Auction related code
 * Copyright:    Copyright (c) 2003
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, dsu
 * @version      1.0
 *
 * Created on Jun 25, 2003, 3:57:50 PM
 */
<span class="nc" id="L71">public class AuctionUtil {</span>
<span class="nc" id="L72">	private static final Category LOG = Log.initCategory(AuctionUtil.class.getName());</span>
	private static final String CLOSE_AUCTION_MENU = &quot;CLOSE_AUCTION_MENU&quot;;
	public static final int COLUMN_CELL_ALIGNMENT = 6;
	protected final static int SHOW_ALL=0;
	protected final static int SHOW_ALL_EXCEPT_SCORE=1;
	protected final static int SHOW_ONLY_RANK=2;
	/**
	 * Retrieve ShiftBidAuction for the specified auctionID and validate auction
	 */
	public static final ShiftBidAuction getAuctionAndValidate(ID auctionID,
			RequestContext context, AuctionPM model) throws RmHardValidationException, Exception {
<span class="nc" id="L83">		ShiftBidAuction auction = AuctionMH.getAuction(auctionID);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">		ID campID = auction == null ? null : auction.getOptMethods().getCampaignID();</span>
<span class="nc" id="L85">		boolean isAuthToView = context.getUser().</span>
<span class="nc" id="L86">				isAuthorized(PrivilegeKeys.SB_VIEWAUCTIONS_ID, CampaignScopeManagerProxy.getScopeID(campID));</span>
<span class="nc" id="L87">		model.setIsPageEnabled(isAuthToView);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">		if (!isAuthToView) {</span>
<span class="nc" id="L89">			model.addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.UNAUTHORIZED_TO_VIEW_AUCTION, RmWebBundleKey.BUNDLE_NAME);</span>
		}
<span class="nc" id="L91">		return auction;</span>
	}

	public static boolean canModifyAuction(RequestContext context, ID auctionID) {

<span class="nc bnc" id="L96" title="All 4 branches missed.">		if (auctionID == null || context == null) {</span>
<span class="nc" id="L97">			return false;</span>
		}

		try {
<span class="nc" id="L101">			ShiftBidAuction auction = AuctionMH.getAuction(auctionID);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">			ID campID = auction == null ? null : auction.getOptMethods().getCampaignID();</span>
<span class="nc" id="L103">			return context.getUser().isAuthorized(PrivilegeKeys.SB_MODIFYAUCTIONS, CampaignScopeManagerProxy.getScopeID(campID));</span>
		}
<span class="nc" id="L105">		catch (Exception e) {</span>
<span class="nc" id="L106">			throw RmRuntimeException.toRuntimeException(e);</span>
		}
	}

	/**
	 * initialize Content Title
	 */
	public static final void initContentTitle(
			RequestContext context, boolean isPageEnabled, String name, Date deadline,
			ContentTitlePC contentTitle, BidOptionsFilterPC filterPC){

<span class="nc" id="L117">		AuctionUtil.initContentTitle( context,  isPageEnabled,  name,  deadline,</span>
									  contentTitle,  filterPC, &quot;&quot;);
<span class="nc" id="L119">	}</span>

	public static final void initContentTitle(
			RequestContext context, boolean isPageEnabled, String name, Date deadline,
			ContentTitlePC contentTitle, BidOptionsFilterPC filterPC, String bidApprovalOrder) 	{

<span class="nc" id="L125">		Localizer localizer = context.getLocalizer();</span>

<span class="nc" id="L127">		String span = &quot;&lt;/span&gt;&quot;;</span>
<span class="nc bnc" id="L128" title="All 4 branches missed.">		if (bidApprovalOrder != null &amp;&amp; !bidApprovalOrder.isEmpty()) {</span>
<span class="nc" id="L129">			String approvalOrderLabel = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.RM_SA_BID_APPROVAL_ORDER);</span>
<span class="nc" id="L130">			String approvalOrder = &quot;&lt;span class=\&quot;headerText2\&quot; style=\&quot;vertical-align:middle;\&quot;&gt;&quot;</span>
					+ bidApprovalOrder + &quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot; + span;

<span class="nc" id="L133">			contentTitle.addActiveComponent(approvalOrderLabel, approvalOrder, true);</span>
		}

<span class="nc bnc" id="L136" title="All 2 branches missed.">		if (deadline != null) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">			if (filterPC != null) {</span>
<span class="nc" id="L138">				contentTitle.addActiveComponent(filterPC);</span>
			}

<span class="nc" id="L141">			TimeZone tz = context.getViewingTimeZone();</span>
<span class="nc" id="L142">			String deadlineLbl = localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.DEADLINE);</span>
<span class="nc bnc" id="L143" title="All 4 branches missed.">			boolean isAccessibility = filterPC != null &amp;&amp; filterPC.isAccessibilityComplianceMode();</span>
<span class="nc" id="L144">			String deadlineId = UIFWebBundleKey.DEADLINE + &quot;_id&quot;;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">			String idAttrValue = isAccessibility ? &quot; id=\&quot;&quot; + deadlineId + &quot;\&quot;&quot; : &quot;&quot;;</span>
<span class="nc" id="L146">			String sDeadline = &quot;&lt;span class=\&quot;headerText2\&quot; &quot; + idAttrValue + &quot;&gt;&quot;</span>
<span class="nc" id="L147">					+ localizer.formatDateTime(deadline, tz) + span;</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">			if (isAccessibility) {</span>
<span class="nc" id="L149">				String deadlineLblId = UIFWebBundleKey.DEADLINE + &quot;label_id&quot;;</span>
<span class="nc" id="L150">				deadlineLbl = HtmlUtil.makeSpanWithId(deadlineLbl, deadlineLblId);</span>
<span class="nc" id="L151">				HtmlElement deadlineWrapper = HtmlUtil.createLabelWithAriaAttributes(deadlineId + &quot;label&quot;, null, null,</span>
						deadlineLblId + &quot; &quot; + deadlineId);
<span class="nc" id="L153">				deadlineWrapper.setInnerHtml(sDeadline);</span>
<span class="nc" id="L154">				sDeadline = deadlineWrapper.toString();</span>
			}
<span class="nc" id="L156">			contentTitle.addActiveComponent(deadlineLbl, sDeadline, true);</span>
		}
<span class="nc" id="L158">	}</span>

	//////////////////////////////////////////////////////////////////////////////
	// Auction Status Related Code
	//////////////////////////////////////////////////////////////////////////////
	/**
	 * Initialize Close Menu
	 */
	public static void addCloseAuctionMenu(PageModel model, RequestContext context,
			ToolbarPC toolbar, boolean isEditable, ResourceBundle bundle) {
<span class="nc" id="L168">		String titleLbl = model.i18n(bundle, RmWebBundleKey.CLOSE_AUCTION);</span>

<span class="nc" id="L170">		DialogToolbarMenuPC dialogMenuPC = new DialogToolbarMenuPC(context, toolbar);</span>
<span class="nc" id="L171">		dialogMenuPC.setName(CLOSE_AUCTION_MENU);</span>
<span class="nc" id="L172">		model.addChildComponent(dialogMenuPC);</span>

		// Initialize Menu Buttons
<span class="nc" id="L175">		dialogMenuPC.setHeader(titleLbl);</span>
<span class="nc" id="L176">		dialogMenuPC.addSubmitButton(RmPageAction.CLOSE_AUCTION_AND_ASSIGN_BONUS,</span>
<span class="nc" id="L177">				model.i18n(bundle, RmWebBundleKey.CLOSE_AUCTION_WITH_BONUS_ASSIGNED), true);</span>
<span class="nc" id="L178">		dialogMenuPC.addSubmitButton(RmPageAction.CLOSE_AUCTION,</span>
<span class="nc" id="L179">				model.i18n(bundle, RmWebBundleKey.CLOSE_AUCTION_WITHOUT_BONUS_ASSIGNED), true);</span>

		// Add button to associated to Menu
<span class="nc" id="L182">		toolbar.addPopupDialogTextButton(CLOSE_AUCTION_MENU, titleLbl, isEditable);</span>
<span class="nc" id="L183">	}</span>

	/**
	 * Add button is toggle Opening / Closing Auction
	 */
	public static void addOpenOrCloseAuctionBtn(PageModel model, RequestContext context,
			ToolbarPC toolbar, boolean isEditable, boolean isAuctionOpen,
			ResourceBundle bundle) {
<span class="nc bnc" id="L191" title="All 2 branches missed.">		if (isAuctionOpen) {</span>
<span class="nc" id="L192">			AuctionUtil.addCloseAuctionMenu(model, context, toolbar, isEditable, bundle);</span>
		} else {
<span class="nc" id="L194">			String lbl = model.i18n(bundle, RmWebBundleKey.OPEN_AUCTION);</span>
<span class="nc" id="L195">			toolbar.addSubmitTextButton(RmPageAction.OPEN_AUCTION, lbl, isEditable);</span>
		}
<span class="nc" id="L197">		toolbar.addDivider();</span>
<span class="nc" id="L198">	}</span>

	/**
	 * Process Auction Status Change
	 */
	public static void processAuctionStatus(RequestContext context,
			WorkpanePageModel model, boolean isOpenAuction, boolean isAddNoneApprBonus) {
<span class="nc" id="L205">		model.extractParameters(context.getRequest());</span>
<span class="nc" id="L206">		ID auctionID = model.getSelectedIDObject();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">		if (auctionID != null) {</span>
			try {
<span class="nc bnc" id="L209" title="All 2 branches missed.">				if (isOpenAuction) {</span>
<span class="nc" id="L210">					AuctionMH.openAuction(auctionID);</span>
				} else {
<span class="nc" id="L212">					AuctionMH.closeAuction(auctionID, isAddNoneApprBonus);</span>
				}
<span class="nc" id="L214">			} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L215">				Message msg = new Message(Message.ERROR_TYPE,</span>
						RmWebBundleKey.UNABLE_TO_CHANGE_AUCTION_STATUS,
						RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L218">				msg.setAssociatedMessage(ex.getLocalizedMessage(context.getLocalizer(), context.getViewingTimeZone()));</span>
<span class="nc" id="L219">				context.addPageMessage(msg);</span>
<span class="nc" id="L220">				LOG.l7dDebug(RmWebLogBundleKey.UNABLE_TO_CHANGE_AUCTION_STATUS, ex);</span>
<span class="nc" id="L221">			} catch (Exception ex) {</span>
<span class="nc" id="L222">				Message msg = new Message(Message.ERROR_TYPE,</span>
						RmWebBundleKey.UNABLE_TO_CHANGE_AUCTION_STATUS,
						RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L225">				context.addPageMessage(msg);</span>
<span class="nc" id="L226">				LOG.l7dError(RmWebLogBundleKey.UNABLE_TO_CHANGE_AUCTION_STATUS, ex);</span>
<span class="nc" id="L227">			}</span>
		}

<span class="nc" id="L230">		context.setPageModel(model);</span>
<span class="nc" id="L231">	}</span>

	//////////////////////////////////////////////////////////////////////////////
	// Schedule, Shift Related Code
	//////////////////////////////////////////////////////////////////////////////
	public static final CalendarRange getCalendarRange(SchedulingPeriod schedPeriod, TimeZone tz, Locale locale) {
<span class="nc" id="L237">		Date sDate = schedPeriod.getStartTime();</span>
<span class="nc" id="L238">		Date eDate = schedPeriod.getEndTime();</span>

<span class="nc" id="L240">		CalendarRange calRange = new CalendarRange(sDate, eDate, tz, locale);</span>
<span class="nc" id="L241">		return calRange;</span>
	}

	public static List&lt;ShiftAssignment&gt; findShifts(CalendarRange dayRange, Collection&lt;ShiftAssignment&gt; shifts) {
<span class="nc" id="L245">		List&lt;ShiftAssignment&gt; results = new ArrayList&lt;ShiftAssignment&gt;(2);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">		for (ShiftAssignment sa : shifts) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">			if (dayRange.includes(ScheduleViewUtil.getDisplayStartTime(sa))) {</span>
<span class="nc" id="L248">				results.add(sa);</span>
			}
<span class="nc" id="L250">		}</span>
<span class="nc" id="L251">		return results;</span>
	}

	/**
	 * Add Day Range to Table Header
	 * @param useMultiSortCols true means a popup will give user ability to sort by &quot;Start&quot;,
	 *        &quot;End&quot;, or &quot;Length&quot; for each shift date column.
	 */
	public static final void addShiftDatesToHeader(SchedulingPeriod schedPeriod,
			Localizer localizer, TimeZone campaignTz, TableHeaderPC header, boolean useMultiSortCols) {
<span class="nc bnc" id="L261" title="All 2 branches missed.">		if (schedPeriod == null) {</span>
<span class="nc" id="L262">			return;</span>
		}

<span class="nc" id="L265">		Locale locale = localizer.getLocaleContext().getRegionalFormatLocale();</span>
<span class="nc" id="L266">		CalendarRange cRange = getCalendarRange(schedPeriod, campaignTz, locale);</span>
<span class="nc" id="L267">		Calendar startCal = cRange.getStartCalendar();</span>
<span class="nc" id="L268">		Calendar endCal = cRange.getEndCalendar();</span>

		//int [] sortName = getSortDayColNames(getNumWeeks(schedPeriod, localizer, tz));
<span class="nc" id="L271">		int i = 0;</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">		while (endCal.after(startCal)) {</span>
<span class="nc" id="L273">			int w = i / 7; //the current week offset</span>

<span class="nc" id="L275">			Date date = startCal.getTime();</span>
<span class="nc" id="L276">			int curDayOfWeek = startCal.get(Calendar.DAY_OF_WEEK);</span>
<span class="nc" id="L277">        	String dayDisplay = localizer.formatDate(date, campaignTz,</span>
					RegionalFormatBundleKey.DATE_NOYEAR_DAYINWEEKFULL_FORMAT);

<span class="nc bnc" id="L280" title="All 2 branches missed.">			String onClickJS = useMultiSortCols ? &quot;pageMediator.popupDialog(''SORT_DIALOG_PC'', true);&quot; : &quot;&quot;;</span>

			//header.addColumnHeaderData(String.valueOf(sortName[curDayOfWeek-1]), dayDisplay, true).setOnClickJS(onClickJS);

<span class="nc" id="L284">			int curSortCol = BiddableSchedule.getDayColumnIndex(w, curDayOfWeek, BiddableSchedule.SORTBY_STARTTIME);</span>
<span class="nc" id="L285">			header.addColumnHeaderData(String.valueOf(curSortCol), (dayDisplay), true).setOnClickJS(onClickJS);</span>

<span class="nc" id="L287">			startCal.add(Calendar.DATE, 1);</span>
<span class="nc" id="L288">			i++;</span>
<span class="nc" id="L289">		}</span>
<span class="nc" id="L290">	}</span>

	/**
	 * 508: Wrap a String in an anchor tag that links to nothing (#).
	 */
	public static String anchor(String innerHTML) {
<span class="nc" id="L296">		return &quot;&lt;a href=\&quot;#\&quot;&gt;&quot; + innerHTML + &quot;&lt;/a&gt;&quot;;</span>
	}

	/**
	 * Get the number of weeks in an SP.
	 * @param schedPeriod The SP.
	 * @return the number of weeks in the SP. If it's a single-week SP, the result is simply 1.
	 */
	public static int getNumWeeks(SchedulingPeriod schedPeriod, Localizer localizer, TimeZone tz) {
<span class="nc" id="L305">		int numWeeks = 1;</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">		if (schedPeriod != null) {</span>
<span class="nc" id="L307">			Locale locale = localizer.getLocaleContext().getRegionalFormatLocale();</span>
<span class="nc" id="L308">			CalendarRange cRange = getCalendarRange(schedPeriod, tz, locale);</span>
<span class="nc" id="L309">			Calendar startCal = cRange.getStartCalendar();</span>
<span class="nc" id="L310">			Calendar endCal = cRange.getEndCalendar();</span>
<span class="nc" id="L311">			int numDays = 0;</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">			while (endCal.after(startCal)) {</span>
<span class="nc" id="L313">				startCal.add(Calendar.DATE, 1);</span>
<span class="nc" id="L314">				numDays++;</span>
			}
<span class="nc" id="L316">			numWeeks = numDays / 7;</span>
		}
<span class="nc" id="L318">		return numWeeks;</span>
	}



	/**
	 * Add Shifts Data to Node
	 */
    public static void addShiftsData(SchedulingPeriod schedPeriod,
			Collection&lt;ShiftAssignment&gt; shifts, Localizer localizer, TimeZone tz, TimeZone campaignTz, DefaultMultiColumnNodeData node) {

<span class="nc" id="L329">		Locale locale = localizer.getLocaleContext().getRegionalFormatLocale();</span>
<span class="nc" id="L330">		CalendarRange cRange = getCalendarRange(schedPeriod, campaignTz, locale);</span>
<span class="nc" id="L331">		Calendar startCal = cRange.getStartCalendar();</span>
<span class="nc" id="L332">		Calendar endCal = cRange.getEndCalendar();</span>

<span class="nc" id="L334">		String alt = localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.VIEW_DETAILS);</span>

<span class="nc bnc" id="L336" title="All 2 branches missed.">		while (endCal.after(startCal)) {</span>
<span class="nc" id="L337">			CalendarRange dayRange = DateTimeUtil.makeDayRange(startCal.getTime(), campaignTz);</span>
<span class="nc" id="L338">			Collection&lt;ShiftAssignment&gt; selectedShiftList = findShifts(dayRange, shifts);</span>

<span class="nc bnc" id="L340" title="All 2 branches missed.">			if (selectedShiftList.isEmpty()) {</span>
<span class="nc" id="L341">				node.add(&quot;-&quot;);</span>
			} else {
<span class="nc" id="L343">				Date comparable = null;</span>
<span class="nc" id="L344">				StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">				for (Iterator&lt;ShiftAssignment&gt; it = selectedShiftList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L346">					ShiftAssignment sa = it.next();</span>

<span class="nc" id="L348">					Date startDate = ScheduleViewUtil.getDisplayStartTime(sa);</span>
<span class="nc" id="L349">					Date endDate = sa.getEndTime();</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">					if (comparable == null) {</span>
<span class="nc" id="L351">						comparable = startDate;</span>
					}
<span class="nc" id="L353">					String dayDisplay = localizer.formatDate(startCal.getTime(), campaignTz,</span>
						RegionalFormatBundleKey.DATE_NOYEAR_DAYINWEEKFULL_FORMAT);
<span class="nc" id="L355">					String shiftDisp = ShiftUtil.makeShiftDatesString(dayRange, startDate, endDate, localizer, tz);</span>
<span class="nc" id="L356">					String onClickJS = &quot;pageMediator.popupShiftDetails( new Array('&quot; + sa.getID() + &quot;') );&quot;;</span>
<span class="nc" id="L357">					String display = HtmlLinkUtil.createActiveLink(&quot;javascript:void(0);&quot;, shiftDisp, alt, &quot;&quot;, &quot;&quot;, </span>
						onClickJS, false, dayDisplay  + ' ' + shiftDisp);

<span class="nc" id="L360">					sb.append(display);</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">					if (it.hasNext()) {</span>
<span class="nc" id="L362">						sb.append(&quot;&lt;br&gt;&quot;);</span>
					}
<span class="nc" id="L364">				}</span>

<span class="nc" id="L366">				BasicWrapper data = new BasicWrapper(comparable, sb.toString());</span>
<span class="nc" id="L367">				node.add(data, CSSUtil.STYLE_NOWRAP);</span>
			}

<span class="nc" id="L370">			startCal.add(Calendar.DATE, 1);</span>
<span class="nc" id="L371">		}</span>
<span class="nc" id="L372">	}</span>

    public static List createShiftsNodeDataList(SchedulingPeriod schedPeriod,
			Collection shifts, Map actMap, Localizer localizer, TimeZone tz, TimeZone campaignTz) {
<span class="nc" id="L376">		ArrayList result = new ArrayList(7);</span>

<span class="nc" id="L378">		Locale locale = localizer.getLocaleContext().getRegionalFormatLocale();</span>
<span class="nc" id="L379">		CalendarRange cRange = getCalendarRange(schedPeriod, tz, locale);</span>
<span class="nc" id="L380">		Calendar startCal = cRange.getStartCalendar();</span>
<span class="nc" id="L381">		Calendar endCal = cRange.getEndCalendar();</span>

<span class="nc" id="L383">		String dayPatterm = RegionalFormatBundleKey.DATE_NOYEAR_DAYINWEEKFULL_FORMAT;</span>

<span class="nc bnc" id="L385" title="All 2 branches missed.">		while (endCal.after(startCal)) {</span>
<span class="nc" id="L386">			DefaultMultiColumnNodeData node = new DefaultMultiColumnNodeData();</span>

<span class="nc" id="L388">			Date currentDate = startCal.getTime();</span>
<span class="nc" id="L389">			String currentDayDisp = localizer.formatDate(currentDate, campaignTz, dayPatterm);</span>
<span class="nc" id="L390">			node.add(currentDayDisp);</span>

<span class="nc" id="L392">			CalendarRange dayRange = DateTimeUtil.makeDayRange(currentDate, campaignTz);</span>
<span class="nc" id="L393">			List&lt;ShiftAssignment&gt; selectedShiftList = new ArrayList&lt;ShiftAssignment&gt;(findShifts(dayRange, shifts));</span>
<span class="nc" id="L394">			Collections.sort(selectedShiftList, new Comparator&lt;ShiftAssignment&gt;() {</span>

				@Override
				public int compare(ShiftAssignment o1, ShiftAssignment o2) {
<span class="nc" id="L398">					return o1.getStartTime().compareTo(o2.getStartTime());</span>
				}
			});

<span class="nc bnc" id="L402" title="All 2 branches missed.">			if (selectedShiftList.isEmpty()) {</span>
<span class="nc" id="L403">				node.add(&quot;-&quot;);</span>
			} else {
<span class="nc" id="L405">				StringBuffer sb = new StringBuffer(100);</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">				for (ShiftAssignment sa : selectedShiftList) {</span>

<span class="nc" id="L408">					Date startDate = ScheduleViewUtil.getDisplayStartTime(sa);</span>
<span class="nc" id="L409">					Date endDate = sa.getEndTime();</span>
<span class="nc" id="L410">					String saDisp = ShiftUtil.makeShiftDatesString(dayRange, startDate, endDate, localizer, tz);</span>

<span class="nc" id="L412">					CalendarRange shiftCR = DateTimeUtil.makeDayRange(sa.getStartTime(), tz);</span>
<span class="nc" id="L413">					List eventList = new ArrayList(sa.getChildren());</span>
<span class="nc" id="L414">					String activities = ShiftUtil.makeActivitiesString(shiftCR, eventList,</span>
							false, false, true, actMap, localizer, tz);

<span class="nc" id="L417">					sb.append(saDisp).append(HtmlUtil.NEW_LINE).append(activities);</span>
<span class="nc" id="L418">				}</span>
<span class="nc" id="L419">				node.add(sb);</span>
			}
<span class="nc" id="L421">			node.setSelectable(false);</span>
<span class="nc" id="L422">			result.add(node);</span>

<span class="nc" id="L424">			startCal.add(Calendar.DATE, 1);</span>
<span class="nc" id="L425">		}</span>

<span class="nc" id="L427">		return result;</span>
	}

	/**
	 * Computes the total length of the given shift assignments taking into account
	 * paid/unpaid shift event assignments associated with the shift assignments.
	 */
	public static String getScheduleHourDisplay(Collection shifts, Localizer localizer) {
<span class="nc" id="L435">		int len = RequestUtil.computeScheduleLength(shifts);</span>
<span class="nc" id="L436">		return localizer.formatDurationInMins(len);</span>
	}

	/**
	 * Computes the total length of the given shift assignments taking into account
	 * paid/unpaid shift event assignments associated with the shift assignments.
	 *
	 * This is used for List Screen to support sorting
	 */
	public static NumberWrapper getScheduleHourWrapper(Collection&lt;ShiftAssignment&gt; shifts, Localizer localizer) {
<span class="nc" id="L446">		int len = RequestUtil.computeScheduleLength(shifts);</span>
<span class="nc" id="L447">		return new NumberWrapper(len, localizer.formatDurationInMins(len));</span>
	}




	/**
	 * Determine if a Scheduling Period, is a single-week SP.
	 * weeks in the SP.
	 * @param sp The Scheduling Period.
	 * @param campTZ The Campaign's TimeZone.
	 * @return True if the Scheduling Period, is a single-week SP, false if it's a multi-week SP.
	 */
	public static boolean isSingleWeekSP(SchedulingPeriod sp, TimeZone campTZ) {
<span class="nc" id="L461">		boolean isSingleWeek = true;</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">		if (sp != null) {</span>
<span class="nc" id="L463">			Date startDate = sp.getStartTime();</span>
<span class="nc" id="L464">			Date endDate = sp.getEndTime();</span>

			//must use campaign TimeZone to determine the exact length of an SP week
<span class="nc" id="L467">			Calendar cal = Calendar.getInstance(campTZ);</span>
<span class="nc" id="L468">			cal.setTime(startDate);</span>
<span class="nc" id="L469">			cal.add(Calendar.DATE, 7);</span>

<span class="nc bnc" id="L471" title="All 2 branches missed.">			if (endDate.after(cal.getTime())) {</span>
<span class="nc" id="L472">				isSingleWeek = false;</span>
			}
		}
<span class="nc" id="L475">		return isSingleWeek;</span>
	}

	/**
	 * Given a Scheduling Period, return an array of TimeRange's representing the
	 * weeks in the SP.
	 * @param sp The Scheduling Period.
	 * @param campTZ The Campaign's TimeZone.
	 * @return An array of TimeRange's representing the weeks in the SP.
	 */
	public static TimeRange[] getWeekRanges(SchedulingPeriod sp, TimeZone campTZ) {
<span class="nc" id="L486">		TimeRange[] weekRanges = null;</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">		if (sp != null) {</span>
<span class="nc" id="L488">			Date SPStartDate = sp.getStartTime();</span>
<span class="nc" id="L489">			Date SPEndDate = sp.getEndTime();</span>
<span class="nc" id="L490">			ArrayList aWeekRanges = new ArrayList();</span>

<span class="nc bnc" id="L492" title="All 2 branches missed.">			if (isSingleWeekSP(sp, campTZ)) {</span>
<span class="nc" id="L493">				weekRanges = new TimeRange[] { new TimeRange(SPStartDate, SPEndDate) };</span>
			} else {
				//Must use campaign TZ to determine SP weeks. The week ranges are not affected
				//by the user preference TimeZone.
<span class="nc" id="L497">				Calendar cal = Calendar.getInstance(campTZ);</span>
<span class="nc" id="L498">				Date curStartDate = SPStartDate;</span>
<span class="nc" id="L499">				Date nextStartDate = SPStartDate;</span>

				do {
<span class="nc" id="L502">					curStartDate = nextStartDate;</span>
<span class="nc" id="L503">					cal.setTime(curStartDate);</span>
<span class="nc" id="L504">					cal.add(Calendar.DATE, 7);</span>
<span class="nc" id="L505">					nextStartDate = cal.getTime();</span>
<span class="nc" id="L506">					cal.add(Calendar.SECOND, -1);</span>
<span class="nc" id="L507">					Date curEndDate = cal.getTime();</span>
<span class="nc" id="L508">					aWeekRanges.add(new TimeRange(curStartDate, curEndDate));</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">				} while (nextStartDate.before(SPEndDate));</span>

				//now convert our ArrayList into an array
<span class="nc bnc" id="L512" title="All 2 branches missed.">				if (aWeekRanges != null) {</span>
<span class="nc" id="L513">					int numWeeks = aWeekRanges.size();</span>
<span class="nc" id="L514">					weekRanges = new TimeRange[numWeeks];</span>
<span class="nc" id="L515">					int w = 0;</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">					for (Iterator it = aWeekRanges.iterator(); it.hasNext();) {</span>
<span class="nc" id="L517">						TimeRange curWeek = (TimeRange) it.next();</span>
<span class="nc" id="L518">						weekRanges[w++] = curWeek;</span>
<span class="nc" id="L519">					}</span>
				}
			}
		}
<span class="nc" id="L523">		return weekRanges;</span>
	}

	protected static Collection&lt;StringsPair&gt; getDisplayOptions(int showOption, RequestContext context) {
<span class="nc" id="L527">		Collection&lt;StringsPair&gt; options = new ArrayList&lt;StringsPair&gt;();</span>
<span class="nc" id="L528">		Localizer localizer = context.getLocalizer();</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">		if (showOption == SHOW_ONLY_RANK) {</span>
<span class="nc" id="L530">			options.add(new StringsPair(Integer.toString(ShiftBidder.RANKBY_EMPLOYEERANK), localizer.i18n(</span>
<span class="nc" id="L531">					localizer.getBundle(UIFWebBundleKey.BUNDLE_NAME), UIFWebBundleKey.RANK)));</span>
		} else {
<span class="nc" id="L533">			options.add(new StringsPair(Integer.toString(ShiftBidder.RANKBY_SENIORITY), localizer.i18n(</span>
<span class="nc" id="L534">					localizer.getBundle(UIFWebBundleKey.BUNDLE_NAME), UIFWebBundleKey.SENIORITY)));</span>
<span class="nc" id="L535">			options.add(new StringsPair(Integer.toString(ShiftBidder.RANKBY_EMPLOYEERANK), localizer.i18n(</span>
<span class="nc" id="L536">					localizer.getBundle(UIFWebBundleKey.BUNDLE_NAME), UIFWebBundleKey.RANK)));</span>
<span class="nc" id="L537">			options.add(new StringsPair(Integer.toString(ShiftBidder.RANKBY_ACCUMULATEDBONUS), localizer.i18n(</span>
<span class="nc" id="L538">					localizer.getBundle(UIFWebBundleKey.BUNDLE_NAME), UIFWebBundleKey.POINTS)));</span>
<span class="nc" id="L539">			options.add(new StringsPair(Integer.toString(ShiftBidder.RANKBY_SHIFTBIDDER_BONUS), localizer.i18n(</span>
<span class="nc" id="L540">					localizer.getBundle(UIFWebBundleKey.BUNDLE_NAME), UIFWebBundleKey.BONUS)));</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">			if (showOption == SHOW_ALL) {</span>
<span class="nc" id="L542">				options.add(new StringsPair(Integer.toString(ShiftBidder.RANKBY_SCORE), localizer.i18n(</span>
<span class="nc" id="L543">						localizer.getBundle(UIFWebBundleKey.BUNDLE_NAME), UIFWebBundleKey.SCORE)));</span>
			}
		}
<span class="nc" id="L546">		return options;</span>
	}

	/**
	 * Retrieves the Organization Settings for every Organization in the list and saves the
	 * Display Description setting in the Map.
	 *
	 * @param spOrgList Collection that contains Organization IDs
	 * @return A HashMap of Organization Display Description settings keyed by Organization ID
	 * @throws Exception Thrown to the calling method
	 */
	public static Map&lt;ID, Boolean&gt; setOrgDisplayDecription(Collection&lt;ID&gt; spOrgList) throws Exception {
<span class="nc" id="L558">		HashMap&lt;ID, Boolean&gt; orgDescSettings = new HashMap();</span>

<span class="nc bnc" id="L560" title="All 2 branches missed.">		for (ID orgID : spOrgList) {</span>
<span class="nc" id="L561">			OrganizationSetting orgSettings = SettingsModelHandler.getSettings(orgID);</span>
<span class="nc" id="L562">			orgDescSettings.put(orgID, Boolean.valueOf(orgSettings.getDisplayBidTemplateDes()));</span>
<span class="nc" id="L563">		}</span>

<span class="nc" id="L565">		return orgDescSettings;</span>
	}

	/**
	 * Returns whether or not an Organizations Display Description setting is checked.
	 *
	 * @param spOrgList Collection of Organization IDs.
	 * @param usersScopeOrgIDs Collection of Organization IDs the user has scope.
	 * @param orgDescSettings Map of Organization Display Description settings
	 * @return True if the Organization Setting Display Description is checked, false otherwise.
	 */
	public static boolean getDisplayDescriptionColumn(Collection&lt;ID&gt; spOrgList, Collection&lt;ID&gt; usersScopeOrgIDs,
			Map&lt;ID, Boolean&gt; orgDescSettings) {
		Boolean displayDecription;

<span class="nc bnc" id="L580" title="All 2 branches missed.">		for (ID orgID : spOrgList) {</span>
<span class="nc" id="L581">			displayDecription = orgDescSettings.get(orgID);</span>
<span class="nc bnc" id="L582" title="All 6 branches missed.">			if (displayDecription != null &amp;&amp; displayDecription.booleanValue() &amp;&amp; usersScopeOrgIDs.contains(orgID)) {</span>
<span class="nc" id="L583">				return true;</span>
			}
<span class="nc" id="L585">		}</span>

<span class="nc" id="L587">		return false;</span>
	}

	/**
	 * Format the string to align it with controls place in the table.  It adds more
	 * left padding to align the data with the data in the control.
	 *
	 * @param value Value for the table cell
	 * @return A span HTML tag with the proper padding to align the text with other controls.
	 */
	public static String columnCellFormatForAlignment(int numberOfPixels, String value) {
<span class="nc" id="L598">		return &quot;&lt;span style=\&quot;padding-left:&quot; + numberOfPixels + &quot;px;\&quot;&gt;&quot; + value + &quot;&lt;/span&gt;&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>