<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueAttributeDefinitionListPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute</a> &gt; <span class="el_source">QueueAttributeDefinitionListPageModel.java</span></div><h1>QueueAttributeDefinitionListPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.workload.model.queueattribute.QueueAttributeDefintion;
import com.bluepumpkin.ejb.bbm.workload.model.queueattribute.QueueAttributeType;
import com.bluepumpkin.ejb.bbm.workresource.OrganizationScopeManagerProxy;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrgWorkpaneListPageModel;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationUtil;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.config.Screen;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;


/**
 * Title:
 * Description:
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author		Sankar Nair
 * @version 1.0
 */
public class QueueAttributeDefinitionListPageModel extends OrgWorkpaneListPageModel {
<span class="fc" id="L47">	private static final Category log = Log.initCategory(QueueAttributeDefinitionListPageModel.class.getName());</span>
	
	//UDF path
	private static final String UDF_PATH = &quot;udf_def&quot;;
	private static final String UDF_SCREEN_NAME = &quot;UDF_DEF_LIST&quot;;
	
	
	private static final String LIST_NAME_SORT = &quot;LIST_NAME_SORT&quot;;
	private static final String LIST_DESCRIPTION_SORT = &quot;LIST_DESCRIPTION_SORT&quot;;
	private static final String LIST_MEDIA_TITLE_SORT = &quot;LIST_MEDIA_TITLE_SORT&quot;;
	private static final String LIST_TYPE_TITLE_SORT = &quot;LIST_TYPE_TITLE_SORT&quot;;
	private static final String LIST_MAPPING_TITLE_SORT = &quot;LIST_MAPPING_TITLE_SORT&quot;;
	private static final String LIST_ORGANIZATION_SORT = &quot;LIST_ORGANIZATION_SORT&quot;;
	public static final String CAN_CONFIGURE = &quot;CAN_CONFIGURE&quot;;
	
<span class="nc" id="L62">	private boolean m_bIsScoped = true; // assume scoped</span>
<span class="nc" id="L63">	private boolean m_bIsInUDFMode = false; </span>
	private Collection m_queueAttributeDefinition;
	
<span class="nc" id="L66">	private Map m_typeNameMap = Collections.EMPTY_MAP;</span>
	
<span class="nc" id="L68">	ID m_selectedOrgID = null;</span>
	

	/**
	 * Constructor
	 */
	public QueueAttributeDefinitionListPageModel(RequestContext context) {
<span class="nc" id="L75">		super(context);</span>
		// mtz QC61346
		//m_selectedOrgID = new ID(OrganizationUtil.getSelectedOrganizationID(m_context));
		
<span class="nc" id="L79">		m_selectedOrgID = getSelectedIDObject();</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">		if (m_selectedOrgID == null){</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">			if (OrganizationUtil.getSelectedOrganizationID(m_context) != null)</span>
<span class="nc" id="L82">				m_selectedOrgID = new ID(OrganizationUtil.getSelectedOrganizationID(m_context));</span>
			else 
<span class="nc" id="L84">				m_selectedOrgID = new ID(-3002);</span>
		} 
		
<span class="nc" id="L87">		setSelectedID(m_selectedOrgID.toString());</span>
<span class="nc" id="L88">		setName(&quot;queueAttributeDefList&quot;);</span>
		
		//m_amBundle = m_localizer.getBundle(AmWebBundleKey.BUNDLE_NAME);
		
		
		//setJSMediator(BbmJavaScriptFileID.MEDIATOR_ORG_QUEUE_LIST_WORKPANE);
		//addJSVariableAsString(CAN_CONFIGURE, String.valueOf(isAuthorizedToConfigure()));
<span class="nc" id="L95">		m_bIsInUDFMode = isInUDFMode();</span>
<span class="nc" id="L96">	}</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) {
<span class="nc" id="L102">		return getInstance(context, QueueAttributeDefinitionListPageModel.class);</span>
	}
	
	/**
	 * Loads all the Job Title value objects for the selected Organization ID
	 *
	 * @return true if load was successful
	 */
	private boolean loadQueueAttributeDefinition() {
		
		try {
		
			
			// determine if current user has admin privilege
			//TODO
<span class="nc bnc" id="L117" title="All 2 branches missed.">			if (m_context.getUser().isAuthorized(PrivilegeKeys.CORE_VIEWORGANIZATION, new ScopeID(m_selectedOrgID, Scope.ORG_SCOPE))) {</span>
				//***** Data of UDF mode *******//
<span class="nc bnc" id="L119" title="All 2 branches missed.">				if(m_bIsInUDFMode){</span>
<span class="nc" id="L120">					m_queueAttributeDefinition = new QueueAttributeDefinitionModelHandler().getQueueAttributeDefinitions(m_context, m_selectedOrgID, QueueAttributeDefintion.EMP_USER_DEFFINED_FIELD_MODULE);</span>
<span class="nc" id="L121">					return true;</span>
				}
				//***** Data of Queue Attribute (default) mode *******//
<span class="nc" id="L124">				m_queueAttributeDefinition = new QueueAttributeDefinitionModelHandler().getQueueAttributeDefinitions(m_context, m_selectedOrgID);</span>
<span class="nc" id="L125">				return true;</span>
			} else {
<span class="nc" id="L127">				addPageMessage(Message.INFO_TYPE, getNotAuthorizedToViewMsg());</span>
<span class="nc" id="L128">				m_bIsScoped = false;</span>
<span class="nc" id="L129">				return false;</span>
			}
<span class="nc" id="L131">		} catch (Exception ex) {</span>
<span class="nc" id="L132">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L133">			return false;</span>
		}
	}

	

	/**
	 * Initialize List
	 */
	protected void initList() {
<span class="nc" id="L143">		super.initList();</span>
		
		// Setup Headers
<span class="nc" id="L146">		TableHeaderPC header = m_list.getHeader();</span>
<span class="nc" id="L147">		header.setSortable(true);</span>
		
		
<span class="nc" id="L150">		header.addColumnHeaderData(LIST_NAME_SORT, i18n(m_common_bundle, UIFWebBundleKey.LIST_HEADER_NAME), true);</span>
<span class="nc" id="L151">		header.addColumnHeaderData(LIST_DESCRIPTION_SORT, i18n(m_common_bundle, UIFWebBundleKey.LIST_HEADER_DESCRIPTION), false);</span>
<span class="nc" id="L152">		header.addColumnHeaderData(LIST_ORGANIZATION_SORT,	i18n(m_bbmBundle, BbmWebBundleKey.CAMPAIGN_ORG_PAGE_TITLE), true);</span>
		//header.addColumnHeaderData(LIST_MEDIA_TITLE_SORT,	i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_LABEL_MEDIA), true);
<span class="nc" id="L154">		header.addColumnHeaderData(LIST_TYPE_TITLE_SORT,	i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_LABEL_TYPE), true);</span>
		//header.addColumnHeaderData(LIST_MAPPING_TITLE_SORT, i18n(m_bbmBundle, BbmWebBundleKey.BBM_ORG_WORKLOADS_GROUPS_MAPPING),false);

		// Setup basic table property
<span class="nc" id="L158">		m_list.setIsAutoSortEnabled(true);</span>
<span class="nc" id="L159">		m_list.setMultiRowSelectable(false);</span>
<span class="nc" id="L160">		header.setDefaultSortColumn(getDefaultSortColumn());</span>
<span class="nc" id="L161">	}</span>

	@Override
	public void setSortColumn(String column) {
<span class="nc bnc" id="L165" title="All 2 branches missed.">	    if (column.matches(&quot;^\\w+$&quot;)) {</span>
<span class="nc" id="L166">	        super.setSortColumn(column);</span>
	    }
<span class="nc" id="L168">	}</span>

	@Override
	protected String getDefaultSortColumn() {
<span class="nc" id="L172">		return LIST_NAME_SORT;</span>
	}

	/**
	 * Create the list model
	 */
	protected void createListModel() {
		
<span class="nc bnc" id="L180" title="All 2 branches missed.">		if (!loadQueueAttributeDefinition()) return;</span>
		
		try {
		
//		String selected = (String)m_context.getAttribute(RequestContext.SESSION_SCOPE, &quot;CACHED_QUEUE_ID&quot;);
	//	this.setPerformActionOnID(selected);
		
<span class="nc bnc" id="L187" title="All 4 branches missed.">		boolean isAuth = m_bIsScoped &amp;&amp; isAuthorizedToConfigure();</span>
<span class="nc" id="L188">		ArrayList listModel = new ArrayList();</span>
<span class="nc" id="L189">		boolean specialUDFsDisplayed = false;</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">		for(Iterator it = m_queueAttributeDefinition.iterator(); it.hasNext();) {</span>
<span class="nc" id="L191">			QueueAttributeDefintion queue = (QueueAttributeDefintion)it.next();</span>
<span class="nc" id="L192">			String dispName = queue.getName();</span>
<span class="nc bnc" id="L193" title="All 4 branches missed.">			if(m_bIsInUDFMode &amp;&amp; QueueAttributeDefinitionModelHandler.SPECIAL_UDF_IDS.contains(queue.getID().toInt())){</span>
<span class="nc" id="L194">				dispName = dispName + &quot;*&quot;;</span>
<span class="nc" id="L195">				specialUDFsDisplayed = true;</span>
			}

			// Create the row data
<span class="nc" id="L199">			String rowID = queue.getID().toString();</span>
<span class="nc" id="L200">			DefaultMultiColumnNodeData row_data =  new DefaultMultiColumnNodeData(rowID);</span>
			
			
<span class="nc" id="L203">			row_data.add(dispName );</span>
<span class="nc" id="L204">			row_data.add( queue.getDescription() );</span>
<span class="nc" id="L205">			row_data.add( queue.getOrganizationName() );</span>
<span class="nc" id="L206">			row_data.add(getTypeMappingStr(queue.getType()));</span>
			//row_data.add( getQueueTypeName(queue.getQueueType()) );
			//row_data.add( getMappingsStr(queue.getID()) );

			// Set if the row should be editable or not. Row should be editable if the
			// selected org is the owner of the activity
			
<span class="nc" id="L213">			HashMap rowAttributes = row_data.getNodeAttributes();</span>
<span class="nc bnc" id="L214" title="All 4 branches missed.">			if ( isAuth &amp;&amp; m_selectedOrgID.equals(queue.getOrganizationID() ) ){</span>
<span class="nc" id="L215">				rowAttributes.put(IS_EDITABLE,	&quot;true&quot;);</span>
<span class="nc" id="L216">				rowAttributes.put(IS_DELETEABLE, &quot;true&quot;);</span>
<span class="nc" id="L217">				rowAttributes.put(IS_COPYABLE,   &quot;true&quot;);</span>
			} else {
<span class="nc" id="L219">				rowAttributes.put(IS_EDITABLE,	&quot;false&quot;);</span>
<span class="nc" id="L220">				rowAttributes.put(IS_DELETEABLE, &quot;false&quot;);</span>
<span class="nc" id="L221">				rowAttributes.put(IS_COPYABLE,   &quot;false&quot;);</span>
			}
<span class="nc" id="L223">			rowAttributes.put(COPY_ITEM_NAME, queue.getName());</span>

			// Add row data to list model
<span class="nc" id="L226">			listModel.add(row_data);</span>

			// Check if row should be selected, assuming only one should be selected
<span class="nc bnc" id="L229" title="All 2 branches missed.">			if (OrganizationModelHandler.UNREASONABLE_ORG_ID.equals(m_selectedRowOrgID)) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">				if(this.isRowSelected(queue.getID())) {</span>
<span class="nc" id="L231">					m_list.addSelectedRowID(rowID);</span>
<span class="nc" id="L232">					m_selectedRowOrgID = queue.getOrganizationID();</span>
				}
			}
<span class="nc" id="L235">		} //end for</span>
		
<span class="nc bnc" id="L237" title="All 2 branches missed.">		if(specialUDFsDisplayed){</span>
			// Add a message to explain the asterisk (*)
<span class="nc" id="L239">			addPageMessage(Message.INFO_TYPE, &quot;* = &quot;+i18n(m_bbmBundle, BbmWebBundleKey.UDF_SPECIAL_FIELDS_MSG));</span>
		}
		
<span class="nc" id="L242">		m_list.setListModel(listModel);</span>
		
<span class="nc" id="L244">		} catch(Exception e) {</span>
<span class="nc" id="L245">			e.printStackTrace();</span>
<span class="nc" id="L246">			handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L247">		}</span>
<span class="nc" id="L248">	}</span>


	/**
	 * Get entity name. Used for title.
	 */
	protected String getTitleEntityType() {
<span class="nc bnc" id="L255" title="All 2 branches missed.">		if(m_bIsInUDFMode)</span>
<span class="nc" id="L256">			return i18n(m_bbmBundle, BbmWebBundleKey.UDF_DEFINITION_TITLE);</span>
<span class="nc" id="L257">		Object[] args = new Object[1];</span>
<span class="nc" id="L258">	    args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="nc" id="L259">	    return m_localizer.i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_ATTRIBUTE_DEFINITION_HEADER, args); </span>
	}
 
	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc bnc" id="L266" title="All 2 branches missed.">		if(m_bIsInUDFMode)</span>
<span class="nc" id="L267">			return UDF_PATH;</span>
<span class="nc" id="L268">		return &quot;queue_attribute_definition&quot;;</span>
	}
	
	protected void initToolbar() {

	    // verticalise queue
<span class="nc" id="L274">	    Object[] args = new Object[1];</span>
<span class="nc" id="L275">	    args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUESMALL);</span>

<span class="nc" id="L277">	    String addLabel = m_toolbar.i18nCore(UIFWebBundleKey.TOOLBAR_CREATE);</span>
		//String copyLabel = MessageFormat.format( i18n(m_bbmBundle, &quot;Copy Queue Attribute&quot;), args);
<span class="nc" id="L279">		String editLabel = m_toolbar.i18nCore(UIFWebBundleKey.TOOLBAR_EDIT);</span>
<span class="nc" id="L280">		String deleteLabel = m_toolbar.i18nCore(UIFWebBundleKey.TOOLBAR_DELETE);</span>

<span class="nc bnc" id="L282" title="All 4 branches missed.">		boolean isAuth = m_bIsScoped &amp;&amp; isAuthorizedToConfigure();</span>
<span class="nc bnc" id="L283" title="All 4 branches missed.">		boolean isBtnEnabled = isAuth &amp;&amp; !StringUtil.isEmpty(this.getPerformActionOnID());</span>
		
<span class="nc" id="L285">		m_toolbar.addSubmitTextButton(PageAction.ADD, addLabel, isAuth);</span>
<span class="nc" id="L286">		m_toolbar.addSubmitTextButton(PageAction.EDIT, editLabel, (isBtnEnabled));</span>
		//m_toolbar.addSubmitTextButton(PageAction.QUEUE_COPY_ACTION, copyLabel, (isBtnEnabled));
<span class="nc" id="L288">		m_toolbar.addDeleteTextButton(PageAction.DELETE, deleteLabel, ( isBtnEnabled));</span>
<span class="nc" id="L289">	}</span>
	
	/**
	 * Return the Selected Queue IDs
	 */
	public ID[] getSelectedQueueIDs() {
<span class="nc" id="L295">		return m_performActionOnIDs;</span>
	}
	
	private String getTypeMappingStr(ID typeID) throws Exception {
<span class="nc bnc" id="L299" title="All 2 branches missed.">		if(m_typeNameMap.isEmpty())</span>
<span class="nc" id="L300">			loadAttributeTypes();</span>
<span class="nc" id="L301">		return (String)m_typeNameMap.get(typeID);</span>
	}
	
	private void loadAttributeTypes() throws Exception {
<span class="nc" id="L305">		m_typeNameMap = new Hashtable&lt;ID,String&gt;();</span>
<span class="nc" id="L306">		Collection&lt;QueueAttributeType&gt; types = new QueueAttributeDefinitionModelHandler().getQueueAttributeTypes(m_context);</span>
<span class="nc" id="L307">		Iterator&lt;QueueAttributeType&gt; iter = types.iterator();</span>
		
<span class="nc bnc" id="L309" title="All 2 branches missed.">		while(iter.hasNext()) {</span>
<span class="nc" id="L310">			QueueAttributeType obj = iter.next();</span>
<span class="nc" id="L311">			m_typeNameMap.put(obj.getID(), obj.getName());</span>
<span class="nc" id="L312">		}</span>
<span class="nc" id="L313">	}</span>
	
	protected boolean isAuthorizedToConfigure() {
<span class="nc bnc" id="L316" title="All 2 branches missed.">		if(m_bIsInUDFMode){</span>
<span class="nc" id="L317">			ScopeID orgScopeID = OrganizationScopeManagerProxy.getScopeID(getSelectedIDObject());</span>
<span class="nc" id="L318">			return (m_context.getUser().isAuthorized(PrivilegeKeys.CORE_CONFIGUREORGANIZATION_ID, orgScopeID));</span>
		}
<span class="nc" id="L320">		return (m_context.getUser().isAuthorized(PrivilegeKeys.FS_CONFIGUREQUEUES));</span>
	}
	
	public void setSelectedOrgID(String id) {
<span class="nc" id="L324">		m_selectedOrgID = new ID(id);</span>
<span class="nc" id="L325">	}</span>

	public void deleteQueueAttributeDefinition(ID id) {
		try {
<span class="nc" id="L329">			new QueueAttributeDefinitionModelHandler().deleteQueueAttributeDefinition(m_context, id);</span>
<span class="nc" id="L330">		} catch (Exception e) {</span>
<span class="nc" id="L331">			Object[] args = new Object[1];</span>
<span class="nc" id="L332">		    args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="nc" id="L333">			String message = m_localizer.i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_ATTRIBUTE_DEFINITION_HEADER, args);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">			if(m_bIsInUDFMode)</span>
<span class="nc" id="L335">				message = m_localizer.i18n(m_bbmBundle, BbmWebBundleKey.UDF_DEFINITION_TITLE);</span>
<span class="nc" id="L336">		    addPageMessage(Message.WARNING_TYPE, message);</span>
<span class="nc" id="L337">			e.printStackTrace();</span>
<span class="nc" id="L338">		}</span>
		
<span class="nc" id="L340">	}</span>

	private boolean isInUDFMode(){
<span class="nc" id="L343">		HttpServletRequest aRequest = m_context.getRequest();</span>
<span class="nc" id="L344">		String pathInfo = aRequest.getPathInfo();</span>
<span class="nc" id="L345">		Screen screen = m_context.getScreen();</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">		String screenName = (screen == null)? &quot;&quot;: screen.getName();</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">		return (UDF_PATH.equals(pathInfo) ||</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">				UDF_SCREEN_NAME.equals(screenName) );</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>