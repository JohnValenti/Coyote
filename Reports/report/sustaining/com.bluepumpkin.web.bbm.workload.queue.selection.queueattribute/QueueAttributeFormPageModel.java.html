<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueAttributeFormPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute</a> &gt; <span class="el_source">QueueAttributeFormPageModel.java</span></div><h1>QueueAttributeFormPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload.queue.selection.queueattribute;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.queueattribute.*;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeType;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationUtil;
import com.bluepumpkin.web.bbm.people.filter.PeopleFilterBoxPC;
import com.bluepumpkin.web.bbm.workload.WorkloadModelHandler;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.filterbox.FilterBoxPC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.list.DynamicMultiColListPC;
import com.witness.web.uif.pagecomponent.list.DynamicMultiColListWithToolbarPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarUtil;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpaneFormPageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;
import com.witness.web.uif.validator.InRangeFieldValidator;

import javax.servlet.http.HttpServletRequest;
import java.text.SimpleDateFormat;
import java.util.*;


/**
 * Title:        QueueAttributeFormPageModel
 * Description:  Display the Edit page for Queue Attributes
 * Copyright:    Copyright (c) 2008
 * Company:      Verint Systems, Inc.
 * @author       Sankar Nair
 */
public class QueueAttributeFormPageModel extends WorkpaneFormPageModel implements
ContainersInRowsPM {

	private static final String MULTIVALUE_ID = &quot;MULTIVALUE_ID_&quot;;
	private static final String ATTRIB_TYPE_ID = &quot;ATTRIB_TYPE_ID_&quot;;

	private static final String ATTRIB_ID = &quot;ATTRIB_ID&quot;;

	private static final String UNDERSCORE = &quot;_&quot;;

	private static final String QUEUE_ATTRIB_VALUE_FUNCTION = &quot;QUEUE_ATTRIB_VALUE_&quot;;

	private static final String QUEUE_ATTRIB_ID = &quot;QueueAttribID&quot;;


	public static final String ATTRIBUTES_EDITOR_TABLE = &quot;ATTRIBUTES_EDITOR_TABLE&quot;;
	public static final String QUEUE_ATTRIBUTE_SAVE = &quot;QUEUE_ATTRIBUTE_SAVE&quot;;

<span class="fc" id="L66">	private static final Category log = Log.initCategory(QueueAttributeFormPageModel.class.getName());</span>

	protected ResourceBundle m_bbmBundle;
	private QueueAttributeDefintion queueAttribute;
	private EmployeeType m_employeeType;
	private FormTwoColumnPC m_formPC;

	private DatePickerPC m_datePicker;
	
	private QueueAttributeDefinitionModelHandler modelHandler; 

	//private QueueAttributeFilterPickerPC filterPC = null;
<span class="nc" id="L78">	private PeopleFilterBoxPC peoplePC = null;</span>
<span class="nc" id="L79">	private FilterBoxPC fb = null; </span>
	
<span class="nc" id="L81">	private DynamicMultiColListPC attributesHolder = null;</span>
	
	private ContainerList m_containerList; // outer container list
	private DynamicMultiColListWithToolbarPC customSchemaTable;
	private FormTwoColumnPC m_queueAttributesPC;
<span class="nc" id="L86">	private FormInputPC m_inputPCOne = null;</span>
	
<span class="nc" id="L88">	private Collection&lt;QueueAttributeDefintion&gt; attribCollection = Collections.EMPTY_LIST;</span>
<span class="nc" id="L89">	private ArrayList&lt;StringsPair&gt; queueAttributeTypes = new ArrayList&lt;StringsPair&gt;();</span>
	public static final String QUEUEATTRIB_DEF_NAME_FN = &quot;queueAttribDefName&quot;;
	public static final String QUEUEATTRIB_DEF_DESC_FN = &quot;queueAttribDefDesc&quot;;
	public static final String QUEUEATTRIB_DEF_TYPE_FN = &quot;queueAttribDefType&quot;;

<span class="nc" id="L94">	private Collection&lt;StringsPair&gt; queueList = new ArrayList&lt;StringsPair&gt;();</span>
	
	
<span class="nc" id="L97">	private Hashtable&lt;String, String&gt; lookupValues = new Hashtable&lt;String, String&gt;();</span>
	
<span class="nc" id="L99">	private Hashtable&lt;ID, QueueAttributePairDateValue&gt; dateLookup = new Hashtable&lt;ID, QueueAttributePairDateValue&gt;();</span>
<span class="nc" id="L100">	private Hashtable&lt;ID, QueueAttributePairTextValue&gt; textLookup = new Hashtable&lt;ID, QueueAttributePairTextValue&gt;();</span>
<span class="nc" id="L101">	private Hashtable&lt;ID, QueueAttributePairDropDownValue&gt; dropDownLookup = new Hashtable&lt;ID, QueueAttributePairDropDownValue&gt;();</span>
<span class="nc" id="L102">	private Hashtable&lt;ID, QueueAttributePairNumericValue&gt; numericLookup = new Hashtable&lt;ID, QueueAttributePairNumericValue&gt;();</span>
<span class="nc" id="L103">	private Hashtable&lt;ID, QueueAttributePairBooleanValue&gt; booleanLookup = new Hashtable&lt;ID, QueueAttributePairBooleanValue&gt;();</span>

<span class="nc" id="L105">	private Hashtable&lt;String, String&gt; dropDownValuesLookup = new Hashtable&lt;String, String&gt;();</span>
	/**
	 * Constructor
	 */
	public QueueAttributeFormPageModel(RequestContext context) {
<span class="nc" id="L110">		super(context, FRAMED_MODEL);</span>

<span class="nc" id="L112">		m_bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L113">		m_containerList = new ContainerList(this, 4);</span>

		
		// Initialize Name	
<span class="nc" id="L117">		queueAttribute = new QueueAttributeDefintion();</span>
<span class="nc" id="L118">		m_inputPCOne = new FormInputPC(context); // small input box -</span>
<span class="nc" id="L119">		addChildComponent(m_inputPCOne);</span>
		
		// Initialize Form PC
<span class="nc" id="L122">		m_formPC = new FormTwoColumnPC(context);</span>
	
<span class="nc" id="L124">		modelHandler = new QueueAttributeDefinitionModelHandler();</span>
		
<span class="nc" id="L126">		attributesHolder = initializeAttributeEditorTable(context);</span>
<span class="nc" id="L127">		addChildComponent(attributesHolder);</span>
<span class="nc" id="L128">		m_containerList.add(attributesHolder);</span>

		//addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE);
		//setJSMediator(&quot;/bbm/js/QueueAttributeEditor.js&quot;);

		
		
		
//		m_queueAttributesPC = new FormTwoColumnPC(context);
		//addChildComponent(m_queueAttributesPC);
		//m_containerList.add(m_queueAttributesPC);
<span class="nc" id="L139">	}</span>
	
	
	private DynamicMultiColListPC initializeAttributeEditorTable (
				
			    RequestContext context) {
<span class="nc" id="L145">			DynamicMultiColListPC table = new DynamicMultiColListPC(context);</span>
<span class="nc" id="L146">			table.setName(&quot;ATTRIBUTES_EDITOR_TABLE&quot;);</span>
			// buttons
	
<span class="nc" id="L149">			TableHeaderPC header = table.getHeader();</span>
<span class="nc" id="L150">			Object[] args = new Object[1];</span>
<span class="nc" id="L151">		    args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
		    
			
<span class="nc" id="L154">			header.addColumnHeaderData(&quot;col1&quot;, m_localizer.i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_ATTRIBUTE_ATTRIBUTES, args));</span>
<span class="nc" id="L155">			header.addColumnHeaderData(&quot;col2&quot;, m_localizer.i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_ATTRIBUTE_ATTRIBUTE_VALUES, args));</span>
<span class="nc" id="L156">			header.addColumnHeaderData(&quot;&quot;, &quot;&quot;); // for hidden id //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L157">			header.addColumnHeaderData(&quot;&quot;, &quot;&quot;); // for hidden type</span>
<span class="nc" id="L158">			header.addColumnHeaderData(&quot;&quot;, &quot;&quot;); // for hidden type</span>
<span class="nc" id="L159">			header.addColumnHeaderData(&quot;&quot;, &quot;&quot;); //for hidden type</span>
<span class="nc" id="L160">			return table;</span>
		}

	
	public Collection getContainers() {
<span class="nc" id="L165">		return m_containerList;</span>
    }

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) {
<span class="nc" id="L172">		return getInstance(context, QueueAttributeFormPageModel.class);</span>
	}

	
	/**
	 * Create Form Model
	 */
	protected void loadData() throws Exception {
		try {

			//There are two IDs. Selected ORganization ID and selected queue ID(s). 
			//The best option would be to allow selection of only one queue and all the same queue attribute settings to
			//be applied to other queues.

<span class="nc" id="L186">			ID selectedOrganizationID = null;</span>
			
<span class="nc" id="L188">			selectedOrganizationID = new ID(OrganizationUtil.getSelectedOrganizationID(m_context));//getSelectedIDObject();</span>
			
<span class="nc" id="L190">			ID[] selectedIDs = getPerformActionOnIDs();</span>
<span class="nc" id="L191">			ArrayList&lt;ID&gt; queueIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L192">			queueIDs.addAll(Arrays.asList(selectedIDs));</span>
			
			//System.out.println(&quot;\n\nOrganization ID &quot; + selectedOrganizationID);
			//System.out.println(&quot;Queue ID(s) &quot; + queueIDs);
			
<span class="nc bnc" id="L197" title="All 2 branches missed.">			if(selectedOrganizationID != null) {</span>
<span class="nc" id="L198">				attribCollection = new QueueAttributeDefinitionModelHandler().getQueueAttributeDefinitions(m_context, selectedOrganizationID);</span>
			}
			
<span class="nc" id="L201">			StringBuffer currentQueueName = new StringBuffer();</span>
//			Collection queues = WorkloadModelHandler.getQueuesByOrgID(m_context, selectedOrganizationID);
<span class="nc" id="L203">			Collection queues = WorkloadModelHandler.getQueuesByIDs(m_context, queueIDs);</span>

			
<span class="nc" id="L206">			Iterator iter = queues.iterator();</span>
//			queueList.add(new StringsPair(getPerformActionOnID(), &quot;&quot;));
			
			
<span class="nc bnc" id="L210" title="All 2 branches missed.">			while(iter.hasNext()) {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">				if(!StringUtil.isEmpty(currentQueueName.toString())) {</span>
<span class="nc" id="L212">					currentQueueName.append(&quot;, &quot;);</span>
				}
<span class="nc" id="L214">				Queue queue = (Queue)iter.next();</span>
<span class="nc" id="L215">				currentQueueName.append(queue.getName());</span>
				
<span class="nc" id="L217">			}</span>
			
			
<span class="nc" id="L220">			Collection&lt;QueueAttributePairDateValue&gt; dateValues = modelHandler.getDateValues(m_context, queueIDs);</span>
<span class="nc" id="L221">			Iterator&lt;QueueAttributePairDateValue&gt; dateIter = dateValues.iterator();</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">			while(dateIter.hasNext()) {</span>
<span class="nc" id="L223">				QueueAttributePairDateValue v = dateIter.next();</span>
<span class="nc" id="L224">				dateLookup.put(v.getQueueAttributeID(), v);</span>
				//TODO - Format the date
				//TODO - Format the date
				//TODO - Format the date
				//TODO - Format the date
<span class="nc" id="L229">				lookupValues.put(v.getQueueID() + UNDERSCORE + v.getQueueAttributeID(), v.getValue().toString());</span>
<span class="nc" id="L230">			}</span>
			
<span class="nc" id="L232">			Collection&lt;QueueAttributePairNumericValue&gt; numericValues = modelHandler.getNumericValues(m_context, queueIDs);</span>
<span class="nc" id="L233">			Iterator&lt;QueueAttributePairNumericValue&gt; numericIter = numericValues.iterator();</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">			while(numericIter.hasNext()) {</span>
<span class="nc" id="L235">				QueueAttributePairNumericValue v = numericIter.next();</span>
<span class="nc" id="L236">				numericLookup.put(v.getQueueAttributeID(), v);</span>
<span class="nc" id="L237">				lookupValues.put(v.getQueueID() + UNDERSCORE + v.getQueueAttributeID(), v.getValue()+ &quot;&quot;);</span>
<span class="nc" id="L238">			}</span>
			
<span class="nc" id="L240">			Collection&lt;QueueAttributePairDropDownValue&gt; ddValues = modelHandler.getDropDownValues(m_context, queueIDs);</span>
<span class="nc" id="L241">			Iterator&lt;QueueAttributePairDropDownValue&gt; ddIter = ddValues.iterator();</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">			while(ddIter.hasNext()) {</span>
<span class="nc" id="L243">				QueueAttributePairDropDownValue v = ddIter.next();</span>
				//System.out.println(&quot;********Adding Queue Drop Down Selection &quot; + v.getQueueAttributeID() + &quot; == &quot; + v.getID() + &quot; == &quot; + v.getValue());
<span class="nc" id="L245">				dropDownLookup.put(v.getQueueAttributeID(), v);</span>
<span class="nc" id="L246">				lookupValues.put(v.getQueueID() + UNDERSCORE + v.getQueueAttributeID(), v.getValue().toString());</span>
<span class="nc" id="L247">			}</span>
			
<span class="nc" id="L249">			Collection&lt;QueueAttributePairTextValue&gt; textValues = modelHandler.getTextValues(m_context, queueIDs);</span>
<span class="nc" id="L250">			Iterator&lt;QueueAttributePairTextValue&gt; textIter = textValues.iterator();</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">			while(textIter.hasNext()) {</span>
<span class="nc" id="L252">				QueueAttributePairTextValue v = textIter.next();</span>
<span class="nc" id="L253">				textLookup.put(v.getQueueAttributeID(), v);</span>
<span class="nc" id="L254">				lookupValues.put(v.getQueueID() + UNDERSCORE + v.getQueueAttributeID(), v.getValue());</span>
<span class="nc" id="L255">			}</span>
			
			
			
			
			
			
			    
<span class="nc" id="L263">			Object[] args = new Object[1];</span>
<span class="nc" id="L264">		    args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
		    
			
<span class="nc" id="L267">		    String title = m_localizer.i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_ATTRIBUTE_ATTRIBUTES, args);</span>
					
<span class="nc" id="L269">			this.getContentTitle().setProperties(title, currentQueueName.toString());</span>
				
			

<span class="nc" id="L273">		} catch (Exception ex) {</span>
<span class="nc" id="L274">			ex.printStackTrace();</span>
<span class="nc" id="L275">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L276">			throw ex;</span>
<span class="nc" id="L277">		}</span>
<span class="nc" id="L278">	}</span>
		
	 protected boolean isValidSelectedOrg() {
<span class="nc" id="L281">	        return true;</span>
	 }
	 private static final String DATE_SAVING_PATTERN = &quot;yyyy-MMM-dd&quot;;

	 
 
	/**
	 * Initialize Form Display
	 */
	protected void initForm() {
<span class="nc" id="L291">		Iterator&lt;QueueAttributeDefintion&gt; iter = attribCollection.iterator();</span>
		
<span class="nc" id="L293">		ArrayList tableRows = new ArrayList();</span>
		
<span class="nc" id="L295">		boolean multipleQueues = false;</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">		if(getPerformActionOnIDs().length &gt; 1)</span>
<span class="nc" id="L297">			multipleQueues = true;</span>
		
<span class="nc bnc" id="L299" title="All 2 branches missed.">		while(iter.hasNext()) {</span>
<span class="nc" id="L300">			QueueAttributeDefintion obj = iter.next();</span>
<span class="nc" id="L301">			DefaultMultiColumnNodeData node = new DefaultMultiColumnNodeData(obj.getID());</span>
<span class="nc" id="L302">			node.add(obj.getName());</span>
			
<span class="nc" id="L304">			boolean sameValues = checkForSameAttribValue(obj.getID());</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">			if(obj.getType().equals(QueueAttributeType.TYPE_TEXT)) {</span>
<span class="nc" id="L306">				String holder = &quot;&quot;;</span>
				
<span class="nc bnc" id="L308" title="All 2 branches missed.">				if(!sameValues) {</span>
<span class="nc" id="L309">					node.add(HtmlUtil.makeTextInput(QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID(),50,50, MULTI_VALUE_DATA,JSUtil.ON_CHANGE));</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">				} else if(textLookup.containsKey(obj.getID())) {</span>
<span class="nc" id="L311">					node.add(HtmlUtil.makeTextInput(QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID(),50,50, textLookup.get(obj.getID()).getValue(),JSUtil.ON_CHANGE));</span>
				} else
<span class="nc" id="L313">					node.add(HtmlUtil.makeTextInput(QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID(),50,50, &quot;&quot;,JSUtil.ON_CHANGE));</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">			} else if(obj.getType().equals(QueueAttributeType.TYPE_NUMERIC)) {</span>
				
				//HtmlUtil.makeTextInput(QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID(), 8, 20, MULTI_VALUE_DATA, &quot;&quot;);
<span class="nc" id="L317">				int type = FormInputPC.TYPE_STRING;</span>
<span class="nc bnc" id="L318" title="All 4 branches missed.">				if(sameValues &amp;&amp; numericLookup.containsKey(obj.getID())) </span>
<span class="nc" id="L319">					m_inputPCOne.reset(QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID(), FormInputPC.localizeRealNumber(numericLookup.get(obj.getID()).getValue() + &quot;&quot;, m_context.getLocalizer()) + &quot;&quot;, type, false);</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">				else if(!sameValues)</span>
<span class="nc" id="L321">					m_inputPCOne.reset(QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID(), MULTI_VALUE_DATA, type, false);</span>
				else
<span class="nc" id="L323">					m_inputPCOne.reset(QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID(), FormInputPC.localizeRealNumber(&quot;0.0&quot;, m_context.getLocalizer()), type, false);</span>
<span class="nc" id="L324">				m_inputPCOne.setAllowedChars(MULTI_VALUE_DATA);</span>
<span class="nc" id="L325">				m_inputPCOne.setIsRequired(false);</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">				if(!sameValues)</span>
<span class="nc" id="L327">					setIsMultiObjEditEnabled(true);</span>
				//if(sameValues) {
<span class="nc" id="L329">					Object[] args = new Object[1];</span>
<span class="nc" id="L330">				    args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
				    
<span class="nc" id="L332">				m_inputPCOne.</span>
<span class="nc" id="L333">				addValidator(new InRangeFieldValidator(this, </span>
<span class="nc" id="L334">                              QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID(), m_localizer.i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_ATTRIBUTE_NUMERIC, args), BbmWebBundleKey.BUNDLE_NAME, -1000000.00, 1000000.00));</span>

				//}
    	    	//m_inputPCOne.setSize(11);
    	    	//m_inputPCOne.setMaxLength(4);
    	    	//m_inputPCOne.setInputType(FormInputPC.TYPE_NUMERIC);
    	    	//m_inputPCOne.setOnChangeJS(&quot;applicationMediator.customDirty();&quot;); 
    	    	
				//addValidator(new InRangeFieldValidator(this, 
    	    		//	&quot;QUEUE_ATTRIB_VALUE_&quot; + obj.getID(), BbmWebBundleKey.Quality_Score, BbmWebBundleKey.BUNDLE_NAME, -1, 99));
    	    	
<span class="nc" id="L345">    	    	node.add(m_inputPCOne.getHtmlDisplay());</span>
				//node.add(HtmlUtil.makeTextInput(QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID(), 8, 20, MULTI_VALUE_DATA, &quot;&quot;));
				
<span class="nc bnc" id="L348" title="All 2 branches missed.">			} else if(obj.getType().equals(QueueAttributeType.TYPE_DATE)) {</span>
<span class="nc" id="L349">				String fn = QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID();</span>
<span class="nc" id="L350">				m_datePicker = new DatePickerPC(m_context, fn);</span>
<span class="nc" id="L351">				addChildComponent(m_datePicker); </span>
				
<span class="nc" id="L353">				m_datePicker.setTimeZone(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L354">				m_datePicker.setIsTimeEnabled(false);</span>
<span class="nc" id="L355">				setLowerAndUpperLimit(m_datePicker);</span>
    			
<span class="nc" id="L357">    			m_datePicker.initForDisplay();</span>
<span class="nc" id="L358">    			Date tempDate = null;</span>
<span class="nc" id="L359">				SimpleDateFormat format = new SimpleDateFormat();</span>
<span class="nc" id="L360">				m_datePicker.setIsDateValueOptional(true);</span>
<span class="nc" id="L361">				format.applyPattern(DATE_SAVING_PATTERN);</span>
				
<span class="nc bnc" id="L363" title="All 4 branches missed.">				if(sameValues &amp;&amp; dateLookup.containsKey(obj.getID())) {</span>
<span class="nc" id="L364">					m_datePicker.setDate(dateLookup.get(obj.getID()).getValue());</span>
				}
				
<span class="nc bnc" id="L367" title="All 2 branches missed.">				if(!sameValues) {</span>
<span class="nc" id="L368">					m_datePicker.setIsMultiValueSupported(true);</span>
<span class="nc" id="L369">					m_datePicker.setIsMultiValue(true);</span>
				}
<span class="nc" id="L371">				node.add(m_datePicker.getHtmlDisplay());</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">			} else if(obj.getType().equals(QueueAttributeType.TYPE_DROPDOWN)) {</span>
				try {
<span class="nc" id="L374">					obj = modelHandler.getQueueAttributeByID(m_context, obj.getID());</span>
<span class="nc" id="L375">				} catch (Exception  e) {</span>
<span class="nc" id="L376">					e.printStackTrace();</span>
<span class="nc" id="L377">					handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L378">				}</span>
<span class="nc" id="L379">				Collection&lt;QueueAttributeDropDown&gt; colDD = obj.getQueueAttributeDropDown();</span>
<span class="nc" id="L380">				Collection&lt;StringsPair&gt; pairedValue = new ArrayList&lt;StringsPair&gt;();</span>
<span class="nc" id="L381">				pairedValue.add(new StringsPair(&quot;-1&quot;, &quot;&quot;));</span>
<span class="nc" id="L382">				Iterator&lt;QueueAttributeDropDown&gt; ddIter = colDD.iterator();</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">				while(ddIter.hasNext()) {</span>
<span class="nc" id="L384">					QueueAttributeDropDown ddVal = ddIter.next();</span>
<span class="nc" id="L385">					pairedValue.add(new StringsPair(ddVal.getID().toString(), ddVal.getValue()));</span>
					//System.out.println(&quot;Putting drop down value &quot; + obj.getID() + &quot;_&quot; + ddVal.getID() + &quot; == &quot; + ddVal.getValue());
<span class="nc" id="L387">					dropDownValuesLookup.put(obj.getID() + UNDERSCORE + ddVal.getID(), ddVal.getValue());</span>
<span class="nc" id="L388">				}</span>
				//System.out.println(&quot;Going to check for &quot; + obj.getID() + &quot; in drop down values&quot;);
<span class="nc bnc" id="L390" title="All 2 branches missed.">				if(!sameValues) {</span>
					
<span class="nc" id="L392">					pairedValue.add(new StringsPair(MULTI_VALUE_DATA, MULTI_VALUE_DATA));</span>
<span class="nc" id="L393">					node.add(HtmlUtil.makeSelectInput(QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID(), MULTI_VALUE_DATA, pairedValue));</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">				} else if(dropDownLookup.containsKey(obj.getID())) {</span>
					//System.out.println(&quot;User had selected dropdown value*************************************************&quot;);
					//System.out.println(&quot;Getting drop down value &quot; + obj.getID() + &quot;_&quot; + dropDownLookup.get(obj.getID()).getValue() + &quot; == &quot; + dropDownValuesLookup.get(obj.getID() + &quot;_&quot; + dropDownLookup.get(obj.getID()).getValue()));
					//System.out.println(obj.getID() + &quot; == &quot; + dropDownLookup.get(obj.getID()).getID() + &quot; == &quot; + dropDownValuesLookup.get(obj.getID() + &quot;_&quot; + dropDownLookup.get(obj.getID()).getValue()));
					//node.add(HtmlUtil.makeSelectInput(&quot;QUEUE_ATTRIB_VALUE_&quot; + obj.getID(), dropDownValuesLookup.get(obj.getID() + &quot;_&quot; + dropDownLookup.get(obj.getId()).getValue()), pairedValue));
<span class="nc" id="L399">					node.add(HtmlUtil.makeSelectInput(QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID(), dropDownLookup.get(obj.getID()).getValue().toString(), pairedValue));</span>
				} else {
					//System.out.println(&quot;*****************In the else block&quot;);
<span class="nc" id="L402">					node.add(HtmlUtil.makeSelectInput(QUEUE_ATTRIB_VALUE_FUNCTION + obj.getID(), &quot;&quot;, pairedValue));</span>
				}
<span class="nc" id="L404">			} else {</span>
<span class="nc" id="L405">				System.out.println(&quot;\t***********      Not any type &quot;);</span>
			}
			
<span class="nc" id="L408">			node.add(HtmlUtil.makeHiddenInput(ATTRIB_ID, obj.getID().toString()));</span>
<span class="nc" id="L409">			node.add(HtmlUtil.makeHiddenInput(ATTRIB_TYPE_ID + obj.getID(), obj.getType().toString()));</span>
<span class="nc" id="L410">			node.add(HtmlUtil.makeHiddenInput(MULTIVALUE_ID + obj.getID(), Boolean.toString(sameValues)));</span>
<span class="nc" id="L411">			tableRows.add(node);</span>
<span class="nc" id="L412">		}</span>
<span class="nc" id="L413">		attributesHolder.setColumnOneClickable(false);</span>
<span class="nc" id="L414">		attributesHolder.setRowSelectable(false);</span>
<span class="nc" id="L415">    	attributesHolder.setListModel(tableRows);</span>
    	
//		m_queueAttributesPC.addRow(&quot;Select the queues to which the same settings should be applied&quot;, HtmlUtil.makeSelectInput(&quot;QUEUE_LIST_VALUES&quot;, null, &quot;&quot;, queueList, true, true));
		
//		m_queueAttributesPC.addRow(&quot;Queue Attribute Picker&quot;, filterPC.getHtmlDisplay());
		
//		m_queueAttributesPC.addRow(&quot;Queue Attribute Picker&quot;, peoplePC.getHtmlDisplay());
<span class="nc" id="L422">	}</span>


	private boolean checkForSameAttribValue(ID attributeID) {
<span class="nc" id="L426">		ID[] queueIDs = getPerformActionOnIDs();</span>
<span class="nc" id="L427">		String value = &quot;*(*(*_INVALID_VALUE_*(*(*&quot;;</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">		if(lookupValues.containsKey(queueIDs[0] + UNDERSCORE + attributeID))</span>
<span class="nc" id="L429">			value = lookupValues.get(queueIDs[0] + UNDERSCORE + attributeID);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">		for(int x = 1; x &lt; queueIDs.length; x++) {</span>
			
<span class="nc bnc" id="L432" title="All 4 branches missed.">			if(value.equals(&quot;*(*(*_INVALID_VALUE_*(*(*&quot;) &amp;&amp; !lookupValues.containsKey(queueIDs[x]+UNDERSCORE + attributeID)) {</span>
				//First queue did not have any value and this queue also do not have any value for this attribute. So the 
				//value is unique.
<span class="nc" id="L435">				continue;</span>
			}
			
<span class="nc bnc" id="L438" title="All 2 branches missed.">			if(!value.equals(lookupValues.get(queueIDs[x]+UNDERSCORE+attributeID))) {</span>
<span class="nc" id="L439">				return false;</span>
			}
		}
		
<span class="nc" id="L443">		return true;</span>
	}


	/**
	 * Initialize Toolbar
	 */
	protected void initToolbar() {
<span class="nc" id="L451">		m_toolbar.addValidateSubmitTextButton(&quot;QUEUE_ATTRIBUTE_SAVE&quot;, i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SAVE), true);</span>

<span class="nc" id="L453">		ToolbarUtil.addConfirmDoneBtn(m_toolbar, true);</span>
<span class="nc" id="L454">	}</span>


	/**
	 * Return the form title
	 *
	 * @return form title
	 */
	public String getFormTitle() {
<span class="nc bnc" id="L463" title="All 2 branches missed.">		if (isNew()) {</span>
<span class="nc" id="L464">			return i18n(m_bbmBundle, &quot;Create Queue Attribute Definition - Non Localized&quot;);</span>
		} else {
<span class="nc" id="L466">			return &quot;Edit Queue Attribute Definition - Non Localized&quot;;</span>
		}
	}
	

	/**
	 * Get entity name. Used for title.
	 */
	protected String getTitleEntityType() {
<span class="nc" id="L475">		return i18n(m_bbmBundle, BbmWebBundleKey.ORG_EMPLOYEETYPE_CONTENT_TITLE);</span>
	}

	/**
	 * Returns an entity name. Used for title.
	 */
	protected String getEntityName() {
<span class="nc" id="L482">		return &quot;Sankar - Entity Name&quot;;</span>
	}

	public String getRequiredHTML() {
<span class="nc" id="L486">		StringBuffer reqHtml = new StringBuffer(&quot;&quot;);</span>
<span class="nc" id="L487">		reqHtml.append(super.getRequiredHTML());</span>
<span class="nc" id="L488">		reqHtml.append(HtmlUtil.makeHiddenInput(QUEUE_ATTRIB_ID, queueAttribute.getID()));</span>

<span class="nc" id="L490">		return reqHtml.toString();</span>
	}
	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
		//return &quot;org_employeetype&quot;;
<span class="nc" id="L497">		return &quot;queue_attribute&quot;;</span>
	}
	
	
	

	public void saveAttributePairValues(HttpServletRequest request) throws Exception {
		try {
<span class="nc" id="L505">		String[] idValues = request.getParameterValues(ATTRIB_ID);</span>
<span class="nc" id="L506">		String[] typeIDs = request.getParameterValues(ATTRIB_TYPE_ID);</span>
<span class="nc" id="L507">		String[] queues = request.getParameterValues(&quot;QUEUE_LIST_VALUES&quot;);</span>
		
<span class="nc" id="L509">		ID[] queueIDs = getPerformActionOnIDs();</span>
		//String[] queues = new String[queuesSelected.length + 1];
		//System.arraycopy(queuesSelected, 0, queues, 0, queuesSelected.length);
		//queues[queues.length - 1] = getPerformActionOnID();
		
		//System.out.println(&quot;QueueID on Save &quot; + getPerformActionOnID());
<span class="nc" id="L515">		String pattern = m_context.getLocalizer().getDateInputFormat();</span>
<span class="nc" id="L516">		SimpleDateFormat format = new SimpleDateFormat(pattern, m_context.getLocalizer().getLocaleContext().getRegionalFormatLocale());</span>
		
<span class="nc" id="L518">		ID queueID = null;</span>
<span class="nc" id="L519">		ArrayList&lt;QueueAttributePairDateValue&gt; dateValues = new ArrayList&lt;QueueAttributePairDateValue&gt;();</span>
<span class="nc" id="L520">		ArrayList&lt;QueueAttributePairNumericValue&gt; numericValues = new ArrayList&lt;QueueAttributePairNumericValue&gt;();</span>
<span class="nc" id="L521">		ArrayList&lt;QueueAttributePairDropDownValue&gt; ddValues = new ArrayList&lt;QueueAttributePairDropDownValue&gt;();</span>
<span class="nc" id="L522">		ArrayList&lt;QueueAttributePairTextValue&gt; textValues = new ArrayList&lt;QueueAttributePairTextValue&gt;();</span>
		
		//System.out.println(&quot;\nSelected queues&quot;);
<span class="nc" id="L525">		Collection&lt;ID&gt; queueIDS = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">		for(int x = 0 ; x &lt; queueIDs.length; x++) {</span>
			//System.out.println(&quot;Selected Queue ID &quot; + queueIDs[x]);
<span class="nc" id="L528">			queueIDS.add(new ID(queueIDs[x]));</span>
		}
		
	//	if(!queueIDS.contains(new ID(getPerformActionOnID())))
		//	queueIDS.add(new ID(getPerformActionOnID()));
		
<span class="nc" id="L534">		Collection&lt;ID&gt; retainAttributeValues = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">		for(int x = 0; x &lt; idValues.length; x++) {</span>
<span class="nc" id="L536">			Iterator&lt;ID&gt; iter = queueIDS.iterator();</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">				while(iter.hasNext()) {</span>
//				if(queues[y].equals(&quot;_&quot;))
//					queueID = new ID(getPerformActionOnID());
//				else
<span class="nc" id="L541">					queueID = iter.next();</span>
				
<span class="nc" id="L543">				String userValue = request.getParameter(QUEUE_ATTRIB_VALUE_FUNCTION+ idValues[x]);</span>
				
				
				//System.out.println(&quot;Queue ID &quot; + queueID + &quot; -- User Value &quot; + userValue);
<span class="nc" id="L547">				ID typeID = new ID(request.getParameter(ATTRIB_TYPE_ID + idValues[x]));</span>
<span class="nc" id="L548">				boolean sameValue = Boolean.parseBoolean(request.getParameter(MULTIVALUE_ID + idValues[x]));</span>
				
<span class="nc bnc" id="L550" title="All 2 branches missed.">				if(StringUtil.isEmptyOrWhiteSpace(userValue))</span>
<span class="nc" id="L551">					break;</span>
				
<span class="nc bnc" id="L553" title="All 4 branches missed.">				if(!sameValue &amp;&amp; MULTI_VALUE_DATA.equals(userValue)) {</span>
<span class="nc" id="L554">					retainAttributeValues.add(new ID(idValues[x]));</span>
<span class="nc" id="L555">					break;</span>
				}
				
<span class="nc bnc" id="L558" title="All 4 branches missed.">				if(typeID.equals(QueueAttributeType.TYPE_DROPDOWN) &amp;&amp; userValue.equals(&quot;-1&quot;))</span>
<span class="nc" id="L559">					break;</span>
				
<span class="nc bnc" id="L561" title="All 2 branches missed.">				if(typeID.equals(QueueAttributeType.TYPE_DATE)) {</span>
<span class="nc" id="L562">					QueueAttributePairDateValue value = new QueueAttributePairDateValue();</span>
<span class="nc" id="L563">					value.setQueueAttributeID(new ID(idValues[x]));</span>
<span class="nc" id="L564">					value.setQueueID(queueID);</span>
<span class="nc" id="L565">					value.setValue(format.parse(userValue));</span>
<span class="nc" id="L566">					dateValues.add(value);</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">				} else if(typeID.equals(QueueAttributeType.TYPE_DROPDOWN)) {</span>
					//System.out.println(&quot;Setting Drop Down Values&quot;);
<span class="nc" id="L569">					QueueAttributePairDropDownValue value = new QueueAttributePairDropDownValue();</span>
<span class="nc" id="L570">					value.setQueueAttributeID(new ID(idValues[x]));</span>
<span class="nc" id="L571">					value.setQueueID(queueID);</span>
<span class="nc" id="L572">					value.setValue(new ID(userValue));</span>
					//System.out.println(&quot;Q ID &quot; + value.getQueueID() + &quot;, QAID &quot; + value.getQueueAttributeID() + &quot;, Value &quot; + value.getValue());
							
<span class="nc" id="L575">					ddValues.add(value);</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">				} else if(typeID.equals(QueueAttributeType.TYPE_NUMERIC)) {</span>
<span class="nc" id="L577">					QueueAttributePairNumericValue value = new QueueAttributePairNumericValue();</span>
<span class="nc" id="L578">					value.setQueueAttributeID(new ID(idValues[x]));</span>
<span class="nc" id="L579">					value.setQueueID(queueID);</span>
					
<span class="nc" id="L581">					value.setValue(new Double(FormInputPC.convertLocalizedRealNumber(userValue, m_context.getLocalizer())).doubleValue());</span>
<span class="nc bnc" id="L582" title="All 4 branches missed.">					if(value.getValue() &lt; -1000000 || value.getValue() &gt; 1000000)</span>
<span class="nc" id="L583">						throw new NumberFormatException();</span>
<span class="nc" id="L584">					numericValues.add(value);</span>
<span class="nc" id="L585">				} else {</span>
<span class="nc" id="L586">					QueueAttributePairTextValue value = new QueueAttributePairTextValue();</span>
<span class="nc" id="L587">					value.setQueueAttributeID(new ID(idValues[x]));</span>
<span class="nc" id="L588">					value.setQueueID(queueID);</span>
<span class="nc" id="L589">					value.setValue(userValue);</span>
<span class="nc" id="L590">					textValues.add(value);</span>
				}
<span class="nc" id="L592">			}</span>
		}

		//First delete all the values and create new values. This is to remove any values
		//whose selection has been removed by the user
<span class="nc" id="L597">		modelHandler.deleteQueueAttributePairValues(m_context, queueIDS, retainAttributeValues);</span>
		
<span class="nc bnc" id="L599" title="All 2 branches missed.">		if(ddValues.size() &gt; 0) {</span>
<span class="nc" id="L600">			modelHandler.createDropDownValuePair(m_context, ddValues);</span>
		}
<span class="nc bnc" id="L602" title="All 2 branches missed.">		if(textValues.size() &gt; 0) {</span>
<span class="nc" id="L603">			modelHandler.createTextValuePair(m_context, textValues);</span>
		}
<span class="nc bnc" id="L605" title="All 2 branches missed.">		if(dateValues.size() &gt; 0)</span>
<span class="nc" id="L606">			modelHandler.createDateValuePair(m_context, dateValues);</span>
		
<span class="nc bnc" id="L608" title="All 2 branches missed.">		if(numericValues.size() &gt; 0)</span>
<span class="nc" id="L609">			modelHandler.createNumericValuePair(m_context, numericValues);</span>

<span class="nc" id="L611">		} catch(NumberFormatException e) {</span>
<span class="nc" id="L612">			e.printStackTrace();</span>
<span class="nc" id="L613">			throw e;</span>
<span class="nc" id="L614">		} catch(Exception e) {</span>
<span class="nc" id="L615">			handleUnableToUpdateInfo(log, e);</span>
<span class="nc" id="L616">			e.printStackTrace();</span>
<span class="nc" id="L617">			throw e;</span>
<span class="nc" id="L618">		}</span>
		
<span class="nc" id="L620">	}</span>
	
	public void removeDeletedRows(HttpServletRequest request) {
		//	 deleted rows from 2 param tables
<span class="nc" id="L624">		setDeletedRows(customSchemaTable.getDynamicMultiColList().getDeletedRowIDs());</span>
<span class="nc" id="L625">	}</span>
	
	
	 private void setDeletedRows(Collection deletedIDs) {
<span class="nc" id="L629">			ArrayList&lt;ID&gt; toBeDeleted = new ArrayList();</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">			if (deletedIDs != null)</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">			    for (Iterator it = deletedIDs.iterator(); it.hasNext();) {</span>
				try {
<span class="nc" id="L633">				    ID deletedID = new ID((String) it.next());</span>
<span class="nc" id="L634">				    toBeDeleted.add(deletedID);</span>
<span class="nc" id="L635">				} catch (RuntimeException e) {</span>
				    // This is possible if a new row is deleted which is not
				    // yet saved.
				    // In this event, there wont be any ids.
<span class="nc" id="L639">				}</span>
			    }
<span class="nc bnc" id="L641" title="All 2 branches missed.">			if(toBeDeleted.size() &lt;= 0) {</span>
<span class="nc" id="L642">			    return;</span>
			}
			
			    	try { 
<span class="nc" id="L646">			    		new QueueAttributeDefinitionModelHandler().deleteDropDownValues(m_context, toBeDeleted);</span>
<span class="nc" id="L647">			    	} catch (Exception e) {</span>
<span class="nc" id="L648">						addPageMessage(Message.WARNING_TYPE, i18n(m_bbmBundle, &quot;Error deleting drop down values. Make sure it is not linked to any queues - Non localized&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L649">						handleUnableToUpdateInfo(log, e);</span>
<span class="nc" id="L650">					}</span>
<span class="nc" id="L651">		    }</span>

	 private void setLowerAndUpperLimit(DatePickerPC m_dateRangePicker){
<span class="nc" id="L654">			Calendar calendar = Calendar.getInstance();</span>
<span class="nc" id="L655">			calendar.set(1970, Calendar.JANUARY, 1, 0, 0, 0);</span>
<span class="nc" id="L656">			Date dateLower = calendar.getTime();</span>
<span class="nc" id="L657">			calendar.set(2078,  Calendar.DECEMBER, 31, 0, 0, 0);</span>
<span class="nc" id="L658">			Date dateUpper = calendar.getTime();</span>
<span class="nc" id="L659">			m_dateRangePicker.setUpperLimit(dateUpper);</span>
<span class="nc" id="L660">		}</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>