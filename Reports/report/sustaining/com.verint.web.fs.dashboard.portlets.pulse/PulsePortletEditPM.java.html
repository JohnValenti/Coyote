<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PulsePortletEditPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.dashboard.portlets.pulse</a> &gt; <span class="el_source">PulsePortletEditPM.java</span></div><h1>PulsePortletEditPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.dashboard.portlets.pulse;

import java.text.DateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.TimeZone;

import javax.portlet.PortletPreferences;
import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.core.keys.CoreJavaScriptFileID;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.core.dashboard.pluto.PlutoPreferencesUtil;
import com.verint.web.core.dashboard.portlets.MultiIFramePortlet;
import com.verint.web.fs.dashboard.portlets.pulse.util.Constants;
import com.verint.web.wfm.keys.WfmJavaScriptFileID;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.CommonWebBundleKey;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpaneFormPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;

public class PulsePortletEditPM extends WorkpaneFormPM {
	private static final long serialVersionUID = -2815302616689463480L;
	private static final String FN_TEMPLATE_ID = &quot;templateID&quot;;
	private static final String FN_INSTANCE_ID = &quot;instanceID&quot;;
	private static final String INITIAL_LOAD = &quot;initialLoad&quot;;

<span class="nc" id="L41">	private boolean m_initialized = false;</span>
<span class="nc" id="L42">	private boolean editComplete = false;</span>
	private String instanceID;
	private String templateID;
<span class="nc" id="L45">	private User m_user = m_context.getUser();</span>

<span class="nc" id="L47">	private boolean initialLoad = true;</span>

<span class="nc" id="L49">	private ID m_campaignID = null;</span>
<span class="nc" id="L50">	private TimeZone m_campaignTimeZone = null;</span>
	private StatisticType m_statisticType;
<span class="nc" id="L52">	private ID m_QueueID = null;</span>
<span class="nc" id="L53">	private boolean savePressed = false;</span>
	
<span class="nc" id="L55">	private String m_datePickerType = null;</span>
<span class="nc" id="L56">	private int m_lastNPeriodType = -1;</span>
<span class="nc" id="L57">	private int m_lastNPeriods = Constants.DATE_LAST_N_PERIOD_INVALID;</span>
<span class="nc" id="L58">	private String m_errorMessageId = null;</span>

	private Date m_tpSDate;
	private Date m_tpEDate;

<span class="nc" id="L63">	private Boolean m_trimToHOO = true;</span>

	private PulsePortletEditPC m_portletEditPC;
	private Collection&lt;Campaign&gt; m_campaignList;

	public PulsePortletEditPM(RequestContext context) {
<span class="nc" id="L69">		super(context, PageModel.BASIC_MODEL);</span>
<span class="nc" id="L70">		m_bodyStyle = &quot;margin: 0px; overflow: auto;&quot;;</span>
<span class="nc" id="L71">		m_workAreaStyle = &quot;height: expression(document.body.clientHeight-28);&quot;;</span>
<span class="nc" id="L72">		m_workContentStyle = &quot;margin: 0px; border: 0px;&quot;;</span>
<span class="nc" id="L73">		m_workPaneStyle = &quot;height: 100%;&quot;;</span>

<span class="nc" id="L75">		addRequiredJavaScriptFile(CoreJavaScriptFileID.PORTLET_POPUP_UTIL);</span>
		
<span class="nc" id="L77">		setIsAutoResizeEnabled(false);</span>
<span class="nc" id="L78">		m_portletEditPC = new PulsePortletEditPC(context);</span>
<span class="nc" id="L79">		addChildComponent(m_portletEditPC);</span>
<span class="nc" id="L80">		setJSMediator(WfmJavaScriptFileID.MEDIATOR_QUEUE_SELECTOR);</span>
<span class="nc" id="L81">	}</span>

	public static PageModel getInstance(RequestContext context) {
<span class="nc" id="L84">		return PageModel.getInstance(context, PulsePortletEditPM.class);</span>
	}

	@Override
	public String getScreenTitle() {
<span class="nc" id="L89">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PULSE_PORTLET_EDIT);</span>
	}

	@Override
	protected void initializeModel() {
<span class="nc bnc" id="L94" title="All 2 branches missed.">		if (!m_initialized) {</span>
<span class="nc" id="L95">			m_initialized = true;</span>

<span class="nc bnc" id="L97" title="All 2 branches missed.">			if (!m_user.isSuperUser()) {</span>
				try {
<span class="nc" id="L99">					setForm(m_portletEditPC);</span>

<span class="nc" id="L101">					m_campaignList = CampaignModelHandler.getCampaignsForUser(m_context, m_context.getUser());</span>

					// On first load, we want to pull the values that may be stored in portlet prefs
<span class="nc bnc" id="L104" title="All 2 branches missed.">					if (initialLoad) {</span>
<span class="nc" id="L105">						initialLoad = false;</span>

<span class="nc" id="L107">						Calendar now = Calendar.getInstance();</span>
<span class="nc" id="L108">						Calendar weekFromNow = Calendar.getInstance();</span>
<span class="nc" id="L109">						weekFromNow.add(Calendar.DATE, 6);</span>

<span class="nc" id="L111">						CampaignManager campaignManager = PulsePortletUtil.getCampaignManager();</span>

						// get or set the campaign ID
<span class="nc" id="L114">						PortletPreferences prefs = PlutoPreferencesUtil.getPortletPreferences(m_context, templateID, instanceID);</span>
<span class="nc" id="L115">						String campaignIDStr = prefs.getValue(Constants.CAMPAIGN_ID, null);</span>
<span class="nc bnc" id="L116" title="All 4 branches missed.">						if (campaignIDStr != null &amp;&amp; !&quot;&quot;.equals(campaignIDStr)) {</span>
<span class="nc" id="L117">							Campaign prefsCampaign = campaignManager.getCampaignByID(new ID(campaignIDStr));</span>
<span class="nc" id="L118">							m_campaignTimeZone = prefsCampaign.getTimeZone();</span>
<span class="nc" id="L119">							m_campaignID = prefsCampaign.getID();</span>
<span class="nc" id="L120">						}</span>
						else  {
<span class="nc bnc" id="L122" title="All 2 branches missed.">							if (m_campaignList.isEmpty()) {</span>
<span class="nc" id="L123">								addPageMessage(Message.WARNING_TYPE, FsWebBundleKey.WARN_NO_CAMPAIGNS_FOUND_FOR_USER,</span>
										FsWebBundleKey.BUNDLE_NAME);
							}
							else {
<span class="nc" id="L127">								m_campaignTimeZone = ((Campaign)((ArrayList)m_campaignList).get(0)).getTimeZone();</span>
<span class="nc" id="L128">								m_campaignID = ((Campaign)((ArrayList)m_campaignList).get(0)).getID();</span>
							}
						}

						// get or set the date picker type
<span class="nc" id="L133">						m_datePickerType = prefs.getValue(Constants.DATE_PICKER_TYPE, null);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">						if (m_datePickerType == null) {</span>
<span class="nc" id="L135">							m_datePickerType = LastNPeriodPickerPC.PICKER_TYPE_DATE_RANGE;</span>
						}

						// get the periodicity type - doesn't need to be assigned a default as the LastNPeriodPickerPC provides one
<span class="nc" id="L139">						String lastNPeriodTypeStr = prefs.getValue(Constants.DATE_LAST_N_PERIOD_TYPE, null);</span>
<span class="nc bnc" id="L140" title="All 4 branches missed.">						if (lastNPeriodTypeStr != null &amp;&amp; !&quot;&quot;.equals(lastNPeriodTypeStr)) {</span>
<span class="nc" id="L141">							m_lastNPeriodType = Integer.parseInt(lastNPeriodTypeStr);</span>
						}

						// get the number of periods - doesn't need to be assigned a default as the LastNPeriodPickerPC provides one
<span class="nc" id="L145">						String lastNPeriodStr = prefs.getValue(Constants.DATE_LAST_N_PERIOD, null);</span>
<span class="nc bnc" id="L146" title="All 4 branches missed.">						if (lastNPeriodStr != null &amp;&amp; !&quot;&quot;.equals(lastNPeriodStr)) {</span>
<span class="nc" id="L147">							m_lastNPeriods = Integer.parseInt(lastNPeriodStr);</span>
						}

						// get or set the start date
<span class="nc" id="L151">						String startDateStr = prefs.getValue(Constants.DATE_DATE_RANGE_START_DATE, null);</span>
<span class="nc bnc" id="L152" title="All 4 branches missed.">						if (startDateStr != null &amp;&amp; !&quot;&quot;.equals(startDateStr)) {</span>
<span class="nc" id="L153">							m_tpSDate = DateFormat.getDateTimeInstance(DateFormat.FULL, DateFormat.FULL).parse(startDateStr);</span>
						}
<span class="nc bnc" id="L155" title="All 2 branches missed.">						else if (m_campaignID != null) {</span>
<span class="nc" id="L156">							m_tpSDate = PulsePortletUtil.getCampaignStartOfDay(m_campaignID, now.getTime());</span>
						}

						// get or set the end date
<span class="nc" id="L160">						String endDateStr = prefs.getValue(Constants.DATE_DATE_RANGE_END_DATE, null);</span>
<span class="nc bnc" id="L161" title="All 4 branches missed.">						if (endDateStr != null &amp;&amp; !&quot;&quot;.equals(endDateStr)) {</span>
<span class="nc" id="L162">							m_tpEDate = DateFormat.getDateTimeInstance(DateFormat.FULL, DateFormat.FULL).parse(endDateStr);</span>
						}
<span class="nc bnc" id="L164" title="All 2 branches missed.">						else if (m_campaignID != null) {</span>
<span class="nc" id="L165">							m_tpEDate = PulsePortletUtil.getCampaignEndOfDay(m_campaignID, weekFromNow.getTime());</span>
						}

						// get or set the queue ID
<span class="nc" id="L169">						String queueIdStr = prefs.getValue(Constants.QUEUE_ID, null);</span>
<span class="nc bnc" id="L170" title="All 4 branches missed.">						if (queueIdStr != null &amp;&amp; !&quot;&quot;.equals(queueIdStr)) {</span>
<span class="nc" id="L171">							m_QueueID = new ID(queueIdStr);</span>
						}

						// get or set the statistic type
<span class="nc" id="L175">						String statisticTypeStr = prefs.getValue(Constants.STATISTIC_TYPE, null);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">						if (statisticTypeStr != null) {</span>
<span class="nc" id="L177">							int statisticTypeId = Integer.parseInt(statisticTypeStr);</span>
<span class="nc" id="L178">							m_statisticType = StatisticType.getStatisticType(statisticTypeId);</span>
<span class="nc" id="L179">						}</span>
						else  {
<span class="nc" id="L181">							m_statisticType = StatisticType.FTE;</span>
						}

						// get or set the trim to HOO flag
<span class="nc" id="L185">						String trimToHOOStr = prefs.getValue(Constants.TRIM_TO_HOO, null);</span>
<span class="nc bnc" id="L186" title="All 4 branches missed.">						if (trimToHOOStr != null &amp;&amp; !&quot;&quot;.equals(trimToHOOStr)) {</span>
<span class="nc" id="L187">							m_trimToHOO = Boolean.parseBoolean(trimToHOOStr);</span>
						}
						else {
							// setting default
<span class="nc" id="L191">							m_trimToHOO = true;</span>
						}
					}

<span class="nc" id="L195">					initCampaignContent();</span>
<span class="nc" id="L196">					m_portletEditPC.init();</span>
<span class="nc" id="L197">					m_portletEditPC.initForDisplay();</span>

<span class="nc" id="L199">					m_toolbar.addSubmitTextButton(</span>
						PageAction.SAVE,
<span class="nc" id="L201">						m_localizer.i18n(CommonWebBundleKey.BUNDLE_NAME, CommonWebBundleKey.TOOLBAR_SAVE),</span>
						true);
<span class="nc" id="L203">					m_toolbar.addConfirmSubmitTextButton(PageAction.CANCEL,</span>
<span class="nc" id="L204">							i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_CANCEL), true);</span>
<span class="nc" id="L205">				} catch (Exception ex) {</span>
<span class="nc" id="L206">					handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L207">				}</span>
			}
		}
<span class="nc" id="L210">	}</span>

	/**
	 * Initialize Content
	 */
	protected void initCampaignContent() {
<span class="nc" id="L216">		m_portletEditPC.setStatisticType(m_statisticType);</span>
<span class="nc" id="L217">		m_portletEditPC.setCampaignID(m_campaignID);</span>
<span class="nc" id="L218">		m_portletEditPC.setCampaignList(m_campaignList);</span>
<span class="nc" id="L219">		m_portletEditPC.setQueueID(m_QueueID);</span>
<span class="nc" id="L220">		m_portletEditPC.setDatePickerType(m_datePickerType);</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">		if (m_lastNPeriodType != -1 &amp;&amp; m_lastNPeriods != Constants.DATE_LAST_N_PERIOD_INVALID) {</span>
<span class="nc" id="L222">			m_portletEditPC.setLastNPeriods(m_lastNPeriods, m_lastNPeriodType);</span>
		}
<span class="nc" id="L224">		setPortletEditPCDateRangePickerTimeZone();</span>
<span class="nc" id="L225">		m_portletEditPC.setStartDate(m_tpSDate);</span>
<span class="nc" id="L226">		m_portletEditPC.setEndDate(m_tpEDate);</span>
<span class="nc" id="L227">		m_portletEditPC.setTrimToHOO(m_trimToHOO);</span>
<span class="nc" id="L228">	}</span>

	/**
	 * Extract parameter using current Request Context
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L235">		boolean success = super.extractParameters(request);</span>
<span class="nc" id="L236">		m_statisticType = m_portletEditPC.getStatisticType();</span>
<span class="nc" id="L237">		m_campaignID = m_portletEditPC.getCampaignID();</span>
<span class="nc" id="L238">		m_campaignList = m_portletEditPC.getCampaignList();</span>
<span class="nc" id="L239">		m_datePickerType = m_portletEditPC.getDatePickerType();</span>
<span class="nc" id="L240">		m_lastNPeriodType = m_portletEditPC.getLastNPeriodsPeriodicity();</span>
<span class="nc" id="L241">		m_lastNPeriods = m_portletEditPC.getNoLastNPeriods();</span>
<span class="nc" id="L242">		setPortletEditPCDateRangePickerTimeZone();</span>
<span class="nc" id="L243">		m_tpSDate = m_portletEditPC.getStartDate();</span>
<span class="nc" id="L244">		m_tpEDate = m_portletEditPC.getEndDate();</span>
<span class="nc" id="L245">		m_QueueID = m_portletEditPC.getQueueID();</span>
<span class="nc" id="L246">		m_trimToHOO = m_portletEditPC.getTrimToHOO();</span>
<span class="nc" id="L247">		return success;</span>
	}

	@Override
	protected void initForm() {
		// TODO Auto-generated method stub
<span class="nc" id="L253">	}</span>

	@Override
	public PageComponent getForm() {
<span class="nc" id="L257">		return this;</span>
	}

	/**
	 * @param editComplete a boolean flag denoting the edit is complete
	 */
	public void setEditComplete(boolean editComplete) {
<span class="nc" id="L264">		this.editComplete = editComplete;</span>
<span class="nc" id="L265">	}</span>

	/**
	 * @param initialLoad a boolean flag denoting the initial load has completed
	 */
	public void setInitialLoad(boolean initialLoad) {
<span class="nc" id="L271">		this.initialLoad = initialLoad;</span>
<span class="nc" id="L272">	}</span>

	/**
	 * @return the instanceID
	 */
	public String getInstanceID() {
<span class="nc" id="L278">		return instanceID;</span>
	}

	/**
	 * @param instanceID the instanceID to set
	 */
	public void setInstanceID(String instanceID) {
<span class="nc" id="L285">		this.instanceID = instanceID;</span>
<span class="nc" id="L286">	}</span>

	/**
	 * @return the templateID
	 */
	public String getTemplateID() {
<span class="nc" id="L292">		return templateID;</span>
	}

	/**
	 * @param templateID the templateID to set
	 */
	public void setTemplateID(String templateID) {
<span class="nc" id="L299">		this.templateID = templateID;</span>
<span class="nc" id="L300">	}</span>

	@Override
	public String getRequiredHTML() {
<span class="nc" id="L304">		return super.getRequiredHTML();</span>
	}
	
	/**
	 * @param savePressed The savePressed to set
	 */
	public void setSavePressed(boolean savePressed) {
<span class="nc" id="L311">		this.savePressed = savePressed;</span>
<span class="nc" id="L312">	}</span>

	@Override
	public String getHtmlDisplay() {
<span class="nc" id="L316">		StringBuffer html = new StringBuffer();</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">		if (editComplete) {</span>
			//if there is error messageID, then call setErrorMsg() on the JS like below.
<span class="nc bnc" id="L319" title="All 4 branches missed.">			if (this.getSaveErrMsgID() != null &amp;&amp; this.getSaveErrMsgID().length() &gt; 0) {</span>
<span class="nc" id="L320">				html.append(&quot;&lt;script type='text/javascript'&gt;setErrorMsg('&quot; + this.getSaveErrMsgID() + &quot;')&lt;/script&gt;&quot;);</span>
			}
<span class="nc bnc" id="L322" title="All 2 branches missed.">			if (savePressed) {</span>
<span class="nc" id="L323">				html.append(MultiIFramePortlet.getPortletModeSwitchJavascriptTag(templateID, &quot;view&quot;, &quot;save&quot;));</span>
			} else {
<span class="nc" id="L325">				html.append(MultiIFramePortlet.getPortletModeSwitchJavascriptTag(templateID, &quot;view&quot;, &quot;cancel&quot;));</span>
			}
		}
<span class="nc bnc" id="L328" title="All 2 branches missed.">		if (m_user.isSuperUser()) {</span>
<span class="nc" id="L329">			addPageMessage(Message.WARNING_TYPE, m_localizer.i18n(</span>
				FsWebBundleKey.BUNDLE_NAME,
				FsWebBundleKey.PULSE_PORTLET_ILLEGAL_EMPLOYEE_MESSAGE));
<span class="nc" id="L332">			return displayAllMessages(m_context);</span>
		}
		else {
<span class="nc bnc" id="L335" title="All 2 branches missed.">			if (getPageMessageList().size() &gt; 0) {</span>
<span class="nc" id="L336">				html.append(displayAllMessages(m_context));</span>
			}
<span class="nc" id="L338">			html.append(m_portletEditPC.getHtmlDisplay());</span>
<span class="nc" id="L339">			html.append(HtmlUtil.makeHiddenInput(FN_TEMPLATE_ID, templateID));</span>
<span class="nc" id="L340">			html.append(HtmlUtil.makeHiddenInput(FN_INSTANCE_ID, instanceID));</span>
<span class="nc" id="L341">			html.append(HtmlUtil.makeHiddenInput(INITIAL_LOAD, initialLoad));</span>

<span class="nc" id="L343">			return html.toString();</span>
		}
	}

	public ID getCampaignID() {
<span class="nc" id="L348">		return m_campaignID;</span>
	}

	public void setCampaignID(ID campaignID) {
<span class="nc" id="L352">		m_campaignID = campaignID;</span>
<span class="nc" id="L353">	}</span>

	public StatisticType getStatisticType() {
<span class="nc" id="L356">		return m_statisticType;</span>
	}

	public void setStatisticType(StatisticType type) {
<span class="nc" id="L360">		m_statisticType = type;</span>
<span class="nc" id="L361">	}</span>

	public String getDatePickerType(){
<span class="nc" id="L364">		return m_datePickerType;</span>
	}

	public int getLastNPeriodType(){
<span class="nc" id="L368">		return m_lastNPeriodType;</span>
	}

	public int getLastNPeriods(){
<span class="nc" id="L372">		return m_lastNPeriods;</span>
	}

	public Date getDateRangeStartDate() {
<span class="nc" id="L376">		return m_tpSDate;</span>
	}

	public Date getDateRangeEndDate() {
<span class="nc" id="L380">		return m_tpEDate;</span>
	}

	public ID getQueueID() {
<span class="nc" id="L384">		return m_QueueID;</span>
	}

	public Boolean getTrimToHOO() {
<span class="nc" id="L388">		return m_trimToHOO;</span>
	}

	public TimeZone getCampaignTimeZone() {
<span class="nc" id="L392">		return m_campaignTimeZone;</span>
	}

	/*
	 * (non-Javadoc)
	 *
	 * @see com.witness.web.uif.pagemodel.WorkpaneFormPM#getForms()
	 */
	@Override
	public Collection getForms() {
<span class="nc" id="L402">		return Collections.singleton(this);</span>
	}

	/**
	 * This method will set the {@code PortletEditPC}'s {@code DateRangePicker}'s
	 * time zone.
	 */
	private void setPortletEditPCDateRangePickerTimeZone()
	{
<span class="nc bnc" id="L411" title="All 2 branches missed.">		if (m_campaignID != null) {</span>
			try {
<span class="nc" id="L413">				CampaignManager campaignManager = PulsePortletUtil.getCampaignManager();</span>
<span class="nc" id="L414">				m_campaignTimeZone = campaignManager.getCampaignByID(m_campaignID).getTimeZone();</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">				if (m_campaignTimeZone != null) {</span>
					// if no campaign default, the picker will run with user timezone
<span class="nc" id="L417">					m_portletEditPC.setDateRangePickerTimeZone(m_campaignTimeZone);</span>
				}
			}
<span class="nc" id="L420">			catch (Exception ex) {</span>
<span class="nc" id="L421">				log.error(&quot;Unable to get campaign.&quot;, ex);</span>
<span class="nc" id="L422">			}</span>
		}
<span class="nc" id="L424">	}</span>

	public void setSaveErrMsgID(String msgID) {
<span class="nc" id="L427">		m_errorMessageId = msgID;	</span>
<span class="nc" id="L428">	}</span>

	public String getSaveErrMsgID() {
<span class="nc" id="L431">		return m_errorMessageId;	</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>