<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AppletRH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.core.applet</a> &gt; <span class="el_source">AppletRH.java</span></div><h1>AppletRH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.core.applet;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.lang.reflect.Method;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.ResourceBundle;

import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.web.core.Log;
import com.bluepumpkin.web.core.keys.PageKeys;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.core.l10n.CoreWebLogBundleKey;
import com.witness.ejb.core.security.model.User;
import com.witness.ejb.core.security.util.UserConverter;
import com.witness.web.uif.base.BackgroundProcessRH;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:		 AppletRH
 * Description:	 Handle requests from the applets
 * Copyright:	 Copyright (c) 2001
 * Company:		 Blue Pumpkin Software, Inc
 * @author		 David Su
 * @version 1.0
 */
public class AppletRH extends  BackgroundProcessRH {
<span class="fc" id="L38">	private static final Category m_log = Log.initCategory(AppletRH.class.getName());</span>
	protected static final String APPLET_RESPONSE = &quot;APPLET_RESPONSE&quot;;
	
	protected static final String GET_LOCALE_CONTEXT = &quot;GET_LOCALE_CONTEXT&quot;;
	
	//If there is an error while processing a request, it will be added to the
	// response map with this key.
	protected static final String ERROR_RESPONSE_CODE = &quot;error&quot;;

	protected Map m_mapAppletIO;

<span class="fc" id="L49">	private static boolean isCheckingDupRequest = false;</span>
<span class="fc" id="L50">	private static HashMap pendingRequestPerUser = new HashMap();</span>

	static {
		//check bpconfig to see if checking dup request
		try {
<span class="fc" id="L55">			String isCheckDup = BbmManagerFactory.getDBConfigManager().getValue(&quot;http/applet/checkDupRequest&quot;);</span>
<span class="pc bpc" id="L56" title="3 of 4 branches missed.">			if (isCheckDup != null &amp;&amp; isCheckDup.toLowerCase().equals(&quot;true&quot;)) {</span>
<span class="nc" id="L57">				isCheckingDupRequest = true;</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">				m_log.warn(&quot;Set Flag: checkDupRequest= &quot; + (isCheckingDupRequest?&quot;true&quot;:&quot;false&quot;));</span>
			} else {
<span class="fc" id="L60">				isCheckingDupRequest = false;</span>
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">				m_log.warn(&quot;Set Flag: checkDupRequest= &quot; + (isCheckingDupRequest?&quot;true&quot;:&quot;false&quot;));</span>
			}
<span class="nc" id="L63">		} catch (Exception ex) {</span>
			//ignore.
<span class="nc" id="L65">			isCheckingDupRequest = false;</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">			m_log.warn(&quot;Set Flag: checkDupRequest= &quot; + (isCheckingDupRequest?&quot;true&quot;:&quot;false&quot;));</span>
<span class="fc" id="L67">		}</span>
<span class="fc" id="L68">	}</span>

<span class="fc" id="L70">	public AppletRH() {</span>
<span class="fc" id="L71">		m_mapAppletIO = new HashMap(2);</span>

<span class="fc" id="L73">		AppletIO io = DefaultAppletIO.getInstance();</span>
<span class="fc" id="L74">		m_mapAppletIO.put(io.getClass().getName(), io);</span>
<span class="fc" id="L75">	}</span>


	public AppletIO getAppletIO(String className) {
<span class="pc bpc" id="L79" title="2 of 4 branches missed.">		if (className == null || &quot;&quot;.equals(className))</span>
<span class="nc" id="L80">			return DefaultAppletIO.getInstance();</span>

<span class="fc" id="L82">		AppletIO io = (AppletIO) m_mapAppletIO.get(className);</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">		if (io == null) {</span>
			try {
<span class="nc" id="L85">				Class clazz = Class.forName(className);</span>
<span class="nc" id="L86">				Method m = clazz.getMethod(&quot;getInstance&quot;, new Class[]{});</span>
<span class="nc" id="L87">				Object instance = m.invoke(null /* static method */, new Object[]{});</span>
<span class="nc" id="L88">				m_mapAppletIO.put(className, instance);</span>
<span class="nc" id="L89">				return (AppletIO)instance;</span>
<span class="nc" id="L90">			} catch (Exception ex) {</span>
<span class="nc" id="L91">				io = DefaultAppletIO.getInstance();</span>
			}
		}
<span class="fc" id="L94">		return io;</span>
	}

	/**
	 * Process Request for the applet
	 */
	public final void handleBackgroundProcessRequest(RequestContext context) throws Exception {
<span class="fc" id="L101">		Map appletResponse = new HashMap(10);</span>

		try {
<span class="fc" id="L104">			String className = context.getRequest().getHeader(AppletIO.REQUEST_CLASS_HEADER);</span>
<span class="fc" id="L105">			AppletIO io = getAppletIO(className);</span>
<span class="fc" id="L106">			Map appletRequest = getAppletRequest(context, io);</span>

<span class="pc bpc" id="L108" title="1 of 2 branches missed.">			if (!io.equals(DefaultAppletIO.getInstance())) {</span>
<span class="nc" id="L109">				convertToDefaultIO(appletRequest, io);</span>
			}

<span class="fc" id="L112">			processAppletRequest(context, appletRequest, appletResponse);</span>
<span class="nc" id="L113">		} catch (Exception ex) {</span>
<span class="nc" id="L114">			handleError(context, ex,</span>
						CoreWebLogBundleKey.APPLET_PROCESS_REQUEST_ERROR,
						CoreWebBundleKey.APPLET_PROCESS_REQUEST_ERROR,
						CoreWebBundleKey.BUNDLE_NAME);
		} finally {
<span class="pc" id="L119">			String className = context.getRequest().getHeader(AppletIO.RESPONSE_CLASS_HEADER);</span>
<span class="pc" id="L120">			AppletIO io = getAppletIO(className);</span>

<span class="pc bpc" id="L122" title="5 of 6 branches missed.">			if (!io.equals(DefaultAppletIO.getInstance())) {</span>
<span class="nc" id="L123">				convertFromDefaultIO(appletResponse, io);</span>
			}
<span class="pc" id="L125">			sendAppletResponse(context, appletResponse, io);</span>
<span class="pc" id="L126">		}</span>
<span class="fc" id="L127">	}</span>

	/**
	 *	Converts the parameter values read from the AppletIO implementation
	 *	into JAVA Objects.
	 *
	 *	NOTE: Up to the sub-class to override.	If sub-class does not accept any
	 *	AppletIO implementation other than the default, then it does not have to
	 *	do anything.
	 */
	protected void convertToDefaultIO(Map map, AppletIO io) {
<span class="nc bnc" id="L138" title="All 2 branches missed.">		if (io.equals(TextAppletIO.getInstance())) {</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">			if (isAppletAction(map, PageAction.APPLET_INIT)) {</span>
<span class="nc" id="L140">				String commands = (String)map.get(PageKeys.APPLET_COMMANDS);</span>
<span class="nc" id="L141">				map.put(PageKeys.APPLET_COMMANDS, TextAppletIO.convertToCollection(commands));</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">			} else if (isAppletAction(map, PageAction.GET_USER_PROPERTIES)) {</span>
<span class="nc" id="L143">				String keys = (String)map.get(PageKeys.PROPERTY_KEYS_COLLECTION);</span>
<span class="nc" id="L144">				map.put(PageKeys.PROPERTY_KEYS_COLLECTION, TextAppletIO.convertToCollection(keys));</span>
				//			} else if (isAppletAction(map, PageAction.GET_USER_PROPERTY)) {
				//				// do nothing
				//			} else if (isAppletAction(map, PageAction.GET_USER_PRIVELEGES)) {
				//				// do nothing
				//			} else if (isAppletAction(map, PageAction.GET_LOCALIZER)) {
				//				// do nothing
<span class="nc bnc" id="L151" title="All 2 branches missed.">			} else if (isAppletAction(map, PageAction.SET_USER_PROPERTIES)) {</span>
<span class="nc" id="L152">				String hashMap = (String)map.get(PageKeys.PROPERTY_HASHMAP);</span>
<span class="nc" id="L153">				map.put(PageKeys.PROPERTY_HASHMAP, TextAppletIO.convertToHashMap(hashMap));</span>
<span class="nc" id="L154">				String persistence = (String)map.get(PageKeys.PROPERTY_PERSISTENCE_FLAG);</span>
<span class="nc" id="L155">				map.put(PageKeys.PROPERTY_PERSISTENCE_FLAG, TextAppletIO.convertToBoolean(persistence));</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">			} else if (isAppletAction(map, PageAction.SET_USER_PROPERTY)) {</span>
<span class="nc" id="L157">				String persistence = (String)map.get(PageKeys.PROPERTY_PERSISTENCE_FLAG);</span>
<span class="nc" id="L158">				map.put(PageKeys.PROPERTY_PERSISTENCE_FLAG, TextAppletIO.convertToBoolean(persistence));</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">			} else if (isAppletAction(map, PageAction.SET_CONTEXT_ATTRIBUTES)) {</span>
				// TODO -  not supported at this point.
<span class="nc bnc" id="L161" title="All 2 branches missed.">			} else if (isAppletAction(map, PageAction.APPLET_LOG_MSG)) {</span>
				// TODO -  not supported at this point.
			}
		}
<span class="nc" id="L165">	}</span>

	/**
	 *	Converts the response parameter values from JAVA objects to the client's expected response
	 *	AppletIO implementation type.
	 *
	 *	NOTE: Up to the sub-class to override.	If the client accepts nothing other than
	 *	the default AppletIO implementation as the server response, then it does not have to
	 *	do anything.
	 */
	protected void convertFromDefaultIO(Map map, AppletIO io) {
		// default behavior is to do nothing
<span class="nc" id="L177">	}</span>

	/**
	 *	Subclass to override this method.  Each applet will have its own
	 *	set of user properties that it needs during initialization.	 The
	 *	set of user properties should be put into a HashMap, with its keys
	 *	being the property names, and its properties being the values.
	 */
	protected Map getInitUserProperties(RequestContext context) {
<span class="fc" id="L186">		return Collections.EMPTY_MAP;</span>
	}

	protected Map getUserProperties(RequestContext context, Map map) {
<span class="fc" id="L190">		Collection propertyKeys = (Collection)map.get(PageKeys.PROPERTY_KEYS_COLLECTION);</span>
<span class="fc" id="L191">		HashMap mapProperties = new HashMap(propertyKeys.size() * 2);</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">		for (Iterator iter = propertyKeys.iterator(); iter.hasNext();) {</span>
<span class="fc" id="L193">			String nextKey = (String) iter.next();</span>
<span class="fc" id="L194">			String nextProperty = context.getUserProperty(nextKey);</span>
<span class="fc" id="L195">			mapProperties.put(nextKey, nextProperty);</span>
<span class="fc" id="L196">		}</span>
<span class="fc" id="L197">		return mapProperties;</span>
	}

	protected String getUserProperty(RequestContext context, Map map) {
<span class="fc" id="L201">		String key = (String)map.get(PageKeys.PROPERTY_KEY);</span>
<span class="fc" id="L202">		return context.getUserProperty(key);</span>
	}

	protected User getUser(RequestContext context) {
		try{
<span class="fc" id="L207">			return UserConverter.convertUser(context.getUser(), null, context.isInWhatIfMode());</span>
<span class="nc" id="L208">		} catch (Exception ex){</span>
<span class="nc" id="L209">			m_log.l7dError(CoreWebLogBundleKey.UNKNOWN_USER_SECURITY_ERROR, ex);</span>
		}
<span class="nc" id="L211">		return null;</span>
	}

	protected void setUserProperties(RequestContext context, Map map) {
<span class="fc" id="L215">		HashMap mapProperties = (HashMap)map.get(PageKeys.PROPERTY_HASHMAP);</span>
<span class="fc" id="L216">		Boolean persistence = (Boolean)map.get(PageKeys.PROPERTY_PERSISTENCE_FLAG);</span>
<span class="fc" id="L217">		context.setUserProperties(mapProperties, persistence.booleanValue(), persistence.booleanValue());</span>
<span class="fc" id="L218">	}</span>

	protected void setUserProperty(RequestContext context, Map map) {
<span class="fc" id="L221">		String key = (String) map.get(PageKeys.PROPERTY_KEY);</span>
<span class="fc" id="L222">		String property = (String) map.get(PageKeys.PROPERTY_VALUE);</span>
<span class="fc" id="L223">		Boolean persistence = (Boolean)map.get(PageKeys.PROPERTY_PERSISTENCE_FLAG);</span>
<span class="fc" id="L224">		context.setUserProperty(key, property, persistence.booleanValue(), persistence.booleanValue());</span>
<span class="fc" id="L225">	}</span>

	protected void setContextAttributes(RequestContext context, Map map) {
<span class="nc" id="L228">		Integer scope = (Integer) map.get(PageKeys.REQUEST_CONTEXT_ATTRIBUTES_SCOPE);</span>
<span class="nc" id="L229">		HashMap mapAttributes = (HashMap) map.get(PageKeys.REQUEST_CONTEXT_ATTRIBUTES_HASHMAP);</span>
<span class="nc bnc" id="L230" title="All 4 branches missed.">		if (mapAttributes != null &amp;&amp; scope != null) {</span>
<span class="nc" id="L231">			Iterator itKeys = mapAttributes.keySet().iterator();</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">			while (itKeys.hasNext()) {</span>
<span class="nc" id="L233">				String nextKey = (String) itKeys.next();</span>
<span class="nc" id="L234">				Object nextValue = mapAttributes.get(nextKey);</span>
<span class="nc" id="L235">				context.setAttribute(scope.intValue(), nextKey, nextValue);</span>
<span class="nc" id="L236">			}</span>
		}
<span class="nc" id="L238">	}</span>

	/**
	 * Process Applet Request
	 *
	 * @param context - The Request Context
	 * @param appletRequest - Map containing Applet Request Information
	 * @param appletResponse - Map containing Response to be send to Applet
	 */
	protected void processAppletRequest(RequestContext context, Map&lt;? extends Object, ? extends Object&gt; appletRequest, Map&lt;Object,Object&gt; appletResponse) {
<span class="fc bfc" id="L248" title="All 2 branches covered.">		if (isAppletAction(appletRequest, PageAction.APPLET_INIT)) {</span>
<span class="fc" id="L249">			Collection commands = (Collection)appletRequest.get(PageKeys.APPLET_COMMANDS);</span>
<span class="fc" id="L250">			HashMap mapProperties = new HashMap(commands.size() * 2);</span>

<span class="fc bfc" id="L252" title="All 2 branches covered.">			for (Iterator iter = commands.iterator(); iter.hasNext();) {</span>
<span class="fc" id="L253">				String command = (String) iter.next();</span>

<span class="fc" id="L255">				Object obj = null;</span>

<span class="fc bfc" id="L257" title="All 2 branches covered.">				if (command.equals(GET_LOCALE_CONTEXT)) {</span>
<span class="fc" id="L258">					obj = context.getLocaleContext();</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">				} else if (command.equals(PageAction.GET_USER_PRIVELEGES)) {</span>
<span class="fc" id="L260">					obj = getUser(context);</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">				} else if (command.equals(PageAction.GET_USER_PROPERTIES)) {</span>
<span class="fc" id="L262">					obj = getInitUserProperties(context);</span>
				} else {
<span class="fc" id="L264">					obj = getAppletInitData(context, appletRequest, appletResponse, command);</span>
				}

<span class="fc bfc" id="L267" title="All 2 branches covered.">				if (obj != null)</span>
<span class="fc" id="L268">					mapProperties.put(command + PageKeys.APPLET_RESPONSE, obj);</span>
<span class="fc" id="L269">			}</span>
<span class="fc" id="L270">			addResponseData(mapProperties, appletResponse);</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">		} else if (isAppletAction(appletRequest, PageAction.GET_USER_PROPERTIES)) {</span>
<span class="fc" id="L272">			addResponseData(getUserProperties(context, appletRequest), appletResponse);</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">		} else if (isAppletAction(appletRequest, PageAction.GET_USER_PROPERTY)) {</span>
<span class="fc" id="L274">			addResponseData(getUserProperty(context, appletRequest), appletResponse);</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">		} else if (isAppletAction(appletRequest, PageAction.GET_USER_PRIVELEGES)) {</span>
<span class="nc" id="L276">			addResponseData(getUser(context), appletResponse);</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">		} else if (isAppletAction(appletRequest, PageAction.SET_USER_PROPERTIES)) {</span>
<span class="fc" id="L278">			setUserProperties(context, appletRequest);</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">		} else if (isAppletAction(appletRequest, PageAction.SET_USER_PROPERTY)) {</span>
<span class="fc" id="L280">			setUserProperty(context, appletRequest);</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">		} else if (isAppletAction(appletRequest, PageAction.SET_CONTEXT_ATTRIBUTES)) {</span>
<span class="nc" id="L282">			setContextAttributes(context, appletRequest);</span>
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">		} else if (isAppletAction(appletRequest, PageAction.APPLET_LOG_MSG)) {</span>
<span class="nc" id="L284">			processLogAppletMsg(context, appletRequest);</span>
		}
<span class="fc" id="L286">	}</span>

	/**
	 * Return Applet Action stored in AppletRequest Map
	 */
	protected String getAppletAction(Map appletRequest) {
<span class="fc" id="L292">		return (String)appletRequest.get(PageAction.APPLET_ACTION);</span>
	}

	/**
	 * Return true if Applet Action is of the specified action.
	 * @param appletRequest - Applet Request Map
	 * @param action - Action to match
	 * @return true if action matches otherwise false.
	 */
	protected boolean isAppletAction(Map appletRequest, String action) {
<span class="fc" id="L302">		String appletAction = getAppletAction(appletRequest);</span>
<span class="fc" id="L303">		return action.equals(appletAction);</span>
	}

	/**
	 * Notify Client of Error
	 *
	 * @param appletResponse
	 */
	protected void notifyClientOfError(Map appletResponse) {
<span class="nc" id="L312">		appletResponse.put(PageKeys.APPLET_ERROR, ERROR_RESPONSE_CODE);</span>
<span class="nc" id="L313">	}</span>

	/**
	 * Add a main object to be send to the applet.
	 * This is a short cut when only one object needs to be send.
	 *
	 * @param obj The object to be send to the applet.
	 */
	protected void addResponseData(Object obj, Map appletResponse) {
<span class="fc" id="L322">		appletResponse.put(PageKeys.APPLET_DATA, obj);</span>
<span class="fc" id="L323">	}</span>

	/**
	 * Log Message that occured in the applet side.
	 */
	protected void processLogAppletMsg(RequestContext context, Map appletRequest) {
<span class="nc" id="L329">		AppletMessage aMsg = (AppletMessage)appletRequest.get(PageKeys.APPLET_MESSAGE);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">		if (aMsg!=null) {</span>
<span class="nc bnc" id="L331" title="All 6 branches missed.">			switch(aMsg.getType()) {</span>
			case AppletMessage.FATAL:
<span class="nc" id="L333">				m_log.fatal(aMsg.getFullMsg(), aMsg.getException());</span>
<span class="nc" id="L334">				break;</span>
			case AppletMessage.ERROR:
<span class="nc" id="L336">				m_log.error(aMsg.getFullMsg(), aMsg.getException());</span>
<span class="nc" id="L337">				break;</span>
			case AppletMessage.WARNING:
<span class="nc" id="L339">				m_log.warn(aMsg.getFullMsg(), aMsg.getException());</span>
<span class="nc" id="L340">				break;</span>
			case AppletMessage.INFO:
<span class="nc" id="L342">				m_log.info(aMsg.getFullMsg(), aMsg.getException());</span>
<span class="nc" id="L343">				break;</span>
			case AppletMessage.DEBUG:
<span class="nc" id="L345">				m_log.debug(aMsg.getFullMsg(), aMsg.getException());</span>
<span class="nc" id="L346">				break;</span>
			default:
<span class="nc" id="L348">				m_log.l7dError(CoreWebLogBundleKey.UNKNOWN_APPLET_MSG_TYPE_MF, new Object[]{aMsg.getFullMsg()}, aMsg.getException());</span>
			}
		}
<span class="nc" id="L351">	}</span>

	/**
	 * Handle Error which logs and notifies Applet of error
	 */
	protected void handleError(RequestContext context, Exception ex, String logRBKey, String msgID, String msgBundle) {
<span class="nc" id="L357">		Localizer localizer = context.getLocalizer();</span>

<span class="nc" id="L359">		ResourceBundle bundle = localizer.getBundle(msgBundle);</span>
<span class="nc" id="L360">		String msg = localizer.i18n(bundle, msgID);</span>

<span class="nc bnc" id="L362" title="All 2 branches missed.">		if (ex==null) m_log.l7dError(logRBKey); else m_log.error(logRBKey, ex);</span>
<span class="nc" id="L363">		context.addPageMessage(new Message(Message.ERROR_TYPE, msg));</span>

<span class="nc" id="L365">		Map appletResponse = (Map)context.getAttribute(RequestContext.REQUEST_SCOPE, APPLET_RESPONSE);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">		if (appletResponse!=null)	notifyClientOfError(appletResponse);</span>
<span class="nc" id="L367">	}</span>

	//////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	//////////////////////////////////////////////////////////////////////////////
	/**
	 * Retrieve request from Applet
	 *
	 * @param context - The context of the request
	 * @return Map containing Applet Request
	 */
	private Map getAppletRequest(RequestContext context, AppletIO io) {
<span class="fc" id="L379">		Map appletResponse = Collections.EMPTY_MAP;</span>

		try {
<span class="fc" id="L382">			InputStream in = context.getRequest().getInputStream();</span>
<span class="fc" id="L383">			appletResponse = io.read(in);</span>
<span class="nc" id="L384">		} catch (Exception ex) {</span>
<span class="nc" id="L385">			m_log.l7dError(CoreWebLogBundleKey.APPLET_UNABLE_TOGET_REQUEST, ex);</span>
<span class="fc" id="L386">		}</span>

<span class="fc" id="L388">		return appletResponse;</span>
	}

	/**
	 * Send results back to the applet.
	 *
	 * @param context - The context of the request.
	 * @param appletResponse - Map containing applet
	 */
	private void sendAppletResponse(RequestContext context, Map appletResponse, AppletIO io) {
		try {
<span class="fc" id="L399">			processPageMsg(context, appletResponse);</span>
<span class="fc" id="L400">			OutputStream out = context.getResponse().getOutputStream();</span>
<span class="fc" id="L401">			io.write(out, appletResponse);</span>
<span class="nc" id="L402">		} catch(IOException ex) {</span>
<span class="nc" id="L403">			m_log.l7dError(CoreWebLogBundleKey.APPLET_PROCESS_REQUEST_ERROR, ex);</span>
<span class="fc" id="L404">		}</span>
<span class="fc" id="L405">	}</span>

	/**
	 * Process Page Message to be passed to Applet through Reponse Map
	 * @param context
	 * @param appletResponse
	 */
	private static void processPageMsg(RequestContext context, Map appletResponse) {
<span class="fc" id="L413">		Collection messages = context.getPageMessages();</span>
<span class="pc bpc" id="L414" title="1 of 2 branches missed.">		if ( messages.isEmpty() ) return;</span>

<span class="nc" id="L416">		StringBuffer sb = new StringBuffer(512);</span>
<span class="nc" id="L417">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L418">		Iterator pageMessages = messages.iterator();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">		while (pageMessages.hasNext()) {</span>
<span class="nc" id="L420">			Message pageMsg = (Message)pageMessages.next();</span>
<span class="nc" id="L421">			sb.append(&quot;&lt;div class='&quot;).append(pageMsg.getMessageStyle()).append(&quot;'&gt;&quot;);</span>
<span class="nc" id="L422">			sb.append(pageMsg.getLocalizedMessage(localizer));</span>
<span class="nc" id="L423">			sb.append(&quot;&lt;/div&gt;&quot;);</span>
<span class="nc" id="L424">		}</span>
<span class="nc" id="L425">		appletResponse.put(PageKeys.APPLET_MESSAGE, sb.toString());</span>
<span class="nc" id="L426">	}</span>
	
	/**
	 * If applets have special data they need to store in their applet init info (accessible
	 * via getAppletInitInfo() or getCachedAppletInitInfo() in ServerRequest) the applet's
	 * request handler can override this method to process the additional commands for the init
	 * info that will be coming in (these commands are generally added via the applet's subclassed
	 * version of ServerRequest via the getAppletInitCommands() method).
	 */
	protected Object getAppletInitData(RequestContext context, Map appletRequest,
			Map appletResponse, String command) {
<span class="nc" id="L437">		return null;</span>
	}
	
	private void checkCacheUsage(RequestContext context) { //reset cache for start or stop
<span class="nc" id="L441">		String dupCheck = context.getParameter(&quot;DupCheck&quot;); //htt://appserver:7001/wfo/control/pulse_ap?DupCheck=true</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">		if (dupCheck == null)</span>
<span class="nc" id="L443">			return; //no change on the flag.</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">		if (dupCheck.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L445">			isCheckingDupRequest = true;</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">			m_log.warn(&quot;Set Flag: checkDupRequest= &quot; + (isCheckingDupRequest?&quot;true&quot;:&quot;false&quot;));</span>
		} else {
<span class="nc" id="L448">			isCheckingDupRequest = false;</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">			m_log.warn(&quot;Set Flag: checkDupRequest= &quot; + (isCheckingDupRequest?&quot;true&quot;:&quot;false&quot;));</span>
		}
<span class="nc" id="L451">		pendingRequestPerUser.clear();</span>
<span class="nc" id="L452">	}</span>
	
	public boolean pushRequest(RequestContext context, Map request) {
<span class="nc" id="L455">		checkCacheUsage(context);</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">		if (!isCheckingDupRequest)</span>
<span class="nc" id="L457">			return true;</span>
		
<span class="nc" id="L459">		String userName = context.getUserName();</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">		if (userName == null)</span>
<span class="nc" id="L461">			return false;</span>
<span class="nc" id="L462">		HashSet pendingRequest = (HashSet)pendingRequestPerUser.get(userName);</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">		if (pendingRequest == null) {</span>
<span class="nc" id="L464">			pendingRequest = new HashSet();</span>
<span class="nc" id="L465">			pendingRequestPerUser.put(userName, pendingRequest);</span>
		}
<span class="nc bnc" id="L467" title="All 2 branches missed.">		if (pendingRequest.contains(request)) {</span>
<span class="nc" id="L468">			m_log.warn(&quot;found dup request: &quot; + request);</span>
<span class="nc" id="L469">			return false;</span>
		}
<span class="nc" id="L471">		pendingRequest.add(request);</span>
<span class="nc" id="L472">		return true;</span>
	}
	
	public void popRequest(RequestContext context, Map request) {
<span class="nc bnc" id="L476" title="All 2 branches missed.">		if (!isCheckingDupRequest)</span>
<span class="nc" id="L477">			return;</span>
		
<span class="nc" id="L479">		String userName = context.getUserName();</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">		if (userName == null)</span>
<span class="nc" id="L481">			return;</span>
<span class="nc" id="L482">		HashSet pendingRequest = (HashSet)pendingRequestPerUser.get(userName);</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">		if (pendingRequest != null)</span>
<span class="nc" id="L484">			pendingRequest.remove(request);</span>
<span class="nc" id="L485">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>