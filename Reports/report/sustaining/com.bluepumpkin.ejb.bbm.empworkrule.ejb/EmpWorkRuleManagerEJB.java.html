<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EmpWorkRuleManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.empworkrule.ejb</a> &gt; <span class="el_source">EmpWorkRuleManagerEJB.java</span></div><h1>EmpWorkRuleManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.empworkrule.ejb;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.TreeSet;

import javax.naming.Context;
import javax.naming.InitialContext;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.PaginationPair;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.empworkrule.model.*;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkUnit.WorkUnitType;
import com.bluepumpkin.ejb.bbm.paypolicy.ejb.PayPolicyManager;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourcePayPolicy;
import com.bluepumpkin.ejb.bbm.workrules.ejb.ComplexWorkRuleDAO;
import com.bluepumpkin.ejb.bbm.workrules.ejb.RotationDAO;
import com.bluepumpkin.ejb.bbm.workrules.ejb.TimeBankDAO;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRuleFieldInfo;
import com.bluepumpkin.ejb.bbm.workrules.model.Rotation;
import com.bluepumpkin.ejb.bbm.workrules.model.TimeBank;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.verint.ejb.wfm.WfmManagerFactory;

@SuppressWarnings(&quot;serial&quot;)
<span class="nc" id="L57">public class EmpWorkRuleManagerEJB extends SessionEJBBase {</span>

<span class="nc" id="L59">	private static Category m_cat = Log.initCategory(EmpWorkRuleManagerEJB.class.getName());</span>
<span class="nc" id="L60">	private boolean isWhatIf = false;</span>
	private WorkResourceManager workResourceManager;
	private WorkRuleManager workRuleManager;

	/** override the base class to provide the appropriate logging category */
	@Override
	protected Category getCategory() {
<span class="nc" id="L67">		return m_cat;</span>
	}

	{
<span class="nc" id="L71">		super.init(EmpWorkRuleManagerEJB.class.getName());</span>
<span class="nc" id="L72">	}</span>

	/**
	 * Perform one-time initialization of this EJB instance
	 */
	@Override
	public void onEjbCreate() {
		try {
			// First query environment to get WIF setting from DD
<span class="nc" id="L81">			Context initialContext = new InitialContext();</span>
<span class="nc" id="L82">			Boolean WIF = (Boolean) initialContext.lookup(&quot;java:comp/env/WIF&quot;);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">			if (WIF != null) {</span>
<span class="nc" id="L84">				isWhatIf = WIF.booleanValue();</span>
			}

<span class="nc" id="L87">			workResourceManager = BbmManagerFactory.getWorkResourceManager(isWhatIf);</span>
<span class="nc" id="L88">			workRuleManager = WfmManagerFactory.getWorkRuleManager(isWhatIf);</span>
<span class="nc" id="L89">		} catch (Exception e) {</span>
<span class="nc" id="L90">			handleException(&quot;onEjbCreate&quot;, e, false);</span>
<span class="nc" id="L91">		}</span>
<span class="nc" id="L92">	}</span>

	/**************************************************************************
	 * functions for work pattern assignments
	 **************************************************************************/
	/**
	 * get a given work resource's work pattern assignments
	 *
	 * @idWorkResource work resource id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of WorkResourceWorkPattern objects which hold the
	 *         assignment information
	 */
	public Collection&lt;WorkResourceWorkPattern&gt; getWorkPatternAssignments(ID idWorkResource, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L108">		methodStart(&quot;getWorkPatternAssignments&quot;, idWorkResource, dtStart, dtEnd);</span>
<span class="nc" id="L109">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L111">			return dao.getWorkPatternAssignments(idWorkResource, dtStart, dtEnd);</span>
<span class="nc" id="L112">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L113">			handleException(e, false);</span>
<span class="nc" id="L114">			throw e;</span>
		} finally {
<span class="nc" id="L116">			dao.cleanUp();</span>
<span class="nc" id="L117">			methodFinish();</span>
		}
	}

	/**
	 * This method is similar to getWorkPatternAssignments(ID idWorkResource,
	 * Date dtStart, Date dtEnd), however that method does not populate the SIDs
	 * of the WorkResourceWorkPattern value objects, whereas this one does. This
	 * method was added rather than refactoring getWorkPatternAssignments since
	 * that method might be used by the FS client.
	 */
	public Collection&lt;WorkResourceWorkPattern&gt; getWorkPatternAssignmentsForEmployee(ID idWorkResource, Date dtStart,
			Date dtEnd) throws BbmFinderException {
<span class="nc" id="L130">		methodStart(&quot;getWorkPatternAssignmentsForEmployee&quot;, idWorkResource, dtStart, dtEnd);</span>
<span class="nc" id="L131">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L133">			HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; assignments = getWorkPatternAssignments(</span>
<span class="nc" id="L134">					Collections.singleton(idWorkResource), dtStart, dtEnd);</span>

<span class="nc" id="L136">			return assignments.get(idWorkResource);</span>
<span class="nc" id="L137">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L138">			handleException(e, false);</span>
<span class="nc" id="L139">			throw e;</span>
		} finally {
<span class="nc" id="L141">			dao.cleanUp();</span>
<span class="nc" id="L142">			methodFinish();</span>
		}
	}

	/**
	 * get a given work resource's work pattern assignments
	 *
	 * @colWorkResourceIDs a collection of work resource ids
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a HashMap of following pairs (idWorkResource, array list of
	 *         workresource's workpattern assignments)
	 */
	public HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; getWorkPatternAssignments(
			Collection&lt;ID&gt; colWorkResourceIDs, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L157">		methodStart(&quot;getWorkPatternAssignments&quot;, colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L158">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L160">			return dao.getWorkPatternAssignments(colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L161">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L162">			handleException(e, false);</span>
<span class="nc" id="L163">			throw e;</span>
		} finally {
<span class="nc" id="L165">			dao.cleanUp();</span>
<span class="nc" id="L166">			methodFinish();</span>
		}
	}

	/**
	 * get a list of work pattern assignment given their IDs
	 */
	public Collection getWorkPatternAssignmentsByIDs(Collection colIDSAs) throws BbmFinderException {
<span class="nc" id="L174">		methodStart(&quot;getWorkPatternAssignmentsByIDs&quot;, colIDSAs);</span>
<span class="nc" id="L175">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L177">			return dao.getWorkPatternAssignmentsByIDs(colIDSAs);</span>
<span class="nc" id="L178">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L179">			handleException(e, false);</span>
<span class="nc" id="L180">			throw e;</span>
		} finally {
<span class="nc" id="L182">			dao.cleanUp();</span>
<span class="nc" id="L183">			methodFinish();</span>
		}
	}

	/** create a work pattern assignment */
	public ID createWorkPatternAssignment(WorkResourceWorkPattern objValue) throws BbmCreateException {
<span class="nc" id="L189">		methodStart(&quot;createWorkPatternAssignment&quot;, objValue);</span>
<span class="nc" id="L190">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L192">			return dao.createWorkPatternAssignment(objValue);</span>
<span class="nc" id="L193">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L194">			handleException(e);</span>
<span class="nc" id="L195">			throw e;</span>
		} finally {
<span class="nc" id="L197">			dao.cleanUp();</span>
<span class="nc" id="L198">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; createWorkPatternAssignments(Collection&lt;WorkResourceWorkPattern&gt; wrwps)
			throws BbmCreateException {
<span class="nc" id="L204">		methodStart(&quot;createWorkPatternAssignments&quot;, wrwps);</span>
<span class="nc" id="L205">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
<span class="nc" id="L206">		Collection&lt;ID&gt; wrwpIDs = new ArrayList&lt;ID&gt;();</span>
		try {
<span class="nc bnc" id="L208" title="All 2 branches missed.">			for (WorkResourceWorkPattern wrwp : wrwps) {</span>
<span class="nc" id="L209">				wrwp.setCreatedBy(m_sessionContext.getCallerPrincipal().getName());</span>
<span class="nc" id="L210">				wrwp.setCreatedDate(new Date(System.currentTimeMillis()));</span>
<span class="nc" id="L211">				wrwpIDs.add(dao.createWorkPatternAssignment(wrwp));</span>
<span class="nc" id="L212">			}</span>
<span class="nc" id="L213">			return wrwpIDs;</span>
<span class="nc" id="L214">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L215">			handleException(e);</span>
<span class="nc" id="L216">			throw e;</span>
		} finally {
<span class="nc" id="L218">			dao.cleanUp();</span>
<span class="nc" id="L219">			methodFinish();</span>
		}
	}

	/** save a work pattern assignment */
	public void updateWorkPatternAssignment(WorkResourceWorkPattern objValue, boolean bSaveAsNew)
			throws MultiUserException, BbmUpdateException {
<span class="nc" id="L226">		methodStart(&quot;updateWorkPatternAssignment&quot;, objValue);</span>
<span class="nc" id="L227">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L229">			objValue.setModifiedBy(m_sessionContext.getCallerPrincipal().getName());</span>
<span class="nc" id="L230">			objValue.setModifiedDate(new Date(System.currentTimeMillis()));</span>
<span class="nc" id="L231">			dao.updateWorkPatternAssignment(objValue, bSaveAsNew);</span>
<span class="nc" id="L232">		} catch (MultiUserException e) {</span>
<span class="nc" id="L233">			handleException(e);</span>
<span class="nc" id="L234">			throw e;</span>
<span class="nc" id="L235">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L236">			handleException(e);</span>
<span class="nc" id="L237">			throw e;</span>
		} finally {
<span class="nc" id="L239">			dao.cleanUp();</span>
<span class="nc" id="L240">			methodFinish();</span>
<span class="nc" id="L241">		}</span>
<span class="nc" id="L242">	}</span>

	/** delete work pattern assignments given their assignment ids */
	public void deleteWorkPatternAssignments(Collection&lt;ID&gt; colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L246">		methodStart(&quot;deleteWorkPatternAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L247">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L249">			dao.deleteWorkPatternAssignments(colIDAssignments);</span>
<span class="nc" id="L250">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L251">			handleException(e);</span>
<span class="nc" id="L252">			throw e;</span>
		} finally {
<span class="nc" id="L254">			dao.cleanUp();</span>
<span class="nc" id="L255">			methodFinish();</span>
<span class="nc" id="L256">		}</span>
<span class="nc" id="L257">	}</span>

	/**
	 * This method will delete the work pattern assignments in
	 * assignmentsToDelete, and will create new assignments for the assignments
	 * in assignmentsToCreate.
	 */
	public void saveWorkPatternAssignments(Collection&lt;WorkResourceWorkPattern&gt; assignmentsToDelete,
			Collection&lt;WorkResourceWorkPattern&gt; assignmentsToCreate) throws BbmCreateException {

<span class="nc" id="L267">		methodStart(&quot;saveWorkPatternAssignments&quot;, assignmentsToDelete, assignmentsToCreate);</span>
<span class="nc" id="L268">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
			// To delete a workresourceworkpattern, set its preference value to
			// 0 and set IsActive to false
<span class="nc bnc" id="L272" title="All 2 branches missed.">			for (WorkResourceWorkPattern assignment : assignmentsToDelete) {</span>
<span class="nc" id="L273">				assignment.setIsActive(false);</span>
<span class="nc" id="L274">				assignment.setPreference(0);</span>
<span class="nc" id="L275">			}</span>
			// Deleting assignments can be thought of as &quot;creating&quot; an
			// assignment that is not actually assigned,
			// in other words subtracting from any assignment that may intersect
			// the date range of the assignment
			// we are trying to delete.
<span class="nc" id="L281">			createWorkPatternAssignments(assignmentsToDelete);</span>
<span class="nc" id="L282">			createWorkPatternAssignments(assignmentsToCreate);</span>
<span class="nc" id="L283">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L284">			handleException(e);</span>
<span class="nc" id="L285">			throw e;</span>
		} finally {
<span class="nc" id="L287">			dao.cleanUp();</span>
<span class="nc" id="L288">			methodFinish();</span>
<span class="nc" id="L289">		}</span>
<span class="nc" id="L290">	}</span>

	/**************************************************************************
	 * functions for time bank assignments
	 **************************************************************************/
	/**
	 * get a given employee's time bank assignments
	 *
	 * @idEmployee employee id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of EmpTimeBank objects which hold the assignment
	 *         information
	 */
	public Collection getTimeBankAssignments(ID idEmployee, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L305">		methodStart(&quot;getTimeBankAssignments&quot;, idEmployee, dtStart, dtEnd);</span>
<span class="nc" id="L306">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L308">			return dao.getTimeBankAssignments(idEmployee, dtStart, dtEnd);</span>
<span class="nc" id="L309">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L310">			handleException(e, false);</span>
<span class="nc" id="L311">			throw e;</span>
		} finally {
<span class="nc" id="L313">			dao.cleanUp();</span>
<span class="nc" id="L314">			methodFinish();</span>
		}
	}

	/**
	 * get a collection of employees' time bank assignments
	 *
	 * @colEmployeeIDs a collection of employee ids
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a HashMap of following pairs (idEmployee, array list of
	 *         EmpTimeBank (i.e. the employee's time bank assignments))
	 */
	public HashMap&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; getTimeBankAssignments(Collection&lt;ID&gt; colEmployeeIDs, Date dtStart,
			Date dtEnd) throws BbmFinderException {
<span class="nc" id="L329">		methodStart(&quot;getTimeBankAssignments&quot;, colEmployeeIDs, dtStart, dtEnd);</span>
<span class="nc" id="L330">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L332">			return dao.getTimeBankAssignments(colEmployeeIDs, dtStart, dtEnd);</span>
<span class="nc" id="L333">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L334">			handleException(e, false);</span>
<span class="nc" id="L335">			throw e;</span>
		} finally {
<span class="nc" id="L337">			dao.cleanUp();</span>
<span class="nc" id="L338">			methodFinish();</span>
		}
	}

	/**
	 * get a list of time bank assignment given their IDs
	 */
	public Collection getTimeBankAssignmentsByIDs(Collection colIDSAs) throws BbmFinderException {
<span class="nc" id="L346">		methodStart(&quot;getTimeBankAssignmentsByIDs&quot;, colIDSAs);</span>
<span class="nc" id="L347">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L349">			return dao.getTimeBankAssignmentsByIDs(colIDSAs);</span>
<span class="nc" id="L350">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L351">			handleException(e, false);</span>
<span class="nc" id="L352">			throw e;</span>
		} finally {
<span class="nc" id="L354">			dao.cleanUp();</span>
<span class="nc" id="L355">			methodFinish();</span>
		}
	}

	/** create a time bank assignment */
	public ID createTimeBankAssignment(EmpTimeBank objValue) throws BbmCreateException {
<span class="nc" id="L361">		methodStart(&quot;createTimeBankAssignment&quot;, objValue);</span>
<span class="nc" id="L362">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L364">			return dao.createTimeBankAssignment(objValue);</span>
<span class="nc" id="L365">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L366">			handleException(e);</span>
<span class="nc" id="L367">			throw e;</span>
		} finally {
<span class="nc" id="L369">			dao.cleanUp();</span>
<span class="nc" id="L370">			methodFinish();</span>
		}
	}

	/**
	 * Creates a time bank assignment, but prior to creation will remove any
	 * existing time banks that overlap with the given time bank for the given
	 * employee.
	 */
	public ID createTimeBankAssignmentWithNoOverlap(EmpTimeBank objValue) throws BbmCreateException {
<span class="nc" id="L380">		methodStart(&quot;createTimeBankAssignmentWithNoOverlap&quot;, objValue);</span>
<span class="nc" id="L381">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L383">			return dao.createTimeBankAssignmentWithNoOverlap(objValue);</span>
<span class="nc" id="L384">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L385">			handleException(e);</span>
<span class="nc" id="L386">			throw e;</span>
		} finally {
<span class="nc" id="L388">			dao.cleanUp();</span>
<span class="nc" id="L389">			methodFinish();</span>
		}
	}

	/** save a time bank assignment */
	public void updateTimeBankAssignment(EmpTimeBank objValue, boolean bSaveAsNew) throws MultiUserException,
			BbmUpdateException {
<span class="nc" id="L396">		methodStart(&quot;updateTimeBankAssignment&quot;, objValue);</span>
<span class="nc" id="L397">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L399">			dao.updateTimeBankAssignment(objValue, bSaveAsNew);</span>
<span class="nc" id="L400">		} catch (MultiUserException e) {</span>
<span class="nc" id="L401">			handleException(e);</span>
<span class="nc" id="L402">			throw e;</span>
<span class="nc" id="L403">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L404">			handleException(e);</span>
<span class="nc" id="L405">			throw e;</span>
		} finally {
<span class="nc" id="L407">			dao.cleanUp();</span>
<span class="nc" id="L408">			methodFinish();</span>
<span class="nc" id="L409">		}</span>
<span class="nc" id="L410">	}</span>

	/** delete time bank assignments given their assignment ids */
	public void deleteTimeBankAssignments(Collection colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L414">		methodStart(&quot;deleteTimeBankAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L415">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L417">			dao.deleteTimeBankAssignments(colIDAssignments);</span>
<span class="nc" id="L418">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L419">			handleException(e);</span>
<span class="nc" id="L420">			throw e;</span>
		} finally {
<span class="nc" id="L422">			dao.cleanUp();</span>
<span class="nc" id="L423">			methodFinish();</span>
<span class="nc" id="L424">		}</span>
<span class="nc" id="L425">	}</span>

	/**
	 * Returns a collection of PaginationPair objects with TimeBank data (used
	 * for pagination). The time banks returned will be the time banks that are
	 * available to be assigned to ALL of the given employees (workResourceIDs)
	 * for the date range between startDate and endDate. This is used when
	 * adding new time bank assignments to employees.
	 */
	public PaginationPair&lt;TimeBank&gt; getAvailableTimeBanksForEmployees(Collection&lt;ID&gt; workResourceIDs, Date startDate,
			Date endDate, boolean isAscendingSort, int pageIDSize, int pageIndex,
			LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap, Collection&lt;ID&gt; filteredIDs) throws BbmFinderException {
<span class="nc" id="L437">		methodStart(&quot;getAvailableTimeBanksForEmployees&quot;, workResourceIDs, startDate, endDate);</span>
<span class="nc" id="L438">		TimeBankDAO dao = new TimeBankDAO();</span>
		try {
<span class="nc" id="L440">			Collection&lt;ID&gt; orgIDsAndParents = workResourceManager.getOrgIDsThatMayOwnFlowDownObjects(workResourceIDs,</span>
					startDate, endDate);
<span class="nc" id="L442">			return dao.getAvailableTimeBanksForEmployees(orgIDsAndParents, workResourceIDs, startDate, endDate,</span>
					isAscendingSort, pageIDSize, pageIndex, sortFieldMap, filteredIDs);
<span class="nc" id="L444">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L445">			handleException(e, false);</span>
<span class="nc" id="L446">			throw e;</span>
<span class="nc" id="L447">		} catch (Exception e) {</span>
<span class="nc" id="L448">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L450">			dao.cleanUp();</span>
<span class="nc" id="L451">			methodFinish();</span>
		}
	}

	/**************************************************************************
	 * functions for min-max hour assignments
	 **************************************************************************/
	/**
	 * get a given work resource's min-max hour assignments
	 *
	 * @idWorkResource work resource id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of WorkResourceMinMaxHour objects which hold the
	 *         assignment information
	 */
	public Collection&lt;WorkResourceMinMaxHour&gt; getMinMaxHourAssignments(ID idWorkResource, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L469">		methodStart(&quot;getMinMaxHourAssignments&quot;, idWorkResource, dtStart, dtEnd);</span>
<span class="nc" id="L470">		WorkResourceMinMaxHourDAO dao = new WorkResourceMinMaxHourDAO();</span>
		try {
<span class="nc" id="L472">			List&lt;ID&gt; aWorkResources = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L473">			aWorkResources.add(idWorkResource);</span>
<span class="nc" id="L474">			return dao.getMinMaxHourAssignments(aWorkResources, dtStart, dtEnd).get(idWorkResource);</span>
<span class="nc" id="L475">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L476">			handleException(e, false);</span>
<span class="nc" id="L477">			throw e;</span>
		} finally {
<span class="nc" id="L479">			dao.cleanUp();</span>
<span class="nc" id="L480">			methodFinish();</span>
		}
	}

	/**
	 * get a collection of workresources' min-max hour assignments
	 *
	 * @colWorkResourceIDs a collection of work resource ids
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a HashMap of following pairs (idWorkResource, array list of
	 *         WorkResourceMinMaxHour objects)
	 */
	public HashMap&lt;ID, List&lt;WorkResourceMinMaxHour&gt;&gt; getMinMaxHourAssignments(Collection&lt;ID&gt; colWorkResourceIDs,
			Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L495">		methodStart(&quot;getMinMaxHourAssignments&quot;, colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L496">		WorkResourceMinMaxHourDAO dao = new WorkResourceMinMaxHourDAO();</span>
		try {
<span class="nc" id="L498">			return dao.getMinMaxHourAssignments(colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L499">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L500">			handleException(e, false);</span>
<span class="nc" id="L501">			throw e;</span>
		} finally {
<span class="nc" id="L503">			dao.cleanUp();</span>
<span class="nc" id="L504">			methodFinish();</span>
		}
	}

	/**
	 * get a list of min-max hour assignments given their IDs
	 */
	public Collection getMinMaxHourAssignmentsByIDs(Collection colIDSAs) throws BbmFinderException {
<span class="nc" id="L512">		methodStart(&quot;getMinMaxHourAssignmentsByIDs&quot;, colIDSAs);</span>
<span class="nc" id="L513">		WorkResourceMinMaxHourDAO dao = new WorkResourceMinMaxHourDAO();</span>
		try {
<span class="nc" id="L515">			return dao.getMinMaxHourAssignmentsByIDs(colIDSAs);</span>
<span class="nc" id="L516">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L517">			handleException(e, false);</span>
<span class="nc" id="L518">			throw e;</span>
		} finally {
<span class="nc" id="L520">			dao.cleanUp();</span>
<span class="nc" id="L521">			methodFinish();</span>
		}
	}

	/** create a min-max hour assignment */
	public ID createMinMaxHourAssignment(WorkResourceMinMaxHour objValue) throws BbmCreateException {
<span class="nc" id="L527">		methodStart(&quot;createMinMaxHourAssignment&quot;, objValue);</span>
<span class="nc" id="L528">		WorkResourceMinMaxHourDAO dao = new WorkResourceMinMaxHourDAO();</span>
		try {
<span class="nc" id="L530">			return dao.createMinMaxHourAssignment(objValue);</span>
<span class="nc" id="L531">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L532">			handleException(e);</span>
<span class="nc" id="L533">			throw e;</span>
		} finally {
<span class="nc" id="L535">			dao.cleanUp();</span>
<span class="nc" id="L536">			methodFinish();</span>
		}
	}

	/** save a min-max hour assignment */
	public void updateMinMaxHourAssignment(WorkResourceMinMaxHour objValue, boolean bSaveAsNew)
			throws MultiUserException, BbmUpdateException {
<span class="nc" id="L543">		methodStart(&quot;updateMinMaxHourAssignment&quot;, objValue);</span>
<span class="nc" id="L544">		WorkResourceMinMaxHourDAO dao = new WorkResourceMinMaxHourDAO();</span>
		try {
<span class="nc" id="L546">			dao.updateMinMaxHourAssignment(objValue, bSaveAsNew);</span>
<span class="nc" id="L547">		} catch (MultiUserException e) {</span>
<span class="nc" id="L548">			handleException(e);</span>
<span class="nc" id="L549">			throw e;</span>
<span class="nc" id="L550">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L551">			handleException(e);</span>
<span class="nc" id="L552">			throw e;</span>
		} finally {
<span class="nc" id="L554">			dao.cleanUp();</span>
<span class="nc" id="L555">			methodFinish();</span>
<span class="nc" id="L556">		}</span>
<span class="nc" id="L557">	}</span>

	/** delete min-max hour assignments given their assignment ids */
	public void deleteMinMaxHourAssignments(Collection colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L561">		methodStart(&quot;deleteMinMaxHourAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L562">		WorkResourceMinMaxHourDAO dao = new WorkResourceMinMaxHourDAO();</span>
		try {
<span class="nc" id="L564">			dao.deleteMinMaxHourAssignments(colIDAssignments);</span>
<span class="nc" id="L565">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L566">			handleException(e);</span>
<span class="nc" id="L567">			throw e;</span>
		} finally {
<span class="nc" id="L569">			dao.cleanUp();</span>
<span class="nc" id="L570">			methodFinish();</span>
<span class="nc" id="L571">		}</span>
<span class="nc" id="L572">	}</span>

	public Map&lt;ID, List&lt;WorkResourceMonthlyMinMaxHour&gt;&gt; getMonthlyMinMaxHourAssignments(Collection&lt;ID&gt; workResourceIDs,
			int year) throws BbmFinderException, RemoteException {
<span class="nc" id="L576">		methodStart(&quot;getMonthlyMinMaxHourAssignments&quot;, workResourceIDs, year);</span>

<span class="nc" id="L578">		WorkResourceMonthlyMinMaxHourDAO dao = new WorkResourceMonthlyMinMaxHourDAO();</span>
		try {
<span class="nc" id="L580">			return dao.getObjectsByWorkResourceIdAndYear(workResourceIDs, year);</span>
<span class="nc" id="L581">		} catch (JdmoException e) {</span>
<span class="nc" id="L582">			handleException(e);</span>
<span class="nc" id="L583">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L585">			dao.cleanUp();</span>
<span class="nc" id="L586">			methodFinish();</span>
		}
	}

	public void saveMonthlyMinMaxHourAssignments(Map&lt;ID, List&lt;WorkResourceMonthlyMinMaxHour&gt;&gt; hoursAssignments)
			throws BbmUpdateException, BbmCreateException, MultiUserException, RemoteException {
<span class="nc" id="L592">		methodStart(&quot;saveMonthlyMinMaxHourAssignments&quot;, hoursAssignments);</span>
<span class="nc" id="L593">		WorkResourceMonthlyMinMaxHourDAO dao = new WorkResourceMonthlyMinMaxHourDAO();</span>

		try {
<span class="nc" id="L596">			List&lt;WorkResourceMonthlyMinMaxHour&gt; recordsToCreate = new ArrayList&lt;WorkResourceMonthlyMinMaxHour&gt;();</span>
<span class="nc" id="L597">			List&lt;WorkResourceMonthlyMinMaxHour&gt; recordsToUpdate = new ArrayList&lt;WorkResourceMonthlyMinMaxHour&gt;();</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">			for (ID employeeID : hoursAssignments.keySet()) {</span>
<span class="nc" id="L599">				List&lt;WorkResourceMonthlyMinMaxHour&gt; employeeHours = hoursAssignments.get(employeeID);</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">				for (int month = 0; month &lt; 12; month++) {</span>
<span class="nc" id="L601">					WorkResourceMonthlyMinMaxHour monthlyHours = employeeHours.get(month);</span>

<span class="nc bnc" id="L603" title="All 2 branches missed.">					if (monthlyHours.isNewRecord()) {</span>
<span class="nc" id="L604">						recordsToCreate.add(monthlyHours);</span>
					} else {
<span class="nc" id="L606">						recordsToUpdate.add(monthlyHours);</span>
					}
				}
<span class="nc" id="L609">			}</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">			if (recordsToUpdate.size() &gt; 0) {</span>
<span class="nc" id="L611">				dao.updateObjects(recordsToUpdate);</span>
			}
<span class="nc bnc" id="L613" title="All 2 branches missed.">			if (recordsToCreate.size() &gt; 0) {</span>
<span class="nc" id="L614">				dao.createObjects(recordsToCreate);</span>
			}
<span class="nc" id="L616">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L617">			handleException(e);</span>
<span class="nc" id="L618">			throw e;</span>
<span class="nc" id="L619">		} catch (MultiUserException e) {</span>
<span class="nc" id="L620">			handleException(e);</span>
<span class="nc" id="L621">			throw e;</span>
<span class="nc" id="L622">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L623">			handleException(e);</span>
<span class="nc" id="L624">			throw e;</span>
		} finally {
<span class="nc" id="L626">			dao.cleanUp();</span>
<span class="nc" id="L627">			methodFinish();</span>
<span class="nc" id="L628">		}</span>
<span class="nc" id="L629">	}</span>

	// ggong
	/**************************************************************************
	 * functions for pooling rules assignments
	 **************************************************************************/
	/**
	 * get a given work resource's Pooling Rule assignments
	 *
	 * @idWorkResource work resource id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of EmpPoolingRule objects which hold the assignment
	 *         information
	 */
	public Collection&lt;EmpPoolingRule&gt; getPoolingRuleAssignments(ID idWorkResource, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L646">		methodStart(&quot;getPoolingRuleAssignments&quot;, idWorkResource, dtStart, dtEnd);</span>
<span class="nc" id="L647">		EmpPoolingRuleDAO dao = new EmpPoolingRuleDAO();</span>
		try {
<span class="nc" id="L649">			ArrayList aWorkResources = new ArrayList();</span>
<span class="nc" id="L650">			aWorkResources.add(idWorkResource);</span>
<span class="nc" id="L651">			return (Collection) dao.getPoolingRuleAssignments(aWorkResources, dtStart, dtEnd).get(idWorkResource);</span>
<span class="nc" id="L652">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L653">			handleException(e, false);</span>
<span class="nc" id="L654">			throw e;</span>
		} finally {
<span class="nc" id="L656">			dao.cleanUp();</span>
<span class="nc" id="L657">			methodFinish();</span>
		}
	}

	/**
	 * get a collection of workresources' Pooling Rule assignments
	 *
	 * @colWorkResourceIDs a collection of work resource ids
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a HashMap of following pairs (idWorkResource, array list of
	 *         EmpPoolingRule objects)
	 */
	public HashMap getPoolingRuleAssignments(Collection colWorkResourceIDs, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L672">		methodStart(&quot;getPoolingRuleAssignments&quot;, colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L673">		EmpPoolingRuleDAO dao = new EmpPoolingRuleDAO();</span>
		try {
<span class="nc" id="L675">			return dao.getPoolingRuleAssignments(colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L676">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L677">			handleException(e, false);</span>
<span class="nc" id="L678">			throw e;</span>
		} finally {
<span class="nc" id="L680">			dao.cleanUp();</span>
<span class="nc" id="L681">			methodFinish();</span>
		}
	}

	/**
	 * get a list of Pooling Rule assignments given their IDs
	 */
	public Collection getPoolingRuleAssignmentsByIDs(Collection colIDSAs) throws BbmFinderException {
<span class="nc" id="L689">		methodStart(&quot;getPoolingRuleAssignmentsByIDs&quot;, colIDSAs);</span>
<span class="nc" id="L690">		EmpPoolingRuleDAO dao = new EmpPoolingRuleDAO();</span>
		try {
<span class="nc" id="L692">			return dao.getPoolingRuleAssignmentsByIDs(colIDSAs);</span>
<span class="nc" id="L693">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L694">			handleException(e, false);</span>
<span class="nc" id="L695">			throw e;</span>
		} finally {
<span class="nc" id="L697">			dao.cleanUp();</span>
<span class="nc" id="L698">			methodFinish();</span>
		}
	}

	/** create a Pooling Rule assignment */
	public ID createPoolingRuleAssignment(EmpPoolingRule objValue) throws BbmCreateException {
<span class="nc" id="L704">		methodStart(&quot;createMinMaxHourAssignment&quot;, objValue);</span>
<span class="nc" id="L705">		EmpPoolingRuleDAO dao = new EmpPoolingRuleDAO();</span>
		try {
<span class="nc" id="L707">			return dao.createPoolingRuleAssignment(objValue);</span>
<span class="nc" id="L708">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L709">			handleException(e);</span>
<span class="nc" id="L710">			throw e;</span>
		} finally {
<span class="nc" id="L712">			dao.cleanUp();</span>
<span class="nc" id="L713">			methodFinish();</span>
		}
	}

	/** save a Pooling Rule assignment */
	public void updatePoolingRuleAssignment(EmpPoolingRule objValue, boolean bSaveAsNew) throws MultiUserException,
			BbmUpdateException {
<span class="nc" id="L720">		methodStart(&quot;updatePoolingRuleAssignment&quot;, objValue);</span>
<span class="nc" id="L721">		EmpPoolingRuleDAO dao = new EmpPoolingRuleDAO();</span>
		try {
<span class="nc" id="L723">			dao.updatePoolingRuleAssignment(objValue, bSaveAsNew);</span>
<span class="nc" id="L724">		} catch (MultiUserException e) {</span>
<span class="nc" id="L725">			handleException(e);</span>
<span class="nc" id="L726">			throw e;</span>
<span class="nc" id="L727">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L728">			handleException(e);</span>
<span class="nc" id="L729">			throw e;</span>
		} finally {
<span class="nc" id="L731">			dao.cleanUp();</span>
<span class="nc" id="L732">			methodFinish();</span>
<span class="nc" id="L733">		}</span>
<span class="nc" id="L734">	}</span>

	/** delete Pooling Rule hour assignments given their assignment ids */
	public void deletePoolingRuleAssignments(Collection colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L738">		methodStart(&quot;deletePoolingRuleAssignments&quot;, colIDAssignments);</span>
<span class="nc" id="L739">		EmpPoolingRuleDAO dao = new EmpPoolingRuleDAO();</span>
		try {
<span class="nc" id="L741">			dao.deletePoolingRuleAssignments(colIDAssignments);</span>
<span class="nc" id="L742">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L743">			handleException(e);</span>
<span class="nc" id="L744">			throw e;</span>
		} finally {
<span class="nc" id="L746">			dao.cleanUp();</span>
<span class="nc" id="L747">			methodFinish();</span>
<span class="nc" id="L748">		}</span>
<span class="nc" id="L749">	}</span>

	// finish ggong

	/**************************************************************************
	 * functions for work rule assignments
	 **************************************************************************/
	/**
	 * get a given work resource's work rule assignments
	 *
	 * @param idWorkResource
	 *            work resource id
	 * @param dtStart
	 *            , @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of work rule ids that assigned to the work resource
	 */
	public Collection getWorkRuleAssignments(ID idWorkResource) throws BbmFinderException {
<span class="nc" id="L767">		methodStart(&quot;getWorkRuleAssignments&quot;, idWorkResource);</span>
<span class="nc" id="L768">		WorkResourceWorkRuleDAO dao = new WorkResourceWorkRuleDAO();</span>
		try {
<span class="nc" id="L770">			return dao.getWorkRuleAssignments(idWorkResource);</span>
<span class="nc" id="L771">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L772">			handleException(e, false);</span>
<span class="nc" id="L773">			throw e;</span>
		} finally {
<span class="nc" id="L775">			dao.cleanUp();</span>
<span class="nc" id="L776">			methodFinish();</span>
		}
	}

	/**
	 * get work rule assignments for a collection of work resource ids
	 *
	 * @param colWorkResourceIDs
	 *            a collection of work resource ids
	 *
	 * @return a HashMap of following pairs (idWorkResource, collection of work
	 *         rule ids)
	 */
	public HashMap getWorkRuleAssignments(Collection colWorkResourceIDs) throws BbmFinderException {
<span class="nc" id="L790">		methodStart(&quot;getWorkRuleAssignments&quot;, colWorkResourceIDs);</span>
<span class="nc" id="L791">		WorkResourceWorkRuleDAO dao = new WorkResourceWorkRuleDAO();</span>
		try {
<span class="nc" id="L793">			return dao.getWorkRuleAssignments(colWorkResourceIDs);</span>
<span class="nc" id="L794">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L795">			handleException(e, false);</span>
<span class="nc" id="L796">			throw e;</span>
		} finally {
<span class="nc" id="L798">			dao.cleanUp();</span>
<span class="nc" id="L799">			methodFinish();</span>
		}
	}

	/** create a work rule assignment */
	public void createWorkRuleAssignments(ID idWorkResource, Collection colWorkRuleIDs) throws BbmCreateException {
<span class="nc" id="L805">		methodStart(&quot;createWorkRuleAssignment&quot;, idWorkResource, colWorkRuleIDs);</span>
<span class="nc" id="L806">		WorkResourceWorkRuleDAO dao = new WorkResourceWorkRuleDAO();</span>
		try {
<span class="nc" id="L808">			dao.createWorkRuleAssignments(idWorkResource, colWorkRuleIDs);</span>
<span class="nc" id="L809">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L810">			handleException(e);</span>
<span class="nc" id="L811">			throw e;</span>
		} finally {
<span class="nc" id="L813">			dao.cleanUp();</span>
<span class="nc" id="L814">			methodFinish();</span>
<span class="nc" id="L815">		}</span>
<span class="nc" id="L816">	}</span>

	/** delete work rules assignments */
	public void deleteWorkRuleAssignments(ID idWorkResource, Collection colWorkRuleIDs) throws BbmRemoveException {
<span class="nc" id="L820">		methodStart(&quot;deleteWorkRuleAssignments&quot;, idWorkResource, colWorkRuleIDs);</span>
<span class="nc" id="L821">		WorkResourceWorkRuleDAO dao = new WorkResourceWorkRuleDAO();</span>
		try {
<span class="nc" id="L823">			dao.deleteWorkRuleAssignments(idWorkResource, colWorkRuleIDs);</span>
<span class="nc" id="L824">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L825">			handleException(e);</span>
<span class="nc" id="L826">			throw e;</span>
		} finally {
<span class="nc" id="L828">			dao.cleanUp();</span>
<span class="nc" id="L829">			methodFinish();</span>
<span class="nc" id="L830">		}</span>
<span class="nc" id="L831">	}</span>

	/**
	 * get WorkPatternAssignments where the WorkPattern's SHIFTWORKPATTERNSETID
	 * = idSet. This method would be useful in scheduling with a Work Pattern
	 * Set filter and for deleting and updated Work Pattern Sets.
	 */
	public HashMap getWorkPatternAssignmentsBySet(Collection colWorkResourceIDs, Date dtStart, Date dtEnd,
			ID idWorkPatternSet) throws BbmFinderException {
<span class="nc" id="L840">		methodStart(&quot;getWorkPatternAssignmentsBySet&quot;, colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L841">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L843">			return dao.getWorkPatternAssignmentsBySet(colWorkResourceIDs, dtStart, dtEnd, idWorkPatternSet);</span>
<span class="nc" id="L844">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L845">			handleException(e, false);</span>
<span class="nc" id="L846">			throw e;</span>
		} finally {
<span class="nc" id="L848">			dao.cleanUp();</span>
<span class="nc" id="L849">			methodFinish();</span>
		}
	}

	public HashMap getWorkRuleAndPayRuleAssignments(Collection colWorkResourceIDs, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L855">		methodStart(&quot;getWorkRuleAndPayRuleAssignments&quot;, colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L856">		HashMap hRules = new HashMap();</span>
		try {
<span class="nc" id="L858">			HashMap hAssignmentRules = getWorkRuleAssignments(colWorkResourceIDs);</span>

<span class="nc" id="L860">			PayPolicyManager mPayPolicy = BbmManagerFactory.getPayPolicyManager();</span>
<span class="nc" id="L861">			WorkResourceManager mResourceManager = BbmManagerFactory.getWorkResourceManager();</span>

<span class="nc" id="L863">			HashMap hPayPolicyAssignments = mResourceManager.getWorkResourcePayPolicies(colWorkResourceIDs, dtStart,</span>
					dtEnd);

<span class="nc" id="L866">			TreeSet tPayPolicies = new TreeSet();</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">			for (Iterator i = hPayPolicyAssignments.values().iterator(); i.hasNext();) {</span>
<span class="nc" id="L868">				Collection cPayPolicyAssignments = (Collection) i.next();</span>
<span class="nc bnc" id="L869" title="All 2 branches missed.">				for (Iterator j = cPayPolicyAssignments.iterator(); j.hasNext();) {</span>
<span class="nc" id="L870">					WorkResourcePayPolicy pAssignment = (WorkResourcePayPolicy) j.next();</span>
<span class="nc" id="L871">					tPayPolicies.add(pAssignment.getPayPolicyID());</span>
<span class="nc" id="L872">				}</span>
<span class="nc" id="L873">			}</span>

<span class="nc" id="L875">			HashMap hPayPolicyWorkRules = new HashMap();</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">			for (Iterator i = tPayPolicies.iterator(); i.hasNext();) {</span>
<span class="nc" id="L877">				ID idPayPolicy = (ID) i.next();</span>
<span class="nc" id="L878">				hPayPolicyWorkRules.put(idPayPolicy, mPayPolicy.getWorkRuleForPayPolicy(idPayPolicy));</span>
<span class="nc" id="L879">			}</span>

<span class="nc bnc" id="L881" title="All 2 branches missed.">			for (Iterator i = colWorkResourceIDs.iterator(); i.hasNext();) {</span>
<span class="nc" id="L882">				ID idEmployee = (ID) i.next();</span>
<span class="nc" id="L883">				LinkedList llRuleAssignments = new LinkedList();</span>
<span class="nc" id="L884">				hRules.put(idEmployee, llRuleAssignments);</span>
<span class="nc" id="L885">				Collection cAssignmentRules = (Collection) hAssignmentRules.get(idEmployee);</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">				if (cAssignmentRules != null) {</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">					for (Iterator j = cAssignmentRules.iterator(); j.hasNext();) {</span>
<span class="nc" id="L888">						ID idAssignmentRule = (ID) j.next();</span>
<span class="nc" id="L889">						llRuleAssignments.add(new RuleAssignment(idAssignmentRule, null, null));</span>
<span class="nc" id="L890">					}</span>
				}
<span class="nc" id="L892">				Collection cPayPolicyAssignments = (Collection) hPayPolicyAssignments.get(idEmployee);</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">				if (cPayPolicyAssignments != null) {</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">					for (Iterator j = cPayPolicyAssignments.iterator(); j.hasNext();) {</span>
<span class="nc" id="L895">						WorkResourcePayPolicy pAssignment = (WorkResourcePayPolicy) j.next();</span>
<span class="nc" id="L896">						Collection cPayRules = (Collection) hPayPolicyWorkRules.get(pAssignment.getPayPolicyID());</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">						for (Iterator k = cPayRules.iterator(); k.hasNext();) {</span>
<span class="nc" id="L898">							ID idPayRule = (ID) k.next();</span>
<span class="nc" id="L899">							llRuleAssignments.add(new RuleAssignment(idPayRule, pAssignment.getStartTime(), pAssignment</span>
<span class="nc" id="L900">									.getEndTime()));</span>
<span class="nc" id="L901">						}</span>
<span class="nc" id="L902">					}</span>
				}
<span class="nc" id="L904">			}</span>
<span class="nc" id="L905">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L906">			handleException(e, false);</span>
<span class="nc" id="L907">			throw e;</span>
<span class="nc" id="L908">		} catch (RemoteException e) {</span>
<span class="nc" id="L909">			handleException(e);</span>
<span class="nc" id="L910">			throw new BbmFinderException(e);</span>
<span class="nc" id="L911">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L912">			handleException(e);</span>
<span class="nc" id="L913">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L915">			methodFinish();</span>
<span class="nc" id="L916">		}</span>
<span class="nc" id="L917">		return hRules;</span>
	}

	public Collection getWorkPatternIDNamePairs(Collection orgIDs) throws BbmFinderException {
<span class="nc" id="L921">		methodStart(&quot;getWorkPatternIDNamePairs&quot;, orgIDs);</span>
<span class="nc" id="L922">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L924">			return dao.getWorkPatternIDNamePairs(orgIDs);</span>
<span class="nc" id="L925">		} catch (BbmFinderException ex) {</span>
<span class="nc" id="L926">			handleException(ex, false);</span>
<span class="nc" id="L927">			throw ex;</span>
		} finally {
<span class="nc" id="L929">			dao.cleanUp();</span>
<span class="nc" id="L930">			methodFinish();</span>
		}
	}

	public Collection getShiftIDNamePairs(Collection orgIDs) throws BbmFinderException {
<span class="nc" id="L935">		methodStart(&quot;getShiftIDNamePairs&quot;, orgIDs);</span>
<span class="nc" id="L936">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L938">			return dao.getShiftIDNamePairs(orgIDs);</span>
<span class="nc" id="L939">		} catch (BbmFinderException ex) {</span>
<span class="nc" id="L940">			handleException(ex, false);</span>
<span class="nc" id="L941">			throw ex;</span>
		} finally {
<span class="nc" id="L943">			dao.cleanUp();</span>
<span class="nc" id="L944">			methodFinish();</span>
		}
	}

	public HashMap getWorkPatternAssignmentsInPeriodAndOnSpotOnly(Collection colWorkResourceIDs, Date dtStart,
			Date dtEnd, Date timeSpot) throws BbmFinderException {
<span class="nc" id="L950">		methodStart(&quot;getWorkPatternAssignmentsInPeriodAndOnSpotOnly&quot;, colWorkResourceIDs, dtStart, dtEnd, timeSpot);</span>
<span class="nc" id="L951">		WorkResourceWorkPatternDAO dao = new WorkResourceWorkPatternDAO();</span>
		try {
<span class="nc" id="L953">			return dao.getWorkPatternAssignmentsInPeriodAndOnSpotOnly(colWorkResourceIDs, dtStart, dtEnd, timeSpot);</span>
<span class="nc" id="L954">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L955">			handleException(e, false);</span>
<span class="nc" id="L956">			throw e;</span>
		} finally {
<span class="nc" id="L958">			dao.cleanUp();</span>
<span class="nc" id="L959">			methodFinish();</span>
		}
	}

	// === rotation rule APIs ========
	public HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; getRotationAssignments(Collection&lt;ID&gt; workResourceIDs)
			throws BbmFinderException {
<span class="nc" id="L966">		methodStart(&quot;getRotationAssignments&quot;, workResourceIDs);</span>
<span class="nc" id="L967">		WorkResourceRotationDAO dao = new WorkResourceRotationDAO();</span>
		try {
<span class="nc" id="L969">			StringBuffer where = new StringBuffer();</span>
<span class="nc" id="L970">			where.append(&quot; WORKRESOURCEID in &quot;).append(dao.getDMO().createInClause(workResourceIDs));</span>
<span class="nc" id="L971">			Collection&lt;WorkResourceRotation&gt; rules = dao.getObjects(where.toString());</span>
<span class="nc" id="L972">			return ValueObjectUtil.groupByField(</span>
					WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_WORKRESOURCEID, rules);
<span class="nc" id="L974">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L975">			handleException(e, false);</span>
<span class="nc" id="L976">			throw e;</span>
<span class="nc" id="L977">		} catch (Exception e) {</span>
<span class="nc" id="L978">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L980">			dao.cleanUp();</span>
<span class="nc" id="L981">			methodFinish();</span>
		}
	}

	public Map&lt;ID, ? extends Collection&lt;WorkResourceRotation&gt;&gt; getRotationAssignmentsByRotationIDs(
			Collection&lt;ID&gt; rotationIDs) throws BbmFinderException {
<span class="nc" id="L987">		methodStart(&quot;getRotationAssignmentsByRotationIDs&quot;, rotationIDs);</span>
<span class="nc" id="L988">		WorkResourceRotationDAO dao = new WorkResourceRotationDAO();</span>
		try {
<span class="nc" id="L990">			StringBuffer where = new StringBuffer();</span>
<span class="nc" id="L991">			WorkResourceComplexWorkRuleFieldInfo fi = new WorkResourceComplexWorkRuleFieldInfo();</span>
<span class="nc" id="L992">			String fn = fi</span>
<span class="nc" id="L993">					.getFieldName(WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_COMPLEXWORKRULEID);</span>
<span class="nc" id="L994">			rotationIDs = DAOUtil.mapIDsToDEIDs(rotationIDs, new ComplexWorkRuleFieldInfo()).values();</span>
<span class="nc" id="L995">			where.append(&quot; &quot;).append(fn).append(&quot; in &quot;).append(dao.getDMO().createInClause(rotationIDs));</span>
<span class="nc" id="L996">			Collection&lt;WorkResourceRotation&gt; rules = dao.getObjects(where.toString());</span>

<span class="nc" id="L998">			Map&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; retVal = new HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt;();</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">			for (WorkResourceRotation assignment : rules) {</span>
<span class="nc" id="L1000">				ID rotationID = assignment.getRotation().getID();</span>
<span class="nc" id="L1001">				Collection&lt;WorkResourceRotation&gt; col = retVal.get(rotationID);</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">				if (col == null) {</span>
<span class="nc" id="L1003">					col = new ArrayList&lt;WorkResourceRotation&gt;();</span>
<span class="nc" id="L1004">					retVal.put(rotationID, col);</span>
				}
<span class="nc" id="L1006">				col.add(assignment);</span>
<span class="nc" id="L1007">			}</span>
<span class="nc" id="L1008">			return retVal;</span>
<span class="nc" id="L1009">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1010">			handleException(e, false);</span>
<span class="nc" id="L1011">			throw e;</span>
<span class="nc" id="L1012">		} catch (Exception e) {</span>
<span class="nc" id="L1013">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1015">			dao.cleanUp();</span>
<span class="nc" id="L1016">			methodFinish();</span>
		}
	}

	/**
	 * getAvailableRotationsForEmployees without filtering by Name, passed
	 * filterByName =null
	 * */
	public PaginationPair&lt;Rotation&gt; getAvailableRotationsForEmployees(Collection&lt;ID&gt; workResourceIDs, Date startDate,
			Date endDate, boolean isAscendingSort, int pageIDSize, int pageIndex,
			LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap, Collection&lt;ID&gt; filteredIDs) throws BbmFinderException {
<span class="nc" id="L1027">		methodStart(&quot;getAvailableRotationsForEmployees&quot;, workResourceIDs, startDate);</span>
<span class="nc" id="L1028">		RotationDAO dao = new RotationDAO();</span>
		try {
<span class="nc" id="L1030">			return dao.getAvailableWorkRulesForEmployees(workResourceIDs, startDate, endDate, isAscendingSort,</span>
					pageIDSize, pageIndex, sortFieldMap, filteredIDs, null);
<span class="nc" id="L1032">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1033">			handleException(e, false);</span>
<span class="nc" id="L1034">			throw e;</span>
<span class="nc" id="L1035">		} catch (Exception e) {</span>
<span class="nc" id="L1036">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1038">			dao.cleanUp();</span>
<span class="nc" id="L1039">			methodFinish();</span>
		}
	}

	public PaginationPair&lt;Rotation&gt; getAvailableRotationsForEmployees(Collection&lt;ID&gt; workResourceIDs, Date startDate,
			Date endDate, boolean isAscendingSort, int pageIDSize, int pageIndex,
			LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap, Collection&lt;ID&gt; filteredIDs, String filterByName)
			throws BbmFinderException {
<span class="nc" id="L1047">		methodStart(&quot;getAvailableRotationsForEmployees&quot;, workResourceIDs, startDate, endDate, filterByName);</span>
<span class="nc" id="L1048">		RotationDAO dao = new RotationDAO();</span>
		try {
<span class="nc" id="L1050">			return dao.getAvailableWorkRulesForEmployees(workResourceIDs, startDate, endDate, isAscendingSort,</span>
					pageIDSize, pageIndex, sortFieldMap, filteredIDs, filterByName);
<span class="nc" id="L1052">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1053">			handleException(e, false);</span>
<span class="nc" id="L1054">			throw e;</span>
<span class="nc" id="L1055">		} catch (Exception e) {</span>
<span class="nc" id="L1056">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1058">			dao.cleanUp();</span>
<span class="nc" id="L1059">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; createRotationAssignments(Collection&lt;WorkResourceRotation&gt; rotationAssignments)
			throws BbmCreateException {
<span class="nc" id="L1065">		methodStart(&quot;createRotationAssignments&quot;, rotationAssignments);</span>
<span class="nc" id="L1066">		WorkResourceRotationDAO dao = new WorkResourceRotationDAO();</span>
		try {
<span class="nc" id="L1068">			return dao.createObjects(rotationAssignments);</span>
<span class="nc" id="L1069">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1070">			handleException(e);</span>
<span class="nc" id="L1071">			throw e;</span>
<span class="nc" id="L1072">		} catch (Exception e) {</span>
<span class="nc" id="L1073">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L1075">			dao.cleanUp();</span>
<span class="nc" id="L1076">			methodFinish();</span>
		}
	}

	public void updateRotationAssignments(Collection&lt;WorkResourceRotation&gt; rotationAssignments)
			throws MultiUserException, BbmUpdateException {
<span class="nc" id="L1082">		methodStart(&quot;updateRotationAssignments&quot;, rotationAssignments);</span>
<span class="nc" id="L1083">		WorkResourceRotationDAO dao = new WorkResourceRotationDAO();</span>
		try {
<span class="nc" id="L1085">			dao.updateObjects(rotationAssignments);</span>
<span class="nc" id="L1086">		} catch (MultiUserException e) {</span>
<span class="nc" id="L1087">			handleException(e);</span>
<span class="nc" id="L1088">			throw e;</span>
<span class="nc" id="L1089">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1090">			handleException(e);</span>
<span class="nc" id="L1091">			throw e;</span>
		} finally {
<span class="nc" id="L1093">			dao.cleanUp();</span>
<span class="nc" id="L1094">			methodFinish();</span>
<span class="nc" id="L1095">		}</span>
<span class="nc" id="L1096">	}</span>

	public void deleteRotationAssignments(Collection&lt;ID&gt; rotationAssignmentIDs) throws BbmRemoveException {
<span class="nc" id="L1099">		methodStart(&quot;deleteRotationAssignments&quot;, rotationAssignmentIDs);</span>
<span class="nc" id="L1100">		WorkResourceRotationDAO dao = new WorkResourceRotationDAO();</span>
		try {
<span class="nc" id="L1102">			dao.deleteWorkResourceRotations(rotationAssignmentIDs);</span>
<span class="nc" id="L1103">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1104">			handleException(e);</span>
<span class="nc" id="L1105">			throw e;</span>
		} finally {
<span class="nc" id="L1107">			dao.cleanUp();</span>
<span class="nc" id="L1108">			methodFinish();</span>
<span class="nc" id="L1109">		}</span>
<span class="nc" id="L1110">	}</span>

	// === complex rule relate APIs ========
	public HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; getComplexWorkRuleAssignments(
			Collection&lt;ID&gt; workResourceIDs) throws BbmFinderException {
<span class="nc" id="L1115">		methodStart(&quot;getComplexWorkRuleAssignments&quot;, workResourceIDs);</span>
<span class="nc" id="L1116">		WorkResourceComplexWorkRuleDAO dao = new WorkResourceComplexWorkRuleDAO();</span>
		try {
<span class="nc" id="L1118">			StringBuffer where = new StringBuffer();</span>
<span class="nc" id="L1119">			where.append(&quot; WORKRESOURCEID in &quot;).append(dao.getDMO().createInClause(workResourceIDs));</span>
<span class="nc" id="L1120">			Collection&lt;WorkResourceComplexWorkRule&gt; rules = dao.getObjects(where.toString());</span>
<span class="nc" id="L1121">			return ValueObjectUtil.groupByField(</span>
					WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_WORKRESOURCEID, rules);
<span class="nc" id="L1123">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1124">			handleException(e, false);</span>
<span class="nc" id="L1125">			throw e;</span>
<span class="nc" id="L1126">		} catch (Exception e) {</span>
<span class="nc" id="L1127">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1129">			dao.cleanUp();</span>
<span class="nc" id="L1130">			methodFinish();</span>
		}
	}

	public Map&lt;ID, ? extends Collection&lt;WorkResourceComplexWorkRule&gt;&gt; getComplexWorkRuleAssignmentsByCWRIDs(
			Collection&lt;ID&gt; complexWorkRuleIDs) throws BbmFinderException {
<span class="nc" id="L1136">		methodStart(&quot;getComplexWorkRuleAssignmentsByCWRIDs&quot;, complexWorkRuleIDs);</span>
<span class="nc" id="L1137">		WorkResourceComplexWorkRuleDAO dao = new WorkResourceComplexWorkRuleDAO();</span>
		try {
<span class="nc" id="L1139">			StringBuffer where = new StringBuffer();</span>
<span class="nc" id="L1140">			WorkResourceComplexWorkRuleFieldInfo fi = new WorkResourceComplexWorkRuleFieldInfo();</span>
<span class="nc" id="L1141">			String fn = fi</span>
<span class="nc" id="L1142">					.getFieldName(WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_COMPLEXWORKRULEID);</span>
<span class="nc" id="L1143">			complexWorkRuleIDs = DAOUtil.mapIDsToDEIDs(complexWorkRuleIDs, new ComplexWorkRuleFieldInfo()).values();</span>
<span class="nc" id="L1144">			where.append(&quot; &quot;).append(fn).append(&quot; in &quot;).append(dao.getDMO().createInClause(complexWorkRuleIDs));</span>
<span class="nc" id="L1145">			Collection&lt;WorkResourceComplexWorkRule&gt; rules = dao.getObjects(where.toString());</span>

<span class="nc" id="L1147">			Map&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; retVal = new HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt;();</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">			for (WorkResourceComplexWorkRule assignment : rules) {</span>
<span class="nc" id="L1149">				ID cwrID = assignment.getComplexWorkRuleID();</span>
<span class="nc" id="L1150">				Collection&lt;WorkResourceComplexWorkRule&gt; col = retVal.get(cwrID);</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">				if (col == null) {</span>
<span class="nc" id="L1152">					col = new ArrayList&lt;WorkResourceComplexWorkRule&gt;();</span>
<span class="nc" id="L1153">					retVal.put(cwrID, col);</span>
				}
<span class="nc" id="L1155">				col.add(assignment);</span>
<span class="nc" id="L1156">			}</span>
<span class="nc" id="L1157">			return retVal;</span>
<span class="nc" id="L1158">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1159">			handleException(e, false);</span>
<span class="nc" id="L1160">			throw e;</span>
<span class="nc" id="L1161">		} catch (Exception e) {</span>
<span class="nc" id="L1162">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1164">			dao.cleanUp();</span>
<span class="nc" id="L1165">			methodFinish();</span>
		}
	}

	public PaginationPair&lt;ComplexWorkRule&gt; getAvailableComplexWorkRulesForEmployees(Collection&lt;ID&gt; workResourceIDs,
			Date startDate, Date endDate, boolean isAscendingSort, int pageIDSize, int pageIndex,
			LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap, Collection&lt;ID&gt; filteredIDs) throws BbmFinderException {
<span class="nc" id="L1172">		methodStart(&quot;getAvailableComplexWorkRulesForEmployees&quot;, workResourceIDs, startDate);</span>
<span class="nc" id="L1173">		ComplexWorkRuleDAO dao = new ComplexWorkRuleDAO();</span>
		try {

			// Supervisor rules should not be returned for supervisors. To
			// accomplish this, we will add
			// those to the filtered IDs.
<span class="nc" id="L1179">			boolean filterOutSupervisorTeamRules = false;</span>

			// First, check if any of employees are supervisors.
<span class="nc" id="L1182">			WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager(isWhatIf);</span>
<span class="nc" id="L1183">			Collection&lt;Employee&gt; emps = wrm.getEmployeesByIDs(workResourceIDs, startDate,</span>
					Employee.DETAIL_LEVEL_EMPLOYEE_BASIC);
<span class="nc bnc" id="L1185" title="All 2 branches missed.">			for (Employee e : emps) {</span>
<span class="nc bnc" id="L1186" title="All 2 branches missed.">				if (e.isSupervisor()) {</span>
<span class="nc" id="L1187">					filterOutSupervisorTeamRules = true;</span>
<span class="nc" id="L1188">					break;</span>
				}
<span class="nc" id="L1190">			}</span>

<span class="nc bnc" id="L1192" title="All 2 branches missed.">			if (filterOutSupervisorTeamRules) {</span>
<span class="nc" id="L1193">				filteredIDs = new HashSet&lt;ID&gt;(filteredIDs);</span>
<span class="nc" id="L1194">				filteredIDs.addAll(dao.getIDsForWorkUnitType(WorkUnitType.SupervisorTeams));</span>
			}

<span class="nc" id="L1197">			return dao.getAvailableWorkRulesForEmployees(workResourceIDs, startDate, endDate, isAscendingSort,</span>
					pageIDSize, pageIndex, sortFieldMap, filteredIDs, null);
<span class="nc" id="L1199">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1200">			handleException(e, false);</span>
<span class="nc" id="L1201">			throw e;</span>
<span class="nc" id="L1202">		} catch (Exception e) {</span>
<span class="nc" id="L1203">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1205">			dao.cleanUp();</span>
<span class="nc" id="L1206">			methodFinish();</span>
		}
	}

	public Collection&lt;ID&gt; createComplexWorkRuleAssignments(
			Collection&lt;WorkResourceComplexWorkRule&gt; complexWorkRuleAssignments) throws BbmCreateException {
<span class="nc" id="L1212">		methodStart(&quot;createComplexWorkRuleAssignments&quot;, complexWorkRuleAssignments);</span>
<span class="nc" id="L1213">		WorkResourceComplexWorkRuleDAO dao = new WorkResourceComplexWorkRuleDAO();</span>
		try {
<span class="nc bnc" id="L1215" title="All 2 branches missed.">			for (WorkResourceComplexWorkRule wrcwr : complexWorkRuleAssignments) {</span>
<span class="nc" id="L1216">				wrcwr.setCreatedBy(m_sessionContext.getCallerPrincipal().getName());</span>
<span class="nc" id="L1217">				wrcwr.setCreatedDate(new Date(System.currentTimeMillis()));</span>
<span class="nc" id="L1218">			}</span>
<span class="nc" id="L1219">			return dao.createObjects(complexWorkRuleAssignments);</span>
<span class="nc" id="L1220">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1221">			handleException(e);</span>
<span class="nc" id="L1222">			throw e;</span>
<span class="nc" id="L1223">		} catch (Exception e) {</span>
<span class="nc" id="L1224">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L1226">			dao.cleanUp();</span>
<span class="nc" id="L1227">			methodFinish();</span>
		}
	}

	public void updateComplexWorkRuleAssignments(Collection&lt;WorkResourceComplexWorkRule&gt; wrcwrs)
			throws MultiUserException, BbmUpdateException {
<span class="nc" id="L1233">		methodStart(&quot;updateComplexWorkRuleAssignments&quot;, wrcwrs);</span>
<span class="nc" id="L1234">		WorkResourceComplexWorkRuleDAO dao = new WorkResourceComplexWorkRuleDAO();</span>
		try {
<span class="nc bnc" id="L1236" title="All 2 branches missed.">			for (WorkResourceComplexWorkRule wrcwr : wrcwrs) {</span>
<span class="nc" id="L1237">				wrcwr.setModifiedBy(m_sessionContext.getCallerPrincipal().getName());</span>
<span class="nc" id="L1238">				wrcwr.setModifiedDate(new Date(System.currentTimeMillis()));</span>
<span class="nc" id="L1239">			}</span>
<span class="nc" id="L1240">			dao.updateObjects(wrcwrs);</span>
<span class="nc" id="L1241">		} catch (MultiUserException e) {</span>
<span class="nc" id="L1242">			handleException(e);</span>
<span class="nc" id="L1243">			throw e;</span>
<span class="nc" id="L1244">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1245">			handleException(e);</span>
<span class="nc" id="L1246">			throw e;</span>
		} finally {
<span class="nc" id="L1248">			dao.cleanUp();</span>
<span class="nc" id="L1249">			methodFinish();</span>
<span class="nc" id="L1250">		}</span>
<span class="nc" id="L1251">	}</span>

	public void deleteComplexWorkRuleAssignments(Collection&lt;ID&gt; wrcwrIDs) throws BbmRemoveException {
<span class="nc" id="L1254">		methodStart(&quot;deleteComplexWorkRuleAssignments&quot;, wrcwrIDs);</span>
<span class="nc" id="L1255">		WorkResourceComplexWorkRuleDAO dao = new WorkResourceComplexWorkRuleDAO();</span>
		try {
<span class="nc" id="L1257">			dao.deleteWorkResourceComplexWorkRules(wrcwrIDs);</span>
<span class="nc" id="L1258">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1259">			handleException(e);</span>
<span class="nc" id="L1260">			throw e;</span>
		} finally {
<span class="nc" id="L1262">			dao.cleanUp();</span>
<span class="nc" id="L1263">			methodFinish();</span>
<span class="nc" id="L1264">		}</span>
<span class="nc" id="L1265">	}</span>

	// ========= time bank adjust related API ===========
	public Collection getTimeBankAdjustments(Collection empIDs, Date startDate, Date endDate) throws BbmFinderException {
<span class="nc" id="L1269">		methodStart(&quot;getTimeBankAdjustments&quot;, empIDs, startDate, endDate);</span>
<span class="nc" id="L1270">		EmpTimeBankAdjustDAO dao = new EmpTimeBankAdjustDAO();</span>
		try {
<span class="nc" id="L1272">			Jdmo dmo = dao.getDMO();</span>
<span class="nc" id="L1273">			StringBuffer where = new StringBuffer();</span>
<span class="nc" id="L1274">			where.append(&quot; EMPLOYEEID in &quot;).append(dmo.createInClause(empIDs));</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">			if (startDate != null) {</span>
<span class="nc" id="L1276">				where.append(&quot; AND ADJUSTDATE &gt;= &quot;).append(JdmoUtil.asSqlLiteral(startDate));</span>
			}
<span class="nc bnc" id="L1278" title="All 2 branches missed.">			if (endDate != null) {</span>
<span class="nc" id="L1279">				where.append(&quot; AND ADJUSTDATE &lt; &quot;).append(JdmoUtil.asSqlLiteral(endDate));</span>
			}
<span class="nc" id="L1281">			Collection tbAdjustments = dao.getObjects(where.toString());</span>
<span class="nc" id="L1282">			HashMap empAdjustments = ValueObjectUtil.groupByField(</span>
					EmpTimeBankAdjustFieldInfo.EMPTIMEBANKADJUST_EMPLOYEEID, tbAdjustments);
<span class="nc" id="L1284">			ArrayList list = new ArrayList(empIDs.size());</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">			for (Iterator i = empIDs.iterator(); i.hasNext();) {</span>
<span class="nc" id="L1286">				list.add(empAdjustments.get(i.next()));</span>
			}
<span class="nc" id="L1288">			return list;</span>
<span class="nc" id="L1289">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1290">			handleException(e, false);</span>
<span class="nc" id="L1291">			throw e;</span>
<span class="nc" id="L1292">		} catch (Exception e) {</span>
<span class="nc" id="L1293">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1295">			dao.cleanUp();</span>
<span class="nc" id="L1296">			methodFinish();</span>
		}
	}

	public ID createTimeBankAdjustments(EmpTimeBankAdjust adjust) throws BbmCreateException {
<span class="nc" id="L1301">		methodStart(&quot;createTimeBankAdjustments&quot;, adjust);</span>
<span class="nc" id="L1302">		EmpTimeBankAdjustDAO dao = new EmpTimeBankAdjustDAO();</span>
		try {
<span class="nc" id="L1304">			return dao.createObject(adjust);</span>
<span class="nc" id="L1305">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1306">			handleException(e);</span>
<span class="nc" id="L1307">			throw e;</span>
<span class="nc" id="L1308">		} catch (Exception e) {</span>
<span class="nc" id="L1309">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L1311">			dao.cleanUp();</span>
<span class="nc" id="L1312">			methodFinish();</span>
		}
	}

	public void deleteTimeBankAdjustments(ID empID, Date startDate, Date endDate) throws BbmRemoveException {
<span class="nc" id="L1317">		methodStart(&quot;deleteTimeBankAdjustments&quot;, empID, startDate, endDate);</span>
<span class="nc" id="L1318">		EmpTimeBankAdjustDAO dao = new EmpTimeBankAdjustDAO();</span>
		try {
<span class="nc" id="L1320">			StringBuffer where = new StringBuffer();</span>
<span class="nc" id="L1321">			where.append(&quot; SELECT ID FROM TIMEBANKEMPLOYEEADJUST WHERE EMPLOYEEID = &quot;).append(empID);</span>
<span class="nc bnc" id="L1322" title="All 2 branches missed.">			if (startDate != null) {</span>
<span class="nc" id="L1323">				where.append(&quot; AND ADJUSTDATE &gt;= &quot;).append(JdmoUtil.asSqlLiteral(startDate));</span>
			}
<span class="nc bnc" id="L1325" title="All 2 branches missed.">			if (endDate != null) {</span>
<span class="nc" id="L1326">				where.append(&quot; AND ADJUSTDATE &lt; &quot;).append(JdmoUtil.asSqlLiteral(endDate));</span>
			}
<span class="nc" id="L1328">			dao.deleteObjects(where.toString());</span>
<span class="nc" id="L1329">		} catch (BbmRemoveException e) {</span>
<span class="nc" id="L1330">			handleException(e);</span>
<span class="nc" id="L1331">			throw e;</span>
		} finally {
<span class="nc" id="L1333">			dao.cleanUp();</span>
<span class="nc" id="L1334">			methodFinish();</span>
<span class="nc" id="L1335">		}</span>
<span class="nc" id="L1336">	}</span>

	public void fixTimeBankAssignmentsForOrgChange(ID empID, ID newOrgID, Date newOrgStart, Date newOrgEnd)
			throws BbmFinderException, BbmRemoveException {
<span class="nc" id="L1340">		methodStart(&quot;fixTimeBankAssignmentsForOrgChange&quot;, empID, newOrgID, newOrgStart, newOrgEnd);</span>
<span class="nc" id="L1341">		EmpTimeBankDAO dao = new EmpTimeBankDAO();</span>
		try {
<span class="nc" id="L1343">			Collection timeBankAssignments = dao.getTimeBankAssignments(empID, newOrgStart, newOrgEnd);</span>
<span class="nc bnc" id="L1344" title="All 4 branches missed.">			if (timeBankAssignments == null || timeBankAssignments.isEmpty()) {</span>
<span class="nc" id="L1345">				return;</span>
			}
<span class="nc" id="L1347">			EmpTimeBank timeBankAssignment = null;</span>
<span class="nc" id="L1348">			ArrayList removeList = new ArrayList(timeBankAssignments.size());</span>
<span class="nc" id="L1349">			ID timeBankID = null;</span>
<span class="nc" id="L1350">			ID timeBankOrgID = null;</span>
<span class="nc" id="L1351">			TimeBank timeBank = null;</span>
<span class="nc" id="L1352">			Organization timeBankOrg = null;</span>
<span class="nc" id="L1353">			Organization empNewOrg = null;</span>
			/*
			 * We must look for any time banks assigned to the employee that
			 * overlap this period, and then save the time bank assignments
			 * whose organization has the same day boundary, time zone and start
			 * day of the week as the new organization. Otherwise, delete it
			 */
<span class="nc bnc" id="L1360" title="All 2 branches missed.">			for (Iterator i = timeBankAssignments.iterator(); i.hasNext();) {</span>
<span class="nc" id="L1361">				timeBankAssignment = (EmpTimeBank) i.next();</span>
<span class="nc" id="L1362">				timeBankID = timeBankAssignment.getTimeBankID();</span>
<span class="nc" id="L1363">				timeBank = workRuleManager.getTimeBank(timeBankID);</span>
<span class="nc" id="L1364">				timeBankOrgID = timeBank.getOrganizationID();</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">				if (timeBankOrgID.equals(newOrgID)) {</span>
					// this time bank assignment is still valid
<span class="nc" id="L1367">					continue;</span>
				} else {
<span class="nc" id="L1369">					timeBankOrg = workResourceManager.getOrganizationByID(timeBankOrgID);</span>
<span class="nc" id="L1370">					empNewOrg = workResourceManager.getOrganizationByID(newOrgID);</span>
<span class="nc bnc" id="L1371" title="All 2 branches missed.">					if (timeBankOrg.getDayBoundaryOffset() != empNewOrg.getDayBoundaryOffset()</span>
<span class="nc bnc" id="L1372" title="All 2 branches missed.">							|| !timeBankOrg.getTimeZone().equals(empNewOrg.getTimeZone())</span>
<span class="nc bnc" id="L1373" title="All 2 branches missed.">							|| timeBankOrg.getWeekStartDate() != empNewOrg.getWeekStartDate()) {</span>
<span class="nc" id="L1374">						removeList.add(timeBankAssignment.getID());</span>
					}
				}
			}
<span class="nc bnc" id="L1378" title="All 2 branches missed.">			if (!removeList.isEmpty()) {</span>
<span class="nc" id="L1379">				dao.deleteObjects(removeList);</span>
			}
<span class="nc" id="L1381">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1382">			handleException(e, false);</span>
<span class="nc" id="L1383">			throw e;</span>
<span class="nc" id="L1384">		} catch (Exception e) {</span>
<span class="nc" id="L1385">			handleException(e, false);</span>
<span class="nc" id="L1386">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L1388">			dao.cleanUp();</span>
<span class="nc" id="L1389">			methodFinish();</span>
<span class="nc" id="L1390">		}</span>
<span class="nc" id="L1391">	}</span>

	/**************************************************************************
	 * functions for required pay period hour assignments
	 **************************************************************************/
	/**
	 * get a given work resource's required pay period hour assignments
	 *
	 * @idWorkResource work resource id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a collection of WorkResourcePayPeriodHour objects which hold the
	 *         assignment information
	 */
	public Collection&lt;WorkResourcePayPeriodHour&gt; getPayPeriodHourAssignments(ID idWorkResource, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="nc" id="L1407">		methodStart(&quot;getPayPeriodHourAssignments&quot;, idWorkResource, dtStart, dtEnd);</span>
<span class="nc" id="L1408">		WorkResourcePayPeriodHourDAO dao = new WorkResourcePayPeriodHourDAO();</span>
		try {
<span class="nc" id="L1410">			List&lt;ID&gt; aWorkResources = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L1411">			aWorkResources.add(idWorkResource);</span>
<span class="nc" id="L1412">			return dao.getPayPeriodHourAssignments(aWorkResources, dtStart, dtEnd).get(idWorkResource);</span>
<span class="nc" id="L1413">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1414">			handleException(e, false);</span>
<span class="nc" id="L1415">			throw e;</span>
		} finally {
<span class="nc" id="L1417">			dao.cleanUp();</span>
<span class="nc" id="L1418">			methodFinish();</span>
		}
	}

	/**
	 * get a collection of workresources' required pay period hour assignments
	 *
	 * @colWorkResourceIDs a collection of work resource ids
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 * @return a HashMap of following pairs (idWorkResource, array list of
	 *         WorkResourcePayPeriodHour objects)
	 */
	public Map&lt;ID, List&lt;WorkResourcePayPeriodHour&gt;&gt; getPayPeriodHourAssignments(Collection&lt;ID&gt; colWorkResourceIDs,
			Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L1433">		methodStart(&quot;getPayPeriodHourAssignments&quot;, colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L1434">		WorkResourcePayPeriodHourDAO dao = new WorkResourcePayPeriodHourDAO();</span>
		try {
<span class="nc" id="L1436">			return dao.getPayPeriodHourAssignments(colWorkResourceIDs, dtStart, dtEnd);</span>
<span class="nc" id="L1437">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1438">			handleException(e, false);</span>
<span class="nc" id="L1439">			throw e;</span>
		} finally {
<span class="nc" id="L1441">			dao.cleanUp();</span>
<span class="nc" id="L1442">			methodFinish();</span>
		}
	}

	/** create a required pay period hour assignment */
	public ID createPayPeriodHourAssignment(WorkResourcePayPeriodHour objValue) throws BbmCreateException {
<span class="nc" id="L1448">		methodStart(&quot;createPayPeriodHourAssignment&quot;, objValue);</span>
<span class="nc" id="L1449">		WorkResourcePayPeriodHourDAO dao = new WorkResourcePayPeriodHourDAO();</span>
		try {
<span class="nc" id="L1451">			return dao.createPayPeriodHourAssignment(objValue);</span>
<span class="nc" id="L1452">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L1453">			handleException(e);</span>
<span class="nc" id="L1454">			throw e;</span>
		} finally {
<span class="nc" id="L1456">			dao.cleanUp();</span>
<span class="nc" id="L1457">			methodFinish();</span>
		}
	}

	/** save a required pay period hour assignment */
	public void updatePayPeriodHourAssignment(WorkResourcePayPeriodHour objValue, boolean bSaveAsNew)
			throws MultiUserException, BbmUpdateException {
<span class="nc" id="L1464">		methodStart(&quot;updatePayPeriodHourAssignment&quot;, objValue);</span>
<span class="nc" id="L1465">		WorkResourcePayPeriodHourDAO dao = new WorkResourcePayPeriodHourDAO();</span>
		try {
<span class="nc" id="L1467">			dao.updatePayPeriodHourAssignment(objValue, bSaveAsNew);</span>
<span class="nc" id="L1468">		} catch (MultiUserException e) {</span>
<span class="nc" id="L1469">			handleException(e);</span>
<span class="nc" id="L1470">			throw e;</span>
<span class="nc" id="L1471">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L1472">			handleException(e);</span>
<span class="nc" id="L1473">			throw e;</span>
		} finally {
<span class="nc" id="L1475">			dao.cleanUp();</span>
<span class="nc" id="L1476">			methodFinish();</span>
<span class="nc" id="L1477">		}</span>
<span class="nc" id="L1478">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>