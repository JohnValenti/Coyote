<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueFormPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload.queue</a> &gt; <span class="el_source">QueueFormPageModel.java</span></div><h1>QueueFormPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload.queue;

import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.ResourceBundle;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.keys.DBInfo;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.HtmlEncoder;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationUtil;
import com.bluepumpkin.web.bbm.organization.setup.datasource.group.GroupMH;
import com.bluepumpkin.web.bbm.organization.tree.OrganizationTreeHelper;
import com.bluepumpkin.web.bbm.workload.WorkloadModelHandler;
import com.bluepumpkin.web.bbm.workload.WorkloadModelHandler.QueueType;
import com.bluepumpkin.web.bbm.workload.queue.mapping.QueueGroupMH;
import com.bluepumpkin.web.core.setup.mediatypes.MediaTypesSetupPageModel;
import com.verint.web.wfm.keys.WfmJavaScriptFileID;
import com.witness.ejb.core.licensing.ejb.LicenseManager;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.list.DualListBoxPC;
import com.witness.web.uif.pagecomponent.list.OptionData;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagemodel.WorkpaneFormPageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;
import com.witness.web.uif.validator.IsEnteredFieldValidator;

/**
 * Title:        QueueFormPageModel
 * Description:  Display the form page for Queue
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, inc
 * @author       Shimon Kakon
 * @version 1.0
 */
public class QueueFormPageModel extends WorkpaneFormPageModel {
<span class="nc" id="L58">	private static final Category log = Log.initCategory(QueueFormPageModel.class.getName());</span>
	protected ResourceBundle m_bbmBundle;
	
	private Queue m_queue;
	private Collection&lt;StringsPair&gt; m_mediaStringPairs;
	private Collection&lt;StringsPair&gt; m_typeStringPairs;
	private Collection&lt;StringsPair&gt; m_organizationStringPairs;
	private FormTwoColumnPC m_formPC;
<span class="nc" id="L66">	private boolean m_isAddMode= false;</span>
	private boolean m_refreshSelection;
	private boolean m_isListMode;
	private DualListBoxPC m_dualPC;
	
	//Default values
<span class="nc" id="L72">	private static final ID MEDIA_DEFAULT_VALUE = Media.MEDIA_ID_PHONE;</span>

	public QueueFormPageModel(RequestContext context) {
<span class="nc" id="L75">		super(context, QueueFormPageModel.FRAMED_MODEL);</span>
		
<span class="nc" id="L77">		m_bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
		
		// Initialize Form PC
<span class="nc" id="L80">		m_formPC = new FormTwoColumnPC(context);</span>
<span class="nc" id="L81">		addChildComponent(m_formPC);</span>
	
<span class="nc" id="L83">		m_dualPC = new DualListBoxPC(context);</span>
<span class="nc" id="L84">		m_queue = new Queue();</span>
		
<span class="nc" id="L86">		addJSVariable(DELETE_CONFIRMATION, m_bbmBundle, BbmWebBundleKey.QUEUE_DELETE_CONFIRM);</span>
<span class="nc" id="L87">	}</span>

	public void initForDisplay() {
<span class="nc bnc" id="L90" title="All 2 branches missed.">		if (m_isInitializedForDisplay) return;</span>
		
<span class="nc" id="L92">		super.initForDisplay();</span>
		
<span class="nc" id="L94">		this.setSelectedID(OrganizationUtil.getSelectedOrganizationID(m_context));</span>
<span class="nc" id="L95">		QueueUtil.setSelectedQueueID(m_context, this.getPerformActionOnID());</span>
	
		// Component specific required JavaScript Files
<span class="nc" id="L98">		addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE);</span>
<span class="nc" id="L99">		setJSMediator(WfmJavaScriptFileID.MEDIATOR_QUEUE_WORKPANE_FORM);</span>

<span class="nc" id="L101">		m_context.setAttribute(RequestContext.SESSION_SCOPE, &quot;CACHED_QUEUE_ID&quot;, this.getPerformActionOnID());</span>
		
		// Add JavaScript Variables
<span class="nc" id="L104">		addJSVariable(DELETE_CONFIRMATION, m_bbmBundle, BbmWebBundleKey.QUEUE_DELETE_CONFIRM);</span>

<span class="nc" id="L106">		initForm();</span>
<span class="nc" id="L107">		initToolbar();</span>
<span class="nc" id="L108">	}</span>

	public static QueueFormPageModel getInstance(RequestContext context) {

<span class="nc" id="L112">		QueueFormPageModel model = null;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">		if (context.getPageModel() != null) {</span>
<span class="nc" id="L114">			model = (QueueFormPageModel)context.getPageModel();</span>
		} else {
<span class="nc" id="L116">			model = new QueueFormPageModel(context);</span>
<span class="nc" id="L117">			model.extractParameters(context.getRequest());</span>
<span class="nc" id="L118">			context.setPageModel(model);</span>
		}
<span class="nc" id="L120">		model.createFormModel();</span>
<span class="nc" id="L121">		return model;</span>
	}

	/**
	 * Initialize Toolbar
	 */
	protected void initToolbar() {
<span class="nc" id="L128">		m_toolbar.setName(getName() + &quot;_toolbar&quot;);</span>
<span class="nc" id="L129">		m_toolbar.setAlignment(ToolbarPC.ALIGN_RIGHT);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">		boolean isSelectedID = !StringUtil.isEmpty(QueueUtil.getSelectedQueueID(m_context));</span>

	    // verticalise queue
<span class="nc" id="L133">	    Object[] args = new Object[1];</span>
<span class="nc" id="L134">	    args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUESMALL);</span>

<span class="nc" id="L136">		String addLabel = MessageFormat.format( i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_CREATE_ACTION), args);</span>
<span class="nc" id="L137">		String copyLabel = MessageFormat.format( i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_COPY_ACTION), args);</span>
<span class="nc" id="L138">		String deleteLabel = MessageFormat.format( i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_DELETE_ACTION), args);</span>
<span class="nc bnc" id="L139" title="All 4 branches missed.">		if(!m_isAddMode &amp;&amp; !m_isListMode) {</span>
<span class="nc" id="L140">			m_toolbar.addSubmitTextButton(PageAction.CREATE_NEW,</span>
<span class="nc" id="L141">				addLabel, isAuthorizedToConfigure());</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">			m_toolbar.addValidateSubmitTextButton(PageAction.COPY,</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">				copyLabel, isSelectedID &amp;&amp; isAuthorizedToConfigure());</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">			m_toolbar.addValidateSubmitTextButton(PageAction.QUEUE_DELETE_ACTION,</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">				deleteLabel, isSelectedID &amp;&amp; isAuthorizedToConfigure());</span>
		}

<span class="nc" id="L148">		m_toolbar.addValidateSubmitTextButton(PageAction.SAVE,</span>
<span class="nc bnc" id="L149" title="All 6 branches missed.">		i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SAVE), (isSelectedID || m_isAddMode) &amp;&amp; isAuthorizedToConfigure());</span>

<span class="nc bnc" id="L151" title="All 4 branches missed.">		if (m_isAddMode || m_isListMode) {</span>
<span class="nc" id="L152">			m_toolbar.addConfirmSubmitTextButton(PageAction.CANCEL,</span>
<span class="nc" id="L153">				i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_CANCEL), true);</span>
		}
<span class="nc" id="L155">		m_toolbar.addResetTextButton(PageAction.RESET,</span>
<span class="nc bnc" id="L156" title="All 8 branches missed.">			i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_RESET), (isSelectedID || m_isAddMode || m_isListMode) &amp;&amp; isAuthorizedToConfigure());</span>
<span class="nc" id="L157">	}</span>


	protected void createFormModel() {
		//add page message if no privileges
<span class="nc bnc" id="L162" title="All 2 branches missed.">		if (!isAuthorizedToConfigure()){</span>
	      // verticalise queue
<span class="nc" id="L164">	      Object[] args = new Object[1];</span>
<span class="nc" id="L165">	      args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUESMALL);</span>
	
<span class="nc" id="L167">	      addPageMessage(Message.INFO_TYPE, MessageFormat.format( i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_NOTAUTHORIZED_CONFIGURE), args));</span>
	    }

		try {
<span class="nc" id="L171">			this.setSelectedID(OrganizationUtil.getSelectedOrganizationID(m_context));</span>
<span class="nc" id="L172">			QueueUtil.setSelectedQueueID(m_context, this.getPerformActionOnID());</span>
			
			
			
<span class="nc bnc" id="L176" title="All 2 branches missed.">		    if(!QueueUtil.getSelectedQueueID(m_context).equals(&quot;&quot;)) {</span>
<span class="nc" id="L177">		        m_queue = WorkloadModelHandler.getQueueByID(m_context, new ID(QueueUtil.getSelectedQueueID(m_context)));</span>
		    }
			    
			
<span class="nc" id="L181">			String title = getLocalizer().i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_SETTINGS);</span>
<span class="nc" id="L182">			Object[] args = new Object[1];</span>
<span class="nc" id="L183">			args[0] = m_context.getSystemManagerFactory()</span>
<span class="nc" id="L184">			  .getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="nc" id="L185">			String formattedTitle = MessageFormat.format(title, args);		</span>
			
<span class="nc bnc" id="L187" title="All 4 branches missed.">			if(!m_isAddMode &amp;&amp; this.hasPerformActionOnID()) {</span>
<span class="nc" id="L188">				m_queue = WorkloadModelHandler.getQueueByID(m_context, new ID(QueueUtil.getSelectedQueueID(m_context)));</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">				if (m_queue == null){</span>
					//means that the queue could not be found, set selectedID to null
					//setSelectedID(&quot;&quot;);
<span class="nc" id="L192">					QueueUtil.setSelectedQueueID(m_context, &quot;&quot;);</span>
				}

			
<span class="nc bnc" id="L196" title="All 2 branches missed.">				this.getContentTitle().setProperties(formattedTitle, m_queue!=null?m_queue.getName():&quot;&quot;);</span>
				
			}
			else {
				//this.getContentTitle().setProperties(i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_SETTINGS), &quot;&quot;);
<span class="nc" id="L201">				this.getContentTitle().setProperties(formattedTitle, &quot;&quot;);</span>
<span class="nc" id="L202">				setDefaultValues();</span>
			}

<span class="nc bnc" id="L205" title="All 4 branches missed.">			if (!this.hasPerformActionOnID() &amp;&amp; !m_isAddMode) {</span>
		        // verticalise queue
<span class="nc" id="L207">		        args = new Object[1];</span>
<span class="nc" id="L208">		        args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>

<span class="nc" id="L210">				addPageMessage(Message.RESPONSE_TYPE, MessageFormat.format( i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_MAKE_SELECTION), args));</span>
			}

			// load media for the drop down
<span class="nc" id="L214">			m_mediaStringPairs = getMediaStringsPair();</span>
<span class="nc" id="L215">			m_typeStringPairs = getQueueTypeStringsPair();</span>
<span class="nc" id="L216">			m_organizationStringPairs = getQueueOrganizationStringsPair();</span>
			
			
<span class="nc" id="L219">		} catch (Exception ex) {</span>
<span class="nc" id="L220">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L221">			m_initFailure = true;</span>
<span class="nc" id="L222">		}</span>
<span class="nc" id="L223">	}</span>

	/**
	 * Return Collection of Media StringsPair (String mediaId, String mediaName)
	 */
	 @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
	private Collection&lt;StringsPair&gt; getMediaStringsPair() throws Exception {
<span class="nc" id="L230">		 Collection&lt;StringsPair&gt; stringPairs = WorkloadModelHandler.getMediaWithStrIDStringsPairList(m_context, m_localizer);</span>
<span class="nc" id="L231">		 Collection&lt;StringsPair&gt; licensedStringPairs = new ArrayList(stringPairs.size());</span>

<span class="nc" id="L233">		 LicenseManager licManager = CoreManagerFactory.getLicenseManager();</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">		 for (Iterator&lt;StringsPair&gt; it = stringPairs.iterator(); it.hasNext();) {</span>
<span class="nc" id="L235">			 StringsPair stringPair = it.next();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">			 if (MediaTypesSetupPageModel.isLicensedForMedia(licManager, stringPair.getKey())) {</span>
<span class="nc" id="L237">				 licensedStringPairs.add(stringPair);</span>
			 }
<span class="nc" id="L239">		 }</span>
<span class="nc" id="L240">		 return licensedStringPairs;</span>
	 }

	/**
	 * Return Collection of Type StringsPair (String type, String TypeString)
	 */
	private Collection&lt;StringsPair&gt; getQueueTypeStringsPair() throws Exception {
<span class="nc" id="L247">		return WorkloadModelHandler.getQueueTypeStringsPairList(m_localizer);</span>
	}
	
	private Collection&lt;StringsPair&gt; getQueueOrganizationStringsPair() throws Exception {
<span class="nc" id="L251">		Collection&lt;Organization&gt; collOrgs = OrganizationModelHandler.getAllOrgsInUserScope(m_context, m_context.getUser());</span>
<span class="nc" id="L252">		Collection&lt;StringsPair&gt; collStringPair = OrganizationTreeHelper.createOrgNameList(collOrgs, m_localizer);</span>
<span class="nc" id="L253">		Collections.sort((ArrayList)collStringPair);</span>
<span class="nc" id="L254">		return collStringPair;</span>
	}

	protected void initForm() {
<span class="nc" id="L258">		setForm(m_formPC);</span>

<span class="nc" id="L260">		m_formPC.setTitle(getFormTitle());</span>

<span class="nc" id="L262">		m_formPC.addRow(getNameLabel(), HtmlUtil.makeTextInput(QueueFields.NAME_FN, 50, DBInfo.QUEUE_NAME_MAXLENGTH, getQueueName(), JSUtil.ON_CHANGE));</span>
<span class="nc" id="L263">		m_formPC.addRow(getDescriptionLabel(), HtmlUtil.makeTextInput(QueueFields.DESCRIPTION_FN, 50, 50,</span>
<span class="nc" id="L264">			getQueueDescription(), JSUtil.ON_CHANGE));</span>
		try
		{
<span class="nc" id="L267">			m_formPC.addRow(getMediaLabel(), getQueueMediaDropDown());</span>
<span class="nc" id="L268">			m_formPC.addRow(getQueueTypeLabel(), getQueueTypeDropDown());</span>
<span class="nc" id="L269">			m_formPC.addRow(getQueueOrganizationLabel(), getQueueOrganizationDropDown());</span>
		}
<span class="nc" id="L271">		catch(Exception exp)</span>
		{
<span class="nc" id="L273">			handleUnableToLoadDataError(log, exp);</span>
<span class="nc" id="L274">			m_initFailure = true;</span>
<span class="nc" id="L275">		}</span>

<span class="nc" id="L277">		m_formPC.addRow(i18n(m_bbmBundle, BbmWebBundleKey.BBM_ORG_WORKLOADS_GROUPS_MAPPING), getMappingsStr());</span>

<span class="nc" id="L279">		m_context.addGenericHTML(HtmlUtil.makeHiddenInput(QueueFields.PARENT_FN, m_queue.getParentQueueID()));</span>
<span class="nc" id="L280">	}</span>

	/**
	 * Return Invalid Entry Characters.  Used to assist JS framework to prevent
	 * these characters
	 */
	protected String getInvalidEntryChars() {
<span class="nc" id="L287">		return HtmlUtil.INVALID_ENTRY_CHARS + &quot;'&quot;;</span>
	}
	
	protected void initDualListBoxPC() throws Exception {
<span class="nc" id="L291">		Collection&lt;StringsPair&gt; mediaStrPairCol = getMediaStringsPair();</span>
<span class="nc" id="L292">		Collection&lt;OptionData&gt; queOptionDataCol = convertQueueTypeStrPairToOptionData(getQueueTypeStringsPair());</span>
<span class="nc" id="L293">		Collection&lt;OptionData&gt; mediaCol = new ArrayList&lt;OptionData&gt;();</span>
<span class="nc" id="L294">		String mediaId = this.getMediaId();</span>
<span class="nc" id="L295">		HashMap&lt;OptionData, Collection&lt;OptionData&gt;&gt; options = </span>
				new HashMap&lt;OptionData, Collection&lt;OptionData&gt;&gt;(); 
<span class="nc bnc" id="L297" title="All 2 branches missed.">		for (Iterator&lt;StringsPair&gt; iter = mediaStrPairCol.iterator();iter.hasNext();) {</span>
<span class="nc" id="L298">			StringsPair pair = (StringsPair) iter.next();</span>
<span class="nc" id="L299">			OptionData optData = new OptionData(pair.getValue(), pair.getKey());</span>
<span class="nc" id="L300">			optData.setSelected(pair.getKey().equalsIgnoreCase(mediaId));</span>
<span class="nc" id="L301">			mediaCol.add(optData);</span>
<span class="nc" id="L302">			options.put(optData, getQueueTypes(pair.getKey(), queOptionDataCol));</span>
<span class="nc" id="L303">		}</span>
<span class="nc" id="L304">		m_dualPC.setPrimaryListName(QueueFields.MEDIA_FN);</span>
<span class="nc" id="L305">		m_dualPC.setSecondaryListName(QueueFields.TYPE_FN);</span>
<span class="nc" id="L306">		m_dualPC.setOnChange(JSUtil.ON_CHANGE);</span>
<span class="nc" id="L307">		m_dualPC.setOptionValue(mediaCol,options);</span>
<span class="nc" id="L308">	}</span>

	private Collection&lt;OptionData&gt; getQueueTypes(String mediaID, Collection&lt;OptionData&gt; queueTypesCol) {
		//TODO: change to use SID instead 
<span class="nc bnc" id="L312" title="All 2 branches missed.">		if (mediaID.equalsIgnoreCase(&quot;ID_PHONE_OUT&quot;)) {</span>
<span class="nc" id="L313">			Collection&lt;OptionData&gt; newCol = new ArrayList&lt;OptionData&gt;();</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">			for(Iterator&lt;OptionData&gt; iter = queueTypesCol.iterator();iter.hasNext();) {</span>
<span class="nc" id="L315">				OptionData optData = iter.next();</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">				if (optData.getKey().equalsIgnoreCase(String.valueOf(QueueType.NORMAL))) {</span>
<span class="nc" id="L317">					newCol.add(optData);</span>
<span class="nc" id="L318">					break;</span>
				}
<span class="nc" id="L320">			}</span>
<span class="nc" id="L321">			return newCol;</span>
		}
<span class="nc" id="L323">		else return queueTypesCol;</span>
	}

	private Collection&lt;OptionData&gt; convertQueueTypeStrPairToOptionData(Collection&lt;StringsPair&gt; strPairCol) {
<span class="nc" id="L327">		Collection&lt;OptionData&gt; retVal = new ArrayList&lt;OptionData&gt;();</span>
<span class="nc" id="L328">		String queueType = this.getQueueType();</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">		for (Iterator&lt;StringsPair&gt; iter = strPairCol.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L330">			StringsPair pair = iter.next();</span>
<span class="nc" id="L331">			OptionData optData = new OptionData(pair.getValue(),pair.getKey());</span>
<span class="nc" id="L332">			optData.setSelected(pair.getKey().equalsIgnoreCase(queueType));</span>
<span class="nc" id="L333">			retVal.add(optData);</span>
<span class="nc" id="L334">		}</span>
<span class="nc" id="L335">		return retVal;</span>
	}

	private boolean isNotAllowChanges() throws Exception
	{
<span class="nc bnc" id="L340" title="All 2 branches missed.">			return (!getIsAddMode()&amp;&amp;</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">			        (WorkloadModelHandler.isQueueParent(m_context,m_queue.getID())||</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">			        m_queue.getParentID()!=null||</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">			        WorkloadModelHandler.isQueueLinkedToCampaign(m_queue.getID())||</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">			        !QueueGroupMH.getLinkedGroupIDsForQueue(m_queue.getID()).isEmpty()));</span>
	}

	/**
	 * Return the DropDown display of Queue Types
	 * with the current selected Data Source Type choosen
	 */
	public Object getQueueMediaDropDown() throws Exception{
<span class="nc bnc" id="L352" title="All 2 branches missed.">		if (isNotAllowChanges())</span>
		{
<span class="nc" id="L354">		    return m_queue.getMediaName() + HtmlUtil.makeHiddenInput(&quot;mediaId&quot;, m_queue.getMediaStrID());</span>
		}
<span class="nc" id="L356">		return HtmlUtil.makeSelectInput(QueueFields.MEDIA_FN, getMediaId(),</span>
			JSUtil.ON_CHANGE, m_mediaStringPairs)
<span class="nc" id="L358">			+ HtmlUtil.makeHiddenInput(&quot;isAddMode&quot;, String.valueOf(m_isAddMode))</span>
<span class="nc" id="L359">			+ HtmlUtil.makeHiddenInput(&quot;isListMode&quot;, String.valueOf(m_isListMode));</span>

	}
	
	public String getQueueParentName() throws Exception {
<span class="nc" id="L364">		return HtmlUtil.makeTextReadOnlyInput(QueueFields.PARENT_FN, 20, m_queue.getParentQueueID());</span>
	}

	public String getRequiredHTML()
	{
<span class="nc" id="L369">		return super.getRequiredHTML() +</span>
<span class="nc" id="L370">				HtmlUtil.makeHiddenInput(&quot;isAddMode&quot;, String.valueOf(m_isAddMode));</span>
	}

	private String getQueueTypeString() {
<span class="nc" id="L374">		StringBuffer sb = new StringBuffer(1024);</span>
<span class="nc bnc" id="L375" title="All 5 branches missed.">		switch ( m_queue.getQueueType() )</span>
		{
			case Queue.QUEUE_TYPE_NORMAL:
<span class="nc" id="L378">			    sb.append(HtmlEncoder.encode(m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_TYPE_NORMAL)));</span>
<span class="nc" id="L379">			    break;</span>
			case Queue.QUEUE_TYPE_VIRTUAL:
<span class="nc" id="L381">			    sb.append(HtmlEncoder.encode(m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_TYPE_VIRTUAL)));</span>
<span class="nc" id="L382">			    break;</span>
			case Queue.QUEUE_TYPE_DISTRIBUTED:
<span class="nc" id="L384">			    sb.append(HtmlEncoder.encode(m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_TYPE_DISTRIBUTED)));</span>
<span class="nc" id="L385">			    break;</span>
			case Queue.QUEUE_TYPE_PROCESS:
<span class="nc" id="L387">			    sb.append(HtmlEncoder.encode(m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.QUEUE_TYPE_PROCESS)));</span>
			    break;
		}
<span class="nc" id="L390">		return sb.toString();</span>
	}
	
	
	
	/**
	 * Return the DropDown display of Queue Types
	 * with the current selected Data Source Type choosen
	 */
	public String getQueueTypeDropDown() throws Exception{

<span class="nc bnc" id="L401" title="All 2 branches missed.">		if (isNotAllowChanges())</span>
		{
<span class="nc" id="L403">			return getQueueTypeString() + HtmlUtil.makeHiddenInput(&quot;queueType&quot;, m_queue.getQueueType());</span>
		}

<span class="nc" id="L406">		return HtmlUtil.makeSelectInput(QueueFields.TYPE_FN, getQueueType(),</span>
                              			JSUtil.ON_CHANGE, m_typeStringPairs)
<span class="nc" id="L408">                              			+ HtmlUtil.makeHiddenInput(&quot;isAddMode&quot;, String.valueOf(m_isAddMode))</span>
<span class="nc" id="L409">                              			+ HtmlUtil.makeHiddenInput(&quot;isListMode&quot;, String.valueOf(m_isListMode));</span>

	}
	
	/**
	 * Return the DropDown display of organizations
	 */
	public String getQueueOrganizationDropDown() throws Exception{
<span class="nc" id="L417">		return HtmlUtil.makeSelectInput(QueueFields.OWNER_ORG_FN, getOrganizationId(),</span>
      			JSUtil.ON_CHANGE, m_organizationStringPairs)
<span class="nc" id="L419">      			+ HtmlUtil.makeHiddenInput(&quot;isAddMode&quot;, String.valueOf(m_isAddMode))</span>
<span class="nc" id="L420">      			+ HtmlUtil.makeHiddenInput(&quot;isListMode&quot;, String.valueOf(m_isListMode));</span>
	}
	

	private String getMappingsStr() {
<span class="nc" id="L425">		String mappingStr = &quot;&amp;nbsp;&quot;;</span>
		try {
<span class="nc bnc" id="L427" title="All 4 branches missed.">			if (m_queue != null &amp;&amp; !m_isAddMode){</span>
<span class="nc" id="L428">				StringBuffer str = new StringBuffer(50);</span>
<span class="nc" id="L429">				ArrayList&lt;ID&gt; queues = new ArrayList&lt;ID&gt;(1);</span>
<span class="nc" id="L430">				ID queueID = new ID(QueueUtil.getSelectedQueueID(m_context));</span>
<span class="nc" id="L431">				queues.add(queueID);</span>
				//get mappings for the queue
<span class="nc" id="L433">				HashMap map = QueueGroupMH.getLinkedGroupIDsForQueues(queues);</span>
<span class="nc bnc" id="L434" title="All 4 branches missed.">				if (map != null &amp;&amp; map.size()&gt;0){</span>
<span class="nc" id="L435">					ArrayList groupList = (ArrayList)map.get(queueID);</span>

					//now get the group names for thr ids
<span class="nc" id="L438">					HashMap nameMap = GroupMH.getGroupNamesByIDs(groupList);</span>
<span class="nc" id="L439">					int i=0;</span>
<span class="nc" id="L440">					Iterator it = nameMap.values().iterator();</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">					while (it.hasNext()) {</span>
						// Get value
<span class="nc" id="L443">						String value = (String)it.next();</span>
<span class="nc" id="L444">						str.append(value);</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">						if (i&lt;nameMap.size()-1)</span>
<span class="nc" id="L446">							str.append(&quot;, &quot;);</span>
<span class="nc" id="L447">						i++;</span>
<span class="nc" id="L448">					}</span>
<span class="nc" id="L449">					mappingStr = str.toString();</span>
				}
			}
<span class="nc" id="L452">		} catch (Exception ex) {</span>
<span class="nc" id="L453">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L454">		}</span>
<span class="nc" id="L455">		return mappingStr;</span>
	}

	protected void initFieldValidators() {
<span class="nc" id="L459">		addValidator(new IsEnteredFieldValidator(this, QueueFields.NAME_FN,</span>
			UIFWebBundleKey.LABEL_NAME, UIFWebBundleKey.BUNDLE_NAME));
<span class="nc" id="L461">	}</span>

	public ID getQueueId() {
<span class="nc bnc" id="L464" title="All 2 branches missed.">		if (m_performActionOnIDs == null) {</span>
<span class="nc" id="L465">			return null;</span>
		}
		else {
<span class="nc" id="L468">			return m_performActionOnIDs[getEditIndex()];</span>
		}
	}

	public Queue getQueue() {
<span class="nc" id="L473">		m_queue.setID(getQueueId());</span>
<span class="nc" id="L474">		return m_queue;</span>
	}

	public void setQueue(){
<span class="nc" id="L478">		m_queue = new Queue();</span>
<span class="nc" id="L479">	}</span>

	public void setQueueName(String name) {
<span class="nc" id="L482">		m_queue.setName(name);</span>
<span class="nc" id="L483">	}</span>

	public String getQueueName() {
<span class="nc" id="L486">		return m_queue.getName();</span>
	}
	
	

	public void setQueueDescription(String description) {
<span class="nc" id="L492">		m_queue.setDescription(description);</span>
<span class="nc" id="L493">	}</span>

	public String getQueueDescription() {
<span class="nc" id="L496">		return m_queue.getDescription();</span>
	}

	public void setMediaId(String id) {
<span class="nc bnc" id="L500" title="All 2 branches missed.">		if(!StringUtil.isEmpty(id)) {</span>
<span class="nc" id="L501">			m_queue.setMediaStrID(id.trim());</span>
		}
<span class="nc" id="L503">	}</span>

	public void setParentID(String id)
	{
<span class="nc" id="L507">	    m_queue.setParentQueueID(id);</span>
<span class="nc" id="L508">	}</span>
	
	public String getParentID()
	{
<span class="nc" id="L512">	    return m_queue.getParentQueueID();</span>
	}
	
	public String getMediaId() {
<span class="nc" id="L516">		String id = m_queue.getMediaStrID().trim();</span>
<span class="nc bnc" id="L517" title="All 4 branches missed.">		if( id != null &amp;&amp; !id.equals(&quot;&quot;)) {</span>
<span class="nc" id="L518">			return id;</span>
		}
		else {
<span class="nc" id="L521">			return &quot;ID_PHONE&quot;;</span>
		}
	}
	
	public void setOrganizationId(String id) {
<span class="nc bnc" id="L526" title="All 2 branches missed.">		if(!StringUtil.isEmpty(id)) {</span>
<span class="nc" id="L527">			m_queue.setOrganizationID(new ID(id));</span>
		}
<span class="nc" id="L529">	}</span>
	
	public String getOrganizationId() {	
		try {
<span class="nc" id="L533">			String id = m_queue.getOrganizationID().toString();</span>
<span class="nc bnc" id="L534" title="All 4 branches missed.">			if(id != null &amp;&amp; !id.equals(&quot;&quot;)) {</span>
<span class="nc" id="L535">				return id;</span>
			}
			else {
<span class="nc" id="L538">				return this.getSelectedID();</span>
			}
<span class="nc" id="L540">		} catch (Exception e) {</span>
<span class="nc" id="L541">			return this.getSelectedID();</span>
		}	
	}

	public String getQueueType() {
<span class="nc" id="L546">		return String.valueOf(m_queue.getQueueType());</span>
	}

	public void setQueueType(int type) {
<span class="nc" id="L550">		m_queue.setQueueType(type);</span>
<span class="nc" id="L551">	}</span>

	public String getFormTitle() {
    // verticalise queue
<span class="nc" id="L555">    Object[] args = new Object[1];</span>
<span class="nc" id="L556">    args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context, DefaultVerticalizationManager.QUEUE);</span>
<span class="nc" id="L557">		return MessageFormat.format( i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_FORM_TITLE), args);</span>
	}
 
	protected String getTitleEntityType() {
<span class="nc" id="L561">		return getFormTitle();</span>
	}

	/**
	 * Returns an entity name. Used for title.
	 */
	protected String getEntityName() {
<span class="nc" id="L568">		return getQueueName();</span>
	}

	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc" id="L575">		return &quot;queue&quot;;</span>
	}

	private String getNameLabel() {
<span class="nc" id="L579">		return i18n(m_common_bundle, UIFWebBundleKey.LABEL_NAME);</span>
	}

	private String getDescriptionLabel() {
<span class="nc" id="L583">		return i18n(m_common_bundle, UIFWebBundleKey.LABEL_DESCRIPTION);</span>
	}

	private String getMediaLabel() {
<span class="nc" id="L587">		return i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_LABEL_MEDIA);</span>
	}

	private String getQueueTypeLabel() {
<span class="nc" id="L591">		return i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_LABEL_TYPE);</span>
	}
	
	private String getQueueOrganizationLabel() {
<span class="nc" id="L595">		return i18n(m_bbmBundle, BbmWebBundleKey.ORGANIZATIONS);</span>
	}

	private void setDefaultValues() {
<span class="nc" id="L599">		m_queue.setMediaID(MEDIA_DEFAULT_VALUE);</span>
<span class="nc" id="L600">		m_queue.setQueueType(Queue.QUEUE_TYPE_NORMAL);</span>
<span class="nc" id="L601">	}</span>

	public void setIsAddMode(boolean isAddMode){
<span class="nc" id="L604">    	m_isAddMode = isAddMode;</span>
<span class="nc" id="L605">	}</span>

	public boolean getIsAddMode(){
<span class="nc" id="L608">		return m_isAddMode;</span>
	}

	public void setRefreshSelection(boolean refreshSelection){
<span class="nc" id="L612">    	m_refreshSelection = refreshSelection;</span>
<span class="nc" id="L613">	}</span>

	public boolean getRefreshSelection(){
<span class="nc" id="L616">		return m_refreshSelection;</span>
	}

	public void setIsListMode(boolean isListMode){
<span class="nc" id="L620">    	m_isListMode = isListMode;</span>
<span class="nc" id="L621">	}</span>

	public boolean getIsListMode(){
<span class="nc" id="L624">		return m_isListMode;</span>
	}

	/**
	 * Return the JavaScript init code required by Page model.
	 *
	 * Default behavior is to retrieve sub-component JavaScript Init code
	 */
	public String getJavaScriptInitCode() {
<span class="nc" id="L633">		StringBuffer jsInit = new StringBuffer(1000);</span>

<span class="nc" id="L635">		jsInit.append(super.getJavaScriptInitCode());</span>

<span class="nc bnc" id="L637" title="All 4 branches missed.">		if (m_refreshSelection &amp;&amp; !m_isListMode) {</span>
<span class="nc" id="L638">			jsInit.append(getPageMediatorRef() + &quot;.refreshSelectionPane();\n&quot;);</span>
		}

<span class="nc" id="L641">		return jsInit.toString();</span>
	}

	protected boolean isAuthorizedToConfigure() {
<span class="nc bnc" id="L645" title="All 2 branches missed.">		return m_context.getUser()!=null &amp;&amp;</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">					 m_context.getUser().isAuthorized(PrivilegeKeys.FS_CONFIGUREQUEUES);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>