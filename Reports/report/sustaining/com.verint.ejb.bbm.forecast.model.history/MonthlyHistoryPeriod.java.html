<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MonthlyHistoryPeriod.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.ejb.bbm.forecast.model.history</a> &gt; <span class="el_source">MonthlyHistoryPeriod.java</span></div><h1>MonthlyHistoryPeriod.java</h1><pre class="source lang-java linenums">/*
 * (c) 2011-2012 Verint Systems, Inc.
 */
package com.verint.ejb.bbm.forecast.model.history;

import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.TimeContext;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.pulse.model.PulseNoteBO;
import com.bluepumpkin.ejb.bbm.time.TimeIntervalAtTime;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.verint.ejb.bbm.forecast.model.history.provider.IHistoryProvider;

import java.util.*;

/**
 * A ProfileEntryHistoryPeriod that represents a &quot;month&quot;.  In reality,
 * the period only contains a maximum of 7 days like the other periods,
 * however the days in the period are correlated to the selected month
 * and the period's sp week.  For example, if the SP week was
 * March 15, 2011 to March 21, 2011, and the selected month/year for this history
 * period was October 2011, the days in this period would be October 15, 2011 -
 * October 21, 2011.
 */
public class MonthlyHistoryPeriod extends ProfileEntryHistoryPeriod {

	private final int month;
	private final int year;
	
	public MonthlyHistoryPeriod(List&lt;TimeIntervalAtTime&gt; daysInPeriod, Date spWeekStartDate,
			int month, int year, TimeContext timeContext) {
<span class="nc" id="L35">		super(daysInPeriod, spWeekStartDate, timeContext);</span>
<span class="nc" id="L36">		this.month = month;</span>
<span class="nc" id="L37">		this.year = year;</span>
<span class="nc" id="L38">	}</span>

	@Override
	public ProfileEntryIntervalType getIntervalType() {
<span class="nc" id="L42">		return ProfileEntryIntervalType.Month;</span>
	}

	@Override
	public String getLocalizedDescription(Localizer localizer) {
<span class="nc" id="L47">		Calendar cal = Calendar.getInstance(getTimeContext().getTimeZone());</span>
<span class="nc" id="L48">		cal.set(Calendar.YEAR, year);</span>
<span class="nc" id="L49">		cal.set(Calendar.MONTH, month - 1);</span>
		
<span class="nc" id="L51">		return localizer.formatDate(cal.getTime(), getTimeContext().getTimeZone(),</span>
						RegionalFormatBundleKey.DATE_MONTH_YEAR_FORMAT);
	}

	/**
	 * We have to override this method because for some reason, the FS client does not
	 * store these custom dates for monthly periods at midnight GMT but instead at day boundary GMT.
	 * Dates for Custom Week periods are indeed stored at midnight.
	 */
	@Override
	public List&lt;Date&gt; getDatesInPeriod() {
<span class="nc" id="L62">		List&lt;Date&gt; retVal = new ArrayList&lt;Date&gt;();</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">		for (TimeIntervalAtTime interval : daysInPeriod) {</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">			if (interval != null) {</span>
<span class="nc" id="L65">				LocalDate ld = new LocalDate(interval.getStartTime(), interval.getTimeContext().getTimeZone());</span>
<span class="nc" id="L66">				retVal.add(ld.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
<span class="nc" id="L67">			} else {</span>
<span class="nc" id="L68">				retVal.add(null);</span>
			}
<span class="nc" id="L70">		}</span>
<span class="nc" id="L71">		return retVal;</span>
	}
	
	/**
	 * The time interval representing a monthly history period is a &quot;fake&quot; week
	 * interval in Decemeber 2000, with a week start matching the view's time
	 * context.  This is done because monthly history periods can have &quot;missing&quot;
	 * days, or days in the interval that are effectively null, which can cause
	 * problems while rendering the history data for the period in a chart.  In
	 * order to circumvent this issue, a fake week is constructed so that the chart
	 * thinks this week is getting rendered but in reality the history data matching
	 * the intervals in daysInPeriod is getting rendered.
	 * 
	 * This week interval was chosen because it will not contain any DST transitions.
	 */
	@Override
	protected TimeIntervalAtTime initIntervalRepresentingPeriod() {
<span class="nc" id="L88">		return ProfileEntryHistoryPeriodUtil.getIntervalRepresentingPeriodForMonthlyAndCustomHistoryWeeks(spWeekStartDate,</span>
				timeContext, timeIntervalFactory);
	}

	@Override
	public TraceCube getHistoryTraceCube(IHistoryProvider historyProvider) throws BbmException {
<span class="nc" id="L94">		return ProfileEntryHistoryPeriodUtil.getHistoryTraceCube(historyProvider, getIntervalsInPeriod(),</span>
				intervalRepresentingPeriod, spWeekStartDate, timeContext, timeIntervalFactory);
	}

	@Override
	public Collection&lt;PulseNoteBO&gt; getNotesForPeriod(IHistoryProvider historyProvider) throws BbmException {
<span class="nc" id="L100">		Collection&lt;PulseNoteBO&gt; notesInPeriod = new ArrayList&lt;PulseNoteBO&gt;();</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">		for (TimeIntervalAtTime day : daysInPeriod) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">			if (day != null) {</span>
<span class="nc" id="L103">				notesInPeriod.addAll(historyProvider.getNotes(day));</span>
			}
<span class="nc" id="L105">		}</span>
<span class="nc" id="L106">		return notesInPeriod;</span>
	}

	/**
	 * Returns the (1-based) month of this Monthly History period.
	 * 1 - January, 12 - December
	 */
	public int getMonth() {
<span class="nc" id="L114">		return month;</span>
	}
	
	/**
	 * Returns the year of this Monthly History period.
	 */
	public int getYear() {
<span class="nc" id="L121">		return year;</span>
	}

	/**
	 * Absolute start dates are not used for monthly history periods.
	 * We instead return the spWeekStartDate here, for no real reason
	 * other than the FS client does the same thing.
	 */
	@Override
	public Date getAbsoluteStartDate() {
<span class="nc" id="L131">		return spWeekStartDate;</span>
	}

	/**
	 * Returns the number of months this history period is offset from
	 * its sp week.  If it is 3 months prior, this method will return -3.
	 * If it is 3 months ahead, it returns 3.
	 * This is the opposite of the weekly behavior, which returns positive
	 * values for values prior to the SP.
	 */
	@Override
	public int getRelativeOffsetFromSPWeek() {
<span class="nc" id="L143">		Calendar startCal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L144">		startCal.set(Calendar.YEAR, year);</span>
<span class="nc" id="L145">		startCal.set(Calendar.MONTH, month - 1);</span>
<span class="nc" id="L146">		Calendar spWeekCal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L147">		spWeekCal.setTime(spWeekStartDate);</span>
		
<span class="nc" id="L149">		int monthCount = 0;</span>
		
<span class="nc bnc" id="L151" title="All 2 branches missed.">		if (startCal.before(spWeekCal)) {</span>
			// Add months until the month and year of startCal matches the month and year of the spWeek
<span class="nc bnc" id="L153" title="All 2 branches missed.">			while (spWeekCal.get(Calendar.YEAR) != startCal.get(Calendar.YEAR)) {</span>
<span class="nc" id="L154">				monthCount--;</span>
<span class="nc" id="L155">				startCal.add(Calendar.MONTH, 1);</span>
			}
<span class="nc bnc" id="L157" title="All 2 branches missed.">			while (spWeekCal.get(Calendar.MONTH) != startCal.get(Calendar.MONTH)) {</span>
<span class="nc" id="L158">				monthCount--;</span>
<span class="nc" id="L159">				startCal.add(Calendar.MONTH, 1);</span>
			}
<span class="nc bnc" id="L161" title="All 2 branches missed.">		} else if (startCal.after(spWeekCal)) {</span>
			// Remove months until the month and year of startCal matches the month and year of the spWeek
<span class="nc bnc" id="L163" title="All 2 branches missed.">			while (spWeekCal.get(Calendar.YEAR) != startCal.get(Calendar.YEAR)) {</span>
<span class="nc" id="L164">				monthCount++;</span>
<span class="nc" id="L165">				startCal.add(Calendar.MONTH, -1);</span>
			}
<span class="nc bnc" id="L167" title="All 2 branches missed.">			while (spWeekCal.get(Calendar.MONTH) != startCal.get(Calendar.MONTH)) {</span>
<span class="nc" id="L168">				monthCount++;</span>
<span class="nc" id="L169">				startCal.add(Calendar.MONTH, -1);</span>
			}
		}
		
<span class="nc" id="L173">		return monthCount;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>