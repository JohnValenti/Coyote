<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AdherenceExceptionDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.rtaamanager.ejb</a> &gt; <span class="el_source">AdherenceExceptionDAO.java</span></div><h1>AdherenceExceptionDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.rtaamanager.ejb;

import java.sql.Timestamp;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoPKGenerator;
import com.bluepumpkin.common.jdmo.JdmoPKGeneratorFactory;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.ejb.bbm.rtaamanager.model.AdherenceException;
import com.bluepumpkin.ejb.bbm.rtaamanager.model.AdherenceExceptionFieldInfo;
import com.bluepumpkin.ejb.bbm.rtaamanager.model.PlannedEventTimeLine;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.RTAAException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;

public class AdherenceExceptionDAO extends DAOBase {

<span class="nc" id="L29">	private static FieldInfo m_fieldInfo = new AdherenceExceptionFieldInfo();</span>
<span class="nc" id="L30">	private static JdmoPKGenerator primaryKeyGenerator = JdmoPKGeneratorFactory.create(m_fieldInfo.getTableName(), false);</span>
	
	@Override
	protected FieldInfo getFieldInfo() {
<span class="nc" id="L34">		return m_fieldInfo;</span>
	}
	
	public AdherenceExceptionDAO(Jdmo dmo) {
<span class="nc" id="L38">		super(dmo);</span>
<span class="nc" id="L39">	}</span>

	@Override
	protected ValueObjectBase createValueObject() {
<span class="nc" id="L43">		return new AdherenceException();</span>
	}
	
	public HashMap updateAdheranceExceptions(
			Collection colEmployeeIDs,
			Collection colAdheranceExceptions,
			HashMap pubPlannedEvents,
			Timestamp tsStart,
			Timestamp tsEnd, boolean bAdhocDumpEnabled)
			throws Exception {
		try {
<span class="nc" id="L54">			String inClause = m_dmo.createInClause(colEmployeeIDs);</span>
<span class="nc" id="L55">			Collection actualEvents = groupEventsByWorkResources(colAdheranceExceptions, colEmployeeIDs);</span>
			//get left overlaps
<span class="nc" id="L57">			String startDBString = &quot;'&quot; + JdmoUtil.formatDBString(tsStart) + &quot;'&quot;;</span>
<span class="nc" id="L58">			String endDBString = &quot;'&quot; + JdmoUtil.formatDBString(tsEnd) + &quot;'&quot;;</span>
<span class="nc" id="L59">			StringBuffer strSQL = new StringBuffer();</span>
<span class="nc" id="L60">			strSQL.append(&quot; EMPLOYEEID in &quot;).append(inClause);</span>
<span class="nc" id="L61">			strSQL.append(&quot; and STARTTIME &lt; &quot;).append(startDBString);</span>
<span class="nc" id="L62">			strSQL.append(&quot; and ENDTIME &gt; &quot;).append(startDBString);</span>
<span class="nc" id="L63">			HashMap leftOverlaps = </span>
<span class="nc" id="L64">					ValueObjectUtil.groupByField(AdherenceExceptionFieldInfo.ADHERENCEEXCEPTION_EMPLOYEEID, getObjects(strSQL.toString()));</span>

			//get right overlaps
<span class="nc" id="L67">			strSQL = new StringBuffer();</span>
<span class="nc" id="L68">			strSQL.append(&quot; EMPLOYEEID in &quot;).append(inClause);</span>
<span class="nc" id="L69">			strSQL.append(&quot; and STARTTIME &lt; &quot;).append(endDBString);</span>
<span class="nc" id="L70">			strSQL.append(&quot; and ENDTIME &gt; &quot;).append(endDBString);</span>
<span class="nc" id="L71">			HashMap rightOverlaps = </span>
<span class="nc" id="L72">					ValueObjectUtil.groupByField(AdherenceExceptionFieldInfo.ADHERENCEEXCEPTION_EMPLOYEEID, getObjects(strSQL.toString()));</span>

<span class="nc" id="L74">			AdherenceException leftOverlap = null;</span>
<span class="nc" id="L75">			AdherenceException rightOverlap = null;</span>
<span class="nc" id="L76">			AdherenceException firstNewEvent = null;</span>
<span class="nc" id="L77">			AdherenceException lastNewEvent = null;</span>

<span class="nc" id="L79">			ArrayList insert = new ArrayList();</span>
			//ArrayList update = new ArrayList();
<span class="nc" id="L81">			HashSet delete = new HashSet();</span>
<span class="nc" id="L82">			ArrayList colFieldValues = new ArrayList();</span>

<span class="nc" id="L84">			JdmoPKGenerator pKGenerator = JdmoPKGeneratorFactory.create(m_fieldInfo.getTableName(), false);</span>
<span class="nc" id="L85">			Iterator iterID = colEmployeeIDs.iterator();</span>
<span class="nc" id="L86">			Iterator itEvents = actualEvents.iterator();</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">			for (; itEvents.hasNext();) {</span>
<span class="nc" id="L88">				Collection exceptionPerEmp = (Collection)itEvents.next();</span>
<span class="nc" id="L89">				ID idEmployee = (ID)iterID.next();</span>
<span class="nc bnc" id="L90" title="All 4 branches missed.">				if (exceptionPerEmp == null || exceptionPerEmp.isEmpty()) {</span>
<span class="nc" id="L91">					continue;</span>
				}

<span class="nc" id="L94">				Collection plannedEvents = (Collection)pubPlannedEvents.get(idEmployee);</span>
<span class="nc" id="L95">				ArrayList newAdherenceExceptions = new ArrayList();</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">				for (Iterator itEvent = exceptionPerEmp.iterator(); itEvent.hasNext();) {</span>
<span class="nc" id="L97">					RTAAException rtaaException = (RTAAException)itEvent.next();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">					if (rtaaException.isDeleted()) {</span>
<span class="nc" id="L99">						continue;</span>
					}
<span class="nc" id="L101">					String strDesc = &quot;&quot;;</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">					if (rtaaException.getApproveBy() != null) {</span>
<span class="nc" id="L103">						strDesc += rtaaException.getApproveBy();</span>
					}
<span class="nc bnc" id="L105" title="All 4 branches missed.">					if (rtaaException.getComment() != null &amp;&amp; rtaaException.getComment().trim().length() != 0) {</span>
<span class="nc" id="L106">						strDesc += &quot;--&quot; + rtaaException.getComment();</span>
					}

<span class="nc" id="L109">					ID plannedEventTimeLineID = null;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">					if (bAdhocDumpEnabled) {</span>
<span class="nc" id="L111">						plannedEventTimeLineID = getPlannedEventID(rtaaException, plannedEvents);</span>
					}
<span class="nc" id="L113">					newAdherenceExceptions.add(</span>
							new AdherenceException(
<span class="nc" id="L115">									pKGenerator.generate(m_dmo.getConnection(), m_fieldInfo.getTableName()),</span>
<span class="nc" id="L116">									rtaaException.getEmployeeID(),</span>
<span class="nc" id="L117">									rtaaException.getPlannedActivityID(),</span>
<span class="nc" id="L118">									rtaaException.getStartTime(),</span>
<span class="nc" id="L119">									rtaaException.getEndTime(),</span>
<span class="nc" id="L120">									rtaaException.isApproved(),</span>
									strDesc,
									plannedEventTimeLineID));
<span class="nc" id="L123">				}</span>

				//now for one employee we have leftoverlaps, rightoverlaps and new events.
<span class="nc" id="L126">				leftOverlap = (AdherenceException)RTAAUtil.getOverlap(leftOverlaps, idEmployee);</span>
<span class="nc" id="L127">				rightOverlap = (AdherenceException)RTAAUtil.getOverlap(rightOverlaps, idEmployee);</span>

<span class="nc" id="L129">				AdherenceException cloned = null;</span>

<span class="nc bnc" id="L131" title="All 2 branches missed.">				if (newAdherenceExceptions.isEmpty()) {</span>
					//no aherence exception any more for the time period. may need to deal with the left and right overlap if there are
<span class="nc bnc" id="L133" title="All 6 branches missed.">					if (leftOverlap != null &amp;&amp; leftOverlap.getEndTime().after(tsStart) &amp;&amp; leftOverlap.getStartTime().before(tsStart)) {</span>
						//update the left overlap event's endtime by delete and recreating
<span class="nc" id="L135">						delete.add(leftOverlap.getID());</span>
						//we should use org day id and sp day id of leftoverlap event since it is ealier
<span class="nc" id="L137">						cloned = (AdherenceException)leftOverlap.clone();</span>
<span class="nc" id="L138">						cloned.setID(getNextKey());</span>
<span class="nc" id="L139">						cloned.setEndTime(tsStart);</span>
<span class="nc" id="L140">						insert.add(cloned);</span>
					}
<span class="nc bnc" id="L142" title="All 6 branches missed.">					if (rightOverlap != null &amp;&amp; rightOverlap.getStartTime().before(tsEnd) &amp;&amp; rightOverlap.getEndTime().after(tsEnd)) {</span>
						//update the right over lap event's start time by delete and recreate
<span class="nc" id="L144">						delete.add(rightOverlap.getID());</span>
<span class="nc" id="L145">						cloned = (AdherenceException)rightOverlap.clone();</span>
<span class="nc" id="L146">						cloned.setID(getNextKey());</span>
<span class="nc" id="L147">						cloned.setStartTime(tsEnd);</span>
<span class="nc" id="L148">						insert.add(cloned);</span>
					}
					continue;
				}

<span class="nc" id="L153">				insert.addAll(newAdherenceExceptions);</span>

<span class="nc" id="L155">				Collections.sort(newAdherenceExceptions);</span>
<span class="nc" id="L156">				firstNewEvent = (AdherenceException)newAdherenceExceptions.get(0);</span>
<span class="nc" id="L157">				lastNewEvent = (AdherenceException)newAdherenceExceptions.get(newAdherenceExceptions.size() - 1);</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">				if (leftOverlap != null) {</span>
<span class="nc" id="L160">					delete.add(leftOverlap.getID());</span>
<span class="nc" id="L161">					leftOverlap = (AdherenceException)leftOverlap.clone();</span>
<span class="nc" id="L162">					leftOverlap.setEndTime(tsStart);</span>

<span class="nc bnc" id="L164" title="All 2 branches missed.">					if (firstNewEvent != null</span>
<span class="nc bnc" id="L165" title="All 4 branches missed.">							&amp;&amp; firstNewEvent.isBasicallyEqual(leftOverlap) &amp;&amp; firstNewEvent.getStartTime().equals(tsStart)) {</span>
<span class="nc" id="L166">						firstNewEvent.setStartTime(leftOverlap.getStartTime());</span>
					} else {
<span class="nc" id="L168">						leftOverlap.setID(getNextKey());</span>
<span class="nc" id="L169">						insert.add(leftOverlap);</span>
					}
				}

<span class="nc bnc" id="L173" title="All 2 branches missed.">				if (rightOverlap != null) {</span>
<span class="nc" id="L174">					delete.add(rightOverlap.getID());</span>
<span class="nc" id="L175">					rightOverlap = (AdherenceException)rightOverlap.clone();</span>
<span class="nc" id="L176">					rightOverlap.setStartTime(tsEnd);</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">					if (lastNewEvent != null</span>
<span class="nc bnc" id="L179" title="All 4 branches missed.">							&amp;&amp; lastNewEvent.isBasicallyEqual(rightOverlap) &amp;&amp; lastNewEvent.getEndTime().equals(tsEnd)) {</span>
<span class="nc" id="L180">						lastNewEvent.setEndTime(rightOverlap.getEndTime());</span>
					} else {
<span class="nc" id="L182">						rightOverlap.setID(getNextKey());</span>
<span class="nc" id="L183">						insert.add(rightOverlap);</span>
					}
				}
<span class="nc" id="L186">			}</span>

			//clear out events that fall within window
<span class="nc" id="L189">			StringBuffer strQuery = new StringBuffer(200);</span>
<span class="nc" id="L190">			strQuery.append(&quot;delete from &quot;).append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L191">			strQuery.append(&quot; where (EMPLOYEEID in &quot;);</span>
<span class="nc" id="L192">			strQuery.append(inClause);</span>
<span class="nc" id="L193">			strQuery.append(&quot; and STARTTIME &gt;= &quot;);</span>
<span class="nc" id="L194">			strQuery.append(startDBString);</span>
<span class="nc" id="L195">			strQuery.append(&quot; and ENDTIME &lt;= &quot;);</span>
<span class="nc" id="L196">			strQuery.append(endDBString);</span>
<span class="nc" id="L197">			strQuery.append(&quot;)&quot;);</span>
<span class="nc" id="L198">			m_dmo.execute(strQuery.toString());</span>

<span class="nc bnc" id="L200" title="All 2 branches missed.">			if (!delete.isEmpty()) {</span>
<span class="nc" id="L201">				Collections.sort(new ArrayList(delete));</span>
<span class="nc" id="L202">				strQuery = new StringBuffer(200);</span>
<span class="nc" id="L203">				strQuery.append(&quot; delete from &quot;).append(m_fieldInfo.getTableName());</span>
<span class="nc" id="L204">				strQuery.append(&quot; where id in &quot;).append(m_dmo.createInClause(delete));</span>
<span class="nc" id="L205">				m_dmo.execute(strQuery.toString());</span>
			}

			//update
//			if (!update.isEmpty()) {
//				JdmoPCommand pc = m_dmo.createPCommand(&quot;update &quot; + m_fieldInfo.getTableName() + &quot; with (rowlock) set starttime = ?, endtime = ? where id = ?&quot;);
//				HashMap param = new HashMap();
//				int ix = 0;
//				AdherenceException event = null;
//				for (Iterator iter = update.iterator(); iter.hasNext();) {
//					event = (AdherenceException)iter.next();
//					param.clear();
//					param.put(new Integer(1), event.getStartTime());
//					param.put(new Integer(2), event.getEndTime());
//					param.put(new Integer(3), event.getID());
//					m_dmo.addBatchPCommand(pc, param);
//				}
//				m_dmo.executeBatchPCommand(pc);
//			}

			//insert
<span class="nc" id="L226">			String arrFieldNames[] = new String[] {&quot;ID&quot;, &quot;EMPLOYEEID&quot;, &quot;PLANNEDACTIVITYID&quot;, &quot;ISAPPROVED&quot;, &quot;STARTTIME&quot;, &quot;ENDTIME&quot;,</span>
					&quot;APPROVEDBY&quot;, &quot;PLANNEDEVENTTIMELINEID&quot;};
<span class="nc" id="L228">			int arrFieldTypes[] = {Types.INTEGER, Types.INTEGER, Types.INTEGER, Types.BOOLEAN, Types.TIMESTAMP, Types.TIMESTAMP,</span>
					Types.VARCHAR, Types.INTEGER};
<span class="nc" id="L230">			AdherenceException event = null;</span>
<span class="nc" id="L231">			Object[] fields = null;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">			for (Iterator i = insert.iterator(); i.hasNext();) {</span>
<span class="nc" id="L233">				event = (AdherenceException)i.next();</span>
<span class="nc" id="L234">				fields = event.getFieldValues();</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">				for (int ix = 0; ix &lt; fields.length; ix++) {</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">					if (event.isFieldNull(ix)) {</span>
<span class="nc" id="L237">						fields[ix] = null;</span>
					}
				}
<span class="nc" id="L240">				colFieldValues.add(event.getFieldValues());</span>
			}
<span class="nc" id="L242">			System.out.println(&quot;updateAdherenceException for Employees &quot; + colEmployeeIDs.toString() + &quot;between &quot; + tsStart + &quot;-&quot; +</span>
<span class="nc" id="L243">					tsEnd + &quot;: insert-&quot; + insert.size() + &quot;, delete-&quot; + delete.size()); // + &quot;, update-&quot; + update.size());</span>
<span class="nc" id="L244">			m_dmo.insertBatchAndExecute(m_fieldInfo.getTableName(), arrFieldNames, arrFieldTypes, colFieldValues);</span>
<span class="nc" id="L245">			return ValueObjectUtil.groupByField(AdherenceExceptionFieldInfo.ADHERENCEEXCEPTION_EMPLOYEEID, insert);</span>
		} finally {
<span class="nc" id="L247">			m_dmo.cleanUp();</span>
		}
	}

	public static Collection groupEventsByWorkResources(Collection listEvents, Collection workResourceIDs) {
<span class="nc bnc" id="L252" title="All 4 branches missed.">		if (workResourceIDs == null || workResourceIDs.size() &lt;= 1) {</span>
			//no need to group
<span class="nc" id="L254">			ArrayList returnList = new ArrayList();</span>
<span class="nc" id="L255">			returnList.add(listEvents);</span>
<span class="nc" id="L256">			return returnList;</span>
		}

		// now go through this collection and construct the map keyed by workresource ID with values being the corresponding collection of
		// event assignments

<span class="nc" id="L262">		HashMap mapWrkResIDToEvents = new HashMap();</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">		for (Iterator itEvent = listEvents.iterator(); itEvent.hasNext();) {</span>
<span class="nc" id="L264">			RTAAException exception = (RTAAException)itEvent.next();</span>
<span class="nc" id="L265">			ID workResourceID = exception.getEmployeeID();</span>
<span class="nc" id="L266">			ArrayList wrkEvents = (ArrayList)mapWrkResIDToEvents.get(workResourceID);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">			if (wrkEvents == null) {</span>
<span class="nc" id="L268">				wrkEvents = new ArrayList();</span>
<span class="nc" id="L269">				mapWrkResIDToEvents.put(workResourceID, wrkEvents);</span>
			}
<span class="nc" id="L271">			wrkEvents.add(exception);</span>
<span class="nc" id="L272">		}</span>
		
<span class="nc" id="L274">		listEvents = new ArrayList();</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">		for (Iterator it = workResourceIDs.iterator(); it.hasNext();) {</span>
<span class="nc" id="L276">			ID workResourceID = (ID)it.next();</span>
<span class="nc" id="L277">			listEvents.add(mapWrkResIDToEvents.get(workResourceID));</span>
<span class="nc" id="L278">		}</span>
<span class="nc" id="L279">		return listEvents;</span>
	}

	//this API will link newly created exception event to the newly created published planned events
	/*
		select ADHERENCEEXCEPTION.ID ADHERENCEEXCEPTION_ID, max(PLANNEDEVENTTIMELINE.ID) PLANNEDEVENTTIMELINE_ID
		from ADHERENCEEXCEPTION
		join PLANNEDEVENTTIMELINE
		on	 PLANNEDEVENTTIMELINE.WORKRESOURCEID = ADHERENCEEXCEPTION.EMPLOYEEID
		and ADHERENCEEXCEPTION.STARTTIME &gt;= PLANNEDEVENTTIMELINE.STARTTIME
		and ADHERENCEEXCEPTION.STARTTIME &lt; PLANNEDEVENTTIMELINE.ENDTIME
		and PLANNEDEVENTTIMELINE.STARTTIME between @fromdate and @todate
		and ADHERENCEEXCEPTION.STARTTIME between @fromdate and @todate
		join #EmployeeIDs
		on	 #EmployeeIDs.ID = ADHERENCEEXCEPTION.EMPLOYEEID
		where PLANNEDEVENTTIMELINE.ISUNPUBLISHED = 0
		and ADHERENCEEXCEPTION.PLANNEDEVENTTIMELINEID is null
		and ADHERENCEEXCEPTION.STARTTIME between @fromdate and @todate
		group by ADHERENCEEXCEPTION.ID
		option (maxdop 1)
		update ADHERENCEEXCEPTION
		set PLANNEDEVENTTIMELINEID = #RESOLUTION.VALUE
		from #RESOLUTION
		where #RESOLUTION.ID = ADHERENCEEXCEPTION.ID and PLANNEDEVENTTIMELINEID is null
		delete from #RESOLUTION
		insert into #RESOLUTION
	 */
	private ID getPlannedEventID (RTAAException exception, Collection plannedEvents) throws JdmoException {
<span class="nc bnc" id="L307" title="All 4 branches missed.">		if (plannedEvents == null || plannedEvents.isEmpty()) {</span>
<span class="nc" id="L308">			return null;</span>
		}
<span class="nc" id="L310">		PlannedEventTimeLine plEvent = null;</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">		for (Iterator i = plannedEvents.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L312">			plEvent = (PlannedEventTimeLine)i.next();</span>
<span class="nc bnc" id="L313" title="All 4 branches missed.">			if (!exception.getStartTime().before(plEvent.getStartTime()) &amp;&amp; exception.getStartTime().before(plEvent.getEndTime())) {</span>
<span class="nc" id="L314">				return plEvent.getID();</span>
			}
		}
<span class="nc" id="L317">		return null;</span>
	}
	
	private ID getNextKey() throws Exception {
<span class="nc" id="L321">		return primaryKeyGenerator.generate(m_dmo.getConnection(), m_fieldInfo.getTableName());</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>