<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DayDetailsTimeIntervalRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.am.timerecords</a> &gt; <span class="el_source">DayDetailsTimeIntervalRequestHandler.java</span></div><h1>DayDetailsTimeIntervalRequestHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.am.timerecords;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeRecordException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.paypolicy.model.PayPolicy;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeInterval;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecord;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourcePayPolicy;
import com.bluepumpkin.web.am.Log;
import com.bluepumpkin.web.am.l10n.AmWebBundleKey;
import com.bluepumpkin.web.am.timecollection.MyTimeModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.workresource.WorkResourceModelHandler;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.base.RequestHandler;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        Blue Pumpkin Software Activity Management
 * Description:  Day Details Time Interval Popup model
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       Swati Tewari
 * @version 1.0
 */

<span class="nc" id="L43">public class DayDetailsTimeIntervalRequestHandler extends RequestHandler {</span>
<span class="nc" id="L44">	private static Category cat  = Log.initCategory(DayDetailsTimeIntervalRequestHandler.class.getName());</span>

	/**
	 * Process Requests for the time interval
	 */
	public void processRequest(RequestContext context)
	throws RemoteException{
<span class="nc" id="L51">    DayDetailsTimeIntervalModel model = new DayDetailsTimeIntervalModel(context);</span>

<span class="nc" id="L53">		model.extractParameters(context.getRequest());</span>
<span class="nc" id="L54">		String actionType = model.getActionType();</span>

<span class="nc bnc" id="L56" title="All 2 branches missed.">		if (!StringUtil.isEmpty(actionType) &amp;&amp;</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">				actionType.equals(DayDetailsTimeIntervalModel.SAVE_TIME_INTERVAL)){</span>
<span class="nc" id="L58">			processSaveAction(context);</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">		} else if (isAction(context,DayDetailsTimeIntervalModel.CREATE_TIME_INTERVAL) ||</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">			isAction(context,DayDetailsTimeIntervalModel.REFRESH_CREATE_TIMEINTERVAL) ||</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">			isAction(context,DayDetailsTimeIntervalModel.REFRESHEDIT_TIME_INTERVAL)){</span>
<span class="nc" id="L62">			processCreateAction(context);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">		} else if (isAction(context,DayDetailsTimeIntervalModel.EDIT_TIME_INTERVAL)){</span>
<span class="nc" id="L64">			processEditAction(context);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">		} else if (!StringUtil.isEmpty(actionType) &amp;&amp;</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">				actionType.equals(DayDetailsTimeIntervalModel.UPDATE_TIME_INTERVAL)){</span>
<span class="nc" id="L67">			processUpdateAction(context);</span>
		}
<span class="nc" id="L69">	}</span>


	/**
	 * processCreateAction()
	 */
	private void processCreateAction(RequestContext context)
	throws RemoteException{
<span class="nc" id="L77">		DayDetailsTimeIntervalModel model = new DayDetailsTimeIntervalModel(context);</span>
<span class="nc" id="L78">		model.extractParameters(context.getRequest());</span>

<span class="nc" id="L80">        setTimeZone(context, model);</span>
<span class="nc" id="L81">		setEmployeeOrgID(model, context);</span>
		//set the editHour and editMinute to the employee default daily paid value
<span class="nc" id="L83">		setEmployeeDefaultDailyPaidHours(context, model);</span>

<span class="nc bnc" id="L85" title="All 2 branches missed.">		if (isAction(context,DayDetailsTimeIntervalModel.REFRESHEDIT_TIME_INTERVAL)){</span>
<span class="nc" id="L86">			model.setActionType(DayDetailsTimeIntervalModel.UPDATE_TIME_INTERVAL);</span>
		} else {
<span class="nc" id="L88">			model.setActionType(DayDetailsTimeIntervalModel.SAVE_TIME_INTERVAL);</span>
		}

<span class="nc" id="L91">		context.setAttribute(RequestContext.REQUEST_SCOPE, DayDetailsTimeIntervalModel.MODEL_KEY, model);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">		if (cat.isInfoEnabled()) cat.debug(AmWebBundleKey.CONTENTS_MODEL</span>
<span class="nc" id="L93">					+ this.getClass().getName() +&quot; :&quot; +model.toString());</span>
<span class="nc" id="L94">	}</span>

	/**
	 * processSaveAction()
	 */
	private void processSaveAction(RequestContext context)
	throws RemoteException{
<span class="nc" id="L101">		DayDetailsTimeIntervalModel model = new DayDetailsTimeIntervalModel(context);</span>
<span class="nc" id="L102">		model.extractParameters(context.getRequest());</span>
<span class="nc" id="L103">		setEmployeeOrgID(model, context);</span>

		//check for end date greater than start date
<span class="nc" id="L106">		Date aStartDate = (Date)model.getDateList().get(0);</span>
<span class="nc" id="L107">		Date aEndDate = (Date)model.getDateList().get(1);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">		if (aEndDate.after(aStartDate)){</span>
			//check for end&gt;start plus duration
<span class="nc bnc" id="L110" title="All 2 branches missed.">			if (checkEndAndDuration(model))</span>
			{
				try {
<span class="nc" id="L113">					TimeRecordModelHandler.createTimeInterval(model, context);</span>
<span class="nc" id="L114">					model.setActionType(DayDetailsTimeIntervalModel.SUCCESS);</span>
<span class="nc" id="L115">					Message message = new Message(Message.RESPONSE_TYPE, AmWebBundleKey.MSG_SAVED_TIME_INTERVAL,</span>
						AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L117">					TimeRecordUtil.setContextAttribute(context, RequestContext.APPLICATION_SCOPE,</span>
						                               TimeRecordUtil.AM_WEB_CREATE_INTERVAL_RECORD, message);
<span class="nc" id="L119">				} catch (BbmTimeRecordException ex){//need to look for code</span>
<span class="nc" id="L120">					cat.l7dError(AmWebBundleKey.MSG_ERROR_CREATETIMEINTERVAL, ex);</span>
<span class="nc" id="L121">					model.addPageMessage(Message.ERROR_TYPE,</span>
							AmWebBundleKey.MSG_ERROR_CREATETIMEINTERVAL, AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L123">					model.setPageAction(DayDetailsTimeIntervalModel.CREATE_TIME_INTERVAL);</span>
<span class="nc" id="L124">				} catch (BbmException ex){</span>
<span class="nc" id="L125">					cat.l7dError(AmWebBundleKey.MSG_ERROR_CREATETIMEINTERVAL, ex);</span>
<span class="nc" id="L126">					model.addPageMessage(Message.ERROR_TYPE,</span>
						AmWebBundleKey.MSG_ERROR_CREATETIMEINTERVAL, AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L128">					model.setPageAction(DayDetailsTimeIntervalModel.CREATE_TIME_INTERVAL);</span>
<span class="nc" id="L129">				}</span>
			} else {
<span class="nc" id="L131">				model.addPageMessage(Message.ERROR_TYPE,</span>
					AmWebBundleKey.MSG_ERROR_ENDANDDURATION, AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L133">				model.setPageAction(DayDetailsTimeIntervalModel.CREATE_TIME_INTERVAL);</span>
			}
		} else {
<span class="nc" id="L136">			model.addPageMessage(Message.ERROR_TYPE,</span>
					AmWebBundleKey.MSG_ERROR_TIMECHECK, AmWebBundleKey.BUNDLE_NAME);

<span class="nc" id="L139">			model.setPageAction(DayDetailsTimeIntervalModel.CREATE_TIME_INTERVAL);</span>
		}
<span class="nc" id="L141">		context.setAttribute(RequestContext.REQUEST_SCOPE, DayDetailsTimeIntervalModel.MODEL_KEY, model);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if (cat.isInfoEnabled()) cat.debug(AmWebBundleKey.CONTENTS_MODEL</span>
<span class="nc" id="L143">					+ this.getClass().getName() +&quot; :&quot; +model.toString());</span>
<span class="nc" id="L144">	}</span>

	private boolean checkEndAndDuration(DayDetailsTimeIntervalModel model){
<span class="nc" id="L147">		Date aStartDate = (Date)model.getDateList().get(0);</span>
<span class="nc" id="L148">		Date aEndDate = (Date)model.getDateList().get(1);</span>
<span class="nc" id="L149">		int duration = model.getEditHour()*60 + model.getEditMinute();</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">		if ((aEndDate.getTime() - aStartDate.getTime()) &lt; duration*60*1000){</span>
<span class="nc" id="L151">			return false;</span>
		}
<span class="nc" id="L153">		return true;</span>
	}

	/**
	 * processEditAction()
	 */
	private void processEditAction(RequestContext context)
	throws RemoteException{
<span class="nc" id="L161">		DayDetailsTimeIntervalModel model = new DayDetailsTimeIntervalModel(context);</span>
<span class="nc" id="L162">		model.extractParameters(context.getRequest());</span>
<span class="nc" id="L163">		setEmployeeOrgID(model, context);</span>
		try {
			//get the entry for display and set model values
<span class="nc" id="L166">			TimeRecord aRecord = TimeRecordModelHandler.getTimeRecordById(model.getRecordID());</span>
<span class="nc" id="L167">			TimeInterval anInterval = (TimeInterval)((ArrayList)aRecord.getChildren()).get(0);</span>

			//set model values
			//start time
<span class="nc" id="L171">            List dateList = new ArrayList();</span>
<span class="nc" id="L172">            dateList.add(anInterval.getStartTime());</span>

			//end time
<span class="nc" id="L175">			dateList.add(anInterval.getEndTime());</span>
<span class="nc" id="L176">            model.setDateList(dateList);</span>

<span class="nc" id="L178">			model.setIntervalID(anInterval.getID());</span>
<span class="nc" id="L179">			int duration = anInterval.getDuration();</span>
<span class="nc" id="L180">			model.setEditHour(duration/60);</span>
<span class="nc" id="L181">			model.setEditMinute(duration%60);</span>
<span class="nc" id="L182">			model.setActivityCategory(anInterval.getActivityCategoryID());</span>
<span class="nc" id="L183">			model.setActivity(anInterval.getActivityID());</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">			model.setIsPaid(anInterval.getPaid()?&quot;true&quot;:null);</span>
<span class="nc" id="L185">			model.setNotes(anInterval.getDescription());</span>

<span class="nc" id="L187">			model.setActionType(DayDetailsTimeIntervalModel.UPDATE_TIME_INTERVAL);</span>
<span class="nc" id="L188">		} catch (BbmObjectNotFoundException ex){</span>
<span class="nc" id="L189">			cat.l7dError(AmWebBundleKey.MSG_ERROR_FINDTIMEINTERVAL, ex);</span>
<span class="nc" id="L190">			model.addPageMessage(Message.ERROR_TYPE,</span>
				AmWebBundleKey.MSG_ERROR_FINDTIMEINTERVAL, AmWebBundleKey.BUNDLE_NAME);

<span class="nc" id="L193">			model.setPageAction(DayDetailsTimeIntervalModel.EDIT_TIME_INTERVAL);</span>
<span class="nc" id="L194">		} catch (BbmFinderException ex){</span>
<span class="nc" id="L195">			cat.l7dError(AmWebBundleKey.MSG_ERROR_FINDTIMEINTERVAL, ex);</span>
<span class="nc" id="L196">			model.addPageMessage(Message.ERROR_TYPE,</span>
				AmWebBundleKey.MSG_ERROR_FINDTIMEINTERVAL, AmWebBundleKey.BUNDLE_NAME);

<span class="nc" id="L199">			model.setPageAction(DayDetailsTimeIntervalModel.EDIT_TIME_INTERVAL);</span>
<span class="nc" id="L200">		}</span>
<span class="nc" id="L201">		context.setAttribute(RequestContext.REQUEST_SCOPE, DayDetailsTimeIntervalModel.MODEL_KEY, model);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">		if (cat.isInfoEnabled()) cat.debug(AmWebBundleKey.CONTENTS_MODEL</span>
<span class="nc" id="L203">					+ this.getClass().getName() +&quot; :&quot; +model.toString());</span>
<span class="nc" id="L204">	}</span>

	/**
	 * processUpdateAction()
	 */
	private void processUpdateAction(RequestContext context)
	throws RemoteException{
<span class="nc" id="L211">		DayDetailsTimeIntervalModel model = new DayDetailsTimeIntervalModel(context);</span>
<span class="nc" id="L212">		model.extractParameters(context.getRequest());</span>
<span class="nc" id="L213">		setEmployeeOrgID(model, context);</span>

<span class="nc" id="L215">		Date aStartDate = (Date)model.getDateList().get(0);</span>
<span class="nc" id="L216">		Date aEndDate = (Date)model.getDateList().get(1);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">		if (aEndDate.after(aStartDate)){</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">			if (checkEndAndDuration(model))</span>
			{
				try {
					//get the entry for display and set model values
<span class="nc" id="L222">					TimeRecordModelHandler.updateTimeInterval(model, context);</span>
<span class="nc" id="L223">					model.setActionType(DayDetailsTimeIntervalModel.SUCCESS);</span>
<span class="nc" id="L224">					Message message = new Message(Message.RESPONSE_TYPE, AmWebBundleKey.MSG_UPDATE_TIME_INTERVAL,</span>
						AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L226">					TimeRecordUtil.setContextAttribute(context, RequestContext.APPLICATION_SCOPE,</span>
						                               TimeRecordUtil.AM_WEB_UPDATE_INTERVAL_RECORD, message);					
<span class="nc" id="L228">				} catch (BbmUpdateException ex){</span>
<span class="nc" id="L229">					cat.l7dError(AmWebBundleKey.MSG_ERROR_UPDATETIMEINTERVAL, ex);</span>
<span class="nc" id="L230">					model.addPageMessage(Message.ERROR_TYPE,</span>
						AmWebBundleKey.MSG_ERROR_UPDATETIMEINTERVAL, AmWebBundleKey.BUNDLE_NAME);

<span class="nc" id="L233">					model.setPageAction(DayDetailsTimeIntervalModel.EDIT_TIME_INTERVAL);</span>
<span class="nc" id="L234">				} catch (BbmTimeRecordException ex){</span>
<span class="nc" id="L235">					cat.l7dError(AmWebBundleKey.MSG_ERROR_UPDATETIMEINTERVAL, ex);</span>
<span class="nc" id="L236">					model.addPageMessage(Message.ERROR_TYPE,</span>
						AmWebBundleKey.MSG_ERROR_UPDATETIMEINTERVAL, AmWebBundleKey.BUNDLE_NAME);

<span class="nc" id="L239">					model.setPageAction(DayDetailsTimeIntervalModel.EDIT_TIME_INTERVAL);</span>
<span class="nc" id="L240">				}</span>
			} else {
<span class="nc" id="L242">				model.addPageMessage(Message.ERROR_TYPE,</span>
					AmWebBundleKey.MSG_ERROR_ENDANDDURATION, AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L244">				model.setPageAction(DayDetailsTimeIntervalModel.CREATE_TIME_INTERVAL);</span>
			}
		} else {
<span class="nc" id="L247">			model.addPageMessage(Message.ERROR_TYPE,</span>
					 AmWebBundleKey.MSG_ERROR_TIMECHECK, AmWebBundleKey.BUNDLE_NAME);

<span class="nc" id="L250">			model.setPageAction(DayDetailsTimeIntervalModel.CREATE_TIME_INTERVAL);</span>
		}
<span class="nc" id="L252">		context.setAttribute(RequestContext.REQUEST_SCOPE, DayDetailsTimeIntervalModel.MODEL_KEY, model);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">		if (cat.isInfoEnabled()) cat.debug(AmWebBundleKey.CONTENTS_MODEL</span>
<span class="nc" id="L254">					+ this.getClass().getName() +&quot; :&quot; +model.toString());</span>
<span class="nc" id="L255">	}</span>

	/**
	 * setEmployeeOrgID()
	 */
	private void setEmployeeOrgID(DayDetailsTimeIntervalModel model, RequestContext context){
<span class="nc" id="L261">        model.setOrgId(MyTimeModelHandler.</span>
<span class="nc" id="L262">            getEmployeeOrgId(context, model.getSelectedIDs()[model.getCurIndex()]));</span>
<span class="nc" id="L263">	}</span>

	/**
	* getEmployeeDefaultDailyPaidHours
	*/
	private void setEmployeeDefaultDailyPaidHours(RequestContext context, DayDetailsTimeIntervalModel model)
	throws RemoteException{
<span class="nc" id="L270">		Calendar aStartCal = Calendar.getInstance(TimeZone.getTimeZone(model.getTimeZone()));</span>
<span class="nc" id="L271">		aStartCal.set(model.getStartYear(), model.getStartMonth(),</span>
<span class="nc" id="L272">				model.getStartDay(), model.getStartHour(), model.getStartMinute(), 0);</span>

<span class="nc" id="L274">		Calendar anEndCal = Calendar.getInstance(TimeZone.getTimeZone(model.getTimeZone()));</span>
<span class="nc" id="L275">        anEndCal.setTime(aStartCal.getTime());</span>
<span class="nc" id="L276">        anEndCal.add(Calendar.DATE, 1);</span>
		try {
<span class="nc" id="L278">			ArrayList payPolicies = (ArrayList)WorkResourceModelHandler.getWorkResourceManager(context).getWorkResourcePayPolicies(</span>
<span class="nc" id="L279">					 model.getSelectedIDs()[model.getCurIndex()],</span>
<span class="nc" id="L280">					 aStartCal.getTime(), anEndCal.getTime(), false);</span>
			//get first pay policy from the collection
<span class="nc bnc" id="L282" title="All 2 branches missed.">			if (payPolicies.size()&gt;0){</span>
<span class="nc" id="L283">				WorkResourcePayPolicy aPolicy = (WorkResourcePayPolicy) payPolicies.get(0);</span>
<span class="nc" id="L284">				ID policyID = aPolicy.getPayPolicyID();</span>
				//get the pay policy
<span class="nc" id="L286">				PayPolicy aPayPolicy = BbmManagerFactory.getPayPolicyManager().getPayPolicyByID(policyID);</span>

<span class="nc" id="L288">				int paidHours = 0;</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">				if (aPayPolicy!=null ){</span>
<span class="nc" id="L290">					paidHours = aPayPolicy.getDailyDefaultPaidMinutes();</span>
					//set editHour
<span class="nc" id="L292">					model.setEditHour(paidHours/60);</span>
					//set editMinute
<span class="nc" id="L294">					model.setEndMinute(paidHours%60);</span>
				}
			}
<span class="nc" id="L297">		} catch (BbmException ex){</span>
<span class="nc" id="L298">		}</span>
<span class="nc" id="L299">	}</span>

    /**
	 * setTimeZone
	 */
	private void setTimeZone(RequestContext context, DayDetailsTimeIntervalModel model){
<span class="nc bnc" id="L305" title="All 2 branches missed.">		if (model.getTimeZone() == null){</span>
<span class="nc" id="L306">			Employee emp = null;</span>
<span class="nc" id="L307">			Calendar aCal = Calendar.getInstance();</span>
<span class="nc" id="L308">			aCal.set(model.getStartYear(), model.getStartMonth(), model.getStartDay(),</span>
<span class="nc" id="L309">				model.getStartHour(), model.getStartMinute(), 0);</span>
			try {
<span class="nc" id="L311">				emp = WorkResourceModelHandler.getWorkResourceManager(context).getEmployeeByID(model.getSelectedIDs()[model.getCurIndex()],</span>
<span class="nc" id="L312">					aCal.getTime(), Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);</span>
				//get organization
<span class="nc" id="L314">				Organization org = OrganizationModelHandler.getOrganization(context, emp.getOrganizationID());</span>
<span class="nc" id="L315">				model.setTimeZone(org.getTimeZone().getID());</span>
<span class="nc" id="L316">			} catch (Exception ex){</span>
<span class="nc" id="L317">				model.setTimeZone(context.getViewingTimeZone().getID());</span>
<span class="nc" id="L318">			}</span>
		}
<span class="nc" id="L320">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>