<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RotationInlineEditListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">RotationInlineEditListPC.java</span></div><h1>RotationInlineEditListPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRuleFieldInfo;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceRotation;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.Rotation;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.core.pagecomponent.DropDownSelectionPC;
import com.bluepumpkin.web.fs.keys.FsJavaScriptFileID;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.widgets.IntegerDropDownSelection;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.InsertableMultiColListPC;
import com.witness.web.uif.pagecomponent.table.DefaultHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.WorkpaneMultiColPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.SortUtil;
import com.witness.web.uif.util.TimeUtil;
import com.witness.web.uif.util.js.JSUtil;

import javax.servlet.http.HttpServletRequest;
import java.util.*;

public class RotationInlineEditListPC extends InsertableMultiColListPC {
	private static final long serialVersionUID = 1L;

	private Collection&lt;WorkResourceRotation&gt; assignments;
<span class="nc" id="L44">	private HashMap&lt;ID, WorkResourceRotation&gt; modifiedAssignments =</span>
			new HashMap&lt;ID, WorkResourceRotation&gt;();
	private Calendar viewStartDate;
	private Calendar viewEndDate;
<span class="nc" id="L48">	private boolean didTimePeriodChange = false;</span>
<span class="nc" id="L49">	private boolean isReadOnly = false;</span>
<span class="nc" id="L50">	private StringBuffer jsInitCode = new StringBuffer();</span>
<span class="nc" id="L51">	private SchedulingPeriod selectedSP = null;</span>

	//Rotations (sometimes) have their start date stored
	//relative to their org's time zone.  We need the associated orgs so we
	//can translate back to midnight GMT.
<span class="nc" id="L56">	private Map&lt;ID, Organization&gt; orgMap = new HashMap&lt;ID, Organization&gt;();</span>

	public RotationInlineEditListPC(RequestContext context, String name, Collection&lt;WorkResourceRotation&gt; rotations,
			Date viewStartDate, Date viewEndDate, boolean isReadOnly, boolean didTimePeriodChange,
			Map&lt;ID, Organization&gt; orgMap, SchedulingPeriod selectedSP) {
<span class="nc" id="L61">		super(context);</span>

<span class="nc" id="L63">		setName(name);</span>

<span class="nc" id="L65">		this.assignments = rotations;</span>
<span class="nc" id="L66">		this.viewStartDate = Calendar.getInstance();</span>
<span class="nc" id="L67">		this.viewStartDate.setTime(viewStartDate);</span>
<span class="nc" id="L68">		this.viewEndDate = Calendar.getInstance();</span>
<span class="nc" id="L69">		this.viewEndDate.setTime(viewEndDate);</span>
<span class="nc" id="L70">		this.didTimePeriodChange = didTimePeriodChange;</span>
<span class="nc" id="L71">		this.isReadOnly = isReadOnly;</span>
<span class="nc" id="L72">		this.orgMap = orgMap;</span>
<span class="nc" id="L73">		this.selectedSP = selectedSP;</span>

<span class="nc" id="L75">		ToolbarPC toolbar = new ToolbarPC(m_context);</span>
<span class="nc" id="L76">		toolbar.setName(&quot;rotationToolbar&quot;);</span>
<span class="nc" id="L77">		ToolbarTextButton addButton = toolbar.createPopupWindowButton(RotationListPopupPM.POPUP_ID,</span>
<span class="nc" id="L78">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_ADD), true);</span>
<span class="nc" id="L79">		addButton.setAttribute(&quot;viewStartDate&quot;, Long.toString(this.viewStartDate.getTimeInMillis()));</span>
<span class="nc" id="L80">		addButton.setAttribute(&quot;viewEndDate&quot;, Long.toString(this.viewEndDate.getTimeInMillis()));</span>
<span class="nc" id="L81">		addButton.setAttribute(&quot;onClick&quot;, getFilterJSForAddButton(getName(), toolbar.getName(), RotationListPopupPM.POPUP_ID));</span>
<span class="nc" id="L82">		ToolbarTextButton removeButton = new ToolbarTextButton(toolbar, &quot;removeRotation&quot;,</span>
<span class="nc" id="L83">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_REMOVE),</span>
				InsertableMultiColListPC.REMOVE_ROW_BUTTON_ACTION, ToolbarTextButton.BLUE_BUTTON, false);

		//Only one rotation may be assigned at any given time
<span class="nc" id="L87">		setOnRowAddJS(getName() + &quot;.itemAdded('&quot; + addButton.getName() + &quot;','&quot; + removeButton.getName() + &quot;');&quot;);</span>
<span class="nc" id="L88">		setOnRowRemoveJS(getName() + &quot;.itemRemoved('&quot; + addButton.getName() + &quot;','&quot; + removeButton.getName() + &quot;');&quot;);</span>

<span class="nc" id="L90">		setIsBorderEnabled(true);</span>
<span class="nc" id="L91">		setToolbar(toolbar);</span>

<span class="nc" id="L93">		addPopupArgs(RotationListPopupPM.POPUP_ID, RotationListPopupPM.FORM_ACTION, &quot;&quot;,</span>
				RotationListPopupPM.POPUP_ARGS, &quot;1000,600,ctr,ctr&quot;, true, 1);

		//If we don't have any rows for the list on initial load, we still need to get the required
		// js files from the inline components that may be added dynamically
<span class="nc" id="L98">		IntegerDropDownSelection dummyIntegerSelectionPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="nc" id="L99">				getName() + &quot;_dummyIntegerSelectionPC&quot;, 0, 0);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">		for (String js : dummyIntegerSelectionPC.getRequireJavaScriptFiles()) {</span>
<span class="nc" id="L101">			addRequiredJavaScriptFile(js);</span>
<span class="nc" id="L102">		}</span>

<span class="nc" id="L104">		setJSMediator(FsJavaScriptFileID.SINGLETON_INSERTABLE_TABLE);</span>

<span class="nc" id="L106">		extractParameters(m_context.getRequest());</span>

		//Remove button should default to false because when the page is first loaded, because a rotation
		//will not be selected when the page first loads.
<span class="nc" id="L110">		removeButton.setEnabled(false);</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">		if (isReadOnly) {</span>
<span class="nc" id="L113">			addButton.setEnabled(false);</span>
<span class="nc" id="L114">			setRowSelectable(false);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">		} else if (rotations.size() &gt; 0) {</span>
<span class="nc" id="L116">			addButton.setEnabled(false);</span>
		}
<span class="nc" id="L118">		toolbar.addToolbarElement(addButton);</span>
<span class="nc" id="L119">		toolbar.addToolbarElement(removeButton);</span>

<span class="nc" id="L121">		setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L122">	}</span>

	public String getJavaScriptInitCode() {
<span class="nc" id="L125">		StringBuffer js = new StringBuffer(super.getJavaScriptInitCode());</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">		if (getToolbar() != null) {</span>
<span class="nc" id="L127">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.setToolbar(&quot;).append(getToolbar().getName()).append(&quot;);&quot;);</span>
<span class="nc" id="L128">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.addButtonEnableAttribute('isDeleteable', 'removeRotation');\n&quot;);</span>
		}
<span class="nc" id="L130">		return js.toString();</span>
	}

<span class="nc" id="L133">	private boolean isHeaderInited = false;</span>

	private void initHeader() {
<span class="nc bnc" id="L136" title="All 2 branches missed.">		if (isHeaderInited) {</span>
<span class="nc" id="L137">			return;</span>
		}
<span class="nc" id="L139">		isHeaderInited = true;</span>

<span class="nc" id="L141">		TableHeaderPC header = getHeader();</span>
<span class="nc" id="L142">		Localizer localizer = m_context.getLocalizer();</span>

<span class="nc" id="L144">		DefaultHeaderData dhd = new DefaultHeaderData(FsWebBundleKey.FS_ROTATION,</span>
<span class="nc" id="L145">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ROTATION));</span>

<span class="nc" id="L147">		dhd.addImageButton(getInfoButtonPopupImage(), getInfoButtonPopupCaption(), getInfoButtonPopupJS()/*, !isInfoButtonEnabled*/);</span>
<span class="nc" id="L148">		dhd.setSortable(false);</span>
<span class="nc" id="L149">		header.addColumnHeaderData(dhd);</span>
<span class="nc" id="L150">		header.addColumnHeaderData(FsWebBundleKey.FS_WORK_PATTERN, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_WORK_PATTERN));</span>
<span class="nc" id="L151">	}</span>

	private String getInfoButtonPopupImage() {
<span class="nc" id="L154">		return ImageFileID.TOOLTIP_BUTTON;</span>
	}

	private String getInfoButtonPopupCaption() {
<span class="nc" id="L158">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_VIEW_ROTATION_DETAILS);</span>
	}

	private String getInfoButtonPopupJS() {
<span class="nc" id="L162">		return &quot;WorkRulesUtil.handleInfoPopup(this, (typeof &quot; + getName() + &quot;==='undefined'?null:&quot; + getName() + &quot;), (typeof &quot; + getHeader().getName() + &quot;==='undefined'?null:&quot; + getHeader().getName() + &quot;),'&quot; +</span>
				RotationListPopupPM.POPUP_ID + &quot;','&quot; + RotationListPopupPM.POPUP_ARG_ROTATION_ID + &quot;','&quot; +
				RotationListPopupPM.POPUP_ARG_SELECTED_IDS + &quot;','&quot; + RotationListPopupPM.POPUP_ARG_IS_INFO_POPUP +
				&quot;','true');&quot;;
	}

<span class="nc" id="L168">	private boolean isRowsInited = false;</span>

	private void initRows() {
<span class="nc bnc" id="L171" title="All 2 branches missed.">		if (isRowsInited) {</span>
<span class="nc" id="L172">			return;</span>
		}
<span class="nc" id="L174">		isRowsInited = true;</span>

<span class="nc" id="L176">		List&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>

<span class="nc" id="L178">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">		for (WorkResourceRotation wrr : assignments) {</span>
<span class="nc" id="L180">			rows.add(getNodeData(wrr, false));</span>
<span class="nc" id="L181">			ids.add(wrr.getRotation().getID());</span>
<span class="nc" id="L182">		}</span>

		//Sort the rows by item name
<span class="nc" id="L185">		SortUtil.sort(rows, getHeader().getColumnIndexByName(FsWebBundleKey.FS_ROTATION), true, m_context.getLocalizer());</span>

<span class="nc" id="L187">		this.setRowIDs(StringUtil.createDelimitedString(ids.toArray(new ID[ids.size()])));</span>
<span class="nc" id="L188">	}</span>

	public String getRowHtml(WorkResourceRotation wrr) {
<span class="nc" id="L191">		StringBuffer html = new StringBuffer();</span>
<span class="nc" id="L192">		super.appendHtmlRowData(html, getNodeData(wrr, true), 0, 0);</span>

		//Create the javascript to instantiate the objects for the inline controls
<span class="nc" id="L195">		html.append(HtmlUtil.jsTag(jsInitCode.toString(), false));</span>
<span class="nc" id="L196">		jsInitCode.setLength(0);</span>

<span class="nc" id="L198">		return html.toString();</span>
	}

	protected DefaultMultiColumnNodeData getNodeData(WorkResourceRotation wrr, boolean isAjaxRequest) {
<span class="nc" id="L202">		DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(wrr.getRotation().getID());</span>

		//Name
<span class="nc bnc" id="L205" title="All 2 branches missed.">		if (wrr.isMultiEditCommon()) {</span>
<span class="nc" id="L206">			nodeData.add(wrr.getRotation().getName());</span>
		} else {
<span class="nc" id="L208">			nodeData.add(&quot;*&quot; + wrr.getRotation().getName());</span>
		}

		//Work Pattern
<span class="nc" id="L212">		DropDownSelectionPC&lt;Integer&gt; workPatternsDDPC = getWorkPatternDDPC(wrr);</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">		if (isReadOnly) {</span>
<span class="nc" id="L214">			workPatternsDDPC.setEnabled(false);</span>
		}
<span class="nc bnc" id="L216" title="All 2 branches missed.">		if (isAjaxRequest) {</span>
<span class="nc" id="L217">			jsInitCode.append(workPatternsDDPC.getJavaScriptInitCode());</span>
		}
<span class="nc" id="L219">		addChildComponent(workPatternsDDPC);</span>
<span class="nc" id="L220">		nodeData.add(workPatternsDDPC);</span>

<span class="nc" id="L222">		setRowAttributes(nodeData, wrr);</span>
<span class="nc" id="L223">		return nodeData;</span>
	}

	protected void setRowAttributes(DefaultMultiColumnNodeData mcnd, WorkResourceRotation wrr) {
<span class="nc bnc" id="L227" title="All 2 branches missed.">		if (!wrr.isMultiEditCommon()) {</span>
<span class="nc" id="L228">			mcnd.setNodeAttribute(ROW_ATTRIBUTE_MULTI_EDIT_NOT_COMMON, String.valueOf(true));</span>
		}
<span class="nc" id="L230">		mcnd.setNodeAttribute(WorkpaneMultiColPM.IS_DELETEABLE, String.valueOf(true));</span>
<span class="nc" id="L231">		mcnd.setNodeAttribute(RotationListPopupPM.POPUP_ARG_ROTATION_ID, wrr.getRotation().getID().toString());</span>
<span class="nc" id="L232">	}</span>

	private DropDownSelectionPC&lt;Integer&gt; getWorkPatternDDPC(WorkResourceRotation wrr) {
<span class="nc" id="L235">		DropDownSelectionPC&lt;Integer&gt; workPatternsDDPC = new DropDownSelectionPC&lt;Integer&gt;(</span>
<span class="nc" id="L236">				getRequestContext(), getName() + &quot;_workPatternsDDPC_&quot; + JSUtil.getJSSuffix(wrr.getRotation().getID().toString()));</span>

<span class="nc bnc" id="L238" title="All 2 branches missed.">		if (isStartWeekMultiEdit(wrr)) {</span>
<span class="nc" id="L239">			workPatternsDDPC.setMultiEdit(true);</span>
		}
<span class="nc" id="L241">		boolean isSelected = false;</span>
<span class="nc" id="L242">		int selectedWorkPatternOffset = getSelectedWorkPatternOffsetDisplayIndex(wrr);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">		for (Integer i = 0; i &lt; wrr.getNumWeeksInRotation(); i++) {</span>
<span class="nc bnc" id="L244" title="All 4 branches missed.">			isSelected = !isStartWeekMultiEdit(wrr) &amp;&amp; (selectedWorkPatternOffset == i);</span>
<span class="nc" id="L245">			ShiftPattern shiftPattern = wrr.getRotation().getShiftPatterns().get(i);</span>

			//If the shift pattern has already been deleted, then display &quot;This work pattern has been deleted&quot;
			//Otherwise, display the name of the work pattern
<span class="nc bnc" id="L249" title="All 4 branches missed.">			if (shiftPattern.getDeletedOnDate() != null &amp;&amp;</span>
					(
<span class="nc bnc" id="L251" title="All 2 branches missed.">							(selectedSP != null &amp;&amp; shiftPattern.getDeletedOnDate().before(selectedSP.getEndTime())) ||</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">									shiftPattern.getDeletedOnDate().before(viewEndDate.getTime())</span>
					)
					) {    //Work pattern was deleted before the view end date or sp end date if in campaign mode
<span class="nc" id="L255">				workPatternsDDPC.addOption(i.toString(), getLocalizer().i18n(</span>
						FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ROTATION_LIST_DISPLAY_DELETED_WP,
<span class="nc" id="L257">						new Object[]{new Integer(i + 1).toString(), shiftPattern.getName()}),</span>
						i, isSelected);
			} else {
<span class="nc" id="L260">				workPatternsDDPC.addOption(i.toString(), getLocalizer().i18n(</span>
						FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ROTATION_LIST_DISPLAY,
<span class="nc" id="L262">						new Object[]{new Integer(i + 1).toString(), shiftPattern.getName()}),</span>
						i, isSelected);
			}
		}


<span class="nc bnc" id="L268" title="All 2 branches missed.">		if (!didTimePeriodChange) {</span>
<span class="nc" id="L269">			workPatternsDDPC.extractParameters(m_context.getRequest());</span>
		}

<span class="nc bnc" id="L272" title="All 2 branches missed.">		if (workPatternsDDPC.isEdited()) {</span>
<span class="nc" id="L273">			workPatternsDDPC.setMultiEdit(false);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">			if (modifiedAssignments.containsKey(wrr.getID())) {</span>
<span class="nc" id="L275">				setWorkPatternOffsetFromDropDownSelection(modifiedAssignments.get(wrr.getID()),</span>
<span class="nc" id="L276">						workPatternsDDPC.getSelections().iterator().next());</span>
			} else {
<span class="nc" id="L278">				setWorkPatternOffsetFromDropDownSelection(wrr,</span>
<span class="nc" id="L279">						workPatternsDDPC.getSelections().iterator().next());</span>
				//Only add to modified assignments if this is not a newly added assignment
<span class="nc bnc" id="L281" title="All 2 branches missed.">				if (wrr.getID() != null) {</span>
<span class="nc" id="L282">					modifiedAssignments.put(wrr.getID(), wrr);</span>
				}
			}
		}

<span class="nc" id="L287">		return workPatternsDDPC;</span>
	}

<span class="nc" id="L290">	private boolean isExtracted = false;</span>

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc bnc" id="L294" title="All 2 branches missed.">		if (isExtracted) {</span>
<span class="nc" id="L295">			return true;</span>
		}
<span class="nc" id="L297">		isExtracted = true;</span>
<span class="nc" id="L298">		boolean retVal = true;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">		if (didTimePeriodChange == false) {</span>
<span class="nc" id="L300">			retVal = super.extractParameters(request);</span>
		}

		// removed
<span class="nc bnc" id="L304" title="All 2 branches missed.">		for (ID removedID : getRemovedRowIDCollection()) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">			for (WorkResourceRotation wrr : assignments) {</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">				if (removedID.equals(wrr.getRotation().getID())) {</span>
<span class="nc" id="L307">					assignments.remove(wrr);</span>
<span class="nc" id="L308">					break;</span>
				}
<span class="nc" id="L310">			}</span>
<span class="nc" id="L311">		}</span>

		// added
		try {
<span class="nc" id="L315">			Collection&lt;ID&gt; addedIDs = getAddedRowIDCollection();</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">			if (addedIDs.size() &gt; 0) {</span>
<span class="nc" id="L317">				HashSet&lt;ID&gt; newOrgIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">				for (Rotation rotation : WorkRulesModelHandler.getRotationsByIDs(m_context, addedIDs)) {</span>
<span class="nc" id="L319">					newOrgIDs.add(rotation.getOrganizationID());</span>
<span class="nc" id="L320">					WorkResourceRotation wrr = new WorkResourceRotation();</span>
<span class="nc" id="L321">					wrr.setRotation(rotation);</span>
<span class="nc" id="L322">					wrr.setMultiEditCommon(true);</span>
<span class="nc" id="L323">					wrr.setNumWeeksInRotation(rotation.getShiftPatterns().size());</span>
					//If this rotation is already present in assignments, make sure to remove it before re-adding.
					//This case happens when the user removes a rotation and then re-adds the same one.
<span class="nc" id="L326">					WorkResourceRotation existingAssignment = null;</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">					for (WorkResourceRotation existingWrr : assignments) {</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">						if (existingWrr.getRotation().getID().equals(rotation.getID())) {</span>
<span class="nc" id="L329">							existingAssignment = existingWrr;</span>
<span class="nc" id="L330">							break;</span>
						}
<span class="nc" id="L332">					}</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">					if (existingAssignment != null) {</span>
<span class="nc" id="L334">						assignments.remove(existingAssignment);</span>
					}
<span class="nc" id="L336">					assignments.add(wrr); // This will be updated in the initRows method call below</span>
<span class="nc" id="L337">				}</span>
				//For any new assignments, we need to grab the organization of the work rule and add it to the org map
<span class="nc" id="L339">				Collection&lt;Organization&gt; newOrgs = OrganizationModelHandler.getOrganizationsByIDs(m_context, newOrgIDs);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">				for (Organization org : newOrgs) {</span>
<span class="nc" id="L341">					orgMap.put(org.getID(), org);</span>
<span class="nc" id="L342">				}</span>
			}
<span class="nc" id="L344">		} catch (Exception e) {</span>
<span class="nc" id="L345">			retVal = false;</span>
<span class="nc" id="L346">			handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L347">		}</span>

<span class="nc" id="L349">		initHeader();</span>
<span class="nc" id="L350">		initRows();</span>

<span class="nc" id="L352">		return retVal;</span>
	}

	private boolean isStartWeekMultiEdit(WorkResourceRotation wrr) {
<span class="nc" id="L356">		return wrr.isFieldMultiValue(</span>
				WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_STARTWEEKOFFSET);
	}

	/**
	 * Returns the rotation rule creation date (start date).  Always returns a Calendar with a
	 * time component set to midnight.
	 * NOTE: Older versions of the FS client sometimes store the start date relative
	 * to midnight at the org where the rule was created.  In these rare cases, we need
	 * to shift the time so that the time portion of the date is at midnight.
	 */
	private Calendar getRotationCreateDate(WorkResourceRotation wrr) {
<span class="nc" id="L368">		Calendar wrStartDate = Calendar.getInstance();</span>
<span class="nc" id="L369">		wrStartDate.setTime(wrr.getRotation().getAlignmentDate().getTime(TimeZoneUtil.GMT_TIMEZONE));</span>

		//Check if the rule has a start date of midnight.  If it does, no translation is
		// required.
<span class="nc bnc" id="L373" title="All 2 branches missed.">		if ((wrStartDate.get(Calendar.HOUR_OF_DAY) != 0 ||</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">				wrStartDate.get(Calendar.MINUTE) != 0 ||</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">				wrStartDate.get(Calendar.SECOND) != 0 ||</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">				wrStartDate.get(Calendar.MILLISECOND) != 0) &amp;&amp;</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">				orgMap.get(wrr.getRotation().getOrganizationID()) != null) {</span>
<span class="nc" id="L378">			Date orgTimeShiftedDate = wrStartDate.getTime();</span>
<span class="nc" id="L379">			LocalDate orgLocalDate = new LocalDate(orgTimeShiftedDate,</span>
<span class="nc" id="L380">					orgMap.get(wrr.getRotation().getOrganizationID()).getTimeZone());</span>
<span class="nc" id="L381">			wrStartDate.setTime(orgLocalDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
		}
<span class="nc" id="L383">		return wrStartDate;</span>
	}

	//Returns the work pattern index to be selected in the drop down based on offset and current selected date range
	private int getSelectedWorkPatternOffsetDisplayIndex(WorkResourceRotation wrr) {
<span class="nc bnc" id="L388" title="All 2 branches missed.">		if (wrr.getNumWeeksInRotation() == 0) {</span>
<span class="nc" id="L389">			return 1;</span>
		}

<span class="nc" id="L392">		int weeksBetween = TimeUtil.getWeeksCountBetweenDates(getRotationCreateDate(wrr), viewStartDate);</span>
<span class="nc" id="L393">		return (((weeksBetween % wrr.getNumWeeksInRotation()) + wrr.getStartWeekOffSet()) % wrr.getNumWeeksInRotation());</span>
	}

	private void setWorkPatternOffsetFromDropDownSelection(WorkResourceRotation wrr, int dropDownDisplayValue) {
<span class="nc" id="L397">		int weeksBetween = TimeUtil.getWeeksCountBetweenDates(getRotationCreateDate(wrr), viewStartDate);</span>
<span class="nc" id="L398">		int offset = (weeksBetween % wrr.getNumWeeksInRotation()) - (dropDownDisplayValue);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">		if (offset &gt; 0) {</span>
<span class="nc" id="L400">			wrr.setStartWeekOffSet(wrr.getNumWeeksInRotation() - offset);</span>
		} else {
<span class="nc" id="L402">			wrr.setStartWeekOffSet(-offset);</span>
		}
<span class="nc" id="L404">	}</span>

	public void save(HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; rotationAssignmentMap) throws BbmException {
<span class="nc" id="L407">		Collection&lt;ID&gt; removedRotationIDs = getRemovedRotationAssignmentIDs(rotationAssignmentMap);</span>
<span class="nc bnc" id="L408" title="All 4 branches missed.">		if (removedRotationIDs != null &amp;&amp; removedRotationIDs.size() &gt; 0) {</span>
<span class="nc" id="L409">			WorkRulesModelHandler.deleteRotationAssignments(m_context, removedRotationIDs);</span>
		}
<span class="nc" id="L411">		Collection&lt;WorkResourceRotation&gt; modifiedRotationAssignments = getModifiedRotationAssignments(rotationAssignmentMap);</span>
<span class="nc bnc" id="L412" title="All 4 branches missed.">		if (modifiedRotationAssignments != null &amp;&amp; modifiedRotationAssignments.size() &gt; 0) {</span>
<span class="nc" id="L413">			WorkRulesModelHandler.updateRotationAssignments(m_context, modifiedRotationAssignments);</span>
		}
<span class="nc" id="L415">		Collection&lt;WorkResourceRotation&gt; addedRotationAssignments = getAddedRotationAssignments(rotationAssignmentMap);</span>
<span class="nc bnc" id="L416" title="All 4 branches missed.">		if (addedRotationAssignments != null &amp;&amp; addedRotationAssignments.size() &gt; 0) {</span>
<span class="nc" id="L417">			WorkRulesModelHandler.createRotationAssignments(m_context, addedRotationAssignments);</span>
		}

		//Clear out the removed/added IDs when finished to avoid saving/deleting duplicates
<span class="nc" id="L421">		setAddedRowIDs(&quot;&quot;);</span>
<span class="nc" id="L422">		setRemovedRowIDs(&quot;&quot;);</span>
<span class="nc" id="L423">	}</span>

	private HashSet&lt;WorkResourceRotation&gt; getAddedRotations() {
<span class="nc" id="L426">		HashSet&lt;WorkResourceRotation&gt; retVal = new HashSet&lt;WorkResourceRotation&gt;();</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">		for (ID id : getAddedRowIDCollection()) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">			for (WorkResourceRotation wrr : assignments) {</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">				if (id.equals(wrr.getRotation().getID())) {</span>
<span class="nc" id="L430">					retVal.add(wrr);</span>
<span class="nc" id="L431">					break;</span>
				}
<span class="nc" id="L433">			}</span>
<span class="nc" id="L434">		}</span>
<span class="nc" id="L435">		return retVal;</span>
	}

	private Collection&lt;WorkResourceRotation&gt; getAddedRotationAssignments(HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; rotationAssignmentMap) {
<span class="nc" id="L439">		Collection&lt;WorkResourceRotation&gt; addedRotations = getAddedRotations();</span>
<span class="nc" id="L440">		ArrayList&lt;WorkResourceRotation&gt; newAddedRotations = new ArrayList&lt;WorkResourceRotation&gt;();</span>

<span class="nc bnc" id="L442" title="All 2 branches missed.">		for (ID employeeID : rotationAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">			for (WorkResourceRotation addedRotation : addedRotations) {</span>
<span class="nc" id="L444">				WorkResourceRotation wrr = new WorkResourceRotation();</span>
<span class="nc" id="L445">				wrr.setStartWeekOffSet(addedRotation.getStartWeekOffSet());</span>
<span class="nc" id="L446">				wrr.setNumWeeksInRotation(addedRotation.getNumWeeksInRotation());</span>
<span class="nc" id="L447">				wrr.setRotation(addedRotation.getRotation());</span>
<span class="nc" id="L448">				wrr.setWeekEnabledMask(-1);</span>
<span class="nc" id="L449">				wrr.setWorkResourceID(employeeID);</span>
<span class="nc" id="L450">				newAddedRotations.add(wrr);</span>
<span class="nc" id="L451">			}</span>
<span class="nc" id="L452">		}</span>

<span class="nc" id="L454">		return newAddedRotations;</span>
	}

	private Collection&lt;WorkResourceRotation&gt; getModifiedRotations() {
<span class="nc" id="L458">		return new ArrayList&lt;WorkResourceRotation&gt;(modifiedAssignments.values());</span>
	}

	private Collection&lt;WorkResourceRotation&gt; getModifiedRotationAssignments(HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; rotationAssignmentMap) {
		//Only one copy of each rotation is stored on the page (even if multiple employees are selected), so
		// we need to modify the other rotations that belong to every employee
<span class="nc" id="L464">		Collection&lt;WorkResourceRotation&gt; modifiedRotations = getModifiedRotations();</span>
<span class="nc" id="L465">		ArrayList&lt;WorkResourceRotation&gt; newModifiedRotations = new ArrayList&lt;WorkResourceRotation&gt;();</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">		for (WorkResourceRotation wrr : modifiedRotations) {</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">			for (ID employeeID : rotationAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">				if (wrr.getWorkResourceID().equals(employeeID) == false) {</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">					for (WorkResourceRotation existingRotationAssignment : rotationAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">						if (wrr.getRotation().getID().equals(existingRotationAssignment.getRotation().getID())) {</span>
<span class="nc" id="L471">							existingRotationAssignment.setStartWeekOffSet(wrr.getStartWeekOffSet());</span>
<span class="nc" id="L472">							newModifiedRotations.add(existingRotationAssignment);</span>
<span class="nc" id="L473">							break;</span>
						}
<span class="nc" id="L475">					}</span>
				}
<span class="nc" id="L477">			}</span>
<span class="nc" id="L478">		}</span>
<span class="nc" id="L479">		modifiedRotations.addAll(newModifiedRotations);</span>
<span class="nc" id="L480">		return modifiedRotations;</span>
	}

	private Collection&lt;ID&gt; getRemovedRotationAssignmentIDs(HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; rotationAssignmentMap) {
<span class="nc" id="L484">		Collection&lt;ID&gt; removedRotationIDs = getRemovedRowIDCollection();</span>
<span class="nc" id="L485">		Collection&lt;ID&gt; removedAssignmentIDs = new ArrayList&lt;ID&gt;();</span>

<span class="nc bnc" id="L487" title="All 2 branches missed.">		for (ID employeeID : rotationAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">			for (WorkResourceRotation wrr : rotationAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">				if (removedRotationIDs.contains(wrr.getRotation().getID())) {</span>
<span class="nc" id="L490">					removedAssignmentIDs.add(wrr.getID());</span>
				}
<span class="nc" id="L492">			}</span>
<span class="nc" id="L493">		}</span>

		//In the case where a rule was removed and then the same rule was added back in, we will need to
		// remove the original rule so we will get the ID for that rule here.
<span class="nc" id="L497">		Collection&lt;WorkResourceRotation&gt; addedAssignments =</span>
<span class="nc" id="L498">				getAddedRotationAssignments(rotationAssignmentMap);</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">		if (addedAssignments.isEmpty() == false) {</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">			for (ID empID : rotationAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">				for (WorkResourceRotation existingAssignment : rotationAssignmentMap.get(empID)) {</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">					for (WorkResourceRotation addedAssignment : addedAssignments) {</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">						if (existingAssignment.getComplexWorkRuleID().equals(addedAssignment.getComplexWorkRuleID())) {</span>
<span class="nc" id="L504">							removedAssignmentIDs.add(existingAssignment.getID());</span>
						}
<span class="nc" id="L506">					}</span>
<span class="nc" id="L507">				}</span>
<span class="nc" id="L508">			}</span>
		}

<span class="nc" id="L511">		return removedAssignmentIDs;</span>
	}

	/**
	 * Returns the number of rotations that will be displayed by this list.
	 */
	public int getNumberOfDisplayedRotations() {
<span class="nc bnc" id="L518" title="All 2 branches missed.">		if (assignments != null) {</span>
<span class="nc" id="L519">			return assignments.size();</span>
		}
<span class="nc" id="L521">		return 0;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>