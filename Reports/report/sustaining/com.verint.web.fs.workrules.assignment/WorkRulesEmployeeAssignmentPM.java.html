<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WorkRulesEmployeeAssignmentPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">WorkRulesEmployeeAssignmentPM.java</span></div><h1>WorkRulesEmployeeAssignmentPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Map.Entry;
import java.util.ResourceBundle;
import java.util.Set;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpTimeBank;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRule;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRuleFieldInfo;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceRotation;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceWorkPattern;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.Rotation;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.ejb.bbm.workrules.model.TimeBank;
import com.bluepumpkin.ejb.core.CoreEJBCreateException;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.employee.assignment.WfmEmployeeAssignmentPM;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.CacheUtil;

public class WorkRulesEmployeeAssignmentPM extends WfmEmployeeAssignmentPM {
	private static final long serialVersionUID = 1L;

<span class="nc" id="L59">	protected boolean isByOrg = true;</span>
	protected final ResourceBundle m_bundle;
	protected SchedulingPeriod selectedSP;
	protected Campaign selectedCampaign;

	//key = employee ID, value = collection of work pattern assignments
	private HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; workPatternAssignmentMap;
	//key = employee ID, value = collection of assignment rule assignments
	private HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; assignmentRuleAssignmentMap;
	//key = employee ID, value = collection of rotation assignments
	private HashMap&lt;ID, Collection&lt;WorkResourceRotation&gt;&gt; rotationAssignmentMap;
	//key = employee ID, value = collection of time bank assignments
	private HashMap&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; timeBankAssignmentMap;
	//key = time bank ID, value = time bank
	private HashMap&lt;ID, TimeBank&gt; timeBankMap;
	//key = org ID
<span class="nc" id="L75">	private final Map&lt;ID, Organization&gt; orgMap = new HashMap&lt;&gt;();</span>
	private final boolean didTimePeriodChange;

	private WorkPatternInlineEditListPC pc_workPattern;
	private HoursPC pc_hours;
	private PayPeriodHourPC payPeriodHourPC;
	private PoolingRulePC pc_poolingRules;
	private AssignmentRuleInlineEditListPC pc_assignmentRule;
	private RotationInlineEditListPC pc_rotation;
	private TimeBankAssignmentListPC pc_timeBank;
<span class="nc" id="L85">	private boolean isViewPeriodValidForAllEmployees = true;</span>

	// Exposes control for visibility of assignment rules for inheriting classes
<span class="nc" id="L88">	protected boolean isAssignmentRuleVisible = true;</span>

	// Exposes control for visibility of rotation assignment for inheriting classes
<span class="nc" id="L91">	protected boolean isRotationAssignmentVisible = true;</span>
<span class="nc" id="L92">	protected boolean isCampaignMode = false;</span>
	// Exposes control for visibility of rotation assignment for inheriting classes
<span class="nc" id="L94">	protected boolean isTimeBankAssignmentVisible = true;</span>

	public static final String EMPLOYEE_ID_LIST_CONTEXT_KEY = &quot;com.verint.web.fs.workrules.assignment.employeeIDs&quot;;

	public WorkRulesEmployeeAssignmentPM(RequestContext context) {
<span class="nc" id="L99">		super(context, PageModel.FRAMED_MODEL);</span>
<span class="nc" id="L100">		m_bundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L102">		didTimePeriodChange = WorkRulesEmployeeAssignmentRH.didTimePeriodChange(context);</span>
<span class="nc" id="L103">	}</span>

	public static WorkRulesEmployeeAssignmentPM getInstance(RequestContext context) {
<span class="nc" id="L106">		return (WorkRulesEmployeeAssignmentPM) PageModel.getInstance(context, WorkRulesEmployeeAssignmentPM.class);</span>
	}

	@Override
	protected void initForm() {
<span class="nc" id="L111">		initContextDateFieldNames(START_DATE_FN, END_DATE_FN);</span>

		//Setting list of employeeIDs in context for the associated popup window (the list may be too large
		//  to use as a query string param)
<span class="nc" id="L115">		CacheUtil.setCachedValue(m_context, CacheUtil.CACHE_MODE_SESSION, WorkRulesEmployeeAssignmentPM.EMPLOYEE_ID_LIST_CONTEXT_KEY,</span>
<span class="nc" id="L116">				StringUtil.createDelimitedString(getSelectedIDs(), StringUtil.DELIM));</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (getSelectedIDSize() &gt; 0) {</span>
<span class="nc" id="L119">			Collection&lt;ID&gt; employeeIDs = getSelectedIDsAsCollection();</span>

<span class="nc" id="L121">			viewStartDate = pc_timePeriod.getSelectedDateRange().getFirst();</span>
<span class="nc" id="L122">			viewEndDate = pc_timePeriod.getSelectedDateRange().getSecond();</span>

			try {
				//Loading this data here instead of loadData because we need the date range from the date selector
<span class="nc" id="L126">				employeeMap = EmployeeModelHandler.getEmployeeMap(m_context, employeeIDs, viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>

				//If the user tries to bypass the UI and forge an HTTP request with employee IDs that they don't have access to, check
				//for that here and clear the selection if that is detected.
<span class="nc bnc" id="L130" title="All 2 branches missed.">				if (!userHasPermissionToViewAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L131">					employeeMap.clear();</span>
<span class="nc" id="L132">					addPageMessage(Message.INSTRUCTION_TYPE, getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
							BbmWebBundleKey.SELECT_EMPLOYEE));
<span class="nc" id="L134">					return;</span>
				}

<span class="nc bnc" id="L137" title="All 2 branches missed.">				if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L138">					addPageMessage(Message.WARNING_TYPE,</span>
							FsWebBundleKey.FS_WORKRULES_NOT_ALL_EMPLOYEES_EDITABLE, FsWebBundleKey.BUNDLE_NAME);
				}

<span class="nc bnc" id="L142" title="All 2 branches missed.">				if (employeeMap.isEmpty()) {</span>
					// There were no employees for the provided ids, something is wrong, either the id
					// selected don't exist in the database or no ids where provided.  Either way, instruct
					// the user to make a valid selection.
<span class="nc" id="L146">					addPageMessage(Message.INSTRUCTION_TYPE,</span>
<span class="nc" id="L147">							getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.SELECT_EMPLOYEE));</span>
<span class="nc" id="L148">					return;</span>
				}

				// There were multiple employees selected, instruct the user of the multi-select.
<span class="nc bnc" id="L152" title="All 2 branches missed.">				if (isMultiEdit()) {</span>
<span class="nc" id="L153">					addPageMessage(Message.INFO_TYPE, BbmWebBundleKey.MultipleAlert, BbmWebBundleKey.BUNDLE_NAME);</span>
				}

<span class="nc" id="L156">				ArrayList&lt;String&gt; invalidEmployeeNames = new ArrayList&lt;String&gt;();</span>
				//Check to see if all employees start/end dates overlap with the view period.  If not, display
				// a message to the user and do not render the page.
<span class="nc bnc" id="L159" title="All 2 branches missed.">				for (Employee emp : employeeMap.values()) {</span>
<span class="nc bnc" id="L160" title="All 4 branches missed.">					if (emp.getStartTimeLocal().equals(viewEndDate) || emp.getStartTimeLocal().after(viewEndDate) ||</span>
<span class="nc bnc" id="L161" title="All 4 branches missed.">							(emp.getEndTimeLocal() != null &amp;&amp; emp.getEndTimeLocal().before(viewStartDate))) {</span>
<span class="nc" id="L162">						isViewPeriodValidForAllEmployees = false;</span>
<span class="nc" id="L163">						invalidEmployeeNames.add(m_localizer.formatName(emp));</span>
					}
<span class="nc" id="L165">				}</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">				if (isViewPeriodValidForAllEmployees) {</span>
<span class="nc" id="L168">					loadWorkPatterns();</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">					if (isAssignmentRuleVisible) {</span>
<span class="nc" id="L171">						assignmentRuleAssignmentMap = WorkRulesModelHandler.getComplexWorkRuleAssignments(m_context, getSelectedIDsAsCollection());</span>
					}

<span class="nc" id="L174">					rotationAssignmentMap = WorkRulesModelHandler.getRotationAssignments(m_context, getSelectedIDsAsCollection());</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">					if (isTimeBankAssignmentVisible) {</span>
<span class="nc" id="L177">						timeBankAssignmentMap = WorkRulesModelHandler.getTimeBankAssignments(m_context, getSelectedIDsAsCollection(),</span>
<span class="nc" id="L178">								viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE), viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
<span class="nc" id="L179">						Collection&lt;ID&gt; timeBankIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">						for (Entry&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; entry : timeBankAssignmentMap.entrySet()) {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">							for (EmpTimeBank etb : entry.getValue()) {</span>
<span class="nc" id="L182">								timeBankIDs.add(etb.getTimeBankID());</span>
<span class="nc" id="L183">							}</span>
<span class="nc" id="L184">						}</span>
<span class="nc" id="L185">						Collection&lt;TimeBank&gt; timeBanks = WorkRulesModelHandler.getTimeBanksByIDs(m_context, timeBankIDs);</span>
<span class="nc" id="L186">						timeBankMap = ValueObjectUtil.getIDObjectMap(timeBanks);</span>
					}

<span class="nc bnc" id="L189" title="All 2 branches missed.">					for (ID employeeID : getSelectedIDsAsCollection()) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">						if (!workPatternAssignmentMap.keySet().contains(employeeID)) {</span>
<span class="nc" id="L191">							Set&lt;WorkResourceWorkPattern&gt; set = Collections.emptySet();</span>
<span class="nc" id="L192">							workPatternAssignmentMap.put(employeeID, set);</span>
						}
<span class="nc bnc" id="L194" title="All 2 branches missed.">						if (isAssignmentRuleVisible) {</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">							if (!assignmentRuleAssignmentMap.keySet().contains(employeeID)) {</span>
<span class="nc" id="L196">								Set&lt;WorkResourceComplexWorkRule&gt; set = Collections.emptySet();</span>
<span class="nc" id="L197">								assignmentRuleAssignmentMap.put(employeeID, set);</span>
							}
						}
<span class="nc bnc" id="L200" title="All 2 branches missed.">						if (isRotationAssignmentVisible) {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">							if (!rotationAssignmentMap.keySet().contains(employeeID)) {</span>
<span class="nc" id="L202">								Set&lt;WorkResourceRotation&gt; set = Collections.emptySet();</span>
<span class="nc" id="L203">								rotationAssignmentMap.put(employeeID, set);</span>
							}
						}
<span class="nc bnc" id="L206" title="All 2 branches missed.">						if (isTimeBankAssignmentVisible) {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">							if (!timeBankAssignmentMap.keySet().contains(employeeID)) {</span>
<span class="nc" id="L208">								Set&lt;EmpTimeBank&gt; set = Collections.emptySet();</span>
<span class="nc" id="L209">								timeBankAssignmentMap.put(employeeID, set);</span>
							}
						}
<span class="nc" id="L212">					}</span>
<span class="nc bnc" id="L213" title="All 4 branches missed.">					boolean extractParams = !didTimePeriodChange &amp;&amp; null != m_context.getPageModel().getPageAction() &amp;&amp;</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">							!PageAction.EDIT.equals(m_context.getPageModel().getPageAction()) &amp;&amp;</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">							!PageAction.NEW_ID.equals(m_context.getPageModel().getPageAction());</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">					pc_hours = new HoursPC(m_context, employeeIDs, employeeMap, viewStartDate, viewEndDate,</span>
							!isByOrg, extractParams);
<span class="nc" id="L218">					pc_hours.setIsBorderEnabled(true);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">					if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L220">						pc_hours.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L221">						pc_hours.setEnabled(false);</span>
					}
<span class="nc bnc" id="L223" title="All 2 branches missed.">					if (pc_hours.isAnySpinnerVisible()) {</span>
<span class="nc" id="L224">						addChildComponent(pc_hours);</span>
<span class="nc" id="L225">						addForm(pc_hours);</span>
					}
<span class="nc bnc" id="L227" title="All 2 branches missed.">					if (LicenseUtil.isAdvancedRMLicense()) {</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">						payPeriodHourPC = new PayPeriodHourPC(m_context, employeeIDs, employeeMap, viewStartDate, viewEndDate, !isByOrg,</span>
								extractParams);
<span class="nc" id="L230">						payPeriodHourPC.setIsBorderEnabled(true);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">						if (!isEditable()) {</span>
<span class="nc" id="L232">							payPeriodHourPC.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L233">							payPeriodHourPC.setEnabled(false);</span>
						}
<span class="nc bnc" id="L235" title="All 2 branches missed.">						if (payPeriodHourPC.isAnySpinnerVisible()) {</span>
<span class="nc" id="L236">							addChildComponent(payPeriodHourPC);</span>
<span class="nc" id="L237">							addForm(payPeriodHourPC);</span>
						}
					}
					//Pooling Rules Container
<span class="nc bnc" id="L241" title="All 4 branches missed.">					if (isByOrg &amp;&amp; hasPoolingLicense()) {</span>
<span class="nc" id="L242">						CollapsibleContainerPC poolingRuleContainer = new CollapsibleContainerPC(m_context);</span>
<span class="nc" id="L243">						poolingRuleContainer.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L244">						poolingRuleContainer.setName(&quot;poolingRuleContainer&quot;);</span>
<span class="nc" id="L245">						poolingRuleContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
								FsWebBundleKey.POOLING_RULES));
<span class="nc" id="L247">						poolingRuleContainer.setIsBorderEnabled(true);</span>

<span class="nc" id="L249">						pc_poolingRules = new PoolingRulePC(m_context, employeeIDs, employeeMap, viewStartDate, viewEndDate, extractParams);</span>
<span class="nc" id="L250">						pc_poolingRules.setShowTitle(false);</span>
<span class="nc" id="L251">						pc_poolingRules.setFirstDayOfWeek(getWeekStartForSelectedEmployee().getCalendarConstant());</span>

<span class="nc bnc" id="L253" title="All 2 branches missed.">						if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L254">							pc_poolingRules.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L255">							pc_poolingRules.setEnabled(false);</span>
						}
<span class="nc" id="L257">						poolingRuleContainer.addComponent(pc_poolingRules);</span>
<span class="nc" id="L258">						addChildComponent(poolingRuleContainer);</span>
<span class="nc" id="L259">						addForm(poolingRuleContainer);</span>
					}

					//Work Pattern Container
<span class="nc" id="L263">					CollapsibleContainerPC workPatternContainer = new CollapsibleContainerPC(m_context);</span>
<span class="nc" id="L264">					workPatternContainer.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L265">					workPatternContainer.setName(&quot;workPatternContainer&quot;);</span>
<span class="nc" id="L266">					workPatternContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
							FsWebBundleKey.WORK_PATTERNS));
<span class="nc" id="L268">					workPatternContainer.setIsBorderEnabled(true);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">					if (selectedSP != null) {</span>
<span class="nc" id="L270">						pc_workPattern = new WorkPatternInlineEditListPC(m_context, &quot;workPatternTable&quot;,</span>
<span class="nc" id="L271">								workPatternAssignmentMap, viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc" id="L272">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), selectedSP, selectedCampaign,</span>
<span class="nc" id="L273">								didTimePeriodChange, getSelectedIDsAsCollection(), null, null);</span>
					} else {
<span class="nc" id="L275">						pc_workPattern = new WorkPatternInlineEditListPC(m_context, &quot;workPatternTable&quot;,</span>
<span class="nc" id="L276">								workPatternAssignmentMap, viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc" id="L277">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), null, null, didTimePeriodChange,</span>
<span class="nc" id="L278">								getSelectedIDsAsCollection(), null, null);</span>
					}
<span class="nc" id="L280">					pc_workPattern.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="nc" id="L281">					pc_workPattern.setIsInnerTable(true);</span>
<span class="nc" id="L282">					pc_workPattern.setIsBorderEnabled(false);</span>
<span class="nc" id="L283">					pc_workPattern.setIsCancelSelectEventPropagation(false);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">					if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L285">						pc_workPattern.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L286">						pc_workPattern.setEnabled(false);</span>
					}
<span class="nc" id="L288">					workPatternContainer.addComponent(pc_workPattern);</span>
<span class="nc" id="L289">					addChildComponent(workPatternContainer);</span>
<span class="nc" id="L290">					addForm(workPatternContainer);</span>

					//Assignment Rule Container
<span class="nc bnc" id="L293" title="All 2 branches missed.">					if (isAssignmentRuleVisible) {</span>
<span class="nc" id="L294">						CollapsibleContainerPC assignmentRuleContainer = new CollapsibleContainerPC(m_context);</span>
<span class="nc" id="L295">						assignmentRuleContainer.setName(&quot;assignmentRuleContainer&quot;);</span>
<span class="nc" id="L296">						assignmentRuleContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
								FsWebBundleKey.FS_ASSIGNMENT_RULES));
<span class="nc" id="L298">						assignmentRuleContainer.setIsBorderEnabled(true);</span>
<span class="nc" id="L299">						pc_assignmentRule = new AssignmentRuleInlineEditListPC(m_context, &quot;assignmentRuleTable&quot;,</span>
<span class="nc" id="L300">								getComplexWorkRuleAssignments(), viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc" id="L301">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">								getSelectedIDsAsCollection(), !isByOrg, didTimePeriodChange, orgMap);</span>
<span class="nc" id="L303">						pc_assignmentRule.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="nc" id="L304">						pc_assignmentRule.setIsInnerTable(true);</span>
<span class="nc" id="L305">						pc_assignmentRule.setIsBorderEnabled(false);</span>
<span class="nc" id="L306">						pc_assignmentRule.setIsCancelSelectEventPropagation(false);</span>
<span class="nc bnc" id="L307" title="All 4 branches missed.">						if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values()) || isCampaignMode) {</span>
<span class="nc" id="L308">							pc_assignmentRule.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L309">							pc_assignmentRule.setEnabled(false);</span>
						}
<span class="nc" id="L311">						assignmentRuleContainer.addComponent(pc_assignmentRule);</span>
<span class="nc" id="L312">						addChildComponent(assignmentRuleContainer);</span>
<span class="nc" id="L313">						addForm(assignmentRuleContainer);</span>
					}

					//Rotation container
<span class="nc" id="L317">					int rotationCount = 0;</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">					if (isRotationAssignmentVisible) {</span>
<span class="nc" id="L319">						CollapsibleContainerPC rotationContainer = new CollapsibleContainerPC(m_context);</span>
<span class="nc" id="L320">						rotationContainer.setName(&quot;rotationContainer&quot;);</span>
<span class="nc" id="L321">						rotationContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
								FsWebBundleKey.FS_ROTATIONS));
<span class="nc" id="L323">						rotationContainer.setIsBorderEnabled(true);</span>
<span class="nc" id="L324">						rotationContainer.setEnabled(isByOrg);</span>
<span class="nc" id="L325">						Collection&lt;WorkResourceRotation&gt; rotations = getRotationAssignments();</span>
<span class="nc" id="L326">						pc_rotation = new RotationInlineEditListPC(m_context, &quot;rotationTable&quot;, rotations,</span>
<span class="nc" id="L327">								viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">								viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE), !isByOrg, didTimePeriodChange,</span>
								orgMap, selectedSP);
<span class="nc" id="L330">						pc_rotation.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="nc" id="L331">						pc_rotation.setIsInnerTable(true);</span>
<span class="nc" id="L332">						pc_rotation.setIsBorderEnabled(false);</span>

<span class="nc bnc" id="L334" title="All 2 branches missed.">						if (!isByOrg) {</span>
<span class="nc" id="L335">							pc_rotation.addOnRowAddJS(&quot;if(rotationTable.totalRowCount &gt; 0) {&quot; +</span>
									&quot;if(!workPatternContainer.getIsCollapsed()) {&quot; +
									&quot;workPatternContainer.defaultToggle();&quot; +
									&quot;}&quot; +
									&quot;workPatternContainer.setToggleable(false);&quot; +
									&quot;}&quot;);
<span class="nc" id="L341">							pc_rotation.addOnRowRemoveJS(&quot;if(rotationTable.totalRowCount == 0) {&quot; +</span>
									&quot;workPatternContainer.setToggleable(true);&quot; +
									&quot;if(workPatternContainer.getIsCollapsed()) {&quot; +
									&quot;workPatternContainer.defaultToggle();&quot; +
									&quot;}&quot; +
									&quot;}&quot;);
						}
<span class="nc" id="L348">						pc_rotation.setIsCancelSelectEventPropagation(false);</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">						if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L350">							pc_rotation.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L351">							pc_rotation.setEnabled(false);</span>
						}
<span class="nc" id="L353">						rotationContainer.addComponent(pc_rotation);</span>
<span class="nc" id="L354">						addChildComponent(rotationContainer);</span>
<span class="nc" id="L355">						addForm(rotationContainer);</span>
<span class="nc" id="L356">						rotationCount = pc_rotation.getNumberOfDisplayedRotations();</span>
<span class="nc" id="L357">						rotationContainer.setRenderJavaScriptIfDisabled(true);</span>
					}

					// If the rotation count &gt; 0, work patterns should be collapsed and disabled.
<span class="nc bnc" id="L361" title="All 2 branches missed.">					if (rotationCount &gt; 0) {</span>
<span class="nc" id="L362">						workPatternContainer.setCollapsed(true);</span>
<span class="nc" id="L363">						workPatternContainer.setIsToggleEnabled(false);</span>
<span class="nc" id="L364">						workPatternContainer.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L365">						addPageMessage(Message.INFO_TYPE, getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
								BbmWebBundleKey.PEOPLE_WORKRULES_WORKPATTERNS_DISABLED));
					}

<span class="nc bnc" id="L369" title="All 4 branches missed.">					if (isTimeBankAssignmentVisible &amp;&amp; hasTimeBankLicense()) {</span>
<span class="nc" id="L370">						CollapsibleContainerPC timeBankContainer = new CollapsibleContainerPC(m_context);</span>
<span class="nc" id="L371">						timeBankContainer.setName(&quot;timeBankContainer&quot;);</span>
<span class="nc" id="L372">						timeBankContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
								FsWebBundleKey.FS_TIME_BANKS));
<span class="nc" id="L374">						timeBankContainer.setIsBorderEnabled(true);</span>
<span class="nc" id="L375">						Collection&lt;EmpTimeBank&gt; timeBankAssignments = getTimeBankAssignments();</span>
<span class="nc" id="L376">						pc_timeBank = new TimeBankAssignmentListPC(m_context, &quot;timeBankTable&quot;, timeBankAssignments, timeBankMap,</span>
<span class="nc" id="L377">								viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE), viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc" id="L378">								didTimePeriodChange, getSelectedIDsAsCollection());</span>
<span class="nc" id="L379">						pc_timeBank.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="nc" id="L380">						pc_timeBank.setIsInnerTable(true);</span>
<span class="nc" id="L381">						pc_timeBank.setIsBorderEnabled(false);</span>
<span class="nc" id="L382">						pc_timeBank.setIsCancelSelectEventPropagation(false);</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">						if (!userHasPermissionToEditAllSelectedEmployees(employeeMap.values())) {</span>
<span class="nc" id="L384">							pc_timeBank.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L385">							pc_timeBank.setEnabled(false);</span>
						}
<span class="nc" id="L387">						timeBankContainer.addComponent(pc_timeBank);</span>
<span class="nc" id="L388">						addChildComponent(timeBankContainer);</span>
<span class="nc" id="L389">						addForm(timeBankContainer);</span>
					}
<span class="nc" id="L391">				} else {</span>
<span class="nc" id="L392">					StringBuilder namesStr = new StringBuilder();</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">					for (String empName : invalidEmployeeNames) {</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">						if (!StringUtil.isEmpty(namesStr.toString())) {</span>
<span class="nc" id="L395">							namesStr.append(&quot;; &quot;);</span>
						}
<span class="nc" id="L397">						namesStr.append(empName);</span>
<span class="nc" id="L398">					}</span>
<span class="nc" id="L399">					addPageMessage(Message.ERROR_TYPE, FsWebBundleKey.FS_VIEW_DATE_OUT_OF_RANGE_FOR_EMP_WORK_RULE_ASSIGNMENT,</span>
<span class="nc" id="L400">							FsWebBundleKey.BUNDLE_NAME, new String[]{namesStr.toString()});</span>
				}
<span class="nc" id="L402">			} catch (Exception e) {</span>
<span class="nc" id="L403">				handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L404">			}</span>
<span class="nc" id="L405">		} else {</span>
<span class="nc" id="L406">			addPageMessage(Message.INSTRUCTION_TYPE, getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
					BbmWebBundleKey.SELECT_EMPLOYEE));
		}
<span class="nc" id="L409">	}</span>

	private Collection&lt;WorkResourceComplexWorkRule&gt; getComplexWorkRuleAssignments() throws BbmException, RemoteException {
		//key = ID of corresponding work rule belonging to the assignment (not the assignment itself)
		//  We only want to display one of each work rule in the assignment rule list
<span class="nc" id="L414">		HashMap&lt;ID, WorkResourceComplexWorkRule&gt; complexWorkRuleAssignments = new HashMap&lt;&gt;();</span>
<span class="nc" id="L415">		HashMap&lt;ComplexWorkRule, HashSet&lt;ID&gt;&gt; cwrEmployeeMap = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L417" title="All 2 branches missed.">		for (ID employeeID : assignmentRuleAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">			for (WorkResourceComplexWorkRule wrcwr : assignmentRuleAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">				if (complexWorkRuleAssignments.keySet().contains(wrcwr.getComplexWorkRule().getID())) {</span>
<span class="nc" id="L420">					WorkResourceComplexWorkRule existingWrcwr =</span>
<span class="nc" id="L421">							complexWorkRuleAssignments.get(wrcwr.getComplexWorkRule().getID());</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">					if (existingWrcwr.getNumWeeksInRotation() != wrcwr.getNumWeeksInRotation()) {</span>
<span class="nc" id="L423">						existingWrcwr.setFieldMultiValue(</span>
								WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_NUMWEEKSINROTATION);
					}
<span class="nc bnc" id="L426" title="All 2 branches missed.">					if (existingWrcwr.getStartWeekOffSet() != wrcwr.getStartWeekOffSet()) {</span>
<span class="nc" id="L427">						existingWrcwr.setFieldMultiValue(</span>
								WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_STARTWEEKOFFSET);
					}
<span class="nc bnc" id="L430" title="All 2 branches missed.">					if (existingWrcwr.getWeeksEnabled().equals(wrcwr.getWeeksEnabled())) {</span>
<span class="nc" id="L431">						existingWrcwr.setFieldMultiValue(</span>
								WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_WEEKENABLEDMASK);
					}
<span class="nc" id="L434">				} else {</span>
<span class="nc" id="L435">					complexWorkRuleAssignments.put(wrcwr.getComplexWorkRule().getID(), wrcwr);</span>
				}

<span class="nc" id="L438">				HashSet&lt;ID&gt; associatedEmployeeIDs = cwrEmployeeMap.get(wrcwr.getComplexWorkRule());</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">				if (associatedEmployeeIDs == null) {</span>
<span class="nc" id="L440">					associatedEmployeeIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L441">					cwrEmployeeMap.put(wrcwr.getComplexWorkRule(), associatedEmployeeIDs);</span>
				}
<span class="nc" id="L443">				associatedEmployeeIDs.add(employeeID);</span>
<span class="nc" id="L444">			}</span>
<span class="nc" id="L445">		}</span>
<span class="nc" id="L446">		HashSet&lt;ID&gt; orgIDs = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">		for (WorkResourceComplexWorkRule wrcwr : complexWorkRuleAssignments.values()) {</span>
<span class="nc" id="L448">			wrcwr.setMultiEditCommon(</span>
<span class="nc" id="L449">					cwrEmployeeMap.get(wrcwr.getComplexWorkRule()).containsAll(getSelectedIDsAsCollection()));</span>
<span class="nc" id="L450">			orgIDs.add(wrcwr.getComplexWorkRule().getOrganizationID());</span>
<span class="nc" id="L451">		}</span>
<span class="nc" id="L452">		Collection&lt;Organization&gt; orgs = OrganizationModelHandler.getOrganizationsByIDs(m_context, orgIDs);</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">		for (Organization org : orgs) {</span>
<span class="nc" id="L454">			orgMap.put(org.getID(), org);</span>
<span class="nc" id="L455">		}</span>
<span class="nc" id="L456">		return new ArrayList&lt;&gt;(complexWorkRuleAssignments.values());</span>
	}

	private Collection&lt;WorkResourceRotation&gt; getRotationAssignments() throws BbmException, RemoteException {
		//key = ID of corresponding rotation belonging to the assignment (not the assignment itself)
		//  We only want to display one of each rotation in the rotation list
<span class="nc" id="L462">		Map&lt;ID, WorkResourceRotation&gt; rotationAssignments = new HashMap&lt;&gt;();</span>
<span class="nc" id="L463">		Map&lt;Rotation, HashSet&lt;ID&gt;&gt; rotationEmployeeMap = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L465" title="All 2 branches missed.">		for (ID employeeID : rotationAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">			for (WorkResourceRotation wrr : rotationAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">				if (rotationAssignments.keySet().contains(wrr.getRotation().getID())) {</span>
<span class="nc" id="L468">					WorkResourceRotation existingRotation = rotationAssignments.get(wrr.getRotation().getID());</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">					if (existingRotation.getStartWeekOffSet() != wrr.getStartWeekOffSet()) {</span>
<span class="nc" id="L470">						existingRotation.setFieldMultiValue(</span>
								WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_STARTWEEKOFFSET);
					}
<span class="nc" id="L473">				} else {</span>
<span class="nc" id="L474">					rotationAssignments.put(wrr.getRotation().getID(), wrr);</span>
				}

<span class="nc" id="L477">				HashSet&lt;ID&gt; associatedEmployeeIDs = rotationEmployeeMap.get(wrr.getRotation());</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">				if (associatedEmployeeIDs == null) {</span>
<span class="nc" id="L479">					associatedEmployeeIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L480">					rotationEmployeeMap.put(wrr.getRotation(), associatedEmployeeIDs);</span>
				}
<span class="nc" id="L482">				associatedEmployeeIDs.add(employeeID);</span>
<span class="nc" id="L483">			}</span>
<span class="nc" id="L484">		}</span>
<span class="nc" id="L485">		HashSet&lt;ID&gt; orgIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">		for (WorkResourceRotation wrr : rotationAssignments.values()) {</span>
<span class="nc" id="L487">			wrr.setMultiEditCommon(</span>
<span class="nc" id="L488">					rotationEmployeeMap.get(wrr.getRotation()).containsAll(getSelectedIDsAsCollection()));</span>
<span class="nc" id="L489">			orgIDs.add(wrr.getRotation().getOrganizationID());</span>
<span class="nc" id="L490">		}</span>
<span class="nc" id="L491">		Collection&lt;Organization&gt; orgs = OrganizationModelHandler.getOrganizationsByIDs(m_context, orgIDs);</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">		for (Organization org : orgs) {</span>
<span class="nc" id="L493">			orgMap.put(org.getID(), org);</span>
<span class="nc" id="L494">		}</span>
<span class="nc" id="L495">		return new ArrayList&lt;WorkResourceRotation&gt;(rotationAssignments.values());</span>
	}

	private Collection&lt;EmpTimeBank&gt; getTimeBankAssignments() {
		//key = ID of corresponding time bank belonging to the assignment (not the assignment itself)
		//  We only want to display one of each time bank in the time bank list
<span class="nc" id="L501">		HashMap&lt;ID, EmpTimeBank&gt; timeBankAssignments =</span>
				new HashMap&lt;ID, EmpTimeBank&gt;();
<span class="nc" id="L503">		HashMap&lt;TimeBank, HashSet&lt;ID&gt;&gt; timeBankEmployeeMap = new HashMap&lt;TimeBank, HashSet&lt;ID&gt;&gt;();</span>

<span class="nc bnc" id="L505" title="All 2 branches missed.">		for (ID employeeID : timeBankAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">			for (EmpTimeBank etb : timeBankAssignmentMap.get(employeeID)) {</span>
<span class="nc" id="L507">				timeBankAssignments.put(etb.getTimeBankID(), etb);</span>

<span class="nc" id="L509">				HashSet&lt;ID&gt; associatedEmployeeIDs = timeBankEmployeeMap.get(timeBankMap.get(etb.getTimeBankID()));</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">				if (associatedEmployeeIDs == null) {</span>
<span class="nc" id="L511">					associatedEmployeeIDs = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L512">					timeBankEmployeeMap.put(timeBankMap.get(etb.getTimeBankID()), associatedEmployeeIDs);</span>
				}
<span class="nc" id="L514">				associatedEmployeeIDs.add(employeeID);</span>
<span class="nc" id="L515">			}</span>
<span class="nc" id="L516">		}</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">		for (EmpTimeBank etb : timeBankAssignments.values()) {</span>
<span class="nc" id="L518">			etb.setMultiEditCommon(</span>
<span class="nc" id="L519">					timeBankEmployeeMap.get(timeBankMap.get(etb.getTimeBankID())).containsAll(getSelectedIDsAsCollection()));</span>
<span class="nc" id="L520">		}</span>
<span class="nc" id="L521">		return new ArrayList&lt;EmpTimeBank&gt;(timeBankAssignments.values());</span>
	}

	private void loadWorkPatterns() throws BbmFinderException {
<span class="nc bnc" id="L525" title="All 4 branches missed.">		if (selectedSP != null &amp;&amp; selectedCampaign != null) {</span>
<span class="nc" id="L526">			workPatternAssignmentMap = WorkRulesModelHandler.getWorkPatternAssignmentsForEmployees(m_context,</span>
<span class="nc" id="L527">					getSelectedIDsAsCollection(), viewStartDate.getTime(selectedCampaign.getTimeZone()),</span>
<span class="nc" id="L528">					viewStartDate.getTime(selectedCampaign.getTimeZone()));</span>
		} else {
<span class="nc" id="L530">			workPatternAssignmentMap = WorkRulesModelHandler.getWorkPatternAssignmentsForEmployees(m_context,</span>
<span class="nc" id="L531">					getSelectedIDsAsCollection(), viewStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE),</span>
<span class="nc" id="L532">					viewEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
		}
		//We need to retrieve the work patterns in a separate call
		//TODO: This should really be a ValueObjectRich so it can be done in the back end but
		// I was unaware of how this would impact the FS client.
		// (These assignments also already extend DAOEffectivity which makes things more difficult)
<span class="nc" id="L538">		HashSet&lt;WorkResourceWorkPattern&gt; wrwps = new HashSet&lt;WorkResourceWorkPattern&gt;();</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">		for (ID employeeID : workPatternAssignmentMap.keySet()) {</span>
			//We only want to display the earliest skill assignment within the view period if the employee
			//  has multiple skill assignments for the same skill in the view period
<span class="nc" id="L542">			HashMap&lt;ID, WorkResourceWorkPattern&gt; filteredAssignmentMap = new HashMap&lt;ID, WorkResourceWorkPattern&gt;();</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">			for (WorkResourceWorkPattern wrwp : workPatternAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">				if (isWorkPatternAssignmentCurrent(wrwp)) {</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">					if (wrwp.getStartTime() != null) {</span>
<span class="nc" id="L546">						wrwp.setLocalStartTime(new LocalDate(wrwp.getStartTime(),</span>
<span class="nc" id="L547">								employeeMap.get(employeeID).getTimeZone(wrwp.getStartTime())));</span>
					}
<span class="nc bnc" id="L549" title="All 2 branches missed.">					if (wrwp.getEndTime() != null) {</span>
<span class="nc" id="L550">						wrwp.setLocalEndTime(new LocalDate(wrwp.getEndTime(),</span>
<span class="nc" id="L551">								employeeMap.get(employeeID).getTimeZone(wrwp.getEndTime())));</span>
					}
<span class="nc bnc" id="L553" title="All 2 branches missed.">					if (filteredAssignmentMap.get(wrwp.getWorkPatternSID()) == null) {</span>
<span class="nc" id="L554">						filteredAssignmentMap.put(wrwp.getWorkPatternSID(), wrwp);</span>
					} else {
<span class="nc" id="L556">						WorkResourceWorkPattern otherAssignment = filteredAssignmentMap.get(wrwp.getWorkPatternSID());</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">						if (wrwp.getStartTime().before(otherAssignment.getStartTime())) {</span>
<span class="nc" id="L558">							filteredAssignmentMap.put(wrwp.getWorkPatternSID(), wrwp);</span>
						}
					}

				}
<span class="nc" id="L563">			}</span>
<span class="nc" id="L564">			ArrayList&lt;WorkResourceWorkPattern&gt; filteredAssignments = new ArrayList&lt;WorkResourceWorkPattern&gt;(filteredAssignmentMap.values());</span>
<span class="nc" id="L565">			workPatternAssignmentMap.put(employeeID, filteredAssignments);</span>
<span class="nc" id="L566">			wrwps.addAll(filteredAssignments);</span>
<span class="nc" id="L567">		}</span>
<span class="nc" id="L568">		ArrayList&lt;ID&gt; workPatternIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">		for (WorkResourceWorkPattern wrwp : wrwps) {</span>
<span class="nc" id="L570">			workPatternIDs.add(wrwp.getWorkPatternSID());</span>
<span class="nc" id="L571">		}</span>
<span class="nc" id="L572">		Collection&lt;ShiftPattern&gt; tempWorkPatterns = WorkRulesModelHandler.getShiftPatterns(m_context, workPatternIDs);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">		for (ID employeeID : workPatternAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">			for (WorkResourceWorkPattern wrwp : workPatternAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">				for (ShiftPattern sp : tempWorkPatterns) {</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">					if (sp.getID().equals(wrwp.getWorkPatternSID())) {</span>
<span class="nc" id="L577">						wrwp.setWorkPattern(sp);</span>
<span class="nc" id="L578">						break;</span>
					}
<span class="nc" id="L580">				}</span>
<span class="nc" id="L581">			}</span>
<span class="nc" id="L582">		}</span>
<span class="nc" id="L583">	}</span>

	public void saveMinMaxHours() throws BbmException {
<span class="nc bnc" id="L586" title="All 2 branches missed.">		if (pc_hours.isAnySpinnerEnabled()) {</span>
<span class="nc" id="L587">			pc_hours.save();</span>
		}
<span class="nc" id="L589">	}</span>

	public void savePayPeriodHours() throws BbmException {
<span class="nc bnc" id="L592" title="All 4 branches missed.">		if (payPeriodHourPC != null &amp;&amp; payPeriodHourPC.isAnySpinnerEnabled()) {</span>
<span class="nc" id="L593">			payPeriodHourPC.save();</span>
		}
<span class="nc" id="L595">	}</span>

	public void savePoolingRules() throws BbmException {
<span class="nc bnc" id="L598" title="All 2 branches missed.">		if (pc_poolingRules != null) {</span>
<span class="nc" id="L599">			pc_poolingRules.save();</span>
		}
<span class="nc" id="L601">	}</span>

	public void saveWorkPatterns() throws BbmException {
<span class="nc bnc" id="L604" title="All 2 branches missed.">		if (pc_workPattern.save(employeeMap)) {</span>
			//On successful save, we need to refresh the work pattern map for the workPatternPC so that
			//merged assignments will be displayed
<span class="nc" id="L607">			loadWorkPatterns();</span>
<span class="nc" id="L608">			pc_workPattern.refreshWorkPatternMap(workPatternAssignmentMap);</span>
		}
<span class="nc" id="L610">	}</span>

	public void saveAssignmentRules() throws BbmException {
<span class="nc" id="L613">		pc_assignmentRule.save(assignmentRuleAssignmentMap);</span>
<span class="nc" id="L614">	}</span>

	public void saveRotations() throws BbmException {
<span class="nc" id="L617">		pc_rotation.save(rotationAssignmentMap);</span>
<span class="nc" id="L618">	}</span>

	public void saveTimeBanks() throws BbmException {
		//We only want to save time banks if we have a time bank license
<span class="nc bnc" id="L622" title="All 2 branches missed.">		if (hasTimeBankLicense()) {</span>
<span class="nc" id="L623">			pc_timeBank.save(timeBankAssignmentMap);</span>
		}
<span class="nc" id="L625">	}</span>

	/**
	 * Returns true if customer has a license to view time bank information.  If this is false,
	 * the time bank module on this page will not be available.
	 */
	private boolean hasTimeBankLicense() {
		try {
<span class="nc" id="L633">			return CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_TIME_BANK);</span>
<span class="nc" id="L634">		} catch (CoreEJBCreateException e) {</span>
<span class="nc" id="L635">		} catch (RemoteException e) {</span>
<span class="nc" id="L636">		}</span>
<span class="nc" id="L637">		return false;</span>
	}

	/**
	 * Returns true if customer has a license to pooling.  If this is false,
	 * the pooling module on this page will not be available.
	 */
	private boolean hasPoolingLicense() {
		try {
<span class="nc" id="L646">			return CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_CAMP_POOLING);</span>
<span class="nc" id="L647">		} catch (CoreEJBCreateException e) {</span>
<span class="nc" id="L648">		} catch (RemoteException e) {</span>
<span class="nc" id="L649">		}</span>
<span class="nc" id="L650">		return false;</span>
	}

	/**
	 * Determines if the current work pattern assignment is &quot;current&quot;, in other words it applies to the current
	 * view period.  This is true if the start date of the assignment lies before or at the view period start date
	 * and the assignment end date is either null or lies after the view period start date.  Work pattern assignments are also
	 * current if they lie between the view start and end dates.
	 */
	private boolean isWorkPatternAssignmentCurrent(WorkResourceWorkPattern assignment) {
<span class="nc bnc" id="L660" title="All 2 branches missed.">		if (selectedCampaign == null) {</span>
			TimeZone empTimeZone;
<span class="nc" id="L662">			Employee emp = employeeMap.get(assignment.getWorkResourceID());</span>

			//Determine time zone of employee at record start
<span class="nc bnc" id="L665" title="All 2 branches missed.">			if (emp.getStartTime().after(assignment.getStartTime())) {</span>
<span class="nc" id="L666">				empTimeZone = emp.getTimeZone(emp.getStartTime());</span>
			} else {
<span class="nc" id="L668">				empTimeZone = emp.getTimeZone(assignment.getStartTime());</span>
			}
<span class="nc" id="L670">			LocalDate localEffectiveStart = new LocalDate(assignment.getStartTime(), empTimeZone);</span>
<span class="nc" id="L671">			LocalDate localEffectiveEnd = null;</span>
			//Determine time zone of employee at record end
<span class="nc bnc" id="L673" title="All 2 branches missed.">			if (assignment.getEndTime() != null) {</span>
<span class="nc bnc" id="L674" title="All 4 branches missed.">				if (emp.getEndTime() == null || emp.getEndTime().after(assignment.getEndTime())) {</span>
<span class="nc" id="L675">					empTimeZone = emp.getTimeZone(assignment.getEndTime());</span>
				} else {
<span class="nc" id="L677">					empTimeZone = emp.getTimeZone(emp.getEndTime());</span>
				}
<span class="nc" id="L679">				localEffectiveEnd = new LocalDate(assignment.getEndTime(), empTimeZone);</span>
			}
<span class="nc bnc" id="L681" title="All 6 branches missed.">			return ((localEffectiveStart.before(viewStartDate) || localEffectiveStart.equals(viewStartDate))</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">					&amp;&amp; (localEffectiveEnd == null || localEffectiveEnd.after(viewStartDate))) ||</span>
<span class="nc bnc" id="L683" title="All 4 branches missed.">					(localEffectiveStart.after(viewStartDate) &amp;&amp; localEffectiveStart.before(viewEndDate));</span>
		} else {
<span class="nc" id="L685">			Date absoluteViewStartDate = viewStartDate.getTime(selectedCampaign.getTimeZone());</span>
<span class="nc" id="L686">			Date absoluteViewEndDate = viewEndDate.getTime(selectedCampaign.getTimeZone());</span>
<span class="nc bnc" id="L687" title="All 4 branches missed.">			return ((assignment.getStartTime().before(absoluteViewStartDate) || assignment.getStartTime().equals(absoluteViewStartDate))</span>
<span class="nc bnc" id="L688" title="All 4 branches missed.">					&amp;&amp; (assignment.getEndTime() == null || assignment.getEndTime().after(absoluteViewStartDate))) ||</span>
<span class="nc bnc" id="L689" title="All 4 branches missed.">					(assignment.getStartTime().after(absoluteViewStartDate) &amp;&amp; assignment.getStartTime().before(absoluteViewEndDate));</span>
		}
	}

	private boolean isEditable() {
<span class="nc bnc" id="L694" title="All 2 branches missed.">		for (Employee emp : employeeMap.values()) {</span>
<span class="nc" id="L695">			ScopeID scopeID = new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE);</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">			if (!m_context.getUser().isAuthorized(PrivilegeKeys.CORE_MODIFYPEOPLE, scopeID)) {</span>
<span class="nc" id="L697">				return false;</span>
			}
<span class="nc" id="L699">		}</span>

<span class="nc bnc" id="L701" title="All 2 branches missed.">		if (employeeMap.isEmpty()) {</span>
<span class="nc" id="L702">			return false;</span>
		}
<span class="nc" id="L704">		return true;</span>
	}

	@Override
	protected String getPageTitle() {
<span class="nc" id="L709">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_WORK_RULES_ASSIGNMENT);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>