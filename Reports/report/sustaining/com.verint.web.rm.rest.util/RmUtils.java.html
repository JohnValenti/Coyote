<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RmUtils.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.rm.rest.util</a> &gt; <span class="el_source">RmUtils.java</span></div><h1>RmUtils.java</h1><pre class="source lang-java linenums">package com.verint.web.rm.rest.util;

import java.rmi.RemoteException;
import java.text.ParsePosition;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;
import javax.ws.rs.core.Response;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftOTExtension;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TORequestManager;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestUtil;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.rest.exception.checked.BusinessWFOException;
import com.verint.web.rest.exception.checked.SystemWFOException;
import com.verint.web.rest.exception.checked.WFOException;
import com.verint.web.rest.util.FormatUtils;
import com.verint.web.rm.rest.entity.Entity;
import com.verint.web.rm.rest.entity.MessageEntity;
import com.verint.web.rm.rest.entity.RequestEntity;
import com.verint.web.rm.rest.entity.RequestStatusEntity;
import com.verint.web.rm.rest.entity.TimeRangeEntity;
import com.verint.web.rm.rest.entity.ValidationResultEntity;
import com.verint.web.rm.rest.entity.custshift.ShiftOTExtensionEntity;
import com.verint.web.rm.rest.entity.shiftbidding.ActivityEntity;
import com.verint.web.rm.rest.entity.shiftbidding.AuctionEntity;
import com.verint.web.rm.rest.entity.timeoff.TimeOffRequestEntity;
import com.verint.web.rm.rest.facade.timeoff.TimeOffRequestFacadeImpl;
import com.witness.ejb.core.security.UserManager;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;

<span class="nc" id="L73">public class RmUtils {</span>

<span class="nc" id="L75">	private static final Category LOG = Log.initCategory(TimeOffRequestFacadeImpl.class.getName());</span>

	public static final String ACTIVITY_ID_FN = &quot;activityID&quot;;
	public static final String AUCTION_ID_FN = &quot;auctionID&quot;;
	public static final String DATE_FN = &quot;date&quot;;
	public static final String END_DATE_FN = &quot;endDate&quot;;
	public static final String EXPIRATION_DATE_FN = &quot;expirationDate&quot;;
	public static final String ID_FN = &quot;id&quot;;
	public static final String NAME_FN = &quot;name&quot;;
	public static final String OVERTIME_FN = &quot;overtime&quot;;
	public static final String PREFERENCE_FN = &quot;preference&quot;;
	public static final String REQUEST_ID_FN = &quot;requestID&quot;;
	public static final String SCHEDULE_IDS_FN = &quot;scheduleIDs&quot;;
	public static final String SHIFT_BIDDER_ID_FN = &quot;shiftBidderID&quot;;
	public static final String SHIFT_ID_FN = &quot;shiftID&quot;;
	public static final String START_DATE_FN = &quot;startDate&quot;;
	public static final String START_TIME_FN = &quot;startTime&quot;;
	public static final String TYPE_FN = &quot;type&quot;;
	public static final String TO_YEAR_FN = &quot;toYear&quot;;
	public static final String VIEW_FN = &quot;view&quot;;

<span class="nc" id="L96">	protected enum Status {</span>
<span class="nc" id="L97">		PENDING (RequestAuditTrail.STATUS_PENDING, Integer.valueOf(1)),</span>
<span class="nc" id="L98">		APPROVED (RequestAuditTrail.STATUS_APPROVED, Integer.valueOf(2)),</span>
<span class="nc" id="L99">		DENIED (RequestAuditTrail.STATUS_DENIED, Integer.valueOf(4)),</span>
<span class="nc" id="L100">		ESCALATED (RequestAuditTrail.STATUS_ESCALATED, Integer.valueOf(8)),</span>
<span class="nc" id="L101">		NEGOTIATION (RequestAuditTrail.STATUS_NEGOTIATION, Integer.valueOf(16)),</span>
<span class="nc" id="L102">		TENTATIVE (RequestAuditTrail.STATUS_TENTATIVE, Integer.valueOf(32)),</span>
<span class="nc" id="L103">		INVALID (RequestAuditTrail.STATUS_INVALID, Integer.valueOf(64)),</span>
<span class="nc" id="L104">		WITHDRAWN (RequestAuditTrail.STATUS_WITHDRAWN, Integer.valueOf(128)),</span>
<span class="nc" id="L105">		WAITLIST (RequestAuditTrail.STATUS_WAITLIST, Integer.valueOf(256)),</span>
<span class="nc" id="L106">		WITHDRAW_REQUEST (RequestAuditTrail.STATUS_WITHDRAW_REQUEST, Integer.valueOf(512)),</span>
<span class="nc" id="L107">		WITHDRAW_REJECT (RequestAuditTrail.STATUS_WITHDRAW_REJECT, Integer.valueOf(1024)),</span>
<span class="nc" id="L108">		WITHDRAW_CANCEL (RequestAuditTrail.STATUS_WITHDRAW_CANCEL, Integer.valueOf(2048)),</span>
<span class="nc" id="L109">		WITHDRAW_ACCEPT (RequestAuditTrail.STATUS_WITHDRAW_ACCEPT, Integer.valueOf(4096)),</span>
<span class="nc" id="L110">		WITHDRAW_NEGOTIATION (RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION, Integer.valueOf(8192));</span>

		private final String statusCode;
		private final Integer statusInt;

<span class="nc" id="L115">		Status(String statusCode, Integer statusInt) {</span>
<span class="nc" id="L116">			this.statusCode = statusCode;</span>
<span class="nc" id="L117">			this.statusInt = statusInt.intValue();</span>
<span class="nc" id="L118">		}</span>

		protected Integer getStatusInt() {
<span class="nc" id="L121">			return statusInt;</span>
		}

		protected String getStatusCode() {
<span class="nc" id="L125">			return statusCode;</span>
		}
	}

<span class="nc" id="L129">	private static Map&lt;String, Status&gt; m_all_status = new HashMap&lt;String, Status&gt;(11);</span>
	static {
<span class="nc" id="L131">		m_all_status.put(RequestAuditTrail.STATUS_PENDING, Status.PENDING);</span>
<span class="nc" id="L132">		m_all_status.put(RequestAuditTrail.STATUS_APPROVED, Status.APPROVED);</span>
<span class="nc" id="L133">		m_all_status.put(RequestAuditTrail.STATUS_DENIED, Status.DENIED);</span>
<span class="nc" id="L134">		m_all_status.put(RequestAuditTrail.STATUS_ESCALATED, Status.ESCALATED);</span>
<span class="nc" id="L135">		m_all_status.put(RequestAuditTrail.STATUS_NEGOTIATION, Status.NEGOTIATION);</span>
<span class="nc" id="L136">		m_all_status.put(RequestAuditTrail.STATUS_TENTATIVE, Status.TENTATIVE);</span>
<span class="nc" id="L137">		m_all_status.put(RequestAuditTrail.STATUS_INVALID, Status.INVALID);</span>
<span class="nc" id="L138">		m_all_status.put(RequestAuditTrail.STATUS_WITHDRAWN, Status.WITHDRAWN);</span>
<span class="nc" id="L139">		m_all_status.put(RequestAuditTrail.STATUS_WAITLIST, Status.WAITLIST);</span>
<span class="nc" id="L140">		m_all_status.put(RequestAuditTrail.STATUS_WITHDRAW_REQUEST, Status.WITHDRAW_REQUEST);</span>
<span class="nc" id="L141">		m_all_status.put(RequestAuditTrail.STATUS_WITHDRAW_REJECT, Status.WITHDRAW_REJECT);</span>
<span class="nc" id="L142">		m_all_status.put(RequestAuditTrail.STATUS_WITHDRAW_CANCEL, Status.WITHDRAW_CANCEL);</span>
<span class="nc" id="L143">		m_all_status.put(RequestAuditTrail.STATUS_WITHDRAW_ACCEPT, Status.WITHDRAW_ACCEPT);</span>
<span class="nc" id="L144">		m_all_status.put(RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION, Status.WITHDRAW_NEGOTIATION);</span>
<span class="nc" id="L145">	}</span>


	public static TORequestManager  getTORequestManager() {
		try {
<span class="nc" id="L150">			RmManagerFactory rmMgrFactory = RmManagerFactory.getInstance(true);</span>
<span class="nc" id="L151">			return rmMgrFactory.getTimeOffRequestManager();</span>
<span class="nc" id="L152">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L153">			throw new RuntimeException(&quot;Cannot get WorkResourceManager.&quot;);</span>
		}
	}

	public static ActivityManager getActivityManager() {
		try {
<span class="nc" id="L159">			return WfmManagerFactory.getActivityManager();</span>
<span class="nc" id="L160">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L161">			throw new RuntimeException(&quot;Cannot get WorkResourceManager.&quot;);</span>
		}
	}

	public static WorkResourceManager getWorkResourceManager() {
		try {
<span class="nc" id="L167">			return BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L168">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L169">			throw new RuntimeException(&quot;Cannot get WorkResourceManager.&quot;);</span>
		}
	}

	public static UserManager getUserManager() {
		try {
<span class="nc" id="L175">			return CoreManagerFactory.getUserManager(false);</span>
<span class="nc" id="L176">		} catch (Exception e) {</span>
<span class="nc" id="L177">			throw new RuntimeException(&quot;Cannot get UserManager.&quot;);</span>
		}
	}

	public static void setStatusCode(TimeOffRequestEntity reqEntity, String strStatus) {
<span class="nc" id="L182">		Status status = m_all_status.get(strStatus);</span>
<span class="nc" id="L183">		reqEntity.setStatusCode(status.getStatusInt().intValue());</span>
<span class="nc" id="L184">	}</span>

	/**
	 * We will not specify status in the RequestFilter.
	 * Create a list to store the requested statuses for filtering in the facade impl later.
	 */
	public static List&lt;String&gt; getStatusListForFilter(int status) {
<span class="nc" id="L191">		List&lt;String&gt; statusList = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">		for (Status s : Status.values()) {</span>
			// status==0 means all status codes
<span class="nc bnc" id="L194" title="All 4 branches missed.">			if (status==0 || ((s.getStatusInt() &amp; status) &gt; 0)) {</span>
<span class="nc" id="L195">				statusList.add(s.getStatusCode());</span>
			}
		}

<span class="nc" id="L199">		return statusList;</span>
	}

	public static int getRequestStatusCode(String strStatus) {
<span class="nc" id="L203">		Status status = m_all_status.get(strStatus);</span>
<span class="nc" id="L204">		return status.getStatusInt().intValue();</span>
	}

	/**
	 * Breaks up an input list into pages
	 *
	 * @param input
	 *            The input list to break up into pages
	 * @param pageSize
	 *            The size of each page
	 * @param pageNumber
	 *            The page to return. pageNumber starts at zero
	 * @return The list containing the page requested. It the page is out of
	 *         bounds an empty list is returned
	 */
	public static &lt;T&gt; List&lt;T&gt; pageList(List&lt;T&gt; input, int pageSize, int pageNumber) {
<span class="nc" id="L220">		int startIndex = pageSize * pageNumber;</span>
<span class="nc" id="L221">		int endIndex = pageSize * (pageNumber + 1);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">		if (input == null) {</span>
<span class="nc" id="L223">			return Collections.emptyList();</span>
		}
<span class="nc bnc" id="L225" title="All 4 branches missed.">		if (startIndex &gt;= input.size() || startIndex &lt; 0) {</span>
<span class="nc" id="L226">			return Collections.emptyList();</span>
		}
<span class="nc bnc" id="L228" title="All 2 branches missed.">		if (endIndex &gt; input.size()) {</span>
<span class="nc" id="L229">			endIndex = input.size();</span>
		}

<span class="nc" id="L232">		return input.subList(startIndex, endIndex);</span>
	}



	public static &lt;T&gt; String join(Collection&lt;T&gt; input,  char separator) {
<span class="nc" id="L238">		StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">		for (Iterator&lt;T&gt; it=input.iterator(); it.hasNext();) {</span>
<span class="nc" id="L240">			T elem = it.next();</span>
<span class="nc" id="L241">			sb.append(elem.toString());</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">			if(it.hasNext()) {</span>
<span class="nc" id="L243">				sb.append(separator);</span>
			}
<span class="nc" id="L245">		}</span>
<span class="nc" id="L246">		return sb.toString();</span>
	}

	public static void addActivities(RequestContext context, List&lt;ActivityEntity&gt; entities, Set&lt;ID&gt; activityIDs) throws RemoteException,
			BbmException {
<span class="nc" id="L251">		Map&lt;ID, Activity&gt; activiesByID = ActivityModelHandler.getAllActivitiesMap(context);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">		for (ID activityID : activityIDs) {</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">			if (activiesByID.containsKey(activityID)) {</span>
<span class="nc" id="L254">				entities.add(new ActivityEntity(activiesByID.get(activityID)));</span>
			}
<span class="nc" id="L256">		}</span>
<span class="nc" id="L257">	}</span>

	public static void addAuctions(List&lt;AuctionEntity&gt; target, Collection&lt;ShiftBidAuction&gt; auctions) {
<span class="nc bnc" id="L260" title="All 2 branches missed.">		for (ShiftBidAuction auction : auctions) {</span>
<span class="nc" id="L261">			target.add(new AuctionEntity(auction));</span>
<span class="nc" id="L262">		}</span>
<span class="nc" id="L263">	}</span>

	public static void addShifts(List&lt;Entity&gt; entities, Set&lt;ID&gt; shiftIDs)
			throws BbmEJBCreateException, BbmFinderException, RemoteException {
<span class="nc" id="L267">		WorkRuleManager wrm = WfmManagerFactory.getWorkRuleManager();</span>
<span class="nc" id="L268">		Collection&lt;Shift&gt; shifts = wrm.getShiftsByIDs(shiftIDs);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">		if (shifts != null) {</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">			for (Shift shift : shifts) {</span>
<span class="nc" id="L271">				Entity entity = new Entity();</span>
<span class="nc" id="L272">				entity.setId(shift.getID().toString());</span>
<span class="nc" id="L273">				entity.setName(shift.getName());</span>
<span class="nc" id="L274">				entities.add(entity);</span>
<span class="nc" id="L275">			}</span>
		}
<span class="nc" id="L277">	}</span>

	public static void addShiftOTExtensions(List&lt;Entity&gt; entities, Set&lt;ID&gt; shiftOTExtensionIDs)
			throws BbmEJBCreateException, BbmFinderException, RemoteException {
<span class="nc" id="L281">		WorkRuleManager wrm = WfmManagerFactory.getWorkRuleManager();</span>
<span class="nc" id="L282">		Collection&lt;ShiftOTExtension&gt; shiftExtensions = wrm.getShiftOTExtensionsByIDs(shiftOTExtensionIDs);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">		if (shiftExtensions != null) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">			for (ShiftOTExtension shiftExtension : shiftExtensions) {</span>
<span class="nc" id="L285">				ShiftOTExtensionEntity entity = new ShiftOTExtensionEntity(shiftExtension);</span>
<span class="nc" id="L286">				entities.add(entity);</span>
<span class="nc" id="L287">			}</span>
		}
<span class="nc" id="L289">	}</span>

	public static void addTimeRanges(List&lt;TimeRangeEntity&gt; dest, List&lt;TimeRange&gt; source) {
<span class="nc bnc" id="L292" title="All 2 branches missed.">		if (source == null) {</span>
<span class="nc" id="L293">			return;</span>
		}
<span class="nc bnc" id="L295" title="All 2 branches missed.">		for (TimeRange range : source) {</span>
<span class="nc" id="L296">			TimeRangeEntity entity = new TimeRangeEntity();</span>
<span class="nc" id="L297">			entity.setStartDate(FormatUtils.dateToISO8601SecPrecisionString(range.getStartDate()));</span>
<span class="nc" id="L298">			entity.setEndDate(FormatUtils.dateToISO8601SecPrecisionString(range.getEndDate()));</span>
<span class="nc" id="L299">			dest.add(entity);</span>
<span class="nc" id="L300">		}</span>
<span class="nc" id="L301">	}</span>

	public static void assertNonZeroParameter(Localizer localizer, int value, String paramName)
			throws BusinessWFOException {
<span class="nc bnc" id="L305" title="All 2 branches missed.">		if (value == 0) {</span>
<span class="nc" id="L306">			throw getParameterIsRequiredException(localizer, paramName);</span>
		}
<span class="nc" id="L308">	}</span>

	public static void assertRequired(Localizer localizer, String value, String paramName)
			throws BusinessWFOException {
<span class="nc bnc" id="L312" title="All 2 branches missed.">		if (StringUtil.isEmptyOrWhiteSpace(value)) {</span>
<span class="nc" id="L313">			throw getParameterIsRequiredException(localizer, paramName);</span>
		}
<span class="nc" id="L315">	}</span>

	public static boolean getBoolean(HttpServletRequest request, String paramName, boolean defaultValue) {
<span class="nc" id="L318">		String strBoolean = request.getParameter(paramName);</span>
<span class="nc" id="L319">		boolean value = defaultValue;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">		if (!StringUtil.isEmptyOrWhiteSpace(strBoolean)) {</span>
<span class="nc" id="L321">			value = Boolean.parseBoolean(strBoolean);</span>
		}
<span class="nc" id="L323">		return value;</span>
	}

	/**
	 * Gets a Calendar for the date parameter in yyyy-MM format.
	 */
	public static Calendar getCalendarFromYearMonth(HttpServletRequest request, String paramName, TimeZone timeZone) {
<span class="nc" id="L330">		String strDate = request.getParameter(paramName);</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">		if (strDate == null) {</span>
<span class="nc" id="L332">			return null;</span>
		}
<span class="nc" id="L334">		SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM&quot;);</span>
<span class="nc" id="L335">		sdf.setTimeZone(timeZone);</span>
<span class="nc" id="L336">		Calendar cal = Calendar.getInstance(timeZone);</span>
<span class="nc" id="L337">		cal.setTime(sdf.parse(strDate, new ParsePosition(0)));</span>
<span class="nc" id="L338">		return cal;</span>
	}

	/**
	 * Gets a date for the specified request parameter. If it doesn't exist a BusinessWFOException is thrown with a BAD_REQUEST status.
	 */
	public static Date getDate(RequestContext context, HttpServletRequest request, String paramName)
			throws BusinessWFOException {
<span class="nc" id="L346">		String sDate = request.getParameter(paramName);</span>
<span class="nc" id="L347">		return getDate(context, sDate, paramName);</span>
	}

	/**
	 * Gets a date for the specified request parameter. If it doesn't exist null is returned.
	 */
	public static Date getDateNullable(HttpServletRequest request, String paramName)
			throws BusinessWFOException {
<span class="nc" id="L355">		String sDate = request.getParameter(paramName);</span>
<span class="nc" id="L356">		return getDate(sDate);</span>
	}

	/**
	 * Gets a date from the specified string. If it doesn't exist, null is returned.
	 */
	public static Date getDate(String sDate) {
<span class="nc bnc" id="L363" title="All 2 branches missed.">		if (StringUtil.isEmptyOrWhiteSpace(sDate)) {</span>
<span class="nc" id="L364">			return null;</span>
		}
<span class="nc" id="L366">		return FormatUtils.iso8601SecPrecisionStringToDate(sDate);</span>
	}

	/**
	 * Gets a date from the specified string. If it doesn't exist a BusinessWFOException is thrown with a BAD_REQUEST status.
	 */
	public static Date getDate(RequestContext context, String sDate, String paramName)
			throws BusinessWFOException {
<span class="nc" id="L374">		return getDate(context.getLocalizer(), sDate, paramName);</span>
	}

	/**
	 * Gets a date from the specified string. If it doesn't exist a BusinessWFOException is thrown with a BAD_REQUEST status.
	 */
	public static Date getDate(Localizer localizer, String sDate, String paramName)
			throws BusinessWFOException {
<span class="nc bnc" id="L382" title="All 2 branches missed.">		if (StringUtil.isEmptyOrWhiteSpace(sDate)) {</span>
<span class="nc" id="L383">			throw getParameterIsRequiredException(localizer, paramName);</span>
		}

<span class="nc" id="L386">		return FormatUtils.iso8601SecPrecisionStringToDate(sDate);</span>
	}

	/**
	 * Returns the int value of the id, otherwise 0 is returned.
	 */
	public static int getInt(ID id) {
<span class="nc bnc" id="L393" title="All 2 branches missed.">		if (id != null) {</span>
<span class="nc" id="L394">			return id.toInt();</span>
		}
<span class="nc" id="L396">		return 0;</span>
	}

	public static int getInt(RequestContext context, HttpServletRequest request, String paramName, Integer defaultValue)
			throws BusinessWFOException {
<span class="nc" id="L401">		String strValue = request.getParameter(paramName);</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">		if (StringUtil.isEmptyOrWhiteSpace(strValue)) {</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">			if (defaultValue == null) {</span>
<span class="nc" id="L404">				throw getParameterIsRequiredException(context.getLocalizer(), paramName);</span>
			}
<span class="nc" id="L406">			return defaultValue.intValue();</span>
		}
<span class="nc" id="L408">		return Integer.parseInt(strValue);</span>
	}

	public static ID getID(String value) {
<span class="nc bnc" id="L412" title="All 2 branches missed.">		if (value == null) {</span>
<span class="nc" id="L413">			return null;</span>
		}
<span class="nc" id="L415">		return new ID(value);</span>
	}

	public static ID getID(Integer id) {
<span class="nc bnc" id="L419" title="All 2 branches missed.">		if (id == null) {</span>
<span class="nc" id="L420">			return null;</span>
		}
<span class="nc" id="L422">		return new ID(id);</span>
	}

	public static ID getID(Localizer localizer, String value, String paramName) throws BusinessWFOException {
<span class="nc bnc" id="L426" title="All 2 branches missed.">		if (StringUtil.isEmptyOrWhiteSpace(value)) {</span>
<span class="nc" id="L427">			throw getParameterIsRequiredException(localizer, paramName);</span>
		}
<span class="nc" id="L429">		return new ID(value);</span>
	}

	public static ID getID(RequestContext context, String paramName) throws BusinessWFOException {
<span class="nc" id="L433">		return getID(context, paramName, true);</span>
	}

	public static ID getID(RequestContext context, String paramName, boolean isRequired) throws BusinessWFOException {
<span class="nc" id="L437">		String sID = context.getParameter(paramName);</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">		if (StringUtil.isEmptyOrWhiteSpace(sID)) {</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">			if (isRequired) {</span>
<span class="nc" id="L440">				throw getParameterIsRequiredException(context.getLocalizer(), paramName);</span>
			}
<span class="nc" id="L442">			return null;</span>
		}
<span class="nc" id="L444">		return new ID(sID);</span>
	}

	public static List&lt;ID&gt; getIDList(List&lt;Integer&gt; values) {
<span class="nc" id="L448">		List&lt;ID&gt; results = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">		if (values != null) {</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">			for (Integer value : values) {</span>
<span class="nc" id="L451">				results.add(ID.fromInt(value.intValue()));</span>
<span class="nc" id="L452">			}</span>
		}
<span class="nc" id="L454">		return results;</span>
	}

	public static Integer getInteger(Activity activity) {
<span class="nc bnc" id="L458" title="All 2 branches missed.">		if (activity != null) {</span>
<span class="nc" id="L459">			return getInt(activity.getID());</span>
		}
<span class="nc" id="L461">		return null;</span>
	}

	/**
	 * Returns the string value of the id, otherwise null is returned.
	 */
	public static Integer getInteger(ID id) {
<span class="nc bnc" id="L468" title="All 2 branches missed.">		if (id != null) {</span>
<span class="nc" id="L469">			return id.toInt();</span>
		}
<span class="nc" id="L471">		return null;</span>
	}

	/**
	 * Returns the string value of the id, otherwise null is returned.
	 */
	public static String getString(ID id) {
<span class="nc bnc" id="L478" title="All 2 branches missed.">		if (id != null) {</span>
<span class="nc" id="L479">			return id.toString();</span>
		}
<span class="nc" id="L481">		return null;</span>
	}

	public static String getString(Date date) {
<span class="nc bnc" id="L485" title="All 2 branches missed.">		if (date == null) {</span>
<span class="nc" id="L486">			return null;</span>
		}
<span class="nc" id="L488">		return FormatUtils.dateToISO8601SecPrecisionString(date);</span>
	}

	public static BusinessWFOException getParameterIsRequiredException(Localizer localizer, String paramName) {
<span class="nc" id="L492">		String msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.PARAMETER_IS_REQUIRED, paramName);</span>
<span class="nc" id="L493">		return new BusinessWFOException(msg, Response.Status.BAD_REQUEST);</span>
	}

	/**
	 * Logs the exception and returns an exception to be thrown by the facade implementation.
	 */
	public static WFOException handleFacadeException(RequestContext context, Exception ex, Category log) {
<span class="nc bnc" id="L500" title="All 4 branches missed.">		if (ex instanceof RemoteException || ex instanceof BbmException) {</span>
<span class="nc" id="L501">			log.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L502">			return new BusinessWFOException(ex.getLocalizedMessage(), Response.Status.BAD_REQUEST);</span>
		}

<span class="nc bnc" id="L505" title="All 2 branches missed.">		if (ex instanceof WFOException) {</span>
<span class="nc" id="L506">			log.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L507">			return (WFOException) ex;</span>
		}

<span class="nc bnc" id="L510" title="All 2 branches missed.">		if (ex instanceof RmHardValidationException) {</span>
<span class="nc" id="L511">			RmHardValidationException hardValEx = (RmHardValidationException) ex;</span>
<span class="nc" id="L512">			String msg = hardValEx.getLocalizedMessage(context.getLocalizer(), context.getViewingTimeZone());</span>
<span class="nc" id="L513">			log.error(msg, ex);</span>
<span class="nc" id="L514">			return new BusinessWFOException(msg, Response.Status.CONFLICT);</span>
		}

<span class="nc" id="L517">		log.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L518">		return new SystemWFOException(ex.getLocalizedMessage());</span>
	}

	/**
	 * Logs the exception and returns an exception to be thrown by the service.
	 */
	public static WFOException handleServiceException(Exception ex, Category log) {
<span class="nc bnc" id="L525" title="All 2 branches missed.">		if (ex instanceof IllegalArgumentException) {</span>
<span class="nc" id="L526">			log.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L527">			return new BusinessWFOException(ex.getLocalizedMessage(), Response.Status.BAD_REQUEST);</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">		} else if (ex instanceof WFOException) {</span>
<span class="nc" id="L529">			log.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L530">			return (WFOException) ex;</span>
		}
<span class="nc" id="L532">		log.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L533">		return new SystemWFOException(ex.getLocalizedMessage());</span>
	}

	/**
	 * Throws a BusinessWFOException if the user is not authorized for at least one privilege.
	 */
	public static void assertIsAuthorized(RequestContext context, ID... privilegeIDs) throws BusinessWFOException {
<span class="nc bnc" id="L540" title="All 2 branches missed.">		if (!isAuthorizedForAtLeastOne(context, privilegeIDs)) {</span>
<span class="nc" id="L541">			throwUnauthorizedRequest(context);</span>
		}
<span class="nc" id="L543">	}</span>

	/**
	 * Returns true if the user has at least one privilege.
	 */
	public static boolean isAuthorizedForAtLeastOne(RequestContext context, ID... privilegeIDs) {
<span class="nc" id="L549">		User user = context.getUser();</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">		for (ID privilegeID : privilegeIDs) {</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">			if (user.isAuthorized(privilegeID)) {</span>
<span class="nc" id="L552">				return true;</span>
			}
		}
<span class="nc" id="L555">		return false;</span>
	}

	/**
	 * Throws a BusinessWFOException if the system doesn't have the advanced RM license.
	 */
	public static void assertHasAdvancedRmLicense(RequestContext context) throws BusinessWFOException {
<span class="nc bnc" id="L562" title="All 2 branches missed.">		if (!LicenseUtil.isAdvancedRMLicense()) {</span>
<span class="nc" id="L563">			throwUnauthorizedRequest(context);</span>
		}
<span class="nc" id="L565">	}</span>

	/**
	 * Throws a BusinessWFOException if the system doesn't have the RM Shift Bidding license.
	 */
	public static void assertHasShiftBiddingLicense(RequestContext context) throws BusinessWFOException {
<span class="nc bnc" id="L571" title="All 2 branches missed.">		if (!LicenseUtil.hasShiftBiddingLicense()) {</span>
<span class="nc" id="L572">			throwUnauthorizedRequest(context);</span>
		}
<span class="nc" id="L574">	}</span>

	/**
	 * Throws a BusinessWFOException if the system doesn't have the RM Time Off Manager license.
	 */
	public static void assertHasTimeOffManagerLicense(RequestContext context) throws BusinessWFOException {
<span class="nc bnc" id="L580" title="All 2 branches missed.">		if (!LicenseUtil.hasTimeOffManagerLicense()) {</span>
<span class="nc" id="L581">			throwUnauthorizedRequest(context);</span>
		}
<span class="nc" id="L583">	}</span>

	/**
	 * Throws a BusinessWFOException for an unauthorized request.
	 */
	public static void throwUnauthorizedRequest(RequestContext context) throws BusinessWFOException {
<span class="nc" id="L589">		String msg = context.getLocalizer().i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.UNAUTHORIZED_REQUEST);</span>
<span class="nc" id="L590">		throw new BusinessWFOException(msg, Response.Status.FORBIDDEN);</span>
	}

	/**
	 * Throws a BusinessWFOException for unauthorized to access RM request.
	 */
	public static void throwUnauthorizedToAccessRequest(RequestContext context) throws BusinessWFOException {
<span class="nc" id="L597">		String msg = context.getLocalizer().i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.UNAUTHORIZED_TO_ACCESS_REQUEST);</span>
<span class="nc" id="L598">		throw new BusinessWFOException(msg, Response.Status.CONFLICT);</span>
	}

	public static void setStatusHistory(RequestEntity reqEntity, Collection&lt;RequestAuditTrail&gt; auditTrails) {
<span class="nc bnc" id="L602" title="All 2 branches missed.">		if (auditTrails == null) {</span>
<span class="nc" id="L603">			return;</span>
		}
<span class="nc" id="L605">		List&lt;RequestStatusEntity&gt; reqStatusList = new ArrayList&lt;RequestStatusEntity&gt;();</span>
<span class="nc" id="L606">		UserManager userMgr = RmUtils.getUserManager();</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">		for (RequestAuditTrail auditTrail : auditTrails) {</span>
<span class="nc" id="L608">			RequestStatusEntity reqStatus = new RequestStatusEntity();</span>
<span class="nc" id="L609">			reqStatus.setChangeDate(FormatUtils.dateToISO8601SecPrecisionString(auditTrail.getModifiedAt()));</span>
<span class="nc" id="L610">			reqStatus.setComments(auditTrail.getNote());</span>
<span class="nc" id="L611">			reqStatus.setModifiedBy(getUserName(userMgr, auditTrail));</span>
<span class="nc" id="L612">			reqStatus.setStatusCode(RmUtils.getRequestStatusCode(auditTrail.getStatus()));</span>
<span class="nc" id="L613">			reqStatusList.add(reqStatus);</span>
<span class="nc" id="L614">		}</span>

<span class="nc" id="L616">		reqEntity.setStatusHistory(reqStatusList);</span>
<span class="nc" id="L617">	}</span>

	public static void setValidationResults(RequestEntity reqEntity, Collection&lt;ValidationResult&gt; valResults,
			RequestContext context) {
<span class="nc bnc" id="L621" title="All 2 branches missed.">		if (valResults == null) {</span>
<span class="nc" id="L622">			return;</span>
		}
<span class="nc" id="L624">		List&lt;ValidationResultEntity&gt; valResultsList = new ArrayList&lt;ValidationResultEntity&gt;();</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">		for (ValidationResult valResult : valResults) {</span>
<span class="nc" id="L626">			ValidationResultEntity reqValResult = new ValidationResultEntity();</span>
<span class="nc" id="L627">			reqValResult.setRelativeUrl(getValidationUrl(valResult, context));</span>
<span class="nc" id="L628">			reqValResult.setErrorMessage(valResult.getLocalizedMessage(context.getLocalizer(), context.getViewingTimeZone()));</span>
<span class="nc" id="L629">			valResultsList.add(reqValResult);</span>
<span class="nc" id="L630">		}</span>

<span class="nc" id="L632">		reqEntity.setValidationResults(valResultsList);</span>
<span class="nc" id="L633">	}</span>

	public static String getValidationUrl(ValidationResult vr, RequestContext context) {
<span class="nc bnc" id="L636" title="All 2 branches missed.">		if (!vr.isSoft()) {</span>
<span class="nc" id="L637">			return &quot;&quot;; // Hard validation does not have alerts</span>
		}

<span class="nc" id="L640">		String validatorName = vr.getValidatorName();</span>
<span class="nc" id="L641">		String[] imgStrs = RequestUtil.getImgStrings(validatorName, context.getLocalizer());</span>

<span class="nc" id="L643">		return imgStrs[0];</span>
	}

	private static String getUserName(UserManager userMgr, RequestAuditTrail auditTrail) {
<span class="nc" id="L647">		String userName = &quot;&quot;;</span>
		try {
<span class="nc" id="L649">			User atUser = userMgr.getUserByID(auditTrail.getBpUserId());</span>
<span class="nc" id="L650">			userName = atUser.getUserName();</span>
<span class="nc" id="L651">		} catch (Exception e) {</span>
<span class="nc" id="L652">			LOG.debug(&quot;cannot retrieve user name for request audit trail&quot;);</span>
<span class="nc" id="L653">		}</span>
<span class="nc" id="L654">		return userName;</span>
	}

	public static ID stringToIntegerID(String sId)
	{
<span class="nc bnc" id="L659" title="All 2 branches missed.">		return (sId==null? null: ID.fromInt(Integer.parseInt(sId)));</span>
	}

	public static Calendar getCalendarInGMTFromDate(Date date)
	{
<span class="nc" id="L664">		Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L665">		cal.setTimeZone(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">		if(date != null)</span>
		{
<span class="nc" id="L668">			cal.setTime(date);</span>
		}
<span class="nc" id="L670">		return cal;</span>
	}

	public static void assertNotNull(RequestContext context, RequestAggregate request, ID requestID) throws BusinessWFOException {
<span class="nc bnc" id="L674" title="All 2 branches missed.">		if (request == null) {</span>
<span class="nc" id="L675">			throwExceptionForFailedToLoadRequestWithID(context, requestID);</span>
		}
<span class="nc" id="L677">	}</span>

	public static BusinessWFOException createInvalidParameterException(Localizer localizer, String parameterName) {
<span class="nc" id="L680">		String msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.INVALID_PARAMETER, parameterName);</span>
<span class="nc" id="L681">		return new BusinessWFOException(msg, Response.Status.BAD_REQUEST);</span>
	}

	public static void throwExceptionFromContextPageMessage(RequestContext context)
			throws BusinessWFOException {
<span class="nc" id="L686">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L687">		String errorMsg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.UNABLE_TO_SAVE_REQUEST);</span>
<span class="nc" id="L688">		Collection&lt;Message&gt; messages = context.getPageMessages();</span>
<span class="nc" id="L689">		Iterator&lt;Message&gt; it = messages.iterator();</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">		if (it.hasNext()) {</span>
<span class="nc" id="L691">			Message message = it.next();</span>
<span class="nc" id="L692">			errorMsg = message.getLocalizedMessage(localizer);</span>
		}
<span class="nc" id="L694">		throw new BusinessWFOException(errorMsg, Response.Status.BAD_REQUEST);</span>
	}

	public static void throwExceptionFromPageMessage(RequestContext context, PageModel model)
			throws BusinessWFOException {
<span class="nc" id="L699">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L700">		String errorMsg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.UNABLE_TO_SAVE_REQUEST);</span>
<span class="nc" id="L701">		Collection&lt;Message&gt; messages = model.getPageMessageList();</span>
<span class="nc" id="L702">		Iterator&lt;Message&gt; it = messages.iterator();</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">		if (it.hasNext()) {</span>
<span class="nc" id="L704">			Message message = it.next();</span>
<span class="nc" id="L705">			errorMsg = message.getLocalizedMessage(localizer);</span>
		}
<span class="nc" id="L707">		throw new BusinessWFOException(errorMsg, Response.Status.BAD_REQUEST);</span>
	}

	public static void throwExceptionBadRequest(Localizer localizer, String bundleName, String key) throws BusinessWFOException {
<span class="nc" id="L711">		String msg = localizer.i18n(bundleName, key);</span>
<span class="nc" id="L712">		throwExceptionBadRequest(msg);</span>
<span class="nc" id="L713">	}</span>

	public static void throwExceptionBadRequest(String msg) throws BusinessWFOException {
<span class="nc" id="L716">		throw new BusinessWFOException(msg, Response.Status.BAD_REQUEST);</span>
	}

	/**
	 * Throws a bad request BusinessWFOException if any message is a warning or higher.
	 */
	public static void throwExceptionIfAtleastWarningMessage(RequestContext context, List&lt;Message&gt; messages) throws BusinessWFOException {
<span class="nc" id="L723">		Localizer localizer = context.getLocalizer();</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">		for (Message message : messages) {</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">			if (message.getMessageType() &gt;= Message.WARNING_TYPE) {</span>
<span class="nc" id="L726">				throwExceptionBadRequest(message.getLocalizedMessage(localizer));</span>
			}
<span class="nc" id="L728">		}</span>
<span class="nc" id="L729">	}</span>

	public static void throwExceptionForFailedToLoadRequestWithID(RequestContext context, ID requestID) throws BusinessWFOException {
<span class="nc" id="L732">		String msg = context.getLocalizer().i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.FAILED_TO_LOAD_REQUEST_WITH_ID, requestID);</span>
<span class="nc" id="L733">		throw new BusinessWFOException(msg, Response.Status.BAD_REQUEST);</span>
	}

	public static void addPageMessages(Localizer localizer, List&lt;MessageEntity&gt; dest, List&lt;Message&gt; messages) {
<span class="nc bnc" id="L737" title="All 2 branches missed.">		for (Message message : messages) {</span>
<span class="nc" id="L738">			dest.add(new MessageEntity(message.getMessageID(),</span>
<span class="nc" id="L739">					message.getMessageArgs(),</span>
<span class="nc" id="L740">					message.getLocalizedMessage(localizer),</span>
<span class="nc" id="L741">					message.getMessageType()));</span>
<span class="nc" id="L742">		}</span>
<span class="nc" id="L743">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>