<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MyAdherencePM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.am.adherence.self</a> &gt; <span class="el_source">MyAdherencePM.java</span></div><h1>MyAdherencePM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.am.adherence.self;

import java.text.MessageFormat;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.CalendarRange;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.HtmlEncoder;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.SimpleEvent;
import com.bluepumpkin.ejb.bbm.rtaamanager.model.EmployeeData;
import com.bluepumpkin.ejb.bbm.rtaamanager.model.RTAAData;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.RTAAException;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeTrackingEvent;
import com.bluepumpkin.ejb.bbm.util.AdherenceSummaryUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.web.am.Log;
import com.bluepumpkin.web.am.adherence.AdherenceHelper;
import com.bluepumpkin.web.am.adherence.keys.AdherenceKeys;
import com.bluepumpkin.web.am.keys.AmJavaScriptFileID;
import com.bluepumpkin.web.am.l10n.AmWebBundleKey;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.jsp.HtmlButton;
import com.witness.web.uif.jsp.HtmlImage;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.BaseNodeData;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.dialog.DialogLegendPC;
import com.witness.web.uif.pagecomponent.list.DualListPC;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpanePageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;

/**
 * Title: MyAdherencePM Description: Page Model for the Agent Self Adherence
 * screen. Copyright: Copyright (c) 2008 Company: Verint Systems. Inc.
 * 
 * @author Gonzalo Quintanar
 */
public class MyAdherencePM extends WorkpanePageModel implements ContainersInRowsPM {
<span class="nc" id="L75">	private static final Category log = Log.initCategory(MyAdherencePM.class.getName());</span>

	// Field Name constants
	public static final String VIEW_DATE_FN = &quot;viewDate&quot;;

	// form field name
	public static final String REFRESH_RATE_FN = &quot;refreshRate&quot;;

	// for the current time indicator dynamic javascript text
	public static final String TIME_OF_DAY_FN = &quot;timeOfDay&quot;;

	// Refresh rate constants
	// indicates that the refresh rate was not set yet
	public static final int REFRESH_RATE_NOT_SET = -1;
	public static final int NO_AUTO_REFRESH = -2;
	public static final int DEFAULT_REFRESH_RATE = NO_AUTO_REFRESH;
	// user profile key
	public static final String REFRESH_RATE_USER_PROPERTY_KEY = &quot;UserAdherenceAutoRefresh&quot;;

	// Action constants
	public static final String FORM_ACTION = &quot;showadherence&quot;;
	// probably not needed, since we have no RH class
	public static final String CHANGE_REFRESH_RATE_ACTION = &quot;CHANGE_REFRESH_RATE_ACTION&quot;;

	// Adherence Grid Constants
	public static final int PREV_DAY_INDEX = -1;
	public static final int NEXT_DAY_INDEX = 1441;

	// Adherence Line Types
	public static final int SCHEDULEDEVENT_LINE = -1;
	public static final int ACTUALEVENT_LINE = -2;
	public static final int ADHERENCEEXCEPTION_LINE = -3;
	public static final int TRACKINGEVENT_LINE = -4;

	// Adherence Exception Colors
	public static final String COLOR_APPROVED_EXCEPTION = &quot;B7D85B&quot;;
	public static final String COLOR_UNAPPROVED_EXCEPTION = &quot;EF6D18&quot;;
	public static final String DEFAULT_EVENT_COLOR = &quot;DFEFAE&quot;;

	private static final int INDEXES_IN_HOUR = 60;

	// Column headers for the Summary Table
<span class="nc" id="L117">	private static final String[] SUMMARY_RB_KEYS = new String[] { AmWebBundleKey.MY_ADHERENCE_SUMMARY_APPROVED,</span>
			AmWebBundleKey.MY_ADHERENCE_SUMMARY_UNAPPROVED, AmWebBundleKey.MY_ADHERENCE_SUMMARY_SCHEDULED,
			AmWebBundleKey.MY_ADHERENCE_SUMMARY_EXCEPTIONS, AmWebBundleKey.MY_ADHERENCE_SUMMARY_PERCENTAGE };

	// Containers
	private ContainerList m_containerList;
	// the collapsable Summary container
<span class="nc" id="L124">	private CollapsibleContainerPC m_summaryPC = null;</span>
	// the adherence dual list (strings on the left, grid on the right)
<span class="nc" id="L126">	private MyDualListPC m_dualList = null;</span>

	// Components
<span class="nc" id="L129">	protected DialogLegendPC m_legendPC = null;</span>
	// allows the user to select the view date
	private DatePickerPC m_datePicker;

	// Data variables
	private int viewYear;
	private int viewMonth;
	private int viewDay;
<span class="nc" id="L137">	protected TimeRange m_dayRange = null; // date range for the view date (ex:</span>
											// today from 12:00 AM to 11:59 PM)
<span class="nc" id="L139">	protected StringBuffer m_sbJS = new StringBuffer(); // for accumulation of</span>
														// js data for the
														// Adherence grid
<span class="nc" id="L142">	protected MyAdherenceSummaryData m_adherenceSummaryData = new MyAdherenceSummaryData();</span>
<span class="nc" id="L143">	int m_scrollX = Integer.MIN_VALUE; // The horizontal position to scroll to</span>
										// by default when the page loads.

	// 508
	// simply the string &quot;Approved exception&quot;
<span class="nc" id="L148">	protected String m_approvedName = &quot;&quot;;</span>
	// simply the string &quot;Unapproved exception&quot;
<span class="nc" id="L150">	protected String m_unapprovedName = &quot;&quot;;</span>
	// the template to use for accessible text descriptions of events
<span class="nc" id="L152">	protected String m_textTemplate = &quot;&quot;;</span>

	// Refresh Rate variables
	// a list of refresh rate options for the drop down
<span class="nc" id="L156">	private ArrayList m_refreshRateList = null;</span>
<span class="nc" id="L157">	private int m_refreshRate = REFRESH_RATE_NOT_SET;</span>

	// Supporting variables
	private ResourceBundle m_bundle;
	private User m_user;

<span class="nc" id="L163">	private int m_minRefreshRate = 15;</span>
	// default is true, unless you override it with the bpconfig setting
<span class="nc" id="L165">	private boolean m_allowManualRefresh = true;</span>

	/**
	 * Constructor
	 */
	public MyAdherencePM(RequestContext context) {
<span class="nc" id="L171">		super(context, PageModel.BASIC_MODEL);</span>

		// Initialize member variables
<span class="nc" id="L174">		m_bundle = m_localizer.getBundle(AmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L175">		m_user = context.getUser();</span>
<span class="nc" id="L176">		m_containerList = new ContainerList(this, 3);</span>
<span class="nc" id="L177">		TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L178">		m_approvedName = i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_APPROVED_EXCEPTION);</span>
<span class="nc" id="L179">		m_unapprovedName = i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_UNAPPROVED_EXCEPTION);</span>
		// Ex:
		// &quot;Lunch: 8:15 AM - 11:45 AM. &quot;
<span class="nc" id="L182">		m_textTemplate = i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_EVENT_DESCRIPTION);</span>

		// Initialize JavaScript Files
<span class="nc" id="L185">		setJSMediator(JavaScriptFileID.MEDIATOR_WORKPANE_GENERIC);</span>
<span class="nc" id="L186">		addRequiredJavaScriptFile(AmJavaScriptFileID.GRAPH_VIEW_SUPPORT);</span>

		// Initialize the Legend dialog
<span class="nc" id="L189">		m_legendPC = new DialogLegendPC(context, m_toolbar);</span>
<span class="nc" id="L190">		addChildComponent(m_legendPC);</span>

		// Initialize the Date Picker
<span class="nc" id="L193">		m_datePicker = new DatePickerPC(context, VIEW_DATE_FN);</span>
<span class="nc" id="L194">		m_datePicker.setTimeZone(tz);</span>
<span class="nc" id="L195">		m_datePicker.setIsDayNavEnabled(true);</span>
<span class="nc" id="L196">		m_datePicker.setIsDateValueOptional(false);</span>
		// m_datePicker.setIsTodayButtonEnabled(true); //bug with different
		// timezones
<span class="nc" id="L199">		addChildComponent(m_datePicker);</span>

		// Set default date before extracting parameters from the url
<span class="nc" id="L202">		Calendar aCalendar = getCalendar();</span>
<span class="nc" id="L203">		viewYear = aCalendar.get(Calendar.YEAR);</span>
<span class="nc" id="L204">		viewMonth = aCalendar.get(Calendar.MONTH);</span>
<span class="nc" id="L205">		viewDay = aCalendar.get(Calendar.DAY_OF_MONTH);</span>
<span class="nc" id="L206">		m_dayRange = makeDayRange(new Date(), tz, false);</span>

		// Initialize the Dual List component
<span class="nc" id="L209">		m_dualList = new MyDualListPC(context);</span>
<span class="nc" id="L210">		addChildComponent(m_dualList);</span>
		// 508: The row headers are actually in the left list!
<span class="nc" id="L212">		m_dualList.getRightListPC().setHasRowHeaders(false);</span>

		// get the minimum refresh rate from BPCONFIG, and whether to allow
		// manula refresh
		try {
<span class="nc" id="L217">			String sMinRefreshRate = BbmManagerFactory.getDBConfigManager().getValue(</span>
					ConfigKey.AM_MY_ADHERENCE_MIN_REFRESH_RATE);
<span class="nc bnc" id="L219" title="All 2 branches missed.">			if (sMinRefreshRate != null) {</span>
<span class="nc" id="L220">				m_minRefreshRate = Integer.parseInt(sMinRefreshRate);</span>
			}

<span class="nc" id="L223">			String sAllowManualRefresh = BbmManagerFactory.getDBConfigManager().getValue(</span>
					ConfigKey.AM_MY_ADHERENCE_ALLOW_MANUAL_REFRESH);
<span class="nc bnc" id="L225" title="All 2 branches missed.">			if (sAllowManualRefresh != null) {</span>
<span class="nc" id="L226">				m_allowManualRefresh = (sAllowManualRefresh.equals(&quot;true&quot;));</span>
			}
<span class="nc" id="L228">		} catch (Exception ex) {</span>
<span class="nc" id="L229">			log.l7dError(</span>
					&quot;failed to fetch AM_MY_ADHERENCE_MIN_REFRESH_RATE, AM_MY_ADHERENCE_ALLOW_MANUAL_REFRESH values from DBCONFIG&quot;,
					ex);
<span class="nc" id="L232">		}</span>

<span class="nc" id="L234">	}// constructor</span>

	// /////////////////////////////////////////////////////////////////////////
	// JavaScript-related methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Return the JavaScript init code required by Page model. The output of
	 * this method is put inside the JavaScript main() function. Default
	 * behavior is to retrieve sub-component JavaScript Init code.
	 */
	public String getJavaScriptInitCode() {
<span class="nc" id="L246">		StringBuffer jsInitCode = new StringBuffer(128);</span>

		// Add sub-component JavaScript code first
<span class="nc" id="L249">		jsInitCode.append(super.getJavaScriptInitCode());</span>

		// If viewing current day, enable auto-refresh
<span class="nc bnc" id="L252" title="All 2 branches missed.">		if (getViewDate().equals(getToday())) {</span>
<span class="nc" id="L253">			String template = &quot;\nsetTimeout(\&quot;{0}.refreshPage()\&quot;,{1});\n\n&quot;;</span>

<span class="nc" id="L255">			Object[] args = new Object[] { getPageMediatorRef(), Integer.toString(getRefreshRate() * 60000)</span>

			};

<span class="nc bnc" id="L259" title="All 2 branches missed.">			if (getRefreshRate() &gt; 0)</span>
<span class="nc" id="L260">				jsInitCode.append(MessageFormat.format(template, args));</span>
		}

		// set horizontal scroll position
<span class="nc bnc" id="L264" title="All 2 branches missed.">		if (m_scrollX == Integer.MIN_VALUE)</span>
<span class="nc" id="L265">			m_scrollX = 0;</span>
<span class="nc" id="L266">		jsInitCode.append(super.getJavaScriptInitCode() + &quot;scrollIt(&quot; + m_scrollX + &quot;);\n\n&quot;);</span>

<span class="nc" id="L268">		return jsInitCode.toString();</span>
	}

	/**
	 * Return the custom JavaScript code for the Page model. The output of this
	 * method is added outside of the JavaScript main() function.
	 */
	public String getCustomJavaScript() {
<span class="nc" id="L276">		StringBuffer jsInitCode = new StringBuffer(1024);</span>
<span class="nc" id="L277">		jsInitCode.append(super.getCustomJavaScript());</span>

		// Append the customResize() function for the dual list
<span class="nc bnc" id="L280" title="All 2 branches missed.">		if (m_dualList != null)</span>
<span class="nc" id="L281">			jsInitCode.append(&quot;\nfunction customResize() {&quot; + m_dualList.getName() + &quot;.onResize(); } \n&quot;);</span>

		// Append the Adherence grid javascript buffer
<span class="nc" id="L284">		jsInitCode.append(m_sbJS.toString());</span>

<span class="nc" id="L286">		jsInitCode.append(&quot;\n\n&quot;);</span>
<span class="nc" id="L287">		jsInitCode.append(&quot;function scrollIt(posX){\n&quot;);</span>
<span class="nc" id="L288">		jsInitCode.append(&quot;DOM2.getElementById(\&quot;dualList_rPane\&quot;).scrollLeft = posX;\n&quot;);</span>
<span class="nc" id="L289">		jsInitCode.append(&quot;}\n\n&quot;);</span>

<span class="nc" id="L291">		jsInitCode.append(getJSChangeWorkspaceAriaLabel(m_localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.WORK_PANE_DESCRIPTION,</span>
<span class="nc" id="L292">			m_contentTitlePC.getPageTitle(), &quot;&quot;)));</span>

<span class="nc" id="L294">		return jsInitCode.toString();</span>
	}

	/**
	 * initialize generated JS data objects
	 */
	protected void startGenerateJSData() {
<span class="nc" id="L301">		m_sbJS.append(&quot;\n\n// Graph View Data \n function afterMain(){\n var calendarGrid = new CalendarGrid();&quot;);</span>
<span class="nc" id="L302">	}</span>

	/**
	 * initialize generated JS data objects
	 */
	protected void finishGenerateJSData() {
<span class="nc" id="L308">		m_sbJS.append(&quot;\n calendarGrid.writeGrid();\n }\n&quot;);</span>
<span class="nc" id="L309">	}</span>

	// /////////////////////////////////////////////////////////////////////////
	// Other common PageModel methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L319">		return getInstance(context, MyAdherencePM.class);</span>
	}// getInstance

	/**
	 * Initialize Model with Data
	 */
	protected void initializeModel() {
<span class="nc bnc" id="L326" title="All 2 branches missed.">		if (m_isInitialized)</span>
<span class="nc" id="L327">			return;</span>
		else
<span class="nc" id="L329">			m_isInitialized = true;</span>

		try {
			// --- check if valid employee
<span class="nc bnc" id="L333" title="All 2 branches missed.">			if (m_user.getEmployeeID() == null)</span>
<span class="nc" id="L334">				addPageMessage(Message.INFO_TYPE, BbmWebBundleKey.NO_PERSON_INFO, BbmWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L336">			ArrayList employeeIDs = new ArrayList(1);</span>
<span class="nc" id="L337">			HashMap theData = null;</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">			if (m_user.getEmployeeID() != null) {</span>
<span class="nc" id="L339">				employeeIDs.add(m_user.getEmployeeID());</span>

<span class="nc" id="L341">				CalendarRange aDay = makeDayRange(m_dayRange.getStartDate(), m_context.getViewingTimeZone(), true);</span>
<span class="nc" id="L342">				theData = MyAdherenceMH</span>
<span class="nc" id="L343">						.getAdherenceData(m_context, employeeIDs, aDay.getStartDate(), aDay.getEndDate());</span>
			}

<span class="nc" id="L346">			populateAdherenceList(theData);</span>

<span class="nc bnc" id="L348" title="All 2 branches missed.">			if (m_user.getEmployeeID() != null) {</span>
<span class="nc" id="L349">				initRefreshRateComponent();</span>
<span class="nc" id="L350">				populateSummary();</span>
<span class="nc" id="L351">				initLegend();</span>
			}
<span class="nc" id="L353">		} catch (Exception ex) {</span>
<span class="nc" id="L354">			handleUnableToLoadDataError(log, ex);</span>
			// msg.setAssociatedMessage(ex.getLocalizedMessage(m_localizer,
			// m_context.getViewingTimeZone()));
		} finally {
<span class="nc" id="L358">			initToolbar();</span>
<span class="nc" id="L359">			initContentTitle();</span>
<span class="nc" id="L360">		}</span>
<span class="nc" id="L361">	}// populateModel</span>

	/**
	 * Initialize Component For Display
	 */
	public void initForDisplay() {
<span class="nc bnc" id="L367" title="All 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L368">			return;</span>
		} else {
<span class="nc" id="L370">			super.initForDisplay();</span>
<span class="nc" id="L371">			getUtilityPane().setIsRefreshEnabled(m_allowManualRefresh);</span>
		}
<span class="nc" id="L373">	}</span>

	/**
	 * The output of this method is added to the end of the HTML output, before
	 * the &lt;/form&gt; tag. You can use it for placing hidden variables in the HTML.
	 */
	public String getRequiredHTML() {
		// We need to add the refresh rate to the session to maintail selected
		// value when the entire page is reloaded.
<span class="nc" id="L382">		m_context.setAttribute(RequestContext.SESSION_SCOPE, REFRESH_RATE_USER_PROPERTY_KEY, &quot;&quot; + m_refreshRate);</span>

		// We also add refresh rate as a hidden variable for when the page
		// reloads (so as not to access session)
<span class="nc" id="L386">		return super.getRequiredHTML() + HtmlUtil.makeHiddenInput(REFRESH_RATE_FN, m_refreshRate);</span>
	}

	/**
	 * Return List of Containers NOTE: Items in the Collection will be treated
	 * either as Page Components or just as Objects.
	 */
	public Collection getContainers() {
<span class="nc" id="L394">		return m_containerList;</span>
	}

	/**
	 * Override extract Parameters to handle date input
	 */
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L401">		boolean success = super.extractParameters(request);</span>

		// Extract Date
		try {
<span class="nc" id="L405">			TimeZone tz = m_context.getViewingTimeZone();</span>

			// Get the extracted date from the date component. If null, then get
			// from session.
			// If still null, then just use the current day.
<span class="nc" id="L410">			Date viewDate = m_datePicker.getDate();</span>
<span class="nc" id="L411">			TimeRange timeRange = null;</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">			if (viewDate == null) {</span>
<span class="nc" id="L413">				timeRange = (TimeRange) m_context.getAttribute(RequestContext.SESSION_SCOPE,</span>
						UserPreferenceKeys.USER_SCHEDULE_VIEW_DAY);
<span class="nc bnc" id="L415" title="All 2 branches missed.">				if (timeRange != null) {</span>
<span class="nc" id="L416">					m_dayRange = timeRange;</span>
<span class="nc" id="L417">					viewDate = timeRange.getStartDate();</span>
				}
			}

<span class="nc bnc" id="L421" title="All 2 branches missed.">			if (viewDate != null) {</span>
<span class="nc" id="L422">				Calendar cal = Calendar.getInstance(tz);</span>
<span class="nc" id="L423">				cal.setTime(viewDate);</span>
<span class="nc" id="L424">				viewYear = cal.get(Calendar.YEAR);</span>
<span class="nc" id="L425">				viewMonth = cal.get(Calendar.MONTH);</span>
<span class="nc" id="L426">				viewDay = cal.get(Calendar.DAY_OF_MONTH);</span>

<span class="nc" id="L428">				m_dayRange = makeDayRange(viewDate, tz, false);</span>

				// Share the view date with the schedule view pages

<span class="nc" id="L432">				m_context.setAttribute(RequestContext.SESSION_SCOPE, UserPreferenceKeys.USER_SCHEDULE_VIEW_DAY,</span>
						m_dayRange);
			}
<span class="nc" id="L435">		} catch (Exception ex) {</span>
<span class="nc" id="L436">			log.setResourceBundle(m_common_bundle);</span>
<span class="nc" id="L437">			log.l7dError(UIFWebBundleKey.EXTRACT_PARAM_FAILED, ex);</span>
<span class="nc" id="L438">		}</span>
<span class="nc" id="L439">		return success;</span>
	}

	// /////////////////////////////////////////////////////////////////////////
	// Setters which are automatically called by super.extractParameters()
	// /////////////////////////////////////////////////////////////////////////

	public void setRefreshRate(int rate) {
<span class="nc" id="L447">		m_refreshRate = rate;</span>
<span class="nc" id="L448">	}</span>

	// /////////////////////////////////////////////////////////////////////////
	// Other Getters and Setters
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc" id="L458">		return FORM_ACTION;</span>
	}

	public int getRefreshRate() {
<span class="nc bnc" id="L462" title="All 2 branches missed.">		if (m_refreshRate == REFRESH_RATE_NOT_SET) {</span>
			// If rate is not set, then try getting it from session. If not in
			// session, then try getting
			// it from the user profile. If not in profile, then just use the
			// default refresh rate.
<span class="nc" id="L467">			String sRate = (String) m_context</span>
<span class="nc" id="L468">					.getAttribute(RequestContext.SESSION_SCOPE, REFRESH_RATE_USER_PROPERTY_KEY);</span>
<span class="nc" id="L469">			boolean isFromProfile = false;</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">			if (sRate == null) {</span>
<span class="nc" id="L471">				sRate = m_context.getUserProperty(REFRESH_RATE_USER_PROPERTY_KEY);</span>
<span class="nc" id="L472">				isFromProfile = true;</span>
			}

<span class="nc bnc" id="L475" title="All 2 branches missed.">			if (!StringUtil.isEmpty(sRate)) {</span>
				try {
<span class="nc" id="L477">					int rate = Integer.parseInt(sRate);</span>
<span class="nc bnc" id="L478" title="All 4 branches missed.">					if ((rate &gt; 0) &amp;&amp; (isFromProfile))</span>
<span class="nc" id="L479">						rate /= 60;</span>
<span class="nc" id="L480">					m_refreshRate = getClosestValidRefreshRate(rate);</span>
<span class="nc" id="L481">				} catch (NumberFormatException e) {</span>
<span class="nc" id="L482">					m_refreshRate = DEFAULT_REFRESH_RATE;</span>
<span class="nc" id="L483">				}</span>
			} else {
<span class="nc" id="L485">				m_refreshRate = DEFAULT_REFRESH_RATE;</span>
			}
		}
<span class="nc" id="L488">		return m_refreshRate;</span>
	}

	// /////////////////////////////////////////////////////////////////////////
	// Date-related Methods
	// /////////////////////////////////////////////////////////////////////////

	protected Calendar getCalendar() {
		// must add time zone
<span class="nc" id="L497">		return Calendar.getInstance(m_context.getViewingTimeZone());</span>
	}

	public Date getToday() {
<span class="nc" id="L501">		Calendar calendar = getCalendar();</span>
<span class="nc" id="L502">		calendar.set(calendar.get(Calendar.YEAR), calendar.get(Calendar.MONTH), calendar.get(Calendar.DAY_OF_MONTH), 0,</span>
				0, 0);
<span class="nc" id="L504">		return calendar.getTime();</span>
	}

	public Date getViewDate() {
<span class="nc" id="L508">		Calendar calendar = getCalendar();</span>
<span class="nc" id="L509">		calendar.set(viewYear, viewMonth, viewDay, 0, 0, 0);</span>
<span class="nc" id="L510">		return calendar.getTime();</span>
	}

	/**
	 * Implemented our own makeDayRange() instead of using DateTimeUtil, because
	 * we need to include 12:00 AM of the next day. This will make our duration
	 * calculations work as expected (endtime - starttime).
	 * 
	 * @param dateInside
	 *            A date inside of the day that you want to get.
	 * @param tz
	 *            The timezone to use for generating the date range for the day.
	 * @param includeNextDayStart
	 *            : If you want to include midnight of the next day, pass true.
	 * @return A CalendarRange containing the start and end dates for a day.
	 */
	public static CalendarRange makeDayRange(Date dateInside, TimeZone tz, boolean includeNextDayStart) {
<span class="nc bnc" id="L527" title="All 4 branches missed.">		if (dateInside == null || tz == null) {</span>
<span class="nc" id="L528">			throw new IllegalArgumentException();</span>
		}
<span class="nc" id="L530">		Calendar aCal = Calendar.getInstance(tz);</span>
<span class="nc" id="L531">		aCal.setTime(dateInside);</span>
<span class="nc" id="L532">		Calendar startCal = getDayStart(aCal);</span>
<span class="nc" id="L533">		Calendar endCal = getDayEnd(aCal, includeNextDayStart);</span>
<span class="nc" id="L534">		return new CalendarRange(startCal.getTime(), endCal.getTime(), tz);</span>
	}// makeDayRange

	/**
	 * return the beginning of the day Calendar for the given Calendar
	 * 
	 * @param  aCal
	 * @return Calendar dayStart
	 */
	public static Calendar getDayStart(Calendar aCal) {
<span class="nc" id="L544">		Calendar dayStart = (Calendar) aCal.clone();</span>
<span class="nc" id="L545">		AdherenceSummaryUtil.adjustToDayStart(dayStart);</span>
<span class="nc" id="L546">		return dayStart;</span>
	}// getDayStart

	/**
	 * return the end of the day Calendar for the given Calendar consider day
	 * end being 1 msec before the next midnight
	 * 
	 * @param aCal
	 * @param includeNextDayStart
	 *            : If you want to include midnight of the next day, pass true.
	 * @return Calendar dayStart
	 */
	public static Calendar getDayEnd(Calendar aCal, boolean includeNextDayStart) {
<span class="nc" id="L559">		Calendar dayEnd = (Calendar) aCal.clone();</span>
<span class="nc" id="L560">		AdherenceSummaryUtil.adjustToDayEnd(dayEnd, includeNextDayStart);</span>
<span class="nc" id="L561">		return dayEnd;</span>
	}// getDayEnd

	// /////////////////////////////////////////////////////////////////////////
	// Refresh Rate methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Initialize the refresh rate component
	 */
	private void initRefreshRateComponent() {
<span class="nc" id="L572">		m_refreshRateList = new ArrayList(7);</span>
<span class="nc" id="L573">		String minutes = i18n(m_bundle, AmWebBundleKey.ADHERENCE_MINUTES);</span>
<span class="nc" id="L574">		String noAutoRefresh = i18n(m_bundle, AmWebBundleKey.ADHERENCE_NO_REFRESH);</span>
<span class="nc" id="L575">		m_refreshRateList.add(new StringsPair(&quot;&quot; + NO_AUTO_REFRESH, noAutoRefresh));</span>

<span class="nc bnc" id="L577" title="All 2 branches missed.">		if (m_minRefreshRate &lt;= 5) {</span>
<span class="nc" id="L578">			m_refreshRateList.add(new StringsPair(&quot;5&quot;, &quot;5 &quot; + minutes));</span>
		}

<span class="nc bnc" id="L581" title="All 2 branches missed.">		if (m_minRefreshRate &lt;= 10) {</span>
<span class="nc" id="L582">			m_refreshRateList.add(new StringsPair(&quot;10&quot;, &quot;10 &quot; + minutes));</span>
		}

<span class="nc bnc" id="L585" title="All 2 branches missed.">		if (m_minRefreshRate &lt;= 15) {</span>
<span class="nc" id="L586">			m_refreshRateList.add(new StringsPair(&quot;15&quot;, &quot;15 &quot; + minutes));</span>
		}

<span class="nc bnc" id="L589" title="All 2 branches missed.">		if (m_minRefreshRate &lt;= 30) {</span>
<span class="nc" id="L590">			m_refreshRateList.add(new StringsPair(&quot;30&quot;, &quot;30 &quot; + minutes));</span>
		}

<span class="nc bnc" id="L593" title="All 2 branches missed.">		if (m_minRefreshRate &lt;= 45) {</span>
<span class="nc" id="L594">			m_refreshRateList.add(new StringsPair(&quot;45&quot;, &quot;45 &quot; + minutes));</span>
		}

<span class="nc bnc" id="L597" title="All 2 branches missed.">		if (m_minRefreshRate &lt;= 60) {</span>
<span class="nc" id="L598">			m_refreshRateList.add(new StringsPair(&quot;60&quot;, &quot;60 &quot; + minutes));</span>
		}
<span class="nc" id="L600">	}</span>

	/**
	 * Given an integer, find the closest refresh rate that we support
	 * 
	 * @param rate
	 *            The desired refresh rate (in minutes)
	 * @return the closest supported refresh rate (in minutes)
	 */
	private int getClosestValidRefreshRate(int rate) {
<span class="nc bnc" id="L610" title="All 2 branches missed.">		if (rate &lt; 0) {</span>
<span class="nc" id="L611">			rate = NO_AUTO_REFRESH;</span>
<span class="nc bnc" id="L612" title="All 4 branches missed.">		} else if (rate &lt;= 5 &amp;&amp; m_minRefreshRate &lt;= 5) {</span>
<span class="nc" id="L613">			rate = 5;</span>
<span class="nc bnc" id="L614" title="All 4 branches missed.">		} else if (rate &lt;= 10 &amp;&amp; m_minRefreshRate &lt;= 10) {</span>
<span class="nc" id="L615">			rate = 10;</span>
<span class="nc bnc" id="L616" title="All 4 branches missed.">		} else if (rate &lt;= 15 &amp;&amp; m_minRefreshRate &lt;= 15) {</span>
<span class="nc" id="L617">			rate = 15;</span>
<span class="nc bnc" id="L618" title="All 4 branches missed.">		} else if (rate &lt;= 30 &amp;&amp; m_minRefreshRate &lt;= 30) {</span>
<span class="nc" id="L619">			rate = 30;</span>
<span class="nc bnc" id="L620" title="All 4 branches missed.">		} else if (rate &lt;= 45 &amp;&amp; m_minRefreshRate &lt;= 45) {</span>
<span class="nc" id="L621">			rate = 45;</span>
<span class="nc bnc" id="L622" title="All 4 branches missed.">		} else if (rate &gt; 45 &amp;&amp; m_minRefreshRate &lt;= 60) {</span>
<span class="nc" id="L623">			rate = 60;</span>
		} else {
<span class="nc" id="L625">			rate = NO_AUTO_REFRESH;</span>
		}

<span class="nc" id="L628">		return rate;</span>
	}

	// /////////////////////////////////////////////////////////////////////////
	// Content Title methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Initialize Content Title
	 */
	protected void initContentTitle() {
<span class="nc" id="L639">		Employee employee = null;</span>
<span class="nc" id="L640">		String nameStr = &quot;&quot;;</span>
		try {
<span class="nc" id="L642">			ID id = m_user.getEmployeeID();</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">			if (id != null) {</span>
<span class="nc" id="L644">				employee = EmployeeModelHandler.getEmployeeByID(m_context, id);</span>
<span class="nc" id="L645">				nameStr = m_localizer.formatName(employee.getPerson());</span>

				// Add the Refresh Rate Selector
<span class="nc bnc" id="L648" title="All 2 branches missed.">				if (getViewDate().equals(getToday()))</span>
<span class="nc" id="L649">					m_contentTitlePC.addActiveComponent(getRefreshRateComponentHtml());</span>

				// Add the Date Selector
<span class="nc" id="L652">				m_contentTitlePC.addActiveComponent(getDateSelectorComponentHtml());</span>
			}
<span class="nc" id="L654">		} catch (Exception ex) {</span>
<span class="nc" id="L655">		}</span>
<span class="nc" id="L656">		m_contentTitlePC.setProperties(i18n(m_bundle, AmWebBundleKey.MYTIME_ADHERENCE_PAGETITLE),</span>
<span class="nc" id="L657">				HtmlEncoder.encode(nameStr));</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()){</span>
<span class="nc" id="L659">			m_contentTitlePC.setAriaRegion(true);</span>
		}

<span class="nc" id="L662">	}// initContentTitle</span>

	// 508
	private HtmlButton getRefreshBtn(String title, String onClick) {
<span class="nc" id="L666">		HtmlImage image = new HtmlImage(ImageFileID.REFRESH_WITH_BORDER);</span>
<span class="nc" id="L667">		image.setAttribute(&quot;class&quot;, &quot;imgToolbarDefault&quot;);</span>
<span class="nc" id="L668">		image.setAttribute(&quot;style&quot;, &quot;margin:0px 0px 0px 0px;&quot;);</span>
<span class="nc" id="L669">		image.setAlt(title);</span>

<span class="nc" id="L671">		HtmlButton button = new HtmlButton(&quot;LogHstoryRefreshButton&quot;);</span>
<span class="nc" id="L672">		button.setInnerHtml(image);</span>
<span class="nc" id="L673">		button.setAttribute(&quot;class&quot;, &quot;dialogBtn&quot;);</span>

<span class="nc" id="L675">		button.setOnClick(onClick);</span>
<span class="nc" id="L676">		button.setAttribute(&quot;title&quot;, title);</span>
		
<span class="nc bnc" id="L678" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()){</span>
<span class="nc" id="L679">			button.setAttribute(&quot;aria-label&quot;, title);</span>
<span class="nc" id="L680">			button.setAttribute(&quot;aria-label-tooltip&quot;, &quot;true&quot;);</span>
		}

<span class="nc" id="L683">		return button;</span>
	}

	/**
	 * Get the HTML for the Date selector component
	 * 
	 * @return the HTML to be added to the page title section.
	 */
	private String getDateSelectorComponentHtml() {
<span class="nc" id="L692">		StringBuffer sb = new StringBuffer(256);</span>
<span class="nc" id="L693">		sb.append(HtmlUtil.TBL_OPEN_TAG</span>
				+ &quot;&lt;tr&gt;&lt;td&gt;&quot;
<span class="nc bnc" id="L695" title="All 2 branches missed.">				+ getDateSelectorUI()</span>
				+ &quot;&lt;/td&gt;&lt;td&gt;&quot;
<span class="nc" id="L697">				+ (m_allowManualRefresh ? getRefreshBtn(i18n(m_bundle, AmWebBundleKey.ADHERENCE_REFRESH_TITLE),</span>
						&quot;document.oFormMain.submit();&quot;) : &quot;&quot;) + &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);

<span class="nc" id="L700">		return sb.toString();</span>
	}

	/**
	 * Return Date Selector UI
	 */
	private String getDateSelectorUI() {
<span class="nc" id="L707">		m_datePicker.setDate(getViewDate());</span>
<span class="nc" id="L708">		m_datePicker.setOnChangeJS(&quot;document.oFormMain.submit();var refreshPage=true;&quot;);</span>
<span class="nc" id="L709">		m_datePicker.initForDisplay();</span>
<span class="nc" id="L710">		return m_datePicker.getHtmlDisplay();</span>
	}

	/**
	 * Get the HTML for the Refresh Rate component
	 * 
	 * @return the HTML to be added to the page title section.
	 */
	private String getRefreshRateComponentHtml() {
<span class="nc" id="L719">		StringBuffer onClick = new StringBuffer(64);</span>
<span class="nc" id="L720">		onClick.append(getNamePrefix()).append(getName()).append(&quot;.refreshPageWithAction('&quot;)</span>
<span class="nc" id="L721">				.append(CHANGE_REFRESH_RATE_ACTION).append(&quot;')&quot;);</span>

<span class="nc" id="L723">		String label = i18n(m_bundle, AmWebBundleKey.ADHERENCE_REFRESHRATE_TITLE);</span>
<span class="nc" id="L724">		StringBuffer sb = new StringBuffer(256);</span>
<span class="nc" id="L725">		sb.append(HtmlUtil.TBL_OPEN_TAG)</span>
<span class="nc" id="L726">				.append(&quot;&lt;tr&gt;&lt;td nowrap&gt;\n&quot;)</span>
<span class="nc" id="L727">				.append(&quot;&lt;span class=\&quot;headerText2\&quot; id=\&quot;&quot;)</span>
<span class="nc" id="L728">				.append(TIME_OF_DAY_FN)</span>
<span class="nc" id="L729">				.append(&quot;\&quot; style=\&quot;position:relative;\&quot;&gt;&lt;/span&gt;\n&quot;)</span>
<span class="nc" id="L730">				.append(&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/td&gt;\n&quot;)</span>
<span class="nc" id="L731">				.append(&quot;&lt;td nowrap&gt;&quot;)</span>
<span class="nc" id="L732">				.append(&quot;&lt;span class=\&quot;headerText2\&quot;&gt;&quot;)</span>
<span class="nc" id="L733">				.append(label)</span>
<span class="nc" id="L734">				.append(&quot;: &lt;/span&gt;&quot;);</span>

<span class="nc" id="L736">		String refreshSelector = HtmlUtil.makeSelectInput(REFRESH_RATE_FN, &quot;&quot;, new String[]{Integer.toString(getRefreshRate())},</span>
<span class="nc" id="L737">				onClick.toString(), m_refreshRateList, null, false, false,</span>
				true, false, null, null, true, label, null);
<span class="nc" id="L739">		sb.append(refreshSelector)</span>
<span class="nc" id="L740">				.append(&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/td&gt;&quot;)</span>
<span class="nc" id="L741">				.append(&quot;&lt;/tr&gt;\n&lt;/table&gt;\n&quot;);</span>

<span class="nc" id="L743">		return sb.toString();</span>
	}

	// /////////////////////////////////////////////////////////////////////////
	// Toolbar-related methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Initialize Toolbar
	 */
	protected void initToolbar() {
<span class="nc bnc" id="L754" title="All 2 branches missed.">		if (m_user.getEmployeeID() != null) {</span>
<span class="nc" id="L755">			m_toolbar.addToolbarElement(m_legendPC.getLegendButton());</span>
		}
<span class="nc" id="L757">	}// initToolbar</span>

	/**
	 * Initialize Legend
	 */
	protected void initLegend() {
<span class="nc" id="L763">		m_legendPC.setHeader(i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_LEGEND_PAGETITLE));</span>
<span class="nc" id="L764">	}// initLegend</span>

	// /////////////////////////////////////////////////////////////////////////
	// Main Adherence component methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Populate the Adherence list model m_dualList with data - prepare for
	 * rendering.
	 * 
	 * @param theData
	 *            HashMap containing all the adherence data for the user.
	 *            AdherenceKeys.ADHERENCE_DATA: the RTAA data
	 *            AdherenceKeys.TRACKING_EVENTS: the tracking events
	 *            AdherenceKeys.TRACKING_ACTIVITY_MAP: the tracking activity
	 *            mappings.
	 */
	protected void populateAdherenceList(HashMap theData) {
<span class="nc" id="L782">		ArrayList leftListModel = new ArrayList();</span>
<span class="nc" id="L783">		ArrayList rightListModel = new ArrayList();</span>
<span class="nc" id="L784">		HashMap trackingActivitiesMap = new HashMap();</span>
<span class="nc" id="L785">		HashMap activitiesMap = new HashMap();</span>

		// --- initialize generated JavaScript data objects
<span class="nc" id="L788">		startGenerateJSData();</span>

<span class="nc bnc" id="L790" title="All 2 branches missed.">		if (theData != null) {</span>
			// Get the employee adherence data
<span class="nc" id="L792">			RTAAData rtaaData = (RTAAData) theData.get(AdherenceKeys.ADHERENCE_DATA);</span>

			// Get tracking events and tracking activities (for secondary
			// activity line)
<span class="nc" id="L796">			HashMap trackingEventsMap = (HashMap) theData.get(AdherenceKeys.TRACKING_EVENTS);</span>
<span class="nc" id="L797">			ArrayList trackingEvents = (ArrayList) trackingEventsMap.get(m_user.getEmployeeID());</span>
<span class="nc" id="L798">			trackingActivitiesMap = (HashMap) theData.get(AdherenceKeys.TRACKING_ACTIVITY_MAP);</span>

			// Get activities map and parent event map
<span class="nc" id="L801">			activitiesMap = rtaaData.getActivities();</span>
			// HashMap parentEventsMap = rtaaData.getParentEventsMap();
<span class="nc" id="L803">			HashMap hmActivityMappings = rtaaData.getActivityMappings();</span>

			// Get the EmployeeData for the user. There is only one user.
<span class="nc" id="L806">			Collection colEmployeeData = rtaaData.getEmployeeData();</span>
<span class="nc" id="L807">			EmployeeData employeeData = null;</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">			for (Iterator it = colEmployeeData.iterator(); it.hasNext();)</span>
<span class="nc" id="L809">				employeeData = (EmployeeData) it.next();</span>

			// Get the event data
<span class="nc" id="L812">			Collection plannedEvents = employeeData.getPlannedEvents();</span>
<span class="nc" id="L813">			Collection actualEvents = employeeData.getActualEvents();</span>
<span class="nc" id="L814">			Collection rtaaExceptions = employeeData.getAdheranceViolations();</span>

			// Get the names for the actual line(s)
<span class="nc" id="L817">			Pair actualNames = AdherenceHelper.getActualDisplayNames(m_context);</span>
<span class="nc" id="L818">			String primaryActual = (String) actualNames.getFirst();</span>
<span class="nc" id="L819">			String secondaryActual = (String) actualNames.getSecond();</span>

			// --- first pass - calculate shown hours range ---
<span class="nc" id="L822">			int shownHours[] = getShownHours(m_dayRange.getStartDate(), m_dayRange.getEndDate());</span>

			// --- set headers -------------------
<span class="nc" id="L825">			setListHeaders(m_dayRange.getStartDate(), m_dayRange.getEndDate());</span>

<span class="nc" id="L827">			TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L828">			CalendarRange aDay = makeDayRange(m_dayRange.getStartDate(), tz, false);</span>

<span class="nc" id="L830">			int rowIndex = 0;</span>

			// //////////////////////////////////////////////////////
			// Create the Scheduled row
			// //////////////////////////////////////////////////////
			// DefaultMultiColumnNodeData rightRowData;
<span class="nc" id="L836">			String rightRowText = &quot;&quot;; // 508</span>
<span class="nc" id="L837">			String rightRowLabel = i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_SCHEDULED);</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">			if (plannedEvents != null) {</span>
<span class="nc" id="L839">				rightRowText = makeRightRow(m_sbJS, aDay, shownHours, plannedEvents, activitiesMap, true, true,</span>
						rowIndex++, true, SCHEDULEDEVENT_LINE, rightListModel, rightRowLabel);
				// rightListModel.add(rightRowData);
			} else
<span class="nc" id="L843">				rightRowText = &quot;&quot;;</span>

<span class="nc" id="L845">			DefaultMultiColumnNodeData leftRowData = makeLeftRow(rightRowLabel, rightRowText);</span>
<span class="nc" id="L846">			leftListModel.add(leftRowData);</span>

			// //////////////////////////////////////////////////////
			// Create the Primary Actual row
			// //////////////////////////////////////////////////////
<span class="nc bnc" id="L851" title="All 2 branches missed.">			if (actualEvents != null) {</span>
<span class="nc" id="L852">				rightRowText = makeRightRow(m_sbJS, aDay, shownHours, actualEvents, activitiesMap, true, true,</span>
						rowIndex++, true, ACTUALEVENT_LINE, rightListModel, primaryActual);
				// rightListModel.add(rightRowData);
			} else
<span class="nc" id="L856">				rightRowText = &quot;&quot;;</span>

<span class="nc" id="L858">			leftRowData = makeLeftRow(primaryActual, rightRowText);</span>
<span class="nc" id="L859">			leftListModel.add(leftRowData);</span>

			// //////////////////////////////////////////////////////
			// Create the Exceptions row
			// //////////////////////////////////////////////////////
<span class="nc" id="L864">			rightRowLabel = i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_EXCEPTIONS);</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">			if (rtaaExceptions != null) {</span>
<span class="nc" id="L866">				rightRowText = makeRightRow(m_sbJS, aDay, shownHours, rtaaExceptions, activitiesMap, true, true,</span>
						rowIndex++, true, ADHERENCEEXCEPTION_LINE, rightListModel, rightRowLabel);
			} else {
<span class="nc" id="L869">				rightRowText = &quot;&quot;;</span>
			}

<span class="nc" id="L872">			leftRowData = makeLeftRow(rightRowLabel, rightRowText);</span>
<span class="nc" id="L873">			leftListModel.add(leftRowData);</span>

			// //////////////////////////////////////////////////////
			// Create the Secondary Actual row
			// //////////////////////////////////////////////////////
<span class="nc bnc" id="L878" title="All 4 branches missed.">			if (secondaryActual != null &amp;&amp; m_context.getUser().isAuthorized(PrivilegeKeys.AM_VIEWTRACKINGEVENTS)) {</span>
<span class="nc" id="L879">				rightRowText = makeRightRow(m_sbJS, aDay, shownHours, trackingEvents, trackingActivitiesMap, true,</span>
						true, rowIndex++, true, TRACKINGEVENT_LINE, rightListModel, secondaryActual);

<span class="nc" id="L882">				leftRowData = makeLeftRow(secondaryActual, rightRowText);</span>
<span class="nc" id="L883">				leftListModel.add(leftRowData);</span>
			}

			// Add the Legend activities
<span class="nc" id="L887">			addLegendData(activitiesMap, trackingActivitiesMap);</span>

			// If viewing today, then Summary Table only includes data up to now
<span class="nc" id="L890">			Date now = new Date();</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">			if (m_dayRange.includes(now)) {</span>
<span class="nc" id="L892">				aDay.setEndDate(now);</span>
			} else {
<span class="nc" id="L894">				aDay = makeDayRange(m_dayRange.getStartDate(), m_context.getViewingTimeZone(), true);</span>
			}

<span class="nc" id="L897">			calculateSummaryData(aDay, plannedEvents, rtaaExceptions, hmActivityMappings);</span>
		}

		// Add the left and right list models to the dual list component
<span class="nc" id="L901">		setDualListModels(leftListModel, rightListModel);</span>

		// --- finish JS data creation
<span class="nc" id="L904">		finishGenerateJSData();</span>

<span class="nc" id="L906">		initDualListForDisplay();</span>
<span class="nc" id="L907">		m_containerList.add(m_dualList);</span>

<span class="nc" id="L909">	}// populateAdherenceList</span>

	/**
	 * Populate the legend with the activity color, name string pairs.
	 * 
	 * @param activitiesMap
	 *            Map of activityID to Activity.
	 * @param trackingActivitiesMap
	 *            Map of activityID to Activity.
	 */
	private void addLegendData(HashMap activitiesMap, HashMap trackingActivitiesMap) {
<span class="nc" id="L920">		ArrayList legendStringPairs = new ArrayList();</span>
<span class="nc bnc" id="L921" title="All 4 branches missed.">		if (activitiesMap != null &amp;&amp; activitiesMap.size() &gt; 0) {</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">			for (Iterator it = activitiesMap.values().iterator(); it.hasNext();) {</span>
<span class="nc" id="L923">				Activity activity = (Activity) it.next();</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">				if (activity.getID().toInt() != Activity.NO_ACTIVITY) {</span>
<span class="nc" id="L925">					legendStringPairs.add(new StringsPair(activity.getColor(), activity.getName()));</span>
				}
<span class="nc" id="L927">			}</span>
		}
<span class="nc bnc" id="L929" title="All 4 branches missed.">		if (trackingActivitiesMap != null &amp;&amp; trackingActivitiesMap.size() &gt; 0) {</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">			for (Iterator it = trackingActivitiesMap.values().iterator(); it.hasNext();) {</span>
<span class="nc" id="L931">				Activity activity = (Activity) it.next();</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">				if (activity.getID().toInt() != Activity.NO_ACTIVITY) {</span>
<span class="nc" id="L933">					legendStringPairs.add(new StringsPair(activity.getColor(), activity.getName()));</span>
				}
<span class="nc" id="L935">			}</span>
		}
<span class="nc" id="L937">		legendStringPairs.add(new StringsPair(COLOR_APPROVED_EXCEPTION, m_approvedName));</span>
<span class="nc" id="L938">		legendStringPairs.add(new StringsPair(COLOR_UNAPPROVED_EXCEPTION, m_unapprovedName));</span>
<span class="nc" id="L939">		m_legendPC.setItems(new ArrayList(legendStringPairs));</span>
<span class="nc" id="L940">	}</span>

	/**
	 * set list headers for the multicolumn list
	 */
	private void setListHeaders(Date start, Date end) {
<span class="nc" id="L946">		makeLeftDualLIstHeader(&quot; &quot;);</span>
<span class="nc" id="L947">		makeRightDualListHeader(start, end);</span>
<span class="nc" id="L948">	}// setListHeaders</span>

	/**
	 * make a row for the list display of the line types.
	 * 
	 * @param rowName
	 *            The name of the row to display in the left list
	 * @param labelText
	 *            The hidden label text describing the events for that row. This
	 *            hidden text will be read by screen readers for 508
	 *            accessibility compliance, since visually impaired users cannot
	 *            see the graph.
	 */
	private DefaultMultiColumnNodeData makeLeftRow(String rowName, String labelText) {
<span class="nc" id="L962">		DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L963">		rowData.add(rowName + HtmlUtil.makeHiddenReadableText(labelText), CSSUtil.STYLE_NOWRAP_NORMAL_LEFT);</span>
<span class="nc" id="L964">		rowData.setSelectable(false);</span>
<span class="nc" id="L965">		return rowData;</span>
	}// makeLeftRow

	/**
	 * Make a graphical row for the multicolumn list display of the adherence
	 * events
	 */
	private String makeRightRow(StringBuffer sbJS, TimeRange aDay, int[] shownHours, Collection events,
			HashMap activities, boolean bShowUnavailable, boolean bShowTimeoff, int rowIndex, boolean isMy,
			int lineType, ArrayList rightListModel, String leftRowLabel) {
<span class="nc" id="L975">		DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L976">		TimeZone tz = m_context.getViewingTimeZone();</span>

		// 508: Holds a textual description of the graph events
<span class="nc" id="L979">		StringBuffer sbRowText = new StringBuffer();</span>

		// --- calculate offset indexes for shown hours (index is the number of
		// minutes before)
<span class="nc" id="L983">		int firstShownIndex = shownHours[0] * 60;</span>
<span class="nc" id="L984">		int lastShownIndex = (shownHours[1] + 1) * 60 - 1;</span>
<span class="nc" id="L985">		int gridWidth = lastShownIndex - firstShownIndex + 1;</span>

		// --- make the row with one empty cell ---
<span class="nc" id="L988">		rowData.add(&quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L989">		rowData.setNodeAttribute(&quot;style&quot;, &quot;font-size:0px&quot;);</span>

		// --- generate JS object with the data for the row ---
<span class="nc" id="L992">		sbJS.append(&quot;\n calendarGrid.addRow(new GridRow(&quot;).append(rowIndex).append(&quot;,&quot;).append(gridWidth).append(&quot;));&quot;);</span>

		// for each event in the falattened schedule for this day
<span class="nc" id="L995">		int eventStartIndex = -1;</span>
<span class="nc" id="L996">		int eventEndIndex = -1;</span>
<span class="nc" id="L997">		String eventColor = &quot;&quot;;</span>
<span class="nc" id="L998">		String eventPattern = &quot;&quot;;</span>

<span class="nc bnc" id="L1000" title="All 4 branches missed.">		if (events != null &amp;&amp; !events.isEmpty()) {</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">			for (Iterator i = events.iterator(); i.hasNext();) {</span>
<span class="nc" id="L1002">				Object event = i.next();</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">				if (event != null) {</span>
<span class="nc" id="L1004">					TimeRange eventRange = new TimeRange(AdherenceSummaryUtil.getEventStartTime(event),</span>
<span class="nc" id="L1005">							AdherenceSummaryUtil.getEventEndTime(event));</span>

<span class="nc" id="L1007">					Calendar startCal = eventRange.getStartCalendar(tz, null);</span>
<span class="nc" id="L1008">					Calendar endCal = eventRange.getEndCalendar(tz, null);</span>

<span class="nc" id="L1010">					eventStartIndex = makeMinuteIndexDST(aDay, startCal, firstShownIndex, lastShownIndex);</span>
<span class="nc" id="L1011">					eventEndIndex = makeMinuteIndexDST(aDay, endCal, firstShownIndex, lastShownIndex)</span>
<span class="nc" id="L1012">							- getDSTAdjustment(eventRange, tz);</span>

<span class="nc bnc" id="L1014" title="All 2 branches missed.">					if (eventEndIndex &gt; gridWidth) {</span>
<span class="nc" id="L1015">						eventEndIndex = gridWidth;</span>
					}

<span class="nc bnc" id="L1018" title="All 4 branches missed.">					if (eventStartIndex != NEXT_DAY_INDEX &amp;&amp; eventEndIndex != PREV_DAY_INDEX) {</span>
						// event overlaps with the shown hrs
<span class="nc" id="L1020">						eventColor = getEventActivityColor(event, activities, lineType);</span>
<span class="nc" id="L1021">						eventPattern = &quot;null&quot;;</span>
<span class="nc" id="L1022">						String sActivityName = getEventActivityName(event, activities, lineType);</span>

<span class="nc bnc" id="L1024" title="All 2 branches missed.">						if (eventColor.length() &gt; 0) {</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">							if (m_scrollX == Integer.MIN_VALUE) {</span>
								// first time it is being set
<span class="nc" id="L1027">								m_scrollX = eventStartIndex;</span>
							} else {
<span class="nc" id="L1029">								m_scrollX = Math.min(m_scrollX, eventStartIndex);</span>
							}
						}

						// get the the text string which will be read read to
						// blind users
<span class="nc" id="L1035">						String activityStr = &quot;&quot;;</span>
<span class="nc bnc" id="L1036" title="All 4 branches missed.">						if (sActivityName != null &amp;&amp; sActivityName.length() &gt; 0) {</span>
<span class="nc" id="L1037">							String sStartTime = m_localizer.formatDate(startCal.getTime(), tz,</span>
									RegionalFormatBundleKey.TIME_FORMAT);
<span class="nc" id="L1039">							String sEndTime = m_localizer.formatDate(endCal.getTime(), tz,</span>
									RegionalFormatBundleKey.TIME_FORMAT);
<span class="nc" id="L1041">							Object[] args = new Object[] { sActivityName, sStartTime, sEndTime };</span>
<span class="nc" id="L1042">							activityStr = MessageFormat.format(m_textTemplate, args);</span>
<span class="nc" id="L1043">							sbRowText.append(activityStr);</span>
<span class="nc" id="L1044">							activityStr = leftRowLabel + &quot;, &quot; + activityStr;</span>
						}

						// create JS ScheduleEvent object and add it to
						// calendarGrid.rows[rowIndex]
<span class="nc" id="L1049">						sbJS.append(&quot;\n calendarGrid.rows[&quot;).append(rowIndex).append(&quot;].addEvent(&quot;)</span>
<span class="nc" id="L1050">							.append(eventStartIndex).append(&quot;,&quot;).append(eventEndIndex).append(&quot;,\&quot;&quot;)</span>
<span class="nc" id="L1051">							.append(eventColor).append(&quot;\&quot;,\&quot;&quot;).append(eventPattern).append(&quot;\&quot;,\&quot;&quot;)</span>
<span class="nc" id="L1052">							.append(activityStr).append(&quot;\&quot;)&quot;);</span>
					}
				}
<span class="nc" id="L1055">			}</span>
		} else {
			// just insert a blank row so that the empty cells are shown
<span class="nc" id="L1058">			sbJS.append(&quot;\n calendarGrid.rows[&quot;).append(rowIndex).append(&quot;].addEvent(&quot;).append(0).append(&quot;,&quot;)</span>
<span class="nc" id="L1059">					.append(1439).append(&quot;,\&quot;&quot;).append(&quot;&quot;).append(&quot;\&quot;,\&quot;&quot;).append(&quot;null&quot;).append(&quot;\&quot;)&quot;);</span>
		}

<span class="nc" id="L1062">		rowData.setSelectable(false);</span>
<span class="nc" id="L1063">		rightListModel.add(rowData);</span>

<span class="nc" id="L1065">		return sbRowText.toString();</span>
	}// makeRightRow

	/**
	 * Calculate the columns of data for the Summary Table, and store the data
	 * in m_adherenceSummaryData.
	 * 
	 * @param hmActivityMappings
	 *            - the activity mappings for all activities for the data.
	 */
	private void calculateSummaryData(CalendarRange aDay, Collection plannedEvents, Collection rtaaExceptions,
			HashMap hmActivityMappings) {
<span class="nc" id="L1077">		int[] durations = AdherenceSummaryUtil.calculateDaySummaryData(aDay, plannedEvents, rtaaExceptions,</span>
				hmActivityMappings);

<span class="nc" id="L1080">		int approved = durations[0];</span>
<span class="nc" id="L1081">		int unapproved = durations[1];</span>
<span class="nc" id="L1082">		int scheduled = durations[2];</span>
<span class="nc" id="L1083">		int exceptions = durations[3];</span>
<span class="nc" id="L1084">		float percentage = AdherenceSummaryUtil.getPercentage(scheduled, exceptions);</span>

<span class="nc" id="L1086">		m_adherenceSummaryData.setApproved(approved);</span>
<span class="nc" id="L1087">		m_adherenceSummaryData.setUnapproved(unapproved);</span>
<span class="nc" id="L1088">		m_adherenceSummaryData.setScheduled(scheduled);</span>
<span class="nc" id="L1089">		m_adherenceSummaryData.setExceptions(exceptions);</span>
<span class="nc" id="L1090">		m_adherenceSummaryData.setPercentage(percentage);</span>
<span class="nc" id="L1091">	}</span>

	/**
	 * get Event Activity Color
	 * 
	 * @param obj
	 *            - An object of type SimpleEvent, RTAAEXCeption, or
	 *            TimeTrackingEvent.
	 * @param activities
	 *            HashMap mapping activity ID's to Activity objects.
	 * @return String color or empty string if not found
	 */
	public String getEventActivityColor(Object obj, HashMap activities, int lineType) {
<span class="nc" id="L1104">		String color = &quot;&quot;;</span>
<span class="nc bnc" id="L1105" title="All 4 branches missed.">		if (obj != null &amp;&amp; activities != null) {</span>
<span class="nc bnc" id="L1106" title="All 4 branches missed.">			if (lineType == SCHEDULEDEVENT_LINE || lineType == ACTUALEVENT_LINE) {</span>
<span class="nc" id="L1107">				ID activityID = ((SimpleEvent) obj).getActivityID();</span>
<span class="nc" id="L1108">				Activity activity = (Activity) activities.get(activityID);</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">				if (activity != null) {</span>
<span class="nc" id="L1110">					color = activity.getColor();</span>
				}
<span class="nc bnc" id="L1112" title="All 2 branches missed.">			} else if (lineType == ADHERENCEEXCEPTION_LINE) {</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">				if (!((RTAAException) obj).isDeleted()) {</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">					if (((RTAAException) obj).isApproved()) {</span>
<span class="nc" id="L1115">						color = COLOR_APPROVED_EXCEPTION;</span>
					} else {
<span class="nc" id="L1117">						color = COLOR_UNAPPROVED_EXCEPTION;</span>
					}
				}
<span class="nc bnc" id="L1120" title="All 2 branches missed.">			} else if (lineType == TRACKINGEVENT_LINE) {</span>
<span class="nc" id="L1121">				ID activityID = ((TimeTrackingEvent) obj).getActivityID();</span>
<span class="nc" id="L1122">				Activity activity = (Activity) activities.get(activityID);</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">				if (activity != null) {</span>
<span class="nc" id="L1124">					color = activity.getColor();</span>
				}
			}
		}
<span class="nc" id="L1128">		return color;</span>
	}// getEventActivityColor

	/**
	 * get Event Activity name
	 * 
	 * @param obj
	 *            - An object of type SimpleEvent, RTAAEXCeption, or
	 *            TimeTrackingEvent.
	 * @param activities
	 *            HashMap mapping activity ID's to Activity objects.
	 * @return Name of the activity or empty string if not found.
	 */
	public String getEventActivityName(Object obj, HashMap activities, int lineType) {
<span class="nc" id="L1142">		String name = &quot;&quot;;</span>
<span class="nc bnc" id="L1143" title="All 4 branches missed.">		if (obj != null &amp;&amp; activities != null) {</span>
<span class="nc bnc" id="L1144" title="All 4 branches missed.">			if (lineType == SCHEDULEDEVENT_LINE || lineType == ACTUALEVENT_LINE) {</span>
<span class="nc" id="L1145">				ID activityID = ((SimpleEvent) obj).getActivityID();</span>
<span class="nc" id="L1146">				Activity activity = (Activity) activities.get(activityID);</span>
<span class="nc bnc" id="L1147" title="All 2 branches missed.">				if (activity != null) {</span>
<span class="nc" id="L1148">					name = activity.getName();</span>
				}
<span class="nc bnc" id="L1150" title="All 2 branches missed.">			} else if (lineType == ADHERENCEEXCEPTION_LINE) {</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">				if (!((RTAAException) obj).isDeleted()) {</span>
<span class="nc bnc" id="L1152" title="All 2 branches missed.">					if (((RTAAException) obj).isApproved()) {</span>
<span class="nc" id="L1153">						name = m_approvedName;</span>
					} else {
<span class="nc" id="L1155">						name = m_unapprovedName;</span>
					}
				}
<span class="nc bnc" id="L1158" title="All 2 branches missed.">			} else if (lineType == TRACKINGEVENT_LINE) {</span>
<span class="nc" id="L1159">				ID activityID = ((TimeTrackingEvent) obj).getActivityID();</span>
<span class="nc" id="L1160">				Activity activity = (Activity) activities.get(activityID);</span>
<span class="nc bnc" id="L1161" title="All 2 branches missed.">				if (activity != null) {</span>
<span class="nc" id="L1162">					name = activity.getName();</span>
				}
			}
		}
<span class="nc" id="L1166">		return name;</span>
	}// getEventActivityColor

	/**
	 * calculate the index in minutes of the Calendar value from the shown index
	 * in the given day
	 * 
	 * @param theDay
	 *            - the given day
	 * @param theCal
	 *            - the time value
	 * @param firstShownIndex
	 *            - limitation by the grid boundaries
	 * @param lastShownIndex
	 *            - limitation by the grid boundaries
	 * @return int index - offset in minutes of theCal from the firstShownIndex
	 *         or -1 if theCal is before the shown hours and 1441 if after shown
	 *         hours
	 */
	public int makeMinuteIndex(TimeRange theDay, Calendar theCal, int firstShownIndex, int lastShownIndex) {
<span class="nc" id="L1186">		int relLocOfTheCal = theDay.getRelativeLocation(theCal);</span>
<span class="nc bnc" id="L1187" title="All 2 branches missed.">		if (relLocOfTheCal == TimeRange.TIME_BEFORE) {</span>
<span class="nc" id="L1188">			return PREV_DAY_INDEX;</span>
<span class="nc bnc" id="L1189" title="All 2 branches missed.">		} else if (relLocOfTheCal == TimeRange.TIME_AFTER) {</span>
<span class="nc" id="L1190">			return NEXT_DAY_INDEX;</span>
		} else {
<span class="nc" id="L1192">			int minutesFromDayStart = theCal.get(Calendar.HOUR_OF_DAY) * 60 + theCal.get(Calendar.MINUTE);</span>
<span class="nc bnc" id="L1193" title="All 2 branches missed.">			if (minutesFromDayStart &lt; firstShownIndex) {</span>
<span class="nc" id="L1194">				return PREV_DAY_INDEX;</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">			} else if (minutesFromDayStart &gt; lastShownIndex) {</span>
<span class="nc" id="L1196">				return NEXT_DAY_INDEX;</span>
			} else {
<span class="nc" id="L1198">				return minutesFromDayStart - firstShownIndex;</span>
			}
		}
	}// makeMinuteIndex

	/**
	 * Calculate the DST-adjusted index in minutes of the Calendar value from
	 * the shown index in the given day. Just like makeMinuteIndex(), except we
	 * consider if the day is the Fall DST transition day. If so, and an event
	 * starts or ends in the 2'nd 1AM hour, we change the start/end index to the
	 * next hour (2 AM), so that we do not end up with an end index which is
	 * less than the start index.
	 * 
	 * @param theDay
	 *            - the given day
	 * @param theCal
	 *            - the time value
	 * @param firstShownIndex
	 *            - limitation by the grid boundaries
	 * @param lastShownIndex
	 *            - limitation by the grid boundaries
	 * @return int index - offset in minutes of theCal from the firstShownIndex
	 *         or -1 if theCal is before the shown hours and 1441 if after shown
	 *         hours
	 */
	public int makeMinuteIndexDST(TimeRange theDay, Calendar theCal, int firstShownIndex, int lastShownIndex) {
<span class="nc" id="L1224">		int minuteIndexTemp = -1;</span>
<span class="nc" id="L1225">		int minuteIndex = makeMinuteIndex(theDay, theCal, firstShownIndex, lastShownIndex);</span>

		// If event starts in the hidden DST hour (ex: the 2'nd 1 AM in PST),
		// make it start at next hour (ex: 2AM)
<span class="nc" id="L1229">		Calendar calClone = (Calendar) theCal.clone();</span>
<span class="nc" id="L1230">		calClone.add(Calendar.HOUR_OF_DAY, -1);</span>
<span class="nc" id="L1231">		minuteIndexTemp = makeMinuteIndex(theDay, calClone, firstShownIndex, lastShownIndex);</span>

<span class="nc bnc" id="L1233" title="All 2 branches missed.">		if (minuteIndex == minuteIndexTemp) {</span>
<span class="nc" id="L1234">			minuteIndex = ((minuteIndex / 60) + 1) * 60;</span>
		}

<span class="nc" id="L1237">		return minuteIndex;</span>
	}

	/**
	 * Returns the adjustment for indexes in case when the event crosses a dst transition.
	 *
	 * For Spring DST we need to subtract 60 while for Fall DST we need to add 60 to account for missing or
	 * extra hour.
	 * @return adjustment amount either -ve or +ve based dst transition
	 */
	public int getDSTAdjustment(TimeRange range, TimeZone tz) {
<span class="nc" id="L1248">		boolean isStartTimeInDST = ZoneId.of(tz.getID()).getRules().isDaylightSavings(range.getStartDate().toInstant());</span>
<span class="nc" id="L1249">		boolean isEndTimeInDST = ZoneId.of(tz.getID()).getRules().isDaylightSavings(range.getEndDate().toInstant());</span>
<span class="nc bnc" id="L1250" title="All 8 branches missed.">		if ((isStartTimeInDST &amp;&amp; !isEndTimeInDST) || (!isStartTimeInDST &amp;&amp; isEndTimeInDST)) {</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">			return isStartTimeInDST ? -INDEXES_IN_HOUR : INDEXES_IN_HOUR;</span>
		}
<span class="nc" id="L1253">		return 0;</span>
	}

	// /////////////////////////////////////////////////////////////////////////
	// Summary Component methods
	// /////////////////////////////////////////////////////////////////////////

	/**
	 * Populate Summary page component
	 */
	private void populateSummary() {
		try {
<span class="nc" id="L1265">			m_summaryPC = createContainerPC(&quot;SummaryContainer&quot;);</span>
<span class="nc bnc" id="L1266" title="All 2 branches missed.">			if (getViewDate().equals(getToday())) {</span>
<span class="nc" id="L1267">				m_summaryPC.setTitle(i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_SUMMARY_SUMMARY_TODAY));</span>
			} else {
<span class="nc" id="L1269">				m_summaryPC.setTitle(i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_SUMMARY_SUMMARY));</span>
			}

<span class="nc" id="L1272">			MultiColListPC theListPC = initContianerAndCreateList(m_context, m_summaryPC);</span>
<span class="nc bnc" id="L1273" title="All 2 branches missed.">			if (getViewDate().equals(getToday())) {</span>
<span class="nc" id="L1274">				theListPC.setTableAttribute(&quot;summary&quot;,</span>
<span class="nc" id="L1275">						i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_SUMMARY_TODAY_TABLE_SUMMARY));</span>
			} else {
<span class="nc" id="L1277">				theListPC.setTableAttribute(&quot;summary&quot;,</span>
<span class="nc" id="L1278">						i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_SUMMARY_TABLE_SUMMARY));</span>
			}
<span class="nc" id="L1280">			initHeader(theListPC, SUMMARY_RB_KEYS);</span>

<span class="nc" id="L1282">			createSummaryListModel(theListPC, m_adherenceSummaryData);</span>
<span class="nc" id="L1283">		} catch (Exception ex) {</span>
<span class="nc" id="L1284">			handlePopulateContainerError(AmWebBundleKey.MSG_MY_ADHERENCE_SUMMARY_NO_SUMMARY, ex);</span>
<span class="nc" id="L1285">		}</span>
<span class="nc" id="L1286">	}// populateSummary</span>

	/**
	 * Create a CollapsibleContainerPC.
	 * 
	 * @param name
	 *            the name of the component.
	 * @return the new component.
	 */
	private final CollapsibleContainerPC createContainerPC(String name) {
<span class="nc" id="L1296">		CollapsibleContainerPC containerPC = new CollapsibleContainerPC(m_context);</span>
<span class="nc" id="L1297">		containerPC.setName(name);</span>
<span class="nc" id="L1298">		m_containerList.add(containerPC);</span>
<span class="nc" id="L1299">		return containerPC;</span>
	}

	/**
	 * Initialize the header of a MultiColListPC.
	 * 
	 * @param theListPC
	 *            the MultiColListPC to initialize.
	 * @param rbKeys
	 *            The names of the columns for the MultiColListPC.
	 */
	private void initHeader(MultiColListPC theListPC, String[] rbKeys) {
<span class="nc" id="L1311">		TableHeaderPC header = theListPC.getHeader();</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">		for (int i = 0; i &lt; rbKeys.length; i++) {</span>
<span class="nc" id="L1313">			String label = i18n(m_bundle, rbKeys[i]);</span>
<span class="nc" id="L1314">			header.addColumnHeaderData(null, label, CSSUtil.CLASS_INNER_HEADER_BORDER_NUMERIC);</span>
		}
<span class="nc" id="L1316">	}</span>

	/**
	 * Set Summary List model
	 */
	private void createSummaryListModel(MultiColListPC theListPC, MyAdherenceSummaryData summaryData) {
<span class="nc bnc" id="L1322" title="All 2 branches missed.">		if (summaryData == null) {</span>
<span class="nc" id="L1323">			return;</span>
		}

		// Create the list model
<span class="nc" id="L1327">		ArrayList listModel = new ArrayList(1);</span>
<span class="nc" id="L1328">		DefaultMultiColumnNodeData row_data = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L1329">		addDurationData(summaryData.getApproved(), row_data);</span>
<span class="nc" id="L1330">		addDurationData(summaryData.getUnapproved(), row_data);</span>
<span class="nc" id="L1331">		addDurationData(summaryData.getScheduled(), row_data);</span>
<span class="nc" id="L1332">		addDurationData(summaryData.getExcpetions(), row_data);</span>
<span class="nc" id="L1333">		addPercentData(summaryData.getPercentage(), summaryData.getScheduled(), row_data);</span>

<span class="nc" id="L1335">		listModel.add(row_data);</span>
<span class="nc" id="L1336">		theListPC.setListModel(listModel);</span>
<span class="nc" id="L1337">	}</span>

	private final MultiColListPC initContianerAndCreateList(RequestContext context, CollapsibleContainerPC parentPC) {
		// List for Display purpose
<span class="nc" id="L1341">		MultiColListPC theListPC = new MultiColListPC(context, false){</span>
			@Override
			protected boolean skipEncloseForKeyboardAccess(BaseNodeData nodeData) {
<span class="nc bnc" id="L1344" title="All 4 branches missed.">				return !this.isKeyboardAccessible() || !nodeData.isSelectable();</span>
			}
		};

<span class="nc" id="L1348">		theListPC.setEnabled(false);</span>

<span class="nc bnc" id="L1350" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L1351">			theListPC.setWrapperRegion(false);</span>
<span class="nc" id="L1352">			theListPC.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L1353">			theListPC.setReadableRowInfoEnabled(true);</span>
<span class="nc" id="L1354">			theListPC.addTableArrowNavigation();</span>
		}

		// Initialize Container
<span class="nc" id="L1358">		parentPC.setStyleClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="nc" id="L1359">		parentPC.setTemplate(&quot;{0}&quot;);</span>
<span class="nc" id="L1360">		parentPC.addComponent(theListPC);</span>

<span class="nc" id="L1362">		return theListPC;</span>
	}

	private void handlePopulateContainerError(String rbKey, Exception ex) {
<span class="nc" id="L1366">		log.l7dError(rbKey, ex);</span>
<span class="nc" id="L1367">		addPageMessage(Message.ERROR_TYPE, rbKey, AmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L1368">	}</span>

	/**
	 * Given a number of milliseconds such as 4020000, add a row like &quot;01:07&quot;
	 * for HH:MM format.
	 * 
	 * @param duration
	 *            a number of milliseconds such as 4020000.
	 * @param row_data
	 *            DefaultMultiColumnNodeData to receive the duration data.
	 */
	private void addDurationData(int duration, DefaultMultiColumnNodeData row_data) {
<span class="nc" id="L1380">		int mm = AdherenceSummaryUtil.getRoundedMinutes(duration);</span>
<span class="nc" id="L1381">		String hhmm = m_localizer.formatDurationInMins(mm);</span>
<span class="nc" id="L1382">		row_data.add(hhmm, CSSUtil.STYLE_NUMERIC);</span>
<span class="nc" id="L1383">	}</span>

	/**
	 * Given a decimal percentage such as .67, add a row like &quot;67%&quot;.
	 * 
	 * @param duration
	 *            a decimal percentage such as .67
	 * @param scheduled
	 *            a number of milliseconds of scheduled time such as 4020000.
	 * @param row_data
	 *            DefaultMultiColumnNodeData to receive the percentage data.
	 */
	private void addPercentData(float duration, int scheduled, DefaultMultiColumnNodeData row_data) {
<span class="nc bnc" id="L1396" title="All 2 branches missed.">		if (scheduled &gt; 0) {</span>
<span class="nc" id="L1397">			row_data.add(m_localizer.formatPercentage(duration, 0), CSSUtil.STYLE_NUMERIC);</span>
		} else {
<span class="nc" id="L1399">			row_data.add(HtmlUtil.NBSP);</span>
		}
<span class="nc" id="L1401">	}</span>

	// /////////////////////////////////////////////////////////////////////////
	// Dual List Helper Methods
	// /////////////////////////////////////////////////////////////////////////

	private void initDualListForDisplay() {
<span class="nc" id="L1408">		MultiColListPC leftListPC = m_dualList.getLeftListPC();</span>
<span class="nc" id="L1409">		MultiColListPC rightListPC = m_dualList.getRightListPC();</span>
<span class="nc" id="L1410">		leftListPC.setTableAttribute(&quot;summary&quot;, i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_CATEGORY_TABLE_SUMMARY));</span>
<span class="nc" id="L1411">		rightListPC.setTableAttribute(&quot;summary&quot;, i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_DETAIL_TABLE_SUMMARY));</span>
<span class="nc" id="L1412">		leftListPC.setRowSelectable(false);</span>
<span class="nc" id="L1413">		rightListPC.setRowSelectable(false);</span>

<span class="nc" id="L1415">		initRightListProperties();</span>

<span class="nc bnc" id="L1417" title="All 2 branches missed.">		if (leftListPC.getListModel().isEmpty()) {</span>
<span class="nc" id="L1418">			m_dualList.setIsBorderEnabled(false);</span>
		}
<span class="nc" id="L1420">	}</span>

	protected void initRightListProperties() {
		// set CSS class to remove margins in the right list
<span class="nc" id="L1424">		MultiColListPC rightListPC = m_dualList.getRightListPC();</span>
<span class="nc" id="L1425">		rightListPC.setCellClass(&quot;tblItemNoPaddn&quot;);</span>
<span class="nc" id="L1426">		rightListPC.setTableRowClass(&quot;tblRowNoPaddn&quot;);</span>
<span class="nc" id="L1427">		rightListPC.getHeader().setStyleClass(&quot;tableHeaderNoPaddn&quot;);</span>

<span class="nc" id="L1429">		MultiColListPC leftListPC = m_dualList.getLeftListPC();</span>
<span class="nc" id="L1430">		leftListPC.setCellClass(&quot;tblRow tblItemNoPaddn&quot;); // tableItem tblItem</span>
															// tblItemNoPaddn
<span class="nc" id="L1432">		leftListPC.setTableRowClass(&quot;tblRow&quot;); // tblRow tblRowNoPaddn</span>
		
<span class="nc bnc" id="L1434" title="All 2 branches missed.">		if  (isAccessibilityComplianceMode()){</span>
<span class="nc" id="L1435">			leftListPC.setWrapperRegion(false);</span>
<span class="nc" id="L1436">			rightListPC.setWrapperRegion(false);</span>
		}
<span class="nc" id="L1438">	}</span>

	/**
	 * generate left list header in dual list
	 */
	protected void makeLeftDualLIstHeader(String title) {
		// --- left column header ----
<span class="nc" id="L1445">		MultiColListPC leftListPC = m_dualList.getLeftListPC();</span>
<span class="nc" id="L1446">		TableHeaderPC leftHeader = leftListPC.getHeader();</span>
<span class="nc" id="L1447">		leftHeader.addColumnHeaderData(null, title);</span>
<span class="nc" id="L1448">	}// makeLeftDualLIstHeader</span>

	/**
	 * generate right list headers with hours for the graph view
	 */
	protected void makeRightDualListHeader(Date start, Date end) {
		// --- right headers = times within shown hours ----
<span class="nc" id="L1455">		MultiColListPC rightListPC = m_dualList.getRightListPC();</span>
<span class="nc" id="L1456">		TableHeaderPC rightHeader = rightListPC.getHeader();</span>

<span class="nc" id="L1458">		TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L1459">		Calendar aCal = Calendar.getInstance(tz);</span>
<span class="nc" id="L1460">		aCal.setTime(start);</span>
<span class="nc" id="L1461">		aCal.set(Calendar.HOUR, 0);</span>
<span class="nc" id="L1462">		aCal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L1463">		aCal.set(Calendar.SECOND, 0);</span>

		// put one string with fixed width spans for each hour
<span class="nc" id="L1466">		StringBuffer sb = new StringBuffer();</span>
<span class="nc bnc" id="L1467" title="All 2 branches missed.">		while (aCal.getTime().before(end)) {</span>
<span class="nc" id="L1468">			sb.append(&quot;&lt;span class=\&quot;hour\&quot;&gt;&quot;)</span>
<span class="nc" id="L1469">					.append(m_localizer.formatDate(aCal.getTime(), tz, RegionalFormatBundleKey.TIME_FORMAT))</span>
<span class="nc" id="L1470">					.append(&quot;&lt;/span&gt;&quot;);</span>
<span class="nc" id="L1471">			aCal.add(Calendar.HOUR, 1);</span>
		}
<span class="nc" id="L1473">		rightHeader.addColumnHeaderData(null, sb.toString());</span>
<span class="nc" id="L1474">	}// makeRightDualListHeader</span>

	/**
	 * Initialize Dual List with Models
	 */
	protected void setDualListModels(List lModel, List rModel) {
<span class="nc" id="L1480">		m_dualList.getLeftListPC().setListModel(lModel);</span>
<span class="nc" id="L1481">		m_dualList.getRightListPC().setListModel(rModel);</span>
<span class="nc" id="L1482">	}</span>

	private int[] getShownHours(Date start, Date end) {
<span class="nc" id="L1485">		int[] result = new int[2];</span>
<span class="nc" id="L1486">		result[0] = 0;</span>
<span class="nc" id="L1487">		Calendar cal = Calendar.getInstance(m_context.getViewingTimeZone());</span>
<span class="nc" id="L1488">		cal.setTime(start);</span>
<span class="nc" id="L1489">		int hours = 0;</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">		while (cal.getTime().before(end)) {</span>
<span class="nc" id="L1491">			hours++;</span>
<span class="nc" id="L1492">			cal.add(Calendar.HOUR, 1);</span>
		}
<span class="nc" id="L1494">		result[1] = hours;</span>
<span class="nc" id="L1495">		return result;</span>
	}

	// ////////////////////////////////////////////////////////////////////////////
	// Helper Classes
	// ////////////////////////////////////////////////////////////////////////////

	public class MyDualListPC extends DualListPC {
		private static final String BORDER_CLASS = &quot; class=\&quot;&quot; + CSSUtil.CLASS_BORDER_DEFAULT + &quot;\&quot; &quot;;
		private static final String DEFAULT_LWPR_STYLE = &quot;height:150px; overflow-x:auto; overflow-y:hidden; &quot;;
		private static final String DEFAULT_LWPR_ATTR = &quot; style=\&quot;&quot; + DEFAULT_LWPR_STYLE + &quot;\&quot; &quot;;
		private static final String DEFAULT_RWPR_STYLE = &quot;height:150px; overflow:auto; &quot;;
		private static final String DEFAULT_RWPR_ATTR = &quot; style=\&quot;&quot; + DEFAULT_RWPR_STYLE + &quot;\&quot; &quot;;

<span class="nc" id="L1509">		public MyDualListPC(RequestContext context) {</span>
<span class="nc" id="L1510">			super(context);</span>
<span class="nc" id="L1511">		}</span>

		@Override
		public String getHtmlDisplay() {
<span class="nc bnc" id="L1515" title="All 2 branches missed.">			if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L1516">				StringBuilder builder = new StringBuilder();</span>
				//wrap with div[region]
<span class="nc" id="L1518">				builder.append(&quot;&lt;div &quot;);</span>
<span class="nc" id="L1519">				builder.append(&quot;tabindex=\&quot;0\&quot; role=\&quot;region\&quot; &quot;);</span>
<span class="nc" id="L1520">				builder.append(&quot;aria-label=\&quot;&quot;);</span>
<span class="nc" id="L1521">				builder.append(i18n(m_bundle, AmWebBundleKey.MY_ADHERENCE_GRID));</span>
<span class="nc" id="L1522">				builder.append(&quot;\&quot;&gt;&quot;);</span>
				//initial getHtmlDisplay			
<span class="nc" id="L1524">				builder.append(super.getHtmlDisplay());</span>
				//close wrapper
<span class="nc" id="L1526">				builder.append(&quot;&lt;/div&gt;&quot;);</span>
<span class="nc" id="L1527">				return builder.toString();				</span>
			} else {
<span class="nc" id="L1529">				return super.getHtmlDisplay();</span>
			}
		}

		/**
		 * Return Left Wrapper Attributes As String. Override the method in
		 * DualContainerPC to change height.
		 */
		protected String getLWAttrAsString() {
<span class="nc bnc" id="L1538" title="All 4 branches missed.">			if (m_leftWprAttr == null || m_leftWprAttr.isEmpty()) {</span>
<span class="nc bnc" id="L1539" title="All 2 branches missed.">				if (isBorderEnabled()) {</span>
<span class="nc" id="L1540">					return BORDER_CLASS + DEFAULT_LWPR_ATTR;</span>
				} else {
<span class="nc" id="L1542">					return DEFAULT_LWPR_ATTR;</span>
				}
			}

<span class="nc" id="L1546">			appendDefaultWprAttr(m_leftWprAttr, DEFAULT_LWPR_STYLE);</span>
<span class="nc" id="L1547">			return getVPfromMap(m_leftWprAttr);</span>
		}

		/**
		 * Return Right Wrapper Attributes As String. Override the method in
		 * DualContainerPC to change height.
		 */
		protected String getRWAttrAsString() {
<span class="nc bnc" id="L1555" title="All 4 branches missed.">			if (m_rightWprAttr == null || m_rightWprAttr.isEmpty()) {</span>
<span class="nc bnc" id="L1556" title="All 2 branches missed.">				if (isBorderEnabled()) {</span>
<span class="nc" id="L1557">					return BORDER_CLASS + DEFAULT_RWPR_ATTR;</span>
				} else {
<span class="nc" id="L1559">					return DEFAULT_RWPR_ATTR;</span>
				}
			}

<span class="nc" id="L1563">			appendDefaultWprAttr(m_rightWprAttr, DEFAULT_RWPR_STYLE);</span>
<span class="nc" id="L1564">			return getVPfromMap(m_rightWprAttr);</span>
		}
	}

}// class MyAdherencePM
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>