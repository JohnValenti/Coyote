<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RTAAServiceDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.rtaaservice.ejb</a> &gt; <span class="el_source">RTAAServiceDAO.java</span></div><h1>RTAAServiceDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.rtaaservice.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author
 * @version 1.0
 */

import java.sql.Timestamp;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.ArrayList;
import java.util.TimeZone;
import java.util.TreeSet;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import java.sql.Types;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoParam;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.ActivityMapping;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.AdheranceOverride;
import com.bluepumpkin.ejb.bbm.rtaaservice.model.RTAAException;
import com.bluepumpkin.ejb.bbm.activity.model.Event;

public class RTAAServiceDAO
{

	public RTAAServiceDAO()
<span class="nc" id="L41">	{</span>
<span class="nc" id="L42">	}</span>

	private static Jdmo getJdmo()
	{
<span class="nc" id="L46">		return new Jdmo();</span>
	}

	public Collection getActivityMappingsByID(Collection colActivityIDs) throws JdmoException
	{

<span class="nc" id="L52">		HashMap hmActivityMappings = new HashMap();</span>
<span class="nc" id="L53">		Jdmo jdmo = getJdmo();</span>
		try
		{
<span class="nc bnc" id="L56" title="All 2 branches missed.">			if (colActivityIDs.isEmpty())</span>
<span class="nc" id="L57">				return new LinkedList();</span>

<span class="nc" id="L59">			String strQuery = &quot;SELECT ACTIVITYID, MAPPEDACTIVITYID, LASTMODIFIEDAT FROM ACTIVITYMAPPING WHERE ACTIVITYID IN &quot;;</span>
<span class="nc" id="L60">			strQuery += jdmo.createInClause(colActivityIDs);</span>
<span class="nc" id="L61">			strQuery += &quot; ORDER BY ACTIVITYID&quot;;</span>

<span class="nc" id="L63">			JdmoRowset r = jdmo.createRowset(strQuery);</span>

<span class="nc" id="L65">			ActivityMapping activityMapping = null;</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">			while (r.next())</span>
			{
<span class="nc" id="L68">				ID idActivity = r.getID(&quot;ACTIVITYID&quot;);</span>
<span class="nc" id="L69">				ID idMappedActivity = r.getID(&quot;MAPPEDACTIVITYID&quot;);</span>

<span class="nc bnc" id="L71" title="All 2 branches missed.">				if (activityMapping == null)</span>
<span class="nc" id="L72">					activityMapping = new ActivityMapping(idActivity);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">				else if (!activityMapping.getActivityID().equals(idActivity))</span>
				{
<span class="nc" id="L75">					hmActivityMappings.put(activityMapping.getActivityID(), activityMapping);</span>
<span class="nc" id="L76">					activityMapping = new ActivityMapping(idActivity);</span>
				}
<span class="nc" id="L78">				activityMapping.getMappedActivityIDs().add(idMappedActivity);</span>
<span class="nc" id="L79">			}</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">			if (activityMapping != null)</span>
<span class="nc" id="L81">				hmActivityMappings.put(activityMapping.getActivityID(), activityMapping);</span>

<span class="nc" id="L83">			LinkedList llActivityMappings = new LinkedList();</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">			for (Iterator i = colActivityIDs.iterator(); i.hasNext();)</span>
			{
<span class="nc" id="L86">				ID idActivity = (ID) i.next();</span>
<span class="nc" id="L87">				activityMapping = (ActivityMapping) hmActivityMappings.get(idActivity);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">				if (activityMapping == null)</span>
<span class="nc" id="L89">					activityMapping = new ActivityMapping(idActivity);</span>
<span class="nc" id="L90">				llActivityMappings.add(activityMapping);</span>
<span class="nc" id="L91">			}</span>
<span class="nc" id="L92">			return llActivityMappings;</span>
		}
		finally
		{
<span class="nc" id="L96">			jdmo.cleanUp();</span>
		}
	}

	public void updateActivityMapping(ActivityMapping activityMapping) throws JdmoException
	{
<span class="nc" id="L102">		Jdmo jdmo = getJdmo();</span>
		try
		{

<span class="nc" id="L106">			String strQuery = &quot;DELETE FROM ACTIVITYMAPPING WHERE ACTIVITYID = &quot;;</span>
<span class="nc" id="L107">			strQuery += activityMapping.getActivityID().toString();</span>
<span class="nc" id="L108">			jdmo.addBatch(strQuery);</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">			for (Iterator i = activityMapping.getMappedActivityIDs().iterator(); i.hasNext();)</span>
			{
<span class="nc" id="L112">				ID idMappedActivity = (ID) i.next();</span>
<span class="nc" id="L113">				HashMap hm = new HashMap();</span>
<span class="nc" id="L114">				hm.put(&quot;ACTIVITYID&quot;, activityMapping.getActivityID().toString());</span>
<span class="nc" id="L115">				hm.put(&quot;MAPPEDACTIVITYID&quot;, idMappedActivity.toString());</span>
<span class="nc" id="L116">				Date dateLastModified = Calendar.getInstance().getTime();</span>
<span class="nc" id="L117">				jdmo.addBatchInsert(&quot;ACTIVITYMAPPING&quot;, hm);</span>
<span class="nc" id="L118">			}</span>
<span class="nc" id="L119">			jdmo.executeBatch();</span>
		}
		finally
		{
<span class="nc" id="L123">			jdmo.cleanUp();</span>
<span class="nc" id="L124">		}</span>

<span class="nc" id="L126">	}</span>

	public void deleteActivityMappingsByID(Collection colActivityIDs) throws JdmoException
	{
<span class="nc" id="L130">		Jdmo jdmo = getJdmo();</span>
		try
		{

<span class="nc" id="L134">			String strQuery = &quot;DELETE FROM ACTIVITYMAPPING WHERE ACTIVITYID IN &quot;;</span>
<span class="nc" id="L135">			strQuery += jdmo.createInClause(colActivityIDs);</span>

<span class="nc" id="L137">			jdmo.executeCommand(strQuery);</span>
		}
		finally
		{
<span class="nc" id="L141">			jdmo.cleanUp();</span>
<span class="nc" id="L142">		}</span>
<span class="nc" id="L143">	}</span>

	public void createAdheranceOverride(Collection colEmployeeIDs, Timestamp tsStartDate, Timestamp tsEndDate, String approveBy, String strComment)
		throws JdmoException
	{
<span class="nc" id="L148">		updateAdheranceOverride(colEmployeeIDs, tsStartDate, tsEndDate, false, approveBy, strComment);</span>
<span class="nc" id="L149">	}</span>

	public void deleteAdheranceOverride(Collection colEmployeeIDs, Timestamp tsStartDate, Timestamp tsEndDate)
		throws JdmoException
	{
<span class="nc" id="L154">		updateAdheranceOverride(colEmployeeIDs, tsStartDate, tsEndDate, true, null, null);</span>
<span class="nc" id="L155">	}</span>

	private void updateAdheranceOverride(
		Collection colEmployeeIDs,
		Timestamp tsStartDate,
		Timestamp tsEndDate,
		boolean bDelete,
		String approveBy,
		String strComment)
		throws JdmoException
	{
<span class="nc" id="L166">		Jdmo jdmo = getJdmo();</span>
		try
		{

<span class="nc" id="L170">			Timestamp tsMinDate = new Timestamp(tsStartDate.getTime());</span>
<span class="nc" id="L171">			Timestamp tsMaxDate = new Timestamp(tsEndDate.getTime());</span>
<span class="nc" id="L172">			deleteOverlappingOverrides(colEmployeeIDs, tsStartDate, tsEndDate, jdmo);</span>

<span class="nc" id="L174">			Date dateLastModified = Calendar.getInstance().getTime();</span>
<span class="nc" id="L175">			Timestamp tsLastModified = new Timestamp(dateLastModified.getTime());</span>

<span class="nc" id="L177">			String arrFieldNames[] =</span>
				new String[] { &quot;ID&quot;, &quot;EMPLOYEEID&quot;, &quot;STARTTIME&quot;, &quot;ENDTIME&quot;, &quot;LASTMODIFIEDAT&quot;, &quot;ISDELETED&quot;, &quot;APPROVEDBY&quot;, &quot;ADHERENCEOVRCOMMENT&quot; };
<span class="nc" id="L179">			int arrFieldTypes[] = { Types.INTEGER, Types.INTEGER, Types.TIMESTAMP, Types.TIMESTAMP, Types.TIMESTAMP, Types.BOOLEAN, Types.VARCHAR, Types.VARCHAR }; </span>
					
<span class="nc" id="L181">			ArrayList colFieldValues = new ArrayList();</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">			for (Iterator itEmployeeID = colEmployeeIDs.iterator(); itEmployeeID.hasNext();)</span>
			{
<span class="nc" id="L184">				ID idEmployee = (ID) itEmployeeID.next();</span>
<span class="nc" id="L185">				Object arrFieldValues[] =</span>
					new Object[] { null, idEmployee, tsStartDate, tsEndDate, tsLastModified, new Boolean(bDelete), approveBy, strComment};
<span class="nc" id="L187">				colFieldValues.add(arrFieldValues);</span>
<span class="nc" id="L188">			}</span>
<span class="nc" id="L189">			jdmo.insertBatchAndExecute(&quot;ADHERENCEOVERRIDE&quot;, arrFieldNames, arrFieldTypes, colFieldValues);</span>
		}
		finally
		{
<span class="nc" id="L193">			jdmo.cleanUp();</span>
<span class="nc" id="L194">		}</span>
<span class="nc" id="L195">	}</span>
	public HashMap getAdheranceOverrides(Collection colEmployeeIDs, Timestamp tsStartDate, Timestamp tsEndDate)
		throws JdmoException
	{
<span class="nc" id="L199">		Jdmo jdmo = getJdmo();</span>
		try
		{
<span class="nc" id="L202">			HashMap hmAdheranceOverrides = new HashMap();</span>

<span class="nc bnc" id="L204" title="All 2 branches missed.">			for (Iterator i = colEmployeeIDs.iterator(); i.hasNext();)</span>
			{
<span class="nc" id="L206">				ID idEmployee = (ID) i.next();</span>
<span class="nc" id="L207">				hmAdheranceOverrides.put(idEmployee, new LinkedList());</span>
<span class="nc" id="L208">			}</span>
<span class="nc bnc" id="L209" title="All 4 branches missed.">			if (tsStartDate == null || tsEndDate == null)</span>
<span class="nc" id="L210">				return hmAdheranceOverrides;</span>

<span class="nc" id="L212">			String strQuery =</span>
				&quot;SELECT EMPLOYEEID, STARTTIME, ENDTIME, LASTMODIFIEDAT, ISDELETED, APPROVEDBY, ADHERENCEOVRCOMMENT FROM ADHERENCEOVERRIDE WHERE ENDTIME &gt;= '&quot;
<span class="nc" id="L214">					+ JdmoUtil.formatDBString(tsStartDate)</span>
					+ &quot;' AND STARTTIME &lt;= '&quot;
<span class="nc" id="L216">					+ JdmoUtil.formatDBString(tsEndDate)</span>
					+ &quot;' AND EMPLOYEEID IN &quot;
<span class="nc" id="L218">					+ jdmo.createInClause(colEmployeeIDs)</span>
					+ &quot; ORDER BY STARTTIME&quot;;
<span class="nc" id="L220">			JdmoRowset r = jdmo.createRowset(strQuery);</span>

<span class="nc bnc" id="L222" title="All 2 branches missed.">			while (r.next())</span>
			{
<span class="nc" id="L224">				ID idEmployee = r.getID(&quot;EMPLOYEEID&quot;);</span>
<span class="nc" id="L225">				Timestamp tsEntryStartDate = r.getTimestamp(&quot;STARTTIME&quot;);</span>
<span class="nc" id="L226">				Timestamp tsEntryEndDate = r.getTimestamp(&quot;ENDTIME&quot;);</span>
<span class="nc" id="L227">				Timestamp tsLastModified = r.getTimestamp(&quot;LASTMODIFIEDAT&quot;);</span>
<span class="nc" id="L228">				boolean bIsDeleted = r.getBoolean(&quot;ISDELETED&quot;);</span>
<span class="nc" id="L229">				String approvedBy = r.getString(&quot;APPROVEDBY&quot;);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">				if (r.wasNull())</span>
<span class="nc" id="L231">					approvedBy = null;</span>
<span class="nc" id="L232">				String strComment = r.getString(&quot;ADHERENCEOVRCOMMENT&quot;);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">				if (r.wasNull())</span>
<span class="nc" id="L234">					strComment = null;</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">				if (tsEntryStartDate.before(tsStartDate))</span>
<span class="nc" id="L236">					tsEntryStartDate = tsStartDate;</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">				if (tsEntryEndDate.after(tsEndDate))</span>
<span class="nc" id="L238">					tsEntryEndDate = tsEndDate;</span>
<span class="nc" id="L239">				AdheranceOverride adheranceOverride =</span>
					new AdheranceOverride(idEmployee, tsEntryStartDate, tsEntryEndDate, tsLastModified, bIsDeleted, approvedBy, strComment);

<span class="nc" id="L242">				Collection colAdheranceOverrides = (Collection) hmAdheranceOverrides.get(idEmployee);</span>
<span class="nc" id="L243">				colAdheranceOverrides.add(adheranceOverride);</span>
<span class="nc" id="L244">			}</span>
<span class="nc" id="L245">			return hmAdheranceOverrides;</span>
		}
		finally
		{
<span class="nc" id="L249">			jdmo.cleanUp();</span>
		}

	}
	public void updateAdheranceExceptions(Collection colAdheranceExceptions, Date dateStart, Date dateEnd)
		throws JdmoException
	{
<span class="nc" id="L256">		Jdmo jdmo = getJdmo();</span>
		try
		{
<span class="nc" id="L259">			Collection colEmployeeIDs = new TreeSet();</span>
<span class="nc" id="L260">			Collection colPayPeriodIDs = new TreeSet();</span>
<span class="nc" id="L261">			boolean bIncludeNullPayPeriodID = false;</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">			for (Iterator i = colAdheranceExceptions.iterator(); i.hasNext();)</span>
			{
<span class="nc" id="L264">				RTAAException rtaaException = (RTAAException) i.next();</span>
<span class="nc" id="L265">				colEmployeeIDs.add(rtaaException.getEmployeeID());</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">				if (rtaaException.getPayPeriodID() == null)</span>
<span class="nc" id="L267">					bIncludeNullPayPeriodID = true;</span>
				else
<span class="nc" id="L269">					colPayPeriodIDs.add(rtaaException.getPayPeriodID());</span>
<span class="nc" id="L270">			}</span>
<span class="nc" id="L271">			String strQuery = &quot;DELETE FROM ADHERENCEEXCEPTION WHERE EMPLOYEEID IN &quot; + jdmo.createInClause(colEmployeeIDs);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">			if (bIncludeNullPayPeriodID == true)</span>
			{
<span class="nc bnc" id="L274" title="All 2 branches missed.">				if (colPayPeriodIDs.isEmpty())</span>
<span class="nc" id="L275">					strQuery += &quot; AND PAYPERIODID IS NULL&quot;;</span>
				else
				{
<span class="nc" id="L278">					strQuery += &quot; AND (PAYPERIODID IN &quot; + jdmo.createInClause(colPayPeriodIDs) + &quot; OR PAYPERIODID IS NULL)&quot;;</span>
				}
			}
<span class="nc bnc" id="L281" title="All 2 branches missed.">			else if (!colPayPeriodIDs.isEmpty())</span>
<span class="nc" id="L282">				strQuery += &quot; AND PAYPERIODID IN &quot; + jdmo.createInClause(colPayPeriodIDs);</span>

<span class="nc" id="L284">			jdmo.addBatch(strQuery);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">			for (Iterator i = colAdheranceExceptions.iterator(); i.hasNext();)</span>
			{
<span class="nc" id="L287">				RTAAException rtaaException = (RTAAException) i.next();</span>
<span class="nc" id="L288">				HashMap hm = new HashMap();</span>
<span class="nc" id="L289">				hm.put(&quot;EMPLOYEEID&quot;, rtaaException.getEmployeeID());</span>
<span class="nc" id="L290">				hm.put(&quot;PLANNEDACTIVITYID&quot;, rtaaException.getPlannedActivityID());</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">				if (rtaaException.getPayPeriodID() != null)</span>
<span class="nc" id="L292">					hm.put(&quot;PAYPERIODID&quot;, rtaaException.getPayPeriodID());</span>
<span class="nc" id="L293">				hm.put(&quot;ISAPPROVED&quot;, JdmoParam.getObject(rtaaException.isApproved()));</span>
<span class="nc" id="L294">				hm.put(&quot;STARTTIME&quot;, JdmoUtil.formatDBString(new Timestamp(rtaaException.getStartTime().getTime())));</span>
<span class="nc" id="L295">				hm.put(&quot;ENDTIME&quot;, JdmoUtil.formatDBString(new Timestamp(rtaaException.getEndTime().getTime())));</span>
<span class="nc" id="L296">				jdmo.addBatchInsert(&quot;ADHERENCEEXCEPTION&quot;, hm);</span>
<span class="nc" id="L297">			}</span>
<span class="nc" id="L298">			jdmo.executeBatch();</span>
		}
		finally
		{
<span class="nc" id="L302">			jdmo.cleanUp();</span>
<span class="nc" id="L303">		}</span>
<span class="nc" id="L304">	}</span>

	public HashMap getAdheranceExceptionsByPayPeriodID(Collection colEmployeeIDs, ID idPayPeriod) throws JdmoException
	{
<span class="nc" id="L308">		Jdmo jdmo = getJdmo();</span>
		try
		{

<span class="nc" id="L312">			HashMap hmAdheranceExceptions = new HashMap();</span>

<span class="nc" id="L314">			String strQuery =</span>
				&quot;SELECT EMPLOYEEID, PLANNEDACTIVITYID, &quot;
					+ &quot;STARTTIME, ENDTIME, ISAPPROVED FROM ADHERENCEEXCEPTION WHERE EMPLOYEEID IN &quot;
<span class="nc" id="L317">					+ jdmo.createInClause(colEmployeeIDs)</span>
					+ &quot; AND PAYPERIODID &quot;;
<span class="nc bnc" id="L319" title="All 2 branches missed.">			if (idPayPeriod == null)</span>
<span class="nc" id="L320">				strQuery += &quot;IS NULL&quot;;</span>
			else
<span class="nc" id="L322">				strQuery += &quot;= &quot; + idPayPeriod.toString();</span>
<span class="nc" id="L323">			strQuery += &quot; ORDER BY STARTTIME&quot;;</span>

<span class="nc" id="L325">			JdmoRowset r = jdmo.createRowset(strQuery);</span>

<span class="nc bnc" id="L327" title="All 2 branches missed.">			while (r.next())</span>
			{
<span class="nc" id="L329">				ID idEmployee = r.getID(&quot;EMPLOYEEID&quot;);</span>
<span class="nc" id="L330">				ID idPlannedActivity = r.getID(&quot;PLANNEDACTIVITYID&quot;);</span>
<span class="nc" id="L331">				Timestamp tsStart = r.getTimestamp(&quot;STARTTIME&quot;);</span>
<span class="nc" id="L332">				Timestamp tsEnd = r.getTimestamp(&quot;ENDTIME&quot;);</span>
<span class="nc" id="L333">				boolean bIsApproved = r.getBoolean(&quot;ISAPPROVED&quot;);</span>
<span class="nc" id="L334">				RTAAException rtaaException =</span>
					new RTAAException(idEmployee, tsStart, tsEnd, idPlannedActivity, bIsApproved, false);
<span class="nc" id="L336">				rtaaException.setPayPeriodID(idPayPeriod);</span>

<span class="nc" id="L338">				Collection colAdheranceExceptions = (Collection) hmAdheranceExceptions.get(idEmployee);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">				if (colAdheranceExceptions == null)</span>
				{
<span class="nc" id="L341">					colAdheranceExceptions = new LinkedList();</span>
<span class="nc" id="L342">					hmAdheranceExceptions.put(idEmployee, colAdheranceExceptions);</span>
				}
<span class="nc" id="L344">				colAdheranceExceptions.add(rtaaException);</span>
<span class="nc" id="L345">			}</span>
<span class="nc" id="L346">			return hmAdheranceExceptions;</span>
		}
		finally
		{
<span class="nc" id="L350">			jdmo.cleanUp();</span>
		}
	}
	private String formatDBString(Timestamp timeStamp, Jdmo jdmo)
	{
<span class="nc" id="L355">		return &quot;'&quot; + JdmoUtil.formatDBString(timeStamp) + &quot;'&quot;;</span>
	}

	private void deleteOverlappingOverrides(Collection colEmployeeIDs, Timestamp tsStart, Timestamp tsEnd, Jdmo jdmo)
		throws JdmoException
	{
		// clear out events that fall within window
<span class="nc" id="L362">		String arrFieldNames[] = new String[] { &quot;ID&quot;, &quot;EMPLOYEEID&quot;, &quot;STARTTIME&quot;, &quot;ENDTIME&quot;, &quot;LASTMODIFIEDAT&quot;, &quot;ISDELETED&quot;, &quot;APPROVEDBY&quot; };</span>
<span class="nc" id="L363">		int arrFieldTypes[] = { Types.INTEGER, Types.INTEGER, Types.TIMESTAMP, Types.TIMESTAMP, Types.TIMESTAMP, Types.BOOLEAN, Types.VARCHAR };</span>
<span class="nc" id="L364">		ArrayList colFieldValues = new ArrayList();</span>

<span class="nc" id="L366">		String strQuery =</span>
			&quot;SELECT EMPLOYEEID, STARTTIME, ENDTIME, LASTMODIFIEDAT, ISDELETED, APPROVEDBY FROM ADHERENCEOVERRIDE &quot;
				+ &quot;WHERE STARTTIME &lt; &quot;
<span class="nc" id="L369">				+ formatDBString(tsStart, jdmo)</span>
				+ &quot; AND ENDTIME &gt; &quot;
<span class="nc" id="L371">				+ formatDBString(tsEnd, jdmo)</span>
				+ &quot; AND EMPLOYEEID IN &quot;
<span class="nc" id="L373">				+ jdmo.createInClause(colEmployeeIDs);</span>

<span class="nc" id="L375">		JdmoRowset r = jdmo.createRowset(strQuery);</span>

<span class="nc bnc" id="L377" title="All 2 branches missed.">		while (r.next())</span>
		{
<span class="nc" id="L379">			ID idEmployee = r.getID(&quot;EMPLOYEEID&quot;);</span>
<span class="nc" id="L380">			Timestamp tsEntryStart = r.getTimestamp(&quot;STARTTIME&quot;);</span>
<span class="nc" id="L381">			Timestamp tsEntryEnd = r.getTimestamp(&quot;ENDTIME&quot;);</span>
<span class="nc" id="L382">			Timestamp tsLastModified = r.getTimestamp(&quot;LASTMODIFIEDAT&quot;);</span>
<span class="nc" id="L383">			boolean bIsDeleted = r.getBoolean(&quot;ISDELETED&quot;);</span>
<span class="nc" id="L384">			String approveBy = r.getString(&quot;APPROVEDBY&quot;);</span>

			{
<span class="nc" id="L387">				Object arrFieldValues[] =</span>
					new Object[] { null, idEmployee, tsEntryStart, tsStart, tsLastModified, new Boolean(bIsDeleted), approveBy};
<span class="nc" id="L389">				colFieldValues.add(arrFieldValues);</span>
			}
			{
<span class="nc" id="L392">				Object arrFieldValues[] =</span>
					new Object[] { null, idEmployee, tsEnd, tsEntryEnd, tsLastModified, new Boolean(bIsDeleted), approveBy};

<span class="nc" id="L395">				colFieldValues.add(arrFieldValues);</span>
			}
<span class="nc" id="L397">		}</span>
<span class="nc" id="L398">		strQuery =</span>
			&quot;DELETE FROM ADHERENCEOVERRIDE &quot;
				+ &quot;WHERE STARTTIME &lt; &quot;
<span class="nc" id="L401">				+ formatDBString(tsStart, jdmo)</span>
				+ &quot; AND ENDTIME &gt; &quot;
<span class="nc" id="L403">				+ formatDBString(tsEnd, jdmo)</span>
				+ &quot; AND EMPLOYEEID IN &quot;
<span class="nc" id="L405">				+ jdmo.createInClause(colEmployeeIDs);</span>
<span class="nc" id="L406">		jdmo.addBatch(strQuery);</span>
<span class="nc" id="L407">		jdmo.executeBatch();</span>

<span class="nc" id="L409">		jdmo.insertBatchAndExecute(&quot;ADHERENCEOVERRIDE&quot;, arrFieldNames, arrFieldTypes, colFieldValues);</span>

<span class="nc" id="L411">		strQuery =</span>
			&quot;delete from ADHERENCEOVERRIDE&quot;
				+ &quot; where EMPLOYEEID in &quot;
<span class="nc" id="L414">				+ jdmo.createInClause(colEmployeeIDs)</span>
				+ &quot; and STARTTIME &gt;= &quot;
<span class="nc" id="L416">				+ formatDBString(tsStart, jdmo)</span>
				+ &quot; and ENDTIME &lt;= &quot;
<span class="nc" id="L418">				+ formatDBString(tsEnd, jdmo);</span>
<span class="nc" id="L419">		jdmo.addBatch(strQuery);</span>

		// truncate left overlapping events
<span class="nc" id="L422">		strQuery =</span>
			&quot;update ADHERENCEOVERRIDE&quot;
				+ &quot; set ENDTIME = &quot;
<span class="nc" id="L425">				+ formatDBString(tsStart, jdmo)</span>
				+ &quot;where EMPLOYEEID in &quot;
<span class="nc" id="L427">				+ jdmo.createInClause(colEmployeeIDs)</span>
				+ &quot; and STARTTIME &lt; &quot;
<span class="nc" id="L429">				+ formatDBString(tsStart, jdmo)</span>
				+ &quot; and ENDTIME &gt; &quot;
<span class="nc" id="L431">				+ formatDBString(tsStart, jdmo)</span>
				+ &quot; and ENDTIME &lt;= &quot;
<span class="nc" id="L433">				+ formatDBString(tsEnd, jdmo);</span>
<span class="nc" id="L434">		jdmo.addBatch(strQuery);</span>

		// truncate right overlapping events
<span class="nc" id="L437">		strQuery =</span>
			&quot;update ADHERENCEOVERRIDE&quot;
				+ &quot; set STARTTIME = &quot;
<span class="nc" id="L440">				+ formatDBString(tsEnd, jdmo)</span>
				+ &quot;where EMPLOYEEID in &quot;
<span class="nc" id="L442">				+ jdmo.createInClause(colEmployeeIDs)</span>
				+ &quot; and STARTTIME &gt;= &quot;
<span class="nc" id="L444">				+ formatDBString(tsStart, jdmo)</span>
				+ &quot; and STARTTIME &lt; &quot;
<span class="nc" id="L446">				+ formatDBString(tsEnd, jdmo)</span>
				+ &quot; and ENDTIME &gt; &quot;
<span class="nc" id="L448">				+ formatDBString(tsEnd, jdmo);</span>
<span class="nc" id="L449">		jdmo.addBatch(strQuery);</span>
<span class="nc" id="L450">		jdmo.executeBatch();</span>
<span class="nc" id="L451">	}</span>

	public void updatePlannedEventsTimeline(Collection colPlannedEvents, ID idPayPeriod) throws JdmoException
	{
<span class="nc" id="L455">		Jdmo jdmo = getJdmo();</span>
		try
		{
<span class="nc" id="L458">			Collection colEmployeeIDs = new LinkedList();</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">			for (Iterator i = colPlannedEvents.iterator(); i.hasNext();)</span>
			{
<span class="nc" id="L461">				Event event = (Event) i.next();</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">				if (event.getWorkResourceIDs().iterator().hasNext())</span>
				{
<span class="nc" id="L464">					ID idWorkResource = (ID) event.getWorkResourceIDs().iterator().next();</span>
<span class="nc" id="L465">					colEmployeeIDs.add(idWorkResource);</span>
				}
<span class="nc" id="L467">			}</span>
<span class="nc" id="L468">			String strQuery =</span>
<span class="nc" id="L469">				&quot;DELETE FROM PLANNEDEVENTTIMELINE WHERE WORKRESOURCEID IN &quot; + jdmo.createInClause(colEmployeeIDs);</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">			if (idPayPeriod == null)</span>
<span class="nc" id="L471">				strQuery += &quot; AND PAYPERIODID IS NULL&quot;;</span>
			else
			{
<span class="nc" id="L474">				strQuery += &quot; AND (PAYPERIODID = &quot; + idPayPeriod.toString() + &quot; OR PAYPERIODID IS NULL)&quot;;</span>
			}
<span class="nc" id="L476">			jdmo.addBatch(strQuery);</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">			for (Iterator i = colPlannedEvents.iterator(); i.hasNext();)</span>
			{
<span class="nc" id="L479">				Event event = (Event) i.next();</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">				if (!event.getWorkResourceIDs().iterator().hasNext())</span>
<span class="nc" id="L481">					continue;</span>
<span class="nc" id="L482">				ID idWorkResource = (ID) event.getWorkResourceIDs().iterator().next();</span>

<span class="nc" id="L484">				HashMap hm = new HashMap();</span>
<span class="nc" id="L485">				hm.put(&quot;WORKRESOURCEID&quot;, idWorkResource);</span>
<span class="nc" id="L486">				hm.put(&quot;IMPORTEDEVENTID&quot;, event.getID());</span>
<span class="nc" id="L487">				hm.put(&quot;ACTIVITYID&quot;, event.getActivityID());</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">				if (idPayPeriod != null)</span>
<span class="nc" id="L489">					hm.put(&quot;PAYPERIODID&quot;, idPayPeriod);</span>
<span class="nc" id="L490">				hm.put(&quot;STARTTIME&quot;, JdmoUtil.formatDBString(new Timestamp(event.getStartTime().getTime())));</span>
<span class="nc" id="L491">				hm.put(&quot;ENDTIME&quot;, JdmoUtil.formatDBString(new Timestamp(event.getEndTime().getTime())));</span>
<span class="nc" id="L492">				jdmo.addBatchInsert(&quot;PLANNEDEVENTTIMELINE&quot;, hm);</span>
<span class="nc" id="L493">			}</span>
<span class="nc" id="L494">			jdmo.executeBatch();</span>
		}
		finally
		{
<span class="nc" id="L498">			jdmo.cleanUp();</span>
<span class="nc" id="L499">		}</span>
<span class="nc" id="L500">	}</span>
	public void updateActualEventsTimeline(Collection colActualEvents, ID idPayPeriod) throws JdmoException
	{
<span class="nc" id="L503">		Jdmo jdmo = getJdmo();</span>
		try
		{
<span class="nc" id="L506">			Collection colEmployeeIDs = new LinkedList();</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">			for (Iterator i = colActualEvents.iterator(); i.hasNext();)</span>
			{
<span class="nc" id="L509">				Event event = (Event) i.next();</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">				if (event.getWorkResourceIDs().iterator().hasNext())</span>
				{
<span class="nc" id="L512">					ID idWorkResource = (ID) event.getWorkResourceIDs().iterator().next();</span>
<span class="nc" id="L513">					colEmployeeIDs.add(idWorkResource);</span>
				}
<span class="nc" id="L515">			}</span>
<span class="nc" id="L516">			String strQuery = &quot;DELETE FROM ACTUALEVENTTIMELINE WHERE EMPLOYEEID IN &quot; + jdmo.createInClause(colEmployeeIDs);</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">			if (idPayPeriod == null)</span>
<span class="nc" id="L518">				strQuery += &quot; AND PAYPERIODID IS NULL&quot;;</span>
			else
			{
<span class="nc" id="L521">				strQuery += &quot; AND (PAYPERIODID = &quot; + idPayPeriod.toString() + &quot; OR PAYPERIODID IS NULL)&quot;;</span>
			}
<span class="nc" id="L523">			jdmo.addBatch(strQuery);</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">			for (Iterator i = colActualEvents.iterator(); i.hasNext();)</span>
			{
<span class="nc" id="L526">				Event event = (Event) i.next();</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">				if (!event.getWorkResourceIDs().iterator().hasNext())</span>
<span class="nc" id="L528">					continue;</span>
<span class="nc" id="L529">				ID idWorkResource = (ID) event.getWorkResourceIDs().iterator().next();</span>

<span class="nc" id="L531">				HashMap hm = new HashMap();</span>
<span class="nc" id="L532">				hm.put(&quot;EMPLOYEEID&quot;, idWorkResource);</span>
<span class="nc" id="L533">				hm.put(&quot;TIMEENTRYEVENTID&quot;, event.getID());</span>
<span class="nc" id="L534">				hm.put(&quot;ACTIVITYID&quot;, event.getActivityID());</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">				if (idPayPeriod != null)</span>
<span class="nc" id="L536">					hm.put(&quot;PAYPERIODID&quot;, idPayPeriod);</span>
<span class="nc" id="L537">				hm.put(&quot;STARTTIME&quot;, JdmoUtil.formatDBString(new Timestamp(event.getStartTime().getTime())));</span>
<span class="nc" id="L538">				hm.put(&quot;ENDTIME&quot;, JdmoUtil.formatDBString(new Timestamp(event.getEndTime().getTime())));</span>
<span class="nc" id="L539">				jdmo.addBatchInsert(&quot;ACTUALEVENTTIMELINE&quot;, hm);</span>
<span class="nc" id="L540">			}</span>
<span class="nc" id="L541">			jdmo.executeBatch();</span>
		}
		finally
		{
<span class="nc" id="L545">			jdmo.cleanUp();</span>
<span class="nc" id="L546">		}</span>
<span class="nc" id="L547">	}</span>

	public void updateOrganizationDays() throws JdmoException
	{
<span class="nc" id="L551">		Jdmo jdmo = new Jdmo();</span>
		try
		{
<span class="nc" id="L554">			Collection colOrganizationIDsWithData = new LinkedList();</span>
<span class="nc" id="L555">			String strQuery = &quot;SELECT ORGANIZATIONID FROM ORGANIZATIONDAY&quot;;</span>
<span class="nc" id="L556">			JdmoRowset r = jdmo.createRowset(strQuery);</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">			while (r.next())</span>
			{
<span class="nc" id="L559">				ID idOrganization = r.getID(&quot;ORGANIZATIONID&quot;);</span>
<span class="nc" id="L560">				colOrganizationIDsWithData.add(idOrganization);</span>
<span class="nc" id="L561">			}</span>

<span class="nc" id="L563">			Collection colOrganizationsWithoutData = new LinkedList();</span>
<span class="nc" id="L564">			strQuery = &quot;SELECT ID, TIMEZONE, DAYBOUNDARYOFFSET FROM ORGANIZATION&quot;;</span>

<span class="nc" id="L566">			r = jdmo.createRowset(strQuery);</span>
<span class="nc" id="L567">			int nInsertCount = 0;</span>

<span class="nc bnc" id="L569" title="All 2 branches missed.">			while (r.next())</span>
			{
<span class="nc" id="L571">				ID idOrganization = r.getID(&quot;ID&quot;);</span>
<span class="nc" id="L572">				String strTimeZoneID = r.getString(&quot;TIMEZONE&quot;);</span>
<span class="nc" id="L573">				int nDayBoundaryOffset = r.getInt(&quot;DAYBOUNDARYOFFSET&quot;);</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">				if (!colOrganizationIDsWithData.contains(idOrganization))</span>
				{
<span class="nc" id="L576">					TimeZone tzLocal = TimeZone.getTimeZone(strTimeZoneID);</span>
<span class="nc" id="L577">					Calendar cal = Calendar.getInstance(tzLocal);</span>
<span class="nc" id="L578">					cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L579">					cal.set(Calendar.MINUTE, nDayBoundaryOffset);</span>
<span class="nc" id="L580">					Date dateStart1 = new Date(cal.getTime().getTime() - (1000L * 60L * 60L * 24L * 365L)); // 30 days</span>
<span class="nc" id="L581">					Date dateEnd1 = new Date(cal.getTime().getTime() + (1000L * 60L * 60L * 24L * 365L)); // 30 days</span>

<span class="nc bnc" id="L583" title="All 2 branches missed.">					for (Date date = dateStart1; date.before(dateEnd1);)</span>
					{
<span class="nc" id="L585">						Timestamp tsStart = new Timestamp(date.getTime());</span>
<span class="nc" id="L586">						Date dateIntervalEnd = new Date(date.getTime() + (1000L * 60L * 60L * 24L * 1L));</span>
<span class="nc" id="L587">						Timestamp tsEnd = new Timestamp(dateIntervalEnd.getTime());</span>

<span class="nc" id="L589">						Calendar calLocalDay = new GregorianCalendar();</span>
<span class="nc" id="L590">						calLocalDay.setTimeZone(tzLocal);</span>
<span class="nc" id="L591">						calLocalDay.setTime(date);</span>
<span class="nc" id="L592">						LocalDate localDate =</span>
							new LocalDate(
<span class="nc" id="L594">								calLocalDay.get(Calendar.YEAR),</span>
<span class="nc" id="L595">								calLocalDay.get(Calendar.MONTH),</span>
<span class="nc" id="L596">								calLocalDay.get(Calendar.DATE),</span>
								0,
								0);
<span class="nc" id="L599">						Timestamp tsLocalDay = new Timestamp(localDate.getTime(TimeZone.getTimeZone(&quot;GMT&quot;)).getTime());</span>

<span class="nc" id="L601">						HashMap hm = new HashMap();</span>
<span class="nc" id="L602">						hm.put(&quot;ORGANIZATIONID&quot;, idOrganization);</span>
<span class="nc" id="L603">						hm.put(&quot;STARTTIME&quot;, JdmoUtil.formatDBString(tsStart));</span>
<span class="nc" id="L604">						hm.put(&quot;ENDTIME&quot;, JdmoUtil.formatDBString(tsEnd));</span>
<span class="nc" id="L605">						hm.put(&quot;LOCALDAY&quot;, JdmoUtil.formatDBString(tsLocalDay));</span>
<span class="nc" id="L606">						jdmo.addBatchInsert(&quot;ORGANIZATIONDAY&quot;, hm);</span>
<span class="nc" id="L607">						date = dateIntervalEnd;</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">						if (nInsertCount++ &gt; 50)</span>
						{
<span class="nc" id="L610">							jdmo.executeBatch();</span>
<span class="nc" id="L611">							nInsertCount = 0;</span>
						}
<span class="nc" id="L613">					}</span>
				}
<span class="nc" id="L615">			}</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">			if (nInsertCount &gt; 0)</span>
<span class="nc" id="L617">				jdmo.executeBatch();</span>
		}
		finally
		{
<span class="nc" id="L621">			jdmo.cleanUp();</span>
<span class="nc" id="L622">		}</span>
<span class="nc" id="L623">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>