<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffLengthCalculatorHelper.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.timeoffcalculator</a> &gt; <span class="el_source">TimeOffLengthCalculatorHelper.java</span></div><h1>TimeOffLengthCalculatorHelper.java</h1><pre class="source lang-java linenums">/*
 * TimeOffLengthCalculatorHelper.java
 * Copyright (c) 2002, Blue Pumpkin Software, Inc.
 * All rights reserved.
 */

package com.bluepumpkin.ejb.bbm.timeoffcalculator;

import java.lang.reflect.InvocationTargetException;
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.cache.CacheUtilBBM;
import com.bluepumpkin.ejb.bbm.holiday.ejb.HolidayManager;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffDefault;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffDefaultFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourceAssignment;
import com.verint.ejb.wfm.WfmManagerFactory;

/**
 * Helper class to construct instances of a TimeOffLengthCalculator.
 *
 * See {@link com.bluepumpkin.ejb.bbm.timeoffcalculator.TimeOffLengthCalculator
 * TimeOffLengthCalculator} for more documentation.
 *
 */
public class TimeOffLengthCalculatorHelper {
<span class="nc" id="L53">	private static Category m_cat = Log.initCategory(TimeOffLengthCalculatorHelper.class.getName());</span>

	public static Map getTOAllotmentMap(ID empID) throws Exception {
<span class="nc" id="L56">		WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L57">		return ValueObjectUtil.getFieldObjectMap(EmployeeTimeOffDefaultFieldInfo.TMOFFDEFAULT_ACTIVITYID,</span>
<span class="nc" id="L58">				(ArrayList) wrm.getTOAllotmentMapForEmpIDs(Collections.singleton(empID)).get(empID));</span>
	}

	public static Map getTOAllotmentMap(Employee emp) {
		// Map of activity ID to daily/weekly default allocation map.
<span class="nc" id="L63">		Map actIDToDefAllocMap = new HashMap();</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">		for (Iterator it = emp.getTimeOffDefaults().iterator(); it.hasNext();) {</span>
<span class="nc" id="L65">			EmployeeTimeOffDefault toallot = (EmployeeTimeOffDefault) it.next();</span>
<span class="nc" id="L66">			actIDToDefAllocMap.put(toallot.getActivityID(), toallot);</span>
<span class="nc" id="L67">		}</span>
<span class="nc" id="L68">		return actIDToDefAllocMap;</span>
	}

	/**
	 * Create a TimeOffLengthCalculator given the employee id, time range,
	 * allotments and org id.
	 *
	 * See doc for {@link TimeOffLengthCalculator TimeOffLengthCalculator}
	 */
	public static TimeOffLengthCalculator getCalculator(ID empId, ID orgId, Date calcRangeStart, Date calcRangeEnd,
			Map allotments) throws BbmFinderException {
		try {
<span class="nc" id="L80">			WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L81">			ScheduleAccessManager sam = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">			if (orgId == null) {</span>
				// get organization at the start of the given calc date range.
<span class="nc" id="L84">				Map wrOrgMap = wrm.getValidWorkResourceAssignments(Collections.singleton(empId), new LocalDate(</span>
						calcRangeStart), new LocalDate(calcRangeEnd), false);
<span class="nc" id="L86">				Collection wrOrg = (Collection) wrOrgMap.get(empId);</span>
<span class="nc bnc" id="L87" title="All 4 branches missed.">				if (wrOrg != null &amp;&amp; !wrOrg.isEmpty()) {</span>
<span class="nc" id="L88">					WorkResourceAssignment wra = (WorkResourceAssignment) wrOrg.iterator().next();</span>
<span class="nc" id="L89">					orgId = wra.getOrganizationID();</span>
				}
<span class="nc bnc" id="L91" title="All 2 branches missed.">				if (orgId == null) {</span>
<span class="nc" id="L92">					orgId = Organization.ROOT_ORG_ID_OBJ;</span>
				}
			}
<span class="nc" id="L95">			Date terminationDate = getEmployeeTerminationDate(empId);</span>
			/*
			 * TODO TO CALC Performance Enhancement, Rel 7.8.1, Sameet, July
			 * 2007 ; add termination date call here
			 */
			// Get the employee allotments
<span class="nc bnc" id="L101" title="All 2 branches missed.">			if (allotments == null) {</span>
<span class="nc" id="L102">				allotments = getTOAllotmentMap(empId);</span>
			}
<span class="nc" id="L104">			Organization org = CacheUtilBBM.getOrganizationByID(orgId);</span>
<span class="nc" id="L105">			Collection hooAssignments = getHOOAssnsDuringInt(orgId, calcRangeStart, calcRangeEnd, wrm);</span>

			// obtain the last shift for the employee
<span class="nc" id="L108">			ShiftAssignment lastShift = TOCalcUtil.getLastShiftAssignment(empId, true);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">			if (lastShift == null) {</span>
<span class="nc" id="L110">				m_cat.info(TOCalcUtil</span>
<span class="nc" id="L111">						.formatEjbBundleMsg(BbmEjbBundleKey.TOCALC_USING_DEFAULT_LAST_SHIFT_FOR_EMP, empId));</span>
<span class="nc" id="L112">				lastShift = TOCalcUtil.getDefaultLastShift();</span>
			}
<span class="nc" id="L114">			Date lastShiftStart = lastShift.getStartTime();</span>

<span class="nc" id="L116">			calcRangeStart = expandTOCalcRangeStart(calcRangeStart, lastShiftStart, org);</span>
<span class="nc" id="L117">			calcRangeEnd = expandTOCalcRangeEnd(calcRangeEnd, lastShiftStart, org);</span>

			// For QA53725 (Silk 91831) - Request management page takes time to
			// load
			// Trying to load the data together than making separate calls
<span class="nc" id="L122">			Collection&lt;ShiftAssignment&gt; shiftAssignments = new ArrayList&lt;ShiftAssignment&gt;();</span>
<span class="nc" id="L123">			Collection unavailabilities = new ArrayList();</span>
<span class="nc" id="L124">			Collection timeOffDuringPeriod = new ArrayList();</span>

<span class="nc" id="L126">			Collection pubShiftAssnEvts = sam.getPublishedEventsForWorkResourceByType(Event.EVENT_TYPE_SHIFT_ASSIGNMENT</span>
					| Event.EVENT_TYPE_SHIFT_EVENT_ASSIGNMENT | Event.EVENT_TYPE_TIME_OFF, empId, calcRangeStart,
					calcRangeEnd);

			// QA 57841: fetch published shifts and unavailabilities separately
			// to get
			// unavailabilities for cases where request is after last published
			// date
<span class="nc" id="L134">			Collection unavailEvtsForEmps = sam.getEventsForWorkResourceByType(Event.EVENT_TYPE_UNAVAILABILITY, empId,</span>
					calcRangeStart, calcRangeEnd);

			// segregate the bulk loaded events by empID and eventType.
<span class="nc" id="L138">			TOCalcUtil.segregateBulkLoadedEvts(pubShiftAssnEvts, shiftAssignments, timeOffDuringPeriod);</span>

<span class="nc" id="L140">			TOCalcUtil.createUnavailsColl(unavailEvtsForEmps, unavailabilities);</span>

			// get Holidays for calculating time off (should not consider parent
			// org as holidays are not inherited)
<span class="nc" id="L144">			Collection allHolidays = getHolidaysForSelf(org, calcRangeStart, calcRangeEnd, sam);</span>

<span class="nc" id="L146">			sam.remove();</span>
<span class="nc" id="L147">			sam = null;</span>
<span class="nc" id="L148">			wrm.remove();</span>
<span class="nc" id="L149">			wrm = null;</span>
			
			
			// create the time off calculator using the seed data obtained.
<span class="nc" id="L153">			return new TimeOffLengthCalculator(empId, org, new TimeRange(calcRangeStart, calcRangeEnd),</span>
					shiftAssignments, unavailabilities, timeOffDuringPeriod,
					hooAssignments, allHolidays, lastShift, allotments, terminationDate	);

<span class="nc" id="L157">		} catch (Exception e) {</span>
<span class="nc" id="L158">			m_cat.error(&quot;Exception getting TimeOffLengthCalculator&quot;, e);</span>
<span class="nc" id="L159">			throw new BbmFinderException(e);</span>
		}
	}

	/**
	 * Adds elements to the 'destColl'. If 'destColl' is null, then srcColl
	 * becomes 'destColl'.
	 *
	 * @param origColl
	 * @param newColl
	 * @return
	 */
	private static Collection addToCollection(Collection destColl, Collection srcColl) {
<span class="nc bnc" id="L172" title="All 2 branches missed.">		if (destColl == null) {</span>
<span class="nc" id="L173">			destColl = srcColl;</span>
		} else {
<span class="nc" id="L175">			destColl.addAll(srcColl);</span>
		}

<span class="nc" id="L178">		return destColl;</span>
	}

	/** Don't construct instances of this class */
<span class="nc" id="L182">	private TimeOffLengthCalculatorHelper() {</span>
<span class="nc" id="L183">	}</span>

	/**
	 * Adjust the specified startDate to the start of the orgWeek if necessary.
	 * The adjustment is made if the startDate falls during the unscheduled
	 * period for the employee (ie. the period after the last shift assignment).
	 *
	 * @param calcRangeStart
	 * @param lastShiftStart
	 * @param org
	 * @return
	 */
	public static Date expandTOCalcRangeStart(Date calcRangeStart, Date lastShiftStart, Organization org) {
		// Expand calculator's time range if necessary. See doc in
		// TOLengthCalc.java for reason.
		//
		// RS == range Start; RE == range End; LS == Last Shift
		// Possible combinations:
		// RS &lt; LS; RE &lt; LS Range before LS; do not have to expand range.
		// RS &lt; LS; RE &gt; LS expand RE to orgWeekEnd
		// RS &gt; LS; RE &lt; LS Invalid. RS cannot be &gt; RE
		// RS &gt; LS; RE &gt; LS; RS and LS on same org week. Expand RS and RE to
		// orgWeekStart and orgWeekEnd resp.
		// RS &gt; LS; RE &gt; LS; RS and LS on diff org week Expand RS and RE to
		// orgWeekStart and orgWeek end resp.

		// RS &gt;= LS
<span class="nc bnc" id="L210" title="All 4 branches missed.">		if (lastShiftStart == null || !calcRangeStart.before(lastShiftStart)) {</span>
<span class="nc" id="L211">			calcRangeStart = TOCalcUtil.getDateForOrgWeekStart(org, calcRangeStart);</span>
		}

<span class="nc" id="L214">		return calcRangeStart;</span>
	}

	/**
	 * Adjust the specified endDate to the endDate of the orgWeek if necessary.
	 * The adjustment is made if the endDate falls during the unscheduled period
	 * for the employee (ie. the period after the last shift assignment).
	 *
	 * @param calcRangeEnd
	 * @param lastShiftStart
	 * @param org
	 * @return
	 */
	public static Date expandTOCalcRangeEnd(Date calcRangeEnd, Date lastShiftStart, Organization org) {
		// Expand calculator's time range if necessary. See doc in
		// TOLengthCalc.java for reason.
		//
		// RS == range Start; RE == range End; LS == Last Shift
		// Possible combinations:
		// RS &lt; LS; RE &lt; LS Range before LS; do not have to expand range.
		// RS &lt; LS; RE &gt; LS expand RE to orgWeekEnd
		// RS &gt; LS; RE &lt; LS Invalid. RS cannot be &gt; RE
		// RS &gt; LS; RE &gt; LS; RS and LS on same org week. Expand RS and RE to
		// orgWeekStart and orgWeekEnd resp.
		// RS &gt; LS; RE &gt; LS; RS and LS on diff org week Expand RS and RE to
		// orgWeekStart and orgWeek end resp.

		// RE &gt;= LS
<span class="nc bnc" id="L242" title="All 4 branches missed.">		if (lastShiftStart == null || !calcRangeEnd.before(lastShiftStart)) {</span>
<span class="nc" id="L243">			calcRangeEnd = TOCalcUtil.getDateForOrgWeekEnd(org, calcRangeEnd);</span>
		}

<span class="nc" id="L246">		return calcRangeEnd;</span>
	}

	/**
	 * get pub and unpub unavails during interval.
	 *
	 * @param empId
	 * @param calcRangeStart
	 * @param calcRangeEnd
	 * @param sam
	 * @return
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	private static Collection getUnavailsDuringInt(ID empId, Date calcRangeStart, Date calcRangeEnd,
			ScheduleAccessManager sam) throws BbmFinderException, RemoteException {

		// QA 57841: unpublished unavailabilities are required to get correct
		// pending numbers
		// after last published date
<span class="nc" id="L266">		Collection unPublishedUnavailabilities = sam.getEventsForWorkResourceByType(Event.EVENT_TYPE_UNAVAILABILITY,</span>
				empId, calcRangeStart, calcRangeEnd);

<span class="nc" id="L269">		return unPublishedUnavailabilities;</span>

	}

	/**
	 * get pub and unpub time Off events during interval.
	 *
	 * @param empId
	 * @param calcRangeStart
	 * @param calcRangeEnd
	 * @param sam
	 * @return
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	public static Collection getTimeOffPubDuringInt(ID empId, Date calcRangeStart, Date calcRangeEnd,
			ScheduleAccessManager sam) throws BbmFinderException, RemoteException {

		// get the timeOffEvents
<span class="nc bnc" id="L288" title="All 2 branches missed.">		if (sam == null) {</span>
			try {
<span class="nc" id="L290">				sam = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc" id="L291">			} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L292">				e.printStackTrace(); // To change body of catch statement use</span>
										// File | Settings | File Templates.
<span class="nc" id="L294">			}</span>
		}
<span class="nc" id="L296">		Collection timeOffEvents = sam.getPublishedEventsForWorkResourceByType(Event.EVENT_TYPE_TIME_OFF, empId,</span>
				calcRangeStart, calcRangeEnd);

<span class="nc" id="L299">		return timeOffEvents;</span>
	}

	/**
	 * get published shiftAssignments for interval.
	 *
	 * @param empId
	 * @param calcRangeStart
	 * @param calcRangeEnd
	 * @param sam
	 * @return
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	private static Collection getShiftAssnsPubForInterval(ID empId, Date calcRangeStart, Date calcRangeEnd,
			ScheduleAccessManager sam) throws BbmFinderException, RemoteException {

		// get list of published shift assignments.
<span class="nc" id="L317">		Collection shiftAssignments = sam.getPublishedEventsForWorkResourceByType(Event.EVENT_TYPE_SHIFT_ASSIGNMENT</span>
				| Event.EVENT_TYPE_SHIFT_EVENT_ASSIGNMENT, empId, calcRangeStart, calcRangeEnd);
<span class="nc" id="L319">		return shiftAssignments;</span>
	}

	/**
	 * Obtain holidays for self and parent orgs.
	 *
	 * @param org
	 * @param calcRangeStart
	 * @param calcRangeEnd
	 * @param sam
	 * @return
	 * @throws Exception
	 */
	public static Collection getHolidaysForSelf(Organization org, Date calcRangeStart, Date calcRangeEnd,
			ScheduleAccessManager sam) throws Exception {

<span class="nc" id="L335">		Jdmo dmo = null;</span>

<span class="nc" id="L337">		ID orgID = org.getID();</span>

		// Holidays for calculating time off
<span class="nc" id="L340">		List orgIds = new java.util.ArrayList();</span>
<span class="nc" id="L341">		orgIds.add(orgID); // add this org to the set</span>

		// Make local date objects for the start and end period
<span class="nc" id="L344">		LocalDate lclStart = new LocalDate(calcRangeStart, org.getTimeZone());</span>
<span class="nc" id="L345">		LocalDate lclEnd = new LocalDate(calcRangeEnd, org.getTimeZone());</span>

		// Get the holidays for this org and all its parents and stuff in a
		// collection
		// HolidayManager hm = BbmManagerFactory.getHolidayManager();
		// Map holidayMap = hm.getHolidays(orgIds, lclStart, lclEnd);
		// hm.remove(); hm=null;
		//Map holidayMap = CacheUtilBBM.getHolidaysForOrgs(orgIds, lclStart, lclEnd);
		
<span class="nc" id="L354">		HolidayManager hm = BbmManagerFactory.getHolidayManager();</span>
<span class="nc" id="L355">	    Map holidayMap = hm.getHolidays(orgIds, lclStart, lclEnd);</span>


<span class="nc" id="L358">		Collection allHolidays = new HashSet();</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">		for (Iterator it = holidayMap.values().iterator(); it.hasNext();) {</span>
<span class="nc" id="L360">			allHolidays.addAll((Collection) it.next());</span>
		}

<span class="nc" id="L363">		return allHolidays;</span>
	}

	/**
	 * @param orgId
	 * @param calcRangeStart
	 * @param calcRangeEnd
	 * @param wrm
	 * @return
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	private static Collection getHOOAssnsDuringInt(ID orgId, Date calcRangeStart, Date calcRangeEnd,
			WorkResourceManager wrm) throws BbmEJBCreateException, BbmFinderException, RemoteException,
			IllegalArgumentException, SecurityException, InstantiationException, IllegalAccessException,
			InvocationTargetException, NoSuchMethodException {

		// obtain the HOO for the organization
		// Collection hooAssignments = wrm.getOrganizationHOOAssignments(orgId,
		// calcRangeStart, calcRangeEnd);
		// return hooAssignments;
<span class="nc" id="L384">		Collection hooAssns = CacheUtilBBM.getOrganizationHOO(orgId, calcRangeStart, calcRangeEnd);</span>
<span class="nc" id="L385">		return hooAssns;</span>
	}

	public static Date getEmployeeTerminationDate(ID empID) throws BbmFinderException {
		try {
<span class="nc" id="L390">			WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L391">			Map empIdTerminationDateMap = wrm.getTerminatedEmployees(Collections.singleton(empID));</span>
<span class="nc" id="L392">			return (Date) empIdTerminationDateMap.get(empID);</span>
<span class="nc" id="L393">		} catch (Exception e) {</span>
<span class="nc" id="L394">			throw new BbmFinderException(e);</span>
		}
	}
	
	

	public static TimeOffLengthCalculator getCalculator(ID empId, Organization org, TimeRange range,
			Collection&lt;ShiftAssignment&gt; shiftAssignments, Collection unavailabilities, Collection timeOffs,
			Collection orgHOOAssignments, Collection holidays, ShiftAssignment lastShift, Map allotmentMap,
			Date terminationDate) {
<span class="nc" id="L404">		return new TimeOffLengthCalculator(empId, org, range, shiftAssignments, unavailabilities, timeOffs,</span>
				orgHOOAssignments, holidays, lastShift, allotmentMap, terminationDate);
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>