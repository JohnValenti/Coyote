<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.people.timeoff</a> &gt; <span class="el_source">TimeOffPC.java</span></div><h1>TimeOffPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.people.timeoff;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.TreeModel;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategory;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategoryFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityTimeOffBalance;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityTimeOffBalanceFieldInfo;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOff;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffAccrued;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffAccruedFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TOPoolAssignmentByActivity;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TOPoolUtil;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPoolAssignmentsByActivityUpdateParameters;
import com.bluepumpkin.ejb.rm.util.DAOUtil;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.people.profile.ProfileContainerIF;
import com.bluepumpkin.web.bbm.workresource.WorkResourceModelHandler;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.jsp.HtmlImage;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.table.DefaultHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.tree.MultiColTreePC;
import com.witness.web.uif.pagecomponent.tree.util.DefaultSortableTreeNodeHelper;
import com.witness.web.uif.pagecomponent.tree.util.SortableTreeNodeHelper;
import com.witness.web.uif.pagecomponent.tree.util.TreeModelBuilder;
import com.witness.web.uif.pagecomponent.tree.util.TreeNodeConverter;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpaneFieldNames;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.validator.InNumericRangeFieldValidator;
import com.witness.web.uif.validator.IsNonNegativeFieldValidator;
import com.witness.web.uif.validator.IsNumericFieldValidator;

/**
 * Title:        ProfileTimeOffPC
 * Description:  includes collapsible section of the form with contacts info fields
 *                  to use it   a) construct object
 *                              b) extract parameters
 *                              c) use getters of the field collections
 *                              d) set all fields in setData(...)
 *                              e) customize CSS class if needed
 *                              e) use getHtmlDisplay
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       Swati Tewari
 * @version      1.0
 */
public class TimeOffPC extends MultiColTreePC implements ProfileContainerIF {  
	// Form field names, for use by field validators; should begin with lowercase letter

	private static final String LAST_BALANCE_FN = &quot;lastBalance&quot;;
	private static final String LAST_DATE_FN = &quot;lastDate&quot;;
	private static final String MAX_BALANCE_FN = &quot;maxBalance&quot;;
	private static final String MAX_CARRYOVER_FN = &quot;maxCarryover&quot;;
	private static final String HOURSYEAR_FN = &quot;hoursYear&quot;;
	private static final String PERDAY_FN = &quot;perDay&quot;;
	private static final String PERWEEK_FN = &quot;perWeek&quot;;
	private static final String UNION_ID_FN = &quot;unionID&quot;;
	private static final String TIMEOFFID_FN = &quot;timeOffID&quot;;
	private static final String ACT_CAT_PREFIX = &quot;type&quot;;

	private final ResourceBundle m_bundle;
<span class="fc" id="L102">	private String m_headerCssClass = &quot;tableHeaderLightLeft&quot;;</span>

	private static final int NUM_OF_YEARS = 4;
<span class="fc" id="L105">	private boolean m_isEditable = false;</span>
<span class="fc" id="L106">	private boolean m_isMultiEdit = false;</span>
<span class="fc" id="L107">	private boolean m_hasAccrualLicense = true; </span>

<span class="fc" id="L109">	private Collection&lt;ID&gt; m_empIDs = Collections.emptyList();</span>
<span class="fc" id="L110">	private Employee m_employee = null;</span>
<span class="fc" id="L111">	private Collection m_colTimeOffs = Collections.emptyList();</span>
<span class="fc" id="L112">	private Map m_timeOffMap = Collections.emptyMap();</span>
<span class="fc" id="L113">	private Map m_rowData = Collections.emptyMap();</span>
<span class="fc" id="L114">	private int m_rowDataNum = 0;</span>
	private ID m_commonOrgID;

	private final DataUpdater m_dataUpdater;

<span class="fc" id="L119">	private final Map m_historyPopupArgsMap = new HashMap();</span>

<span class="fc" id="L121">	private transient Map&lt;ID, TOPoolAssignmentByActivity&gt; activityIDToPoolAssignment = Collections.emptyMap();</span>
<span class="fc" id="L122">	private List&lt;StringsPair&gt; commonPools = Collections.emptyList();</span>
	private Date asOfDate;
<span class="fc" id="L124">	private transient List&lt;TOPoolAssignmentsByActivityUpdateParameters&gt; modifiedAssignmentsByActivity = Collections.emptyList();</span>

	
	public TimeOffPC(RequestContext context) {
<span class="fc" id="L128">		super(context);</span>
<span class="fc" id="L129">		m_bundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L130">		m_dataUpdater = new DataUpdater(context);</span>
<span class="fc" id="L131">		this.setName(&quot;timeOffForm&quot;);</span>
<span class="fc" id="L132">		this.setIsTreeRootShown(false);</span>
<span class="fc" id="L133">		this.setMultiRowSelectable(false);</span>
<span class="fc" id="L134">		TOPoolByActivityPC.registerPopupArgs(this);</span>
<span class="fc" id="L135">	}//constructor</span>

	@Override
	public boolean isAuthorized(User user, boolean isMyProfile) {
<span class="pc bpc" id="L139" title="3 of 4 branches missed.">		return isMyProfile &amp;&amp; user.isAuthorized(PrivilegeKeys.TOM_VIEWPERSONALSUMMARY);</span>
		
	}

	/**
	 * Initialize PC with Data to be displayed
	 */
	@Override
	public void init(Collection ids, Employee emp, boolean isConfigDataOnly,
			boolean isEditable, boolean isMultiEdit, Date viewDate, PageModel model) throws Exception {
		    
<span class="nc" id="L150">		this.asOfDate = viewDate;</span>
<span class="nc" id="L151">		ID orgID = Organization.YOUR_COMPANY_ID_OBJ;</span>
<span class="nc bnc" id="L152" title="All 4 branches missed.">		if (!ids.isEmpty() &amp;&amp; ids.size() &gt; 1) {</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">			LocalDate lDate = (viewDate==null) ? new LocalDate(new Date()) : new LocalDate(viewDate);</span>
<span class="nc" id="L154">			orgID = WorkResourceModelHandler.getEmployeesCommonOrganization(m_context, ids, lDate, lDate);</span>
<span class="nc" id="L155">		} else {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">		    if (emp.getID() != null) {</span>
<span class="nc" id="L157">		    	orgID = emp.getOrganizationID();</span>
		    }
		}
		
<span class="nc" id="L161">		m_commonOrgID = orgID;</span>
<span class="nc" id="L162">		m_empIDs = ids;</span>

<span class="nc" id="L164">		m_isEditable = isEditable;</span>
<span class="nc" id="L165">		m_hasAccrualLicense = true;</span>
<span class="nc" id="L166">		initData(emp, isConfigDataOnly, isMultiEdit);</span>
<span class="nc" id="L167">		addFieldValidators(model);</span>
<span class="nc" id="L168">	}</span>

	/**
	 * Initialize Data
	 */
	@Override
	public void initData(Employee emp, boolean bMergeData, boolean isMultiEdit) {
<span class="nc" id="L175">		m_isMultiEdit = isMultiEdit;</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">		if (emp == null) </span>
<span class="nc" id="L177">		    return;</span>
<span class="nc" id="L178">		m_employee = emp;</span>
		
		
		

		// m_colTimeOffs
<span class="nc bnc" id="L184" title="All 2 branches missed.">		if (!bMergeData) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">			if (!m_isMultiEdit) {</span>
<span class="nc" id="L186">				m_colTimeOffs = m_employee.getTimeOffs();</span>
			} else {
<span class="nc" id="L188">				m_colTimeOffs = m_employee.getMultiEditTimeOffs();</span>
			}
		}

		
<span class="nc" id="L193">		m_rowData = new HashMap();</span>
<span class="nc" id="L194">		Collection&lt;Activity&gt; activities = null;</span>
<span class="nc" id="L195">		Collection&lt;ActivityCategory&gt; actCats = null;</span>
<span class="nc" id="L196">		List&lt;ID&gt; actIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L197">		Collection&lt;ID&gt; actCatIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">		if (m_commonOrgID != null) {</span>
			try {
				//get activities with isAbsence=yes
<span class="nc" id="L201">				ActivityFilter activityFilter = new ActivityFilter();</span>
<span class="nc" id="L202">				activityFilter.setTimeoff(true);</span>
<span class="nc" id="L203">				activities = ActivityModelHandler.getActivities(m_context, m_commonOrgID, activityFilter);</span>

<span class="nc" id="L205">				ActivityCategoryFilter filter = new ActivityCategoryFilter();</span>
<span class="nc" id="L206">				filter.setTimeoffWithAllotment(true);</span>
<span class="nc" id="L207">				actCats = ActivityModelHandler.getActivityCategories(m_context, m_commonOrgID, filter);</span>
<span class="nc" id="L208">			} catch (Exception ex) {</span>
<span class="nc" id="L209">			}</span>
		}
<span class="nc bnc" id="L211" title="All 2 branches missed.">		if (actCats != null) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">			for (Iterator&lt;ActivityCategory&gt; it = actCats.iterator(); it.hasNext();) {</span>
<span class="nc" id="L213">				ActivityCategory actCat = it.next();</span>
<span class="nc" id="L214">				RowData row = new RowData(actCat);</span>
<span class="nc" id="L215">				row.rowIndex = m_rowData.size();</span>
<span class="nc" id="L216">				m_rowData.put(row.unionID, row);</span>
<span class="nc" id="L217">				actCatIDs.add(actCat.getID());</span>
<span class="nc" id="L218">			}</span>
		}
<span class="nc bnc" id="L220" title="All 2 branches missed.">		if (activities != null) {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">			for (Iterator&lt;Activity&gt; it = activities.iterator(); it.hasNext();) {</span>
<span class="nc" id="L222">				Activity act = it.next();</span>
<span class="nc" id="L223">				RowData row = new RowData(act);</span>
<span class="nc" id="L224">				row.rowIndex = m_rowData.size();</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">				if (m_rowData.containsKey(row.parentID))//contains this activity's category</span>
<span class="nc" id="L226">					row.isFirstLayer = false;</span>
<span class="nc" id="L227">				m_rowData.put(row.unionID, row);</span>
<span class="nc" id="L228">				actIDs.add(act.getID());</span>
<span class="nc" id="L229">			}</span>
		}
<span class="nc" id="L231">		m_rowDataNum = m_rowData.size();</span>

		// EmployeeTimeOffAccrued &amp; ActivityTimeOffBalance
<span class="nc bnc" id="L234" title="All 2 branches missed.">		if (m_rowDataNum &gt; 0) {//when m_commonOrgID == null</span>
			try {
<span class="nc" id="L236">				Collection toAccrueds = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode()).getLastUpdatedTOAccrued(</span>
						m_empIDs, actIDs, actCatIDs);
<span class="nc" id="L238">				Collection toBalances = WfmManagerFactory.getActivityManager(m_context.isInWhatIfMode()).getTOBalanceForActivities(</span>
						m_empIDs, actIDs, actCatIDs);
<span class="nc bnc" id="L240" title="All 2 branches missed.">				for (Iterator it = toAccrueds.iterator(); it.hasNext();) {</span>
<span class="nc" id="L241">					EmployeeTimeOffAccrued toAccrued = (EmployeeTimeOffAccrued) it.next();</span>
<span class="nc" id="L242">					ID unionID = getUnionID(toAccrued.getActivityID(), toAccrued.getActivityCategoryId());</span>
<span class="nc" id="L243">					RowData row = (RowData) m_rowData.get(unionID);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">					if (row != null) {</span>
<span class="nc" id="L245">						row.toAccrueds.add(toAccrued);</span>
					}
<span class="nc" id="L247">				}</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">				for (Iterator it = toBalances.iterator(); it.hasNext();) {</span>
<span class="nc" id="L249">					ActivityTimeOffBalance toBalance = (ActivityTimeOffBalance) it.next();</span>
<span class="nc" id="L250">					ID unionID = getUnionID(toBalance.getActivityID(), toBalance.getActivityCategoryId());</span>
<span class="nc" id="L251">					RowData row = (RowData) m_rowData.get(unionID);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">					if (row != null) {</span>
<span class="nc" id="L253">						row.toBalances.add(toBalance);</span>
					}
<span class="nc" id="L255">				}</span>
<span class="nc" id="L256">			} catch (Exception ex) {</span>
<span class="nc" id="L257">			}</span>
		}

		try {
<span class="nc" id="L261">			loadTimeOffPoolByActivityData(activities);</span>
<span class="nc" id="L262">		} catch (Exception ex) {</span>
<span class="nc" id="L263">			this.handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L264">		}</span>

<span class="nc" id="L266">	}</span>

	private void loadTimeOffPoolByActivityData(Collection&lt;Activity&gt; activities) throws Exception {
<span class="nc bnc" id="L269" title="All 8 branches missed.">		if (activities == null || activities.isEmpty() || !LicenseUtil.isAdvancedRMLicense() || asOfDate == null) {</span>
			//initData is called twice. Once from extract parameters and once when loading the data
			//we need to initialize this only when loading data
<span class="nc" id="L272">			return;</span>
		}
<span class="nc" id="L274">		List&lt;ID&gt; activitesWithPools = DAOUtil.valueObjectsToIdList(ActivityModelHandler.getActivitiesWithTOPools(m_context, activities));</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">		if (activitesWithPools.isEmpty()) {</span>
<span class="nc" id="L276">			return;</span>
		}

<span class="nc" id="L279">		activityIDToPoolAssignment = TOPoolUtil.getTOPoolAssignmentForDisplay(this.m_empIDs, this.asOfDate, activitesWithPools);</span>
<span class="nc" id="L280">		commonPools = TOPoolUtil.getCommonPoolsAsStringPairs(m_empIDs, asOfDate);</span>
<span class="nc" id="L281">	}</span>

	private Collection getEmployeeTimeOffs() {
<span class="nc" id="L284">		return m_colTimeOffs;</span>
	}

	/**
	 * Adds field validators to the page model
	 *
	 * @param pageModel is the page model which contains this component
	 *
	 * Pre-condition: initData has to be called first
	 */
	public void addFieldValidators(PageModel pageModel) {
<span class="nc bnc" id="L295" title="All 4 branches missed.">		if (!isEnabled() || !m_isEditable) return;</span>

<span class="nc" id="L297">		String bName = BbmWebBundleKey.BUNDLE_NAME;</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">		for (Iterator it = m_rowData.values().iterator(); it.hasNext();) {</span>
<span class="nc" id="L299">			RowData rowData = (RowData) it.next();</span>
<span class="nc" id="L300">			int i = rowData.rowIndex;</span>

<span class="nc bnc" id="L302" title="All 2 branches missed.">			if (rowData.isFirstLayer) {</span>
<span class="nc bnc" id="L303" title="All 4 branches missed.">				if (m_hasAccrualLicense &amp;&amp; rowData.isTOAllotment) {</span>
					//Last updated
<span class="nc" id="L305">					pageModel.addValidator(new IsNumericFieldValidator(this, LAST_BALANCE_FN + i, BbmWebBundleKey.LastUpdatedBalance, bName));</span>
					//Max Balance &amp; Carryover
<span class="nc" id="L307">					pageModel.addValidator(new IsNonNegativeFieldValidator(this, MAX_BALANCE_FN + i, BbmWebBundleKey.MaxBalance, bName));</span>
<span class="nc" id="L308">					pageModel.addValidator(new IsNonNegativeFieldValidator(this, MAX_CARRYOVER_FN + i, BbmWebBundleKey.MaxCarryover, bName));</span>
				}
<span class="nc bnc" id="L310" title="All 2 branches missed.">				if (rowData.isTOAllotment) {</span>
					//allotment: this year
<span class="nc bnc" id="L312" title="All 2 branches missed.">					for (int index = 0; index &lt; NUM_OF_YEARS; index++) {</span>
<span class="nc" id="L313">						String yearFN = HOURSYEAR_FN + index + &quot;_&quot; + i;</span>
<span class="nc" id="L314">						pageModel.addValidator(new IsNumericFieldValidator(this, yearFN, BbmWebBundleKey.ThisYear, bName));</span>
<span class="nc" id="L315">						pageModel.addValidator(new InNumericRangeFieldValidator(this, yearFN, BbmWebBundleKey.ThisYear, bName, 0.0, 8760.0, m_localizer));</span>
<span class="nc" id="L316">						pageModel.addValidator(new IsNonNegativeFieldValidator(this, yearFN, BbmWebBundleKey.ThisYear, bName));</span>
					}
				}
			}

<span class="nc bnc" id="L321" title="All 2 branches missed.">			if (rowData.act != null) {</span>
				//default per day
<span class="nc" id="L323">				String dayFN = PERDAY_FN + &quot;R&quot; + i;</span>
<span class="nc" id="L324">				pageModel.addValidator(new IsNumericFieldValidator(</span>
						this, dayFN, BbmWebBundleKey.DefaultPerDay, bName));
<span class="nc" id="L326">				pageModel.addValidator(new InNumericRangeFieldValidator(</span>
						this, dayFN, BbmWebBundleKey.DefaultPerDay, bName, 0.0, 24.0, m_localizer));
<span class="nc" id="L328">				pageModel.addValidator(new IsNonNegativeFieldValidator(</span>
						this, dayFN, BbmWebBundleKey.DefaultPerDay, bName));

				//default per week
<span class="nc" id="L332">				String weekFN = PERWEEK_FN + &quot;R&quot; + i;</span>
<span class="nc" id="L333">				pageModel.addValidator(new IsNumericFieldValidator(</span>
						this, weekFN, BbmWebBundleKey.DefaultPerWeek, BbmWebBundleKey.BUNDLE_NAME));
<span class="nc" id="L335">				pageModel.addValidator(new InNumericRangeFieldValidator(</span>
						this, weekFN, BbmWebBundleKey.DefaultPerWeek, BbmWebBundleKey.BUNDLE_NAME, 0.0, 168.0, m_localizer));
<span class="nc" id="L337">				pageModel.addValidator(new IsNonNegativeFieldValidator(</span>
						this, weekFN, BbmWebBundleKey.DefaultPerWeek, bName));
			}
<span class="nc" id="L340">		}</span>
<span class="nc" id="L341">	}</span>
	
	
	


	/**
	 * Page Model should invoke this method in getCustomJavaScript().
	 *
	 * It generates JavaScript Validation to make sure default per week is &gt; than per day.
	 * v11.2 Added validation for having a last date if there is a last balance.
	 */
	public String getCustomValidateFormJS() {
<span class="nc bnc" id="L354" title="All 2 branches missed.">		if (m_isEditable) {</span>
<span class="nc" id="L355">			return &quot;function customValidateForm() {\n&quot; +</span>
					&quot;  for (var i=0; i&lt;&quot;+ m_rowDataNum+&quot;; i++) {\n&quot; +
					&quot;    var eDayFN = \&quot;&quot; + PERDAY_FN + &quot;R\&quot; + i;\n&quot; +
					&quot;    var eWeekFN = \&quot;&quot; + PERWEEK_FN + &quot;R\&quot; + i;\n&quot; +
					&quot;    var eLastBalanceFN = \&quot;&quot; + LAST_BALANCE_FN + &quot;\&quot; + i;\n&quot; +
					&quot;    var eLastDateFN = \&quot;&quot; + LAST_DATE_FN + &quot;\&quot; + i;\n&quot; +
					&quot;    var eDay = DOM2.getElementById(eDayFN);\n&quot;+
					&quot;    var eWeek = DOM2.getElementById(eWeekFN);\n&quot;+
					&quot;    var eLastBalance = DOM2.getElementById(eLastBalanceFN);\n&quot;+
					&quot;    var eLastDate = DOM2.getElementById(eLastDateFN);\n&quot;+
					&quot;&quot;	+
					&quot;    if (eLastBalance &amp;&amp; eLastBalance.value != '' &amp;&amp;  (eLastDate &amp;&amp; eLastDate.value == '' )) {\n&quot;+
<span class="nc" id="L367">					&quot;	alert(\&quot;&quot; + i18n(m_bundle, BbmWebBundleKey.INCOMPLETE_LAST_UPDATE_MSG) +&quot;\&quot;);\n&quot; +</span>
					&quot;	eLastDate.focus();\n&quot; +
					&quot;	return false;\n&quot; +
					&quot;	}\n&quot; +
					&quot;&quot;	+
					&quot;    if (eLastDate &amp;&amp; eLastDate.value != '' &amp;&amp;  (eLastBalance &amp;&amp; eLastBalance.value == '' )) {\n&quot;+
<span class="nc" id="L373">					&quot;	alert(\&quot;&quot; + i18n(m_bundle, BbmWebBundleKey.INCOMPLETE_LAST_UPDATE_MSG) +&quot;\&quot;);\n&quot; +</span>
					&quot;	eLastBalance.focus();\n&quot; +
					&quot;	return false;\n&quot; +
					&quot;	}\n&quot; +
					&quot;&quot;	+
					&quot;    if (!eDay || !eWeek) {continue;}\n&quot;+
					&quot;    if (eDay.value != '' &amp;&amp; eWeek.value == ''){\n&quot;+
<span class="nc" id="L380">					&quot;      alert(\&quot;&quot; + i18n(m_bundle, BbmWebBundleKey.REQUIRED_DEFAULT_WEEK_MSG) +&quot;\&quot;);\n&quot; +</span>
					&quot;      eWeek.focus();\n&quot; +
					&quot;      return false;\n&quot; +
					&quot;    }\n&quot; +
					&quot;    if (eDay.value == '' &amp;&amp; eWeek.value != ''){\n&quot;+
<span class="nc" id="L385">					&quot;      alert(\&quot;&quot; + i18n(m_bundle, BbmWebBundleKey.REQUIRED_DEFAULT_DAY_MSG) +&quot;\&quot;);\n&quot; +</span>
					&quot;      eDay.focus();\n&quot; +
					&quot;      return false;\n&quot; +
					&quot;    }\n&quot; +
					&quot;    if (eDay.value &amp;&amp; eWeek.value &amp;&amp; parseFloat(eWeek.value) &lt; parseFloat(eDay.value)) {\n&quot; +
					&quot;      eWeek.select();eWeek.focus();\n&quot; +
<span class="nc" id="L391">					&quot;      alert(\&quot;&quot; + i18n(m_bundle, BbmWebBundleKey.DEFAULT_WEEK_LESS_THAN_DAY_MSG) +&quot;\&quot;);\n&quot; +</span>
					&quot;      return false;\n&quot; +
					&quot;    }\n&quot; +
					&quot;  }\n&quot; +
					&quot;  return true;\n&quot; +
					&quot;}\n&quot;;
			
			
		} else {
<span class="nc" id="L400">			return &quot;&quot;;</span>
		}
	}

	//====================== data ========================================
	/**
	 * customize CSS class
	 */
	public void setCssClass(String sCssClass) {
<span class="nc" id="L409">		m_headerCssClass = sCssClass;</span>
<span class="nc" id="L410">	}//setCssClasses</span>

	public void setIsEditable(boolean isEditable) {
<span class="nc" id="L413">		m_isEditable = isEditable;</span>
<span class="nc" id="L414">	}</span>

	//====================== extracting data ========================================

	/**
	 * Overwrite ExtractParameters to check for component name
	 * @param request The HttpRequest
	 * @return true if no errors were encountered, otherwise false
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {

		//When not editable, avoid extractParameters() and therefore alter data in m_employee object.
		//Because posting data in MyProfile page, although not modified, can result in an Exception. (QC#48185)
		//So here as an easy fix, we avoid extractParameters() when this PC is not editable. (By Default)
		//On the other hand, TimeOffPM will need to enable Editable for this PC, to properly extractParameters() for update.
<span class="nc bnc" id="L430" title="All 2 branches missed.">		if (!m_isEditable) </span>
<span class="nc" id="L431">		    return true;</span>

<span class="nc" id="L433">		m_colTimeOffs = new ArrayList();</span>

		//reset multiedit
		//(&quot;selectedID&quot;);
<span class="nc" id="L437">		String sTmp = request.getParameter(WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN);</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">		if (!StringUtil.isEmpty(sTmp)) {</span>
<span class="nc" id="L439">			m_empIDs = StringUtil.parseIDStringToCollection(sTmp);</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">			if (m_empIDs.size() &gt; 1)</span>
<span class="nc" id="L441">				m_isMultiEdit = true;</span>
		}

<span class="nc" id="L444">		m_dataUpdater.clear();</span>

<span class="nc" id="L446">		int i = 0;</span>
		
<span class="nc bnc" id="L448" title="All 2 branches missed.">		while (request.getParameter(UNION_ID_FN + &quot;R&quot; + i) != null) {</span>
<span class="nc" id="L449">			EmployeeTimeOff tmpTimeOff = new EmployeeTimeOff();</span>

<span class="nc" id="L451">			boolean bNewRecord = true;</span>
<span class="nc" id="L452">			boolean bNewRecordEntered = false;</span>

<span class="nc" id="L454">			double val = 0.00;</span>
			//ID
<span class="nc" id="L456">			sTmp = request.getParameter(TIMEOFFID_FN + &quot;R&quot; + i);</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">			if (!StringUtil.isEmpty(sTmp)) {</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">				if (sTmp.length() &gt; 0) {</span>
<span class="nc" id="L459">					bNewRecord = false;</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">					if (m_isMultiEdit) {</span>
<span class="nc" id="L461">						tmpTimeOff.setMultiEditIDsInString(sTmp);</span>
					} else {
<span class="nc" id="L463">						tmpTimeOff.setIDInString(sTmp);</span>
					}
				}
			}

			//activityID &amp; activityCategoryID
<span class="nc" id="L469">			sTmp = request.getParameter(UNION_ID_FN + &quot;R&quot; + i);</span>
<span class="nc" id="L470">			ID unionID = new ID(sTmp);</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">			if (!StringUtil.isEmpty(sTmp)) </span>
			{
<span class="nc" id="L473">				ID[] solvedIDs = solveUnionID(unionID);</span>
				
<span class="nc bnc" id="L475" title="All 2 branches missed.">				if (solvedIDs[0] != null)</span>
				{
<span class="nc" id="L477">					tmpTimeOff.setActivityID(solvedIDs[0]);</span>
				}
				
<span class="nc bnc" id="L480" title="All 2 branches missed.">				if (solvedIDs[1] != null)</span>
				{
<span class="nc" id="L482">					tmpTimeOff.setActivityCategoryID(solvedIDs[1]);</span>
					
<span class="nc bnc" id="L484" title="All 2 branches missed.">					if (solvedIDs[0] == null)</span>
					{
<span class="nc" id="L486">						tmpTimeOff.setActivityID(null);</span>
					}
				}
			}

			//Last updated
			String sTmp1, sTmp2;
<span class="nc" id="L493">			sTmp1 = request.getParameter(LAST_BALANCE_FN + i);</span>
<span class="nc" id="L494">			sTmp2 = request.getParameter(LAST_DATE_FN + i);</span>
<span class="nc bnc" id="L495" title="All 4 branches missed.">			if (sTmp1 != null || sTmp2 != null)</span>
<span class="nc" id="L496">				m_dataUpdater.putTOAccrued(unionID, sTmp1, sTmp2);</span>

			//Max Balance &amp; Carryover
<span class="nc" id="L499">			sTmp1 = request.getParameter(MAX_BALANCE_FN + i);</span>
<span class="nc" id="L500">			sTmp2 = request.getParameter(MAX_CARRYOVER_FN + i);</span>
<span class="nc bnc" id="L501" title="All 4 branches missed.">			if (sTmp1 != null || sTmp2 != null)</span>
<span class="nc" id="L502">				m_dataUpdater.putTOBalance(unionID, sTmp1, sTmp2);</span>

			//yearly data
<span class="nc bnc" id="L505" title="All 2 branches missed.">			for (int index = 0; index &lt; NUM_OF_YEARS; index++) {</span>
<span class="nc" id="L506">				sTmp = request.getParameter(HOURSYEAR_FN + index + &quot;_&quot; + i);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">				sTmp = (StringUtil.isEmpty(sTmp)) ? &quot;0&quot; : sTmp;</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">				if (bNewRecord){</span>
<span class="nc" id="L509">					bNewRecordEntered = true;</span>
				}
<span class="nc bnc" id="L511" title="All 2 branches missed.">				if (!sTmp.equals(&quot;*&quot;)) {</span>
<span class="nc" id="L512">					val = FormInputPC.convertLocalizedRealNumber(sTmp, m_localizer);</span>
<span class="nc" id="L513">					tmpTimeOff.setAccrualRateByYear(index, val);</span>
					
				} else {//multiple
<span class="nc" id="L516">					tmpTimeOff.setFieldMultiValue(EmployeeTimeOffFieldInfo.EMPTIMEOFF_ACCRUALRATE_YEAR1 + index);</span>
				}
			}

			//per day
<span class="nc" id="L521">			sTmp = request.getParameter(PERDAY_FN + &quot;R&quot; + i);</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">			sTmp = (StringUtil.isEmpty(sTmp)) ? &quot;0&quot; : sTmp;</span>
<span class="nc bnc" id="L523" title="All 4 branches missed.">			if (bNewRecord &amp;&amp; sTmp.length() &gt; 0){</span>
<span class="nc" id="L524">				bNewRecordEntered = true;</span>
			}
<span class="nc bnc" id="L526" title="All 2 branches missed.">			if (!sTmp.equals(&quot;*&quot;)) {</span>
<span class="nc" id="L527">				val = FormInputPC.convertLocalizedRealNumber(sTmp, m_localizer);</span>
<span class="nc" id="L528">				tmpTimeOff.setHoursPerDay(val);</span>
			} else {//multiple
<span class="nc" id="L530">				tmpTimeOff.setFieldMultiValue(EmployeeTimeOffFieldInfo.EMPTIMEOFF_HOURSPERDAY);</span>
			}

			//per week
<span class="nc" id="L534">			sTmp = request.getParameter(PERWEEK_FN + &quot;R&quot; + i);</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">			sTmp = (StringUtil.isEmpty(sTmp)) ? &quot;0&quot; : sTmp;</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">			if (bNewRecord){</span>
<span class="nc" id="L537">				bNewRecordEntered = true;</span>
			}
<span class="nc bnc" id="L539" title="All 2 branches missed.">			if (!sTmp.equals(&quot;*&quot;)) {</span>
<span class="nc" id="L540">				val = FormInputPC.convertLocalizedRealNumber(sTmp, m_localizer);</span>
<span class="nc" id="L541">				tmpTimeOff.setHoursPerWeek(val);</span>
			} else {//multiple
<span class="nc" id="L543">				tmpTimeOff.setFieldMultiValue(EmployeeTimeOffFieldInfo.EMPTIMEOFF_HOURSPERWEEK);</span>
			}

<span class="nc" id="L546">			m_colTimeOffs.add(tmpTimeOff);</span>
<span class="nc bnc" id="L547" title="All 4 branches missed.">			if (!bNewRecord || bNewRecordEntered) </span>
			{
<span class="nc bnc" id="L549" title="All 2 branches missed.">				if (!m_isMultiEdit) </span>
				{
					//This IF is useless, currently updateTimeOff() is same as addTimeOff().
					//Thus, updateTimeOff() may add redundant Objects, Rick Sun 10/30/2009
<span class="nc" id="L553">					ArrayList empTimeOffs = m_employee.getTimeOffs();</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">					if (!empTimeOffsContains(empTimeOffs, tmpTimeOff))</span>
<span class="nc" id="L555">						m_employee.addTimeOff(tmpTimeOff);</span>
					
				}
			}
<span class="nc" id="L559">			i++;</span>
<span class="nc" id="L560">		}//for</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">		if (m_isMultiEdit) {</span>
<span class="nc" id="L562">			m_employee.setMultiEditTimeOffs(m_colTimeOffs);</span>
		}

<span class="nc" id="L565">		modifiedAssignmentsByActivity = TOPoolByActivityPC.extractFromRequest(request, m_context.getViewingTimeZone());</span>

<span class="nc" id="L567">		return true;</span>
	}//extractParameters

	/**
	 * Check if a list of EmployeeTimeOff objects contains the specified EmployeeTimeOff object.
	 * We do not check ID's, only the accrual values.
	 */
	private boolean empTimeOffsContains(ArrayList empTimeOffs, EmployeeTimeOff to)
	{
<span class="nc bnc" id="L576" title="All 2 branches missed.">		if (empTimeOffs == null)</span>
<span class="nc" id="L577">			return false;</span>
		
<span class="nc bnc" id="L579" title="All 2 branches missed.">		for (Iterator it=empTimeOffs.iterator(); it.hasNext();)</span>
		{	
<span class="nc" id="L581">			EmployeeTimeOff eto = (EmployeeTimeOff)it.next();</span>
			
<span class="nc bnc" id="L583" title="All 4 branches missed.">			if (eto==null &amp;&amp; to==null)</span>
<span class="nc" id="L584">				return true;</span>
			
<span class="nc bnc" id="L586" title="All 4 branches missed.">			if (eto==null || to==null)</span>
<span class="nc" id="L587">				continue;</span>

<span class="nc bnc" id="L589" title="All 2 branches missed.">			if ( areBothNullOrEqual(eto.getEmployeeID(), to.getEmployeeID()) &amp;&amp;</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">				 areBothNullOrEqual(eto.getActivityID(), to.getActivityID()) &amp;&amp;</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">				 areBothNullOrEqual(eto.getActivityName(), to.getActivityName()) &amp;&amp;</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">				 areBothNullOrEqual(eto.getAccrualRateByYearInObject(0), to.getAccrualRateByYearInObject(0)) &amp;&amp;</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">				 areBothNullOrEqual(eto.getAccrualRateByYearInObject(1), to.getAccrualRateByYearInObject(1)) &amp;&amp;</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">				 areBothNullOrEqual(eto.getAccrualRateByYearInObject(2), to.getAccrualRateByYearInObject(2)) &amp;&amp;</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">				 areBothNullOrEqual(eto.getAccrualRateByYearInObject(3), to.getAccrualRateByYearInObject(3)) &amp;&amp;</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">				 areBothNullOrEqual(eto.getAccrualRateByYearInObject(4), to.getAccrualRateByYearInObject(4)) &amp;&amp;</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">				 areBothNullOrEqual(eto.getActivityCategoryID(), to.getActivityCategoryID()) )//NOSONAR</span>
<span class="nc" id="L598">				return true;</span>
<span class="nc" id="L599">		}</span>
<span class="nc" id="L600">		return false;</span>
	}
	
	/**
	 * Return true if both objects are null or if both are equal.
	 * @param val1
	 * @param val2
	 * @return
	 */
	private boolean areBothNullOrEqual(Object val1, Object val2)
	{
<span class="nc bnc" id="L611" title="All 4 branches missed.">		if (val1==null &amp;&amp; val2==null)</span>
<span class="nc" id="L612">			return true;</span>
		
<span class="nc bnc" id="L614" title="All 4 branches missed.">		if (val1==null || val2==null)</span>
<span class="nc" id="L615">			return false;</span>

<span class="nc bnc" id="L617" title="All 2 branches missed.">		if (val1.equals(val2))</span>
<span class="nc" id="L618">			return true;</span>
		
<span class="nc" id="L620">		return false;</span>
	}
	
	/**
	 * Initialize Component For Display
	 */
	@Override
	public void initForDisplay() {
<span class="nc bnc" id="L628" title="All 2 branches missed.">		if (m_isInitializedForDisplay) </span>
<span class="nc" id="L629">		    return;</span>
		else {
<span class="nc" id="L631">			super.initForDisplay();</span>
<span class="nc" id="L632">			initContent();</span>
		}
<span class="nc" id="L634">	}</span>

	private void initContent() {
		// Initialize headers
<span class="nc" id="L638">		initHeader();</span>

		//  set form fields
<span class="nc" id="L641">		Collection colTimeOffs = getEmployeeTimeOffs();</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">		if (colTimeOffs == null){</span>
<span class="nc" id="L643">			colTimeOffs = new ArrayList();</span>
		}
		//create hashmap of EmployeetimeOff objects
<span class="nc" id="L646">		createMap(colTimeOffs);</span>

		//build Tree
		//This empty root won't be shown
<span class="nc" id="L650">		RowData rootData = new RowData(new ActivityCategory());</span>
		// QC 69951 Activity Types no longer alphabetized: replace DefaultTreeNodeHelper with DefaultSortableTreeNodeHelper
<span class="nc" id="L652">		SortableTreeNodeHelper treeNodeHelper = new DefaultSortableTreeNodeHelper(m_rowData.values(), rootData,</span>
				new RowDataConvertor());
<span class="nc" id="L654">		TreeModel treeModel = TreeModelBuilder.buildTreeModel(treeNodeHelper,</span>
<span class="nc" id="L655">								new int[]{0}, m_headerPC.isAscending(), m_localizer);		</span>
<span class="nc" id="L656">		setTreeModel(treeModel);</span>

		//For all Popup Args stored in m_popupArgsMap (during build tree process), add them.
<span class="nc" id="L659">		realizeHistoryPopupArgs();</span>
<span class="nc" id="L660">	}</span>

	private void storeHistoryPopupArgs(String sCmd, String sParam) {
<span class="nc" id="L663">		m_historyPopupArgsMap.put(sCmd, sParam);</span>
<span class="nc" id="L664">	}</span>

	private void realizeHistoryPopupArgs() {
<span class="nc bnc" id="L667" title="All 2 branches missed.">		for (Iterator it = m_historyPopupArgsMap.entrySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L668">			Map.Entry entry = (Map.Entry) it.next();</span>
<span class="nc" id="L669">			String sCmd   = (String) entry.getKey();</span>
<span class="nc" id="L670">			String sParam = (String) entry.getValue();</span>
<span class="nc" id="L671">			addPopupArgs(sCmd, &quot;to_accrued_history_pu&quot;, sParam, WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN,</span>
					&quot;720,480,ctr,ctr&quot;, true, 1);
<span class="nc" id="L673">		}</span>
<span class="nc" id="L674">	}</span>

	private HtmlImage buildHistoryPopupButton(String sCmd) {
<span class="nc" id="L677">		String onClick = &quot;pageMediator.popupWindow('&quot; + sCmd + &quot;', pageMediator);&quot;;</span>
<span class="nc" id="L678">		HtmlImage btnImage = new HtmlImage(ImageFileID.EDIT);</span>
<span class="nc" id="L679">		btnImage.setAttribute(&quot;class&quot;, CSSUtil.CLASS_HAND_CURSOR);</span>
<span class="nc" id="L680">		btnImage.setAlign(&quot;absmiddle&quot;);</span>
<span class="nc" id="L681">		btnImage.setAlt(m_localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_ACCRUED_HISTORY));</span>
<span class="nc" id="L682">		btnImage.setOnClick(onClick);</span>
<span class="nc" id="L683">		return btnImage;</span>
	}

	private DefaultMultiColumnNodeData toNodeData(RowData rowData, boolean editable) {
<span class="nc" id="L687">		ArrayList&lt;Object&gt; cols = new ArrayList&lt;Object&gt;();</span>

		//id and name of activity type and number of items
<span class="nc" id="L690">		String activityName = rowData.name;</span>
<span class="nc" id="L691">		String[] yearVal = new String[NUM_OF_YEARS];</span>
<span class="nc" id="L692">		String perDayVal = &quot;&quot;;</span>
<span class="nc" id="L693">		String perWeekVal = &quot;&quot;;</span>
<span class="nc" id="L694">		String timeOffID = null;</span>
		
		
		//get value from hashmap
<span class="nc bnc" id="L698" title="All 2 branches missed.">		if (m_timeOffMap.containsKey(rowData.unionID)) {</span>
			//set values from the map
<span class="nc" id="L700">			EmployeeTimeOff timeOff = (EmployeeTimeOff) m_timeOffMap.get(rowData.unionID);</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">			for (int index = 0; index &lt; NUM_OF_YEARS; index++) {</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">				if (timeOff.getAccrualRateByYearInObject(index) != null) {</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">						if (timeOff.getAccrualRateByYear(index) != 0.0){</span>
<span class="nc" id="L704">							yearVal[index] = formatDecimal(2, timeOff.getAccrualRateByYear(index));</span>
						}
					
<span class="nc bnc" id="L707" title="All 2 branches missed.">				} else if (timeOff.getEmployeeID() == null) {</span>
<span class="nc" id="L708">					yearVal[index] = &quot;*&quot;;</span>
				}
			}
<span class="nc bnc" id="L711" title="All 2 branches missed.">			if (!timeOff.isFieldMultiValue(EmployeeTimeOffFieldInfo.EMPTIMEOFF_HOURSPERDAY)) {</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">				if (timeOff.getHoursPerDay() != 0.0)</span>
<span class="nc" id="L713">					perDayVal = formatDecimal(2, timeOff.getHoursPerDay());</span>
			} else {
<span class="nc" id="L715">				perDayVal = &quot;*&quot;;</span>
			}
<span class="nc bnc" id="L717" title="All 2 branches missed.">			if (!timeOff.isFieldMultiValue(EmployeeTimeOffFieldInfo.EMPTIMEOFF_HOURSPERWEEK)) {</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">				if (timeOff.getHoursPerWeek() != 0.0)</span>
<span class="nc" id="L719">					perWeekVal = formatDecimal(2, timeOff.getHoursPerWeek());</span>
			} else {
<span class="nc" id="L721">				perWeekVal = &quot;*&quot;;</span>
			}
<span class="nc bnc" id="L723" title="All 2 branches missed.">			if (!m_isMultiEdit) {</span>
<span class="nc" id="L724">				timeOffID = timeOff.getIDInString();</span>
			} else {
<span class="nc" id="L726">				timeOffID = timeOff.getMultiEditIDsInString();</span>
			}
		}

<span class="nc" id="L730">		int i = rowData.rowIndex;</span>
<span class="nc" id="L731">		StringBuilder aBuf = new StringBuilder(512);</span>
<span class="nc" id="L732">		aBuf.append(activityName);</span>
<span class="nc" id="L733">		aBuf.append(HtmlUtil.makeHiddenInput(UNION_ID_FN, i, rowData.unionID.toString()));</span>
<span class="nc" id="L734">		aBuf.append(HtmlUtil.makeHiddenInput(TIMEOFFID_FN, i, timeOffID));</span>
		//Time Off Type
<span class="nc" id="L736">		cols.add(aBuf.toString());</span>

<span class="nc bnc" id="L738" title="All 2 branches missed.">		if (shouldShowTimeOffPoolByActivity()) {</span>
<span class="nc" id="L739">			setupNodeDataForTimeOffPools(rowData, editable, cols, i);</span>
		}
		
		//default per day
<span class="nc" id="L743">		String dayFN = PERDAY_FN + &quot;R&quot; + i;</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">		if (rowData.act != null) {</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">			if (editable) {</span>
<span class="nc" id="L746">				cols.add(HtmlUtil.makeTextInput(dayFN, 5, 8, perDayVal, null, null, true, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.DefaultPerDay)));</span>
			} else {
<span class="nc" id="L748">				cols.add(HtmlUtil.makeTextInput(dayFN, 5, 0, perDayVal, null, null, false, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.DefaultPerDay)));</span>
			}
		} else {
<span class="nc" id="L751">			cols.add(&quot;&quot;);</span>
		}

		//default per week
<span class="nc" id="L755">		String weekFN = PERWEEK_FN + &quot;R&quot; + i;</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">		if (rowData.act != null) {</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">			if (editable) {</span>
<span class="nc" id="L758">				cols.add(HtmlUtil.makeTextInput(weekFN, 5, 8, perWeekVal, null, null, true, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.DefaultPerWeek)));</span>
			} else {
<span class="nc" id="L760">				cols.add(HtmlUtil.makeTextInput(weekFN, 5, 0, perWeekVal, null, null, false, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.DefaultPerWeek)));</span>
			}
		} else {
<span class="nc" id="L763">			cols.add(&quot;&quot;);</span>
		}

		//Only show accrual fields if has Accrual License
<span class="nc bnc" id="L767" title="All 2 branches missed.">		if (m_hasAccrualLicense) {</span>

			//Accrual Schedule
<span class="nc bnc" id="L770" title="All 4 branches missed.">			if (rowData.isFirstLayer &amp;&amp; rowData.isTOAllotment){</span>
<span class="nc" id="L771">				cols.add(ActivityModelHandler.getAccrualScheduleStr(m_localizer, rowData.accrualSchedule));</span>
			} else{
<span class="nc" id="L773">				cols.add(&quot;&quot;);</span>
			}
			
			//Last updated
<span class="nc bnc" id="L777" title="All 2 branches missed.">			if (rowData.isFirstLayer) {</span>
<span class="nc" id="L778">				String lastBalance = null;</span>
<span class="nc" id="L779">				String lastDate = null;</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">				if (rowData.toAccrueds.size() &lt; m_empIDs.size()) {//some of emps have empty values</span>
<span class="nc" id="L781">					lastBalance = &quot;&quot;;</span>
<span class="nc" id="L782">					lastDate = &quot;&quot;;</span>
				}
<span class="nc bnc" id="L784" title="All 2 branches missed.">				for (Iterator it = rowData.toAccrueds.iterator(); it.hasNext();) {</span>
<span class="nc" id="L785">					EmployeeTimeOffAccrued toAccrued = (EmployeeTimeOffAccrued) it.next();</span>

<span class="nc" id="L787">					String balance = &quot;&quot;;</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">					if (!toAccrued.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)) {</span>
<span class="nc" id="L789">						balance = formatDecimal(2, toAccrued.getAccruedHours());</span>
					}
<span class="nc" id="L791">					String date = m_localizer.formatDate(toAccrued.getAccruedAtDate(),</span>
<span class="nc" id="L792">							m_context.getViewingTimeZone(), RegionalFormatBundleKey.DATE_FORMAT);</span>

<span class="nc bnc" id="L794" title="All 2 branches missed.">					if (lastBalance == null) {</span>
<span class="nc" id="L795">						lastBalance = balance;</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">					} else if (!lastBalance.equals(balance)){</span>
<span class="nc" id="L797">							lastBalance = &quot;*&quot;;//multi value</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">					} if (lastDate == null) {</span>
<span class="nc" id="L799">						lastDate = date;</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">					} else if (!lastDate.equals(date)){</span>
<span class="nc" id="L801">							lastDate = &quot;*&quot;;//multi value</span>
					}
<span class="nc bnc" id="L803" title="All 4 branches missed.">				} if (editable &amp;&amp; rowData.isTOAllotment) {</span>
					//TO Accrued History Popup Button
<span class="nc" id="L805">					String sCmd = &quot;TO_ACCRUED_HISTORY_&quot; + i;</span>
<span class="nc" id="L806">					String sParam = &quot;&quot;;</span>
<span class="nc" id="L807">					ID[] solvedIDs = solveUnionID(rowData.unionID);</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">					if (solvedIDs[0] != null){</span>
<span class="nc" id="L809">						sParam = &quot;actID=&quot; + solvedIDs[0].toString();</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">					} else if (solvedIDs[1] != null){</span>
<span class="nc" id="L811">						sParam = &quot;actCatID=&quot; + solvedIDs[1].toString();</span>
					}
<span class="nc" id="L813">					storeHistoryPopupArgs(sCmd, sParam);</span>
<span class="nc" id="L814">					String popupBtn = buildHistoryPopupButton(sCmd).toString();</span>

<span class="nc" id="L816">					cols.add(HtmlUtil.makeTextInput(LAST_BALANCE_FN + i, 5, 8, lastBalance, null, null, true, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.LastUpdatedBalance)));</span>
<span class="nc" id="L817">					cols.add(HtmlUtil.makeTextInput(LAST_DATE_FN + i, 10, 12, lastDate, null, null, true, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.LastUpdatedDate)) + popupBtn);</span>
<span class="nc" id="L818">				} else {</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">					if(rowData.isTOAllotment){</span>
<span class="nc" id="L820">						cols.add(HtmlUtil.makeTextInput(LAST_BALANCE_FN + i, 5, 0, lastBalance, null, null, false, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.LastUpdatedBalance)));</span>
<span class="nc" id="L821">						cols.add(HtmlUtil.makeTextInput(LAST_DATE_FN + i, 10, 0, lastDate, null, null, false, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.LastUpdatedDate)));</span>
					}else {
<span class="nc" id="L823">						cols.add(&quot;&quot;);</span>
<span class="nc" id="L824">						cols.add(&quot;&quot;);</span>
					}
				}
<span class="nc" id="L827">			} else {</span>
<span class="nc" id="L828">				cols.add(&quot;&quot;);</span>
<span class="nc" id="L829">				cols.add(&quot;&quot;);</span>
			}

			//Max Balance &amp; Carryover
<span class="nc bnc" id="L833" title="All 2 branches missed.">			if (rowData.isFirstLayer) {</span>
<span class="nc" id="L834">				String maxBalance = null;</span>
<span class="nc" id="L835">				String maxCarryover = null;</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">				if (rowData.toBalances.size() &lt; m_empIDs.size()) {//some of emps have empty values</span>
<span class="nc" id="L837">					maxBalance = &quot;&quot;;</span>
<span class="nc" id="L838">					maxCarryover = &quot;&quot;;</span>
				}
<span class="nc bnc" id="L840" title="All 2 branches missed.">				for (Iterator it = rowData.toBalances.iterator(); it.hasNext();) {</span>
<span class="nc" id="L841">					ActivityTimeOffBalance toBalance = (ActivityTimeOffBalance) it.next();</span>

<span class="nc" id="L843">					String balance = &quot;&quot;;</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">					if (!toBalance.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">							&amp;&amp; toBalance.getMaxBalance() != ActivityTimeOffBalance.MAX_BALANCE_NA) {</span>
<span class="nc" id="L846">						balance = formatDecimal(2, toBalance.getMaxBalance());</span>
					}
<span class="nc" id="L848">					String carryover = &quot;&quot;;</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">					if (!toBalance.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER)</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">							&amp;&amp; toBalance.getMaxCarryOver() != ActivityTimeOffBalance.MAX_BALANCE_NA) {</span>
<span class="nc" id="L851">						carryover = formatDecimal(2, toBalance.getMaxCarryOver());</span>
					}

<span class="nc bnc" id="L854" title="All 2 branches missed.">					if (maxBalance == null) {</span>
<span class="nc" id="L855">						maxBalance = balance;</span>
					} else {
<span class="nc bnc" id="L857" title="All 2 branches missed.">						if (!maxBalance.equals(balance))</span>
<span class="nc" id="L858">							maxBalance = &quot;*&quot;;//multi value</span>
					}
<span class="nc bnc" id="L860" title="All 2 branches missed.">					if (maxCarryover == null) {</span>
<span class="nc" id="L861">						maxCarryover = carryover;</span>
					} else {
<span class="nc bnc" id="L863" title="All 2 branches missed.">						if (!maxCarryover.equals(carryover))</span>
<span class="nc" id="L864">							maxCarryover = &quot;*&quot;;//multi value</span>
					}
<span class="nc" id="L866">				}</span>
<span class="nc bnc" id="L867" title="All 4 branches missed.">				if (editable &amp;&amp; rowData.isTOAllotment) {</span>
<span class="nc" id="L868">					cols.add(HtmlUtil.makeTextInput(MAX_BALANCE_FN + i, 5, 8, maxBalance, null, null, true, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.MaxBalance)));</span>
<span class="nc" id="L869">					cols.add(HtmlUtil.makeTextInput(MAX_CARRYOVER_FN + i, 5, 8, maxCarryover, null, null, true, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.MaxCarryover)));</span>
				} else {
<span class="nc bnc" id="L871" title="All 2 branches missed.">					if (rowData.isTOAllotment) {</span>
<span class="nc" id="L872">						cols.add(HtmlUtil.makeTextInput(MAX_BALANCE_FN + i, 5, 0, maxBalance, null, null, false, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.MaxBalance)));</span>
<span class="nc" id="L873">						cols.add(HtmlUtil.makeTextInput(MAX_CARRYOVER_FN + i, 5, 0, maxCarryover, null, null, false, false, activityName + &quot;, &quot; + i18n(m_bundle, BbmWebBundleKey.MaxCarryover)));</span>
					} else {
<span class="nc" id="L875">						cols.add(&quot;&quot;);</span>
<span class="nc" id="L876">						cols.add(&quot;&quot;);</span>
					}
				}
<span class="nc" id="L879">			} else {</span>
<span class="nc" id="L880">				cols.add(&quot;&quot;);</span>
<span class="nc" id="L881">				cols.add(&quot;&quot;);</span>
			}

		}

		//allotment: this year
<span class="nc bnc" id="L887" title="All 2 branches missed.">		if (rowData.isFirstLayer) {</span>
<span class="nc bnc" id="L888" title="All 4 branches missed.">			if (editable &amp;&amp; rowData.isTOAllotment) {</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">				for (int index = 0; index &lt; NUM_OF_YEARS; index++)</span>
<span class="nc" id="L890">					cols.add(HtmlUtil.makeTextInput(HOURSYEAR_FN + index + &quot;_&quot; + i, 4, 8, yearVal[index], null, null, true, false, activityName + &quot;, &quot; + (Calendar.getInstance().get(Calendar.YEAR)+index-1)));</span>
			} else {
<span class="nc bnc" id="L892" title="All 2 branches missed.">				for (int index = 0; index &lt; NUM_OF_YEARS; index++) {</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">					if (rowData.isTOAllotment) {</span>
<span class="nc" id="L894">						cols.add(HtmlUtil.makeTextInput(HOURSYEAR_FN + index + &quot;_&quot; + i, 4, 0, yearVal[index], null, null, false, false, activityName + &quot;, &quot; + (Calendar.getInstance().get(Calendar.YEAR)+index-1)));</span>
					} else {
<span class="nc" id="L896">						cols.add(&quot;&quot;);</span>
					}
				}
			}
		} else {
<span class="nc bnc" id="L901" title="All 2 branches missed.">			for (int index = 0; index &lt; NUM_OF_YEARS; index++)</span>
<span class="nc" id="L902">				cols.add(&quot;&quot;);</span>
		}

<span class="nc" id="L905">		DefaultMultiColumnNodeData timeOffData = new DefaultMultiColumnNodeData(&quot;timeOffProfile&quot;, cols);</span>
<span class="nc" id="L906">		timeOffData.setSelectable(false);</span>
<span class="nc" id="L907">		return timeOffData;</span>
	}

	private void setupNodeDataForTimeOffPools(RowData rowData, boolean editable, List&lt;Object&gt; cols, int i) {
<span class="nc bnc" id="L911" title="All 4 branches missed.">		if (rowData.act == null || activityIDToPoolAssignment == null) {</span>
<span class="nc" id="L912">			cols.add(&quot;&quot;);</span>
<span class="nc" id="L913">			return;</span>
		}

<span class="nc" id="L916">		TOPoolAssignmentByActivity assignment = activityIDToPoolAssignment.get(rowData.act.getID());</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">		if (assignment == null) {</span>
<span class="nc" id="L918">			cols.add(&quot;&quot;);</span>
<span class="nc" id="L919">			return;</span>
		}

<span class="nc" id="L922">		TOPoolByActivityData data = new TOPoolByActivityData(assignment);</span>
<span class="nc" id="L923">		TOPoolByActivityPC pc = new TOPoolByActivityPC(data, commonPools, m_context);</span>
<span class="nc" id="L924">		pc.setIsEditable(m_isEditable);</span>
<span class="nc" id="L925">		cols.add(pc);</span>
<span class="nc" id="L926">	}</span>

	//////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	//////////////////////////////////////////////////////////////////////////////
	@SuppressWarnings(&quot;unchecked&quot;)
	private void initHeader() {
<span class="nc" id="L933">		int thisYear = m_employee.getTimeOffYear();</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">		if (thisYear == -1) {</span>
<span class="nc" id="L935">			Calendar rightNow = Calendar.getInstance();</span>
<span class="nc" id="L936">			thisYear = rightNow.get(Calendar.YEAR);</span>
		}

	
<span class="nc" id="L940">		DefaultHeaderData hdrTOType  = new DefaultHeaderData(&quot;cTOType&quot;, i18n(m_bundle, BbmWebBundleKey.TimeOffType), null, m_headerCssClass, false);</span>
<span class="nc" id="L941">		DefaultHeaderData headerTimeOffPool = new DefaultHeaderData(&quot;headerTimeOffPool&quot;, i18n(m_bundle, BbmWebBundleKey.PEOPLE_TIMEOFF_POOL_HEADER), null,</span>
				m_headerCssClass, false);
<span class="nc" id="L943">		DefaultHeaderData hdrPerday  = new DefaultHeaderData(&quot;cPerDay&quot;, i18n(m_bundle, BbmWebBundleKey.DefaultPerDay), null, m_headerCssClass, false);</span>
<span class="nc" id="L944">		DefaultHeaderData hdrPerweek = new DefaultHeaderData(&quot;cPerWeek&quot;, i18n(m_bundle, BbmWebBundleKey.DefaultPerWeek), null, m_headerCssClass, false);</span>
<span class="nc" id="L945">		DefaultHeaderData hdrSchedule     = new DefaultHeaderData(&quot;cSchedule&quot;, i18n(m_bundle, BbmWebBundleKey.AccrualSchedule), &quot;65&quot;, m_headerCssClass, false);</span>
<span class="nc" id="L946">		DefaultHeaderData hdrLastBalance  = new DefaultHeaderData(&quot;cLastBalance&quot;, i18n(m_bundle, BbmWebBundleKey.LastUpdatedBalance), &quot;55&quot;, m_headerCssClass, false);</span>
<span class="nc" id="L947">		DefaultHeaderData hdrLastDate     = new DefaultHeaderData(&quot;cLastDate&quot;, i18n(m_bundle, BbmWebBundleKey.LastUpdatedDate), &quot;98&quot;, m_headerCssClass, false);</span>
<span class="nc" id="L948">		DefaultHeaderData hdrMaxBalance   = new DefaultHeaderData(&quot;cMaxBalance&quot;, i18n(m_bundle, BbmWebBundleKey.MaxBalance), &quot;55&quot;, m_headerCssClass, false);</span>
<span class="nc" id="L949">		DefaultHeaderData hdrMaxCarryover = new DefaultHeaderData(&quot;cMaxCarryover&quot;, i18n(m_bundle, BbmWebBundleKey.MaxCarryover), &quot;55&quot;, m_headerCssClass, false);</span>
<span class="nc" id="L950">		DefaultHeaderData hdrYearSpan     = new DefaultHeaderData(&quot;cYearSpan&quot;, &quot;&lt;center&gt;&quot;+i18n(m_bundle, BbmWebBundleKey.AccrualRate)+&quot;&lt;/center&gt;&quot;, null, m_headerCssClass, false);</span>
<span class="nc" id="L951">		List&lt;DefaultHeaderData&gt; hdrListYears = new ArrayList&lt;DefaultHeaderData&gt;();</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">		for (int i = 1; i &lt;= NUM_OF_YEARS; i++) {</span>
<span class="nc" id="L953">			hdrListYears.add(new DefaultHeaderData(&quot;c&quot; + i, &quot;&quot; + (thisYear + i - 2), null, m_headerCssClass, false));</span>
		}
		

<span class="nc" id="L957">		TableHeaderPC headerPC = getHeader();</span>
		List&lt;DefaultHeaderData&gt; hdrList;
		//Only show accrual fields if has Accrual License
<span class="nc bnc" id="L960" title="All 2 branches missed.">		if (!m_hasAccrualLicense) {</span>
			//One layer of headers:
			//TOType, TO Pool, PerDay, PerWeek, 2008, 2009, 2010, 2011
<span class="nc" id="L963">			hdrList = new ArrayList&lt;DefaultHeaderData&gt;();</span>
<span class="nc" id="L964">			hdrList.add(hdrTOType);</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">			if (shouldShowTimeOffPoolByActivity()) {</span>
<span class="nc" id="L966">				hdrList.add(headerTimeOffPool);</span>
			}
<span class="nc" id="L968">			hdrList.add(hdrPerday);</span>
<span class="nc" id="L969">			hdrList.add(hdrPerweek);</span>
<span class="nc" id="L970">			hdrList.addAll(hdrListYears);</span>
<span class="nc" id="L971">			headerPC.setHeaders(hdrList);</span>
		} else {
			//Two layer of headers:
			//TOType, TOPool, PerDay, PerWeek, Schedule, LastBalance, LastDate, MaxBalance, MaxCarryover, |&lt;---- YearSpan ----&gt;|
			//                                                                                    2008, 2009, 2010, 2011
<span class="nc" id="L976">			hdrTOType.setRowSpan(2);</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">			if (shouldShowTimeOffPoolByActivity()) {</span>
<span class="nc" id="L978">				headerTimeOffPool.setRowSpan(2);</span>
			}
<span class="nc" id="L980">			hdrPerday.setRowSpan(2);</span>
<span class="nc" id="L981">			hdrPerweek.setRowSpan(2);</span>
<span class="nc" id="L982">			hdrSchedule.setRowSpan(2);</span>
<span class="nc" id="L983">			hdrLastBalance.setRowSpan(2);</span>
<span class="nc" id="L984">			hdrLastDate.setRowSpan(2);</span>
<span class="nc" id="L985">			hdrMaxBalance.setRowSpan(2);</span>
<span class="nc" id="L986">			hdrMaxCarryover.setRowSpan(2);</span>
<span class="nc" id="L987">			hdrYearSpan.setColSpan(NUM_OF_YEARS);</span>

<span class="nc" id="L989">			hdrPerday.setColumnWidth(&quot;55&quot;);</span>
<span class="nc" id="L990">			hdrPerweek.setColumnWidth(&quot;55&quot;);</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">			for (DefaultHeaderData hdrYear : hdrListYears) {</span>
<span class="nc" id="L992">				hdrYear.setColumnWidth(&quot;50&quot;);</span>
<span class="nc" id="L993">			}</span>

			//2nd layer
<span class="nc" id="L996">			headerPC.setHeaders(hdrListYears);</span>
			//1st layer
<span class="nc" id="L998">			hdrList = new ArrayList();</span>
<span class="nc" id="L999">			hdrList.add(hdrTOType);</span>
			//JT
			
<span class="nc bnc" id="L1002" title="All 2 branches missed.">			if (shouldShowTimeOffPoolByActivity()) {</span>
<span class="nc" id="L1003">				hdrList.add(headerTimeOffPool);</span>
			}
						
<span class="nc" id="L1006">			hdrList.add(hdrPerday);</span>
<span class="nc" id="L1007">			hdrList.add(hdrPerweek);</span>
<span class="nc" id="L1008">			hdrList.add(hdrSchedule);</span>
<span class="nc" id="L1009">			hdrList.add(hdrLastBalance);</span>
<span class="nc" id="L1010">			hdrList.add(hdrLastDate);</span>
<span class="nc" id="L1011">			hdrList.add(hdrMaxBalance);</span>
<span class="nc" id="L1012">			hdrList.add(hdrMaxCarryover);</span>
<span class="nc" id="L1013">			hdrList.add(hdrYearSpan);</span>
<span class="nc" id="L1014">			headerPC.incActiveHeaderLevel();</span>
<span class="nc" id="L1015">			headerPC.setHeaders(hdrList);</span>
			//Toggle button doesn't show properly with 2 layer header
<span class="nc" id="L1017">			this.setToggleable(false);</span>
		}
<span class="nc" id="L1019">	}</span>

	private boolean shouldShowTimeOffPoolByActivity() {
<span class="nc bnc" id="L1022" title="All 4 branches missed.">		return LicenseUtil.isAdvancedRMLicense() &amp;&amp; asOfDate != null;</span>
	}


	private void createMap(Collection empTimeOffCol) {
<span class="nc" id="L1027">		m_timeOffMap = new HashMap();</span>
<span class="nc bnc" id="L1028" title="All 4 branches missed.">		if (empTimeOffCol != null &amp;&amp; !empTimeOffCol.isEmpty()) {</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">			for (Iterator j = empTimeOffCol.iterator(); j.hasNext();) {</span>
<span class="nc" id="L1030">				EmployeeTimeOff empTimeOff = (EmployeeTimeOff) j.next();</span>
<span class="nc" id="L1031">				ID unionID = getUnionID(empTimeOff.getActivityID(), empTimeOff.getActivityCategoryID());</span>
<span class="nc" id="L1032">				m_timeOffMap.put(unionID, empTimeOff);</span>
<span class="nc" id="L1033">			}</span>
		}
<span class="nc" id="L1035">	}</span>

	private String formatDecimal(int prec, double num) {
		try {
<span class="nc" id="L1039">			BigDecimal n = new BigDecimal(num);</span>
<span class="nc" id="L1040">			String strFormat = (n.setScale(prec, BigDecimal.ROUND_HALF_UP)).toString();</span>
<span class="nc" id="L1041">			strFormat = FormInputPC.localizeRealNumber(strFormat, m_localizer);</span>
<span class="nc" id="L1042">			return strFormat;</span>
<span class="nc" id="L1043">		} catch (ArithmeticException e) {</span>
<span class="nc" id="L1044">			return null;</span>
		}
	}

	@Override
	public void initStickyCollapsedState(String cacheMode, boolean defaultState) {
<span class="nc" id="L1050">	}</span>

	@Override
	public void setIsToggleable(boolean value) {
<span class="nc" id="L1054">	}</span>

	private class RowData {
		final Activity act;
		final ActivityCategory actCate;
		final ID unionID;//ActivityID or ActivityCategoryID
		final ID parentID;//ActivityCategoryID
		final String name;
		final int accrualSchedule;// monthly, yearly, etc.
		final boolean isTOAllotment;
<span class="nc" id="L1064">		int rowIndex = -1;</span>
<span class="nc" id="L1065">		boolean isFirstLayer = true;// of the tree</span>
<span class="nc" id="L1066">		Collection toAccrueds = new ArrayList();</span>
<span class="nc" id="L1067">		Collection toBalances = new ArrayList();</span>
		//EmployeeTimeOff

<span class="nc" id="L1070">		public RowData(Activity activity) {</span>
<span class="nc" id="L1071">			this.act     = activity;</span>
<span class="nc" id="L1072">			this.actCate = null;</span>
<span class="nc" id="L1073">			this.unionID  = getUnionID(activity.getID(), activity.getActivityCategoryId());</span>
<span class="nc" id="L1074">			this.parentID = getUnionID(null, activity.getActivityCategoryId());</span>
<span class="nc" id="L1075">			this.name            = activity.getName();</span>
<span class="nc" id="L1076">			this.accrualSchedule = activity.getTOAccrualSchedule();</span>
<span class="nc" id="L1077">			this.isTOAllotment   = activity.isTimeoffWithAllotment();</span>
<span class="nc" id="L1078">		}</span>

<span class="nc" id="L1080">		public RowData(ActivityCategory actCategory) {</span>
<span class="nc" id="L1081">			this.act     = null;</span>
<span class="nc" id="L1082">			this.actCate = actCategory;</span>
<span class="nc" id="L1083">			this.unionID  = getUnionID(null, actCategory.getID());</span>
<span class="nc" id="L1084">			this.parentID = getUnionID(null, actCategory.getID());</span>
<span class="nc" id="L1085">			this.name            = actCategory.getName();</span>
<span class="nc" id="L1086">			this.accrualSchedule = actCategory.getTOAccrualSchedule();</span>
<span class="nc" id="L1087">			this.isTOAllotment   = actCategory.isTOAllotment();</span>
<span class="nc" id="L1088">		}</span>
	}

	private ID getUnionID(ID activityID, ID actCategoryID) {
<span class="nc" id="L1092">		ID unionID = activityID;</span>
<span class="nc bnc" id="L1093" title="All 2 branches missed.">		if (unionID == null)</span>
<span class="nc" id="L1094">			unionID = new ID(ACT_CAT_PREFIX + actCategoryID);</span>
<span class="nc" id="L1095">		return unionID;</span>
	}

	private ID[] solveUnionID(ID unionID) {
<span class="nc" id="L1099">		ID[] result = new ID[2];</span>
<span class="nc" id="L1100">		String unionStr = unionID.toString();</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">		if (unionStr.startsWith(ACT_CAT_PREFIX))</span>
<span class="nc" id="L1102">			result[1] = new ID(unionStr.substring(ACT_CAT_PREFIX.length()));</span>
		else
<span class="nc" id="L1104">			result[0] = new ID(unionStr);</span>
<span class="nc" id="L1105">		return result;</span>
	}

<span class="nc" id="L1108">	private class RowDataConvertor implements TreeNodeConverter {</span>
		@Override
		public ID getNodeID(Object data) {
<span class="nc" id="L1111">			RowData rowData = (RowData) data;</span>
<span class="nc" id="L1112">			return rowData.unionID;</span>
		}

		@Override
		public ID getParentNodeID(Object data) {
<span class="nc" id="L1117">			RowData rowData = (RowData) data;</span>
<span class="nc" id="L1118">			return rowData.parentID;</span>
		}

		@Override
		public DefaultMutableTreeNode toTreeNode(Object data) {
<span class="nc" id="L1123">			RowData rowData = (RowData) data;</span>
<span class="nc" id="L1124">			return new DefaultMutableTreeNode(toNodeData(rowData, m_isEditable));</span>
		}
	}

	class DataUpdater {
<span class="fc" id="L1129">		private final Map/*&lt;unionID, EmployeeTimeOffAccrued&gt;*/ toAccruedInputs = new HashMap();</span>
<span class="fc" id="L1130">		private final Map/*&lt;unionID, ActivityTimeOffBalance&gt;*/ toBalanceInputs = new HashMap();</span>
		private final DatePickerPC datePicker;

<span class="fc" id="L1133">		public DataUpdater(RequestContext context) {</span>
<span class="fc" id="L1134">			datePicker = new DatePickerPC(context, &quot;dpInputFN&quot;);</span>
<span class="fc" id="L1135">		}</span>

		void clear() {
<span class="nc" id="L1138">			toAccruedInputs.clear();</span>
<span class="nc" id="L1139">			toBalanceInputs.clear();</span>
<span class="nc" id="L1140">		}</span>

		/**
		 * @param unionID	must be provided
		 * Empty value for accruedHours or accruedAtDate means to delete it.
		 * Multi value for accruedHours or accruedAtDate means to ignore it.
		 */
		void putTOAccrued(ID unionID, String accruedHours, String accruedAtDate) {
<span class="nc" id="L1148">			EmployeeTimeOffAccrued toAccrued = new EmployeeTimeOffAccrued();</span>
<span class="nc bnc" id="L1149" title="All 2 branches missed.">			if (!StringUtil.isEmpty(accruedHours)) {</span>
<span class="nc bnc" id="L1150" title="All 2 branches missed.">				if (accruedHours.equals(&quot;*&quot;))</span>
<span class="nc" id="L1151">					toAccrued.setFieldMultiValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS);</span>
				else
<span class="nc" id="L1153">					toAccrued.setAccruedHours(FormInputPC.convertLocalizedRealNumber(accruedHours, m_localizer));</span>
			} else {
<span class="nc" id="L1155">				toAccrued.setFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS);</span>
			}
<span class="nc bnc" id="L1157" title="All 2 branches missed.">			if (!StringUtil.isEmpty(accruedAtDate)) {</span>
<span class="nc bnc" id="L1158" title="All 2 branches missed.">				if (accruedAtDate.equals(&quot;*&quot;))</span>
<span class="nc" id="L1159">					toAccrued.setFieldMultiValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT);</span>
				else
<span class="nc" id="L1161">					toAccrued.setAccruedAtDate(datePicker.convertStrToDate(accruedAtDate));</span>
			} else {
<span class="nc" id="L1163">				toAccrued.setFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT);</span>
			}

<span class="nc bnc" id="L1166" title="All 2 branches missed.">			if (toAccrued.isFieldMultiValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)</span>
<span class="nc bnc" id="L1167" title="All 2 branches missed.">					&amp;&amp; toAccrued.isFieldMultiValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT))</span>
<span class="nc" id="L1168">				return;//both value ignored</span>

<span class="nc bnc" id="L1170" title="All 2 branches missed.">			if ( (toAccrued.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">					&amp;&amp; !toAccrued.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT))</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">					|| (!toAccrued.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">							&amp;&amp; toAccrued.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT)) ) {</span>
				//Incomplete input
<span class="nc" id="L1175">				TimeOffPC.this.addPageMessage(Message.ERROR_TYPE,</span>
						BbmWebBundleKey.INCOMPLETE_LAST_UPDATE_MSG, BbmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1177">				return;</span>
			}

<span class="nc" id="L1180">			toAccruedInputs.put(unionID, toAccrued);</span>
<span class="nc" id="L1181">		}</span>

		/**
		 * @param unionID	must be provided
		 * Empty value for maxBalance or maxCarryover means to delete it.
		 * Multi value for maxBalance or maxCarryover means to ignore it.
		 */
		void putTOBalance(ID unionID, String maxBalance, String maxCarryover) {
<span class="nc" id="L1189">			ActivityTimeOffBalance toBalance = new ActivityTimeOffBalance();</span>
<span class="nc bnc" id="L1190" title="All 2 branches missed.">			if (!StringUtil.isEmpty(maxBalance)) {</span>
<span class="nc bnc" id="L1191" title="All 2 branches missed.">				if (maxBalance.equals(&quot;*&quot;))</span>
<span class="nc" id="L1192">					toBalance.setFieldMultiValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE);</span>
				else
<span class="nc" id="L1194">					toBalance.setMaxBalance(FormInputPC.convertLocalizedRealNumber(maxBalance, m_localizer));</span>
			} else {
<span class="nc" id="L1196">				toBalance.setFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE);</span>
			}
<span class="nc bnc" id="L1198" title="All 2 branches missed.">			if (!StringUtil.isEmpty(maxCarryover)) {</span>
<span class="nc bnc" id="L1199" title="All 2 branches missed.">				if (maxCarryover.equals(&quot;*&quot;))</span>
<span class="nc" id="L1200">					toBalance.setFieldMultiValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER);</span>
				else
<span class="nc" id="L1202">					toBalance.setMaxCarryOver(FormInputPC.convertLocalizedRealNumber(maxCarryover, m_localizer));</span>
			} else {
<span class="nc" id="L1204">				toBalance.setFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER);</span>
			}

<span class="nc bnc" id="L1207" title="All 2 branches missed.">			if (toBalance.isFieldMultiValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)</span>
<span class="nc bnc" id="L1208" title="All 2 branches missed.">					&amp;&amp; toBalance.isFieldMultiValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER))</span>
<span class="nc" id="L1209">				return;//both value ignored</span>

<span class="nc" id="L1211">			toBalanceInputs.put(unionID, toBalance);</span>
<span class="nc" id="L1212">		}</span>

		void updateTOAccrued() throws Exception {
<span class="nc" id="L1215">			Collection/*&lt;ID&gt;*/ actIDs = new ArrayList();</span>
<span class="nc" id="L1216">			Collection/*&lt;ID&gt;*/ actCatIDs = new ArrayList();</span>
<span class="nc bnc" id="L1217" title="All 2 branches missed.">			for (Iterator it = toAccruedInputs.keySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L1218">				ID unionID = (ID) it.next();</span>
<span class="nc" id="L1219">				ID[] solvedIDs = solveUnionID(unionID);</span>
<span class="nc bnc" id="L1220" title="All 2 branches missed.">				if (solvedIDs[0] != null)</span>
<span class="nc" id="L1221">					actIDs.add(solvedIDs[0]);</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">				if (solvedIDs[1] != null)</span>
<span class="nc" id="L1223">					actCatIDs.add(solvedIDs[1]);</span>
<span class="nc" id="L1224">			}</span>
<span class="nc" id="L1225">			Collection toAccruedsOld = Collections.emptyList();</span>
<span class="nc bnc" id="L1226" title="All 4 branches missed.">			if (actIDs.size() &gt; 0 || actCatIDs.size() &gt; 0) {</span>
<span class="nc" id="L1227">				toAccruedsOld = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode())</span>
<span class="nc" id="L1228">						.getLastUpdatedTOAccrued(m_empIDs, actIDs, actCatIDs);</span>
			}

<span class="nc" id="L1231">			Map/*&lt;dbID, EmployeeTimeOffAccrued&gt;*/ toAccruedsOldMap = new HashMap();</span>
<span class="nc bnc" id="L1232" title="All 2 branches missed.">			for (Iterator it = toAccruedsOld.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1233">				EmployeeTimeOffAccrued toAccruedOld = (EmployeeTimeOffAccrued) it.next();</span>
<span class="nc" id="L1234">				String dbID = getDbID(toAccruedOld.getEmployeeID(),</span>
<span class="nc" id="L1235">						getUnionID(toAccruedOld.getActivityID(), toAccruedOld.getActivityCategoryId()));</span>
<span class="nc" id="L1236">				toAccruedsOldMap.put(dbID, toAccruedOld);</span>
<span class="nc" id="L1237">			}</span>

<span class="nc" id="L1239">			Collection toAccruedsNew = new ArrayList();</span>
<span class="nc" id="L1240">			Collection toAccruedIDsDelete = new ArrayList();</span>
<span class="nc" id="L1241">			boolean isUpdatingEarlierDate = false;</span>
<span class="nc bnc" id="L1242" title="All 2 branches missed.">			for (Iterator it = toAccruedInputs.entrySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L1243">				Map.Entry entry = (Map.Entry) it.next();</span>
<span class="nc" id="L1244">				ID unionID = (ID) entry.getKey();</span>
<span class="nc" id="L1245">				EmployeeTimeOffAccrued toAccruedInput = (EmployeeTimeOffAccrued) entry.getValue();</span>
<span class="nc bnc" id="L1246" title="All 2 branches missed.">				for (Iterator i = m_empIDs.iterator(); i.hasNext();) {</span>
<span class="nc" id="L1247">					ID empID = (ID) i.next();</span>
<span class="nc" id="L1248">					String dbID = getDbID(empID, unionID);</span>
<span class="nc" id="L1249">					EmployeeTimeOffAccrued toAccruedOld = (EmployeeTimeOffAccrued) toAccruedsOldMap.get(dbID);</span>

					//To Delete
<span class="nc bnc" id="L1252" title="All 2 branches missed.">					if (toAccruedInput.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">							&amp;&amp; toAccruedInput.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT)) {</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">						if (toAccruedOld != null)</span>
<span class="nc" id="L1255">							toAccruedIDsDelete.add(toAccruedOld.getID());</span>
						continue;
					}
					//To Create or Update
<span class="nc" id="L1259">					boolean modified = false;</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">					if (toAccruedOld == null) {//If Old does not exist, create a New one</span>
<span class="nc" id="L1261">						toAccruedOld = new EmployeeTimeOffAccrued();</span>
<span class="nc" id="L1262">						toAccruedOld.setEmployeeID(empID);</span>
<span class="nc" id="L1263">						ID[] solvedIDs = solveUnionID(unionID);</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">						if (solvedIDs[0] != null)</span>
<span class="nc" id="L1265">							toAccruedOld.setActivityID(solvedIDs[0]);</span>
<span class="nc bnc" id="L1266" title="All 2 branches missed.">						if (solvedIDs[1] != null)</span>
<span class="nc" id="L1267">							toAccruedOld.setActivityCategoryId(solvedIDs[1]);</span>
<span class="nc" id="L1268">						modified = true;</span>
					}
					//Update toAccrued according to Input
<span class="nc bnc" id="L1271" title="All 2 branches missed.">					if (!toAccruedInput.isFieldMultiValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)) {</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">						if (toAccruedInput.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)) {</span>
<span class="nc bnc" id="L1273" title="All 2 branches missed.">							if (!toAccruedOld.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)) {</span>
<span class="nc" id="L1274">								toAccruedOld.setFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS);</span>
<span class="nc" id="L1275">								modified = true;</span>
							}
						} else {
<span class="nc bnc" id="L1278" title="All 2 branches missed.">							if (toAccruedInput.getAccruedHours() != toAccruedOld.getAccruedHours()</span>
<span class="nc bnc" id="L1279" title="All 2 branches missed.">									|| toAccruedOld.getFieldValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS)</span>
											== null/*NullObject or null as new created didn't set*/) {
<span class="nc" id="L1281">								toAccruedOld.setAccruedHours(toAccruedInput.getAccruedHours());</span>
<span class="nc" id="L1282">								modified = true;</span>
							}
						}
					}
<span class="nc bnc" id="L1286" title="All 2 branches missed.">					if (!toAccruedInput.isFieldMultiValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT)) {</span>
<span class="nc bnc" id="L1287" title="All 2 branches missed.">						if (toAccruedInput.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT)) {</span>
<span class="nc bnc" id="L1288" title="All 2 branches missed.">							if (!toAccruedOld.isFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT)) {</span>
<span class="nc" id="L1289">								toAccruedOld.setFieldNull(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDAT);</span>
<span class="nc" id="L1290">								modified = true;</span>
							}
						} else {
<span class="nc bnc" id="L1293" title="All 2 branches missed.">							if (!toAccruedInput.getAccruedAtDate().equals(toAccruedOld.getAccruedAtDate())) {</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">								if (toAccruedOld.getAccruedAtDate() != null</span>
<span class="nc bnc" id="L1295" title="All 2 branches missed.">										&amp;&amp; toAccruedInput.getAccruedAtDate().before(toAccruedOld.getAccruedAtDate()))</span>
<span class="nc" id="L1296">									isUpdatingEarlierDate = true;</span>
<span class="nc" id="L1297">								toAccruedOld.setAccruedAtDate(toAccruedInput.getAccruedAtDate());</span>
<span class="nc" id="L1298">								modified = true;</span>
							}
						}
					}
<span class="nc bnc" id="L1302" title="All 2 branches missed.">					if (modified) {</span>
<span class="nc bnc" id="L1303" title="All 2 branches missed.">						if ( toAccruedOld.getFieldValue(EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_ACCRUEDHOURS) == null</span>
<span class="nc bnc" id="L1304" title="All 2 branches missed.">								|| toAccruedOld.getAccruedAtDate() == null ) {</span>
							//Incomplete input, (When one input is *, and the current record is new created)
<span class="nc" id="L1306">							TimeOffPC.this.addPageMessage(Message.ERROR_TYPE,</span>
									BbmWebBundleKey.INCOMPLETE_LAST_UPDATE_MSG, BbmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1308">							throw new BbmException(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.INCOMPLETE_LAST_UPDATE_MSG);</span>
						}

<span class="nc" id="L1311">						toAccruedsNew.add(toAccruedOld);</span>
					}
<span class="nc" id="L1313">				}</span>
<span class="nc" id="L1314">			}</span>

			//Update or Insert, new created toAccrued doesn't have an value object ID
<span class="nc bnc" id="L1317" title="All 2 branches missed.">			if (toAccruedsNew.size() &gt; 0) {</span>
<span class="nc" id="L1318">				BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode())</span>
<span class="nc" id="L1319">						.updateOrInsertTOAccrued(toAccruedsNew);</span>
<span class="nc bnc" id="L1320" title="All 2 branches missed.">				if (isUpdatingEarlierDate)</span>
<span class="nc" id="L1321">					TimeOffPC.this.addPageMessage(Message.INFO_TYPE,//TODO: l10n</span>
							&quot;You have updated the balance for a date which is earlier than the most recent update date.&quot;);
			}
			//Delete
<span class="nc bnc" id="L1325" title="All 2 branches missed.">			if (toAccruedIDsDelete.size() &gt; 0) {</span>
<span class="nc" id="L1326">				BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode())</span>
<span class="nc" id="L1327">						.deleteTOAccrued(toAccruedIDsDelete);</span>
			}
<span class="nc" id="L1329">		}</span>

		void updateTOBalance() throws Exception {
<span class="nc" id="L1332">			Collection/*&lt;ID&gt;*/ actIDs = new ArrayList();</span>
<span class="nc" id="L1333">			Collection/*&lt;ID&gt;*/ actCatIDs = new ArrayList();</span>
<span class="nc bnc" id="L1334" title="All 2 branches missed.">			for (Iterator it = toBalanceInputs.keySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L1335">				ID unionID = (ID) it.next();</span>
<span class="nc" id="L1336">				ID[] solvedIDs = solveUnionID(unionID);</span>
<span class="nc bnc" id="L1337" title="All 2 branches missed.">				if (solvedIDs[0] != null)</span>
<span class="nc" id="L1338">					actIDs.add(solvedIDs[0]);</span>
<span class="nc bnc" id="L1339" title="All 2 branches missed.">				if (solvedIDs[1] != null)</span>
<span class="nc" id="L1340">					actCatIDs.add(solvedIDs[1]);</span>
<span class="nc" id="L1341">			}</span>
<span class="nc" id="L1342">			Collection toBalancesOld = Collections.emptyList();</span>
<span class="nc bnc" id="L1343" title="All 4 branches missed.">			if (actIDs.size() &gt; 0 || actCatIDs.size() &gt; 0) {</span>
<span class="nc" id="L1344">				toBalancesOld = WfmManagerFactory.getActivityManager(m_context.isInWhatIfMode())</span>
<span class="nc" id="L1345">						.getTOBalanceForActivities(m_empIDs, actIDs, actCatIDs);</span>
			}

<span class="nc" id="L1348">			Map/*&lt;dbID, ActivityTimeOffBalance&gt;*/ toBalancesOldMap = new HashMap();</span>
<span class="nc bnc" id="L1349" title="All 2 branches missed.">			for (Iterator it = toBalancesOld.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1350">				ActivityTimeOffBalance toBalanceOld = (ActivityTimeOffBalance) it.next();</span>
<span class="nc" id="L1351">				String dbID = getDbID(toBalanceOld.getWorkResourceID(),</span>
<span class="nc" id="L1352">						getUnionID(toBalanceOld.getActivityID(), toBalanceOld.getActivityCategoryId()));</span>
<span class="nc" id="L1353">				toBalancesOldMap.put(dbID, toBalanceOld);</span>
<span class="nc" id="L1354">			}</span>

<span class="nc" id="L1356">			Collection toBalancesNew = new ArrayList();</span>
<span class="nc" id="L1357">			Collection toBalanceIDsDelete = new ArrayList();</span>
<span class="nc bnc" id="L1358" title="All 2 branches missed.">			for (Iterator it = toBalanceInputs.entrySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L1359">				Map.Entry entry = (Map.Entry) it.next();</span>
<span class="nc" id="L1360">				ID unionID = (ID) entry.getKey();</span>
<span class="nc" id="L1361">				ActivityTimeOffBalance toBalanceInput = (ActivityTimeOffBalance) entry.getValue();</span>
<span class="nc bnc" id="L1362" title="All 2 branches missed.">				for (Iterator i = m_empIDs.iterator(); i.hasNext();) {</span>
<span class="nc" id="L1363">					ID empID = (ID) i.next();</span>
<span class="nc" id="L1364">					String dbID = getDbID(empID, unionID);</span>
<span class="nc" id="L1365">					ActivityTimeOffBalance toBalanceOld = (ActivityTimeOffBalance) toBalancesOldMap.get(dbID);</span>

					//To Delete
<span class="nc bnc" id="L1368" title="All 2 branches missed.">					if (toBalanceInput.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)</span>
<span class="nc bnc" id="L1369" title="All 2 branches missed.">							&amp;&amp; toBalanceInput.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER)) {</span>
<span class="nc bnc" id="L1370" title="All 2 branches missed.">						if (toBalanceOld != null)</span>
<span class="nc" id="L1371">							toBalanceIDsDelete.add(toBalanceOld.getID());</span>
						continue;
					}
					//To Create or Update
<span class="nc" id="L1375">					boolean modified = false;</span>
<span class="nc bnc" id="L1376" title="All 2 branches missed.">					if (toBalanceOld == null) {//If Old does not exist, create a New one</span>
<span class="nc" id="L1377">						toBalanceOld = new ActivityTimeOffBalance();</span>
<span class="nc" id="L1378">						toBalanceOld.setWorkResourceID(empID);</span>
<span class="nc" id="L1379">						ID[] solvedIDs = solveUnionID(unionID);</span>
<span class="nc bnc" id="L1380" title="All 2 branches missed.">						if (solvedIDs[0] != null)</span>
<span class="nc" id="L1381">							toBalanceOld.setActivityID(solvedIDs[0]);</span>
<span class="nc bnc" id="L1382" title="All 2 branches missed.">						if (solvedIDs[1] != null)</span>
<span class="nc" id="L1383">							toBalanceOld.setActivityCategoryId(solvedIDs[1]);</span>
<span class="nc" id="L1384">						modified = true;</span>
					}
					//Update toBalance according to Input
<span class="nc bnc" id="L1387" title="All 2 branches missed.">					if (!toBalanceInput.isFieldMultiValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)) {</span>
<span class="nc bnc" id="L1388" title="All 2 branches missed.">						if (toBalanceInput.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)) {</span>
<span class="nc bnc" id="L1389" title="All 2 branches missed.">							if (!toBalanceOld.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)</span>
<span class="nc bnc" id="L1390" title="All 2 branches missed.">									&amp;&amp; toBalanceOld.getMaxBalance() != ActivityTimeOffBalance.MAX_BALANCE_NA) {</span>
<span class="nc" id="L1391">								toBalanceOld.setFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE);</span>
<span class="nc" id="L1392">								modified = true;</span>
							}
						} else {
<span class="nc bnc" id="L1395" title="All 2 branches missed.">							if (toBalanceInput.getMaxBalance() != toBalanceOld.getMaxBalance()</span>
<span class="nc bnc" id="L1396" title="All 2 branches missed.">									|| toBalanceOld.getFieldValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXBALANCE)</span>
											== null/*NullObject or null as new created didn't set*/) {
<span class="nc" id="L1398">								toBalanceOld.setMaxBalance(toBalanceInput.getMaxBalance());</span>
<span class="nc" id="L1399">								modified = true;</span>
							}
						}
					}
<span class="nc bnc" id="L1403" title="All 2 branches missed.">					if (!toBalanceInput.isFieldMultiValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER)) {</span>
<span class="nc bnc" id="L1404" title="All 2 branches missed.">						if (toBalanceInput.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER)) {</span>
<span class="nc bnc" id="L1405" title="All 2 branches missed.">							if (!toBalanceOld.isFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER)</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">									&amp;&amp; toBalanceOld.getMaxCarryOver() != ActivityTimeOffBalance.MAX_BALANCE_NA) {</span>
<span class="nc" id="L1407">								toBalanceOld.setFieldNull(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER);</span>
<span class="nc" id="L1408">								modified = true;</span>
							}
						} else {
<span class="nc bnc" id="L1411" title="All 2 branches missed.">							if (toBalanceInput.getMaxCarryOver() != toBalanceOld.getMaxCarryOver()</span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">									|| toBalanceOld.getFieldValue(ActivityTimeOffBalanceFieldInfo.ACT_TMOFF_BAL_MAXCARRYOVER)</span>
											== null/*NullObject or null as new created didn't set*/) {
<span class="nc" id="L1414">								toBalanceOld.setMaxCarryOver(toBalanceInput.getMaxCarryOver());</span>
<span class="nc" id="L1415">								modified = true;</span>
							}
						}
					}
<span class="nc bnc" id="L1419" title="All 2 branches missed.">					if (modified) {</span>
<span class="nc" id="L1420">						toBalancesNew.add(toBalanceOld);</span>
					}
<span class="nc" id="L1422">				}</span>
<span class="nc" id="L1423">			}</span>

			//Update or Insert, new created toBalance doesn't have an value object ID
<span class="nc bnc" id="L1426" title="All 2 branches missed.">			if (toBalancesNew.size() &gt; 0) {</span>
<span class="nc" id="L1427">				WfmManagerFactory.getActivityManager(m_context.isInWhatIfMode())</span>
<span class="nc" id="L1428">						.updateOrInsertActivityTOBalance(toBalancesNew);</span>
			}
			//Delete
<span class="nc bnc" id="L1431" title="All 2 branches missed.">			if (toBalanceIDsDelete.size() &gt; 0) {</span>
<span class="nc" id="L1432">				WfmManagerFactory.getActivityManager(m_context.isInWhatIfMode())</span>
<span class="nc" id="L1433">						.deleteActivityTOBalance(toBalanceIDsDelete);</span>
			}
<span class="nc" id="L1435">		}</span>

		private String getDbID(ID empID, ID unionID) {
<span class="nc" id="L1438">			return empID.toString() + &quot;+&quot; + unionID.toString();</span>
		}
	}

	public void updateData() throws Exception {
<span class="nc" id="L1443">		m_dataUpdater.updateTOAccrued();</span>
<span class="nc" id="L1444">		m_dataUpdater.updateTOBalance();</span>
<span class="nc" id="L1445">	}</span>

	public List&lt;TOPoolAssignmentsByActivityUpdateParameters&gt; getModifiedPoolAssignmentsByActivity() {
<span class="nc" id="L1448">		return modifiedAssignmentsByActivity;</span>
	}
}//class
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>