<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MyTimeRecordModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.am.timecollection</a> &gt; <span class="el_source">MyTimeRecordModel.java</span></div><h1>MyTimeRecordModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.am.timecollection;

import java.awt.Color;
import java.text.MessageFormat;
import java.util.ArrayList;

import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecord;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecordEntry;
import com.bluepumpkin.ejb.core.profile.model.UserProfile;
import com.bluepumpkin.web.am.l10n.AmWebBundleKey;
import com.bluepumpkin.web.am.timerecords.TimeRecordUtil;
import com.bluepumpkin.web.core.keys.PageKeys;
import com.witness.web.uif.jsp.HtmlLink;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.ColorUtil;
import com.witness.web.uif.util.HtmlUtil;

/**
 * Title:        Blue Pumpkin Software Activity Management
 * Description:  My Time page model
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       Swati Tewari
 * @version      1.0
 */

public class MyTimeRecordModel extends MyTimeModel{
<span class="nc" id="L33">	private boolean m_initialized = false;</span>
	private int m_activityTotal;

	public static final String REFRESH_RATE_FN = &quot;refreshRate&quot;; //form field name
	public static final String TIME_OF_DAY_FN = &quot;timeOfDay&quot;; //for the current time indicator dynamic javascript text
	
	//Refresh rate constants
    public static final int REFRESH_RATE_NOT_SET = -1; //indicates that the refresh rate was not set yet
    public static final int NO_AUTO_REFRESH = -2;
    public static final int DEFAULT_REFRESH_RATE = NO_AUTO_REFRESH;
    public static final String REFRESH_RATE_USER_PROPERTY_KEY = &quot;MyTimeAutoRefresh&quot;; //user profile key    
    
    //Action constants
    public static final String CHANGE_REFRESH_RATE_ACTION = &quot;CHANGE_REFRESH_RATE_ACTION&quot;; //probably not needed, since we have no RH class
    
    //Refresh Rate variables
<span class="nc" id="L49">    private ArrayList m_refreshRateList = null; // a list of refresh rate options for the drop down</span>
<span class="nc" id="L50">    private int m_refreshRate = REFRESH_RATE_NOT_SET;</span>
    
	public MyTimeRecordModel(RequestContext context) throws Exception {
<span class="nc" id="L53">		super(context,MyTimeModel.TIME_RECORD_MODEL);</span>
<span class="nc" id="L54">		addJSVariable(PageKeys.LIST_OFFSET_JS_VAR, &quot;false&quot;);</span>
<span class="nc" id="L55">	}</span>

	public static MyTimeRecordModel getInstance(RequestContext context)throws Exception{
<span class="nc" id="L58">		MyTimeRecordModel model = (MyTimeRecordModel) context.getAttribute(RequestContext.REQUEST_SCOPE,</span>
							MyTimeModel.MODEL_KEY);
<span class="nc bnc" id="L60" title="All 2 branches missed.">		if (model==null){</span>
			//create a new model
<span class="nc" id="L62">			model = new MyTimeRecordModel(context);</span>
			// Cache model
<span class="nc" id="L64">			context.setAttribute(RequestContext.REQUEST_SCOPE, MyTimeModel.MODEL_KEY, model);</span>
		}
<span class="nc" id="L66">		model.populateModel(context);</span>

<span class="nc" id="L68">		return model;</span>
	}

	/**
	 * Make sure that the model is populated
	 */
	private void populateModel(RequestContext context) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">		if ( m_initialized )</span>
<span class="nc" id="L76">			return;</span>
<span class="nc" id="L77">		m_initialized = true;</span>
		try {
<span class="nc bnc" id="L79" title="All 2 branches missed.">			if ( empId != null )</span>
<span class="nc" id="L80">				myTimeEvent = MyTimeModelHandler.getHistoryEventsForToday(empId,m_sortAscend,getStartDateCalendar());</span>
<span class="nc" id="L81">			processActivityGroup(context);</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">			if ( empId != null )</span>
<span class="nc" id="L83">				processCurrentActivity();</span>
<span class="nc" id="L84">		} catch (Exception e) {</span>
<span class="nc" id="L85">		}</span>
<span class="nc" id="L86">	}</span>

	/**
	* getNeedNotes()
	* return boolean
	*/
	public boolean getNeedNotes(){
<span class="nc" id="L93">		return true;</span>
	}

	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc" id="L100">		return &quot;processchangeshift&quot;;</span>
	}

	/**
	 * setPageSN()
	 */
	protected void setPageSN(UserProfile aProfile){
<span class="nc" id="L107">		int sn = getLatestPageSN(aProfile);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">		m_validSN = sn == m_pageSN;</span>
<span class="nc" id="L109">		m_pageSN = sn + 1;</span>
<span class="nc" id="L110">		aProfile.setProperty(MyTimeModel.MYTIME_SN, String.valueOf(m_pageSN), false);</span>
<span class="nc" id="L111">	}</span>

	/**
	 * Return URL for HTML Form Action
	 */
	public String getTimeRecordDisplay() {
<span class="nc" id="L117">		StringBuffer aBuf = new StringBuffer();</span>

<span class="nc bnc" id="L119" title="All 2 branches missed.">        for (int i=0; i&lt;myTimeEvent.size();i++){</span>
<span class="nc" id="L120">			TimeRecord aRecord = (TimeRecord) myTimeEvent.get(i);</span>

			//now get the timerecordentry
<span class="nc" id="L123">			ArrayList anEntryList = (ArrayList)aRecord.getChildren();</span>

			//set entry order per option
<span class="nc bnc" id="L126" title="All 2 branches missed.">			if (  !m_sortAscend ) {</span>
				// reverse order of myTimeEvent
<span class="nc" id="L128">				ArrayList reversedTimeEvent = new ArrayList(anEntryList.size());</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">				for( int entryNum = anEntryList.size() -1; entryNum &gt;= 0 ;entryNum-- ) {</span>
<span class="nc" id="L130">					reversedTimeEvent.add(anEntryList.get(entryNum));</span>
				}
<span class="nc" id="L132">				anEntryList = reversedTimeEvent;</span>
			}
<span class="nc" id="L134">			int countOfItems = anEntryList.size() + 1;</span>

<span class="nc bnc" id="L136" title="All 2 branches missed.">			for (int j=0; j&lt;anEntryList.size(); j++){</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">				switch (aRecord.getType())</span>
				{
					case TimeRecord.AGG_TIMEENTRY:
					case TimeRecord.TIMEENTRY:

<span class="nc" id="L142">					TimeRecordEntry anEntry = (TimeRecordEntry) anEntryList.get(j);</span>
<span class="nc" id="L143">					StringBuilder rowInfo = new StringBuilder();</span>

<span class="nc" id="L145">					String startTime = m_localizer.formatDate(anEntry.getStartTime(),</span>
<span class="nc" id="L146">								m_context.getViewingTimeZone(),</span>
								RegionalFormatBundleKey.DATE_FORMAT,
								RegionalFormatBundleKey.TIME_FORMAT);
										
<span class="nc bnc" id="L150" title="All 4 branches missed.">					if ((m_sortAscend &amp;&amp; j == 0)){</span>
<span class="nc" id="L151">						String startShiftRow = mageStartShiftRow(startTime, countOfItems);</span>
<span class="nc" id="L152">						aBuf.append(startShiftRow);</span>
					}
					
<span class="nc bnc" id="L155" title="All 2 branches missed.">					if (!anEntry.getActivityID().equals(Activity.ACTIVITY_NONE)) { //regular entry </span>
<span class="nc" id="L156">						String duration = m_localizer.formatDurationInMins(anEntry.getDuration());</span>
<span class="nc" id="L157">						String activityCategoryName = anEntry.getActivityCategoryName();</span>
<span class="nc" id="L158">						String activityName = anEntry.getActivityName();</span>
<span class="nc" id="L159">						appendRowInfo(i18n(getBundle(), AmWebBundleKey.ACTIVITY_TYPE), activityCategoryName, rowInfo);</span>
<span class="nc" id="L160">						appendRowInfo(i18n(getBundle(), AmWebBundleKey.ACTIVITY), activityName, rowInfo);</span>
<span class="nc" id="L161">						appendRowInfo(i18n(getBundle(), AmWebBundleKey.DURATION), duration, rowInfo);</span>
<span class="nc" id="L162">						appendRowInfo(i18n(getBundle(), AmWebBundleKey.CREATOR), TimeRecordUtil.getCreatorStr(m_context, getBundle(), aRecord.getType(), anEntry.getTimeSourceCode()), rowInfo);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">						appendRowInfo(i18n(getBundle(), &quot;MY_NOTES&quot;), !StringUtil.isEmpty(anEntry.getDescription())?anEntry.getDescription():&quot;&quot;, rowInfo);</span>
<span class="nc" id="L164">						String activityColor = getActivityColor(anEntry.getActivityID());</span>
<span class="nc" id="L165">						String activityTextColor = &quot;000000&quot;;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">						if (activityColor != null) {</span>
<span class="nc" id="L167">							Color inverseColor = ColorUtil</span>
<span class="nc" id="L168">									.getContrastingColor(new Color(Integer.parseInt(activityColor, 16)));</span>
<span class="nc" id="L169">							activityTextColor = String.format(&quot;%06X&quot;, (0xFFFFFF &amp; inverseColor.getRGB()));</span>
						}
<span class="nc" id="L171">						aBuf.append(&quot;&lt;tr&gt;&quot;)</span>
<span class="nc" id="L172">							.append(makeTDTag(StringUtil.NBSP, null, null, 1))</span>
<span class="nc" id="L173">							.append(getCellWithReadableRowInfo(startTime, rowInfo.toString(), 1, j + 2, countOfItems))</span>
<span class="nc" id="L174">							.append(makeTDTag(activityCategoryName, null, null, 1))</span>
<span class="nc" id="L175">							.append(makeTDTag(activityName, activityColor, activityTextColor, 1))</span>
<span class="nc" id="L176">							.append(makeTDTag(duration, null, null, 1))</span>
<span class="nc" id="L177">							.append(makeTDTag(TimeRecordUtil.getCreatorStr(m_context, getBundle(), aRecord.getType(), anEntry.getTimeSourceCode()), null, null, 1))</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">							.append(makeTDTag(!StringUtil.isEmpty(anEntry.getDescription())?anEntry.getDescription():StringUtil.NBSP, null, null, 1))</span>
<span class="nc" id="L179">							.append(&quot;&lt;/tr&gt;&quot;);</span>
<span class="nc" id="L180">					} else { //end shift					</span>
<span class="nc" id="L181">                       	aBuf.append(getCellWithReadableRowInfo(startTime, rowInfo.toString(), 2, j + 2, countOfItems))</span>
<span class="nc" id="L182">							.append(makeTDTag(i18n(getBundle(), AmWebBundleKey.END_SHIFT), null, null, 3))</span>
<span class="nc" id="L183">							.append(makeTDTag(TimeRecordUtil.getCreatorStr(m_context, getBundle(), aRecord.getType(), anEntry.getTimeSourceCode()), null, null, 1))</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">							.append(makeTDTag(!StringUtil.isEmpty(anEntry.getDescription())?anEntry.getDescription():StringUtil.NBSP, null, null, 1))</span>
<span class="nc" id="L185">							.append(&quot;&lt;/tr&gt;&quot;);</span>
					}

<span class="nc bnc" id="L188" title="All 4 branches missed.">					if (!m_sortAscend &amp;&amp; j == anEntryList.size()-1){</span>
<span class="nc" id="L189">						aBuf.append(mageStartShiftRow(startTime, countOfItems));</span>
					}
					//add to activity total for display
<span class="nc" id="L192">					m_activityTotal += anEntry.getDuration();</span>
					break;
					/*
					case TimeRecord.TIMEINTERVAL:

					TimeInterval anInterval = (TimeInterval) anEntryList.get(j);
					startTime = DateTimeDisplay.getString(anInterval.getStartTime(),
							m_context.getViewingTimeZone(),
							TimeZoneBundleKey.LONG_DATETIME_NOSECOND_FORMAT,m_context.getLocale());
					String endTime = DateTimeDisplay.getString(anInterval.getEndTime(),
							m_context.getViewingTimeZone(),
							TimeZoneBundleKey.LONG_DATETIME_NOSECOND_FORMAT,m_context.getLocale());

					String duration = DateTimeDisplay.getMinutesDisplay(anInterval.getDuration(),m_context.getLocale());
					String intervalBGColor = &quot;C2D2E6&quot;;
					aBuf.append(&quot;&lt;tr&gt;&quot;)
						.append(makeTDTag(startTime + &quot;- &lt;br&gt;&quot;+ endTime, intervalBGColor, 2))
						.append(makeTDTag(anInterval.getActivityCategoryName(), intervalBGColor, 1))
						.append(makeTDTag(anInterval.getActivityName(), getActivityColor(anInterval.getActivityID()), 1))
						.append(makeTDTag(duration, intervalBGColor, 1))
						.append(makeTDTag(TimeRecordUtil.getCreatorStr(getBundle(), aRecord.getType(), anInterval.getTimeSourceCode()), intervalBGColor, 1))
						.append(makeTDTag(!StringUtil.isEmpty(anInterval.getDescription())?anInterval.getDescription():StringUtil.NBSP, intervalBGColor, 1))
						.append(&quot;&lt;/tr&gt;&quot;);

					//add to activity total for display
					m_activityTotal += anInterval.getDuration();
					break;
					*/
				}
			}
		}

<span class="nc" id="L224">		return aBuf.toString();</span>
	}
	
	private String getCellWithReadableRowInfo(String content, String rowInfo, int colspan, int rowNum, int totalCount) {
<span class="nc" id="L228">		String firstCell = makeTDTag(content, null, null, colspan);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L230">			HtmlLink accessibilityAnchor = new HtmlLink();</span>
<span class="nc" id="L231">			accessibilityAnchor.setHref(&quot;#&quot; + rowNum);</span>
<span class="nc" id="L232">			accessibilityAnchor.setOnKeyDown(&quot;window.oTable.onKeyDown(this);&quot;);</span>
<span class="nc" id="L233">			accessibilityAnchor.setAttribute(&quot;class&quot;, &quot;focusableNode&quot;);</span>
<span class="nc" id="L234">			String hiddenRowInfo = HtmlUtil.makeHiddenReadableText(rowInfo);</span>
<span class="nc" id="L235">			String hiddenRowNumInfo = HtmlUtil.makeHiddenReadableText(MessageFormat.format(i18n(m_common_bundle, UIFWebBundleKey.MULTI_COL_LIST_LEVEL_TEMPLATE), rowNum, totalCount));</span>
<span class="nc" id="L236">			String hiddenTimeHeader = HtmlUtil.makeHiddenReadableText(i18n(getBundle(), AmWebBundleKey.TIME));</span>
<span class="nc" id="L237">			StringBuilder cellWithReadableRowInfo = new StringBuilder();</span>
<span class="nc" id="L238">			cellWithReadableRowInfo</span>
<span class="nc" id="L239">					.append(hiddenRowNumInfo)</span>
<span class="nc" id="L240">					.append(hiddenTimeHeader)					</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">					.append(StringUtil.isEmpty(content)?StringUtil.NBSP:content)</span>
<span class="nc" id="L242">					.append(hiddenRowInfo);</span>
<span class="nc" id="L243">			accessibilityAnchor.setInnerHtml(cellWithReadableRowInfo.toString());</span>
<span class="nc" id="L244">			firstCell = makeTDTag(accessibilityAnchor.toString(), null, null, colspan);</span>
		}
<span class="nc" id="L246">		return firstCell;</span>
	}
	
	private void appendRowInfo(String header, String value, StringBuilder builder) {
<span class="nc bnc" id="L250" title="All 4 branches missed.">		if (!StringUtil.isEmpty(value) &amp;&amp; isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L251">			builder</span>
<span class="nc" id="L252">				.append(header)</span>
<span class="nc" id="L253">				.append(&quot; &quot;)</span>
<span class="nc" id="L254">				.append(value)</span>
<span class="nc" id="L255">				.append(&quot; &quot;);</span>
		}
<span class="nc" id="L257">	}</span>

	public String getActivityTotalTime() {
<span class="nc" id="L260">		return m_localizer.formatDurationInMins(m_activityTotal);</span>
	}

	private String makeTDTag(String content, String bgColor, String textColor, int colspan){
<span class="nc" id="L264">		StringBuffer aBuf = new StringBuffer();</span>
<span class="nc" id="L265">		aBuf.append(&quot;&lt;td&quot;);</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">		if (colspan &gt; 1)</span>
<span class="nc" id="L267">			aBuf.append(&quot; colspan=&quot; + colspan);</span>
<span class="nc" id="L268">		aBuf.append(&quot; valign=\&quot;top\&quot; iscell=\&quot;true\&quot;&quot;);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">		if (bgColor!=null){</span>
<span class="nc" id="L270">			aBuf.append( &quot; bgColor=\&quot;#&quot; + bgColor + &quot;\&quot;&quot;);</span>
<span class="nc" id="L271">			aBuf.append(&quot; class=\&quot;scheduleItemNoColor2\&quot;&quot;);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">			if (textColor != null)</span>
<span class="nc" id="L273">				aBuf.append( &quot; style=\&quot;color:#&quot;+textColor + &quot;\&quot;&quot;);</span>
		} else {
<span class="nc" id="L275">         	aBuf.append(&quot; class=\&quot;tableItemNormal\&quot;&quot;);</span>
		}
<span class="nc" id="L277">		aBuf.append(&quot;&gt;&quot;)</span>
<span class="nc" id="L278">			.append(content)</span>
<span class="nc" id="L279">			.append(&quot;&lt;/td&gt;&quot;);</span>

<span class="nc" id="L281">		return aBuf.toString();</span>
	}

	private String mageStartShiftRow(String startTime, int totalCount){
    	//add start shift
<span class="nc" id="L286">		String firstCell = makeTDTag(startTime, null, null, 2);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {			</span>
<span class="nc" id="L288">			firstCell = getCellWithReadableRowInfo(startTime, getStartShiftReadableRowInfo(), 2, 1, totalCount);</span>
		}
<span class="nc" id="L290">		return &quot;&lt;tr&gt;&quot; + firstCell</span>
<span class="nc" id="L291">				+ makeTDTag(i18n(getBundle(), AmWebBundleKey.START_SHIFT), null, null, 5) + &quot;&lt;/tr&gt;&quot;;</span>
	}
	
	private String getStartShiftReadableRowInfo() {
<span class="nc" id="L295">		return i18n(getBundle(), AmWebBundleKey.ACTIVITY_TYPE) + &quot; &quot; +  i18n(getBundle(), AmWebBundleKey.START_SHIFT);</span>
	}

	public String getJavaScriptInitCode() {
<span class="nc" id="L299">		 StringBuffer jsInitCode = new StringBuffer(128);</span>

	        // Add sub-component JavaScript code first
<span class="nc" id="L302">	        jsInitCode.append(super.getJavaScriptInitCode());</span>
	        
<span class="nc" id="L304">	        String template = &quot;\nsetTimeout(\&quot;{0}.refreshPage()\&quot;,{1});\n\n&quot;;</span>
	            
<span class="nc" id="L306">            Object[] args = new Object[] {</span>
<span class="nc" id="L307">                getPageMediatorRef(),</span>
<span class="nc" id="L308">                Integer.toString(getRefreshRate() * 60000)</span>
                
            };
            
<span class="nc bnc" id="L312" title="All 2 branches missed.">            if (getRefreshRate() &gt; 0)</span>
<span class="nc" id="L313">                jsInitCode.append(MessageFormat.format(template, args));</span>
	        
<span class="nc" id="L315">	        return jsInitCode.toString();</span>
	}
	
	private void initRefreshRateComponent(){
<span class="nc" id="L319">		 m_refreshRateList = new ArrayList(7);</span>
<span class="nc" id="L320">        String minutes = i18n(m_bundle, AmWebBundleKey.ADHERENCE_MINUTES);</span>
<span class="nc" id="L321">        String noAutoRefresh = i18n(m_bundle, AmWebBundleKey.ADHERENCE_NO_REFRESH);</span>
<span class="nc" id="L322">        m_refreshRateList.add(new StringsPair(&quot;&quot;+NO_AUTO_REFRESH, noAutoRefresh));</span>
        //m_refreshRateList.add(new StringsPair(&quot;1&quot;, &quot;1 &quot; + minutes));
<span class="nc" id="L324">        m_refreshRateList.add(new StringsPair(&quot;5&quot;, &quot;5 &quot; + minutes));</span>
<span class="nc" id="L325">        m_refreshRateList.add(new StringsPair(&quot;10&quot;, &quot;10 &quot; + minutes));</span>
<span class="nc" id="L326">        m_refreshRateList.add(new StringsPair(&quot;15&quot;, &quot;15 &quot; + minutes));</span>
<span class="nc" id="L327">        m_refreshRateList.add(new StringsPair(&quot;30&quot;, &quot;30 &quot; + minutes));</span>
<span class="nc" id="L328">        m_refreshRateList.add(new StringsPair(&quot;45&quot;, &quot;45 &quot; + minutes));</span>
<span class="nc" id="L329">        m_refreshRateList.add(new StringsPair(&quot;60&quot;, &quot;60 &quot; + minutes));</span>
<span class="nc" id="L330">	}	</span>
	
	/**
     * The output of this method is added to the end of the HTML output, before the &lt;/form&gt; tag.
     * You can use it for placing hidden variables in the HTML.  
     */
    public String getRequiredHTML() 
    {
        //We need to add the refresh rate to the session to maintail selected value when the entire page is reloaded.
<span class="nc" id="L339">        m_context.setAttribute(RequestContext.SESSION_SCOPE, REFRESH_RATE_USER_PROPERTY_KEY, &quot;&quot;+m_refreshRate);</span>
        
        //We also add refresh rate as a hidden variable for when the page reloads (so as not to access session)
<span class="nc" id="L342">        return super.getRequiredHTML() +</span>
<span class="nc" id="L343">                HtmlUtil.makeHiddenInput(REFRESH_RATE_FN, m_refreshRate);</span>
    }
    
    public void setRefreshRate(int rate) 
    {
<span class="nc" id="L348">        m_refreshRate = rate;</span>
<span class="nc" id="L349">    }</span>
    
    public int getRefreshRate() 
    {
        /*if(m_refreshRate == REFRESH_RATE_NOT_SET) 
        {
            //If rate is not set, then try getting it from session. If not in session, then try getting 
            //it from the user profile. If not in profile, then just use the default refresh rate.
            String sRate = (String)m_context.getAttribute(RequestContext.SESSION_SCOPE, REFRESH_RATE_USER_PROPERTY_KEY);
            boolean isFromProfile = false;
            if (sRate == null)
            {
                sRate = m_context.getUserProperty(REFRESH_RATE_USER_PROPERTY_KEY);
                isFromProfile = true;
            }
            
            if (!StringUtil.isEmpty(sRate)) 
            {
                try 
                {
                    int rate = Integer.parseInt(sRate);
                    if ((rate &gt; 0) &amp;&amp; (isFromProfile))
                        rate /= 60;
                    m_refreshRate = getClosestValidRefreshRate(rate); 
                } 
                catch(NumberFormatException e) 
                {
                    m_refreshRate = DEFAULT_REFRESH_RATE;
                }
            }
            else 
            {
                m_refreshRate = DEFAULT_REFRESH_RATE;
            }
        }*/
<span class="nc" id="L384">    	String sRate = m_context.getUserProperty(REFRESH_RATE_USER_PROPERTY_KEY);</span>
    	//boolean isFromProfile = true;
<span class="nc bnc" id="L386" title="All 2 branches missed.">    	 if (!StringUtil.isEmpty(sRate)) </span>
         {
             try 
             {
<span class="nc" id="L390">                 int rate = Integer.parseInt(sRate);</span>
                 /*if ((rate &gt; 0) &amp;&amp; (isFromProfile))
                     rate /= 60;*/
<span class="nc" id="L393">                 m_refreshRate = getClosestValidRefreshRate(rate); </span>
             } 
<span class="nc" id="L395">             catch(NumberFormatException e) </span>
             {
<span class="nc" id="L397">                 m_refreshRate = DEFAULT_REFRESH_RATE;</span>
<span class="nc" id="L398">             }</span>
         }
         else 
         {
<span class="nc" id="L402">             m_refreshRate = DEFAULT_REFRESH_RATE;</span>
         }
    	
<span class="nc" id="L405">        return m_refreshRate;</span>
    }
    
    /**
     * Given an integer, find the closest refresh rate that we support
     * @param rate The desired refresh rate (in minutes)
     * @return the closest supported refresh rate (in minutes)
     */
    private int getClosestValidRefreshRate(int rate)
    {
<span class="nc bnc" id="L415" title="All 2 branches missed.">        if (rate &lt; 0) rate = NO_AUTO_REFRESH;</span>
        //else if (rate &lt; 5) rate = 1;
<span class="nc bnc" id="L417" title="All 2 branches missed.">        else if (rate &lt;= 5) rate = 5;</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">        else if (rate &lt;= 10) rate = 10;</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">        else if (rate &lt;= 15) rate = 15;</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">        else if (rate &lt;= 30) rate = 30;</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">        else if (rate &lt;= 45) rate = 45;</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">        else if (rate &lt;= 60) rate = 60;</span>
<span class="nc" id="L423">        else rate = NO_AUTO_REFRESH;        </span>
<span class="nc" id="L424">        return rate;</span>
    }
    
	public String getRefreshRateComponentHtml() {
<span class="nc" id="L428">		initRefreshRateComponent();</span>

<span class="nc" id="L430">		StringBuffer onClick = new StringBuffer(64);</span>
<span class="nc" id="L431">		onClick.append(getNamePrefix()).append(getName()).append(&quot;.refreshPageWithAction('&quot;)</span>
<span class="nc" id="L432">				.append(CHANGE_REFRESH_RATE_ACTION).append(&quot;')&quot;);</span>

<span class="nc" id="L434">		String refreshRateLabel = i18n(m_bundle, AmWebBundleKey.ADHERENCE_REFRESHRATE_TITLE);</span>
<span class="nc" id="L435">		String refreshPageOnChangeJSVar = &quot;var refreshPage = true;&quot;;</span>
<span class="nc" id="L436">		StringBuffer sb = new StringBuffer(256);</span>
<span class="nc" id="L437">		sb.append(HtmlUtil.TBL_OPEN_TAG).append(&quot;&lt;tr&gt;&lt;td nowrap&gt;\n&quot;).append(&quot;&lt;span class=\&quot;headerText2\&quot; id=\&quot;&quot;)</span>
<span class="nc" id="L438">				.append(TIME_OF_DAY_FN).append(&quot;\&quot; style=\&quot;position:relative;\&quot;&gt;&lt;/span&gt;\n&quot;)</span>
<span class="nc" id="L439">				.append(&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/td&gt;\n&quot;).append(&quot;&lt;td nowrap&gt;&quot;)</span>
<span class="nc" id="L440">				.append(&quot;&lt;span class=\&quot;headerText2\&quot;&gt;&quot;)</span>

<span class="nc" id="L442">				.append(refreshRateLabel).append(&quot;: &lt;/span&gt;&quot;)</span>
<span class="nc" id="L443">				.append(HtmlUtil.makeSelectInput(REFRESH_RATE_FN, &quot;&quot;,</span>
<span class="nc" id="L444">						new String[] { Integer.toString(getRefreshRate()) }, onClick.toString() + &quot;;&quot; + refreshPageOnChangeJSVar, m_refreshRateList,</span>
						null, false, false, true, false, null, null, true, refreshRateLabel, null))
<span class="nc" id="L446">				.append(&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/td&gt;&quot;).append(&quot;&lt;/tr&gt;\n&lt;/table&gt;\n&quot;);</span>

<span class="nc" id="L448">		return sb.toString();</span>
	}
    
    public boolean isMyTimeRecordModel(){
<span class="nc" id="L452">    	return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>