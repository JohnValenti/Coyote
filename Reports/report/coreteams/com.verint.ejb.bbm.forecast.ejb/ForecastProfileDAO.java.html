<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ForecastProfileDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.ejb.bbm.forecast.ejb</a> &gt; <span class="el_source">ForecastProfileDAO.java</span></div><h1>ForecastProfileDAO.java</h1><pre class="source lang-java linenums">package com.verint.ejb.bbm.forecast.ejb;

import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueueFieldInfo;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.dao.OneToManyRelationship;
import com.bluepumpkin.ejb.bbm.dao.RichObjectDAO;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastInstanceFieldInfo;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.verint.ejb.bbm.forecast.model.ForecastProfile;
import com.verint.ejb.bbm.forecast.model.ForecastProfileFieldInfo;

public class ForecastProfileDAO extends RichObjectDAO&lt;ForecastProfile&gt; {

	public static final String NULL_CHECK = &quot; IS NULL &quot;;
	public static final String AND = &quot; AND &quot;;
<span class="fc" id="L30">	private static ForecastProfileFieldInfo m_fieldInfo = new ForecastProfileFieldInfo();</span>

	public ForecastProfileDAO() {
<span class="fc" id="L33">		super();</span>
<span class="fc" id="L34">	}</span>

	public ForecastProfileDAO(Jdmo dmo) {
<span class="nc" id="L37">		super(dmo);</span>
<span class="nc" id="L38">	}</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="fc" id="L42">		return m_fieldInfo;</span>
	}

	protected void buildDBRelationships() {
<span class="fc" id="L46">		ProfileComponentDAO profileComponentDAO = new ProfileComponentDAO(m_dmo);</span>

<span class="fc" id="L48">		addRelationship(new OneToManyRelationship(this, profileComponentDAO, getFieldInfo().getFieldIndexByName(&quot;ID&quot;), profileComponentDAO</span>
<span class="fc" id="L49">			.getFieldInfo().getFieldIndexByName(&quot;FORECASTPROFILEID&quot;), ForecastProfileFieldInfo.PROFILECOMPONENT_RELATIONSHIP_KEY));</span>

<span class="fc" id="L51">	}</span>

	@Override
	protected Map&lt;Integer, ? extends FieldInfo&gt; getForeignKeyFieldInfo() {
<span class="fc" id="L55">		Map&lt;Integer, FieldInfo&gt; retVal = new HashMap&lt;&gt;(super.getForeignKeyFieldInfo());</span>
<span class="fc" id="L56">		retVal.put(ForecastProfileFieldInfo.FORECASTPROFILE_SPQUEUEID, new SPQueueFieldInfo());</span>
<span class="fc" id="L57">		retVal.put(ForecastProfileFieldInfo.FORECASTPROFILE_FORECASTINSTANCEID, new ForecastInstanceFieldInfo());</span>
<span class="fc" id="L58">		return retVal;</span>
	}

	@Override
	protected ForecastProfile createValueObject() {
<span class="fc" id="L63">		return new ForecastProfile();</span>
	}
	

	/**
	 * Finds forecast profile objects that fill the role defined by the parameters.
	 * The ForecastProfile table is used in different ways. 
	 * &lt;p&gt;
	 * &lt;ol&gt;
	 * &lt;li&gt;It is used for active forecasts. In this case, forecastInstanceID is null and 
	 * spQueueID is not null. For active forecasts, records that fill the same role have 
	 * null forecastInstanceID, the same spQueueID, and the same start date
	 * &lt;li&gt;It is used for forecast instances, including base forecast and named instances.
	 * In this case, forecastInstanceID is not null and spQueueID is not null. For instances,
	 * records that fill the same role have the same forecastInstanceID, the same spQueueID,
	 * and the same start date.
	 * &lt;li&gt;It is used for manually saved forecast profiles. In this case, forecastInstanceID is
	 * null and spQueueID is null. For manually saved forecast profiles, records that fill the
	 * same role will have null forecastInstanceID, null SPQueueID, and the same name.
	 * &lt;/ol&gt;
	 * @param spQueueID spQueueID
	 * @param name name
	 * @param forecastInstanceID forecastInstanceID
	 * @param startDate startDate 
	 * @return Collection&lt;ForecastProfile&gt;
	 * @throws BbmFinderException BbmFinderException
	 */
	public Collection&lt;ForecastProfile&gt; getObjectsWithRole(ID spQueueID, String name, ID forecastInstanceID, Date startDate) throws 
			BbmFinderException {
<span class="fc" id="L92">		StringBuilder sql = new StringBuilder(&quot; &quot;);</span>

<span class="fc" id="L94">		sql.append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_SPQUEUEID));</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">		if (spQueueID == null) {</span>
<span class="fc" id="L96">			sql.append(NULL_CHECK);</span>
		} else {
<span class="fc" id="L98">			sql.append(&quot; = &quot;).append(JdmoUtil.asSqlLiteral(convertSIDToDEID(spQueueID, new SPQueueFieldInfo())));</span>
		}

<span class="fc bfc" id="L101" title="All 2 branches covered.">		if (spQueueID == null) {</span>
<span class="fc" id="L102">			sql.append(AND);</span>
<span class="fc" id="L103">			sql.append(&quot;(&quot;);</span>
<span class="fc" id="L104">			sql.append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_NAME));</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">			if (name == null) {</span>
<span class="nc" id="L106">				sql.append(NULL_CHECK);</span>
			} else {
<span class="fc" id="L108">				sql.append(&quot; = &quot;).append(JdmoUtil.asSqlLiteral(name));</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">				if (StringUtil.isEmpty(name)) {</span>
<span class="nc" id="L110">					sql.append(&quot; OR &quot;).append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_NAME)).append(NULL_CHECK);</span>
				}
			}
<span class="fc" id="L113">			sql.append(&quot;)&quot;);</span>
		}

<span class="fc" id="L116">		sql.append(AND);</span>
<span class="fc" id="L117">		sql.append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_FORECASTINSTANCEID));</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">		if (forecastInstanceID == null) {</span>
<span class="fc" id="L119">			sql.append(NULL_CHECK);</span>
		} else {
<span class="fc" id="L121">			sql.append(&quot; = &quot;).append(JdmoUtil.asSqlLiteral(convertSIDToDEID(forecastInstanceID, new ForecastInstanceFieldInfo())));</span>
		}
		
<span class="pc bpc" id="L124" title="1 of 4 branches missed.">		if (spQueueID != null || forecastInstanceID != null) {</span>
<span class="fc" id="L125">			sql.append(AND);</span>
<span class="fc" id="L126">			sql.append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_STARTDATE));</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">			if (startDate == null) {</span>
<span class="nc" id="L128">				sql.append(NULL_CHECK);</span>
			} else {
<span class="fc" id="L130">				sql.append(&quot; = &quot;).append(JdmoUtil.asSqlLiteral(startDate));</span>
			}
		}
<span class="fc" id="L133">		return getObjects(sql.toString());</span>
	}

	public Collection&lt;ForecastProfile&gt; getObjectsByForecastInstanceID(ID forecastInstanceID) throws BbmFinderException {
<span class="fc" id="L137">		ID forecastInstanceDEID = DAOUtil.mapIDToDEID(forecastInstanceID, new ForecastInstanceFieldInfo());</span>
<span class="fc" id="L138">		return getObjects(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_FORECASTINSTANCEID) + &quot; = &quot; + JdmoUtil</span>
<span class="fc" id="L139">			.asSqlLiteral(forecastInstanceDEID));</span>
	}

	//QC-117409 (from QC-115976) ESR 4113828 Port to 11.2
	/**
	 * Returns the objects matching the forecastInstanceID and the spQueueID
	 * @param forecastInstanceID forecastInstanceID
	 * @param spQueueIDs spQueueIDs
	 * @return Collection&lt;ForecastProfile&gt;
	 * @throws BbmFinderException BbmFinderException
	 */
	public Collection&lt;ForecastProfile&gt; getObjectsByForecastInstanceAndSPQueueID(ID forecastInstanceID, Collection &lt;? extends ID&gt; spQueueIDs) 
		throws BbmFinderException {
<span class="nc" id="L152">		StringBuilder sql = new StringBuilder(&quot; &quot;);</span>
<span class="nc" id="L153">		sql.append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_FORECASTINSTANCEID));</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">		if (forecastInstanceID == null) {</span>
<span class="nc" id="L155">			sql.append(NULL_CHECK);</span>
		} else {
<span class="nc" id="L157">			sql.append(&quot; = &quot;).append(JdmoUtil.asSqlLiteral(convertSIDToDEID(forecastInstanceID, new ForecastInstanceFieldInfo())));</span>
		}
		
<span class="nc bnc" id="L160" title="All 4 branches missed.">		if (spQueueIDs != null &amp;&amp; !spQueueIDs.isEmpty()) {</span>
<span class="nc" id="L161">			sql.append(AND);</span>
<span class="nc" id="L162">			sql.append(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_SPQUEUEID));</span>
<span class="nc" id="L163">			sql.append(&quot; IN &quot;);</span>
			try {
<span class="nc" id="L165">				sql.append(getDMO().createInClause(convertSIDsToDEIDs(spQueueIDs, new SPQueueFieldInfo())));</span>
<span class="nc" id="L166">			} catch (JdmoException e) {</span>
<span class="nc" id="L167">				throw new BbmFinderException(e);</span>
<span class="nc" id="L168">			}</span>
			
		}
		
<span class="nc" id="L172">		return getObjects(sql.toString());</span>
	}

	
	public void deleteObjectsByInstanceAndSPQueues(ID forecastInstanceID, Collection&lt;? extends ID&gt; spQueueIDs) throws BbmRemoveException {
		try {
<span class="nc" id="L178">			Collection&lt;ID&gt; idCol = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">			for (ForecastProfile fp : getObjectsByForecastInstanceID(forecastInstanceID)) {</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">				if (spQueueIDs.contains(fp.getSPQueueID())) {</span>
<span class="nc" id="L181">					idCol.add(fp.getID());</span>
				}
<span class="nc" id="L183">			}</span>
<span class="nc" id="L184">			deleteObjects(idCol);</span>
<span class="nc" id="L185">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L186">			throw new BbmRemoveException(e);</span>
<span class="nc" id="L187">		}</span>
<span class="nc" id="L188">	}</span>
	
	public Collection&lt;ForecastProfile&gt; getActive(Collection&lt;ID&gt; spQueueIDs) throws BbmFinderException {
		try {
<span class="fc" id="L192">			return getObjects(&quot; FORECASTINSTANCEID IS NULL AND SPQUEUEID in &quot; +</span>
<span class="fc" id="L193">					getDMO().createInClause(convertSIDsToDEIDs(spQueueIDs, new SPQueueFieldInfo())));</span>
<span class="nc" id="L194">		} catch (Exception ex) {</span>
<span class="nc" id="L195">			throw new BbmFinderException(ex);</span>
		}
	}

	public Collection&lt;ForecastProfile&gt; getObjectsBySPQueueID(ID spQueueID) throws BbmFinderException {
<span class="nc" id="L200">		Collection&lt;ID&gt; deIDs = convertSIDsToDEIDs(Collections.singleton(spQueueID), new SPQueueFieldInfo());</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">		if (deIDs.isEmpty()) {</span>
<span class="nc" id="L202">			throw new BbmFinderException();</span>
		}
<span class="nc" id="L204">		return getObjects(m_fieldInfo.getFieldName(ForecastProfileFieldInfo.FORECASTPROFILE_SPQUEUEID) + &quot; = &quot; + JdmoUtil.asSqlLiteral</span>
<span class="nc" id="L205">			(deIDs.iterator().next()));</span>
	}

	Collection&lt;ID&gt; convertSIDsToDEIDs(Collection&lt;? extends ID&gt; sIDs, FieldInfo fieldInfo) throws BbmFinderException {
<span class="fc" id="L209">		return DAOUtil.mapIDsToDEIDs(sIDs, fieldInfo).values();</span>
	}
	
	ID convertSIDToDEID(ID sID, FieldInfo fieldInfo) throws BbmFinderException {
<span class="fc" id="L213">		return DAOUtil.mapIDToDEID(sID, fieldInfo);</span>
	}


	public void deleteObjectsBySpQueueID(ID spQueueId) throws BbmRemoveException {
<span class="nc bnc" id="L218" title="All 2 branches missed.">		if (spQueueId == null) {</span>
<span class="nc" id="L219">			return;</span>
		}
		try {
<span class="nc" id="L222">			String strSQL = &quot;delete from FORECASTPROFILE where SID=(select FORECASTPROFILE.SID from FORECASTPROFILE,SPQUEUE where &quot; +</span>
				&quot;FORECASTPROFILE.SPQUEUEID=SPQUEUE.ID and SPQUEUE.SID=?)&quot;;

<span class="nc" id="L225">			Object[] param = new Object[1];</span>
<span class="nc" id="L226">			param[0] = spQueueId;</span>
<span class="nc" id="L227">			getDMO().executePCommand(strSQL, param);</span>
<span class="nc" id="L228">		} catch(JdmoException e) {</span>
<span class="nc" id="L229">			throw new BbmRemoveException(e);</span>
<span class="nc" id="L230">		}</span>
<span class="nc" id="L231">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>