<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AssignmentRuleInlineEditListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">AssignmentRuleInlineEditListPC.java</span></div><h1>AssignmentRuleInlineEditListPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRule;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceComplexWorkRuleFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.CalendarPeriod;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.widgets.CheckBoxDropDownSelectionPC;
import com.verint.web.fs.widgets.IntegerDropDownSelection;
import com.verint.web.fs.workrules.WorkRulesJSFileID;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.InsertableMultiColListPC;
import com.witness.web.uif.pagecomponent.table.DefaultHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.WorkpaneMultiColPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.SortUtil;
import com.witness.web.uif.util.TimeUtil;
import com.witness.web.uif.util.js.JSUtil;

import javax.servlet.http.HttpServletRequest;
import java.util.*;

public class AssignmentRuleInlineEditListPC extends InsertableMultiColListPC {
	private static final long serialVersionUID = 1L;

	private static final String ACTIVE_DD_TEXT_JS_VAR = &quot;ACTIVE_DD_TEXT_JS_VAR&quot;;
	private static final String INACTIVE_DD_TEXT_JS_VAR = &quot;INACTIVE_DD_TEXT_JS_VAR&quot;;

<span class="pc" id="L45">	private Collection&lt;WorkResourceComplexWorkRule&gt; assignments = new ArrayList&lt;WorkResourceComplexWorkRule&gt;();</span>
	//key = workresourcecomplexworkrule ID, value = associated workresourcecomplexworkrule
<span class="pc" id="L47">	private HashMap&lt;ID, WorkResourceComplexWorkRule&gt; modifiedAssignments =</span>
			new HashMap&lt;ID, WorkResourceComplexWorkRule&gt;();
	private Calendar viewStartDate;
	private Calendar viewEndDate;
	private ResourceBundle fsWebBundle;
<span class="pc" id="L52">	private boolean isAjaxRequest = false;</span>
<span class="pc" id="L53">	private boolean didTimePeriodChange = false;</span>
<span class="pc" id="L54">	private boolean isReadOnly = false;</span>
	//Assignment rules (sometimes) have their start date stored
	//relative to their org's time zone.  We need the associated orgs so we
	//can translate back to midnight GMT.
<span class="pc" id="L58">	private Map&lt;ID, Organization&gt; orgMap = new HashMap&lt;ID, Organization&gt;();</span>

	public AssignmentRuleInlineEditListPC(RequestContext context, String name,
			Collection&lt;WorkResourceComplexWorkRule&gt; assignmentRuleAssignments,
			Date viewStartDate, Date viewEndDate, Collection&lt;ID&gt; employeeIDs,
			boolean isReadOnly, boolean didTimePeriodChange, Map&lt;ID, Organization&gt; orgMap) {
<span class="fc" id="L64">		super(context);</span>
<span class="fc" id="L65">		setName(name);</span>
<span class="fc" id="L66">		this.assignments = assignmentRuleAssignments;</span>
<span class="fc" id="L67">		this.viewStartDate = Calendar.getInstance();</span>
<span class="fc" id="L68">		this.viewStartDate.setTime(viewStartDate);</span>
<span class="fc" id="L69">		this.viewEndDate = Calendar.getInstance();</span>
<span class="fc" id="L70">		this.viewEndDate.setTime(viewEndDate);</span>
<span class="fc" id="L71">		this.didTimePeriodChange = didTimePeriodChange;</span>
<span class="fc" id="L72">		this.isReadOnly = isReadOnly;</span>
<span class="fc" id="L73">		this.orgMap = orgMap;</span>

<span class="fc" id="L75">		fsWebBundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

<span class="fc" id="L77">		ToolbarPC toolbar = new ToolbarPC(m_context);</span>
<span class="fc" id="L78">		toolbar.setName(&quot;assignmentRuleToolbar&quot;);</span>
<span class="fc" id="L79">		ToolbarTextButton addButton = toolbar.createPopupWindowButton(AssignmentRuleListPopupPM.POPUP_ID,</span>
<span class="fc" id="L80">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_ADD), true);</span>
<span class="fc" id="L81">		addButton.setAttribute(&quot;viewStartDate&quot;, Long.toString(this.viewStartDate.getTimeInMillis()));</span>
<span class="fc" id="L82">		addButton.setAttribute(&quot;viewEndDate&quot;, Long.toString(this.viewEndDate.getTimeInMillis()));</span>
<span class="fc" id="L83">		addButton.setAttribute(&quot;onClick&quot;, getFilterJSForAddButton(getName(), toolbar.getName(), AssignmentRuleListPopupPM.POPUP_ID));</span>

<span class="fc" id="L85">		ToolbarTextButton removeButton = new ToolbarTextButton(toolbar, &quot;removeAssignmentRule&quot;,</span>
<span class="fc" id="L86">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_REMOVE),</span>
				InsertableMultiColListPC.REMOVE_ROW_BUTTON_ACTION, ToolbarTextButton.BLUE_BUTTON, false);
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">		if (isReadOnly) {</span>
<span class="nc" id="L89">			addButton.setEnabled(false);</span>
<span class="nc" id="L90">			removeButton.setEnabled(false);</span>
<span class="nc" id="L91">			setRowSelectable(false);</span>
		}
<span class="fc" id="L93">		toolbar.addToolbarElement(addButton);</span>
<span class="fc" id="L94">		toolbar.addToolbarElement(removeButton);</span>

<span class="fc" id="L96">		setIsBorderEnabled(true);</span>
<span class="fc" id="L97">		setToolbar(toolbar);</span>

<span class="fc" id="L99">		addPopupArgs(AssignmentRuleListPopupPM.POPUP_ID, AssignmentRuleListPopupPM.FORM_ACTION, &quot;&quot;,</span>
				AssignmentRuleListPopupPM.POPUP_ARGS, &quot;1000,600,ctr,ctr&quot;, true, 1);

		//If we don't have any rows for the list on initial load, we still need to get the required
		// js files from the inline components that may be added dynamically
<span class="fc" id="L104">		IntegerDropDownSelection dummyIntegerSelectionPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="fc" id="L105">				getName() + &quot;_dummyIntegerSelectionPC&quot;, 0, 0);</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">		for (String js : dummyIntegerSelectionPC.getRequireJavaScriptFiles()) {</span>
<span class="fc" id="L107">			addRequiredJavaScriptFile(js);</span>
<span class="fc" id="L108">		}</span>
<span class="fc" id="L109">		CheckBoxDropDownSelectionPC&lt;Integer&gt; dummyCheckBoxSelectionPC = new CheckBoxDropDownSelectionPC&lt;Integer&gt;(getRequestContext(),</span>
<span class="fc" id="L110">				getName() + &quot;_dummyCheckBoxSelectionPC&quot;);</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">		for (String js : dummyCheckBoxSelectionPC.getRequireJavaScriptFiles()) {</span>
<span class="fc" id="L112">			addRequiredJavaScriptFile(js);</span>
<span class="fc" id="L113">		}</span>

<span class="fc" id="L115">		extractParameters(m_context.getRequest());</span>

<span class="fc" id="L117">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="fc" id="L118">		setJSMediator(WorkRulesJSFileID.ASSIGNMENT_RULE_INLINE_EDIT_PC);</span>
<span class="fc" id="L119">		addJSVariable(ACTIVE_DD_TEXT_JS_VAR, fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_ACTIVE);</span>
<span class="fc" id="L120">		addJSVariable(INACTIVE_DD_TEXT_JS_VAR, fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_INACTIVE);</span>
<span class="fc" id="L121">	}</span>

	//This constructor is used by EmployeeAssignmentInlineEditRH to dynamically generate a row
	public AssignmentRuleInlineEditListPC(RequestContext context, String name,
			Collection&lt;WorkResourceComplexWorkRule&gt; assignmentRuleAssignments,
			Date viewStartDate, Date viewEndDate, Map&lt;ID, Organization&gt; orgMap) {
<span class="nc" id="L127">		super(context);</span>

<span class="nc" id="L129">		setName(name);</span>
<span class="nc" id="L130">		fsWebBundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L131">		this.assignments = assignmentRuleAssignments;</span>
<span class="nc" id="L132">		this.viewStartDate = Calendar.getInstance();</span>
<span class="nc" id="L133">		this.viewStartDate.setTime(viewStartDate);</span>
<span class="nc" id="L134">		this.viewEndDate = Calendar.getInstance();</span>
<span class="nc" id="L135">		this.viewEndDate.setTime(viewEndDate);</span>
<span class="nc" id="L136">		this.isAjaxRequest = true;</span>
<span class="nc" id="L137">		this.orgMap = orgMap;</span>
<span class="nc" id="L138">	}</span>

	public String getJavaScriptInitCode() {
<span class="fc" id="L141">		StringBuffer js = new StringBuffer(super.getJavaScriptInitCode());</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">		if (getToolbar() != null) {</span>
<span class="fc" id="L143">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.setToolbar(&quot;).append(getToolbar().getName()).append(&quot;);&quot;);</span>
<span class="fc" id="L144">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.addButtonEnableAttribute('isDeleteable', 'removeAssignmentRule');\n&quot;);</span>
		}
<span class="fc" id="L146">		return js.toString();</span>
	}

<span class="pc" id="L149">	private boolean isHeaderInited = false;</span>

	private void initHeader() {
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">		if (isHeaderInited) {</span>
<span class="nc" id="L153">			return;</span>
		}
<span class="fc" id="L155">		isHeaderInited = true;</span>

<span class="fc" id="L157">		TableHeaderPC header = getHeader();</span>
<span class="fc" id="L158">		Localizer localizer = m_context.getLocalizer();</span>
<span class="fc" id="L159">		DefaultHeaderData dhd = new DefaultHeaderData(FsWebBundleKey.FS_ASSIGNMENT_RULE,</span>
<span class="fc" id="L160">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ASSIGNMENT_RULE));</span>
<span class="fc" id="L161">		dhd.addImageButton(getInfoButtonPopupImage(), getInfoButtonPopupCaption(), getInfoButtonPopupJS());</span>
<span class="fc" id="L162">		dhd.setSortable(false);</span>
<span class="fc" id="L163">		header.addColumnHeaderData(dhd);</span>
<span class="fc" id="L164">		header.addColumnHeaderData(FsWebBundleKey.FS_ASSIGNMENT_RULE_CYCLE, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ASSIGNMENT_RULE_CYCLE));</span>
<span class="fc" id="L165">		header.addColumnHeaderData(FsWebBundleKey.FS_ASSIGNMENT_RULE_PATTERN, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ASSIGNMENT_RULE_PATTERN));</span>
<span class="fc" id="L166">		header.addColumnHeaderData(FsWebBundleKey.FS_ASSIGNMENT_RULE_WEEK, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_ASSIGNMENT_RULE_WEEK));</span>
<span class="fc" id="L167">	}</span>

	private String getInfoButtonPopupImage() {
<span class="fc" id="L170">		return ImageFileID.TOOLTIP_BUTTON;</span>
	}

	private String getInfoButtonPopupCaption() {
<span class="fc" id="L174">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_VIEW_ASSIGNMENT_RULE_DETAILS);</span>
	}

	private String getInfoButtonPopupJS() {
<span class="fc" id="L178">		return &quot;WorkRulesUtil.handleInfoPopup(this, &quot; + getName() + &quot;,&quot; + getHeader().getName() + &quot;,'&quot; +</span>
				AssignmentRuleListPopupPM.POPUP_ID + &quot;','&quot; + AssignmentRuleListPopupPM.POPUP_ARG_ASSIGNMENT_RULE_ID + &quot;','&quot; +
				AssignmentRuleListPopupPM.POPUP_ARG_SELECTED_IDS + &quot;','&quot; + AssignmentRuleListPopupPM.POPUP_ARG_IS_INFO_POPUP +
				&quot;','true');&quot;;
	}

<span class="pc" id="L184">	private boolean isRowsInited = false;</span>

	private void initRows() throws Exception {
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">		if (isRowsInited) {</span>
<span class="nc" id="L188">			return;</span>
		}
<span class="fc" id="L190">		isRowsInited = true;</span>

<span class="fc" id="L192">		List&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>

<span class="fc" id="L194">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">		for (WorkResourceComplexWorkRule wrcwr : assignments) {</span>
<span class="fc" id="L196">			rows.add(getNodeData(wrcwr));</span>
<span class="fc" id="L197">			ids.add(wrcwr.getComplexWorkRule().getID());</span>
<span class="fc" id="L198">		}</span>

		//Sort the rows by item name
<span class="fc" id="L201">		SortUtil.sort(rows, getHeader().getColumnIndexByName(FsWebBundleKey.FS_ASSIGNMENT_RULE), true, m_context.getLocalizer());</span>

<span class="fc" id="L203">		this.setRowIDs(StringUtil.createDelimitedString(ids.toArray(new ID[ids.size()])));</span>
<span class="fc" id="L204">	}</span>

	public String getRowHtml(WorkResourceComplexWorkRule wrcwr) {
<span class="nc" id="L207">		StringBuffer html = new StringBuffer();</span>

<span class="nc" id="L209">		super.appendHtmlRowData(html, getNodeData(wrcwr), 0, 0);</span>

		//Create the javascript to instantiate the objects for the inline controls
<span class="nc" id="L212">		html.append(HtmlUtil.jsTag(jsInitCode.toString(), false));</span>
<span class="nc" id="L213">		jsInitCode.setLength(0);</span>

<span class="nc" id="L215">		return html.toString();</span>
	}

<span class="pc" id="L218">	private StringBuffer jsInitCode = new StringBuffer();</span>

	protected DefaultMultiColumnNodeData getNodeData(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L221">		DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(wrcwr.getComplexWorkRule().getID());</span>

		//Name
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">		if (wrcwr.isMultiEditCommon()) {</span>
<span class="fc" id="L225">			nodeData.add(wrcwr.getComplexWorkRule().getName());</span>
		} else {
<span class="nc" id="L227">			nodeData.add(&quot;*&quot; + wrcwr.getComplexWorkRule().getName());</span>
		}

		//Only add cycle, pattern and week dropdowns if the work rule has a calendar period defined in weeks
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">		if (wrcwr.getComplexWorkRule().getCalendarPeriod() != null &amp;&amp;</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">				wrcwr.getComplexWorkRule().getCalendarPeriod().getCalendarUnit() == CalendarPeriod.CalendarUnit.Week) {</span>
			//Cycle
<span class="fc" id="L234">			IntegerDropDownSelection cycleDDPC = getCycleDDPC(wrcwr);</span>
<span class="fc" id="L235">			addChildComponent(cycleDDPC);</span>
<span class="fc" id="L236">			nodeData.add(cycleDDPC);</span>

			//Pattern
			//Initialize weekddpc here since we need the display value of the week dd for the pattern dd
<span class="fc" id="L240">			IntegerDropDownSelection weekDDPC = getWeekDDPC(wrcwr);</span>
<span class="fc" id="L241">			CheckBoxDropDownSelectionPC&lt;Integer&gt; patternDDPC = getPatternDDPC(wrcwr, weekDDPC);</span>
<span class="fc" id="L242">			addChildComponent(patternDDPC);</span>
<span class="fc" id="L243">			nodeData.add(patternDDPC);</span>

			//Week
<span class="fc" id="L246">			addChildComponent(weekDDPC);</span>
<span class="fc" id="L247">			nodeData.add(weekDDPC);</span>

<span class="pc bpc" id="L249" title="1 of 2 branches missed.">			if (isAjaxRequest) {</span>
<span class="nc" id="L250">				jsInitCode.append(cycleDDPC.getJavaScriptInitCode());</span>
<span class="nc" id="L251">				jsInitCode.append(weekDDPC.getJavaScriptInitCode());</span>
<span class="nc" id="L252">				jsInitCode.append(patternDDPC.getJavaScriptInitCode());</span>
<span class="nc" id="L253">				jsInitCode.append(&quot;var &quot; + getWeekOffsetJSVarName(wrcwr) + &quot; = &quot; +</span>
<span class="nc" id="L254">						wrcwr.getStartWeekOffSet() + &quot;;&quot;);</span>
<span class="nc" id="L255">				jsInitCode.append(&quot;var &quot; + getWeeksBetweenJSVarName(wrcwr) + &quot; = &quot; +</span>
<span class="nc" id="L256">						TimeUtil.getWeeksCountBetweenDates(getWorkRuleCreateDate(wrcwr), viewStartDate) + &quot;;&quot;);</span>
			} else {
<span class="fc" id="L258">				addJSVariable(getWeekOffsetJSVarName(wrcwr), wrcwr.getStartWeekOffSet());</span>
<span class="fc" id="L259">				addJSVariable(getWeeksBetweenJSVarName(wrcwr),</span>
<span class="fc" id="L260">						TimeUtil.getWeeksCountBetweenDates(getWorkRuleCreateDate(wrcwr), viewStartDate));</span>
			}
<span class="fc" id="L262">		} else {</span>
<span class="nc" id="L263">			nodeData.add(&quot;&quot;);</span>
<span class="nc" id="L264">			nodeData.add(&quot;&quot;);</span>
<span class="nc" id="L265">			nodeData.add(&quot;&quot;);</span>
		}

<span class="fc" id="L268">		setRowAttributes(nodeData, wrcwr);</span>
<span class="fc" id="L269">		return nodeData;</span>
	}

	protected void setRowAttributes(DefaultMultiColumnNodeData mcnd, WorkResourceComplexWorkRule wrcwr) {
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">		if (!wrcwr.isMultiEditCommon()) {</span>
<span class="nc" id="L274">			mcnd.setNodeAttribute(ROW_ATTRIBUTE_MULTI_EDIT_NOT_COMMON, String.valueOf(true));</span>
		}
<span class="fc" id="L276">		mcnd.setNodeAttribute(WorkpaneMultiColPM.IS_DELETEABLE, String.valueOf(true));</span>
<span class="fc" id="L277">		mcnd.setNodeAttribute(AssignmentRuleListPopupPM.POPUP_ARG_ASSIGNMENT_RULE_ID, wrcwr.getComplexWorkRule().getID().toString());</span>
<span class="fc" id="L278">	}</span>

<span class="pc" id="L280">	private boolean isExtracted = false;</span>

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc bfc" id="L284" title="All 2 branches covered.">		if (isExtracted) {</span>
<span class="fc" id="L285">			return true;</span>
		}
<span class="fc" id="L287">		isExtracted = true;</span>
<span class="fc" id="L288">		boolean retVal = true;</span>
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">		if (didTimePeriodChange == false) {</span>
<span class="fc" id="L290">			retVal = super.extractParameters(request);</span>
		}

		// removed
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">		for (ID removedID : getRemovedRowIDCollection()) {</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">			for (WorkResourceComplexWorkRule wrcwr : assignments) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">				if (removedID.equals(wrcwr.getComplexWorkRule().getID())) {</span>
<span class="nc" id="L297">					assignments.remove(wrcwr);</span>
<span class="nc" id="L298">					break;</span>
				}
<span class="nc" id="L300">			}</span>
<span class="nc" id="L301">		}</span>

		try {
			// added
<span class="fc" id="L305">			Collection&lt;ID&gt; addedIDs = getAddedRowIDCollection();</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">			if (addedIDs.size() &gt; 0) {</span>
<span class="fc" id="L307">				HashSet&lt;Integer&gt; defaultEnabledWeeks = new HashSet&lt;Integer&gt;();</span>
<span class="fc" id="L308">				defaultEnabledWeeks.add(0);</span>
<span class="fc" id="L309">				HashSet&lt;ID&gt; newOrgIDs = new HashSet&lt;ID&gt;();</span>
<span class="fc bfc" id="L310" title="All 2 branches covered.">				for (ComplexWorkRule cwr : WorkRulesModelHandler.getComplexWorkRulesByIDs(m_context, addedIDs)) {</span>
<span class="fc" id="L311">					newOrgIDs.add(cwr.getOrganizationID());</span>
<span class="fc" id="L312">					WorkResourceComplexWorkRule wrcwr = new WorkResourceComplexWorkRule();</span>
<span class="fc" id="L313">					wrcwr.setComplexWorkRule(cwr);</span>
<span class="fc" id="L314">					wrcwr.setMultiEditCommon(true);</span>
<span class="fc" id="L315">					wrcwr.setWeeksEnabled(defaultEnabledWeeks);</span>
					//If this work rule is already present in assignments, make sure to remove it before re-adding.
					//This case happens when the user removes a work rule and then re-adds the same rule.
<span class="fc" id="L318">					WorkResourceComplexWorkRule existingAssignment = null;</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">					for (WorkResourceComplexWorkRule existingWrcwr : assignments) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">						if (existingWrcwr.getComplexWorkRule().getID().equals(cwr.getID())) {</span>
<span class="nc" id="L321">							existingAssignment = existingWrcwr;</span>
<span class="nc" id="L322">							break;</span>
						}
<span class="nc" id="L324">					}</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">					if (existingAssignment != null) {</span>
<span class="nc" id="L326">						assignments.remove(existingAssignment);</span>
					}
<span class="fc" id="L328">					assignments.add(wrcwr); // This will be updated in the initRows method call below</span>
<span class="fc" id="L329">				}</span>
				//For any new assignments, we need to grab the organization of the work rule and add it to the org map
<span class="fc" id="L331">				Collection&lt;Organization&gt; newOrgs = OrganizationModelHandler.getOrganizationsByIDs(m_context, newOrgIDs);</span>
<span class="fc bfc" id="L332" title="All 2 branches covered.">				for (Organization org : newOrgs) {</span>
<span class="fc" id="L333">					orgMap.put(org.getID(), org);</span>
<span class="fc" id="L334">				}</span>
			}
<span class="fc" id="L336">			initHeader();</span>
<span class="fc" id="L337">			initRows();</span>
<span class="nc" id="L338">		} catch (Exception e) {</span>
<span class="nc" id="L339">			retVal = false;</span>
<span class="nc" id="L340">			handleUnableToLoadDataError(log, e);</span>
<span class="fc" id="L341">		}</span>

<span class="fc" id="L343">		return retVal;</span>
	}

	private String getCycleDDPCName(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L347">		return getName() + &quot;_cycleDDPC_&quot; + JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString());</span>
	}

	private String getPatternDDPCName(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L351">		return getName() + &quot;_patternDDPC_&quot; + JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString());</span>
	}

	private String getWeekDDPCName(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L355">		return getName() + &quot;_weekDDPC_&quot; + JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString());</span>
	}

	private String getWeekOffsetJSVarName(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L359">		return getName() + &quot;_weekOffset_&quot; + JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString());</span>
	}

	private String getWeeksBetweenJSVarName(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L363">		return getName() + &quot;_weeksBetween_&quot; + JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString());</span>
	}

	private IntegerDropDownSelection getCycleDDPC(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L367">		IntegerDropDownSelection cycleDDPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="fc" id="L368">				getCycleDDPCName(wrcwr), 1, 26);</span>
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">		if (isCycleMultiEdit(wrcwr)) {</span>
<span class="nc" id="L370">			cycleDDPC.setMultiEdit(true);</span>
		} else {
<span class="fc" id="L372">			cycleDDPC.setSelectedIDs(Collections.singleton(Integer.toString(wrcwr.getNumWeeksInRotation())));</span>
		}

		//When this dropdown is changed, the pattern and week dropdowns need to be repopulated
<span class="fc" id="L376">		cycleDDPC.setOnChangeJS(getName() + &quot;.cycleDDPCChanged('&quot; +</span>
<span class="fc" id="L377">				JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString()) + &quot;');&quot;);</span>

<span class="fc" id="L379">		cycleDDPC.extractParameters(m_context.getRequest());</span>
<span class="pc bpc" id="L380" title="2 of 4 branches missed.">		if (assignments != null &amp;&amp; assignments.contains(wrcwr)) {</span>
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">			if (cycleDDPC.isEdited()) {</span>
<span class="nc" id="L382">				cycleDDPC.setMultiEdit(false);</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">				if (modifiedAssignments.containsKey(wrcwr.getID())) {</span>
<span class="nc" id="L384">					modifiedAssignments.get(wrcwr.getID()).setNumWeeksInRotation(cycleDDPC.getSelections().iterator().next());</span>
<span class="nc" id="L385">					modifiedAssignments.get(wrcwr.getID()).setNumWeeksInRotationModified(true);</span>
				} else {
<span class="nc" id="L387">					wrcwr.setNumWeeksInRotation(cycleDDPC.getSelections().iterator().next());</span>
<span class="nc" id="L388">					wrcwr.setNumWeeksInRotationModified(true);</span>
					//Only add to modified assignments if this is not a newly added assignment
<span class="nc bnc" id="L390" title="All 2 branches missed.">					if (wrcwr.getID() != null) {</span>
<span class="nc" id="L391">						modifiedAssignments.put(wrcwr.getID(), wrcwr);</span>
					}
				}
			}
<span class="pc bpc" id="L395" title="4 of 6 branches missed.">			if ((wrcwr.isMultiEditCommon() || cycleDDPC.isEdited()) &amp;&amp; cycleDDPC.getSelections().size() &gt; 0) {</span>
<span class="fc" id="L396">				wrcwr.setNumWeeksInRotation(cycleDDPC.getSelections().iterator().next());</span>
			}
		}

<span class="pc bpc" id="L400" title="1 of 2 branches missed.">		if (isReadOnly) {</span>
<span class="nc" id="L401">			cycleDDPC.setEnabled(false);</span>
		}

<span class="fc" id="L404">		return cycleDDPC;</span>
	}

	private CheckBoxDropDownSelectionPC&lt;Integer&gt; getPatternDDPC(WorkResourceComplexWorkRule wrcwr, IntegerDropDownSelection weekDDPC) {
<span class="fc" id="L408">		CheckBoxDropDownSelectionPC&lt;Integer&gt; ddpc =</span>
<span class="fc" id="L409">				new CheckBoxDropDownSelectionPC&lt;Integer&gt;(getRequestContext(), getPatternDDPCName(wrcwr));</span>

<span class="fc" id="L411">		ddpc.setDisableAutoUpdateOfInputText(true);</span>
<span class="fc" id="L412">		ddpc.setOnChangeJS(getName() + &quot;.patternDDPCChanged('&quot; +</span>
<span class="fc" id="L413">				JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString()) + &quot;');&quot;);</span>
<span class="fc" id="L414">		int maxWidth = i18n(fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_INACTIVE).length() * 7 + 25;</span>

<span class="pc bpc" id="L416" title="1 of 2 branches missed.">		if (isReadOnly) {</span>
<span class="nc" id="L417">			ddpc.setEnabled(false);</span>
		}

<span class="pc bpc" id="L420" title="3 of 6 branches missed.">		if (isCycleMultiEdit(wrcwr) || isWeekMultiEdit(wrcwr) || isWeekMultiEdit(wrcwr)) {</span>
<span class="nc" id="L421">			ddpc.setMultiEdit(true);</span>
<span class="nc" id="L422">			ddpc.setEnabled(false);</span>
		} else {
<span class="fc" id="L424">			populatePatternDDOptions(ddpc, weekDDPC, wrcwr);</span>
		}

<span class="fc" id="L427">		StringBuffer initJS = new StringBuffer();</span>
		//TODO: can we fix this hack to determine max width, preferably dynamically using javascript?
<span class="fc" id="L429">		initJS.append(getPatternDDPCName(wrcwr) + &quot;.setWidth(&quot; + Integer.toString(maxWidth) + &quot;);&quot;);</span>
<span class="fc" id="L430">		ddpc.setInitJS(initJS.toString());</span>

<span class="fc" id="L432">		ddpc.extractParameters(m_context.getRequest());</span>

<span class="pc bpc" id="L434" title="1 of 2 branches missed.">		if (ddpc.isEdited()) {</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">			if (modifiedAssignments.containsKey(wrcwr.getID())) {</span>
<span class="nc" id="L436">				modifiedAssignments.get(wrcwr.getID()).setWeeksEnabled(getPatternDDSelections(ddpc));</span>
<span class="nc" id="L437">				modifiedAssignments.get(wrcwr.getID()).setWeeksEnabledModified(true);</span>
			} else {
<span class="nc" id="L439">				wrcwr.setWeeksEnabled(getPatternDDSelections(ddpc));</span>
<span class="nc" id="L440">				wrcwr.setWeeksEnabledModified(true);</span>
				//Only add to modified assignments if this is not a newly added assignment
<span class="nc bnc" id="L442" title="All 2 branches missed.">				if (wrcwr.getID() != null) {</span>
<span class="nc" id="L443">					modifiedAssignments.put(wrcwr.getID(), wrcwr);</span>
				}
			}

			//We need to repopulate the DD with the updated selections if it has been edited
<span class="nc" id="L448">			ddpc.clearOptions();</span>
<span class="nc" id="L449">			populatePatternDDOptions(ddpc, weekDDPC, wrcwr);</span>
		}

<span class="fc" id="L452">		return ddpc;</span>
	}

	private IntegerDropDownSelection getWeekDDPC(WorkResourceComplexWorkRule wrcwr) {
		IntegerDropDownSelection weekDDPC;

		//The value that is displayed in this dropdown depends on the current selected date and the work rule create date
<span class="fc" id="L459">		Calendar wrStartDate = getWorkRuleCreateDate(wrcwr);</span>

<span class="pc bpc" id="L461" title="1 of 2 branches missed.">		if (isCycleMultiEdit(wrcwr)) {</span>
<span class="nc" id="L462">			weekDDPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="nc" id="L463">					getWeekDDPCName(wrcwr), 1, 1);</span>
<span class="nc" id="L464">			weekDDPC.setMultiEdit(true);</span>
		} else {
<span class="fc" id="L466">			weekDDPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="fc" id="L467">					getWeekDDPCName(wrcwr), 1, wrcwr.getNumWeeksInRotation());</span>
<span class="fc" id="L468">			weekDDPC.setSelectedIDs(Collections.singleton(Integer.toString(getWeekOffsetDisplayValue(</span>
<span class="fc" id="L469">					wrStartDate, viewStartDate, wrcwr.getStartWeekOffSet(), wrcwr.getNumWeeksInRotation()))));</span>
		}
<span class="pc bpc" id="L471" title="1 of 2 branches missed.">		if (isWeekMultiEdit(wrcwr)) {</span>
<span class="nc" id="L472">			weekDDPC.setMultiEdit(true);</span>
		}

<span class="pc bpc" id="L475" title="1 of 2 branches missed.">		if (isCycleMultiEdit(wrcwr)) {</span>
<span class="nc" id="L476">			weekDDPC.setInitJS(getWeekDDPCName(wrcwr) + &quot;.setEnabled(false);&quot;);</span>
		}

		//When this dropdown is changed, the pattern dropdown needs to have its main selection changed
<span class="fc" id="L480">		weekDDPC.setOnChangeJS(getName() + &quot;.weekDDPCChanged('&quot; +</span>
<span class="fc" id="L481">				JSUtil.getJSSuffix(wrcwr.getComplexWorkRule().getID().toString()) + &quot;');&quot;);</span>

<span class="pc bpc" id="L483" title="1 of 2 branches missed.">		if (!didTimePeriodChange) {</span>
<span class="fc" id="L484">			weekDDPC.extractParameters(m_context.getRequest());</span>
		}
<span class="pc bpc" id="L486" title="1 of 2 branches missed.">		if (weekDDPC.isEdited()) {</span>
<span class="nc" id="L487">			weekDDPC.setMultiEdit(false);</span>

			//We are re-instantiating this here because the drop down may have had options added to it.
			//When getting the selected values from the dropdown, it will not return a selected value if
			//the drop down does not have the actual object value that gets handed in during instantiation.
			//If values were added via javascript, these objects will not be present in the drop down.
			//See DropDownSelectionPC.getSelections()
<span class="nc" id="L494">			weekDDPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="nc" id="L495">					getWeekDDPCName(wrcwr), 1, wrcwr.getNumWeeksInRotation());</span>
<span class="nc" id="L496">			weekDDPC.extractParameters(m_context.getRequest());</span>

<span class="nc bnc" id="L498" title="All 2 branches missed.">			if (modifiedAssignments.containsKey(wrcwr.getID())) {</span>
<span class="nc" id="L499">				modifiedAssignments.get(wrcwr.getID()).setStartWeekOffSet(getWeekOffsetFromDisplayValue(wrStartDate,</span>
<span class="nc" id="L500">						viewStartDate, weekDDPC.getSelections().iterator().next(), wrcwr.getNumWeeksInRotation()));</span>
<span class="nc" id="L501">				modifiedAssignments.get(wrcwr.getID()).setStartWeekOffsetModified(true);</span>
			} else {
<span class="nc" id="L503">				wrcwr.setStartWeekOffSet(getWeekOffsetFromDisplayValue(wrStartDate, viewStartDate,</span>
<span class="nc" id="L504">						weekDDPC.getSelections().iterator().next(), wrcwr.getNumWeeksInRotation()));</span>
<span class="nc" id="L505">				wrcwr.setStartWeekOffsetModified(true);</span>
				//Only add to modified assignments if this is not a newly added assignment
<span class="nc bnc" id="L507" title="All 2 branches missed.">				if (wrcwr.getID() != null) {</span>
<span class="nc" id="L508">					modifiedAssignments.put(wrcwr.getID(), wrcwr);</span>
				}
			}
		}

<span class="pc bpc" id="L513" title="1 of 2 branches missed.">		if (isReadOnly) {</span>
<span class="nc" id="L514">			weekDDPC.setEnabled(false);</span>
		}

<span class="fc" id="L517">		return weekDDPC;</span>
	}

	//Takes the offset value in the DB and converts it to the appropriate display value
	//  based on the currently selected date
	private int getWeekOffsetDisplayValue(Calendar ruleCreateDate, Calendar viewWeekDate,
			int startWeekOffset, int numWeeksInRotation) {
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">		if (numWeeksInRotation == 0) {</span>
<span class="nc" id="L525">			return 1;</span>
		}
<span class="fc" id="L527">		int weeksBetween = TimeUtil.getWeeksCountBetweenDates(ruleCreateDate, viewWeekDate);</span>
<span class="fc" id="L528">		return (((weeksBetween % numWeeksInRotation) + startWeekOffset) % numWeeksInRotation) + 1;</span>
	}

	//Converts the display value from the dropdown into the offset that will be stored into the DB
	private int getWeekOffsetFromDisplayValue(Calendar ruleCreateDate, Calendar viewWeekDate, int weekOffsetDisplayValue,
			int numWeeksInRotation) {
<span class="nc" id="L534">		int weeksBetween = TimeUtil.getWeeksCountBetweenDates(ruleCreateDate, viewWeekDate);</span>
<span class="nc" id="L535">		int retVal = (weeksBetween % numWeeksInRotation) - (weekOffsetDisplayValue - 1);</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">		if (retVal &gt; 0) {</span>
<span class="nc" id="L537">			return numWeeksInRotation - retVal;</span>
		}
<span class="nc" id="L539">		return -retVal;</span>
	}

	//The selections for the pattern DD have a 1-based index while the backend API needs a 0-based
	private HashSet&lt;Integer&gt; getPatternDDSelections(CheckBoxDropDownSelectionPC&lt;Integer&gt; ddpc) {
<span class="nc" id="L544">		HashSet&lt;Integer&gt; retVal = new HashSet&lt;Integer&gt;();</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">		for (Integer week : ddpc.getSelections()) {</span>
<span class="nc" id="L546">			retVal.add(week - 1);</span>
<span class="nc" id="L547">		}</span>
<span class="nc" id="L548">		return retVal;</span>
	}

	private void populatePatternDDOptions(CheckBoxDropDownSelectionPC&lt;Integer&gt; patternDDPC,
			IntegerDropDownSelection weekDDPC, WorkResourceComplexWorkRule wrcwr) {
<span class="fc bfc" id="L553" title="All 2 branches covered.">		for (int i = 0; i &lt; wrcwr.getNumWeeksInRotation(); i++) {</span>
<span class="pc bpc" id="L554" title="1 of 2 branches missed.">			if (wrcwr.getWeeksEnabled().contains(i)) {</span>
<span class="fc" id="L555">				patternDDPC.addOption(Integer.toString(i + 1),</span>
<span class="fc" id="L556">						i18n(fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_ACTIVE).replaceFirst(</span>
<span class="fc" id="L557">								&quot;%&quot;, Integer.toString(i + 1)), i + 1, true);</span>
			} else {
<span class="nc" id="L559">				patternDDPC.addOption(Integer.toString(i + 1),</span>
<span class="nc" id="L560">						i18n(fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_INACTIVE).replaceFirst(</span>
<span class="nc" id="L561">								&quot;%&quot;, Integer.toString(i + 1)), i + 1, false);</span>
			}
		}

<span class="pc bpc" id="L565" title="1 of 2 branches missed.">		if (weekDDPC.getSelections().size() &gt; 0) {</span>
<span class="pc bpc" id="L566" title="1 of 2 branches missed.">			if (wrcwr.getWeeksEnabled().contains(weekDDPC.getSelections().iterator().next().intValue() - 1)) {</span>
<span class="fc" id="L567">				patternDDPC.setInitialText(i18n(fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_ACTIVE).replaceFirst(</span>
<span class="fc" id="L568">						&quot;%&quot;, Integer.toString(weekDDPC.getSelections().iterator().next().intValue())));</span>
			} else {
<span class="nc" id="L570">				patternDDPC.setInitialText(i18n(fsWebBundle, FsWebBundleKey.FS_ASSIGNMENT_RULE_INACTIVE).replaceFirst(</span>
<span class="nc" id="L571">						&quot;%&quot;, Integer.toString(weekDDPC.getSelections().iterator().next().intValue())));</span>
			}
		}
<span class="fc" id="L574">	}</span>

	private boolean isCycleMultiEdit(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L577">		return wrcwr.isFieldMultiValue(</span>
				WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_NUMWEEKSINROTATION);
	}

	private boolean isWeekMultiEdit(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L582">		return wrcwr.isFieldMultiValue(</span>
				WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_STARTWEEKOFFSET);
	}

	private boolean isPatternMultiEdit(WorkResourceComplexWorkRule wrcwr) {
<span class="nc" id="L587">		return wrcwr.isFieldMultiValue(</span>
				WorkResourceComplexWorkRuleFieldInfo.COMPLEXWORKRULEWORKRESOURCE_WEEKENABLEDMASK);
	}

	/**
	 * Returns the work rule creation date (start date).  Always returns a Calendar with a
	 * time component set to midnight and a time zone set to GMT.
	 */
	private Calendar getWorkRuleCreateDate(WorkResourceComplexWorkRule wrcwr) {
<span class="fc" id="L596">		Calendar wrStartDate = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="fc" id="L597">		wrStartDate.setTime(wrcwr.getComplexWorkRule().getCalendarPeriod().getAlignmentDate().getTime(TimeZoneUtil.GMT_TIMEZONE));</span>
<span class="fc" id="L598">		return wrStartDate;</span>
	}

	public void save(HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; assignmentRuleAssignmentMap)
			throws BbmException {
		//Assignment rules
<span class="fc" id="L604">		Collection&lt;ID&gt; removedWorkRuleIDs = getRemovedWorkRuleAssignmentIDs(assignmentRuleAssignmentMap);</span>
<span class="pc bpc" id="L605" title="2 of 4 branches missed.">		if (removedWorkRuleIDs != null &amp;&amp; removedWorkRuleIDs.size() &gt; 0) {</span>
<span class="nc" id="L606">			WorkRulesModelHandler.deleteComplexWorkRuleAssignments(m_context, removedWorkRuleIDs);</span>
		}
<span class="fc" id="L608">		Collection&lt;WorkResourceComplexWorkRule&gt; modifiedWorkRuleAssignments =</span>
<span class="fc" id="L609">				getModifiedWorkRuleAssignments(assignmentRuleAssignmentMap);</span>
<span class="pc bpc" id="L610" title="2 of 4 branches missed.">		if (modifiedWorkRuleAssignments != null &amp;&amp; modifiedWorkRuleAssignments.size() &gt; 0) {</span>
<span class="nc" id="L611">			WorkRulesModelHandler.updateComplexWorkRuleAssignments(m_context, modifiedWorkRuleAssignments);</span>
		}
<span class="fc" id="L613">		Collection&lt;WorkResourceComplexWorkRule&gt; addedWorkRuleAssignments =</span>
<span class="fc" id="L614">				getAddedWorkRuleAssignments(assignmentRuleAssignmentMap);</span>
<span class="pc bpc" id="L615" title="1 of 4 branches missed.">		if (addedWorkRuleAssignments != null &amp;&amp; addedWorkRuleAssignments.size() &gt; 0) {</span>
<span class="fc" id="L616">			WorkRulesModelHandler.createComplexWorkRuleAssignments(m_context, addedWorkRuleAssignments);</span>
		}

		//Clear out the removed/added IDs when finished to avoid saving/deleting duplicates
<span class="fc" id="L620">		setAddedRowIDs(&quot;&quot;);</span>
<span class="fc" id="L621">		setRemovedRowIDs(&quot;&quot;);</span>
<span class="fc" id="L622">	}</span>

	private Collection&lt;WorkResourceComplexWorkRule&gt; getAddedWorkRuleAssignments(HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; assignmentRuleAssignmentMap) {
		//Only one copy of each assignment is stored on the page (even if multiple employees are selected), so
		// we need to add the other assignments that will belong to every selected employee
<span class="fc" id="L627">		Collection&lt;WorkResourceComplexWorkRule&gt; addedAssignments = getAddedAssignmentRuleAssignments();</span>
<span class="fc" id="L628">		ArrayList&lt;WorkResourceComplexWorkRule&gt; newAddedAssignments = new ArrayList&lt;WorkResourceComplexWorkRule&gt;();</span>

<span class="fc bfc" id="L630" title="All 2 branches covered.">		for (ID employeeID : assignmentRuleAssignmentMap.keySet()) {</span>
<span class="fc bfc" id="L631" title="All 2 branches covered.">			for (WorkResourceComplexWorkRule addedAssignment : addedAssignments) {</span>
<span class="fc" id="L632">				WorkResourceComplexWorkRule wrcwr = new WorkResourceComplexWorkRule();</span>
<span class="fc" id="L633">				wrcwr.setStartWeekOffSet(addedAssignment.getStartWeekOffSet());</span>
<span class="fc" id="L634">				wrcwr.setNumWeeksInRotation(addedAssignment.getNumWeeksInRotation());</span>
<span class="fc" id="L635">				wrcwr.setComplexWorkRule(addedAssignment.getComplexWorkRule());</span>
<span class="fc" id="L636">				wrcwr.setWeeksEnabled(addedAssignment.getWeeksEnabled());</span>
<span class="fc" id="L637">				wrcwr.setWorkResourceID(employeeID);</span>
<span class="fc" id="L638">				newAddedAssignments.add(wrcwr);</span>
<span class="fc" id="L639">			}</span>
<span class="fc" id="L640">		}</span>

<span class="fc" id="L642">		return newAddedAssignments;</span>
	}

	private ArrayList&lt;WorkResourceComplexWorkRule&gt; getAddedAssignmentRuleAssignments() {
<span class="fc" id="L646">		ArrayList&lt;WorkResourceComplexWorkRule&gt; retVal = new ArrayList&lt;WorkResourceComplexWorkRule&gt;();</span>
<span class="fc bfc" id="L647" title="All 2 branches covered.">		for (ID id : getAddedRowIDCollection()) {</span>
<span class="pc bpc" id="L648" title="1 of 2 branches missed.">			for (WorkResourceComplexWorkRule wrcwr : assignments) {</span>
<span class="pc bpc" id="L649" title="1 of 2 branches missed.">				if (id.equals(wrcwr.getComplexWorkRule().getID())) {</span>
<span class="fc" id="L650">					retVal.add(wrcwr);</span>
<span class="fc" id="L651">					break;</span>
				}
<span class="nc" id="L653">			}</span>
<span class="fc" id="L654">		}</span>
<span class="fc" id="L655">		return retVal;</span>
	}

	private Collection&lt;WorkResourceComplexWorkRule&gt; getModifiedWorkRuleAssignments(HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; assignmentRuleAssignmentMap) {
		//Only one copy of each assignment is stored on the page (even if multiple employees are selected), so
		// we need to modify the other assignments that belong to every selected employee
<span class="fc" id="L661">		Collection&lt;WorkResourceComplexWorkRule&gt; modifiedAssignments = getModifiedAssignmentRuleAssignments();</span>
<span class="fc" id="L662">		ArrayList&lt;WorkResourceComplexWorkRule&gt; newModifiedAssignments = new ArrayList&lt;WorkResourceComplexWorkRule&gt;();</span>
<span class="pc bpc" id="L663" title="1 of 2 branches missed.">		for (WorkResourceComplexWorkRule wrcwr : modifiedAssignments) {</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">			for (ID employeeID : assignmentRuleAssignmentMap.keySet()) {</span>
<span class="nc bnc" id="L665" title="All 4 branches missed.">				if (wrcwr.getWorkResourceID() != null &amp;&amp; employeeID.equals(wrcwr.getWorkResourceID()) == false) {</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">					for (WorkResourceComplexWorkRule existingAssignment : assignmentRuleAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">						if (wrcwr.getComplexWorkRule().getID().equals(existingAssignment.getComplexWorkRule().getID())) {</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">							if (wrcwr.isStartWeekOffsetModified()) {</span>
<span class="nc" id="L669">								existingAssignment.setStartWeekOffSet(wrcwr.getStartWeekOffSet());</span>
							}
<span class="nc bnc" id="L671" title="All 2 branches missed.">							if (wrcwr.isNumWeeksInRotationModified()) {</span>
<span class="nc" id="L672">								existingAssignment.setNumWeeksInRotation(wrcwr.getNumWeeksInRotation());</span>
							}
<span class="nc bnc" id="L674" title="All 2 branches missed.">							if (wrcwr.isWeeksEnabledModified()) {</span>
<span class="nc" id="L675">								existingAssignment.setWeeksEnabled(wrcwr.getWeeksEnabled());</span>
							}
<span class="nc" id="L677">							newModifiedAssignments.add(existingAssignment);</span>
<span class="nc" id="L678">							break;</span>
						}
<span class="nc" id="L680">					}</span>
				}
<span class="nc" id="L682">			}</span>
<span class="nc" id="L683">		}</span>
<span class="fc" id="L684">		modifiedAssignments.addAll(newModifiedAssignments);</span>
<span class="fc" id="L685">		return modifiedAssignments;</span>
	}

	private Collection&lt;WorkResourceComplexWorkRule&gt; getModifiedAssignmentRuleAssignments() {
<span class="fc" id="L689">		return new ArrayList&lt;WorkResourceComplexWorkRule&gt;(modifiedAssignments.values());</span>
	}

	private Collection&lt;ID&gt; getRemovedWorkRuleAssignmentIDs(HashMap&lt;ID, Collection&lt;WorkResourceComplexWorkRule&gt;&gt; assignmentRuleAssignmentMap) {
<span class="fc" id="L693">		Collection&lt;ID&gt; removedAssignmentRuleIDs = getRemovedRowIDCollection();</span>
<span class="fc" id="L694">		Collection&lt;ID&gt; removedAssignmentIDs = new ArrayList&lt;ID&gt;();</span>

<span class="fc bfc" id="L696" title="All 2 branches covered.">		for (ID employeeID : assignmentRuleAssignmentMap.keySet()) {</span>
<span class="pc bpc" id="L697" title="1 of 2 branches missed.">			for (WorkResourceComplexWorkRule wrcwr : assignmentRuleAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">				if (removedAssignmentRuleIDs.contains(wrcwr.getComplexWorkRule().getID())) {</span>
<span class="nc" id="L699">					removedAssignmentIDs.add(wrcwr.getID());</span>
				}
<span class="nc" id="L701">			}</span>
<span class="fc" id="L702">		}</span>

		//In the case where a rule was removed and then the same rule was added back in, we will need to
		// remove the original rule so we will get the ID for that rule here.
<span class="fc" id="L706">		Collection&lt;WorkResourceComplexWorkRule&gt; addedAssignments =</span>
<span class="fc" id="L707">				getAddedWorkRuleAssignments(assignmentRuleAssignmentMap);</span>
<span class="fc bfc" id="L708" title="All 2 branches covered.">		if (addedAssignments.isEmpty() == false) {</span>
<span class="fc bfc" id="L709" title="All 2 branches covered.">			for (ID empID : assignmentRuleAssignmentMap.keySet()) {</span>
<span class="pc bpc" id="L710" title="1 of 2 branches missed.">				for (WorkResourceComplexWorkRule existingAssignment : assignmentRuleAssignmentMap.get(empID)) {</span>
<span class="nc bnc" id="L711" title="All 2 branches missed.">					for (WorkResourceComplexWorkRule addedAssignment : addedAssignments) {</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">						if (existingAssignment.getComplexWorkRuleID().equals(addedAssignment.getComplexWorkRuleID())) {</span>
<span class="nc" id="L713">							removedAssignmentIDs.add(existingAssignment.getID());</span>
						}
<span class="nc" id="L715">					}</span>
<span class="nc" id="L716">				}</span>
<span class="fc" id="L717">			}</span>
		}

<span class="fc" id="L720">		return removedAssignmentIDs;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>