<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeBankAssignmentListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">TimeBankAssignmentListPC.java</span></div><h1>TimeBankAssignmentListPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpTimeBank;
import com.bluepumpkin.ejb.bbm.workrules.model.TimeBank;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.fs.keys.FsJavaScriptFileID;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.widgets.IntegerDropDownSelection;
import com.verint.web.fs.workrules.WorkRulesJSFileID;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.InsertableMultiColListPC;
import com.witness.web.uif.pagecomponent.picker.date.DateRangePickerPC;
import com.witness.web.uif.pagecomponent.table.DefaultHeaderData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.WorkpaneMultiColPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.SortUtil;
import com.witness.web.uif.util.js.JSUtil;

import javax.servlet.http.HttpServletRequest;
import java.text.SimpleDateFormat;
import java.util.*;

@SuppressWarnings(&quot;serial&quot;)
public class TimeBankAssignmentListPC extends InsertableMultiColListPC {

	private Collection&lt;EmpTimeBank&gt; assignments;
	private Map&lt;ID, TimeBank&gt; timeBankMap;
	private Calendar viewStartDate;
	private Calendar viewEndDate;
<span class="fc" id="L42">	private boolean didTimePeriodChange = false;</span>
	private Collection&lt;ID&gt; selectedEmployeeIDs;

	public TimeBankAssignmentListPC(RequestContext context, String name, Collection&lt;EmpTimeBank&gt; assignments,
			Map&lt;ID, TimeBank&gt; timeBankMap, Date viewStartDate, Date viewEndDate, boolean didTimePeriodChange,
			Collection&lt;ID&gt; selectedEmployeeIDs) {
<span class="fc" id="L48">		super(context);</span>

<span class="fc" id="L50">		setName(name);</span>

<span class="fc" id="L52">		this.assignments = assignments;</span>
<span class="fc" id="L53">		this.timeBankMap = timeBankMap;</span>
<span class="fc" id="L54">		this.viewStartDate = Calendar.getInstance();</span>
<span class="fc" id="L55">		this.viewStartDate.setTime(viewStartDate);</span>
<span class="fc" id="L56">		this.viewEndDate = Calendar.getInstance();</span>
<span class="fc" id="L57">		this.viewEndDate.setTime(viewEndDate);</span>
<span class="fc" id="L58">		this.didTimePeriodChange = didTimePeriodChange;</span>
<span class="fc" id="L59">		this.selectedEmployeeIDs = selectedEmployeeIDs;</span>

<span class="fc" id="L61">		ToolbarPC toolbar = new ToolbarPC(m_context);</span>
<span class="fc" id="L62">		toolbar.setName(&quot;timeBankToolbar&quot;);</span>
<span class="fc" id="L63">		ToolbarTextButton addButton = toolbar.createPopupWindowButton(TimeBankListPopupPM.POPUP_ID,</span>
<span class="fc" id="L64">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_ADD), true);</span>
<span class="fc" id="L65">		addButton.setAttribute(&quot;viewStartDate&quot;, Long.toString(this.viewStartDate.getTimeInMillis()));</span>
<span class="fc" id="L66">		addButton.setAttribute(&quot;viewEndDate&quot;, Long.toString(this.viewEndDate.getTimeInMillis()));</span>
<span class="fc" id="L67">		addButton.setAttribute(&quot;onClick&quot;, getFilterJSForAddButton(getName(), toolbar.getName(), TimeBankListPopupPM.POPUP_ID));</span>
<span class="fc" id="L68">		ToolbarTextButton removeButton = new ToolbarTextButton(toolbar, &quot;removeTimeBank&quot;,</span>
<span class="fc" id="L69">				m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.TOOLBAR_REMOVE),</span>
				InsertableMultiColListPC.REMOVE_ROW_BUTTON_ACTION, ToolbarTextButton.BLUE_BUTTON, false);

		//Only one time bank may be assigned at any given time
<span class="fc" id="L73">		setOnRowAddJS(getName() + &quot;.itemAdded('&quot; + addButton.getName() + &quot;','&quot; + removeButton.getName() + &quot;');&quot;);</span>
<span class="fc" id="L74">		setOnRowRemoveJS(getName() + &quot;.itemRemoved('&quot; + addButton.getName() + &quot;','&quot; + removeButton.getName() + &quot;');&quot;);</span>

<span class="fc" id="L76">		setIsBorderEnabled(true);</span>
<span class="fc" id="L77">		setToolbar(toolbar);</span>

<span class="fc" id="L79">		addPopupArgs(TimeBankListPopupPM.POPUP_ID, TimeBankListPopupPM.FORM_ACTION, &quot;&quot;,</span>
				TimeBankListPopupPM.POPUP_ARGS, &quot;1000,600,ctr,ctr&quot;, true, 1);

<span class="fc" id="L82">		addPopupArgs(TimeBankEffectivityPopupPM.POPUP_ID, TimeBankEffectivityPopupPM.FORM_ACTION, &quot;&quot;,</span>
				TimeBankEffectivityPopupPM.POPUP_ARGS, &quot;600,400,ctr,ctr&quot;, true, 1);

		//If we don't have any rows for the list on initial load, we still need to get the required
		// js files from the inline components that may be added dynamically
<span class="fc" id="L87">		IntegerDropDownSelection dummyIntegerSelectionPC = new IntegerDropDownSelection(getRequestContext(),</span>
<span class="fc" id="L88">				getName() + &quot;_dummyIntegerSelectionPC&quot;, 0, 0);</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">		for (String js : dummyIntegerSelectionPC.getRequireJavaScriptFiles()) {</span>
<span class="fc" id="L90">			addRequiredJavaScriptFile(js);</span>
<span class="fc" id="L91">		}</span>

<span class="fc" id="L93">		setJSMediator(FsJavaScriptFileID.SINGLETON_INSERTABLE_TABLE);</span>

<span class="fc" id="L95">		extractParameters(m_context.getRequest());</span>

<span class="pc bpc" id="L97" title="1 of 2 branches missed.">		if (assignments.size() &gt; 0) {</span>
<span class="nc" id="L98">			addButton.setEnabled(false);</span>
		}
<span class="fc" id="L100">		toolbar.addToolbarElement(addButton);</span>
<span class="fc" id="L101">		toolbar.addToolbarElement(removeButton);</span>
<span class="fc" id="L102">		addRequiredJavaScriptFile(WorkRulesJSFileID.WORK_RULES_UTIL);</span>
<span class="fc" id="L103">	}</span>

	public String getJavaScriptInitCode() {
<span class="fc" id="L106">		StringBuffer js = new StringBuffer(super.getJavaScriptInitCode());</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">		if (getToolbar() != null) {</span>
<span class="fc" id="L108">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.setToolbar(&quot;).append(getToolbar().getName()).append(&quot;);&quot;);</span>
<span class="fc" id="L109">			js.append(&quot;\n&quot;).append(getName()).append(&quot;.addButtonEnableAttribute('isDeleteable', 'removeTimeBank');\n&quot;);</span>
		}
<span class="fc" id="L111">		return js.toString();</span>
	}

<span class="fc" id="L114">	private boolean isHeaderInited = false;</span>

	private void initHeader() {
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">		if (isHeaderInited) {</span>
<span class="nc" id="L118">			return;</span>
		}
<span class="fc" id="L120">		isHeaderInited = true;</span>

<span class="fc" id="L122">		TableHeaderPC header = getHeader();</span>
<span class="fc" id="L123">		Localizer localizer = m_context.getLocalizer();</span>

<span class="fc" id="L125">		DefaultHeaderData dhd = new DefaultHeaderData(FsWebBundleKey.FS_TIME_BANK,</span>
<span class="fc" id="L126">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_TIME_BANK));</span>
<span class="fc" id="L127">		dhd.addImageButton(getInfoButtonPopupImage(), getInfoButtonPopupCaption(), getInfoButtonPopupJS());</span>
<span class="fc" id="L128">		dhd.setSortable(false);</span>
<span class="fc" id="L129">		header.addColumnHeaderData(dhd);</span>
<span class="pc bpc" id="L130" title="1 of 4 branches missed.">		if (selectedEmployeeIDs != null &amp;&amp; selectedEmployeeIDs.size() == 1) {      //show effective date history if single employee is selected</span>
<span class="fc" id="L131">			dhd = new DefaultHeaderData(FsWebBundleKey.FS_START_DATE_END_DATE,</span>
<span class="fc" id="L132">					localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_START_DATE_END_DATE));</span>
<span class="fc" id="L133">			dhd.addImageButton(getInfoButtonPopupImage(), getEffectivityInfoButtonPopupCaption(),</span>
<span class="fc" id="L134">					getEffectivityInfoButtonPopupJS());</span>
<span class="fc" id="L135">			dhd.setSortable(false);</span>
<span class="fc" id="L136">			header.addColumnHeaderData(dhd);</span>
		} else {
<span class="fc" id="L138">			header.addColumnHeaderData(FsWebBundleKey.FS_START_DATE_END_DATE,</span>
<span class="fc" id="L139">					localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_START_DATE_END_DATE));</span>
		}
<span class="fc" id="L141">	}</span>

	private String getInfoButtonPopupImage() {
<span class="fc" id="L144">		return ImageFileID.TOOLTIP_BUTTON;</span>
	}

	private String getInfoButtonPopupCaption() {
<span class="fc" id="L148">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_VIEW_TIME_BANK_DETAILS);</span>
	}

	private String getInfoButtonPopupJS() {
<span class="fc" id="L152">		return &quot;WorkRulesUtil.handleInfoPopup(this, &quot; + getName() + &quot;,&quot; + getHeader().getName() + &quot;,'&quot; +</span>
				TimeBankListPopupPM.POPUP_ID + &quot;','&quot; + TimeBankListPopupPM.POPUP_ARG_TIMEBANK_ID + &quot;','&quot; +
				TimeBankListPopupPM.POPUP_ARG_SELECTED_IDS + &quot;','&quot; + TimeBankListPopupPM.POPUP_ARG_IS_INFO_POPUP +
				&quot;','true');&quot;;
	}

	private String getEffectivityInfoButtonPopupCaption() {
<span class="fc" id="L159">		return m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_VIEW_TIME_BANK_ASSIGNMENT_HISTORY);</span>
	}

	private String getEffectivityInfoButtonPopupJS() {
<span class="fc" id="L163">		SimpleDateFormat sdf = new SimpleDateFormat(m_context.getLocalizer().getDateInputFormat(), m_context.getLocalizer().getLocaleContext().getRegionalFormatLocale());</span>
<span class="fc" id="L164">		return &quot;WorkRulesUtil.handleInfoPopup(this, &quot; + getName() + &quot;,&quot; + getHeader().getName() + &quot;,'&quot; +</span>
				TimeBankEffectivityPopupPM.POPUP_ID + &quot;',null,null,'&quot; + TimeBankEffectivityPopupPM.POPUP_ARG_EMPLOYEE_ID + &quot;,&quot; +
<span class="fc" id="L166">				TimeBankEffectivityPopupPM.POPUP_ARG_VIEW_DATE + &quot;','&quot; + selectedEmployeeIDs.iterator().next().toString() +</span>
<span class="fc" id="L167">				&quot;,&quot; + sdf.format(viewStartDate.getTime()) + &quot;');&quot;;</span>
	}

<span class="fc" id="L170">	private boolean isRowsInited = false;</span>

	private void initRows() {
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">		if (isRowsInited) {</span>
<span class="nc" id="L174">			return;</span>
		}
<span class="fc" id="L176">		isRowsInited = true;</span>

<span class="fc" id="L178">		List&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>

<span class="fc" id="L180">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;ID&gt;();</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">		for (EmpTimeBank etb : assignments) {</span>
<span class="nc" id="L182">			rows.add(getNodeData(etb, timeBankMap.get(etb.getTimeBankID()), false));</span>
<span class="nc" id="L183">			ids.add(etb.getTimeBankID());</span>
<span class="nc" id="L184">		}</span>

		//Sort the rows by item name
<span class="fc" id="L187">		SortUtil.sort(rows, getHeader().getColumnIndexByName(FsWebBundleKey.FS_TIME_BANK), true, m_context.getLocalizer());</span>

<span class="fc" id="L189">		this.setRowIDs(StringUtil.createDelimitedString(ids.toArray(new ID[ids.size()])));</span>
<span class="fc" id="L190">	}</span>

	public String getRowHtml(EmpTimeBank etb, TimeBank timeBank) {
<span class="nc" id="L193">		StringBuffer html = new StringBuffer();</span>
<span class="nc" id="L194">		super.appendHtmlRowData(html, getNodeData(etb, timeBank, true), 0, 0);</span>
<span class="nc" id="L195">		return html.toString();</span>
	}

	protected DefaultMultiColumnNodeData getNodeData(EmpTimeBank etb, TimeBank timeBank, boolean isAjaxRequest) {
<span class="nc" id="L199">		DefaultMultiColumnNodeData nodeData = new DefaultMultiColumnNodeData(etb.getTimeBankID());</span>

		//Name
<span class="nc bnc" id="L202" title="All 2 branches missed.">		if (etb.isMultiEditCommon()) {</span>
<span class="nc" id="L203">			nodeData.add(timeBank.getName());</span>
		} else {
<span class="nc" id="L205">			nodeData.add(&quot;*&quot; + timeBank.getName());</span>
		}

		//Effective Dates
<span class="nc" id="L209">		DateRangePickerPC dateRangePC = new DateRangePickerPC(getRequestContext(),</span>
<span class="nc" id="L210">				getDateRangePCName(getName(), etb.getTimeBankID()));</span>
<span class="nc" id="L211">		dateRangePC.setTimeZone(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L212">		dateRangePC.setIsMultiValueSupported(true);</span>
<span class="nc" id="L213">		dateRangePC.setIsControlEnabled(false);</span>
		//Time Banks are stored in the DB at GMT time and with an exclusive end date.  We need to subtract a day
		//from the end date for display purposes.
<span class="nc" id="L216">		dateRangePC.getEndDatePickerPC().setIsDateValueInclusive(true);</span>
<span class="nc" id="L217">		dateRangePC.getStartDatePickerPC().setDate(etb.getStartTime());</span>
<span class="nc" id="L218">		Calendar endDateDisplay = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L219">		endDateDisplay.setTime(etb.getEndTime());</span>
<span class="nc" id="L220">		endDateDisplay.add(Calendar.DAY_OF_YEAR, -1);</span>
<span class="nc" id="L221">		dateRangePC.getEndDatePickerPC().setDate(endDateDisplay.getTime());</span>

		//addChildComponent(dateRangePC);
<span class="nc" id="L224">		nodeData.add(dateRangePC.getHtmlDisplay());</span>

<span class="nc" id="L226">		setRowAttributes(nodeData, etb);</span>
<span class="nc" id="L227">		return nodeData;</span>
	}

	protected void setRowAttributes(DefaultMultiColumnNodeData mcnd, EmpTimeBank etb) {
<span class="nc bnc" id="L231" title="All 2 branches missed.">		if (!etb.isMultiEditCommon()) {</span>
<span class="nc" id="L232">			mcnd.setNodeAttribute(ROW_ATTRIBUTE_MULTI_EDIT_NOT_COMMON, String.valueOf(true));</span>
		}
<span class="nc" id="L234">		mcnd.setNodeAttribute(WorkpaneMultiColPM.IS_DELETEABLE, String.valueOf(true));</span>
<span class="nc" id="L235">		mcnd.setNodeAttribute(TimeBankListPopupPM.POPUP_ARG_TIMEBANK_ID, etb.getTimeBankID().toString());</span>
<span class="nc" id="L236">	}</span>

<span class="fc" id="L238">	private boolean isExtracted = false;</span>

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc bfc" id="L242" title="All 2 branches covered.">		if (isExtracted) {</span>
<span class="fc" id="L243">			return true;</span>
		}
<span class="fc" id="L245">		isExtracted = true;</span>
<span class="fc" id="L246">		boolean retVal = true;</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">		if (didTimePeriodChange == false) {</span>
<span class="fc" id="L248">			retVal = super.extractParameters(request);</span>
		}

		// removed
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">		for (ID removedID : getRemovedRowIDCollection()) {</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">			for (EmpTimeBank etb : assignments) {</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">				if (removedID.equals(etb.getTimeBankID())) {</span>
<span class="nc" id="L255">					assignments.remove(etb);</span>
<span class="nc" id="L256">					timeBankMap.remove(etb.getTimeBankID());</span>
<span class="nc" id="L257">					break;</span>
				}
<span class="nc" id="L259">			}</span>
<span class="nc" id="L260">		}</span>

		// added
		try {
<span class="fc" id="L264">			Collection&lt;ID&gt; addedIDs = getAddedRowIDCollection();</span>
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">			if (addedIDs.size() &gt; 0) {</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">				for (TimeBank timeBank : WorkRulesModelHandler.getTimeBanksByIDs(m_context, addedIDs)) {</span>
<span class="nc" id="L267">					EmpTimeBank etb = new EmpTimeBank();</span>
<span class="nc" id="L268">					etb.setTimeBankID(timeBank.getID());</span>
<span class="nc" id="L269">					etb.setMultiEditCommon(true);</span>
<span class="nc" id="L270">					etb.setStartTime(timeBank.getStartDate());</span>
<span class="nc" id="L271">					etb.setEndTime(timeBank.getEndDate());</span>
					//If this time bank is already present in assignments, make sure to remove it before re-adding.
					//This case happens when the user removes a time bank and then re-adds the same one.
<span class="nc" id="L274">					EmpTimeBank existingAssignment = null;</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">					for (EmpTimeBank existingEtb : assignments) {</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">						if (existingEtb.getTimeBankID().equals(timeBank.getID())) {</span>
<span class="nc" id="L277">							existingAssignment = existingEtb;</span>
<span class="nc" id="L278">							break;</span>
						}
<span class="nc" id="L280">					}</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">					if (existingAssignment != null) {</span>
<span class="nc" id="L282">						assignments.remove(existingAssignment);</span>
					}
<span class="nc" id="L284">					assignments.add(etb); // This will be updated in the initRows method call below</span>
<span class="nc" id="L285">					timeBankMap.put(timeBank.getID(), timeBank);</span>
<span class="nc" id="L286">				}</span>
			}
<span class="nc" id="L288">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L289">			retVal = false;</span>
<span class="nc" id="L290">			handleUnableToLoadDataError(log, e);</span>
<span class="fc" id="L291">		}</span>

<span class="fc" id="L293">		initHeader();</span>
<span class="fc" id="L294">		initRows();</span>

<span class="fc" id="L296">		return retVal;</span>
	}

	public void save(HashMap&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; timeBankAssignmentMap) throws BbmException {
<span class="fc" id="L300">		Collection&lt;ID&gt; removedTimeBankIDs = getRemovedTimeBankAssignmentIDs(timeBankAssignmentMap);</span>
<span class="pc bpc" id="L301" title="2 of 4 branches missed.">		if (removedTimeBankIDs != null &amp;&amp; removedTimeBankIDs.size() &gt; 0) {</span>
<span class="nc" id="L302">			WorkRulesModelHandler.deleteTimeBankAssignments(m_context, removedTimeBankIDs);</span>
		}
<span class="fc" id="L304">		Collection&lt;EmpTimeBank&gt; addedTimeBankAssignments = getAddedTimeBankAssignments(timeBankAssignmentMap);</span>
<span class="pc bpc" id="L305" title="2 of 4 branches missed.">		if (addedTimeBankAssignments != null &amp;&amp; addedTimeBankAssignments.size() &gt; 0) {</span>
<span class="nc" id="L306">			WorkRulesModelHandler.createTimeBankAssignments(m_context, addedTimeBankAssignments);</span>
		}

		//Clear out the removed/added IDs when finished to avoid saving/deleting duplicates
<span class="fc" id="L310">		setAddedRowIDs(&quot;&quot;);</span>
<span class="fc" id="L311">		setRemovedRowIDs(&quot;&quot;);</span>
<span class="fc" id="L312">	}</span>

	private Collection&lt;ID&gt; getRemovedTimeBankAssignmentIDs(HashMap&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; timeBankAssignmentMap) {
<span class="fc" id="L315">		Collection&lt;ID&gt; removedTimeBankIDs = getRemovedRowIDCollection();</span>
<span class="fc" id="L316">		Collection&lt;ID&gt; removedAssignmentIDs = new ArrayList&lt;ID&gt;();</span>

<span class="fc bfc" id="L318" title="All 2 branches covered.">		for (ID employeeID : timeBankAssignmentMap.keySet()) {</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">			for (EmpTimeBank etb : timeBankAssignmentMap.get(employeeID)) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">				if (removedTimeBankIDs.contains(etb.getTimeBankID())) {</span>
<span class="nc" id="L321">					removedAssignmentIDs.add(etb.getID());</span>
				}
<span class="nc" id="L323">			}</span>
<span class="fc" id="L324">		}</span>

<span class="fc" id="L326">		return removedAssignmentIDs;</span>
	}

	private Collection&lt;EmpTimeBank&gt; getAddedTimeBankAssignments(HashMap&lt;ID, Collection&lt;EmpTimeBank&gt;&gt; timeBankAssignmentMap) {
<span class="fc" id="L330">		Collection&lt;EmpTimeBank&gt; addedTimeBanks = getAddedTimeBanks();</span>
<span class="fc" id="L331">		ArrayList&lt;EmpTimeBank&gt; newAddedTimeBanks = new ArrayList&lt;EmpTimeBank&gt;();</span>

<span class="fc bfc" id="L333" title="All 2 branches covered.">		for (ID employeeID : timeBankAssignmentMap.keySet()) {</span>
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">			for (EmpTimeBank addedTimeBank : addedTimeBanks) {</span>
<span class="nc" id="L335">				EmpTimeBank etb = new EmpTimeBank();</span>
<span class="nc" id="L336">				etb.setStartTime(addedTimeBank.getStartTime());</span>
<span class="nc" id="L337">				etb.setEndTime(addedTimeBank.getEndTime());</span>
<span class="nc" id="L338">				etb.setTimeBankID(addedTimeBank.getTimeBankID());</span>
<span class="nc" id="L339">				etb.setEmployeeID(employeeID);</span>
<span class="nc" id="L340">				newAddedTimeBanks.add(etb);</span>
<span class="nc" id="L341">			}</span>
<span class="fc" id="L342">		}</span>

<span class="fc" id="L344">		return newAddedTimeBanks;</span>
	}

	private HashSet&lt;EmpTimeBank&gt; getAddedTimeBanks() {
<span class="fc" id="L348">		HashSet&lt;EmpTimeBank&gt; retVal = new HashSet&lt;EmpTimeBank&gt;();</span>
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">		for (ID id : getAddedRowIDCollection()) {</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">			for (EmpTimeBank etb : assignments) {</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">				if (id.equals(etb.getTimeBankID())) {</span>
<span class="nc" id="L352">					retVal.add(etb);</span>
<span class="nc" id="L353">					break;</span>
				}
<span class="nc" id="L355">			}</span>
<span class="nc" id="L356">		}</span>
<span class="fc" id="L357">		return retVal;</span>
	}

	private static String getPCNamePrefix(String listName, ID workPatternID) {
<span class="nc" id="L361">		return listName + workPatternID.toString();</span>
	}

	private static String getDateRangePCName(String listName, ID timeBankID) {
<span class="nc" id="L365">		return JSUtil.getJSSuffix(getPCNamePrefix(listName, timeBankID) + &quot;_dateRangePC&quot;);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>