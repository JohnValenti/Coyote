<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>HoursPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules.assignment</a> &gt; <span class="el_source">HoursPC.java</span></div><h1>HoursPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules.assignment;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.ScopeID;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.ArrayUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.EmpWorkRuleManager;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceMinMaxHour;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.people.profile.ProfilePageModel;
import com.bluepumpkin.web.bbm.people.profile.effectivedate.DataContainerPC;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.Scope;
import com.witness.web.uif.jsp.HtmlInput;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.form.FormFourColumnPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.DurationSpinnerPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;

import javax.servlet.http.HttpServletRequest;
import java.text.SimpleDateFormat;
import java.util.*;

public class HoursPC extends FormFourColumnPC {
	private static final long serialVersionUID = 1L;

	// Page Components
	private ToolbarPC pc_toolbar;
	private DurationSpinnerPC pc_minPaid, pc_maxPaid, pc_otPerDay, pc_otPerWeek, pc_vtoPerDay, pc_vtoPerWeek;
	private DatePickerPC pc_startDate, pc_endDate;
	private HtmlInput html_updateMode, html_datesModified;

	// Data
<span class="fc" id="L48">	private Collection&lt;ID&gt; employeeIDs = Collections.emptyList();</span>
	//key = employee ID
	private Map&lt;ID, Employee&gt; employeeMap;
	private LocalDate viewPeriodStart, viewPeriodEnd;
<span class="fc" id="L52">	private LocalDate effectiveDateStart = null;</span>
<span class="fc" id="L53">	private LocalDate effectiveDateEnd = null;</span>
<span class="fc" id="L54">	private LocalDate empStartDate = null;</span>
<span class="fc" id="L55">	private Map&lt;ID, List&lt;WorkResourceMinMaxHour&gt;&gt; hoursAssignments = Collections.emptyMap();</span>
<span class="fc" id="L56">	private Map&lt;ID, WorkResourceMinMaxHour&gt; currentHoursAssignments = new HashMap&lt;ID, WorkResourceMinMaxHour&gt;();</span>
	private boolean onlyPeriodEditable;
<span class="fc" id="L58">	private boolean extractParams = true;</span>

	private Map&lt;ID, List&lt;Integer&gt;&gt; authorizedViewFields;
	private Map&lt;ID, List&lt;Integer&gt;&gt; authorizedEditFields;

	public HoursPC(RequestContext context, Collection&lt;ID&gt; employeeIDs, Map&lt;ID, Employee&gt; employeeMap,
			LocalDate viewPeriodStart, LocalDate viewPeriodEnd, boolean onlyPeriodEditable, boolean extractParams) throws BbmFinderException {
<span class="fc" id="L65">		super(context);</span>
<span class="fc" id="L66">		this.onlyPeriodEditable = onlyPeriodEditable;</span>
<span class="fc" id="L67">		setName(&quot;hoursPC&quot;);</span>
<span class="fc" id="L68">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="fc" id="L69">		this.pc_toolbar = new ToolbarPC(m_context);</span>
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">		if (employeeIDs != null) {</span>
<span class="fc" id="L71">			this.employeeIDs = employeeIDs;</span>
		}
<span class="fc" id="L73">		this.viewPeriodStart = viewPeriodStart;</span>
<span class="fc" id="L74">		this.viewPeriodEnd = viewPeriodEnd;</span>
<span class="fc" id="L75">		this.extractParams = extractParams;</span>
<span class="fc" id="L76">		this.employeeMap = employeeMap;</span>

<span class="fc" id="L78">		initializeSecureFieldMetaData();</span>

<span class="fc" id="L80">		pc_minPaid = new DurationSpinnerPC(m_context, &quot;hoursPC__minPaid&quot;);</span>
<span class="fc" id="L81">		pc_minPaid.setMaxTime(99, 45, 0);</span>
<span class="fc" id="L82">		pc_minPaid.setMinutesIncrement(15);</span>
<span class="fc" id="L83">		pc_minPaid.setEnabled(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MINMAXPAIDHOURS));</span>
<span class="fc" id="L84">		pc_minPaid.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_MINMAXPAIDHOURS));</span>
<span class="fc" id="L85">		addChildComponent(pc_minPaid);</span>

<span class="fc" id="L87">		pc_maxPaid = new DurationSpinnerPC(m_context, &quot;hoursPC__maxPaid&quot;);</span>
<span class="fc" id="L88">		pc_maxPaid.setMaxTime(99, 45, 0);</span>
<span class="fc" id="L89">		pc_maxPaid.setMinutesIncrement(15);</span>
<span class="fc" id="L90">		pc_maxPaid.setEnabled(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MINMAXPAIDHOURS));</span>
<span class="fc" id="L91">		pc_maxPaid.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_MINMAXPAIDHOURS));</span>
<span class="fc" id="L92">		addChildComponent(pc_maxPaid);</span>

<span class="fc" id="L94">		pc_otPerDay = new DurationSpinnerPC(m_context, &quot;hoursPC__otPerDay&quot;);</span>
<span class="fc" id="L95">		pc_otPerDay.setMaxTime(24, 0, 0);</span>
<span class="fc" id="L96">		pc_otPerDay.setMinutesIncrement(15);</span>
<span class="fc" id="L97">		pc_otPerDay.setEnabled(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXOTMINSPERDAY));</span>
<span class="fc" id="L98">		pc_otPerDay.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXOTMINSPERDAY));</span>
<span class="fc" id="L99">		addChildComponent(pc_otPerDay);</span>

<span class="fc" id="L101">		pc_otPerWeek = new DurationSpinnerPC(m_context, &quot;hoursPC__otPerWeek&quot;);</span>
<span class="fc" id="L102">		pc_otPerWeek.setMaxTime(99, 45, 0);</span>
<span class="fc" id="L103">		pc_otPerWeek.setMinutesIncrement(15);</span>
<span class="fc" id="L104">		pc_otPerWeek.setEnabled(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXOTMINSPERWEEK));</span>
<span class="fc" id="L105">		pc_otPerWeek.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXOTMINSPERWEEK));</span>
<span class="fc" id="L106">		addChildComponent(pc_otPerWeek);</span>

<span class="fc" id="L108">		pc_vtoPerDay = new DurationSpinnerPC(m_context, &quot;hoursPC__vtoPerDay&quot;);</span>
<span class="fc" id="L109">		pc_vtoPerDay.setMaxTime(24, 0, 0);</span>
<span class="fc" id="L110">		pc_vtoPerDay.setMinutesIncrement(15);</span>
<span class="fc" id="L111">		pc_vtoPerDay.setEnabled(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXVTOHOURSPERDAY));</span>
<span class="fc" id="L112">		pc_vtoPerDay.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXVTOHOURSPERDAY));</span>
<span class="fc" id="L113">		addChildComponent(pc_vtoPerDay);</span>

<span class="fc" id="L115">		pc_vtoPerWeek = new DurationSpinnerPC(m_context, &quot;hoursPC__vtoPerWeek&quot;);</span>
<span class="fc" id="L116">		pc_vtoPerWeek.setMaxTime(99, 45, 0);</span>
<span class="fc" id="L117">		pc_vtoPerWeek.setMinutesIncrement(15);</span>
<span class="fc" id="L118">		pc_vtoPerWeek.setEnabled(isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXVTOHOURSPERWEEK));</span>
<span class="fc" id="L119">		pc_vtoPerWeek.setVisible(isFieldViewable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXVTOHOURSPERWEEK));</span>
<span class="fc" id="L120">		addChildComponent(pc_vtoPerWeek);</span>

<span class="fc" id="L122">		html_datesModified = new HtmlInput(&quot;hoursPC__datesModified&quot;, &quot;false&quot;, &quot;hidden&quot;);</span>
<span class="pc bpc" id="L123" title="1 of 4 branches missed.">		html_updateMode = new HtmlInput(&quot;hoursPC__updateMode&quot;, onlyPeriodEditable || employeeIDs.size() &gt; 1 ? DataContainerPC.UPDATE_MODE_2 : DataContainerPC.UPDATE_MODE_1, &quot;hidden&quot;);</span>
<span class="fc" id="L124">		pc_startDate = new DatePickerPC(m_context, &quot;hoursPC__startDate_input&quot;);</span>
<span class="fc" id="L125">		pc_startDate.setName(&quot;hoursPC__startDate&quot;);</span>
<span class="fc" id="L126">		pc_startDate.setEnabled(false);</span>
<span class="fc" id="L127">		pc_startDate.setIsPickerEnabled(false);</span>
<span class="fc" id="L128">		pc_startDate.setIsControlEnabled(false);</span>
<span class="fc" id="L129">		pc_startDate.setIsMultiValueSupported(true);</span>
<span class="fc" id="L130">		addChildComponent(pc_startDate);</span>

<span class="fc" id="L132">		pc_endDate = new DatePickerPC(m_context, &quot;hoursPC__endDate_input&quot;);</span>
<span class="fc" id="L133">		pc_endDate.setName(&quot;hoursPC__endDate&quot;);</span>
<span class="fc" id="L134">		pc_endDate.setEnabled(false);</span>
<span class="fc" id="L135">		pc_endDate.setIsPickerEnabled(false);</span>
<span class="fc" id="L136">		pc_endDate.setIsControlEnabled(false);</span>
<span class="fc" id="L137">		pc_endDate.setIsDateValueOptional(true);</span>
<span class="fc" id="L138">		pc_endDate.setIsMultiValueSupported(true);</span>
<span class="fc" id="L139">		pc_endDate.setDate((LocalDate) null);</span>
<span class="fc" id="L140">		addChildComponent(pc_endDate);</span>

<span class="fc" id="L142">		loadData();</span>

<span class="fc" id="L144">		extractParameters(m_context.getRequest());</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">		if (&quot;true&quot;.equals(html_datesModified.getAttribute(&quot;value&quot;))) {</span>
			//This is a hack to prevent the date picker from redrawing the &quot;*&quot; on a postback
			//For some reason this does not get reset via extract params in DatePickerPC
<span class="nc" id="L148">			pc_endDate.setIsMultiValue(false);</span>
		}

<span class="fc" id="L151">		setTitle(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_HOURS_TITLE));</span>
<span class="fc" id="L152">		initializeRows();</span>
<span class="fc" id="L153">	}</span>

	/**
	 * Initializes the secure field meta data for use in determining viewability/editability of certain fields.
	 */
	private void initializeSecureFieldMetaData() {
<span class="fc" id="L159">		authorizedViewFields = new HashMap&lt;&gt;();</span>
<span class="fc" id="L160">		authorizedEditFields = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L162" title="All 2 branches covered.">		for (Employee emp : employeeMap.values()) {</span>
<span class="fc" id="L163">			int[] viewableFields =</span>
<span class="fc" id="L164">					m_context.getUser().getAuthorizedFields(</span>
							PrivilegeKeys.CORE_VIEWSECUREFIELD,
<span class="fc" id="L166">							new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE));</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">			if (viewableFields == null) {</span>
<span class="nc" id="L168">				viewableFields = new int[0];</span>
			}

<span class="fc" id="L171">			int[] editableFields =</span>
<span class="fc" id="L172">					m_context.getUser().getAuthorizedFields(</span>
							PrivilegeKeys.CORE_EDITSECUREFIELD,
<span class="fc" id="L174">							new ScopeID(emp.getOrganizationID(), Scope.ORG_SCOPE));</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">			if (editableFields == null) {</span>
<span class="nc" id="L176">				editableFields = new int[0];</span>
			}

<span class="fc" id="L179">			authorizedViewFields.put(emp.getID(), ArrayUtil.asList(viewableFields));</span>
<span class="fc" id="L180">			authorizedEditFields.put(emp.getID(), ArrayUtil.asList(editableFields));</span>
<span class="fc" id="L181">		}</span>
<span class="fc" id="L182">	}</span>

	public void setEnabled(boolean enabled) {
<span class="nc" id="L185">		super.setEnabled(enabled);</span>
<span class="nc" id="L186">		pc_maxPaid.setEnabled(enabled);</span>
<span class="nc" id="L187">		pc_minPaid.setEnabled(enabled);</span>
<span class="nc" id="L188">	}</span>

	/**
	 * Returns whether a field is EDITABLE based on the current user and employees/scope selected.
	 *
	 * @param secureFieldInfoId Secure field info {@link com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo SecureFieldInfo}
	 * @return boolean
	 */
	private boolean isFieldEditable(int secureFieldInfoId) {
		// If the field is not viewable then we don't even need to check
		// further for editability.
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">		if (!isFieldViewable(secureFieldInfoId)) {</span>
<span class="nc" id="L200">			return false;</span>
		}

<span class="fc bfc" id="L203" title="All 2 branches covered.">		for (Employee emp : employeeMap.values()) {</span>
			// Just looking for any employee in the selection that doesn't permit EDITING
			// because we can't permit more access than the lowest permitted or actions
			// can be taken that shouldn't be allowed for some of the employees.
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">			if (authorizedEditFields.containsKey(emp.getID())) {</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">				if (!authorizedEditFields.get(emp.getID()).contains(secureFieldInfoId)) {</span>
					// This field is not EDITABLE for this employee and scope so
					// we cannot permit the field to be EDITABLE for the selected
					// employees.
<span class="nc" id="L212">					return false;</span>
				}
			} // If the employee doesn't have any secured field information let's assume they can be accessed.
<span class="fc" id="L215">		}</span>
<span class="fc" id="L216">		return true;</span>
	}

	/**
	 * Returns whether a field is VIEWABLE based on the current user and employees/scope selected.
	 *
	 * @param secureFieldInfoId Secure field info {@link com.bluepumpkin.ejb.bbm.workresource.model.SecureFieldInfo SecureFieldInfo}
	 * @return boolean
	 */
	private boolean isFieldViewable(int secureFieldInfoId) {
<span class="fc bfc" id="L226" title="All 2 branches covered.">		for (Employee emp : employeeMap.values()) {</span>
			// Just looking for any employee in the selection that doesn't permit VIEWING
			// because we can't permit more access than the lowest permitted or actions
			// can be taken that shouldn't be allowed for some of the employees.
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">			if (authorizedViewFields.containsKey(emp.getID())) {</span>
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">				if (!authorizedViewFields.get(emp.getID()).contains(secureFieldInfoId)) {</span>
					// This field is not VIEWABLE for this employee and scope so
					// we cannot permit the field to be VIEWABLE for the selected
					// employees.
<span class="nc" id="L235">					return false;</span>
				}
			} // If the employee doesn't have any secured field information let's assume they can be accessed.
<span class="fc" id="L238">		}</span>
<span class="fc" id="L239">		return true;</span>
	}

	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="fc bfc" id="L244" title="All 2 branches covered.">		if (!extractParams) {</span>
<span class="fc" id="L245">			return true;</span>
		}
<span class="fc" id="L247">		String updateMode = request.getParameter(html_updateMode.getAttribute(&quot;name&quot;));</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(updateMode)) {</span>
<span class="fc" id="L249">			html_updateMode.setAttribute(&quot;value&quot;, updateMode);</span>
		}
<span class="fc" id="L251">		String datesModified = request.getParameter(html_datesModified.getAttribute(&quot;name&quot;));</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(datesModified)) {</span>
<span class="fc" id="L253">			html_datesModified.setAttribute(&quot;value&quot;, datesModified);</span>
		}
<span class="fc" id="L255">		return super.extractParameters(request);</span>
	}

	@Override
	public void setName(String name) {
<span class="fc" id="L260">		super.setName(name);</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">		if (pc_minPaid != null) {</span>
<span class="nc" id="L262">			pc_minPaid.setName(name + &quot;__minPaid&quot;);</span>
		}

<span class="pc bpc" id="L265" title="1 of 2 branches missed.">		if (pc_maxPaid != null) {</span>
<span class="nc" id="L266">			pc_maxPaid.setName(name + &quot;__maxPaid&quot;);</span>
		}

<span class="pc bpc" id="L269" title="1 of 2 branches missed.">		if (pc_otPerDay != null) {</span>
<span class="nc" id="L270">			pc_otPerDay.setName(name + &quot;__otPerDay&quot;);</span>
		}

<span class="pc bpc" id="L273" title="1 of 2 branches missed.">		if (pc_otPerWeek != null) {</span>
<span class="nc" id="L274">			pc_otPerWeek.setName(name + &quot;__otPerWeek&quot;);</span>
		}

<span class="pc bpc" id="L277" title="1 of 2 branches missed.">		if (pc_vtoPerDay != null) {</span>
<span class="nc" id="L278">			pc_vtoPerDay.setName(name + &quot;__vtoPerDay&quot;);</span>
		}

<span class="pc bpc" id="L281" title="1 of 2 branches missed.">		if (pc_vtoPerWeek != null) {</span>
<span class="nc" id="L282">			pc_vtoPerWeek.setName(name + &quot;__vtoPerWeek&quot;);</span>
		}

<span class="pc bpc" id="L285" title="1 of 2 branches missed.">		if (html_updateMode != null) {</span>
<span class="nc" id="L286">			html_updateMode.setAttribute(&quot;name&quot;, name + &quot;__updateMode&quot;);</span>
		}

<span class="pc bpc" id="L289" title="1 of 2 branches missed.">		if (html_datesModified != null) {</span>
<span class="nc" id="L290">			html_datesModified.setAttribute(&quot;name&quot;, name + &quot;__datesModified&quot;);</span>
		}

<span class="pc bpc" id="L293" title="1 of 2 branches missed.">		if (pc_startDate != null) {</span>
<span class="nc" id="L294">			pc_startDate.setName(name + &quot;__startDate&quot;);</span>
		}

<span class="pc bpc" id="L297" title="1 of 2 branches missed.">		if (pc_endDate != null) {</span>
<span class="nc" id="L298">			pc_endDate.setName(name + &quot;__endDate&quot;);</span>
		}
<span class="fc" id="L300">	}</span>

	private void loadData() throws BbmFinderException {
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">		if (employeeIDs.size() == 0) {</span>
<span class="nc" id="L304">			return;</span>
		}
		
		EmpWorkRuleManager ewrm;
		try {
<span class="fc" id="L309">			ewrm = WfmManagerFactory.getEmpWorkRuleManager(m_context.isInWhatIfMode());</span>
<span class="fc" id="L310">			hoursAssignments = ewrm.getMinMaxHourAssignments(employeeIDs, null, null);</span>
			
        	    //Default those that have no entry
<span class="fc bfc" id="L313" title="All 2 branches covered.">        	    for (Employee emp : employeeMap.values()) {</span>
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">        		if (!hoursAssignments.containsKey(emp.getID())) {</span>
<span class="nc" id="L315">        		    List&lt;WorkResourceMinMaxHour&gt; hoursList = WorkResourceMinMaxHour.getDefaultWorkResourceMinMaxHourAssignmentList(emp.getID(), emp.getStartTime());</span>
<span class="nc" id="L316">        		    hoursAssignments.put(emp.getID(), hoursList);</span>
        		}
<span class="fc" id="L318">        	    }</span>
        	    
<span class="nc" id="L320">		} catch (Exception e) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">			if (e instanceof BbmFinderException) {</span>
<span class="nc" id="L322">				throw (BbmFinderException) e;</span>
			}
<span class="nc" id="L324">			throw new BbmFinderException(e);</span>
<span class="fc" id="L325">		}</span>

<span class="fc" id="L327">		Duration biggestMinPaid = Duration.fromMinutes(0);</span>
<span class="fc" id="L328">		Duration smallestMaxPaid = Duration.fromMinutes(Integer.MAX_VALUE);</span>
<span class="fc" id="L329">		Duration biggestOTPerDay = Duration.fromMinutes(0);</span>
<span class="fc" id="L330">		Duration smallestOTPerWeek = Duration.fromMinutes(Integer.MAX_VALUE);</span>
<span class="fc" id="L331">		Duration biggestVTOPerDay = Duration.fromMinutes(0);</span>
<span class="fc" id="L332">		Duration smallestVTOPerWeek = Duration.fromMinutes(Integer.MAX_VALUE);</span>

<span class="fc" id="L334">		boolean first = true;</span>
		// Find all current assignment objects
<span class="fc bfc" id="L336" title="All 2 branches covered.">		for (ID id : employeeIDs) {</span>
<span class="fc" id="L337">			List&lt;WorkResourceMinMaxHour&gt; hoursList = hoursAssignments.get(id);</span>
			
			// This should never happen since we now default every employee above
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">			if (hoursList == null) {</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">				if (employeeIDs.size() &gt; 1) {</span>
<span class="nc" id="L342">					setAllFieldsMultiEdit();</span>
				} else {
					try {
<span class="nc" id="L345">					    	Employee employee = employeeMap.values().iterator().next();</span>
<span class="nc" id="L346">						empStartDate = employee.getStartTimeLocal();</span>
<span class="nc" id="L347">					} catch (Exception ex) {</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">						if (ex instanceof BbmFinderException) {</span>
<span class="nc" id="L349">							throw (BbmFinderException) ex;</span>
						}
<span class="nc" id="L351">						throw new BbmFinderException(ex);</span>
<span class="nc" id="L352">					}</span>
				}
				break;
			}
			
			
<span class="fc" id="L358">			boolean foundCurrentRecordForEmployee = false;</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">			for (WorkResourceMinMaxHour hours : hoursList) {</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">				if (isHoursRecordCurrent(hours)) {</span>
<span class="fc" id="L361">					currentHoursAssignments.put(id, hours);</span>
<span class="fc" id="L362">					foundCurrentRecordForEmployee = true;</span>
<span class="fc bfc" id="L363" title="All 2 branches covered.">					if (first) {</span>
<span class="fc" id="L364">						first = false;</span>
<span class="fc" id="L365">						pc_minPaid.setValue(Duration.fromMinutes(hours.getMinMinutes()));</span>
<span class="fc" id="L366">						pc_maxPaid.setValue(Duration.fromMinutes(hours.getMaxMinutes()));</span>
<span class="fc" id="L367">						pc_otPerDay.setValue(Duration.fromMinutes(hours.getMaxOTMinutesPerDay()));</span>
<span class="fc" id="L368">						pc_otPerWeek.setValue(Duration.fromMinutes(hours.getMaxOTMinutesPerWeek()));</span>
<span class="fc" id="L369">						pc_vtoPerDay.setValue(Duration.fromMinutes(hours.getMaxVTOHoursPerDay()));</span>
<span class="fc" id="L370">						pc_vtoPerWeek.setValue(Duration.fromMinutes(hours.getMaxVTOHoursPerWeek()));</span>
<span class="fc" id="L371">						effectiveDateStart = new LocalDate(hours.getStartTime(),</span>
<span class="fc" id="L372">								employeeMap.get(hours.getWorkResourceID()).getTimeZone(hours.getStartTime()));</span>
<span class="pc bpc" id="L373" title="1 of 2 branches missed.">						if (hours.getEndTime() != null) {</span>
<span class="nc" id="L374">							effectiveDateEnd = new LocalDate(hours.getEndTime(),</span>
<span class="nc" id="L375">									employeeMap.get(hours.getWorkResourceID()).getTimeZone(hours.getEndTime()));</span>
						}
					} else {
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">						if (hours.getMinMinutes() != pc_minPaid.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L379">							pc_minPaid.setMultiEdit(true);</span>
						}

<span class="pc bpc" id="L382" title="1 of 2 branches missed.">						if (hours.getMaxMinutes() != pc_maxPaid.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L383">							pc_maxPaid.setMultiEdit(true);</span>
						}

<span class="pc bpc" id="L386" title="1 of 2 branches missed.">						if (hours.getMaxOTMinutesPerDay() != pc_otPerDay.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L387">							pc_otPerDay.setMultiEdit(true);</span>
						}

<span class="pc bpc" id="L390" title="1 of 2 branches missed.">						if (hours.getMaxOTMinutesPerWeek() != pc_otPerWeek.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L391">							pc_otPerWeek.setMultiEdit(true);</span>
						}

<span class="pc bpc" id="L394" title="1 of 2 branches missed.">						if (hours.getMaxVTOHoursPerDay() != pc_vtoPerDay.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L395">							pc_vtoPerDay.setMultiEdit(true);</span>
						}

<span class="pc bpc" id="L398" title="1 of 2 branches missed.">						if (hours.getMaxVTOHoursPerWeek() != pc_vtoPerWeek.getDuration().getDurationInMinutes()) {</span>
<span class="nc" id="L399">							pc_vtoPerWeek.setMultiEdit(true);</span>
						}

<span class="fc" id="L402">						LocalDate hoursStartLocal = new LocalDate(hours.getStartTime(), employeeMap.get(hours.getWorkResourceID()).getTimeZone(hours.getStartTime()));</span>

<span class="fc bfc" id="L404" title="All 2 branches covered.">						if (!hoursStartLocal.equals(effectiveDateStart)) {</span>
<span class="fc" id="L405">							pc_startDate.setIsMultiValue(true);</span>
						}

<span class="fc" id="L408">						LocalDate hoursEndLocal = null;</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">						if (hours.getEndTime() != null) {</span>
<span class="nc" id="L410">							hoursEndLocal = new LocalDate(hours.getEndTime(),</span>
<span class="nc" id="L411">									employeeMap.get(hours.getWorkResourceID()).getTimeZone(hours.getEndTime()));</span>
						}
<span class="pc bpc" id="L413" title="6 of 10 branches missed.">						if ((hoursEndLocal == null &amp;&amp; effectiveDateEnd != null)</span>
								|| (hoursEndLocal != null &amp;&amp; effectiveDateEnd == null)
<span class="nc bnc" id="L415" title="All 2 branches missed.">								|| (hoursEndLocal != null &amp;&amp; !hoursEndLocal.equals(effectiveDateEnd))) {</span>
<span class="nc" id="L416">							pc_endDate.setIsMultiValue(true);</span>
						}
					}

<span class="fc bfc" id="L420" title="All 2 branches covered.">					if (hours.getMinMinutes() &gt; biggestMinPaid.getDurationInMinutes()) {</span>
<span class="fc" id="L421">						biggestMinPaid = Duration.fromMinutes(hours.getMinMinutes());</span>
					}

<span class="fc bfc" id="L424" title="All 2 branches covered.">					if (hours.getMaxMinutes() &lt; smallestMaxPaid.getDurationInMinutes()) {</span>
<span class="fc" id="L425">						smallestMaxPaid = Duration.fromMinutes(hours.getMaxMinutes());</span>
					}

<span class="fc bfc" id="L428" title="All 2 branches covered.">					if (hours.getMaxOTMinutesPerDay() &gt; biggestOTPerDay.getDurationInMinutes()) {</span>
<span class="fc" id="L429">						biggestOTPerDay = Duration.fromMinutes(hours.getMaxOTMinutesPerDay());</span>
					}

<span class="fc bfc" id="L432" title="All 2 branches covered.">					if (hours.getMaxOTMinutesPerWeek() &lt; smallestOTPerWeek.getDurationInMinutes()) {</span>
<span class="fc" id="L433">						smallestOTPerWeek = Duration.fromMinutes(hours.getMaxOTMinutesPerWeek());</span>
					}

<span class="pc bpc" id="L436" title="1 of 2 branches missed.">					if (hours.getMaxVTOHoursPerDay() &gt; biggestVTOPerDay.getDurationInMinutes()) {</span>
<span class="nc" id="L437">						biggestVTOPerDay = Duration.fromMinutes(hours.getMaxVTOHoursPerDay());</span>
					}

<span class="fc bfc" id="L440" title="All 2 branches covered.">					if (hours.getMaxVTOHoursPerWeek() &lt; smallestVTOPerWeek.getDurationInMinutes()) {</span>
<span class="fc" id="L441">						smallestVTOPerWeek = Duration.fromMinutes(hours.getMaxVTOHoursPerWeek());</span>
					}

					break;
				} // if hours record is current
<span class="nc" id="L446">			} // for each employees hoursList</span>
<span class="pc bpc" id="L447" title="1 of 4 branches missed.">			if (employeeIDs.size() &gt; 1 &amp;&amp; !foundCurrentRecordForEmployee) {</span>
<span class="nc" id="L448">				setAllFieldsMultiEdit();</span>
			}
<span class="fc" id="L450">			resetMultiEditFields();</span>
<span class="fc" id="L451">		} // for all employees</span>

<span class="fc bfc" id="L453" title="All 2 branches covered.">		if (pc_startDate.isMultiValue() == false) {</span>
<span class="pc bpc" id="L454" title="1 of 2 branches missed.">			if (empStartDate != null) {</span>
<span class="nc" id="L455">				pc_startDate.setDate(empStartDate);</span>
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">			} else if (effectiveDateStart != null) {</span>
<span class="fc" id="L457">				pc_startDate.setDate(effectiveDateStart);</span>
			} else {  //This is a wierd case.  It only happens when employees have effective history but none of it covers the current view period.
<span class="nc" id="L459">				pc_startDate.setDate(viewPeriodStart);</span>
<span class="nc" id="L460">				effectiveDateStart = viewPeriodStart;</span>
			}
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">			if (effectiveDateEnd != null) {</span>
<span class="nc" id="L463">				pc_endDate.setDate(effectiveDateEnd);</span>
			}
		}

<span class="fc" id="L467">		pc_minPaid.setAsMinimumValueSpinner(pc_maxPaid.getName(), smallestMaxPaid);</span>
<span class="fc" id="L468">		pc_maxPaid.setAsMaximumValueSpinner(pc_minPaid.getName(), biggestMinPaid);</span>
<span class="fc" id="L469">		pc_otPerDay.setAsMinimumValueSpinner(pc_otPerWeek.getName(), smallestOTPerWeek);</span>
<span class="fc" id="L470">		pc_otPerWeek.setAsMaximumValueSpinner(pc_otPerDay.getName(), biggestOTPerDay);</span>
<span class="fc" id="L471">		pc_vtoPerDay.setAsMinimumValueSpinner(pc_vtoPerWeek.getName(), smallestVTOPerWeek);</span>
<span class="fc" id="L472">		pc_vtoPerWeek.setAsMaximumValueSpinner(pc_vtoPerDay.getName(), biggestVTOPerDay);</span>

		//If in campaign mode, when the user changes the values for the hours spinners the selected date range
		// will snap to the current view period
<span class="pc bpc" id="L476" title="1 of 2 branches missed.">		if (onlyPeriodEditable) {</span>
<span class="nc" id="L477">			pc_minPaid.setOnChangeJS(&quot;snapHoursEffectiveDatesToViewPeriod();&quot;);</span>
<span class="nc" id="L478">			pc_maxPaid.setOnChangeJS(&quot;snapHoursEffectiveDatesToViewPeriod();&quot;);</span>
<span class="nc" id="L479">			pc_otPerDay.setOnChangeJS(&quot;snapHoursEffectiveDatesToViewPeriod();&quot;);</span>
<span class="nc" id="L480">			pc_otPerWeek.setOnChangeJS(&quot;snapHoursEffectiveDatesToViewPeriod();&quot;);</span>
<span class="nc" id="L481">			pc_vtoPerDay.setOnChangeJS(&quot;snapHoursEffectiveDatesToViewPeriod();&quot;);</span>
<span class="nc" id="L482">			pc_vtoPerWeek.setOnChangeJS(&quot;snapHoursEffectiveDatesToViewPeriod();&quot;);</span>
		}
<span class="fc" id="L484">	}</span>


	/**
	 * Determines if the current hours record is &quot;current&quot;, in other words it applies to the current
	 * view period.  This is true if the start date of the hours lies before or at the view period start date
	 * and the hours end date is either null or lies after the view period start date.  Hours records are also
	 * current if they lie between the view start and end dates.
	 */
	private boolean isHoursRecordCurrent(WorkResourceMinMaxHour hours) {
		TimeZone empTimeZone;
<span class="fc" id="L495">		Employee emp = employeeMap.get(hours.getWorkResourceID());</span>
		//Determine time zone of employee at record start
<span class="pc bpc" id="L497" title="1 of 2 branches missed.">		if (emp.getStartTime().after(hours.getStartTime())) {</span>
<span class="nc" id="L498">			empTimeZone = emp.getTimeZone(emp.getStartTime());</span>
		} else {
<span class="fc" id="L500">			empTimeZone = emp.getTimeZone(hours.getStartTime());</span>
		}
<span class="fc" id="L502">		LocalDate localEffectiveStart = new LocalDate(hours.getStartTime(), empTimeZone);</span>
<span class="fc" id="L503">		LocalDate localEffectiveEnd = null;</span>
		//Determine time zone of employee at record end
<span class="pc bpc" id="L505" title="1 of 2 branches missed.">		if (hours.getEndTime() != null) {</span>
<span class="nc bnc" id="L506" title="All 4 branches missed.">			if (emp.getEndTime() == null || emp.getEndTime().after(hours.getEndTime())) {</span>
<span class="nc" id="L507">				empTimeZone = emp.getTimeZone(hours.getEndTime());</span>
			} else {
<span class="nc" id="L509">				empTimeZone = emp.getTimeZone(emp.getEndTime());</span>
			}
<span class="nc" id="L511">			localEffectiveEnd = new LocalDate(hours.getEndTime(), empTimeZone);</span>
		}
<span class="pc bpc" id="L513" title="4 of 6 branches missed.">		return ((localEffectiveStart.before(viewPeriodStart) || localEffectiveStart.equals(viewPeriodStart))</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">				&amp;&amp; (localEffectiveEnd == null || localEffectiveEnd.after(viewPeriodStart))) ||</span>
<span class="pc bnc" id="L515" title="All 4 branches missed.">				(localEffectiveStart.after(viewPeriodStart) &amp;&amp; localEffectiveStart.before(viewPeriodEnd));</span>
	}

	private void setAllFieldsMultiEdit() {
<span class="nc" id="L519">		pc_minPaid.setMultiEdit(true);</span>
<span class="nc" id="L520">		pc_maxPaid.setMultiEdit(true);</span>
<span class="nc" id="L521">		pc_otPerDay.setMultiEdit(true);</span>
<span class="nc" id="L522">		pc_otPerWeek.setMultiEdit(true);</span>
<span class="nc" id="L523">		pc_vtoPerDay.setMultiEdit(true);</span>
<span class="nc" id="L524">		pc_vtoPerWeek.setMultiEdit(true);</span>
<span class="nc" id="L525">		pc_startDate.setIsMultiValue(true);</span>
<span class="nc" id="L526">		pc_endDate.setIsMultiValue(true);</span>
<span class="nc" id="L527">	}</span>

	private void resetMultiEditFields() {
<span class="pc bpc" id="L530" title="1 of 2 branches missed.">		if (pc_minPaid.isMultiEdit()) {</span>
<span class="nc" id="L531">			pc_minPaid.setValue(Duration.fromMinutes(0));</span>
		}

<span class="pc bpc" id="L534" title="1 of 2 branches missed.">		if (pc_maxPaid.isMultiEdit()) {</span>
<span class="nc" id="L535">			pc_maxPaid.setValue(Duration.fromMinutes(0));</span>
		}

<span class="pc bpc" id="L538" title="1 of 2 branches missed.">		if (pc_otPerDay.isMultiEdit()) {</span>
<span class="nc" id="L539">			pc_otPerDay.setValue(Duration.fromMinutes(0));</span>
		}

<span class="pc bpc" id="L542" title="1 of 2 branches missed.">		if (pc_otPerWeek.isMultiEdit()) {</span>
<span class="nc" id="L543">			pc_otPerWeek.setValue(Duration.fromMinutes(0));</span>
		}

<span class="pc bpc" id="L546" title="1 of 2 branches missed.">		if (pc_vtoPerDay.isMultiEdit()) {</span>
<span class="nc" id="L547">			pc_vtoPerDay.setValue(Duration.fromMinutes(0));</span>
		}

<span class="pc bpc" id="L550" title="1 of 2 branches missed.">		if (pc_vtoPerWeek.isMultiEdit()) {</span>
<span class="nc" id="L551">			pc_vtoPerWeek.setValue(Duration.fromMinutes(0));</span>
		}
<span class="fc" id="L553">	}</span>

	private void initializeRows() {
		Object leftLabel;
		Object left;
		Object right;
		Object rightLabel;

<span class="pc bpc" id="L561" title="1 of 2 branches missed.">		leftLabel = pc_minPaid.isVisible() ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MIN_PAID_HOURS) : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">		left = pc_minPaid.isVisible() ? pc_minPaid.getHtmlDisplay() : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L563" title="1 of 2 branches missed.">		rightLabel = pc_maxPaid.isVisible() ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MAX_PAID_HOURS) : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L564" title="1 of 2 branches missed.">		right = pc_maxPaid.isVisible() ? pc_maxPaid.getHtmlDisplay() : &quot;&amp;nbsp;&quot;;</span>

		// Only add the min paid and max paid row if at least one of them is visible.
<span class="pc bpc" id="L567" title="3 of 4 branches missed.">		if (pc_minPaid.isVisible() || pc_maxPaid.isVisible()) {</span>
<span class="fc" id="L568">			addRowData(leftLabel, left, rightLabel, right);</span>
		}

<span class="pc bpc" id="L571" title="1 of 2 branches missed.">		leftLabel = pc_otPerDay.isVisible() ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MAX_OT_PER_DAY) : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L572" title="1 of 2 branches missed.">		left = pc_otPerDay.isVisible() ? pc_otPerDay.getHtmlDisplay() : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L573" title="1 of 2 branches missed.">		rightLabel = pc_otPerWeek.isVisible() ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MAX_OT_PER_WEEK) : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L574" title="1 of 2 branches missed.">		right = pc_otPerWeek.isVisible() ? pc_otPerWeek.getHtmlDisplay() : &quot;&amp;nbsp;&quot;;</span>

<span class="pc bpc" id="L576" title="3 of 4 branches missed.">		if (pc_otPerDay.isVisible() || pc_otPerWeek.isVisible()) {</span>
<span class="fc" id="L577">			addRowData(leftLabel, left, rightLabel, right);</span>
		}

<span class="pc bpc" id="L580" title="1 of 2 branches missed.">		leftLabel = pc_vtoPerDay.isVisible() ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MAX_VTO_PER_DAY) : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L581" title="1 of 2 branches missed.">		left = pc_vtoPerDay.isVisible() ? pc_vtoPerDay.getHtmlDisplay() : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L582" title="1 of 2 branches missed.">		rightLabel = pc_vtoPerWeek.isVisible() ? m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_MAX_VTO_PER_WEEK) : &quot;&amp;nbsp;&quot;;</span>
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">		right = pc_vtoPerWeek.isVisible() ? pc_vtoPerWeek.getHtmlDisplay() : &quot;&amp;nbsp;&quot;;</span>

<span class="pc bpc" id="L585" title="3 of 4 branches missed.">		if (pc_vtoPerDay.isVisible() || pc_vtoPerWeek.isVisible()) {</span>
<span class="fc" id="L586">			addRowData(leftLabel, left, rightLabel, right);</span>
		}

<span class="fc" id="L589">		final StringBuffer editIconHtml = new StringBuffer();</span>
<span class="pc bpc" id="L590" title="1 of 2 branches missed.">		if (isAnySpinnerVisible()) {</span>
<span class="fc" id="L591">			editIconHtml.append(HtmlUtil.imageTag(ImageFileID.EDIT, ImageFileID.EDIT_WIDTH,</span>
<span class="fc" id="L592">					ImageFileID.EDIT_HEIGHT, m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.EDIT), false))</span>
<span class="fc" id="L593">					.append(&quot; onClick=\&quot;&quot;).append(pc_toolbar.getName()).append(&quot;.onSelect('&quot;).append(HoursPopupPM.HOURS_POPUP_ID).append(&quot;',this)\&quot; &quot;)</span>
<span class="fc" id="L594">					.append(&quot;actionType=\&quot;POPUP_WINDOW_TYPE\&quot;&quot;)</span>
<span class="fc" id="L595">					.append(&quot;style=\&quot;vertical-align: middle;\&quot;&quot;)</span>
<span class="fc" id="L596">					.append(&quot;&gt;&quot;);</span>
		}

<span class="fc" id="L599">		SimpleDateFormat sdf = new SimpleDateFormat(m_context.getLocalizer().getDateInputFormat(), m_context.getLocalizer().getLocaleContext().getRegionalFormatLocale());</span>
<span class="fc" id="L600">		StringBuffer args = new StringBuffer(&quot;selectedID=&quot;).append(StringUtil.createDelimitedString(employeeIDs.toArray(new ID[employeeIDs.size()]), &quot;%2C&quot;));</span>
<span class="fc" id="L601">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_START).append(&quot;=&quot;).append(viewPeriodStart.getTime(TimeZoneUtil.GMT_TIMEZONE).getTime());</span>
		//End date is inclusive
<span class="fc" id="L603">		LocalDate viewPeriodEndDisplay = new LocalDate(viewPeriodEnd);</span>
<span class="fc" id="L604">		viewPeriodEndDisplay.add(Calendar.DATE, -1);</span>
<span class="fc" id="L605">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_END).append(&quot;=&quot;).append(viewPeriodEndDisplay.getTime(TimeZoneUtil.GMT_TIMEZONE).getTime());</span>
<span class="fc" id="L606">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_PERIOD_ONLY).append(&quot;=&quot;).append(onlyPeriodEditable);</span>
<span class="fc bfc" id="L607" title="All 2 branches covered.">		if (employeeIDs.size() &gt; 1) {    //If in multi-edit mode, we will only be editing along the view date ranges</span>
<span class="fc" id="L608">			args.append(&quot;&amp;CUR_PERIOD_START=&quot; /* Defined in DataContainerPC */).append(sdf.format(viewPeriodStart.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
<span class="fc" id="L609">			args.append(&quot;&amp;CUR_PERIOD_END=&quot; /* Defined in DataContainerPC */).append(sdf.format(viewPeriodEndDisplay.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
		} else {
<span class="pc bpc" id="L611" title="1 of 2 branches missed.">			if (effectiveDateStart != null) {</span>
<span class="fc" id="L612">				args.append(&quot;&amp;CUR_PERIOD_START=&quot; /* Defined in DataContainerPC */).append(sdf.format(effectiveDateStart.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
			}
<span class="pc bpc" id="L614" title="1 of 2 branches missed.">			if (effectiveDateEnd != null) {</span>
<span class="nc" id="L615">				args.append(&quot;&amp;CUR_PERIOD_END=&quot; /* Defined in DataContainerPC */).append(sdf.format(effectiveDateEnd.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
			}
		}
<span class="fc" id="L618">		args.append(&quot;&amp;PERIOD_START=&quot; /* Defined in DataContainerPC */).append(sdf.format(viewPeriodStart.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
<span class="fc" id="L619">		args.append(&quot;&amp;PERIOD_END=&quot; /* Defined in DataContainerPC */).append(sdf.format(viewPeriodEndDisplay.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
<span class="fc" id="L620">		args.append(&quot;&amp;&quot;).append(ProfilePageModel.SHOW_AS_DATE_FN).append(&quot;=&quot;).append(sdf.format(viewPeriodStart.getTime(TimeZoneUtil.GMT_TIMEZONE)));</span>
<span class="fc" id="L621">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_START_NAME).append(&quot;=&quot;).append(pc_startDate.getDateInputFieldName());</span>
<span class="fc" id="L622">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_END_NAME).append(&quot;=&quot;).append(pc_endDate.getDateInputFieldName());</span>
<span class="fc" id="L623">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_MIN_PAID_NAME).append(&quot;=&quot;).append(pc_minPaid.getName());</span>
<span class="fc" id="L624">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_MAX_PAID_NAME).append(&quot;=&quot;).append(pc_maxPaid.getName());</span>
<span class="fc" id="L625">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_OT_PER_DAY_NAME).append(&quot;=&quot;).append(pc_otPerDay.getName());</span>
<span class="fc" id="L626">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_OT_PER_WEEK_NAME).append(&quot;=&quot;).append(pc_otPerWeek.getName());</span>
<span class="fc" id="L627">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_VTO_PER_DAY_NAME).append(&quot;=&quot;).append(pc_vtoPerDay.getName());</span>
<span class="fc" id="L628">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_VTO_PER_WEEK_NAME).append(&quot;=&quot;).append(pc_vtoPerWeek.getName());</span>
<span class="fc" id="L629">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_UPDATE_MODE_NAME).append(&quot;=&quot;).append(html_updateMode.getAttribute(&quot;name&quot;));</span>
<span class="fc" id="L630">		args.append(&quot;&amp;&quot;).append(HoursPopupPM.PARAM_DATES_MODIFIED_NAME).append(&quot;=&quot;).append(html_datesModified.getAttribute(&quot;name&quot;));</span>
<span class="fc" id="L631">		addPopupArgs(HoursPopupPM.HOURS_POPUP_ID, &quot;work_rules_assignment_hours_popup&quot;, args.toString(), html_updateMode.getAttribute(&quot;name&quot;), &quot;1000,600,ctr,ctr&quot;, true, 1);</span>

<span class="fc" id="L633">		addRowData(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_START_DATE),</span>
<span class="fc" id="L634">				pc_startDate.toString() + editIconHtml.toString() + html_updateMode.toString() + html_datesModified.toString(),</span>
<span class="fc" id="L635">				m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_END_DATE),</span>
<span class="fc" id="L636">				pc_endDate.toString());</span>
<span class="fc" id="L637">	}</span>

	/**
	 * Returns true if any of the spinner components are enabled.
	 */
	public boolean isAnySpinnerEnabled() {
<span class="pc bpc" id="L643" title="5 of 6 branches missed.">		if (pc_minPaid.isEnabled() || pc_maxPaid.isEnabled() || pc_otPerDay.isEnabled() ||</span>
<span class="nc bnc" id="L644" title="All 6 branches missed.">				pc_otPerWeek.isEnabled() || pc_vtoPerDay.isEnabled() || pc_vtoPerWeek.isEnabled()) {</span>
<span class="fc" id="L645">			return true;</span>
		}
<span class="nc" id="L647">		return false;</span>
	}

	/**
	 * Returns true if any of the spinner components are visible.
	 */
	public boolean isAnySpinnerVisible() {
<span class="pc bpc" id="L654" title="5 of 6 branches missed.">		if (pc_minPaid.isVisible() || pc_maxPaid.isVisible() || pc_otPerDay.isVisible() ||</span>
<span class="nc bnc" id="L655" title="All 6 branches missed.">				pc_otPerWeek.isVisible() || pc_vtoPerDay.isVisible() || pc_vtoPerWeek.isVisible()) {</span>
<span class="fc" id="L656">			return true;</span>
		}
<span class="nc" id="L658">		return false;</span>
	}

	// ---- Getters &amp; Setters ---- //

	public Duration getMinPaid() {
<span class="nc" id="L664">		return pc_minPaid.getDuration();</span>
	}

	public Duration getMaxPaid() {
<span class="nc" id="L668">		return pc_maxPaid.getDuration();</span>
	}

	public Duration getOtPerDay() {
<span class="nc" id="L672">		return pc_otPerDay.getDuration();</span>
	}

	public Duration getOtPerWeek() {
<span class="nc" id="L676">		return pc_otPerWeek.getDuration();</span>
	}

	public Duration getVtoPerDay() {
<span class="nc" id="L680">		return pc_vtoPerDay.getDuration();</span>
	}

	public Duration getVtoPerWeek() {
<span class="nc" id="L684">		return pc_vtoPerWeek.getDuration();</span>
	}

	public LocalDate getStartDate() {
<span class="nc" id="L688">		return pc_startDate.getLocalDate();</span>
	}

	public LocalDate getEndDate() {
<span class="nc" id="L692">		return pc_endDate.getLocalDate();</span>
	}

	public void setViewPeriodStart(long viewPeriodStart) {
<span class="nc" id="L696">		this.viewPeriodStart = new LocalDate(new Date(viewPeriodStart), TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L697">	}</span>

	public void setViewPeriodEnd(long viewPeriodEnd) {
<span class="nc" id="L700">		this.viewPeriodEnd = new LocalDate(new Date(viewPeriodEnd), TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L701">	}</span>

	public void save() throws BbmException {
<span class="fc" id="L704">		boolean edited =</span>
<span class="pc bpc" id="L705" title="1 of 2 branches missed.">				pc_minPaid.isEdited()</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">						|| pc_maxPaid.isEdited()</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">						|| pc_otPerDay.isEdited()</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">						|| pc_otPerWeek.isEdited()</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">						|| pc_vtoPerDay.isEdited()</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">						|| pc_vtoPerWeek.isEdited()</span>
<span class="pc bnc" id="L711" title="All 2 branches missed.">						|| &quot;true&quot;.equals(html_datesModified.getAttribute(&quot;value&quot;));</span>
<span class="pc bpc" id="L712" title="1 of 2 branches missed.">		if (edited) {</span>
<span class="fc" id="L713">			EmpWorkRuleManager ewrm = WfmManagerFactory.getEmpWorkRuleManager(m_context.isInWhatIfMode());</span>
<span class="fc bfc" id="L714" title="All 2 branches covered.">			for (Employee employee : employeeMap.values()) {</span>
<span class="fc" id="L715">				WorkResourceMinMaxHour wrmmh = currentHoursAssignments.get(employee.getID());</span>
<span class="pc bpc" id="L716" title="1 of 2 branches missed.">				if (wrmmh == null) {</span>
<span class="nc" id="L717">					wrmmh = new WorkResourceMinMaxHour();</span>
				}

<span class="fc" id="L720">				wrmmh.setWorkResourceID(employee.getID());</span>
<span class="pc bpc" id="L721" title="1 of 2 branches missed.">				if (pc_minPaid.isEdited()) {</span>
<span class="fc" id="L722">					wrmmh.setMinMinutes(pc_minPaid.getDuration().getDurationInMinutes());</span>
				}

<span class="pc bpc" id="L725" title="1 of 2 branches missed.">				if (pc_maxPaid.isEdited()) {</span>
<span class="fc" id="L726">					wrmmh.setMaxMinutes(pc_maxPaid.getDuration().getDurationInMinutes());</span>
				}

				// These fields should only be set if the field is editable.  Since the page component may or may not
				// be added to the rendered markup now because of the secured field implementation, you can't rely on
				// property state of the page components for decision making here.
<span class="pc bpc" id="L732" title="1 of 4 branches missed.">				if (pc_otPerDay.isEdited() &amp;&amp; isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXOTMINSPERDAY)) {</span>
<span class="fc" id="L733">					wrmmh.setMaxOTMinutesPerDay(pc_otPerDay.getDuration().getDurationInMinutes());</span>
				}

<span class="pc bpc" id="L736" title="1 of 4 branches missed.">				if (pc_otPerWeek.isEdited() &amp;&amp; isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXOTMINSPERWEEK)) {</span>
<span class="fc" id="L737">					wrmmh.setMaxOTMinutesPerWeek(pc_otPerWeek.getDuration().getDurationInMinutes());</span>
				}

<span class="pc bpc" id="L740" title="1 of 4 branches missed.">				if (pc_vtoPerDay.isEdited() &amp;&amp; isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXVTOHOURSPERDAY)) {</span>
<span class="fc" id="L741">					wrmmh.setMaxVTOHoursPerDay(pc_vtoPerDay.getDuration().getDurationInMinutes());</span>
				}

<span class="pc bpc" id="L744" title="1 of 4 branches missed.">				if (pc_vtoPerWeek.isEdited() &amp;&amp; isFieldEditable(SecureFieldInfo.SECFLD_EMPLOYEE_MAXVTOHOURSPERWEEK)) {</span>
<span class="fc" id="L745">					wrmmh.setMaxVTOHoursPerWeek(pc_vtoPerWeek.getDuration().getDurationInMinutes());</span>
				}

				// The Date pickers do not have a value in the multi-edit scenario.
				// Additionally, they don't have an isedited property to determine
				// when we should use the date from the date picker and when it should
				// be used from the current assignment.
<span class="fc" id="L752">				LocalDate localStartDate = pc_startDate.getLocalDate();</span>
<span class="fc bfc" id="L753" title="All 2 branches covered.">				if (localStartDate == null) {  //The only way we could have a null date here is if we are in multi-edit and the date was not modified.  Just use the current assignment date in that case.</span>
<span class="pc bpc" id="L754" title="1 of 2 branches missed.">					if (currentHoursAssignments.containsKey(employee.getID())) {</span>
<span class="fc" id="L755">						localStartDate = new LocalDate(</span>
<span class="fc" id="L756">								currentHoursAssignments.get(employee.getID()).getStartTime(),</span>
<span class="fc" id="L757">								employee.getTimeZone(currentHoursAssignments.get(employee.getID()).getStartTime()));</span>
					} else {  //Employee does not have any hours records.  This record should therefore begin on his/her start date.
<span class="nc" id="L759">						localStartDate = employee.getStartTimeLocal();</span>
					}
				}
<span class="pc bpc" id="L762" title="1 of 2 branches missed.">				if (localStartDate.before(employee.getStartTimeLocal())) {</span>
<span class="nc" id="L763">					localStartDate = employee.getStartTimeLocal();</span>
				}

<span class="fc" id="L766">				wrmmh.setStartTime(localStartDate.getTime(</span>
<span class="fc" id="L767">						employee.getTimeZone(localStartDate.getTime(TimeZoneUtil.GMT_TIMEZONE))));</span>
<span class="fc" id="L768">				LocalDate localEndDate = pc_endDate.getLocalDate();</span>
				//If end date coming back from the picker is null this could mean one of two things:
				// 1 - The picker was multi-edit and did not change.
				// 2 - The picker had its end date explicitly set to null (open-ended).
				// We need to check if the dates were modified, if they were, then that means the date
				// was explicitly set to null (otherwise they were unchanged and we can assume that the
				// picker remained in a multi-value state)
<span class="pc bpc" id="L775" title="1 of 2 branches missed.">				if (localEndDate == null) {</span>
<span class="pc bpc" id="L776" title="1 of 2 branches missed.">					if (&quot;true&quot;.equals(html_datesModified.getAttribute(&quot;value&quot;))) {</span>
<span class="nc" id="L777">						wrmmh.setEndTime(null);</span>
<span class="pc bpc" id="L778" title="1 of 2 branches missed.">					} else if (currentHoursAssignments.containsKey(employee.getID()) &amp;&amp;</span>
<span class="pc bpc" id="L779" title="1 of 2 branches missed.">							currentHoursAssignments.get(employee.getID()).getEndTime() != null) {</span>
<span class="nc" id="L780">						localEndDate = new LocalDate(</span>
<span class="nc" id="L781">								currentHoursAssignments.get(employee.getID()).getEndTime(),</span>
<span class="nc" id="L782">								employee.getTimeZone(currentHoursAssignments.get(employee.getID()).getEndTime()));</span>
					}
				} else {
<span class="nc" id="L785">					localEndDate.add(Calendar.DATE, 1);    //Display date was inclusive, we need to add one day to get the value we should be comparing DB records against</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">					if (localEndDate.after(employee.getEndTimeLocal())) {</span>
<span class="nc" id="L787">						localEndDate = employee.getEndTimeLocal();</span>
					}

<span class="nc" id="L790">					wrmmh.setEndTime(localEndDate.getTime(</span>
<span class="nc" id="L791">							employee.getTimeZone(localEndDate.getTime(TimeZoneUtil.GMT_TIMEZONE))));</span>
				}
				try {
<span class="fc bfc" id="L794" title="All 2 branches covered.">					if (DataContainerPC.UPDATE_MODE_1.equals(html_updateMode.getAttribute(&quot;value&quot;))) {</span>
<span class="fc" id="L795">						ewrm.updateMinMaxHourAssignment(wrmmh, true);</span>
					} else {
<span class="fc" id="L797">						ewrm.createMinMaxHourAssignment(wrmmh);</span>
					}
<span class="nc" id="L799">				} catch (Exception ex) {</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">					if (ex instanceof BbmException) {</span>
<span class="nc" id="L801">						throw (BbmException) ex;</span>
					}
<span class="nc" id="L803">					throw new BbmException(ex);</span>
<span class="fc" id="L804">				}</span>
<span class="fc" id="L805">			}</span>
		}
<span class="fc" id="L807">	}</span>

	@Override
	public String getJavaScriptInitCode() {
<span class="fc" id="L811">		StringBuffer js = new StringBuffer();</span>
<span class="fc" id="L812">		js.append(super.getJavaScriptInitCode());</span>
<span class="pc bpc" id="L813" title="1 of 2 branches missed.">		if (onlyPeriodEditable) {</span>
<span class="nc" id="L814">			js.append(getDateSnapOnValueChangeJS());</span>
		}
<span class="fc" id="L816">		return js.toString();</span>
	}

	/**
	 * This JS is used to force the effective dates to snap to the view period if a duration spinner is modified
	 * when in campaign mode (essentially it will match the view period of the currently selected SP).
	 */
	private String getDateSnapOnValueChangeJS() {
<span class="nc bnc" id="L824" title="All 2 branches missed.">		String startDateDisplay = viewPeriodStart == null ? &quot;&quot; : m_localizer.formatDate(viewPeriodStart, RegionalFormatBundleKey.DATE_FORMAT);</span>
<span class="nc" id="L825">		String endDateDisplay = &quot;&quot;;</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">		if (viewPeriodEnd != null) {</span>
<span class="nc" id="L827">			LocalDate viewPeriodEndDisplay = new LocalDate(viewPeriodEnd);</span>
<span class="nc" id="L828">			viewPeriodEndDisplay.add(Calendar.DATE, -1);</span>
<span class="nc" id="L829">			endDateDisplay = m_localizer.formatDate(viewPeriodEndDisplay, RegionalFormatBundleKey.DATE_FORMAT);</span>
		}
<span class="nc" id="L831">		StringBuffer js = new StringBuffer();</span>
<span class="nc" id="L832">		js.append(&quot;function snapHoursEffectiveDatesToViewPeriod() {\n&quot;)</span>
<span class="nc" id="L833">				.append(&quot;\t var startElements = document.getElementsByName('&quot;).append(pc_startDate.getDateInputFieldName()).append(&quot;');\n&quot;)</span>
<span class="nc" id="L834">				.append(&quot;\t if (startElements.length == 1) startElements[0].value = '&quot;).append(startDateDisplay).append(&quot;';\n&quot;)</span>
<span class="nc" id="L835">				.append(&quot;\t var endElements = document.getElementsByName('&quot;).append(pc_endDate.getDateInputFieldName()).append(&quot;');\n&quot;)</span>
<span class="nc" id="L836">				.append(&quot;\t if (endElements.length == 1) endElements[0].value = '&quot;).append(endDateDisplay).append(&quot;';\n&quot;)</span>
<span class="nc" id="L837">				.append(&quot;}\n&quot;);</span>

<span class="nc" id="L839">		return js.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>