<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffRequestFormPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.timeoff</a> &gt; <span class="el_source">TimeOffRequestFormPopupPM.java</span></div><h1>TimeOffRequestFormPopupPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.timeoff;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.PersonNameUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityProperties;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.profile.model.UserProfile;
import com.bluepumpkin.ejb.facade.base.FacadeException;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.requests.timeoff.waitlist.model.TOWaitlist;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.DateUtil;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.ejb.rm.util.TORequestUtil;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.keys.RmJavaScriptFileID;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestFormPopupPM;
import com.bluepumpkin.web.rm.requests.RequestUtil;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.jsp.HtmlDiv;
import com.witness.web.uif.jsp.HtmlTableCell;
import com.witness.web.uif.keys.AccessibilityComplianceKeys;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.BaseNodeData;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.list.DualListBoxPC;
import com.witness.web.uif.pagecomponent.list.DynamicMultiColListPC;
import com.witness.web.uif.pagecomponent.list.DynamicMultiColListWithToolbarPC;
import com.witness.web.uif.pagecomponent.list.OptionData;
import com.witness.web.uif.pagecomponent.message.MessagePC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.date.DateRangePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.DurationSpinnerPC;
import com.witness.web.uif.pagecomponent.picker.time.TimePickerPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title:		 TimeOffRequestFormPopupPM
 * Description:  Time Off Request Form
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       David Su
 * @version      1.0
 */
public class TimeOffRequestFormPopupPM extends RequestFormPopupPM implements ContainersInRowsPM {
<span class="nc" id="L98">	private static final String CLASS_NAME = TimeOffRequestFormPopupPM.class.getName();</span>
<span class="nc" id="L99">	private static final Category LOGGER = Log.initCategory(CLASS_NAME);</span>
	private static final String DATE_CHOICE_FN = &quot;dateChoice&quot;;
	private static final String TIMEOFF_TYPE_FN = &quot;timeOffType&quot;;
	public static final String DEBIT_TYPE_FN = &quot;debitType&quot;;
	private static final String REQUESTED_FOR_FN = &quot;requestedFor&quot;;
	private static final String REQUEST_STATUS_FN = &quot;requestStatus&quot;;
	private static final String REQUEST_ADDTOWL_FN = &quot;addToWL&quot;;
	private static final String REQUEST_WL_EXPIRYDATE_FN = &quot;wlExpiryDate&quot;;
	private static final String PARTIAL_START_PICKER_FN = &quot;partialDayStart&quot;;
	private static final String PARTIAL_DURATION_FN = &quot;partialDuration&quot;;
	private static final String WAITLIST_TO_CHOICE = &quot;waitlistTOChoiceUserRank&quot;;
	private static final String WAITLIST_ELIGIBLE_TO_CHOICE = &quot;waitlistEligibleTOChoiceID&quot;;
	private static final String IS_FULLDAY_FN = &quot;isVTOFullDay&quot;;
	private static final String IS_PARTIALLDAY_FN = &quot;isVTOPartialDay&quot;;
	private static final String IS_LATESTART_FN = &quot;isVTOLateStart&quot;;
	private static final String IS_EARLYOFF_FN = &quot;isVTOEarlyOff&quot;;
	private static final String IS_ANYTIMEOFF_FN = &quot;isVTOAnytimeOff&quot;;
	private static final String RELOAD_JS = &quot;reload();&quot;;
	private static final String ATLEAST_AN_ADVANCED_VTO_TYPE_SELECTED = &quot;ATLEAST_AN_ADVANCED_VTO_TYPE_SELECTED&quot;;
	private static final int TIME_INTERVAL = 15;

	private final DateRangePickerPC m_dateRangePickerPC;
	private DatePickerPC singleDatePickerPC;
	private FormTwoColumnPC m_mainContainerPC;
	private DynamicMultiColListWithToolbarPC m_choiceListPC;
	private final TimeOffCalendarPC m_timeOffCalPC;
	private final DualListBoxPC m_dualListBoxPC;

	private final ContainerList m_containerList;
	private ID m_toCalEmpID;
<span class="nc" id="L129">	private Collection&lt;EmployeeName&gt; m_empNames = Collections.emptyList();</span>
<span class="nc" id="L130">	private Collection&lt;Activity&gt; m_timeoffTypeList = Collections.emptyList();</span>
	private TORequest m_timeoffRequest;
	protected OrganizationSetting m_orgSetting;
	private TOPool 	toPool;
<span class="nc" id="L134">	private boolean m_isAuthorized = true;</span>
<span class="nc" id="L135">	private boolean m_isRequestSaved = false;</span>
	private DatePickerPC m_wlExpiryDatePickerPC;
	private boolean m_addToWL;
<span class="nc" id="L138">	private int numberOfChoice = 0;</span>

	//From the Net Staffing Ribbon Selection
<span class="nc" id="L141">	private boolean m_isFromNetStaffingRibbon = false;</span>
	private Date m_ribbonStartDate;
	private Date m_ribbonEndDate;

<span class="nc" id="L145">	private int waitlistTOChoiceUserRank = -1;</span>
<span class="nc" id="L146">	private boolean validChoiceList = true;</span>
<span class="nc" id="L147">	private ActivityProperties activityProperty = null;</span>
	private final HtmlChoiceInput choiceInput;
<span class="nc" id="L149">	private boolean isAdvancedVTORequest = false;</span>
	private final TimePickerPC partialStartTimePC;
	private final DurationSpinnerPC partialDurationPC;
	private final boolean isAdvancedLicense;
	/**
	 * Constructor
	 */
	public TimeOffRequestFormPopupPM(RequestContext context) {
<span class="nc" id="L157">		super(context, RmKeys.RH_TIMEOFF_FORM);</span>

<span class="nc" id="L159">		isAdvancedLicense = LicenseUtil.isAdvancedRMLicense();</span>
<span class="nc" id="L160">		m_containerList = new ContainerList(this, 3);</span>
<span class="nc" id="L161">		setTimeOffRequest(new TORequest(TORequest.DL_BASIC));</span>
<span class="nc" id="L162">		initSingleDatePickerPC(); //used for Advanced VTO</span>
<span class="nc" id="L163">		m_dateRangePickerPC = initDateRangePickerPC();</span>
<span class="nc" id="L164">		addChildComponent(m_dateRangePickerPC);</span>
<span class="nc" id="L165">		initExpiryDatePickerPC();</span>

<span class="nc" id="L167">		m_timeOffCalPC = new TimeOffCalendarPC(m_context, 2, true, m_toolbar);//changed in 7.6.2 for performance</span>

<span class="nc" id="L169">		addChildComponent(m_timeOffCalPC);</span>

<span class="nc" id="L171">		m_dualListBoxPC = new DualListBoxPC(m_context);</span>
<span class="nc" id="L172">		addChildComponent(m_dualListBoxPC);</span>
<span class="nc" id="L173">		choiceInput = new HtmlChoiceInput();</span>
<span class="nc" id="L174">		partialStartTimePC = new TimePickerPC(context, PARTIAL_START_PICKER_FN, false);</span>
<span class="nc" id="L175">		addChildComponent(partialStartTimePC);</span>
<span class="nc" id="L176">		partialDurationPC = new DurationSpinnerPC(m_context, PARTIAL_DURATION_FN);</span>
<span class="nc" id="L177">		addChildComponent(partialDurationPC);</span>

<span class="nc" id="L179">		addRequiredJavaScriptFile(RmJavaScriptFileID.TIME_OFF_REQUEST_DIALOG_JS);</span>
<span class="nc" id="L180">		addJSVariable(ATLEAST_AN_ADVANCED_VTO_TYPE_SELECTED, m_bundle, RmWebBundleKey.ATLEAST_AN_ADVANCED_VTO_TYPE_SELECTED);</span>
<span class="nc" id="L181">	}</span>

	/**
	 * Return an instance of the model that is ready for rendering
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L187">		return getInstance(context, TimeOffRequestFormPopupPM.class);</span>
	}

	/**
	 * Initialize Model with Data
	 */
	@Override
	protected void initializeModel() {
<span class="nc bnc" id="L195" title="All 2 branches missed.">		if (m_isInitialized) {</span>
<span class="nc" id="L196">			return;</span>
		} else {
<span class="nc" id="L198">			m_isInitialized = true;</span>
		}
<span class="nc" id="L200">		boolean requestExists = true;</span>
		try {
<span class="nc" id="L202">			ID empID = getRequestedFor();</span>
<span class="nc" id="L203">			TimeOffRequestsMH.TODetailData toData = null;</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">			TORequest aRequest = (getRequestID() == null) ? null : getSelectedTimeOffRequest(getRequestID());</span>

			//make sure request has not been deleted
<span class="nc bnc" id="L207" title="All 4 branches missed.">			if (aRequest == null &amp;&amp; !isNew()) {</span>
<span class="nc" id="L208">				requestExists = false;</span>
<span class="nc" id="L209">				this.addPageMessage(Message.ERROR_TYPE, i18n(RmWebBundleKey.REQUEST_NOT_FOUND_ERROR));</span>
			} else {

				// if only part of page is being refreshed, use the user input object (instead of database object) to avoid loosing user input
<span class="nc bnc" id="L213" title="All 2 branches missed.">				if (&quot;REFRESH_COMPONENT_ACTION&quot;.equals(m_context.getParameter(PageAction.PAGE_ACTION))) {</span>
<span class="nc" id="L214">					aRequest = getTimeOffRequest();</span>
				}
				//For Flex time: this function is overridden
<span class="nc" id="L217">				toData = initializeModelTimeOffData(empID, aRequest);</span>

<span class="nc" id="L219">				m_timeoffTypeList = toData.getTOTypes();</span>
<span class="nc" id="L220">				m_empNames = toData.getEmployeeNames();</span>
<span class="nc" id="L221">				m_orgSetting = toData.getOrgSetting();</span>
<span class="nc" id="L222">				toPool = toData.getPool();</span>
<span class="nc" id="L223">				m_toCalEmpID = toData.getEmpID();</span>
<span class="nc" id="L224">				List&lt;ID&gt; timeOffIds = (List&lt;ID&gt;) TimeOffRequestsMH.getActivityIDsfromActivity(m_timeoffTypeList);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">				ID selectedTimeOffTypeID = isNew() ? getTimeOffType() : aRequest.getTimeOffType();</span>

				// We should have an activity for multi-pool support
<span class="nc bnc" id="L228" title="All 6 branches missed.">				if (isAdvancedLicense &amp;&amp; selectedTimeOffTypeID == null &amp;&amp; !timeOffIds.isEmpty()) {</span>
					// Grab the first one if necessary.
<span class="nc" id="L230">					selectedTimeOffTypeID = timeOffIds.get(0);</span>
				}

<span class="nc" id="L233">				m_timeOffCalPC.setShowTOPoolsToolTip(true);</span>

				try {
<span class="nc bnc" id="L236" title="All 4 branches missed.">					if (selectedTimeOffTypeID != null &amp;&amp; timeOffIds.contains(selectedTimeOffTypeID)) {</span>
<span class="nc" id="L237">						activityProperty = ActivityModelHandler.getActivityProperties(m_context, selectedTimeOffTypeID);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">					} else if (!m_timeoffTypeList.isEmpty()) {</span>
<span class="nc" id="L239">						ID defaultActivityId = m_timeoffTypeList.iterator().next().getID();</span>
<span class="nc" id="L240">						activityProperty = ActivityModelHandler.getActivityProperties(m_context, defaultActivityId);</span>
					}

<span class="nc" id="L243">				} catch (Exception ex) {</span>
<span class="nc" id="L244">					log.l7dError(&quot;failed to fetch activity by id&quot;, ex);</span>
<span class="nc" id="L245">				}</span>

<span class="nc bnc" id="L247" title="All 4 branches missed.">				isAdvancedVTORequest = activityProperty != null ? activityProperty.isUseAdvancedVTOOptions()</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">						&amp;&amp; LicenseUtil.isAdvancedRMLicense() : false;</span>
				//set the date picker start dates
<span class="nc bnc" id="L250" title="All 2 branches missed.">				if (m_orgSetting != null) {</span>
<span class="nc" id="L251">					Organization org = OrganizationModelHandler.getOrganization(m_context, new ID(m_orgSetting.getCurrentOrgId()));</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">					if(isAdvancedVTORequest){</span>
<span class="nc" id="L253">						setSingleDatePickerWeekStarts(org);</span>
					} else {
<span class="nc" id="L255">						setDateRangePickerWeekStarts(org);</span>
					}
				}

				// Populate Time Off Calendar PC
<span class="nc" id="L260">				m_timeOffCalPC.setOrgSetting(m_orgSetting);</span>

<span class="nc bnc" id="L262" title="All 2 branches missed.">				if (m_toCalEmpID != null) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">					ID timeoffPoolID =  toPool==null? null : toPool.getID();</span>

					//JT. AdvancedRM needs activity
<span class="nc bnc" id="L266" title="All 2 branches missed.">					if(isAdvancedLicense){</span>
<span class="nc" id="L267">						m_timeOffCalPC.fetchData(m_toCalEmpID, false, timeoffPoolID, selectedTimeOffTypeID);</span>
					} else {
<span class="nc" id="L269">						m_timeOffCalPC.fetchData(m_toCalEmpID, false, timeoffPoolID, null);</span>
					}
				}

<span class="nc bnc" id="L273" title="All 2 branches missed.">				if (!isNew()) {</span>
<span class="nc" id="L274">					TORequest request = toData.getTORequest();</span>
<span class="nc" id="L275">					m_isAuthorized = RequestUtil.isAuthToUpdate(m_context, request);</span>

					// Try to keep extracted value in case of error
<span class="nc bnc" id="L278" title="All 2 branches missed.">					if (hasError()) {</span>
<span class="nc" id="L279">						m_timeoffRequest.setAuditTrailList(request.getAuditTrail());</span>
					} else {
<span class="nc" id="L281">						setTimeOffRequest(request);</span>
					}

<span class="nc bnc" id="L284" title="All 2 branches missed.">					if (waitlistTOChoiceUserRank == -1) {</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">						waitlistTOChoiceUserRank = m_timeoffRequest.getWaitlistTOChoice() != null ? m_timeoffRequest.getWaitlistTOChoice()</span>
<span class="nc" id="L286">								.getUserRank() : -1;</span>
					}
				}
			}
<span class="nc" id="L290">		} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L291">			Message msg = handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L292">			msg.setAssociatedMessage(ex.getLocalizedMessage(m_localizer, m_context.getViewingTimeZone()));</span>
<span class="nc" id="L293">		} catch (Exception ex) {</span>
<span class="nc" id="L294">			handleUnableToLoadDataError(log, ex);</span>
		} finally {
<span class="nc" id="L296">			initContentTitle();</span>
<span class="nc bnc" id="L297" title="All 8 branches missed.">			if (requestExists) {</span>
<span class="nc" id="L298">				initContent();</span>
			} else {
<span class="nc" id="L300">				initToolbar(false);</span>
			}
<span class="nc" id="L302">			initPageMessages();</span>
<span class="nc" id="L303">		}</span>
<span class="nc" id="L304">	}</span>

	protected TimeOffRequestsMH.TODetailData initializeModelTimeOffData(ID empID, TORequest aRequest) throws RemoteException, BbmException,
			FacadeException, RmHardValidationException, Exception {
		TimeOffRequestsMH.TODetailData toData;
<span class="nc bnc" id="L309" title="All 2 branches missed.">		if (isManagerMode()) {</span>
<span class="nc" id="L310">			toData = TimeOffRequestsMH.getTODetailDataForManager(m_context, m_context.getUser(), empID, isNew(), aRequest,</span>
					m_isFromNetStaffingRibbon);
		} else {
<span class="nc" id="L313">			toData = TimeOffRequestsMH.getTODetailData(m_context, empID, aRequest, m_isFromNetStaffingRibbon);</span>
		}
<span class="nc" id="L315">		return toData;</span>
	}

	protected void initPageMessages() {
<span class="nc" id="L319">		int timeInterval = getTimeOffRoundInterval();</span>
<span class="nc" id="L320">		String timeOffRoundedMsg = TimeOffRequestUtil.getRoundedMsg(m_localizer, timeInterval);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">		if (!m_timeoffTypeList.isEmpty()) {</span>
<span class="nc" id="L322">			addPageMessage(Message.INFO_TYPE, timeOffRoundedMsg);</span>
		}
<span class="nc" id="L324">	}</span>

	/**
	 * Create and add Date Range Picker as Child Component
	 */
	protected DateRangePickerPC initDateRangePickerPC() {
<span class="nc" id="L330">		DateRangePickerPC dateRangePickerPC = new DateRangePickerPC(m_context, DATE_CHOICE_FN);</span>
<span class="nc" id="L331">		dateRangePickerPC.setIsTimeEnabled(true);</span>

		// initialize date pickers properties
<span class="nc" id="L334">		DatePickerPC startDatePC = dateRangePickerPC.getStartDatePickerPC();</span>
<span class="nc" id="L335">		DatePickerPC endDatePC = dateRangePickerPC.getEndDatePickerPC();</span>
<span class="nc" id="L336">		startDatePC.setIsDateValueOptional(true);</span>
<span class="nc" id="L337">		endDatePC.setIsDateValueOptional(true);</span>

		//set upper date limit to 12/31/2078
<span class="nc" id="L340">		Calendar cal = Calendar.getInstance(m_context.getViewingTimeZone());</span>
<span class="nc" id="L341">		cal.set(2078, 11, 31, 23, 59, 59);</span>
<span class="nc" id="L342">		endDatePC.setUpperLimit(cal.getTime());</span>
<span class="nc" id="L343">		return dateRangePickerPC;</span>
	}
	/**
	 * used for Advanced VTO Requests
	 * */
	protected void initSingleDatePickerPC(){
<span class="nc" id="L349">		singleDatePickerPC = new DatePickerPC(m_context, DATE_CHOICE_FN);</span>
<span class="nc" id="L350">		singleDatePickerPC.setIsTimeEnabled(false);</span>
		// For leaving the input date is empty, we setIsDateValueOptional= true
<span class="nc" id="L352">		singleDatePickerPC.setIsDateValueOptional(true);</span>
		//set upper date limit to 12/31/2099
<span class="nc" id="L354">		Calendar cal = Calendar.getInstance(m_context.getViewingTimeZone());</span>
<span class="nc" id="L355">		cal.setTime(new Date());</span>
<span class="nc" id="L356">		singleDatePickerPC.setDefaultDisplayDate(cal.getTime(), m_context.getViewingTimeZone());</span>
<span class="nc" id="L357">		cal.set(2099, 11, 31, 23, 59, 59);</span>
<span class="nc" id="L358">		singleDatePickerPC.setUpperLimit(cal.getTime());</span>
<span class="nc" id="L359">		addChildComponent(singleDatePickerPC);</span>
<span class="nc" id="L360">	}</span>
	private void setSingleDatePickerWeekStarts(Organization org) throws Exception {
<span class="nc" id="L362">		singleDatePickerPC.setFirstDayOfWeek(org.getWeekStartDay().getCalendarConstant());</span>

<span class="nc" id="L364">	}</span>
	/**
	 * Init waitlist date picker
	 */
	private void initExpiryDatePickerPC() {
<span class="nc" id="L369">		m_wlExpiryDatePickerPC = new DatePickerPC(m_context, REQUEST_WL_EXPIRYDATE_FN);</span>
<span class="nc" id="L370">		m_wlExpiryDatePickerPC.setLowerLimit(new Date());</span>
<span class="nc" id="L371">		m_wlExpiryDatePickerPC.setIsDateValueOptional(true);</span>
<span class="nc" id="L372">		m_wlExpiryDatePickerPC.setIsTimeEnabled(true);</span>
<span class="nc" id="L373">		addChildComponent(m_wlExpiryDatePickerPC);</span>
<span class="nc" id="L374">	}</span>

	/**
	 * Set first day of week using org week start
	 */
	private void setDateRangePickerWeekStarts(Organization org) throws Exception {
<span class="nc" id="L380">		m_dateRangePickerPC.setFirstDayOfWeek(org.getWeekStartDay().getCalendarConstant());</span>
<span class="nc" id="L381">		m_wlExpiryDatePickerPC.setFirstDayOfWeek(org.getWeekStartDay().getCalendarConstant());</span>

		//set the default time to use organization day boundary
<span class="nc" id="L384">		int dayBoundaryOffset = org.getDayBoundaryOffset();</span>
<span class="nc" id="L385">		Calendar startCal = Calendar.getInstance(m_view_tz);</span>
<span class="nc" id="L386">		startCal.setTime(new Date());</span>
<span class="nc" id="L387">		startCal.set(Calendar.HOUR_OF_DAY, dayBoundaryOffset / 60);</span>
<span class="nc" id="L388">		startCal.set(Calendar.MINUTE, dayBoundaryOffset % 60);</span>

<span class="nc bnc" id="L390" title="All 2 branches missed.">		if (startCal.getTime().before(new Date())) {</span>
<span class="nc" id="L391">			startCal.add(Calendar.DATE, 1);</span>
		}

<span class="nc" id="L394">		Calendar endCal = Calendar.getInstance(m_view_tz);</span>
<span class="nc" id="L395">		endCal.setTime(startCal.getTime());</span>

<span class="nc" id="L397">		endCal.add(Calendar.DATE, 1);</span>
<span class="nc" id="L398">		endCal.set(Calendar.MINUTE, dayBoundaryOffset % 60 - 1);</span>
<span class="nc" id="L399">		m_dateRangePickerPC.getStartDatePickerPC().setDefaultDisplayDate(startCal.getTime(), m_view_tz);</span>
<span class="nc" id="L400">		m_dateRangePickerPC.getEndDatePickerPC().setDefaultDisplayDate(endCal.getTime(), m_view_tz);</span>
<span class="nc" id="L401">		m_wlExpiryDatePickerPC.setDefaultDisplayDate(startCal.getTime(), m_view_tz);</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">		if (m_wlExpiryDatePickerPC.getDate() == null) {</span>
<span class="nc" id="L403">			m_wlExpiryDatePickerPC.setDate(startCal.getTime());</span>
		}
<span class="nc" id="L405">	}</span>

	/**
	 * Disable Date Range Picker to Read Only
	 */
	private void disableDateRangePickerPC() {
<span class="nc" id="L411">		m_dateRangePickerPC.setIsPickerEnabled(false);</span>
<span class="nc" id="L412">		m_dateRangePickerPC.getStartDatePickerPC().setInputType(DatePickerPC.INPUT_TYPE_READONLY);</span>
<span class="nc" id="L413">		m_dateRangePickerPC.getEndDatePickerPC().setInputType(DatePickerPC.INPUT_TYPE_READONLY);</span>
<span class="nc" id="L414">	}</span>

	/**
	 * Disable Date Picker to Read Only
	 */
	private void disableSingleDatePickerPC() {
<span class="nc" id="L420">		singleDatePickerPC.setIsPickerEnabled(false);</span>
<span class="nc" id="L421">		singleDatePickerPC.setInputType(DatePickerPC.INPUT_TYPE_READONLY);</span>
<span class="nc" id="L422">	}</span>

	/**
	 * Create Debit Drop Down Option
	 */
	private OptionData createDebitOption(String debitType) {
<span class="nc" id="L428">		String value = i18n(TimeOffRequestUtil.getDebitTypeRBKey(debitType));</span>
<span class="nc" id="L429">		boolean isSelected = debitType.equals(getDebitType());</span>
<span class="nc" id="L430">		return new OptionData(value, debitType, isSelected);</span>
	}

	/**
	 * Prepare content title for rendering
	 */
	protected void initContentTitle() {
<span class="nc bnc" id="L437" title="All 2 branches missed.">		String rbKey = isNew() ? RmWebBundleKey.CREATE_NEW_REQUEST : RmWebBundleKey.EDIT_REQUEST;</span>
<span class="nc" id="L438">		String pageTitle = i18n(rbKey);</span>

<span class="nc" id="L440">		String itemName = i18n(RmWebBundleKey.REQUEST_TYPE_TIME_OFF);</span>
<span class="nc" id="L441">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="nc" id="L442">		m_contentTitlePC.setItemName(itemName);</span>
<span class="nc" id="L443">	}</span>

	/**
	 * Initialize Content
	 */
	private void initContent() {
<span class="nc bnc" id="L449" title="All 4 branches missed.">		if (isManagerMode() &amp;&amp; m_empNames.isEmpty()) {</span>

<span class="nc" id="L451">			String[] args = new String[1];</span>
<span class="nc" id="L452">			args[0] = m_context.getSystemManagerFactory().getVerticalizationManager()</span>
<span class="nc" id="L453">					.getVerticalizedString(m_context, DefaultVerticalizationManager.WORKERS);</span>

<span class="nc" id="L455">			addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.WARNING_NO_PRIV_FOR_TOREQ_CREATION, RmWebBundleKey.BUNDLE_NAME, args);</span>
<span class="nc" id="L456">			initToolbar(false);</span>
<span class="nc" id="L457">		} else {</span>
<span class="nc" id="L458">			addMsgIfNoTOTypes();</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">			if (m_isAuthorized) {</span>
<span class="nc" id="L460">				initMainList();</span>
<span class="nc" id="L461">				initChoiceList();</span>
<span class="nc" id="L462">				initTimeOffCalendars();</span>
<span class="nc" id="L463">				initAdditionalContent();</span>
<span class="nc" id="L464">				addAccrualCalculatorToolBtn(m_toCalEmpID);</span>
<span class="nc" id="L465">				initToolbar(true);</span>
			} else {
<span class="nc" id="L467">				initToolbar(false);</span>
			}
		}

<span class="nc bnc" id="L471" title="All 2 branches missed.">		if (m_isRequestSaved) {</span>
<span class="nc" id="L472">			RequestUtil.addSavedRequestMsg(m_timeoffRequest, this);</span>
		}
<span class="nc" id="L474">	}</span>

	protected void addMsgIfNoTOTypes() {
<span class="nc bnc" id="L477" title="All 4 branches missed.">		if (isNew() &amp;&amp; m_timeoffTypeList.isEmpty()) {</span>
<span class="nc" id="L478">			addPageMessageNoActivities();</span>
		}
<span class="nc" id="L480">	}</span>

	protected void addPageMessageNoActivities() {
<span class="nc" id="L483">		addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.WARNING_NO_TO_ACTIVITIES, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L484">	}</span>

	protected void initAdditionalContent() {
<span class="nc" id="L487">	}</span>

	private void addAccrualCalculatorToolBtn(ID empID) {
<span class="nc bnc" id="L490" title="All 2 branches missed.">		boolean enabled = empID != null;</span>
<span class="nc" id="L491">		final String cmd = &quot;CALCULATE_TO_&quot; + empID;</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">		addPopupArgs(cmd, &quot;to_accrual_calculator&quot;, &quot;empID=&quot; + empID +&quot;&amp;isAgentPage=&quot; +(!isManagerMode()), null, &quot;480,360,ctr,ctr&quot;, true, 1);</span>
<span class="nc" id="L493">		m_toolbar.addPopupWindowTextButton(cmd, i18n(RmWebBundleKey.TIMEOFF_CALCULATE_ESTIMATE), enabled);</span>
<span class="nc" id="L494">	}</span>

	/**
	 * Return Employee Name Drop Down
	 */
	private String createEmpNameDD() {
<span class="nc bnc" id="L500" title="All 2 branches missed.">		if (m_empNames.isEmpty()) {</span>
<span class="nc" id="L501">			return &quot;&quot;;</span>
		}
<span class="nc" id="L503">		ID selectedID = getRequestedFor();</span>

		// If there is only a single employee name or request has Escalated Status
		// then just return it as text
<span class="nc bnc" id="L507" title="All 4 branches missed.">		if (m_empNames.size() == 1 || isEscalatedRequest()) {</span>
<span class="nc" id="L508">			EmployeeName eName = findEmpNameByID(selectedID);</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">			return (isAccessibilityComplianceMode() ? HtmlUtil.createLabel(m_localizer.formatName(eName), null)</span>
<span class="nc" id="L510">					: m_localizer.formatName(eName)) +</span>
<span class="nc" id="L511">					HtmlUtil.makeHiddenInput(REQUESTED_FOR_FN, eName.getID().toString());</span>
		}

		// Create Employee Name Drop Down
<span class="nc" id="L515">		List sortedENames = new ArrayList(m_empNames);</span>
<span class="nc" id="L516">		PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>
<span class="nc" id="L517">		int listSize = sortedENames.size();</span>
<span class="nc" id="L518">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">		for (Iterator it = sortedENames.iterator(); it.hasNext();) {</span>
<span class="nc" id="L520">			EmployeeName eName = (EmployeeName) it.next();</span>
<span class="nc" id="L521">			String id = eName.getID().toString();</span>
<span class="nc" id="L522">			String display = m_localizer.formatName(eName);</span>
<span class="nc" id="L523">			StringsPair option = new StringsPair(id, display);</span>
<span class="nc" id="L524">			options.add(option);</span>
<span class="nc" id="L525">		}</span>

<span class="nc bnc" id="L527" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot; : selectedID.toString();</span>
<span class="nc" id="L528">		return HtmlUtil.makeSelectInput(</span>
			REQUESTED_FOR_FN, 
			selectedValue,
			&quot;jQuery(document).trigger('requestedForUpdatedEvent');reload();&quot; + AccessibilityComplianceKeys.REFRESH_PAGE_ONCHANGE_INDICATOR,
				options, 
			false);
	}

	private Activity getActivityForTimeOffType() {
<span class="nc" id="L537">		Activity activity = null;</span>
<span class="nc" id="L538">		ID selectedID = getTimeOffType();</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">		for (Iterator&lt;Activity&gt; it = m_timeoffTypeList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L540">			Activity tmpActivity = it.next();</span>
			// Keep track of First One
<span class="nc bnc" id="L542" title="All 2 branches missed.">			if (activity == null) {</span>
<span class="nc" id="L543">				activity = tmpActivity;</span>
			}

<span class="nc bnc" id="L546" title="All 2 branches missed.">			if (tmpActivity.getID().equals(selectedID)) {</span>
<span class="nc" id="L547">				activity = tmpActivity;</span>
<span class="nc" id="L548">				break;</span>
			}
<span class="nc" id="L550">		}</span>
<span class="nc" id="L551">		return activity;</span>
	}

	/**
	 * Create Time Off Type Display
	 */
	private String createTimeOffTypeDsp() {
<span class="nc bnc" id="L558" title="All 2 branches missed.">		if (m_timeoffTypeList.isEmpty()) {</span>
<span class="nc" id="L559">			return &quot;&quot;;</span>
		}
<span class="nc" id="L561">		Activity activity = getActivityForTimeOffType();</span>

<span class="nc" id="L563">		return activity.getName() + HtmlUtil.makeHiddenInput(TIMEOFF_TYPE_FN, activity.getID().toString());</span>
	}

	/**
	 * Return Time Off Type Drop Down
	 */
	private String createTimeOffTypeDD() {
		// If Request has Escalated Status then just return it as text
<span class="nc bnc" id="L571" title="All 2 branches missed.">		if (isEscalatedRequest()) {</span>
<span class="nc" id="L572">			return createTimeOffTypeDsp();</span>
		}
<span class="nc" id="L574">		m_dualListBoxPC.setPrimaryOnChange(m_dualListBoxPC.getPrimaryOnChange() + AccessibilityComplianceKeys.REFRESH_PAGE_ONCHANGE_INDICATOR);</span>
<span class="nc" id="L575">		return m_dualListBoxPC.getPrimaryListBox();</span>
	}

	/**
	 * Return Time Off Debit Type Drop Down
	 */
	protected String createDebitTypeDD() {
		// If Request has Escalated Status then just return it as text
<span class="nc bnc" id="L583" title="All 2 branches missed.">		if (isEscalatedRequest()) {</span>
<span class="nc" id="L584">			String debitType = getDebitType();</span>
<span class="nc" id="L585">			return i18n(TimeOffRequestUtil.getDebitTypeRBKey(debitType)) + HtmlUtil.makeHiddenInput(DEBIT_TYPE_FN, debitType);</span>
		}

<span class="nc" id="L588">		return m_dualListBoxPC.getSecondaryListBox();</span>
	}

	/**
	 * Create Comment History Page Component
	 */
	private MessagePC createCommentHistoryPC() {
<span class="nc" id="L595">		MessagePC msgPC = RequestUtil.createCmntMsgPC(m_context, &quot;510px&quot;, &quot;50px&quot;, &quot;&quot;);</span>
<span class="nc" id="L596">		Collection msgs = RequestUtil.getCommentsAsMessages(m_timeoffRequest);</span>
<span class="nc" id="L597">		msgPC.addMessage(msgs);</span>
<span class="nc" id="L598">		return msgPC;</span>
	}

	/**
	 * Initializes Dual List Box PC
	 */
	private void initDualListBoxPC() {
<span class="nc bnc" id="L605" title="All 2 branches missed.">		if (m_timeoffTypeList.isEmpty()) {</span>
<span class="nc" id="L606">			return;</span>
		}

		// Create Debit Types for Time Off
<span class="nc" id="L610">		List timeoffDebitTypes = new ArrayList(2);</span>
		//get the config setting for the request type allowed option
<span class="nc" id="L612">		int reqTypeAllowedVal = 2;</span>
		try {
<span class="nc" id="L614">			reqTypeAllowedVal = BbmManagerFactory.getDBConfigManager().getIntValue(ConfigKey.TIMEOFF_REQUEST_TYPES_ALLOWED);</span>
<span class="nc" id="L615">		} catch (Exception ex) {</span>
<span class="nc" id="L616">			log.l7dError(&quot;failed to fetch time off request option value from BPCONFIG&quot;, ex);</span>
<span class="nc" id="L617">		}</span>
		// Process Time Off Types
<span class="nc" id="L619">		ID selectedID = getTimeOffType();</span>

<span class="nc bnc" id="L621" title="All 4 branches missed.">		boolean showDebit = reqTypeAllowedVal == 1 &amp;&amp; m_timeoffRequest.getTimeOffDebitType().equals(TORequest.DEBITTYPE_DEBIT);</span>
<span class="nc bnc" id="L622" title="All 4 branches missed.">		boolean showDebitIf = reqTypeAllowedVal == 0 &amp;&amp; m_timeoffRequest.getTimeOffDebitType().equals(TORequest.DEBITTYPE_DEBIT_ONLY_IF);</span>
<span class="nc bnc" id="L623" title="All 6 branches missed.">		if (reqTypeAllowedVal == 2 || reqTypeAllowedVal == 0 || showDebit) {</span>
<span class="nc" id="L624">			timeoffDebitTypes.add(createDebitOption(TORequest.DEBITTYPE_DEBIT));</span>
		}
<span class="nc bnc" id="L626" title="All 8 branches missed.">		if ((reqTypeAllowedVal == 2 || reqTypeAllowedVal == 1 || showDebitIf) &amp;&amp; !isAdvancedVTORequest) {</span>
<span class="nc" id="L627">			timeoffDebitTypes.add(createDebitOption(TORequest.DEBITTYPE_DEBIT_ONLY_IF));</span>
		}

		//add appropriate page message
<span class="nc bnc" id="L631" title="All 2 branches missed.">		if (reqTypeAllowedVal != 2) {</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">			if (showDebit) {</span>
<span class="nc" id="L633">				addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.TIMEOFF_REQ_TYPE_DEBIT_IF, RmWebBundleKey.BUNDLE_NAME);</span>
			}
<span class="nc bnc" id="L635" title="All 2 branches missed.">			if (showDebitIf) {</span>
<span class="nc" id="L636">				addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.TIMEOFF_REQ_TYPE_DEBIT, RmWebBundleKey.BUNDLE_NAME);</span>
			}
		}
		// Create Debit Types for Unavailability
<span class="nc" id="L640">		List unavailDebitTypes = new ArrayList(2);</span>
<span class="nc" id="L641">		unavailDebitTypes.add(createDebitOption(TORequest.DEBITTYPE_DONT_DEBIT));</span>

<span class="nc" id="L643">		int size = m_timeoffTypeList.size();</span>
<span class="nc" id="L644">		List pOptionList = new ArrayList(size);</span>
<span class="nc" id="L645">		Map sOptionMap = new HashMap(size);</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">		for (Iterator it = m_timeoffTypeList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L647">			Activity activity = (Activity) it.next();</span>
<span class="nc" id="L648">			ID id = activity.getID();</span>
<span class="nc" id="L649">			OptionData od = new OptionData(activity.getName(), id.toString());</span>
<span class="nc" id="L650">			od.setSelected(id.equals(selectedID));</span>
<span class="nc" id="L651">			pOptionList.add(od);</span>

			// Process Debit Type Map
<span class="nc" id="L654">			List sOptionList = new ArrayList(3);</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">			if (activity.isTimeoff()) {</span>
<span class="nc" id="L656">				sOptionList.addAll(timeoffDebitTypes);</span>
			}
<span class="nc bnc" id="L658" title="All 2 branches missed.">			if (activity.isUnavailability()) {</span>
<span class="nc" id="L659">				sOptionList.addAll(unavailDebitTypes);</span>
			}
<span class="nc" id="L661">			sOptionMap.put(od, sOptionList);</span>
<span class="nc" id="L662">		}</span>

<span class="nc" id="L664">		m_dualListBoxPC.setPrimaryListName(TIMEOFF_TYPE_FN);</span>
<span class="nc" id="L665">		m_dualListBoxPC.setSecondaryListName(DEBIT_TYPE_FN);</span>

<span class="nc" id="L667">		m_dualListBoxPC.setPrimaryOnChange(JSUtil.ON_CHANGE + RELOAD_JS);</span>
<span class="nc" id="L668">		m_dualListBoxPC.setSecondaryOnChange(JSUtil.ON_CHANGE);</span>
<span class="nc bnc" id="L669" title="All 4 branches missed.">		m_dualListBoxPC.setIsPrimaryEnabled(!(!isNew() &amp;&amp; LicenseUtil.isAdvancedRMLicense()));</span>
<span class="nc" id="L670">		m_dualListBoxPC.setOptionValue(pOptionList, sOptionMap);</span>
<span class="nc" id="L671">	}</span>

	/**
	 * Initialize Main List
	 */
	private void initMainList() {
<span class="nc" id="L677">		m_mainContainerPC = new FormTwoColumnPC(m_context);</span>
<span class="nc" id="L678">		m_mainContainerPC.setTitle(i18n(RmWebBundleKey.REQUEST_SUMMARY));</span>
<span class="nc" id="L679">		m_mainContainerPC.setSummary(i18n(RmWebBundleKey.TO_REQUEST_POPUP_MAIN_TABLE_SUMMARY));</span>
//		workaround to prevent jaws from reading table row twice
<span class="nc" id="L681">		m_mainContainerPC.setAditionalDescription(HtmlUtil.NBSP);</span>
<span class="nc" id="L682">		m_containerList.add(m_mainContainerPC);</span>

<span class="nc" id="L684">		m_mainContainerPC.setWrapperCSSClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>
<span class="nc" id="L685">		m_mainContainerPC.setLastRowType(FormTwoColumnPC.LAST_ROW_FULL);</span>

<span class="nc bnc" id="L687" title="All 2 branches missed.">		if(isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L688">			m_mainContainerPC.setWrapperRegion(true);</span>
<span class="nc" id="L689">			m_mainContainerPC.setPCTitleSpan(i18n(m_bundle, RmWebBundleKey.REQUEST_SUMMARY));</span>
		}
<span class="nc" id="L691">		initMainListRowEmployeeName();</span>

		// Time Off Type and Time Off Hours Drop Downs
<span class="nc" id="L694">		initMainListTimeOffTypeAndTimeOffHours();</span>

<span class="nc" id="L696">		boolean isShowWaitlistRow = initMainListRowAddToWaitlist();</span>

<span class="nc" id="L698">		initMainListRowCommentHistory();</span>

<span class="nc" id="L700">		initMainListRowAddComment();</span>

<span class="nc bnc" id="L702" title="All 4 branches missed.">		if (!isShowWaitlistRow &amp;&amp; isAccessibilityMode()) {</span>
			//Fix for QC#00000: JAWS Tables dialog doesn't recognize this table unless it has 4 or more rows! Add a dummy row.
<span class="nc" id="L704">			m_mainContainerPC.addRow(&quot;&quot;, &quot;&quot;);</span>
		}

<span class="nc" id="L707">	}</span>

	/**
	 * Determine whether the logged-in user has the &quot;Use Accessiblity Compliance Mode&quot; preference set to true.
	 * @return the &quot;Use Accessiblity Compliance Mode&quot; preference.
	 */
	public boolean isAccessibilityMode() {
<span class="nc" id="L714">		UserProfile userProfile = (UserProfile) m_context.getAttribute(RequestContext.SESSION_SCOPE, &quot;UserProfile&quot;);</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">		if (userProfile == null) {</span>
<span class="nc" id="L716">			return false;</span>
		}

<span class="nc" id="L719">		String strVal = userProfile.loadProperty(UserPreferenceKeys.USER_ACCESSIBILITY_COMPLIANCE_MODE, &quot;false&quot;);</span>
<span class="nc" id="L720">		Boolean boolFlag = new Boolean(&quot;true&quot;.equals(strVal));</span>
<span class="nc" id="L721">		return boolFlag.booleanValue();</span>
	}

	protected void initMainListRowAddComment() {
<span class="nc" id="L725">		String commentUI = RequestUtil.createCommentUI(COMMENT_FN, getComment(), 100, 3, this,</span>
<span class="nc" id="L726">				i18n(m_common_bundle, UIFWebBundleKey.ADD_COMMENT));</span>
<span class="nc" id="L727">		m_mainContainerPC.addRow(i18n(m_common_bundle, UIFWebBundleKey.ADD_COMMENT), commentUI);</span>
<span class="nc" id="L728">	}</span>

	protected void initMainListRowCommentHistory() {
<span class="nc bnc" id="L731" title="All 2 branches missed.">		if (!isNew()) {</span>
<span class="nc" id="L732">			MessagePC commentHistoryPC = createCommentHistoryPC();</span>
<span class="nc" id="L733">			String label = i18n(m_common_bundle, UIFWebBundleKey.COMMENT_HISTORY);</span>
			
<span class="nc bnc" id="L735" title="All 2 branches missed.">			if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L736">				commentHistoryPC.setWrapperRegion(true);</span>
<span class="nc" id="L737">				commentHistoryPC.setAccessibilityDesc(label);</span>
<span class="nc" id="L738">				m_mainContainerPC.addRow(label, commentHistoryPC.toString());</span>
			} else {
<span class="nc" id="L740">				m_mainContainerPC.addRow(label, commentHistoryPC);</span>
			}
			
		}
<span class="nc" id="L744">	}</span>

	protected boolean initMainListRowAddToWaitlist() {
		//add the option to add to waitlist if applicable
<span class="nc bnc" id="L748" title="All 2 branches missed.">		boolean isShowWaitlistRow = !isAdvancedVTORequest</span>
<span class="nc bnc" id="L749" title="All 6 branches missed.">				&amp;&amp; (TORequestUtil.isTOWaitlistFeatureEnabled() &amp;&amp; isAuthToWaitlist() &amp;&amp; isWaitlistEnabledForPool());</span>

<span class="nc bnc" id="L751" title="All 2 branches missed.">		if (isShowWaitlistRow) {</span>
<span class="nc" id="L752">			String checkboxLabel = i18n(RmWebBundleKey.TIMEOFF_ADD_TO_WL);</span>
<span class="nc" id="L753">			createAndAddWaitListRow(checkboxLabel);</span>
		}
<span class="nc" id="L755">		return isShowWaitlistRow;</span>
	}

	protected void initMainListRowEmployeeName() {
<span class="nc bnc" id="L759" title="All 2 branches missed.">		if (isManagerMode()) {</span>
<span class="nc" id="L760">			String empNameLabel = HtmlUtil.createLabel(i18n(RmWebBundleKey.EMPLOYEE_NAME_LABEL), REQUESTED_FOR_FN);</span>
<span class="nc bnc" id="L761" title="All 6 branches missed.">			if(isAccessibilityComplianceMode() &amp;&amp; isEscalatedRequest() || m_empNames.size() == 1) {</span>
<span class="nc" id="L762">				m_mainContainerPC.addAriaLabelsRow(empNameLabel, createEmpNameDD());</span>
			} else {
<span class="nc" id="L764">				m_mainContainerPC.addRow(empNameLabel, createEmpNameDD());</span>
			}

		}
<span class="nc" id="L768">	}</span>

	private void initMainListTimeOffTypeAndTimeOffHours() {
<span class="nc" id="L771">		initDualListBoxPC();</span>

<span class="nc" id="L773">		String timeOffTypeLabel = HtmlUtil.createLabel(i18n(RmWebBundleKey.TIMEOFF_TYPE_LABEL), TIMEOFF_TYPE_FN);</span>
<span class="nc bnc" id="L774" title="All 6 branches missed.">		if(isAccessibilityComplianceMode() &amp;&amp; isEscalatedRequest() || !m_dualListBoxPC.isPrimaryEnabled()) {</span>
<span class="nc" id="L775">			m_mainContainerPC.addAriaLabelsRow(timeOffTypeLabel, createTimeOffTypeDD());</span>
		} else {
<span class="nc" id="L777">			m_mainContainerPC.addRow(timeOffTypeLabel, createTimeOffTypeDD());</span>
		}

<span class="nc bnc" id="L780" title="All 2 branches missed.">		if (LicenseUtil.isAdvancedRMLicense()) {</span>
<span class="nc" id="L781">			createAnyTimeOptionsRow();</span>
		}
<span class="nc" id="L783">		initMainListTimeOffHours();</span>
<span class="nc" id="L784">	}</span>

	private String createAnyTimeOptionsRow() {
<span class="nc" id="L787">		StringBuilder sb = new StringBuilder(100);</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">		if (isAdvancedVTORequest) {</span>
<span class="nc" id="L789">			String vtoLabel = i18n(RmWebBundleKey.ADVANCED_VTO_OPTIONS);</span>
<span class="nc" id="L790">			m_mainContainerPC.addRow(vtoLabel, getFullDayRow(String.format(&quot;%s %s&quot;, vtoLabel, i18n(RmWebBundleKey.TIMEOFF_FULLDAY))));</span>
<span class="nc" id="L791">			m_mainContainerPC.addRow(&quot;&quot;, getPartialDayRow(i18n(RmWebBundleKey.TIMEOFF_PARTIALDAY)));</span>
<span class="nc" id="L792">			m_mainContainerPC.addRow(&quot;&quot;, getLateStartRow(i18n(RmWebBundleKey.TIMEOFF_LATESTART)));</span>
<span class="nc" id="L793">			m_mainContainerPC.addRow(&quot;&quot;, getEarlyOffRow(i18n(RmWebBundleKey.TIMEOFF_EARLYOFF)));</span>
<span class="nc" id="L794">			m_mainContainerPC.addRow(&quot;&quot;, getAnyTimeOffRow(i18n(RmWebBundleKey.TIMEOFF_ANYTIMEOFF)));</span>
		}
<span class="nc" id="L796">		return sb.toString();</span>
	}

	private String getFullDayRow(String ariaLabel) {
<span class="nc" id="L800">		String rowLabel = i18n(RmWebBundleKey.TIMEOFF_FULLDAY);</span>
<span class="nc" id="L801">		String jsString = JSUtil.ON_CHANGE;</span>
<span class="nc" id="L802">		boolean isSelectedChoice = getIsVTOFullDay();</span>
<span class="nc" id="L803">		initChoiceInput(IS_FULLDAY_FN, isNew(), isSelectedChoice, jsString, ariaLabel);</span>
<span class="nc" id="L804">		return choiceInput + rowLabel;</span>
	}

	private String getPartialDayRow(String ariaLabel) {
<span class="nc" id="L808">		String rowLabel = i18n(RmWebBundleKey.TIMEOFF_PARTIALDAY);</span>
<span class="nc" id="L809">		String jsString = JSUtil.ON_CHANGE + RELOAD_JS + AccessibilityComplianceKeys.REFRESH_PAGE_ONCHANGE_INDICATOR;</span>
<span class="nc" id="L810">		boolean isSelectedChoice = getIsVTOPartialDay();</span>
<span class="nc" id="L811">		initChoiceInput(IS_PARTIALLDAY_FN, isNew(), isSelectedChoice, jsString, ariaLabel);</span>
<span class="nc" id="L812">		return choiceInput + rowLabel;</span>
	}

	private String getLateStartRow(String ariaLabel) {
<span class="nc" id="L816">		String rowLabel = i18n(RmWebBundleKey.TIMEOFF_LATESTART);</span>
<span class="nc" id="L817">		String jsString = JSUtil.ON_CHANGE;</span>
<span class="nc" id="L818">		boolean isSelectedChoice = getIsVTOLateStart();</span>
<span class="nc" id="L819">		initChoiceInput(IS_LATESTART_FN, isNew(), isSelectedChoice, jsString, ariaLabel);</span>
<span class="nc" id="L820">		return choiceInput + rowLabel;</span>
	}

	private String getEarlyOffRow(String ariaLabel) {
<span class="nc" id="L824">		String rowLabel = i18n(RmWebBundleKey.TIMEOFF_EARLYOFF);</span>
<span class="nc" id="L825">		boolean isSelectedChoice = getIsVTOEarlyOff();</span>
<span class="nc" id="L826">		String jsString = JSUtil.ON_CHANGE;</span>
<span class="nc" id="L827">		initChoiceInput(IS_EARLYOFF_FN, isNew(), isSelectedChoice, jsString, ariaLabel);</span>
<span class="nc" id="L828">		return choiceInput.getHtmlDisplay() + rowLabel;</span>
	}

	private String getAnyTimeOffRow(String ariaLabel) {
<span class="nc" id="L832">		String rowLabel = i18n(RmWebBundleKey.TIMEOFF_ANYTIMEOFF);</span>
<span class="nc" id="L833">		String jsString = JSUtil.ON_CHANGE;</span>
<span class="nc" id="L834">		boolean isSelectedChoice = getIsVTOAnytimeOff();</span>
<span class="nc" id="L835">		initChoiceInput(IS_ANYTIMEOFF_FN, isNew(), isSelectedChoice, jsString, ariaLabel);</span>
<span class="nc" id="L836">		return choiceInput.getHtmlDisplay() + rowLabel;</span>
	}

	private void initChoiceInput(String fn, boolean isEditable, boolean isChecked, String jsString, String ariaLabel) {
<span class="nc" id="L840">		choiceInput.reset();</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">		choiceInput.setValue(isEditable ? &quot;true&quot; : String.valueOf(isChecked));</span>
<span class="nc" id="L842">		choiceInput.setIsChecked(isChecked);</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">		choiceInput.setOnClickJS(StringUtil.isEmpty(jsString) ? JSUtil.ON_CHANGE : jsString);</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">		choiceInput.setIsDisabled(!isEditable);</span>
<span class="nc" id="L845">		choiceInput.setIsValueSubmittedWhenDisabled(true);</span>
<span class="nc" id="L846">		choiceInput.setInputName(fn);</span>
<span class="nc" id="L847">		choiceInput.setAriaLabel(ariaLabel);</span>
<span class="nc" id="L848">	}</span>

	protected void initMainListTimeOffHours() {
<span class="nc" id="L851">		String timeOffDebitLabel = HtmlUtil.createLabel(i18n(RmWebBundleKey.TIMEOFF_HOURS_LABEL), DEBIT_TYPE_FN);</span>
<span class="nc bnc" id="L852" title="All 4 branches missed.">		if (isAccessibilityComplianceMode() &amp;&amp; isEscalatedRequest()) {</span>
<span class="nc" id="L853">			m_mainContainerPC.addAriaLabelsRow(timeOffDebitLabel, createDebitTypeDD());</span>
		} else {
<span class="nc" id="L855">			m_mainContainerPC.addRow(timeOffDebitLabel, createDebitTypeDD());</span>
		}
<span class="nc" id="L857">	}</span>

	/**
	 * Return true if User is authorized to waitlist a Request.
	 */
	protected boolean isAuthToWaitlist() {
<span class="nc" id="L863">		return m_context.getUser().isAuthorized(PrivilegeKeys.TOM_ADDREQUESTTOWAITLIST_ID);</span>
	}

	private boolean isWaitlistEnabledForPool() {
<span class="nc bnc" id="L867" title="All 4 branches missed.">		return toPool != null &amp;&amp; toPool.isWaitlistEnabled();</span>
	}

	/**
	 * Create the waitlist row, which has the &quot;Add to Waitlist if not Approvable&quot; checkbox and expiry date.
	 * @param checkboxLabel For 508 Accessibility compliance, we need the label text for the checkbox.
	 * @return The HTML for the waitlist row.
	 */
	private String createAndAddWaitListRow(String checkboxLabel) {
<span class="nc" id="L876">		StringBuilder sb = new StringBuilder(100);</span>

<span class="nc bnc" id="L878" title="All 6 branches missed.">		boolean canBeAddedToWL = isAuthToWaitlist() &amp;&amp; isWaitlistEnabledForPool() &amp;&amp; TORequestUtil.isTOWaitlistFeatureEnabled();</span>
<span class="nc bnc" id="L879" title="All 4 branches missed.">		if (!isNew() &amp;&amp; m_timeoffRequest.getWaitlistInfo() == null) {</span>
<span class="nc bnc" id="L880" title="All 4 branches missed.">			canBeAddedToWL = m_timeoffRequest.isEligibleForWaitlist() &amp;&amp; isAuthToWaitlist();</span>
		}

<span class="nc" id="L883">		HtmlChoiceInput wlInput = new HtmlChoiceInput();</span>
<span class="nc bnc" id="L884" title="All 6 branches missed.">		sb.append(wlInput.getChkBoxInput(REQUEST_ADDTOWL_FN, REQUEST_ADDTOWL_FN, checkboxLabel, m_timeoffRequest.getWaitlistInfo() != null</span>
				|| m_addToWL, !canBeAddedToWL, &quot;&quot;, true));

<span class="nc" id="L887">		sb.append(HtmlUtil.NBSP + HtmlUtil.NBSP + HtmlUtil.NBSP + HtmlUtil.NBSP);</span>
<span class="nc" id="L888">		sb.append(i18n(RmWebBundleKey.TIMEOFF_WL_EXPIRY_DATE));</span>

<span class="nc bnc" id="L890" title="All 2 branches missed.">		if (m_timeoffRequest.getWaitlistInfo() != null) {</span>
<span class="nc" id="L891">			m_wlExpiryDatePickerPC.setDate(m_timeoffRequest.getWaitlistInfo().getTOWaitlistExpiryDate());</span>
		}
<span class="nc" id="L893">		m_wlExpiryDatePickerPC.setIsPickerEnabled(canBeAddedToWL);</span>
<span class="nc" id="L894">		sb.append(m_wlExpiryDatePickerPC.getHtmlDisplay());</span>

<span class="nc bnc" id="L896" title="All 4 branches missed.">		if (m_timeoffRequest.isWaitlisted() &amp;&amp; !com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil.isWaitListRankOnRqPageDisabled()) {</span>
			//Waitlist Rank
<span class="nc" id="L898">			sb.append(HtmlUtil.NBSP + HtmlUtil.NBSP + HtmlUtil.NBSP + HtmlUtil.NBSP);</span>
<span class="nc" id="L899">			sb.append(i18n(RmWebBundleKey.TIMEOFF_WAITLIST_RANK));</span>
<span class="nc" id="L900">			sb.append(HtmlUtil.NBSP);</span>
<span class="nc" id="L901">			sb.append(TimeOffRequestsMH.getWaitlistRank(m_timeoffRequest.getID()));</span>
		}

<span class="nc" id="L904">		m_mainContainerPC.addRow(checkboxLabel, sb.toString());</span>
<span class="nc" id="L905">		return sb.toString();</span>
	}

	/**
	 * Initialize Choise List
	 */
	public void initChoiceList() {
<span class="nc" id="L912">		DynamicMultiColListPC dynamicMultiColListPC = null;</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L914">			dynamicMultiColListPC = new DynamicMultiColListPC(m_context) {</span>
<span class="nc" id="L915">				private String originCellData = &quot;&quot;;</span>
<span class="nc" id="L916">				private int rowNumber = 0;</span>

				@Override
				protected HtmlDiv getNewHtmlDiv() {
<span class="nc" id="L920">					HtmlDiv htmlDiv = super.getNewHtmlDiv();</span>
<span class="nc" id="L921">					htmlDiv.setAttribute(&quot;aria-label&quot;, i18n(m_bundle, RmWebBundleKey.TIMEOFF_CHOICES_GRID));</span>
<span class="nc" id="L922">					return htmlDiv;</span>
				}

				@Override
				protected boolean skipEncloseForKeyboardAccess(BaseNodeData nodeData) {
<span class="nc bnc" id="L927" title="All 4 branches missed.">					return !this.isKeyboardAccessible() || !nodeData.isSelectable();</span>
				}

				@Override
				protected String addAdditionalCellText(HtmlTableCell cell) {
<span class="nc" id="L932">					return originCellData;</span>
				}

				@Override
				protected String getCellData(HtmlTableCell cell) {
<span class="nc" id="L937">					originCellData = cell.getInnerHtml().toString();</span>
<span class="nc" id="L938">					int currentRow = rowNumber++;</span>
<span class="nc" id="L939">					String hiddenSpan = HtmlUtil.makeHiddenSpanWithId(&quot;&quot;, RmWebBundleKey.TIMEOFF_CHOICES_GRID + currentRow);</span>
<span class="nc" id="L940">					return StringUtil.NBSP + hiddenSpan;</span>
				}

				@Override
				protected String getCustomCellTemplate() {
<span class="nc" id="L945">					return &quot;\n&lt;a class=\&quot;focusableNode\&quot; href=\&quot;#{1}\&quot; onClick=\&quot;return false;\&quot; &quot;</span>
							+ &quot;onKeyDown=\&quot;{0}.onKeyDown(this);\&quot;&gt;{2}&lt;/a&gt;&quot;;
				}
			};
<span class="nc" id="L949">			dynamicMultiColListPC.setWrapperRegion(true);</span>
<span class="nc" id="L950">			dynamicMultiColListPC.disableRepeatHeader();</span>
<span class="nc" id="L951">			dynamicMultiColListPC.setReadableRowInfoEnabled(true);</span>
<span class="nc" id="L952">			dynamicMultiColListPC.addJSVariableAsString(RmWebBundleKey.TIMEOFF_CHOICES_GRID, RmWebBundleKey.TIMEOFF_CHOICES_GRID);</span>
<span class="nc" id="L953">			dynamicMultiColListPC.addJSVariableAsString(RmWebBundleKey.EMPTY_ROW, i18n(m_bundle, RmWebBundleKey.EMPTY_ROW));</span>
		} else {
<span class="nc" id="L955">			dynamicMultiColListPC = new DynamicMultiColListPC(m_context);</span>
		}
<span class="nc" id="L957">		m_choiceListPC = new DynamicMultiColListWithToolbarPC(m_context, dynamicMultiColListPC);</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">		m_choiceListPC.setEnabled(!isTOChoiceEditDisabled());</span>
<span class="nc" id="L959">		m_choiceListPC.setPaddingBottom(&quot;10px&quot;);</span>
<span class="nc" id="L960">		m_containerList.add(m_choiceListPC);</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L962">			m_choiceListPC.setUseWrapper(true);</span>
<span class="nc" id="L963">			m_choiceListPC.setWrapperRegion(true);</span>
<span class="nc" id="L964">			m_choiceListPC.getToolbar().setUseWrapper(true);</span>
<span class="nc" id="L965">			m_choiceListPC.getToolbar().setWrapperRegion(true);</span>
<span class="nc" id="L966">			m_choiceListPC.setWrapperAriaLabel(i18n(m_bundle, RmWebBundleKey.TIMEOFF_CHOICES));</span>
		}

<span class="nc" id="L969">		dynamicMultiColListPC.setHeightInPixels(110);</span>
<span class="nc" id="L970">		dynamicMultiColListPC.setIsRowNumberEnabled(true);</span>
<span class="nc" id="L971">		dynamicMultiColListPC.disableRepeatHeader();</span>
<span class="nc" id="L972">		dynamicMultiColListPC.setTableAttribute(&quot;summary&quot;, i18n(m_bundle, RmWebBundleKey.TO_REQUEST_POPUP_CHOICES_TABLE_SUMMARY));</span>

		//Hide toolbar buttons for anytime Time Off Request when editing
<span class="nc bnc" id="L975" title="All 4 branches missed.">		if (isAdvancedVTORequest &amp;&amp; !isNew()) {</span>
<span class="nc" id="L976">			m_choiceListPC.setIsCreateButtonShown(false);</span>
<span class="nc" id="L977">			m_choiceListPC.setIsDeleteButtonShown(false);</span>
<span class="nc" id="L978">			m_choiceListPC.setIsMoveUpButtonShown(false);</span>
<span class="nc" id="L979">			m_choiceListPC.setIsMoveDownButtonShown(false);</span>
<span class="nc" id="L980">			m_choiceListPC.setWrapperAriaLabel(i18n(m_bundle, RmWebBundleKey.TIMEOFF_CHOICES));</span>
		}
		// Init Header
<span class="nc" id="L983">		TableHeaderPC headerPC = dynamicMultiColListPC.getHeader();</span>
<span class="nc" id="L984">		headerPC.addColumnHeaderData(&quot;&quot;, i18n(RmWebBundleKey.TIMEOFF_CHOICES));</span>
<span class="nc" id="L985">		headerPC.addColumnHeaderData(&quot;&quot;, i18n(m_common_bundle, UIFWebBundleKey.LENGTH));</span>
<span class="nc" id="L986">		headerPC.addColumnHeaderData(&quot;&quot;, i18n(RmWebBundleKey.TIMEOFF_HOURS_ACCOUNTED_LABEL));</span>
<span class="nc" id="L987">		headerPC.addColumnHeaderData(&quot;&quot;, i18n(RmWebBundleKey.TIMEOFF_CHOICES_ALERTS));</span>

		// Init Template Node
<span class="nc" id="L990">		DefaultMultiColumnNodeData tmplNodeData = getTemplateData();</span>
<span class="nc" id="L991">		dynamicMultiColListPC.setTemplateNodeData(tmplNodeData);</span>

		// Populdate List Model
<span class="nc" id="L994">		List&lt;DefaultMultiColumnNodeData&gt; listModel = getChoiceDateList();</span>
<span class="nc" id="L995">		dynamicMultiColListPC.setListModel(listModel);</span>
<span class="nc" id="L996">	}</span>

	/**
	 * Return Template Row Data
	 */
	protected DefaultMultiColumnNodeData getTemplateData() {
<span class="nc" id="L1002">		return createChoiceRowData(&quot;_&quot;, 0, null);</span>
	}

	/**
	 * Create Choice Row Data
	 */
	protected DefaultMultiColumnNodeData createChoiceRowData(String rowID, int index, TOChoice choice) {
<span class="nc bnc" id="L1009" title="All 2 branches missed.">		Date startDate = (choice == null) ? null : choice.getStartDate();</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">		Date endDate = (choice == null) ? null : choice.getEndDate();</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">		if (!isAdvancedVTORequest) {</span>
			// Initialize Date Range
<span class="nc" id="L1013">			m_dateRangePickerPC.setDateInputIndex(index);</span>
<span class="nc" id="L1014">			m_dateRangePickerPC.getStartDatePickerPC().setDate(startDate);</span>
<span class="nc" id="L1015">			m_dateRangePickerPC.getEndDatePickerPC().setDate(endDate);</span>
		} else {
<span class="nc" id="L1017">			singleDatePickerPC.setDate(startDate);</span>
<span class="nc" id="L1018">			singleDatePickerPC.setDateInputIndex(index);</span>
<span class="nc" id="L1019">			Calendar cal = Calendar.getInstance(m_view_tz);</span>

<span class="nc bnc" id="L1021" title="All 4 branches missed.">			if (startDate != null &amp;&amp; endDate != null) {</span>
<span class="nc" id="L1022">				int timeInterval = getTimeOffRoundInterval();</span>
<span class="nc" id="L1023">				partialDurationPC.setName(PARTIAL_DURATION_FN+index);</span>
<span class="nc" id="L1024">				partialDurationPC.setMaxTime(24, 0, 0);</span>
<span class="nc" id="L1025">				partialDurationPC.setEnabled(true);</span>
<span class="nc" id="L1026">				partialDurationPC.setEdited(true);</span>
<span class="nc" id="L1027">				partialDurationPC.setVisible(true);</span>
<span class="nc" id="L1028">				partialDurationPC.setMinutesIncrement(timeInterval);</span>

<span class="nc" id="L1030">				partialStartTimePC.setTimeInterval(timeInterval);</span>
<span class="nc" id="L1031">				partialStartTimePC.setIsPickerEnabled(true);</span>
<span class="nc" id="L1032">				partialStartTimePC.setIsControlEnabled(true);</span>
				//Important to setTimeInputIndex, without this, the time on does not dialog does not show when click Set
<span class="nc" id="L1034">				partialStartTimePC.setInputIndex(index);</span>
<span class="nc" id="L1035">				partialStartTimePC.setTitle(i18n(RmWebBundleKey.START_TIME));</span>
<span class="nc" id="L1036">				setTime(partialStartTimePC, cal, startDate);</span>
<span class="nc" id="L1037">				int duration = (int) (endDate.getTime()-startDate.getTime())/(1000*60);</span>
<span class="nc" id="L1038">				partialDurationPC.setValue(Duration.fromMinutes(duration));</span>
			}
		}
<span class="nc bnc" id="L1041" title="All 2 branches missed.">		if (m_dateRangePickerPC != null) {</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">			if (!isAdvancedVTORequest) {</span>
<span class="nc" id="L1043">				m_wlExpiryDatePickerPC.setUpperLimit(m_dateRangePickerPC.getStartDatePickerPC().getDate());</span>
			} else {
<span class="nc" id="L1045">				m_wlExpiryDatePickerPC.setUpperLimit(singleDatePickerPC.getDate());</span>
			}
		}

<span class="nc" id="L1049">		DefaultMultiColumnNodeData tmplNodeData = new DefaultMultiColumnNodeData(rowID);</span>
		//Time Off Choice date range data
<span class="nc" id="L1051">		String dateRangeHtml = getDateRangeHtml();</span>
		
<span class="nc" id="L1053">		HtmlTableCell cell = new HtmlTableCell(dateRangeHtml);</span>
<span class="nc" id="L1054">		cell.setNowrap(&quot;nowrap&quot;);</span>
<span class="nc" id="L1055">		tmplNodeData.add(cell);</span>
		//Time Off Choice, other data: Length, Hours Accounted, Alerts
<span class="nc" id="L1057">		String[] lenngthHoursAlerts = getTimeOffChoiceLenAndAlerts(choice, m_localizer, m_view_tz, m_bundle, m_timeoffRequest.isApproved(),</span>
				this.validChoiceList);
<span class="nc bnc" id="L1059" title="All 2 branches missed.">		for (String data : lenngthHoursAlerts) {</span>
<span class="nc" id="L1060">			tmplNodeData.add(data);</span>
		}

<span class="nc" id="L1063">		return tmplNodeData;</span>
	}

	private String getDateRangeHtml() {
<span class="nc bnc" id="L1067" title="All 2 branches missed.">		String dateRangeHtml = m_dateRangePickerPC != null ? getRangePickerHtmlDisplay(m_dateRangePickerPC) : &quot;&quot;;</span>
<span class="nc bnc" id="L1068" title="All 2 branches missed.">		if (isAdvancedVTORequest) {</span>
<span class="nc bnc" id="L1069" title="All 2 branches missed.">			dateRangeHtml = m_timeoffRequest.isVTOPartialDay() ? getDateTimeDurationHtmlDisplay()</span>
<span class="nc" id="L1070">				: getSingleDatePickerHtmlDisplay(singleDatePickerPC);</span>
		}
<span class="nc" id="L1072">		return dateRangeHtml;</span>
	}

	private String getDateTimeDurationHtmlDisplay() {
<span class="nc" id="L1076">		return getSingleDatePickerHtmlDisplay(singleDatePickerPC) + getPartialStartTimeHtmlDisplay(partialStartTimePC)</span>
<span class="nc" id="L1077">			+ i18n(RmWebBundleKey.CSR_DURATION) + HtmlUtil.NBSP + getPartialDurationDisplay(partialDurationPC);</span>
	}

	protected String getSingleDatePickerHtmlDisplay(DatePickerPC singleDatePickerPC) {
<span class="nc" id="L1081">		return singleDatePickerPC.getHtmlDisplay();</span>
	}

	protected String getPartialDurationDisplay(DurationSpinnerPC partialDurationPC) {
<span class="nc" id="L1085">		return partialDurationPC.getHtmlDisplay();</span>
	}

	protected String getPartialStartTimeHtmlDisplay(TimePickerPC partialStartTimePC) {
<span class="nc" id="L1089">		return partialStartTimePC.getHtmlDisplay();</span>
	}

	protected String getRangePickerHtmlDisplay(DateRangePickerPC dateRangePickerPC) {
<span class="nc" id="L1093">		return dateRangePickerPC.getHtmlDisplay();</span>
	}

	private void setTime(TimePickerPC timePickerPC, Calendar cal, Date time) {
<span class="nc" id="L1097">		cal.setTime(time);</span>
<span class="nc" id="L1098">		int hours = cal.get(Calendar.HOUR_OF_DAY);</span>
<span class="nc" id="L1099">		int minutes = cal.get(Calendar.MINUTE);</span>
<span class="nc" id="L1100">		timePickerPC.setTime(hours, minutes, 0);</span>
<span class="nc" id="L1101">	}</span>

	protected String[] getTimeOffChoiceLenAndAlerts(TOChoice choice, Localizer localizer, TimeZone tz, ResourceBundle rmBundle,
			boolean isApproved, boolean hasValidChoiceList) {
<span class="nc" id="L1105">		return TimeOffRequestUtil.getTimeOffChoiceLenAndAlertsWithPrintAccountedHours(choice, localizer, tz, rmBundle, isApproved, false,</span>
				hasValidChoiceList);
	}

	/**
	 * Return Choice Date List Model
	 */
	protected List&lt;DefaultMultiColumnNodeData&gt; getChoiceDateList() {
<span class="nc" id="L1113">		List&lt;DefaultMultiColumnNodeData&gt; listModel = new ArrayList&lt;DefaultMultiColumnNodeData&gt;();</span>
<span class="nc" id="L1114">		Collection&lt;TOChoice&gt; choiceList = m_timeoffRequest.getRequestChoiceList();</span>

<span class="nc bnc" id="L1116" title="All 2 branches missed.">		if (choiceList.isEmpty()) {</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">			if (!m_isFromNetStaffingRibbon) {</span>
<span class="nc" id="L1118">				DefaultMultiColumnNodeData firstRow = createChoiceRowData(&quot;&quot;, 1, null);</span>
<span class="nc" id="L1119">				listModel.add(firstRow);</span>
<span class="nc" id="L1120">			} else {</span>
<span class="nc" id="L1121">				TOChoice choice = new TOChoice();</span>
<span class="nc" id="L1122">				choice.setStartDate(m_ribbonStartDate);</span>
<span class="nc" id="L1123">				choice.setEndDate(m_ribbonEndDate);</span>
<span class="nc" id="L1124">				DefaultMultiColumnNodeData firstRow = createChoiceRowData(&quot;&quot;, 1, choice);</span>
<span class="nc" id="L1125">				listModel.add(firstRow);</span>
<span class="nc" id="L1126">			}</span>
		} else {
<span class="nc bnc" id="L1128" title="All 2 branches missed.">			if (isTOChoiceEditDisabled()) {</span>
<span class="nc" id="L1129">				disableDateRangePickerPC();</span>
<span class="nc" id="L1130">				disableSingleDatePickerPC();</span>
			}
			//Populate Time Off Choices from database
<span class="nc" id="L1133">			listModel =populateTimeOffChoices(choiceList);</span>
		}
<span class="nc" id="L1135">		numberOfChoice = listModel.size();</span>
<span class="nc" id="L1136">		return listModel;</span>
	}
	protected List&lt;DefaultMultiColumnNodeData&gt; populateTimeOffChoices(Collection&lt;TOChoice&gt; choiceList){
<span class="nc" id="L1139">		List&lt;DefaultMultiColumnNodeData&gt; listModel = new ArrayList&lt;DefaultMultiColumnNodeData&gt;();</span>
<span class="nc" id="L1140">		int index = 1;</span>
<span class="nc bnc" id="L1141" title="All 2 branches missed.">		for (TOChoice choice : choiceList) {</span>
<span class="nc" id="L1142">			DefaultMultiColumnNodeData nodeData = createChoiceRowData(&quot;&quot;, index++, choice);</span>
<span class="nc" id="L1143">			listModel.add(nodeData);</span>
<span class="nc" id="L1144">		}</span>
<span class="nc" id="L1145">		return listModel;</span>
	}

	/**
	 * Init Time Off Calendar
	 */
	public void initTimeOffCalendars() {
<span class="nc" id="L1152">		m_timeOffCalPC.setIsLegendButtonEnabled(true);</span>
<span class="nc" id="L1153">		removeChildComponent(m_timeOffCalPC);</span>
<span class="nc" id="L1154">		m_containerList.add(m_timeOffCalPC);</span>
<span class="nc" id="L1155">	}</span>

	/** Return List of Containers
	 *
	 * NOTE: Items in the Collection will be treated either as Page Components or
	 *       just a basic Object.
	 */
	@Override
	public Collection getContainers() {
<span class="nc" id="L1164">		return m_containerList;</span>
	}

	@Override
	protected boolean isSaveButtonEnabled() {
<span class="nc bnc" id="L1169" title="All 2 branches missed.">		if (getTOTypeList().isEmpty()) {</span>
<span class="nc" id="L1170">			return false;</span>
		}
<span class="nc" id="L1172">		return RequestUtil.isRequestFormSaveBtnEnabled(m_request);</span>

	}

	protected Collection&lt;Activity&gt; getTOTypeList() {
<span class="nc" id="L1177">		return m_timeoffTypeList;</span>
	}

	/**
	 * Extract parameter
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L1185">		boolean success = super.extractParameters(request);</span>

<span class="nc bnc" id="L1187" title="All 2 branches missed.">		boolean isNewTORequest = getTimeOffRequest().getID() == null;</span>
		//also set the waitlist info
<span class="nc bnc" id="L1189" title="All 4 branches missed.">		if (m_addToWL &amp;&amp; !isAdvancedVTORequest) {</span>
			//Waitlist will not be supported for VTO Request
<span class="nc" id="L1191">			TOWaitlist waitlist = new TOWaitlist();</span>
<span class="nc" id="L1192">			waitlist.setTOWaitlistCreatorID(m_context.getUser().getID());</span>
<span class="nc" id="L1193">			waitlist.setTOWaitlistCreationDate(new Date());</span>
<span class="nc" id="L1194">			m_timeoffRequest.setWaitlistInfo(waitlist);</span>
			//also set the expiry date
<span class="nc" id="L1196">			m_wlExpiryDatePickerPC.extractParameters(request);</span>
<span class="nc" id="L1197">			m_timeoffRequest.getWaitlistInfo().setTOWaitlistExpiryDate(m_wlExpiryDatePickerPC.getDate());</span>
<span class="nc bnc" id="L1198" title="All 2 branches missed.">			if (m_timeoffRequest.getRequestStatus().equals(RequestAuditTrail.STATUS_DENIED)) {</span>
<span class="nc" id="L1199">				m_timeoffRequest.setRequestStatus(RequestAuditTrail.STATUS_PENDING);</span>
			}
<span class="nc" id="L1201">		} else {</span>
			//User definitely wants to remove the Waitlist preferences &amp; also the request from Waitlist if its already waitlisted.
<span class="nc bnc" id="L1203" title="All 4 branches missed.">			if (!m_addToWL &amp;&amp; m_timeoffRequest.getRequestStatus().equals(RequestAuditTrail.STATUS_WAITLIST)) {</span>
				//Auto Processing cannot revert the status to pending
<span class="nc" id="L1205">				m_timeoffRequest.setRequestStatus(RequestAuditTrail.STATUS_PENDING);</span>
			}
<span class="nc" id="L1207">			m_timeoffRequest.setWaitlistInfo(null);</span>

		}

		// QC 45654: Save button doesn't resubmit after request has been denied
<span class="nc bnc" id="L1212" title="All 2 branches missed.">		if (m_timeoffRequest.getRequestStatus().equals(RequestAuditTrail.STATUS_DENIED)) {</span>
<span class="nc" id="L1213">			m_timeoffRequest.setRequestStatus(RequestAuditTrail.STATUS_PENDING);</span>
		}

<span class="nc" id="L1216">		List sDates = m_dateRangePickerPC.getStartDatePickerPC().getDates();</span>
<span class="nc" id="L1217">		List eDates = m_dateRangePickerPC.getEndDatePickerPC().getDates();</span>
		try {
<span class="nc bnc" id="L1219" title="All 2 branches missed.">			if (getTimeOffType() != null) {</span>
<span class="nc" id="L1220">				activityProperty = ActivityModelHandler.getActivityProperties(m_context, getTimeOffType());</span>
<span class="nc bnc" id="L1221" title="All 2 branches missed.">			} else if (!m_timeoffTypeList.isEmpty()) {</span>
<span class="nc" id="L1222">				ID defaultActivityId = m_timeoffTypeList.iterator().next().getID();</span>
<span class="nc" id="L1223">				activityProperty = ActivityModelHandler.getActivityProperties(m_context, defaultActivityId);</span>
			}

<span class="nc" id="L1226">		} catch (Exception ex) {</span>
<span class="nc" id="L1227">			log.l7dError(&quot;failed to fetch activity by id&quot;, ex);</span>
<span class="nc" id="L1228">		}</span>
<span class="nc bnc" id="L1229" title="All 4 branches missed.">		isAdvancedVTORequest = activityProperty == null ? false : activityProperty.isUseAdvancedVTOOptions()</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">				&amp;&amp; LicenseUtil.isAdvancedRMLicense();</span>
<span class="nc" id="L1231">		Pair&lt;Date, Date&gt; partialDaytimes = null;</span>
<span class="nc bnc" id="L1232" title="All 2 branches missed.">		if (isAdvancedVTORequest) {</span>
<span class="nc" id="L1233">			singleDatePickerPC.extractParameters(request);</span>
<span class="nc" id="L1234">			sDates = singleDatePickerPC.getDates();</span>
<span class="nc" id="L1235">			eDates = null;</span>
		}

<span class="nc" id="L1238">		int choiceSize = sDates.size();</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">		if (choiceSize &lt; 2) {</span>
			// It must be at least two choices because one is hidden
<span class="nc" id="L1241">			success = false;</span>
		} else {
<span class="nc" id="L1243">			ArrayList choiceList = new ArrayList(choiceSize);</span>
<span class="nc" id="L1244">			int timeInterval = getTimeOffRoundInterval();</span>

<span class="nc bnc" id="L1246" title="All 2 branches missed.">			for (int i = 1; i &lt; choiceSize; i++) {</span>
<span class="nc" id="L1247">				Date startDate = (Date) sDates.get(i);</span>
<span class="nc bnc" id="L1248" title="All 2 branches missed.">				Date endDate = eDates != null ? (Date) eDates.get(i) : null;</span>
				// Round the dates to the nearest interval
<span class="nc bnc" id="L1250" title="All 2 branches missed.">				if (startDate != null) {</span>
<span class="nc" id="L1251">					startDate = roundTOStartDateParameter(startDate, timeInterval);</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">					if (endDate != null) {</span>
<span class="nc" id="L1253">						endDate = roundTOEndDateParameter(endDate, timeInterval);</span>
					} else {
<span class="nc" id="L1255">						endDate = TimeZoneUtil.addDay(startDate);</span>
					}
				}
<span class="nc bnc" id="L1258" title="All 2 branches missed.">				if (isAdvancedVTORequest) {</span>
<span class="nc" id="L1259">					m_timeoffRequest.setAdvancedVTODate(startDate);</span>
				}
<span class="nc bnc" id="L1261" title="All 2 branches missed.">				if (getIsVTOPartialDay()) {</span>
<span class="nc" id="L1262">					int[] starTimeInMinutes = partialStartTimePC.getTimes();</span>
<span class="nc bnc" id="L1263" title="All 2 branches missed.">					Date date = startDate == null ? new Date() : startDate;</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">					int startTimeInMinute = starTimeInMinutes == null ? 0 : starTimeInMinutes[i] / 60;</span>
<span class="nc" id="L1265">					String durationValue = getParameter(request,partialDurationPC.getName()+i+&quot;__input&quot;);</span>
<span class="nc" id="L1266">					int endTimeInMinute = startTimeInMinute + calcualateDurationValue(durationValue);</span>
<span class="nc" id="L1267">					partialDaytimes = DateUtil.getTimes(m_view_tz, 0, date, startTimeInMinute, endTimeInMinute);</span>
<span class="nc" id="L1268">					startDate = partialDaytimes.getFirst();</span>
<span class="nc" id="L1269">					endDate = partialDaytimes.getSecond();</span>
<span class="nc" id="L1270">					m_timeoffRequest.setPartialStartTime(startDate);</span>
<span class="nc" id="L1271">					m_timeoffRequest.setPartialEndTime(endDate);</span>

				}
<span class="nc" id="L1274">				TOChoice choice = new TOChoice();</span>

<span class="nc bnc" id="L1276" title="All 6 branches missed.">				if ((isNewTORequest || !m_addToWL) &amp;&amp; i == 1) {</span>
<span class="nc" id="L1277">					choice.setRank(1);</span>
<span class="nc bnc" id="L1278" title="All 6 branches missed.">				} else if (!isNewTORequest &amp;&amp; m_addToWL &amp;&amp; i == waitlistTOChoiceUserRank) {</span>
<span class="nc" id="L1279">					choice.setRank(1);</span>
<span class="nc" id="L1280">					choice.setIsWaitlist(true);</span>
				} else {
<span class="nc bnc" id="L1282" title="All 4 branches missed.">					if (waitlistTOChoiceUserRank == -1 &amp;&amp; i == 1) {</span>
<span class="nc" id="L1283">						choice.setRank(1);</span>
					} else {
<span class="nc" id="L1285">						choice.setRank(0);</span>
					}
				}
<span class="nc" id="L1288">				choice.setUserRank(i);</span>
<span class="nc" id="L1289">				choice.setStartDate(startDate);</span>
<span class="nc" id="L1290">				choice.setEndDate(endDate);</span>
<span class="nc" id="L1291">				choiceList.add(choice);</span>

			}
<span class="nc" id="L1294">			m_timeoffRequest.setRequestChoiceList(choiceList);</span>
		}

<span class="nc" id="L1297">		return success;</span>
	}

	protected Date roundTOStartDateParameter(Date startDate, int timeInterval) {
<span class="nc" id="L1301">		return TimeOffRequestUtil.roundToNearestInterval(m_context.getViewingTimeZone(), startDate, timeInterval);</span>
	}

	protected Date roundTOEndDateParameter(Date endDate, int timeInterval) {
<span class="nc" id="L1305">		return TimeOffRequestUtil.roundToNearestInterval(m_context.getViewingTimeZone(), endDate, timeInterval);</span>
	}

	/**
	 * Return true if choice list is valid
	 */
	private boolean isValidChoiceList() {
<span class="nc" id="L1312">		validChoiceList = true;</span>
<span class="nc" id="L1313">		Collection choiceList = m_timeoffRequest.getRequestChoiceList();</span>
<span class="nc bnc" id="L1314" title="All 4 branches missed.">		if (choiceList != null &amp;&amp; !choiceList.isEmpty()) {</span>
<span class="nc" id="L1315">			int i = 1;</span>
<span class="nc bnc" id="L1316" title="All 2 branches missed.">			for (Iterator it = choiceList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1317">				TOChoice choice = (TOChoice) it.next();</span>
<span class="nc" id="L1318">				Date sDate = choice.getStartDate();</span>
<span class="nc" id="L1319">				Date eDate = choice.getEndDate();</span>
<span class="nc bnc" id="L1320" title="All 4 branches missed.">				long duration = sDate != null &amp;&amp; eDate != null ? eDate.getTime() - sDate.getTime() : 0;</span>
<span class="nc" id="L1321">				long maxDuration = 2 * 365 * 24 * 60 * 60 * 1000L;</span>
<span class="nc bnc" id="L1322" title="All 4 branches missed.">				if (sDate == null || eDate == null) {</span>
<span class="nc" id="L1323">					addChoiceErrorMsg(i, RmWebBundleKey.TIMEOFF_CHOICE_ERROR_BLANK);</span>
<span class="nc" id="L1324">					validChoiceList = false;</span>
<span class="nc bnc" id="L1325" title="All 4 branches missed.">				} else if (sDate.equals(eDate) &amp;&amp; !isAdvancedVTORequest) {</span>
<span class="nc" id="L1326">					addChoiceErrorMsg(i, RmWebBundleKey.TIMEOFF_CHOICE_ERROR_SAMETIME);</span>
<span class="nc" id="L1327">					validChoiceList = false;</span>
<span class="nc bnc" id="L1328" title="All 2 branches missed.">				} else if (duration &gt; maxDuration) {//duration greater than 2 years</span>
<span class="nc" id="L1329">					addChoiceErrorMsg(i, RmWebBundleKey.TIMEOFF_CHOICE_DURATION_ERROR);</span>
<span class="nc" id="L1330">					validChoiceList = false;</span>
				}
<span class="nc" id="L1332">				i++;</span>
<span class="nc" id="L1333">			}</span>
<span class="nc" id="L1334">		} else {</span>
<span class="nc" id="L1335">			addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.TIMEOFF_CHOICE_ERROR_NONE, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L1336">			validChoiceList = false;</span>
		}

<span class="nc" id="L1339">		return validChoiceList;</span>
	}

	/**
	 * Return true if choice list is valid
	 */
	private boolean isValidExpiryDate() {
<span class="nc" id="L1346">		return true;</span>
	}

	private void addChoiceErrorMsg(int num, String rbKey) {
<span class="nc" id="L1350">		String[] args = new String[] { m_localizer.formatNumber(num) };</span>
<span class="nc" id="L1351">		addPageMessage(Message.ERROR_TYPE, rbKey, RmWebBundleKey.BUNDLE_NAME, args);</span>
<span class="nc" id="L1352">	}</span>

	/**
	 * Validate Data to be valid
	 */
	@Override
	public boolean validate() {
<span class="nc" id="L1359">		boolean success = super.validate();</span>

<span class="nc bnc" id="L1361" title="All 2 branches missed.">		if (!isValidChoiceList()) {</span>
<span class="nc" id="L1362">			return false;</span>
		}

<span class="nc bnc" id="L1365" title="All 2 branches missed.">		if (!isValidExpiryDate()) {</span>
<span class="nc" id="L1366">			return false;</span>
		}

<span class="nc" id="L1369">		return success;</span>
	}

	/**
	 * Specify Employee which Request is for
	 */
	public void setRequestedFor(ID empID) {
<span class="nc" id="L1376">		m_timeoffRequest.setEmployeeID(empID);</span>
<span class="nc" id="L1377">	}</span>

	/**
	 * Return Employee which Request is for
	 */
	public ID getRequestedFor() {
<span class="nc" id="L1383">		ID id = m_timeoffRequest.getEmployeeID();</span>

<span class="nc bnc" id="L1385" title="All 4 branches missed.">		if (!isManagerMode() &amp;&amp; id == null) {</span>
<span class="nc" id="L1386">			id = m_context.getUser().getEmployeeID();</span>
		}

<span class="nc" id="L1389">		return id;</span>
	}

	/**
	 * Set the Time Off Request to be used
	 */
	public void setTimeOffRequest(TORequest request) {
<span class="nc" id="L1396">		m_timeoffRequest = request;</span>
<span class="nc" id="L1397">		m_request = request;</span>
<span class="nc" id="L1398">	}</span>

	/**
	 * Return the Time Off Request
	 */
	public TORequest getTimeOffRequest() {
<span class="nc" id="L1404">		return m_timeoffRequest;</span>
	}

	/**
	 * Set Time Off Type ID
	 */
	public void setTimeOffType(ID id) {
<span class="nc" id="L1411">		m_timeoffRequest.setTimeOffType(id);</span>
<span class="nc" id="L1412">	}</span>

	/**
	 * Return Time Off Type ID
	 */
	public ID getTimeOffType() {
<span class="nc" id="L1418">		return m_timeoffRequest.getTimeOffType();</span>
	}

	/**
	 * Set isFromNetStaffingRibbon
	 */
	public void setIsFromNetStaffingRibbon(String val) {
<span class="nc bnc" id="L1425" title="All 2 branches missed.">		if (val.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L1426">			m_isFromNetStaffingRibbon = true;</span>
			//Set default activity as VTO only if no activity has been selected by the user.
<span class="nc bnc" id="L1428" title="All 2 branches missed.">			if (getTimeOffType() == null) {</span>
<span class="nc" id="L1429">				setTimeOffType(Activity.ACTIVITY_VOLUNTARY_TIMEOFF);</span>
			}
		} else {
<span class="nc" id="L1432">			m_isFromNetStaffingRibbon = false;</span>
		}
<span class="nc" id="L1434">	}</span>

	/**
	 * Return isFromNetStaffingRibbon
	 */
	public boolean getIsFromNetStaffingRibbon() {
<span class="nc" id="L1440">		return m_isFromNetStaffingRibbon;</span>
	}

	/**
	 * Set the date at which the user's selection starts on the graph schedule view's Net Staffing ribbon.
	 * @param date
	 */
	public void setRibbonStartDate(String date) {
<span class="nc" id="L1448">		m_ribbonStartDate = new Date(Long.parseLong(date));</span>
<span class="nc" id="L1449">	}</span>

	/**
	 * Get the date at which the user's selection starts on the graph schedule view's Net Staffing ribbon.
	 */
	public Date getRibbonStartDate() {
<span class="nc" id="L1455">		return m_ribbonStartDate;</span>
	}

	/**
	 * Set the date at which the user's selection ends on the graph schedule view's Net Staffing ribbon.
	 * @param date
	 */
	public void setRibbonEndDate(String date) {
<span class="nc" id="L1463">		m_ribbonEndDate = new Date(Long.parseLong(date));</span>
<span class="nc" id="L1464">	}</span>

	/**
	 * Get the date at which the user's selection ends on the graph schedule view's Net Staffing ribbon.
	 */
	public Date getRibbonEndDate() {
<span class="nc" id="L1470">		return m_ribbonEndDate;</span>
	}

	/**
	 * Set Debit Type
	 */
	public void setDebitType(String type) {
<span class="nc" id="L1477">		m_timeoffRequest.setTimeOffDebitType(type);</span>
<span class="nc" id="L1478">	}</span>

	/**
	 * Return Debit Type
	 */
	public String getDebitType() {
<span class="nc" id="L1484">		return m_timeoffRequest.getTimeOffDebitType();</span>
	}

	/**
	 * Set Request Status
	 */
	public void setRequestStatus(String status) {
<span class="nc" id="L1491">		m_timeoffRequest.setRequestStatus(status);</span>
<span class="nc" id="L1492">	}</span>

	/**
	 * Return Request Status
	 */
	public String getRequestStatus() {
<span class="nc" id="L1498">		return m_timeoffRequest.getRequestStatus();</span>
	}

	/**
	 * Set add to wl
	 */
	public void setAddToWL(boolean addToWL) {
<span class="nc" id="L1505">		m_addToWL = true;</span>
<span class="nc" id="L1506">	}</span>

	/**
	 * Return Debit Type
	 */
	public boolean getAddToWL() {
<span class="nc bnc" id="L1512" title="All 2 branches missed.">		return m_timeoffRequest.getWaitlistInfo() != null;</span>
	}

	/**
	 * Return true if Request is Escalated
	 */
	private boolean isEscalatedRequest() {
<span class="nc" id="L1519">		return RequestAuditTrail.STATUS_ESCALATED.equals(getRequestStatus());</span>
	}

	/**
	 * Set if VTO is a full day
	 */
	public void setIsVTOFullDay(boolean value) {
<span class="nc" id="L1526">		m_timeoffRequest.setVTOFullDay(value);</span>
<span class="nc" id="L1527">	}</span>

	/**
	 * Return if VTO is full day
	 */
	public boolean getIsVTOFullDay() {
<span class="nc" id="L1533">		return m_timeoffRequest.isVTOFullDay();</span>
	}

	/**
	 * Set if VTO is a partial day
	 */
	public void setIsVTOPartialDay(boolean value) {
<span class="nc" id="L1540">		m_timeoffRequest.setVTOPartialDay(value);</span>
<span class="nc" id="L1541">	}</span>

	/**
	 * Return if VTO is partial day
	 */
	public boolean getIsVTOPartialDay() {
<span class="nc" id="L1547">		return m_timeoffRequest.isVTOPartialDay();</span>
	}

	/**
	 * Set if VTO is a late start
	 */
	public void setIsVTOLateStart(boolean value) {
<span class="nc" id="L1554">		m_timeoffRequest.setVTOLateStart(value);</span>
<span class="nc" id="L1555">	}</span>

	/**
	 * Return if VTO is late start
	 */
	public boolean getIsVTOLateStart() {
<span class="nc" id="L1561">		return m_timeoffRequest.isVTOLateStart();</span>
	}

	/**
	 * Set if VTO is a early off
	 */
	public void setIsVTOEarlyOff(boolean value) {
<span class="nc" id="L1568">		m_timeoffRequest.setVTOEarlyOff(value);</span>
<span class="nc" id="L1569">	}</span>

	/**
	 * Return if VTO is early off
	 */
	public boolean getIsVTOEarlyOff() {
<span class="nc" id="L1575">		return m_timeoffRequest.isVTOEarlyOff();</span>
	}

	/**
	 * Set if VTO is a anytime off
	 */
	public void setIsVTOAnytimeOff(boolean value) {
<span class="nc" id="L1582">		m_timeoffRequest.setVTOAnytimeOff(value);</span>
<span class="nc" id="L1583">	}</span>

	/**
	 * Return if VTO is any time off
	 */
	public boolean getIsVTOAnytimeOff() {
<span class="nc" id="L1589">		return m_timeoffRequest.isVTOAnytimeOff();</span>
	}

	/**
	 * Return Required Html
	 */
	@Override
	public String getRequiredHTML() {
<span class="nc" id="L1597">		StringBuilder sb = new StringBuilder(100);</span>
<span class="nc" id="L1598">		sb.append(super.getRequiredHTML());</span>

<span class="nc bnc" id="L1600" title="All 2 branches missed.">		if (!isManagerMode()) {</span>
<span class="nc" id="L1601">			ID empID = m_context.getUser().getEmployeeID();</span>
<span class="nc" id="L1602">			String requestFor = HtmlUtil.makeHiddenInput(REQUESTED_FOR_FN, empID.toString());</span>
<span class="nc" id="L1603">			sb.append(requestFor);</span>
		}

<span class="nc" id="L1606">		String requestStatus = HtmlUtil.makeHiddenInput(REQUEST_STATUS_FN, m_timeoffRequest.getRequestStatus());</span>
<span class="nc" id="L1607">		sb.append(requestStatus);</span>
		//if (getWaitlistTOChoiceUserRank() != -1) {
<span class="nc" id="L1609">		sb.append(HtmlUtil.makeHiddenInput(WAITLIST_TO_CHOICE, getWaitlistTOChoiceUserRank()));</span>
		//}

<span class="nc bnc" id="L1612" title="All 2 branches missed.">		sb.append(HtmlUtil.makeHiddenInput(&quot;isFromNetStaffingRibbon&quot;, m_isFromNetStaffingRibbon ? &quot;true&quot; : &quot;false&quot;));</span>
<span class="nc bnc" id="L1613" title="All 2 branches missed.">		sb.append(HtmlUtil.makeHiddenInput(&quot;isNewForm&quot;, isNew() ? &quot;true&quot; : &quot;false&quot;));</span>
<span class="nc" id="L1614">		return sb.toString();</span>
	}

	@Override
	public void setSavedRequestID(ID requsetID) {
<span class="nc" id="L1619">		m_isRequestSaved = true;</span>
<span class="nc" id="L1620">		super.setSavedRequestID(requsetID);</span>

<span class="nc bnc" id="L1622" title="All 2 branches missed.">		if (m_isFromNetStaffingRibbon) {</span>
<span class="nc" id="L1623">			setIsRefreshOpenerOnClose(false);</span>
		}
<span class="nc" id="L1625">	}</span>

	//////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	//////////////////////////////////////////////////////////////////////////////
	/**
	 * Return Employee Name By ID or the First One
	 */
	private EmployeeName findEmpNameByID(ID empID) {
<span class="nc" id="L1634">		EmployeeName eName = null;</span>

<span class="nc bnc" id="L1636" title="All 2 branches missed.">		for (Iterator it = m_empNames.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1637">			EmployeeName tmpEName = (EmployeeName) it.next();</span>
			// Keep track of First Employee Name
<span class="nc bnc" id="L1639" title="All 2 branches missed.">			if (eName == null) {</span>
<span class="nc" id="L1640">				eName = tmpEName;</span>
			}

<span class="nc bnc" id="L1643" title="All 2 branches missed.">			if (tmpEName.getID().equals(empID)) {</span>
<span class="nc" id="L1644">				eName = tmpEName;</span>
<span class="nc" id="L1645">				break;</span>
			}
<span class="nc" id="L1647">		}</span>

<span class="nc" id="L1649">		return eName;</span>
	}

	/**
	 * Set the Time Off Waitlist TO ChoiceID to be used
	 */
	public void setWaitlistTOChoiceUserRank(int rank) {
<span class="nc" id="L1656">		waitlistTOChoiceUserRank = rank;</span>
<span class="nc" id="L1657">	}</span>

	/**
	 * Return the Time Off Request
	 */
	public int getWaitlistTOChoiceUserRank() {
<span class="nc" id="L1663">		return waitlistTOChoiceUserRank;</span>
	}

	public boolean isTOChoiceEditDisabled() {
<span class="nc bnc" id="L1667" title="All 6 branches missed.">		return (isEscalatedRequest() || RequestAuditTrail.STATUS_WAITLIST.equals(getRequestStatus()) || m_timeoffTypeList.isEmpty());</span>
	}

	/**
	 * Initialize Component For Display
	 */
	@Override
	public void initForDisplay() {
<span class="nc" id="L1675">		super.initForDisplay();</span>
<span class="nc" id="L1676">		initForDisplayChoiceList();</span>
<span class="nc" id="L1677">	}</span>

	protected void initForDisplayChoiceList() {
		try {
<span class="nc" id="L1681">			int choiceLimit = getMaxNumberOfChoiceAllowed();</span>
<span class="nc bnc" id="L1682" title="All 2 branches missed.">			if (m_choiceListPC != null) {</span>
<span class="nc" id="L1683">				String tableName = m_choiceListPC.getDynamicMultiColList().getName() + &quot;Ref&quot;; //refer MultiColListPC line 773</span>
<span class="nc" id="L1684">				ToolbarPC toolbarPC = m_choiceListPC.getToolbar();</span>
<span class="nc" id="L1685">				String toolbarName = toolbarPC.getName();</span>

<span class="nc" id="L1687">				setAddButtonAttributes(choiceLimit, tableName, toolbarPC, toolbarName);</span>

<span class="nc" id="L1689">				setDeleteButtonAttributes(choiceLimit, tableName, toolbarPC, toolbarName);</span>
			}
<span class="nc" id="L1691">		} catch (Exception ex) {</span>
			//log and ignore the exception
<span class="nc" id="L1693">			log.l7dError(&quot;failed to get max number of choice for employee &quot; + getRequestedFor(), ex);</span>
<span class="nc" id="L1694">		}</span>

<span class="nc" id="L1696">	}</span>

	private void setDeleteButtonAttributes(int choiceLimit, String tableName, ToolbarPC toolbarPC, String toolbarName) {
<span class="nc" id="L1699">		ToolbarTextButton button = (ToolbarTextButton) toolbarPC.getElement(PageAction.DELETE);</span>

<span class="nc bnc" id="L1701" title="All 2 branches missed.">		if (button == null) {</span>
<span class="nc" id="L1702">			return;</span>
		}
<span class="nc bnc" id="L1704" title="All 6 branches missed.">		if (isAdvancedVTORequest || !isNew() || m_timeoffTypeList.isEmpty()) {</span>
<span class="nc" id="L1705">			button.setEnabled(false);</span>
		}
<span class="nc" id="L1707">		button.setAttribute(&quot;choice_limit&quot;, String.valueOf(choiceLimit));</span>
<span class="nc" id="L1708">		String onClickJS = &quot;onClickDeleteChoiceButton(&quot; + toolbarName + &quot;, &quot; + tableName + &quot;, &quot; + choiceLimit + &quot;, this);&quot;;</span>
<span class="nc" id="L1709">		button.getContainer().setOnClick(onClickJS);</span>
<span class="nc" id="L1710">		button.getContainer().setOnDblClick(onClickJS);</span>

<span class="nc" id="L1712">	}</span>

	private void setAddButtonAttributes(int choiceLimit, String tableName, ToolbarPC toolbarPC, String toolbarName) {
<span class="nc" id="L1715">		ToolbarTextButton button = (ToolbarTextButton) toolbarPC.getElement(PageAction.ADD);</span>

<span class="nc bnc" id="L1717" title="All 2 branches missed.">		if (button == null) {</span>
<span class="nc" id="L1718">			return;</span>
		}
<span class="nc bnc" id="L1720" title="All 6 branches missed.">		if (choiceLimit == numberOfChoice || isAdvancedVTORequest || m_timeoffTypeList.isEmpty()) {</span>
<span class="nc" id="L1721">			button.setEnabled(false);</span>
		}

<span class="nc" id="L1724">		button.setAttribute(&quot;choice_limit&quot;, String.valueOf(choiceLimit));</span>
<span class="nc" id="L1725">		String onClickJS = &quot;onClickAddChoiceButton(&quot; + toolbarName + &quot;, &quot; + tableName + &quot;, &quot; + choiceLimit + &quot;, this);&quot;;</span>
<span class="nc" id="L1726">		button.getContainer().setOnClick(onClickJS);</span>
<span class="nc" id="L1727">		button.getContainer().setOnDblClick(onClickJS);</span>

<span class="nc" id="L1729">	}</span>

	private int getMaxNumberOfChoiceAllowed() throws Exception {
<span class="nc" id="L1732">		int maxCount = 1;</span>
<span class="nc" id="L1733">		ID empID = getRequestedFor();</span>
<span class="nc bnc" id="L1734" title="All 6 branches missed.">		if (empID == null &amp;&amp; m_empNames != null &amp;&amp; !m_empNames.isEmpty()) {</span>
<span class="nc bnc" id="L1735" title="All 2 branches missed.">			if (m_empNames.size() &gt; 1) {</span>
<span class="nc" id="L1736">				List sortedENames = new ArrayList(m_empNames);</span>
<span class="nc" id="L1737">				PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>
<span class="nc" id="L1738">				EmployeeName eName = (EmployeeName) sortedENames.iterator().next();</span>
<span class="nc" id="L1739">				empID = eName.getID();</span>
<span class="nc" id="L1740">			} else {</span>
<span class="nc" id="L1741">				EmployeeName eName = m_empNames.iterator().next();</span>
<span class="nc" id="L1742">				empID = eName.getID();</span>
			}
		}
<span class="nc" id="L1745">		OrganizationSetting orgSetting = TimeOffRequestsMH.getOrgSettingForEmployee(getRequestContext(), empID);</span>
<span class="nc bnc" id="L1746" title="All 2 branches missed.">		if (orgSetting != null) {</span>
<span class="nc" id="L1747">			maxCount = orgSetting.getTimeOffChoicesCount();</span>
		}
<span class="nc" id="L1749">		return maxCount;</span>
	}

	private int getTimeOffRoundInterval() {
<span class="nc" id="L1753">		int timeInterval = TIME_INTERVAL;</span>
<span class="nc" id="L1754">		ID empID = getRequestedFor();</span>
<span class="nc bnc" id="L1755" title="All 6 branches missed.">		if (empID == null &amp;&amp; m_empNames != null &amp;&amp; !m_empNames.isEmpty()) {</span>
<span class="nc bnc" id="L1756" title="All 2 branches missed.">			if (m_empNames.size() &gt; 1) {</span>
<span class="nc" id="L1757">				List&lt;EmployeeName&gt; sortedENames = new ArrayList&lt;&gt;(m_empNames);</span>
<span class="nc" id="L1758">				PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>
<span class="nc" id="L1759">				EmployeeName eName = sortedENames.iterator().next();</span>
<span class="nc" id="L1760">				empID = eName.getID();</span>
<span class="nc" id="L1761">			} else {</span>
<span class="nc" id="L1762">				EmployeeName eName = m_empNames.iterator().next();</span>
<span class="nc" id="L1763">				empID = eName.getID();</span>
			}
		}
		try {
<span class="nc" id="L1767">			timeInterval = TimeOffRequestUtil.getSettingTimeOffRoundInterval(getRequestContext(), empID);</span>
<span class="nc" id="L1768">		} catch (Exception e) {</span>
<span class="nc" id="L1769">			handleUnableToLoadDataErrorAndLogAsDebug(LOGGER, e);</span>
<span class="nc" id="L1770">		}</span>
<span class="nc" id="L1771">		return timeInterval;</span>
	}
	/**
	 * Returns an integer representation of the number of selected minutes.
	 * Example: 13:50 will return 362
	 */
	private int calcualateDurationValue(String spinnerValue) {
<span class="nc bnc" id="L1778" title="All 2 branches missed.">		if (spinnerValue == null) {</span>
<span class="nc" id="L1779">			return 0;</span>
		}
		int hours;
		int minutes;
<span class="nc" id="L1783">		String[] splitValues = spinnerValue.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L1784" title="All 2 branches missed.">		if (splitValues.length &lt; 2) {</span>
<span class="nc" id="L1785">			return 0;</span>
		}
<span class="nc" id="L1787">		hours = Integer.parseInt(splitValues[0]);</span>
<span class="nc" id="L1788">		minutes = Integer.parseInt(splitValues[1]);</span>
<span class="nc" id="L1789">		return hours*60 + minutes;</span>
	}
	/**
	 * Return the JavaScript init code required by Page Component.
	 */
	@Override
	public String getJavaScriptInitCode() {
<span class="nc bnc" id="L1796" title="All 2 branches missed.">		if (m_request.getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L1797">			setIsRefreshOpenerOnClose(true);</span>
		}

<span class="nc" id="L1800">		return super.getJavaScriptInitCode() + getOnClickOverrideJavaScript();</span>
	}

	public String getOnClickOverrideJavaScript() {
<span class="nc" id="L1804">		StringBuilder sb = new StringBuilder();</span>

		/* The time off calendar controls should not cause the ribbon selection to be lost */
<span class="nc" id="L1807">		sb.append(&quot;\n\nvar monthDD = document.getElementById('timeOffCalMonth');\n&quot;)</span>
<span class="nc" id="L1808">				.append(&quot;if (monthDD) { monthDD.onchange = function(){notClosingWindow(); timeOffCal.onSelectMonth(this.value);}; }\n&quot;)</span>

<span class="nc" id="L1810">				.append(&quot;var yearDD = document.getElementById('timeOffCalYear');\n&quot;)</span>
<span class="nc" id="L1811">				.append(&quot;if (yearDD) { yearDD.onchange = function(){notClosingWindow(); timeOffCal.onSelectMonth(this.value);}; }\n&quot;)</span>

<span class="nc" id="L1813">				.append(&quot;var prevMonth = document.getElementById('timeOffCalPrev');\n&quot;)</span>
<span class="nc" id="L1814">				.append(&quot;if (prevMonth) { prevMonth.onclick = function(){notClosingWindow(); timeOffCal.onSelectPrev();}; }\n&quot;)</span>

<span class="nc" id="L1816">				.append(&quot;var nextMonth = document.getElementById('timeOffCalNext');\n&quot;)</span>
<span class="nc" id="L1817">				.append(&quot;if (nextMonth) { nextMonth.onclick = function(){notClosingWindow(); timeOffCal.onSelectNext();}; }\n\n&quot;);</span>
<span class="nc" id="L1818">		return sb.toString();</span>
	}
	protected TORequest getSelectedTimeOffRequest(ID requestID) throws BbmFinderException, BbmCreateException, RmHardValidationException, RemoteException{
<span class="nc" id="L1821">		return TimeOffRequestsMH.getTORequest(requestID);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>