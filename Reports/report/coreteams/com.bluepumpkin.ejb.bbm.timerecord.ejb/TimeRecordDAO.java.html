<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeRecordDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.timerecord.ejb</a> &gt; <span class="el_source">TimeRecordDAO.java</span></div><h1>TimeRecordDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.timerecord.ejb;

import java.math.BigDecimal;
import java.sql.Timestamp;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoParam;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.NumberFactory;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.config.model.Config;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeInterval;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecord;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecordEntry;
import com.bluepumpkin.ejb.bbm.util.DateAdjustmentUtil;

import com.bluepumpkin.common.cache.CacheFactory;
import com.bluepumpkin.common.cache.Cache;

/**
 * TimeRecordDAO is not to be accessed by other objects directly. Use default package level restriction.
 */
public class TimeRecordDAO {
	static final String REMAKERCOLNAME = &quot;MODIFIERBPUSERID&quot;;
	static final String APPROVERCOLSTR = &quot;A.APPROVEDBY, A.APPROVEDDATE, &quot;;
	static final String APPROVERCOLNAME = &quot;APPROVEDBY&quot;;
	static final String APPROVETIMECOLNAME = &quot;APPROVEDDATE&quot;;
	static final String ENTRYLASTMOFIDIEAT = &quot;LASTMODIFIEDAT&quot;;

	private static final String MYTIME_EMP_LAST_ACT_CACHE = &quot;MYTIME_EMP_LAST_ACT_CACHE&quot;;
<span class="fc" id="L45">	private static boolean cacheEnabled = true;</span>
<span class="fc" id="L46">	private static boolean m_ignoreFutureData = false; //used to ignore data in the future for data filling project</span>

//	private static boolean m_Init_ResetImmidiateToLastActivity = false;
//	private static boolean m_ResetImmidiateToLastActivity = false;
//	private static DBConfigManager m_DBConfigManager;
	/**
	 * default constructor
	 */
<span class="nc" id="L54">	public TimeRecordDAO() {</span>
<span class="nc" id="L55">	}</span>

	public static void setIgnoreFutureData(boolean ignore) {
<span class="fc" id="L58">		m_ignoreFutureData = ignore;</span>
<span class="fc" id="L59">	}</span>

	/**
	 * Approve a TimeRecord.
	 * &lt;p&gt;
	 * @param record
	 * @param approver
	 * @param vote
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void approveTimeRecord(ID trID, String approver, boolean vote)
			throws JdmoException {
<span class="nc" id="L72">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L74">			int size = 5;</span>
<span class="nc" id="L75">			StringBuffer pStmt = new StringBuffer(&quot;update TIMERECORD set ISAPPROVED=?, LASTMODIFIEDAT=?, &quot;);</span>
<span class="nc" id="L76">			pStmt.append(APPROVETIMECOLNAME).append(&quot;=?,&quot;);</span>
<span class="nc" id="L77">			pStmt.append(APPROVERCOLNAME).append(&quot;=?&quot;);</span>
<span class="nc" id="L78">			pStmt.append(&quot; where ISPOSTED=0 and ID=?&quot;);</span>
<span class="nc" id="L79">			Object[] param = new Object[size];</span>
<span class="nc" id="L80">			param[0] = JdmoParam.getObject(vote);</span>
<span class="nc" id="L81">			param[1] = new Date();</span>
<span class="nc" id="L82">			param[2] = new Date();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">			if (approver != null) {</span>
<span class="nc" id="L84">				param[size - 2] = approver;</span>
			} else {
<span class="nc" id="L86">				param[size - 2] = new JdmoParam(null, Types.VARCHAR);</span>
			}
<span class="nc" id="L88">			param[size - 1] = trID;</span>
<span class="nc" id="L89">			jdmo.executePCommand(pStmt.toString(), param);</span>
		} finally {
<span class="nc" id="L91">			jdmo.cleanUp();</span>
<span class="nc" id="L92">		}</span>
<span class="nc" id="L93">	}</span>

	/**
	 * Approve a TimeRecord and will check multi-user Exception.
	 * &lt;p&gt;
	 * @param record
	 * @param approver
	 * @param vote
	 * @param jdmo
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void approveTimeRecord(TimeRecord record, String approver, boolean vote, Jdmo jdmo)
			throws JdmoException {
<span class="nc" id="L107">		int size = 7;</span>
<span class="nc" id="L108">		StringBuffer pStmt = new StringBuffer(&quot;update TIMERECORD set ISAPPROVED=?, CHANGESTATUS =?, CHANGECOUNTER=?, LASTMODIFIEDAT=?, &quot;);</span>
<span class="nc" id="L109">		pStmt.append(APPROVETIMECOLNAME).append(&quot;=?,&quot;);</span>
<span class="nc" id="L110">		pStmt.append(APPROVERCOLNAME).append(&quot;=?&quot;);</span>
<span class="nc" id="L111">		pStmt.append(&quot; where ISPOSTED=0 and ID=?&quot;);</span>
<span class="nc" id="L112">		Object[] param = new Object[size];</span>
<span class="nc" id="L113">		param[0] = JdmoParam.getObject(vote);</span>
		// if it is 0 promote it to 1, if 1 to 1, then 2 to 2
<span class="nc bnc" id="L115" title="All 2 branches missed.">		param[1] = new Short(record.getSyncStatus() == 0 ? 1 : record.getSyncStatus());</span>
<span class="nc" id="L116">		param[2] = new Long(record.getVersion());</span>
<span class="nc" id="L117">		param[3] = new Date();</span>
<span class="nc" id="L118">		param[4] = new Date();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (approver != null) {</span>
<span class="nc" id="L120">			param[size - 2] = approver;</span>
		} else {
<span class="nc" id="L122">			param[size - 2] = new JdmoParam(null, Types.VARCHAR);</span>
		}
<span class="nc" id="L124">		param[size - 1] = record.getID();</span>
<span class="nc" id="L125">		jdmo.executePCommand(pStmt.toString(), param);</span>
<span class="nc" id="L126">	}</span>

	/**
	 * Approve a TimeRecord and will check Multi-User Exception.
	 * &lt;p&gt;
	 * @param record
	 * @param approver
	 * @param vote
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void approveTimeRecord(TimeRecord record, String approver, boolean vote)
			throws JdmoException {
<span class="nc" id="L139">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L141">			approveTimeRecord(record, approver, vote, jdmo);</span>
		} finally {
<span class="nc" id="L143">			jdmo.cleanUp();</span>
<span class="nc" id="L144">		}</span>
<span class="nc" id="L145">	}</span>

	/**
	 * Check a TimeInterval by a period and work resource ID, which will check the overlap rule and remove those not posted time record.
	 * &lt;p&gt;
	 * @param wrID
	 * @param actID
	 * @param start
	 * @param end
	 * &lt;p&gt;
	 * @return true if the time interval exists, false otherwise
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static boolean checkExistingTimeInterval(ID wrID, ID actID, Timestamp start, Timestamp end)
			throws JdmoException {
<span class="nc" id="L161">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L163">			String pStmt = &quot;select A.ID from TIMERECORD A, TIMERECORDADJUSTMENT B where A.ISPOSTED=0 and A.EMPLOYEEID=? and A.ID=B.TIMERECORDID and B.STARTTIME&lt;? and B.ENDTIME&gt;? and B.ACTIVITYID=?&quot;;</span>
<span class="nc" id="L164">			JdmoQuery jQuery1 = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L165">			jQuery1.setParID(1, wrID);</span>
<span class="nc" id="L166">			jQuery1.setParTimestamp(2, end);</span>
<span class="nc" id="L167">			jQuery1.setParTimestamp(3, start);</span>
<span class="nc" id="L168">			jQuery1.setParID(4, actID);</span>
			// Check if there is any TimeRecord meets the criteria and overlap
<span class="nc" id="L170">			JdmoRowset rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L172">				return true;</span>
			}
<span class="nc" id="L174">			return false;</span>
		} finally {
<span class="nc bnc" id="L176" title="All 6 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L177">				jdmo.cleanUp();</span>
			}
		}
	}

	/**
	 * Used by the UI to create TimeInterval, which will create a new TimeRecord.
	 * &lt;p&gt;
	 * @param interval
	 * &lt;p&gt;
	 * @return the ID for the newly created time interval
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ID createTimeInterval(TimeInterval interval)
			throws JdmoException {
<span class="nc" id="L193">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L195">			HashMap map = new HashMap();</span>
<span class="nc" id="L196">			map.put(&quot;TIMERECORDID&quot;, interval.getParentID());</span>
<span class="nc" id="L197">			map.put(&quot;ACTIVITYID&quot;, interval.getActivityID());</span>
<span class="nc" id="L198">			map.put(&quot;STARTTIME&quot;, TimeZoneUtil.toTimestamp(interval.getStartTime()));</span>
<span class="nc" id="L199">			map.put(&quot;ENDTIME&quot;, TimeZoneUtil.toTimestamp(interval.getEndTime()));</span>
<span class="nc" id="L200">			map.put(&quot;COUNTTOWARDSMINUTES&quot;, new Integer(interval.getDuration()));</span>
<span class="nc" id="L201">			map.put(&quot;TIMESOURCECODE&quot;, new Integer(interval.getTimeSourceCode()));</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">			if (interval.getDescription() != null) {</span>
<span class="nc" id="L203">				map.put(&quot;DESCRIPTION&quot;, interval.getDescription());</span>
			}
<span class="nc" id="L205">			map.put(&quot;ISPAID&quot;, JdmoParam.getObject(interval.getPaid()));</span>
<span class="nc" id="L206">			ID id = jdmo.addBatchInsert(&quot;TIMERECORDADJUSTMENT&quot;, map);</span>
<span class="nc" id="L207">			jdmo.executeBatch();</span>
<span class="nc" id="L208">			return id;</span>
		} finally {
<span class="nc" id="L210">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Used by the UI to create TimeInterval, which will create a new TimeRecord.
	 * &lt;p&gt;
	 * @param record
	 * &lt;p&gt;
	 * @return the ID for the newly created time record
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ID createTimeInterval(TimeRecord record)
			throws JdmoException {
<span class="nc bnc" id="L225" title="All 2 branches missed.">		if (record.getType() != TimeRecord.TIMEINTERVAL) {</span>
<span class="nc" id="L226">			return null;</span>
		}
<span class="nc" id="L228">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L230">			HashMap map = new HashMap();</span>
			// Create the record first
<span class="nc" id="L232">			map.put(&quot;EMPLOYEEID&quot;, record.getEmployeeID());</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">			if (record.getRemarkEmployeeID() != null) {</span>
<span class="nc" id="L234">				map.put(REMAKERCOLNAME, record.getRemarkEmployeeID());</span>
			}
<span class="nc bnc" id="L236" title="All 2 branches missed.">			if (record.getLastModifiedTime() == null) {</span>
<span class="nc" id="L237">				map.put(&quot;LASTMODIFIEDAT&quot;, new Date());</span>
			} else {
<span class="nc" id="L239">				map.put(&quot;LASTMODIFIEDAT&quot;, record.getLastModifiedTime());</span>
			}
<span class="nc bnc" id="L241" title="All 2 branches missed.">			if (record.getDescription() != null) {</span>
<span class="nc" id="L242">				map.put(&quot;REMARK&quot;, record.getDescription());</span>
			}
<span class="nc" id="L244">			map.put(&quot;ISAPPROVED&quot;, JdmoParam.getObject(record.getApprove()));</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">			if (record.getApprove()) {</span>
<span class="nc" id="L246">				map.put(APPROVETIMECOLNAME, new Date());</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">				if (record.getApproverName() != null) {</span>
<span class="nc" id="L248">					map.put(APPROVERCOLNAME, record.getApproverName());</span>
				}
			}
<span class="nc" id="L251">			map.put(&quot;ISPOSTED&quot;, JdmoParam.getObject(record.isLocked()));</span>
<span class="nc" id="L252">			map.put(&quot;CHANGECOUNTER&quot;, new Long(record.getVersion()));</span>
<span class="nc" id="L253">			map.put(&quot;CHANGESTATUS&quot;, new Short(record.getSyncStatus()));</span>
			// If record is approved, need get Approver name
<span class="nc bnc" id="L255" title="All 2 branches missed.">			if (record.getApprove()) {</span>
<span class="nc" id="L256">				map.put(APPROVETIMECOLNAME, new Date());</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">				if (record.getApproverName() != null) {</span>
<span class="nc" id="L258">					map.put(APPROVERCOLNAME, record.getApproverName());</span>
				}
			}
<span class="nc" id="L261">			ID id = jdmo.addBatchInsert(&quot;TIMERECORD&quot;, map);</span>
<span class="nc" id="L262">			record.setID(id);</span>
			// Create the interval
<span class="nc" id="L264">			map.clear();</span>
<span class="nc" id="L265">			TimeInterval interval = (TimeInterval)record.getChild().get(0);</span>
<span class="nc" id="L266">			map.put(&quot;TIMERECORDID&quot;, id);</span>
<span class="nc" id="L267">			map.put(&quot;ACTIVITYID&quot;, interval.getActivityID());</span>
<span class="nc" id="L268">			map.put(&quot;STARTTIME&quot;, TimeZoneUtil.toTimestamp(interval.getStartTime()));</span>
<span class="nc" id="L269">			map.put(&quot;ENDTIME&quot;, TimeZoneUtil.toTimestamp(interval.getEndTime()));</span>
<span class="nc" id="L270">			map.put(&quot;COUNTTOWARDSMINUTES&quot;, new Integer(interval.getDuration()));</span>
<span class="nc" id="L271">			map.put(&quot;TIMESOURCECODE&quot;, new Integer(interval.getTimeSourceCode()));</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">			if (interval.getDescription() != null) {</span>
<span class="nc" id="L273">				map.put(&quot;DESCRIPTION&quot;, interval.getDescription());</span>
			}
<span class="nc" id="L275">			map.put(&quot;ISPAID&quot;, JdmoParam.getObject(interval.getPaid()));</span>
<span class="nc" id="L276">			jdmo.addBatchInsert(&quot;TIMERECORDADJUSTMENT&quot;, map);</span>
<span class="nc" id="L277">			jdmo.executeBatch();</span>
<span class="nc" id="L278">			return id;</span>
		} finally {
<span class="nc" id="L280">			jdmo.cleanUp();</span>
		}
	} //createTimeInterval

	/**
	 * Create a TimeRecordEntry.
	 * &lt;p&gt;
	 * @param entry
	 * @param b_ResetImmidiateToLastActivity
	 * &lt;p&gt;
	 * @return the ID for the newly created time record
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ID createTimeRecordEntry(TimeRecordEntry entry, boolean b_ResetImmidiateToLastActivity)
			throws JdmoException {
<span class="nc" id="L296">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L298">			ID result = createTimeRecordEntry(entry, jdmo);</span>
<span class="nc" id="L299">			entry.setID(result);</span>
<span class="nc" id="L300">			jdmo.executeBatch();</span>

<span class="nc bnc" id="L302" title="All 2 branches missed.">			if (b_ResetImmidiateToLastActivity) {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">				if (entry.getDataSourceID() == null) {</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">					if (entry.getActivityID() != null) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">						if (entry.getActivityID().toString().compareToIgnoreCase(&quot;-4001&quot;) != 0) {</span>
							//record is created manually be user so populate in cache
<span class="nc" id="L307">							setEmpLastActCache(entry.getEmployeeID(), entry.getActivityID());</span>
						}
					}
				}
			}

<span class="nc" id="L313">			return result;</span>
<span class="nc" id="L314">		} catch (Exception e) {</span>
<span class="nc" id="L315">			throw new JdmoException(e);</span>
		} finally {
<span class="nc bnc" id="L317" title="All 4 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L318">				jdmo.cleanUp();</span>
			}
		}
	}

	/**
	 * Create a TimeRecordEntry.
	 * &lt;p&gt;
	 * @param entryList
	 * @param b_ResetImmidiateToLastActivity
	 * &lt;p&gt;
	 * @return an ID collection of newly created time records
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ArrayList createTimeRecordEntry(ArrayList entryList, boolean b_ResetImmidiateToLastActivity)
			throws JdmoException {
<span class="fc" id="L335">		Jdmo jdmo = new Jdmo();</span>

<span class="fc" id="L337">		ArrayList idList = new ArrayList(entryList.size());</span>
		try {
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">			for (Iterator it = entryList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L340">				TimeRecordEntry entry = (TimeRecordEntry)it.next();</span>

<span class="nc bnc" id="L342" title="All 2 branches missed.">				if (b_ResetImmidiateToLastActivity) {</span>
<span class="nc" id="L343">					Cache b_cache = CacheFactory.getCache(MYTIME_EMP_LAST_ACT_CACHE, TimeRecordDAO.class.getClassLoader());</span>

<span class="nc" id="L345">					String sValue = (String)b_cache.get(&quot;Emp_Last_Act&quot; + &quot;_&quot; + entry.getEmployeeID());</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">					if (sValue == null) {</span>
						//last act was not found in cache, look in DB
<span class="nc" id="L348">						ID lastactID = getEmpLastActFromDB(entry.getEmployeeID());</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">						if (lastactID != null) {</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">							if (entry.getActivityID().toString().equals(&quot;-4101&quot;)) {</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">								if (lastactID.toString().compareToIgnoreCase(&quot;-4001&quot;) != 0) {</span>
<span class="nc" id="L352">									entry.setActivityID(lastactID);</span>
								}
							}
						}
<span class="nc" id="L356">					} else {</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">						if (entry.getActivityID().toString().equals(&quot;-4101&quot;)) {</span>
<span class="nc" id="L358">							entry.setActivityID(new ID(sValue));</span>
						}
					}
				}

<span class="nc" id="L363">				ID result = createTimeRecordEntry(entry, jdmo);</span>
<span class="nc" id="L364">				entry.setID(result);</span>
<span class="nc" id="L365">				idList.add(result);</span>
<span class="nc" id="L366">			}</span>
<span class="fc" id="L367">			jdmo.executeBatch();</span>
<span class="fc" id="L368">			return idList;</span>
<span class="nc" id="L369">		} catch (Exception e) {</span>
<span class="nc" id="L370">			throw new JdmoException(e);</span>
		} finally {
<span class="pc bpc" id="L372" title="3 of 4 branches missed.">			if (jdmo != null) {</span>
<span class="pc" id="L373">				jdmo.cleanUp();</span>
			}
		}
	}

	/**
	 * Create a TimeRecordEntry with a predefined Jdmo.
	 * &lt;p&gt;
	 * @param entry
	 * @param jdmo
	 * &lt;p&gt;
	 * @return the ID for the newly created time record
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ID createTimeRecordEntry(TimeRecordEntry entry, Jdmo jdmo)
			throws JdmoException {
<span class="nc" id="L390">		HashMap map = new HashMap(8);</span>

<span class="nc" id="L392">		map.put(&quot;ACTIVITYID&quot;, entry.getActivityID());</span>

<span class="nc bnc" id="L394" title="All 2 branches missed.">		if (entry.getRawTimeEntryID() != null) {</span>
<span class="nc" id="L395">			map.put(&quot;RAWTIMEENTRYID&quot;, entry.getRawTimeEntryID());</span>
		}
<span class="nc" id="L397">		map.put(&quot;TIMERECORDID&quot;, entry.getParentID());</span>
<span class="nc" id="L398">		map.put(&quot;STARTTIME&quot;, entry.getStartTime());</span>
<span class="nc" id="L399">		map.put(&quot;UPDATETIMESTAMP&quot;, BigDecimal.valueOf(entry.getSortTime().getTime()));</span>
<span class="nc" id="L400">		map.put(&quot;TIMESOURCECODE&quot;, new Integer(entry.getTimeSourceCode()));</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">		if (entry.getDescription() != null) {</span>
<span class="nc" id="L402">			map.put(&quot;DESCRIPTION&quot;, entry.getDescription());</span>
		}
<span class="nc" id="L404">		map.put(&quot;ISPAID&quot;, JdmoParam.getObject(entry.getPaid()));</span>
<span class="nc" id="L405">		map.put(&quot;EMPLOYEEID&quot;, entry.getEmployeeID());</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">		if (entry.getLastUpdateTimestamp() != null) {</span>
<span class="nc" id="L407">			map.put(&quot;LASTMODIFIEDAT&quot;, entry.getLastModifiedTime());</span>
		} else {
<span class="nc" id="L409">			map.put(&quot;LASTMODIFIEDAT&quot;, new Date());</span>
		}
<span class="nc bnc" id="L411" title="All 2 branches missed.">		if (entry.getModifier() != null) {</span>
<span class="nc" id="L412">			map.put(&quot;MODIFIEDBY&quot;, entry.getModifier());</span>
		}
<span class="nc bnc" id="L414" title="All 2 branches missed.">		if (entry.getDataSourceID() != null) {</span>
<span class="nc" id="L415">			map.put(&quot;DATASOURCEID&quot;, entry.getDataSourceID());</span>
		}
<span class="nc" id="L417">		ID result = jdmo.addBatchInsert(&quot;TIMEENTRYEVENT&quot;, map);</span>
<span class="nc" id="L418">		entry.setID(result);</span>
<span class="nc" id="L419">		return result;</span>
	}

	/**
	 * Gets the Valid Intervals for workResource.
	 * &lt;p&gt;
	 * @param workResourceID
	 * @param dtStart
	 * @param dtEnd
	 * &lt;p&gt;
	 * @return HashMap, Keyed by WorkResourceID and associated collection of time records
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static HashMap findTimeIntervals(Collection workResourceID, Timestamp dtStart, Timestamp dtEnd)
			throws JdmoException {
<span class="nc" id="L435">		HashMap timeRecords = new HashMap(workResourceID.size());</span>
<span class="nc" id="L436">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L438">			String empInClause = jdmo.createInClause(workResourceID);</span>
<span class="nc" id="L439">			StringBuffer pStmt2 = new StringBuffer(200);</span>
<span class="nc" id="L440">			pStmt2.append(</span>
					&quot;select A.ID, B.ID, C.NAME, D.ID, D.NAME, B.ISPAID, B.DESCRIPTION, A.EMPLOYEEID, B.STARTTIME, B.ENDTIME, FIRSTNAME, LASTNAME, &quot;).
<span class="nc" id="L442">					append(APPROVERCOLSTR).append(REMAKERCOLNAME).append(&quot;, a.LASTMODIFIEDAT, REMARK, ISAPPROVED, ISPOSTED, A.CHANGECOUNTER, CHANGESTATUS, ACTIVITYID, &quot;).</span>
<span class="nc" id="L443">					append(&quot;COUNTTOWARDSMINUTES, TIMESOURCECODE FROM TIMERECORD A, TIMERECORDADJUSTMENT B, ACTIVITY C, ACTIVITYCATEGORY D, EMPLOYEEAM E, PERSON F where A.ID=B.TIMERECORDID and B.ACTIVITYID=C.ID and A.EMPLOYEEID=E.ID and E.PERSONID=F.ID and D.ID=&quot;).</span>
<span class="nc" id="L444">					append(&quot;C.ACTIVITYCATEGORYID and A.ID in (select distinct A.ID from TIMERECORD A, TIMERECORDADJUSTMENT B where A.EMPLOYEEID in&quot;).</span>
<span class="nc" id="L445">					append(empInClause).append(&quot; and A.ID=B.TIMERECORDID and B.STARTTIME&lt;=? and B.ENDTIME&gt;?) order by A.EMPLOYEEID, A.ID, B.STARTTIME asc&quot;);</span>
<span class="nc" id="L446">			JdmoQuery jQuery2 = jdmo.createQuery(pStmt2.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L447">			jQuery2.setParTimestamp(1, dtEnd);</span>
<span class="nc" id="L448">			jQuery2.setParTimestamp(2, dtStart);</span>
			// Load the TimeIntervals
<span class="nc" id="L450">			JdmoRowset rs = jdmo.createRowset(jQuery2, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
			// One TimeRecord can only have one TimeInterval, enforced by index
<span class="nc bnc" id="L452" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L453">				ID empID = rs.getID(8);</span>
<span class="nc" id="L454">				ArrayList trArray = (ArrayList)timeRecords.get(empID);</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">				if (trArray == null) {</span>
<span class="nc" id="L456">					trArray = new ArrayList(1);</span>
				}
<span class="nc" id="L458">				ID key = rs.getID(1);</span>
<span class="nc" id="L459">				TimeRecord record = new TimeRecord(</span>
						key,
						empID,
<span class="nc" id="L462">						rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L463">						TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L464">						rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L465">						TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L466">						rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L467">						rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L468">						rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L469">				record.setEmpFirstName(rs.getString(&quot;FIRSTNAME&quot;));</span>
<span class="nc" id="L470">				record.setEmpLastName(rs.getString(&quot;LASTNAME&quot;));</span>
<span class="nc" id="L471">				record.setType(TimeRecord.TIMEINTERVAL);</span>
<span class="nc" id="L472">				TimeInterval interval = new TimeInterval(</span>
<span class="nc" id="L473">						rs.getID(2),</span>
<span class="nc" id="L474">						rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L475">						TimeZoneUtil.toDate(rs.getTimestamp(9)),</span>
<span class="nc" id="L476">						TimeZoneUtil.toDate(rs.getTimestamp(10)),</span>
<span class="nc" id="L477">						rs.getInt(&quot;COUNTTOWARDSMINUTES&quot;),</span>
<span class="nc" id="L478">						rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L479">						rs.getBoolean(6),</span>
<span class="nc" id="L480">						rs.getString(7),</span>
						record);
<span class="nc" id="L482">				interval.setActivityName(rs.getString(3));</span>
<span class="nc" id="L483">				interval.setActivityCategoryID(rs.getID(4));</span>
<span class="nc" id="L484">				interval.setActivityCategoryName(rs.getString(5));</span>
<span class="nc" id="L485">				record.addChild(interval);</span>
<span class="nc" id="L486">				trArray.add(record);</span>
<span class="nc" id="L487">				timeRecords.put(empID, trArray);</span>
<span class="nc" id="L488">			}</span>
<span class="nc" id="L489">			return timeRecords;</span>
		} finally {
<span class="nc" id="L491">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Return EmployeeID for a given Time Record ID.
	 * &lt;p&gt;
	 * @param trID
	 * &lt;p&gt;
	 * @return an employee ID for the given time record ID
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ID getEmployeeIDWithTimeRecordID(ID trID)
			throws JdmoException {
<span class="nc" id="L506">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L508">			StringBuffer pStmt = new StringBuffer(&quot;select EMPLOYEEID from TIMERECORD where ID=?&quot;);</span>
<span class="nc" id="L509">			JdmoQuery jq = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L510">			jq.setParID(1, trID);</span>
<span class="nc" id="L511">			JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L512">			ID empID = null;</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L514">				empID = rs.getID(1);</span>
			}
<span class="nc" id="L516">			return empID;</span>
		} finally {
<span class="nc" id="L518">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Load all TimeRecord IDs with TimeRecordEntries based on given period for one work resource.
	 * &lt;p&gt;
	 * @param wrID
	 * @param start
	 * @param end
	 * &lt;p&gt;
	 * @return a collection of event IDs for a work resource
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ArrayList getEventIDsForWorkResource(ID wrID, Date start, Date end)
			throws JdmoException {
<span class="nc" id="L535">		Jdmo jdmo = new Jdmo();</span>
<span class="nc" id="L536">		Date end1 = DateAdjustmentUtil.adjustEndDateForDemo(end, m_ignoreFutureData);</span>
		try {
<span class="nc" id="L538">			String pStmt</span>
					= &quot;select distinct A2.ID from TIMERECORD A2, TIMEENTRYEVENT B2 where A2.EMPLOYEEID=? and A2.ID=B2.TIMERECORDID and B2.UPDATETIMESTAMP&lt;? and B2.UPDATETIMESTAMP&gt;=?&quot;;
<span class="nc" id="L540">			JdmoQuery jQuery1 = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L541">			jQuery1.setParID(1, wrID);</span>
<span class="nc" id="L542">			jQuery1.setParLong(2, end1.getTime());</span>
<span class="nc" id="L543">			jQuery1.setParLong(3, start.getTime());</span>
<span class="nc" id="L544">			JdmoRowset rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L545">			ArrayList trArray = new ArrayList();</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L547">				trArray.add(rs.getID(1));</span>
			}
<span class="nc" id="L549">			return trArray;</span>
		} finally {
<span class="nc" id="L551">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Retrieve one Time Record by ID, will check if there is TimeEntry associated with it or not, then check TimeInterval.
	 * &lt;p&gt;
	 * @param timeRecordID
	 * &lt;p&gt;
	 * @return a time record using the given ID
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	public static TimeRecord getTimeRecordByID(ID timeRecordID)
			throws JdmoException {
<span class="nc" id="L566">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L568">			JdmoRowset rs = null;</span>
<span class="nc" id="L569">			StringBuffer sb = new StringBuffer(&quot;SELECT EMPLOYEEID, LASTNAME, FIRSTNAME, &quot;);</span>
<span class="nc" id="L570">			sb.append(TimeRecordDAO.APPROVERCOLSTR).append(TimeRecordDAO.REMAKERCOLNAME);</span>
<span class="nc" id="L571">			sb.append(&quot;, a.LASTMODIFIEDAT, REMARK, ISAPPROVED, ISPOSTED, CHANGESTATUS, &quot;);</span>
<span class="nc" id="L572">			sb.append(&quot;A.CHANGECOUNTER FROM TIMERECORD A, EMPLOYEEAM B, PERSON C WHERE &quot;);</span>
<span class="nc" id="L573">			sb.append(&quot;A.EMPLOYEEID=B.ID and B.PERSONID=C.ID and A.ID=?&quot;);</span>
<span class="nc" id="L574">			JdmoQuery jQuery = jdmo.createQuery(sb.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L575">			jQuery.setParID(1, timeRecordID);</span>
<span class="nc" id="L576">			rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L577">			TimeRecord record = null;</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L579">				record = new TimeRecord(</span>
						timeRecordID,
<span class="nc" id="L581">						rs.getID(&quot;EMPLOYEEID&quot;),</span>
<span class="nc" id="L582">						rs.getID(TimeRecordDAO.REMAKERCOLNAME),</span>
<span class="nc" id="L583">						TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L584">						rs.getString(TimeRecordDAO.APPROVERCOLNAME),</span>
<span class="nc" id="L585">						TimeZoneUtil.toDate(rs.getTimestamp(TimeRecordDAO.APPROVETIMECOLNAME)),</span>
<span class="nc" id="L586">						rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L587">						rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L588">						rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L589">				record.setEmpFirstName(rs.getString(&quot;FIRSTNAME&quot;));</span>
<span class="nc" id="L590">				record.setEmpLastName(rs.getString(&quot;LASTNAME&quot;));</span>
<span class="nc" id="L591">				record.setVersion(rs.getLong(&quot;CHANGECOUNTER&quot;));</span>
<span class="nc" id="L592">				record.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
			}
<span class="nc" id="L594">			rs.close();</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">			if (record != null) {</span>
				// Load Entries first
<span class="nc" id="L597">				StringBuffer buf = new StringBuffer(</span>
						&quot;SELECT B.ID, B.ISPAID, B.DESCRIPTION, C.NAME, D.ID, D.NAME, B.LASTMODIFIEDAT, B.MODIFIEDBY, B.DATASOURCEID, RAWTIMEENTRYID, ACTIVITYID, STARTTIME, UPDATETIMESTAMP, TIMESOURCECODE FROM TIMEENTRYEVENT B, ACTIVITY C, ACTIVITYCATEGORY D WHERE B.TIMERECORDID =? AND B.ACTIVITYID = C.ID AND D.ID = C.ACTIVITYCATEGORYID&quot;);
<span class="nc bnc" id="L599" title="All 2 branches missed.">				if (m_ignoreFutureData) {</span>
<span class="nc" id="L600">					buf.append(&quot; AND UPDATETIMESTAMP&lt;=?&quot;);</span>
				}
<span class="nc" id="L602">				buf.append(&quot; ORDER BY B.UPDATETIMESTAMP ASC&quot;);</span>
<span class="nc" id="L603">				JdmoQuery jQuery2 = jdmo.createQuery(buf.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L604">				jQuery2.setParID(1, timeRecordID);</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">				if (m_ignoreFutureData) {</span>
<span class="nc" id="L606">					jQuery2.setParLong(2, new Date().getTime());</span>
				}
<span class="nc" id="L608">				rs = jdmo.createRowset(jQuery2, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L610">					record.setType(TimeRecord.TIMEENTRY);</span>
					do {
<span class="nc" id="L612">						Date entryStart = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L613">						TimeRecordEntry entry = new TimeRecordEntry(</span>
<span class="nc" id="L614">								rs.getID(1),</span>
<span class="nc" id="L615">								rs.getID(&quot;RAWTIMEENTRYID&quot;),</span>
<span class="nc" id="L616">								rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L617">								rs.getID(&quot;DATASOURCEID&quot;),</span>
								entryStart,
								entryStart,
<span class="nc" id="L620">								new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)),</span>
<span class="nc" id="L621">								rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L622">								rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L623">								rs.getString(&quot;DESCRIPTION&quot;),</span>
								record);
<span class="nc" id="L625">						entry.setActivityName(rs.getString(4));</span>
<span class="nc" id="L626">						entry.setActivityCategoryID(rs.getID(5));</span>
<span class="nc" id="L627">						entry.setActivityCategoryName(rs.getString(6));</span>
<span class="nc" id="L628">						entry.setLastModifiedTime(TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)));</span>
<span class="nc" id="L629">						entry.setModifier(rs.getString(&quot;MODIFIEDBY&quot;));</span>
<span class="nc" id="L630">						ArrayList temp = record.getChild();</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">						if (!temp.isEmpty()) {</span>
<span class="nc" id="L632">							((TimeRecordEntry)temp.get(temp.size() - 1)).setEndTime(entryStart);</span>
						}
<span class="nc" id="L634">						record.addChild(entry);</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">					} while (rs.next());</span>
<span class="nc" id="L636">					rs.close();</span>
				} else {
					// Load TimeInterval
<span class="nc" id="L639">					String pStmt</span>
							= &quot;SELECT B.ID, B.ISPAID, B.DESCRIPTION, C.NAME, D.ID, D.NAME, ACTIVITYID, STARTTIME, ENDTIME, COUNTTOWARDSMINUTES, TIMESOURCECODE FROM TIMERECORDADJUSTMENT B, ACTIVITY C, ACTIVITYCATEGORY D WHERE B.TIMERECORDID =? AND B.ACTIVITYID = C.ID AND D.ID = C.ACTIVITYCATEGORYID ORDER BY B.STARTTIME ASC&quot;;
<span class="nc" id="L641">					jQuery = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L642">					jQuery.setParID(1, timeRecordID);</span>
<span class="nc" id="L643">					rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">					if (rs.next()) {</span>
<span class="nc" id="L645">						record.setType(TimeRecord.TIMEINTERVAL);</span>
						do {
<span class="nc" id="L647">							TimeInterval entry = new TimeInterval(</span>
<span class="nc" id="L648">									rs.getID(1),</span>
<span class="nc" id="L649">									rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L650">									TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;)),</span>
<span class="nc" id="L651">									TimeZoneUtil.toDate(rs.getTimestamp(&quot;ENDTIME&quot;)),</span>
<span class="nc" id="L652">									rs.getInt(&quot;COUNTTOWARDSMINUTES&quot;),</span>
<span class="nc" id="L653">									rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L654">									rs.getBoolean(2),</span>
<span class="nc" id="L655">									rs.getString(3),</span>
									record);
<span class="nc" id="L657">							entry.setActivityName(rs.getString(4));</span>
<span class="nc" id="L658">							entry.setActivityCategoryID(rs.getID(5));</span>
<span class="nc" id="L659">							entry.setActivityCategoryName(rs.getString(6));</span>
<span class="nc" id="L660">							record.addChild(entry);</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">						} while (rs.next());</span>
<span class="nc" id="L662">						rs.close();</span>
					}
				}
			}
<span class="nc" id="L666">			return record;</span>
		} finally {
<span class="nc" id="L668">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Load all TimeRecord with TimeRecordEntries based on given collection of ID.
	 * &lt;p&gt;
	 * @param idCol
	 * &lt;p&gt;
	 * @return a collection of time records based on a collection of time record IDs
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static ArrayList getTimeRecordByIDs(Collection idCol)
			throws JdmoException {
<span class="nc" id="L683">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L685">			StringBuffer pStmt1 = new StringBuffer(&quot;select A.ID, B.ID, C.NAME, D.ID, D.NAME, B.ISPAID, &quot;).append(</span>
<span class="nc" id="L686">					&quot;B.DESCRIPTION, A.EMPLOYEEID, &quot;).append(APPROVERCOLSTR).append(&quot; A.&quot;).append(REMAKERCOLNAME).append(</span>
<span class="nc" id="L687">							&quot;, A.CHANGECOUNTER, a.LASTMODIFIEDAT, REMARK, ISAPPROVED, ISPOSTED, &quot;).append(</span>
<span class="nc" id="L688">							&quot;CHANGESTATUS, RAWTIMEENTRYID, ACTIVITYID, STARTTIME, UPDATETIMESTAMP, TIMESOURCECODE, &quot;).append(</span>
<span class="nc" id="L689">							&quot;B.LASTMODIFIEDAT BLASTMODIFIEDAT, B.MODIFIEDBY BMODIFIEDBY FROM TIMERECORD A, &quot;).append(</span>
<span class="nc" id="L690">							&quot;TIMEENTRYEVENT B, ACTIVITY C, ACTIVITYCATEGORY D &quot;).append(</span>
<span class="nc" id="L691">							&quot; where A.ID=B.TIMERECORDID and B.ACTIVITYID=C.ID and &quot;).append(</span>
<span class="nc" id="L692">							&quot;D.ID=C.ACTIVITYCATEGORYID and A.ID in &quot;).append(jdmo.createInClause(idCol));</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L694">				pStmt1.append(&quot; and B.UPDATETIMESTAMP&lt;=?&quot;);</span>
			}
<span class="nc" id="L696">			pStmt1.append(&quot; order by A.EMPLOYEEID, A.ID, B.UPDATETIMESTAMP asc&quot;);</span>
<span class="nc" id="L697">			JdmoQuery jQuery1 = jdmo.createQuery(pStmt1.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L698">			jQuery1.setParLong(2, new Date().getTime());</span>
<span class="nc" id="L699">			JdmoRowset rs = jdmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L700">			ArrayList trArray = new ArrayList(idCol.size());</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L702">				ID empID = rs.getID(8);</span>
<span class="nc" id="L703">				ID key = rs.getID(1);</span>
<span class="nc" id="L704">				TimeRecord record = null;</span>
<span class="nc" id="L705">				TimeRecord previous = null;</span>
<span class="nc" id="L706">				int last = trArray.size();</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">				if (last == 0) {</span>
<span class="nc" id="L708">					record = new TimeRecord(</span>
							key,
							empID,
<span class="nc" id="L711">							rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L712">							TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L713">							rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L714">							TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L715">							rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L716">							rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L717">							rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L718">					record.setVersion(rs.getLong(10));</span>
<span class="nc" id="L719">					record.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
<span class="nc" id="L720">					trArray.add(record);</span>
<span class="nc" id="L721">					previous = record;</span>
				} else {
<span class="nc" id="L723">					previous = (TimeRecord)trArray.get(last - 1);</span>
				}
				// if it is a new timerecord
<span class="nc bnc" id="L726" title="All 2 branches missed.">				if (!previous.getID().equals(key)) {</span>
<span class="nc" id="L727">					record = new TimeRecord(</span>
							key,
							empID,
<span class="nc" id="L730">							rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L731">							TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L732">							rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L733">							TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L734">							rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L735">							rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L736">							rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L737">					record.setVersion(rs.getLong(10));</span>
<span class="nc" id="L738">					record.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
<span class="nc" id="L739">					trArray.add(record);</span>
				} else {
					// if it is not a new timerecord
<span class="nc" id="L742">					record = previous;</span>
				}
<span class="nc" id="L744">				Date entryStart = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L745">				TimeRecordEntry entry = new TimeRecordEntry(</span>
<span class="nc" id="L746">						rs.getID(2),</span>
<span class="nc" id="L747">						rs.getID(&quot;RAWTIMEENTRYID&quot;),</span>
<span class="nc" id="L748">						rs.getID(&quot;ACTIVITYID&quot;),</span>
						entryStart,
						entryStart,
<span class="nc" id="L751">						new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)),</span>
<span class="nc" id="L752">						rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L753">						rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L754">						rs.getString(7),</span>
						record);
<span class="nc" id="L756">				entry.setActivityName(rs.getString(3));</span>
<span class="nc" id="L757">				entry.setActivityCategoryID(rs.getID(4));</span>
<span class="nc" id="L758">				entry.setActivityCategoryName(rs.getString(5));</span>
<span class="nc" id="L759">				entry.setLastModifiedTime(TimeZoneUtil.toDate(rs.getTimestamp(&quot;BLASTMODIFIEDAT&quot;)));</span>
<span class="nc" id="L760">				entry.setModifier(rs.getString(&quot;BMODIFIEDBY&quot;));</span>
<span class="nc" id="L761">				ArrayList temp = record.getChild();</span>
				// need to set the previous entry's endtime
<span class="nc bnc" id="L763" title="All 2 branches missed.">				if (!temp.isEmpty()) {</span>
<span class="nc" id="L764">					TimeRecordEntry lastEntry = (TimeRecordEntry)temp.get(temp.size() - 1);</span>
<span class="nc" id="L765">					lastEntry.setEndTime(entryStart);</span>
				}
				// add the new entry directly
<span class="nc" id="L768">				record.addChild(entry);</span>
<span class="nc" id="L769">			}</span>
<span class="nc" id="L770">			return trArray;</span>
		} finally {
<span class="nc" id="L772">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * The optimistic locking of TimeRecord for TimeRecordEntry Operations,
	 * used internally for all create/update time record entry operation.
	 * This version retrieves basic information of TimeRecord/TimeRecordEntry.
	 * TODO: Change it to pessimistic locking
	 * &lt;p&gt;
	 * @param timeRecordID
	 * &lt;p&gt;
	 * @return TimeRecord
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static TimeRecord getTimeRecordForUpdate(ID timeRecordID)
			throws JdmoException {
<span class="nc" id="L790">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L792">			Object[] param = new Object[1];</span>
<span class="nc" id="L793">			param[0] = timeRecordID;</span>
			// Select for update, obtain the current TimeRecord status
<span class="nc" id="L795">			jdmo.executePCommand(&quot;update TIMERECORD set REMARK=REMARK where ID=?&quot;, param);</span>
<span class="nc" id="L796">			JdmoRowset rs = null;</span>
<span class="nc" id="L797">			StringBuffer pStmt = new StringBuffer(&quot;select a.EMPLOYEEID, &quot;).append(APPROVERCOLSTR);</span>
<span class="nc" id="L798">			pStmt.append(REMAKERCOLNAME).append(&quot;, a.LASTMODIFIEDAT, REMARK, &quot;).append(</span>
<span class="nc" id="L799">					&quot;ISAPPROVED, ISPOSTED, CHANGESTATUS, CHANGECOUNTER, &quot;).append(</span>
<span class="nc" id="L800">							&quot;B.ID, DATASOURCEID, RAWTIMEENTRYID, ACTIVITYID, STARTTIME, UPDATETIMESTAMP, &quot;).append(</span>
<span class="nc" id="L801">							&quot;TIMESOURCECODE, ISPAID, DESCRIPTION, b.LASTMODIFIEDAT BLASTMODIFIEDAT, b.MODIFIEDBY BMODIFIEDBY &quot;).append(</span>
							&quot;from TIMERECORD a, TIMEENTRYEVENT b where a.ID=? and a.ID=b.TIMERECORDID &quot;);
<span class="nc bnc" id="L803" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L804">				pStmt.append(&quot;and UPDATETIMESTAMP&lt;=? &quot;);</span>
			}
<span class="nc" id="L806">			pStmt.append(&quot;order by b.UPDATETIMESTAMP asc&quot;);</span>
<span class="nc" id="L807">			JdmoQuery jQuery = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L808">			jQuery.setParID(1, timeRecordID);</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L810">				jQuery.setParLong(2, new Date().getTime());</span>
			}
<span class="nc" id="L812">			rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L813">			TimeRecord record = null;</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">				if (record == null) {</span>
<span class="nc" id="L816">					record = new TimeRecord(</span>
							timeRecordID,
<span class="nc" id="L818">							rs.getID(&quot;EMPLOYEEID&quot;),</span>
<span class="nc" id="L819">							rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L820">							TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L821">							rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L822">							TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L823">							rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L824">							rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L825">							rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L826">					record.setVersion(rs.getLong(&quot;CHANGECOUNTER&quot;));</span>
<span class="nc" id="L827">					record.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
				}
<span class="nc" id="L829">				Date entryStart = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L830">				TimeRecordEntry entry = new TimeRecordEntry(</span>
<span class="nc" id="L831">						rs.getID(&quot;ID&quot;),</span>
<span class="nc" id="L832">						rs.getID(&quot;RAWTIMEENTRYID&quot;),</span>
<span class="nc" id="L833">						rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L834">						rs.getID(&quot;DATASOURCEID&quot;),</span>
						entryStart,
						entryStart, // EndTime is the same as StartTime
<span class="nc" id="L837">						new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)),</span>
<span class="nc" id="L838">						rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L839">						rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L840">						rs.getString(&quot;DESCRIPTION&quot;),</span>
						record);
<span class="nc" id="L842">				entry.setLastModifiedTime(TimeZoneUtil.toDate(rs.getTimestamp(&quot;BLASTMODIFIEDAT&quot;)));</span>
<span class="nc" id="L843">				entry.setModifier(rs.getString(&quot;BMODIFIEDBY&quot;));</span>
<span class="nc" id="L844">				ArrayList temp = record.getChild();</span>
				// Adjust EndTime of previous Entry
<span class="nc bnc" id="L846" title="All 2 branches missed.">				if (!temp.isEmpty()) {</span>
<span class="nc" id="L847">					((TimeRecordEntry)temp.get(temp.size() - 1)).setEndTime(entryStart);</span>
				}
				// Add the entry directly into TimeRecord
<span class="nc" id="L850">				record.addChild(entry);</span>
<span class="nc" id="L851">			}</span>
<span class="nc" id="L852">			return record;</span>
		} finally {
<span class="nc" id="L854">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * The optimistic locking of TimeRecord for TimeRecordEntry Operations,
	 * used internally for all create/update timerecord entry operation.
	 * This version retrieves basic information of TimeRecord/TimeRecordEntry.
	 * It will check the version, early detect the version.
	 * If there is version mismatch, will return null.
	 * The danger is, it cannot tell the difference between
	 * TimeRecord Removed(ID is gone) or Version mismatch.
	 * But in most cases, it is version mismatch.
	 * &lt;p&gt;
	 * @param timeRecordID
	 * @param version
	 * @param interval
	 * &lt;p&gt;
	 * @return TimeRecord
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static TimeRecord getTimeRecordForUpdate(ID timeRecordID, long version, boolean interval)
			throws JdmoException {
<span class="nc" id="L878">		TimeRecord record = null;</span>
<span class="nc" id="L879">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L881" title="All 2 branches missed.">			if (!interval) {</span>
				// Only retrieve TimeEntry
<span class="nc" id="L883">				StringBuffer pStmt = new StringBuffer(</span>
<span class="nc" id="L884">						&quot;select a.EMPLOYEEID, &quot;).append(APPROVERCOLSTR).append(REMAKERCOLNAME).append(&quot;, a.LASTMODIFIEDAT, REMARK, &quot;).append(</span>
<span class="nc" id="L885">								&quot;ISAPPROVED, ISPOSTED, CHANGESTATUS, b.ID, b.DATASOURCEID, RAWTIMEENTRYID, ACTIVITYID, &quot;).append(</span>
<span class="nc" id="L886">								&quot;STARTTIME, UPDATETIMESTAMP, TIMESOURCECODE, ISPAID, DESCRIPTION, &quot;).append(</span>
<span class="nc" id="L887">								&quot;b.LASTMODIFIEDAT BLASTMODIFIEDAT, b.MODIFIEDBY BMODIFIEDBY from TIMERECORD a, &quot;).append(</span>
<span class="nc" id="L888">								&quot;TIMEENTRYEVENT b where a.ID=? and a.CHANGECOUNTER=? &quot;).append(</span>
								&quot;and a.ID = b.TIMERECORDID &quot;);
<span class="nc bnc" id="L890" title="All 2 branches missed.">				if (m_ignoreFutureData) {</span>
<span class="nc" id="L891">					pStmt.append(&quot;and b.UPDATETIMESTAMP&lt;=? &quot;);</span>
				}
<span class="nc" id="L893">				pStmt.append(&quot;order by b.UPDATETIMESTAMP asc&quot;);</span>
<span class="nc" id="L894">				JdmoQuery jQuery = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L895">				jQuery.setParID(1, timeRecordID);</span>
<span class="nc" id="L896">				jQuery.setParLong(2, version);</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">				if (m_ignoreFutureData) {</span>
<span class="nc" id="L898">					jQuery.setParLong(3, new Date().getTime());</span>
				}
<span class="nc" id="L900">				JdmoRowset rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">					if (record == null) {</span>
<span class="nc" id="L903">						record = new TimeRecord(</span>
								timeRecordID,
<span class="nc" id="L905">								rs.getID(&quot;EMPLOYEEID&quot;),</span>
<span class="nc" id="L906">								rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L907">								TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L908">								rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L909">								TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L910">								rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L911">								rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L912">								rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L913">						record.setVersion(version);</span>
<span class="nc" id="L914">						record.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
					}
<span class="nc" id="L916">					Date entryStart = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L917">					TimeRecordEntry entry = new TimeRecordEntry(</span>
<span class="nc" id="L918">							rs.getID(&quot;ID&quot;),</span>
<span class="nc" id="L919">							rs.getID(&quot;RAWTIMEENTRYID&quot;),</span>
<span class="nc" id="L920">							rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L921">							rs.getID(&quot;DATASOURCEID&quot;),</span>
							entryStart,
							entryStart, // EndTime is the same as StartTime
<span class="nc" id="L924">							new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)),</span>
<span class="nc" id="L925">							rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L926">							rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L927">							rs.getString(&quot;DESCRIPTION&quot;),</span>
							record);
<span class="nc" id="L929">					entry.setLastModifiedTime(TimeZoneUtil.toDate(rs.getTimestamp(&quot;BLASTMODIFIEDAT&quot;)));</span>
<span class="nc" id="L930">					entry.setModifier(rs.getString(&quot;BMODIFIEDBY&quot;));</span>
<span class="nc" id="L931">					entry.setEmployeeID(record.getEmployeeID());</span>
<span class="nc" id="L932">					ArrayList temp = record.getChild();</span>
					// Adjust EndTime of previous Entry
<span class="nc bnc" id="L934" title="All 2 branches missed.">					if (!temp.isEmpty()) {</span>
<span class="nc" id="L935">						((TimeRecordEntry)temp.get(temp.size() - 1)).setEndTime(entryStart);</span>
					}
					// Add the entry directly into TimeRecord
<span class="nc" id="L938">					record.addChild(entry);</span>
<span class="nc" id="L939">				}</span>
<span class="nc" id="L940">				rs.close();</span>
<span class="nc" id="L941">			} else {</span>
				// Only retrieve TimeInterval
				// Load TimeInterval
<span class="nc" id="L944">				StringBuffer pStmt = new StringBuffer(</span>
<span class="nc" id="L945">						&quot;select a.EMPLOYEEID, &quot;).append(APPROVERCOLSTR).append(REMAKERCOLNAME).append(&quot;, a.LASTMODIFIEDAT, REMARK, &quot;).append(</span>
<span class="nc" id="L946">								&quot;ISAPPROVED, ISPOSTED, CHANGESTATUS, B.ID, &quot;).append(</span>
<span class="nc" id="L947">								&quot;ACTIVITYID, STARTTIME, ENDTIME, COUNTTOWARDSMINUTES, &quot;).append(</span>
<span class="nc" id="L948">								&quot;TIMESOURCECODE, ISPAID, DESCRIPTION from TIMERECORD a, &quot;).append(</span>
<span class="nc" id="L949">								&quot;TIMERECORDADJUSTMENT b where a.ID=? and a.CHANGECOUNTER=? &quot;).append(</span>
								&quot;and a.ID = b.TIMERECORDID order by b.STARTTIME asc&quot;);
<span class="nc" id="L951">				JdmoQuery jQuery = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L952">				jQuery.setParID(1, timeRecordID);</span>
<span class="nc" id="L953">				jQuery.setParLong(2, version);</span>
<span class="nc" id="L954">				JdmoRowset rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">					if (record == null) {</span>
<span class="nc" id="L957">						record = new TimeRecord(</span>
								timeRecordID,
<span class="nc" id="L959">								rs.getID(&quot;EMPLOYEEID&quot;),</span>
<span class="nc" id="L960">								rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L961">								TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L962">								rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L963">								TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L964">								rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L965">								rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L966">								rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L967">						record.setVersion(version);</span>
<span class="nc" id="L968">						record.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
					}
<span class="nc" id="L970">					TimeInterval intv = new TimeInterval(</span>
<span class="nc" id="L971">							rs.getID(&quot;ID&quot;),</span>
<span class="nc" id="L972">							rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L973">							TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;)),</span>
<span class="nc" id="L974">							TimeZoneUtil.toDate(rs.getTimestamp(&quot;ENDTIME&quot;)),</span>
<span class="nc" id="L975">							rs.getInt(&quot;COUNTTOWARDSMINUTES&quot;),</span>
<span class="nc" id="L976">							rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L977">							rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L978">							rs.getString(&quot;DESCRIPTION&quot;),</span>
							record);
<span class="nc" id="L980">					record.addChild(intv);</span>
<span class="nc" id="L981">				}</span>
<span class="nc" id="L982">				rs.close();</span>
			}
<span class="nc" id="L984">			return record;</span>
		} finally {
<span class="nc" id="L986">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Initial design is to use &quot;select for update&quot; pessimistic lock.
	 * Switched to Optimistic locking mechanism now.
	 * &lt;p&gt;
	 * @param id
	 * &lt;p&gt;
	 * @return TimeRecord
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static TimeRecord getTimeRecordForUpdateOnly(ID id)
			throws JdmoException {
<span class="nc" id="L1002">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1004">			StringBuffer pStmt = new StringBuffer(&quot;select EMPLOYEEID, &quot;);</span>
<span class="nc" id="L1005">			pStmt.append(APPROVERCOLSTR);</span>
<span class="nc" id="L1006">			pStmt.append(REMAKERCOLNAME).append(&quot;, LASTMODIFIEDAT, REMARK, ISAPPROVED, ISPOSTED, CHANGECOUNTER, CHANGESTATUS from TIMERECORD A where ID=?&quot;);</span>
<span class="nc" id="L1007">			JdmoQuery jq = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L1008">			jq.setParID(1, id);</span>
<span class="nc" id="L1009">			JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L1010">			TimeRecord tr = null;</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1012">				tr = new TimeRecord(id,</span>
<span class="nc" id="L1013">						rs.getID(&quot;EMPLOYEEID&quot;),</span>
<span class="nc" id="L1014">						rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L1015">						TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L1016">						rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L1017">						TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L1018">						rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L1019">						rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L1020">						rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L1021">				tr.setVersion(rs.getLong(&quot;CHANGECOUNTER&quot;));</span>
<span class="nc" id="L1022">				tr.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
			}
<span class="nc bnc" id="L1024" title="All 2 branches missed.">			if (rs != null) {</span>
				try {
<span class="nc" id="L1026">					rs.close();</span>
<span class="nc" id="L1027">				} catch (Exception e) {</span>
<span class="nc" id="L1028">				}</span>
			}
<span class="nc" id="L1030">			return tr;</span>
		} finally {
<span class="nc" id="L1032">			jdmo.cleanUp();</span>
		}
	} //getTimeRecordForUpdateOnly

	/**
	 * Using pessimistic locking, lock TimeRecord based on its entry ID.
	 * &lt;p&gt;
	 * @param entryID
	 * &lt;p&gt;
	 * @return TimeRecord
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static TimeRecord getTimeRecordForUpdateOnlyByEntryID(ID entryID)
			throws JdmoException {
<span class="nc" id="L1047">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1049">			StringBuffer pStmt = new StringBuffer(&quot;select ID, EMPLOYEEID, &quot;);</span>
<span class="nc" id="L1050">			pStmt.append(APPROVERCOLSTR);</span>
<span class="nc" id="L1051">			pStmt.append(REMAKERCOLNAME).append(&quot;, LASTMODIFIEDAT, REMARK, ISAPPROVED, ISPOSTED, CHANGECOUNTER, CHANGESTATUS from TIMERECORD where ID=(select timerecordid from TIMEENTRYEVENT A, TIMERECORD B where A.ID=? and A.TIMERECORDID=B.ID)&quot;);</span>
<span class="nc" id="L1052">			JdmoQuery jq = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L1053">			jq.setParID(1, entryID);</span>
<span class="nc" id="L1054">			JdmoRowset rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L1055">			TimeRecord tr = null;</span>
<span class="nc bnc" id="L1056" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1057">				tr = new TimeRecord(rs.getID(&quot;ID&quot;),</span>
<span class="nc" id="L1058">						rs.getID(&quot;EMPLOYEEID&quot;),</span>
<span class="nc" id="L1059">						rs.getID(REMAKERCOLNAME),</span>
<span class="nc" id="L1060">						TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)),</span>
<span class="nc" id="L1061">						rs.getString(APPROVERCOLNAME),</span>
<span class="nc" id="L1062">						TimeZoneUtil.toDate(rs.getTimestamp(APPROVETIMECOLNAME)),</span>
<span class="nc" id="L1063">						rs.getString(&quot;REMARK&quot;),</span>
<span class="nc" id="L1064">						rs.getBoolean(&quot;ISAPPROVED&quot;),</span>
<span class="nc" id="L1065">						rs.getBoolean(&quot;ISPOSTED&quot;));</span>
<span class="nc" id="L1066">				tr.setVersion(rs.getLong(&quot;CHANGECOUNTER&quot;));</span>
<span class="nc" id="L1067">				tr.setSyncStatus(rs.getShort(&quot;CHANGESTATUS&quot;));</span>
			}
<span class="nc bnc" id="L1069" title="All 2 branches missed.">			if (rs != null) {</span>
				try {
<span class="nc" id="L1071">					rs.close();</span>
<span class="nc" id="L1072">				} catch (Exception e) {</span>
<span class="nc" id="L1073">				}</span>
			}
<span class="nc" id="L1075">			return tr;</span>
		} finally {
<span class="nc" id="L1077">			jdmo.cleanUp();</span>
		}
	} //getTimeRecordForUpdateOnlyByEntryID

	/**
	 * Check if there is an open TimeRecord just before a given date.
	 * &lt;p&gt;
	 * @param trID
	 * @param dtStart
	 * &lt;p&gt;
	 * @return true if the shift is open, false otherwise
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static boolean isOpenShift(ID trID, Date dtStart)
			throws JdmoException {
<span class="nc" id="L1093">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1095">			StringBuffer pStmt = new StringBuffer(&quot;select ID from TIMEENTRYEVENT where TIMERECORDID=? and UPDATETIMESTAMP&gt;=? and ACTIVITYID=-4001&quot;);</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L1097">				pStmt.append(&quot; and UPDATETIMESTAMP&lt;?&quot;);</span>
			}
<span class="nc" id="L1099">			JdmoQuery jQuery = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L1100">			jQuery.setParID(1, trID);</span>
<span class="nc" id="L1101">			jQuery.setParLong(2, dtStart.getTime());</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L1103">				jQuery.setParLong(3, new Date().getTime());</span>
			}
<span class="nc" id="L1105">			JdmoRowset rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L1106" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1107">				return false;</span>
			}
<span class="nc" id="L1109">			return true;</span>
		} finally {
<span class="nc" id="L1111">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Tries to get the SyncStatus of the TimeRecord.
	 * &lt;p&gt;
	 * @param ID,
	 * &lt;p&gt;
	 * @return boolean
	 * &lt;p&gt;
	 * @exception JdmoException, any DB system level exception
	 * @exception BbmObjectNotFoundException, if TimeRecord no longer exist
	 */
	static boolean isTimeRecordModified(ID id)
			throws JdmoException, BbmObjectNotFoundException {
<span class="nc" id="L1127">		Jdmo jdmo = new Jdmo();</span>
<span class="nc" id="L1128">		JdmoRowset rs = null;</span>
		try {
<span class="nc" id="L1130">			String pStmt = &quot;select CHANGESTATUS from TIMERECORD where ID=?&quot;;</span>
<span class="nc" id="L1131">			JdmoQuery jq = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L1132">			jq.setParID(1, id);</span>
<span class="nc" id="L1133">			rs = jdmo.createRowset(jq, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L1134" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1135">				short status = rs.getShort(&quot;CHANGESTATUS&quot;);</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">				return (status == 0) ? false : true;</span>
			}
<span class="nc" id="L1138">			throw new BbmObjectNotFoundException();</span>
		} finally {
<span class="nc bnc" id="L1140" title="All 4 branches missed.">			if (rs != null) {</span>
				try {
<span class="nc" id="L1142">					rs.close();</span>
<span class="nc" id="L1143">				} catch (Exception e) {</span>
<span class="nc" id="L1144">				}</span>
			}
<span class="nc bnc" id="L1146" title="All 4 branches missed.">			if (jdmo != null) {</span>
<span class="nc" id="L1147">				jdmo.cleanUp();</span>
			}
		}
	} //isTimeRecordModified

	/**
	 * Update an existing TimeRecordEntry without knowing the TimeRecordID.
	 * Provided for BPX quick update for previous entry's activity.
	 * &lt;p&gt;
	 * @param entry
	 * &lt;p&gt;
	 * @return the number of rows that were modified by the executed Jdmo.executePCommand method
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static int quickUpdateTimeRecordEntry(TimeRecordEntry entry)
			throws JdmoException {
<span class="nc" id="L1164">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1166">			String pStmt = null;</span>
<span class="nc" id="L1167">			Object[] param = new Object[3];</span>
<span class="nc bnc" id="L1168" title="All 2 branches missed.">			if (entry.getRawTimeEntryID() != null) {</span>
<span class="nc" id="L1169">				pStmt = &quot;update TIMEENTRYEVENT set ACTIVITYID=?, ISPAID=? where RAWTIMEENTRYID=?&quot;;</span>
<span class="nc" id="L1170">				param[2] = entry.getRawTimeEntryID();</span>
			} else {
<span class="nc" id="L1172">				pStmt = &quot;update TIMEENTRYEVENT set ACTIVITYID=?, ISPAID=? where ID=?&quot;;</span>
<span class="nc" id="L1173">				param[2] = entry.getID();</span>
			}
<span class="nc" id="L1175">			param[0] = entry.getActivityID();</span>
<span class="nc" id="L1176">			param[1] = JdmoParam.getObject(entry.getPaid());</span>
<span class="nc" id="L1177">			return jdmo.executePCommand(pStmt, param);</span>
		} finally {
<span class="nc" id="L1179">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Update an existing TimeRecordEntry without knowing the TimeRecordID.
	 * Provided for BPX quick update for previous entry's activity.
	 * &lt;p&gt;
	 * @param entry
	 * @param jdmo
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static int quickUpdateTimeRecordEntry(TimeRecordEntry entry, Jdmo jdmo)
			throws JdmoException {
<span class="nc" id="L1194">		String pStmt = null;</span>
<span class="nc" id="L1195">		Object[] param = new Object[3];</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">		if (entry.getRawTimeEntryID() != null) {</span>
<span class="nc" id="L1197">			pStmt = &quot;update TIMEENTRYEVENT set ACTIVITYID=?, ISPAID=? where RAWTIMEENTRYID=?&quot;;</span>
<span class="nc" id="L1198">			param[2] = entry.getRawTimeEntryID();</span>
		} else {
<span class="nc" id="L1200">			pStmt = &quot;update TIMEENTRYEVENT set ACTIVITYID=?, ISPAID=? where ID=?&quot;;</span>
<span class="nc" id="L1201">			param[2] = entry.getID();</span>
		}
<span class="nc" id="L1203">		param[0] = entry.getActivityID();</span>
<span class="nc" id="L1204">		param[1] = JdmoParam.getObject(entry.getPaid());</span>
<span class="nc" id="L1205">		return jdmo.executePCommand(pStmt, param);</span>
	}

	/**
	 * Used by the UI to refresh a TimeRecord, which cleans up all entries first.
	 * &lt;p&gt;
	 * @param record
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void refreshTimeRecord(TimeRecord record)
			throws JdmoException {
<span class="nc bnc" id="L1217" title="All 4 branches missed.">		if (record.getID() == null || record.getType() != TimeRecord.TIMEENTRY) {</span>
<span class="nc" id="L1218">			return;</span>
		}
<span class="nc" id="L1220">		ArrayList child = record.getChild();</span>
<span class="nc bnc" id="L1221" title="All 4 branches missed.">		if (child == null || child.isEmpty()) {</span>
<span class="nc" id="L1222">			return;</span>
		}
<span class="nc" id="L1224">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1226">			String pStmt = &quot;delete TIMEENTRYEVENT where TIMERECORDID=?&quot;;</span>
<span class="nc" id="L1227">			Object[] param = new Object[1];</span>
<span class="nc" id="L1228">			param[0] = record.getID();</span>
<span class="nc" id="L1229">			jdmo.executePCommand(pStmt, param);</span>
<span class="nc" id="L1230">			HashMap map = new HashMap(8);</span>
<span class="nc bnc" id="L1231" title="All 2 branches missed.">			for (Iterator it = child.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1232">				TimeRecordEntry entry = (TimeRecordEntry)it.next();</span>
<span class="nc bnc" id="L1233" title="All 2 branches missed.">				if (entry.getID() != null) {</span>
<span class="nc" id="L1234">					map.put(&quot;ID&quot;, entry.getID());</span>
				}
<span class="nc" id="L1236">				map.put(&quot;ACTIVITYID&quot;, entry.getActivityID());</span>
<span class="nc bnc" id="L1237" title="All 2 branches missed.">				if (entry.getRawTimeEntryID() != null) {</span>
<span class="nc" id="L1238">					map.put(&quot;RAWTIMEENTRYID&quot;, entry.getRawTimeEntryID());</span>
				}
<span class="nc" id="L1240">				map.put(&quot;TIMERECORDID&quot;, record.getID());</span>
<span class="nc" id="L1241">				map.put(&quot;STARTTIME&quot;, entry.getStartTime());</span>
<span class="nc" id="L1242">				map.put(&quot;UPDATETIMESTAMP&quot;, BigDecimal.valueOf(entry.getSortTime().getTime()));</span>
<span class="nc" id="L1243">				map.put(&quot;TIMESOURCECODE&quot;, NumberFactory.newInteger(entry.getTimeSourceCode()));</span>
<span class="nc bnc" id="L1244" title="All 2 branches missed.">				if (entry.getDescription() != null) {</span>
<span class="nc" id="L1245">					map.put(&quot;DESCRIPTION&quot;, entry.getDescription());</span>
				}
<span class="nc" id="L1247">				map.put(&quot;ISPAID&quot;, JdmoParam.getObject(entry.getPaid()));</span>
<span class="nc bnc" id="L1248" title="All 2 branches missed.">				if (entry.getLastModifiedTime() != null) {</span>
<span class="nc" id="L1249">					map.put(&quot;LASTMODIFIEDAT&quot;, entry.getLastModifiedTime());</span>
				} else {
<span class="nc" id="L1251">					map.put(&quot;LASTMODIFIEDAT&quot;, new Date());</span>
				}
<span class="nc bnc" id="L1253" title="All 2 branches missed.">				if (entry.getDataSourceID() != null) {</span>
<span class="nc" id="L1254">					map.put(&quot;DATASOURCEID&quot;, entry.getDataSourceID());</span>
				}
<span class="nc" id="L1256">				jdmo.addBatchInsert(&quot;TIMEENTRYEVENT&quot;, map);</span>
<span class="nc" id="L1257">				map.clear();</span>
<span class="nc" id="L1258">			}</span>
<span class="nc" id="L1259">			jdmo.executeBatch();</span>
		} finally {
<span class="nc" id="L1261">			jdmo.cleanUp();</span>
<span class="nc" id="L1262">		}</span>
<span class="nc" id="L1263">	} //cleanTimeRecord</span>

	/**
	 * Remove a TimeInterval by ID.
	 * &lt;p&gt;
	 * @param id
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void removeTimeInterval(ID id)
			throws JdmoException {
<span class="nc" id="L1274">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L1276" title="All 2 branches missed.">			if (id != null) {</span>
<span class="nc" id="L1277">				ArrayList trCol = new ArrayList(1);</span>
<span class="nc" id="L1278">				trCol.add(id);</span>
<span class="nc" id="L1279">				DAOUtil.deleteObjects(jdmo, &quot;TIMERECORDADJUSTMENT&quot;, trCol);</span>
			}
		} finally {
<span class="nc" id="L1282">			jdmo.cleanUp();</span>
<span class="nc" id="L1283">		}</span>
<span class="nc" id="L1284">	}</span>

	/**
	 * Remove a TimeInterval by a period and workresource ID,
	 * which will check the overlap rule, and remove those not posted timerecord.
	 * &lt;p&gt;
	 * @param wrID
	 * @param type
	 * @param activityCol
	 * @param start
	 * @param end
	 * @param overlap
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void removeTimeInterval(
			ID wrID,
			int type,
			Collection activityCol,
			Timestamp start,
			Timestamp end,
			int overlap)
			throws JdmoException {
<span class="nc" id="L1307">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1309">			StringBuffer pStmt = new StringBuffer(400);</span>
<span class="nc bnc" id="L1310" title="All 3 branches missed.">			switch (overlap) {</span>
				case Config.STARTSIN:
<span class="nc" id="L1312">					pStmt.append(&quot;select A.ID from TIMERECORD A, TIMERECORDADJUSTMENT B where A.ISPOSTED=0 &quot;).</span>
<span class="nc" id="L1313">							append(&quot;and A.EMPLOYEEID=&quot;).append(wrID).append(&quot; and A.ID=B.TIMERECORDID&quot;);</span>
<span class="nc bnc" id="L1314" title="All 2 branches missed.">					if (type != 0) {</span>
<span class="nc" id="L1315">						pStmt.append(&quot; and B.TIMESOURCECODE=&quot;).append(type);</span>
					}
<span class="nc" id="L1317">					pStmt.append(&quot; and B.STARTTIME&gt;='&quot;).append(JdmoUtil.formatDBString(start)).append(&quot;' and B.STARTTIME&lt;'&quot;).append(JdmoUtil.formatDBString(end)).append(&quot;'&quot;);</span>
<span class="nc bnc" id="L1318" title="All 4 branches missed.">					if (activityCol != null &amp;&amp; !activityCol.isEmpty()) {</span>
<span class="nc" id="L1319">						pStmt.append(&quot; and B.ACTIVITYID in &quot;).append(jdmo.createInClause(activityCol));</span>
					}
<span class="nc" id="L1321">					DAOUtil.deleteObjects(jdmo, &quot;TIMERECORD&quot;, pStmt.toString());</span>
<span class="nc" id="L1322">					break;</span>
				case Config.ENDSIN:
<span class="nc" id="L1324">					pStmt.append(&quot;select A.ID from TIMERECORD A, TIMERECORDADJUSTMENT B where A.ISPOSTED=0 &quot;).</span>
<span class="nc" id="L1325">							append(&quot;and A.EMPLOYEEID=&quot;).append(wrID).append(&quot; and A.ID=B.TIMERECORDID&quot;);</span>
<span class="nc bnc" id="L1326" title="All 2 branches missed.">					if (type != 0) {</span>
<span class="nc" id="L1327">						pStmt.append(&quot; and B.TIMESOURCECODE=&quot;).append(type);</span>
					}
<span class="nc" id="L1329">					pStmt.append(&quot; and B.ENDTIME&gt;='&quot;).append(JdmoUtil.formatDBString(start)).append(&quot;' and B.ENDTIME&lt;'&quot;).append(JdmoUtil.formatDBString(end)).append(&quot;'&quot;);</span>
<span class="nc bnc" id="L1330" title="All 4 branches missed.">					if (activityCol != null &amp;&amp; !activityCol.isEmpty()) {</span>
<span class="nc" id="L1331">						pStmt.append(&quot; and B.ACTIVITYID in &quot;).append(jdmo.createInClause(activityCol));</span>
					}
<span class="nc" id="L1333">					DAOUtil.deleteObjects(jdmo, &quot;TIMERECORD&quot;, pStmt.toString());</span>
<span class="nc" id="L1334">					break;</span>
				default:
<span class="nc" id="L1336">					pStmt.append(&quot;select TIMERECORDID, STARTTIME, ENDTIME from TIMERECORD A, &quot;).</span>
<span class="nc" id="L1337">							append(&quot;TIMERECORDADJUSTMENT B where A.ISPOSTED=0 and A.EMPLOYEEID=? &quot;).append(&quot;and A.ID=B.TIMERECORDID&quot;);</span>
<span class="nc bnc" id="L1338" title="All 2 branches missed.">					if (type != 0) {</span>
<span class="nc" id="L1339">						pStmt.append(&quot; and B.TIMESOURCECODE=? &quot;);</span>
					}
<span class="nc" id="L1341">					pStmt.append(&quot; and B.STARTTIME&lt;=? and B.ENDTIME&gt;=?&quot;);</span>
<span class="nc bnc" id="L1342" title="All 4 branches missed.">					if (activityCol != null &amp;&amp; !activityCol.isEmpty()) {</span>
<span class="nc" id="L1343">						pStmt.append(&quot; and B.ACTIVITYID in &quot;).append(jdmo.createInClause(activityCol));</span>
					}
<span class="nc" id="L1345">					pStmt.append(&quot; order by B.STARTTIME asc&quot;);</span>
<span class="nc" id="L1346">					JdmoQuery jQuery2 = jdmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L1347">					jQuery2.setParID(1, wrID);</span>
<span class="nc" id="L1348">					jQuery2.setParInt(2, type);</span>
<span class="nc" id="L1349">					jQuery2.setParTimestamp(3, end);</span>
<span class="nc" id="L1350">					jQuery2.setParTimestamp(4, start);</span>
					// Load the TimeIntervals
<span class="nc" id="L1352">					JdmoRowset rs = jdmo.createRowset(jQuery2, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L1353">					Collection trCol = new ArrayList(1);</span>
<span class="nc" id="L1354">					Date dtPeriodStart = TimeZoneUtil.toDate(start);</span>
<span class="nc" id="L1355">					Date dtPeriodEnd = TimeZoneUtil.toDate(end);</span>
<span class="nc" id="L1356">					Date dtStart = null;</span>
<span class="nc" id="L1357">					Date dtEnd = null;</span>
<span class="nc" id="L1358">					Date dtMidDate = null;</span>
<span class="nc bnc" id="L1359" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L1360">						dtStart = rs.getTimestamp(&quot;STARTTIME&quot;);</span>
<span class="nc" id="L1361">						dtEnd = rs.getTimestamp(&quot;ENDTIME&quot;);</span>
<span class="nc" id="L1362">						dtMidDate = new Date(dtStart.getTime() + (dtEnd.getTime() - dtStart.getTime()) / 2);</span>
<span class="nc bnc" id="L1363" title="All 2 branches missed.">						if (!dtMidDate.before(dtPeriodStart)</span>
<span class="nc bnc" id="L1364" title="All 2 branches missed.">								&amp;&amp; dtMidDate.before(dtPeriodEnd)) {</span>
<span class="nc" id="L1365">							trCol.add(rs.getID(&quot;TIMERECORDID&quot;));</span>
						}
					}
<span class="nc bnc" id="L1368" title="All 2 branches missed.">					if (!trCol.isEmpty()) {</span>
<span class="nc" id="L1369">						DAOUtil.deleteObjects(jdmo, &quot;TIMERECORD&quot;, trCol);</span>
					}
			}
		} finally {
<span class="nc" id="L1373">			jdmo.cleanUp();</span>
<span class="nc" id="L1374">		}</span>
<span class="nc" id="L1375">	}</span>

	/**
	 * Remove an existing TimeRecordEntry by ID.
	 * &lt;p&gt;
	 * @param id
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void removeTimeRecordEntry(ID id)
			throws JdmoException {
<span class="nc" id="L1386">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc bnc" id="L1388" title="All 2 branches missed.">			if (id != null) {</span>
<span class="nc" id="L1389">				ArrayList trCol = new ArrayList(1);</span>
<span class="nc" id="L1390">				trCol.add(id);</span>
<span class="nc" id="L1391">				DAOUtil.deleteObjects(jdmo, &quot;TIMEENTRYEVENT&quot;, trCol);</span>
			}
		} finally {
<span class="nc" id="L1394">			jdmo.cleanUp();</span>
<span class="nc" id="L1395">		}</span>
<span class="nc" id="L1396">	}</span>

	/**
	 * Update a TimeInterval value object.
	 * &lt;p&gt;
	 * @param interval
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void updateTimeIntervalOnly(TimeInterval interval)
			throws JdmoException {
<span class="nc" id="L1407">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1409">			StringBuffer pStmt = new StringBuffer(</span>
<span class="nc" id="L1410">					&quot;update TIMERECORDADJUSTMENT set ACTIVITYID=?, &quot;).append(</span>
<span class="nc" id="L1411">							&quot;TIMERECORDID=?, STARTTIME=?, ENDTIME=?, &quot;).append(</span>
<span class="nc" id="L1412">							&quot;COUNTTOWARDSMINUTES=?, TIMESOURCECODE=?, &quot;).append(</span>
							&quot;DESCRIPTION=?, ISPAID=? where ID=?&quot;);
<span class="nc" id="L1414">			Object[] param = new Object[9];</span>
<span class="nc" id="L1415">			param[0] = interval.getActivityID();</span>
<span class="nc" id="L1416">			param[1] = interval.getParentID();</span>
<span class="nc" id="L1417">			param[2] = TimeZoneUtil.toTimestamp(interval.getStartTime());</span>
<span class="nc" id="L1418">			param[3] = TimeZoneUtil.toTimestamp(interval.getEndTime());</span>
<span class="nc" id="L1419">			param[4] = new Integer(interval.getDuration());</span>
<span class="nc" id="L1420">			param[5] = new Integer(interval.getTimeSourceCode());</span>
<span class="nc bnc" id="L1421" title="All 2 branches missed.">			if (interval.getDescription() != null) {</span>
<span class="nc" id="L1422">				param[6] = interval.getDescription();</span>
			} else {
<span class="nc" id="L1424">				param[6] = new JdmoParam(null, Types.VARCHAR);</span>
			}
<span class="nc" id="L1426">			param[7] = JdmoParam.getObject(interval.getPaid());</span>
<span class="nc" id="L1427">			param[8] = interval.getID();</span>
<span class="nc" id="L1428">			jdmo.executePCommand(pStmt.toString(), param);</span>
		} finally {
<span class="nc" id="L1430">			jdmo.cleanUp();</span>
<span class="nc" id="L1431">		}</span>
<span class="nc" id="L1432">	}</span>

	/**
	 * Update TimeRecord and will check Mutli-User Exception.
	 * If there is checkMulti flag is set, it will utilize ChangeCounter to
	 * detect obsolete record.
	 * If there is lockTR flag is set, it will promote the SyncStatus of the
	 * TimeRecord to prevent backend operations on the TimeRecord.
	 * It is set to True, in createEndShift/approveTimeRecord operations.
	 * So at least an Exclusive lock is applied via &quot;update&quot; operation, and
	 * optimistic locking is optional to enforce via the boolean flag.
	 * All update operations will invoke this method to acquire the lock on
	 * TimeRecord.
	 * &lt;p&gt;
	 * @param record
	 * @param checkMulti if need to detect version change
	 * @param lockTR if need to update the syncStatus to forbid TimeCollection
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static int updateTimeRecord(TimeRecord record, boolean checkMulti, boolean lockTR)
			throws JdmoException {
<span class="nc" id="L1454">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1456">			StringBuffer pStmt = new StringBuffer(</span>
<span class="nc" id="L1457">					&quot;update TIMERECORD set &quot;).append(</span>
<span class="nc" id="L1458">							REMAKERCOLNAME).append(&quot;=?, LASTMODIFIEDAT=?, REMARK=?, &quot;).append(</span>
<span class="nc" id="L1459">							&quot;ISAPPROVED=?,&quot;).append(APPROVERCOLNAME).append(&quot;=?,&quot;).append(</span>
<span class="nc" id="L1460">							APPROVETIMECOLNAME).append(&quot;=?&quot;);</span>
<span class="nc" id="L1461">			int paramSize = 7;</span>
<span class="nc bnc" id="L1462" title="All 2 branches missed.">			if (lockTR) {</span>
<span class="nc" id="L1463">				pStmt.append(&quot;, CHANGESTATUS =?&quot;);</span>
<span class="nc" id="L1464">				++paramSize;</span>
			}
<span class="nc bnc" id="L1466" title="All 2 branches missed.">			if (checkMulti) {</span>
<span class="nc" id="L1467">				pStmt.append(&quot;, CHANGECOUNTER=?&quot;);</span>
<span class="nc" id="L1468">				++paramSize;</span>
			}
<span class="nc" id="L1470">			pStmt.append(&quot; where ISPOSTED=0 and ID=?&quot;);</span>
<span class="nc" id="L1471">			Object[] param = new Object[paramSize];</span>
<span class="nc bnc" id="L1472" title="All 2 branches missed.">			if (record.getRemarkEmployeeID() != null) {</span>
<span class="nc" id="L1473">				param[0] = record.getRemarkEmployeeID();</span>
			} else {
<span class="nc" id="L1475">				param[0] = new JdmoParam(null, Types.INTEGER);</span>
			}
<span class="nc" id="L1477">			param[1] = TimeZoneUtil.toTimestamp(new Date());</span>
<span class="nc bnc" id="L1478" title="All 2 branches missed.">			if (record.getDescription() != null) {</span>
<span class="nc" id="L1479">				param[2] = record.getDescription();</span>
			} else {
<span class="nc" id="L1481">				param[2] = new JdmoParam(null, Types.VARCHAR);</span>
			}
<span class="nc" id="L1483">			param[3] = JdmoParam.getObject(record.getApprove());</span>
<span class="nc bnc" id="L1484" title="All 2 branches missed.">			if (record.getApproverName() != null) {</span>
<span class="nc" id="L1485">				param[4] = record.getApproverName();</span>
			} else {
<span class="nc" id="L1487">				param[4] = new JdmoParam(null, Types.VARCHAR);</span>
			}
<span class="nc bnc" id="L1489" title="All 2 branches missed.">			if (record.getApproveTime() != null) {</span>
<span class="nc" id="L1490">				param[5] = record.getApproveTime();</span>
			} else {
<span class="nc" id="L1492">				param[5] = new JdmoParam(null, Types.TIMESTAMP);</span>
			}
<span class="nc bnc" id="L1494" title="All 2 branches missed.">			if (lockTR)</span>
			{
				// if it is 0, promote it to 1, if 1 to 1, then 2 to 2
<span class="nc bnc" id="L1497" title="All 2 branches missed.">				param[paramSize - 3] = new Short(record.getSyncStatus() == 0 ? 1 : record.getSyncStatus());</span>
			}
<span class="nc bnc" id="L1499" title="All 2 branches missed.">			if (checkMulti) {</span>
<span class="nc" id="L1500">				param[paramSize - 2] = new Long(record.getVersion());</span>
			}
<span class="nc" id="L1502">			param[paramSize - 1] = record.getID();</span>
<span class="nc" id="L1503">			return jdmo.executePCommand(pStmt.toString(), param);</span>
		} finally {
<span class="nc" id="L1505">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Update a TimeRecordEntry.
	 * &lt;p&gt;
	 * @param entry
	 * @param b_ResetImmidiateToLastActivity
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static int updateTimeRecordEntry(TimeRecordEntry entry, boolean b_ResetImmidiateToLastActivity)
			throws JdmoException {
<span class="nc" id="L1519">		Jdmo jdmo = new Jdmo();</span>
		try {

<span class="nc bnc" id="L1522" title="All 2 branches missed.">			if (b_ResetImmidiateToLastActivity) {</span>
<span class="nc" id="L1523">				Cache b_cache = CacheFactory.getCache(MYTIME_EMP_LAST_ACT_CACHE, TimeRecordDAO.class.getClassLoader());</span>

<span class="nc" id="L1525">				String sValue = (String)b_cache.get(&quot;Emp_Last_Act&quot; + &quot;_&quot; + entry.getEmployeeID());</span>
<span class="nc bnc" id="L1526" title="All 2 branches missed.">				if (sValue == null) {</span>
					//last act was not found in cache, look in DB
<span class="nc" id="L1528">					ID lastactID = getEmpLastActFromDB(entry.getEmployeeID());</span>
<span class="nc bnc" id="L1529" title="All 2 branches missed.">					if (lastactID != null) {</span>
<span class="nc bnc" id="L1530" title="All 2 branches missed.">						if (entry.getActivityID().toString().equals(&quot;-4101&quot;)) {</span>
<span class="nc bnc" id="L1531" title="All 2 branches missed.">							if (lastactID.toString().compareToIgnoreCase(&quot;-4001&quot;) != 0) {</span>
<span class="nc" id="L1532">								entry.setActivityID(lastactID);</span>
							}
						}
					}
<span class="nc" id="L1536">				} else {</span>
<span class="nc bnc" id="L1537" title="All 2 branches missed.">					if (entry.getActivityID().toString().equals(&quot;-4101&quot;)) {</span>
<span class="nc" id="L1538">						entry.setActivityID(new ID(sValue));</span>
					}
				}
			}

			// TimeEntryEvent cannot be moved to another TimeRecord,
			// so no need to update TIMERECORDID, EMPLOYEEID, and RAWTIMEENTRYID
<span class="nc" id="L1545">			StringBuffer pStmt = new StringBuffer(</span>
<span class="nc" id="L1546">					&quot;update TIMEENTRYEVENT set ACTIVITYID=?, &quot;).append(</span>
<span class="nc" id="L1547">							&quot; STARTTIME=?, UPDATETIMESTAMP=?, &quot;).append(</span>
<span class="nc" id="L1548">							&quot;TIMESOURCECODE=?, DESCRIPTION=?, ISPAID=?, &quot;).append(</span>
							&quot;LASTMODIFIEDAT=?, MODIFIEDBY=? where ID=?&quot;);
<span class="nc" id="L1550">			Object[] param = new Object[9];</span>
<span class="nc" id="L1551">			param[0] = entry.getActivityID();</span>
<span class="nc" id="L1552">			param[1] = TimeZoneUtil.toTimestamp(entry.getStartTime());</span>
<span class="nc" id="L1553">			param[2] = BigDecimal.valueOf(entry.getSortTime().getTime());</span>
<span class="nc" id="L1554">			param[3] = new Integer(entry.getTimeSourceCode());</span>
<span class="nc bnc" id="L1555" title="All 2 branches missed.">			if (entry.getDescription() != null) {</span>
<span class="nc" id="L1556">				param[4] = entry.getDescription();</span>
			} else {
<span class="nc" id="L1558">				param[4] = new JdmoParam(null, Types.VARCHAR);</span>
			}
<span class="nc" id="L1560">			param[5] = JdmoParam.getObject(entry.getPaid());</span>
<span class="nc bnc" id="L1561" title="All 2 branches missed.">			if (entry.getLastModifiedTime() != null) {</span>
<span class="nc" id="L1562">				param[6] = TimeZoneUtil.toTimestamp(entry.getLastModifiedTime());</span>
			} else {
<span class="nc" id="L1564">				param[6] = TimeZoneUtil.toTimestamp(new Date());</span>
			}
<span class="nc bnc" id="L1566" title="All 2 branches missed.">			if (entry.getModifier() != null) {</span>
<span class="nc" id="L1567">				param[7] = entry.getModifier();</span>
			} else {
<span class="nc" id="L1569">				param[7] = new JdmoParam(null, Types.VARCHAR);</span>
			}
<span class="nc" id="L1571">			param[8] = entry.getID();</span>
<span class="nc" id="L1572">			return jdmo.executePCommand(pStmt.toString(), param);</span>
<span class="nc" id="L1573">		} catch (Exception e) {</span>
<span class="nc" id="L1574">			throw new JdmoException(e);</span>
		} finally {
<span class="nc" id="L1576">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Mainly used by RemoveTimeRecord function to just update the TimeRecord timestamp, and is for backend only.
	 * &lt;p&gt;
	 * @param timeRecordID
	 * @param jdmo
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static int updateTimeRecordTimeStamp(ID timeRecordID, Jdmo jdmo)
			throws JdmoException {
<span class="nc" id="L1590">		Object[] param = new Object[2];</span>
<span class="nc" id="L1591">		param[0] = TimeZoneUtil.toTimestamp(new Date());</span>
<span class="nc" id="L1592">		param[1] = timeRecordID;</span>
<span class="nc" id="L1593">		int updated = 0;</span>
<span class="nc" id="L1594">		jdmo.executePCommand(&quot;update TIMERECORD set LASTMODIFIEDAT=? where ID=?&quot;, param);</span>
<span class="nc" id="L1595">		return updated;</span>
	} // updateTimeRecordTimeStamp

	/**
	 * Mainly used by RemoveTimeRecord function to remove all Entries, and is for backend only.
	 * &lt;p&gt;
	 * @param timeRecordID
	 * @param jdmo
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static void removeTimeRecordEntries(ID timeRecordID, Jdmo jdmo)
			throws JdmoException {
<span class="nc" id="L1608">		Object[] param = new Object[1];</span>
<span class="nc" id="L1609">		param[0] = timeRecordID;</span>
<span class="nc" id="L1610">		jdmo.executePCommand(&quot;delete TIMEENTRYEVENT where TIMERECORDID=?&quot;, param);</span>
<span class="nc" id="L1611">	} // updateTimeRecordEntries</span>

	/**
	 * Find last open TimeRecordEntry before a given time, only retrieve TimeRecordID, StartTime/SortTime, ActivityID.
	 * &lt;p&gt;
	 * @param workResourceID
	 * @param dtStart
	 * &lt;p&gt;
	 * @return TimeRecordEntry, if find any, null means no such time record
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static TimeRecordEntry findLastTimeEntry(ID workResourceID, Date dtStart)
			throws JdmoException {
<span class="nc" id="L1625">		Jdmo jdmo = new Jdmo();</span>
		try {
			// TimeEntryEvent table is denormailzed, so no need to join TimeRecord table to get EMPLOYEEID information
<span class="nc" id="L1628">			String pStmt</span>
					= &quot;select b.TIMERECORDID, b.STARTTIME, b.UPDATETIMESTAMP, b.ACTIVITYID from TIMEENTRYEVENT b where b.UPDATETIMESTAMP=(select max(b2.UPDATETIMESTAMP) from TIMEENTRYEVENT b2 where b.TIMERECORDID=b2.TIMERECORDID and b2.UPDATETIMESTAMP&lt;=? and b2.EMPLOYEEID=?)&quot;;
<span class="nc" id="L1630">			JdmoQuery jQuery = jdmo.createQuery(pStmt, Jdmo.PARAM_QUERY);</span>
<span class="nc bnc" id="L1631" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L1632">				jQuery.setParLong(1, DateAdjustmentUtil.adjustEndDateForDemo(dtStart, m_ignoreFutureData).getTime());</span>
			} else {
<span class="nc" id="L1634">				jQuery.setParLong(1, dtStart.getTime());</span>
			}
<span class="nc" id="L1636">			jQuery.setParID(2, workResourceID);</span>
<span class="nc" id="L1637">			JdmoRowset rs = jdmo.createRowset(jQuery, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc bnc" id="L1638" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1639">				ID actID = rs.getID(&quot;ACTIVITYID&quot;);</span>
<span class="nc bnc" id="L1640" title="All 2 branches missed.">				if (!actID.equals(Activity.ACTIVITY_NONE)) {</span>
<span class="nc" id="L1641">					Date start = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L1642">					TimeRecordEntry entry = new TimeRecordEntry(actID, start, start, 0, false, null);</span>
<span class="nc" id="L1643">					entry.setEmployeeID(workResourceID);</span>
<span class="nc" id="L1644">					entry.setParentID(rs.getID(&quot;TIMERECORDID&quot;));</span>
<span class="nc" id="L1645">					entry.setSortTime(new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)));</span>
<span class="nc" id="L1646">					return entry;</span>
				}
			}
<span class="nc" id="L1649">			return null;</span>
		} finally {
<span class="nc" id="L1651">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Returns a collection of the last time entries, using a default lookback value of two weeks.  Used to find out who is active in the system (open shift).
	 * &lt;p&gt;
	 * @param empCol
	 * @param date
	 * &lt;p&gt;
	 * @return
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static Collection findLastEntry(Collection empCol, Date date)
			throws JdmoException {
		//by default we will look back 14 days for open shift.
<span class="nc" id="L1668">		return findLastEntry(empCol, date, 14 * TimeZoneUtil.DAY_IN_MILLISECONDS_LONG);</span>
	}

	/**
	 * Returns a collection of the last time entries, using a given lookback.  Used to find out who is active in the system (open shift).
	 * &lt;p&gt;
	 * @param empCol
	 * @param date
	 * @param numDayLookback
	 * &lt;p&gt;
	 * @return
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static Collection findLastEntry(Collection empCol, Date date, long numDayLookback)
			throws JdmoException {
<span class="nc" id="L1684">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1686">			long currentMilli = System.currentTimeMillis();</span>
<span class="nc bnc" id="L1687" title="All 6 branches missed.">			currentMilli = (date == null || (m_ignoreFutureData &amp;&amp; date.getTime() &gt; currentMilli)) ? currentMilli : date.getTime();</span>
<span class="nc" id="L1688">			StringBuffer pStmt = new StringBuffer(1000);</span>
<span class="nc" id="L1689">			String empInClause = jdmo.createInClause(empCol);</span>
<span class="nc" id="L1690">			String tempTable = &quot;emplatest&quot;;</span>
			// From JDMO get real temp table name
<span class="nc" id="L1692">			String realTempTable = jdmo.getNativeTemptableName(tempTable);</span>
			// Drop temp first
			try {
<span class="nc" id="L1695">				jdmo.dropTempTable(tempTable);</span>
<span class="nc" id="L1696">			} catch (JdmoException e) {</span>
<span class="nc" id="L1697">			}</span>
			// Create a new temp table
<span class="nc" id="L1699">			StringBuffer strSQLCreate = new StringBuffer();</span>
<span class="nc" id="L1700">			strSQLCreate.append(realTempTable);</span>
<span class="nc" id="L1701">			strSQLCreate.append(&quot; (UPDATETIMESTAMP decimal(17,0), EMPLOYEEID int)&quot;);</span>
<span class="nc" id="L1702">			jdmo.createTempTable(strSQLCreate.toString());</span>
			// Insert data into temp table
<span class="nc" id="L1704">			StringBuffer pInsert = new StringBuffer(&quot;insert into &quot;);</span>
<span class="nc" id="L1705">			pInsert.append(realTempTable).append(&quot; select MAX(updatetimestamp),&quot;);</span>
<span class="nc" id="L1706">			pInsert.append(&quot; b2.employeeid FROM timeentryevent b2&quot;);</span>
<span class="nc" id="L1707">			pInsert.append(&quot; WHERE b2.updatetimestamp&lt;=&quot;).append(currentMilli).append(&quot; AND b2.updatetimestamp&gt;=&quot;).append(currentMilli - numDayLookback).</span>
<span class="nc" id="L1708">					append(&quot; and b2.employeeID in &quot;).append(empInClause);</span>
<span class="nc" id="L1709">			pInsert.append(&quot; GROUP BY b2.employeeid&quot;);</span>
<span class="nc" id="L1710">			jdmo.executeCommand(pInsert.toString());</span>
			// now select again
<span class="nc" id="L1712">			pStmt.append(&quot;select distinct b.EMPLOYEEID, b.ID, b.ACTIVITYID, &quot;).</span>
<span class="nc" id="L1713">					append(&quot;RAWTIMEENTRYID, TIMERECORDID, STARTTIME, b.UPDATETIMESTAMP, TIMESOURCECODE, B.DATASOURCEID, &quot;).</span>
<span class="nc" id="L1714">					append(&quot;LASTMODIFIEDAT, MODIFIEDBY, ISPAID, DESCRIPTION&quot;).</span>
<span class="nc" id="L1715">					append(&quot; from &quot;).append(realTempTable).append(&quot; t, TIMEENTRYEVENT b where t.EMPLOYEEID=b.EMPLOYEEID and&quot;).</span>
<span class="nc" id="L1716">					append(&quot; b.UPDATETIMESTAMP=t.UPDATETIMESTAMP&quot;);</span>
<span class="nc" id="L1717">			JdmoRowset rs = jdmo.createRowset(pStmt.toString(), Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L1718">			ArrayList entryList = new ArrayList(empCol.size());</span>
<span class="nc bnc" id="L1719" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1720">				Date start = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L1721">				TimeRecordEntry entry = new TimeRecordEntry(rs.getID(&quot;ID&quot;),</span>
<span class="nc" id="L1722">						rs.getID(&quot;RAWTIMEENTRYID&quot;),</span>
<span class="nc" id="L1723">						rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L1724">						rs.getID(&quot;DATASOURCEID&quot;),</span>
						start,
						start,
<span class="nc" id="L1727">						new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)),</span>
<span class="nc" id="L1728">						rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L1729">						rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L1730">						rs.getString(&quot;DESCRIPTION&quot;));</span>
<span class="nc" id="L1731">				entry.setEmployeeID(rs.getID(&quot;EMPLOYEEID&quot;));</span>
<span class="nc" id="L1732">				entry.setParentID(rs.getID(&quot;TIMERECORDID&quot;));</span>
<span class="nc" id="L1733">				entry.setLastModifiedTime(TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)));</span>
<span class="nc" id="L1734">				entry.setModifier(rs.getString(&quot;MODIFIEDBY&quot;));</span>
<span class="nc" id="L1735">				entryList.add(entry);</span>
<span class="nc" id="L1736">			}</span>
<span class="nc" id="L1737">			return entryList;</span>
		} finally {
<span class="nc" id="L1739">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Returns a collection of the last time entries.  Used to find out who is active in the system (open shift).
	 * &lt;p&gt;
	 * @return Collection, those have Open Shift
	 * &lt;p&gt;
	 * @throws JdmoException
	 */
	static Collection findLastEntries()
			throws JdmoException {
<span class="nc" id="L1752">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1754">			long currentMilli = System.currentTimeMillis();</span>
<span class="nc" id="L1755">			String tempTable = &quot;empdatasourcelatest&quot;;</span>
			// From JDMO get real temp table name
<span class="nc" id="L1757">			String realTempTable = jdmo.getNativeTemptableName(tempTable);</span>
			// Drop temp first
			try {
<span class="nc" id="L1760">				jdmo.dropTempTable(tempTable);</span>
<span class="nc" id="L1761">			} catch (JdmoException e) {</span>
<span class="nc" id="L1762">			}</span>
			// Create a new temp table
<span class="nc" id="L1764">			StringBuffer strSQLCreate = new StringBuffer();</span>
<span class="nc" id="L1765">			strSQLCreate.append(realTempTable);</span>
<span class="nc" id="L1766">			strSQLCreate.append(&quot; (UPDATETIMESTAMP decimal(17,0), EMPLOYEEID int, DATASOURCEID int)&quot;);</span>
<span class="nc" id="L1767">			jdmo.createTempTable(strSQLCreate.toString());</span>
			// Insert data into temp table
<span class="nc" id="L1769">			StringBuffer pInsert = new StringBuffer(&quot;insert into &quot;);</span>
<span class="nc" id="L1770">			pInsert.append(realTempTable).append(&quot; select max(UPDATETIMESTAMP), &quot;).</span>
<span class="nc" id="L1771">					append(&quot;b2.EMPLOYEEID, b2.DATASOURCEID from TIMEENTRYEVENT b2, DATASOURCE d&quot;).</span>
<span class="nc" id="L1772">					append(&quot; where b2.UPDATETIMESTAMP&lt;=&quot;).append(currentMilli).</span>
<span class="nc" id="L1773">					append(&quot; and d.ISMANAGED=1 &quot;).append(&quot;and (b2.DATASOURCEID=d.ID or b2.DATASOURCEID is NULL)&quot;).</span>
<span class="nc" id="L1774">					append(&quot; group by b2.EMPLOYEEID, b2.DATASOURCEID&quot;);</span>
<span class="nc" id="L1775">			jdmo.executeCommand(pInsert.toString());</span>
			// now select again
<span class="nc" id="L1777">			StringBuffer pStmt = new StringBuffer(300);</span>
<span class="nc" id="L1778">			pStmt.append(&quot;select distinct b.EMPLOYEEID, b.ID, b.ACTIVITYID, &quot;).</span>
<span class="nc" id="L1779">					append(&quot;RAWTIMEENTRYID, TIMERECORDID, STARTTIME, b.UPDATETIMESTAMP, TIMESOURCECODE, B.DATASOURCEID, &quot;).</span>
<span class="nc" id="L1780">					append(&quot;LASTMODIFIEDAT, MODIFIEDBY, ISPAID, DESCRIPTION&quot;).</span>
<span class="nc" id="L1781">					append(&quot; from &quot;).append(realTempTable).append(&quot; t, TIMEENTRYEVENT b where t.EMPLOYEEID=b.EMPLOYEEID and&quot;).</span>
<span class="nc" id="L1782">					append(&quot;  (b.DATASOURCEID = T.DATASOURCEID or &quot;).</span>
<span class="nc" id="L1783">					append(&quot; (t.DATASOURCEID is NULL and b.DATASOURCEID is NULL)) and &quot;).</span>
<span class="nc" id="L1784">					append(&quot; b.UPDATETIMESTAMP=t.UPDATETIMESTAMP&quot;);</span>
<span class="nc" id="L1785">			JdmoRowset rs = jdmo.createRowset(pStmt.toString(), Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L1786">			ArrayList entryList = new ArrayList(1000);</span>
<span class="nc bnc" id="L1787" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1788">				Date start = TimeZoneUtil.toDate(rs.getTimestamp(&quot;STARTTIME&quot;));</span>
<span class="nc" id="L1789">				TimeRecordEntry entry = new TimeRecordEntry(rs.getID(&quot;ID&quot;),</span>
<span class="nc" id="L1790">						rs.getID(&quot;RAWTIMEENTRYID&quot;),</span>
<span class="nc" id="L1791">						rs.getID(&quot;ACTIVITYID&quot;),</span>
<span class="nc" id="L1792">						rs.getID(&quot;DATASOURCEID&quot;),</span>
						start,
						start,
<span class="nc" id="L1795">						new Date(rs.getLong(&quot;UPDATETIMESTAMP&quot;)),</span>
<span class="nc" id="L1796">						rs.getInt(&quot;TIMESOURCECODE&quot;),</span>
<span class="nc" id="L1797">						rs.getBoolean(&quot;ISPAID&quot;),</span>
<span class="nc" id="L1798">						rs.getString(&quot;DESCRIPTION&quot;));</span>
<span class="nc" id="L1799">				entry.setEmployeeID(rs.getID(&quot;EMPLOYEEID&quot;));</span>
<span class="nc" id="L1800">				entry.setParentID(rs.getID(&quot;TIMERECORDID&quot;));</span>
<span class="nc" id="L1801">				entry.setLastModifiedTime(TimeZoneUtil.toDate(rs.getTimestamp(&quot;LASTMODIFIEDAT&quot;)));</span>
<span class="nc" id="L1802">				entry.setModifier(rs.getString(&quot;MODIFIEDBY&quot;));</span>
<span class="nc" id="L1803">				entryList.add(entry);</span>
<span class="nc" id="L1804">			}</span>
<span class="nc" id="L1805">			return entryList;</span>
		} finally {
<span class="nc" id="L1807">			jdmo.cleanUp();</span>
		}
	}

	/**
	 * Sets the last activity the employee was working on in the MY TIME cache.
	 * &lt;p&gt;
	 * @param empID
	 * @param activityID
	 * &lt;p&gt;
	 * @throws Exception
	 */
	public static void setEmpLastActCache(ID empID, ID activityID)
			throws Exception {
<span class="nc bnc" id="L1821" title="All 2 branches missed.">		if (cacheEnabled) {</span>
<span class="nc" id="L1822">			Cache a_cache = CacheFactory.getCache(MYTIME_EMP_LAST_ACT_CACHE, TimeRecordDAO.class.getClassLoader());</span>
<span class="nc" id="L1823">			a_cache.put(&quot;Emp_Last_Act&quot; + &quot;_&quot; + empID, activityID.toString());</span>
		}
<span class="nc" id="L1825">	}</span>

	/**
	 * Gets the last activity the employee was working on from the database.
	 * &lt;p&gt;
	 * @param employeeID
	 * &lt;p&gt;
	 * @return
	 * &lt;p&gt;
	 * @throws Exception
	 */
	private static ID getEmpLastActFromDB(ID employeeID)
			throws Exception {
<span class="nc" id="L1838">		Jdmo jdmo = new Jdmo();</span>
		try {
<span class="nc" id="L1840">			Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L1841">			cal.setTime(new Date());</span>
<span class="nc" id="L1842">			cal.add(Calendar.DAY_OF_MONTH, -1);</span>

<span class="nc" id="L1844">			String selectedFields = &quot;ACTIVITYID&quot;;</span>
<span class="nc" id="L1845">			String tableName = &quot;TIMEENTRYEVENT&quot;;</span>
<span class="nc" id="L1846">			StringBuffer where = new StringBuffer();</span>
<span class="nc" id="L1847">			where.append(&quot; EMPLOYEEID = &quot;).append(employeeID.toInt())</span>
<span class="nc" id="L1848">					.append(&quot; AND DATASOURCEID IS NULL&quot;)</span>
<span class="nc" id="L1849">					.append(&quot; AND STARTTIME &gt; '&quot;).append(JdmoUtil.formatDBString(cal.getTime())).append(&quot;'&quot;)</span>
<span class="nc" id="L1850">					.append(&quot; AND ACTIVITYID != -4001 and TIMESOURCECODE in (1,5) &quot;);</span>
<span class="nc bnc" id="L1851" title="All 2 branches missed.">			if (m_ignoreFutureData) {</span>
<span class="nc" id="L1852">				where.append(&quot;AND UPDATETIMESTAMP&lt;=&quot; + System.currentTimeMillis() + &quot; &quot;);</span>
			}

<span class="nc" id="L1855">			String orderByFields = &quot;STARTTIME DESC&quot;;</span>
<span class="nc" id="L1856">			int nRows = 1;</span>

<span class="nc" id="L1858">			String query = jdmo.getSelectTopNRows(selectedFields, tableName, where.toString(), orderByFields, nRows, false);</span>

<span class="nc" id="L1860">			JdmoRowset rs = jdmo.createRowset(query);</span>

<span class="nc" id="L1862">			ID actID = null;</span>
<span class="nc bnc" id="L1863" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1864">				actID = rs.getID(&quot;ACTIVITYID&quot;);</span>
			}

<span class="nc bnc" id="L1867" title="All 2 branches missed.">			if (actID != null) {</span>
<span class="nc" id="L1868">				setEmpLastActCache(employeeID, actID);</span>
			}
<span class="nc" id="L1870">			return actID;</span>
		} finally {
<span class="nc" id="L1872">			jdmo.cleanUp();</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>