<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeTrackingCache.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.timerecord.cache</a> &gt; <span class="el_source">TimeTrackingCache.java</span></div><h1>TimeTrackingCache.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.timerecord.cache;

import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.SortedSet;
import java.util.TreeSet;
import java.util.ArrayList;

import com.bluepumpkin.common.cache.Cache;
import com.bluepumpkin.common.cache.CacheFactory;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.config.ejb.DBConfigManager;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeTrackingEvent;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.timerecord.ejb.TimeTrackingDAO;
import com.bluepumpkin.ejb.bbm.timerecord.ejb.TimeTrackingManager;
import com.bluepumpkin.ejb.bbm.timerecord.ejb.TimeTrackingManagerEJB;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;

<span class="nc" id="L28">public class TimeTrackingCache {</span>
<span class="nc" id="L29">	private static Category m_cat = Log.initCategory(TimeTrackingCache.class.getName());</span>
<span class="nc" id="L30">	private static int m_CachedMilliSeconds = TimeZoneUtil.DAY_IN_MILLISECONDS;</span>
<span class="nc" id="L31">	public static ID initKey = new ID(-1);</span>
<span class="nc" id="L32">	public static int m_CacheCleanupInterval = TimeZoneUtil.HOUR_IN_MILLISECONDS;</span>

	public static Cache getCache()
			throws Exception {
<span class="nc" id="L36">		Cache cache = CacheFactory.getCache(TimeTrackingManager.TIMETRACKING_CACHE_NAME, TimeTrackingManagerEJB.class.getClassLoader());</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">		if (cache == null) {</span>
<span class="nc" id="L38">			return null;</span>
		}
<span class="nc" id="L40">		initCache(cache);</span>
<span class="nc" id="L41">		return cache;</span>
	}

	public static void reloadCache(Cache cache)
			throws Exception {
<span class="nc bnc" id="L46" title="All 2 branches missed.">		if (cache.lock(initKey, -1)) {</span>
			try {
<span class="nc" id="L48">				Object value = cache.get(initKey);</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">				if (value != null) {</span>
<span class="nc" id="L50">					cache.put(initKey, null);</span>
				}
			} finally {
<span class="nc" id="L53">				cache.unLock(initKey);</span>
<span class="nc" id="L54">			}</span>
		}
<span class="nc" id="L56">		initCache(cache);</span>
<span class="nc" id="L57">	}</span>

	public static void initCache(Cache cache)
			throws Exception {
<span class="nc bnc" id="L61" title="All 2 branches missed.">		if (cache.get(initKey) != null) {</span>
<span class="nc" id="L62">			return;</span>
		}

<span class="nc bnc" id="L65" title="All 2 branches missed.">		if (cache.lock(initKey, -1)) {</span>
			try {
<span class="nc" id="L67">				Object value = cache.get(initKey);</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">				if (value != null) {</span>
<span class="nc" id="L69">					return;</span>
				}

<span class="nc" id="L72">				DBConfigManager dbConfig = BbmManagerFactory.getDBConfigManager();</span>
<span class="nc" id="L73">				String val = (String)dbConfig.getValue(&quot;bluepumpkin/bbm/cache/timetracking/cleanupInterval&quot;);</span>
<span class="nc bnc" id="L74" title="All 4 branches missed.">				if (val != null &amp;&amp; val.trim().length() &gt; 0) {</span>
<span class="nc" id="L75">					m_CacheCleanupInterval = Integer.parseInt(val);</span>
				}

<span class="nc" id="L78">				Date dt[] = getCurrentCacheWindow();</span>
<span class="nc" id="L79">				TimeTrackingDAO dao = new TimeTrackingDAO();</span>
<span class="nc" id="L80">				HashMap hm = dao.getEventsForWorkResource(Collections.emptyList(), dt[0], dt[1]);</span>
<span class="nc bnc" id="L81" title="All 4 branches missed.">				if (hm != null &amp;&amp; hm.size() &gt; 0) {</span>
<span class="nc" id="L82">					Iterator iter = hm.values().iterator();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">					while (iter.hasNext()) {</span>
<span class="nc" id="L84">						insertInCache(cache, (Collection)iter.next());</span>
					}
				}

				// update cache reload time stamp
<span class="nc" id="L89">				Date lastTs = new Date();</span>
<span class="nc" id="L90">				cache.put(initKey, lastTs);</span>
			} finally {
<span class="nc" id="L92">				cache.unLock(initKey);</span>
<span class="nc" id="L93">			}</span>
		}
<span class="nc" id="L95">	}</span>

	public static Date[] getCurrentCacheWindow() {
<span class="nc" id="L98">		Date end = new Date();</span>
<span class="nc" id="L99">		Date[] window = new Date[2];</span>
<span class="nc" id="L100">		Date start = new Date(end.getTime() - m_CachedMilliSeconds);</span>

<span class="nc" id="L102">		window[0] = start;</span>
<span class="nc" id="L103">		window[1] = end;</span>
<span class="nc" id="L104">		return window;</span>
	}

	public static boolean fitsInCache(Date startTime, Date endTime, Date cacheStartTime, Date cacheEndTime, boolean checkStartTime) {
<span class="nc bnc" id="L108" title="All 4 branches missed.">		if (checkStartTime &amp;&amp; startTime.before(cacheStartTime)) {</span>
<span class="nc" id="L109">			return false;</span>
		}
<span class="nc" id="L111">		boolean result = TimeZoneUtil.periodsOverlap(startTime, </span>
										endTime, 
										cacheStartTime,
										cacheEndTime);
<span class="nc" id="L115">		return result;</span>
	}

	public static boolean fitsInCache(Date startTime, Date endTime) {
<span class="nc" id="L119">		Date[] cacheWindow = getCurrentCacheWindow();</span>
<span class="nc" id="L120">		return fitsInCache(startTime, endTime, cacheWindow[0], cacheWindow[1], true);</span>
	}

	public static boolean fitsInCache(TimeTrackingEvent event, Date cacheStartTime, Date cacheEndTime, boolean checkStartTime) {
<span class="nc" id="L124">		Date endTime = event.getEndTime();</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">		if (endTime == null) {</span>
<span class="nc" id="L126">			endTime = new Date();</span>
		}
<span class="nc" id="L128">		return fitsInCache(event.getStartTime(), endTime, cacheStartTime, cacheEndTime, checkStartTime);</span>
	}

	static private void removeOldEvents(Cache cache) {
<span class="nc" id="L132">		Date cacheWindow[] = getCurrentCacheWindow();</span>
<span class="nc" id="L133">		Date lastTs = null;</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">		if (cache.lock(initKey, -1)) {</span>
			try {
<span class="nc" id="L137">				lastTs = (Date)cache.get(initKey);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">				if (lastTs == null) {</span>
<span class="nc" id="L139">					lastTs = new Date();</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">				} else if (Math.abs(System.currentTimeMillis() - lastTs.getTime()) &lt; m_CacheCleanupInterval) {</span>
<span class="nc" id="L141">					return;</span>
				}

<span class="nc" id="L144">				m_cat.info(&quot;*********  Entered TimeTrackingCache - removeOldEvents() &quot;);</span>

				// iterate all the cache contents and remove old events
				// store updated lists
<span class="nc" id="L148">				HashMap hmUpdate = new HashMap();</span>
<span class="nc" id="L149">				HashMap eventRemStat = new HashMap();</span>

<span class="nc" id="L151">				Iterator keyIter = cache.keySet().iterator();</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">				while (keyIter.hasNext()) {</span>
<span class="nc" id="L153">					Object nKey = keyIter.next();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">					if (nKey.equals(initKey)) {</span>
<span class="nc" id="L155">						continue;</span>
					}

<span class="nc" id="L158">					Collection lst = getListFromCache(cache, nKey);</span>
<span class="nc" id="L159">					int counter = 0;</span>
<span class="nc" id="L160">					int keyCount = 1;</span>
<span class="nc bnc" id="L161" title="All 4 branches missed.">					if (lst != null &amp;&amp; lst.size() &gt; 0) {</span>

<span class="nc" id="L163">						Iterator lstIter = lst.iterator();</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">						while (lstIter.hasNext()) {</span>
<span class="nc" id="L165">							TimeTrackingEvent cur = (TimeTrackingEvent)lstIter.next();</span>
<span class="nc" id="L166">							Date startTime = cacheWindow[0];</span>
<span class="nc" id="L167">							Date endTime = increaseDateBySec(cacheWindow[1], 1);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">							if( fitsInCache(cur, startTime, endTime, true) ){</span>
<span class="nc" id="L169">								break;</span>
							}						
						
<span class="nc" id="L172">							lstIter.remove();</span>
<span class="nc" id="L173">							hmUpdate.put(nKey, lst);</span>
<span class="nc" id="L174">							counter++;</span>
<span class="nc" id="L175">						}</span>
					}

<span class="nc bnc" id="L178" title="All 2 branches missed.">					if (keyCount &lt; 10) {</span>
<span class="nc" id="L179">						eventRemStat.put(nKey, new Integer(counter));</span>
					}
<span class="nc" id="L181">					keyCount++;</span>
<span class="nc" id="L182">				}</span>
<span class="nc" id="L183">				updateListInCache(cache, hmUpdate);</span>

<span class="nc" id="L185">				lastTs = new Date();</span>
<span class="nc" id="L186">				cache.put(initKey, lastTs);</span>

<span class="nc bnc" id="L188" title="All 2 branches missed.">				if (eventRemStat != null) {</span>
<span class="nc" id="L189">					Iterator iter = eventRemStat.keySet().iterator();</span>
<span class="nc" id="L190">					StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L191">					buf.append(&quot; *********  TimeTrackingCache - removeOldEvents  &quot;);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">					while (iter.hasNext()) {</span>

<span class="nc" id="L194">						Object key = iter.next();</span>

<span class="nc" id="L196">						buf.append(&quot; EmpId : &quot;);</span>
<span class="nc" id="L197">						buf.append(key.toString());</span>
<span class="nc" id="L198">						buf.append(&quot;;&quot;);</span>
<span class="nc" id="L199">						buf.append(&quot; removedEvents : &quot;);</span>
<span class="nc" id="L200">						buf.append(eventRemStat.get(key).toString());</span>
<span class="nc" id="L201">						buf.append(&quot;\\n&quot;);</span>

<span class="nc" id="L203">					}</span>
<span class="nc" id="L204">					m_cat.info(buf.toString());</span>
				}
			} finally {
<span class="nc" id="L207">				cache.unLock(initKey);</span>
<span class="nc" id="L208">			}</span>
		}
<span class="nc" id="L210">	}</span>

	public static void insertInCache(Cache trCache, Collection values) {
<span class="nc bnc" id="L213" title="All 6 branches missed.">		if (trCache == null || values == null || values.size() &lt;= 0) {</span>
<span class="nc" id="L214">			return;</span>
		}

<span class="nc" id="L217">		Date cacheWindow[] = getCurrentCacheWindow();</span>

<span class="nc" id="L219">		HashMap hmUpdate = new HashMap();</span>

<span class="nc" id="L221">		Iterator iter = values.iterator();</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L223">			TimeTrackingEvent cur = (TimeTrackingEvent)iter.next();</span>
<span class="nc" id="L224">			ID key = cur.getEmployeeID();</span>

<span class="nc" id="L226">			TreeSet lst = getListFromCache(trCache, key);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">			if (lst == null) {</span>
<span class="nc" id="L228">				lst = new TreeSet();</span>
			}
<span class="nc" id="L230">			hmUpdate.put(key, lst);</span>

			// replace existing object with the new one if they are same
<span class="nc bnc" id="L233" title="All 2 branches missed.">			if (lst.contains(cur)) {</span>
<span class="nc" id="L234">				SortedSet dset = lst.tailSet(cur);</span>
<span class="nc" id="L235">				lst.remove(dset.first());</span>
			}

			// if the cache is empty it's okay to add the event even if it does not fit the time range
<span class="nc" id="L239">			Date startTime = cacheWindow[0];</span>
<span class="nc" id="L240">			Date endTime = increaseDateBySec(cacheWindow[1], 1);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">			if( !fitsInCache(cur, startTime, endTime, true)  ) {</span>
<span class="nc" id="L242">				continue;</span>
			}

<span class="nc" id="L245">			lst.add(cur);</span>
<span class="nc" id="L246">		}</span>

<span class="nc" id="L248">		updateListInCache(trCache, hmUpdate);</span>

<span class="nc" id="L250">		removeOldEvents(trCache);</span>
<span class="nc" id="L251">	}</span>

	public static void filterNoActivity(HashMap hmEvents) {
<span class="nc bnc" id="L254" title="All 4 branches missed.">		if (hmEvents == null || hmEvents.size() &lt;= 0) {</span>
<span class="nc" id="L255">			return;</span>
		}

<span class="nc" id="L258">		Iterator iter = hmEvents.values().iterator();</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L260">			TimeTrackingEvent prev = null;</span>

<span class="nc" id="L262">			Collection lst = (Collection)iter.next();</span>
<span class="nc" id="L263">			Iterator lstIter = lst.iterator();</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">			while (lstIter.hasNext()) {</span>
<span class="nc" id="L265">				TimeTrackingEvent cur = (TimeTrackingEvent)lstIter.next();</span>

				// Filter this out, but set the end time of the previous event
<span class="nc bnc" id="L268" title="All 2 branches missed.">				if (cur.getActivityID().equals(Activity.ACTIVITY_NONE)) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">					if (prev != null) {</span>
<span class="nc" id="L270">						prev.setEndTime(cur.getStartTime());</span>
<span class="nc" id="L271">						prev = cur;</span>
					}
<span class="nc" id="L273">					lstIter.remove();</span>
<span class="nc" id="L274">					continue;</span>
				}

<span class="nc bnc" id="L277" title="All 2 branches missed.">				if (prev != null) {</span>
<span class="nc" id="L278">					prev.setEndTime(cur.getStartTime());</span>
				}
<span class="nc" id="L280">				prev = cur;</span>
<span class="nc" id="L281">			}</span>
			// set the end time of the last event to null
<span class="nc bnc" id="L283" title="All 2 branches missed.">			if (prev != null) {</span>
<span class="nc" id="L284">				prev.setEndTime(null);</span>
			}
<span class="nc" id="L286">		}</span>
<span class="nc" id="L287">	}</span>

	private static void updateListInCache(Cache trCache, Map hmList) {
<span class="nc bnc" id="L290" title="All 4 branches missed.">		if (hmList == null || hmList.size() &lt;= 0) {</span>
<span class="nc" id="L291">			return;</span>
		}

<span class="nc" id="L294">		Iterator iter = hmList.keySet().iterator();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L296">			ID key = (ID)iter.next();</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">			if (trCache.lock(key, -1)) {</span>
				try {
<span class="nc" id="L299">					Object value = hmList.get(key);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">					if (value != null) {</span>
<span class="nc" id="L301">						trCache.put(key, value);</span>
					}
				} finally {
<span class="nc" id="L304">					trCache.unLock(key);</span>
<span class="nc" id="L305">				}</span>
			}
<span class="nc" id="L307">		}</span>
<span class="nc" id="L308">	}</span>

	private static TreeSet getListFromCache(Cache trCache, Object key) {
<span class="nc bnc" id="L311" title="All 2 branches missed.">		if (trCache.lock(key, -1)) {</span>
			try {
<span class="nc" id="L313">				return (TreeSet)trCache.get(key);</span>
			} finally {
<span class="nc" id="L315">				trCache.unLock(key);</span>
			}
		}

<span class="nc" id="L319">		return null;</span>
	}

	public static HashMap getObjects(Cache trCache, Collection empIDColl, Date startTime, Date endTime) {
<span class="nc bnc" id="L323" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L324">			StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L325">			buf.append(&quot;Enter: getObjects&quot;);</span>
<span class="nc" id="L326">			buf.append(empIDColl);</span>
<span class="nc" id="L327">			buf.append(&quot;;&quot;);</span>
<span class="nc" id="L328">			buf.append(startTime);</span>
<span class="nc" id="L329">			buf.append(&quot;;&quot;);</span>
<span class="nc" id="L330">			buf.append(endTime);</span>

<span class="nc" id="L332">			m_cat.debug(buf.toString());</span>
		}

<span class="nc" id="L335">		HashMap retVal = new HashMap();</span>
<span class="nc" id="L336">		Date dt[] = getCurrentCacheWindow();</span>
<span class="nc" id="L337">		TreeSet lst = null;</span>

<span class="nc" id="L339">		Iterator iter = empIDColl.iterator();</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L341">			ID key = (ID)iter.next();</span>
<span class="nc" id="L342">			ArrayList empLst = new ArrayList();</span>

<span class="nc" id="L344">			lst = getListFromCache(trCache, key);</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">			if (lst == null) //reload the cache</span>
			{
				try {
<span class="nc" id="L348">					TimeTrackingDAO dao = new TimeTrackingDAO();</span>
<span class="nc" id="L349">					HashMap hm = dao.getEventsForWorkResource(Collections.singletonList(key), dt[0], dt[1]);</span>
<span class="nc bnc" id="L350" title="All 4 branches missed.">					if (hm != null &amp;&amp; hm.size() &gt; 0) {</span>
<span class="nc" id="L351">						Iterator listIter = hm.values().iterator();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">						while (listIter.hasNext()) {</span>
<span class="nc" id="L353">							insertInCache(trCache, (Collection)listIter.next());</span>
						}
						// get the updated list
<span class="nc" id="L356">						lst = getListFromCache(trCache, key);</span>
<span class="nc" id="L357">					} else {</span>
						// add an empty list, this will prevent reloading the cache
<span class="nc" id="L359">						updateListInCache(trCache, Collections.singletonMap(key, new TreeSet()));</span>
					}
<span class="nc" id="L361">				} catch (Exception ex) {</span>
<span class="nc" id="L362">					m_cat.error(ex.getMessage(), ex);</span>
<span class="nc" id="L363">				}</span>
			}

<span class="nc bnc" id="L366" title="All 2 branches missed.">			if (lst != null) {</span>
<span class="nc" id="L367">				Iterator lstIter = lst.iterator();</span>

<span class="nc bnc" id="L369" title="All 2 branches missed.">				while (lstIter.hasNext()) {</span>
<span class="nc" id="L370">					TimeTrackingEvent cur = (TimeTrackingEvent)lstIter.next();</span>

					// make a copy 
<span class="nc" id="L373">					TimeTrackingEvent newEvent = new TimeTrackingEvent(cur);</span>
<span class="nc" id="L374">					empLst.add(newEvent);</span>
<span class="nc" id="L375">				}</span>
<span class="nc" id="L376">				retVal.put(key, empLst);</span>
			}
<span class="nc" id="L378">		}</span>
		// filter &quot;No Activity&quot; events
<span class="nc" id="L380">		filterNoActivity(retVal);</span>

<span class="nc bnc" id="L382" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L383">			StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L384">			buf.append(retVal);</span>

<span class="nc" id="L386">			m_cat.debug(buf.toString());</span>
		}
<span class="nc" id="L388">		return retVal;</span>
	}
	
	public static Date increaseDateBySec(Date date, int interval){
<span class="nc" id="L392">		Date result = date;</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">		if(date != null) {</span>
<span class="nc" id="L394">			Calendar calendar = Calendar.getInstance();</span>
<span class="nc" id="L395">			calendar.setTime(date);</span>
<span class="nc" id="L396">			calendar.add(Calendar.SECOND, interval);</span>
<span class="nc" id="L397">			result = new Date(calendar.getTimeInMillis());</span>
		}
<span class="nc" id="L399">		return result;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>