<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TOHoursPerDayUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb</a> &gt; <span class="el_source">TOHoursPerDayUtil.java</span></div><h1>TOHoursPerDayUtil.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Set;
import java.util.StringTokenizer;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.cache.CacheUtilBBM;
import com.bluepumpkin.ejb.bbm.schedule.model.TimeOffEvent;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.DailyHoursBuckets;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TimeOffLengthCalculator;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbLogBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDay;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.verint.ejb.wfm.IDailyHoursBuckets;
import com.verint.ejb.wfm.ITimeOffHoursPerDayUtil;

<span class="nc" id="L36">public class TOHoursPerDayUtil implements ITimeOffHoursPerDayUtil {</span>
<span class="fc" id="L37">	private static Category m_cat = Log.initCategory(TOHoursPerDayUtil.class.getName());</span>

	public static TOHoursPerDay convertTOChoiceToHoursPerDay(TORequest toRequest, TOChoice toChoice, ID empID) throws BbmUpdateException {
<span class="nc bnc" id="L40" title="All 2 branches missed.">		if (toRequest.getTimeOffDebitType().equals(TORequest.DEBITTYPE_DONT_DEBIT)) {</span>
<span class="nc" id="L41">			throw new BbmUpdateException(RmEjbLogBundleKey.BUNDLE_NAME, RmEjbLogBundleKey.INVALID_REQUEST_TYPE, new Object[]{toRequest.getTimeOffDebitType()}); </span>
		}
<span class="nc bnc" id="L43" title="All 2 branches missed.">		TOHoursPerDay hoursPerDay = toChoice==null? null: toChoice.getHoursPerDay();</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">		if (hoursPerDay == null) {</span>
<span class="nc" id="L45">			hoursPerDay = new TOHoursPerDay();</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">			if(toChoice!=null) {</span>
<span class="nc" id="L47">			toChoice.setHoursPerDay(hoursPerDay);</span>
		}
		}
<span class="nc bnc" id="L50" title="All 2 branches missed.">		if(toChoice!=null) {</span>
<span class="nc" id="L51">		hoursPerDay.setTOChoiceID(toChoice.getID());</span>
<span class="nc" id="L52">		hoursPerDay.setTimeOffChoiceRank(toChoice.getRank());</span>
<span class="nc" id="L53">		hoursPerDay.setStartTime(toChoice.getStartDate());</span>
<span class="nc" id="L54">		hoursPerDay.setEndTime(toChoice.getEndDate());</span>
		}
<span class="nc" id="L56">		hoursPerDay.setEmployeeID(empID);</span>
<span class="nc" id="L57">		hoursPerDay.setActivityID(toRequest.getTimeOffType());</span>
<span class="nc" id="L58">		hoursPerDay.setIsDirty(true);</span>
<span class="nc" id="L59">		hoursPerDay.setTimeOffRule(toRequest.getTimeOffRule());</span>
<span class="nc" id="L60">		hoursPerDay.setExpiryDate(toRequest.getExpirationDate());</span>
		
		/*
		if (toRequest.getTimeOffDebitType().equals(TORequest.DEBITTYPE_DEBIT)) {
			hoursPerDay.setTimeOffRule(TimeOffEvent.TIME_OFF_RULE_USE_MINSTOWARDSRULES);
		} else if (toRequest.getTimeOffDebitType().equals(TORequest.DEBITTYPE_DEBIT_ONLY_IF)) {
			hoursPerDay.setTimeOffRule(TimeOffEvent.TIME_OFF_RULE_USE_SHIFT);
		} else */
		
<span class="nc" id="L69">		hoursPerDay.setDirtyTime(new Date());</span>
<span class="nc" id="L70">		hoursPerDay.setStatus(toRequest.getRequestStatus());</span>
<span class="nc" id="L71">		return hoursPerDay;</span>
	}

	public static Collection convertTOEventCollectionToHoursPerDay(Collection toEventCol, ID empID) {
<span class="nc" id="L75">		Collection hoursPerDayList = new ArrayList();</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">		for (Iterator iterator = toEventCol.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L77">			TimeOffEvent event = (TimeOffEvent) iterator.next();</span>
<span class="nc" id="L78">			hoursPerDayList.add(convertTOEventToHoursPerDay(null, event, empID));</span>
<span class="nc" id="L79">		}</span>
<span class="nc" id="L80">		return hoursPerDayList;</span>
	}

	public static TOHoursPerDay convertTOEventToHoursPerDay(TOHoursPerDay hoursPerDay, TimeOffEvent toEvent, ID empID) {
<span class="nc bnc" id="L84" title="All 2 branches missed.">		if (hoursPerDay == null) {</span>
<span class="nc" id="L85">			hoursPerDay = new TOHoursPerDay();</span>
		}
<span class="nc" id="L87">		hoursPerDay.setEmployeeID(empID);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">		if (toEvent!=null){</span>
<span class="nc" id="L89">		hoursPerDay.setTOEventID(toEvent.getID());</span>
<span class="nc" id="L90">		hoursPerDay.setActivityID(toEvent.getActivityID());</span>
<span class="nc" id="L91">		hoursPerDay.setStartTime(toEvent.getStartTime());</span>
<span class="nc" id="L92">		hoursPerDay.setEndTime(toEvent.getEndTime());</span>
<span class="nc" id="L93">		hoursPerDay.setTimeOffRule(toEvent.getTimeOffRule());</span>
<span class="nc" id="L94">		hoursPerDay.setTotalMinutes(toEvent.getCountsMinutesTowardsRules());</span>
<span class="nc" id="L95">		hoursPerDay.setOriginalMinutes(toEvent.getCountsMinutesTowardsRules());</span>
		}
<span class="nc" id="L97">		hoursPerDay.setIsDirty(true);</span>
<span class="nc" id="L98">		hoursPerDay.setDirtyTime(new Date());</span>
<span class="nc" id="L99">		hoursPerDay.setStatus(RequestAuditTrail.STATUS_APPROVED);</span>
<span class="nc" id="L100">		return hoursPerDay;</span>
	}

	public static String convertDailyBucketsToHoursPerDayString(DailyHoursBuckets buckets) {
<span class="nc" id="L104">		StringBuffer hoursPerDayStr = new StringBuffer();</span>
<span class="nc" id="L105">		hoursPerDayStr.append(buckets.getPeriodFlag()).append(&quot;:&quot;);</span>
<span class="nc" id="L106">		double preValue = -999;</span>
<span class="nc" id="L107">		int repeatvalueCounter = 0;</span>
<span class="nc" id="L108">		boolean addComma = false;</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">		for (int i = 0; i &lt; buckets.getSize(); i++) {</span>
<span class="nc" id="L110">			double hrsPerdayDouble = buckets.getBucketHours(i);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">			if (preValue != hrsPerdayDouble) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">				if (i != 0) {</span>
<span class="nc" id="L113">					appendValue(addComma, repeatvalueCounter, preValue, hoursPerDayStr);</span>
<span class="nc" id="L114">					addComma = true;</span>
				}
<span class="nc" id="L116">				preValue = hrsPerdayDouble;</span>
<span class="nc" id="L117">				repeatvalueCounter = 0;</span>

			}
<span class="nc" id="L120">			repeatvalueCounter++;</span>
		}
<span class="nc" id="L122">		appendValue(addComma, repeatvalueCounter, preValue, hoursPerDayStr);</span>
<span class="nc" id="L123">		return hoursPerDayStr.toString();</span>
	}

	public static void appendValue(boolean addComma, int repeatvalueCounter, double preValue, StringBuffer hoursPerDayStr) {
<span class="nc bnc" id="L127" title="All 2 branches missed.">		if (addComma) {</span>
<span class="nc" id="L128">			hoursPerDayStr.append(',');</span>
		}
<span class="nc bnc" id="L130" title="All 2 branches missed.">		if (repeatvalueCounter &gt; 1) {</span>
<span class="nc" id="L131">			hoursPerDayStr.append(repeatvalueCounter).append('|');</span>
		}
<span class="nc" id="L133">		int hrsPerdayInt = (int) preValue;</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">		if (hrsPerdayInt != preValue) {</span>
<span class="nc" id="L135">			BigDecimal bd = new BigDecimal(preValue);</span>
<span class="nc" id="L136">			bd = bd.setScale(2, BigDecimal.ROUND_HALF_UP);</span>
<span class="nc" id="L137">			hoursPerDayStr.append(bd.doubleValue());</span>
<span class="nc" id="L138">		} else {</span>
<span class="nc" id="L139">			hoursPerDayStr.append(hrsPerdayInt);</span>
		}
<span class="nc" id="L141">	}</span>
	//toHoursPerDayToBeUpdated will be updated with all the refreshed contents of  toHoursPerDayNew Object
	public static TOHoursPerDay updateTOEventToHoursPerDay(TOHoursPerDay hoursPerDayToBeUpdated, TOHoursPerDay hoursPerDayNewData) {
<span class="nc" id="L144">		hoursPerDayToBeUpdated.setTOEventID(hoursPerDayNewData.getTOEventID());</span>
<span class="nc" id="L145">		hoursPerDayToBeUpdated.setTOChoiceID(hoursPerDayNewData.getTOChoiceID());</span>
<span class="nc" id="L146">		hoursPerDayToBeUpdated.setTimeOffChoiceRank(hoursPerDayNewData.getTimeOffChoiceRank());</span>
<span class="nc" id="L147">		hoursPerDayToBeUpdated.setEmployeeID(hoursPerDayNewData.getEmployeeID());</span>
<span class="nc" id="L148">		hoursPerDayToBeUpdated.setStartTime(hoursPerDayNewData.getStartTime());</span>
<span class="nc" id="L149">		hoursPerDayToBeUpdated.setEndTime(hoursPerDayNewData.getEndTime());</span>
<span class="nc" id="L150">		hoursPerDayToBeUpdated.setTimeOffRule(hoursPerDayNewData.getTimeOffRule());</span>
<span class="nc" id="L151">		hoursPerDayToBeUpdated.setHoursPerDay(hoursPerDayNewData.getHoursPerDay());</span>
<span class="nc" id="L152">		hoursPerDayToBeUpdated.setTotalMinutes(hoursPerDayNewData.getTotalMinutes());</span>
<span class="nc" id="L153">		hoursPerDayToBeUpdated.setOriginalMinutes(hoursPerDayNewData.getOriginalMinutes());</span>
<span class="nc" id="L154">		hoursPerDayToBeUpdated.setOriginalHoursPerDay(hoursPerDayNewData.getOriginalHoursPerDay());</span>
<span class="nc" id="L155">		hoursPerDayToBeUpdated.setIsDirty(hoursPerDayNewData.getIsDirty());</span>
<span class="nc" id="L156">		hoursPerDayToBeUpdated.setDirtyTime(hoursPerDayNewData.getDirtyTime());</span>
<span class="nc" id="L157">		hoursPerDayToBeUpdated.setStatus(hoursPerDayNewData.getStatus());</span>
<span class="nc" id="L158">		hoursPerDayToBeUpdated.setExpiryDate(hoursPerDayNewData.getExpiryDate());</span>
<span class="nc" id="L159">		hoursPerDayToBeUpdated.setTotalMinutesFromDefault(hoursPerDayNewData.getTotalMinutesFromDefaulted());</span>
<span class="nc" id="L160">		hoursPerDayToBeUpdated.setTotalMinutesFromScheduled(hoursPerDayNewData.getTotalMinutesFromScheduled());</span>

<span class="nc" id="L162">		return hoursPerDayToBeUpdated;</span>
	}

	public static Organization getOrganization(TOHoursPerDay hoursPerDay) {
		Organization org;
		try {
<span class="nc" id="L168">			ID orgId = ValidationUtil.getOrgIDForEmployeeDuringPeriod</span>
<span class="nc" id="L169">			        (hoursPerDay.getEmployeeID(), hoursPerDay.getStartTime(), hoursPerDay.getStartTime());</span>
<span class="nc" id="L170">			org = CacheUtilBBM.getOrganizationByID(orgId);</span>
<span class="nc" id="L171">			org.getName(); // just to check if Org is not null; else expect a Illegal Arg Exception</span>
<span class="nc" id="L172">		} catch (Exception e) {</span>
<span class="nc" id="L173">			throw new IllegalArgumentException(&quot;Invalid Org details for:&quot; + hoursPerDay);</span>
<span class="nc" id="L174">		}</span>
<span class="nc" id="L175">		return org;</span>
	}

	/*
	DECODER RING FOR HOURSPERDAY
	
	FLAG:LENGTH, REPEAT_DAYS| LENGTH

	FLAGS:
	DAILYHOURSBUCKETS_PERIOD_INIT  		0
	DAILYHOURSBUCKETS_PERIOD_SCHED  	1
	DAILYHOURSBUCKETS_PERIOD_OVERLAP  	2
	DAILYHOURSBUCKETS_PERIOD_UNSCHED  	3

	Examples
	1:0,6.5
	2:2|0
	3:8
	1:0,2|8.5
	 */
	public static DailyHoursBuckets getDailyHoursBucketsForDateRange(Organization org, TOHoursPerDay hoursPerDay, Date startDate, Date endDate) {
<span class="nc bnc" id="L196" title="All 2 branches missed.">		if (org == null) {</span>
<span class="nc" id="L197">			org = getOrganization(hoursPerDay);</span>
		}
<span class="nc" id="L199">		int orgDayOffset = org.getDayBoundaryOffset();</span>
<span class="nc" id="L200">		TimeZone orgTimeZone = org.getTimeZone();</span>
<span class="nc" id="L201">		Date end = hoursPerDay.getEndTime();</span>
<span class="nc" id="L202">		Date curDay = hoursPerDay.getStartTime();</span>
<span class="nc bnc" id="L203" title="All 8 branches missed.">		if (startDate == null || endDate == null || startDate.before(curDay) || endDate.after(end)) {</span>
<span class="nc" id="L204">			throw new IllegalArgumentException(&quot;hoursPerDay ID=&quot; + hoursPerDay.getID() + &quot; : TO Event start date:&quot; + curDay +</span>
			        &quot; after  given date : &quot; + startDate +
			        &quot; or given end Date: &quot; + endDate + &quot; for Calc  after  hoursPerDay.getEndTime &quot; + end);
		}
		
		//Move the start Date and end Date to OrgDay start and OrgDay end
		//since 1 day is the least count for TO Calculator / DailyBuckets
		//Bug Fix for QC28841 :Time off duration is not broken across boundary day, Sameet Nov 2008
		/*startDate= TOCalcUtil.getDateForOrgDayStart(orgTimeZone,orgDayOffset,startDate);
		endDate = TOCalcUtil.getDateForOrgDayEnd(orgTimeZone,orgDayOffset,endDate);*/

<span class="nc" id="L215">		TimeRange range = new TimeRange(startDate, endDate);</span>
<span class="nc" id="L216">		DailyHoursBuckets dayBuckets = new DailyHoursBuckets(orgDayOffset, orgTimeZone, range);</span>
<span class="nc" id="L217">		startDate =dayBuckets.getDHBRangeStartAsOrgDayStart();</span>
<span class="nc" id="L218">		endDate = dayBuckets.getDHBRangeEndAsOrgDayEnd();</span>
		
		
		
<span class="nc bnc" id="L222" title="All 2 branches missed.">		if (hoursPerDay.getHoursPerDay() == null) {</span>
<span class="nc" id="L223">			return dayBuckets;</span>
		}
		
<span class="nc" id="L226">		int minutesDefaulted = hoursPerDay.getTotalMinutesFromDefaulted();</span>
<span class="nc" id="L227">		int minutesScheduled = hoursPerDay.getTotalMinutesFromScheduled();</span>
<span class="nc" id="L228">		dayBuckets.setTotalMinutesFromDefault(minutesDefaulted);</span>
<span class="nc" id="L229">		dayBuckets.setTotalMinutesFromSchedule(minutesScheduled);</span>
		
<span class="nc" id="L231">		StringTokenizer st = new StringTokenizer(hoursPerDay.getHoursPerDay(), &quot;:&quot;);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">		if (!st.hasMoreElements()) { </span>
<span class="nc" id="L233">			return dayBuckets;</span>
		}
<span class="nc" id="L235">		dayBuckets.setPeriodFlag((new Integer(st.nextElement().toString())).intValue());</span>
<span class="nc" id="L236">		String hrsPerDayStr = st.nextElement().toString();</span>
<span class="nc" id="L237">		st = new StringTokenizer(hrsPerDayStr, &quot;,&quot;);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">		while (st.hasMoreElements()) {</span>
<span class="nc" id="L239">			String hours = (String) st.nextElement();</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">			if (hours.indexOf(&quot;|&quot;) != -1) {</span>
<span class="nc" id="L241">				StringTokenizer st1 = new StringTokenizer(hours, &quot;|&quot;);</span>
<span class="nc" id="L242">				int count = Integer.parseInt(st1.nextToken());</span>
<span class="nc" id="L243">				float value = Float.parseFloat(st1.nextToken());</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">				for (int ix = 0; ix &lt; count; ix++) {</span>
<span class="nc" id="L245">					curDay = _addToBucketAndMoveForwardOneDay(org, dayBuckets, curDay, startDate, endDate, value);</span>
				}
<span class="nc" id="L247">			} else {</span>
<span class="nc" id="L248">				curDay = _addToBucketAndMoveForwardOneDay(org, dayBuckets, curDay, startDate, endDate, Float.parseFloat(hours));</span>
			}
<span class="nc" id="L250">		}</span>
<span class="nc" id="L251">		return dayBuckets;</span>
	}

	private static Date _addToBucketAndMoveForwardOneDay(Organization org, DailyHoursBuckets dayBuckets, Date curDay, Date startDate, Date endDate, float hours) {
<span class="nc bnc" id="L255" title="All 4 branches missed.">		if (!curDay.before(startDate) &amp;&amp; !curDay.after(endDate)) { // the Current date should be in the requested Time Range.</span>
<span class="nc" id="L256">			dayBuckets.addToBucket(curDay, hours);</span>
		}
<span class="nc" id="L258">		return TOCalcUtil.getDateForwardOneDay(curDay, org.getTimeZone());</span>
	}

	// granualrity for this method is calculation for the whole day ,
	// if you want partial time period like starts at mid day and ends at mid day or for few hours within a day
	// then Time Off calculator should be used for that.

	
	@Override
	public IDailyHoursBuckets getDailyHoursBuckets(Organization org, Date start, Date end, String hours) {
<span class="nc" id="L268">		TOHoursPerDay toHrsPerDay = new TOHoursPerDay();</span>
<span class="nc" id="L269">		toHrsPerDay.setStartTime(start); </span>
<span class="nc" id="L270">		toHrsPerDay.setEndTime(end);</span>
<span class="nc" id="L271">		toHrsPerDay.setHoursPerDay(hours);</span>
<span class="nc" id="L272">		return getDailyHoursBuckets( org,  toHrsPerDay);</span>
		
	}
	
	public static DailyHoursBuckets getDailyHoursBuckets(Organization org, TOHoursPerDay hoursPerDay) {
<span class="nc" id="L277">		return getDailyHoursBucketsForDateRange(org, hoursPerDay, hoursPerDay.getStartTime(), hoursPerDay.getEndTime());</span>
	}

	public static TOHoursPerDay calcMinutesForToChoice(TORequest tor, TimeOffLengthCalculator toCalc, TOChoice choice) throws Exception {
<span class="nc" id="L281">		DailyHoursBuckets dailyBuckets = toCalc.calculateDailyLengths(choice.getStartDate(), choice.getEndDate(), tor.getTimeOffType());</span>
<span class="nc" id="L282">		TOHoursPerDay hoursPerDay = TOHoursPerDayUtil.convertTOChoiceToHoursPerDay(tor, choice, tor.getEmployeeID());</span>
<span class="nc" id="L283">		hoursPerDay.setHoursPerDay(TOHoursPerDayUtil.convertDailyBucketsToHoursPerDayString(dailyBuckets));</span>
<span class="nc" id="L284">        hoursPerDay.setTotalMinutes(dailyBuckets.getTotalMinutes());</span>
<span class="nc" id="L285">        hoursPerDay.setTotalMinutesFromDefault(dailyBuckets.getTotalMinutesFromDefault());</span>
<span class="nc" id="L286">        hoursPerDay.setTotalMinutesFromScheduled(dailyBuckets.getTotalMinutesFromSchedule());</span>
<span class="nc" id="L287">        hoursPerDay.setOriginalMinutes(dailyBuckets.getTotalMinutes());</span>
<span class="nc" id="L288">		hoursPerDay.setIsDirty(false);</span>
<span class="nc" id="L289">		hoursPerDay.setDirtyTime(new Date());</span>
<span class="nc" id="L290">		choice.setHoursPerDay(hoursPerDay);</span>
		//JT
<span class="nc" id="L292">		choice.setInUnpublishedGap(toCalc.getIsInUnpublishededGap());</span>
<span class="nc" id="L293">		return hoursPerDay;</span>
	}

	public static TOHoursPerDay refreshMinsForTOHoursPerDay(TOHoursPerDay hrsPerDay, TimeOffLengthCalculator toCalc, StringBuilder hoursPerDayChange) throws Exception {
<span class="nc" id="L297">		Date pubDate = toCalc.getLastPublishedShiftDayEnd();</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">		boolean useFixedMins = hrsPerDay.getStartTime().after(pubDate)</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">		        &amp;&amp; (hrsPerDay.getTimeOffRule() == TimeOffEvent.TIME_OFF_RULE_USE_MINSTOWARDSRULES)</span>
<span class="nc bnc" id="L300" title="All 4 branches missed.">		        &amp;&amp; (hrsPerDay.getTOEventID() != null || RequestAuditTrail.STATUS_APPROVED.equals(hrsPerDay.getStatus()));</span>
		DailyHoursBuckets dailyBuckets;
<span class="nc bnc" id="L302" title="All 4 branches missed.">		if (useFixedMins &amp;&amp; hrsPerDay.areOriginalMinutesAvailable()) {</span>
			// When original mins are available, this daily length computation is still needed for those cases where 
			// the hrsPerDay.getToEventID() is not null. 
			// Such TOEvents converted to TOHrsPerDay via a call to convertTOEventToHoursPerDay(TOHoursPerDay, TimeOffEvent, ID)
			// do not have the hoursPerDay entry. Hence, this daily length computation is needed to subsequently calculate hoursPerDay
<span class="nc" id="L307">			dailyBuckets = toCalc.calculateDailyLengthsForGivenTotalLength</span>
<span class="nc" id="L308">			        (hrsPerDay.getStartTime(), hrsPerDay.getEndTime(), hrsPerDay.getActivityID(), hrsPerDay.getTotalMinutes());</span>
		} else {
<span class="nc" id="L310">			dailyBuckets = toCalc.calculateDailyLengths(hrsPerDay.getStartTime(), hrsPerDay.getEndTime(), hrsPerDay.getActivityID());</span>
		}
		
		
		
		
        
<span class="nc" id="L317">		String hrsPerDayOld = hrsPerDay.getHoursPerDay();</span>
<span class="nc" id="L318">		int totalMinsOld = hrsPerDay.getTotalMinutes();</span>
<span class="nc" id="L319">		hrsPerDay.setHoursPerDay(TOHoursPerDayUtil.convertDailyBucketsToHoursPerDayString(dailyBuckets));</span>
<span class="nc" id="L320">		hrsPerDay.setTotalMinutesFromDefault(dailyBuckets.getTotalMinutesFromDefault());</span>
<span class="nc" id="L321">		hrsPerDay.setTotalMinutesFromScheduled(dailyBuckets.getTotalMinutesFromSchedule());</span>
		
<span class="nc" id="L323">		String origHoursPerDay = hrsPerDay.getOriginalHoursPerDay();</span>
<span class="nc bnc" id="L324" title="All 6 branches missed.">		if (useFixedMins &amp;&amp; hrsPerDay.areOriginalHoursAvailable() &amp;&amp; !origHoursPerDay.isEmpty()) { </span>
			// This is called into when a publish-&gt;unpublish into the future needs to reset the total mins and hrs per day 
			// to the originalHoursPerDay and origMins. ESR#4551574 
			// It would not suffice to check if just the originalMins are available, since you could end up copying an
			// empty originalHoursPerDay that shows 0 scheduled hours in the TO Calendar, even if the agents screen shows
			// more than 0 hrs scheduled for a request.
<span class="nc" id="L330">			hrsPerDay.setTotalMinutes(hrsPerDay.getOriginalMinutes());</span>
<span class="nc" id="L331">			hrsPerDay.setHoursPerDay(origHoursPerDay);</span>
		} else {
			// how much hours/day are at time of approval, break up
<span class="nc" id="L334">			hrsPerDay.setTotalMinutes(dailyBuckets.getTotalMinutes());  </span>
		}
		
<span class="nc bnc" id="L337" title="All 4 branches missed.">		if (hrsPerDay.refreshOrignalMinutes || !hrsPerDay.areOriginalMinutesAvailable()) {</span>
<span class="nc" id="L338">            hrsPerDay.setOriginalMinutes(dailyBuckets.getTotalMinutes());</span>
		}
		
		// audit how the TOHoursPerDay change before and after approval
<span class="nc bnc" id="L342" title="All 6 branches missed.">			if (hrsPerDayOld != null &amp;&amp; (!hrsPerDay.getHoursPerDay().equals(hrsPerDayOld) || totalMinsOld != hrsPerDay.getTotalMinutes())) {</span>
<span class="nc" id="L343">			hoursPerDayChange.append(&quot;TOHours(Before)=&quot;).append(hrsPerDayOld).append(&quot;\tTOHours(After)=&quot;).append(hrsPerDay.getHoursPerDay());</span>
		}
		
		// get a snapshot of original hours per day to see how this refresh call changes it
<span class="nc" id="L347">		hrsPerDay.setOriginalHoursPerDay(hrsPerDayOld);</span>
		
		//hrsPerDay.setIsInPublishedPeriod(pubDate.after(hrsPerDay.getEndTime())); //Mark IsInPublishedPeriod=true ONLY IF ENTIRE REQ IS IN PUBLISHED RANGE
<span class="nc" id="L350">		hrsPerDay.setIsDirty(false);</span>
<span class="nc" id="L351">		hrsPerDay.setDirtyTime(new Date());</span>
<span class="nc" id="L352">		return hrsPerDay;</span>
	}



	public static Set extractFieldSet(int iField, Collection colItems) {
<span class="nc bnc" id="L358" title="All 4 branches missed.">		if (colItems == null || colItems.isEmpty()) {</span>
<span class="nc" id="L359">			return new HashSet();</span>
		}
<span class="nc" id="L361">		HashSet mapResults = new HashSet(colItems.size());</span>
<span class="nc" id="L362">		Iterator it = colItems.iterator();</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">		while (it.hasNext()) {</span>
<span class="nc" id="L364">			ValueObjectBase item = (ValueObjectBase) it.next();</span>
<span class="nc" id="L365">			Object key = item.getFieldValue(iField);</span>
<span class="nc bnc" id="L366" title="All 4 branches missed.">			if (key != null &amp;&amp; !mapResults.contains(key)) {</span>
<span class="nc" id="L367">				mapResults.add(key);</span>
			}
<span class="nc" id="L369">		}</span>
<span class="nc" id="L370">		return mapResults;</span>
	}

<span class="fc" id="L373">	static TimeZone GMT_TIMEZONE = TimeZone.getTimeZone(&quot;GMT&quot;);</span>

	public static Date getDateForDaysAfter(Date date, int dayCount, TimeZone tz) {
<span class="pc bpc" id="L376" title="1 of 2 branches missed.">		if (date == null) {</span>
<span class="nc" id="L377">			return date;</span>
		}
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">		Calendar cal = Calendar.getInstance((tz != null ? tz : GMT_TIMEZONE));</span>
<span class="fc" id="L380">		cal.setTime(date);</span>
<span class="fc" id="L381">		TOCalcUtil.addDaysToCalendar(cal, dayCount);</span>
		//cal.add(Calendar.DAY_OF_MONTH, dayCount);  // advance by the specified number of days.
<span class="fc" id="L383">		return cal.getTime();</span>
	}

	public static Date getDateForDaysBefore(Date date, int dayCount, TimeZone tz) {
<span class="nc bnc" id="L387" title="All 2 branches missed.">		if (date == null) {</span>
<span class="nc" id="L388">			return date;</span>
		}
<span class="nc bnc" id="L390" title="All 2 branches missed.">		Calendar cal = Calendar.getInstance((tz != null ? tz : GMT_TIMEZONE));</span>
<span class="nc" id="L391">		cal.setTime(date);</span>
<span class="nc" id="L392">		TOCalcUtil.addDaysToCalendar(cal, (-1 * dayCount));</span>
		//cal.add(Calendar.DAY_OF_MONTH, (-1 * dayCount));  // substract by the specified number of days.
<span class="nc" id="L394">		return cal.getTime();</span>
	}

	public static boolean isTOHoursPerDayDifferentFromTOChoice(TORequest toRequest, TOChoice toChoice, TOHoursPerDay hoursPerDay) {
<span class="nc" id="L398">		boolean retval = true;</span>
<span class="nc bnc" id="L399" title="All 8 branches missed.">		if (toRequest != null &amp;&amp; toChoice != null &amp;&amp; hoursPerDay != null &amp;&amp; hoursPerDay.getHoursPerDay() != null &amp;&amp;</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">		        hoursPerDay.getEmployeeID().equals(toRequest.getEmployeeID()) &amp;&amp;</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">		        hoursPerDay.getActivityID().equals(toRequest.getTimeOffType()) &amp;&amp;</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">		        hoursPerDay.getTOChoiceID().equals(toChoice.getID()) &amp;&amp;</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">		        hoursPerDay.getTimeOffChoiceRank() == (toChoice.getRank()) &amp;&amp;</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">		        hoursPerDay.getStartTime().equals(toChoice.getStartDate()) &amp;&amp;</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">		        hoursPerDay.getEndTime().equals(toChoice.getEndDate()) &amp;&amp;</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">		        hoursPerDay.getStatus().equals(toRequest.getRequestStatus()) &amp;&amp;</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">		        hoursPerDay.getTimeOffRule() == toRequest.getTimeOffRule()) {</span>
<span class="nc" id="L408">			retval = false;</span>
		}
<span class="nc bnc" id="L410" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc" id="L411">			m_cat.debug(&quot;isTOHoursPerDayDifferentFromTOChoice=&quot; + retval + &quot; :toChoice= &quot; + toChoice + &quot;\n hoursPerDay=&quot; + hoursPerDay);</span>
		}
<span class="nc" id="L413">		return retval;</span>
	}

	public static boolean isTOHoursPerDayRefreshRequired(TORequest toRequest, TOChoice toChoice, TOHoursPerDay hoursPerDay) {
<span class="nc" id="L417">		boolean retval = true;</span>
<span class="nc bnc" id="L418" title="All 6 branches missed.">		if (toRequest != null &amp;&amp; toChoice != null &amp;&amp; hoursPerDay != null &amp;&amp;</span>
<span class="nc bnc" id="L419" title="All 4 branches missed.">		        hoursPerDay.getHoursPerDay() != null &amp;&amp; hoursPerDay.getID() != null &amp;&amp;</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">		        hoursPerDay.getEmployeeID().equals(toRequest.getEmployeeID()) &amp;&amp;</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">		        hoursPerDay.getActivityID().equals(toRequest.getTimeOffType()) &amp;&amp;</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">		        hoursPerDay.getTOChoiceID().equals(toChoice.getID()) &amp;&amp;</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">		        hoursPerDay.getStartTime().equals(toChoice.getStartDate()) &amp;&amp;</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">		        hoursPerDay.getEndTime().equals(toChoice.getEndDate()) &amp;&amp;</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">		        hoursPerDay.getTimeOffRule() == toRequest.getTimeOffRule()) {</span>
<span class="nc" id="L426">			retval = false;</span>
		}
<span class="nc bnc" id="L428" title="All 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc" id="L429">			m_cat.debug(&quot;isTOHoursPerDayRefreshRequired=&quot; + retval + &quot; :toChoice= &quot; + toChoice + &quot;\n hoursPerDay=&quot; + hoursPerDay);</span>
		}
<span class="nc" id="L431">		return retval;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>