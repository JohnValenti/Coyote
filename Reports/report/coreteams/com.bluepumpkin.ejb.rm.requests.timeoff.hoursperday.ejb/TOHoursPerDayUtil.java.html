<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TOHoursPerDayUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb</a> &gt; <span class="el_source">TOHoursPerDayUtil.java</span></div><h1>TOHoursPerDayUtil.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Set;
import java.util.StringTokenizer;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.cache.CacheUtilBBM;
import com.bluepumpkin.ejb.bbm.schedule.model.TimeOffEvent;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.DailyHoursBuckets;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TimeOffLengthCalculator;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbLogBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDay;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.verint.ejb.wfm.IDailyHoursBuckets;
import com.verint.ejb.wfm.ITimeOffHoursPerDayUtil;

<span class="nc" id="L37">public class TOHoursPerDayUtil implements ITimeOffHoursPerDayUtil {</span>
<span class="fc" id="L38">	private static Category m_cat = Log.initCategory(TOHoursPerDayUtil.class.getName());</span>

	public static TOHoursPerDay convertTOChoiceToHoursPerDay(TORequest toRequest, TOChoice toChoice, ID empID) throws BbmUpdateException {
<span class="pc bpc" id="L41" title="1 of 2 branches missed.">		if (toRequest.getTimeOffDebitType().equals(TORequest.DEBITTYPE_DONT_DEBIT)) {</span>
<span class="nc" id="L42">			throw new BbmUpdateException(RmEjbLogBundleKey.BUNDLE_NAME, RmEjbLogBundleKey.INVALID_REQUEST_TYPE, new Object[]{toRequest.getTimeOffDebitType()}); </span>
		}
<span class="pc bpc" id="L44" title="1 of 2 branches missed.">		TOHoursPerDay hoursPerDay = toChoice==null? null: toChoice.getHoursPerDay();</span>
<span class="fc bfc" id="L45" title="All 2 branches covered.">		if (hoursPerDay == null) {</span>
<span class="fc" id="L46">			hoursPerDay = new TOHoursPerDay();</span>
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">			if(toChoice!=null) {</span>
<span class="fc" id="L48">			toChoice.setHoursPerDay(hoursPerDay);</span>
		}
		}
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">		if(toChoice!=null) {</span>
<span class="fc" id="L52">		hoursPerDay.setTOChoiceID(toChoice.getID());</span>
<span class="fc" id="L53">		hoursPerDay.setTimeOffChoiceRank(toChoice.getRank());</span>
<span class="fc" id="L54">		hoursPerDay.setStartTime(toChoice.getStartDate());</span>
<span class="fc" id="L55">		hoursPerDay.setEndTime(toChoice.getEndDate());</span>
		}
<span class="fc" id="L57">		hoursPerDay.setEmployeeID(empID);</span>
<span class="fc" id="L58">		hoursPerDay.setActivityID(toRequest.getTimeOffType());</span>
<span class="fc" id="L59">		hoursPerDay.setIsDirty(true);</span>
<span class="fc" id="L60">		hoursPerDay.setTimeOffRule(toRequest.getTimeOffRule());</span>
<span class="fc" id="L61">		hoursPerDay.setExpiryDate(toRequest.getExpirationDate());</span>
		
		/*
		if (toRequest.getTimeOffDebitType().equals(TORequest.DEBITTYPE_DEBIT)) {
			hoursPerDay.setTimeOffRule(TimeOffEvent.TIME_OFF_RULE_USE_MINSTOWARDSRULES);
		} else if (toRequest.getTimeOffDebitType().equals(TORequest.DEBITTYPE_DEBIT_ONLY_IF)) {
			hoursPerDay.setTimeOffRule(TimeOffEvent.TIME_OFF_RULE_USE_SHIFT);
		} else */
		
<span class="fc" id="L70">		hoursPerDay.setDirtyTime(new Date());</span>
<span class="fc" id="L71">		hoursPerDay.setStatus(toRequest.getRequestStatus());</span>
<span class="fc" id="L72">		return hoursPerDay;</span>
	}

	public static Collection convertTOEventCollectionToHoursPerDay(Collection toEventCol, ID empID) {
<span class="nc" id="L76">		Collection hoursPerDayList = new ArrayList();</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">		for (Iterator iterator = toEventCol.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L78">			TimeOffEvent event = (TimeOffEvent) iterator.next();</span>
<span class="nc" id="L79">			hoursPerDayList.add(convertTOEventToHoursPerDay(null, event, empID));</span>
<span class="nc" id="L80">		}</span>
<span class="nc" id="L81">		return hoursPerDayList;</span>
	}

	public static TOHoursPerDay convertTOEventToHoursPerDay(TOHoursPerDay hoursPerDay, TimeOffEvent toEvent, ID empID) {
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">		if (hoursPerDay == null) {</span>
<span class="fc" id="L86">			hoursPerDay = new TOHoursPerDay();</span>
		}
<span class="fc" id="L88">		hoursPerDay.setEmployeeID(empID);</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">		if (toEvent!=null){</span>
<span class="fc" id="L90">		hoursPerDay.setTOEventID(toEvent.getID());</span>
<span class="fc" id="L91">		hoursPerDay.setActivityID(toEvent.getActivityID());</span>
<span class="fc" id="L92">		hoursPerDay.setStartTime(toEvent.getStartTime());</span>
<span class="fc" id="L93">		hoursPerDay.setEndTime(toEvent.getEndTime());</span>
<span class="fc" id="L94">		hoursPerDay.setTimeOffRule(toEvent.getTimeOffRule());</span>
<span class="fc" id="L95">		hoursPerDay.setTotalMinutes(toEvent.getCountsMinutesTowardsRules());</span>
<span class="fc" id="L96">		hoursPerDay.setOriginalMinutes(toEvent.getCountsMinutesTowardsRules());</span>
		}
<span class="fc" id="L98">		hoursPerDay.setIsDirty(true);</span>
<span class="fc" id="L99">		hoursPerDay.setDirtyTime(new Date());</span>
<span class="fc" id="L100">		hoursPerDay.setStatus(RequestAuditTrail.STATUS_APPROVED);</span>
<span class="fc" id="L101">		return hoursPerDay;</span>
	}

	public static String convertDailyBucketsToHoursPerDayString(DailyHoursBuckets buckets) {
<span class="fc" id="L105">		StringBuffer hoursPerDayStr = new StringBuffer();</span>
<span class="fc" id="L106">		hoursPerDayStr.append(buckets.getPeriodFlag()).append(&quot;:&quot;);</span>
<span class="fc" id="L107">		double preValue = -999;</span>
<span class="fc" id="L108">		int repeatvalueCounter = 0;</span>
<span class="fc" id="L109">		boolean addComma = false;</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">		for (int i = 0; i &lt; buckets.getSize(); i++) {</span>
<span class="fc" id="L111">			double hrsPerdayDouble = buckets.getBucketHours(i);</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">			if (preValue != hrsPerdayDouble) {</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">				if (i != 0) {</span>
<span class="fc" id="L114">					appendValue(addComma, repeatvalueCounter, preValue, hoursPerDayStr);</span>
<span class="fc" id="L115">					addComma = true;</span>
				}
<span class="fc" id="L117">				preValue = hrsPerdayDouble;</span>
<span class="fc" id="L118">				repeatvalueCounter = 0;</span>

			}
<span class="fc" id="L121">			repeatvalueCounter++;</span>
		}
<span class="fc" id="L123">		appendValue(addComma, repeatvalueCounter, preValue, hoursPerDayStr);</span>
<span class="fc" id="L124">		return hoursPerDayStr.toString();</span>
	}

	public static void appendValue(boolean addComma, int repeatvalueCounter, double preValue, StringBuffer hoursPerDayStr) {
<span class="fc bfc" id="L128" title="All 2 branches covered.">		if (addComma) {</span>
<span class="fc" id="L129">			hoursPerDayStr.append(',');</span>
		}
<span class="fc bfc" id="L131" title="All 2 branches covered.">		if (repeatvalueCounter &gt; 1) {</span>
<span class="fc" id="L132">			hoursPerDayStr.append(repeatvalueCounter).append('|');</span>
		}
<span class="fc" id="L134">		int hrsPerdayInt = (int) preValue;</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">		if (hrsPerdayInt != preValue) {</span>
<span class="nc" id="L136">			BigDecimal bd = new BigDecimal(preValue);</span>
<span class="nc" id="L137">			bd = bd.setScale(2, BigDecimal.ROUND_HALF_UP);</span>
<span class="nc" id="L138">			hoursPerDayStr.append(bd.doubleValue());</span>
<span class="nc" id="L139">		} else {</span>
<span class="fc" id="L140">			hoursPerDayStr.append(hrsPerdayInt);</span>
		}
<span class="fc" id="L142">	}</span>
	//toHoursPerDayToBeUpdated will be updated with all the refreshed contents of  toHoursPerDayNew Object
	public static TOHoursPerDay updateTOEventToHoursPerDay(TOHoursPerDay hoursPerDayToBeUpdated, TOHoursPerDay hoursPerDayNewData) {
<span class="nc" id="L145">		hoursPerDayToBeUpdated.setTOEventID(hoursPerDayNewData.getTOEventID());</span>
<span class="nc" id="L146">		hoursPerDayToBeUpdated.setTOChoiceID(hoursPerDayNewData.getTOChoiceID());</span>
<span class="nc" id="L147">		hoursPerDayToBeUpdated.setTimeOffChoiceRank(hoursPerDayNewData.getTimeOffChoiceRank());</span>
<span class="nc" id="L148">		hoursPerDayToBeUpdated.setEmployeeID(hoursPerDayNewData.getEmployeeID());</span>
<span class="nc" id="L149">		hoursPerDayToBeUpdated.setStartTime(hoursPerDayNewData.getStartTime());</span>
<span class="nc" id="L150">		hoursPerDayToBeUpdated.setEndTime(hoursPerDayNewData.getEndTime());</span>
<span class="nc" id="L151">		hoursPerDayToBeUpdated.setTimeOffRule(hoursPerDayNewData.getTimeOffRule());</span>
<span class="nc" id="L152">		hoursPerDayToBeUpdated.setHoursPerDay(hoursPerDayNewData.getHoursPerDay());</span>
<span class="nc" id="L153">		hoursPerDayToBeUpdated.setTotalMinutes(hoursPerDayNewData.getTotalMinutes());</span>
<span class="nc" id="L154">		hoursPerDayToBeUpdated.setOriginalMinutes(hoursPerDayNewData.getOriginalMinutes());</span>
<span class="nc" id="L155">		hoursPerDayToBeUpdated.setOriginalHoursPerDay(hoursPerDayNewData.getOriginalHoursPerDay());</span>
<span class="nc" id="L156">		hoursPerDayToBeUpdated.setIsDirty(hoursPerDayNewData.getIsDirty());</span>
<span class="nc" id="L157">		hoursPerDayToBeUpdated.setDirtyTime(hoursPerDayNewData.getDirtyTime());</span>
<span class="nc" id="L158">		hoursPerDayToBeUpdated.setStatus(hoursPerDayNewData.getStatus());</span>
<span class="nc" id="L159">		hoursPerDayToBeUpdated.setExpiryDate(hoursPerDayNewData.getExpiryDate());</span>
<span class="nc" id="L160">		hoursPerDayToBeUpdated.setTotalMinutesFromDefault(hoursPerDayNewData.getTotalMinutesFromDefaulted());</span>
<span class="nc" id="L161">		hoursPerDayToBeUpdated.setTotalMinutesFromScheduled(hoursPerDayNewData.getTotalMinutesFromScheduled());</span>

<span class="nc" id="L163">		return hoursPerDayToBeUpdated;</span>
	}

	public static Organization getOrganization(TOHoursPerDay hoursPerDay) {
		Organization org;
		try {
<span class="nc" id="L169">			ID orgId = ValidationUtil.getOrgIDForEmployeeDuringPeriod</span>
<span class="nc" id="L170">			        (hoursPerDay.getEmployeeID(), hoursPerDay.getStartTime(), hoursPerDay.getStartTime());</span>
<span class="nc" id="L171">			org = CacheUtilBBM.getOrganizationByID(orgId);</span>
<span class="nc" id="L172">			org.getName(); // just to check if Org is not null; else expect a Illegal Arg Exception</span>
<span class="nc" id="L173">		} catch (Exception e) {</span>
<span class="nc" id="L174">			throw new IllegalArgumentException(&quot;Invalid Org details for:&quot; + hoursPerDay);</span>
<span class="nc" id="L175">		}</span>
<span class="nc" id="L176">		return org;</span>
	}

	/*
	DECODER RING FOR HOURSPERDAY
	
	FLAG:LENGTH, REPEAT_DAYS| LENGTH

	FLAGS:
	DAILYHOURSBUCKETS_PERIOD_INIT  		0
	DAILYHOURSBUCKETS_PERIOD_SCHED  	1
	DAILYHOURSBUCKETS_PERIOD_OVERLAP  	2
	DAILYHOURSBUCKETS_PERIOD_UNSCHED  	3

	Examples
	1:0,6.5
	2:2|0
	3:8
	1:0,2|8.5
	 */
	public static DailyHoursBuckets getDailyHoursBucketsForDateRange(Organization org, TOHoursPerDay hoursPerDay, Date startDate, Date endDate) {
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">		if (org == null) {</span>
<span class="nc" id="L198">			org = getOrganization(hoursPerDay);</span>
		}
<span class="fc" id="L200">		int orgDayOffset = org.getDayBoundaryOffset();</span>
<span class="fc" id="L201">		TimeZone orgTimeZone = org.getTimeZone();</span>
<span class="fc" id="L202">		Date end = hoursPerDay.getEndTime();</span>
<span class="fc" id="L203">		Date curDay = hoursPerDay.getStartTime();</span>
<span class="pc bpc" id="L204" title="4 of 8 branches missed.">		if (startDate == null || endDate == null || startDate.before(curDay) || endDate.after(end)) {</span>
<span class="nc" id="L205">			throw new IllegalArgumentException(&quot;hoursPerDay ID=&quot; + hoursPerDay.getID() + &quot; : TO Event start date:&quot; + curDay +</span>
			        &quot; after  given date : &quot; + startDate +
			        &quot; or given end Date: &quot; + endDate + &quot; for Calc  after  hoursPerDay.getEndTime &quot; + end);
		}
		
		//Move the start Date and end Date to OrgDay start and OrgDay end
		//since 1 day is the least count for TO Calculator / DailyBuckets
		//Bug Fix for QC28841 :Time off duration is not broken across boundary day, Sameet Nov 2008
		/*startDate= TOCalcUtil.getDateForOrgDayStart(orgTimeZone,orgDayOffset,startDate);
		endDate = TOCalcUtil.getDateForOrgDayEnd(orgTimeZone,orgDayOffset,endDate);*/

<span class="fc" id="L216">		TimeRange range = new TimeRange(startDate, endDate);</span>
<span class="fc" id="L217">		DailyHoursBuckets dayBuckets = new DailyHoursBuckets(orgDayOffset, orgTimeZone, range);</span>
<span class="fc" id="L218">		startDate =dayBuckets.getDHBRangeStartAsOrgDayStart();</span>
<span class="fc" id="L219">		endDate = dayBuckets.getDHBRangeEndAsOrgDayEnd();</span>
		
		
		
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">		if (hoursPerDay.getHoursPerDay() == null) {</span>
<span class="nc" id="L224">			return dayBuckets;</span>
		}
		
<span class="fc" id="L227">		int minutesDefaulted = hoursPerDay.getTotalMinutesFromDefaulted();</span>
<span class="fc" id="L228">		int minutesScheduled = hoursPerDay.getTotalMinutesFromScheduled();</span>
<span class="fc" id="L229">		dayBuckets.setTotalMinutesFromDefault(minutesDefaulted);</span>
<span class="fc" id="L230">		dayBuckets.setTotalMinutesFromSchedule(minutesScheduled);</span>
		
<span class="fc" id="L232">		StringTokenizer st = new StringTokenizer(hoursPerDay.getHoursPerDay(), &quot;:&quot;);</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">		if (!st.hasMoreElements()) { </span>
<span class="nc" id="L234">			return dayBuckets;</span>
		}
<span class="fc" id="L236">		dayBuckets.setPeriodFlag((new Integer(st.nextElement().toString())).intValue());</span>
<span class="fc" id="L237">		String hrsPerDayStr = st.nextElement().toString();</span>
<span class="fc" id="L238">		st = new StringTokenizer(hrsPerDayStr, &quot;,&quot;);</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">		while (st.hasMoreElements()) {</span>
<span class="fc" id="L240">			String hours = (String) st.nextElement();</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">			if (hours.indexOf(&quot;|&quot;) != -1) {</span>
<span class="fc" id="L242">				StringTokenizer st1 = new StringTokenizer(hours, &quot;|&quot;);</span>
<span class="fc" id="L243">				int count = Integer.parseInt(st1.nextToken());</span>
<span class="fc" id="L244">				float value = Float.parseFloat(st1.nextToken());</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">				for (int ix = 0; ix &lt; count; ix++) {</span>
<span class="fc" id="L246">					curDay = _addToBucketAndMoveForwardOneDay(org, dayBuckets, curDay, startDate, endDate, value);</span>
				}
<span class="fc" id="L248">			} else {</span>
<span class="fc" id="L249">				curDay = _addToBucketAndMoveForwardOneDay(org, dayBuckets, curDay, startDate, endDate, Float.parseFloat(hours));</span>
			}
<span class="fc" id="L251">		}</span>
<span class="fc" id="L252">		return dayBuckets;</span>
	}

	private static Date _addToBucketAndMoveForwardOneDay(Organization org, DailyHoursBuckets dayBuckets, Date curDay, Date startDate, Date endDate, float hours) {
<span class="pc bpc" id="L256" title="2 of 4 branches missed.">		if (!curDay.before(startDate) &amp;&amp; !curDay.after(endDate)) { // the Current date should be in the requested Time Range.</span>
<span class="fc" id="L257">			dayBuckets.addToBucket(curDay, hours);</span>
		}
<span class="fc" id="L259">		return TOCalcUtil.getDateForwardOneDay(curDay, org.getTimeZone());</span>
	}

	// granualrity for this method is calculation for the whole day ,
	// if you want partial time period like starts at mid day and ends at mid day or for few hours within a day
	// then Time Off calculator should be used for that.

	
	@Override
	public IDailyHoursBuckets getDailyHoursBuckets(Organization org, Date start, Date end, String hours) {
<span class="nc" id="L269">		TOHoursPerDay toHrsPerDay = new TOHoursPerDay();</span>
<span class="nc" id="L270">		toHrsPerDay.setStartTime(start); </span>
<span class="nc" id="L271">		toHrsPerDay.setEndTime(end);</span>
<span class="nc" id="L272">		toHrsPerDay.setHoursPerDay(hours);</span>
<span class="nc" id="L273">		return getDailyHoursBuckets( org,  toHrsPerDay);</span>
		
	}
	
	public static DailyHoursBuckets getDailyHoursBuckets(Organization org, TOHoursPerDay hoursPerDay) {
<span class="fc" id="L278">		return getDailyHoursBucketsForDateRange(org, hoursPerDay, hoursPerDay.getStartTime(), hoursPerDay.getEndTime());</span>
	}

	public static TOHoursPerDay calcMinutesForToChoice(TORequest tor, TimeOffLengthCalculator toCalc, TOChoice choice) throws Exception {
<span class="fc" id="L282">		DailyHoursBuckets dailyBuckets = toCalc.calculateDailyLengths(choice.getStartDate(), choice.getEndDate(), tor.getTimeOffType());</span>
<span class="fc" id="L283">		TOHoursPerDay hoursPerDay = TOHoursPerDayUtil.convertTOChoiceToHoursPerDay(tor, choice, tor.getEmployeeID());</span>
<span class="fc" id="L284">		hoursPerDay.setHoursPerDay(TOHoursPerDayUtil.convertDailyBucketsToHoursPerDayString(dailyBuckets));</span>
<span class="fc" id="L285">        hoursPerDay.setTotalMinutes(dailyBuckets.getTotalMinutes());</span>
<span class="fc" id="L286">        hoursPerDay.setTotalMinutesFromDefault(dailyBuckets.getTotalMinutesFromDefault());</span>
<span class="fc" id="L287">        hoursPerDay.setTotalMinutesFromScheduled(dailyBuckets.getTotalMinutesFromSchedule());</span>
<span class="fc" id="L288">        hoursPerDay.setOriginalMinutes(dailyBuckets.getTotalMinutes());</span>
<span class="fc" id="L289">		hoursPerDay.setIsDirty(false);</span>
<span class="fc" id="L290">		hoursPerDay.setDirtyTime(new Date());</span>
<span class="fc" id="L291">		choice.setHoursPerDay(hoursPerDay);</span>
		
<span class="fc" id="L293">		return hoursPerDay;</span>
	}

	public static TOHoursPerDay refreshMinsForTOHoursPerDay(TOHoursPerDay hrsPerDay, TimeOffLengthCalculator toCalc, StringBuilder hoursPerDayChange) throws Exception {
<span class="fc" id="L297">		Date pubDate = toCalc.getLastPublishedShiftDayEnd();</span>
<span class="fc bfc" id="L298" title="All 2 branches covered.">		boolean useFixedMins = hrsPerDay.getStartTime().after(pubDate)</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">		        &amp;&amp; (hrsPerDay.getTimeOffRule() == TimeOffEvent.TIME_OFF_RULE_USE_MINSTOWARDSRULES)</span>
<span class="fc bfc" id="L300" title="All 4 branches covered.">		        &amp;&amp; (hrsPerDay.getTOEventID() != null || RequestAuditTrail.STATUS_APPROVED.equals(hrsPerDay.getStatus()));</span>
		DailyHoursBuckets dailyBuckets;
<span class="pc bpc" id="L302" title="1 of 4 branches missed.">		if (useFixedMins &amp;&amp; hrsPerDay.areOriginalMinutesAvailable()) {</span>
			// When original mins are available, this daily length computation is still needed for those cases where 
			// the hrsPerDay.getToEventID() is not null. 
			// Such TOEvents converted to TOHrsPerDay via a call to convertTOEventToHoursPerDay(TOHoursPerDay, TimeOffEvent, ID)
			// do not have the hoursPerDay entry. Hence, this daily length computation is needed to subsequently calculate hoursPerDay
<span class="fc" id="L307">			dailyBuckets = toCalc.calculateDailyLengthsForGivenTotalLength</span>
<span class="fc" id="L308">			        (hrsPerDay.getStartTime(), hrsPerDay.getEndTime(), hrsPerDay.getActivityID(), hrsPerDay.getTotalMinutes());</span>
		} else {
<span class="fc" id="L310">			dailyBuckets = toCalc.calculateDailyLengths(hrsPerDay.getStartTime(), hrsPerDay.getEndTime(), hrsPerDay.getActivityID());</span>
		}
		
		
		
		
        
<span class="fc" id="L317">		String hrsPerDayOld = hrsPerDay.getHoursPerDay();</span>
<span class="fc" id="L318">		int totalMinsOld = hrsPerDay.getTotalMinutes();</span>
<span class="fc" id="L319">		hrsPerDay.setHoursPerDay(TOHoursPerDayUtil.convertDailyBucketsToHoursPerDayString(dailyBuckets));</span>
<span class="fc" id="L320">		hrsPerDay.setTotalMinutesFromDefault(dailyBuckets.getTotalMinutesFromDefault());</span>
<span class="fc" id="L321">		hrsPerDay.setTotalMinutesFromScheduled(dailyBuckets.getTotalMinutesFromSchedule());</span>
		
<span class="fc" id="L323">		String origHoursPerDay = hrsPerDay.getOriginalHoursPerDay();</span>
<span class="pc bpc" id="L324" title="1 of 6 branches missed.">		if (useFixedMins &amp;&amp; hrsPerDay.areOriginalHoursAvailable() &amp;&amp; !origHoursPerDay.isEmpty()) { </span>
			// This is called into when a publish-&gt;unpublish into the future needs to reset the total mins and hrs per day 
			// to the originalHoursPerDay and origMins. ESR#4551574 
			// It would not suffice to check if just the originalMins are available, since you could end up copying an
			// empty originalHoursPerDay that shows 0 scheduled hours in the TO Calendar, even if the agents screen shows
			// more than 0 hrs scheduled for a request.
<span class="fc" id="L330">			hrsPerDay.setTotalMinutes(hrsPerDay.getOriginalMinutes());</span>
<span class="fc" id="L331">			hrsPerDay.setHoursPerDay(origHoursPerDay);</span>
		} else {
			// how much hours/day are at time of approval, break up
<span class="fc" id="L334">			hrsPerDay.setTotalMinutes(dailyBuckets.getTotalMinutes());  </span>
		}
		
<span class="pc bpc" id="L337" title="1 of 4 branches missed.">		if (hrsPerDay.refreshOrignalMinutes || !hrsPerDay.areOriginalMinutesAvailable()) {</span>
<span class="fc" id="L338">            hrsPerDay.setOriginalMinutes(dailyBuckets.getTotalMinutes());</span>
		}
		
		// audit how the TOHoursPerDay change before and after approval
<span class="pc bpc" id="L342" title="2 of 6 branches missed.">			if (hrsPerDayOld != null &amp;&amp; (!hrsPerDay.getHoursPerDay().equals(hrsPerDayOld) || totalMinsOld != hrsPerDay.getTotalMinutes())) {</span>
<span class="fc" id="L343">			hoursPerDayChange.append(&quot;TOHours(Before)=&quot;).append(hrsPerDayOld).append(&quot;\tTOHours(After)=&quot;).append(hrsPerDay.getHoursPerDay());</span>
		}
		
		// get a snapshot of original hours per day to see how this refresh call changes it
<span class="fc" id="L347">		hrsPerDay.setOriginalHoursPerDay(hrsPerDayOld);</span>
		
		//hrsPerDay.setIsInPublishedPeriod(pubDate.after(hrsPerDay.getEndTime())); //Mark IsInPublishedPeriod=true ONLY IF ENTIRE REQ IS IN PUBLISHED RANGE
<span class="fc" id="L350">		hrsPerDay.setIsDirty(false);</span>
<span class="fc" id="L351">		hrsPerDay.setDirtyTime(new Date());</span>
<span class="fc" id="L352">		return hrsPerDay;</span>
	}

	public static HashMap groupByField(int iField, Collection colItems) {
<span class="pc bpc" id="L356" title="1 of 4 branches missed.">		if (colItems == null || colItems.isEmpty()) {</span>
<span class="fc" id="L357">			return new HashMap();</span>
		}
<span class="fc" id="L359">		HashMap mapResults = new HashMap(colItems.size());</span>
<span class="fc" id="L360">		Iterator it = colItems.iterator();</span>
<span class="fc bfc" id="L361" title="All 2 branches covered.">		while (it.hasNext()) {</span>
<span class="fc" id="L362">			ValueObjectBase item = (ValueObjectBase) it.next();</span>
<span class="fc" id="L363">			Object key = item.getFieldValue(iField);</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">			if (key == null) {</span>
<span class="nc" id="L365">				continue;</span>
			}
<span class="fc" id="L367">			ArrayList arr = (ArrayList) mapResults.get(key);</span>
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">			if (arr == null) {</span>
<span class="fc" id="L369">				arr = new ArrayList(1);</span>
<span class="fc" id="L370">				mapResults.put(key, arr);</span>
			}
<span class="fc" id="L372">			arr.add(item);</span>
<span class="fc" id="L373">		}</span>
<span class="fc" id="L374">		return mapResults;</span>
	}

	public static Set extractFieldSet(int iField, Collection colItems) {
<span class="pc bpc" id="L378" title="2 of 4 branches missed.">		if (colItems == null || colItems.isEmpty()) {</span>
<span class="nc" id="L379">			return new HashSet();</span>
		}
<span class="fc" id="L381">		HashSet mapResults = new HashSet(colItems.size());</span>
<span class="fc" id="L382">		Iterator it = colItems.iterator();</span>
<span class="fc bfc" id="L383" title="All 2 branches covered.">		while (it.hasNext()) {</span>
<span class="fc" id="L384">			ValueObjectBase item = (ValueObjectBase) it.next();</span>
<span class="fc" id="L385">			Object key = item.getFieldValue(iField);</span>
<span class="pc bpc" id="L386" title="1 of 4 branches missed.">			if (key != null &amp;&amp; !mapResults.contains(key)) {</span>
<span class="fc" id="L387">				mapResults.add(key);</span>
			}
<span class="fc" id="L389">		}</span>
<span class="fc" id="L390">		return mapResults;</span>
	}

<span class="fc" id="L393">	static TimeZone GMT_TIMEZONE = TimeZone.getTimeZone(&quot;GMT&quot;);</span>

	public static Date getDateForDaysAfter(Date date, int dayCount, TimeZone tz) {
<span class="fc bfc" id="L396" title="All 2 branches covered.">		if (date == null) {</span>
<span class="fc" id="L397">			return date;</span>
		}
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">		Calendar cal = Calendar.getInstance((tz != null ? tz : GMT_TIMEZONE));</span>
<span class="fc" id="L400">		cal.setTime(date);</span>
<span class="fc" id="L401">		TOCalcUtil.addDaysToCalendar(cal, dayCount);</span>
		//cal.add(Calendar.DAY_OF_MONTH, dayCount);  // advance by the specified number of days.
<span class="fc" id="L403">		return cal.getTime();</span>
	}

	public static Date getDateForDaysBefore(Date date, int dayCount, TimeZone tz) {
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">		if (date == null) {</span>
<span class="nc" id="L408">			return date;</span>
		}
<span class="pc bpc" id="L410" title="1 of 2 branches missed.">		Calendar cal = Calendar.getInstance((tz != null ? tz : GMT_TIMEZONE));</span>
<span class="fc" id="L411">		cal.setTime(date);</span>
<span class="fc" id="L412">		TOCalcUtil.addDaysToCalendar(cal, (-1 * dayCount));</span>
		//cal.add(Calendar.DAY_OF_MONTH, (-1 * dayCount));  // substract by the specified number of days.
<span class="fc" id="L414">		return cal.getTime();</span>
	}

	public static boolean isTOHoursPerDayDifferentFromTOChoice(TORequest toRequest, TOChoice toChoice, TOHoursPerDay hoursPerDay) {
<span class="fc" id="L418">		boolean retval = true;</span>
<span class="pc bpc" id="L419" title="4 of 8 branches missed.">		if (toRequest != null &amp;&amp; toChoice != null &amp;&amp; hoursPerDay != null &amp;&amp; hoursPerDay.getHoursPerDay() != null &amp;&amp;</span>
<span class="pc bpc" id="L420" title="1 of 2 branches missed.">		        hoursPerDay.getEmployeeID().equals(toRequest.getEmployeeID()) &amp;&amp;</span>
<span class="pc bpc" id="L421" title="1 of 2 branches missed.">		        hoursPerDay.getActivityID().equals(toRequest.getTimeOffType()) &amp;&amp;</span>
<span class="pc bpc" id="L422" title="1 of 2 branches missed.">		        hoursPerDay.getTOChoiceID().equals(toChoice.getID()) &amp;&amp;</span>
<span class="pc bpc" id="L423" title="1 of 2 branches missed.">		        hoursPerDay.getTimeOffChoiceRank() == (toChoice.getRank()) &amp;&amp;</span>
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">		        hoursPerDay.getStartTime().equals(toChoice.getStartDate()) &amp;&amp;</span>
<span class="pc bpc" id="L425" title="1 of 2 branches missed.">		        hoursPerDay.getEndTime().equals(toChoice.getEndDate()) &amp;&amp;</span>
<span class="fc bfc" id="L426" title="All 2 branches covered.">		        hoursPerDay.getStatus().equals(toRequest.getRequestStatus()) &amp;&amp;</span>
<span class="pc bpc" id="L427" title="1 of 2 branches missed.">		        hoursPerDay.getTimeOffRule() == toRequest.getTimeOffRule()) {</span>
<span class="fc" id="L428">			retval = false;</span>
		}
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc" id="L431">			m_cat.debug(&quot;isTOHoursPerDayDifferentFromTOChoice=&quot; + retval + &quot; :toChoice= &quot; + toChoice + &quot;\n hoursPerDay=&quot; + hoursPerDay);</span>
		}
<span class="fc" id="L433">		return retval;</span>
	}

	public static boolean isTOHoursPerDayRefreshRequired(TORequest toRequest, TOChoice toChoice, TOHoursPerDay hoursPerDay) {
<span class="fc" id="L437">		boolean retval = true;</span>
<span class="pc bpc" id="L438" title="3 of 6 branches missed.">		if (toRequest != null &amp;&amp; toChoice != null &amp;&amp; hoursPerDay != null &amp;&amp;</span>
<span class="pc bpc" id="L439" title="2 of 4 branches missed.">		        hoursPerDay.getHoursPerDay() != null &amp;&amp; hoursPerDay.getID() != null &amp;&amp;</span>
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">		        hoursPerDay.getEmployeeID().equals(toRequest.getEmployeeID()) &amp;&amp;</span>
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">		        hoursPerDay.getActivityID().equals(toRequest.getTimeOffType()) &amp;&amp;</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">		        hoursPerDay.getTOChoiceID().equals(toChoice.getID()) &amp;&amp;</span>
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">		        hoursPerDay.getStartTime().equals(toChoice.getStartDate()) &amp;&amp;</span>
<span class="pc bpc" id="L444" title="1 of 2 branches missed.">		        hoursPerDay.getEndTime().equals(toChoice.getEndDate()) &amp;&amp;</span>
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">		        hoursPerDay.getTimeOffRule() == toRequest.getTimeOffRule()) {</span>
<span class="fc" id="L446">			retval = false;</span>
		}
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">		if (RequestUtil.isRMDebugEnabled()) {</span>
<span class="nc" id="L449">			m_cat.debug(&quot;isTOHoursPerDayRefreshRequired=&quot; + retval + &quot; :toChoice= &quot; + toChoice + &quot;\n hoursPerDay=&quot; + hoursPerDay);</span>
		}
<span class="fc" id="L451">		return retval;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>