<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TraceChart.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.pulse.model</a> &gt; <span class="el_source">TraceChart.java</span></div><h1>TraceChart.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.pulse.model;

import java.io.Externalizable;
import java.io.IOException;
import java.io.ObjectInput;
import java.io.ObjectOutput;
import java.util.Arrays;
import java.util.StringTokenizer;

import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceUtil;

/**
 * Capturing the chart definition for a trace type (statistic type)
 * A trace type, may have multiple chart types. This object is capture one of them.
 * 
 * 
 * @author ssong
 *
 *  */
public class TraceChart implements Externalizable{
	public static final short ABSOLUTE_CHART = 0;
	public static final short ABSDEVIATION_CHART = 1;
	public static final short PCTDEVIATION_CHART = 2;
	public static final int CHART_TYPES = PCTDEVIATION_CHART + 1;
	
	public static final short ACTUAL_LINE = 0;
	public static final short FORECAST_LINE = 1;
	public static final short REQUIRE_LINE = 2;
	public static final short LINE_TYPES = REQUIRE_LINE + 1;
<span class="fc" id="L31">	public static final short[] LINE_TYPES_ARRAY = {ACTUAL_LINE,FORECAST_LINE,REQUIRE_LINE};</span>
	
	private short m_TraceType;
	private short m_ChartType;
<span class="pc" id="L35">	private boolean[] m_LineType = new boolean[] {false, false, false};	</span>
<span class="pc" id="L36">	private boolean m_Hidden = false;</span>
	
	private static final String DELIMIT = &quot;/&quot;;
	
<span class="nc" id="L40">	public TraceChart() {}</span>
	
<span class="nc" id="L42">	public TraceChart(String defStr) {</span>
<span class="nc" id="L43">		populate(defStr);</span>
<span class="nc" id="L44">	}</span>
	
<span class="fc" id="L46">	public TraceChart(short traceType, short chartType, short[] lineType, boolean validOnly) {</span>
<span class="fc" id="L47">		m_TraceType = traceType;</span>
<span class="fc" id="L48">		m_ChartType = chartType;</span>
<span class="fc" id="L49">		addLineType(lineType, validOnly);</span>
<span class="fc" id="L50">	}</span>
	
	public short getTraceType() {
<span class="fc" id="L53">		return m_TraceType;</span>
	}

	public void setTraceType(short type) {
<span class="nc" id="L57">		m_TraceType = type;</span>
<span class="nc" id="L58">	}</span>
	
	public short getChartType() {
<span class="nc" id="L61">		return m_ChartType;</span>
	}
	
	public void setChartType(short type) {
<span class="nc" id="L65">		m_ChartType = type;</span>
<span class="nc" id="L66">	}</span>
	
	public void hide(boolean flag) {
<span class="nc" id="L69">		m_Hidden = flag;</span>
<span class="nc" id="L70">	}</span>
	
	public boolean isHidden() {
<span class="fc" id="L73">		return m_Hidden;</span>
	}
	
	public void addLineType(short[] lineType, boolean validOnly) {
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">		if (lineType != null) {</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">			for (int i=0; i&lt;lineType.length; i++)</span>
<span class="pc bpc" id="L79" title="2 of 4 branches missed.">				if (lineType[i]&lt;=REQUIRE_LINE &amp;&amp; lineType[i]&gt;=ACTUAL_LINE) {</span>
<span class="pc bpc" id="L80" title="1 of 4 branches missed.">					if (validOnly &amp;&amp; !isSupported(m_TraceType, m_ChartType, lineType[i]))</span>
<span class="fc" id="L81">						continue;</span>
<span class="fc" id="L82">					m_LineType[lineType[i]] = true;</span>
				}
		}				
<span class="fc" id="L85">		m_Hidden = false;</span>
<span class="fc" id="L86">	}</span>
	
	public void setLineType(short[] lineType, boolean validOnly) {
<span class="nc" id="L89">		Arrays.fill(m_LineType, false);</span>
<span class="nc" id="L90">		addLineType(lineType, validOnly);		</span>
<span class="nc" id="L91">	}</span>
	
<span class="nc" id="L93">	public boolean[] getLineType() { return m_LineType; }</span>
	
	public String toString() {
<span class="fc" id="L96">		StringBuffer sb = new StringBuffer();</span>
<span class="fc" id="L97">		sb.append(m_TraceType).append(DELIMIT).append(m_ChartType).append(DELIMIT);</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">		for (int i=0; i&lt;m_LineType.length; i++) {</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">			if(m_LineType[i])</span>
<span class="fc" id="L100">				sb.append(1);</span>
			else
<span class="fc" id="L102">				sb.append(0);</span>
		}
<span class="fc" id="L104">		sb.append(DELIMIT);</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">		if (m_Hidden)</span>
<span class="nc" id="L106">			sb.append(1);</span>
		else
<span class="fc" id="L108">			sb.append(0);</span>
<span class="fc" id="L109">		return sb.toString();</span>
	}
	
	public void populate(String defStr) {
<span class="nc" id="L113">		StringTokenizer st = new StringTokenizer(defStr, DELIMIT);</span>
<span class="nc" id="L114">		String traceType = st.nextToken();</span>
<span class="nc" id="L115">		m_TraceType = Short.valueOf(traceType).shortValue();</span>
<span class="nc" id="L116">		String charType = st.nextToken();</span>
<span class="nc" id="L117">		m_ChartType = Short.valueOf(charType).shortValue();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (st.hasMoreTokens()) {</span>
<span class="nc" id="L119">			String lineType = st.nextToken();</span>
<span class="nc" id="L120">			char[] lineSel = lineType.toCharArray();</span>
<span class="nc bnc" id="L121" title="All 4 branches missed.">			for (int i=0; i&lt;= REQUIRE_LINE &amp;&amp; i&lt;lineSel.length; i++) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">				m_LineType[i] = lineSel[i]=='1';</span>
			}		
<span class="nc bnc" id="L124" title="All 2 branches missed.">			if (st.hasMoreTokens()) {</span>
<span class="nc" id="L125">				String hidden = st.nextToken();		</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">				m_Hidden = Short.valueOf(hidden).shortValue()==1;</span>
			}
		}
<span class="nc" id="L129">	}	</span>
	
	public boolean isValid() {
<span class="nc" id="L132">		boolean hasLine = false;		</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">		for (int i=0; i&lt;m_LineType.length; i++) {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">			if (m_LineType[i]) {</span>
<span class="nc" id="L135">				hasLine = true;</span>
<span class="nc" id="L136">				short lineType = (short)i;</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">				if (!isSupported(m_TraceType, m_ChartType, lineType))</span>
<span class="nc" id="L138">					return false;</span>
			}
		}
<span class="nc" id="L141">		return hasLine;		</span>
	}
	/**
	 * Actual only has Absolute Chart
	 * Require only has subset of Trace Types to display
	 * @param traceType
	 * @param chartType
	 * @param lineType
	 * @return
	 */
	public static boolean isSupported(short traceType, short chartType, short lineType) {
<span class="pc bpc" id="L152" title="3 of 4 branches missed.">		if (chartType != ABSOLUTE_CHART &amp;&amp; lineType == ACTUAL_LINE) {</span>
<span class="nc" id="L153">			return false;						</span>
		}
		
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">		if (chartType == ABSOLUTE_CHART)</span>
		{
<span class="fc bfc" id="L158" title="All 2 branches covered.">			if (lineType == REQUIRE_LINE) {</span>
				// we don't support display Abandonment in Pulse
<span class="fc bfc" id="L160" title="All 2 branches covered.">				if (traceType == Trace.ABANDONMENT)</span>
<span class="fc" id="L161">					return false;</span>
<span class="fc" id="L162">				return TraceUtil.META_AGGR_REQUIRE.supportType(traceType);</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">			}else if(lineType == FORECAST_LINE )</span>
			{
<span class="fc" id="L165">				return TraceUtil.META_AGGR_FORECAST.supportType(traceType );</span>
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">			}else if(lineType == ACTUAL_LINE )</span>
			{
<span class="fc" id="L168">				return TraceUtil.META_ACTUAL.supportType(traceType );</span>
			}
		}
		else
		{
			//deviations need actual and forecast/required
<span class="nc bnc" id="L174" title="All 2 branches missed.">			if (lineType == REQUIRE_LINE) {</span>
				// we don't support display Abandonment in Pulse
<span class="nc bnc" id="L176" title="All 2 branches missed.">				if (traceType == Trace.ABANDONMENT)</span>
<span class="nc" id="L177">					return false;</span>
<span class="nc bnc" id="L178" title="All 4 branches missed.">				return TraceUtil.META_AGGR_REQUIRE.supportType(traceType) &amp;&amp; TraceUtil.META_ACTUAL.supportType(traceType);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">			}else if(lineType == FORECAST_LINE )</span>
			{
<span class="nc bnc" id="L181" title="All 4 branches missed.">				return TraceUtil.META_AGGR_FORECAST.supportType(traceType) &amp;&amp; TraceUtil.META_ACTUAL.supportType(traceType);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">			}else if(lineType == ACTUAL_LINE )</span>
			{
<span class="nc" id="L184">				return TraceUtil.META_ACTUAL.supportType(traceType);</span>
			}			
		}
<span class="nc" id="L187">		return true;</span>
	}
	
	/**
	 * Return supported Trace Types for a given line type
	 * @param lineType
	 * @return
	 */
	public static short[] getSupportedTypes(short lineType) {
<span class="nc bnc" id="L196" title="All 4 branches missed.">		switch (lineType) {</span>
			case ACTUAL_LINE:
<span class="nc" id="L198">				return TraceUtil.META_ACTUAL.getTraceTypes();</span>
			case FORECAST_LINE:
<span class="nc" id="L200">				return TraceUtil.META_AGGR_FORECAST.getTraceTypes();</span>
			case REQUIRE_LINE:
<span class="nc" id="L202">				return TraceUtil.META_AGGR_REQUIRE.getTraceTypes();</span>
			default:
<span class="nc" id="L204">				return null;</span>
		}		
	}

	/* (non-Javadoc)
	 * @see java.io.Externalizable#readExternal(java.io.ObjectInput)
	 */
	public void readExternal(ObjectInput in) throws IOException, ClassNotFoundException {
<span class="nc" id="L212">		String def = (String)in.readObject();</span>
<span class="nc" id="L213">		populate(def);		</span>
<span class="nc" id="L214">	}</span>

	/* (non-Javadoc)
	 * @see java.io.Externalizable#writeExternal(java.io.ObjectOutput)
	 */
	public void writeExternal(ObjectOutput out) throws IOException {
<span class="nc" id="L220">		out.writeObject(toString());		</span>
<span class="nc" id="L221">	}		</span>
	
	public boolean isDeviation() {
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">		return !(m_ChartType == ABSOLUTE_CHART);</span>
	}
	
	public boolean[] needTraceCubes() {
<span class="fc" id="L228">		boolean[] cubeSelection = new boolean[] {false, false, false};</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">		for (int i=0; i&lt;m_LineType.length; i++)</span>
<span class="fc" id="L230">			cubeSelection[i] = m_LineType[i];</span>
<span class="fc" id="L231">		cubeSelection[0] = m_LineType[0] | isDeviation();</span>
<span class="fc" id="L232">		return cubeSelection;</span>
	}

	public boolean equals(Object obj) {
<span class="nc bnc" id="L236" title="All 2 branches missed.">		if (obj instanceof TraceChart) {</span>
<span class="nc" id="L237">			TraceChart other = (TraceChart)obj;</span>

<span class="nc bnc" id="L239" title="All 2 branches missed.">			if (other.getTraceType() != getTraceType())</span>
<span class="nc" id="L240">				return false;</span>

<span class="nc bnc" id="L242" title="All 2 branches missed.">			if (other.getChartType() != getChartType())</span>
<span class="nc" id="L243">				return false;</span>

<span class="nc" id="L245">			boolean[] lineType1 = getLineType();</span>
<span class="nc" id="L246">			boolean[] lineType2 = other.getLineType();</span>

<span class="nc bnc" id="L248" title="All 2 branches missed.">			if (lineType1.length != lineType2.length)</span>
<span class="nc" id="L249">				return false;</span>

<span class="nc bnc" id="L251" title="All 2 branches missed.">			for (int i = 0; i &lt; lineType1.length; i++) {</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">				if (lineType1[i] != lineType2[i])</span>
<span class="nc" id="L253">					return false;</span>
			}

<span class="nc" id="L256">			return true;</span>
		}
<span class="nc" id="L258">		return false;</span>
	}

	public int hashCode() {
<span class="nc" id="L262">		return getTraceType()*3 + getChartType();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>