<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SkillAssignmentDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.skill.ejb</a> &gt; <span class="el_source">SkillAssignmentDAO.java</span></div><h1>SkillAssignmentDAO.java</h1><pre class="source lang-java linenums">/*
 * Title:        SkillAssignmentDAO
 * Description:  dao object to serialize SkillAssignment object
 * Copyright:    Copyright (c) 2001, 2011
 * Company:      Verint Systems, Inc.
 * @author       lixin zhang
 * @version      1.1
 */

package com.bluepumpkin.ejb.bbm.skill.ejb;

import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOEffectivity;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.skill.model.EmployeeSkillChangeObject;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignmentFieldInfo;
import com.bluepumpkin.ejb.bbm.skill.model.SkillFieldInfo;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectEffectivity;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.core.change.ejb.ChangeManager;

public class SkillAssignmentDAO extends DAOEffectivity {

<span class="fc" id="L49">	private static FieldInfo m_fieldInfo = new SkillAssignmentFieldInfo();</span>
<span class="fc" id="L50">	protected FieldInfo getFieldInfo() { return m_fieldInfo; }</span>
	
<span class="pc" id="L52">	private ChangeManager m_changeManager = null;</span>
	
	public SkillAssignmentDAO() {
<span class="fc" id="L55">		super();</span>
<span class="fc" id="L56">	}</span>
	
	public SkillAssignmentDAO(Jdmo dmo) {
<span class="nc" id="L59">		super(dmo);</span>
<span class="nc" id="L60">	}</span>
	
	protected ValueObjectBase createValueObject()
	{
<span class="nc" id="L64">		return (new SkillAssignment());</span>
	}
	

	/**
	 *   get a given work resource's skill assignment
	 *
	 *   @idWorkResource work resource id
	 *   @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 *   @return a collection of SkillAssignment objects which hold the assignment information
	 */
	public Collection getSkillAssignments(ID idWorkResource, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L77">		return super.getEffectivityAssignments(idWorkResource,</span>
				SkillAssignmentFieldInfo.SKILLASSIGNMENT_WORKRESOURCEID, dtStart, dtEnd);
	}

	/**
	 *   get skill assignments for a list of work resources
	 *
	 *   @colWorkResourceIDs  a collection of work resource ids
	 *   @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 *   @return a HashMap of following pairs
	 *            (idWorkResource, array list of skill assignments)
	 */
	public HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; getSkillAssignmentInPeriodAndOnSpotOnly(Collection&lt;ID&gt; colWorkResourceIDs, Date dtStart, Date dtEnd, Date timeSpot) throws BbmFinderException{
<span class="nc" id="L91">		return getSkillAssignments(colWorkResourceIDs, dtStart, dtEnd, false, timeSpot); //on spot only</span>
	}
	
	public HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; getSkillAssignments(Collection&lt;ID&gt; colWorkResourceIDs, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L95">		return getSkillAssignments(colWorkResourceIDs, dtStart, dtEnd, false, null);</span>
	}
	
	private HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; getSkillAssignments(Collection&lt;ID&gt; colWorkResourceIDs, Date dtStart, Date dtEnd, boolean isInPeriodOnly, Date timeSpot) throws BbmFinderException {
		try {
			//load all skills
<span class="fc" id="L101">			HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; hSkills = new HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt;();</span>
			
<span class="fc" id="L103">			StringBuffer query = new StringBuffer();</span>
			
<span class="fc" id="L105">			query.append( &quot;SELECT W.ID, SKILL.SID,WORKRESOURCEID,PROFICIENCY,PRIORITY,RESERVELEVEL,STARTDATE,ENDDATE FROM WORKRESOURCESKILL w,SKILL &quot; );</span>
<span class="fc" id="L106">			query.append( &quot;WHERE SKILL.ID = SKILLID AND SKILL.DELETEONDATE is NULL &quot; );</span>
			
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">			if (isInPeriodOnly) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">				if( dtEnd != null ) {</span>
<span class="nc" id="L110">					query.append( &quot; AND '&quot;);</span>
<span class="nc" id="L111">					query.append( JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtEnd)) );</span>
<span class="nc" id="L112">					query.append( &quot;' &gt; ENDDATE OR ENDDATE is NULL &quot;);</span>
				}
				
<span class="nc bnc" id="L115" title="All 2 branches missed.">				if( dtStart != null ) {</span>
<span class="nc" id="L116">					query.append( &quot; AND ( '&quot;);</span>
<span class="nc" id="L117">					query.append( JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtStart)) );</span>
<span class="nc" id="L118">					query.append( &quot;' &lt; STARTDATE ) &quot;);</span>
				}
				
			} else {
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">				if (timeSpot == null)</span>
<span class="fc" id="L123">					appendTimeRange(query, dtStart, dtEnd);</span>
			}
			
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">			if (timeSpot != null) {</span>
<span class="nc" id="L127">				query.append( &quot; AND ( '&quot;);</span>
<span class="nc" id="L128">				query.append( JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(timeSpot)) );</span>
<span class="nc" id="L129">				query.append( &quot;' &gt;= STARTDATE ) &quot;);</span>
<span class="nc" id="L130">				query.append( &quot; AND ( '&quot;);</span>
<span class="nc" id="L131">				query.append( JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(timeSpot)) );</span>
<span class="nc" id="L132">				query.append( &quot;' &lt; ENDDATE OR ENDDATE is NULL ) &quot;);</span>
			}
			
<span class="fc" id="L135">			query.append( &quot; AND WORKRESOURCEID IN &quot; );</span>
<span class="fc" id="L136">			query.append(m_dmo.createInClause(colWorkResourceIDs) );</span>
			
<span class="fc" id="L138">			JdmoRowset r = m_dmo.createRowset( query.toString() );</span>
			
			//-------------------------------------------------
			// get data and create skills
			//-------------------------------------------------
			
<span class="fc bfc" id="L144" title="All 2 branches covered.">			while(r.next()) {</span>
<span class="fc" id="L145">				ID id = r.getID(&quot;ID&quot;);</span>
<span class="fc" id="L146">				ID idSkill = r.getID(&quot;SID&quot;);</span>
<span class="fc" id="L147">				ID idEmployee = r.getID(&quot;WORKRESOURCEID&quot;);</span>
<span class="fc" id="L148">				int nProficiency = r.getInt(&quot;PROFICIENCY&quot;);</span>
<span class="fc" id="L149">				int nPriority = r.getInt(&quot;PRIORITY&quot;);</span>
<span class="fc" id="L150">				int nReserve = r.getInt(&quot;RESERVELEVEL&quot;);</span>
<span class="fc" id="L151">				Date start = r.getTimestamp(&quot;STARTDATE&quot;);</span>
<span class="fc" id="L152">				Date end = r.getTimestamp(&quot;ENDDATE&quot;);</span>
<span class="fc" id="L153">				String skillDEID = r.getString(&quot;ID&quot;);</span>
				
<span class="fc" id="L155">				SkillAssignment pSkill = new SkillAssignment();</span>
<span class="fc" id="L156">				pSkill.setID(id);</span>
<span class="fc" id="L157">				pSkill.setSkillID(idSkill);</span>
<span class="fc" id="L158">				pSkill.setWorkResourceID(idEmployee);</span>
<span class="fc" id="L159">				pSkill.setPriority(nPriority);</span>
<span class="fc" id="L160">				pSkill.setProficiency(((double)nProficiency)/10.0);</span>
				//pSkill.setReserve(nReserve != 0);
<span class="fc" id="L162">				pSkill.setReserve(nReserve);</span>
<span class="fc" id="L163">				pSkill.setStartTime(start);</span>
<span class="fc" id="L164">				pSkill.setEndTime(end);</span>
<span class="fc" id="L165">				pSkill.setSkillDEIDStr(skillDEID);</span>
				
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">				if (hSkills.get(idEmployee) == null)</span>
<span class="fc" id="L168">					hSkills.put(idEmployee,new ArrayList&lt;SkillAssignment&gt;());</span>
				
<span class="fc" id="L170">				hSkills.get(idEmployee).add(pSkill);</span>
<span class="fc" id="L171">			}</span>
						
<span class="fc" id="L173">			return hSkills;			</span>
<span class="nc" id="L174">		} catch(JdmoException e) {			</span>
<span class="nc" id="L175">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L177">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 *   get skill assignments for a list of work resources
	 *
	 *   @colWorkResourceIDs  a collection of work resource ids
	 *   @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 *   @return a HashMap of following pairs
	 *            (idWorkResource, array list of skill assignments)
	 */
	public HashMap&lt;ID, ArrayList&lt;SkillAssignment&gt;&gt; getSkillAssignmentsForTemplates(Collection&lt;ID&gt; colTemplateIDs, Date dtStart, Date dtEnd) throws BbmFinderException {
		try {
			//load all skills
<span class="nc" id="L193">			HashMap&lt;ID, ArrayList&lt;SkillAssignment&gt;&gt; hSkills = new HashMap&lt;ID, ArrayList&lt;SkillAssignment&gt;&gt;();</span>
<span class="nc" id="L194">			StringBuffer query = new StringBuffer();</span>
			
<span class="nc" id="L196">			query.append( &quot;SELECT SKILL.SID SSID, EMPTEMPLATE.SID ESID, EMPTEMPLATESKILL.PROFICIENCY, PRIORITY, RESERVELEVEL FROM EMPTEMPLATE,EMPTEMPLATESKILL,SKILL &quot; );</span>
<span class="nc" id="L197">			query.append( &quot; WHERE SKILLID = SKILL.ID AND SKILL.DELETEONDATE is NULL AND EMPTEMPLATEID = EMPTEMPLATE.ID &quot; );</span>

<span class="nc" id="L199">			query.append( &quot;AND EMPTEMPLATE.SID IN &quot; );</span>
<span class="nc" id="L200">			query.append( m_dmo.createInClause(colTemplateIDs) );</span>

<span class="nc" id="L202">			JdmoRowset r = m_dmo.createRowset( query.toString() );</span>
			
			//-------------------------------------------------
			// get data and create skills
			//-------------------------------------------------
			
<span class="nc bnc" id="L208" title="All 2 branches missed.">			while(r.next()) {</span>
<span class="nc" id="L209">				ID idSkill = r.getID(&quot;SSID&quot;);</span>
<span class="nc" id="L210">				ID idTemplate = r.getID(&quot;ESID&quot;);</span>
<span class="nc" id="L211">				int nProficiency = r.getInt(&quot;PROFICIENCY&quot;);</span>
<span class="nc" id="L212">				int nPriority = r.getInt(&quot;PRIORITY&quot;);</span>
<span class="nc" id="L213">				int nReserve = r.getInt(&quot;RESERVELEVEL&quot;);</span>
				
<span class="nc" id="L215">				SkillAssignment pSkill = new SkillAssignment();</span>
<span class="nc" id="L216">				pSkill.setSkillID(idSkill);</span>
<span class="nc" id="L217">				pSkill.setWorkResourceID(idTemplate);</span>
<span class="nc" id="L218">				pSkill.setPriority(nPriority);</span>
<span class="nc" id="L219">				pSkill.setProficiency((double)nProficiency);</span>
<span class="nc" id="L220">				pSkill.setClassification(nReserve);</span>
				
<span class="nc bnc" id="L222" title="All 2 branches missed.">				if (hSkills.get(idTemplate) == null)</span>
<span class="nc" id="L223">					hSkills.put(idTemplate,new ArrayList&lt;SkillAssignment&gt;());</span>
				
<span class="nc" id="L225">				hSkills.get(idTemplate).add(pSkill);</span>
<span class="nc" id="L226">			}</span>
						
<span class="nc" id="L228">			return hSkills;</span>
<span class="nc" id="L229">		} catch(JdmoException e) {</span>
<span class="nc" id="L230">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L232">			m_dmo.cleanUp();</span>
		}
	}

	/** create a skill assignment */
	public ID createSkillAssignment(SkillAssignment objValue) throws BbmCreateException {
<span class="nc" id="L238">		ID id = null;</span>
		try {
<span class="nc" id="L240">			objValue.setID(new ID(DAOUtil.getDEID(m_dmo)));</span>
			//try to merge first
<span class="nc" id="L242">			super.merge(objValue);</span>
<span class="nc" id="L243">			id = this.createNoOverlapAssignment(convertSIDtoDEID(objValue), SkillAssignmentFieldInfo.SKILLASSIGNMENT_WORKRESOURCEID,</span>
				SkillAssignmentFieldInfo.SKILLASSIGNMENT_SKILLID);
<span class="nc" id="L245">		} catch (Exception ex) {</span>
<span class="nc" id="L246">			throw new BbmCreateException(ex);</span>
<span class="nc" id="L247">		}</span>
		
		try {
<span class="nc" id="L250">			notifyChangeManager(objValue);</span>
<span class="nc" id="L251">		} catch(BbmCreateException e) {</span>
<span class="nc" id="L252">			throw e;</span>
<span class="nc" id="L253">		} catch(Exception e) {</span>
<span class="nc" id="L254">			throw new BbmCreateException(e);</span>
<span class="nc" id="L255">		}</span>
		
<span class="nc" id="L257">		return id;</span>
	}

	public Collection&lt;ID&gt; createSkillAssignments(Collection&lt;SkillAssignment&gt; assignments) throws BbmCreateException {
<span class="fc" id="L261">		Collection&lt;ID&gt; retVal = new ArrayList&lt;ID&gt;();</span>
		try {
<span class="fc" id="L263">			Collection&lt;ID&gt; skillSIDs = ValueObjectUtil.getFieldObjectCol(SkillAssignmentFieldInfo.SKILLASSIGNMENT_SKILLID, assignments);</span>
<span class="fc" id="L264">			Map&lt;ID, ID&gt; skillIDMap = DAOUtil.mapIDsToDEIDs(skillSIDs, new SkillFieldInfo());</span>
			
<span class="fc bfc" id="L266" title="All 2 branches covered.">			for (SkillAssignment assignment : assignments) {</span>
<span class="fc" id="L267">				assignment.setID(ID.fromString(DAOUtil.getDEID(m_dmo)));	//Not sure why this is required but if an existing assignment's effective date is changed the code will fail if this line is not here</span>
<span class="fc" id="L268">				assignment.setSkillID(skillIDMap.get(assignment.getSkillID()));</span>
				//try to merge first
<span class="fc" id="L270">				super.merge(assignment);</span>
<span class="fc" id="L271">				ID id = createNoOverlapAssignment(assignment, SkillAssignmentFieldInfo.SKILLASSIGNMENT_WORKRESOURCEID,</span>
						SkillAssignmentFieldInfo.SKILLASSIGNMENT_SKILLID);
<span class="fc" id="L273">				retVal.add(id);</span>
<span class="fc" id="L274">				notifyChangeManager(assignment);</span>
<span class="fc" id="L275">			}</span>
<span class="nc" id="L276">		} catch (Exception ex) {</span>
<span class="nc" id="L277">			throw new BbmCreateException(ex);</span>
<span class="fc" id="L278">		}</span>
		
<span class="fc" id="L280">		return retVal;</span>
	}

	/**
	 *  save a skill assignment
	 *  @param bSaveAsNew where save as new assignment or replace existing one
	 *
	 */
	public void updateSkillAssignment(SkillAssignment objValue, boolean bSaveAsNew) throws MultiUserException, BbmUpdateException {
		try {
			//try to merge first
<span class="nc" id="L291">			super.merge(objValue);</span>
<span class="nc" id="L292">			super.updateNoOverlapAssignment(convertSIDtoDEID(objValue), SkillAssignmentFieldInfo.SKILLASSIGNMENT_WORKRESOURCEID,</span>
					SkillAssignmentFieldInfo.SKILLASSIGNMENT_SKILLID, bSaveAsNew);
<span class="nc" id="L294">		} catch (BbmFinderException ex) {</span>
<span class="nc" id="L295">			throw new BbmUpdateException(ex);</span>
<span class="nc" id="L296">		}</span>
		try {
<span class="nc" id="L298">			notifyChangeManager(objValue);</span>
<span class="nc" id="L299">		} catch(BbmUpdateException e) {</span>
<span class="nc" id="L300">			throw e;</span>
<span class="nc" id="L301">		} catch(Exception e) {</span>
<span class="nc" id="L302">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L303">		}</span>
<span class="nc" id="L304">	}</span>

	/** delete skill assignments given their assignment ids */
	public void deleteSkillAssignmentByDEID(Collection&lt;SkillAssignment&gt; colIDAssignments) throws BbmRemoveException {
<span class="nc bnc" id="L308" title="All 4 branches missed.">		if( colIDAssignments == null || colIDAssignments.size() &lt;= 0 )</span>
<span class="nc" id="L309">			return;</span>
		
		try 
		{
<span class="nc" id="L313">			StringBuffer idsToDelete = new StringBuffer();</span>
<span class="nc" id="L314">			Iterator&lt;SkillAssignment&gt; iter = colIDAssignments.iterator();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">			while( iter.hasNext() )</span>
			{
<span class="nc bnc" id="L317" title="All 2 branches missed.">				if( idsToDelete.length() &gt; 0 )</span>
<span class="nc" id="L318">					idsToDelete.append(&quot;,&quot;);</span>
					
<span class="nc" id="L320">				idsToDelete.append( &quot;'&quot; );</span>
<span class="nc" id="L321">				idsToDelete.append( iter.next() );</span>
<span class="nc" id="L322">				idsToDelete.append( &quot;'&quot; );</span>
			}

			// get skills to be deleted, this is required for
			// notification
<span class="nc" id="L327">			StringBuffer  query =  new StringBuffer();</span>
<span class="nc" id="L328">			query.append( &quot;SELECT ID, WORKRESOURCEID, STARTDATE, ENDDATE FROM WORKRESOURCESKILL &quot; );</span>
<span class="nc" id="L329">			query.append( &quot; WHERE ID in (&quot; );</span>
<span class="nc" id="L330">			query.append( idsToDelete.toString() );</span>
<span class="nc" id="L331">			query.append( &quot; )&quot; );</span>
			
<span class="nc" id="L333">			ArrayList&lt;SkillAssignment&gt; delSkill = new ArrayList&lt;SkillAssignment&gt;();</span>
<span class="nc" id="L334">			JdmoRowset r = m_dmo.createRowset( query.toString() );</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">			while(r.next()) </span>
			{
<span class="nc" id="L337">				SkillAssignment pSkill = new SkillAssignment();</span>
				
<span class="nc" id="L339">				ID id = new ID( r.getString(&quot;ID&quot;) );</span>
<span class="nc" id="L340">				pSkill.setID(id);</span>

<span class="nc" id="L342">				ID idEmployee = r.getID(&quot;WORKRESOURCEID&quot;);</span>
<span class="nc" id="L343">				pSkill.setWorkResourceID(idEmployee);</span>
				
<span class="nc" id="L345">				Timestamp ts = r.getTimestamp(&quot;STARTDATE&quot;);</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">				if( ts != null )</span>
				{
<span class="nc" id="L348">					Date sd = new Date( ts.getTime() );</span>
<span class="nc" id="L349">					pSkill.setStartTime(sd);</span>
				}
				
<span class="nc" id="L352">				ts = r.getTimestamp(&quot;ENDDATE&quot;);</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">				if( ts != null )</span>
				{
<span class="nc" id="L355">					Date sd = new Date( ts.getTime() );</span>
<span class="nc" id="L356">					pSkill.setEndTime(sd);</span>
				}

<span class="nc" id="L359">				delSkill.add(pSkill);</span>
<span class="nc" id="L360">			}</span>

			// delete the skills
<span class="nc" id="L363">			query.setLength(0);</span>
<span class="nc" id="L364">			query.append( &quot;delete from workresourceskill where id in (&quot; );</span>
<span class="nc" id="L365">			query.append( idsToDelete.toString() );</span>
<span class="nc" id="L366">			query.append( &quot; )&quot; );</span>
<span class="nc" id="L367">			this.m_dmo.executeCommand(query.toString());</span>
			
			// notify changes
<span class="nc" id="L370">			iter = delSkill.iterator();</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">			while( iter.hasNext() )</span>
			{
<span class="nc" id="L373">				this.notifyChangeManager( iter.next() );</span>
			}

		} 
<span class="nc" id="L377">		catch (Exception e) </span>
		{
<span class="nc" id="L379">			throw new BbmRemoveException(e);</span>
		}
		finally
		{
<span class="nc" id="L383">			this.m_dmo.cleanUp();</span>
<span class="nc" id="L384">		}</span>
<span class="nc" id="L385">	}</span>
	
	/** delete skill assignments given their assignment ids */
	public void deleteSkillAssignments(Collection colIDAssignments) throws BbmRemoveException {
		Collection colAssignments;
		try {
<span class="nc" id="L391">			colAssignments = getObjectsByIDs(colIDAssignments);</span>
<span class="nc bnc" id="L392" title="All 4 branches missed.">			if (colAssignments == null || colAssignments.isEmpty()) return;</span>
<span class="nc" id="L393">		} catch (Exception e) {</span>
<span class="nc" id="L394">			throw new BbmRemoveException(e);</span>
<span class="nc" id="L395">		}</span>
		
<span class="nc" id="L397">		deleteObjects(colIDAssignments);</span>
		
		try {
<span class="nc" id="L400">			Iterator it = colAssignments.iterator();</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">			while (it.hasNext())</span>
<span class="nc" id="L402">				notifyChangeManager((SkillAssignment) it.next());</span>
<span class="nc" id="L403">		} catch(BbmRemoveException e) {</span>
<span class="nc" id="L404">			throw e;</span>
<span class="nc" id="L405">		} catch (Exception e) {</span>
<span class="nc" id="L406">			throw new BbmRemoveException(e);</span>
<span class="nc" id="L407">		}</span>
<span class="nc" id="L408">	}</span>
	
	public Collection getSkillAssignmentsByIDs(Collection colIDSAs) throws BbmFinderException {
<span class="nc" id="L411">		return getObjectsByIDs(colIDSAs);</span>
	}
	
	public void notifyChangeManager(SkillAssignment assignment)
			throws Exception {
<span class="pc bpc" id="L416" title="1 of 2 branches missed.">		if (m_changeManager == null)</span>
<span class="fc" id="L417">			m_changeManager = CoreManagerFactory.getChangeManager();</span>
		
<span class="fc" id="L419">		ArrayList&lt;ID&gt; arrIDs = new ArrayList&lt;ID&gt;(1);</span>
<span class="fc" id="L420">		arrIDs.add(assignment.getWorkResourceID());</span>
		
<span class="fc" id="L422">		TimeRange range = new TimeRange(assignment.getStartTime(),</span>
<span class="pc bpc" id="L423" title="1 of 2 branches missed.">				assignment.getEndTime() == null ?</span>
<span class="pc" id="L424">						new Date(TimeRange.FAR_FUTURE) : assignment.getEndTime());</span>
		
<span class="fc" id="L426">		EmployeeSkillChangeObject vo = new EmployeeSkillChangeObject();</span>
<span class="fc" id="L427">		vo.setAffectedObjects(EmployeeSkillChangeObject.EMPLOYEE_TYPE, arrIDs);</span>
<span class="fc" id="L428">		vo.setAffectedTimeRange(range);</span>
<span class="fc" id="L429">		m_changeManager.onChange(vo);</span>
<span class="fc" id="L430">	}</span>
	
	/**
	 * This method swaps the integer ID skillID for the string (DEID) skill ID.  Used before saving.
	 * WARNING: once a SkillAssignment has been handed in to this method, it is no longer safe to use
	 * as a string value gets stored in the SkillAssignmentFieldInfo.SKILLASSIGNMENT_SKILLID field.
	 * Subsequent calls to SkillAssignment.getSkillID() will result in a class cast exception!
	 * @deprecated - Use DAOUtil.mapIDtoDEID instead
	 */
	private SkillAssignment convertSIDtoDEID(SkillAssignment obj) throws BbmFinderException{
		try {
			// Find SID to ID mapping
<span class="nc" id="L442">			StringBuffer pStmt = new StringBuffer(&quot;select ID from skill where SID=?&quot;);</span>
<span class="nc" id="L443">			JdmoQuery jq1 = m_dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L444">			ID skillID = obj.getSkillID();		</span>
<span class="nc" id="L445">			jq1.setParString(1, skillID.toString());</span>
<span class="nc" id="L446">			JdmoRowset rs = m_dmo.createRowset(jq1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L447">			String skillIDStr = &quot;&quot;;</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L449">				skillIDStr = rs.getString(1);</span>
<span class="nc" id="L450">				obj.setFieldValue(SkillAssignmentFieldInfo.SKILLASSIGNMENT_SKILLID, skillIDStr);</span>
			}

<span class="nc" id="L453">			return obj;</span>
<span class="nc" id="L454">		} catch (JdmoException ex) {</span>
<span class="nc" id="L455">			throw new BbmFinderException(ex);</span>
		}
	}
	
	private void appendTimeRange( StringBuffer query, Date dtStart, Date dtEnd ) {
<span class="fc bfc" id="L460" title="All 2 branches covered.">		if( dtEnd != null ) {</span>
<span class="fc" id="L461">			query.append( &quot; AND '&quot;);</span>
<span class="fc" id="L462">			query.append( JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtEnd)) );</span>
<span class="fc" id="L463">			query.append( &quot;' &gt;= STARTDATE &quot;);</span>
		}
		
<span class="fc bfc" id="L466" title="All 2 branches covered.">		if( dtStart != null )	{</span>
<span class="fc" id="L467">			query.append( &quot; AND ( '&quot;);</span>
<span class="fc" id="L468">			query.append( JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtStart)) );</span>
<span class="fc" id="L469">			query.append( &quot;' &lt;= ENDDATE OR ENDDATE is NULL ) &quot;);</span>
		}
<span class="fc" id="L471">	}</span>
	
	protected boolean allowCreateWithId() {
<span class="fc" id="L474">		return true;</span>
	}
	
	
	public Collection getEffectiveAtTimeRange(ValueObjectEffectivity newObject, Date start, Date end) throws BbmFinderException {
<span class="fc" id="L479">		SkillAssignment skillAssignment = (SkillAssignment)newObject;</span>
<span class="fc" id="L480">		StringBuffer extraCriteria = new StringBuffer(200);</span>
<span class="fc" id="L481">		extraCriteria.append(getFieldInfo().getFieldName(SkillAssignmentFieldInfo.SKILLASSIGNMENT_SKILLID));</span>
<span class="fc" id="L482">		extraCriteria.append(&quot;='&quot;).append(skillAssignment.getFieldValue(SkillAssignmentFieldInfo.SKILLASSIGNMENT_SKILLID)).append(&quot;'&quot;); //skill ID is DEID now.</span>
<span class="fc" id="L483">		extraCriteria.append(&quot; and &quot;);</span>
<span class="fc" id="L484">		extraCriteria.append(getFieldInfo().getFieldName(SkillAssignmentFieldInfo.SKILLASSIGNMENT_PRIORITY));</span>
<span class="fc" id="L485">		extraCriteria.append(&quot;=&quot;).append(skillAssignment.getPriority());</span>
<span class="fc" id="L486">		extraCriteria.append(&quot; and &quot;);</span>
<span class="fc" id="L487">		extraCriteria.append(getFieldInfo().getFieldName(SkillAssignmentFieldInfo.SKILLASSIGNMENT_PROFICIENCY));</span>
<span class="fc" id="L488">		extraCriteria.append(&quot;=&quot;).append(skillAssignment.getProficiency());</span>
<span class="fc" id="L489">		extraCriteria.append(&quot; and &quot;);</span>
<span class="fc" id="L490">		extraCriteria.append(getFieldInfo().getFieldName(SkillAssignmentFieldInfo.SKILLASSIGNMENT_RESERVELEVEL));</span>
<span class="pc bpc" id="L491" title="1 of 2 branches missed.">		extraCriteria.append(&quot;=&quot;).append(skillAssignment.isReserve()?1:0);</span>
		
<span class="fc" id="L493">		return getEffectivityAssignments(newObject.getParentID(), SkillAssignmentFieldInfo.SKILLASSIGNMENT_WORKRESOURCEID, start, end, extraCriteria.toString());</span>
	 }
	
	// override the one in DAOEffectivity. For skill assignment only, the start and end are naming as startdate and enddate 
	// instead of starttime and endtime. should change db schema later.
	public Collection getEffectivityAssignments(ID id, int iField, Date dtStart, Date dtEnd, String extraCriteria) throws BbmFinderException {
<span class="pc bpc" id="L499" title="1 of 2 branches missed.">		if (id == null) return Collections.emptyList();</span>

<span class="fc" id="L501">		StringBuffer strWhere = new StringBuffer(30);</span>
<span class="fc" id="L502">		strWhere.append(&quot;A.&quot;).append(getFieldInfo().getFieldName(iField)).append(&quot;=&quot;).append(id);</span>
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">		if (extraCriteria != null) {</span>
<span class="fc" id="L504">			strWhere.append(&quot; AND &quot;).append(extraCriteria);</span>
		}

<span class="pc bpc" id="L507" title="1 of 2 branches missed.">		if (dtStart != null) {</span>
<span class="fc" id="L508">			 String strStart = &quot;'&quot; + JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtStart)) + &quot;'&quot;;</span>
<span class="fc" id="L509">			 strWhere.append(&quot; AND (A.ENDDATE IS NULL OR A.ENDDATE &gt;= &quot; + strStart + &quot;)&quot;);</span>
		}

<span class="pc bpc" id="L512" title="1 of 2 branches missed.">		if (dtEnd != null) {</span>
<span class="fc" id="L513">			String strEnd = &quot;'&quot; + JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtEnd)) + &quot;'&quot;;</span>
<span class="fc" id="L514">			strWhere.append(&quot; AND A.STARTDATE &lt;= &quot; + strEnd);</span>
		}

<span class="fc" id="L517">		strWhere.append(&quot; ORDER BY A.STARTDATE &quot;);</span>

<span class="fc" id="L519">		return getObjects(new String(strWhere));</span>
	}
	
	/**
	 * The &quot;start time&quot; field for a skill assignment is named &quot;STARTDATE&quot; instead of the default
	 * &quot;STARTTIME&quot;.
	 */
	@Override
	protected String getStartTimeFieldName() {
<span class="fc" id="L528">		return getFieldInfo().getFieldName(SkillAssignmentFieldInfo.SKILLASSIGNMENT_STARTTIME);</span>
	}
	
	/**
	 * The &quot;end time&quot; field for a skill assignment is named &quot;ENDDATE&quot; instead of the default
	 * &quot;ENDTIME&quot;.
	 */
	@Override
	protected String getEndTimeFieldName() {
<span class="fc" id="L537">		return getFieldInfo().getFieldName(SkillAssignmentFieldInfo.SKILLASSIGNMENT_ENDTIME);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>