<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StaffingProfilesListPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.staffingprofiles</a> &gt; <span class="el_source">StaffingProfilesListPC.java</span></div><h1>StaffingProfilesListPC.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.staffingprofiles;

import com.bluepumpkin.common.datatypes.DayOfWeek;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SPEmpTemplate;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.skill.ejb.SkillManager;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTemplate;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeType;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.ejb.WorkRuleManager;
import com.bluepumpkin.ejb.bbm.workrules.model.ComplexWorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.fs.widgets.MultiColMasterDetailListPC;
import com.verint.web.fs.widgets.ToggleVisiblePC;
import com.witness.web.uif.data.wrapper.NumberWrapper;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.WorkpaneMultiColPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.SortUtil;

import javax.servlet.http.HttpServletRequest;
import java.util.*;

public class StaffingProfilesListPC extends MultiColMasterDetailListPC {
	private static final long serialVersionUID = 1L;
	protected static final String MIN_AGENT_RATIO_FN = &quot;minAgentRatioPF&quot;;
	protected static final String MAX_AGENT_RATIO_FN = &quot;maxAgentRatioPF&quot;;
	protected static final String MIN_AGENT_FN = &quot;minAgentPF&quot;;
	protected static final String MAX_AGENT_FN = &quot;maxAgentPF&quot;;

	private static final String DELIMITER_COMMA = &quot;,&quot;;

	ToggleVisiblePC toggleAll;
	protected FormInputPC m_MinAgentRatioPC;
	protected FormInputPC m_MaxAgentRatioPC;
	protected FormInputPC m_MinAgentPC;
	protected FormInputPC m_MaxAgentPC;

<span class="nc" id="L54">	protected Map m_minAgentRatioMap = Collections.emptyMap();</span>
<span class="nc" id="L55">	protected Map m_maxAgentRatioMap = Collections.emptyMap();</span>
<span class="nc" id="L56">	protected Map m_minAgentMap = Collections.emptyMap();</span>
<span class="nc" id="L57">	protected Map m_maxAgentMap = Collections.emptyMap();</span>

	private boolean isByOrg;
	private Campaign m_camp;
<span class="nc" id="L61">	private Map&lt;ID, Organization&gt; m_orgMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L62">	private boolean m_hasWeekStartMisAlligned = false;</span>

	final static String EMPTY_STRING = &quot;&quot;;

	public StaffingProfilesListPC(RequestContext context, Collection&lt;SPEmpTemplate&gt; spEmpTemplates,
			Collection&lt;EmployeeTemplate&gt; empTemplates, boolean isByOrg, int minPhantoms, int maxPhantoms,
			Map&lt;ID, Organization&gt; orgMap, Map&lt;ID, Campaign&gt; campaignMap, Map&lt;ID, Activity&gt; activityMap,
			Map&lt;ID, EmployeeType&gt; empTypeMap) {
<span class="nc" id="L70">		super(context);</span>

<span class="nc bnc" id="L72" title="All 4 branches missed.">		if (campaignMap != null &amp;&amp; !campaignMap.isEmpty()) {</span>
<span class="nc" id="L73">			m_camp = campaignMap.values().iterator().next();</span>
		}

		// performance enhance, it is slow to call EJB to get org for each
		// staffing profile.
<span class="nc bnc" id="L78" title="All 4 branches missed.">		if (orgMap != null &amp;&amp; !orgMap.isEmpty()) {</span>
<span class="nc" id="L79">			m_orgMap = orgMap;</span>
		}

<span class="nc" id="L82">		toggleAll = new ToggleVisiblePC(m_context, &quot;toggleAll&quot;);</span>
<span class="nc" id="L83">		this.addChildComponent(toggleAll);</span>

<span class="nc bnc" id="L85" title="All 2 branches missed.">		if (empTemplates == null) {</span>
<span class="nc" id="L86">			this.isByOrg = false;</span>
		} else {
<span class="nc" id="L88">			this.isByOrg = true;</span>
		}

<span class="nc bnc" id="L91" title="All 2 branches missed.">		if (!isByOrg) {</span>
<span class="nc" id="L92">			m_MinAgentRatioPC = new FormInputPC(context);</span>
<span class="nc" id="L93">			m_MinAgentRatioPC.setInputType(FormInputPC.TYPE_PERCENTAGE);</span>
<span class="nc" id="L94">			m_MinAgentRatioPC.setIsRequired(true);</span>

<span class="nc" id="L96">			m_MaxAgentRatioPC = new FormInputPC(context);</span>
<span class="nc" id="L97">			m_MaxAgentRatioPC.setInputType(FormInputPC.TYPE_PERCENTAGE);</span>
<span class="nc" id="L98">			m_MaxAgentRatioPC.setIsRequired(true);</span>

<span class="nc" id="L100">			m_MinAgentPC = new FormInputPC(context);</span>
<span class="nc" id="L101">			m_MinAgentPC.setIsRequired(true);</span>

<span class="nc" id="L103">			m_MaxAgentPC = new FormInputPC(context);</span>
<span class="nc" id="L104">			m_MaxAgentPC.setIsRequired(true);</span>

<span class="nc" id="L106">			this.addChildComponent(m_MinAgentRatioPC);</span>
<span class="nc" id="L107">			this.addChildComponent(m_MaxAgentRatioPC);</span>
<span class="nc" id="L108">			this.addChildComponent(m_MinAgentPC);</span>
<span class="nc" id="L109">			this.addChildComponent(m_MaxAgentPC);</span>

<span class="nc" id="L111">			initRows(spEmpTemplates, minPhantoms, maxPhantoms);</span>

		} else {
<span class="nc" id="L114">			initRows2(empTemplates);</span>
		}

<span class="nc" id="L117">		initHeader();</span>
<span class="nc" id="L118">	}</span>

	/**
	 * Return Maps
	 */
	public Map getMinAgentRatiosMap() {
<span class="nc" id="L124">		return m_minAgentRatioMap;</span>
	}

	public Map getMaxAgentRatiosMap() {
<span class="nc" id="L128">		return m_maxAgentRatioMap;</span>
	}

	public Map getMinAgentsMap() {
<span class="nc" id="L132">		return m_minAgentMap;</span>
	}

	public Map getMaxAgentsMap() {
<span class="nc" id="L136">		return m_maxAgentMap;</span>
	}

	private void initHeader() {
<span class="nc" id="L140">		TableHeaderPC header = getHeader();</span>
<span class="nc" id="L141">		Localizer localizer = m_context.getLocalizer();</span>
<span class="nc" id="L142">		header.setPartialSortable(true);</span>

<span class="nc" id="L144">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_NAME,</span>
<span class="nc" id="L145">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_NAME), true);</span>
<span class="nc" id="L146">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_WP,</span>
<span class="nc" id="L147">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_WP), true);</span>
<span class="nc" id="L148">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_Org,</span>
<span class="nc" id="L149">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_Org), true);</span>
<span class="nc" id="L150">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_WAGE,</span>
<span class="nc" id="L151">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_WAGE), true);</span>
<span class="nc" id="L152">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_PROFICIENCY,</span>
<span class="nc" id="L153">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_PROFICIENCY), true);</span>
<span class="nc" id="L154">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_CHAT_SESSION,</span>
<span class="nc" id="L155">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_CHAT_SESSION), true);</span>
<span class="nc" id="L156">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_ASSIGNMENT_RULES,</span>
<span class="nc" id="L157">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_ASSIGNMENT_RULES), true);</span>
<span class="nc" id="L158">		header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_SKILLS,</span>
<span class="nc" id="L159">				localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_SKILLS), true);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">		if (!isByOrg) {</span>
<span class="nc" id="L161">			header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_MANIMUM_AGENT_RATIO,</span>
<span class="nc" id="L162">					localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_MANIMUM_AGENT_RATIO),</span>
					true);
<span class="nc" id="L164">			header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_MAXIMUM_AGENT_RATIO,</span>
<span class="nc" id="L165">					localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_MAXIMUM_AGENT_RATIO),</span>
					true);
<span class="nc" id="L167">			header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_MANIMUM_AGENTS,</span>
<span class="nc" id="L168">					localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_MANIMUM_AGENTS), true);</span>
<span class="nc" id="L169">			header.addColumnHeaderData(FsWebBundleKey.FS_STAFFING_PROFILES_MAXIMUM_AGENTS,</span>
<span class="nc" id="L170">					localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_STAFFING_PROFILES_MAXIMUM_AGENTS), true);</span>
		}

		// Enable Auto Sorting
<span class="nc" id="L174">		ArrayList&lt;String&gt; sortColumns = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L175">		sortColumns.add(UIFWebBundleKey.LIST_HEADER_NAME);</span>
<span class="nc" id="L176">		header.setDefaultSortColumns(sortColumns);</span>
<span class="nc" id="L177">	}</span>

<span class="nc" id="L179">	DayOfWeek m_campWeekStart = null;</span>

	private DayOfWeek getCampWeekStart() {
		// one calc for each ListPC
<span class="nc bnc" id="L183" title="All 4 branches missed.">		if (m_camp != null &amp;&amp; m_campWeekStart == null) {</span>
<span class="nc" id="L184">			Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L185">			cal.set(Calendar.DAY_OF_WEEK, Calendar.SUNDAY);</span>
<span class="nc" id="L186">			cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L187">			cal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L188">			cal.add(Calendar.MINUTE, m_camp.getWeekStart());</span>
<span class="nc" id="L189">			m_campWeekStart = DayOfWeek.fromCalendarConstant(cal.get(Calendar.DAY_OF_WEEK));</span>
		}
<span class="nc" id="L191">		return m_campWeekStart;</span>
	}

	private void initRows(Collection&lt;SPEmpTemplate&gt; spEmpTemplates, int minPhantom, int maxPhantom) {
<span class="nc" id="L195">		Collection&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>
		try {
<span class="nc" id="L197">			WorkResourceManager wrMgr = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L198">			ScheduleAccessManager saMgr = WfmManagerFactory.getScheduleAccessManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L199">			WorkRuleManager wrm = WfmManagerFactory.getWorkRuleManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L200">			SkillManager skillMgr = WfmManagerFactory.getSkillManager(m_context.isInWhatIfMode());</span>

<span class="nc" id="L202">			Collection&lt;ID&gt; empTemplateIDs = new ArrayList&lt;&gt;(spEmpTemplates.size());</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">			for (SPEmpTemplate spEmpTemplate : spEmpTemplates) {</span>
<span class="nc" id="L204">				empTemplateIDs.add(spEmpTemplate.getEmpTemplateID());</span>
<span class="nc" id="L205">			}</span>
<span class="nc" id="L206">			HashMap&lt;ID, EmployeeTemplate&gt; empTemplateIDObjMap = ValueObjectUtil.getIDObjectMap(saMgr</span>
<span class="nc" id="L207">					.getEmployeeTemplatesByIDs(empTemplateIDs));</span>

<span class="nc" id="L209">			ArrayList&lt;ID&gt; colWP = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L210">			ArrayList&lt;ID&gt; colAR = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L211">			ArrayList&lt;ID&gt; colSkill = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">			for (EmployeeTemplate et : empTemplateIDObjMap.values()) {</span>
<span class="nc" id="L213">				colWP.addAll(et.getShiftPatterns());</span>
<span class="nc" id="L214">				colAR.addAll(et.getAssignmentRuleIDs());</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">				for (SkillAssignment sa : et.getSkillAssignments()) {</span>
<span class="nc" id="L216">					colSkill.add(sa.getSkillID());</span>
<span class="nc" id="L217">				}</span>
<span class="nc" id="L218">			}</span>
<span class="nc" id="L219">			HashMap&lt;ID, ShiftPattern&gt; allShiftPatterns = ValueObjectUtil.getIDObjectMap(wrm.getShiftPatternsByIDs(colWP));</span>
<span class="nc" id="L220">			HashMap&lt;ID, ComplexWorkRule&gt; allWorkRules = ValueObjectUtil.getIDObjectMap(wrm.getComplexWorkRulesByIDs(colAR));</span>
<span class="nc" id="L221">			HashMap&lt;ID, Skill&gt; allSkills = ValueObjectUtil.getIDObjectMap(skillMgr.getSkillsByIDs(colSkill));</span>

<span class="nc bnc" id="L223" title="All 2 branches missed.">			for (SPEmpTemplate spEmpTemplate : spEmpTemplates) {</span>
<span class="nc" id="L224">				ID empTemplateID = spEmpTemplate.getEmpTemplateID();</span>
<span class="nc" id="L225">				EmployeeTemplate et = empTemplateIDObjMap.get(empTemplateID);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">				if (et != null) {</span>
<span class="nc" id="L227">					DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData(spEmpTemplate.getID());</span>
					// Name
<span class="nc bnc" id="L229" title="All 2 branches missed.">					boolean isWeekStartMisAligned = m_camp != null</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">							&amp;&amp; getOrg(wrMgr, et.getOrganizationID()).getWeekStartDay() != getCampWeekStart();</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">					rowData.add(et.getName() + (isWeekStartMisAligned ? &quot;*&quot; : EMPTY_STRING));</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">					if (isWeekStartMisAligned) {</span>
<span class="nc" id="L233">						m_hasWeekStartMisAlligned = true;</span>
					}

					// Work Pattern
<span class="nc" id="L237">					StringBuilder workPatternDisplay = new StringBuilder();</span>
<span class="nc" id="L238">					List&lt;ID&gt; colWPIDs = et.getShiftPatterns();</span>
<span class="nc" id="L239">					int strCnt = 0;</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">					if (colWPIDs.size() &gt; 0) {</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">						for (ID wpID : colWPIDs) {</span>
<span class="nc bnc" id="L242" title="All 4 branches missed.">							if (strCnt &gt; 0 &amp;&amp; strCnt != colWPIDs.size()) {</span>
<span class="nc" id="L243">								workPatternDisplay.append(DELIMITER_COMMA);</span>
							}

<span class="nc" id="L246">							ShiftPattern sp = allShiftPatterns.get(wpID);</span>
<span class="nc" id="L247">							workPatternDisplay.append(sp.getName());</span>
<span class="nc" id="L248">							strCnt++;</span>
<span class="nc" id="L249">						}</span>
<span class="nc" id="L250">						rowData.add(workPatternDisplay.toString());</span>
					} else {
<span class="nc" id="L252">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

					// Org
<span class="nc" id="L256">					ID orgID = et.getOrganizationID();</span>
<span class="nc" id="L257">					Organization o = getOrg(wrMgr, orgID);</span>
<span class="nc" id="L258">					rowData.add(o.getName());</span>

					// wage
<span class="nc" id="L261">					rowData.add(et.getWage());</span>

					// Proficiency
<span class="nc" id="L264">					rowData.add(et.getProficiency());</span>

					// Chat Session
<span class="nc bnc" id="L267" title="All 2 branches missed.">					if (et.getChatSessions() &gt;= 0) {</span>
<span class="nc" id="L268">						rowData.add(new Integer(et.getChatSessions()).toString());</span>
					} else {
<span class="nc" id="L270">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

					// assignment Rules
<span class="nc" id="L274">					List&lt;ID&gt; colARIDs = et.getAssignmentRuleIDs();</span>
<span class="nc" id="L275">					StringBuilder assignmentRulesColumnDisplay = new StringBuilder();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">					if (colARIDs.size() &gt; 0) {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">						for (ID ruleID : colARIDs) {</span>
<span class="nc" id="L278">							ComplexWorkRule complexWorkRule = allWorkRules.get(ruleID);</span>

<span class="nc bnc" id="L280" title="All 2 branches missed.">							if (assignmentRulesColumnDisplay.length() &gt; 0) {</span>
<span class="nc" id="L281">								assignmentRulesColumnDisplay.append(DELIMITER_COMMA);</span>
							}
<span class="nc" id="L283">							assignmentRulesColumnDisplay.append(complexWorkRule.getName());</span>
<span class="nc" id="L284">						}</span>
<span class="nc" id="L285">						rowData.add(assignmentRulesColumnDisplay.toString());</span>
					} else {
<span class="nc" id="L287">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

					// skills
<span class="nc" id="L291">					Collection&lt;SkillAssignment&gt; skillAssignments = et.getSkillAssignments();</span>
<span class="nc" id="L292">					StringBuilder skillsAssignmentsColumnDisplay = new StringBuilder();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">					if (skillAssignments.size() &gt; 0) {</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">						for (SkillAssignment sa : skillAssignments) {</span>
<span class="nc" id="L295">							Skill skill = allSkills.get(sa.getSkillID());</span>

<span class="nc bnc" id="L297" title="All 2 branches missed.">							if (skillsAssignmentsColumnDisplay.length() &gt; 0) {</span>
<span class="nc" id="L298">								skillsAssignmentsColumnDisplay.append(DELIMITER_COMMA);</span>
							}
<span class="nc" id="L300">							skillsAssignmentsColumnDisplay.append(skill.getName());</span>
<span class="nc" id="L301">						}</span>
<span class="nc" id="L302">						rowData.add(skillsAssignmentsColumnDisplay);</span>
					} else {
<span class="nc" id="L304">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

					// Min percent
<span class="nc" id="L308">					rowData.add(getMinAgentRatioUI(spEmpTemplate.getID().toString(), spEmpTemplate.getMinAllocation(), true));</span>

					// Max percent
<span class="nc" id="L311">					rowData.add(getMaxAgentRatioUI(spEmpTemplate.getID().toString(), spEmpTemplate.getMaxAllocation(), true));</span>

					// Min
<span class="nc" id="L314">					rowData.add(getMinAgentsUI(spEmpTemplate.getID().toString(), spEmpTemplate.getMinNumEmployees(), true));</span>

					// Max
<span class="nc" id="L317">					rowData.add(getMaxAgentsUI(spEmpTemplate.getID().toString(), spEmpTemplate.getMaxNumEmployees(), true));</span>
<span class="nc" id="L318">					rows.add(rowData);</span>
				}

<span class="nc" id="L321">			}</span>
<span class="nc" id="L322">		} catch (Exception e) {</span>
<span class="nc" id="L323">			handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L324">		}</span>

<span class="nc" id="L326">		DefaultMultiColumnNodeData rowData1 = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L327">		rowData1.add(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_TOTAL_STAFFING_PROFILES));</span>
<span class="nc" id="L328">		rowData1.add(EMPTY_STRING);</span>
<span class="nc" id="L329">		rowData1.add(EMPTY_STRING);</span>
<span class="nc" id="L330">		rowData1.add(EMPTY_STRING);</span>
<span class="nc" id="L331">		rowData1.add(EMPTY_STRING);</span>
<span class="nc" id="L332">		rowData1.add(EMPTY_STRING);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">		if (!isByOrg) {</span>
<span class="nc" id="L334">			rowData1.add(EMPTY_STRING);</span>
<span class="nc" id="L335">			rowData1.add(EMPTY_STRING);</span>
<span class="nc" id="L336">			rowData1.add(EMPTY_STRING);</span>
<span class="nc" id="L337">			rowData1.add(EMPTY_STRING);</span>
<span class="nc" id="L338">			rowData1.add(getMinAgentsUI(&quot;test&quot;, minPhantom, true));</span>
<span class="nc" id="L339">			rowData1.add(getMaxAgentsUI(&quot;test&quot;, maxPhantom, true));</span>
		}

<span class="nc" id="L342">		setRowAttributes(rowData1, null);</span>

<span class="nc" id="L344">		rows.add(rowData1);</span>
<span class="nc" id="L345">	}</span>

	private void initRows2(Collection&lt;EmployeeTemplate&gt; empTemplates) {
<span class="nc" id="L348">		Collection&lt;MultiColumnNodeData&gt; rows = super.getListModel();</span>

		try {
<span class="nc" id="L351">			WorkResourceManager wrMgr = BbmManagerFactory.getWorkResourceManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L352">			WorkRuleManager wrm = WfmManagerFactory.getWorkRuleManager(m_context.isInWhatIfMode());</span>
<span class="nc" id="L353">			SkillManager skillMgr = WfmManagerFactory.getSkillManager(m_context.isInWhatIfMode());</span>

<span class="nc" id="L355">			ArrayList&lt;ID&gt; colWP = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L356">			ArrayList&lt;ID&gt; colAR = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L357">			ArrayList&lt;ID&gt; colSkill = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">			for (EmployeeTemplate et : empTemplates) {</span>
<span class="nc" id="L359">				colWP.addAll(et.getShiftPatterns());</span>
<span class="nc" id="L360">				colAR.addAll(et.getAssignmentRuleIDs());</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">				for (SkillAssignment sa : et.getSkillAssignments()) {</span>
<span class="nc" id="L362">					colSkill.add(sa.getSkillID());</span>
<span class="nc" id="L363">				}</span>
<span class="nc" id="L364">			}</span>
<span class="nc" id="L365">			HashMap&lt;ID, ShiftPattern&gt; allShiftPatterns = ValueObjectUtil.getIDObjectMap(wrm.getShiftPatternsByIDs(colWP));</span>
<span class="nc" id="L366">			HashMap&lt;ID, ComplexWorkRule&gt; allWorkRules = ValueObjectUtil.getIDObjectMap(wrm.getComplexWorkRulesByIDs(colAR));</span>
<span class="nc" id="L367">			HashMap&lt;ID, Skill&gt; allSkills = ValueObjectUtil.getIDObjectMap(skillMgr.getSkillsByIDs(colSkill));</span>

<span class="nc bnc" id="L369" title="All 2 branches missed.">			for (EmployeeTemplate et : empTemplates) {</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">				if (et != null) {</span>
<span class="nc" id="L371">					DefaultMultiColumnNodeData rowData = new DefaultMultiColumnNodeData(et.getID());</span>
					// Name
<span class="nc bnc" id="L373" title="All 2 branches missed.">					boolean isWeekStartMisAligned = m_camp != null</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">							&amp;&amp; getOrg(wrMgr, et.getOrganizationID()).getWeekStartDay() != getCampWeekStart();</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">					rowData.add(et.getName() + (isWeekStartMisAligned ? &quot;*&quot; : EMPTY_STRING));</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">					if (isWeekStartMisAligned) {</span>
<span class="nc" id="L377">						m_hasWeekStartMisAlligned = true;</span>
					}

					// Work Pattern
<span class="nc" id="L381">					List&lt;ID&gt; colWPIDs = et.getShiftPatterns();</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">					if (colWPIDs.size() &gt; 0) {</span>
<span class="nc" id="L383">						ShiftPattern sp = allShiftPatterns.get(colWPIDs.iterator().next());</span>
<span class="nc" id="L384">						rowData.add(sp.getName());</span>
<span class="nc" id="L385">					} else {</span>
<span class="nc" id="L386">						rowData.add(EMPTY_STRING);</span>
					}

					// Org
<span class="nc" id="L390">					ID orgID = et.getOrganizationID();</span>
<span class="nc" id="L391">					Organization o = getOrg(wrMgr, orgID);</span>
<span class="nc" id="L392">					rowData.add(o.getName());</span>

					// wage
<span class="nc" id="L395">					rowData.add(et.getWage());</span>

					// Proficiency
<span class="nc" id="L398">					rowData.add(et.getProficiency());</span>

					// Chat Session
<span class="nc bnc" id="L401" title="All 2 branches missed.">					if (et.getChatSessions() &gt;= 0) {</span>
<span class="nc" id="L402">						rowData.add(new Integer(et.getChatSessions()).toString());</span>
					} else {
<span class="nc" id="L404">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

					// assignment Rules
<span class="nc" id="L408">					List&lt;ID&gt; colARIDs = et.getAssignmentRuleIDs();</span>
<span class="nc" id="L409">					StringBuilder assignmentRulesColumnDisplay = new StringBuilder();</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">					if (colARIDs.size() &gt; 0) {</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">						for (ID ruleID : colARIDs) {</span>
<span class="nc" id="L412">							ComplexWorkRule complexWorkRule = allWorkRules.get(ruleID);</span>

<span class="nc bnc" id="L414" title="All 2 branches missed.">							if (assignmentRulesColumnDisplay.length() &gt; 0) {</span>
<span class="nc" id="L415">								assignmentRulesColumnDisplay.append(DELIMITER_COMMA);</span>
							}
<span class="nc" id="L417">							assignmentRulesColumnDisplay.append(complexWorkRule.getName());</span>
<span class="nc" id="L418">						}</span>
<span class="nc" id="L419">						rowData.add(assignmentRulesColumnDisplay.toString());</span>
					} else {
<span class="nc" id="L421">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

					// skills
<span class="nc" id="L425">					Collection&lt;SkillAssignment&gt; skillAssignments = et.getSkillAssignments();</span>
<span class="nc" id="L426">					StringBuilder skillsAssignmentsColumnDisplay = new StringBuilder();</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">					if (skillAssignments.size() &gt; 0) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">						for (SkillAssignment sa : skillAssignments) {</span>
<span class="nc" id="L429">							Skill skill = allSkills.get(sa.getSkillID());</span>

<span class="nc bnc" id="L431" title="All 2 branches missed.">							if (skillsAssignmentsColumnDisplay.length() &gt; 0) {</span>
<span class="nc" id="L432">								skillsAssignmentsColumnDisplay.append(DELIMITER_COMMA);</span>
							}
<span class="nc" id="L434">							skillsAssignmentsColumnDisplay.append(skill.getName());</span>
<span class="nc" id="L435">						}</span>
<span class="nc" id="L436">						rowData.add(skillsAssignmentsColumnDisplay);</span>
					} else {
<span class="nc" id="L438">						rowData.add(&quot;&amp;nbsp&quot;);</span>
					}

<span class="nc" id="L441">					rows.add(rowData);</span>
				}

<span class="nc" id="L444">			}</span>
<span class="nc" id="L445">		} catch (Exception e) {</span>
<span class="nc" id="L446">			handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L447">		}</span>

<span class="nc" id="L449">	}</span>

	protected void setRowAttributes(DefaultMultiColumnNodeData rowData, SPEmpTemplate spEmpTemplate) {
<span class="nc" id="L452">		String totalProfileName = m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_TOTAL_STAFFING_PROFILES);</span>
<span class="nc" id="L453">		boolean isDeletable = true;</span>

<span class="nc bnc" id="L455" title="All 2 branches missed.">		if (rowData.getColumnData(0) == totalProfileName) {</span>
<span class="nc" id="L456">			isDeletable = false;</span>
		}

<span class="nc" id="L459">		String isDelete = String.valueOf(isDeletable);</span>
<span class="nc" id="L460">		rowData.setNodeAttribute(WorkpaneMultiColPM.IS_DELETEABLE, isDelete);</span>
<span class="nc" id="L461">		rowData.setNodeAttribute(WorkpaneMultiColPM.IS_ADDABLE, isDelete);</span>
<span class="nc" id="L462">	}</span>

	protected NumberWrapper getMaxAgentsUI(String rowID, int agents, boolean isEditable) {
		String sAgents;

<span class="nc bnc" id="L467" title="All 2 branches missed.">		if (isEditable) {</span>
<span class="nc" id="L468">			String fn = MAX_AGENT_FN + rowID;</span>
<span class="nc" id="L469">			m_MaxAgentPC.reset();</span>
<span class="nc" id="L470">			m_MaxAgentPC.setSize(5);</span>
<span class="nc" id="L471">			m_MaxAgentPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="nc" id="L472">			m_MaxAgentPC.setInputValue(String.valueOf(agents));</span>
<span class="nc" id="L473">			m_MaxAgentPC.setLowerLimit(0);</span>
<span class="nc" id="L474">			m_MaxAgentPC.setIsRequired(true);</span>
<span class="nc" id="L475">			m_MaxAgentPC.setInputFN(fn);</span>
<span class="nc" id="L476">			m_MaxAgentPC.initForDisplay();</span>
<span class="nc" id="L477">			sAgents = m_MaxAgentPC.getHtmlDisplay();</span>
<span class="nc" id="L478">		} else {</span>
<span class="nc" id="L479">			sAgents = m_localizer.formatNumber(agents);</span>
		}
<span class="nc" id="L481">		return new NumberWrapper(agents, sAgents);</span>
	}

	protected NumberWrapper getMinAgentsUI(String rowID, int agents, boolean isEditable) {
<span class="nc" id="L485">		String sAgents = EMPTY_STRING;</span>

<span class="nc bnc" id="L487" title="All 2 branches missed.">		if (isEditable) {</span>
<span class="nc" id="L488">			String fn = MIN_AGENT_FN + rowID;</span>
<span class="nc" id="L489">			m_MinAgentPC.reset();</span>
<span class="nc" id="L490">			m_MinAgentPC.setSize(5);</span>
<span class="nc" id="L491">			m_MinAgentPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="nc" id="L492">			m_MinAgentPC.setInputValue(String.valueOf(agents));</span>
<span class="nc" id="L493">			m_MinAgentPC.setLowerLimit(0);</span>
<span class="nc" id="L494">			m_MinAgentPC.setIsRequired(true);</span>
<span class="nc" id="L495">			m_MinAgentPC.setInputFN(fn);</span>
<span class="nc" id="L496">			m_MinAgentPC.initForDisplay();</span>
<span class="nc" id="L497">			sAgents = m_MinAgentPC.getHtmlDisplay();</span>
<span class="nc" id="L498">		} else {</span>
<span class="nc" id="L499">			sAgents = m_localizer.formatNumber(agents);</span>
		}
<span class="nc" id="L501">		return new NumberWrapper(agents, sAgents);</span>
	}

	protected NumberWrapper getMaxAgentRatioUI(String rowID, int agents, boolean isEditable) {
		String sAgents;

<span class="nc bnc" id="L507" title="All 2 branches missed.">		if (isEditable) {</span>
<span class="nc" id="L508">			String fn = MAX_AGENT_RATIO_FN + rowID;</span>
<span class="nc" id="L509">			m_MaxAgentRatioPC.reset();</span>
<span class="nc" id="L510">			m_MaxAgentRatioPC.setSize(5);</span>
<span class="nc" id="L511">			m_MaxAgentRatioPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="nc" id="L512">			m_MaxAgentRatioPC.setInputValue(String.valueOf(agents));</span>
<span class="nc" id="L513">			m_MaxAgentRatioPC.setLowerLimit(0);</span>
<span class="nc" id="L514">			m_MaxAgentRatioPC.setIsRequired(true);</span>
<span class="nc" id="L515">			m_MaxAgentRatioPC.setInputFN(fn);</span>
<span class="nc" id="L516">			m_MaxAgentRatioPC.initForDisplay();</span>
<span class="nc" id="L517">			sAgents = m_MaxAgentRatioPC.getHtmlDisplay() + &quot; %&quot;;</span>
<span class="nc" id="L518">		} else {</span>
<span class="nc" id="L519">			sAgents = m_localizer.formatNumber(agents);</span>
		}
<span class="nc" id="L521">		return new NumberWrapper(agents, sAgents);</span>
	}

	protected NumberWrapper getMinAgentRatioUI(String rowID, int agents, boolean isEditable) {
		String sAgents;

<span class="nc bnc" id="L527" title="All 2 branches missed.">		if (isEditable) {</span>
<span class="nc" id="L528">			String fn = MIN_AGENT_RATIO_FN + rowID;</span>
<span class="nc" id="L529">			m_MinAgentRatioPC.reset();</span>
<span class="nc" id="L530">			m_MinAgentRatioPC.setSize(5);</span>
<span class="nc" id="L531">			m_MinAgentRatioPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="nc" id="L532">			m_MinAgentRatioPC.setInputValue(String.valueOf(agents));</span>
<span class="nc" id="L533">			m_MinAgentRatioPC.setLowerLimit(0);</span>
<span class="nc" id="L534">			m_MinAgentRatioPC.setIsRequired(true);</span>
<span class="nc" id="L535">			m_MinAgentRatioPC.setInputFN(fn);</span>
<span class="nc" id="L536">			m_MinAgentRatioPC.initForDisplay();</span>
<span class="nc" id="L537">			sAgents = m_MinAgentRatioPC.getHtmlDisplay() + &quot; %&quot;;</span>
<span class="nc" id="L538">		} else {</span>
<span class="nc" id="L539">			sAgents = m_localizer.formatNumber(agents);</span>
		}
<span class="nc" id="L541">		return new NumberWrapper(agents, sAgents);</span>
	}

	/**
	 * Retrieve request parameters from request object to the page model object.
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L549">		boolean success = super.extractParameters(request);</span>

<span class="nc" id="L551">		m_minAgentRatioMap = FormInputPC.extractIDKeyParamMap(request, MIN_AGENT_RATIO_FN);</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">		for (Object key : m_minAgentMap.keySet()) {</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">			if (m_minAgentMap.get(key) == null) {</span>
<span class="nc" id="L554">				m_minAgentMap.put(key, 0);</span>
			}
<span class="nc" id="L556">		}</span>

<span class="nc" id="L558">		m_maxAgentRatioMap = FormInputPC.extractIDKeyParamMap(request, MAX_AGENT_RATIO_FN);</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">		for (Object key : m_maxAgentRatioMap.keySet()) {</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">			if (m_maxAgentRatioMap.get(key) == null) {</span>
<span class="nc" id="L561">				m_maxAgentRatioMap.put(key, 100);</span>
			}
<span class="nc" id="L563">		}</span>

<span class="nc" id="L565">		m_minAgentMap = FormInputPC.extractIDKeyParamMap(request, MIN_AGENT_FN);</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">		for (Object key : m_minAgentMap.keySet()) {</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">			if (m_minAgentMap.get(key) == null) {</span>
<span class="nc" id="L568">				m_minAgentMap.put(key, 0);</span>
			}
<span class="nc" id="L570">		}</span>

<span class="nc" id="L572">		m_maxAgentMap = FormInputPC.extractIDKeyParamMap(request, MAX_AGENT_FN);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">		for (Object key : m_maxAgentMap.keySet()) {</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">			if (m_maxAgentMap.get(key) == null) {</span>
<span class="nc" id="L575">				m_maxAgentMap.put(key, 100);</span>
			}
<span class="nc" id="L577">		}</span>

<span class="nc" id="L579">		return success;</span>
	}

	@Override
	protected void autoSortList(List list) {
<span class="nc bnc" id="L584" title="All 2 branches missed.">		if (isListSorted()) {</span>
<span class="nc" id="L585">			return;</span>
		}

<span class="nc" id="L588">		MultiColumnNodeData lastRow = (MultiColumnNodeData) list.get(list.size() - 1);</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">		if (list.size() &gt; 1) {</span>
<span class="nc" id="L590">			list.remove(list.size() - 1);</span>
<span class="nc" id="L591">			int[] sortColumnIndexes = m_headerPC.getSortColumnIndexes();</span>
<span class="nc bnc" id="L592" title="All 6 branches missed.">			if (list != null &amp;&amp; !list.isEmpty() &amp;&amp; sortColumnIndexes != null) {</span>
<span class="nc" id="L593">				boolean isAscending = m_headerPC.isAscending();</span>
<span class="nc" id="L594">				SortUtil.sort(list, sortColumnIndexes, isAscending, m_localizer);</span>
			}
<span class="nc" id="L596">			int index = 0;</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">			for (Iterator it = list.iterator(); it.hasNext(); index++) {</span>
<span class="nc" id="L598">				list.set(index, it.next());</span>
			}
<span class="nc" id="L600">			list.add(lastRow);</span>
		}

		// Indicate List is Sorted
<span class="nc" id="L604">		setIsListSorted(true);</span>
<span class="nc" id="L605">	}</span>

	private Organization getOrg(WorkResourceManager wrMgr, ID id) throws Exception {
<span class="nc" id="L608">		Organization org = m_orgMap.get(id);</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">		if (org == null) {</span>
<span class="nc" id="L610">			org = wrMgr.getOrganizationByID(id);</span>
<span class="nc" id="L611">			m_orgMap.put(id, org);</span>
		}
<span class="nc" id="L613">		return org;</span>
	}

	public boolean hasWeekStartMisAlligned() {
<span class="nc" id="L617">		return m_hasWeekStartMisAlligned;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>