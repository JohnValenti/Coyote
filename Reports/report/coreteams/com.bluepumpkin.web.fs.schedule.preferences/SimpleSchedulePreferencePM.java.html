<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SimpleSchedulePreferencePM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.schedule.preferences</a> &gt; <span class="el_source">SimpleSchedulePreferencePM.java</span></div><h1>SimpleSchedulePreferencePM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.schedule.preferences;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.schedulepref.model.EmployeeOTVTOPref;
import com.bluepumpkin.ejb.bbm.schedulepref.model.SimpleSchedulePreference;
import com.bluepumpkin.web.bbm.people.PeoplePM;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultNodeData;
import com.witness.web.uif.pagecomponent.assignmentbox.AssignmentBoxPC;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;

/**
 * Title:        SimpleSchedulePreferencePM
 * Description:  Schedule preference simple entry.
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       Chris King
 * @version      1.0
 */
public class SimpleSchedulePreferencePM extends SchedulePreferencePM implements PeoplePM{
	public static final String DAYOFF_OR_START_FN = &quot;dayOffOrStartTime&quot;;
	public static final String DAYOFF_PREFS_FN = &quot;dayOffPrefs&quot;;
	// OT and VTO stand for Over-Time before/after shift and Voluntary Time-Off at
	// shift beginning/end
	public static final String OTBEFORE_PREFS_FN = &quot;overTimeBefore&quot;;
	public static final String OTAFTER_PREFS_FN = &quot;overTimeAfter&quot;;
	public static final String VTOATBEGINNING_PREFS_FN = &quot;voluntaryTimeOffBegin&quot;;
	public static final String VTOATEND_PREFS_FN = &quot;voluntaryTimeOffEnd&quot;;
	public static final String OTVTOID_PREFS_FN = &quot;overTimeVTimeOffId&quot;;
	public static final String OTVTO_OPTION_NO_PREFERENCE = &quot;0&quot;;
	public static final String OTVTO_OPTION_PREFER = &quot;1&quot;;
	public static final String OTVTO_OPTION_DO_NOT_PREFER = &quot;2&quot;;
	public static final short OTVTO_OPTION_DEFAULT = 0;

	//page components
	private StartTimePrefPC m_startTimePrefPC;
	private CollapsibleContainerPC m_dayOffContainer;
	private CollapsibleContainerPC m_overTimeVTimeOffPrefPC;
	private AssignmentBoxPC m_assignmentBoxPC;

	//data fields
	private short m_dayOffOrStartTime;
	private short m_overTimeBefore;
	private short m_overTimeAfter;
	private short m_voluntaryTimeOffBegin;
	private short m_voluntaryTimeOffEnd;
	private ID m_overTimeVTimeOffId;
	private EmployeeOTVTOPref m_overTimeVTimeOffPref;
	private boolean m_overTimeVTimeOffEnabled;

	private boolean m_isMultiEdit;
	private Collection&lt;ID&gt; m_colEmpIDs;

	/**
	 * Constructs a Simple Schedule Preference pagemodel.
	 * The content title must be populated at this time because it is rendered
	 * by the page template before the getInstance method is called by the page jsp.
	 */
	public SimpleSchedulePreferencePM(RequestContext context) {
<span class="nc" id="L78">		super(context, SchedulePreferencePM.VIEW_TYPE_SIMPLE);</span>

		//initialize the page components
<span class="nc" id="L81">		m_startTimePrefPC = new StartTimePrefPC(context);</span>
<span class="nc" id="L82">		m_containerList.add(m_startTimePrefPC);</span>

<span class="nc" id="L84">		m_dayOffContainer = new CollapsibleContainerPC(context);</span>
<span class="nc" id="L85">		m_dayOffContainer.setName(&quot;dayOffContainer&quot;);</span>
<span class="nc" id="L86">		m_containerList.add(m_dayOffContainer);</span>

<span class="nc" id="L88">		m_assignmentBoxPC = new AssignmentBoxPC(context);</span>
<span class="nc" id="L89">		m_assignmentBoxPC.setName(DAYOFF_PREFS_FN);</span>
<span class="nc" id="L90">		m_assignmentBoxPC.setWrapperRegion(false);</span>
<span class="nc" id="L91">		addChildComponent(m_assignmentBoxPC);</span>

<span class="nc" id="L93">		m_overTimeVTimeOffEnabled = isAuthorizedToViewOTVTO();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">		if (m_overTimeVTimeOffEnabled) {</span>
<span class="nc" id="L95">			m_overTimeVTimeOffPrefPC = new CollapsibleContainerPC(context);</span>
<span class="nc" id="L96">			m_overTimeVTimeOffPrefPC.setName(&quot;otVtoCollapsiblePC&quot;);</span>
<span class="nc" id="L97">			m_containerList.add(m_overTimeVTimeOffPrefPC);</span>
		} else
<span class="nc" id="L99">			m_overTimeVTimeOffPref = null;</span>

<span class="nc" id="L101">		m_containerList.add(HtmlUtil.makeHiddenSpanWithId(i18n(m_bundle,FsWebBundleKey.ROLE_REGION), &quot;roleRegion&quot;));</span>
<span class="nc" id="L102">		m_containerList.add(HtmlUtil.makeHiddenSpanWithId(i18n(m_bundle,FsWebBundleKey.ROLE_TABLE), &quot;roleTable&quot;));</span>
<span class="nc" id="L103">		addJSVariable(&quot;INVALID_OR_OVERLAP&quot;, m_bundle, FsWebBundleKey.MSG_SP_START_PREF_OVERLAP);</span>

<span class="nc" id="L105">		m_colEmpIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L106">	}//constructor</span>


	/**
	 * Return instance of Model which is ready to be rendered
	 */
	//public static SimpleSchedulePreferencePM getInstance(RequestContext context)
	public static PageModel getInstance(RequestContext context)
	{

<span class="nc" id="L116">		SimpleSchedulePreferencePM model = null;</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (context.getPageModel() instanceof SimpleSchedulePreferencePM) {</span>
<span class="nc" id="L119">			model = (SimpleSchedulePreferencePM)context.getPageModel();</span>
		} else {
<span class="nc" id="L121">			model = new SimpleSchedulePreferencePM(context);</span>
<span class="nc" id="L122">			model.extractParameters(context.getRequest());</span>
<span class="nc" id="L123">			context.setPageModel(model);</span>
		}

		// Initialize Auto Caching of ID enabled through screendefintion.xml &quot;AutoCacheSelectedIDKey&quot;
<span class="nc" id="L127">		model.initSelectedIDCaching();</span>

<span class="nc" id="L129">		model.populateModel(context);</span>
<span class="nc" id="L130">		return model;</span>

		//return getInstance(context, SimpleSchedulePreferencePM.class);

	}//getInstance

	/**
	 * Clear Inner Containers
	 */
	protected void clearInnerContainers() {
<span class="nc" id="L140">		removeChildComponent( m_assignmentBoxPC );</span>
<span class="nc" id="L141">		super.clearInnerContainers();</span>
<span class="nc" id="L142">	}</span>

	/**
	 * Load data from the back end and populate the components
	 */
	protected void loadAndInitData(){
		try {

<span class="nc bnc" id="L150" title="All 2 branches missed.">			if(m_isMultiEdit){</span>
<span class="nc" id="L151">				HashMap theData = SchedulePreferenceMH.getSimplePrefs(m_context, m_employeeId);</span>

				//populate start time preferences container
<span class="nc" id="L154">				m_startTimePrefPC.init(theData);</span>
<span class="nc" id="L155">				m_startTimePrefPC.setCollapsed(true);</span>
<span class="nc" id="L156">				m_startTimePrefPC.setEnabled(false);</span>



				//populate date off preference container
<span class="nc" id="L161">				populateDayOffPrefContainer(theData);</span>
				//populate OT/VTO preference container
<span class="nc bnc" id="L163" title="All 2 branches missed.">				if (m_overTimeVTimeOffPrefPC != null)</span>
<span class="nc" id="L164">					populateOtVtoPrefContainer(theData);</span>
<span class="nc" id="L165">			}</span>
			else{
<span class="nc" id="L167">				HashMap theData = SchedulePreferenceMH.getSimplePrefs(m_context, m_employeeId);</span>

				//populate start time preferences container
<span class="nc" id="L170">				m_startTimePrefPC.init(theData);</span>

				//populate date off preference container
<span class="nc" id="L173">				populateDayOffPrefContainer(theData);</span>
				//populate OT/VTO preference container
<span class="nc bnc" id="L175" title="All 2 branches missed.">				if (m_overTimeVTimeOffPrefPC != null)</span>
<span class="nc" id="L176">					populateOtVtoPrefContainer(theData);</span>
			}
<span class="nc" id="L178">		} catch (Exception ex) {</span>
<span class="nc" id="L179">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L180">		}</span>
<span class="nc" id="L181">	}//loadAndInitData</span>

	private static String makeRadioEntry(String fieldName, short selectedValue, short entryValue,String label){
<span class="nc bnc" id="L184" title="All 2 branches missed.">		boolean isChecked = (selectedValue == entryValue);</span>
<span class="nc" id="L185">		return HtmlChoiceInput.makeRadioInput(fieldName, String.valueOf(entryValue),label,	isChecked,&quot;&quot;);</span>
	}

	/**
	 * populate day off preferences container
	 */
	protected void populateDayOffPrefContainer(HashMap theData){
<span class="nc" id="L192">		m_dayOffContainer.setIsBorderEnabled(true);</span>
<span class="nc" id="L193">		m_dayOffContainer.setTitle(i18n(m_bundle, FsWebBundleKey.SP_DAY_OFF_PREFS));</span>
<span class="nc" id="L194">		SimpleSchedulePreference simpleSchedPref =</span>
<span class="nc" id="L195">				(SimpleSchedulePreference)theData.get(SchedulePreferenceMH.SIMPLE_PREFS_KEY);</span>

		//make template
<span class="nc" id="L198">		m_dayOffContainer.setTemplate(&quot;&lt;table cellpadding=\&quot;10\&quot; cellspacing=\&quot;0\&quot; width=\&quot;100%\&quot;&gt;&lt;tr&gt;&quot;</span>
				+ &quot;&lt;td class=\&quot;schedPrefLeft25\&quot;&gt;{0}&lt;/td&gt;&lt;td class=\&quot;schedPrefText\&quot;&gt;{1}&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);

<span class="nc bnc" id="L201" title="All 2 branches missed.">		Collection dayOffPrefs = (simpleSchedPref!=null)?simpleSchedPref.getDayOffPreference():null;</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">		if(m_isMultiEdit){</span>
<span class="nc" id="L203">			SchedulePreferenceMH mh = new SchedulePreferenceMH();</span>
			try {
<span class="nc bnc" id="L205" title="All 2 branches missed.">				if(mh.isDayOffSame(m_context, m_colEmpIDs)){</span>
					//do nothing
				}
				else{
<span class="nc" id="L209">					dayOffPrefs = null;</span>
				}
<span class="nc" id="L211">			} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L212">				handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L213">			} catch (RemoteException e) {</span>
<span class="nc" id="L214">				handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L215">			} catch (BbmException e) {</span>
<span class="nc" id="L216">				handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L217">			}</span>
<span class="nc" id="L218">			boolean b_dayoffsame = false;</span>

		}

		//add assignment box
<span class="nc" id="L223">		m_dayOffContainer.addComponent(makePreferredDayOffListBox(dayOffPrefs));</span>


		//add radios with DayOff vs. StartTime pref
<span class="nc bnc" id="L227" title="All 2 branches missed.">		short preferDayOff = (simpleSchedPref!=null)?simpleSchedPref.getPreferDayOff():0;</span>
<span class="nc" id="L228">		m_dayOffContainer.addComponent(makeStartTimeOrTimeOffString(preferDayOff));</span>

<span class="nc" id="L230">	}//populateDayOffPrefContainer</span>

	/**
	 * populate Over-time/ Voluntary Time-off preferences container
	 */
	protected void populateOtVtoPrefContainer(HashMap theData){
<span class="nc" id="L236">		m_overTimeVTimeOffPref = new EmployeeOTVTOPref();</span>
<span class="nc" id="L237">		m_overTimeVTimeOffPref = (EmployeeOTVTOPref)theData.get(SchedulePreferenceMH.OTVTO_PREFS_KEY);</span>

<span class="nc" id="L239">		FormTwoColumnPC form2ColPC = new FormTwoColumnPC(m_context);</span>
<span class="nc" id="L240">		m_overTimeVTimeOffPrefPC.setIsBorderEnabled(true);</span>
<span class="nc" id="L241">		m_overTimeVTimeOffPrefPC.setTitle(i18n(m_bundle, FsWebBundleKey.SP_OVERTIME_VOLUNTARYTIMEOFF_TITLE));</span>
<span class="nc" id="L242">		form2ColPC.setShowTitle(false);</span>
<span class="nc" id="L243">		form2ColPC.setUseWrapper(false);</span>
<span class="nc" id="L244">		m_overTimeVTimeOffPrefPC.setTemplate(&quot;{0}&quot;);</span>

<span class="nc" id="L246">		boolean b_OTVOSame = false;</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">		if(m_isMultiEdit){</span>
<span class="nc" id="L248">			SchedulePreferenceMH mh = new SchedulePreferenceMH();</span>
			try {
<span class="nc" id="L250">				b_OTVOSame = mh.isOTVTOOffSame(m_context, m_colEmpIDs);</span>
<span class="nc" id="L251">			} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L252">				handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L253">			} catch (RemoteException e) {</span>
<span class="nc" id="L254">				handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L255">			} catch (BbmException e) {</span>
<span class="nc" id="L256">				handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L257">			}</span>
		}

		// Create dropdown options
<span class="nc" id="L261">		Collection&lt;StringsPair&gt; sp = new ArrayList(3);</span>
<span class="nc" id="L262">		sp.add(new StringsPair(OTVTO_OPTION_NO_PREFERENCE, i18n(m_bundle, FsWebBundleKey.SP_OTVTO_OPTION_NO_PREFERENCE)));</span>
<span class="nc" id="L263">		sp.add(new StringsPair(OTVTO_OPTION_PREFER, i18n(m_bundle, FsWebBundleKey.SP_OTVTO_OPTION_PREFER)));</span>
<span class="nc" id="L264">		sp.add(new StringsPair(OTVTO_OPTION_DO_NOT_PREFER, i18n(m_bundle, FsWebBundleKey.SP_OTVTO_OPTION_DO_NOT_PREFER)));</span>
		// Create Over-time Before dropdown
<span class="nc" id="L266">		int selectedValue = getoverTimeBefore();</span>
<span class="nc" id="L267">		String pref= new Integer(selectedValue).toString();</span>

		//set selection to default for multi edit if values are not same
<span class="nc bnc" id="L270" title="All 4 branches missed.">		if(!b_OTVOSame &amp;&amp; m_isMultiEdit)</span>
<span class="nc" id="L271">			pref=&quot;&quot;;</span>

<span class="nc" id="L273">		String labelDesc= i18n(m_bundle, FsWebBundleKey.SP_OVERTIME_BEFORE);</span>
<span class="nc" id="L274">		form2ColPC.addRow(labelDesc</span>
<span class="nc" id="L275">				,HtmlUtil.makeSelectInput(OTBEFORE_PREFS_FN, pref,sp,labelDesc,&quot;&quot;));</span>
		// Create Over-time After dropdown
<span class="nc" id="L277">		selectedValue = getoverTimeAfter();</span>
<span class="nc" id="L278">		pref= new Integer(selectedValue).toString();</span>
		//set selection to default for multi edit if values are not same
<span class="nc bnc" id="L280" title="All 4 branches missed.">		if(!b_OTVOSame &amp;&amp; m_isMultiEdit)</span>
<span class="nc" id="L281">			pref=&quot;&quot;;</span>
<span class="nc" id="L282">		labelDesc=i18n(m_bundle, FsWebBundleKey.SP_OVERTIME_AFTER);</span>
<span class="nc" id="L283">		form2ColPC.addRow(labelDesc</span>
<span class="nc" id="L284">				, HtmlUtil.makeSelectInput(OTAFTER_PREFS_FN, pref, sp,labelDesc,&quot;&quot;));</span>
		// Create Voluntary Time-off at Beginng dropdown
<span class="nc" id="L286">		selectedValue = getvoluntaryTimeOffBegin();</span>
<span class="nc" id="L287">		pref= new Integer(selectedValue).toString();</span>
		//set selection to default for multi edit if values are not same
<span class="nc bnc" id="L289" title="All 4 branches missed.">		if(!b_OTVOSame &amp;&amp; m_isMultiEdit)</span>
<span class="nc" id="L290">			pref=&quot;&quot;;</span>
<span class="nc" id="L291">		labelDesc=i18n(m_bundle, FsWebBundleKey.SP_VOLUNTARYTIMEOFF_AT_BEGINNING);</span>
<span class="nc" id="L292">		form2ColPC.addRow(labelDesc</span>
<span class="nc" id="L293">				, HtmlUtil.makeSelectInput(VTOATBEGINNING_PREFS_FN, pref,sp,labelDesc,&quot;&quot;));</span>
		// Create Voluntary Time-off at End dropdown
<span class="nc" id="L295">		selectedValue = getvoluntaryTimeOffEnd();</span>
<span class="nc" id="L296">		pref= new Integer(selectedValue).toString();</span>
		//set selection to default for multi edit if values are not same
<span class="nc bnc" id="L298" title="All 4 branches missed.">		if(!b_OTVOSame &amp;&amp; m_isMultiEdit)</span>
<span class="nc" id="L299">			pref=&quot;&quot;;</span>
<span class="nc" id="L300">		labelDesc=i18n(m_bundle, FsWebBundleKey.SP_VOLUNTARYTIMEOFF_AT_END);</span>
<span class="nc" id="L301">		form2ColPC.addRow(labelDesc</span>
<span class="nc" id="L302">				, HtmlUtil.makeSelectInput(VTOATEND_PREFS_FN, pref, sp,labelDesc,&quot;&quot;));</span>

<span class="nc" id="L304">		m_overTimeVTimeOffPrefPC.addComponent(form2ColPC);</span>
<span class="nc" id="L305">		m_context.addGenericHTML(HtmlUtil.makeHiddenInput(OTVTOID_PREFS_FN, getoverTimeVTimeOffId()));</span>

<span class="nc" id="L307">	}</span>

	protected boolean isAuthorizedToViewOTVTO() {
<span class="nc" id="L310">		return m_context.getUser().isAuthorized(PrivilegeKeys.FS_VIEWOTVTOSCHEDULEPREF);</span>
	}
	// Getters/ setters for Over-time/ Voluntary Time-off parameters
	public void setoverTimeBefore(short sVal){
<span class="nc" id="L314">		m_overTimeBefore = sVal;</span>
<span class="nc" id="L315">	}</span>

	public void setoverTimeAfter(short sVal){
<span class="nc" id="L318">		m_overTimeAfter = sVal;</span>
<span class="nc" id="L319">	}</span>

	public void setvoluntaryTimeOffBegin(short sVal){
<span class="nc" id="L322">		m_voluntaryTimeOffBegin = sVal;</span>
<span class="nc" id="L323">	}</span>

	public void setvoluntaryTimeOffEnd(short sVal){
<span class="nc" id="L326">		m_voluntaryTimeOffEnd = sVal;</span>
<span class="nc" id="L327">	}</span>

	public void setoverTimeVTimeOffId(String sVal){
<span class="nc bnc" id="L330" title="All 4 branches missed.">		ID id = ((sVal == null) || sVal.equals(&quot;&quot;)) ? null : new ID (Integer.parseInt( sVal ));</span>
<span class="nc" id="L331">		m_overTimeVTimeOffId = id;</span>
<span class="nc" id="L332">	}</span>

	public int getoverTimeBefore() {
<span class="nc bnc" id="L335" title="All 2 branches missed.">		return  ((m_overTimeVTimeOffPref != null)? m_overTimeVTimeOffPref.getOtBefore():OTVTO_OPTION_DEFAULT);</span>
	}
	public int getoverTimeAfter() {
<span class="nc bnc" id="L338" title="All 2 branches missed.">		return  ((m_overTimeVTimeOffPref != null)? m_overTimeVTimeOffPref.getOtAfter():OTVTO_OPTION_DEFAULT);</span>
	}
	public int getvoluntaryTimeOffBegin() {
<span class="nc bnc" id="L341" title="All 2 branches missed.">		return  ((m_overTimeVTimeOffPref != null)? m_overTimeVTimeOffPref.getVtoAtBeginning():OTVTO_OPTION_DEFAULT);</span>
	}
	public int getvoluntaryTimeOffEnd() {
<span class="nc bnc" id="L344" title="All 2 branches missed.">		return  ((m_overTimeVTimeOffPref != null)? m_overTimeVTimeOffPref.getVtoAtEnd():OTVTO_OPTION_DEFAULT);</span>
	}
	public ID getoverTimeVTimeOffId() {
<span class="nc bnc" id="L347" title="All 2 branches missed.">		return  ((m_overTimeVTimeOffPref != null)? m_overTimeVTimeOffPref.getID():null);</span>
	}

	private void setOTVTOSchedulePref() {
<span class="nc bnc" id="L351" title="All 2 branches missed.">		if (m_overTimeVTimeOffPref != null) {</span>
<span class="nc" id="L352">			m_overTimeVTimeOffPref.setEmployeeId(m_employeeId);</span>
<span class="nc" id="L353">			m_overTimeVTimeOffPref.setOtBefore(m_overTimeBefore);</span>
<span class="nc" id="L354">			m_overTimeVTimeOffPref.setOtAfter(m_overTimeAfter);</span>
<span class="nc" id="L355">			m_overTimeVTimeOffPref.setVtoAtBeginning(m_voluntaryTimeOffBegin);</span>
<span class="nc" id="L356">			m_overTimeVTimeOffPref.setVtoAtEnd(m_voluntaryTimeOffEnd);</span>
<span class="nc" id="L357">			m_overTimeVTimeOffPref.setID(m_overTimeVTimeOffId);</span>
		}
<span class="nc" id="L359">	}</span>

	/** make preferred day off listbox */
	protected String makePreferredDayOffListBox(Collection dayOffPrefs) {
		//prepare container
<span class="nc" id="L364">		m_assignmentBoxPC.setHeaderTitle(i18n(m_bundle, FsWebBundleKey.SP_DAY_OFF_PREFS_DESC));</span>
<span class="nc" id="L365">		m_assignmentBoxPC.setLeftTitle(i18n(m_bundle, FsWebBundleKey.SP_DAY_OFF_PREFS_WEEK_DAY) + &quot; %s &quot;</span>
<span class="nc" id="L366">				+ HtmlUtil.makeHiddenReadableText(i18n(m_bundle, FsWebBundleKey.SP_DAY_OFF_PREFS_DESC)));</span>
<span class="nc" id="L367">		m_assignmentBoxPC.setRightTitle(i18n(m_bundle, FsWebBundleKey.SP_PREFERENCE));</span>
<span class="nc" id="L368">		m_assignmentBoxPC.setItemCount(8);</span>
<span class="nc" id="L369">		m_assignmentBoxPC.setMultiRowSelectable(true);</span>
<span class="nc" id="L370">		m_assignmentBoxPC.setShowMoveButtons(true);</span>
		//prepare data
<span class="nc" id="L372">		List lData = createLeftList(dayOffPrefs);</span>
<span class="nc" id="L373">		m_assignmentBoxPC.getLeftListPC().setData(lData);</span>
<span class="nc" id="L374">		List rData = createRightList(dayOffPrefs);</span>
<span class="nc" id="L375">		m_assignmentBoxPC.getRightListPC().setData(rData);</span>

<span class="nc" id="L377">		return m_assignmentBoxPC.getHtmlDisplay();</span>
	}//makePreferredDayOffListBox

	/** make list of unselected for Day Off preferences days of the week */
	protected List createLeftList(Collection dayOffPrefs) {
<span class="nc" id="L382">		ArrayList leftList = new ArrayList();</span>
<span class="nc bnc" id="L383" title="All 4 branches missed.">		if (dayOffPrefs == null || dayOffPrefs.size() &lt; 7) {</span>
<span class="nc" id="L384">			boolean[] isDaySelected = {false,false,false,false,false,false,false,false};</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">			if (dayOffPrefs != null) {</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">				for( Iterator it = dayOffPrefs.iterator(); it.hasNext();) {</span>
					//int code of the day 1-Sunday 7-Saturday
<span class="nc" id="L388">					Integer intVal = (Integer) it.next();</span>
<span class="nc" id="L389">					isDaySelected[intVal.intValue()] = true;</span>
<span class="nc" id="L390">				}</span>
			}
			//make list from non-selected
<span class="nc" id="L393">			String[] weekdayNames = m_localizer.getWeekdayNames(true);</span>
<span class="nc" id="L394">			int[] weekdayValues = m_localizer.getWeekdayValues();</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">			for(int i=0; i&lt;weekdayValues.length; i++) {</span>
<span class="nc" id="L396">				int iDay = weekdayValues[i];</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">				if (!isDaySelected[iDay]) {</span>
<span class="nc" id="L398">					String name = Integer.toString(iDay);</span>
<span class="nc" id="L399">					String display = weekdayNames[iDay];</span>
<span class="nc" id="L400">					DefaultNodeData data = new DefaultNodeData(name, display, display);</span>
<span class="nc" id="L401">					leftList.add(data);</span>
				}
			}
		}
<span class="nc" id="L405">		return leftList;</span>
	}//createLeftList

	/** make right of selected for Day Off preferences days of the week */
	protected List createRightList(Collection dayOffPrefs) {
<span class="nc" id="L410">		ArrayList rightList = new ArrayList();</span>
<span class="nc bnc" id="L411" title="All 4 branches missed.">		if (dayOffPrefs != null &amp;&amp; dayOffPrefs.size() &gt; 0) {</span>
<span class="nc" id="L412">			String[] weekdayNames = m_localizer.getWeekdayNames(true);</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">			for( Iterator it = dayOffPrefs.iterator(); it.hasNext();) {</span>
				//int code of the day 1-Sunday 7-Saturday
<span class="nc" id="L415">				Integer intVal = (Integer) it.next();</span>

				//weekday display string
<span class="nc" id="L418">				String name = intVal.toString();</span>
<span class="nc" id="L419">				String display = weekdayNames[intVal.intValue()];</span>
<span class="nc" id="L420">				DefaultNodeData data = new DefaultNodeData(name, display, display);</span>
<span class="nc" id="L421">				rightList.add(data);</span>
<span class="nc" id="L422">			}</span>
		}
<span class="nc" id="L424">		return rightList;</span>
	}//createRightList

	/** make */
	protected String makeStartTimeOrTimeOffString(short preferDayOff){
<span class="nc" id="L429">		StringBuffer sb = new StringBuffer(1000);</span>
<span class="nc" id="L430">		sb.append(&quot;&lt;div id=\&quot;StartTimeOrTimeOff\&quot; aria-labelledby=\&quot;StartTimeOrTimeOffDesc\&quot; class=\&quot;tabbable subregion\&quot; tabindex=\&quot;0\&quot;&gt;&quot;);</span>
<span class="nc" id="L431">		sb.append(&quot;&lt;table cellpadding=\&quot;0\&quot; cellspacing=\&quot;5\&quot; class=\&quot;schedPrefText\&quot; style=\&quot;margin:7px;\&quot;&gt;&lt;tr&gt;&quot;)</span>
<span class="nc" id="L432">				.append(&quot;&lt;td colspan=\&quot;2\&quot; style=\&quot;padding:8px;\&quot;&gt;&quot;)</span>
<span class="nc" id="L433">				.append(&quot;&lt;span id=\&quot;StartTimeOrTimeOffDesc\&quot;&gt;&quot;)</span>
<span class="nc" id="L434">				.append(i18n(m_bundle, FsWebBundleKey.SP_START_TIME_OR_DAY_OFF_Q))</span>
<span class="nc" id="L435">				.append(HtmlUtil.makeHiddenReadableText(i18n(m_common_bundle, UIFWebBundleKey.RADIO_GROUP)))</span>
<span class="nc" id="L436">				.append(&quot;&lt;/span&gt;&quot;)</span>
<span class="nc" id="L437">				.append(&quot;&lt;br&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=\&quot;padding-left:8px;\&quot;&gt;&quot;)</span>
<span class="nc" id="L438">				.append(makeRadioEntry(DAYOFF_OR_START_FN,preferDayOff,</span>
						SimpleSchedulePreference.PREFER_DAYOFF_OVER_STARTTIME,
<span class="nc" id="L440">						i18n(m_bundle, FsWebBundleKey.SP_START_TIME_OR_DAY_OFF_DO)))</span>
<span class="nc" id="L441">				.append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=\&quot;padding-left:8px;\&quot;&gt;&quot;)</span>
<span class="nc" id="L442">				.append(makeRadioEntry(DAYOFF_OR_START_FN,preferDayOff,</span>
						SimpleSchedulePreference.PREFER_STARTTIME_OVER_DAYOFF,
<span class="nc" id="L444">						i18n(m_bundle, FsWebBundleKey.SP_START_TIME_OR_DAY_OFF_ST)))</span>
<span class="nc" id="L445">				.append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=\&quot;padding-left:8px;\&quot;&gt;&quot;)</span>
<span class="nc" id="L446">				.append(makeRadioEntry(DAYOFF_OR_START_FN,preferDayOff,</span>
						SimpleSchedulePreference.PREFER_DAYOFF_EQUAL_STARTTIME,
<span class="nc" id="L448">						i18n(m_bundle, FsWebBundleKey.SP_START_TIME_OR_DAY_OFF_EQ)))</span>
<span class="nc" id="L449">				.append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;)</span>
<span class="nc" id="L450">				.append(&quot;&lt;/div&quot;);</span>
<span class="nc" id="L451">		return sb.toString();</span>
	}//makeStartTimeOrTimeOffString

	public void setDayOffOrStartTime(short sVal){
<span class="nc" id="L455">		m_dayOffOrStartTime = sVal;</span>
<span class="nc" id="L456">	}</span>

	//====== processing the data =========================
	public void save() {
<span class="nc" id="L460">		SimpleSchedulePreference simpleSchedPref = new SimpleSchedulePreference();</span>
		//IDs
<span class="nc" id="L462">		m_employeeId = getEmployeeID();</span>
		//simpleSchedPref.setID(m_prefsID);
<span class="nc" id="L464">		simpleSchedPref.setEmployeeID(m_employeeId);</span>
<span class="nc bnc" id="L465" title="All 4 branches missed.">		if ((m_overTimeVTimeOffPref == null)  &amp;&amp; (m_overTimeVTimeOffEnabled))</span>
<span class="nc" id="L466">			m_overTimeVTimeOffPref = new EmployeeOTVTOPref();</span>

		//effective period
		/*
		simpleSchedPref.setStartTimeLocal(m_effectiveRange.getStartLocalDate(null));
		LocalDate ld = new LocalDate(new Date(TimeRange.FAR_FUTURE));
		if (ld.equals(m_effectiveRange.getEndLocalDate(null)))
				simpleSchedPref.setEndTimeLocal(null);
		else
				simpleSchedPref.setEndTimeLocal(m_effectiveRange.getEndLocalDate(null));
		//move asOfDate to the effective period start -&gt; refreshed page will show it
		m_asOfDate.setTime(m_effectiveRange.getStartDate());
		 */

<span class="nc" id="L480">		simpleSchedPref.setPreferDayOff(m_dayOffOrStartTime);</span>
		//overtime prefs
		//simpleSchedPref.setPreferOvertime(super.m_overTime);

		//start time prefs
<span class="nc" id="L485">		m_startTimePrefPC.transferStartTimePrefs(simpleSchedPref);</span>

		//day off prefs
<span class="nc" id="L488">		setDayOffPrefs(simpleSchedPref);</span>

<span class="nc" id="L490">		setOTVTOSchedulePref();</span>
		//log preference to the trace
<span class="nc bnc" id="L492" title="All 2 branches missed.">		if (log.isDebugEnabled()) {</span>
<span class="nc" id="L493">			logSimpleSchedPrefs(simpleSchedPref);</span>
		}

		try {
<span class="nc bnc" id="L497" title="All 2 branches missed.">			if(m_isMultiEdit){</span>
<span class="nc" id="L498">				SchedulePreferenceMH.saveSimplePrefsForMultipleEmps(m_context, m_colEmpIDs, simpleSchedPref, m_overTimeVTimeOffPref);</span>
			} else {
<span class="nc" id="L500">				SchedulePreferenceMH.saveSimplePrefs(m_context, simpleSchedPref, m_overTimeVTimeOffPref);</span>
			}
<span class="nc" id="L502">			addPageMessage(Message.RESPONSE_TYPE, FsWebBundleKey.FS_SAVE_SUCCESS, FsWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L503">		} catch (Exception ex) {</span>
<span class="nc" id="L504">			handleUnableToUpdateInfo(log, ex);</span>
<span class="nc" id="L505">		}</span>
<span class="nc" id="L506">	}</span>

	/** dump the simple preferences object into the log file */
	public void logSimpleSchedPrefs(SimpleSchedulePreference pref) {
<span class="nc" id="L510">		StringBuffer sb = new StringBuffer(1000);</span>
<span class="nc" id="L511">		sb.append(&quot;\r\n ======== start Simple Schedule Preference dump ====== \r\n&quot;);</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">		if (pref == null) {</span>
<span class="nc" id="L513">			sb.append(&quot;NULL simple preference obj \r\n&quot;);</span>
		} else {
			//sb.append(&quot;Pref ID: &quot;+ pref.getID() +&quot; \r\n&quot;);
<span class="nc" id="L516">			sb.append(&quot;Employee ID: &quot;+ pref.getEmployeeID() +&quot; \r\n&quot;);</span>

			//sb.append(&quot;from time: &quot;+ pref.getStartTimeLocal().getTime() +&quot; \r\n&quot;);
			//if (pref.getEndTimeLocal() !=null)
			//    sb.append(&quot;to time: &quot;+ pref.getEndTimeLocal().getTime() +&quot; \r\n&quot;);
			//else
			//    sb.append(&quot;to time: NULL \r\n&quot;);

<span class="nc" id="L524">			sb.append(&quot;early/late: &quot;+ pref.getPreferredStart() +&quot; \r\n&quot;);</span>
<span class="nc" id="L525">			sb.append(&quot;day off/start time: &quot;+ pref.getPreferDayOff() +&quot; \r\n&quot;);</span>
<span class="nc" id="L526">			Collection dayOffPrefs = pref.getDayOffPreference();</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">			if (dayOffPrefs != null) {</span>
<span class="nc" id="L528">				sb.append(&quot;day off prefs size: &quot;+ dayOffPrefs.size() +&quot; \r\n&quot;);</span>
			} else {
<span class="nc" id="L530">				sb.append(&quot;day off prefs is NULL \r\n&quot;);</span>
			}
<span class="nc" id="L532">			sb.append(&quot;start time prefs: &quot;);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">			for (int iDay = 1; iDay &lt; 8; iDay ++) {</span>
<span class="nc" id="L534">				sb.append(&quot; \r\n&quot;);</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">				for (int iPref = 0; iPref &lt;3; iPref ++) {</span>
<span class="nc" id="L536">					sb.append(&quot; &quot;).append(pref.getStartTimePreferenceStart(iDay,iPref))</span>
<span class="nc" id="L537">							.append(&quot;-&quot;).append(pref.getStartTimePreferenceEnd(iDay,iPref))</span>
<span class="nc" id="L538">							.append(&quot;, &quot;);</span>
				}
			}
<span class="nc bnc" id="L541" title="All 2 branches missed.">			if (m_overTimeVTimeOffPref != null) {</span>
<span class="nc" id="L542">				sb.append(&quot; \r\nOT Before: &quot; + m_overTimeVTimeOffPref.getOtBefore() + &quot; Ot After: &quot; + m_overTimeVTimeOffPref.getOtAfter() +</span>
<span class="nc" id="L543">					&quot; VTO Beginning &quot; + m_overTimeVTimeOffPref.getVtoAtBeginning() + &quot; VTO End: &quot; + m_overTimeVTimeOffPref.getVtoAtEnd());</span>
			}
		}
<span class="nc" id="L546">		sb.append(&quot;\r\n ======== end Simple Schedule Preference dump ====== \r\n&quot;);</span>
<span class="nc" id="L547">		log.debug(sb.toString());</span>
<span class="nc" id="L548">	}</span>

	/** populate simple prefs obj with extracted day off prefs data */
	public void setDayOffPrefs(SimpleSchedulePreference simpleSchedPref){
<span class="nc" id="L552">		String [] IDs = m_assignmentBoxPC.getRightListPC().getExtractedListIDsAsStringArray();</span>
<span class="nc" id="L553">		ArrayList dayOffPrefs = new ArrayList();</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">		for (int i = 0; i &lt; IDs.length; i++){</span>
			try {
<span class="nc" id="L556">				Integer dayOffPref = Integer.valueOf(IDs[i]);;</span>
<span class="nc" id="L557">				dayOffPrefs.add(dayOffPref);</span>
<span class="nc" id="L558">			} catch (NumberFormatException ex) {</span>
				//ignore
<span class="nc" id="L560">			}</span>
		}
<span class="nc" id="L562">		simpleSchedPref.setDayOffPreference(dayOffPrefs);</span>
<span class="nc" id="L563">	}//setDayOffPrefs</span>


	@Override
	public boolean isCommonMsgEnabled() {
<span class="nc" id="L568">		return true;</span>
	}


	@Override
	public boolean isCreateMode() {
<span class="nc" id="L574">		return false;</span>
	}


	@Override
	public boolean isMultiEdit() {
<span class="nc" id="L580">		return false;</span>
	}


	@Override
	public boolean isPeopleSelectable() {
<span class="nc" id="L586">		return false;</span>
	}

	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc bnc" id="L593" title="All 2 branches missed.">		 if (m_isMy) {</span>
<span class="nc" id="L594">	            return FORM_ACTION_MY_SIMPLE;</span>
	        } else {
<span class="nc" id="L596">	            return &quot;people_schedpredorgmode&quot;;</span>
	        }
	}

	public void setSelectedID(String ids) {
<span class="nc" id="L601">		super.setSelectedID(ids);</span>

		// we must do this when coming to the profile page because the employeeid isn't set
		// from the people summary list.  we assume the first listed employee (if any) is the
		// first employee to view.
<span class="nc" id="L606">		int idSize = getSelectedIDSize();</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">		if (idSize &gt; 0) {</span>
<span class="nc" id="L608">			setEmployeeID(getSelectedIDs()[0]);</span>
		}
<span class="nc bnc" id="L610" title="All 2 branches missed.">		if (idSize &gt; 1) {</span>
<span class="nc" id="L611">			m_isMultiEdit = true;</span>
<span class="nc" id="L612">			setIsMultiObjEditEnabled(true);</span>
<span class="nc" id="L613">			ID[] selectedIDs = getSelectedIDs();</span>
<span class="nc" id="L614">			m_colEmpIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">			for (int i = 0; i &lt; selectedIDs.length; i++) {</span>
<span class="nc" id="L616">				m_colEmpIDs.add(selectedIDs[i]);</span>
			}
		}
<span class="nc" id="L619">	}</span>

	/** set Employee ID for this profile*/
	protected void setEmployeeID(ID value) {
<span class="nc" id="L623">		m_employeeId = value;</span>
<span class="nc" id="L624">	}</span>
	
	@Override
	public String getCustomJavaScript() {
<span class="nc" id="L628">		StringBuilder js = new StringBuilder(super.getCustomJavaScript());</span>
<span class="nc" id="L629">		js.append(getJSChangeWorkspaceAriaLabel(m_localizer.i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.WORK_PANE_DESCRIPTION, m_contentTitlePC.getPageTitle(), &quot;&quot;)));</span>
<span class="nc" id="L630">		return js.toString();</span>
	}

}//class
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>