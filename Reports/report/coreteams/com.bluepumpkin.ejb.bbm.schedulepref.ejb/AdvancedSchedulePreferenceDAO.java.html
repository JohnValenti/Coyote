<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AdvancedSchedulePreferenceDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.schedulepref.ejb</a> &gt; <span class="el_source">AdvancedSchedulePreferenceDAO.java</span></div><h1>AdvancedSchedulePreferenceDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.schedulepref.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  dao object to serialize advanced schedule preference
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       lixin zhang
 * @version      1.0
 */

import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.dao.DAOEffectivityNode;
import com.bluepumpkin.ejb.bbm.schedulepref.model.AdvancedSchedulePreference;
import com.bluepumpkin.ejb.bbm.schedulepref.model.AdvancedSchedulePreferenceFieldInfo;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.core.base.MultiUserException;

public class AdvancedSchedulePreferenceDAO extends DAOEffectivityNode {

<span class="nc" id="L36">    private static FieldInfo m_fieldInfo = new AdvancedSchedulePreferenceFieldInfo();</span>
<span class="nc" id="L37">    protected FieldInfo getFieldInfo() { return m_fieldInfo; }</span>

    public AdvancedSchedulePreferenceDAO() {
<span class="nc" id="L40">         super();</span>
<span class="nc" id="L41">    }</span>

    public AdvancedSchedulePreferenceDAO(Jdmo dmo) {
<span class="nc" id="L44">         super(dmo);</span>
<span class="nc" id="L45">    }</span>

    protected ValueObjectBase createValueObject()
    {
<span class="nc" id="L49">        return (new AdvancedSchedulePreference());</span>
    } 
    
    /** create a child DAO object given the type */
    protected DAOBase createChildDAO(int iType)
    {
<span class="nc" id="L55">        return (new AdvancedStartTimePreferenceDAO(m_dmo));</span>
    }
    
    public ValueObjectBase getObjectByID(ID id) throws BbmObjectNotFoundException, BbmFinderException
    {
<span class="nc" id="L60">        AdvancedSchedulePreference item = (AdvancedSchedulePreference) super.getObjectByID(id);</span>
<span class="nc" id="L61">        item.processPreferenceDataAfterLoad();</span>
        
<span class="nc" id="L63">        return item;</span>
    }
    
    public Collection getObjects(String strWhere) throws BbmFinderException
    {
<span class="nc" id="L68">        Collection col = super.getObjects(strWhere);   </span>
        
        // post process       
<span class="nc" id="L71">        Iterator it = col.iterator();</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        while (it.hasNext())</span>
<span class="nc" id="L73">           ((AdvancedSchedulePreference) it.next()).processPreferenceDataAfterLoad();</span>
        
<span class="nc" id="L75">        return col;   </span>
    }
    
    public void updateObject(ValueObjectBase objValue) throws MultiUserException, BbmUpdateException
    {
<span class="nc" id="L80">        ((AdvancedSchedulePreference) objValue).processPreferenceDataBeforeUpdate();</span>
<span class="nc" id="L81">        super.updateObject(objValue);</span>
<span class="nc" id="L82">    }</span>
    
    public ID createObject(ValueObjectBase objValue) throws BbmCreateException
    {
<span class="nc" id="L86">        ((AdvancedSchedulePreference) objValue).processPreferenceDataBeforeUpdate();</span>
<span class="nc" id="L87">        return super.createObject(objValue);</span>
    }
    
    /**
     *   get a given employee's advanced schedule preference assignments
     *   
     *   @idEmployee employee id
     *   @dtStart, @dtEnd: the time period, null date means a open period
     *   
     *   @return a collection of AdvancedSchedulePreference objects which hold the assignment information
     */
    public Collection getAdvancedSchedulePreferences(ID idEmployee, Date dtStart, Date dtEnd) throws BbmFinderException
    {
<span class="nc" id="L100">         return super.getEffectivityAssignments(idEmployee, </span>
            AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_EMPLOYEEID, 
            dtStart, dtEnd,
            &quot;A.ISADVANCEDPREFERENCE = 1&quot;);     
    }
    
    /**
     *   get advanced schedule preference assignments for a list of employees
     *   
     *   @colEmployeeIDs a collection of employee ids
     *   @dtStart, @dtEnd: the time period, null date means a open period
     *   
     *   @return a HashMap of pair (idEmployee, a collection of AdvancedSchedulePreference objects)
     */
    public HashMap getAdvancedSchedulePreferences(Collection colEmployeeIDs, Date dtStart, Date dtEnd) 
         throws BbmFinderException	
    {
<span class="nc" id="L117">         return super.getEffectivityAssignments(colEmployeeIDs, </span>
            AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_EMPLOYEEID, 
            dtStart, dtEnd,
            &quot;A.ISADVANCEDPREFERENCE = 1&quot;);     
    }
    
    private void setPreferenceOverridden(AdvancedSchedulePreference objValue) throws Exception
    {        
<span class="nc" id="L125">        Date dtStart = objValue.getStartTime();</span>
<span class="nc" id="L126">        Date dtEnd = objValue.getEndTime();</span>

<span class="nc" id="L128">        String strStart = &quot;'&quot; + JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtStart)) + &quot;'&quot;;</span>
             
<span class="nc" id="L130">        StringBuffer strSQL = new StringBuffer(30);</span>
<span class="nc" id="L131">        strSQL.append(&quot;update SCHEDULEPREFERENCE set ISOVERRIDDEN = 1 &quot;);</span>
<span class="nc" id="L132">        strSQL.append(&quot; where ISADVANCEDPREFERENCE = 0 &quot;);</span>
<span class="nc" id="L133">        strSQL.append(&quot; and (ENDTIME IS NULL OR ENDTIME &gt; &quot; + strStart + &quot;)&quot;);           </span>
    
<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (dtEnd != null) {</span>
<span class="nc" id="L136">            String strEnd = &quot;'&quot; + JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtEnd)) + &quot;'&quot;;</span>
<span class="nc" id="L137">            strSQL.append(&quot; AND STARTTIME &lt;= &quot; + strEnd);</span>
        }
        
<span class="nc" id="L140">        m_dmo.executeCommand(strSQL.toString());        </span>
<span class="nc" id="L141">    }</span>
          
    /** 
     *  create an advanced schedule preference object
     *  @param  bSetOverridden if true set overlapping simple preference as overridden
     */ 
    public ID createAdvancedSchedulePreference(AdvancedSchedulePreference objValue, boolean bSetOverridden) throws BbmCreateException
    {
<span class="nc" id="L149">          ID id = super.createNoOverlapAssignment(objValue, </span>
              AdvancedSchedulePreferenceFieldInfo.ADVANCEDSCHEDPREF_EMPLOYEEID, 
              -1, &quot;ISADVANCEDPREFERENCE = 1&quot;); 
           
<span class="nc bnc" id="L153" title="All 2 branches missed.">          if (!bSetOverridden) return id;</span>
          
          try
          {
<span class="nc" id="L157">             setPreferenceOverridden(objValue);            </span>
          }
<span class="nc" id="L159">          catch(Exception e) {</span>
<span class="nc" id="L160">             throw new BbmCreateException(e);</span>
<span class="nc" id="L161">          }</span>
          
<span class="nc" id="L163">          return id;    </span>
    } 
   
    /** save an advanced schedule preference object */
    public void updateAdvancedSchedulePreference(AdvancedSchedulePreference objValue) throws MultiUserException, BbmUpdateException
    {
        try
        {
            // check if start or end time has been changed
<span class="nc" id="L172">            AdvancedSchedulePreference item = (AdvancedSchedulePreference) getObjectByID(objValue.getID());</span>
            
<span class="nc" id="L174">            Date dtStartNew = objValue.getStartTime();</span>
<span class="nc" id="L175">            Date dtEndNew = objValue.getEndTime();</span>
            
<span class="nc" id="L177">            Date dtStartOld = item.getStartTime();</span>
<span class="nc" id="L178">            Date dtEndOld = item.getEndTime();</span>
            
<span class="nc bnc" id="L180" title="All 10 branches missed.">            if (dtStartNew.equals(dtStartOld) &amp;&amp; </span>
                  ((dtEndNew == null &amp;&amp; dtEndOld == null) || 
<span class="nc bnc" id="L182" title="All 2 branches missed.">                    (dtEndNew != null &amp;&amp; dtEndOld != null &amp;&amp; dtEndNew.equals(dtEndOld))))</span>
            {          
<span class="nc" id="L184">                updateObject(objValue);  // no time period change, update the object                        </span>
            }
            else
            {
                // there are changes of the time range, do a create
<span class="nc" id="L189">                objValue.setID(null);</span>
<span class="nc" id="L190">                createAdvancedSchedulePreference(objValue, true);</span>
            }
            
        }
<span class="nc" id="L194">        catch(BbmUpdateException e)</span>
        {
<span class="nc" id="L196">			throw e;</span>
        }
<span class="nc" id="L198">        catch(Exception e)</span>
        {
<span class="nc" id="L200">            throw new BbmUpdateException(e);</span>
<span class="nc" id="L201">        }</span>
<span class="nc" id="L202">    }</span>
   
    /** delete advanced schedule preferences given their ids */
    public void deleteAdvancedSchedulePreferences(Collection colIDs) throws BbmRemoveException
    {
<span class="nc" id="L207">         deleteObjects(colIDs);</span>
<span class="nc" id="L208">    }	</span>
    
    /**
     *   get a AdvancedSchedulePreference by ID
     */
    public AdvancedSchedulePreference getAdvancedSchedulePreferenceByID(ID id)
         throws BbmFinderException
    {
<span class="nc" id="L216">        return (AdvancedSchedulePreference) this.getObjectByID(id);</span>
    }
    
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>