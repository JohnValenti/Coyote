<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ServiceGoalsTraceUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.timeseries.util</a> &gt; <span class="el_source">ServiceGoalsTraceUtil.java</span></div><h1>ServiceGoalsTraceUtil.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.timeseries.util;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.timeseries.ejb.TimeSeriesManager;
import com.bluepumpkin.ejb.bbm.timeseries.model.ClientServiceGoalTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ServiceGoalTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.workload.model.MediaType;
import com.verint.ejb.wfm.WfmManagerFactory;

/**
 * This is a utility class for Service goals-specific trace operations.
 */
public class ServiceGoalsTraceUtil {

<span class="nc" id="L26">	private ServiceGoalsTraceUtil() {}</span>

	/**
	 * Returns a Service Goals trace cube for the given arguments.  Generally, if this is for a combined queue you would
	 * hand in a null queue ID while including a media ID.  For non-combined queues you need to hand in the queue ID but not
	 * the media ID.
	 * NOTE: The ServiceGoalsTraceCube that is returned will either contain PCA data or ASA data, but not both.  It will
	 * include the data for the service goal type that has been selected for the particular queue.
	 */
	public static ClientServiceGoalTraceCube getServiceGoalsTraceCube(ID campaignId, ID queueId, ID mediaId, Date start, Date end,
			boolean inWhatIf) throws BbmFinderException, RemoteException, BbmEJBCreateException, BbmTimeSeriesException {
<span class="fc" id="L37">		return getServiceGoalsTraceCube(campaignId, queueId, mediaId, start, end, WfmManagerFactory.getTimeSeriesManager(inWhatIf));</span>
	}

	public static ClientServiceGoalTraceCube getServiceGoalsTraceCube(ID campaignId, ID queueId, ID mediaId, Date start, Date end,
			TimeSeriesManager timeSeriesManager) throws BbmFinderException, RemoteException, BbmTimeSeriesException {
<span class="fc" id="L42">		short[] serviceGoalsTraceTypes = getApplicableServiceGoalTraceTypes(MediaType.get(mediaId));</span>
<span class="fc" id="L43">		short[] forecastTraceTypes = ForecastTraceUtil.getApplicableForecastTraceTypesForAggregation(MediaType.get(mediaId));</span>
<span class="fc" id="L44">		ServiceGoalTraceCube metaServiceGoals = new ServiceGoalTraceCube(serviceGoalsTraceTypes);</span>
<span class="fc" id="L45">		ForecastTraceCube metaForecast = new ForecastTraceCube(forecastTraceTypes);</span>
<span class="fc" id="L46">		ClientServiceGoalTraceCube result = null;</span>

<span class="fc" id="L48">		Collection&lt;ID&gt; queueIds = new ArrayList&lt;ID&gt;();</span>
<span class="fc bfc" id="L49" title="All 2 branches covered.">		if (queueId != null) queueIds.add(queueId);</span>

		Collection&lt;TraceCube&gt; serviceGoalsTimeSeries;
		Collection&lt;TraceCube&gt; forecastTimeSeries;

<span class="fc bfc" id="L54" title="All 2 branches covered.">		if (queueIds.size() &gt; 0) {</span>
<span class="fc" id="L55">			serviceGoalsTimeSeries = timeSeriesManager.getRawMultipleQueuesTimeSeries(metaServiceGoals, campaignId,</span>
				queueIds, start, end, true);
<span class="fc" id="L57">			forecastTimeSeries = timeSeriesManager.getRawMultipleQueuesTimeSeries(metaForecast, campaignId,</span>
				queueIds, start, end, true);
		} else {
<span class="fc" id="L60">			serviceGoalsTimeSeries = timeSeriesManager.getRawCombinedQueuesTimeSeries(metaServiceGoals, campaignId,</span>
				mediaId, start, end, true);
<span class="fc" id="L62">			forecastTimeSeries = timeSeriesManager.getRawCombinedQueuesTimeSeries(metaForecast, campaignId,</span>
				mediaId, start, end, true);
		}
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">		if (forecastTimeSeries == null) forecastTimeSeries = new ArrayList&lt;TraceCube&gt;();</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">		if (serviceGoalsTimeSeries == null) serviceGoalsTimeSeries = new ArrayList&lt;TraceCube&gt;();</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">		if (forecastTimeSeries.size() == 0) {</span>
			// When we don't have forecast, we need as many 0 forecasts as the number of service goals series.
<span class="nc bnc" id="L69" title="All 2 branches missed.">			for (int i = 0; i &lt;= serviceGoalsTimeSeries.size() - 1; i++) {</span>
<span class="nc" id="L70">				forecastTimeSeries.add(ForecastTraceUtil.createZeroForecastTraceCube(queueId, start, end, forecastTraceTypes));</span>
			}
		}

<span class="pc bpc" id="L74" title="1 of 2 branches missed.">		if (serviceGoalsTimeSeries.size() == 0) {</span>
<span class="nc" id="L75">			return new ClientServiceGoalTraceCube(ForecastTraceUtil.createZeroForecastTraceCube(queueId, start, end, forecastTraceTypes),</span>
<span class="nc" id="L76">				createZeroServiceGoalsTraceCube(queueId, start, end, serviceGoalsTraceTypes), MediaType.get(mediaId));</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">		} else if (serviceGoalsTimeSeries.size() &gt; 1) {</span>
<span class="nc" id="L78">			ClientServiceGoalTraceCube[] clientServiceGoalsCubesArray = new ClientServiceGoalTraceCube[serviceGoalsTimeSeries.size()];</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">			if (forecastTimeSeries.size() &lt; serviceGoalsTimeSeries.size()) {</span>
<span class="nc" id="L80">				int diff = serviceGoalsTimeSeries.size() - forecastTimeSeries.size();</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">				for (int i = 1; i&lt;= diff; i++) {</span>
<span class="nc" id="L82">					forecastTimeSeries.add(ForecastTraceUtil.createZeroForecastTraceCube(queueId, start, end, forecastTraceTypes));</span>
				}
			}
<span class="nc" id="L85">			TraceCube[] forecastTraceCubeArray = (TraceCube[])forecastTimeSeries.toArray(new TraceCube[forecastTimeSeries.size()]);</span>
<span class="nc" id="L86">			TraceCube[] serviceGoalsTraceCubeArray = (TraceCube[])serviceGoalsTimeSeries.toArray(new TraceCube[serviceGoalsTimeSeries.size()]);</span>

<span class="nc bnc" id="L88" title="All 2 branches missed.">			for (int i = 0 ; i &lt;= serviceGoalsTimeSeries.size() - 1; i++) {</span>
<span class="nc" id="L89">				clientServiceGoalsCubesArray[i] = new ClientServiceGoalTraceCube((ForecastTraceCube) forecastTraceCubeArray[i], (ServiceGoalTraceCube) serviceGoalsTraceCubeArray[i], MediaType.get(mediaId));</span>
			}
			// Combine queue data into a single cube.
<span class="nc" id="L92">			result = (ClientServiceGoalTraceCube)TraceOperator.combineQueue(clientServiceGoalsCubesArray, false, TraceOperatorAdapter.getQueueMediaMap(serviceGoalsTimeSeries));</span>
<span class="nc" id="L93">		} else {</span>
<span class="fc" id="L94">			result = new ClientServiceGoalTraceCube((ForecastTraceCube) forecastTimeSeries.iterator().next(),</span>
<span class="fc" id="L95">				(ServiceGoalTraceCube)serviceGoalsTimeSeries.iterator().next(), MediaType.get(mediaId));</span>
		}
<span class="fc" id="L97">		TraceUtil.setUndefinedValuesToZero(result);</span>
<span class="fc" id="L98">		return result;</span>
	}

	/**
	 * Creates and returns a ServiceGoalTraceCube with the given trace types, initialized with zero values for every interval
	 * between the given start and end dates.
	 */
	public static ServiceGoalTraceCube createZeroServiceGoalsTraceCube(ID queueId, Date start, Date end, short[] traceTypes) throws BbmTimeSeriesException {
<span class="nc" id="L106">		ServiceGoalTraceCube result = new ServiceGoalTraceCube(queueId, start, end, traceTypes);</span>
<span class="nc" id="L107">		TraceUtil.zeroOutTraceCubeValues(result, traceTypes);</span>
<span class="nc" id="L108">		return result;</span>
	}

	/**
	 * Returns the service goal trace types that are applicable to the given media type.
	 */
	public static short[] getApplicableServiceGoalTraceTypes(MediaType mediaType) {
<span class="pc bpc" id="L115" title="2 of 4 branches missed.">		switch (mediaType) {</span>
		case IMMEDIATE:
<span class="fc" id="L117">			return new short[]{Trace.PCA, Trace.ASA, Trace.ABANDONMENT};</span>
		case DEFERRED:
<span class="nc" id="L119">			return new short[]{Trace.PCA, Trace.ASA, Trace.ABANDONMENT, Trace.DEADLINE_TIME};</span>
		case OUTBOUND:
<span class="fc" id="L121">			return new short[]{Trace.MAX_DIALS};</span>
		default:
<span class="nc" id="L123">			return new short[]{Trace.PCA, Trace.ASA, Trace.ABANDONMENT};</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>