<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ScheduleRequestsMessage.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.ejb.facade.scheduling</a> &gt; <span class="el_source">ScheduleRequestsMessage.java</span></div><h1>ScheduleRequestsMessage.java</h1><pre class="source lang-java linenums">package com.verint.ejb.facade.scheduling;

import java.util.ArrayList;
import java.util.List;

import javax.jms.JMSException;
import javax.jms.ObjectMessage;
import javax.jms.Queue;
import javax.jms.QueueConnection;
import javax.jms.QueueConnectionFactory;
import javax.jms.QueueSender;
import javax.jms.QueueSession;
import javax.jms.Session;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.JMSMessageBase;
import com.bluepumpkin.ejb.core.Log;
import com.bluepumpkin.ejb.facade.JNDINames;

public class ScheduleRequestsMessage extends JMSMessageBase {

	private static final long serialVersionUID = -2926539930973553858L;

<span class="fc" id="L28">	public static final Category CAT = Log.initCategory(ScheduleRequestsMessage.class.getName());</span>

<span class="fc" id="L30">	private final List&lt;ID&gt; m_requestIDs = new ArrayList&lt;ID&gt;();</span>
	private final ScheduleRequestParameters m_ScheduleRequestParameters;
	
	private int errorRetryAttempt;
<span class="fc" id="L34">	private ErrorStatus errorStatus = ErrorStatus.NoError;</span>

	/**
	 * Creates a new message indicating that we need to invoke scheduling calculations for some scheduling periods.  
	 * This message will be processed by FacadeSchedulingManagerMDB.
	 * @param requests
	 * 
	 * @param isWhatIfMode
	 * @param action
	 * @param schedParams
	 * @param recalcSubCampaigns
	 * @param enableLQF
	 * @param retryAttempt - Number of times this message was attempted to be processed.  If there was an error or timeout,
	 * FacadeSchedulingManagerMDB will create a new ScheduleRequestsMessage and increment the retryAttempt on the message
	 * to indicate how many attempts have occurred to process the requests.
 	 * @param errorRetryAttempt - Number of times this message was attempted to be processed after error.  If there was an error,
	 * FacadeSchedulingManagerMDB will create a new ScheduleRequestsMessage and increment the errorRetryAttempt on the message
	 * to indicate how many attempts have occurred to process the requests after an error like integration server failure.
	 * @param scheduleInChronologicalOrder if true, the scheduling engine will try to schedule the sp in the chronological order of start date
	 * @deprecated Use {@link #ScheduleRequestsMessage(List, ScheduleRequestParameters, int)} instead
	 */
	public ScheduleRequestsMessage(List&lt;ID&gt; requests, boolean isWhatIfMode,
			int action, String[] schedParams, boolean recalcSubCampaigns,
			boolean enableLQF, boolean overrideSchedules, int retryAttempt, int errorRetryAttempt, boolean scheduleInChronologicalOrder) {
<span class="nc" id="L58">		this(requests, new ScheduleRequestParameters(isWhatIfMode, action, schedParams, recalcSubCampaigns, enableLQF, overrideSchedules, retryAttempt, scheduleInChronologicalOrder), errorRetryAttempt);</span>
<span class="nc" id="L59">	}</span>
	
	/**
	 * Creates a new message indicating that we need to invoke scheduling calculations for some scheduling periods.  
	 * This message will be processed by FacadeSchedulingManagerMDB.
	 * @param requests
	 * @param isWhatIfMode
	 * @param action
	 * @param schedParams
	 * @param recalcSubCampaigns
	 * @param enableLQF
	 * @param overrideSchedules
	 * @deprecated Use {@link #ScheduleRequestsMessage(List, ScheduleRequestParameters, int)} instead
	 */
	public ScheduleRequestsMessage(List&lt;ID&gt; requests, boolean isWhatIfMode,
			int action, String[] schedParams, boolean recalcSubCampaigns,
			boolean enableLQF, boolean overrideSchedules) {
<span class="nc" id="L76">		this(requests, isWhatIfMode, action, schedParams, recalcSubCampaigns, enableLQF, overrideSchedules,  0, 0, false);</span>
<span class="nc" id="L77">	}</span>
	
	/**
	 * Creates a new message indicating that we need to invoke scheduling calculations for some scheduling periods.  
	 * This message will be processed by FacadeSchedulingManagerMDB.
	 * @param requests
	 * @param isWhatIfMode
	 * @param action
	 * @param schedParams
	 * @param recalcSubCampaigns
	 * @param enableLQF
	 * @param overrideSchedules
	 * @param scheduleInChronologicalOrder
	 * @deprecated Use {@link #ScheduleRequestsMessage(List, ScheduleRequestParameters, int)} instead
	 */
	public ScheduleRequestsMessage(List&lt;ID&gt; requests, boolean isWhatIfMode,
			int action, String[] schedParams, boolean recalcSubCampaigns,
			boolean enableLQF, boolean overrideSchedules, boolean scheduleInChronologicalOrder) {
<span class="nc" id="L95">		this(requests, isWhatIfMode, action, schedParams, recalcSubCampaigns, enableLQF, overrideSchedules,  0, 0, scheduleInChronologicalOrder);</span>
<span class="nc" id="L96">	}</span>
	
	public ScheduleRequestsMessage(List&lt;ID&gt; requests,
			ScheduleRequestParameters schedulingParameters,
<span class="fc" id="L100">			int errorRetryAttempt) {</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">		if (requests != null) {</span>
<span class="fc" id="L102">			m_requestIDs.addAll(requests);</span>
		}
<span class="fc" id="L104">		this.m_ScheduleRequestParameters = schedulingParameters;</span>
<span class="fc" id="L105">		this.errorRetryAttempt = errorRetryAttempt;</span>
<span class="fc" id="L106">	}</span>
	
	public void sendMessage() throws NamingException, JMSException {
		try {
<span class="fc" id="L110">			sendMessage(new InitialContext());</span>
<span class="nc" id="L111">		} catch (NamingException e) {</span>
<span class="nc" id="L112">			CAT.error(&quot;Error creating/looking up the Initial context&quot;, e);</span>
<span class="nc" id="L113">			throw e;</span>
<span class="fc" id="L114">		}</span>
<span class="fc" id="L115">	}</span>

	/**
	 * Looks up the context for the Facade scheduling queue
	 * {@link JNDINames#FACADE_SCHEDULING_QUEUE} and sends this
	 * {@link ScheduleRequestsMessage} scheduling message to it. This method can
	 * be used outside of the EJB/Web Container of the weblogic to send me JMS
	 * messages.
	 */
	public void sendMessage(Context ctx) throws NamingException, JMSException {

		try {
<span class="fc" id="L127">			QueueConnectionFactory queueConnectionFactory = (QueueConnectionFactory) ctx</span>
<span class="fc" id="L128">					.lookup(JNDINames.FACADE_JMS_QUEUE_FACTORY);</span>
<span class="fc" id="L129">			QueueConnection queueConnection = queueConnectionFactory</span>
<span class="fc" id="L130">					.createQueueConnection();</span>
<span class="fc" id="L131">			QueueSession queueSession = queueConnection.createQueueSession(</span>
					false, Session.AUTO_ACKNOWLEDGE);
<span class="fc" id="L133">			Queue queue = (Queue) ctx.lookup(JNDINames.FACADE_SCHEDULING_QUEUE);</span>
<span class="fc" id="L134">			QueueSender queueSender = queueSession.createSender(queue);</span>
<span class="fc" id="L135">			queueConnection.start();</span>
<span class="fc" id="L136">			ObjectMessage objectMessage = queueSession.createObjectMessage();</span>
<span class="fc" id="L137">			objectMessage.setObject(this);</span>
<span class="fc" id="L138">			queueSender.send(objectMessage);</span>
<span class="fc" id="L139">			queueSender.close();</span>
<span class="fc" id="L140">			queueSession.close();</span>
<span class="fc" id="L141">			queueConnection.close();</span>
<span class="nc" id="L142">		} catch (NamingException e) {</span>
<span class="nc" id="L143">			CAT.error(&quot;Error looking up the Initial context&quot;, e);</span>
<span class="nc" id="L144">			throw e;</span>
<span class="nc" id="L145">		} catch (JMSException e) {</span>
<span class="nc" id="L146">			CAT.error(&quot;Error sending the Scheduling Request for &quot;, e);</span>
<span class="nc" id="L147">			throw e;</span>
<span class="fc" id="L148">		}</span>
<span class="fc" id="L149">	}</span>

	/**
	 * @return the m_requestIDs
	 */
	public List&lt;ID&gt; getRequestsToSchedule() {
<span class="fc" id="L155">		return new ArrayList&lt;ID&gt;(m_requestIDs);</span>
	}
	
	
	public ScheduleRequestParameters getScheduleRequestParameters(){
<span class="fc" id="L160">		return m_ScheduleRequestParameters;</span>
	}

	/**
	 * @return the isWhatIfMode
	 */
	public boolean isWhatIfMode() {
<span class="fc" id="L167">		return m_ScheduleRequestParameters.isWhatIfMode();</span>
	}

	/**
	 * @return the schedAction
	 */
	public int getSchedulingAction() {
<span class="fc" id="L174">		return m_ScheduleRequestParameters.getSchedAction();</span>
	}

	/**
	 * @return the schedParams
	 */
	public String[] getSchedulingParameters() {
<span class="fc" id="L181">		return m_ScheduleRequestParameters.getSchedParams();</span>
	}

	public boolean isEnableLQF() {
<span class="fc" id="L185">		return m_ScheduleRequestParameters.isEnableLQF();</span>
	}

	public boolean isRecalcSubCampaign() {
<span class="fc" id="L189">		return m_ScheduleRequestParameters.isRecalcSubCampaigns();</span>
	}
	
	
	public boolean isOverrideSchedules() {
<span class="fc" id="L194">		return m_ScheduleRequestParameters.isOverrideSchedules();</span>
	}

	
	/**
	 * Returns the number of times that this message
	 * has attempted to be processed.
	 */
	public int getRetryAttempt() {
<span class="nc" id="L203">		return m_ScheduleRequestParameters.getRetryAttempt();</span>
	}

	/**
	 * Sets the number of times that this message
	 * has attempted to be processed.
	 */
	public void setRetryAttempt(int retryAttempt) {
<span class="nc" id="L211">		m_ScheduleRequestParameters.setRetryAttempt(retryAttempt);</span>
<span class="nc" id="L212">	}</span>
	
	
	public boolean isScheduleInChronologicalOrder(){
<span class="fc" id="L216">		return m_ScheduleRequestParameters.isScheduleInOrder();</span>
	}
	
	public String getUserSeal() {
<span class="fc" id="L220">		return m_ScheduleRequestParameters.getUserSeal();</span>
	}

	public void setUserSeal(String seal) {
<span class="nc" id="L224">		m_ScheduleRequestParameters.setUserSeal(seal);</span>
<span class="nc" id="L225">	}</span>
	
	/**
	 * Sets the the successive errors that were there while trying to process this message
	 */
	public void setErrorRetryAttempt(int retryAttempt) {
<span class="nc" id="L231">		this.errorRetryAttempt = retryAttempt;</span>
<span class="nc" id="L232">	}</span>

	/**
	 * Returns the successive errors that were there while trying to process this message
	 */
	public int getErrorRetryAttempt() {
<span class="nc" id="L238">		return errorRetryAttempt;</span>
	}	
	
	public ErrorStatus getErrorStatus() {
<span class="nc" id="L242">		return errorStatus;</span>
	}
	
	public void setErrorStatus(ErrorStatus errorStatus) {
<span class="nc" id="L246">		this.errorStatus = errorStatus;</span>
<span class="nc" id="L247">	}	</span>
	
	
	/**
	 * Indicates the status of an error that may have occurred during the
	 * processing of this message.
	 * FIXME: Errors should be associated to the requests themselves, not 
	 * the message (which can handle multiple requests).
	 */
<span class="pc" id="L256">	public static enum ErrorStatus {</span>
<span class="fc" id="L257">		NoError,</span>
<span class="fc" id="L258">		IntegrationServerConnectionFailure,</span>
<span class="fc" id="L259">		IntegrationServerConfigurationError</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>