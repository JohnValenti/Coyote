<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SkillsAssignmentMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.skills</a> &gt; <span class="el_source">SkillsAssignmentMH.java</span></div><h1>SkillsAssignmentMH.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.skills;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.skill.ejb.SkillManager;
import com.bluepumpkin.ejb.bbm.skill.model.Skill;
import com.bluepumpkin.ejb.bbm.skill.model.SkillAssignment;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.system.RequestContext;

import java.rmi.RemoteException;
import java.util.*;

<span class="nc" id="L19">public class SkillsAssignmentMH {</span>
	private static final String MULTI_VALUE_DATA = &quot;*&quot;;

	public static HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; getSkillAssignmentsForEmployees(RequestContext context, Collection&lt;ID&gt; employeeIDs,
			Date startDate, Date endDate) throws BbmFinderException {
		try {
<span class="fc" id="L25">			SkillManager sm = WfmManagerFactory.getSkillManager(context.isInWhatIfMode());</span>
<span class="fc" id="L26">			return sm.getSkillAssignments(employeeIDs, startDate, endDate);</span>
<span class="nc" id="L27">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L28">			throw e;</span>
<span class="nc" id="L29">		} catch (Exception e) {</span>
<span class="nc" id="L30">			throw new BbmFinderException(e);</span>
		}
	}

	public static Collection&lt;SkillAssignment&gt; getSkillAssignmentsForEmployee(RequestContext context, ID employeeID,
			Date startDate, Date endDate) throws BbmFinderException {
		try {
<span class="nc" id="L37">			HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; skillAssignmentMap = getSkillAssignmentsForEmployees(context,</span>
<span class="nc" id="L38">					Collections.singleton(employeeID), startDate, endDate);</span>
<span class="nc bnc" id="L39" title="All 4 branches missed.">			if (skillAssignmentMap == null || skillAssignmentMap.get(employeeID) == null) {</span>
<span class="nc" id="L40">				return new ArrayList&lt;SkillAssignment&gt;();</span>
			}
<span class="nc" id="L42">			return skillAssignmentMap.get(employeeID);</span>
<span class="nc" id="L43">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L44">			throw e;</span>
<span class="nc" id="L45">		} catch (Exception e) {</span>
<span class="nc" id="L46">			throw new BbmFinderException(e);</span>
		}
	}

	/**
	 * This method will delete the skill assignments in assignmentsToDelete, and will
	 * create new assignments for the assignments in assignmentsToCreate.
	 */
	public static void saveSkillAssignments(RequestContext context,
			Collection&lt;SkillAssignment&gt; assignmentsToDelete,
			Collection&lt;SkillAssignment&gt; assignmentsToCreate) throws BbmException {
		try {
<span class="pc bpc" id="L58" title="3 of 6 branches missed.">			if ((assignmentsToDelete != null &amp;&amp; assignmentsToDelete.isEmpty() == false) ||</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">					(assignmentsToCreate != null &amp;&amp; assignmentsToCreate.isEmpty() == false)) {</span>
<span class="fc" id="L60">				SkillManager sm = WfmManagerFactory.getSkillManager(context.isInWhatIfMode());</span>

				//Batch the save operation for each employee to avoid a transaction timeout when editing
				//large sets of employees
<span class="fc" id="L64">				Set&lt;ID&gt; employeeIDs = new HashSet&lt;ID&gt;();</span>
<span class="fc" id="L65">				Map&lt;ID, Collection&lt;SkillAssignment&gt;&gt; assignmentsToDeleteByEmp =</span>
						new HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt;();
<span class="fc" id="L67">				HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt; assignmentsToCreateByEmp =</span>
						new HashMap&lt;ID, Collection&lt;SkillAssignment&gt;&gt;();
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">				for (SkillAssignment assignment : assignmentsToDelete) {</span>
<span class="nc bnc" id="L70" title="All 4 branches missed.">					if (assignment != null &amp;&amp; assignment.getWorkResourceID() != null) {</span>
<span class="nc" id="L71">						employeeIDs.add(assignment.getWorkResourceID());</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">						if (assignmentsToDeleteByEmp.get(assignment.getWorkResourceID()) == null) {</span>
<span class="nc" id="L73">							assignmentsToDeleteByEmp.put(assignment.getWorkResourceID(), new ArrayList&lt;SkillAssignment&gt;());</span>
						}
<span class="nc" id="L75">						assignmentsToDeleteByEmp.get(assignment.getWorkResourceID()).add(assignment);</span>
					}
<span class="nc" id="L77">				}</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">				for (SkillAssignment assignment : assignmentsToCreate) {</span>
<span class="pc bpc" id="L79" title="2 of 4 branches missed.">					if (assignment != null &amp;&amp; assignment.getWorkResourceID() != null) {</span>
<span class="fc" id="L80">						employeeIDs.add(assignment.getWorkResourceID());</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">						if (assignmentsToCreateByEmp.get(assignment.getWorkResourceID()) == null) {</span>
<span class="fc" id="L82">							assignmentsToCreateByEmp.put(assignment.getWorkResourceID(), new ArrayList&lt;SkillAssignment&gt;());</span>
						}
<span class="fc" id="L84">						assignmentsToCreateByEmp.get(assignment.getWorkResourceID()).add(assignment);</span>
					}
<span class="fc" id="L86">				}</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">				for (ID employeeID : employeeIDs) {</span>
<span class="fc" id="L88">					Collection&lt;SkillAssignment&gt; empAssignmentsToDelete = assignmentsToDeleteByEmp.get(employeeID);</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">					if (empAssignmentsToDelete == null) {</span>
<span class="fc" id="L90">						empAssignmentsToDelete = new ArrayList&lt;SkillAssignment&gt;();</span>
					}
<span class="fc" id="L92">					Collection&lt;SkillAssignment&gt; empAssignmentsToCreate = assignmentsToCreateByEmp.get(employeeID);</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">					if (empAssignmentsToCreate == null) {</span>
<span class="nc" id="L94">						empAssignmentsToCreate = new ArrayList&lt;SkillAssignment&gt;();</span>
					}

<span class="fc" id="L97">					sm.saveSkillAssignments(empAssignmentsToDelete, empAssignmentsToCreate);</span>
<span class="fc" id="L98">				}</span>
			}
<span class="nc" id="L100">		} catch (Exception e) {</span>
<span class="nc" id="L101">			throw new BbmException(e);</span>
<span class="fc" id="L102">		}</span>
<span class="fc" id="L103">	}</span>

	/**
	 * Returns a list of skills that are able to be assigned to the given employees during the given date range.
	 */
	public static Collection&lt;Skill&gt; getEmployeeSkills(RequestContext context, Collection&lt;ID&gt; employeeIDs,
			Date viewStartDate, Date viewEndDate) throws BbmException {
<span class="pc bpc" id="L110" title="2 of 4 branches missed.">		if (employeeIDs == null || employeeIDs.isEmpty()) {</span>
<span class="nc" id="L111">			return Collections.emptyList();</span>
		}
		try {
<span class="fc" id="L114">			return WfmManagerFactory.getSkillManager(context.isInWhatIfMode()).getAvailableSkillsForEmployees(</span>
					employeeIDs, viewStartDate, viewEndDate);
<span class="nc" id="L116">		} catch (RemoteException ex) {</span>
<span class="nc" id="L117">			throw new BbmException(ex);</span>
		}
	}

	/**
	 * Returns a string representation of the proficiency value (actually a double value) for the given employees.
	 * If the employees do not all have the same proficiency, an &quot;*&quot; is returned to represent multi-value data.
	 */
	public static String getProficiencyForEmployees(RequestContext context, Collection&lt;ID&gt; colEmpID, Date asOfDate)
			throws RemoteException, BbmException {
<span class="pc bpc" id="L127" title="2 of 4 branches missed.">		if (colEmpID == null || colEmpID.isEmpty()) {</span>
<span class="nc" id="L128">			return null;</span>
		}
<span class="fc" id="L130">		int prof = 0;</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">		if (colEmpID.size() &gt; 1) {</span>
			// multiple employees
<span class="fc" id="L133">			Collection&lt;Employee&gt; colEmp = getEmployeesByIDs(context, colEmpID, asOfDate);</span>
<span class="pc bpc" id="L134" title="2 of 4 branches missed.">			if (colEmp == null || colEmp.isEmpty()) {</span>
<span class="nc" id="L135">				return null;</span>
			}

<span class="fc" id="L138">			prof = ((Employee) colEmp.iterator().next()).getProficiency();</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">			for (Employee emp : colEmp) {</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">				if (emp.getProficiency() != prof) {</span>
<span class="nc" id="L141">					return MULTI_VALUE_DATA;</span>
				}
<span class="fc" id="L143">			}</span>
<span class="fc" id="L144">		} else {</span>
			// single emp
<span class="fc" id="L146">			Employee emp = getEmployeeByID(context, colEmpID.iterator().next(), asOfDate);</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">			if (emp == null) {</span>
<span class="nc" id="L148">				return null;</span>
			}
<span class="fc" id="L150">			prof = emp.getProficiency();</span>
		}
<span class="fc" id="L152">		Double d = prof / 10.0;</span>
<span class="fc" id="L153">		return Double.toString(d);</span>
	}

	/**
	 * Returns a map of employee IDs with the number of chat sessions for each ID.  The map will only
	 * contain entries for employees that have chat skills assigned, unless includeEmployeesWithoutChatSkills is true,
	 * in which case it will return the number of chat sessions for all given employees.  If none of the given employee IDs
	 * have chat skills assigned (and includeEmployeesWithoutChatSkills is false), returns an empty map.
	 */
	public static Map&lt;ID, Integer&gt; getNumberOfChatSessionsForEmployees(RequestContext context,
			Collection&lt;ID&gt; employeeIDs, boolean includeEmployeesWithoutChatSkills) throws BbmException, RemoteException {
<span class="fc" id="L164">		Map&lt;ID, Integer&gt; retVal = getWorkResourceManager(context).getNumberOfChatSessionsForEmployees(employeeIDs,</span>
				includeEmployeesWithoutChatSkills);
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">		if (includeEmployeesWithoutChatSkills) {</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">			for (ID empID : employeeIDs) {</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">				if (retVal.get(empID) == null) {</span>
<span class="nc" id="L169">					retVal.put(empID, 1);</span>
				}
<span class="fc" id="L171">			}</span>
		}
<span class="fc" id="L173">		return retVal;</span>
	}

	public static void saveNumberOfChatSessionsForEmployees(RequestContext context, Collection&lt;ID&gt; employeeIDs,
			int numChatSessions) throws BbmException, RemoteException {
<span class="nc" id="L178">		getWorkResourceManager(context).createOrUpdateNumChatSessions(employeeIDs, numChatSessions, context.getUserName());</span>
<span class="nc" id="L179">	}</span>

	public static void saveEmployeeProficiency(RequestContext context, Collection&lt;ID&gt; employeeIDs, Date asOfDate,
			double proficiency) throws BbmException, MultiUserException, RemoteException {
<span class="fc" id="L183">		Collection&lt;Employee&gt; colEmp = getEmployeesByIDs(context, employeeIDs, asOfDate);</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">		for (Employee employee : colEmp) {</span>
<span class="fc" id="L185">			employee.setProficiency((int) (proficiency * 10));    //Proficiency is stored as an int in the DB, even though it is a double value.</span>
<span class="fc" id="L186">		}</span>
<span class="fc" id="L187">		getWorkResourceManager(context).updateEmployees(colEmp);</span>
<span class="fc" id="L188">	}</span>

	/**
	 * Retrieve the Work Resource Manager EJB remote interface
	 */
	private static WorkResourceManager getWorkResourceManager(
			RequestContext context) throws BbmException {
<span class="fc" id="L195">		return BbmManagerFactory.getWorkResourceManager(context</span>
<span class="fc" id="L196">				.isInWhatIfMode());</span>
	}

	private static Collection&lt;Employee&gt; getEmployeesByIDs(RequestContext context,
			Collection&lt;ID&gt; colEmpID, Date asOfDate) throws RemoteException, BbmException {
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">		if (colEmpID == null) {</span>
<span class="nc" id="L202">			return null;</span>
		}
<span class="fc" id="L204">		return getWorkResourceManager(context).getEmployeesByIDs(colEmpID,</span>
				asOfDate, Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);
	}

	private static Employee getEmployeeByID(RequestContext context, ID empID, Date asOfDate)
			throws RemoteException, BbmException {
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">		if (empID == null) {</span>
<span class="nc" id="L211">			return null;</span>
		}
<span class="fc" id="L213">		return getWorkResourceManager(context).getEmployeeByID(empID, asOfDate,</span>
				Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>