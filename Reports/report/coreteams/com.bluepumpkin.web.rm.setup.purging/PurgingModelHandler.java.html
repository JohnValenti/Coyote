<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PurgingModelHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.setup.purging</a> &gt; <span class="el_source">PurgingModelHandler.java</span></div><h1>PurgingModelHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.setup.purging;

import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.ResourceBundle;
import java.util.Set;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityProperties;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.core.base.ModelHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.setup.filingrules.FilingRuleModelHandler;
import com.witness.web.uif.system.RequestContext;


/**
 * Title          PurgingModelHandler
 * Description    Model handler for Purging
 * Copyright      Copyright (c) 2002
 * Company        Blue Pumpkin Software, Inc
 * @author        Howard Mullings
 * @version       1.0
 */
<span class="nc" id="L39">public class PurgingModelHandler extends ModelHandler {</span>
<span class="fc" id="L40">	private static final Category LOG = Log.initCategory(PurgingModelHandler.class.getName());</span>

<span class="fc" id="L42">	private static final Set&lt;String&gt; REQUEST_TYPE_SET = new HashSet&lt;String&gt;();</span>
	static {
<span class="fc" id="L44">		REQUEST_TYPE_SET.add(Request.REQUESTTYPE_ALL);</span>
<span class="fc" id="L45">		REQUEST_TYPE_SET.add(Request.REQUESTTYPE_SHIFTBID);</span>
<span class="fc" id="L46">		REQUEST_TYPE_SET.add(Request.REQUESTTYPE_SHIFTSWAP);</span>
<span class="fc" id="L47">		REQUEST_TYPE_SET.add(Request.REQUESTTYPE_CUSTSHIFT);</span>
<span class="fc" id="L48">		REQUEST_TYPE_SET.add(Request.REQUESTTYPE_TIMEOFF);</span>
<span class="fc" id="L49">		REQUEST_TYPE_SET.add(Request.REQUESTTYPE_FLEXTIME);</span>
<span class="fc" id="L50">	}</span>

	/**
	 * Return a collection of Request Types
	 * Get the possible requests types to purge. The request types
	 * can be purged in the major groups of All, Shift Bid, Shift swap,
	 * Custom Shift, and Time off.
	 * Requests for time off can also be purged based on the time off
	 * activity. If this method can't determine the time off activities
	 * it will ignore them. This method will log exceptions it encounters
	 * but will not throw any of them.
	 *
	 * This routine must return the items in the following order:
	 * 1) All
	 * 2) Shift Bid
	 * 3) Shift swap
	 * 4) Custom Shift
	 * 5) Time Off	 *
	 * 6) Flex Time *
	 *
	 * When Shift bidding is added the code in PurgingPageModel that trims
	 * the request type collection based on the authorization must be changed.
	 *
	 * @param   orgID	ID	Identifes the organizationId
	 * @param   rmBundle the resource bundle to use to get the string labels
	 *                   for the constants components of the collection. These
	 *                   components are the All, Shift Swap and Time Off.
	 * @return  StringsPair collection of key value pairs
	 */
	public static List&lt;Object&gt; getRequestTypes(ID orgID, ResourceBundle rmBundle, Localizer localizer) {
<span class="fc" id="L80">		List&lt;Object&gt; reqTypes = new ArrayList&lt;Object&gt;();</span>

		// The order of the following enteries is very important.
		// Don't add or change enteries without changing the
		// code in PurgingPageModel.initForm that handles the
		// case where the user only has some of the privileges
		// necessary to purge requests. In this case, some of these items
		// have to be removed and the code in initForm assumes the
		// location of the items it plans to delete.
<span class="fc" id="L89">		reqTypes.add(new StringsPair(Request.REQUESTTYPE_ALL,</span>
<span class="fc" id="L90">				localizer.i18n(rmBundle,</span>
						RmWebBundleKey.REQUEST_TYPE_ALL)));

<span class="fc" id="L93">		reqTypes.add(new StringsPair(Request.REQUESTTYPE_SHIFTBID,</span>
<span class="fc" id="L94">				localizer.i18n(rmBundle,</span>
						RmWebBundleKey.REQUEST_TYPE_SHIFT_BIDDING)));

<span class="fc" id="L97">		reqTypes.add(new StringsPair(Request.REQUESTTYPE_SHIFTSWAP,</span>
<span class="fc" id="L98">				localizer.i18n(rmBundle,</span>
						RmWebBundleKey.REQUEST_TYPE_SHIFT_SWAP)));

<span class="fc" id="L101">		reqTypes.add(new StringsPair(Request.REQUESTTYPE_CUSTSHIFT,</span>
<span class="fc" id="L102">				localizer.i18n(rmBundle,</span>
						RmWebBundleKey.REQUEST_TYPE_CUSTOM_SHIFT)));

<span class="fc" id="L105">		reqTypes.add(getTimeOffRequestTypes(orgID, rmBundle, localizer, false));</span>
<span class="fc" id="L106">		reqTypes.add(getTimeOffRequestTypes(orgID, rmBundle, localizer, true));</span>

<span class="fc" id="L108">		return reqTypes;</span>
	}

	private static List&lt;StringsPair&gt; getTimeOffRequestTypes(ID orgID, ResourceBundle rmBundle, Localizer localizer, boolean isFlex) {
<span class="fc" id="L112">		List&lt;StringsPair&gt; reqTypes = new ArrayList&lt;StringsPair&gt;();</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">		if (isFlex) {</span>
<span class="fc" id="L114">			reqTypes.add(new StringsPair(Request.REQUESTTYPE_FLEXTIME,</span>
<span class="fc" id="L115">					localizer.i18n(rmBundle,</span>
							RmWebBundleKey.REQUEST_TYPE_FLEX_TIME_ALL)));
		} else {
<span class="fc" id="L118">			reqTypes.add(new StringsPair(Request.REQUESTTYPE_TIMEOFF,</span>
<span class="fc" id="L119">					localizer.i18n(rmBundle,</span>
							RmWebBundleKey.REQUEST_TYPE_TIME_OFF_ALL)));
		}

<span class="fc bfc" id="L123" title="All 2 branches covered.">		String timeOffActivityFormat =</span>
<span class="fc" id="L124">				localizer.i18n(rmBundle,</span>
						isFlex ? RmWebBundleKey.REQUEST_TYPE_FLEX_TIME_ACTIVITY : RmWebBundleKey.REQUEST_TYPE_TIME_OFF_ACTIVITY);
		try {
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L128">			Collection&lt;StringsPair&gt; timeOffTypes = FilingRuleModelHandler.getTimeOffTypes(orgID, isFlex);</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">			if (timeOffTypes != null) {</span>
<span class="fc" id="L130">				Iterator&lt;StringsPair&gt; itr = timeOffTypes.iterator();</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">				while (itr.hasNext()) {</span>
<span class="fc" id="L132">					StringsPair sp = itr.next();</span>
<span class="fc" id="L133">					sp.setValue(</span>
<span class="fc" id="L134">							MessageFormat.format(timeOffActivityFormat,</span>
<span class="fc" id="L135">									new Object[] { sp.getValue() }));</span>
<span class="fc" id="L136">				}</span>
<span class="fc" id="L137">				reqTypes.addAll(timeOffTypes);</span>
			}
<span class="nc" id="L139">		}	catch (Exception e) {</span>
<span class="nc" id="L140">			LOG.debug(e);</span>
<span class="fc" id="L141">		}</span>
<span class="fc" id="L142">		return reqTypes;</span>
	}

	/**
	 * Convert a request type or activity id string to a request type.
	 * If the arguement is an activity then the request type is TIME_OFF.
	 * The code assumes that activity ids always start with a number and
	 * true request types never do.
	 *
	 * @param requestTypeOrActivityId - a request type or an activity id.
	 * @return String the request type.
	 */
	private static String getTrueRequestType(RequestContext context, String requestTypeOrActivityId) throws Exception {
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">		if (REQUEST_TYPE_SET.contains(requestTypeOrActivityId)) {</span>
<span class="fc" id="L156">			return requestTypeOrActivityId;</span>
		} else {
<span class="nc" id="L158">			ActivityProperties activityProperties = ActivityModelHandler.getActivityProperties(context, ID.fromInt(Integer.parseInt(requestTypeOrActivityId)));</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">			return (activityProperties.getTimeoffWithFlex() == ActivityProperties.FLEX_TIME) ? Request.REQUESTTYPE_FLEXTIME : Request.REQUESTTYPE_TIMEOFF;</span>
		}
	}

	/**
	 * Convert a request type or activity id string to an activity id object.
	 * The code assumes that activity ids always start with a number and
	 * true request types never do.
	 *
	 * @param requestTypeOrActivityId - a request type or an activity id.
	 * @return ID null if the given argument is not an activity id,
	 *            otherwise the argument will be converted to an ID object.
	 */
	private static ID getTimeOffActivityId(String requestTypeOrActivityId) {
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">		if (REQUEST_TYPE_SET.contains(requestTypeOrActivityId)) {</span>
			// Not an Time Off Activity
<span class="fc" id="L175">			return null;</span>
		} else {
			// Must be a Time Off Specific Activity
<span class="nc" id="L178">			return new ID(requestTypeOrActivityId);</span>
		}
	}

	/**
	 * Deletes request for all subtypes within the organization branch or the
	 * current organization.
	 * @param   reqType String Identifies the type of request
	 * @param   orgId	ID	Identifies the organizationId
	 * @param   isForBranch boolean true identifes if the request is deleted from the
	 *							Organization branch otherwise only deletes for the
	 *							current Organization
	 * @throws Exception
	 */
	public static void purgeRequest(RequestContext context, String reqType, ID orgId, boolean isForBranch)
			throws Exception {
<span class="nc" id="L194">		ID subType = getTimeOffActivityId(reqType);</span>
<span class="nc" id="L195">		String trueReqType = getTrueRequestType(context, reqType);</span>

<span class="nc" id="L197">		RmManagerFactory.getInstance().getCommonRequestManager().</span>
<span class="nc" id="L198">				deleteRequestsByType(orgId, isForBranch, trueReqType, subType);</span>
<span class="nc" id="L199">	}</span>

	/**
	 * Deletes request for all subtypes within the organization branch or the
	 * current organization.
	 * @param   reqType String Identifies the type of request
	 * @param   orgId	ID	Identifies the organizationId
	 * @param   pastDays int Identifes the number of days in advance
	 * @param   isForBranch boolean true identifes if the request is deleted from the
	 *							Organization branch otherwise only deletes for the
	 *							current Organization
	 * @throws Exception
	 */
	public static void purgeRequest(RequestContext context, String reqType, ID orgId, int pastDays, boolean isForBranch)
			throws Exception {
<span class="nc" id="L214">		Calendar daysInPastCal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L215">		daysInPastCal.add(Calendar.DATE, -1*pastDays);</span>

<span class="nc" id="L217">		ID subType = getTimeOffActivityId(reqType);</span>
<span class="nc" id="L218">		String trueReqType = getTrueRequestType(context, reqType);</span>

<span class="nc" id="L220">		RmManagerFactory.getInstance().getCommonRequestManager().</span>
<span class="nc" id="L221">				deleteRequestsByDate(orgId, isForBranch, daysInPastCal.getTime(), trueReqType, subType);</span>
<span class="nc" id="L222">	}</span>

	/**
	 * Deletes request for all subtypes within the organization branch or the
	 * current organization.
	 * @param   reqType String Identifies the type of request
	 * @param   orgId	ID	Identifies the organizationId
	 * @param   startDate Date Identifes the start date
	 * @param   endDate Date Identifes the end date
	 * @param   isForBranch boolean true identifes if the request is deleted from the
	 *							Organization branch otherwise only deletes for the
	 *							current Organization
	 * @throws Exception
	 */
	public static void purgeRequest(RequestContext context, String reqType,	ID orgId,	Date startDate,
			Date endDate,	boolean isForBranch)
			throws Exception {
<span class="fc" id="L239">		ID subType = getTimeOffActivityId(reqType);</span>
<span class="fc" id="L240">		String trueReqType = getTrueRequestType(context, reqType);</span>

<span class="fc" id="L242">		TimeRange timeRange = new TimeRange(startDate, endDate);</span>
<span class="fc" id="L243">		RmManagerFactory.getInstance().getCommonRequestManager().</span>
<span class="fc" id="L244">				deleteRequestsByDateRange(orgId, isForBranch,</span>
						timeRange, trueReqType, subType);
<span class="fc" id="L246">	}</span>

	/**
	 * Deletes request starting during the given range for all subtypes within the organization branch or the
	 * current organization.
	 * @param   reqType String Identifies the type of request
	 * @param   orgId	ID	Identifies the organizationId
	 * @param   startDate Date Identifes the start date
	 * @param   endDate Date Identifes the end date
	 * @param   isForBranch boolean true identifes if the request is deleted from the
	 *							Organization branch otherwise only deletes for the
	 *							current Organization
	 * @throws Exception
	 */
	public static void purgeRequestByRequestStart(RequestContext context, String reqType,	ID orgId,	Date startDate,
			Date endDate,	boolean isForBranch)
			throws Exception {
<span class="fc" id="L263">		ID subType = getTimeOffActivityId(reqType);</span>
<span class="fc" id="L264">		String trueReqType = getTrueRequestType(context, reqType);</span>

<span class="fc" id="L266">		TimeRange timeRange = new TimeRange(startDate, endDate);</span>
<span class="fc" id="L267">		RmManagerFactory.getInstance().getCommonRequestManager().</span>
<span class="fc" id="L268">			deleteRequestsByStartDateRange(orgId, isForBranch,</span>
						timeRange, trueReqType, subType);
<span class="fc" id="L270">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>