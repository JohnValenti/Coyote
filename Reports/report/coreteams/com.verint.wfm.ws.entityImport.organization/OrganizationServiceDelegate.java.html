<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OrganizationServiceDelegate.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.wfm.ws.entityImport.organization</a> &gt; <span class="el_source">OrganizationServiceDelegate.java</span></div><h1>OrganizationServiceDelegate.java</h1><pre class="source lang-java linenums">/**
 * @author Eliot Clingman, Copyright (c) 2011, 2017, 2018 by Verint Systems, Inc. All Rights Reserved. Organization Manager Web
 *		Service This supports methods to synchronize organizations between WFO and an external application
 *	Consider separating load logic into OrganizationImportProcessData and have a validator class with the validation methods.
 */
package com.verint.wfm.ws.entityImport.organization;

import java.rmi.RemoteException;
import java.util.*;
import java.util.stream.Collectors;
import javax.annotation.PostConstruct;
import javax.annotation.PreDestroy;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.MapUtil;
import com.bluepumpkin.ejb.bbm.dao.MapUtil.SystemType;
import com.bluepumpkin.ejb.bbm.vo.validators.ValidatorConstants;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.OrganizationHOO;
import com.bluepumpkin.ejb.core.Log;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.verint.wfm.ws.ServiceApplicationException;
import com.verint.wfm.ws.entityImport.EntityImportService;
import com.verint.wfm.ws.entityImport.model.HoursOfOperationDTO;
import com.verint.wfm.ws.entityImport.organization.model.OrganizationDTO;
import com.verint.wfm.ws.util.CalendarUtil;
import com.verint.wfm.ws.util.ExternalIDUtil;
import com.verint.wfm.ws.util.OrganizationExternalKey;
import com.verint.wfm.ws.util.SyncUtil;
import com.verint.wfm.ws.wrappers.MapUtilWrapper;

<span class="fc" id="L41">public class OrganizationServiceDelegate {</span>

	private static final long serialVersionUID = 1L;
	private static final String USER_ERROR_ORGANIZATION_ENTITY_WILL_NOT_BE_PERSISTED =
			&quot;User error: Organization entity will not be persisted&quot;;
	public static final String COMMUNICATION_FAULT_UPDATE_OR_MATCH = &quot;There was a communication fault invoking &quot; +
			&quot;workResourceManager.updateOrganization() or matchOrganizationWithExternalID()&quot;;

<span class="fc" id="L49">	private static Category CAT = Log.initCategory(OrganizationServiceDelegate.class.getName());</span>

	private static final int WEEK_DAYS_PLUS_1 = 8;
	private static final short DEFAULT_NUM_SEATS = 0;

<span class="fc" id="L54">	private WorkResourceManager workResourceManager = null;</span>

	// ---------------------------------------------------------------------- helpers
	@PostConstruct
	public void postConstruct() {
		try {
<span class="fc" id="L60">			workResourceManager = BbmManagerFactory.getWorkResourceManager();</span>
<span class="fc" id="L61">			CAT.info(&quot;Succeeded to obtain reference to WorkResourceManager :)&quot;);</span>
<span class="nc" id="L62">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L63">			CAT.error(&quot;Failed to obtain reference to WorkResourceManager :(&quot;, e);</span>
<span class="fc" id="L64">		}</span>
<span class="fc" id="L65">	}</span>

	@PreDestroy
	public void preDestroy() {
<span class="nc" id="L69">		workResourceManager = null;</span>
<span class="nc" id="L70">	}</span>

	WorkResourceManager getWorkResourceManager() {
<span class="nc" id="L73">		return workResourceManager;</span>
	}

	MapUtilWrapper getMapUtilWrapper() {
<span class="nc" id="L77">		return MapUtilWrapper.getInstance();</span>
	}

	SyncUtil getSyncUtil() {
<span class="nc" id="L81">		return new SyncUtil();</span>
	}

	public List&lt;OrganizationNotPersistedInfo&gt; createOrUpdate(Collection&lt;OrganizationDTO&gt; organizationDTOs, String systemTypeName)
			throws ServiceApplicationException {

<span class="nc" id="L87">		SystemType systemType = SystemType.valueOf(systemTypeName);</span>
<span class="nc" id="L88">		CAT.debug(&quot;createOrUpdate(): systemType.name(): &quot; + systemType.name());</span>
<span class="nc bnc" id="L89" title="All 4 branches missed.">		if (organizationDTOs == null || organizationDTOs.isEmpty()) {</span>
<span class="nc" id="L90">			CAT.debug(&quot;No Organizations to create/update&quot;);</span>
<span class="nc" id="L91">			return new ArrayList&lt;&gt;();</span>
		}

<span class="nc bnc" id="L94" title="All 2 branches missed.">		if (getWorkResourceManager() == null) {</span>
<span class="nc" id="L95">			CAT.error(&quot;In createOrUpdate method: manager does not exist&quot;);</span>
<span class="nc" id="L96">			throw new ServiceApplicationException(&quot;In createOrUpdate method: manager does not exist&quot;);</span>
		}

		// Convert From DTO's to entities so that the EJB layer can handle them
<span class="nc" id="L100">		OrganizationImportProcessData organizationImportProcessData = createOrganizationImportProcessData(</span>
				systemType,
				organizationDTOs,
<span class="nc" id="L103">				getOrganizationByID(Organization.YOUR_COMPANY_ID_OBJ));</span>
		try {
<span class="nc bnc" id="L105" title="All 2 branches missed.">			if (! convertToEntity(organizationImportProcessData) ) {</span>
<span class="nc" id="L106">				return organizationImportProcessData.getOrganizationNotPersistedInfos();</span>
			}
<span class="nc" id="L108">			CAT.info(&quot;Succeeded to convert DTOs!&quot;);</span>
<span class="nc" id="L109">		} catch (RuntimeException e) {</span>
<span class="nc" id="L110">			CAT.error(&quot;Unrecoverable system bug while converting DTO to entity Organization&quot;, e);</span>
<span class="nc" id="L111">			throw new ServiceApplicationException(e);</span>
<span class="nc" id="L112">		}</span>

<span class="nc" id="L114">		CAT.info(&quot;createOrUpdate():  new and old organizations.size() resp.: &quot;</span>
<span class="nc" id="L115">				+ organizationImportProcessData.getNewOrganizationWrappers().size() + &quot;, &quot;</span>
<span class="nc" id="L116">				+ organizationImportProcessData.getOldOrganizationWrappers().size());</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (isHierarchyValid(organizationImportProcessData)) {</span>
			//The entire hierarchy is not altered in one transaction.
			//Therefore if a ServiceApplicationException occurs in the middle of the change set, it may leave the hierarchy in a corrupted.
<span class="nc" id="L121">			createNewOrganizations(organizationImportProcessData);</span>
<span class="nc" id="L122">			updateExistingOrganizations(organizationImportProcessData);</span>
		}

<span class="nc" id="L125">		return organizationImportProcessData.getOrganizationNotPersistedInfos();</span>
	}

	private OrganizationImportProcessData createOrganizationImportProcessData(
			SystemType systemType,
			Collection&lt;OrganizationDTO&gt; organizationDTOs,
			Organization yourCompanyOrganization)
					throws  ServiceApplicationException {

		Collection&lt;Organization&gt; existingOrganizations;
		try {
<span class="nc" id="L136">			existingOrganizations = getWorkResourceManager().getFullScopeTree();</span>
<span class="nc" id="L137">		} catch (Exception e) {</span>
<span class="nc" id="L138">			CAT.error(</span>
					&quot;Unable to retrieve the existing organizations in order to match them with the imported organizations&quot; +
							&quot; due to a BbmFinderException&quot;,
					e);
<span class="nc" id="L142">			throw new ServiceApplicationException(e);</span>
<span class="nc" id="L143">		}</span>
<span class="nc" id="L144">		Collection&lt;ID&gt; existingOrganizationIDs = existingOrganizations</span>
<span class="nc" id="L145">				.stream()</span>
<span class="nc" id="L146">				.map(organization -&gt; organization.getID())</span>
<span class="nc" id="L147">				.collect(Collectors.toSet());</span>

		Map&lt;ID, ID&gt; iDToExternalIdMap;
		try {
<span class="nc" id="L151">			iDToExternalIdMap = getMapUtilWrapper().getExternalIDMap(</span>
					systemType, MapUtil.ObjectType.Organization, existingOrganizationIDs, false);
<span class="nc" id="L153">		} catch (JdmoException e) {</span>
<span class="nc" id="L154">			CAT.error(&quot;Unrecoverable system error attempting to retrieve the organization external id map.&quot;, e);</span>
<span class="nc" id="L155">			throw new ServiceApplicationException(e);</span>
<span class="nc" id="L156">		}</span>
<span class="nc" id="L157">		existingOrganizations</span>
<span class="nc" id="L158">				.stream()</span>
<span class="nc" id="L159">				.forEach(organization -&gt; organization.setExternalID(iDToExternalIdMap.get(organization.getID())));</span>

<span class="nc" id="L161">		return new OrganizationImportProcessData(</span>
				systemType,
				organizationDTOs,
				existingOrganizations,
				iDToExternalIdMap,
<span class="nc" id="L166">				getOrganizationByID(Organization.YOUR_COMPANY_ID_OBJ));</span>
	}

	/**
	 * Only protected for testing purposes, should be private.
	 * PRE: getWorkResourceManager() != null
	 * 		organizationImportProcessData.getExistingOrganizations has been populated with the organizations in DB.
	 * POST:OrganizationWithWeekWrappers will be created from items in organizationImportProcessData.getOrganizationDTOs().
	 * 		organizationImportProcessData.getOrganizationWrappersToBeImportedByName will be populated.
	 * 		organizationImportProcessData.organizationNotPersistedInfos will be populated with any recoverable problems.
	 * 		organizationImportProcessData.getProposedNewHierarchy will be populated.
	 * 		organizationImportProcessData.newOrganizationWrappers will be populated.
	 * 		organizationImportProcessData.oldOrganizationWrappers will be populated.
	 *
	 * @param organizationImportProcessData
	 * @return 	true if importing organizations from organizationImportProcessData.getOrganizationDTOs() will results in a valid hierarchy
	 * 			without circular references; false if the conversion resulted in an unrecoverable exception.
	 * @throws ServiceApplicationException
	 */
	protected boolean convertToEntity(OrganizationImportProcessData organizationImportProcessData) throws ServiceApplicationException {

<span class="nc" id="L187">		Map&lt;String, OrganizationWithWeekWrapper&gt; organizationWrappersToBeImportedByName =</span>
<span class="nc" id="L188">				organizationImportProcessData.getOrganizationWrappersToBeImportedByName();</span>
<span class="nc" id="L189">		Set&lt;String&gt; organizationNamesToBeImported = new HashSet&lt;&gt;();</span>
		//organizationNamesToBeImported is required to track the all the orgs we are attempting to import.
		//organizationWrappersToBeImportedByName.keySet() cannot be used since some will not be persisted.
<span class="nc" id="L192">		List&lt;OrganizationNotPersistedInfo&gt; organizationNotPersistedInfos = organizationImportProcessData.getOrganizationNotPersistedInfos();</span>

		// Covert each DTO to a native entity
<span class="nc bnc" id="L195" title="All 2 branches missed.">		for (OrganizationDTO organizationDTO : organizationImportProcessData.getOrganizationDTOs()) {</span>
			// We will create exception info; only add to collection if there is an exception
			// Note: we are using name as the unique identifier, not an external source id
<span class="nc" id="L198">			OrganizationNotPersistedInfo organizationNotPersistedInfo = new OrganizationNotPersistedInfo(</span>
<span class="nc" id="L199">					organizationDTO.getExternalSourceId(), organizationDTO.getName());</span>
<span class="nc" id="L200">			OrganizationWithWeekWrapper organizationWrapper = new OrganizationWithWeekWrapper();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">			if (organizationNamesToBeImported.contains(organizationDTO.getName().toUpperCase())) {</span>
<span class="nc" id="L202">				organizationNotPersistedInfo.logAndAddError(</span>
						CAT,
<span class="nc" id="L204">						organizationNotPersistedInfo.getDuplicateNameMessage());</span>
<span class="nc" id="L205">				organizationNotPersistedInfos.add(organizationNotPersistedInfo);</span>
<span class="nc" id="L206">				return false;</span>
			} else {
<span class="nc" id="L208">				organizationNamesToBeImported.add(organizationDTO.getName().toUpperCase());</span>
			}

<span class="nc" id="L211">			verifyOrganizationName(</span>
					organizationDTO,
					organizationNotPersistedInfo,
					organizationWrapper,
<span class="nc" id="L215">					organizationImportProcessData.getYourCompanyRootNameUpperCase());</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">			if (! organizationNotPersistedInfo.getMessages().isEmpty()) {</span>
<span class="nc" id="L217">				CAT.error(USER_ERROR_ORGANIZATION_ENTITY_WILL_NOT_BE_PERSISTED);</span>
<span class="nc" id="L218">				organizationNotPersistedInfos.add(organizationNotPersistedInfo);</span>
<span class="nc" id="L219">				continue;</span>
			}

<span class="nc" id="L222">			setIdentifyingOrgPropertiesFromDTO(</span>
					organizationImportProcessData,
					organizationDTO,
					organizationWrapper);

<span class="nc" id="L227">			setOrgPropertiesFromDTO(</span>
<span class="nc" id="L228">					organizationImportProcessData.getDefaultTimeZone(),</span>
					organizationDTO,
					organizationNotPersistedInfo,
					organizationWrapper);
<span class="nc bnc" id="L232" title="All 2 branches missed.">			if (! organizationNotPersistedInfo.getMessages().isEmpty()) {</span>
<span class="nc" id="L233">				CAT.error(USER_ERROR_ORGANIZATION_ENTITY_WILL_NOT_BE_PERSISTED);</span>
<span class="nc" id="L234">				organizationNotPersistedInfos.add(organizationNotPersistedInfo);</span>
<span class="nc" id="L235">				continue;</span>
			}

<span class="nc" id="L238">			organizationWrappersToBeImportedByName.put(organizationDTO.getName().toUpperCase(), organizationWrapper);</span>
<span class="nc" id="L239">		}</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">		if (! populateProposedNewHierarchy(organizationImportProcessData)) {</span>
<span class="nc" id="L241">			return false;</span>
		}
<span class="nc" id="L243">		populateNewAndOldOrganizationWrappers(organizationImportProcessData);</span>
<span class="nc" id="L244">		return true;</span>
	}

	/**
	 * Returns the organization by the given id.
	 */
	Organization getOrganizationByID(ID orgID) throws ServiceApplicationException {
		try {
<span class="nc" id="L252">			return getWorkResourceManager().getOrganizationByID(orgID);</span>
<span class="nc" id="L253">		} catch (BbmFinderException|RemoteException e) {</span>
<span class="nc" id="L254">			throw new ServiceApplicationException(e);</span>
		}
	}

	/**
	 * Verifies the organization name is a valid string
	 *
	 * @param organizationDTO
	 * @param organizationNotPersistedInfo
	 * @param organizationWrapper
	 * @param yourCompanyRootName
	 * @throws ServiceApplicationException
	 */
	private void verifyOrganizationName(
			OrganizationDTO organizationDTO,
			OrganizationNotPersistedInfo organizationNotPersistedInfo,
			OrganizationWithWeekWrapper organizationWrapper,
			String yourCompanyRootName)
					throws ServiceApplicationException {
		// Use name as the unique identifier of this entity
<span class="nc bnc" id="L274" title="All 2 branches missed.">		if (StringUtil.isEmptyOrWhiteSpace(organizationDTO.getName())) {</span>
<span class="nc" id="L275">			organizationNotPersistedInfo.addNameMissingMessage(organizationWrapper.getOrganization().getDescription());</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">		} else if (StringUtil.containsInvalidChars(organizationDTO.getName(), ValidatorConstants.INVALID_NAME_CHARS)){</span>
<span class="nc" id="L277">			organizationNotPersistedInfo.addNameHasInvalidCharactersMessage(ValidatorConstants.INVALID_NAME_CHARS);</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">		} else if (organizationDTO.getName().length() &gt; EntityImportService.NAME_MAX_LENGTH) {</span>
<span class="nc" id="L279">			organizationNotPersistedInfo.addNameLengthExceededMessage(</span>
<span class="nc" id="L280">					organizationDTO.getName().length(),</span>
					EntityImportService.NAME_MAX_LENGTH);
<span class="nc bnc" id="L282" title="All 2 branches missed.">		} else if (yourCompanyRootName.equalsIgnoreCase(organizationDTO.getName())) {</span>
			//The Your Company Name org should not be modified by the import, all orgs will be imported under it.
			// check if the organization name is same as your company name
<span class="nc" id="L285">			organizationNotPersistedInfo.addNameSameAsRoot();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">		} else if (! StringUtil.isEmptyOrWhiteSpace(organizationDTO.getParentOrganizationName())</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">				&amp;&amp; (yourCompanyRootName.equalsIgnoreCase(organizationDTO.getParentOrganizationName()))) {</span>
			//Why is this disallowed?
<span class="nc" id="L289">			organizationNotPersistedInfo.addParentNameSameAsRoot();</span>
		}
<span class="nc" id="L291">	}</span>

	private void setIdentifyingOrgPropertiesFromDTO(
			OrganizationImportProcessData organizationImportProcessData,
			OrganizationDTO organizationDTO,
			OrganizationWithWeekWrapper organizationWrapper)
					throws ServiceApplicationException {
<span class="nc" id="L298">		Organization organization = organizationWrapper.getOrganization();</span>

		// Warning: Keep parent name around, but don't look up its ID yet because the parent might be another
		// organization that needs to be imported, and thus not saved yet!
<span class="nc bnc" id="L302" title="All 2 branches missed.">		String parentName = organizationDTO.getParentOrganizationName() == null ?</span>
<span class="nc" id="L303">				organizationImportProcessData.getYourCompanyRootName() :</span>
<span class="nc" id="L304">				organizationDTO.getParentOrganizationName();</span>
<span class="nc" id="L305">		organizationWrapper.setParentOrganizationName(parentName);</span>
<span class="nc" id="L306">		organization.setName(organizationDTO.getName());</span>

<span class="nc" id="L308">		ID orgExternalID = ExternalIDUtil.buildExternalID(</span>
<span class="nc" id="L309">				organizationImportProcessData.getSystemType(),</span>
<span class="nc" id="L310">				organizationDTO.getExternalSourceId());</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">		if (orgExternalID != null) {</span>
<span class="nc" id="L312">			organization.setExternalID(orgExternalID);</span>
<span class="nc" id="L313">			organizationImportProcessData.getOrgIDToExternalIDMap().forEach((orgID, externalId) -&gt; {</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">				if (externalId.equals(orgExternalID)) {</span>
<span class="nc" id="L315">					organization.setID(orgID);</span>
				}
<span class="nc" id="L317">			});</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">			if (organization.getID() != null) {</span>
<span class="nc" id="L319">				CAT.info(String.format(</span>
						&quot;Found existing organization by External Id [%s] for the imported name [%s]&quot;,
						orgExternalID,
<span class="nc" id="L322">						organizationDTO.getName()));</span>
			}
		}

		//We will later try to find a matching existing organization by name in setIDOfImportedOrganizationsBasedOnExistingOrganizationNames
<span class="nc" id="L327">	}</span>

	private void setOrgPropertiesFromDTO(
			TimeZone defaultTimeZone,
			OrganizationDTO organizationDTO,
			OrganizationNotPersistedInfo organizationNotPersistedInfo,
			OrganizationWithWeekWrapper organizationWrapper) {
<span class="nc bnc" id="L334" title="All 2 branches missed.">		if (isStartOfWeekInvalid(organizationDTO.getWeekStartDate())) {</span>
<span class="nc" id="L335">			organizationNotPersistedInfo.addWeekStartMessage(organizationDTO.getWeekStartDate());</span>
<span class="nc" id="L336">			return;</span>
		}

<span class="nc" id="L339">		Organization organization = organizationWrapper.getOrganization();</span>
<span class="nc" id="L340">		organization.setDescription(organizationDTO.getDescription());</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">		if (organizationDTO.getTimeZoneId() == null) {</span>
<span class="nc" id="L342">			organization.setTimeZone(defaultTimeZone);</span>
		} else {
<span class="nc" id="L344">			organization.setTimeZone(TimeZone.getTimeZone(organizationDTO.getTimeZoneId()));</span>
		}

		// If not, we will look up the parent right before we persist the organization
<span class="nc bnc" id="L348" title="All 2 branches missed.">		if (organizationDTO.getWeekStartDate() != null) {</span>
<span class="nc" id="L349">			organization.setWeekStartDate(organizationDTO.getWeekStartDate());</span>
		} else {
<span class="nc" id="L351">			organizationWrapper.setOrganizationWeekStartDateFromParent(true);</span>
		}

<span class="nc bnc" id="L354" title="All 2 branches missed.">		if (organizationDTO.getNumSeats() == null) {</span>
<span class="nc" id="L355">			organization.setNumSeats(DEFAULT_NUM_SEATS);</span>
		} else {
<span class="nc" id="L357">			organization.setNumSeats(organizationDTO.getNumSeats());</span>
		}

<span class="nc" id="L360">		setOrgHOOFromDTO(organization, organizationDTO, organizationWrapper, organizationNotPersistedInfo);</span>
<span class="nc" id="L361">	}</span>

	private boolean isStartOfWeekInvalid(Short weekStartIndex) {
<span class="nc bnc" id="L364" title="All 6 branches missed.">		return weekStartIndex != null &amp;&amp; (weekStartIndex.shortValue() &lt; 1 || weekStartIndex &gt; CalendarUtil.DAYS_IN_WEEK);</span>
	}

	private void setOrgHOOFromDTO(
			Organization organization,
			OrganizationDTO organizationDTO,
			OrganizationWithWeekWrapper organizationWrapper,
			OrganizationNotPersistedInfo organizationNotPersistedInfo) {
		// handle week hours of operation entity
<span class="nc" id="L373">		HoursOfOperationDTO hoursOfOperationDTO = organizationDTO.getHoursOfOperationDTO();</span>
<span class="nc" id="L374">		OrganizationHOO organizationHOO = new OrganizationHOO();</span>
<span class="nc" id="L375">		organizationWrapper.setOrganizationHOO(organizationHOO);</span>
<span class="nc" id="L376">		organizationHOO.setOrganizationID(organization.getID());</span>

		// If hour's aren't provided, treat organization as always closed
<span class="nc bnc" id="L379" title="All 2 branches missed.">		if (hoursOfOperationDTO == null) {</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">			for (short i = 1; i &lt;= CalendarUtil.DAYS_IN_WEEK; i++) {</span>
<span class="nc" id="L381">				organizationHOO.setDayOpen(i, (short) 0);</span>
<span class="nc" id="L382">				organizationHOO.setDayClose(i, (short) 0);</span>
			}
		} else {
			// If hours are provided, first validate them then copy their properties over
<span class="nc bnc" id="L386" title="All 2 branches missed.">			if (hoursOfOperationDTO.getDayOpen() == null</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">					|| hoursOfOperationDTO.getDayOpen().length != WEEK_DAYS_PLUS_1) {</span>
<span class="nc" id="L388">				organizationNotPersistedInfo.addWeekDayOpenLengthMessage(hoursOfOperationDTO.getDayOpen().length);</span>
			}
<span class="nc bnc" id="L390" title="All 2 branches missed.">			if (hoursOfOperationDTO.getDayClose() == null</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">					|| hoursOfOperationDTO.getDayClose().length != WEEK_DAYS_PLUS_1) {</span>
<span class="nc" id="L392">				organizationNotPersistedInfo.addWeekDayCloseLengthMessage(hoursOfOperationDTO.getDayClose().length);</span>
			}

<span class="nc bnc" id="L395" title="All 2 branches missed.">			if (organizationNotPersistedInfo.getMessages().isEmpty()) {</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">				for (short i = 1; i &lt;= CalendarUtil.DAYS_IN_WEEK; i++) {</span>
<span class="nc" id="L397">					organizationHOO.setDayOpen(i, (short) (hoursOfOperationDTO.getDayOpen()[i]));</span>
<span class="nc" id="L398">					organizationHOO.setDayClose(i, (short) (hoursOfOperationDTO.getDayClose()[i]));</span>
				}
				// This method is called after setDayOpen()/Close() because it overwrites it
<span class="nc bnc" id="L401" title="All 2 branches missed.">				if (hoursOfOperationDTO.isFull24Hour()) {</span>
<span class="nc" id="L402">					organizationHOO.setOpen24Hours();</span>
				}
			}
		}
<span class="nc" id="L406">	}</span>

	private boolean populateProposedNewHierarchy(OrganizationImportProcessData organizationImportProcessData) 
			throws ServiceApplicationException {
<span class="nc" id="L410">		Map&lt;String, OrganizationWithWeekWrapper&gt; proposedNewHierarchy = organizationImportProcessData.getProposedNewHierarchy();</span>

		//add orgs to be imported to proposedNewHierarchy
<span class="nc" id="L413">		proposedNewHierarchy.putAll(organizationImportProcessData.getOrganizationWrappersToBeImportedByName());</span>

<span class="nc" id="L415">		setNewNameOnExistingOrganizations(organizationImportProcessData.getExistingOrganizations(), proposedNewHierarchy);</span>

<span class="nc" id="L417">		List&lt;OrganizationNotPersistedInfo&gt; organizationNotPersistedInfos = organizationImportProcessData.getOrganizationNotPersistedInfos();</span>
<span class="nc" id="L418">		int messageStartSize = organizationNotPersistedInfos.size();</span>
<span class="nc" id="L419">		setIDOfImportedOrganizationsBasedOnExistingOrganizationNames(organizationImportProcessData);</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">		if (messageStartSize &lt; organizationNotPersistedInfos.size()) {</span>
<span class="nc" id="L421">			return false;</span>
		}

<span class="nc" id="L424">		addUnmatchedExistingOrganizationsWithParentNameToProposedHierarchy(organizationImportProcessData);</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">		if (messageStartSize &lt; organizationNotPersistedInfos.size()) {</span>
<span class="nc" id="L426">			return false;</span>
		}
<span class="nc" id="L428">		return true;</span>
	}

	private void setNewNameOnExistingOrganizations(
			Collection&lt;Organization&gt; existingOrganizations,
			Map&lt;String, OrganizationWithWeekWrapper&gt; proposedNewHierarchy) {
		//loop through existing organizations
		//	if id is already in proposedNewHierarchy we have a match, the existing org name should be updated
		//		this will handle the rename case
<span class="nc" id="L437">		existingOrganizations.forEach(existingOrganization -&gt; {</span>
<span class="nc" id="L438">			proposedNewHierarchy.forEach( (importName, importWrapper) -&gt; {</span>
<span class="nc" id="L439">				Organization importOrg = importWrapper.getOrganization();</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">				if (existingOrganization.getID().equals(importOrg.getID())) {</span>
<span class="nc" id="L441">					existingOrganization.setName(importOrg.getName());</span>
				}
<span class="nc" id="L443">			});</span>
<span class="nc" id="L444">		});</span>
<span class="nc" id="L445">	}</span>

	/**
	 * PRE: organizationImportProcessData.getExistingOrganizations has been populated
	 * 		organizationImportProcessData.getProposedNewHierarchy contains the organizationsToBeImported
	 * @param organizationImportProcessData
	 */
	private void setIDOfImportedOrganizationsBasedOnExistingOrganizationNames(OrganizationImportProcessData organizationImportProcessData) {
		//loop through proposedNewHierarchy
		//	if id and external is null, attempt to find an existing org with the same name
		//		set id when found
		//	if id is null but external exists, attempt to find an existing org with the same name
		//		do we want to eventually update this existing org (by setting id here)?
		//			the existing organization could have been manually added by a wfm user
		//		what if the existing has a different external ID than the imported external id
		//			Should we treat this a catastrophic failure?
		//			should we highjack the external id of the existing org and overwrite it?
<span class="nc" id="L462">		Collection&lt;Organization&gt; existingOrganizations = organizationImportProcessData.getExistingOrganizations();</span>
<span class="nc" id="L463">		Map&lt;String, OrganizationWithWeekWrapper&gt; proposedNewHierarchy = organizationImportProcessData.getProposedNewHierarchy();</span>
<span class="nc" id="L464">		proposedNewHierarchy.forEach( (importName, importWrapper) -&gt; {</span>
<span class="nc" id="L465">			Organization orgToBeImported = importWrapper.getOrganization();</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">			if (orgToBeImported.getID() == null) {</span>
<span class="nc" id="L467">				existingOrganizations.forEach(existingOrganization -&gt; {</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">					if (existingOrganization.getName().equalsIgnoreCase(importName)) {</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">						if (isExternalIdsDifferent(orgToBeImported, existingOrganization)) {</span>
<span class="nc" id="L470">							String message = &quot;Failed to overwrite an existing organization with the same name but a different external ID&quot;;</span>
<span class="nc" id="L471">							OrganizationNotPersistedInfo organizationNotPersistedInfo = new OrganizationNotPersistedInfo(</span>
<span class="nc" id="L472">									importWrapper.getOrgExternalID().toString(), importName);</span>
<span class="nc" id="L473">							organizationNotPersistedInfo.logAndAddError(CAT, message);</span>
<span class="nc" id="L474">							organizationImportProcessData.getOrganizationNotPersistedInfos().add(organizationNotPersistedInfo);</span>
						}
<span class="nc" id="L476">						orgToBeImported.setID(existingOrganization.getID());</span>
<span class="nc" id="L477">						OrganizationHOO organizationHOO = importWrapper.getOrganizationHOO();</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">						if (organizationHOO != null) {</span>
<span class="nc" id="L479">							organizationHOO.setOrganizationID(orgToBeImported.getID());</span>
						}
					}
<span class="nc" id="L482">				});</span>
			}
<span class="nc" id="L484">		});</span>
<span class="nc" id="L485">	}</span>

	private boolean isExternalIdsDifferent(Organization orgToBeImported, Organization existingOrganization) {
<span class="nc bnc" id="L488" title="All 2 branches missed.">		return existingOrganization.getExternalID() != null</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">				&amp;&amp; orgToBeImported.getExternalID() != null</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">				&amp;&amp; ! existingOrganization.getExternalID().equals(orgToBeImported.getExternalID());</span>
	}

	private void addUnmatchedExistingOrganizationsWithParentNameToProposedHierarchy(
			OrganizationImportProcessData organizationImportProcessData) {
		//loop through existing organizations
		//	if the id is not found in proposedNewHierarchy
		//		if the existing org name matches an imported org name, add an exception message and return
		//		else add existing org to proposedNewHierarchy
<span class="nc" id="L499">		Collection&lt;Organization&gt; existingOrganizations = organizationImportProcessData.getExistingOrganizations();</span>
<span class="nc" id="L500">		Map&lt;String, OrganizationWithWeekWrapper&gt; proposedNewHierarchy = organizationImportProcessData.getProposedNewHierarchy();</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">		for (Organization existingOrganization: existingOrganizations) {</span>
<span class="nc" id="L502">			if (! proposedNewHierarchy</span>
<span class="nc" id="L503">					.values()</span>
<span class="nc" id="L504">					.stream()</span>
<span class="nc" id="L505">					.filter(importWrapper -&gt; existingOrganization.getID().equals(importWrapper.getOrganization().getID()))</span>
<span class="nc" id="L506">					.findAny()</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">					.isPresent() ) {</span>
<span class="nc" id="L508">				OrganizationWithWeekWrapper renamedWrapper = proposedNewHierarchy.get(existingOrganization.getName().toUpperCase());</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">				if (renamedWrapper != null) {</span>
<span class="nc" id="L510">					OrganizationNotPersistedInfo organizationNotPersistedInfo = new OrganizationNotPersistedInfo(</span>
<span class="nc" id="L511">							renamedWrapper.getOrgExternalID().toString(), existingOrganization.getName());</span>
<span class="nc" id="L512">					String message = organizationNotPersistedInfo.getRenameOrganizationToExistingMessage();</span>
<span class="nc" id="L513">					organizationNotPersistedInfo.logAndAddError(CAT, message);</span>
<span class="nc" id="L514">					organizationImportProcessData.getOrganizationNotPersistedInfos().add(organizationNotPersistedInfo);</span>
<span class="nc" id="L515">					return;</span>
				}
<span class="nc" id="L517">				OrganizationWithWeekWrapper existingOrganizationWrapper = new OrganizationWithWeekWrapper(existingOrganization);</span>
<span class="nc" id="L518">				ID existingParentID = existingOrganization.getParentID();</span>
				//The existingOrganizationWrapper parent name should always be set by this statement.
<span class="nc" id="L520">				existingOrganizations</span>
<span class="nc" id="L521">						.stream()</span>
<span class="nc" id="L522">						.filter(org -&gt; org.getID().equals(existingParentID))</span>
<span class="nc" id="L523">						.findFirst()</span>
<span class="nc" id="L524">						.ifPresent(parentOrg -&gt; existingOrganizationWrapper.setParentOrganizationName(parentOrg.getName()) );</span>
<span class="nc" id="L525">				proposedNewHierarchy.put(existingOrganization.getName().toUpperCase(), existingOrganizationWrapper);</span>
			}
<span class="nc" id="L527">		}</span>

<span class="nc" id="L529">	}</span>

	private void populateNewAndOldOrganizationWrappers(OrganizationImportProcessData organizationImportProcessData) {
		for(OrganizationWithWeekWrapper organizationWrapper : 
<span class="nc bnc" id="L533" title="All 2 branches missed.">				organizationImportProcessData.getOrganizationWrappersToBeImportedByName().values()) {</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">			if (organizationWrapper.getOrganization().getID() == null) {</span>
<span class="nc" id="L535">				organizationImportProcessData.getNewOrganizationWrappers().add(organizationWrapper);</span>
			} else {
<span class="nc" id="L537">				organizationImportProcessData.getOldOrganizationWrappers().add(organizationWrapper);</span>
			}
<span class="nc" id="L539">		}</span>
<span class="nc" id="L540">	}</span>

	/**
	 * PRE: getWorkResourceManager() != null
	 * 		organizationImportProcessData organizationWrappersToBeImportedByName: each organization has a unique name.
	 * 		organizationImportProcessData getProposedNewHierarchy: has been populated.
	 * CRITICAL: The import uses the organization name as a unique identifier. This approach is not does not handle localized data.
	 * The parent id has not been determined at this point.
	 * @param organizationImportProcessData organizationWrappersToBeImported is a list of organizations to be imported.
	 * @return true if the proposed hierarchy changes are valid with no circular dependencies, false otherwise.
	 * 			When false, a CircularOrganizationHierarchyMessage will be added to organizationImportProcessData.
	 */
	protected boolean isHierarchyValid(OrganizationImportProcessData organizationImportProcessData) throws ServiceApplicationException {
		//Go through each org to be imported, verifying it has no circular parental references.
<span class="nc" id="L554">		Map&lt;String, OrganizationWithWeekWrapper&gt; organizationWrappersToBeImportedByName =</span>
<span class="nc" id="L555">				organizationImportProcessData.getOrganizationWrappersToBeImportedByName();</span>
<span class="nc" id="L556">		TreeSet&lt;String&gt; uncheckedOrganizationNames = new TreeSet(organizationWrappersToBeImportedByName.keySet());</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">		while (! uncheckedOrganizationNames.isEmpty()) {</span>
<span class="nc" id="L558">			HashSet&lt;String&gt; visitedNodes = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L559">			String checkOrganizationName = uncheckedOrganizationNames.pollLast();</span>
<span class="nc" id="L560">			visitedNodes.add(checkOrganizationName);</span>
<span class="nc" id="L561">			OrganizationWithWeekWrapper startOrganizationWrapper = organizationWrappersToBeImportedByName.get(checkOrganizationName);</span>
<span class="nc" id="L562">			Organization startOrganization = startOrganizationWrapper.getOrganization();</span>
<span class="nc" id="L563">			OrganizationNotPersistedInfo organizationNotPersistedInfo = new OrganizationNotPersistedInfo(</span>
<span class="nc" id="L564">					startOrganizationWrapper.getOrgExternalID().toString(), startOrganization.getName());</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">			if (! isHierarchyValidHelper(</span>
					organizationImportProcessData,
					uncheckedOrganizationNames,
					visitedNodes,
<span class="nc" id="L569">					startOrganization.getName(),</span>
					organizationNotPersistedInfo)) {
<span class="nc" id="L571">				organizationImportProcessData.getOrganizationNotPersistedInfos().add(organizationNotPersistedInfo);</span>
<span class="nc" id="L572">				return false;</span>
			}
<span class="nc" id="L574">		}</span>
<span class="nc" id="L575">		return true;</span>
	}

	private boolean isHierarchyValidHelper(
			OrganizationImportProcessData organizationImportProcessData,
			TreeSet&lt;String&gt; uncheckedOrganizationNames,
			HashSet&lt;String&gt; visitedNodes,
			String checkOrganizationName,
			OrganizationNotPersistedInfo organizationNotPersistedInfo) {
<span class="nc" id="L584">		String checkOrganizationNameUpper = checkOrganizationName.toUpperCase();</span>
<span class="nc" id="L585">		OrganizationWithWeekWrapper organizationWithWeekWrapper =</span>
<span class="nc" id="L586">				organizationImportProcessData.getProposedNewHierarchy().get(checkOrganizationNameUpper);</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">		if (organizationWithWeekWrapper == null) {</span>
<span class="nc" id="L588">			organizationNotPersistedInfo.logAndAddError(</span>
					CAT,
<span class="nc" id="L590">					organizationNotPersistedInfo.getNoSuchParentOrganizationNameMessage(checkOrganizationName));</span>
<span class="nc" id="L591">			return false;</span>
		}

<span class="nc" id="L594">		String parentName = organizationWithWeekWrapper.getParentOrganizationName();</span>
<span class="nc" id="L595">		String parentNameUpperCase = parentName.toUpperCase();</span>

<span class="nc" id="L597">		uncheckedOrganizationNames.remove(parentNameUpperCase);</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">		if (parentNameUpperCase.equals(organizationImportProcessData.getYourCompanyRootNameUpperCase())) {</span>
<span class="nc" id="L599">			return true;</span>
		}

<span class="nc bnc" id="L602" title="All 2 branches missed.">		if (visitedNodes.contains(parentNameUpperCase)) {</span>
<span class="nc" id="L603">			organizationNotPersistedInfo.logAndAddError(</span>
					CAT,
<span class="nc" id="L605">					organizationNotPersistedInfo.getCircularOrganizationHierarchyMessage(checkOrganizationName, parentName));</span>
<span class="nc" id="L606">			return false;</span>
		}
<span class="nc" id="L608">		visitedNodes.add(parentNameUpperCase);</span>
<span class="nc" id="L609">		return isHierarchyValidHelper(</span>
				organizationImportProcessData,
				uncheckedOrganizationNames,
				visitedNodes,
				parentName,
				organizationNotPersistedInfo);
	}

	private void createNewOrganizations(OrganizationImportProcessData organizationImportProcessData) throws ServiceApplicationException {
<span class="nc bnc" id="L618" title="All 2 branches missed.">		for (OrganizationWithWeekWrapper organizationWrapper : organizationImportProcessData.getNewOrganizationWrappers()) {</span>
<span class="nc" id="L619">			createNewOrganizationFromWrapper(organizationImportProcessData, organizationWrapper);</span>
<span class="nc" id="L620">		}</span>
<span class="nc" id="L621">	}</span>

	private void createNewOrganizationFromWrapper(
			OrganizationImportProcessData organizationImportProcessData,
			OrganizationWithWeekWrapper organizationWrapper)
					throws ServiceApplicationException {
		try {
<span class="nc" id="L628">			Organization organization = organizationWrapper.getOrganization();</span>

			//Only at last minute we get parent id, because it could be a newly created organization
<span class="nc" id="L631">			Organization parentOrg = organizationImportProcessData</span>
<span class="nc" id="L632">					.getProposedNewHierarchy()</span>
<span class="nc" id="L633">					.get(organizationWrapper.getParentOrganizationName().toUpperCase())</span>
<span class="nc" id="L634">					.getOrganization();</span>
<span class="nc" id="L635">			setWrapperParentIDAndWeekStartDate(organizationWrapper, parentOrg);</span>
<span class="nc" id="L636">			getWorkResourceManager().createOrganization(</span>
<span class="nc" id="L637">					organization, organizationWrapper.getOrganizationHOO(), organizationImportProcessData.getSystemType());</span>
			// Note: any problem with validity or database state should have been detected by now
			// So any exceptions thrown here are unrecoverable system bugs
			// They are captured separate in case invoked method's contract changes
<span class="nc" id="L641">		} catch (BbmCreateException e) {</span>
<span class="nc" id="L642">			CAT.error(&quot;Failed to create the organization!&quot;, e);</span>
<span class="nc" id="L643">			throw new ServiceApplicationException(&quot;Failed to create the organization!&quot;, e);</span>
<span class="nc" id="L644">		} catch (RemoteException e) {</span>
<span class="nc" id="L645">			CAT.error(&quot;There was a communication fault invoking workResourceManager.createOrganization()&quot;, e);</span>
<span class="nc" id="L646">			throw new ServiceApplicationException(</span>
					&quot;There was a communication fault invoking workResourceManager.createOrganization()&quot;, e);
<span class="nc" id="L648">		} catch (RuntimeException e) {</span>
<span class="nc" id="L649">			CAT.error(&quot;Failed to create the organization due to Runtime Exception&quot;, e);</span>
<span class="nc" id="L650">			throw new ServiceApplicationException(&quot;Failed to create the organization due to Runtime Exception&quot;, e);</span>
<span class="nc" id="L651">		}</span>
<span class="nc" id="L652">	}</span>

	@SuppressWarnings(&quot;deprecation&quot;)
	private void setWrapperParentIDAndWeekStartDate(OrganizationWithWeekWrapper organizationWrapper, Organization parentOrg) {
<span class="nc" id="L656">		Organization organization = organizationWrapper.getOrganization();</span>
<span class="nc" id="L657">		organization.setParentID(parentOrg.getID());</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">		if (organizationWrapper.isOrganizationWeekStartDateFromParent()){</span>
<span class="nc" id="L659">			organization.setWeekStartDate(parentOrg.getWeekStartDate());</span>
		}
<span class="nc" id="L661">	}</span>

	private void updateExistingOrganizations(OrganizationImportProcessData organizationImportProcessData)
					throws ServiceApplicationException {
		// persist updates for the old organizations
<span class="nc bnc" id="L666" title="All 2 branches missed.">		for (OrganizationWithWeekWrapper organizationWrapper : organizationImportProcessData.getOldOrganizationWrappers()) {</span>
<span class="nc" id="L667">			updateExistingOrganization(</span>
					organizationImportProcessData,
					organizationWrapper);
<span class="nc" id="L670">		}</span>
<span class="nc" id="L671">	}</span>

	private void updateExistingOrganization(
			OrganizationImportProcessData organizationImportProcessData,
			OrganizationWithWeekWrapper organizationWrapper)
					throws ServiceApplicationException {
		try {
<span class="nc" id="L678">			Organization organization = organizationWrapper.getOrganization();</span>
			//Only at last minute we get parent id, because it could be a newly created organization
<span class="nc" id="L680">			Organization parentOrg = organizationImportProcessData</span>
<span class="nc" id="L681">					.getProposedNewHierarchy()</span>
<span class="nc" id="L682">					.get(organizationWrapper.getParentOrganizationName().toUpperCase())</span>
<span class="nc" id="L683">					.getOrganization();</span>

<span class="nc" id="L685">			setWrapperParentIDAndWeekStartDate(organizationWrapper, parentOrg);</span>
<span class="nc" id="L686">			getWorkResourceManager().updateOrganization(organization, organizationWrapper.getOrganizationHOO());</span>
<span class="nc" id="L687">			updateOrganizationMapDBEntry(organizationImportProcessData.getSystemType(), organizationWrapper);</span>
<span class="nc" id="L688">		} catch (MultiUserException e) {</span>
<span class="nc" id="L689">			CAT.error(&quot;Another process is has updated this organization&quot;, e);</span>
<span class="nc" id="L690">			throw new ServiceApplicationException(&quot;Another process is has updated this organization&quot;, e);</span>
<span class="nc" id="L691">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L692">			CAT.error(&quot;Failed to update the organization!&quot;, e);</span>
<span class="nc" id="L693">			throw new ServiceApplicationException(&quot;Failed to update the organization!&quot;, e);</span>
<span class="nc" id="L694">		} catch (RemoteException e) {</span>
<span class="nc" id="L695">			CAT.error(COMMUNICATION_FAULT_UPDATE_OR_MATCH, e);</span>
<span class="nc" id="L696">			throw new ServiceApplicationException(COMMUNICATION_FAULT_UPDATE_OR_MATCH, e);</span>
<span class="nc" id="L697">		} catch (RuntimeException e) {</span>
<span class="nc" id="L698">			CAT.error(&quot;Failed to update the organization due to Runtime Exception&quot;, e);</span>
<span class="nc" id="L699">			throw new ServiceApplicationException(&quot;Failed to update the organization due to Runtime Exception&quot;, e);</span>
<span class="nc" id="L700">		} catch (Exception any) {</span>
<span class="nc" id="L701">			CAT.error(&quot;failed to Create/Update Organization!&quot;, any);</span>
<span class="nc" id="L702">			throw new ServiceApplicationException(any);</span>
<span class="nc" id="L703">		}</span>
<span class="nc" id="L704">	}</span>

	private void updateOrganizationMapDBEntry(SystemType systemType, OrganizationWithWeekWrapper organizationWrapper)
			throws JdmoException, MultiUserException, BbmUpdateException, RemoteException {
<span class="nc bnc" id="L708" title="All 2 branches missed.">		if (organizationWrapper.getOrgExternalID() != null) {</span>
			//We could possibly eliminate this call by using organizationImportProcessData.getOrgIDToExternalIDMap
<span class="nc" id="L710">			ID wfoOrgId = getMapUtilWrapper().getExternalToWfoID(</span>
					systemType,
					MapUtil.ObjectType.Organization,
<span class="nc" id="L713">					organizationWrapper.getOrgExternalID());</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">			if (wfoOrgId == null) {</span>
				// Update organization map with external id
<span class="nc" id="L716">				getWorkResourceManager().matchOrganizationWithExternalID(</span>
<span class="nc" id="L717">						organizationWrapper.getOrganization(),</span>
						systemType,
<span class="nc" id="L719">						organizationWrapper.getOrgExternalID());</span>
			}
		}
<span class="nc" id="L722">	}</span>

	public List&lt;Boolean&gt; areSaved(List&lt;OrganizationExternalKey&gt; organizationKeys, String systemTypeName)
			throws ServiceApplicationException {

<span class="nc" id="L727">		SystemType systemType = SystemType.valueOf(systemTypeName);</span>

<span class="nc" id="L729">		List&lt;Boolean&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L730" title="All 4 branches missed.">		if (organizationKeys == null || organizationKeys.isEmpty()) {</span>
<span class="nc" id="L731">			CAT.debug(&quot;No organizations to check&quot;);</span>
<span class="nc" id="L732">			return result;</span>
		}

		//This first call is just to load the organizations into the cache
<span class="nc" id="L736">		getSyncUtil().getOrganizationIDByNameCaseInsensitive(&quot;&quot;, getWorkResourceManager(), true);</span>

<span class="nc bnc" id="L738" title="All 2 branches missed.">		for(OrganizationExternalKey org : organizationKeys) {</span>
<span class="nc" id="L739">			result.add(isExistingOrganization(systemType, org));</span>
<span class="nc" id="L740">		}</span>
<span class="nc" id="L741">		return result;</span>
	}

	private boolean isExistingOrganization(SystemType systemType, OrganizationExternalKey org) throws ServiceApplicationException {
<span class="nc bnc" id="L745" title="All 2 branches missed.">		return getLocalID(org, systemType.name()) != null;</span>
	}

	public String doTheseExist(List&lt;OrganizationExternalKey&gt; organizationKeys, String systemTypeName)
			throws ServiceApplicationException {
<span class="nc bnc" id="L750" title="All 4 branches missed.">		if (organizationKeys == null || organizationKeys.isEmpty()) {</span>
<span class="nc" id="L751">			CAT.debug(&quot;No organizations to check&quot;);</span>
<span class="nc" id="L752">			return &quot;&quot;;</span>
		}

		//This first call is just to load the organizations into the cache
<span class="nc" id="L756">		getSyncUtil().getOrganizationIDByNameCaseInsensitive(&quot;&quot;, getWorkResourceManager(), true);</span>
<span class="nc" id="L757">		StringBuilder preResult = new StringBuilder();</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">		for (OrganizationExternalKey org : organizationKeys) {</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">			if (getLocalID(org, systemTypeName) != null) {</span>
<span class="nc" id="L760">				preResult.append(1);</span>
			} else {
<span class="nc" id="L762">				preResult.append(0);</span>
			}
<span class="nc" id="L764">		}</span>
<span class="nc" id="L765">		return preResult.toString();</span>
	}

	private ID getLocalID(OrganizationExternalKey externalKey, String systemTypeName) throws ServiceApplicationException {
<span class="nc" id="L769">		String extId = externalKey.externalId;</span>
<span class="nc" id="L770">		String orgName = externalKey.name;</span>
<span class="nc" id="L771">		SystemType systemType = SystemType.valueOf(systemTypeName);</span>

		ID localId;
<span class="nc" id="L774">		ID orgExternalId = ExternalIDUtil.buildExternalID(systemType, extId);</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">		if (orgExternalId != null) {</span>
//			Looks up the Organization ID from the external ID. Looks in the following order:
//				Coherence cache by org name
//				SyncUtil's static map (which we are considering removing) but clears it if we can't find the external id in the DB.
			try {
<span class="nc" id="L780">				localId = getMapUtilWrapper().getExternalToWfoID(systemType, MapUtil.ObjectType.Organization, orgExternalId);</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">				if (localId == null) {</span>
<span class="nc" id="L782">					localId = getSyncUtil().getOrganizationIDByNameCaseInsensitive(orgName, getWorkResourceManager(), false);</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">					if (localId != null) {</span>
<span class="nc" id="L784">						ID wfoExtId = getMapUtilWrapper().getWfoToExternalID(systemType, MapUtil.ObjectType.Organization, localId, null);</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">						if (wfoExtId != null) {</span>
<span class="nc" id="L786">							localId = null;</span>
						}
					}
				}
<span class="nc" id="L790">			} catch (JdmoException e) {</span>
<span class="nc" id="L791">				throw new ServiceApplicationException(e);</span>
<span class="nc" id="L792">			}</span>
		} else {
//			look up in Coherence cache by org name
			//Branch Forecasting versions prior to 15.2 HFR 2 did not provide external ids for non-leaf orgs (aka groupers).
<span class="nc" id="L796">			localId = getSyncUtil().getOrganizationIDByNameCaseInsensitive(orgName, getWorkResourceManager(), false);</span>
		}
<span class="nc" id="L798">		return localId;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>