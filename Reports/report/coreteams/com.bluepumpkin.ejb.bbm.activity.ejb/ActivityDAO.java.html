<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.activity.ejb</a> &gt; <span class="el_source">ActivityDAO.java</span></div><h1>ActivityDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.activity.ejb;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.Filter.Filter;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFieldInfo;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilterDAO;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityProperties;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.witness.ejb.core.licensing.LicenseKeys;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Set;

public class ActivityDAO extends DAOBase&lt;Activity&gt; {

	private static final int OUTBOUND_ACTIVITY_ID = -4138;
	private static final int DEFERRED_ACTIVITY_ID = -4102;
	private static final int BLENDED_ACTIVITY_ID = -4103;
	private static final String AND = &quot; AND &quot;;
<span class="fc" id="L34">	private static final FieldInfo activityFieldInfo = new ActivityFieldInfo();</span>

	public ActivityDAO() {
<span class="fc" id="L37">		super();</span>
<span class="fc" id="L38">	}</span>

	public ActivityDAO(Jdmo dmo) {
<span class="fc" id="L41">		super(dmo);</span>
<span class="fc" id="L42">	}</span>

	@Override
	public FieldInfo getFieldInfo() {
<span class="fc" id="L46">		return activityFieldInfo;</span>
	}

	@Override
	protected Activity createValueObject() {
<span class="fc" id="L51">		return new Activity();</span>
	}

	protected Collection findActivities(Collection&lt;ID&gt; ids) throws BbmFinderException {
		try {
<span class="nc" id="L56">			return checkLicense(getObjects(&quot;A.ID in &quot; + m_dmo.createInClause(ids)));</span>
<span class="nc" id="L57">		} catch (JdmoException e) {</span>
<span class="nc" id="L58">			throw new BbmFinderException(e);</span>
		}
	}

	// find organization (and its parents) activities
	protected Collection&lt;Activity&gt; findOrganizationActivities(Collection&lt;ID&gt; organizationIdCol, ActivityFilter activityFilter) throws 
		BbmFinderException {
<span class="nc" id="L65">		Collection&lt;ID&gt; parentOrgs = DAOUtil.getParentOrganizationsCollection(organizationIdCol, m_dmo);</span>
<span class="nc" id="L66">		parentOrgs.addAll(organizationIdCol);</span>
<span class="nc" id="L67">		return findOrganizationActivities(parentOrgs, activityFilter, false);</span>
	}


	private static String replaceFieldWithCase(String selectStatement, String fieldName) {
<span class="fc" id="L72">		String replacement = String.format(&quot;case when ACTIVITYCATEGORY.%s &gt; 0 then ACTIVITYCATEGORY.%s	else A.%s end as %s&quot;, fieldName, </span>
			fieldName, fieldName, fieldName);
<span class="fc" id="L74">		return selectStatement.replace(&quot;A.&quot; + fieldName, replacement);</span>
	}

	private Set&lt;ID&gt; getAllOrgIds(Collection&lt;ID&gt; orgIds, boolean findParentOrgs) {
<span class="fc" id="L78">		HashSet&lt;ID&gt; allOrgs = new HashSet&lt;&gt;(orgIds);</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">		if (findParentOrgs) {</span>
<span class="fc" id="L80">			HashSet&lt;ID&gt; parentOrgs = DAOUtil.getParentOrganizationsCollection(orgIds, m_dmo);</span>
<span class="fc" id="L81">			allOrgs.addAll(parentOrgs);</span>
		}
<span class="fc" id="L83">		return allOrgs;</span>
	}


	/**
	 * Similar to findOrganizationActivities, but findOrganizationActivitiesCheckCategory
	 * also checks for the values of fields ISDELETED and ISTIMEOFFWITHALLOTMENT
	 * in the ActivityCategory table in addition to the values in Activity table.
	 * This is needed since a value of  ISTIMEOFFWITHALLOTMENT = 1 in the ActivityCategory table
	 * implies that all activities that have this category will also have a value of 1.
	 *
	 * @param orgIds         orgIds orgIds
	 * @param activityFilter activityFilter
	 * @param findParentOrgs findParentOrgs
	 * @return Collection&lt;Activity&gt;
	 * @throws BbmFinderException BbmFinderException
	 */
	protected Collection&lt;Activity&gt; findOrganizationActivitiesCheckCategory(Collection&lt;ID&gt; orgIds, ActivityFilter activityFilter, boolean 
		findParentOrgs) throws BbmFinderException {
		try {
<span class="fc" id="L103">			String fullSql = getOrganizationActivitiesSql(orgIds, activityFilter, findParentOrgs, ActivityProperties.FLEX_TIME_INVALID);</span>
<span class="fc" id="L104">			return checkLicense(getObjectsGivenFullSqlQueryStr(fullSql));</span>
<span class="nc" id="L105">		} catch (JdmoException e) {</span>
<span class="nc" id="L106">			throw new BbmFinderException(e);</span>
		}

	}

	/**
	 * This method appends all the possible conditions to attain the final sql that would return the org related categories.
	 * Major change from previous version of this method is to filter flex and time off activities based on FLEXTIMEOFF value
	 *
	 * @param orgIds         orgIds
	 * @param activityFilter activityFilter
	 * @param findParentOrgs findParentOrgs
	 * @param flexType       flexType
	 * @return String
	 * @throws JdmoException JdmoException
	 */
	private String getOrganizationActivitiesSql(Collection&lt;ID&gt; orgIds, ActivityFilter activityFilter, boolean findParentOrgs, int 
		flexType) throws JdmoException {

<span class="fc" id="L125">		Set&lt;ID&gt; allOrgs = getAllOrgIds(orgIds, findParentOrgs);</span>
		//Select field1,field2...
<span class="fc" id="L127">		StringBuffer selectFieldBuffer = getSelectStatement();</span>
<span class="fc" id="L128">		appendSystemFieldsToSelect(selectFieldBuffer);</span>

		//replace fields that need to be checked against ACTIVITYCATEGORY with case statements
<span class="fc" id="L131">		String selectFields = selectFieldBuffer.toString();</span>
<span class="fc" id="L132">		selectFields = replaceFieldWithCase(selectFields, &quot;ISDELETED&quot;);</span>
<span class="fc" id="L133">		selectFields = replaceFieldWithCase(selectFields, &quot;ISTIMEOFFWITHALLOTMENT&quot;);</span>

<span class="fc" id="L135">		StringBuilder whereAndOrder = new StringBuilder();</span>
<span class="fc" id="L136">		whereAndOrder.append(&quot;Where A.ORGANIZATIONID IN &quot;).append(m_dmo.createInClause(allOrgs));</span>

<span class="fc" id="L138">		String strFilter = getFilterStr(activityFilter);</span>

<span class="pc bpc" id="L140" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(strFilter)) {</span>
<span class="fc" id="L141">			whereAndOrder.append(AND).append(strFilter);</span>
		}

		//filtering flex and TO request types
<span class="fc" id="L145">		checkFlexType(flexType, whereAndOrder);</span>

<span class="fc" id="L147">		String orderBy = getDefaultOrderByStatement();</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">		if (!StringUtil.isEmpty(orderBy)) {</span>
<span class="fc" id="L149">			whereAndOrder.append(&quot; &quot;).append(orderBy);</span>
		}

<span class="fc" id="L152">		return String.format(&quot;Select A.* from ( %s  FROM ACTIVITY A  inner join ACTIVITYCATEGORY  on ACTIVITYCATEGORY.ID = A&quot; + &quot;&quot; + &quot;&quot; + </span>
			&quot;.ACTIVITYCATEGORYID ) A %s &quot;, selectFields, whereAndOrder);
	}

	/**
	 * This method is used for appending the where clause with the condition on FLEXTIMEOFF column
	 * Based on whether the request is for pulling flex acitivites or time off activities
	 * Possible valid values are: 1=flex, 0=TimeOff and Activity.FLEX_TIME_INVALID = do nothing
	 *
	 * @param flexType      flexType
	 * @param whereAndOrder whereAndOrder
	 */
	private void checkFlexType(int flexType, StringBuilder whereAndOrder) {
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">		if (ActivityProperties.FLEX_TIME_INVALID != flexType) {</span>
<span class="nc" id="L166">			whereAndOrder.append(AND);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">			if (ActivityProperties.TIME_OFF_TIME == flexType) {</span>
<span class="nc" id="L168">				whereAndOrder.append(&quot;NOT &quot;);</span>
			}
<span class="nc" id="L170">			whereAndOrder.append(&quot;EXISTS (SELECT 1 FROM ACTIVITYPROPERTIES WHERE FLEXTIMEOFF = 1 AND ID = A.ID ) &quot;);</span>
		}
<span class="fc" id="L172">	}</span>

	/**
	 * Similar to findOrganizationActivities, but findOrganizationActivitiesCheckCategory
	 * also checks for the values of fields ISDELETED and ISTIMEOFFWITHALLOTMENT
	 * in the ActivityCategory table in addition to the values in Activity table.
	 * This is needed since a value of  ISTIMEOFFWITHALLOTMENT = 1 in the ActivityCategory table
	 * implies that all activities that have this category will also have a value of 1.
	 *
	 * @param orgIds         orgIds
	 * @param activityFilter activityFilter
	 * @param findParentOrgs findParentOrgs
	 * @param flexType       flexType
	 * @return Collection&lt;Activity&gt;
	 * @throws BbmFinderException BbmFinderException
	 */
	protected Collection&lt;Activity&gt; findOrganizationActivitiesCheckCategory(Collection&lt;ID&gt; orgIds, ActivityFilter activityFilter, boolean 
		findParentOrgs, int flexType) throws BbmFinderException {
		try {
<span class="nc" id="L191">			String fullSql = getOrganizationActivitiesSql(orgIds, activityFilter, findParentOrgs, flexType);</span>
<span class="nc" id="L192">			return checkLicense(getObjectsGivenFullSqlQueryStr(fullSql));</span>
<span class="nc" id="L193">		} catch (JdmoException e) {</span>
<span class="nc" id="L194">			throw new BbmFinderException(e);</span>
		}

	}

	protected Collection&lt;Activity&gt; findOrganizationActivities(Collection&lt;ID&gt; orgIds, ActivityFilter activityFilter, boolean 
		findParentOrgs) throws BbmFinderException {
<span class="fc" id="L201">		Set&lt;ID&gt; allOrgs = getAllOrgIds(orgIds, findParentOrgs);</span>
<span class="fc" id="L202">		StringBuilder strWhere = new StringBuilder();</span>
		try {
<span class="fc" id="L204">			strWhere.append(getOrganizationInClause(allOrgs));</span>
<span class="fc" id="L205">			String strFilter = getFilterStr(activityFilter);</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">			if (!StringUtil.isEmpty(strFilter)) {</span>
<span class="fc" id="L207">				strWhere.append(AND).append(strFilter);</span>
			}
<span class="fc" id="L209">			return checkLicense(getObjects(strWhere.toString(), getDefaultOrderByStatement()));</span>
<span class="nc" id="L210">		} catch (JdmoException e) {</span>
<span class="nc" id="L211">			throw new BbmFinderException(e);</span>
		}
	}

	private String getOrganizationInClause(Collection&lt;ID&gt; organizationIds) throws JdmoException {
<span class="fc" id="L216">		return &quot;A.ORGANIZATIONID IN &quot; + m_dmo.createInClause(organizationIds);</span>
	}

	protected Collection&lt;Activity&gt; findOrganizationActivities(Collection&lt;ID&gt; orgIds, ActivityFilter activityFilter, boolean 
		findParentOrgs, int flexType) throws BbmFinderException {
<span class="nc" id="L221">		Set&lt;ID&gt; allOrgs = getAllOrgIds(orgIds, findParentOrgs);</span>
<span class="nc" id="L222">		StringBuilder strWhere = new StringBuilder();</span>
		try {
<span class="nc" id="L224">			strWhere.append(getOrganizationInClause(allOrgs));</span>
<span class="nc" id="L225">			String strFilter = getFilterStr(activityFilter);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">			if (!StringUtil.isEmpty(strFilter)) {</span>
<span class="nc" id="L227">				strWhere.append(AND).append(strFilter);</span>
			}

			//filtering flex and TO request types
<span class="nc" id="L231">			checkFlexType(flexType, strWhere);</span>

<span class="nc" id="L233">			return checkLicense(getObjects(strWhere.toString(), getDefaultOrderByStatement()));</span>
<span class="nc" id="L234">		} catch (JdmoException e) {</span>
<span class="nc" id="L235">			throw new BbmFinderException(e);</span>
		}
	}

	protected Collection findOrganizationActivitiesByCategory(Collection&lt;ID&gt; organizationIdCol, ID activityCategoryId, ActivityFilter 
		activityFilter) throws BbmFinderException {
<span class="nc" id="L241">		activityFilter.setActivityCategoryId(activityCategoryId, Filter.OP_EQUAL);</span>
<span class="nc" id="L242">		return findOrganizationActivities(organizationIdCol, activityFilter);</span>
	}

	protected Collection&lt;Activity&gt; findActivities(ActivityFilter activityFilter) throws BbmFinderException {
<span class="fc" id="L246">		return checkLicense(getObjects(getFilterStr(activityFilter), getDefaultOrderByStatement()));</span>
	}

	protected Collection&lt;ID&gt; findActivitiesIds(ActivityFilter activityFilter) throws BbmFinderException {
		try {
<span class="nc" id="L251">			StringBuffer sqlQuery = new StringBuffer();</span>
<span class="nc" id="L252">			sqlQuery.append(&quot;SELECT &quot;).append(&quot;A.&quot;).append(activityFieldInfo.getFieldName(ActivityFieldInfo.ACTIVITY_ID));</span>
<span class="nc" id="L253">			appendFromWhereStatement(sqlQuery);</span>
<span class="nc" id="L254">			String filterStr = getFilterStr(activityFilter);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">			if (!StringUtil.isEmpty(filterStr)) {</span>
<span class="nc" id="L256">				sqlQuery.append(&quot;WHERE &quot;).append(filterStr);</span>
			}

<span class="nc" id="L259">			return fetchActivitiesIds(sqlQuery.toString());</span>
<span class="nc" id="L260">		} catch (Exception e) {</span>
<span class="nc" id="L261">			throw new BbmFinderException(e);</span>
		}
	}

	protected Collection findOrganizationActivitiesIds(ID organizationId, ActivityFilter activityFilter) throws BbmFinderException {
		try {
			// create the sql statement
<span class="nc" id="L268">			StringBuffer sqlQuery = new StringBuffer();</span>
<span class="nc" id="L269">			sqlQuery.append(&quot;SELECT &quot;).append(&quot;A.&quot;).append(activityFieldInfo.getFieldName(ActivityFieldInfo.ACTIVITY_ID));</span>
<span class="nc" id="L270">			appendFromWhereStatement(sqlQuery);</span>
			// where clause
<span class="nc" id="L272">			sqlQuery.append(&quot;WHERE &quot;);</span>
<span class="nc" id="L273">			Collection parentOrgs = DAOUtil.getParentOrganizationsCollection(organizationId, m_dmo);</span>
<span class="nc" id="L274">			parentOrgs.add(organizationId);</span>
<span class="nc" id="L275">			sqlQuery.append(getOrganizationInClause(parentOrgs));</span>
<span class="nc" id="L276">			String strFilter = getFilterStr(activityFilter);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">			if (!StringUtil.isEmpty(strFilter)) {</span>
<span class="nc" id="L278">				sqlQuery.append(AND).append(strFilter);</span>
			}

			// fetch the data
<span class="nc" id="L282">			return fetchActivitiesIds(sqlQuery.toString());</span>
<span class="nc" id="L283">		} catch (Exception e) {</span>
<span class="nc" id="L284">			throw new BbmFinderException(e);</span>
		}
	}

	private Collection&lt;ID&gt; fetchActivitiesIds(String sqlQuery) throws JdmoException, BbmFinderException {
		// fetch the data
<span class="nc" id="L290">		ArrayList&lt;ID&gt; activityIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L291">		JdmoRowset rs = m_dmo.createRowset(sqlQuery);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L293">			ID id = rs.getID(activityFieldInfo.getFieldName(ActivityFieldInfo.ACTIVITY_ID));</span>
<span class="nc" id="L294">			activityIds.add(id);</span>
<span class="nc" id="L295">		}</span>
<span class="nc" id="L296">		return checkLicense(activityIds);</span>
	}

	private String getDefaultOrderByStatement() {
<span class="fc" id="L300">		return &quot; ORDER BY A.&quot; + activityFieldInfo.getFieldName(ActivityFieldInfo.ACTIVITY_NAME) + &quot; ASC &quot;;</span>
	}

	private String getFilterStr(ActivityFilter activityFilter) {
<span class="fc bfc" id="L304" title="All 2 branches covered.">		if (activityFilter != null) {</span>
<span class="fc" id="L305">			ActivityFilterDAO activityFilterDAO = new ActivityFilterDAO(activityFilter);</span>
<span class="fc" id="L306">			String strFilter = new String(activityFilterDAO.getFilterText());</span>
<span class="fc" id="L307">			strFilter = strFilter.trim();</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">			if (strFilter.length() &gt; 0) {</span>
<span class="fc" id="L309">				return strFilter;</span>
			}
		}
<span class="fc" id="L312">		return &quot;&quot;;</span>
	}

	public Collection getAllNonSeedActivities() throws BbmFinderException {
<span class="nc" id="L316">		return getObjects(&quot; ID not like '-%'&quot;);</span>
	}
	
	private &lt;T&gt; Collection&lt;T&gt; checkLicense(Collection&lt;T&gt; col) throws BbmFinderException {
<span class="fc" id="L320">		boolean hasOutboundLicense = ActivityMediaDAO.checkLicense(LicenseKeys.APP_MEDIA_OUTBOUND);</span>
<span class="fc" id="L321">		boolean hasMultiSideLicense = ActivityMediaDAO.checkLicense(LicenseKeys.APP_MULTIMEDIA);</span>
<span class="fc" id="L322">		boolean hasDeskTopLicense = ActivityMediaDAO.checkLicense(LicenseKeys.APP_DESKTOPMONITORING);</span>

<span class="pc bpc" id="L324" title="3 of 6 branches missed.">		if (hasOutboundLicense &amp;&amp; hasMultiSideLicense &amp;&amp; hasDeskTopLicense) {</span>
<span class="nc" id="L325">			return col;</span>
		}
<span class="fc bfc" id="L327" title="All 2 branches covered.">		for (Iterator&lt;T&gt; i = col.iterator(); i.hasNext(); ) {</span>
<span class="fc" id="L328">			Object obj = i.next();</span>
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">			if (!hasOutboundLicense) {</span>
<span class="nc bnc" id="L330" title="All 4 branches missed.">				if (obj instanceof ID &amp;&amp; ((ID) obj).toInt() == OUTBOUND_ACTIVITY_ID) {</span>
<span class="nc" id="L331">					i.remove();</span>
<span class="nc" id="L332">					continue;</span>
				}
<span class="nc bnc" id="L334" title="All 4 branches missed.">				if (obj instanceof Activity &amp;&amp; ((Activity) obj).getID().toInt() == OUTBOUND_ACTIVITY_ID) {</span>
<span class="nc" id="L335">					i.remove();</span>
<span class="nc" id="L336">					continue;</span>
				}
			}
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">			if (!hasMultiSideLicense) {</span>
<span class="nc bnc" id="L340" title="All 6 branches missed.">				if (obj instanceof ID &amp;&amp; (((ID) obj).toInt() == DEFERRED_ACTIVITY_ID || ((ID) obj).toInt() == BLENDED_ACTIVITY_ID)) {</span>
<span class="nc" id="L341">					i.remove();</span>
<span class="nc" id="L342">					continue;</span>
				}
<span class="nc bnc" id="L344" title="All 4 branches missed.">				if (obj instanceof Activity &amp;&amp; (((Activity) obj).getID().toInt() == DEFERRED_ACTIVITY_ID || ((Activity) obj).getID().toInt</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">					() == BLENDED_ACTIVITY_ID)) {</span>
<span class="nc" id="L346">					i.remove();</span>
<span class="nc" id="L347">					continue;</span>
				}
			}
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">			if (!hasDeskTopLicense) {</span>
<span class="fc" id="L351">				ID id = null;</span>
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">				if (obj instanceof ID) {</span>
<span class="nc" id="L353">					id = (ID) obj;</span>
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">				} else if (obj instanceof Activity) {</span>
<span class="fc" id="L355">					id = ((Activity) obj).getID();</span>
				}

				//id from -4140 to -4165 are desktop activities
<span class="fc bfc" id="L359" title="All 2 branches covered.">				if (isDesktopActivity(id)) {</span>
<span class="fc" id="L360">					i.remove();</span>
				}
			}
<span class="fc" id="L363">		}</span>
<span class="fc" id="L364">		return col;</span>
	}

	private boolean isDesktopActivity(ID id) {
<span class="pc bpc" id="L368" title="1 of 6 branches missed.">		return id != null &amp;&amp; id.toInt() &lt;= -4140 &amp;&amp; id.toInt() &gt;= -4164;</span>
	}

	protected Collection&lt;ID&gt; getDailyPoolAllotmentActivityIDs(boolean checkTimeOffWithAllotment) throws BbmFinderException {
		try {
<span class="nc" id="L373">			String sql = &quot;select A.ID from ACTIVITY A inner join ACTIVITYPROPERTIES AP on AP.ID = A.ID where AP.USEDAILYTOPOOL = 1 &quot;;</span>

<span class="nc bnc" id="L375" title="All 2 branches missed.">			if (checkTimeOffWithAllotment) {</span>
<span class="nc" id="L376">				sql += &quot; AND ISTIMEOFFWITHALLOTMENT = 1&quot;;</span>
			}
<span class="nc" id="L378">			return fetchActivitiesIds(sql);</span>
<span class="nc" id="L379">		} catch (Exception e) {</span>
<span class="nc" id="L380">			throw new BbmFinderException(e);</span>
		}
	}

	public ID getActivityIdByName(String name) throws JdmoException {
<span class="nc" id="L385">		String sql = &quot;SELECT ID FROM ACTIVITY WHERE NAME = ?&quot;;</span>
<span class="nc" id="L386">		JdmoQuery query = m_dmo.createQuery(sql, Jdmo.PARAM_QUERY);</span>
<span class="nc" id="L387">		query.setParString(1, name);</span>
<span class="nc" id="L388">		JdmoRowset rowSet = m_dmo.createRowset(query, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>
<span class="nc" id="L389">		ID activityId = null;</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">		if (rowSet.next()) {</span>
<span class="nc" id="L391">			activityId = rowSet.getID(1);</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">			if (rowSet.next()) {</span>
<span class="nc" id="L393">				throw new JdmoException(&quot;Found multiple activities with name [&quot; + name + &quot;]&quot;);</span>
			}
		}
<span class="nc" id="L396">		return activityId;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>