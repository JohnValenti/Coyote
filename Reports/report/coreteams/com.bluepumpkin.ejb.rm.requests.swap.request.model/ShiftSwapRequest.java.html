<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftSwapRequest.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.swap.request.model</a> &gt; <span class="el_source">ShiftSwapRequest.java</span></div><h1>ShiftSwapRequest.java</h1><pre class="source lang-java linenums">/*
 * ShiftSwapRequest.java
 *
 * Copyright (c) 2002, Blue Pumpkin Software, Inc.
 * All rights reserved.
 */
package com.bluepumpkin.ejb.rm.requests.swap.request.model;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.Iterator;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestDetailLevel;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationCache;
import com.bluepumpkin.ejb.rm.requests.swap.request.validation.ShiftSwapValidationCache;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.requests.swap.withdraw.model.ShiftSwapWithdraw;


/**
 * Class represents ShiftSwapRequests.
 *
 * A shift swap request is associated with 2 or more {@link ShiftSwapItem shift swap items}.
 * The swap happens linearly,  ie. first shift in the list is handed off to
 * the 2nd employee, the 2nd shift to the 3rd employee and so on.  For this n-person swap:
 * &lt;li&gt; items is an ordered list item(0) ... item(N-1)
 * &lt;li&gt; item(A) gives its shift to item((A+1)modN)
 * &lt;li&gt; item(A) receives its new shift from item((A+N-1)modN)
 * &lt;li&gt; min/max hours not violated for either employee
 *
 */
public class ShiftSwapRequest extends RequestAggregate {
    public static final String SHIFTSWAP_TYPE_ONEWAY = &quot;one-way&quot;;
    public static final String SHIFTSWAP_TYPE_TWOWAY = &quot;two-way&quot;;

    private static final long serialVersionUID = 6909127108854014755L;

<span class="nc" id="L48">    private static final FieldInfo m_fieldInfo = new ShiftSwapRequestFieldInfo();</span>

    public static final long DL_SHIFTSWAP_ITEMS = RequestDetailLevel.DL_SHIFTSWAP_ITEMS;
	public static final long DL_SHIFTSWAP_WITHDRAW = RequestDetailLevel.DL_SHIFTSWAP_WITHDRAW;
	public static final int OVERLAP_HASH = -1;

<span class="nc" id="L54">    private transient ValidationCache m_validationCache = null;</span>
    private transient ShiftSwapWithdraw m_ShiftSwapWithdrawCache;

<span class="nc" id="L57">	private boolean m_updateAllShiftSwapItems = false;</span>

	// we do not want to serialize this
<span class="nc" id="L60">    private transient List&lt;ShiftSwapItem&gt; m_cachedSSItems = null;</span>

    // not necessary to be serialized.
<span class="nc" id="L63">	private transient List&lt;Pair&lt;ID, TimeRange&gt;&gt; m_cachedEmpIDTimeRangePairs = null;</span>

    public static long getDetailLevelForValidation()   {
<span class="nc" id="L66">        return DL_BASIC | DL_SHIFTSWAP_ITEMS;</span>
    }

    public ShiftSwapRequest(long detailLevel) {
<span class="nc" id="L70">        super(Request.REQUESTTYPE_SHIFTSWAP, detailLevel);</span>
<span class="nc" id="L71">    }</span>

    //getters
    @Override
	public FieldInfo getFieldInfo() {
<span class="nc" id="L76">        return m_fieldInfo;</span>
    }

    /*
    public void setShiftSwapItem(ShiftSwapItem ssItem)
    {
        ShiftSwapRequestItem ssrItem = new ShiftSwapRequestItem(ssItem, 1);
        createChildObject(ShiftSwapRequestFieldInfo.REQUESTITEM_CHILD_TYPE,  ssrItem);
    }
     */

	/*
	 *  flag all existing shift swap items for udpate during the next
	 *  request update
	 *  &lt;p&gt;
	 *  In the current implementation, the existing set of SSItems never have to
	 *  be replaced with new set.  So there is no use for this method.
	 */
	public void setUpdateAllShiftSwapItems(boolean update) {
<span class="nc" id="L95">		m_updateAllShiftSwapItems = update;</span>
<span class="nc" id="L96">	}</span>

	/*
	 *  flag all existing shift swap items for udpate during the next
	 *  request update
	 *  &lt;p&gt;
	 *  In the current implementation, the existing set of SSItems never have to
	 *  be replaced with new set.  So there is no use for this method.
	 */
	public boolean getUpdateAllShiftSwapItems() {
<span class="nc" id="L106">		return m_updateAllShiftSwapItems;</span>
	}

	/**
	 * If shift swap items hash is set to OVERLAP_HASH value, then overlap exists after approval.
	 * Overlap means that a requested shift swap overlaps an existing shift or the receiver
	 * @return is overlap request
	 */
    public boolean isOverlap() {
<span class="nc bnc" id="L115" title="All 2 branches missed.">    	for(ShiftSwapItem i:getShiftSwapItems()){</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">    		if (i.getHashCode()==OVERLAP_HASH){</span>
<span class="nc" id="L117">    			return true;</span>
    		}
<span class="nc" id="L119">    	}</span>
<span class="nc" id="L120">		return false;</span>
	}

	/**
	 * Finds the shift swap item associated with this request that
     * matches the given shift swap item. Used by the unit test code.
	 *
	 * @param ssItem
	 * @return
	 */
	public ShiftSwapItem getShiftSwapItem(ShiftSwapItem givenSSItem)
	{
<span class="nc" id="L132">		List swapItems = getShiftSwapItems();</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">		for (int i=0; i &lt; swapItems.size(); i++) {</span>
<span class="nc" id="L134">			ShiftSwapItem curItem = (ShiftSwapItem) swapItems.get(i);</span>

<span class="nc bnc" id="L136" title="All 2 branches missed.">			if (curItem.getEmployeeID().equals(givenSSItem.getEmployeeID()) &amp;&amp;</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">				curItem.getStartDate().equals(givenSSItem.getStartDate()) &amp;&amp;</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">				curItem.getEndDate().equals(givenSSItem.getEndDate()) &amp;&amp;</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">				curItem.getShiftType().equals(givenSSItem.getShiftType()))</span>
			{
<span class="nc" id="L141">				return curItem;</span>
			}
		}

<span class="nc" id="L145">		return null;</span>
	}


    public Collection getShiftSwapRequestItems() {
<span class="nc" id="L150">        return getChildObjects(ShiftSwapRequestFieldInfo.REQUESTITEM_CHILD_TYPE);</span>
    }

	//TODO: ordered list for TORequest as well.
    public List&lt;ShiftSwapItem&gt; getShiftSwapItems() {
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (m_cachedSSItems == null)  {</span>
<span class="nc" id="L156">            m_cachedSSItems = new ArrayList&lt;ShiftSwapItem&gt;();</span>

        	// get the shift swap request items.
<span class="nc" id="L159">            Collection ssReqItems = getShiftSwapRequestItems();</span>

            // then obtain the shift swap items from the shift swap request items.
<span class="nc bnc" id="L162" title="All 2 branches missed.">            for (Iterator itr = ssReqItems.iterator(); itr.hasNext(); ) {</span>
<span class="nc" id="L163">            	ShiftSwapRequestItem ssReqItem = (ShiftSwapRequestItem) itr.next();</span>

<span class="nc" id="L165">            	int itemOrder = ssReqItem.getShiftSwapItemOrder();</span>
<span class="nc bnc" id="L166" title="All 4 branches missed.">            	if (itemOrder != 0 &amp;&amp; itemOrder != 1) {</span>
<span class="nc" id="L167">            		throw new IllegalStateException(&quot;Item Order == &quot; + itemOrder);</span>
            	}

<span class="nc" id="L170">                m_cachedSSItems.add( ssReqItem.getShiftSwapItem() );</span>
<span class="nc" id="L171">            }</span>
        }

<span class="nc" id="L174">        return m_cachedSSItems;</span>
    }

    public ID getFirstEmployeeID() {
        //TODO: cache
<span class="nc" id="L179">        Iterator itr = getChildObjects(ShiftSwapRequestFieldInfo.REQUESTITEM_CHILD_TYPE).iterator();</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if ( itr.hasNext() ) {</span>
<span class="nc" id="L181">            return ((ShiftSwapRequestItem) itr.next()).getShiftSwapItem().getEmployeeID();</span>
        }

<span class="nc" id="L184">        return null;</span>
    }

    public ID getSecondEmployeeID() {
        //TODO: cache
<span class="nc" id="L189">        Iterator itr = getChildObjects(ShiftSwapRequestFieldInfo.REQUESTITEM_CHILD_TYPE).iterator();</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if ( itr.hasNext() ) {</span>
<span class="nc" id="L191">        	itr.next();</span>
        }

<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (itr.hasNext()) {</span>
<span class="nc" id="L195">            return ((ShiftSwapRequestItem) itr.next()).getShiftSwapItem().getEmployeeID();</span>
        }

<span class="nc" id="L198">        return null;</span>
    }

    /**
     * Returns one of the following:
     * {@link #SHIFTSWAP_TYPE_ONEWAY SHIFTSWAP_TYPE_ONEWAY} or {@link #SHIFTSWAP_TYPE_TWOWAY SHIFTSWAP_TYPE_TWOWAY}
     *
     * @return
     */
    public String getSwapType() {
<span class="nc" id="L208">        return this.getFormattedFieldValue(ShiftSwapRequestFieldInfo.SHIFTSWAPREQUEST_S_SWAPTYPE);</span>
    }

    public String getNegotiationComment() {
<span class="nc" id="L212">        return getFormattedFieldValue(ShiftSwapRequestFieldInfo.SHIFTSWAPREQUEST_S_NEGOTIATIONCOMMENT);</span>
    }

	/**
	 * Note:  This returns a collection of employee IDs and not employees.
	 *
	 * @return
	 */
	//TODO: must be renamed to getEmployeeIDs().
    public List&lt;ID&gt; getEmployees() {
<span class="nc" id="L222">        ShiftSwapValidationCache vc = (ShiftSwapValidationCache) getValidationCache();</span>

<span class="nc" id="L224">        return vc.getEmployeeIDsForRequest();</span>
    }

    public ArrayList getStartDates() {
<span class="nc" id="L228">        List items = this.getShiftSwapItems();</span>
<span class="nc" id="L229">        ShiftSwapItem item = null;</span>
<span class="nc" id="L230">        ArrayList dateList = new ArrayList(items.size());</span>

<span class="nc bnc" id="L232" title="All 2 branches missed.">        for (int i = 0; i &lt; items.size(); i++) {</span>
<span class="nc" id="L233">            item = (ShiftSwapItem) items.get(i);</span>
<span class="nc" id="L234">            dateList.add(item.getStartDate());</span>
        }

<span class="nc" id="L237">        return dateList;</span>
    }

    public ArrayList getDisplayStartDates() {
<span class="nc" id="L241">        List items = this.getShiftSwapItems();</span>
<span class="nc" id="L242">        ShiftSwapItem item = null;</span>
<span class="nc" id="L243">        ArrayList dateList = new ArrayList(items.size());</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">        for (int i = 0; i &lt; items.size(); i++) {</span>
<span class="nc" id="L246">            item = (ShiftSwapItem) items.get(i);</span>
<span class="nc" id="L247">            dateList.add(item.getDisplayStartDate());</span>
        }

<span class="nc" id="L250">        return dateList;</span>
    }

    public ArrayList getEndDates() {
<span class="nc" id="L254">        List items = this.getShiftSwapItems();</span>
<span class="nc" id="L255">        ShiftSwapItem item = null;</span>
<span class="nc" id="L256">        ArrayList dateList = new ArrayList(items.size());</span>

<span class="nc bnc" id="L258" title="All 2 branches missed.">        for (int i = 0; i &lt; items.size(); i++) {</span>
<span class="nc" id="L259">            item = (ShiftSwapItem) items.get(i);</span>
<span class="nc" id="L260">            dateList.add(item.getEndDate());</span>
        }

<span class="nc" id="L263">        return dateList;</span>
    }

    /**
     * Returns the expiration date for each shiftSwap item associated with
     * the request.  # of entries == # of shift swap items assoc with the req.
     *
     * @return
     */
    public ArrayList getExpirationDates() {
<span class="nc" id="L273">        List items = this.getShiftSwapItems();</span>
<span class="nc" id="L274">        ShiftSwapItem item = null;</span>
<span class="nc" id="L275">        ArrayList dateList = new ArrayList(items.size());</span>

<span class="nc bnc" id="L277" title="All 2 branches missed.">        for (int i = 0; i &lt; items.size(); i++) {</span>
<span class="nc" id="L278">            item = (ShiftSwapItem) items.get(i);</span>
<span class="nc" id="L279">            dateList.add(item.getExpirationDate());</span>
        }

<span class="nc" id="L282">        return dateList;</span>
    }

    public ArrayList getNegotiations() {
<span class="nc" id="L286">        List items = this.getShiftSwapItems();</span>
<span class="nc" id="L287">        ShiftSwapItem item = null;</span>
<span class="nc" id="L288">        ArrayList booleanList = new ArrayList(items.size());</span>

<span class="nc bnc" id="L290" title="All 2 branches missed.">        for (int i = 0; i &lt; items.size(); i++) {</span>
<span class="nc" id="L291">            item = (ShiftSwapItem) items.get(i);</span>
<span class="nc" id="L292">            booleanList.add(new Boolean(item.getNegotiation()));</span>
        }

<span class="nc" id="L295">        return booleanList;</span>
    }

    public ArrayList getShiftTypes() {
<span class="nc" id="L299">        List items = this.getShiftSwapItems();</span>
<span class="nc" id="L300">        ShiftSwapItem item = null;</span>
<span class="nc" id="L301">        ArrayList shiftList = new ArrayList(items.size());</span>

<span class="nc bnc" id="L303" title="All 2 branches missed.">        for (int i = 0; i &lt; items.size(); i++) {</span>
<span class="nc" id="L304">            item = (ShiftSwapItem) items.get(i);</span>
<span class="nc" id="L305">            shiftList.add(item.getShiftType());</span>
        }

<span class="nc" id="L308">        return shiftList;</span>
    }

   
    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate#getEmpIDTimeRangePairs()
     */
    @Override
	public Collection&lt;Pair&lt;ID, TimeRange&gt;&gt; getEmpIDTimeRangePairs() {
<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (m_cachedEmpIDTimeRangePairs == null)   {</span>
<span class="nc" id="L318">			m_cachedEmpIDTimeRangePairs = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L320">			List&lt;ShiftSwapItem&gt; ssItems = getShiftSwapItems();</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">            for (int i=0; i &lt; ssItems.size(); i++)  {</span>
<span class="nc" id="L322">                ShiftSwapItem ssItem = ssItems.get(i);</span>
<span class="nc" id="L323">				m_cachedEmpIDTimeRangePairs.add(new Pair&lt;ID, TimeRange&gt;(ssItem.getEmployeeID(),</span>
<span class="nc" id="L324">                    new TimeRange(ssItem.getStartDate(), ssItem.getEndDate()) ) );</span>
            }
        }

<span class="nc" id="L328">        return m_cachedEmpIDTimeRangePairs;</span>
    }

    public void setSwapType(String type) {
<span class="nc" id="L332">        setFieldValue(ShiftSwapRequestFieldInfo.SHIFTSWAPREQUEST_S_SWAPTYPE, type);</span>
<span class="nc" id="L333">    }</span>

    public void setShiftSwapItems(List ssItems) {
    	// Unlike TORequests (for which existing TOChoices can be replaced with a new set),
    	// an SSRequest's existing set of SSItems will not be replaced with a new set.
    	// Thus this call to clearAllShiftSwapItems()is not necessary to delete
    	// exisiting SSItems and create new SSItems during a request update.
        //deleteAllChildren(ShiftSwapRequestFieldInfo.REQUESTITEM_CHILD_TYPE); //NOSONAR

<span class="nc bnc" id="L342" title="All 2 branches missed.">        for (int i=0; i &lt; ssItems.size(); i++ ) {</span>
<span class="nc" id="L343">            ShiftSwapRequestItem ssrItem = new ShiftSwapRequestItem(</span>
<span class="nc" id="L344">                            (ShiftSwapItem) ssItems.get(i), i);</span>
<span class="nc" id="L345">            createChildObject(ShiftSwapRequestFieldInfo.REQUESTITEM_CHILD_TYPE, ssrItem);</span>
        }
<span class="nc" id="L347">    }</span>

    public void setNegotiationComment(String comment) {
<span class="nc" id="L350">        setFieldValue(ShiftSwapRequestFieldInfo.SHIFTSWAPREQUEST_S_NEGOTIATIONCOMMENT, comment);</span>
<span class="nc" id="L351">    }</span>

    /**
     * Implements a method from the Validatable interface.
     * @return the ValidationCache associated with this object.
     */
    @Override
	public ValidationCache getValidationCache() {
<span class="nc bnc" id="L359" title="All 2 branches missed.">        if (m_validationCache == null) {</span>
<span class="nc" id="L360">            m_validationCache = new ShiftSwapValidationCache(this);</span>
        }

<span class="nc" id="L363">        return m_validationCache;</span>
    }

    public ShiftSwapValidationCache getCache() {
<span class="nc" id="L367">        return (ShiftSwapValidationCache) getValidationCache();</span>
    }

    /**
     * Implements a method from the Validatable interface.
     * @return a collection of TimeRange objects: one for each shift swap item
     */
    @Override
	public Collection getValidationTimeRanges() {
<span class="nc" id="L376">        Collection result = new ArrayList();</span>

<span class="nc" id="L378">        Collection items = this.getShiftSwapItems();</span>

<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (items != null) {</span>
            ShiftSwapItem item;
            TimeRange range;

<span class="nc bnc" id="L384" title="All 2 branches missed.">            for (Iterator itr = items.iterator(); itr.hasNext();) {</span>
<span class="nc" id="L385">                item = (ShiftSwapItem) itr.next();</span>
<span class="nc" id="L386">                range = new TimeRange(item.getStartDate(), item.getEndDate());</span>
<span class="nc" id="L387">                result.add(range);</span>
            }
        }

<span class="nc" id="L391">        return result;</span>
    }

	public boolean isOneWay() {
<span class="nc" id="L395">		return getSwapType().equals(ShiftSwapRequest.SHIFTSWAP_TYPE_ONEWAY);</span>
	}

	// TODO: refactor SSRequestDAO.deleteAllChildren() and TORequestDAO.deleteAllChildren() methods
	//  for code similar to moveChildrenFromPersistedToUpdated().
	// TODO: Instead of clearAllShiftSwapItems() and setDeleteAllChildFlag(), use method in ValueObjectNode (added by greg).
	public void moveChildrenFromPersistedToUpdated() {
		// get the shift swap request items.
<span class="nc" id="L403">		Collection ssReqItems = getChildObjects(ShiftSwapRequestFieldInfo.REQUESTITEM_CHILD_TYPE);</span>

<span class="nc bnc" id="L405" title="All 4 branches missed.">		if (ssReqItems != null &amp;&amp; !ssReqItems.isEmpty()) {</span>
			//for each SSReqItem
<span class="nc bnc" id="L407" title="All 2 branches missed.">			for (Iterator itr = ssReqItems.iterator(); itr.hasNext(); ) {</span>
<span class="nc" id="L408">				ShiftSwapRequestItem ssReqItem = (ShiftSwapRequestItem) itr.next();</span>

				// move SSItem from persisted to updated list
<span class="nc" id="L411">				ssReqItem.moveChildrenFromPersistedToUpdated();</span>

				// move SSReqItem from persisted to updated list.
<span class="nc" id="L414">				updateChildObject(ShiftSwapRequestFieldInfo.REQUESTITEM_CHILD_TYPE, ssReqItem);</span>
<span class="nc" id="L415">			}</span>

			//clear persisted SSRequestItems associated with this SSRequest
<span class="nc" id="L418">			clearChildObjectMap(ShiftSwapRequestFieldInfo.REQUESTITEM_CHILD_TYPE);</span>
		}

<span class="nc" id="L421">		ShiftSwapWithdraw ssWithdraw = getWithdrawInfo();</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">		if (ssWithdraw!=null){</span>
<span class="nc" id="L423">			updateChildObject(ShiftSwapRequestFieldInfo.SS_WITHDRAW_CHILD_TYPE, ssWithdraw);</span>
<span class="nc" id="L424">			clearChildObjectMap(ShiftSwapRequestFieldInfo.SS_WITHDRAW_CHILD_TYPE);</span>
		}

		//TODO: if caching implemented, invalidate cache.
<span class="nc" id="L428">	}</span>

    /**
     * updates the following expiration dates associated with the request
     * &lt;li&gt; request expiration date.
     * &lt;li&gt; shift swap item expiration date.
     *
     * &lt;p&gt; Request expiration date:
     * &lt;li&gt; If status == negotiation, request expiration date is
     * &lt;code&gt;min( min(shiftswapitem.startTime), max(shiftswapItem.expirationDate)) &lt;/code&gt;
     * considering all shiftSwap items.
     * &lt;li&gt; if status == pending or other states, the request expiration date is
     * &lt;code&gt;min(shiftswapitem.startTime) &lt;/code&gt; taking into account all the shiftswapitems
     *
     * &lt;p&gt; ShiftSwapItemExpiration date:  This cannot be after the request's expiration date.
     *
     */
    public void updateReqAndItemExpirationDates(Collection ssItems) {
<span class="nc bnc" id="L446" title="All 2 branches missed.">        if ( ssItems == null ) {</span>
<span class="nc" id="L447">            ssItems = getShiftSwapItems();</span>
        }

        // Considering all ssItems, earliest date for ssItem.startDate.
        //
        // start with the maximum value.
<span class="nc" id="L453">        Date ssItemStartDateMin = new Date(Long.MAX_VALUE);</span>

        // Considering all ssItems, latest date for ssItem.expirationDate.
        // start with the minimum value
<span class="nc" id="L457">        Date ssItemExpirDateMax = new Date(Long.MIN_VALUE);</span>
        // for each shift swap item
<span class="nc bnc" id="L459" title="All 2 branches missed.">        for (Iterator it = ssItems.iterator(); it.hasNext();) {</span>
<span class="nc" id="L460">            ShiftSwapItem ssItem = (ShiftSwapItem) it.next();</span>
            // if expiration date for the item is not set, use the item's start date.
<span class="nc bnc" id="L462" title="All 2 branches missed.">            if (ssItem.getExpirationDate() == null) {</span>
<span class="nc" id="L463">                ssItem.setExpirationDate(ssItem.getStartDate());</span>
            }

<span class="nc" id="L466">            ssItemStartDateMin = RequestUtil.getEarlierDate(ssItemStartDateMin, ssItem.getStartDate());</span>
            // if status is negotiation, get the max(ssItem.expirationDate).
<span class="nc bnc" id="L468" title="All 2 branches missed.">            if (isNegotiation()) {</span>
<span class="nc" id="L469">                ssItemExpirDateMax = RequestUtil.getLaterDate(ssItemExpirDateMax, ssItem.getExpirationDate());</span>
            }
<span class="nc" id="L471">        }</span>
        // if status is negotiation, also consider max(ssItem.expirationDate).
<span class="nc" id="L473">        Date ssReqExpirDate = null;</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">        if (isNegotiation()) {</span>
<span class="nc" id="L475">            ssReqExpirDate = RequestUtil.getEarlierDate(ssItemStartDateMin, ssItemExpirDateMax);</span>
        } else {
<span class="nc" id="L477">            ssReqExpirDate = ssItemStartDateMin;</span>
        }

        // set the expirationDate
<span class="nc" id="L481">        setExpirationDate(ssReqExpirDate);</span>

        // an item's expiration date cannot be later than the request's expiration date. verify and fix.
<span class="nc bnc" id="L484" title="All 2 branches missed.">        for (Iterator it = ssItems.iterator(); it.hasNext();) {</span>
<span class="nc" id="L485">            ShiftSwapItem item = (ShiftSwapItem) it.next();</span>

<span class="nc bnc" id="L487" title="All 2 branches missed.">            if (item.getExpirationDate().after(ssReqExpirDate)) {</span>
<span class="nc" id="L488">                item.setExpirationDate(ssReqExpirDate);</span>
            }
<span class="nc" id="L490">        }</span>
<span class="nc" id="L491">    }</span>

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate#getRequestSubType()
     */
    @Override
	public ID getRequestSubType() {
        // TODO Auto-generated method stub
<span class="nc" id="L499">        return null;</span>
    }

    /**
     * Obtain the shiftSwapItem which will be received by the specified employee
     * participating in the swap.
     * &lt;p&gt; Note: the received swapItem can either be a 'shift' or 'timeoff'.
     *
     * @param empID
     * @return
     */
    public ShiftSwapItem getShiftSwapItemRcvdByEmpID(ID empID) {
<span class="nc" id="L511">        ShiftSwapItem ssItemRcvd = null;</span>

<span class="nc" id="L513">        List ssItems = getShiftSwapItems();</span>
<span class="nc" id="L514">        int ssItemsSize = ssItems.size();</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">        for (int i = 0; i &lt; ssItemsSize; i++) {</span>
<span class="nc" id="L516">            ShiftSwapItem ssItemGivenUp = (ShiftSwapItem)ssItems.get(i);</span>

<span class="nc" id="L518">            ssItemRcvd = (ShiftSwapItem) ssItems.get( (i - 1 + ssItemsSize) % ssItemsSize );</span>


<span class="nc bnc" id="L521" title="All 2 branches missed.">            if (ssItemGivenUp.getEmployeeID().equals(empID)) {</span>
<span class="nc" id="L522">                break;</span>
            }
        }

<span class="nc" id="L526">        return ssItemRcvd;</span>
    }

	public boolean isEligibleForAcceptAndRejectWithdrawAction() {
<span class="nc bnc" id="L530" title="All 4 branches missed.">		return isEligibleForRejectWithdrawAction() &amp;&amp; isEligibleForAcceptWithdrawAction();</span>
	}

	public boolean isEligibleForRejectWithdrawAction() {
<span class="nc bnc" id="L534" title="All 2 branches missed.">		return getWithdrawInfo() != null &amp;&amp;</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">		        RequestAuditTrail.STATUS_WITHDRAW_REQUEST.equals(getWithdrawInfo().getRequestStatus()) &amp;&amp;</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">		        getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED);</span>
	}

	public boolean isEligibleForAcceptWithdrawAction() {
<span class="nc bnc" id="L540" title="All 2 branches missed.">		return getWithdrawInfo() != null &amp;&amp;</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">		        (RequestAuditTrail.STATUS_WITHDRAW_REQUEST.equals(getWithdrawInfo().getRequestStatus()) ||</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">		        RequestAuditTrail.STATUS_WITHDRAW_REJECT.equals(getWithdrawInfo().getRequestStatus())) &amp;&amp;</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">		        getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED);</span>
	}

	public boolean isApprovedWithdrawStatusInProgress() {
<span class="nc bnc" id="L547" title="All 2 branches missed.">		return getWithdrawInfo() != null &amp;&amp;</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">		        (RequestAuditTrail.SSW_SOFT_VALIDATION_STATES.contains(getWithdrawInfo().getRequestStatus())) &amp;&amp;</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">		        getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED);</span>
	}

	/**
	 * Check if employee is allowed to confirm a withdrawal request made by another employee in the swap
	 * @param employeeID - employee id
	 * @return boolean true - the employee needs to confirm the withdrawal request, false - no withdrawal approval required
	 */
	public boolean isEligibleForConfirmWithdrawAction(ID employeeID) {
<span class="nc bnc" id="L558" title="All 2 branches missed.">		boolean isNegotiation = getWithdrawInfo() != null &amp;&amp;</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">		        (RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION.equals(getWithdrawInfo().getRequestStatus())) &amp;&amp;</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">		        getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED);</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">		if(isNegotiation){</span>
<span class="nc" id="L562">			ShiftSwapItem ssItem1 = getShiftSwapItems().get(0);</span>
<span class="nc" id="L563">			ShiftSwapItem ssItem2 = getShiftSwapItems().get(1);</span>
			//Check if current employee has negotiation set to false, then return true.
<span class="nc bnc" id="L565" title="All 4 branches missed.">			if ((!ssItem1.getNegotiation() &amp;&amp; ssItem1.getEmployeeID().compareTo(employeeID)==0) ||</span>
<span class="nc bnc" id="L566" title="All 4 branches missed.">				(!ssItem2.getNegotiation() &amp;&amp; ssItem2.getEmployeeID().compareTo(employeeID)==0)){</span>
<span class="nc" id="L567">				return true;</span>
			}
<span class="nc" id="L569">			return false;</span>
		}
<span class="nc" id="L571">		return false;</span>
	}

	public boolean isEligibleForCancelWithdrawAction() {
<span class="nc bnc" id="L575" title="All 2 branches missed.">		return getWithdrawInfo() != null &amp;&amp;</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">		        (RequestAuditTrail.STATUS_WITHDRAW_REQUEST.equals(getWithdrawInfo().getRequestStatus()) ||</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">		        RequestAuditTrail.STATUS_WITHDRAW_REJECT.equals(getWithdrawInfo().getRequestStatus()) ||</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">		        RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION.equals(getWithdrawInfo().getRequestStatus())) &amp;&amp;</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">		        getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED);</span>
	}

    public boolean isEligibleForWithdraw() {
<span class="nc bnc" id="L583" title="All 2 branches missed.">		return (RequestAuditTrail.STATUS_WAITLIST.equals(getRequestStatus()) ||</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">		        RequestAuditTrail.STATUS_PENDING.equals(getRequestStatus()) ||</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">		        RequestAuditTrail.STATUS_TENTATIVE.equals(getRequestStatus()) ||</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">		        RequestAuditTrail.STATUS_ESCALATED.equals(getRequestStatus()) ||</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">		        RequestAuditTrail.STATUS_NEGOTIATION.equals(getRequestStatus())) ||</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">		        (getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED) &amp;&amp;</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">		        !isOverlap() &amp;&amp;</span>
<span class="nc bnc" id="L590" title="All 4 branches missed.">		        (getWithdrawInfo() == null || getWithdrawInfo().getRequestStatus().equals(RequestAuditTrail.STATUS_WITHDRAW_CANCEL)));</span>
	}

    public boolean isEligibleForWithdrawNegotiation() {
<span class="nc bnc" id="L594" title="All 4 branches missed.">		return getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED) &amp;&amp; !isOverlap() &amp;&amp;</span>
<span class="nc bnc" id="L595" title="All 4 branches missed.">		        (getWithdrawInfo() == null || getWithdrawInfo().getRequestStatus().equals(RequestAuditTrail.STATUS_WITHDRAW_CANCEL));</span>
	}

	/**
	 * Returns withdraw info associated with this request.
	 * &lt;p/&gt;
	 * Note:
	 *
	 * @return
	 */
	public ShiftSwapWithdraw getWithdrawInfo() {
		// if m_TOWithdraw Cache is uninitialized, initialize.
<span class="nc bnc" id="L607" title="All 2 branches missed.">		if (m_ShiftSwapWithdrawCache == null) {</span>
<span class="nc" id="L608">			Collection ssWithdrawCol = getChildObjects(ShiftSwapRequestFieldInfo.SS_WITHDRAW_CHILD_TYPE);</span>
<span class="nc bnc" id="L609" title="All 4 branches missed.">			if (ssWithdrawCol != null &amp;&amp; !ssWithdrawCol.isEmpty()) {</span>
<span class="nc" id="L610">				m_ShiftSwapWithdrawCache = (ShiftSwapWithdraw) ssWithdrawCol.iterator().next();</span>
			}
		}
<span class="nc" id="L613">		return m_ShiftSwapWithdrawCache;</span>
	}

	/**
	 * Replaces existing Withdraw with the given list.
	 *
	 * @param Withdraw
	 */
	public void setWithdrawInfo(ShiftSwapWithdraw withdraw) {
		// clear existing choices (in this valueObject and set flag for removal from database).
		//deleteAllChildren(ShiftSwapRequestFieldInfo.SS_WITHDRAW_CHILD_TYPE);//NOSONAR
<span class="nc bnc" id="L624" title="All 2 branches missed.">		if (withdraw != null) {</span>
<span class="nc" id="L625">			ShiftSwapWithdraw existing = getWithdrawInfo();</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">			if (existing==null){</span>
<span class="nc" id="L627">				createChildObject(ShiftSwapRequestFieldInfo.SS_WITHDRAW_CHILD_TYPE, withdraw);</span>
			} else {
<span class="nc" id="L629">				withdraw.setID(existing.getID());</span>
<span class="nc" id="L630">				updateChildObject(ShiftSwapRequestFieldInfo.SS_WITHDRAW_CHILD_TYPE, withdraw);</span>
			}
		}

		// invalidate cache as the m_TOWithdraw  has changed.
<span class="nc" id="L635">		m_ShiftSwapWithdrawCache = null;</span>
<span class="nc" id="L636">		addDetailLevel(DL_SHIFTSWAP_WITHDRAW);</span>
<span class="nc" id="L637">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>