<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AuctionMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.auction</a> &gt; <span class="el_source">AuctionMH.java</span></div><h1>AuctionMH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.auction;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.Set;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.EmpWorkRuleManager;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.base.SupportNavigation;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.base.RmRuntimeException;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestDetailLevel;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.BiddableSchedulesForAuctionParameter;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionManager;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.SerializedAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb.ShiftBidRequestManager;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BidOptionRow;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableSchedule;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableScheduleRow;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidPreference;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidder;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.UnsubmittedShiftBidPreference;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.ShiftBidAuctionUtil;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.organization.tree.OrganizationTreeHelper;
import com.bluepumpkin.web.bbm.workresource.WorkResourceModelHandler;
import com.bluepumpkin.web.core.base.ModelHandler;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.system.RequestContext;

/**
 * File:         AuctionMH
 * Description:  Model Handler for the auctions pages
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, inc
 * @author       David Su
 * @version      1.0
 * Created on August 2, 2002, 10:15 AM
 */
<span class="nc" id="L71">public class AuctionMH extends ModelHandler {</span>
	//////////////////////////////////////////////////////////////////////////////
	// Auction Related Code
	//////////////////////////////////////////////////////////////////////////////
	public static ID createAuction(ShiftBidAuction auction) throws RmHardValidationException, Exception {
<span class="nc" id="L76">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L77">		return sbAuctionMgr.createAuction(auction);</span>
	}

	public static void updateAuction(ShiftBidAuction auction) throws RmHardValidationException, Exception {
<span class="nc" id="L81">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L82">		sbAuctionMgr.updateAuction(auction);</span>
<span class="nc" id="L83">	}</span>

	public static ShiftBidAuction getAuction(ID id) throws RmHardValidationException, Exception {
<span class="nc" id="L86">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L87">		return sbAuctionMgr.getAuctionByID(id, ShiftBidAuction.DL_CAMPAIGN);</span>
	}

	public static Collection getAuctionsByIDs(Collection auctionIds) throws RmHardValidationException, Exception {
<span class="nc" id="L91">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L92">		return sbAuctionMgr.getAuctionsByIDs(auctionIds, ShiftBidAuction.DL_CAMPAIGN);</span>
	}

	public static void removeAuction(ID id) throws RmHardValidationException, Exception {
<span class="nc" id="L96">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L97">		ArrayList idList = new ArrayList(1);</span>
<span class="nc" id="L98">		idList.add(id);</span>
<span class="nc" id="L99">		sbAuctionMgr.deleteAuctions(idList);</span>
<span class="nc" id="L100">	}</span>

	public static void openAuction(ID id) throws RmHardValidationException, Exception {
<span class="nc" id="L103">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L104">		sbAuctionMgr.openAuction(id);</span>
<span class="nc" id="L105">	}</span>

	public static void closeAuction(ID id, boolean isAddNoneApprBonus) throws RmHardValidationException, Exception {
<span class="nc" id="L108">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L109">		sbAuctionMgr.closeAuction(id, isAddNoneApprBonus);</span>
<span class="nc" id="L110">	}</span>

	public static Collection getAuctionsForManager(User user) throws RmHardValidationException, Exception {
<span class="nc" id="L113">		ID empID = user.getEmployeeID();</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">		if (empID == null) {</span>
<span class="nc" id="L115">			return Collections.emptyList();</span>
		}

<span class="nc" id="L118">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L119">		return sbAuctionMgr.getAuctionsForManagerEmpID(empID, ShiftBidAuction.DL_BASIC | ShiftBidAuction.DL_EXCLUDE_EXPIRED_AUCTION);</span>
	}

	public static Collection getAuctionsForBidder(User user) throws RmHardValidationException, Exception {
<span class="nc" id="L123">		ID empID = user.getEmployeeID();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">		if (empID == null) {</span>
<span class="nc" id="L125">			return Collections.emptyList();</span>
		}

<span class="nc" id="L128">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L129">		return sbAuctionMgr.getAuctionsForBidderEmpID(empID, ShiftBidAuction.DL_BASIC | ShiftBidAuction.DL_EXCLUDE_EXPIRED_AUCTION);</span>
	}

	public static Collection getAuctionsForManagerWithCampaign(User user) throws RmHardValidationException, Exception {
<span class="nc" id="L133">		ID empID = user.getEmployeeID();</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">		if (empID == null) {</span>
<span class="nc" id="L135">			return Collections.emptyList();</span>
		}

<span class="nc" id="L138">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L139">		return sbAuctionMgr.getAuctionsForManagerEmpID(empID, ShiftBidAuction.DL_CAMPAIGN | ShiftBidAuction.DL_EXCLUDE_EXPIRED_AUCTION);</span>
	}

	//////////////////////////////////////////////////////////////////////////////
	// Schedules Related Code
	//////////////////////////////////////////////////////////////////////////////


	public static Collection&lt;BiddableScheduleRow&gt; getBiddableScheduleRows(Collection&lt;ID&gt; biddableSchedueIDs) throws Exception {
<span class="nc" id="L148">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L149">		return sbAuctionMgr.getBiddableScheduleRows(biddableSchedueIDs);</span>
	}

	public static Collection&lt;BidOptionRow&gt; getBidOptionsRows(ID auctionID, ID bidderID, Collection&lt;ID&gt; biddableSchedueIDs)
			throws Exception {
<span class="nc" id="L154">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L155">		return sbAuctionMgr.getBidOptionsRows(auctionID, bidderID, biddableSchedueIDs);</span>
	}



	//The data for the schedule rows page for the auction
	//organizatioID is the selected organization. If this value is null no filtering is done by organizations
	public static Pair&lt;List&lt;ID&gt;, List&lt;BiddableScheduleRow&gt;&gt; getBiddableScheduleRowsForAuction(ID auctionID,
			ID organizationID,
			String sortColumn,
			boolean isSortAscending, int pageSize, TimeRange[] weekRanges, ID managerEmployeeID)
			throws Exception {
<span class="nc" id="L167">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">        int iSortOrder = isSortAscending?</span>
				SupportNavigation.SORT_ASCENDING:SupportNavigation.SORT_DESCENDING;

<span class="nc bnc" id="L172" title="All 2 branches missed.">		int iSortColumn = StringUtil.isEmpty(sortColumn)?</span>
<span class="nc" id="L173">				ShiftBidder.SORTBY_NONE:Integer.parseInt(sortColumn);</span>

<span class="nc" id="L175">		BiddableSchedulesForAuctionParameter param = new BiddableSchedulesForAuctionParameter();</span>
<span class="nc" id="L176">		param.setAuctionID(auctionID);</span>
<span class="nc" id="L177">		param.setParentOrganizationID(organizationID);</span>
<span class="nc" id="L178">		param.setPageSize(pageSize);</span>
<span class="nc" id="L179">		param.setSortBy(new int[] { iSortColumn });</span>
<span class="nc" id="L180">		param.setSortDirection(new int[] { iSortOrder });</span>
<span class="nc" id="L181">		param.setWeekRanges(weekRanges);</span>


<span class="nc" id="L184">		return sbAuctionMgr.getBiddableScheduleRowsForAuction(param, managerEmployeeID);</span>
	}



	public static Pair&lt;List&lt;ID&gt;, List&lt;BidOptionRow&gt;&gt; getBidOptionsForBidder(BiddableSchedulesForAuctionParameter param)
			throws RmHardValidationException, Exception {
<span class="nc" id="L191">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>

<span class="nc" id="L193">		return sbAuctionMgr.getBidOptionsForBidder(param);</span>
	}


	public static void updateSchedulesBonus(ID auctionID, Map&lt;ID, String&gt; bonusMap) throws RmHardValidationException, Exception {
<span class="nc bnc" id="L198" title="All 2 branches missed.">		if (bonusMap.isEmpty()) {</span>
<span class="nc" id="L199">			return;</span>
		}

<span class="nc" id="L202">		List&lt;BiddableSchedule&gt; bsList = new ArrayList&lt;BiddableSchedule&gt;(bonusMap.size());</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">		for (Map.Entry&lt;ID, String&gt; entry : bonusMap.entrySet()) {</span>
<span class="nc" id="L204">			ID bsID = entry.getKey();</span>

<span class="nc" id="L206">			BiddableSchedule bs = new BiddableSchedule(BiddableSchedule.DL_BASIC);</span>
<span class="nc" id="L207">			bs.setID(bsID);</span>
<span class="nc" id="L208">			String strBonus = entry.getValue();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">			if (strBonus != null) {</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">				int intBonus = StringUtil.isEmpty(strBonus) ? 0 : Integer.parseInt(strBonus);</span>
<span class="nc" id="L211">				bs.setBonusPoints(intBonus);</span>
			}
<span class="nc" id="L213">			bsList.add( bs );</span>
<span class="nc" id="L214">		}</span>

<span class="nc" id="L216">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L217">		sbAuctionMgr.updateBonusAndDescriptions(bsList, null);</span>
<span class="nc" id="L218">	}</span>

	public static void updateSchedulesBonusAndDescription(ID auctionID, Map&lt;ID, String&gt; bonusMap, Map&lt;ID, String&gt; descriptionMap)
			throws RmHardValidationException, Exception {
<span class="nc bnc" id="L222" title="All 4 branches missed.">		if (bonusMap.isEmpty() || descriptionMap.isEmpty()) {</span>
<span class="nc" id="L223">			return;</span>
		}

<span class="nc" id="L226">		List&lt;BiddableSchedule&gt; bsList = new ArrayList&lt;BiddableSchedule&gt;(bonusMap.size());</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">		for (Map.Entry&lt;ID, String&gt; entry : bonusMap.entrySet()) {</span>
<span class="nc" id="L228">			ID bsID = entry.getKey();</span>

<span class="nc" id="L230">			BiddableSchedule bs = new BiddableSchedule(BiddableSchedule.DL_BASIC);</span>
<span class="nc" id="L231">			bs.setID(bsID);</span>
<span class="nc" id="L232">			String strBonus = entry.getValue();</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">			if (strBonus != null) {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">				int intBonus = StringUtil.isEmpty(strBonus) ? 0 : Integer.parseInt(strBonus);</span>
<span class="nc" id="L235">				bs.setBonusPoints(intBonus);</span>
			}

			// Update Description for Schedule that has the same ID
<span class="nc" id="L239">			String description = descriptionMap.get(bsID);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">			if (description != null) {</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">				description = StringUtil.isEmpty(description) ? null : description;</span>
<span class="nc" id="L242">				bs.setDescription(description);</span>
			}

<span class="nc" id="L245">			bsList.add( bs );</span>
<span class="nc" id="L246">		}</span>

<span class="nc" id="L248">		Set&lt;ID&gt; descriptionIDs = descriptionMap.keySet();</span>

<span class="nc" id="L250">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L251">		sbAuctionMgr.updateBonusAndDescriptions(bsList, descriptionIDs);</span>
<span class="nc" id="L252">	}</span>

	public static Collection&lt;ShiftAssignment&gt; getShiftAssignments(Collection&lt;ID&gt; scheduleIDs)
            throws RmHardValidationException, Exception {
<span class="nc" id="L256">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L257">		return sbAuctionMgr.getShiftAssignments(scheduleIDs);</span>
	}

	/**
	 * Get a collection of IDStringPair's of WorkPatterns.
	 * @param orgIDs
	 */
	public static Collection getWorkPatternIDNamePairs(Collection orgIDs) throws RemoteException, BbmFinderException,
	BbmEJBCreateException {
<span class="nc" id="L266">		EmpWorkRuleManager empWorkRuleManager = WfmManagerFactory.getEmpWorkRuleManager();</span>
<span class="nc" id="L267">		return empWorkRuleManager.getWorkPatternIDNamePairs(orgIDs);</span>
	}

	/**
	 * Get a collection of IDStringPair's of Shifts.
	 * @param orgIDs
	 */
	public static Collection getShiftIDNamePairs(Collection orgIDs) throws RemoteException, BbmFinderException, BbmEJBCreateException {
<span class="nc" id="L275">		EmpWorkRuleManager empWorkRuleManager = WfmManagerFactory.getEmpWorkRuleManager();</span>
<span class="nc" id="L276">		return empWorkRuleManager.getShiftIDNamePairs(orgIDs);</span>
	}

	public static List&lt;String&gt; getTemplateNames(ID auctionID, Collection&lt;ID&gt; orgIDs, ID bidderID, boolean byEmplType)
			throws RmHardValidationException, Exception {

<span class="nc" id="L282">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L283">		return sbAuctionMgr.getTemplateNames(auctionID, orgIDs, bidderID, byEmplType);</span>
	}




	//////////////////////////////////////////////////////////////////////////////
	// Bidders Related Code
	//////////////////////////////////////////////////////////////////////////////
	public static EmployeeName getEmployeeNameByBidderID(RequestContext context, ID bidderID) throws RmHardValidationException, Exception {
<span class="nc" id="L293">		ShiftBidder bidder = getShiftBidderByID(bidderID);</span>
<span class="nc" id="L294">		ID empID = bidder.getEmployeeID();</span>
<span class="nc" id="L295">		return EmployeeModelHandler.getEmployeeNameByID(context, empID);</span>
	}

	public static ShiftBidder getShiftBidderByID(ID bidderID) throws RmHardValidationException, Exception {
<span class="nc" id="L299">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L300">		ShiftBidder shiftbidder = sbAuctionMgr.getShiftBidderByID(bidderID, ShiftBidder.DL_BASIC);</span>
<span class="nc" id="L301">		return shiftbidder;</span>
	}

	public static ShiftBidder getShiftBidder(ID auctionID, ID empID) throws RmHardValidationException, Exception {
<span class="nc" id="L305">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L306">		ShiftBidder shiftbidder = sbAuctionMgr.getShiftBidderForEmpID(empID, auctionID, ShiftBidder.DL_BASIC);</span>
<span class="nc" id="L307">		return shiftbidder;</span>
	}

	/**
	 * Gets the basic ShiftBidder data for the employee and specified auctions.
	 */
	public static Collection&lt;ShiftBidder&gt; getBasicShiftBidderForEmpAndAuctions(ID employeeID, Collection&lt;ID&gt; auctionIDs)
			throws Exception {
<span class="nc" id="L315">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L316">		return sbAuctionMgr.getBasicShiftBidderForEmpAndAuctions(employeeID, auctionIDs);</span>
	}

	public static Pair getBidders(ID auctionID, ID orgID, String sortColumn, boolean isSortAscending, int blockSize)
            throws RmHardValidationException, Exception {
<span class="nc" id="L321">        ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>

<span class="nc bnc" id="L323" title="All 2 branches missed.">		int iSortOrder = isSortAscending?</span>
				SupportNavigation.SORT_ASCENDING:SupportNavigation.SORT_DESCENDING;

<span class="nc bnc" id="L326" title="All 2 branches missed.">		int iSortColumn = StringUtil.isEmpty(sortColumn)?</span>
<span class="nc" id="L327">				ShiftBidder.SORTBY_NONE:Integer.parseInt(sortColumn);</span>

<span class="nc" id="L329">        return sbAuctionMgr.getShiftBiddersForAuction(auctionID, orgID, true, iSortColumn,</span>
                iSortOrder, blockSize, PrivilegeKeys.SB_MODIFYPEOPLEINAUCTIONS_ID,
				ShiftBidder.DL_BASIC | ShiftBidder.DL_EMPLOYEE | ShiftBidder.DL_NUMBER_OF_SHIFTBIDREQUESTS
				| ShiftBidder.DL_SHIFTBIDDER_SCORE);
	}

    	public static Collection getBidders(ID auctionID, ID orgID) throws RmHardValidationException, Exception {
<span class="nc" id="L336">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L337">		return (Collection) sbAuctionMgr.getShiftBiddersForAuction(auctionID, orgID, true, ShiftBidder.SORTBY_NONE,</span>
                SupportNavigation.SORT_ASCENDING, Integer.MAX_VALUE, PrivilegeKeys.SB_MODIFYPEOPLEINAUCTIONS_ID,
				ShiftBidder.DL_BASIC | ShiftBidder.DL_EMPLOYEE | ShiftBidder.DL_SHIFTBIDDER_SCORE
<span class="nc" id="L340">				| ShiftBidder.DL_NUMBER_OF_SHIFTBIDREQUESTS).getSecond();</span>
	}

	public static Collection getNextShiftBidders(ID auctionID, Collection bidderIDs)
            throws Exception, RmHardValidationException {
<span class="nc" id="L345">        ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L346">		return sbAuctionMgr.getNextShiftBidders(auctionID, bidderIDs,</span>
                ShiftBidder.DL_BASIC | ShiftBidder.DL_EMPLOYEE | ShiftBidder.DL_SHIFTBIDDER_SCORE
                | ShiftBidder.DL_NUMBER_OF_SHIFTBIDREQUESTS);
	}

	public static Collection getBiddersAddedToAuction(ID auctionID) throws RmHardValidationException, Exception {
<span class="nc" id="L352">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L353">		return (Collection) sbAuctionMgr.getShiftBiddersForAuction(auctionID, null, false, ShiftBidder.SORTBY_NAME,</span>
                SupportNavigation.SORT_ASCENDING, Integer.MAX_VALUE, PrivilegeKeys.SB_MODIFYPEOPLEINAUCTIONS_ID,
<span class="nc" id="L355">                ShiftBidder.DL_BASIC | ShiftBidder.DL_EMPLOYEE).getSecond();</span>
	}

	public static ID getOrgIDForEmp(RequestContext context, ID empID) throws Exception {
<span class="nc" id="L359">		ID orgID = null;</span>

<span class="nc bnc" id="L361" title="All 2 branches missed.">		if (empID!=null) {</span>
<span class="nc" id="L362">			orgID = OrganizationModelHandler.getEmployeeOrgID(context, empID);</span>
		}

<span class="nc" id="L365">		return orgID;</span>
	}

	public static int getEmpMaxPrefLevel(RequestContext context, ID empID) throws RemoteException, BbmException {
<span class="nc" id="L369">		OrganizationSetting orgSetting = RequestsMH.getOrgSettingForEmployee(context, empID);</span>
<span class="nc" id="L370">		return orgSetting.getShiftBidMaxPref();</span>
	}

	public static void updateShiftBidders(ID auctionID, Map bonusMap, Map deadlineMap) throws RmHardValidationException, Exception {
<span class="nc bnc" id="L374" title="All 2 branches missed.">		if (bonusMap.isEmpty()) {</span>
<span class="nc" id="L375">			return;</span>
		}

<span class="nc" id="L378">		List bidderList = new ArrayList(bonusMap.size());</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">		for(Iterator it=bonusMap.entrySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L380">			Map.Entry entry = (Map.Entry)it.next();</span>
<span class="nc" id="L381">			ID bidderID = (ID)entry.getKey();</span>

<span class="nc" id="L383">			ShiftBidder sb = new ShiftBidder(ShiftBidder.DL_BASIC);</span>
<span class="nc" id="L384">			sb.setID(bidderID);</span>
<span class="nc" id="L385">			Object value = entry.getValue();</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">			if (value!=null) {</span>
<span class="nc" id="L387">				sb.setBonusThisAuction(Integer.parseInt((String)value));</span>
			}
<span class="nc" id="L389">			Date deadline = (Date)deadlineMap.get(bidderID);</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">			if (deadline!=null) {</span>
<span class="nc" id="L391">				sb.setDeadlineDate(deadline);</span>
			}
<span class="nc" id="L393">			bidderList.add(sb);</span>
<span class="nc" id="L394">		}</span>
<span class="nc" id="L395">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L396">		sbAuctionMgr.updateShiftBiddersForAuction(auctionID, bidderList);</span>
<span class="nc" id="L397">	}</span>

	public static void startAuctionSerialization(Collection bidderIDs,
			int rankBy, int thinkTime, ID auctionID) throws RmHardValidationException, Exception {
<span class="nc" id="L401">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L402">		sbAuctionMgr.startAuctionSerialization(auctionID, bidderIDs, thinkTime, rankBy);</span>
<span class="nc" id="L403">	}</span>

	public static void stopAuctionSerialization(ID auctionID) throws RmHardValidationException, Exception {
<span class="nc" id="L406">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L407">		sbAuctionMgr.stopAuctionSerialization(auctionID);</span>
<span class="nc" id="L408">	}</span>

	public static SerializedAuction getSerializedAuction(ID auctionID) throws RmHardValidationException, Exception {
<span class="nc" id="L411">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L412">		return sbAuctionMgr.getSerializedAuction(auctionID);</span>
	}


	public static void addShiftBidderToAuction(Collection bidderIDs, Date deadline, ID auctionID) throws RmHardValidationException, Exception {
<span class="nc bnc" id="L417" title="All 2 branches missed.">		if (bidderIDs.isEmpty()) {</span>
<span class="nc" id="L418">			return;</span>
		}

<span class="nc" id="L421">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L422">		sbAuctionMgr.addShiftBiddersToAuction(auctionID, bidderIDs, deadline);</span>
<span class="nc" id="L423">	}</span>

	public static void removeShiftBidderFromAuction(Collection bidderIDs, ID auctionID) throws RmHardValidationException, Exception {
<span class="nc" id="L426">		ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L427">		sbAuctionMgr.removeShiftBiddersFromAuction(auctionID, bidderIDs);</span>
<span class="nc" id="L428">	}</span>

	//////////////////////////////////////////////////////////////////////////////
	// Shift Bid Request Code
	//////////////////////////////////////////////////////////////////////////////
	/**
	 * Return ShiftBidRequest with Rank info if valid
	 */
	public static ShiftBidRequest validateRequestAndComputeRank(ShiftBidRequest request) throws RmHardValidationException, Exception {
<span class="nc" id="L437">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L438">		return (ShiftBidRequest) sbrMgr.validateRequestAndComputeRank(request);</span>
	}

	public static ID createRequest(ShiftBidRequest request, String comment) throws RmHardValidationException, Exception {
<span class="nc" id="L442">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L443">		return sbrMgr.createRequest(request, comment);</span>
	}

	public static void updateRequest(ShiftBidRequest request, String comment) throws RmHardValidationException, Exception {
<span class="nc" id="L447">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L448">		sbrMgr.updateRequest(request, comment);</span>
<span class="nc" id="L449">	}</span>

	public static ShiftBidRequest getRequest(ID id, boolean isSoftValExec) throws RmHardValidationException, Exception {
<span class="nc" id="L452">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L453">		return (ShiftBidRequest) sbrMgr.getRequestByID(id, true, isSoftValExec,</span>
				ShiftBidRequest.DL_BASIC |
						ShiftBidRequest.DL_SHIFTBID_AUCTION |
						ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL |
						ShiftBidRequest.DL_AUDIT_TRAIL |
						//Need rank since it is displayed in the popup form used to view the request
						ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
						RequestDetailLevel.DL_INCLUDE_ZERO_NUM_OF_AVAIL_INSTANCES |
						RequestDetailLevel.DL_BIDDABLESCHEDULEINSTANCES);
	}

	public static ID getApprovedRequestID(ID shiftBidderID, ID auctionID) throws Exception {
<span class="nc" id="L465">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L466">		return sbrMgr.getApprovedRequestID(shiftBidderID, auctionID);</span>
	}

	public static void withdrawApprovedBidRequest(ShiftBidRequest req, String comment) throws Exception {
<span class="nc" id="L470">		ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L471">		sbrMgr.withdrawApprovedBidRequest(req, comment);</span>
<span class="nc" id="L472">	}</span>

	/**
	 * The the  preference for requests that have not yet been submitted for the given employee and auction
	 * The key is the BiddableSchedule ID and the value is the preference.
	 */
	public static Map&lt;ID, ShiftBidPreference&gt; getUnsubmittedSchedulePreference(ID auctionID, ID employeeID) {
		try {
<span class="nc" id="L480">			ShiftBidRequestManager mgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L481">			return mgr.getUnsubmittedSchedulePreference(auctionID, employeeID);</span>
<span class="nc" id="L482">		} catch (Exception e) {</span>
<span class="nc" id="L483">			throw RmRuntimeException.toRuntimeException(e);</span>
		}

	}

	public static void updateUnsubmittedSchedulePreference(Collection&lt;UnsubmittedShiftBidPreference&gt; preferences) {
		try {
<span class="nc" id="L490">			ShiftBidRequestManager mgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L491">			mgr.updateUnsubmittedSchedulePreference(preferences);</span>
<span class="nc" id="L492">		} catch (Exception e) {</span>
<span class="nc" id="L493">			throw RmRuntimeException.toRuntimeException(e);</span>
<span class="nc" id="L494">		}</span>
<span class="nc" id="L495">	}</span>

	public static void createRequestsFromUnsubmittedPreferences(RequestContext context, ID auctionID, ID bidderID, ID employeeID) {
		try {
<span class="nc" id="L499">			ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L500">			ShiftBidAuction auction = sbAuctionMgr.getAuctionByID(auctionID, ShiftBidAuction.DL_BASIC);</span>

<span class="nc" id="L502">			ShiftBidRequestManager sbrMgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L503">			int minimumBidSubmissions = ShiftBidAuctionUtil.calculateShiftBidderMinimumNumberOfBidsForEmployee(auction, employeeID);</span>
<span class="nc" id="L504">			OrganizationSetting orgSetting = RequestsMH.getOrgSettingForEmployee(context, employeeID);</span>
<span class="nc" id="L505">			boolean enforceUniquePreferences = orgSetting.getEnforceUniquePreferences();</span>

<span class="nc" id="L507">			sbrMgr.createRequestsFromUnsubmittedPreferences(auction, bidderID, minimumBidSubmissions, enforceUniquePreferences);</span>
<span class="nc" id="L508">		} catch (Exception e) {</span>
<span class="nc" id="L509">			throw RmRuntimeException.toRuntimeException(e);</span>
<span class="nc" id="L510">		}</span>
<span class="nc" id="L511">	}</span>

	public static int getAvailableShiftsForSubmittedBids(ID auctionID, ID bidderID) {
		try {
<span class="nc" id="L515">			ShiftBidRequestManager mgr = RequestUtil.getShiftBidRequestManager(null, null);</span>
<span class="nc" id="L516">			return mgr.getAvailableShiftsForSubmittedBids(auctionID, bidderID);</span>
<span class="nc" id="L517">		} catch (Exception e) {</span>
<span class="nc" id="L518">			throw RmRuntimeException.toRuntimeException(e);</span>
		}
	}

	public static int getEmployeeRankFromEmployeeID(RequestContext context, ID employeeID) {
<span class="nc bnc" id="L523" title="All 2 branches missed.">		if (employeeID == null) {</span>
<span class="nc" id="L524">			return 0;</span>
		}
		try {
<span class="nc" id="L527">			Employee emp = WorkResourceModelHandler.getWorkResourceManager(context).getEmployeeByID(employeeID, null,</span>
					Employee.DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY);
<span class="nc" id="L529">			return emp.getRank();</span>
<span class="nc" id="L530">		} catch (Exception e) {</span>
<span class="nc" id="L531">			throw RmRuntimeException.toRuntimeException(e);</span>
		}
	}

	public static Collection&lt;Organization&gt; getLinkedViewableOrgsBySid(RequestContext context, ID spId, Collection&lt;ID&gt; userScopeOrgIds)
			throws BbmException, RemoteException {
<span class="nc" id="L537">		Collection&lt;ID&gt; spOrgIDs = CampaignModelHandler.getLinkedOrgsforSP(context, spId);</span>
<span class="nc" id="L538">		Collection&lt;ID&gt; viewableOrgIds = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L539">		Collection&lt;Organization&gt; spOrgs = Collections.emptyList();</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">		for (ID orgId : spOrgIDs) {</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">			if (userScopeOrgIds.contains(orgId)) {</span>
<span class="nc" id="L542">				viewableOrgIds.add(orgId);</span>
			}
<span class="nc" id="L544">		}</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">		if (!viewableOrgIds.isEmpty()) {</span>
<span class="nc" id="L546">			spOrgs = OrganizationModelHandler.getOrganizationsByIDs(context, viewableOrgIds);</span>
		} else {
<span class="nc" id="L548">			spOrgs = Collections.emptyList();</span>
		}
<span class="nc" id="L550">		return spOrgs;</span>
	}

	public static Collection&lt;StringsPair&gt; getAuctionNamesInGiveOrgIds(Collection&lt;ID&gt; organizationIDs) {
		try {
<span class="nc" id="L555">			ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L556">			return sbAuctionMgr.getAuctionNamesInGiveOrgIds(organizationIDs);</span>
<span class="nc" id="L557">		} catch (Exception e) {</span>
<span class="nc" id="L558">			throw RmRuntimeException.toRuntimeException(e);</span>
		}
	}

	public static Collection&lt;StringsPair&gt; getOrgStringsPairs(Collection&lt;Organization&gt; orgs, RequestContext context) {

<span class="nc" id="L564">		boolean isOrgListHierarchical = &quot;true&quot;.equals(context.getUserProperty(UserPreferenceKeys.USER_SHOW_ORG_LIST_HIERARCHICAL));</span>
<span class="nc" id="L565">		Collection&lt;StringsPair&gt; options = new ArrayList&lt;StringsPair&gt;();</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">		if (isOrgListHierarchical) {</span>
<span class="nc" id="L567">			options = OrganizationTreeHelper.createIndentedOrgNameList(orgs, context.getLocalizer());</span>
		} else {
<span class="nc bnc" id="L569" title="All 2 branches missed.">			for (Organization org : orgs) {</span>
<span class="nc" id="L570">				ID orgId = org.getID();</span>
<span class="nc" id="L571">				options.add(new StringsPair(orgId.toString(), org.getName()));</span>
<span class="nc" id="L572">			}</span>
		}
<span class="nc" id="L574">		return options;</span>
	}

	public static ShiftAssignment getBiddableShiftAssignment(ID biddableShiftAssignmentID) {
		try {
<span class="nc" id="L579">			ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L580">			return sbAuctionMgr.getBiddableShiftAssignment(biddableShiftAssignmentID);</span>
<span class="nc" id="L581">		} catch (Exception e) {</span>
<span class="nc" id="L582">			throw RmRuntimeException.toRuntimeException(e);</span>
		}

	}

	public static List&lt;ID&gt; getSkillIdsForBiddableSchedule(ID biddableScheduleID) {
		try {
<span class="nc" id="L589">			ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L590">			return sbAuctionMgr.getSkillIdsForBiddableSchedule(biddableScheduleID);</span>
<span class="nc" id="L591">		} catch (Exception e) {</span>
<span class="nc" id="L592">			throw RmRuntimeException.toRuntimeException(e);</span>
		}
	}

	public static String resynchronizeAuctionSchedules(RequestContext context, ID auctionID, boolean update) {

<span class="nc" id="L598">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L599">		ResourceBundle bundle = localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>

<span class="nc bnc" id="L601" title="All 4 branches missed.">		if (update &amp;&amp; !AuctionUtil.canModifyAuction(context, auctionID)) {</span>
<span class="nc" id="L602">			throw RmRuntimeException.i18n(localizer, bundle, RmWebBundleKey.UNAUTHORIZED);</span>
		}

		try {

<span class="nc" id="L607">			ShiftBidAuctionManager sbAuctionMgr = RequestUtil.getShiftBidAuctionMgr(null, null);</span>
<span class="nc" id="L608">			Map&lt;String, String&gt; messages = sbAuctionMgr.resynchronizeAuctionSchedules(auctionID, update);</span>
<span class="nc" id="L609">			String preferencesInvalid = messages.get(&quot;PREFERENCES_INVALID&quot;);</span>
<span class="nc" id="L610">			String requestsInvalid = messages.get(&quot;REQUESTS_INVALID&quot;);</span>

<span class="nc bnc" id="L612" title="All 2 branches missed.">			String key = update ? RmWebBundleKey.RESYNC_BID_SCHEDULES_AFTER_UPDATE_MSG : RmWebBundleKey.RESYNC_BID_SCHEDULES_CONFIRM_MSG;</span>
<span class="nc bnc" id="L613" title="All 4 branches missed.">			return localizer.i18n(bundle, key,</span>
					preferencesInvalid == null ? &quot;0&quot; : preferencesInvalid,
					requestsInvalid == null ? &quot;0&quot; : requestsInvalid);

<span class="nc" id="L617">		} catch (Exception e) {</span>
<span class="nc" id="L618">			throw RmRuntimeException.toRuntimeException(e);</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>