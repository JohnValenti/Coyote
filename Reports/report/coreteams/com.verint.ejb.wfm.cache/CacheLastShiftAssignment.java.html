<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CacheLastShiftAssignment.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.ejb.wfm.cache</a> &gt; <span class="el_source">CacheLastShiftAssignment.java</span></div><h1>CacheLastShiftAssignment.java</h1><pre class="source lang-java linenums">/*
 * Created on Jul 26, 2004
 *
 * To change the template for this generated file go to
 * Window&amp;gt;Preferences&amp;gt;Java&amp;gt;Code Generation&amp;gt;Code and Comments
 */
package com.verint.ejb.wfm.cache;

import java.rmi.RemoteException;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

import com.bluepumpkin.common.base.Log;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.cache.Cache;
import com.bluepumpkin.ejb.bbm.cache.CacheManager;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.verint.ejb.wfm.WfmManagerFactory;

/**
 * @author rrajendran
 *
 *         To change the template for this generated type comment go to
 *         Window&amp;gt;Preferences&amp;gt;Java&amp;gt;Code Generation&amp;gt;Code and Comments
 */
public class CacheLastShiftAssignment extends Cache {

<span class="fc" id="L38">	private static Category m_cat = Log.initCategory(CacheLastShiftAssignment.class.getName());</span>

<span class="fc" id="L40">	private ScheduleAccessManager m_sam = null;</span>

	{ // instance initializer
		try {
<span class="fc" id="L44">			m_sam = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc" id="L45">		} catch (Exception e) {</span>
<span class="nc" id="L46">			throw new RuntimeException(e);</span>
<span class="fc" id="L47">		}</span>
	}

	@SuppressWarnings(&quot;all&quot;)
	// This class and its members are public because of the use of reflection in
	// CacheKey
	public static class CacheKeyLastShiftAssignment extends CacheKey {

<span class="fc" id="L55">		public static final String[] cacheKeyFieldNames = { &quot;m_empIDSet&quot;, &quot;m_isForPublished&quot; };</span>

<span class="fc" id="L57">		public Set m_empIDSet = null;</span>
<span class="fc" id="L58">		public boolean m_isForPublished = false;</span>

		/**
		 * @param cacheKeyFieldNames
		 */
		public CacheKeyLastShiftAssignment(Collection empIDs, boolean isForPublished) {
<span class="fc" id="L64">			super(cacheKeyFieldNames);</span>

<span class="fc" id="L66">			m_empIDSet = new HashSet(empIDs);</span>
<span class="fc" id="L67">			m_isForPublished = isForPublished;</span>
<span class="fc" id="L68">		}</span>

		/*
		 * (non-Javadoc)
		 * 
		 * @see java.lang.Object#hashCode()
		 */
		public int hashCode() {
			/*
			 * Returns the hash code value for this set. The hash code of a set
			 * is defined to be the sum of the hash codes of the elements in the
			 * set, where the hashcode of a null element is defined to be zero.
			 * This ensures that s1.equals(s2) implies that
			 * s1.hashCode()==s2.hashCode() for any two sets s1 and s2, as
			 * required by the general contract of the Object.hashCode method.
			 */
<span class="fc" id="L84">			return m_empIDSet.hashCode();</span>
		}

		/*
		 * (non-Javadoc)
		 * 
		 * @see
		 * com.bluepumpkin.ejb.bbm.cache.Cache.CacheKey#isSuperSet(com.bluepumpkin
		 * .ejb.bbm.cache.Cache.CacheKey)
		 */
		public boolean isSuperSet(CacheKey givenKey) {
<span class="nc" id="L95">			CacheKeyLastShiftAssignment givenLastShiftAssnKey = (CacheKeyLastShiftAssignment) givenKey;</span>

<span class="nc bnc" id="L97" title="All 2 branches missed.">			boolean isForPublishedMatches = m_isForPublished == givenLastShiftAssnKey.m_isForPublished;</span>

<span class="nc" id="L99">			boolean givenEmpIDsIsSubSet = m_empIDSet.contains(givenLastShiftAssnKey.m_empIDSet);</span>

<span class="nc bnc" id="L101" title="All 4 branches missed.">			return isForPublishedMatches &amp;&amp; givenEmpIDsIsSubSet;</span>
		}
	}

	/**
	 * @param cacheMgr
	 */
	public CacheLastShiftAssignment(CacheManager cacheMgr) {
<span class="fc" id="L109">		super(cacheMgr);</span>
<span class="fc" id="L110">	}</span>

	public ShiftAssignment getLastShiftAssignment(ID empID, boolean isForPublished) throws BbmObjectNotFoundException,
			BbmEJBCreateException, BbmFinderException, RemoteException {

		// construct key
<span class="fc" id="L116">		CacheKeyLastShiftAssignment givenCacheKey = new CacheKeyLastShiftAssignment(Collections.singleton(empID),</span>
				isForPublished);

		// get exact match and superset match
<span class="fc" id="L120">		Pair exactAndSupersetMapEntryPair = getExactOrSupersetEntry(givenCacheKey);</span>

		// get the key for the exact match
<span class="fc" id="L123">		Map.Entry exactMatchMapEntry = (Entry) exactAndSupersetMapEntryPair.getFirst();</span>
<span class="fc" id="L124">		Map cachedEmpIDtoLastShiftAssnExactMap = null;</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">		if (exactMatchMapEntry != null) {</span>
<span class="nc" id="L126">			cachedEmpIDtoLastShiftAssnExactMap = (Map) exactMatchMapEntry.getValue();</span>

<span class="nc bnc" id="L128" title="All 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L129">				m_cat.debug(CACHE_HIT_MSG + givenCacheKey);</span>

			// if last shift assignment exists
<span class="nc" id="L132">			ShiftAssignment lastShift = (ShiftAssignment) cachedEmpIDtoLastShiftAssnExactMap.get(empID);</span>
<span class="nc" id="L133">			return lastShift;</span>
		}

		// get key for superset match
<span class="fc" id="L137">		Map.Entry superSetMatchMapEntry = (Entry) exactAndSupersetMapEntryPair.getSecond();</span>
<span class="fc" id="L138">		Map cachedEmpIDToLastShiftSuperSetMap = null;</span>
<span class="fc" id="L139">		CacheKeyLastShiftAssignment cacheKeyForSuperSetMatch = null;</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">		if (superSetMatchMapEntry != null) {</span>
<span class="nc" id="L141">			cacheKeyForSuperSetMatch = (CacheKeyLastShiftAssignment) superSetMatchMapEntry.getKey();</span>
<span class="nc" id="L142">			cachedEmpIDToLastShiftSuperSetMap = (Map) superSetMatchMapEntry.getValue();</span>
		}

		// if not found in cache
<span class="fc" id="L146">		ShiftAssignment lastShiftAssn = null;</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">		if (cacheKeyForSuperSetMatch == null) {</span>
<span class="fc" id="L148">			Map empIDToLastShiftMap = getLastShiftAssignmentUncached(Collections.singleton(empID), isForPublished,</span>
					m_sam);
<span class="fc" id="L150">			lastShiftAssn = (ShiftAssignment) empIDToLastShiftMap.get(empID);</span>

<span class="fc" id="L152">			put(givenCacheKey, empIDToLastShiftMap);</span>

<span class="pc bpc" id="L154" title="1 of 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="fc" id="L155">				m_cat.debug(CACHE_MISS_MSG + givenCacheKey);</span>
<span class="fc" id="L156">		} else { // superset found in cache</span>
<span class="nc" id="L157">			lastShiftAssn = (ShiftAssignment) cachedEmpIDToLastShiftSuperSetMap.get(empID);</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">			if (m_cat.isDebugEnabled())</span>
<span class="nc" id="L160">				m_cat.debug(CACHE_SUPERSET_HIT_MSG + givenCacheKey);</span>
		}

<span class="fc" id="L163">		return lastShiftAssn;</span>
	}

	/**
	 * @param empID
	 * @param m_sam2
	 * @return
	 */
	public static Map getLastShiftAssignmentUncached(Collection empIDs, boolean isForPublished,
			ScheduleAccessManager sam) throws BbmEJBCreateException, BbmObjectNotFoundException, BbmFinderException,
			RemoteException {

<span class="pc bpc" id="L175" title="1 of 2 branches missed.">		sam = (sam == null) ? WfmManagerFactory.getScheduleAccessManager() : sam;</span>

<span class="pc bpc" id="L177" title="1 of 2 branches missed.">		Map empIDToLastShiftAssnMap = (isForPublished) ? sam.getLastPublishedShiftAssignments(empIDs) : sam</span>
<span class="pc" id="L178">				.getLastShiftAssignments(empIDs);</span>

<span class="fc" id="L180">		return empIDToLastShiftAssnMap;</span>

	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>