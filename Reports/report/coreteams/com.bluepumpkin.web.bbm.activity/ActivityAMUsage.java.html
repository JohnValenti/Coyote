<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityAMUsage.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.activity</a> &gt; <span class="el_source">ActivityAMUsage.java</span></div><h1>ActivityAMUsage.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.activity;

import java.util.*;
import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityProperties;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.localization.Localizer;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.*;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.*;
import com.witness.web.uif.validator.*;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;

/**
 * Title:        ActivityAMUsage
 * Description:  A collapsable container for the Activity's AM usage attributes
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 *
 * @author Shimon Kakon
 * @version 1.0
 */

public class ActivityAMUsage extends ActivityUsage {

	public static final int MAX_DURATION_DEFAULT_MIN = -1;
	private static final int TOLERANCE_DEFAULT_MIN = 5;
	private static final boolean WHOS_IN_STATE_DEFAULT = false; //in

<span class="fc" id="L35">	private ArrayList m_whosInStateStringPair = null;</span>
	private FormInputPC m_fiPC;

	public ActivityAMUsage(RequestContext context, ResourceBundle bundle, Activity activity, ActivityProperties activityProperties) {
<span class="fc" id="L39">		super(context, bundle, activity, activityProperties);</span>

<span class="fc" id="L41">		m_fiPC = new FormInputPC(m_context);</span>
<span class="fc" id="L42">		addChildComponent(m_fiPC);</span>
<span class="fc" id="L43">	}</span>

	public boolean extractParameters(HttpServletRequest request) {
		// if duration value is not set, the default is -1, which means unlimited
<span class="fc" id="L47">		String strDuration = request.getParameter(ActivityFields.MAX_DURATION_FN);</span>
<span class="pc bpc" id="L48" title="1 of 2 branches missed.">		int duration = StringUtil.isEmpty(strDuration)</span>
<span class="pc" id="L49">			? MAX_DURATION_DEFAULT_MIN : Integer.parseInt(strDuration);</span>
<span class="fc" id="L50">		setMaxDurationThreshold(duration);</span>

		// in/out is an options list backed by a boolean value, so &quot;true&quot;/&quot;false&quot;
		// needs to be converted to boolean true/false
<span class="fc" id="L54">		String boolValue = (String) request.getParameter(ActivityFields.OUT_FN);</span>
<span class="pc bpc" id="L55" title="1 of 4 branches missed.">		setOut((boolValue != null &amp;&amp; boolValue.equals(&quot;true&quot;)) ? true : false);</span>

		//set tolerance
<span class="fc" id="L58">		strDuration = request.getParameter(ActivityFields.TOLERANCE_FN);</span>
<span class="fc bfc" id="L59" title="All 2 branches covered.">		duration = StringUtil.isEmpty(strDuration)</span>
<span class="fc" id="L60">			? TOLERANCE_DEFAULT_MIN : Integer.parseInt(strDuration);</span>
<span class="fc" id="L61">		setTolerance(duration);</span>

<span class="fc" id="L63">		return true;</span>
	}

	public void initForDisplay() {
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L68">			return;</span>
		} else {
<span class="fc" id="L70">			super.initForDisplay();</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">			if (m_visible) {</span>
<span class="fc" id="L72">				setTitle(i18n(m_bundle, BbmWebBundleKey.ACTIVITY_TITLE_AM_USAGE));</span>
<span class="fc" id="L73">				setName(&quot;amUsage&quot;);</span>
<span class="fc" id="L74">				m_whosInStateStringPair = new ArrayList(2);</span>
<span class="fc" id="L75">				m_whosInStateStringPair.add(new StringsPair(&quot;false&quot;, m_localizer.i18n(m_bundle, BbmWebBundleKey.ACTIVITY_WHOSIN_STATE_IN)));</span>
<span class="fc" id="L76">				m_whosInStateStringPair.add(new StringsPair(&quot;true&quot;, m_localizer.i18n(m_bundle, BbmWebBundleKey.ACTIVITY_WHOSIN_STATE_OUT)));</span>
			}
		}
<span class="fc" id="L79">	}</span>

	protected void initFields() {
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">		if (m_visible) {</span>
<span class="fc" id="L83">			m_fields = new StringBuffer(512);</span>
<span class="fc" id="L84">			int i = 0;</span>
			// Tolerance
<span class="pc bpc" id="L86" title="3 of 4 branches missed.">			switch (m_displayMap[ActivityFields.TOLERANCE]) {</span>
				case ActivityFields.EDITABLE:
<span class="fc" id="L88">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_FORM_TOLERANCE, i++));</span>
<span class="fc" id="L89">					addComponent(HtmlUtil.makeTextInput(ActivityFields.TOLERANCE_FN, 5, 5, getToleranceString(), JSUtil.ON_CHANGE));</span>
<span class="fc" id="L90">					addValidator(new IsNonNegativeIntegerFieldValidator(this, ActivityFields.TOLERANCE_FN,</span>
						BbmWebBundleKey.ACTIVITY_LABEL_FORM_TOLERANCE, BbmWebBundleKey.BUNDLE_NAME));
<span class="fc" id="L92">					break;</span>
				case ActivityFields.DISPLAYABLE:
<span class="nc" id="L94">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_FORM_TOLERANCE, i++));</span>
<span class="nc" id="L95">					addComponent(getToleranceString());</span>
				case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L97">					addHiddenField(ActivityFields.TOLERANCE);</span>
<span class="nc" id="L98">					break;</span>
				default:
<span class="nc" id="L100">					throw new IllegalStateException();</span>
			}

			// Max Duration
<span class="pc bpc" id="L104" title="3 of 4 branches missed.">			switch (m_displayMap[ActivityFields.MAX_DURATION]) {</span>
				case ActivityFields.EDITABLE:
<span class="fc" id="L106">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_FORM_MAXTHRESHOLD, i++));</span>
<span class="fc" id="L107">					addComponent(getMaxDurationCombo());</span>
<span class="fc" id="L108">					addValidator(new IsNonNegativeIntegerFieldValidator(this, ActivityFields.MAX_DURATION_FN,</span>
						BbmWebBundleKey.ACTIVITY_LABEL_LIST_MAXTHRESHOLD, BbmWebBundleKey.BUNDLE_NAME));
<span class="fc" id="L110">					break;</span>
				case ActivityFields.DISPLAYABLE:
<span class="nc" id="L112">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_FORM_MAXTHRESHOLD, i++));</span>
<span class="nc" id="L113">					addComponent(getMaxDurationString());</span>
				case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L115">					addHiddenField(ActivityFields.MAX_DURATION);</span>
<span class="nc" id="L116">					break;</span>
				default:
<span class="nc" id="L118">					throw new IllegalStateException();</span>
			}

			// Who's in state
<span class="pc bpc" id="L122" title="3 of 4 branches missed.">			switch (m_displayMap[ActivityFields.OUT]) {</span>
				case ActivityFields.EDITABLE:
<span class="fc" id="L124">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_WHOSIN, i++));</span>
<span class="fc" id="L125">					addComponent(HtmlUtil.makeSelectInput(ActivityFields.OUT_FN, String.valueOf(m_activity.isOut()),</span>
						JSUtil.ON_CHANGE, m_whosInStateStringPair));
<span class="fc" id="L127">					break;</span>
				case ActivityFields.DISPLAYABLE:
<span class="nc" id="L129">					m_fields.append(addToTemplate(BbmWebBundleKey.ACTIVITY_LABEL_WHOSIN, i++));</span>
<span class="nc" id="L130">					addComponent(ActivityAMUsage.getWhosInStateDisplay(m_activity.isOut(), m_bundle, m_localizer));</span>
				case ActivityFields.NON_DISPLAYABLE:
<span class="nc" id="L132">					addHiddenField(ActivityFields.OUT);</span>
					break;
			}

<span class="fc" id="L136">		} else { // container is invisible</span>
<span class="nc" id="L137">			addHiddenField(ActivityFields.TOLERANCE);</span>
<span class="nc" id="L138">			addHiddenField(ActivityFields.MAX_DURATION);</span>
<span class="nc" id="L139">			addHiddenField(ActivityFields.OUT);</span>
		}

<span class="fc" id="L142">	}</span>

	public void setTolerance(int tolerance) {
<span class="fc" id="L145">		m_activity.setAdherenceTolerance(tolerance);</span>
<span class="fc" id="L146">	}</span>

	public void setMaxDurationThreshold(int duration) {
<span class="fc" id="L149">		m_activity.setMaxDurationThreshold(duration);</span>
<span class="fc" id="L150">	}</span>

	private String getToleranceString() {
<span class="fc" id="L153">		return Integer.toString(m_activity.getAdherenceTolerance());</span>
	}

	private String getMaxDurationString() {
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">		return isDurationUnlimited() ? &quot;&quot; : Integer.toString(m_activity.getMaxDurationThreshold());</span>
	}

	public void setOut(boolean out) {
<span class="fc" id="L161">		m_activity.setOut(out);</span>
<span class="fc" id="L162">	}</span>

	private boolean isDurationUnlimited() {
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">		return m_activity.getMaxDurationThreshold() == MAX_DURATION_DEFAULT_MIN;</span>
	}

	/**
	 * creates a checkbox/label textinput/label combination for max duration
	 */
	public String getMaxDurationCombo() {
<span class="fc" id="L172">		boolean unlimited = isDurationUnlimited();</span>

<span class="fc" id="L174">		StringBuffer sb = new StringBuffer(512);</span>
		// checkbox/label                                                              ti
<span class="fc" id="L176">		sb.append(HtmlChoiceInput.makeChkBoxInput(ActivityFields.MAX_DURATION_CHKBOX_FN,</span>
<span class="fc" id="L177">			String.valueOf(unlimited),</span>
<span class="fc" id="L178">			i18n(m_bundle, BbmWebBundleKey.ACTIVITY_LABEL_UNLIMITED),</span>
			unlimited, ACTIVITY_FIELD_ON_CHANGE));
		// textinput/label
<span class="fc" id="L181">		sb.append(HtmlUtil.makeSpacerHtml(8, 1));</span>

		// Use a FieldInputPC because it supports the setMiscAttributes method,
		// which is used to set the onKeyUp event handler. onChange does not
		// take effect until the *next* event. 		
<span class="fc" id="L186">		m_fiPC.reset();</span>
<span class="fc" id="L187">		m_fiPC.setIsRequired(false);</span>
<span class="fc" id="L188">		m_fiPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="fc" id="L189">		m_fiPC.setInputValue(getMaxDurationString());</span>
<span class="fc" id="L190">		m_fiPC.setInputFN(ActivityFields.MAX_DURATION_FN);</span>
<span class="fc" id="L191">		m_fiPC.setIsReadOnly(unlimited);</span>
<span class="fc" id="L192">		m_fiPC.setSize(5);</span>
<span class="fc" id="L193">		m_fiPC.setMiscAttributes(&quot;onKeyUp=&quot; + ACTIVITY_FIELD_ON_CHANGE);</span>
<span class="fc" id="L194">		m_fiPC.initForDisplay();</span>
<span class="fc" id="L195">		sb.append(m_fiPC.getHtmlDisplay());</span>

<span class="fc" id="L197">		sb.append(HtmlUtil.makeSpacerHtml(4, 1));</span>
<span class="fc" id="L198">		sb.append(i18n(m_bundle, BbmWebBundleKey.ACTIVITY_LABEL_MINUTES));</span>
<span class="fc" id="L199">		return sb.toString();</span>
	}

	public void setDefaultValues() {
<span class="fc" id="L203">		m_activity.setAdherenceTolerance(TOLERANCE_DEFAULT_MIN);</span>
<span class="fc" id="L204">		m_activity.setMaxDurationThreshold(MAX_DURATION_DEFAULT_MIN);</span>
<span class="fc" id="L205">		m_activity.setOut(WHOS_IN_STATE_DEFAULT);</span>
<span class="fc" id="L206">	}</span>

	private void addHiddenField(short field) {
<span class="nc bnc" id="L209" title="All 4 branches missed.">		switch (field) {</span>
			case ActivityFields.MAX_DURATION:
<span class="nc" id="L211">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.MAX_DURATION_FN, getMaxDurationString()));</span>
<span class="nc" id="L212">				break;</span>
			case ActivityFields.TOLERANCE:
<span class="nc" id="L214">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.TOLERANCE_FN, getToleranceString()));</span>
<span class="nc" id="L215">				break;</span>
			case ActivityFields.OUT:
<span class="nc" id="L217">				m_hiddenFields.append(HtmlUtil.makeHiddenInput(ActivityFields.OUT_FN, String.valueOf(m_activity.isOut())));</span>
				break;
		}
<span class="nc" id="L220">		m_hiddenFields.append(&quot;\n&quot;);</span>
<span class="nc" id="L221">	}</span>

	public static String getWhosInStateDisplay(boolean out, ResourceBundle bbmWebBundle, Localizer localizer) {
<span class="fc bfc" id="L224" title="All 2 branches covered.">		if (out) {</span>
<span class="fc" id="L225">			return localizer.i18n(bbmWebBundle, BbmWebBundleKey.ACTIVITY_WHOSIN_STATE_OUT);</span>
		} else {
<span class="fc" id="L227">			return localizer.i18n(bbmWebBundle, BbmWebBundleKey.ACTIVITY_WHOSIN_STATE_IN);</span>
		}
	}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>