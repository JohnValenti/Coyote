<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SpecialActivityFormPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.activity</a> &gt; <span class="el_source">SpecialActivityFormPageModel.java</span></div><h1>SpecialActivityFormPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.activity;

import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityProperties;
import com.bluepumpkin.ejb.bbm.workresource.OrganizationScopeManagerProxy;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrgWorkpaneFormPageModel;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.verint.web.wfm.keys.WfmJavaScriptFileID;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.container.Collapsible2ColFormPC;
import com.witness.web.uif.pagecomponent.contenttitle.ContentTitlePC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title:        SpecialActivityFormPageModel
 * Description:  Display a form for special activity. It allows the user to specify
 *               an activity for each of the 10 or so &quot;special&quot; activities (Ex: Activity.ACTIVITY_NONE).
 * @author       Gonzalo Quintanar
 */
public class SpecialActivityFormPageModel extends OrgWorkpaneFormPageModel 
{
<span class="fc" id="L47">	private static final Category log = Log.initCategory(SpecialActivityFormPageModel.class.getName());</span>

	//Constants
    public static final int NUM_SPECIAL_ACTIVITIES = 7;
    public static final int PARTIALLY_OVERRIDABLE_SPECIAL_ACTIVITY_START_INDEX = 1;
<span class="fc" id="L52">    public static ID[] specialActivityIDs = new ID[NUM_SPECIAL_ACTIVITIES];</span>
    static {
<span class="fc" id="L54">          specialActivityIDs[0] = Activity.ACTIVITY_VACATION;            //(-4113) Org: -3002</span>
<span class="fc" id="L55">    	  specialActivityIDs[1] = Activity.ACTIVITY_NONE;                //(-4001) Org: -3001</span>
<span class="fc" id="L56">          specialActivityIDs[2] = Activity.ACTIVITY_UNKNOWN;             //(-4002) Org: -3001</span>
<span class="fc" id="L57">          specialActivityIDs[3] = Activity.ACTIVITY_SHIFT_OVERTIME_GAP;  //(-4135) Org: -3002    </span>
<span class="fc" id="L58">          specialActivityIDs[4] = Activity.ACTIVITY_VOLUNTARY_TIMEOFF;   //(-4136) Org: -3002</span>
<span class="fc" id="L59">          specialActivityIDs[5] = Activity.ACTIVITY_LEARNING_BREAK;      //(-4132) Org: -3002</span>
<span class="fc" id="L60">          specialActivityIDs[6] = Activity.ACTIVITY_COACHING;            //(-4165) Org: -3002</span>
<span class="fc" id="L61">    }     </span>
	
	//Page Components
	private Collapsible2ColFormPC m_activityVacationFormPC;
	private SpecialActivityAttributes m_activityNoneFormPC;
	private SpecialActivityAttributes m_activityUnknownFormPC;
	private SpecialActivityAttributes m_activityGapFormPC;
	private SpecialActivityAttributes m_activityVtoFormPC;
	private SpecialActivityAttributes m_activityLearningBreakFormPC;
	private SpecialActivityAttributes m_activityCoachingFormPC;
	
	//Data variables
	private HashMap m_systemSpecialActivityIndexToIdMap; //A HashMap from specialActivityIDs. The key will be the index, the value will be the special activity ID.	
	private Collection m_currentOrgTimeOffActivities;    //All of the activities defined at the currently selected organization (no inheritance).
	private Map m_systemSpecialActivityIdNameMap;        //Map from activity ID to Activity. Gives us the system org's default special activities.
	private Activity m_parentVacationActivity;           //The default Vacation activity (this will be the Vacation activity available at the parent org).
	private Activity m_currentVacationActivity;          //The Vacation activity specified for the current organization. It might be inheritted from a parent organization.	
<span class="nc" id="L78">	private boolean m_cancelled = false;                 //true if the user clicked the &quot;Cancel&quot; button, false otherwise.</span>
<span class="nc" id="L79">	private StringBuffer m_hiddenFields = new StringBuffer(512);</span>
	
	/**
	 * Constructor
	 *
	 * @param context Request Context
	 */
	public SpecialActivityFormPageModel(RequestContext context) {
<span class="nc" id="L87">		super(context);</span>
		
<span class="nc" id="L89">		setJSMediator(WfmJavaScriptFileID.MEDIATOR_ACTIVITY_WORKPANE_FORM);</span>
<span class="nc" id="L90">		addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE_FORM); </span>
<span class="nc" id="L91">		addRequiredJavaScriptFile(WfmJavaScriptFileID.SPECIAL_ACTIVITY_ON_CHANGE);</span>

<span class="nc" id="L93">		setIsFormEditable(isAuthorizedToConfigureAMAttributes(getSelectedIDObject()));</span>
		
		//Create a HashMap from specialActivityIDs. 
		//The key will be the index, the value will be the special activity ID
<span class="nc" id="L97">		m_systemSpecialActivityIndexToIdMap = new HashMap(specialActivityIDs.length);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">		for (int i=0; i&lt;specialActivityIDs.length; i++)</span>
		{
<span class="nc" id="L100">			m_systemSpecialActivityIndexToIdMap.put(new Integer(i), specialActivityIDs[i]);</span>
		}		
<span class="nc" id="L102">	}</span>


	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L106">		boolean success=super.extractParameters(request);</span>
		
		//the containers depend on the selected org ID, which isn't known until super.extractParameters() completes.
<span class="nc" id="L109">		createCollapsibleContainers();</span>
		
<span class="nc" id="L111">		return success;</span>
	}
	/**
	 * Initialize Toolbar
	 */
	protected void initToolbar() {
<span class="nc bnc" id="L117" title="All 4 branches missed.">		if (m_isFormEditable &amp;&amp; !getSelectedIDObject().equals(Organization.YOUR_COMPANY_ID_OBJ)) </span>
		{
<span class="nc" id="L119">			m_toolbar.addValidateSubmitTextButton(PageAction.SAVE,</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">					i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SAVE), !m_initFailure);</span>

<span class="nc" id="L122">			m_toolbar.addResetTextButton(PageAction.RESET,</span>
<span class="nc" id="L123">					i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_RESET), true);</span>
		}
<span class="nc" id="L125">	}</span>

	/**
	 * Return if it is a new created entity
	 */
	public boolean isNew() {
<span class="nc" id="L131">		return false;</span>
	}

	/**
	 * Initialize Component For Display
	 */
	public void initForDisplay() 
	{
<span class="nc bnc" id="L139" title="All 2 branches missed.">		if (m_isInitializedForDisplay) </span>
		{
<span class="nc" id="L141">			return;</span>
		}
		else 
		{
<span class="nc" id="L145">			super.initForDisplay();			</span>
			
<span class="nc bnc" id="L147" title="All 2 branches missed.">			if( isValidSelectedOrg() ) </span>
			{
<span class="nc" id="L149">				ID selectedOrgID = getSelectedIDObject();</span>

				//prevent the user from overriding values that he could set himself on the Activity Edit page
<span class="nc bnc" id="L152" title="All 2 branches missed.">				if (!selectedOrgID.equals(Organization.YOUR_COMPANY_ID_OBJ))</span>
				{
<span class="nc bnc" id="L154" title="All 4 branches missed.">					if (isAuthorizedToView(selectedOrgID) || isAuthorizedToConfigure(selectedOrgID)) </span>
					{
<span class="nc" id="L156">						addForm(m_activityVacationFormPC);</span>
<span class="nc" id="L157">						addForm(m_activityNoneFormPC);			</span>
<span class="nc" id="L158">						addForm(m_activityUnknownFormPC);</span>
<span class="nc" id="L159">						addForm(m_activityGapFormPC);</span>
<span class="nc" id="L160">						addForm(m_activityVtoFormPC);</span>
<span class="nc" id="L161">						addForm(m_activityLearningBreakFormPC);</span>
<span class="nc" id="L162">						addForm(m_activityCoachingFormPC);</span>
					}
					else
					{
<span class="nc" id="L166">						m_isFormEditable = false;</span>
<span class="nc" id="L167">						addPageMessage(Message.INFO_TYPE, getNotAuthorizedToViewMsg());</span>
					}
				}
				else 
				{
<span class="nc" id="L172">					m_isFormEditable = false;</span>
<span class="nc" id="L173">					String msg = i18n(m_bbmBundle, BbmWebBundleKey.ORGANIZATION_SPECIAL_ACTIVITY_WRONG_ORG);</span>
<span class="nc" id="L174">					addPageMessage(Message.INFO_TYPE, msg);</span>
				}				
<span class="nc" id="L176">			}</span>
			else 
			{
<span class="nc" id="L179">				m_isFormEditable = false;</span>
<span class="nc" id="L180">				String msg = i18n(m_bbmBundle, BbmWebBundleKey.ORGANIZATION_GENERAL_SELECT_ORG_MSG);</span>
<span class="nc" id="L181">				addPageMessage(Message.RESPONSE_TYPE, msg);</span>
			}
		}
<span class="nc" id="L184">	}</span>


	/**
	 * Return instance of Model which is ready to be rendered
	 *
	 * @param context Request Context
	 */
	public static SpecialActivityFormPageModel getInstance(RequestContext context) {
<span class="nc" id="L193">		return (SpecialActivityFormPageModel)getInstance(context, SpecialActivityFormPageModel.class);</span>
	}

	/**
	 * Return the form title
	 *
	 * @return form title
	 */
	public String getFormTitle() {
<span class="nc" id="L202">		return i18n(m_bbmBundle, BbmWebBundleKey.SPECIAL_ACTIVITY_FORM_TITLE);</span>
	}


	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc" id="L210">		return &quot;special_activity_form&quot;;</span>
	}

	/**
	 * Override method to return Required HTML for this component
	 * Use this to add a specific hidden field
	 */
	public String getRequiredHTML() {
<span class="nc" id="L218">		StringBuffer reqHtml = new StringBuffer(1256);</span>
<span class="nc" id="L219">		reqHtml.append(super.getRequiredHTML());</span>
<span class="nc" id="L220">		m_hiddenFields.append(&quot;\n&quot;);</span>
<span class="nc" id="L221">		reqHtml.append(m_hiddenFields);</span>
<span class="nc" id="L222">		return reqHtml.toString();</span>
	}	

	/**
	 * Returns a (single) entity type.
	 */
	protected String getTitleEntityType() {
<span class="nc" id="L229">		return this.getFormTitle();</span>
	}

	/**
	 * Returns an entity name. Used for title.
	 */
	protected String getEntityName() 
	{
		try
		{
<span class="nc" id="L239">			return &quot;&quot;; //getOrganizationName();</span>
		}
<span class="nc" id="L241">		catch (Exception ex) </span>
		{
<span class="nc" id="L243">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L244">			m_initFailure = true;</span>
<span class="nc" id="L245">			return &quot;&quot;;</span>
		}
	}

	/**
	 * Returns organization value object given its id.
	 */
	public Organization getOrganization(ID orgId) {
<span class="nc bnc" id="L253" title="All 2 branches missed.">		if (orgId==null) return null;</span>
		try {
<span class="nc" id="L255">			return OrganizationModelHandler.getOrganization(m_context, orgId);</span>
<span class="nc" id="L256">		} catch (Exception e) {</span>
<span class="nc" id="L257">			handleUnableToLoadDataError(log, e);</span>
<span class="nc" id="L258">			m_initFailure = true;</span>
		}
<span class="nc" id="L260">		return null;</span>
	}
	
	/**
	 * Return the title
	 */
	public ContentTitlePC getContentTitle() 
	{
<span class="nc" id="L268">		StringBuffer itemName = new StringBuffer(64);</span>
<span class="nc" id="L269">		m_contentTitlePC.setPageTitle(this.getTitleEntityType());</span>

		// Get and set the item name: [organization name]
<span class="nc" id="L272">		itemName.append(this.getOrganizationName());</span>
<span class="nc" id="L273">		m_contentTitlePC.setItemName(itemName.toString());</span>
<span class="nc" id="L274">		return m_contentTitlePC;</span>
	}
	
	/**
	 * Create the form model - fetch the data from backend
	 *
	 */
	protected void createFormModel() 
	{
		//checkForLicenses();
		
		try 
		{
<span class="nc bnc" id="L287" title="All 2 branches missed.">			if (hasSelectedID()) </span>
			{
				//Get all of the time off activities defined at the current organization.
				//Since this is used for Vacation activities only, we should only get the isTimeOff=1 activities
<span class="nc" id="L291">				ActivityFilter filter = new ActivityFilter();</span>
<span class="nc" id="L292">				filter.setTimeoff(true);</span>
<span class="nc" id="L293">				m_currentOrgTimeOffActivities = ActivityModelHandler.getActivities(m_context, </span>
<span class="nc" id="L294">						Collections.singletonList(getSelectedIDObject()), filter, false, ActivityProperties.TIME_OFF_TIME);</span>

				//Get all of the system org's default special activities.
<span class="nc" id="L297">				Collection systemSpecialActivities = ActivityModelHandler.getActivitiesByIDs(m_context, Arrays.asList(specialActivityIDs));</span>
<span class="nc" id="L298">				m_systemSpecialActivityIdNameMap = buildActivityIdNameMap(systemSpecialActivities);</span>

				//Get the Vacation activity currently set for the current organization.
<span class="nc" id="L301">				m_currentVacationActivity = ActivityModelHandler.getVacationOverride(m_context, getSelectedIDObject());</span>

				//Get the default Vacation activity (this will be the Vacation activity available at the parent org).
<span class="nc" id="L304">				ID parentOrgID = getOrganization(getSelectedIDObject()).getParentID();</span>
<span class="nc" id="L305">				m_parentVacationActivity = ActivityModelHandler.getVacationOverride(m_context, parentOrgID);</span>
			}
		}
<span class="nc" id="L308">		catch (Exception ex) </span>
		{
<span class="nc" id="L310">			m_currentOrgTimeOffActivities = null;</span>
<span class="nc" id="L311">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L312">			m_initFailure = true;</span>
<span class="nc" id="L313">		}</span>
<span class="nc" id="L314">	}</span>
	
	/**
	 * Check whether the given activity ID is a special activity.
	 * @param activityID
	 * @return
	 */
	public static boolean isSpecialActivity(ID activityID)
	{
<span class="nc bnc" id="L323" title="All 2 branches missed.">		for (int i=0; i&lt;specialActivityIDs.length; i++)</span>
		{
<span class="nc bnc" id="L325" title="All 2 branches missed.">			if (specialActivityIDs[i].equals(activityID))</span>
<span class="nc" id="L326">				return true;</span>
		}
<span class="nc" id="L328">		return false;</span>
	}
	
	/**
	 * Return Collection of Activities StringsPair (String activityId, String activityName)
	 * for  given collection of activities
	 */
	public static Collection getActivitiesStringsPair(Collection activities)
	{
<span class="nc bnc" id="L337" title="All 4 branches missed.">		if (activities == null || activities.isEmpty()) {</span>
<span class="nc" id="L338">			return new ArrayList();</span>
		}
<span class="nc" id="L340">		Collection activitiesStringsPair = new ArrayList(activities.size());</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">		for (Iterator it = activities.iterator(); it.hasNext();) {</span>
<span class="nc" id="L342">			Activity activity = (Activity) it.next();</span>
<span class="nc" id="L343">			activitiesStringsPair.add(new StringsPair(</span>
<span class="nc" id="L344">					activity.getId().toString(), activity.getName()));</span>
<span class="nc" id="L345">		}</span>
<span class="nc" id="L346">		return activitiesStringsPair;</span>
	}

	/**
	 * Create a hashmap activityID, activityName (key, value) combination
	 * return HashMap of activityID, activityName
	 */
	public static Map buildActivityIdNameMap(Collection activities)
	{
<span class="nc bnc" id="L355" title="All 4 branches missed.">		if (activities == null || activities.isEmpty()) {</span>
<span class="nc" id="L356">			return Collections.emptyMap();</span>
		}
<span class="nc" id="L358">		HashMap activityMap = new HashMap(activities.size());</span>
<span class="nc bnc" id="L359" title="All 4 branches missed.">		if (activities != null &amp;&amp; activities.size() &gt; 0) {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">			for (Iterator it = activities.iterator(); it.hasNext();) {</span>
<span class="nc" id="L361">				Activity activity = (Activity) it.next();</span>
<span class="nc" id="L362">				activityMap.put(activity.getId(), activity.getName());</span>
<span class="nc" id="L363">			}</span>
		}
<span class="nc" id="L365">		return activityMap;</span>
	}
	
	/**
	 * Create a hashmap of activity ID, Activity (value object).
	 * We only use the given activities collection to populate the map.
	 */
	public static Map buildActivityMap(Collection activities)
	{
<span class="nc bnc" id="L374" title="All 4 branches missed.">		if (activities == null || activities.isEmpty()) {</span>
<span class="nc" id="L375">			return Collections.emptyMap();</span>
		}
<span class="nc" id="L377">		HashMap activityMap = new HashMap(activities.size());</span>
<span class="nc bnc" id="L378" title="All 4 branches missed.">		if (activities != null &amp;&amp; activities.size() &gt; 0) {</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">			for (Iterator it = activities.iterator(); it.hasNext();) {</span>
<span class="nc" id="L380">				Activity activity = (Activity) it.next();</span>
<span class="nc" id="L381">				activityMap.put(activity.getID(), activity);</span>
<span class="nc" id="L382">			}</span>
		}
<span class="nc" id="L384">		return activityMap;</span>
	}	
	
	/**
	 * Initialize Form Display
	 */
	protected void createCollapsibleContainers() 
	{
		try
		{
			//The Vacation type is a full override
<span class="nc" id="L395">			m_activityVacationFormPC = new Collapsible2ColFormPC(m_context);</span>
<span class="nc" id="L396">			initActivityForm(m_activityVacationFormPC, &quot;ACTIVITY_VACATION&quot;, Activity.ACTIVITY_VACATION);			</span>

			//The other special types only allow override of the Adherence Tolerance and Max Time In Activity attributes
<span class="nc" id="L399">			m_activityNoneFormPC = new SpecialActivityAttributes(m_context, m_bbmBundle);</span>
<span class="nc" id="L400">			initActivityForm(m_activityNoneFormPC, &quot;ACTIVITY_NONE&quot;, Activity.ACTIVITY_NONE);</span>
			
<span class="nc" id="L402">			m_activityUnknownFormPC = new SpecialActivityAttributes(m_context, m_bbmBundle);</span>
<span class="nc" id="L403">			initActivityForm(m_activityUnknownFormPC, &quot;ACTIVITY_UNKNOWN&quot;, Activity.ACTIVITY_UNKNOWN);</span>
			
			//prevent user from overriding values that he could set on the Activity Edit page
<span class="nc" id="L406">			m_activityGapFormPC = new SpecialActivityAttributes(m_context, m_bbmBundle);</span>
<span class="nc" id="L407">			initActivityForm(m_activityGapFormPC, &quot;ACTIVITY_SHIFT_OVERTIME_GAP&quot;, Activity.ACTIVITY_SHIFT_OVERTIME_GAP);</span>
			
<span class="nc" id="L409">			m_activityVtoFormPC = new SpecialActivityAttributes(m_context, m_bbmBundle);</span>
<span class="nc" id="L410">			initActivityForm(m_activityVtoFormPC, &quot;ACTIVITY_VOLUNTARY_TIMEOFF&quot;, Activity.ACTIVITY_VOLUNTARY_TIMEOFF);</span>
			
<span class="nc" id="L412">			m_activityLearningBreakFormPC = new SpecialActivityAttributes(m_context, m_bbmBundle);</span>
<span class="nc" id="L413">			initActivityForm(m_activityLearningBreakFormPC, &quot;ACTIVITY_LEARNING_BREAK&quot;, Activity.ACTIVITY_LEARNING_BREAK);</span>
			
<span class="nc" id="L415">			m_activityCoachingFormPC = new SpecialActivityAttributes(m_context, m_bbmBundle);</span>
<span class="nc" id="L416">			initActivityForm(m_activityCoachingFormPC, &quot;ACTIVITY_COACHING&quot;, Activity.ACTIVITY_COACHING);</span>
		}
<span class="nc" id="L418">		catch (Exception ex) </span>
		{
<span class="nc" id="L420">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L421">			m_initFailure = true;</span>
<span class="nc" id="L422">		}</span>
<span class="nc" id="L423">	}</span>
	
	/**
	 * Initialize Form Display
	 */
	protected void initActivityForm(Collapsible2ColFormPC formPC, String formName, ID specialActivityID) 
	{
<span class="nc" id="L430">		formPC.setName(formName);</span>
<span class="nc" id="L431">		addChildComponent(formPC);</span>
<span class="nc" id="L432">	}</span>

	/**
	 * Initialize Form Display
	 */
	protected void initForm() 
	{
		try
		{
			//The Vacation type is a full override
<span class="nc" id="L442">			String specialActivityName = (String)m_systemSpecialActivityIdNameMap.get(Activity.ACTIVITY_VACATION);</span>
<span class="nc" id="L443">			m_activityVacationFormPC.setTitle(specialActivityName);		</span>
<span class="nc" id="L444">			m_activityVacationFormPC.addRow(specialActivityName, getVacationActivityDropDown());</span>
				
			//The other special types only allow override of the Adherence Tolerance and Max Time In Activity attributes
<span class="nc" id="L447">			specialActivityName = (String)m_systemSpecialActivityIdNameMap.get(Activity.ACTIVITY_NONE);	</span>
<span class="nc" id="L448">			m_activityNoneFormPC.initForm(Activity.ACTIVITY_NONE, specialActivityName, getTolerance(Activity.ACTIVITY_NONE), getDuration(Activity.ACTIVITY_NONE), </span>
					true, m_hiddenFields, m_isFormEditable);
			
<span class="nc" id="L451">			specialActivityName = (String)m_systemSpecialActivityIdNameMap.get(Activity.ACTIVITY_UNKNOWN);</span>
<span class="nc" id="L452">			m_activityUnknownFormPC.initForm(Activity.ACTIVITY_UNKNOWN, specialActivityName, getTolerance(Activity.ACTIVITY_UNKNOWN), getDuration(Activity.ACTIVITY_UNKNOWN), </span>
					true, m_hiddenFields, m_isFormEditable);
	
			//prevent user from overriding values that he could set on the Activity Edit page
<span class="nc" id="L456">			specialActivityName = (String)m_systemSpecialActivityIdNameMap.get(Activity.ACTIVITY_SHIFT_OVERTIME_GAP);</span>
<span class="nc" id="L457">			m_activityGapFormPC.initForm(Activity.ACTIVITY_SHIFT_OVERTIME_GAP, specialActivityName, getTolerance(Activity.ACTIVITY_SHIFT_OVERTIME_GAP), getDuration(Activity.ACTIVITY_SHIFT_OVERTIME_GAP), </span>
					true, m_hiddenFields, m_isFormEditable);
		
<span class="nc" id="L460">			specialActivityName = (String)m_systemSpecialActivityIdNameMap.get(Activity.ACTIVITY_VOLUNTARY_TIMEOFF);</span>
<span class="nc" id="L461">			m_activityVtoFormPC.initForm(Activity.ACTIVITY_VOLUNTARY_TIMEOFF, specialActivityName, getTolerance(Activity.ACTIVITY_VOLUNTARY_TIMEOFF), getDuration(Activity.ACTIVITY_VOLUNTARY_TIMEOFF), </span>
					true, m_hiddenFields, m_isFormEditable);
		
<span class="nc" id="L464">			specialActivityName = (String)m_systemSpecialActivityIdNameMap.get(Activity.ACTIVITY_LEARNING_BREAK);</span>
<span class="nc" id="L465">			m_activityLearningBreakFormPC.initForm(Activity.ACTIVITY_LEARNING_BREAK, specialActivityName, getTolerance(Activity.ACTIVITY_LEARNING_BREAK), getDuration(Activity.ACTIVITY_LEARNING_BREAK), </span>
					true, m_hiddenFields, m_isFormEditable);
		
<span class="nc" id="L468">			specialActivityName = (String)m_systemSpecialActivityIdNameMap.get(Activity.ACTIVITY_COACHING);</span>
<span class="nc" id="L469">			m_activityCoachingFormPC.initForm(Activity.ACTIVITY_COACHING, specialActivityName, getTolerance(Activity.ACTIVITY_COACHING), getDuration(Activity.ACTIVITY_COACHING), </span>
					true, m_hiddenFields, m_isFormEditable);
		}
<span class="nc" id="L472">		catch (Exception ex) </span>
		{
<span class="nc" id="L474">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L475">			m_initFailure = true;</span>
<span class="nc" id="L476">		}</span>
<span class="nc" id="L477">	}</span>
	
	/**
	 * Ex: &quot;None&quot;, &quot;Vto&quot;, etc. These are used for constructing the form element names
	 */
	protected static String getActivityType(ID activityID)
	{
<span class="nc bnc" id="L484" title="All 2 branches missed.">		if (activityID.equals(Activity.ACTIVITY_NONE))</span>
<span class="nc" id="L485">			return &quot;None&quot;;</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">		else if (activityID.equals(Activity.ACTIVITY_UNKNOWN))</span>
<span class="nc" id="L487">			return &quot;Unknown&quot;;</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">		else if (activityID.equals(Activity.ACTIVITY_SHIFT_OVERTIME_GAP))</span>
<span class="nc" id="L489">			return &quot;Gap&quot;;</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">		else if (activityID.equals(Activity.ACTIVITY_VOLUNTARY_TIMEOFF))</span>
<span class="nc" id="L491">			return &quot;Vto&quot;;</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">		else if (activityID.equals(Activity.ACTIVITY_LEARNING_BREAK))</span>
<span class="nc" id="L493">			return &quot;LearningBreak&quot;;</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">		else if (activityID.equals(Activity.ACTIVITY_COACHING))</span>
<span class="nc" id="L495">			return &quot;Coaching&quot;;</span>
		else
<span class="nc" id="L497">			return &quot;&quot;;</span>
	}
	
	protected SpecialActivityAttributes getAttributesPC(ID activityID)
	{
<span class="nc bnc" id="L502" title="All 2 branches missed.">		if (activityID.equals(Activity.ACTIVITY_NONE))</span>
<span class="nc" id="L503">			return m_activityNoneFormPC;</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">		else if (activityID.equals(Activity.ACTIVITY_UNKNOWN))</span>
<span class="nc" id="L505">			return m_activityUnknownFormPC;</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">		else if (activityID.equals(Activity.ACTIVITY_SHIFT_OVERTIME_GAP))</span>
<span class="nc" id="L507">			return m_activityGapFormPC;</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">		else if (activityID.equals(Activity.ACTIVITY_VOLUNTARY_TIMEOFF))</span>
<span class="nc" id="L509">			return m_activityVtoFormPC;</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">		else if (activityID.equals(Activity.ACTIVITY_LEARNING_BREAK))</span>
<span class="nc" id="L511">			return m_activityLearningBreakFormPC;</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">		else if (activityID.equals(Activity.ACTIVITY_COACHING))</span>
<span class="nc" id="L513">			return m_activityCoachingFormPC;</span>
		else
<span class="nc" id="L515">			return null;</span>
	}
	
	/**
	 * Return the DropDown display of a special activity type. 
	 */
	protected String getVacationActivityDropDown() 
	{
<span class="nc bnc" id="L523" title="All 2 branches missed.">		if (m_parentVacationActivity != null) </span>
		{
			//add all of the activities created at this org to the list of options
<span class="nc" id="L526">			HashSet allActivityOptions = new HashSet(m_currentOrgTimeOffActivities);</span>
			
			//get the parent special activity of this type, and add it to the list of options. This will be the &quot;default&quot; option.
<span class="nc" id="L529">			allActivityOptions.add(m_parentVacationActivity);		</span>
			
			//add the current org's vacation override. This will uaually already be in m_currentOrgTimeOffActivities or m_parentVacationActivity,
			//except in the case where someone unchecks isTimeoff for an activity that had previously been used as a vacation override (QC78855).
<span class="nc" id="L533">			allActivityOptions.add(m_currentVacationActivity);	</span>
		
			//sort the options
<span class="nc" id="L536">			Collection activityStringPairs = getSortedActivityStringPairs(allActivityOptions);</span>

<span class="nc" id="L538">			return HtmlUtil.makeSelectInput(&quot;specialVacationActivity&quot;,</span>
					&quot;&quot;,
<span class="nc" id="L540">					new String[]{getSelectedVacationActivityID().toString()}, </span>
					JSUtil.ON_CHANGE,
					activityStringPairs,
					&quot;200&quot;);
		}
		else 
		{
<span class="nc" id="L547">			return &quot;&amp;nbsp;&quot;;</span>
		}
	}
	
	/**
	 * Determines which ID should be selected in the corresponding dropdown. When the user first navigates
	 * to the page (or if they click Cancel on the page), we will get the value from the database. But, if 
	 * the user has clicked Save and the form is redisplaying, we need to get the values selected by the 
	 * user, even if they were not saved to the database (due to validation errors, etc).
	 */
	protected ID getSelectedVacationActivityID()
	{
<span class="nc" id="L559">		String sSelectedID = m_context.getParameter(&quot;specialVacationActivity&quot;);</span>
<span class="nc" id="L560">		ID selectedID = null;</span>
		
<span class="nc bnc" id="L562" title="All 6 branches missed.">		if (((sSelectedID == null) || m_cancelled) &amp;&amp; m_currentVacationActivity != null)</span>
		{
<span class="nc" id="L564">			selectedID = m_currentVacationActivity.getID();</span>
		}
		else
		{
<span class="nc" id="L568">			selectedID = new ID(sSelectedID);</span>
		}
		
<span class="nc" id="L571">		return selectedID;</span>
	}

	
	protected boolean isDurationUnlimited(int duration) {
<span class="nc bnc" id="L576" title="All 2 branches missed.">		return duration == SpecialActivityAttributes.MAX_DURATION_DEFAULT_MIN;</span>
	}	
	
	protected int getDuration(ID activityID) throws Exception
	{
<span class="nc" id="L581">		int duration = 0;		</span>
<span class="nc" id="L582">		String activityType = getActivityType(activityID);</span>
<span class="nc" id="L583">		String durationFN = ActivityFields.MAX_DURATION_FN+activityType;		</span>
<span class="nc" id="L584">		String strDuration = m_context.getParameter(durationFN);</span>
		
<span class="nc bnc" id="L586" title="All 4 branches missed.">		if (m_cancelled || (strDuration==null))  //StringUtil.isEmpty</span>
<span class="nc" id="L587">			duration = getDurationFromDB(activityID);</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">		else if (strDuration.length()==0)</span>
<span class="nc" id="L589">			duration = SpecialActivityAttributes.MAX_DURATION_DEFAULT_MIN;</span>
		else
<span class="nc" id="L591">			duration = Integer.parseInt(strDuration);</span>
		
<span class="nc" id="L593">		String durationCheckboxFN = ActivityFields.MAX_DURATION_CHKBOX_FN+activityType;		</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">		if (isChecked(durationCheckboxFN)) //if not null, then it must be checked. If null, then it must be unchecked. </span>
<span class="nc" id="L595">			duration = SpecialActivityAttributes.MAX_DURATION_DEFAULT_MIN;</span>
		
<span class="nc" id="L597">		getAttributesPC(activityID).setDurationUnlimited(isDurationUnlimited(duration));</span>
		
<span class="nc" id="L599">		return duration;</span>
	}
	
	protected boolean isChecked(String checkboxName)
	{
<span class="nc" id="L604">		String strDurationCheckbox = m_context.getParameter(checkboxName);</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">		return (strDurationCheckbox != null); //if not null, then it must be checked. If null, then it must be unchecked. </span>
	}
	
	protected int getDurationFromDB(ID activityID) throws Exception
	{
<span class="nc" id="L610">		return ActivityModelHandler.getMaxDurationOverride(m_context, getSelectedIDObject(), activityID);		</span>
	}	
	
	protected int getTolerance(ID activityID) throws Exception
	{
<span class="nc" id="L615">		String activityType = getActivityType(activityID);</span>
<span class="nc" id="L616">		String toleranceFN = ActivityFields.TOLERANCE_FN+activityType;</span>
		
<span class="nc" id="L618">		String strTolerance = m_context.getParameter(toleranceFN);</span>
<span class="nc bnc" id="L619" title="All 4 branches missed.">		if (m_cancelled || (strTolerance == null))</span>
<span class="nc" id="L620">			return getToleranceFromDB(activityID);</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">		else if (strTolerance.length() == 0)</span>
<span class="nc" id="L622">			return SpecialActivityAttributes.TOLERANCE_DEFAULT_MIN;</span>
		
<span class="nc" id="L624">		return Integer.parseInt(strTolerance);</span>
	}
	
	protected int getToleranceFromDB(ID activityID) throws Exception
	{
<span class="nc" id="L629">		return ActivityModelHandler.getAdherenceToleranceOverride(m_context, getSelectedIDObject(), activityID);		</span>
	}	
	
	/**
	 * Setes whether or not the user clicked the &quot;Cancel&quot; button.
	 */
	public void setCancelled(boolean cancelled)
	{
<span class="nc" id="L637">		m_cancelled = cancelled;</span>
<span class="nc" id="L638">	}	</span>
	
	/**
	 * Given a list of Activity value objects, return a list of StringPairs (ID string, name string) sorted by name.
	 */
	protected Collection getSortedActivityStringPairs(Collection activities)
	{
<span class="nc" id="L645">		ArrayList pairs = new ArrayList();</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">		for (Iterator it=activities.iterator(); it.hasNext();)</span>
		{
<span class="nc" id="L648">			Activity activity = (Activity)it.next();</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">			if (activity != null)</span>
			{
<span class="nc" id="L651">				StringsPair pair = new StringsPair(activity.getID().toString(), activity.getName());</span>
<span class="nc" id="L652">				pairs.add(pair);</span>
			}
<span class="nc" id="L654">		}</span>
		
<span class="nc" id="L656">		Collections.sort(pairs);</span>
<span class="nc" id="L657">		return pairs;</span>
	}

	/**
	 * Return true if selected Org is valid; Override parent method to allow editing
	 * of activities define in the root (system)level
	 */
	protected boolean isValidSelectedOrg() {
<span class="nc" id="L665">		return hasSelectedID();</span>
	}

	/**
	 * Return true if Current User is authorized to configure specified Organization
	 */
	protected boolean isAuthorizedToView(ID orgID) {
<span class="nc" id="L672">		return m_context.getUser().isAuthorized(PrivilegeKeys.CORE_VIEWACTIVITIES,</span>
<span class="nc" id="L673">				OrganizationScopeManagerProxy.getScopeID(orgID));</span>
	}


	/**
	 * Return true if Current User is authorized to configure specified Organization
	 */
	protected boolean isAuthorizedToConfigure(ID orgID) {
<span class="nc" id="L681">		return m_context.getUser().isAuthorized(PrivilegeKeys.CORE_VIEWACTIVITIES,</span>
<span class="nc" id="L682">				OrganizationScopeManagerProxy.getScopeID(orgID));</span>
	}


	/**
	 * Return localized message indicating that current user is not authorized
	 * to view activities in the selected Organization.
	 */
	protected String getNotAuthorizedToViewMsg() {
<span class="nc" id="L691">		return MessageFormat.format(</span>
<span class="nc" id="L692">			i18n(m_bbmBundle, BbmWebBundleKey.NOT_AUTHORIZED_TO_VIEW_ENTITY_IN_SELECTED_ORG),</span>
<span class="nc" id="L693">			new Object[] { i18n(m_bbmBundle, BbmWebBundleKey.BBM_ORG_ACTIVITIES) } );</span>
	}
	
	/**
	 * Return true if Current User is authorized to configure activity AM attributes
	 */
	protected boolean isAuthorizedToConfigureAMAttributes(ID orgID) {
<span class="nc" id="L700">		return m_context.getUser().isAuthorized(PrivilegeKeys.CORE_VIEWACTIVITIES,</span>
<span class="nc" id="L701">				OrganizationScopeManagerProxy.getScopeID(orgID));</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>