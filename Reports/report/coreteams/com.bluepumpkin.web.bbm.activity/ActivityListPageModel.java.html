<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActivityListPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.activity</a> &gt; <span class="el_source">ActivityListPageModel.java</span></div><h1>ActivityListPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.activity;

import java.text.MessageFormat;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.workresource.OrganizationScopeManagerProxy;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.web.bbm.Log;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrgWorkpaneListPageModel;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.verint.web.wfm.keys.WfmJavaScriptFileID;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        ActivityListPageModel
 * Description:  Display the list of Activity per given organization
 * Copyright:    Copyright (c) 2001, 2017
 * Company:      Blue Pumpkin Software, inc
 * @author       Shimon Kakon
 * @version 1.0
 */
public class ActivityListPageModel extends OrgWorkpaneListPageModel {
<span class="fc" id="L33">	private static final Category log = Log.initCategory(ActivityListPageModel.class.getName());</span>
	private Collection&lt;Activity&gt; m_activities;

<span class="fc" id="L36">	private static final HashSet NO_DELETION_ACTIVITIES = new HashSet();</span>
	static {
<span class="fc" id="L38">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_COACHING);</span>
<span class="fc" id="L39">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_LEARNING_START);</span>
<span class="fc" id="L40">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_LEARNING_END);</span>
<span class="fc" id="L41">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_LEARNING_BREAK);</span>
<span class="fc" id="L42">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_NONE);</span>
<span class="fc" id="L43">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_SHIFT_OVERTIME_GAP);</span>
<span class="fc" id="L44">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_UNKNOWN);</span>
<span class="fc" id="L45">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_VACATION);</span>
<span class="fc" id="L46">		NO_DELETION_ACTIVITIES.add(Activity.ACTIVITY_VOLUNTARY_TIMEOFF);</span>
<span class="fc" id="L47">	}</span>

	/**
	 * Constructor
	 *
	 * @param context the request context
	 */
	public ActivityListPageModel(RequestContext context) {
<span class="fc" id="L55">		super(context);</span>
<span class="fc" id="L56">	}</span>

	/**
	 * Initialize Component For Display
	 */
	public void initForDisplay() {
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">		if (m_isInitializedForDisplay) return;</span>
		else {
<span class="fc" id="L64">			super.initForDisplay();</span>

			// Add JavaScript Variables
<span class="fc" id="L67">			addJSVariable(DELETE_CONFIRMATION, m_bbmBundle, BbmWebBundleKey.ACTIVITY_DELETE_CONFIRMATION);</span>

<span class="fc" id="L69">			addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE_LIST);</span>
<span class="fc" id="L70">			setJSMediator(WfmJavaScriptFileID.MEDIATOR_ACTIVITY_WORKPANE_LIST);</span>

			// Enable Object Copy
<span class="fc" id="L73">			initCopyObjType(Activity.OBJECT_TYPE_ACTIVITY);</span>
		}
<span class="fc" id="L75">	}</span>


	/**
	 * Return instance of Model which is ready to be rendered
	 *
	 * @param context - The request context
	 * @return Activity List PageModel
	 */
	public static ActivityListPageModel getInstance(RequestContext context) {
<span class="fc" id="L85">		return (ActivityListPageModel)getInstance(context, ActivityListPageModel.class);</span>
	}

	/**
	 * get URL for HTML Form Action
	 *
	 * @return the form action
	 */
	public String getFormAction() {
<span class="fc" id="L94">		return &quot;activity_list&quot;;</span>
	}

	/**
	 * Initialize toolbar.
	 * Override default toolbar defined in WorkpaneListPageModel
	 */
	protected void initToolbar() {
		///*[Swati]: London
<span class="fc" id="L103">		String addLabel = i18n(m_bbmBundle,	BbmWebBundleKey.ACTIVITY_CREATE_NEW_ACTION);</span>
<span class="fc" id="L104">		String copyLabel = i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_COPY_ACTION);</span>
<span class="fc" id="L105">		String editLabel = i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_EDIT_ACTION);</span>
<span class="fc" id="L106">		String delLabel = i18n(m_bbmBundle,	BbmWebBundleKey.ACTIVITY_DELETE_ACTION);</span>
<span class="fc" id="L107">		useDefaultToolbar(false, addLabel, copyLabel, editLabel, delLabel);</span>
<span class="fc" id="L108">	}</span>

	/**
	 * Create the list model
	 */
	protected void createListModel(){
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">		if(!this.loadActivities()) {</span>
<span class="nc" id="L115">			return;</span>
		}

<span class="fc" id="L118">		this.removeChildComponent(m_list);</span>
<span class="fc" id="L119">		m_list = new ActivityListPC(getRequestContext(), &quot;activityTable&quot;, m_activities, true, true) {</span>
			@Override
			protected void setRowAttributes(DefaultMultiColumnNodeData mcnd, Activity activity) {
<span class="fc" id="L122">				super.setRowAttributes(mcnd, activity);</span>
<span class="fc" id="L123">				HashMap&lt;String, String&gt; nodeAttributes = mcnd.getNodeAttributes();</span>
<span class="fc" id="L124">				nodeAttributes.put(IS_EDITABLE,	isRowEditable(activity.getOrganizationId()));</span>
<span class="fc" id="L125">				nodeAttributes.put(IS_DELETEABLE, isRowDeleteable(activity.getId(), activity.getOrganizationId()));</span>
<span class="fc" id="L126">				nodeAttributes.put(IS_COPYABLE, isRowCopyable(activity.getId(), activity.getOrganizationId()));</span>
<span class="fc" id="L127">				nodeAttributes.put(COPY_ITEM_NAME, activity.getName());</span>
	
				// Check if row should be selected, assuming only one should be selected
<span class="fc bfc" id="L130" title="All 2 branches covered.">				if (OrganizationModelHandler.UNREASONABLE_ORG_ID.equals(m_selectedRowOrgID)) {</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">					if(isRowSelected(activity.getID())) {</span>
<span class="fc" id="L132">						m_list.addSelectedRowID(activity.getID().toString());</span>
<span class="fc" id="L133">						m_selectedRowOrgID = activity.getOrganizationId();</span>
					}
				}
<span class="fc" id="L136">			}</span>
		};
		
		// Enable List Sorting
		//m_list.getHeader().setDefaultSortColumn(ActivityFields.NAME_FN);				
<span class="fc" id="L141">		removeChildComponent(m_list);</span>
<span class="fc" id="L142">    	addChildComponent(m_list);</span>
<span class="fc" id="L143">		m_list.setIsAutoSortEnabled(true);</span>
<span class="fc" id="L144">		m_list.extractParameters(m_context.getRequest());</span>
		
<span class="fc" id="L146">		m_list.setMultiRowSelectable(false);</span>
<span class="fc" id="L147">	}</span>

	/**
	 * Get entity name. Used for title.
	 */
	protected String getTitleEntityType() {
<span class="fc" id="L153">		return i18n(m_bbmBundle, BbmWebBundleKey.ACTIVITY_LIST_TITLE);</span>
	}



	/**
	 * Loads all the activity value objects
	 *
	 * @return true if load was successful
	 */
	private boolean loadActivities() {
		try {
			// Load all the activities value objects
<span class="fc" id="L166">			m_activities = ActivityModelHandler.getActivitiesFilterActivities(m_context, getSelectedIDObject(),</span>
				new ActivityFilter(), new ID[]{Activity.ACTIVITY_DELETED});
<span class="fc" id="L168">			return true;</span>
<span class="nc" id="L169">		} catch (Exception ex) {</span>
<span class="nc" id="L170">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L171">			return false;</span>
		}
	}


	/**
	 * Return true if Current User is authorized to configure specified Organization
	 */
	protected boolean isAuthorizedToView(ID orgID) {
<span class="fc" id="L180">		return m_context.getUser().isAuthorized(PrivilegeKeys.CORE_VIEWACTIVITIES,</span>
<span class="fc" id="L181">				OrganizationScopeManagerProxy.getScopeID(orgID));</span>
	}


	/**
	 * Return true if Current User is authorized to configure specified Organization
	 */
	protected boolean isAuthorizedToConfigure(ID orgID) {
<span class="fc" id="L189">		return m_context.getUser().isAuthorized(PrivilegeKeys.CORE_EDITACTIVITIES,</span>
<span class="fc" id="L190">				OrganizationScopeManagerProxy.getScopeID(orgID));</span>
	}
	

	/**
	 * Return localized message indicating that current user is not authorized
	 * to view activities in the selected Organization.
	 */
	protected String getNotAuthorizedToViewMsg() {
<span class="nc" id="L199">		return MessageFormat.format(</span>
<span class="nc" id="L200">			i18n(m_bbmBundle, BbmWebBundleKey.NOT_AUTHORIZED_TO_VIEW_ENTITY_IN_SELECTED_ORG),</span>
<span class="nc" id="L201">			new Object[] { i18n(m_bbmBundle, BbmWebBundleKey.BBM_ORG_ACTIVITIES) } );</span>
	}

	/**
	 * Is the list row editable?
	 * Override parent to allow editing of activities defined in the root
	 *
	 * @param rowOrgID the row's organization ID
	 * @return &quot;true&quot; if a row is editable, &quot;false&quot; otherwise
	 *
	 */
	protected String isRowEditable(ID rowOrgID) {
<span class="fc bfc" id="L213" title="All 2 branches covered.">		if(rowOrgID.equals(Organization.ROOT_ORG_ID_OBJ)) {</span>
<span class="fc" id="L214">			return super.isRowEditable(Organization.YOUR_COMPANY_ID_OBJ);</span>
		}
		else {
<span class="fc" id="L217">			return super.isRowEditable(rowOrgID);</span>
		}
	}		

	/**
	 * Is the list row delete-able?
	 * Activities defined in the root should never be deleteable
	 *
	 * @param rowOrgID the row's organization ID
	 * @return &quot;true&quot; if a row is editable, &quot;false&quot; otherwise
	 *
	 */
	protected String isRowDeleteable(ID activityID, ID rowOrgID) {
<span class="fc bfc" id="L230" title="All 2 branches covered.">		if ( rowOrgID.equals(Organization.ROOT_ORG_ID_OBJ)</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">				|| NO_DELETION_ACTIVITIES.contains(activityID) ) {</span>
<span class="fc" id="L232">			return &quot;false&quot;;</span>
		}
		else {
<span class="fc" id="L235">			String deleteable = &quot;false&quot;;</span>

<span class="fc" id="L237">			ID selectedOrgID = getSelectedIDObject();</span>
<span class="fc" id="L238">			boolean isAuthorizedToDelete= m_context.getUser().isAuthorized(PrivilegeKeys.CORE_DELETEACTIVITIES,</span>
<span class="fc" id="L239">					OrganizationScopeManagerProxy.getScopeID(selectedOrgID)); </span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">			if ( selectedOrgID != null &amp;&amp;</span>
<span class="pc bpc" id="L241" title="1 of 4 branches missed.">					 selectedOrgID.equals(rowOrgID) &amp;&amp; isAuthorizedToDelete ) {</span>
<span class="fc" id="L242">				deleteable = &quot;true&quot;;</span>
			}

<span class="fc" id="L245">			return deleteable;</span>
		}
	}

	/**
	 * Is the list row copy-able?
	 * Activities defined in the root should never be copyable
	 *
	 * @param rowOrgID the row's organization ID
	 * @return &quot;true&quot; if a row is editable, &quot;false&quot; otherwise
	 *
	 */
	protected String isRowCopyable(ID activityID, ID rowOrgID) {
<span class="fc bfc" id="L258" title="All 2 branches covered.">		if ( rowOrgID.equals(Organization.ROOT_ORG_ID_OBJ)</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">				|| NO_DELETION_ACTIVITIES.contains(activityID) ) {			</span>
<span class="fc" id="L260">			return &quot;false&quot;;</span>
		}
		else {
<span class="fc" id="L263">			return super.isRowEditable(rowOrgID);</span>
		}
	}


	/**
	 * is the edit/delete actions should be enabled?
	 * Override parent to allow editing of activities defined in the root
	 *
	 * @param isSuperEnabled the result from the super class &quot;decision&quot;
	 * @return true if super returns true and the selected row org id
	 * equals to the selected organization org id
	 */
	protected boolean isEditDeleteActionsEnabled(boolean isSuperEnabled) {
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">		if(m_selectedRowOrgID.equals(Organization.ROOT_ORG_ID_OBJ)) {</span>
<span class="nc" id="L278">			boolean isEnabled = Organization.YOUR_COMPANY_ID_OBJ.equals(getSelectedIDObject());</span>
<span class="nc bnc" id="L279" title="All 4 branches missed.">			return (isEnabled &amp;&amp; isSuperEnabled);</span>
		}
		else {
<span class="fc" id="L282">			return super.isEditDeleteActionsEnabled(isSuperEnabled);</span>
		}
	}

	/**
	 * is the add action should be enabled?
	 */
	protected boolean isAddActionEnabled() {
<span class="fc" id="L290">		boolean isAuthorizedToAdd= m_context.getUser().isAuthorized(PrivilegeKeys.CORE_ADDACTIVITIES,</span>
<span class="fc" id="L291">				OrganizationScopeManagerProxy.getScopeID(getSelectedIDObject()));</span>
<span class="fc" id="L292">		return isAuthorizedToAdd;</span>
	}

	

	/**
	 * is the edit action should be enabled?
	 */
	protected boolean isEditActionEnabled() {
<span class="fc" id="L301">		boolean isSuperEnabled = super.isEditActionEnabled();</span>
<span class="fc" id="L302">		boolean isAuthorizedToEdit= m_context.getUser().isAuthorized(PrivilegeKeys.CORE_EDITACTIVITIES,</span>
<span class="fc" id="L303">				OrganizationScopeManagerProxy.getScopeID(getSelectedIDObject()));</span>
<span class="pc bpc" id="L304" title="1 of 4 branches missed.">		return isEditDeleteActionsEnabled(isSuperEnabled) &amp;&amp;isAuthorizedToEdit;</span>
	}

	/**
	 * is the delete action should be enabled?
	 * * Override parent to prevent deletion of activities defined in the root
	 */
	protected boolean isDeleteActionEnabled() {
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">		if(m_selectedRowOrgID.equals(Organization.ROOT_ORG_ID_OBJ)) {</span>
<span class="nc" id="L313">			return false;</span>
		}
		else {
<span class="fc" id="L316">			boolean isSuperEnabled = super.isDeleteActionEnabled();</span>
<span class="fc" id="L317">			boolean isAuthorizedToDelete= m_context.getUser().isAuthorized(PrivilegeKeys.CORE_DELETEACTIVITIES,</span>
<span class="fc" id="L318">					OrganizationScopeManagerProxy.getScopeID(getSelectedIDObject())); </span>
<span class="pc bpc" id="L319" title="1 of 4 branches missed.">			return isEditDeleteActionsEnabled(isSuperEnabled) &amp;&amp; isAuthorizedToDelete;</span>
		}
	}

	/**
	 * Returns true if the list support sorting.
	 * Override default toolbar defined in WorkpaneListPageModel
	 */
	protected boolean isSortSupported() {
<span class="fc" id="L328">		return true;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>