<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeRecordModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.am.timerecords</a> &gt; <span class="el_source">TimeRecordModel.java</span></div><h1>TimeRecordModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.am.timerecords;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.ResourceBundle;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.HtmlEncoder;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmTimePeriodOverlapException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeRecordException;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeEntrySourceCode;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeInterval;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecord;
import com.bluepumpkin.ejb.bbm.timerecord.model.TimeRecordEntry;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.profile.model.UserProfile;
import com.bluepumpkin.web.am.Log;
import com.bluepumpkin.web.am.keys.AmJavaScriptFileID;
import com.bluepumpkin.web.am.l10n.AmWebBundleKey;
import com.bluepumpkin.web.am.l10n.AmWebLogBundleKey;
import com.bluepumpkin.web.am.util.JSPUtil;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.helper.AccessRightHelper;
import com.bluepumpkin.web.core.user.profile.UserProfileManager;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.jsp.HtmlDiv;
import com.witness.web.uif.jsp.HtmlElement;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.list.MultiColListPC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarTextButton;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpanePageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.TimeZoneHelper;

/**
 * Title:        Blue Pumpkin Software Activity Management
 * Description:  Display the time records for an employee
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       Swati Tewari
 * @version 1.0
 */

public class TimeRecordModel extends WorkpanePageModel{
<span class="fc" id="L71">	private static Category cat  = Log.initCategory(TimeRecordModel.class.getName());</span>

	// Page Actions
	public static final String APPROVEDAY_ACTION = &quot;APPROVEDAY_ACTION&quot;;
	public static final String APPROVETR_ACTION = &quot;APPROVETR_ACTION&quot;;
	public static final String DELETETR_ACTION = &quot;DELETETR_ACTION&quot;;
	public static final String VIEWADHERENCE_ACTION = &quot;VIEWADHERENCE_ACTION&quot;;
	public static final String CANCEL_ACTION = &quot;CANCEL_ACTION&quot;;
	public static final String DONE_ACTION = &quot;DONE_ACTION&quot;;
	public static final String REFRESH_ACTION = &quot;REFRESH_ACTION&quot;;
	public static final String DELETETE_ACTION = &quot;DELETETE_ACTION&quot;;

	public static final String PREV_ACTION = &quot;PREV_ACTION&quot;;
	public static final String NEXT_ACTION = &quot;NEXT_ACTION&quot;;

	// field names
	public static final String SELECTED_DATE_FN = &quot;sel&quot;;

	public static final String LOAD_SCOPE_PRIV_ACTION = &quot;loadScopePriv&quot;;
	
	public static final String ARIA_LABELLEDBY_ID = &quot;viewTypeWithTime&quot;;

<span class="nc" id="L93">	private Collection timeRecordsForEmployee = new ArrayList();</span>
	private ID empId;
	private ID supervisorId;
	private ID orgId;
	private int recordId;
	private ID timeEntryID;
	private long version;
<span class="nc" id="L100">	private TimeRecord timeRecord = null;</span>
	private Date m_selectedDate;

	private boolean approved;
<span class="nc" id="L104">	private int selYear = -1;</span>
	private int selMonth;
	private int selDay;
<span class="nc" id="L107">	private long longDate = -1;</span>
	private ResourceBundle m_bundle;

<span class="nc" id="L110">	private String boundaryTimeSpan = null;</span>

<span class="nc" id="L112">	private ArrayList selectedIndex = new ArrayList();</span>
<span class="nc" id="L113">	private int detailSelectedIndex = -1;</span>
<span class="nc" id="L114">	private int mediatorNum = -1;</span>
<span class="nc" id="L115">	private int position = -1;</span>
<span class="nc" id="L116">	private boolean aggregated = false;</span>
	private boolean direction;

	// Contained List
<span class="nc" id="L120">	private TRDayDetailPC aPC = null;</span>
	private MultiColListPC aList;
	private DatePickerPC m_datePicker;

	//privilege variables
	int viewTRForEmployee;
<span class="nc" id="L126">	boolean approveTRPrivilege = false;</span>
<span class="nc" id="L127">	boolean editTRPrivilege = false;</span>
<span class="nc" id="L128">	boolean viewAdherencePrivilege = false;</span>
<span class="nc" id="L129">	boolean viewTIPrivilege = false;</span>
<span class="nc" id="L130">	boolean editTIPrivilege = false;</span>

<span class="nc" id="L132">	boolean isDayLocked = true;</span>
<span class="nc" id="L133">	boolean m_hasTRELicense = false;</span>

<span class="nc" id="L135">	private boolean m_isInitiated = false;</span>

	/**
	 * Constructor
	 */
	public TimeRecordModel(RequestContext context){
<span class="nc" id="L141">		super(context, PageModel.FRAMED_MODEL);</span>
<span class="nc" id="L142">	setDefaultPageIDSize(1);</span>
<span class="nc" id="L143">	setPageIDResizeEnabled(false);</span>

<span class="nc" id="L145">		m_bundle = m_localizer.getBundle(AmWebBundleKey.BUNDLE_NAME);</span>

		// Component specific required JavaScript Files
<span class="nc" id="L148">		addRequiredJavaScriptFile(JavaScriptFileID.MEDIATOR_WORKPANE);</span>
<span class="nc" id="L149">		setJSMediator(AmJavaScriptFileID.MEDIATOR_TRDAYDETAIL_WORKPANE);</span>
<span class="nc" id="L150">		addRequiredJavaScriptFile(JavaScriptFileID.DIALOG_PICKERS);</span>
<span class="nc" id="L151">		setName(&quot;workpaneMediator&quot;);</span>

<span class="nc bnc" id="L153" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L154">			aList= new MultiColListPC(m_context) {</span>
				@Override
				protected HtmlDiv getNewHtmlDiv() {
<span class="nc" id="L157">					HtmlDiv wrapper = super.getNewHtmlDiv();</span>
<span class="nc" id="L158">					wrapper.setAttribute(ATTR_ARIA_LABELLEDBY, ARIA_LABELLEDBY_ID);</span>
<span class="nc" id="L159">					wrapper.setStyle(&quot;margin: 2px&quot;);</span>
<span class="nc" id="L160">					return wrapper;</span>
				}
				
				@Override
				protected String getColHeaderText(int nCol) {
<span class="nc" id="L165">					return &quot;&quot;;</span>
				}
			};
<span class="nc" id="L168">			aList.setWrapperRegion(true);</span>
<span class="nc" id="L169">			aList.setAddListInfoEnabled(false);</span>
		} else {
<span class="nc" id="L171">			aList = new MultiColListPC(context);</span>
		}
		
<span class="nc" id="L174">		aList.setName(&quot;TRList&quot;);</span>
<span class="nc" id="L175">		addChildComponent(aList);</span>

<span class="nc" id="L177">		aPC = new TRDayDetailPC(context);</span>
<span class="nc" id="L178">		addChildComponent(aPC);</span>

		//--- add a DatePicker Dialog Box to the model
		// It is enclosed in a DialogBoxPageModel to provide DialogMediator support.
<span class="nc" id="L182">		m_datePicker = new DatePickerPC(context, SELECTED_DATE_FN);</span>
<span class="nc" id="L183">		addChildComponent(m_datePicker);</span>

<span class="nc" id="L185">		extractParameters(context.getRequest());</span>
<span class="nc" id="L186">		setValuesFromProfile(context);</span>

		//create time interval
<span class="nc" id="L189">		addPopupArgs( &quot;POPUP_CREATE_TIME_INTERVAL&quot;, &quot;createtimeinterval&quot;,</span>
			null, &quot;selectedID,curIndex,pageAction,startYear,startMonth,startDay,timeZone&quot;, &quot;1000, 360, ctr, ctr&quot;, true, 1);
		//edit time interval
<span class="nc" id="L192">		addPopupArgs( &quot;POPUP_EDIT_TIME_INTERVAL&quot;, &quot;createtimeinterval&quot;,</span>
			null, &quot;selectedID,curIndex,pageAction,recordID,timeZone&quot;, &quot;1000, 360, ctr, ctr&quot;, true, 1);
		//create time record
<span class="nc" id="L195">		addPopupArgs( &quot;POPUP_CREATE_RECORD&quot;, &quot;addtimerecord&quot;,</span>
			null, &quot;selectedID,curIndex,pageAction,startYear,startMonth,startDay&quot;, &quot;875, 425, 150, 65&quot;, true, 1);
		//edit remark
<span class="nc" id="L198">		addPopupArgs( &quot;POPUP_EDIT_REMARK&quot;, &quot;edittimerecord&quot;,</span>
			null, &quot;selectedID,curIndex,pageAction,recordID,version,timeZone,orgId&quot;, &quot;350, 250, ctr, ctr&quot;, true, 1);
		//insert time record entry
<span class="nc" id="L201">		addPopupArgs( &quot;POPUP_INSERT_ENTRY&quot;, &quot;edittimerecord&quot;,</span>
			&quot;entryValues&quot;, &quot;pageAction&quot;, &quot;900, 360, ctr, ctr&quot;, true, 1);
		//delete time record entry
<span class="nc" id="L204">		addPopupArgs( &quot;POPUP_DELETE_ENTRY&quot;, &quot;edittimerecord&quot;,</span>
			&quot;entryValues&quot;, &quot;pageAction&quot;, &quot;400, 220, ctr, ctr&quot;, true, 1);
		//edit time record entry
<span class="nc" id="L207">		addPopupArgs( &quot;POPUP_EDIT_ENTRY&quot;, &quot;edittimerecord&quot;,</span>
			&quot;entryValues&quot;, &quot;pageAction&quot;, &quot;900, 360, ctr, ctr&quot;, true, 1);
		//create end shift
<span class="nc" id="L210">		addPopupArgs( &quot;POPUP_CREATE_ENDSHIFT&quot;, &quot;edittimerecord&quot;,</span>
			null, &quot;selectedID,curIndex,pageAction,recordID,timeZone&quot;, &quot;350, 300, ctr, ctr&quot;, true, 1);

		//add javascript variables
<span class="nc" id="L214">		addJSVariable(&quot;oConfirmDeleteTR&quot;, m_bundle, AmWebBundleKey.MSG_JS_CONFIRM_DELETETR);</span>
<span class="nc" id="L215">		addJSVariable(&quot;oConfirmDeleteTE&quot;, m_bundle, AmWebBundleKey.MSG_JS_CONFIRM_DELETETE);</span>
<span class="nc" id="L216">		addJSVariable(&quot;oUnapproveTRLabel&quot;, m_bundle, AmWebBundleKey.UNAPPROVE_TR);</span>
<span class="nc" id="L217">		addJSVariable(&quot;oApproveTRLabel&quot;, m_bundle, AmWebBundleKey.APPROVE_TR);</span>
<span class="nc" id="L218">	}</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static TimeRecordModel getInstance(RequestContext context){
<span class="nc" id="L224">		return (TimeRecordModel)getInstance(context, TimeRecordModel.class);</span>
	}

	/**
	 * Return the resource bundle associated with the page model
	 */
	public ResourceBundle getBundle() {
<span class="nc" id="L231">		return m_bundle;</span>
	}

	/**
	 * Initialize Model with Data
	 */
	protected void initializeModel() {
		try {
<span class="nc bnc" id="L239" title="All 2 branches missed.">			if (m_isInitiated) return;</span>
<span class="nc" id="L240">			processTimeRecordForEmployee(m_context);</span>
<span class="nc" id="L241">			setContentTitle(m_context);</span>
<span class="nc" id="L242">			setDisplay(m_context);</span>
<span class="nc" id="L243">			this.setHeader();</span>
<span class="nc" id="L244">			setToolbar(m_context);</span>
<span class="nc" id="L245">			m_isInitiated = true;</span>
<span class="nc" id="L246">		} catch (Exception ex){</span>
<span class="nc" id="L247">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L248">		}</span>
<span class="nc" id="L249">	}</span>

	/**
	 * setAllRequiredPrivileges()
	 */
	private void setAllRequiredPrivileges(RequestContext context)
	throws Exception{
<span class="nc" id="L256">		ArrayList empColl = new ArrayList();</span>
<span class="nc" id="L257">		empColl.add(this.getEmpId());</span>

<span class="nc" id="L259">		Calendar aCalendar = Calendar.getInstance(context.getViewingTimeZone());</span>
<span class="nc" id="L260">		aCalendar.set(this.getSelYear(), this.getSelMonth(), this.getSelDay(), 0, 0, 0);</span>
<span class="nc" id="L261">		aCalendar.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L262">		Date date = aCalendar.getTime();</span>
<span class="nc" id="L263">		this.checkForTRELicense();</span>

		//view time records for employee
<span class="nc" id="L266">		this.viewTRForEmployee = AccessRightHelper.getAuthorizationCode(context, context.getUser(),</span>
			PrivilegeKeys.AM_VIEWEMPLOYEETIMERECORDS, empColl, date)[0];
		//view adherence privilege
<span class="nc bnc" id="L269" title="All 2 branches missed.">		this.viewAdherencePrivilege = AccessRightHelper.getAuthorizationCode(context, context.getUser(),</span>
			PrivilegeKeys.AM_VIEWADHERENCE, empColl, date)[0] == AccessRightHelper.EMP_IS_AUTHORIZED;
		//approve time record privilege
<span class="nc bnc" id="L272" title="All 2 branches missed.">		this.approveTRPrivilege = AccessRightHelper.getAuthorizationCode(context, context.getUser(),</span>
			PrivilegeKeys.AM_APPROVETIMERECORDS, empColl, date)[0] == AccessRightHelper.EMP_IS_AUTHORIZED;
		//edit time record privilege
<span class="nc bnc" id="L275" title="All 2 branches missed.">		this.editTRPrivilege = AccessRightHelper.getAuthorizationCode(context, context.getUser(),</span>
			PrivilegeKeys.AM_EDITEMPLOYEETIMERECORDS, empColl, date)[0] == AccessRightHelper.EMP_IS_AUTHORIZED;

<span class="nc bnc" id="L278" title="All 2 branches missed.">		if (this.editTRPrivilege)</span>
		{//allow viewing if allowed to edit
<span class="nc" id="L280">			this.viewTRForEmployee = 0;</span>
		}

		//view time interval
<span class="nc bnc" id="L284" title="All 2 branches missed.">		this.viewTIPrivilege = AccessRightHelper.getAuthorizationCode(context, context.getUser(),</span>
			PrivilegeKeys.AM_VIEWEMPLOYEETIMEINTERVALS, empColl)[0] == AccessRightHelper.EMP_IS_AUTHORIZED;
		//edit time interval
<span class="nc bnc" id="L287" title="All 2 branches missed.">		this.editTIPrivilege = AccessRightHelper.getAuthorizationCode(context, context.getUser(),</span>
			PrivilegeKeys.AM_EDITEMPLOYEETIMEINTERVALS, empColl)[0] == AccessRightHelper.EMP_IS_AUTHORIZED;
<span class="nc" id="L289">	}</span>

	/**
	 * Returns the selected date
	 */
	public Date getSelectedDate() {
<span class="nc" id="L295">		return m_selectedDate;</span>
	}

	/**
	 * Sets the selected date
	 */
	public void setSelectedDate(Date selectedDate) {
<span class="nc" id="L302">		m_selectedDate = selectedDate;</span>
<span class="nc" id="L303">	}</span>

	/**
	 * setValuesFromProfile
	 * This method allows for setting of the page model variables
	 * that derive from the user profile
	 */
	private void setValuesFromProfile(RequestContext context){
		try {
<span class="nc" id="L312">			UserProfile aProfile = UserProfileManager.getUserProfile(context,</span>
<span class="nc" id="L313">						context.getUser().getID());</span>

<span class="nc" id="L315">			TimeZone tz = context.getViewingTimeZone();</span>
<span class="nc" id="L316"> 			Calendar aCal = Calendar.getInstance(tz);</span>

			//get from profile if year==0
<span class="nc bnc" id="L319" title="All 2 branches missed.">			if (this.getSelYear()  == -1){</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">				if (aProfile.getProperty(&quot;DAYDETAIL_DATE&quot;) != null){</span>
<span class="nc" id="L321">					aCal.setTime(JSPUtil.toDateObj(aProfile.getProperty(&quot;DAYDETAIL_DATE&quot;),</span>
												   &quot;MM_dd_yyyy_H_mm&quot;,
												   tz));
				}
<span class="nc" id="L325">				this.setSelYear(aCal.get(Calendar.YEAR));</span>
<span class="nc" id="L326">				this.setSelMonth(aCal.get(Calendar.MONTH));</span>
<span class="nc" id="L327">				this.setSelDay(aCal.get(Calendar.DAY_OF_MONTH));</span>
			} else {
<span class="nc" id="L329">				aCal.set(this.getSelYear(), this.getSelMonth(), this.getSelDay());</span>
			}

<span class="nc" id="L332">			aCal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L333">			aCal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L334">			aCal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L335">			aProfile.setProperty(&quot;DAYDETAIL_DATE&quot;,</span>
<span class="nc" id="L336">								 JSPUtil.formatDate(aCal.getTime(), &quot;MM_dd_yyyy_H_mm&quot;, tz),</span>
								 false);

			//set aggregated field
<span class="nc bnc" id="L340" title="All 2 branches missed.">			if (this.getSelYear() == -1){</span>
<span class="nc" id="L341">				aProfile.loadProperty(&quot;DAYDETAIL_VIEWTYPE&quot;);</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">				if (aProfile.getProperty(&quot;DAYDETAIL_VIEWTYPE&quot;) != null){</span>
<span class="nc" id="L343">					this.setAggregated(Boolean.valueOf(aProfile.getProperty(&quot;DAYDETAIL_VIEWTYPE&quot;)).booleanValue());</span>
				}
			}
<span class="nc" id="L346">			aProfile.setProperty(&quot;DAYDETAIL_VIEWTYPE&quot;, String.valueOf(this.getAggregated()), true);</span>

			//save the profile
<span class="nc" id="L349">			UserProfileManager.setUserProfile(context, aProfile);</span>
<span class="nc" id="L350">		} catch (Exception ex){</span>

<span class="nc" id="L352">		}</span>
<span class="nc" id="L353">	}</span>

	/**
	 * Set the content title for the page
	 */
	public void setContentTitle(RequestContext context)
	throws BbmException, RemoteException{
		//get date from parameters
<span class="nc" id="L361">		TimeZone tz = context.getViewingTimeZone();</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">		Calendar aCal = (tz != null) ? Calendar.getInstance(tz) : Calendar.getInstance();</span>
<span class="nc" id="L363">		aCal.set(this.selYear, this.selMonth, this.selDay, 0, 0, 0);</span>
<span class="nc" id="L364">		aCal.set(Calendar.MILLISECOND, 0);</span>

<span class="nc" id="L366">		m_datePicker.setTimeZone(tz);</span>
<span class="nc" id="L367">		m_datePicker.setOnChangeJS(&quot;submitRefresh()&quot;);</span>
<span class="nc" id="L368">		m_datePicker.setDate(aCal.getTime());</span>
<span class="nc" id="L369">		m_datePicker.setIsDayNavEnabled(true);</span>

		//get employee name
<span class="nc" id="L372">		Employee employee = null;</span>
<span class="nc" id="L373">		String nameStr = &quot;&quot;;</span>
		try {
<span class="nc bnc" id="L375" title="All 2 branches missed.">			if (this.getEmpId() != null){</span>
<span class="nc" id="L376">				employee = EmployeeModelHandler.getEmployeeByID(context, new ID(this.getEmpId()));</span>
			}
<span class="nc" id="L378">		} catch (BbmFinderException ex){</span>
<span class="nc" id="L379">			cat.setResourceBundle(m_localizer.getBundle(AmWebLogBundleKey.BUNDLE_NAME));</span>
<span class="nc" id="L380">			cat.l7dError(AmWebLogBundleKey.MSG_ERROR_EMPNOTFOUND, ex);</span>
<span class="nc" id="L381">		}</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">		if (employee != null){</span>
<span class="nc" id="L383">			nameStr = m_localizer.formatName(employee.getPerson());</span>
		}
<span class="nc bnc" id="L385" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L386">			m_datePicker.setAriaLabel(i18n(m_bundle, AmWebBundleKey.SELECT_DATE));</span>
<span class="nc" id="L387">			m_datePicker.setOnChangeJS(m_datePicker.getOnChangeJS() + REFRESH_PAGE_ONCHANGE_INDICATOR);</span>
<span class="nc" id="L388">			m_contentTitlePC.setAriaRegion(true);</span>
		}
		
<span class="nc" id="L391">		m_contentTitlePC.setProperties(i18n(m_bundle, AmWebBundleKey.AM_TIME_DAYDETAILS), nameStr);</span>
<span class="nc" id="L392">		m_contentTitlePC.setActiveComponent(HtmlUtil.TBL_OPEN_TAG + &quot;&lt;tr&gt;&lt;td nowrap&gt;&quot;</span>
								+ &quot;&lt;SPAN class=\&quot;headerText2\&quot;&gt;&quot;
<span class="nc" id="L394">								+ i18n(m_bundle, AmWebBundleKey.SELECT_DATE)</span>
								+ &quot;: &lt;/SPAN&gt;&quot;
								+ &quot;&lt;/td&gt;&lt;td nowrap&gt;&quot;
<span class="nc" id="L397">								+ m_datePicker.getHtmlDisplay()</span>
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);
<span class="nc" id="L399">	}</span>

	/**
	 * processTimeRecordForEmployee
	 * @param context
	 * this method also checks for the required privileges to view,
	 * edit or apprrove time records for an employee and sets the
	 * required flag which is used to disable the buttons
	 */
	public void processTimeRecordForEmployee(RequestContext context)
	throws Exception{

<span class="nc" id="L411">		Calendar aCalendar = Calendar.getInstance(context.getViewingTimeZone());</span>
<span class="nc" id="L412">		aCalendar.set(this.getSelYear(), this.getSelMonth(), this.getSelDay(), 0, 0, 0);</span>
<span class="nc" id="L413">		aCalendar.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L414">		Pair aColl = null;</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">		if (this.getEmpId() != null){</span>
<span class="nc" id="L416">			setAllRequiredPrivileges(context);//set privileges before getting data</span>

<span class="nc bnc" id="L418" title="All 2 branches missed.">			if (this.viewTRForEmployee == AccessRightHelper.EMP_IS_AUTHORIZED){//check for privilege to view emp time records</span>
				//get collection depending on view
				try {
<span class="nc bnc" id="L421" title="All 2 branches missed.">					if (this.aggregated){//aggregated view</span>
<span class="nc" id="L422">						aColl = TimeRecordModelHandler</span>
<span class="nc" id="L423">								.getAggreagatedTimeRecordForEmployeePerDay(this.getEmpId(), this.getSelYear(), this.getSelMonth(), this.getSelDay());</span>
					} else {
<span class="nc" id="L425">						aColl = TimeRecordModelHandler</span>
<span class="nc" id="L426">							.getTimeRecordForEmployeePerDay(this.getEmpId(), this.getSelYear(), this.getSelMonth(), this.getSelDay());</span>
					}
<span class="nc" id="L428">				} catch (BbmTimeRecordException ex){</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">                	 if (ex.getErrCode() == BbmTimeRecordException.TR_NO_ORG){</span>
                        //&quot;The employee is not associated to any organization&quot;
<span class="nc" id="L431">                        addPageMessage(Message.INFO_TYPE, i18n(m_bundle, AmWebBundleKey.ADHERENCE_EMP_NO_ORG),</span>
                            AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L433">                        this.editTRPrivilege = false;</span>
<span class="nc" id="L434">                        this.editTIPrivilege = false;</span>
                    }
<span class="nc" id="L436">				} catch (BbmFinderException ex) {</span>
<span class="nc" id="L437">					cat.setResourceBundle(m_localizer.getBundle(AmWebLogBundleKey.BUNDLE_NAME));</span>
<span class="nc" id="L438">					cat.l7dError(AmWebLogBundleKey.MSG_ERROR_FINDINGTR, ex);</span>

<span class="nc" id="L440">					String msg = &quot;&quot;;</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">					if (ex instanceof BbmTimePeriodOverlapException){//special handling</span>
<span class="nc" id="L442">						msg = i18n(m_bundle, AmWebBundleKey.MSG_INFO_ORGOVERLAP);</span>
<span class="nc bnc" id="L443" title="All 4 branches missed.">					} else if (ex.getCoreException() != null &amp;&amp; ex.getCoreException() instanceof BbmTimeRecordException) {</span>
<span class="nc" id="L444">						BbmTimeRecordException tre = (BbmTimeRecordException)ex.getCoreException();</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">						switch (tre.getErrCode()) {</span>
							case BbmTimeRecordException.TR_NO_ORG:
<span class="nc" id="L447">								msg = i18n(m_bundle, AmWebBundleKey.NO_ORG_FOUND);</span>
<span class="nc" id="L448">								break;</span>

							default:
<span class="nc" id="L451">								msg = i18n(m_bundle, AmWebBundleKey.MSG_NO_RECORDS);</span>
								break;
						}
<span class="nc" id="L454">					} else {</span>
<span class="nc" id="L455">						msg = ex.getLocalizedMessage();</span>
					}
<span class="nc" id="L457">					this.editTRPrivilege = false;</span>
<span class="nc" id="L458">					this.approveTRPrivilege = false;</span>
<span class="nc" id="L459">					addPageMessage(Message.ERROR_TYPE, msg);</span>
<span class="nc" id="L460">				}</span>
			} else {
<span class="nc bnc" id="L462" title="All 2 branches missed.">				if (this.viewTRForEmployee == AccessRightHelper.EMP_ORG_NOT_FOUND){</span>
					//&quot;The employee is not associated to any organization&quot;
<span class="nc" id="L464">					addPageMessage(Message.INFO_TYPE, i18n(m_bundle, AmWebBundleKey.ADHERENCE_EMP_NO_ORG),</span>
						AmWebBundleKey.BUNDLE_NAME);
				} else {
					//&quot;You do not have privileges to view time records for this employee.&quot;
<span class="nc" id="L468">					addPageMessage(Message.INFO_TYPE, i18n(m_bundle, AmWebBundleKey.MSG_ERROR_NOPRIVTOVIEWEMP),</span>
						AmWebBundleKey.BUNDLE_NAME);
				}
			}

		}//empid not null

<span class="nc bnc" id="L475" title="All 4 branches missed.">		if (aColl!=null &amp;&amp; aColl.getSecond()!=null){</span>
<span class="nc" id="L476">			this.timeRecordsForEmployee = (Collection)aColl.getSecond();</span>
			//get from pair
<span class="nc" id="L478">			isDayLocked = ((Boolean)aColl.getFirst()).booleanValue();</span>
		}
<span class="nc" id="L480">	}</span>

	/**
	 * setTimeRecordsForEmployee
	 */
	public void setTimeRecordsForEmployee(Collection timeRecordsForEmployee){
<span class="nc" id="L486">		this.timeRecordsForEmployee = timeRecordsForEmployee;</span>
<span class="nc" id="L487">	}</span>

	/**
	 * getTimeRecordsForEmployee
	 */
	public Collection getTimeRecordsForEmployee(){
<span class="nc" id="L493">		return this.timeRecordsForEmployee;</span>
	}

	/**
	 * set empId
	 */
	public void setEmpId(ID empId){
<span class="nc" id="L500">		this.empId = empId;</span>
<span class="nc" id="L501">	}</span>

	/**
	 * get empId
	 */
	public ID getEmpId(){
<span class="nc" id="L507">		return this.empId;</span>
	}

	/**
	 * set supervisorId
	 */
	public void setSupervisorId(ID supervisorId){
<span class="nc" id="L514">		this.supervisorId = supervisorId;</span>
<span class="nc" id="L515">	}</span>

	/**
	 * get supervisorId
	 */
	public ID getSupervisorId(){
<span class="nc" id="L521">		return this.supervisorId;</span>
	}

	/**
	 * set orgId
	 */
	public void setOrgId(ID orgId){
<span class="nc" id="L528">		this.orgId = orgId;</span>
<span class="nc" id="L529">	}</span>

	/**
	 * get orgId
	 */
	public ID getOrgId(){
<span class="nc" id="L535">		return this.orgId;</span>
	}

	/**
	 * set recordId
	 */
	public void setRecordId(int recordId){
<span class="nc" id="L542">		this.recordId = recordId;</span>
<span class="nc" id="L543">	}</span>

	/**
	 * get recordId
	 */
	public int getRecordId(){
<span class="nc" id="L549">		return this.recordId;</span>
	}

	/**
	 * set timeEntryID
	 */
	public void setTimeEntryID(ID timeEntryID){
<span class="nc" id="L556">		this.timeEntryID = timeEntryID;</span>
<span class="nc" id="L557">	}</span>

	/**
	 * get timeEntryID
	 */
	public ID getTimeEntryID(){
<span class="nc" id="L563">		return this.timeEntryID;</span>
	}

	/**
	* Set version
	*/
	public void setVersion(long version){
<span class="nc" id="L570">		this.version = version;</span>
<span class="nc" id="L571">	}</span>

	/**
	* Get version
	*/
	public long getVersion(){
<span class="nc" id="L577">		return this.version;</span>
	}

	/**
	 * set timeRecord
	 */
	public void setTimeRecord(TimeRecord timeRecord){
<span class="nc" id="L584">		this.timeRecord = timeRecord;</span>
<span class="nc" id="L585">	}</span>

	/**
	 * get timeRecord
	 */
	public TimeRecord getTimeRecord(){
<span class="nc" id="L591">		return this.timeRecord;</span>
	}

	/**
	 * set approved
	 */
	public void setApproved(boolean approved){
<span class="nc" id="L598">		this.approved = approved;</span>
<span class="nc" id="L599">	}</span>

	/**
	 * get is_approved
	 */
	public boolean getApproved(){
<span class="nc" id="L605">		return this.approved;</span>
	}

	/**
	 * set selYear
	 */
	public void setSelYear(int selYear){
<span class="nc" id="L612">		this.selYear = selYear;</span>
<span class="nc" id="L613">	}</span>

	/**
	 * get selYear
	 */
	public int getSelYear(){
<span class="nc" id="L619">		return this.selYear;</span>
	}

	/**
	 * set selMonth
	 */
	public void setSelMonth(int selMonth){
<span class="nc" id="L626">		this.selMonth = selMonth;</span>
<span class="nc" id="L627">	}</span>

	/**
	 * get selMonth
	 */
	public int getSelMonth(){
<span class="nc" id="L633">		return this.selMonth;</span>
	}

	/**
	 * set selDay
	 */
	public void setSelDay(int selDay){
<span class="nc" id="L640">		this.selDay = selDay;</span>
<span class="nc" id="L641">	}</span>

	/**
	 * get selDay
	 */
	public int getSelDay(){
<span class="nc" id="L647">		return this.selDay;</span>
	}

	/**
	 * set longDate
	 */
	public void setLongDate(long date){
<span class="nc" id="L654">		this.longDate = date;</span>

<span class="nc" id="L656">		Date aDate = new Date(longDate);</span>
<span class="nc" id="L657">		Calendar aCalendar = Calendar.getInstance();</span>
<span class="nc" id="L658">		aCalendar.setTime(aDate);</span>
<span class="nc" id="L659">		aCalendar.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L660">		this.selYear = aCalendar.get(Calendar.YEAR);</span>
<span class="nc" id="L661">		this.selMonth = aCalendar.get(Calendar.MONTH);</span>
<span class="nc" id="L662">		this.selDay = aCalendar.get(Calendar.DAY_OF_MONTH);</span>
<span class="nc" id="L663">	}</span>

	/**
	 * get longDate
	 */
	 public long getLongDate(){
<span class="nc" id="L669">		return this.longDate;</span>
	 }

	/**
	* Set boundaryTimeSpan
	*/
	public void setBoundaryTimeSpan(String boundaryTimeSpan){
<span class="nc" id="L676">		this.boundaryTimeSpan = boundaryTimeSpan;</span>
<span class="nc" id="L677">	}</span>

	/**
	* Get boundaryTimeSpan
	*/
	public String getBoundaryTimeSpan(){
<span class="nc" id="L683">		return this.boundaryTimeSpan;</span>
	}


	/**
	 * Set Selected IDs
	 */
	public void setSelectedID(String ids) {
<span class="nc" id="L691">		super.setSelectedID(ids);</span>
<span class="nc" id="L692">		setCurEmployee();</span>
<span class="nc" id="L693">	}</span>

	/**
	 * Set Edit Index.
	 */
	public void setEditIndex(int index) {
<span class="nc" id="L699">		super.setEditIndex(index);</span>
<span class="nc" id="L700">		setCurEmployee();</span>
<span class="nc" id="L701">	}</span>
	
	/**
	 * setCurEmployee
	 * This method sets the current employee based on pagination
	 */
	public void setCurEmployee(){
<span class="nc bnc" id="L708" title="All 2 branches missed.">		if ( getSelectedIDSize() &gt; 0 ) {</span>
<span class="nc" id="L709">			setEmpId(getSelectedIDs()[getEditIndex()]);</span>
		}
<span class="nc" id="L711">	}</span>

	/**
	 * set position
	 */
	public void setPosition(int position){
<span class="nc" id="L717">		this.position = position;</span>
<span class="nc" id="L718">	}</span>

	/**
	 * get position
	 */
	public int getPosition(){
<span class="nc" id="L724">		return this.position;</span>
	}

	/**
	 * set aggregated
	 */
	public void setAggregated(boolean aggregated){
<span class="nc" id="L731">		this.aggregated = aggregated;</span>
<span class="nc" id="L732">	}</span>

	/**
	 * get aggregated
	 */
	public boolean getAggregated(){
<span class="nc" id="L738">		return this.aggregated;</span>
	}

	/**
	 * set direction
	 */
	public void setDirection(boolean direction){
<span class="nc" id="L745">		this.direction = direction;</span>
<span class="nc" id="L746">	}</span>

	/**
	 * get direction
	 */
	public boolean getDirection(){
<span class="nc" id="L752">		return this.direction;</span>
	}

	private String formatDate(Date date, String tz) {
<span class="nc" id="L756">		return m_localizer.formatDate(date,</span>
<span class="nc" id="L757">				TimeZone.getTimeZone(tz),</span>
				RegionalFormatBundleKey.DATE_FORMAT,
				RegionalFormatBundleKey.TIME_FORMAT);
	}

	/**
	 * Generate the display components
	 */
	public ArrayList getRowData(RequestContext context) throws Exception{
<span class="nc" id="L766">		ArrayList data = new ArrayList();</span>

<span class="nc" id="L768">		ArrayList listModel = null;</span>
		//procee time records here
<span class="nc" id="L770">		Collection timeRecords = this.getTimeRecordsForEmployee();</span>
<span class="nc" id="L771">		int recordNum =0;</span>

<span class="nc" id="L773">		this.boundaryTimeSpan = &quot;&quot;;</span>
<span class="nc" id="L774">		boolean setDSTFlag = false;</span>
<span class="nc" id="L775">		boolean setIndex = false;</span>
<span class="nc" id="L776">		boolean isAutoClosed = false;</span>

<span class="nc" id="L778">		String errorFontStartTag = &quot;&lt;font color=\&quot;#CB1D1D\&quot;&gt;&quot;;</span>
<span class="nc" id="L779">		String fontEndTag = &quot;&lt;/font&gt;&quot;;</span>
<span class="nc" id="L780">		boolean notShowTimeInterval = false;</span>
<span class="nc" id="L781">		boolean notShowTimeRecord = false;</span>

		//show rest of page only if found any time records
<span class="nc bnc" id="L784" title="All 2 branches missed.">		if (timeRecords!=null){</span>
<span class="nc" id="L785">			Iterator it = timeRecords.iterator();</span>

<span class="nc bnc" id="L787" title="All 2 branches missed.">			while (it.hasNext()) {</span>
<span class="nc" id="L788">				listModel = new ArrayList();</span>
<span class="nc" id="L789">				recordNum++;</span>
<span class="nc" id="L790">				isAutoClosed = false;</span>
<span class="nc" id="L791">				TimeRecord aRecord = (TimeRecord) it.next();</span>
<span class="nc bnc" id="L792" title="All 4 branches missed.">				notShowTimeInterval = (aRecord.getType() == TimeRecord.TIMEINTERVAL &amp;&amp; !this.viewTIPrivilege);</span>
<span class="nc bnc" id="L793" title="All 6 branches missed.">				notShowTimeRecord = ((aRecord.getType() == TimeRecord.AGG_TIMEENTRY || aRecord.getType() == TimeRecord.TIMEENTRY)</span>
						&amp;&amp; !(this.viewTRForEmployee == AccessRightHelper.EMP_IS_AUTHORIZED));
<span class="nc bnc" id="L795" title="All 4 branches missed.">				if (!notShowTimeInterval &amp;&amp; !notShowTimeRecord){</span>
					//set selected index
<span class="nc bnc" id="L797" title="All 2 branches missed.">					if (aRecord.getID().equals(new ID(this.getRecordId()))){</span>
<span class="nc" id="L798">						this.selectedIndex.add(String.valueOf(recordNum-1));</span>
					}

					//add page message if the day for the employee organization has daylight saving conversion
<span class="nc bnc" id="L802" title="All 2 branches missed.">					if (!setDSTFlag){</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">						if (TimeZoneUtil.hasDSTConversion(this.selYear, this.selMonth, this.selDay, TimeZone.getTimeZone(aRecord.getTimeZone()))){</span>
<span class="nc" id="L804">							this.addPageMessage(Message.WARNING_TYPE, AmWebBundleKey.MSG_WARNING_DST,</span>
									AmWebBundleKey.BUNDLE_NAME);
						}
					}

<span class="nc bnc" id="L809" title="All 2 branches missed.">					if (recordNum == 1){</span>
<span class="nc" id="L810">						Calendar aSCal = Calendar.getInstance(TimeZone.getTimeZone(aRecord.getTimeZone()));</span>
<span class="nc" id="L811">						aSCal.set(this.selYear, this.selMonth, this.selDay);</span>
<span class="nc" id="L812">						aSCal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L813">						aSCal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L814">						aSCal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L815">						aSCal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L816">						aSCal.add(Calendar.MILLISECOND, aRecord.getDayBoundaryOffset()*60000);</span>

<span class="nc" id="L818">						this.boundaryTimeSpan = &quot;&amp;nbsp;(&quot; + formatDate(aSCal.getTime(),	aRecord.getTimeZone());</span>
					}
<span class="nc bnc" id="L820" title="All 2 branches missed.">					if (recordNum == timeRecords.size()){</span>
<span class="nc" id="L821">						Calendar aECal = Calendar.getInstance(TimeZone.getTimeZone(aRecord.getTimeZone()));</span>
<span class="nc" id="L822">						aECal.set(this.selYear, this.selMonth, this.selDay);</span>
<span class="nc" id="L823">						aECal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L824">						aECal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L825">						aECal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L826">						aECal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L827">						aECal.add(Calendar.DATE, 1);</span>
<span class="nc" id="L828">						aECal.add(Calendar.MILLISECOND, aRecord.getDayBoundaryOffset()*60000);</span>
<span class="nc" id="L829">						this.boundaryTimeSpan += &quot; - &quot; + formatDate(aECal.getTime(),</span>
<span class="nc" id="L830">								aRecord.getTimeZone()) + &quot;)&quot;;</span>
					}

					//aRecord.validate();
<span class="nc" id="L834">					ArrayList anEntryList = (ArrayList)aRecord.getChildren();</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">					String recordName = (aRecord.getType() == TimeRecord.TIMEENTRY</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">							|| aRecord.getType() == TimeRecord.AGG_TIMEENTRY</span>
<span class="nc" id="L837">									? i18n(m_bundle, AmWebBundleKey.AM_MYTIME_TIMERECORD)</span>
<span class="nc" id="L838">									: i18n(m_bundle, AmWebBundleKey.PAID_INTERVAL))</span>
							+ &quot; &quot; + recordNum;

<span class="nc bnc" id="L841" title="All 2 branches missed.">					if (timeRecords.size() &gt; 1) aPC.resetForReUse();</span>
<span class="nc" id="L842">					aPC.setName(&quot;T&quot; + recordNum);// Set component name</span>
<span class="nc" id="L843">					aPC.setComplianceModeTitle(recordName);</span>

<span class="nc" id="L845">					setTableHeader(aPC, aRecord.getType());</span>
<span class="nc" id="L846">					setTableProperties(aPC);</span>

					//need to set boolean here so that button attribures can be rightly set
<span class="nc" id="L849">					boolean hasEndShift = getHasEndShift(aRecord);</span>

<span class="nc bnc" id="L851" title="All 6 branches missed.">					String isEnabled = !aRecord.isLocked() &amp;&amp; !isDayLocked &amp;&amp; this.editTRPrivilege?&quot;true&quot;:&quot;false&quot;;//enabled for edit</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">					for (int i=0; i&lt;anEntryList.size(); i++){</span>
<span class="nc bnc" id="L853" title="All 3 branches missed.">						switch (aRecord.getType())</span>
						{
							case TimeRecord.AGG_TIMEENTRY:
							case TimeRecord.TIMEENTRY:
<span class="nc" id="L857">								TimeRecordEntry anEntry = (TimeRecordEntry) anEntryList.get(i);</span>

								//reset the index since it could have been set for the entry
<span class="nc bnc" id="L860" title="All 2 branches missed.">								if (!setIndex){</span>
<span class="nc" id="L861">									this.detailSelectedIndex = -1;</span>
								}
								//set selected index
<span class="nc bnc" id="L864" title="All 4 branches missed.">								if (i==0 &amp;&amp; this.getPosition()==0){//check for insert at first position</span>
<span class="nc" id="L865">									this.detailSelectedIndex = 0;</span>
<span class="nc" id="L866">									this.mediatorNum = recordNum;</span>
<span class="nc" id="L867">									setIndex = true;</span>
<span class="nc bnc" id="L868" title="All 4 branches missed.">								} else if (!setIndex &amp;&amp; anEntry.getID().equals(this.getTimeEntryID())){</span>
<span class="nc" id="L869">									this.detailSelectedIndex = i+1;</span>
<span class="nc" id="L870">									this.mediatorNum = recordNum;</span>
<span class="nc" id="L871">									setIndex = true;</span>
								}

								//set PC selected index
<span class="nc bnc" id="L875" title="All 2 branches missed.">								if (this.detailSelectedIndex != -1){</span>
<span class="nc" id="L876">									aPC.getMultiColList().addSelectedRowID(String.valueOf(this.detailSelectedIndex));</span>
								}

<span class="nc" id="L879">								boolean isFirstEntry = false;</span>
<span class="nc" id="L880">								boolean isLastEntry = false;</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">								if (i ==0){</span>
<span class="nc" id="L882">									isFirstEntry = true;</span>
								}

<span class="nc bnc" id="L885" title="All 4 branches missed.">								if ((i == (anEntryList.size()-2) &amp;&amp; hasEndShift) ||</span>
<span class="nc bnc" id="L886" title="All 4 branches missed.">										(i == (anEntryList.size()-1) &amp;&amp; !hasEndShift)){</span>
<span class="nc" id="L887">									isLastEntry = true;</span>
								}

								//Parameters are: recordID, entryID, selectedID, curIndex, timeZone, orgID, position, curDate,
								//isFirstEntry, isLastEntry, version
<span class="nc" id="L892">								String entryValues = &quot;&quot;;</span>

								// Create the row data
<span class="nc" id="L895">								ArrayList row_data = null;</span>

<span class="nc bnc" id="L897" title="All 2 branches missed.">								if (i == 0){//add start shift row</span>
<span class="nc" id="L898">									entryValues = anEntry.getParentID() + &quot;||&quot; + anEntry.getID() + &quot;||&quot;</span>
<span class="nc" id="L899">										+ this.getSelectedID() + &quot;||&quot; + this.getEditIndex() + &quot;||&quot; + aRecord.getTimeZone()</span>
<span class="nc" id="L900">										+ &quot;||&quot; + aRecord.getOrgID() + &quot;||&quot; + 0 + &quot;||&quot; + anEntry.getStartTime().getTime()</span>
<span class="nc" id="L901">										+ &quot;||&quot; + isFirstEntry + &quot;||&quot; + isLastEntry + &quot;||&quot; + aRecord.getVersion();</span>
<span class="nc" id="L902">									row_data = new ArrayList();</span>
<span class="nc" id="L903">									row_data.add(formatDate(anEntry.getStartTime(),aRecord.getTimeZone()));</span>
<span class="nc" id="L904">									row_data.add(i18n(m_bundle, AmWebBundleKey.START_SHIFT));</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">									if (!this.getAggregated()){</span>
<span class="nc" id="L906">										row_data.add(&quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L907">										row_data.add(&quot;&amp;nbsp;&quot;);</span>
									}
<span class="nc" id="L909">									row_data.add(&quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L910">									row_data.add(&quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L911">									row_data.add(&quot;&amp;nbsp;&quot;);</span>

									// Set if the row should be editable or not.
<span class="nc" id="L914">									HashMap rowAttributes = new HashMap(1);</span>
									//put 3 parameters, ; delimited: isEditable, isStartEntry, isLastEntry
<span class="nc" id="L916">									rowAttributes.put(&quot;ENTRY&quot;, String.valueOf(isEnabled) + &quot;;&quot; + &quot;true&quot; + &quot;;&quot; + &quot;false&quot;);</span>
									//if (hasEndShift){
<span class="nc" id="L918">										rowAttributes.put(&quot;LENGTH&quot;, String.valueOf(aRecord.getChildren().size()));</span>
									//}
									// Add row data to list model
<span class="nc" id="L921">									listModel.add(new DefaultMultiColumnNodeData(entryValues, row_data, rowAttributes));</span>
								}
<span class="nc" id="L923">								entryValues = anEntry.getParentID() + &quot;||&quot; + anEntry.getID() + &quot;||&quot;</span>
<span class="nc" id="L924">										+ this.getSelectedID() + &quot;||&quot; + this.getEditIndex() + &quot;||&quot; + aRecord.getTimeZone()</span>
<span class="nc" id="L925">										+ &quot;||&quot; + aRecord.getOrgID() + &quot;||&quot; + (i+1) + &quot;||&quot; + anEntry.getStartTime().getTime()</span>
<span class="nc" id="L926">										+ &quot;||&quot; + isFirstEntry + &quot;||&quot; + isLastEntry + &quot;||&quot; + aRecord.getVersion();</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">								if (!anEntry.getActivityID().equals(Activity.ACTIVITY_NONE)) {</span>
<span class="nc" id="L928">									row_data = new ArrayList();</span>
<span class="nc" id="L929">									row_data.add(formatDate(anEntry.getStartTime(), aRecord.getTimeZone()));</span>
<span class="nc" id="L930">									row_data.add(anEntry.getActivityCategoryName());</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">									if (!this.getAggregated())</span>
<span class="nc" id="L932">									 row_data.add(anEntry.getActivityName());</span>
<span class="nc" id="L933">									row_data.add(m_localizer.formatDurationInMins(anEntry.getDuration()));</span>
<span class="nc" id="L934">									row_data.add(m_localizer.formatYesNo(anEntry.getPaid()));</span>
<span class="nc" id="L935">									row_data.add(getCreatorStr(aRecord.getType(), anEntry.getTimeSourceCode()));</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">									if (!this.getAggregated())</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">										row_data.add(anEntry.getDescription()!=null</span>
<span class="nc bnc" id="L938" title="All 2 branches missed.">											&amp;&amp; !anEntry.getDescription().equals(&quot;&quot;)?HtmlEncoder.encode(anEntry.getDescription()):&quot;&amp;nbsp;&quot;);</span>

									// Set if the row should be editable or not.
<span class="nc" id="L941">									HashMap rowAttributes = new HashMap(1);</span>
									//put 3 parameters, || delimited: isEditable, isStartEntry, isLastEntry
<span class="nc" id="L943">									rowAttributes.put(&quot;ENTRY&quot;, String.valueOf(isEnabled) + &quot;;&quot; + &quot;false&quot; + &quot;;&quot; + &quot;false&quot;);</span>
									//if (hasEndShift){
<span class="nc" id="L945">										rowAttributes.put(&quot;LENGTH&quot;, String.valueOf(aRecord.getChildren().size()));</span>
									//}
									//add parameter for hasEndShift
<span class="nc" id="L948">									rowAttributes.put(&quot;HAS_END_SHIFT&quot;, String.valueOf(hasEndShift));</span>
									
									
									//First attempt at zebra striping. The problem with this is that row selections no longer appear.
									/*
									ArrayList col_styles = new ArrayList(row_data.size());
									for (int colNum=0; colNum&lt;row_data.size(); colNum++)
									{
										if (i%2 == 0)
											col_styles.add(&quot;background-color:#ffffff &quot;);
										else
											col_styles.add(&quot;background-color:#f8f8f8 &quot;);
									}
									*/

									
									// Add row data to list model
<span class="nc" id="L965">									listModel.add(new DefaultMultiColumnNodeData(entryValues, row_data, rowAttributes)); //col_styles</span>
<span class="nc" id="L966">								} else {//end shift</span>

									//set flag for auto closed
<span class="nc bnc" id="L969" title="All 2 branches missed.">									if (anEntry.getTimeSourceCode() == TimeEntrySourceCode.AUTO_CLOSE)</span>
<span class="nc" id="L970">										isAutoClosed = true;</span>
<span class="nc" id="L971">									row_data = new ArrayList();</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">									row_data.add((isAutoClosed?errorFontStartTag:&quot;&quot;)</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">										+ formatDate(anEntry.getStartTime(), aRecord.getTimeZone())</span>
										+ (isAutoClosed?fontEndTag:&quot;&quot;));
<span class="nc bnc" id="L975" title="All 2 branches missed.">									row_data.add((isAutoClosed?errorFontStartTag:&quot;&quot;)</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">										+ i18n(m_bundle, AmWebBundleKey.END_SHIFT)</span>
										+ (isAutoClosed?fontEndTag:&quot;&quot;));
<span class="nc bnc" id="L978" title="All 2 branches missed.">									if (!this.getAggregated())</span>
<span class="nc" id="L979">										row_data.add(&quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L980">									row_data.add(&quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L981">									row_data.add(&quot;&amp;nbsp;&quot;);</span>
<span class="nc bnc" id="L982" title="All 2 branches missed.">									row_data.add((isAutoClosed?errorFontStartTag:&quot;&quot;)</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">										+ getCreatorStr(aRecord.getType(), anEntry.getTimeSourceCode())</span>
										+ (isAutoClosed?fontEndTag:&quot;&quot;));
<span class="nc bnc" id="L985" title="All 2 branches missed.">									if (!this.getAggregated()){</span>
<span class="nc bnc" id="L986" title="All 6 branches missed.">										row_data.add(anEntry.getDescription()!=null &amp;&amp; !anEntry.getDescription().equals(&quot;&quot;)?</span>
												((isAutoClosed?errorFontStartTag:&quot;&quot;)
<span class="nc bnc" id="L988" title="All 2 branches missed.">												+ HtmlEncoder.encode(anEntry.getDescription())</span>
												+ (isAutoClosed?fontEndTag:&quot;&quot;)):&quot;&quot;);
									}

									// Set if the row should be editable or not.
<span class="nc" id="L993">									HashMap rowAttributes = new HashMap(1);</span>
									//put 3 parameters, || delimited: isEditable, isStartEntry, isLastEntry
<span class="nc" id="L995">									rowAttributes.put(&quot;ENTRY&quot;, String.valueOf(isEnabled) + &quot;;&quot; + &quot;false&quot; + &quot;;&quot; + &quot;true&quot;);</span>
<span class="nc" id="L996">									rowAttributes.put(&quot;LENGTH&quot;, String.valueOf(aRecord.getChildren().size()));</span>
									
									// Add row data to list model
<span class="nc" id="L999">									listModel.add(new DefaultMultiColumnNodeData(entryValues, row_data, rowAttributes));</span>
								}
<span class="nc" id="L1001">								break;</span>
							case TimeRecord.TIMEINTERVAL:
<span class="nc bnc" id="L1003" title="All 2 branches missed.">								if (!notShowTimeInterval)</span>
								{
<span class="nc" id="L1005">									TimeInterval anInterval = (TimeInterval) anEntryList.get(i);</span>

									//reset the index since it could have been set for the entry
<span class="nc bnc" id="L1008" title="All 2 branches missed.">									if (!setIndex){</span>
<span class="nc" id="L1009">										this.detailSelectedIndex = -1;</span>
									}

									//set selected index
<span class="nc bnc" id="L1013" title="All 2 branches missed.">									if (anInterval.getID().equals(this.getTimeEntryID())){</span>
<span class="nc" id="L1014">										this.detailSelectedIndex = i;</span>
<span class="nc" id="L1015">										this.mediatorNum = recordNum;</span>
<span class="nc" id="L1016">                                        setIndex = true;</span>
									}
									//set PC selected index
<span class="nc bnc" id="L1019" title="All 2 branches missed.">									if (this.detailSelectedIndex != -1){</span>
<span class="nc" id="L1020">										aPC.getMultiColList().addSelectedRowID(String.valueOf(this.detailSelectedIndex));</span>
									}
<span class="nc" id="L1022">									row_data = new ArrayList();</span>
<span class="nc" id="L1023">									row_data.add(formatDate(anInterval.getStartTime(), aRecord.getTimeZone()));</span>
<span class="nc" id="L1024">									row_data.add(formatDate(anInterval.getEndTime(), aRecord.getTimeZone()));</span>
<span class="nc" id="L1025">									row_data.add(anInterval.getActivityCategoryName());</span>
<span class="nc" id="L1026">									row_data.add(anInterval.getActivityName());</span>
<span class="nc" id="L1027">									row_data.add(m_localizer.formatDurationInMins(anInterval.getDuration()));</span>
<span class="nc" id="L1028">									row_data.add(m_localizer.formatYesNo(anInterval.getPaid()));</span>
<span class="nc" id="L1029">									row_data.add(getCreatorStr(aRecord.getType(), anInterval.getTimeSourceCode()));</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">									row_data.add(anInterval.getDescription()!=null</span>
<span class="nc bnc" id="L1031" title="All 2 branches missed.">										&amp;&amp; !anInterval.getDescription().equals(&quot;&quot;)?HtmlEncoder.encode(anInterval.getDescription()):&quot;&amp;nbsp;&quot;);</span>

									// Set if the row should be editable or not.
<span class="nc" id="L1034">									HashMap rowAttributes = new HashMap(1);</span>
<span class="nc" id="L1035">									rowAttributes.put(&quot;IS_EDITABLE&quot;, isEnabled);</span>
<span class="nc" id="L1036">									rowAttributes.put(&quot;ENTRY&quot;, &quot;;&quot;);</span>
<span class="nc" id="L1037">									rowAttributes.put(&quot;LENGTH&quot;, String.valueOf(aRecord.getChildren().size()));</span>
									// Add row data to list model
<span class="nc" id="L1039">									listModel.add(new DefaultMultiColumnNodeData(aRecord.getID().toString(), row_data, rowAttributes));</span>
								}
							break;
						}
					}

<span class="nc" id="L1045">					setComponentToolbars(aPC, context, aRecord, hasEndShift);//set toolbars</span>

					//set setRemarkEmployeeStr string for component
					//if (aRecord.getRemarkEmployeeName()!=null &amp;&amp; aRecord.getRemarkDate()!=null)
<span class="nc" id="L1049">						aPC.setRemarkEmployeeStr(getRemarkAndApproverEmployeeStr(aRecord));</span>

					//set comments string for component
<span class="nc bnc" id="L1052" title="All 2 branches missed.">					aPC.setComments(getCommentStr(aRecord.getDescription()!=null?HtmlEncoder.encode(aRecord.getDescription()):&quot;&amp;nbsp;&quot;));</span>
<span class="nc" id="L1053">					aPC.getMultiColList().setListModel(listModel);//add list</span>
					
<span class="nc" id="L1055">					StringBuffer recordNumImg = new StringBuffer();</span>
					//get time record num image
<span class="nc" id="L1057">					recordNumImg.append(&quot;&lt;table border=\&quot;0\&quot;&gt;&lt;tr&gt;&quot;</span>
						+ &quot;&lt;td class=\&quot;bgImage\&quot; background=\&quot;&quot;
<span class="nc bnc" id="L1059" title="All 2 branches missed.">						+ context.getStaticFileUrl(&quot;/am/images/icons/blankBG.gif&quot;)</span>
						+ &quot;\&quot; width=\&quot;14\&quot; height=\&quot;14\&quot;&gt;&quot;
						+ (recordNum&lt;10?&quot;&amp;nbsp;&quot;:&quot;&quot;)
<span class="nc" id="L1062">						+ m_localizer.formatNumber(recordNum)</span>
						+ &quot;&lt;/td&gt;&quot;);
					//append locked icon if required
<span class="nc bnc" id="L1065" title="All 4 branches missed.">					if (aRecord.isLocked() || isDayLocked){</span>
<span class="nc" id="L1066">						recordNumImg.append(&quot;&lt;td class=\&quot;bgImage\&quot; background=\&quot;&quot;</span>
<span class="nc" id="L1067">						+ context.getStaticFileUrl(&quot;/am/images/lockTR.gif&quot;)</span>
						+ &quot;\&quot; width=\&quot;14\&quot; height=\&quot;14\&quot;&gt;&quot;
<span class="nc" id="L1069">						+ HtmlUtil.imageTag(ImageFileID.BLACK_CHECK, &quot;12&quot;, &quot;14&quot;, i18n(m_bundle, AmWebBundleKey.LOCKED))</span>
						+ &quot;&lt;/td&gt;&quot;);
					}

<span class="nc" id="L1073">					recordNumImg.append(&quot;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>

<span class="nc bnc" id="L1075" title="All 2 branches missed.">					String autoClosedStr = isAutoClosed?i18n(m_bundle, AmWebBundleKey.SYSTEM_AUTOCLOSE):&quot;&quot;;</span>
					//now get the mail list element
<span class="nc" id="L1077">					ArrayList&lt;String&gt; columns = new ArrayList&lt;String&gt;(4);</span>
<span class="nc" id="L1078">					columns.add(recordNumImg.toString());</span>
					
<span class="nc" id="L1080">					String columnContent = recordName + getFormattedRecordDisplayTime(aRecord)</span>
<span class="nc bnc" id="L1081" title="All 4 branches missed.">							+ ((aRecord.getOverlap() ? errorFontStartTag + &quot;[&quot; + i18n(m_bundle, AmWebBundleKey.INVALID)</span>
									+ &quot;]&quot; + fontEndTag : &quot;&quot;)
									+ (isAutoClosed ? errorFontStartTag + &quot; [&quot; + autoClosedStr + &quot;]&quot; : &quot;&quot;))
							+ fontEndTag;
<span class="nc" id="L1085">					String formatedDuration = m_localizer.formatDurationInMins(aRecord.getDuration());</span>
					
<span class="nc" id="L1087">					columnContent = makeContentFocusableForAccessibility(columnContent, &quot;&quot;);</span>
<span class="nc" id="L1088">					formatedDuration = makeContentFocusableForAccessibility(formatedDuration, i18n(m_bundle, AmWebBundleKey.TOTAL));</span>

<span class="nc" id="L1090">					columns.add(columnContent);</span>
					
					//add image for approve status
<span class="nc bnc" id="L1093" title="All 2 branches missed.">					if (m_hasTRELicense) {</span>
						// get image
<span class="nc" id="L1095">						boolean isAccessibilityMode = isAccessibilityComplianceMode();</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">						String approveImg = aRecord.getApprove()</span>
<span class="nc" id="L1097">								? HtmlUtil.imageTag(null, ImageFileID.APPROVED, ImageFileID.APPROVED_WIDTH,</span>
<span class="nc" id="L1098">										ImageFileID.APPROVED_HEIGHT, i18n(m_bundle, AmWebBundleKey.APPROVED), null,</span>
										null, true, null, isAccessibilityMode, isAccessibilityMode)
<span class="nc" id="L1100">								: HtmlUtil.imageTag(null, ImageFileID.NOT_APPROVED, ImageFileID.NOT_APPROVED_WIDTH,</span>
<span class="nc" id="L1101">										ImageFileID.NOT_APPROVED_HEIGHT, i18n(m_bundle, AmWebBundleKey.NOT_APPROVED),</span>
										null, null, true, null, isAccessibilityMode, isAccessibilityMode);
<span class="nc" id="L1103">						columns.add(approveImg);</span>
					}
<span class="nc" id="L1105">					columns.add(formatedDuration);</span>

<span class="nc" id="L1107">					DefaultMultiColumnNodeData userdata = new DefaultMultiColumnNodeData(</span>
<span class="nc" id="L1108">							String.valueOf(aRecord.getID()), columns);</span>
<span class="nc" id="L1109">					userdata.setAttachedObject(aPC.toString());</span>
<span class="nc" id="L1110">					data.add(userdata);</span>
				}
<span class="nc" id="L1112">			}</span>
		}
<span class="nc" id="L1114">		return data;</span>
	}
	
	private String getFormattedRecordDisplayTime(TimeRecord record) {
<span class="nc" id="L1118">		return StringUtil.NBSP + &quot;(&quot;</span>
<span class="nc bnc" id="L1119" title="All 2 branches missed.">				+ (isAccessibilityComplianceMode() ? m_localizer.formatTimeZone(record.getTimeZone())</span>
<span class="nc" id="L1120">						: TimeZoneHelper.getDisplayTimeZone(record.getTimeZone(), m_localizer))</span>
				+ &quot;)&quot; + StringUtil.NBSP;
	}
	
	private String makeContentFocusableForAccessibility(String columnContent, String columnHeader) {
<span class="nc bnc" id="L1125" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L1126">			String focusableContent = columnContent;</span>
<span class="nc bnc" id="L1127" title="All 2 branches missed.">			if (!StringUtil.isEmpty(columnHeader)) {</span>
<span class="nc" id="L1128">				focusableContent = HtmlUtil.createHiddenReadableText(columnHeader).toString() + &quot; &quot; + focusableContent;</span>
			}
<span class="nc" id="L1130">			focusableContent = HtmlUtil.getTabbableLabel(focusableContent, null);</span>
<span class="nc" id="L1131">			return focusableContent;</span>
		} else {
<span class="nc" id="L1133">			return columnContent;</span>
		}
	}

	/**
	 * getRemarkAndApproverEmployeeStr
	 */
	private String getRemarkAndApproverEmployeeStr(TimeRecord aRecord){
<span class="nc" id="L1141">		StringBuilder trElmt= new StringBuilder();</span>
<span class="nc" id="L1142">		trElmt.append(&quot;&lt;tr&gt;&quot;);</span>
<span class="nc" id="L1143">		trElmt.append(&quot;&lt;td id=\&quot;Modified\&quot; class=\&quot;sdr\&quot;&gt;&quot;);</span>
		
<span class="nc" id="L1145">		StringBuilder spanElmt = new StringBuilder();</span>
<span class="nc" id="L1146">		spanElmt.append(&quot;&lt;span class=\&quot;boldTextSm\&quot;&gt;&quot;);</span>
<span class="nc" id="L1147">		spanElmt.append(i18n(m_bundle, AmWebBundleKey.MODIFIED_BY));</span>
<span class="nc" id="L1148">		spanElmt.append(&quot;&amp;nbsp;:&amp;nbsp;&amp;nbsp;&lt;/span&gt;&quot;);</span>

<span class="nc bnc" id="L1150" title="All 2 branches missed.">		if (!StringUtil.isEmpty(aRecord.getRemarkEmployeeName())) {</span>
<span class="nc" id="L1151">			spanElmt.append(aRecord.getRemarkEmployeeName()</span>
<span class="nc" id="L1152">				+ &quot;&amp;nbsp;(&quot; + formatDate(aRecord.getLastModifiedTime(), aRecord.getTimeZone()) + &quot;)&quot;);</span>
		}

<span class="nc bnc" id="L1155" title="All 6 branches missed.">		if (aRecord.getApprove() &amp;&amp; aRecord.getApproverName()!=null &amp;&amp; aRecord.getApproveTime()!=null){//approver</span>
<span class="nc" id="L1156">			spanElmt.append(&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span class=\&quot;boldTextSm\&quot;&gt;&quot;);</span>
<span class="nc" id="L1157">			spanElmt.append(i18n(m_bundle, AmWebBundleKey.APPROVED_BY));</span>
<span class="nc bnc" id="L1158" title="All 2 branches missed.">			spanElmt.append(&quot;&amp;nbsp;:&amp;nbsp;&amp;nbsp;&lt;/span&gt;&quot; + (aRecord.getApproverName()!=null?aRecord.getApproverName():&quot;&quot;)</span>
<span class="nc" id="L1159">			+ &quot;&amp;nbsp;(&quot; + formatDate(aRecord.getApproveTime(), aRecord.getTimeZone()) + &quot;)&quot;);</span>
		}
		
<span class="nc bnc" id="L1162" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L1163">			HtmlElement el = HtmlUtil.createLabelWithAriaAttributes(&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;);</span>
<span class="nc" id="L1164">			el.setInnerHtml(spanElmt.toString());</span>
<span class="nc" id="L1165">			spanElmt = new StringBuilder(el.toString());</span>
		}
		
<span class="nc" id="L1168">		trElmt.append(spanElmt);</span>
<span class="nc" id="L1169">		trElmt.append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L1170">		trElmt.append(&quot;&lt;/tr&gt;\n&quot;);</span>
<span class="nc" id="L1171">		return trElmt.toString();</span>
	}

	/**
	 * getCommentStr
	 */
	private String getCommentStr(String comments){
<span class="nc" id="L1178">		StringBuilder trElmt = new StringBuilder();</span>
<span class="nc" id="L1179">		trElmt.append(&quot;&lt;tr&gt;&lt;td id=\&quot;Comments\&quot; class=\&quot;sdr\&quot;&gt;&quot;);</span>
		
<span class="nc" id="L1181">		StringBuilder spanElmt = new StringBuilder();</span>
<span class="nc" id="L1182">		spanElmt.append(&quot;&lt;span class=\&quot;boldTextSm\&quot;&gt;&quot;);</span>
<span class="nc" id="L1183">		spanElmt.append(i18n(m_bundle, AmWebBundleKey.COMMENTS));</span>
<span class="nc" id="L1184">		spanElmt.append(&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;:&amp;nbsp;&amp;nbsp;&lt;/span&gt;&quot;);</span>
<span class="nc" id="L1185">		spanElmt.append(comments);</span>
		
<span class="nc bnc" id="L1187" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L1188">			HtmlElement el = HtmlUtil.createLabelWithAriaAttributes(&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;);</span>
<span class="nc" id="L1189">			el.setInnerHtml(spanElmt.toString());</span>
<span class="nc" id="L1190">			spanElmt = new StringBuilder(el.toString());</span>
		}
		
<span class="nc" id="L1193">		trElmt.append(spanElmt);</span>
<span class="nc" id="L1194">		trElmt.append(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);</span>
<span class="nc" id="L1195">		return trElmt.toString();</span>
	}

	/**
	 * setTableHearder()
	 */
	private void setTableHeader(TRDayDetailPC aPC, int recordType){
<span class="nc" id="L1202">		aPC.getMultiColList().getHeader().setStyle(&quot;tableHeaderLightLeft&quot;);</span>
<span class="nc bnc" id="L1203" title="All 4 branches missed.">		if (recordType == TimeRecord.TIMEENTRY || recordType == TimeRecord.AGG_TIMEENTRY){</span>
<span class="nc" id="L1204">			aPC.getMultiColList().getHeader().addColumnHeaderData(&quot;TIME&quot;,</span>
<span class="nc" id="L1205">			i18n(m_bundle, AmWebBundleKey.TIME), &quot;tableHeaderLightLeft&quot;);</span>
		} else {
<span class="nc" id="L1207">			aPC.getMultiColList().getHeader().addColumnHeaderData(&quot;STARTTIME&quot;,</span>
<span class="nc" id="L1208">			i18n(m_bundle, AmWebBundleKey.ADHERENCE_SORT_STARTTIME), &quot;tableHeaderLightLeft&quot;);</span>
<span class="nc" id="L1209">			aPC.getMultiColList().getHeader().addColumnHeaderData(&quot;STARTTIME&quot;,</span>
<span class="nc" id="L1210">			i18n(m_bundle, AmWebBundleKey.ADHERENCE_SORT_ENDTIME), &quot;tableHeaderLightLeft&quot;);</span>
		}
<span class="nc" id="L1212">		aPC.getMultiColList().getHeader().addColumnHeaderData(&quot;ACTIVITY_CATEGORY&quot;,</span>
<span class="nc" id="L1213">			i18n(m_bundle, AmWebBundleKey.ACTIVITY_TYPE), &quot;tableHeaderLightLeft&quot;);</span>

<span class="nc bnc" id="L1215" title="All 4 branches missed.">		if (!this.getAggregated() || recordType == TimeRecord.TIMEINTERVAL){</span>
<span class="nc" id="L1216">			aPC.getMultiColList().getHeader().addColumnHeaderData(&quot;ACTIVITY&quot;,</span>
<span class="nc" id="L1217">				i18n(m_bundle, AmWebBundleKey.ACTIVITY), &quot;tableHeaderLightLeft&quot;);</span>
		}

<span class="nc bnc" id="L1220" title="All 4 branches missed.">		if (recordType == TimeRecord.TIMEENTRY || recordType == TimeRecord.AGG_TIMEENTRY){</span>
<span class="nc" id="L1221">			aPC.getMultiColList().getHeader().addColumnHeaderData(&quot;DURATION&quot;,</span>
<span class="nc" id="L1222">				i18n(m_bundle, AmWebBundleKey.DURATION), &quot;tableHeaderLightLeft&quot;);</span>
		} else {
<span class="nc" id="L1224">			aPC.getMultiColList().getHeader().addColumnHeaderData(&quot;PAIDINTERVAL&quot;,</span>
<span class="nc" id="L1225">				i18n(m_bundle, AmWebBundleKey.PAID_INTERVAL), &quot;tableHeaderLightLeft&quot;);</span>
		}
<span class="nc" id="L1227">		aPC.getMultiColList().getHeader().addColumnHeaderData(&quot;PAYABLE&quot;,</span>
<span class="nc" id="L1228">			i18n(m_bundle, AmWebBundleKey.PAYABLE), &quot;tableHeaderLightLeft&quot;);</span>
<span class="nc" id="L1229">		aPC.getMultiColList().getHeader().addColumnHeaderData(&quot;CREATOR&quot;,</span>
<span class="nc" id="L1230">			i18n(m_bundle, AmWebBundleKey.CREATOR), &quot;tableHeaderLightLeft&quot;);</span>

<span class="nc bnc" id="L1232" title="All 4 branches missed.">		if (!this.getAggregated() || recordType == TimeRecord.TIMEINTERVAL){</span>
<span class="nc" id="L1233">			aPC.getMultiColList().getHeader().addColumnHeaderData(&quot;NOTES&quot;,</span>
<span class="nc" id="L1234">				i18n(m_bundle, AmWebBundleKey.MY_NOTES), &quot;tableHeaderLightLeft&quot;);</span>
		}
<span class="nc" id="L1236">	}</span>

	/**
	 * setTableProperties()
	 */
	private void setTableProperties(TRDayDetailPC aPC){
		// Set up basic table property
<span class="nc bnc" id="L1243" title="All 2 branches missed.">		aPC.getMultiColList().setEnabled(!this.getAggregated());</span>
<span class="nc" id="L1244">		aPC.getMultiColList().setMultiRowSelectable(false);</span>

<span class="nc" id="L1246">		aPC.setNeedExpSummary(true);</span>
<span class="nc" id="L1247">		aPC.getMultiColList().setTableRowClass(&quot;sdr&quot;);</span>
<span class="nc" id="L1248">		aPC.getMultiColList().setCellClass(&quot;sdrItem&quot;);</span>
<span class="nc" id="L1249">	}</span>

	/**
	 * getHasEndShift()
	 */
	private boolean getHasEndShift(TimeRecord aRecord){
<span class="nc" id="L1255">		boolean hasEndShift = false;</span>
<span class="nc" id="L1256">		ArrayList anEntryList = (ArrayList)aRecord.getChildren();</span>
<span class="nc bnc" id="L1257" title="All 2 branches missed.">		for (int i=0; i&lt;anEntryList.size(); i++){</span>
<span class="nc bnc" id="L1258" title="All 3 branches missed.">			switch (aRecord.getType())</span>
			{
				case TimeRecord.AGG_TIMEENTRY:
				case TimeRecord.TIMEENTRY:
<span class="nc" id="L1262">					TimeRecordEntry anEntry = (TimeRecordEntry) anEntryList.get(i);</span>
<span class="nc bnc" id="L1263" title="All 2 branches missed.">					if (anEntry.getActivityID().equals(Activity.ACTIVITY_NONE)){</span>
<span class="nc" id="L1264">						hasEndShift = true;</span>
<span class="nc" id="L1265">						break;</span>
					}
					break;
				case TimeRecord.TIMEINTERVAL:
<span class="nc" id="L1269">					hasEndShift = true;</span>
					break;
			}
		}
<span class="nc" id="L1273">		return hasEndShift;</span>
	}

	/**
	 * getCreatorStr()
	 */
	private String getCreatorStr(int recordType, int timeSourceCode){
		//get text for creator
<span class="nc" id="L1281">		String creator = null;</span>
		
<span class="nc bnc" id="L1283" title="All 2 branches missed.">		if (recordType == TimeRecord.TIMEINTERVAL){</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">			if (timeSourceCode == TimeInterval.SYSTEM){</span>
<span class="nc" id="L1285">				creator = i18n(m_bundle, AmWebBundleKey.SYSTEM);</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">			} else if (timeSourceCode == TimeInterval.MANUAL){</span>
<span class="nc" id="L1287">				creator = i18n(m_bundle, AmWebBundleKey.MANAGER);</span>
<span class="nc bnc" id="L1288" title="All 2 branches missed.">			} else if (timeSourceCode == TimeInterval.SCHEDULE){</span>
<span class="nc" id="L1289">				creator = i18n(m_bundle, AmWebBundleKey.SCHEDULE);</span>
<span class="nc bnc" id="L1290" title="All 2 branches missed.">			} else if (timeSourceCode == TimeInterval.HOLIDAY){</span>
<span class="nc" id="L1291">				creator = i18n(m_bundle, AmWebBundleKey.HOLIDAY);</span>
			}
		} else {
<span class="nc bnc" id="L1294" title="All 2 branches missed.">			if (timeSourceCode == TimeEntrySourceCode.MULTI){</span>
<span class="nc" id="L1295">				creator = i18n(m_bundle, AmWebBundleKey.MULTIPLE);</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">			} else if (timeSourceCode == TimeEntrySourceCode.RAWPUNCH){</span>
<span class="nc" id="L1297">				creator = i18n(m_bundle, AmWebBundleKey.SYSTEM);</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed.">			} else if (timeSourceCode == TimeEntrySourceCode.MYTIME){</span>
<span class="nc" id="L1299">				creator = i18n(m_bundle, AmWebBundleKey.MY_TIME);</span>
<span class="nc bnc" id="L1300" title="All 2 branches missed.">			} else if (timeSourceCode == TimeEntrySourceCode.MANUAL){</span>
<span class="nc" id="L1301">				creator = i18n(m_bundle, AmWebBundleKey.MANAGER);</span>
<span class="nc bnc" id="L1302" title="All 2 branches missed.">			} else if (timeSourceCode == TimeEntrySourceCode.FROMSCHEDULE){</span>
<span class="nc" id="L1303">				creator = i18n(m_bundle, AmWebBundleKey.SCHEDULE);</span>
<span class="nc bnc" id="L1304" title="All 2 branches missed.">			} else if (timeSourceCode == TimeEntrySourceCode.AUTO_CLOSE){</span>
<span class="nc" id="L1305">				creator = i18n(m_bundle, AmWebBundleKey.SYSTEM_AUTOCLOSE);</span>
<span class="nc bnc" id="L1306" title="All 2 branches missed.">			} else if (timeSourceCode == TimeEntrySourceCode.AUTO_MERGE){</span>
<span class="nc" id="L1307">				creator = i18n(m_bundle, AmWebBundleKey.SYSTEM_AUTOMERGE);</span>
<span class="nc bnc" id="L1308" title="All 2 branches missed.">			} else if (timeSourceCode == TimeEntrySourceCode.HAAFEED){</span>
<span class="nc" id="L1309">				creator = i18n(m_bundle, AmWebBundleKey.HAA_TIME_SOURCE);</span>
			}
		}
<span class="nc bnc" id="L1312" title="All 2 branches missed.">		return creator==null?&quot;&quot;:creator;</span>
	}

	/**
	 * setComponentToolbars()
	 */
	private void setComponentToolbars(TRDayDetailPC aPC,
		RequestContext context, TimeRecord aRecord, boolean hasEndShift){
<span class="nc" id="L1320">		ToolbarPC tb1 = new ToolbarPC(context);</span>

<span class="nc" id="L1322">        boolean isEnabled = false;</span>

<span class="nc bnc" id="L1324" title="All 4 branches missed.">        if (!aRecord.isLocked() &amp;&amp; !isDayLocked){</span>
<span class="nc bnc" id="L1325" title="All 6 branches missed.">             if ((aRecord.getType() == TimeRecord.TIMEENTRY || aRecord.getType() == TimeRecord.AGG_TIMEENTRY) &amp;&amp; this.editTRPrivilege){</span>
<span class="nc" id="L1326">                isEnabled = true;</span>
<span class="nc bnc" id="L1327" title="All 4 branches missed.">            } if (aRecord.getType() == TimeRecord.TIMEINTERVAL &amp;&amp; this.editTIPrivilege){</span>
<span class="nc" id="L1328">                isEnabled = true;</span>
            }
        }
		//add end shift button if not found
<span class="nc bnc" id="L1332" title="All 4 branches missed.">		if (!hasEndShift &amp;&amp; this.editTRPrivilege){</span>
<span class="nc" id="L1333">			ToolbarTextButton aButton0 = new ToolbarTextButton(tb1,</span>
<span class="nc" id="L1334">			&quot;POPUP_CREATE_ENDSHIFT&quot;, i18n(m_bundle, AmWebBundleKey.CREATE_END_SHIFT));</span>
<span class="nc" id="L1335">			aButton0.getButtonTable().setAttribute(&quot;recordID&quot;, aRecord.getID().toString());</span>
<span class="nc" id="L1336">			aButton0.getButtonTable().setAttribute(&quot;pageAction&quot;, EditTimeRecordModel.CREATE_END_SHIFT);</span>
<span class="nc" id="L1337">			aButton0.getButtonTable().setAttribute(&quot;selectedID&quot;, this.getSelectedID());</span>
<span class="nc" id="L1338">			aButton0.getButtonTable().setAttribute(&quot;curIndex&quot;, String.valueOf(this.getEditIndex()));</span>
<span class="nc" id="L1339">			aButton0.getButtonTable().setAttribute(&quot;timeZone&quot;, aRecord.getTimeZone());</span>
<span class="nc" id="L1340">			tb1.addToolbarElement(aButton0);</span>
		}

<span class="nc bnc" id="L1343" title="All 4 branches missed.">		if (aRecord.getType() == TimeRecord.TIMEENTRY  || aRecord.getType() == TimeRecord.AGG_TIMEENTRY){</span>
<span class="nc" id="L1344">			ToolbarTextButton aButton1 = new ToolbarTextButton(tb1,</span>
<span class="nc" id="L1345">				&quot;POPUP_INSERT_ENTRY&quot;, i18n(m_bundle, AmWebBundleKey.INSERT_TIME_ENTRY), false);</span>
<span class="nc" id="L1346">			aButton1.getButtonTable().setAttribute(&quot;pageAction&quot;, EditTimeRecordModel.INSERTTE_ACTION);</span>
<span class="nc" id="L1347">			tb1.addToolbarElement(aButton1);</span>

<span class="nc" id="L1349">			ToolbarTextButton aButton2 = new ToolbarTextButton(tb1,</span>
<span class="nc" id="L1350">				&quot;POPUP_DELETE_ENTRY&quot;, i18n(m_bundle, AmWebBundleKey.DELETE_TIME_ENTRY), false);</span>
<span class="nc" id="L1351">			aButton2.getButtonTable().setAttribute(&quot;pageAction&quot;, EditTimeRecordModel.DELETETE_ACTION);</span>
<span class="nc" id="L1352">			tb1.addToolbarElement(aButton2);</span>
		}

		//edit time entry / time interval
<span class="nc bnc" id="L1356" title="All 4 branches missed.">		if (aRecord.getType() == TimeRecord.TIMEENTRY || aRecord.getType() == TimeRecord.AGG_TIMEENTRY){</span>
<span class="nc" id="L1357">			ToolbarTextButton aButton3 = new ToolbarTextButton(tb1,</span>
<span class="nc" id="L1358">				&quot;POPUP_EDIT_ENTRY&quot;, i18n(m_bundle, AmWebBundleKey.EDIT_TIME_ENTRY), false);</span>
<span class="nc" id="L1359">			aButton3.getButtonTable().setAttribute(&quot;pageAction&quot;, EditTimeRecordModel.EDITTE_ACTION);</span>
<span class="nc" id="L1360">			tb1.addToolbarElement(aButton3);</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">		} else if (aRecord.getType() == TimeRecord.TIMEINTERVAL){</span>
<span class="nc" id="L1362">			ToolbarTextButton aButton3 = new ToolbarTextButton(tb1,</span>
<span class="nc" id="L1363">				&quot;POPUP_EDIT_TIME_INTERVAL&quot;, i18n(m_bundle, AmWebBundleKey.EDIT_TIME_INTERVAL), isEnabled);</span>
<span class="nc" id="L1364">			aButton3.getButtonTable().setAttribute(&quot;recordID&quot;, aRecord.getID().toString());</span>
<span class="nc" id="L1365">			aButton3.getButtonTable().setAttribute(&quot;pageAction&quot;, DayDetailsTimeIntervalModel.EDIT_TIME_INTERVAL);</span>
<span class="nc" id="L1366">			aButton3.getButtonTable().setAttribute(&quot;selectedID&quot;, this.getSelectedID());</span>
<span class="nc" id="L1367">			aButton3.getButtonTable().setAttribute(&quot;curIndex&quot;, String.valueOf(this.getEditIndex()));</span>
<span class="nc" id="L1368">			aButton3.getButtonTable().setAttribute(&quot;timeZone&quot;, aRecord.getTimeZone());</span>
<span class="nc" id="L1369">			tb1.addToolbarElement(aButton3);</span>
		}

<span class="nc" id="L1372">		tb1.setAlignment(ToolbarPC.ALIGN_RIGHT);</span>

<span class="nc" id="L1374">		ToolbarPC tb2 = new ToolbarPC(context);</span>

		//approve record: do not show button if no privilege
<span class="nc bnc" id="L1377" title="All 2 branches missed.">		if (this.approveTRPrivilege){</span>
			//decide label based on current status
<span class="nc bnc" id="L1379" title="All 2 branches missed.">			String label = !aRecord.getApprove()?</span>
<span class="nc" id="L1380">				i18n(m_bundle, AmWebBundleKey.APPROVE_TR): i18n(m_bundle, AmWebBundleKey.UNAPPROVE_TR);</span>
<span class="nc bnc" id="L1381" title="All 2 branches missed.">			ToolbarTextButton aButton5 = new ToolbarTextButton(m_toolbar,</span>
<span class="nc bnc" id="L1382" title="All 2 branches missed.">				&quot;APPROVETR_ACTION&quot;, label, this.approveTRPrivilege &amp;&amp; getHasEndShift(aRecord)</span>
<span class="nc bnc" id="L1383" title="All 6 branches missed.">					&amp;&amp; !aRecord.getOverlap() &amp;&amp; !aRecord.isLocked() &amp;&amp; !isDayLocked);</span>
<span class="nc" id="L1384">			aButton5.getButtonTable().setAttribute(&quot;recordId&quot;, aRecord.getID().toString());</span>
<span class="nc" id="L1385">			aButton5.getButtonTable().setAttribute(&quot;version&quot;, String.valueOf(aRecord.getVersion()));</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">			aButton5.getButtonTable().setAttribute(&quot;approved&quot;, String.valueOf(!aRecord.getApprove()));</span>
<span class="nc" id="L1387">			tb2.addToolbarElement(aButton5);</span>
		}

        //delete record
<span class="nc" id="L1391">		ToolbarTextButton aButton6 = new ToolbarTextButton(m_toolbar,</span>
<span class="nc" id="L1392">			&quot;DELETETR_ACTION&quot;, i18n(m_bundle, AmWebBundleKey.DELETE_TIME_RECORD),</span>
				isEnabled);
<span class="nc" id="L1394">		aButton6.getButtonTable().setAttribute(&quot;recordID&quot;, aRecord.getID().toString());</span>
<span class="nc" id="L1395">		tb2.addToolbarElement(aButton6);</span>

		//edit remarks
<span class="nc" id="L1398">		ToolbarTextButton aButton4 = new ToolbarTextButton(tb1, &quot;POPUP_EDIT_REMARK&quot;,</span>
<span class="nc" id="L1399">			 i18n(m_bundle, AmWebBundleKey.EDIT_COMMENTS), isEnabled);</span>
<span class="nc" id="L1400">		aButton4.getButtonTable().setAttribute(&quot;recordID&quot;, aRecord.getID().toString());</span>
<span class="nc" id="L1401">		aButton4.getButtonTable().setAttribute(&quot;pageAction&quot;, EditTimeRecordModel.EDITREMARK_ACTION);</span>
<span class="nc" id="L1402">		aButton4.getButtonTable().setAttribute(&quot;selectedID&quot;, this.getSelectedID());</span>
<span class="nc" id="L1403">		aButton4.getButtonTable().setAttribute(&quot;curIndex&quot;, String.valueOf(getEditIndex()));</span>
<span class="nc" id="L1404">		aButton4.getButtonTable().setAttribute(&quot;timeZone&quot;, aRecord.getTimeZone());</span>
<span class="nc" id="L1405">		aButton4.getButtonTable().setAttribute(&quot;version&quot;, String.valueOf(aRecord.getVersion()));</span>
<span class="nc" id="L1406">		aButton4.getButtonTable().setAttribute(&quot;orgId&quot;, aRecord.getOrgID().toString());</span>
<span class="nc" id="L1407">		tb2.addToolbarElement(aButton4);</span>
<span class="nc" id="L1408">		tb2.setAlignment(ToolbarPC.ALIGN_RIGHT);</span>

<span class="nc" id="L1410">		aPC.setFirstTB(tb1);</span>
<span class="nc" id="L1411">		aPC.setSecondTB(tb2);</span>
<span class="nc" id="L1412">	}</span>

	/**
	 * set the display for the model
	 */
	public void setDisplay(RequestContext context) throws Exception{
<span class="nc bnc" id="L1418" title="All 4 branches missed.">		if (isDayLocked &amp;&amp; this.timeRecordsForEmployee.size()&gt;0){</span>
            //&quot;Time Record(s) for this day are locked.&quot;
<span class="nc" id="L1420">            addPageMessage(Message.INFO_TYPE, i18n(m_bundle, AmWebBundleKey.LOCKED_TIME_RECORDS),</span>
						AmWebBundleKey.BUNDLE_NAME);
        } else {
<span class="nc" id="L1423">			getDialogResultMessage();</span>
        }
<span class="nc" id="L1425">		aList.setStyleClass(&quot;listRowMed&quot;);</span>
<span class="nc" id="L1426">		aList.setStyleClass(&quot;listRowMed&quot;);</span>
<span class="nc" id="L1427">		aList.setEnabled(false);//prevent selection for now</span>

<span class="nc" id="L1429">		aList.setListModel(getRowData(context));</span>
		/*
		if (this.selectedIndex.size() &gt; 0){//set selected index
			int [] index = new int[]{Integer.valueOf((String)this.selectedIndex.get(0)).intValue()};
			aList.getMultiColList().setSelectedIndexes(index);
		}
		*/
<span class="nc" id="L1436">	}</span>
	protected void getDialogResultMessage() {
<span class="nc" id="L1438">		Message message = TimeRecordUtil.getContextAttribute(m_context, RequestContext.APPLICATION_SCOPE);</span>
<span class="nc bnc" id="L1439" title="All 2 branches missed.">		if (message != null) {</span>
<span class="nc" id="L1440">			addPageMessage(message);</span>
		}
<span class="nc" id="L1442">	}</span>

	/**
	 * Return MultiColListPC for display
	 */
	public MultiColListPC getList(){
<span class="nc" id="L1448">		return aList;</span>
	}

	/**
	 * Set the list header
	 */
	public void setHeader(){
<span class="nc bnc" id="L1455" title="All 2 branches missed.">		if (!StringUtil.isEmpty(this.boundaryTimeSpan)){//only if variable is not null</span>
			//set header
			//decide image based on view type
<span class="nc" id="L1458">			String image=&quot;&quot;;</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">			if (!this.aggregated){</span>
<span class="nc" id="L1460">				image = &quot;&lt;a class=\&quot;tableHeaderAnchor\&quot; href=\&quot;javascript:submitView();\&quot;&quot;</span>
<span class="nc bnc" id="L1461" title="All 2 branches missed.">						+ (isAccessibilityComplianceMode() ? ATTR_ARIA_LABEL_TOOLTIP_TRUE + &quot; &quot; + ATTR_ARIA_LABEL</span>
<span class="nc" id="L1462">								+ &quot;=\&quot;&quot; + i18n(m_bundle, AmWebBundleKey.TR_EXPANDEDVIEW) + &quot;\&quot;&quot; : &quot;&quot;)</span>
<span class="nc" id="L1463">						+ &quot;&gt;&quot; + &quot;&lt;img alt=\&quot;&quot; + i18n(m_bundle, AmWebBundleKey.TR_COLLAPSEDVIEW) + &quot;\&quot; src=\&quot;&quot;</span>
						+ ImageFileID.COLLAPSE + &quot;\&quot; style=\&quot;cursor:pointer; cursor:hand; border: 0;\&quot; alt=\&quot;\&quot; /&gt;&lt;/a&gt;&quot;;
			} else {
<span class="nc" id="L1466">				image = &quot;&lt;a class=\&quot;tableHeaderAnchor\&quot; href=\&quot;javascript:submitView();\&quot;&quot;</span>
<span class="nc bnc" id="L1467" title="All 2 branches missed.">						+ (isAccessibilityComplianceMode() ? ATTR_ARIA_LABEL_TOOLTIP_TRUE + &quot; &quot; + ATTR_ARIA_LABEL</span>
<span class="nc" id="L1468">								+ &quot;=\&quot;&quot; + i18n(m_bundle, AmWebBundleKey.TR_COLLAPSEDVIEW) + &quot;\&quot;&quot; : &quot;&quot;)</span>
<span class="nc" id="L1469">						+ &quot;&gt;&quot; + &quot;&lt;img alt=\&quot;&quot; + i18n(m_bundle, AmWebBundleKey.TR_EXPANDEDVIEW) + &quot;\&quot; src=\&quot;&quot;</span>
						+ ImageFileID.EXTEND + &quot;\&quot; style=\&quot;cursor:pointer; cursor:hand; border: 0;\&quot; alt=\&quot;\&quot; /&gt;&lt;/a&gt;&quot;;
			}
<span class="nc" id="L1472">			aList.getHeader().addColumnHeaderData(&quot;IMAGE&quot;, image + &quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;, &quot;tableHeaderLightLeft&quot;);</span>

<span class="nc bnc" id="L1474" title="All 2 branches missed.">			String viewTypeWithTime = (this.getAggregated()?i18n(m_bundle, AmWebBundleKey.ALL_TIME_RECORDS_COLLAPSEDVIEW):</span>
<span class="nc" id="L1475">								i18n(m_bundle, AmWebBundleKey.ALL_TIME_RECORDS_EXTENDEDVIEW)) + this.boundaryTimeSpan;</span>
<span class="nc bnc" id="L1476" title="All 2 branches missed.">			if(isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L1477">				viewTypeWithTime += HtmlUtil.makeHiddenSpanWithId(</span>
<span class="nc" id="L1478">						viewTypeWithTime + &quot; &quot; + getLocalizer().i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.GRID),</span>
						ARIA_LABELLEDBY_ID);
			}
<span class="nc" id="L1481">			aList.getHeader().addColumnHeaderData(&quot;ALL TIME RECORDS&quot;, viewTypeWithTime, &quot;tableHeaderLightLeft&quot;);</span>
			
<span class="nc bnc" id="L1483" title="All 2 branches missed.">			if (m_hasTRELicense)</span>
<span class="nc" id="L1484">				aList.getHeader().addColumnHeaderData(&quot;APPROVED&quot;,</span>
<span class="nc" id="L1485">					i18n(m_bundle, AmWebBundleKey.APPROVED), &quot;tableHeaderLightLeft&quot;);</span>
<span class="nc" id="L1486">			aList.getHeader().addColumnHeaderData(&quot;TOTAL&quot;,</span>
<span class="nc" id="L1487">				i18n(m_bundle, AmWebBundleKey.TOTAL), &quot;tableHeaderLightLeft&quot;);</span>
		}
<span class="nc" id="L1489">	}</span>

	/**
	 * Set the page toolbar
	 */
	public void setToolbar(RequestContext context){		// Pagination
<span class="nc" id="L1495">		m_toolbar.setPagination(&quot;&quot;, getEditIndex(), getPageIDSize(), getSelectedIDSize());</span>

		//add toolbar
<span class="nc bnc" id="L1498" title="All 2 branches missed.">		boolean enabled = this.getEmpId() != null?true: false;</span>

		//set boolean to true if found unapproved time record
<span class="nc" id="L1501">		boolean approveDay = false;</span>
<span class="nc bnc" id="L1502" title="All 2 branches missed.">		if (this.timeRecordsForEmployee!=null){</span>
<span class="nc" id="L1503">			Iterator it = this.timeRecordsForEmployee.iterator();</span>

<span class="nc bnc" id="L1505" title="All 2 branches missed.">			while (it.hasNext()) {</span>
<span class="nc" id="L1506">				TimeRecord aRecord = (TimeRecord) it.next();</span>
<span class="nc bnc" id="L1507" title="All 4 branches missed.">				if (!aRecord.getApprove() &amp;&amp; getHasEndShift(aRecord)){</span>
<span class="nc" id="L1508">					approveDay = true;</span>
<span class="nc" id="L1509">					break;</span>
				}
<span class="nc" id="L1511">			}</span>
		}


		//do not show approve day button if no privilege
<span class="nc bnc" id="L1516" title="All 2 branches missed.">		if (this.approveTRPrivilege){</span>
<span class="nc" id="L1517">			ToolbarTextButton aButton1 = new ToolbarTextButton(m_toolbar,</span>
<span class="nc" id="L1518">				&quot;APPROVEDAY_ACTION&quot;, i18n(m_bundle, AmWebBundleKey.APPROVE_DAY));</span>
<span class="nc bnc" id="L1519" title="All 2 branches missed.">			aButton1.setEnabled(this.getTimeRecordsForEmployee()!=null &amp;&amp;</span>
<span class="nc bnc" id="L1520" title="All 8 branches missed.">				this.getTimeRecordsForEmployee().size()&gt;0 &amp;&amp; this.approveTRPrivilege &amp;&amp; approveDay &amp;&amp; !isDayLocked?true:false);</span>
<span class="nc" id="L1521">			this.m_toolbar.addToolbarElement(aButton1);</span>
		}

		//do not show button if no edit privilege
<span class="nc bnc" id="L1525" title="All 2 branches missed.">		if (this.editTIPrivilege){</span>
<span class="nc" id="L1526">			ToolbarTextButton aButton6 = new ToolbarTextButton(m_toolbar,</span>
<span class="nc" id="L1527">				&quot;POPUP_CREATE_TIME_INTERVAL&quot;, i18n(m_bundle, AmWebBundleKey.CREATE_TIME_INTERVAL));</span>
<span class="nc bnc" id="L1528" title="All 2 branches missed.">			aButton6.setEnabled(!isDayLocked);</span>
<span class="nc" id="L1529">			aButton6.getButtonTable().setAttribute(&quot;pageAction&quot;, &quot;CREATE_TIME_INTERVAL&quot;);</span>
<span class="nc" id="L1530">			aButton6.getButtonTable().setAttribute(&quot;selectedID&quot;, this.getSelectedID());</span>
<span class="nc" id="L1531">			aButton6.getButtonTable().setAttribute(&quot;curIndex&quot;, String.valueOf(this.getEditIndex()));</span>
<span class="nc" id="L1532">			aButton6.getButtonTable().setAttribute(&quot;startYear&quot;, String.valueOf(this.getSelYear()));</span>
<span class="nc" id="L1533">			aButton6.getButtonTable().setAttribute(&quot;startMonth&quot;, String.valueOf(this.getSelMonth()));</span>
<span class="nc" id="L1534">			aButton6.getButtonTable().setAttribute(&quot;startDay&quot;, String.valueOf(this.getSelDay()));</span>
			//aButton6.getButtonTable().setAttribute(&quot;timeZone&quot;, context.getViewingTimeZone().getID());
<span class="nc" id="L1536">			m_toolbar.addToolbarElement(aButton6);</span>
		}

<span class="nc" id="L1539">		ToolbarTextButton aButton3 = new ToolbarTextButton(m_toolbar,</span>
<span class="nc" id="L1540">			&quot;POPUP_CREATE_RECORD&quot;, i18n(m_bundle, AmWebBundleKey.CREATE_NEW_RECORD));</span>
<span class="nc bnc" id="L1541" title="All 4 branches missed.">		aButton3.setEnabled(getEditState(context) &amp;&amp; !isDayLocked);</span>
<span class="nc" id="L1542">		aButton3.getButtonTable().setAttribute(&quot;pageAction&quot;, &quot;ADDTR_ACTION&quot;);</span>
<span class="nc" id="L1543">		aButton3.getButtonTable().setAttribute(&quot;selectedID&quot;, this.getSelectedID());</span>
<span class="nc" id="L1544">		aButton3.getButtonTable().setAttribute(&quot;curIndex&quot;, String.valueOf(this.getEditIndex()));</span>
<span class="nc" id="L1545">		aButton3.getButtonTable().setAttribute(&quot;startYear&quot;, String.valueOf(this.getSelYear()));</span>
<span class="nc" id="L1546">		aButton3.getButtonTable().setAttribute(&quot;startMonth&quot;, String.valueOf(this.getSelMonth()));</span>
<span class="nc" id="L1547">		aButton3.getButtonTable().setAttribute(&quot;startDay&quot;, String.valueOf(this.getSelDay()));</span>

<span class="nc" id="L1549">		m_toolbar.addToolbarElement(aButton3);</span>

<span class="nc" id="L1551">		ToolbarTextButton aButton5 = new ToolbarTextButton(m_toolbar,</span>
<span class="nc" id="L1552">			&quot;VIEW_ADHERENCE&quot;, i18n(m_bundle, AmWebBundleKey.VIEW_ADHERENCE), this.viewAdherencePrivilege);</span>

<span class="nc" id="L1554">		m_toolbar.addToolbarElement(aButton5);</span>

<span class="nc" id="L1556">		m_toolbar.setAlignment(ToolbarPC.ALIGN_RIGHT);</span>
<span class="nc" id="L1557">	}</span>

	/**
	 * Return the JavaScript init code required by Page model.
	 *
	 * Default behavior is to retrieve sub-component JavaScript Init code
	 */
	public String getJavaScriptInitCode() {
<span class="nc" id="L1565">		StringBuffer jsInitCode = new StringBuffer(512);</span>

		// Add sub-component JavaScript code first
<span class="nc" id="L1568">		jsInitCode.append(super.getJavaScriptInitCode()).append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L1569" title="All 2 branches missed.">		if (!this.getAggregated()){</span>
<span class="nc bnc" id="L1570" title="All 2 branches missed.">			jsInitCode.append</span>
<span class="nc" id="L1571">				((this.detailSelectedIndex != -1?&quot;T&quot;+this.mediatorNum+&quot;_t&quot;+&quot;.onSelect(\&quot;r&quot;+this.detailSelectedIndex+&quot;\&quot;);\n&quot;:&quot;&quot;));</span>
		}
<span class="nc" id="L1573">		return jsInitCode.toString();</span>
	}


	/**
	 * Override extract Parameters to handle date input
	 */
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L1581">		boolean success = super.extractParameters(request);</span>
<span class="nc bnc" id="L1582" title="All 2 branches missed.">		if (m_datePicker == null) {</span>
<span class="nc" id="L1583">			m_datePicker = new DatePickerPC(m_context, SELECTED_DATE_FN);</span>
		}
<span class="nc" id="L1585">		TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="nc bnc" id="L1586" title="All 2 branches missed.">		if (tz != null) {</span>
<span class="nc" id="L1587">			m_datePicker.setTimeZone(tz);</span>
		}
<span class="nc" id="L1589">		boolean success2 = m_datePicker.extractParameters(request);</span>
<span class="nc" id="L1590">		Date date = m_datePicker.getDate();</span>
<span class="nc" id="L1591">		initContextDateFieldNames(m_datePicker.getDateInputFieldName(), m_datePicker.getDateInputFieldName());</span>
		// need to set these variables, which are used in the timerecords modules
<span class="nc bnc" id="L1593" title="All 2 branches missed.">		if (date != null) {</span>
<span class="nc" id="L1594">			Calendar cal = Calendar.getInstance(tz);</span>
<span class="nc" id="L1595">			cal.setTime(date);</span>
<span class="nc" id="L1596">			selYear = cal.get(Calendar.YEAR);</span>
<span class="nc" id="L1597">			selMonth = cal.get(Calendar.MONTH);</span>
<span class="nc" id="L1598">			selDay = cal.get(Calendar.DAY_OF_MONTH);</span>
		}
<span class="nc bnc" id="L1600" title="All 4 branches missed.">		return success &amp;&amp; success2;</span>
	}

	private void checkForTRELicense() throws Exception{
<span class="nc" id="L1604">		m_hasTRELicense = CoreManagerFactory.getLicenseManager().isLicensed(LicenseKeys.APP_TIME_REC_EXPORT);</span>
<span class="nc" id="L1605">	}</span>

	/**
	 * getEditState()
	 */
	private boolean getEditState(RequestContext context){
<span class="nc bnc" id="L1611" title="All 2 branches missed.">		if (this.getEmpId() != null){</span>
<span class="nc" id="L1612">			return this.editTRPrivilege;</span>
		}
<span class="nc" id="L1614">		return false;</span>
	}

	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="nc" id="L1621">		return &quot;viewtimerecord&quot;;</span>
	}

		/**
	 * Return the Page Action
	 */
	public String getPageAction() {
<span class="nc" id="L1628">		return &quot;&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>