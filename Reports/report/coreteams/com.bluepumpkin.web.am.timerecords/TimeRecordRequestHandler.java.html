<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeRecordRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.am.timerecords</a> &gt; <span class="el_source">TimeRecordRequestHandler.java</span></div><h1>TimeRecordRequestHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.am.timerecords;

import java.rmi.RemoteException;
import java.util.Calendar;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeRecordException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.web.am.l10n.AmWebBundleKey;
import com.bluepumpkin.web.am.l10n.AmWebLogBundleKey;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.base.WebException;
import com.witness.web.uif.base.WorkpaneRequestHandler;
import com.witness.web.uif.keys.PageAction;
import com.bluepumpkin.web.core.keys.PageKeys;
import com.witness.web.uif.pagemodel.WorkpaneFieldNames;
import com.witness.web.uif.pagemodel.WorkpanePageModel;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        Blue Pumpkin Software Activity Management
 * Description:  Request Handler for Time Record day detail page
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       Swati Tewari
 * @version 1.0
 */

<span class="nc" id="L31">public class TimeRecordRequestHandler extends WorkpaneRequestHandler {</span>

	/** Log object used to log information to log file */
<span class="fc" id="L34">	private static Category cat  = com.bluepumpkin.web.am.Log.initCategory(TimeRecordRequestHandler.class.getName());</span>
	private static final String ADHERENCE_PAGE = &quot;adherencePage&quot;;
	private TimeRecordModel trModel;

	public void processRequest(RequestContext context) throws WebException{
<span class="nc bnc" id="L39" title="All 2 branches missed.">		if (isAction(context, TimeRecordModel.VIEWADHERENCE_ACTION)){</span>

			// workaround: 
			// storing the ADHERENCE_PARAM_EDIT_INDEX in the session
			// so that the applet can pick this up.
<span class="nc" id="L44">			String editIndex = context.getRequest().getParameter(WorkpaneFieldNames.EDIT_INDEX_FN);</span>
<span class="nc" id="L45">			context.setAttribute(RequestContext.SESSION_SCOPE, PageKeys.APPLET_PARAM_EDIT_INDEX, editIndex);</span>

<span class="nc" id="L47">			setNextPage(context, ADHERENCE_PAGE);</span>
<span class="nc" id="L48">		} else {</span>
			try {
<span class="nc" id="L50">				trModel = new TimeRecordModel(context);</span>
<span class="nc" id="L51">				trModel.setSupervisorId(context.getUser().getID());</span>
				//cache myTimeModel
<span class="nc" id="L53">				context.setPageModel(trModel);</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">				if (trModel.getSelectedIDSize() &gt; 0 ){</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">					if (isAction(context, PageAction.PREVIOUS)) {</span>
<span class="nc" id="L56">						processPrev(context,trModel);</span>
<span class="nc" id="L57">						trModel.setCurEmployee();</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">					} else if (isAction(context, PageAction.NEXT)) {</span>
<span class="nc" id="L59">						processNext(context,trModel);</span>
<span class="nc" id="L60">						trModel.setCurEmployee();</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">					} else if (isAction(context, PageAction.NEW_ID)) {</span>
<span class="nc" id="L62">						processNewID(context,trModel);</span>
<span class="nc" id="L63">						trModel.setCurEmployee();</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">					} else if (isAction(context,TimeRecordModel.DELETETR_ACTION)){</span>
<span class="nc" id="L65">						deleteTimeRecord();</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">					} else if (isAction(context,TimeRecordModel.APPROVEDAY_ACTION)){</span>
<span class="nc" id="L67">						approveDay(context);</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">					} else if (isAction(context,TimeRecordModel.APPROVETR_ACTION)){</span>
<span class="nc" id="L69">						approveTimeRecord(context);</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">					} else if (isAction(context,TimeRecordModel.DELETETE_ACTION)){</span>
<span class="nc" id="L71">						removeTimeRecordEntry(context);</span>
					}
					//trModel.processTimeRecordForEmployee(context);
				} else {//message for employee selection
<span class="nc" id="L75">					trModel.addPageMessage(Message.RESPONSE_TYPE,</span>
						AmWebBundleKey.SELECT_EMPLOYEE, AmWebBundleKey.BUNDLE_NAME);

					//set calendar to today if not set yet
<span class="nc bnc" id="L79" title="All 2 branches missed.">					if (trModel.getSelYear()  == -1){</span>
<span class="nc" id="L80">						Calendar aCal = Calendar.getInstance();</span>
<span class="nc" id="L81">						trModel.setSelYear(aCal.get(Calendar.YEAR));</span>
<span class="nc" id="L82">						trModel.setSelMonth(aCal.get(Calendar.MONTH));</span>
<span class="nc" id="L83">						trModel.setSelDay(aCal.get(Calendar.DAY_OF_MONTH));</span>
					}
					//set boundaryTimeSpan to empty string
<span class="nc" id="L86">					trModel.setBoundaryTimeSpan(&quot;&quot;);</span>
				}
<span class="nc" id="L88">			} catch (Exception e ) {</span>
<span class="nc" id="L89">				throw new WebException();</span>
<span class="nc" id="L90">			}</span>
		}
<span class="nc" id="L92">	}</span>
	/**
	 * Return Page Model to perform generic action request on
	 */
	public WorkpanePageModel getPageModel(RequestContext context) {
<span class="nc" id="L97">		return trModel;</span>
	}

	/**
	 * Custom process Request
	 */
	public void processCustomRequest(RequestContext context) throws WebException {
<span class="nc" id="L104">	}</span>

	/**
	 * Process approve time record
	 */
	private void approveTimeRecord(RequestContext context)
	throws RemoteException{
		try {
<span class="nc" id="L112">			TimeRecordModelHandler.approveTimeRecord(new ID(trModel.getRecordId()),</span>
<span class="nc" id="L113">				trModel.getApproved(), trModel.getVersion(), context.getUser().getUserName());</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">			if (trModel.getApproved()){</span>
<span class="nc" id="L115">				trModel.addPageMessage(Message.RESPONSE_TYPE,</span>
				AmWebBundleKey.MSG_RECORDAPPROVED,  AmWebBundleKey.BUNDLE_NAME);
			} else {
<span class="nc" id="L118">				trModel.addPageMessage(Message.RESPONSE_TYPE,</span>
					AmWebBundleKey.MSG_RECORDDISAPPROVED,  AmWebBundleKey.BUNDLE_NAME);
			}
<span class="nc" id="L121">		} catch (BbmTimeRecordException ex){</span>
<span class="nc" id="L122">			cat.l7dInfo(AmWebLogBundleKey.MSG_ERROR_APPROVINGTR, ex);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            if (trModel.getApproved()){</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">                if (ex.getErrCode()==BbmTimeRecordException.TR_INVALID){</span>
<span class="nc" id="L125">                    trModel.addPageMessage(Message.ERROR_TYPE,</span>
                        AmWebBundleKey.MSG_ERROR_APPROVINGTR_INVALID, AmWebBundleKey.BUNDLE_NAME);
                } else {
<span class="nc" id="L128">                    trModel.addPageMessage(Message.ERROR_TYPE,</span>
                        AmWebBundleKey.MSG_ERROR_APPROVINGTR, AmWebBundleKey.BUNDLE_NAME);
                }
            } else {
<span class="nc" id="L132">                trModel.addPageMessage(Message.ERROR_TYPE,</span>
                AmWebBundleKey.MSG_ERROR_UNAPPROVINGTR, AmWebBundleKey.BUNDLE_NAME);
            }
<span class="nc" id="L135">		} catch (BbmUpdateException ex){</span>
<span class="nc" id="L136">			cat.l7dError(AmWebLogBundleKey.MSG_ERROR_APPROVINGTR, ex);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (trModel.getApproved()){</span>
<span class="nc" id="L138">                trModel.addPageMessage(Message.ERROR_TYPE,</span>
                    AmWebLogBundleKey.MSG_ERROR_UPDATINGTR,    AmWebBundleKey.BUNDLE_NAME);
            } else {
<span class="nc" id="L141">                trModel.addPageMessage(Message.ERROR_TYPE,</span>
                AmWebBundleKey.MSG_ERROR_UNAPPROVINGTR, AmWebBundleKey.BUNDLE_NAME);
            }
<span class="nc" id="L144">		}</span>
<span class="nc" id="L145">	}</span>

	/**
	 * Process approve day
	 */
	private void approveDay(RequestContext context)
	throws RemoteException{
		try {
<span class="nc" id="L153">			TimeRecordModelHandler.approveTimeRecords(trModel, context);</span>
<span class="nc" id="L154">			trModel.addPageMessage(Message.RESPONSE_TYPE,</span>
				AmWebBundleKey.MSG_RECORDSAPPROVED, AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L156">		} catch (BbmTimeRecordException ex){</span>
<span class="nc" id="L157">			cat.l7dError(AmWebLogBundleKey.MSG_ERROR_APPROVINGTR_DAY, ex);</span>
<span class="nc" id="L158">			trModel.addPageMessage(Message.ERROR_TYPE,</span>
				AmWebBundleKey.MSG_ERROR_APPROVINGTR_DAY, AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L160">		} catch (BbmUpdateException ex){</span>
<span class="nc" id="L161">			cat.l7dError(AmWebLogBundleKey.MSG_ERROR_UPDATINGTR, ex);</span>
<span class="nc" id="L162">			trModel.addPageMessage(Message.ERROR_TYPE,</span>
				AmWebBundleKey.MSG_ERROR_UPDATINGTR, AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L164">		}</span>
<span class="nc" id="L165">	}</span>

	/**
	 * Process delete time record
	 */
	private void deleteTimeRecord() throws RemoteException{
		try {
<span class="nc" id="L172">			TimeRecordModelHandler.deleteTimeRecord(new ID(trModel.getRecordId()));</span>
<span class="nc" id="L173">			trModel.addPageMessage(Message.RESPONSE_TYPE,</span>
				AmWebBundleKey.MSG_TRDELETED, AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L175">		} catch (BbmRemoveException ex){</span>
<span class="nc" id="L176">			cat.l7dError(AmWebLogBundleKey.MSG_ERROR_DELETINGTR, ex);</span>
<span class="nc" id="L177">			trModel.addPageMessage(Message.ERROR_TYPE,</span>
				AmWebBundleKey.MSG_ERROR_DELETINGTR, AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L179">		}</span>
<span class="nc" id="L180">	}</span>

    /**
	 * removeTimeRecordEntry()
	 */
	private void removeTimeRecordEntry(RequestContext context){

		try {
<span class="nc" id="L188">			TimeRecordModelHandler.removeTimeRecordEntry(new ID(trModel.getRecordId()),</span>
<span class="nc" id="L189">					context.getUser().getID(), trModel.getPosition(), trModel.getDirection(), trModel.getVersion());</span>
<span class="nc" id="L190">			trModel.addPageMessage(Message.RESPONSE_TYPE,</span>
				AmWebBundleKey.MSG_TEDELETED, AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L192">		} catch (Exception ex){</span>
<span class="nc" id="L193">			cat.l7dError(AmWebLogBundleKey.MSG_ERROR_DELETINGTE, ex);</span>
<span class="nc" id="L194">			trModel.addPageMessage(Message.ERROR_TYPE,</span>
				AmWebBundleKey.MSG_ERROR_DELETINGTE, AmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L196">		}</span>
<span class="nc" id="L197">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>