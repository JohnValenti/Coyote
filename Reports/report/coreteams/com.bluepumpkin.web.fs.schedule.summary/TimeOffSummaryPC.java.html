<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffSummaryPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.schedule.summary</a> &gt; <span class="el_source">TimeOffSummaryPC.java</span></div><h1>TimeOffSummaryPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.schedule.summary;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.ResourceBundle;
import java.util.Set;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.TreeModel;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.BPMessageFormat;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityCategory;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
//import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TOAccrualCalculator;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffAccrued;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TimeOffActivitySummary;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.fs.Log;
import com.bluepumpkin.web.fs.keys.FsImageFileID;
import com.bluepumpkin.web.fs.keys.FsKeys;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.core.pagecomponent.tree.ReadableMultiColTreePC;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.jsp.HtmlButton;
import com.witness.web.uif.jsp.HtmlElement;
import com.witness.web.uif.jsp.HtmlImage;
import com.witness.web.uif.jsp.HtmlSelect;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagecomponent.tree.MultiColTreePC;
import com.witness.web.uif.pagecomponent.tree.util.DefaultSortableTreeNodeHelper;
import com.witness.web.uif.pagecomponent.tree.util.SortableTreeNodeHelper;
import com.witness.web.uif.pagecomponent.tree.util.TreeModelBuilder;
import com.witness.web.uif.pagecomponent.tree.util.TreeNodeConverter;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.UserPreferencesUtil;
import com.witness.web.uif.util.html.CSSUtil;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title:        TimeOffSummaryPC
 * Description:  Display Time Off Summary
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, dsu
 * @version      1.0
 *
 * Created on September 19, 2002, 10:29 AM
 */
public class TimeOffSummaryPC extends CollapsibleContainerPC { 
	public static final String STYLE_ATTR = &quot;style&quot;;
<span class="nc" id="L68">	private static Category m_log = Log.initCategory(TimeOffSummaryPC.class.getName());</span>
	private static final String YEAR_OPTION_DELIM = &quot; - &quot;;

	private final ResourceBundle m_bundle;
	private final TimeZone m_tz;
	private final ID m_empID;
	private final String m_empName;//Show employee name on title, if it's not set to null
	private final String TO_YEAR_FN;
	private Collection m_timeoffData;
	private Calendar m_timeoffYearStart;
	private Set m_timeoffCatIdSet;
<span class="nc" id="L79">	private String m_timeOffYear = FsKeys.TO_YEAR_CURRENT;</span>
<span class="nc" id="L80">	private Date m_inputDate = null;//if set, the timeOffYear is based on this date instead of the dropdown</span>
<span class="nc" id="L81">	private String m_asOfDate = &quot;&quot;;</span>
<span class="nc" id="L82">	private boolean m_hasAccrualLicense = false;</span>
<span class="nc" id="L83">	private boolean m_isAgentPage = true;</span>

	/**
	 * Creates a new instance of TimeOffSummaryPC for the agent's page
	 * @param context
	 */
	public TimeOffSummaryPC(RequestContext context) {
<span class="nc" id="L90">		this(context, context.getUser().getEmployeeID(), null, true);</span>
<span class="nc" id="L91">	}//constructor</span>

	/**
	 * Creates a new instance of TimeOffSummaryPC for the manager's page
	 * @param context
	 */
	public TimeOffSummaryPC(RequestContext context, ID empID, String empName, boolean isAgentPage) {
<span class="nc" id="L98">		super(context);</span>
<span class="nc" id="L99">        m_isAgentPage = isAgentPage;</span>
<span class="nc" id="L100">		m_bundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L101">		m_tz = context.getViewingTimeZone();</span>
<span class="nc" id="L102">		m_empID = empID;</span>
<span class="nc" id="L103">		m_empName = empName;</span>
<span class="nc" id="L104">		setName(&quot;toSummaryPC_&quot; + m_empID);</span>
<span class="nc" id="L105">		TO_YEAR_FN = &quot;timeOffYear&quot;;// + m_empID; (Don't need this for now, we don't allow DropDown when multi-selection)</span>
<span class="nc" id="L106">	}</span>

	/**
	 * Initialize with default Data
	 */
	public void init() {
		try {
<span class="nc" id="L113">			HashMap theData = new HashMap();</span>

<span class="nc" id="L115">			ScheduleSummaryMH.getTimeOffSummary(m_context, m_empID, m_inputDate, getTimeOffYear(), theData, m_isAgentPage);</span>

<span class="nc" id="L117">			Collection timeOffSummaryData = (Collection)theData.get(ScheduleSummaryMH.TO_SUMMARY_DATA_KEY);</span>
<span class="nc" id="L118">			Calendar timeOffYearStart = (Calendar)theData.get(ScheduleSummaryMH.TO_YEAR_KEY);</span>

<span class="nc" id="L120">			init(timeOffSummaryData, timeOffYearStart);</span>
<span class="nc" id="L121">		} catch (BbmFinderException ex) {</span>
			//m_log.l7dInfo(FsWebBundleKey.MSG_SCHED_SUMMARY_NO_TO_SUMMARY, ex);
<span class="nc" id="L123">			addPageMessage(Message.ERROR_TYPE, ex.getLocalizedMessage());</span>
		}	 
<span class="nc" id="L125">		catch (Exception ex) {</span>
<span class="nc" id="L126">			m_log.l7dError(FsWebBundleKey.MSG_SCHED_SUMMARY_NO_TO_SUMMARY, ex);</span>
<span class="nc" id="L127">			addPageMessage(Message.ERROR_TYPE, FsWebBundleKey.MSG_SCHED_SUMMARY_NO_TO_SUMMARY,</span>
					FsWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L129">		}	</span>
<span class="nc" id="L130">	}//init</span>

	/**
	 * Initialize Component with Data
	 * @param data - time off data
	 * @param yearStart
	 */ 
	public void init(Collection data, Calendar yearStart) {
<span class="nc" id="L138">		m_timeoffData = data;</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">		if (yearStart==null) {</span>
<span class="nc" id="L140">			m_timeoffYearStart = Calendar.getInstance(m_tz, m_locale);			</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">			if (isNextYearSelect()){</span>
<span class="nc" id="L142">				m_timeoffYearStart.add(Calendar.YEAR, 1);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">			}else if (isPreviousYearSelect()){</span>
<span class="nc" id="L144">				m_timeoffYearStart.add(Calendar.YEAR, -1);</span>
			}
		} else {
<span class="nc" id="L147">			m_timeoffYearStart = yearStart;</span>
		}
<span class="nc" id="L149">	}//init</span>

	/**
	 * Initialize Component For Display
	 */   
	public void initForDisplay() {
<span class="nc bnc" id="L155" title="All 2 branches missed.">		if (m_isInitializedForDisplay) return; </span>
		else {        
<span class="nc" id="L157">			super.initForDisplay();</span>
<span class="nc" id="L158">			initContent();</span>
		}
<span class="nc" id="L160">	}//initForDisplay</span>

	/**
	 * Initialize Content
	 */
	private void initContent() {
<span class="nc" id="L166">		m_hasAccrualLicense = true; //TOAccrualCalculator.hasLicenseForAccrual();</span>

		//--- container title
<span class="nc" id="L169">		String yearOptionsHtml = makeYearOptionsHtml();</span>
		String title;
<span class="nc bnc" id="L171" title="All 2 branches missed.">		if (m_empName == null) {//Do not display employee name in title</span>
<span class="nc" id="L172">			String template = i18n(m_bundle, FsWebBundleKey.SCHED_SUMMARY_TO_SUMMARY);</span>
<span class="nc" id="L173">			Object[] args = new Object[] {yearOptionsHtml, m_asOfDate};		</span>
<span class="nc" id="L174">			title = BPMessageFormat.format(template, args);</span>
<span class="nc" id="L175">		} else {//Display employee name in title</span>
<span class="nc" id="L176">			String template = i18n(m_bundle, FsWebBundleKey.SCHED_SUMMARY_TO_SUMMARY2);</span>
<span class="nc" id="L177">			Object[] args = new Object[] {yearOptionsHtml, m_asOfDate, m_empName};		</span>
<span class="nc" id="L178">			title = BPMessageFormat.format(template, args);</span>
		}
<span class="nc" id="L180">		setTitle(title);</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">		if (m_hasAccrualLicense) {//Only show when has license</span>
<span class="nc" id="L182">			addHeaderControl(getCalculatorLink());</span>
		}
<span class="nc" id="L184">		setStyleClass(CSSUtil.CLASS_BORDER_DEFAULT);</span>

		// Initialize Tree as content
<span class="nc" id="L187">		initSummaryTree();</span>
<span class="nc" id="L188">	}//initContent</span>

	/**
	 * make html string for the dropdown of this/next time off year selector
	 * @return string ready for rendering
	 */
	private String makeYearOptionsHtml() {		
		//--- Set dates for current and next years
<span class="nc" id="L196">		Calendar prevCal = Calendar.getInstance(m_tz, m_locale);</span>
<span class="nc" id="L197">		Calendar currentCal = Calendar.getInstance(m_tz, m_locale);</span>
<span class="nc" id="L198">		Calendar nextCal = Calendar.getInstance(m_tz, m_locale);</span>
<span class="nc" id="L199">		String hiddenLabel = &quot;&quot;;</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">		if (m_timeoffYearStart!= null) {</span>
<span class="nc" id="L201">			Date yearStartDate = m_timeoffYearStart.getTime();</span>
<span class="nc" id="L202">			prevCal.setTime(yearStartDate);</span>
<span class="nc" id="L203">			currentCal.setTime(yearStartDate);</span>
<span class="nc" id="L204">			nextCal.setTime(yearStartDate);</span>
		}

		// Need to adjust Current and Next because yearStartDate value is based on isCurrentYearSelect
		int indexSelected;
<span class="nc bnc" id="L209" title="All 2 branches missed.">		if (isCurrentYearSelect()) {</span>
<span class="nc" id="L210">			prevCal.add(Calendar.YEAR,-1);</span>
<span class="nc" id="L211">			nextCal.add(Calendar.YEAR,1);</span>
<span class="nc" id="L212">			indexSelected = 1;</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">		} else if(isPreviousYearSelect()){</span>
<span class="nc" id="L214">			currentCal.add(Calendar.YEAR,1);</span>
<span class="nc" id="L215">			nextCal.add(Calendar.YEAR,2);</span>
<span class="nc" id="L216">			indexSelected = 0;</span>
		}else{
<span class="nc" id="L218">			prevCal.add(Calendar.YEAR,-2);</span>
<span class="nc" id="L219">			currentCal.add(Calendar.YEAR,-1);</span>
<span class="nc" id="L220">			indexSelected = 2;</span>
		}

		//--- make three options for the drop down
<span class="nc" id="L224">		ArrayList timeOffYearOptions = new ArrayList(3);</span>
<span class="nc" id="L225">		StringsPair spPrevious = new StringsPair(FsKeys.TO_YEAR_PREVIOUS, makeYearOptionText(prevCal));</span>
<span class="nc" id="L226">		StringsPair spCurrent = new StringsPair(FsKeys.TO_YEAR_CURRENT, makeYearOptionText(currentCal));</span>
<span class="nc" id="L227">		StringsPair spNext = new StringsPair(FsKeys.TO_YEAR_NEXT, makeYearOptionText(nextCal));</span>
<span class="nc" id="L228">		timeOffYearOptions.add(spPrevious);</span>
<span class="nc" id="L229">		timeOffYearOptions.add(spCurrent);</span>
<span class="nc" id="L230">		timeOffYearOptions.add(spNext);</span>

		//Initialize m_asOfDate, which is the end date of the selected year option
<span class="nc" id="L233">		String textSelected = ((StringsPair)timeOffYearOptions.get(indexSelected)).getValue();</span>
<span class="nc" id="L234">		int i = textSelected.indexOf(YEAR_OPTION_DELIM) + YEAR_OPTION_DELIM.length();</span>
		
<span class="nc" id="L236">		String asOfDatePlainText = textSelected.substring(i);</span>
<span class="nc" id="L237">		m_asOfDate = &quot;&lt;b&gt;&quot; + asOfDatePlainText + &quot;&lt;/b&gt;&quot;;//Bold</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">		if(isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L239">			setUseWrapper(true);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">			if(m_empName == null) {</span>
<span class="nc" id="L241">				hiddenLabel = BPMessageFormat.format(i18n(m_bundle, FsWebBundleKey.SCHED_SUMMARY_TO_SUMMARY), </span>
						new String[]{textSelected, asOfDatePlainText});
			} else {
<span class="nc" id="L244">				hiddenLabel = BPMessageFormat.format(i18n(m_bundle, FsWebBundleKey.SCHED_SUMMARY_TO_SUMMARY2), </span>
						new String[]{textSelected, asOfDatePlainText, m_empName});
			}
			
<span class="nc" id="L248">			this.setWrapperAriaLabel(hiddenLabel);</span>
		}

<span class="nc bnc" id="L251" title="All 2 branches missed.">		if (m_inputDate == null) //Use Drop Down Selection Box</span>
        {
            //return HtmlUtil.makeSelectInput(TO_YEAR_FN, m_timeOffYear, JSUtil.REFRESH_PAGE, timeOffYearOptions);
            //For 508, we need to create an htmlSelect, and set its title, since our label won't work,
            //because it is a multiple-part label (before and after the selector). We then pass the 
            //selectorit as argument to HtmlUtil.makeSelectDD(..., htmlSelect);
<span class="nc" id="L257">            String label = i18n(m_bundle, FsWebBundleKey.SCHED_SUMMARY_TO_SUMMARY_TITLE);</span>
<span class="nc" id="L258">            HtmlSelect htmlSelect = new HtmlSelect(TO_YEAR_FN, timeOffYearOptions, m_timeOffYear);</span>
            //htmlSelect.setOnChange(JSUtil.REFRESH_PAGE);
<span class="nc" id="L260">            htmlSelect.setTitle(label);</span>
<span class="nc" id="L261">			htmlSelect.setAriaDescription(getLocalizer().i18n(BbmWebBundleKey.BUNDLE_NAME,</span>
<span class="nc" id="L262">					BbmWebBundleKey.DROPDOWN_SELECTION_CAUTION_MESSAGE), htmlSelect.getName() + &quot;_desc&quot;);</span>
<span class="nc" id="L263">			return HtmlUtil.makeSelectInput(TO_YEAR_FN, &quot;&quot;, new String[] { m_timeOffYear }, JSUtil.REFRESH_PAGE,</span>
					timeOffYearOptions, null, false, false, true, false, null, htmlSelect, true, label, null);
        }
		else //Just show Plain Text (of Selected Option - FsKeys.TO_YEAR_CURRENT)
        {
<span class="nc" id="L268">			return textSelected;</span>
        }
	}//makeYearOptionsHtml

	/*
	* make year option display string
	*/
	private String makeYearOptionText(Calendar yearStart){
<span class="nc" id="L276">		Calendar endCal = Calendar.getInstance(m_tz, m_locale);</span>
<span class="nc" id="L277">		endCal.setTime(yearStart.getTime());</span>
<span class="nc" id="L278">		endCal.add(Calendar.YEAR,1);</span>
<span class="nc" id="L279">		endCal.add(Calendar.MINUTE,-1);</span>
<span class="nc" id="L280">		return localize(yearStart) + YEAR_OPTION_DELIM + localize(endCal);</span>
	}//makeYearOptionText

	/**
	 * Localize Calendar
	 */
	private String localize(Calendar cal) {
<span class="nc" id="L287">		return m_localizer.formatDate(cal.getTime(), m_tz, RegionalFormatBundleKey.DATE_FORMAT);</span>
	}

	/**
	 * HTML code for Calculator Pop-up Button
	 */
	private String getCalculatorLink() {
<span class="nc" id="L294">		final String cmd = &quot;CALCULATE_TO_&quot; + m_empID;</span>
<span class="nc" id="L295">		addPopupArgs(cmd, &quot;to_accrual_calculator&quot;, &quot;empID=&quot; + m_empID + &quot;&amp;isAgentPage=&quot; + m_isAgentPage, null,</span>
				&quot;480,360,ctr,ctr&quot;, true, 1);
<span class="nc" id="L297">		String onClick = &quot;pageMediator.popupWindow('&quot; + cmd + &quot;', pageMediator);&quot;;</span>
<span class="nc" id="L298">		return getCalculatorBtnImage(onClick).toString();</span>
	}

	private HtmlButton getCalculatorBtnImage(String onClick) {
<span class="nc" id="L302">        HtmlImage btnImage = new HtmlImage(FsImageFileID.TO_ACCRUAL_CALCULATOR);</span>
<span class="nc" id="L303">		btnImage.setAttribute(&quot;class&quot;, &quot;imgTableHeader&quot;); //CSSUtil.CLASS_HAND_CURSOR);</span>
<span class="nc" id="L304">		btnImage.setAttribute(STYLE_ATTR, &quot;background-color:#FFFFFF&quot;);</span>
<span class="nc" id="L305">        btnImage.setAlt(i18n(m_bundle, FsWebBundleKey.TO_ACCRUAL_CALCULATOR));</span>
        
<span class="nc" id="L307">        HtmlButton button = new HtmlButton(FsWebBundleKey.TO_ACCRUAL_CALCULATOR);</span>
<span class="nc" id="L308">        button.setInnerHtml(btnImage);</span>
<span class="nc" id="L309">        button.setAttribute(&quot;class&quot;, &quot;imgTableHeader&quot;);</span>
<span class="nc" id="L310">        button.setAttribute(STYLE_ATTR, &quot;background-color:#FFFFFF&quot;);</span>
<span class="nc" id="L311">        button.appendAttribute(&quot;align&quot;, &quot;absmiddle&quot;);</span>
<span class="nc" id="L312">        button.setOnClick(onClick);</span>
<span class="nc" id="L313">        button.setAttribute(&quot;title&quot;, i18n(m_bundle, FsWebBundleKey.TO_ACCRUAL_CALCULATOR)); //508</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L315">			button.setAttribute(&quot;aria-label&quot;, i18n(m_bundle, FsWebBundleKey.TO_ACCRUAL_CALCULATOR));</span>
<span class="nc" id="L316">			button.setAttribute(&quot;aria-label-tooltip&quot;, &quot;true&quot;);</span>
		}
<span class="nc" id="L318">        return button;</span>
	}

	/**
	 * Initialize Summary Tree
	 */
	private void initSummaryTree() {
<span class="nc" id="L325">		MultiColTreePC treePC = new ReadableMultiColTreePC(m_context, m_bundle, UserPreferencesUtil.getRepeatHeaderInterval(m_context));</span>
<span class="nc" id="L326">		treePC.setName(this.getName() + &quot;_tree&quot;);</span>
<span class="nc" id="L327">		treePC.setIsTreeRootShown(false);</span>
<span class="nc" id="L328">		treePC.setMultiRowSelectable(false);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L330">			treePC.setWrapperRegion(false);</span>
<span class="nc" id="L331">			treePC.setUseWrapper(true);</span>
<span class="nc" id="L332">			treePC.setRenderJavaScriptIfDisabled(true);</span>
<span class="nc" id="L333">			HtmlElement wrapper = treePC.getWrapper();</span>
<span class="nc" id="L334">			String wrapperInlineStyle = wrapper.getAttribute(STYLE_ATTR);</span>
<span class="nc" id="L335">			wrapper.setAttribute(STYLE_ATTR, wrapperInlineStyle + &quot; margin:2px;&quot;);</span>
		}
<span class="nc" id="L337">		initTreeData(treePC);</span>
<span class="nc" id="L338">		setTemplate(&quot;{0}&quot;);</span>
<span class="nc" id="L339">		addComponent(treePC);</span>
<span class="nc" id="L340">	}</span>


	/**
	 * create headers for Time Off Summary
	 */
	private void initTreeHeader(MultiColTreePC treePC){
<span class="nc" id="L347">		TableHeaderPC header = treePC.getHeader();</span>
<span class="nc" id="L348">		header.addColumnHeaderData(&quot;TIME_OFF_TYPE_COL&quot;,i18n(m_bundle,FsWebBundleKey.TO_SUMMARY_TO_TYPE), CSSUtil.CLASS_INNER_HEADER_BORDER);</span>

		//Story 5861 - Time Summary/My Schedule Summary Time-Off Changes
<span class="nc" id="L351">		boolean isTOSummaryOverrides = isTimeOffSummaryColumnChanged();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">		if (isTOSummaryOverrides)</span>
		{
			//Balance: If current Time-Off Year is selected then this column will display the latest balance that was imported from payroll.
<span class="nc" id="L355">			addNumericHeader(&quot;BALANCE_COL&quot;, FsWebBundleKey.SUMMARY_TB_BALANCE_HOURS, header);</span>

			//Date Last Updated: If current Time-Off Year is selected then this column will display the date that the above balance is applicable to.
<span class="nc" id="L358">			addNumericHeader(&quot;LAST_UPDATED_COL&quot;, m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME), BbmWebBundleKey.LastUpdatedDate, header);</span>
		}
		else
		{
<span class="nc" id="L362">			addNumericHeader(&quot;TOTAL_COL&quot;, FsWebBundleKey.TO_SUMMARY_TOTAL, header);</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">			if (m_hasAccrualLicense)</span>
<span class="nc" id="L364">				addNumericHeader(&quot;CARRYOVER_COL&quot;, FsWebBundleKey.TO_SUMMARY_CARRYOVER, header);</span>
		}

<span class="nc" id="L367">		addNumericHeader(&quot;USED_COL&quot;, FsWebBundleKey.TO_SUMMARY_USED, header);</span>
<span class="nc" id="L368">		addNumericHeader(&quot;SCHEDULED_COL&quot;, FsWebBundleKey.TO_SUMMARY_SCHEDULED, header);</span>
<span class="nc" id="L369">		addNumericHeader(&quot;PENDING_COL&quot;, FsWebBundleKey.TO_SUMMARY_PENDING, header);</span>
<span class="nc" id="L370">		addNumericHeader(&quot;REMAINING_COL&quot;, FsWebBundleKey.TO_SUMMARY_REMAINING, header);</span>
        
<span class="nc" id="L372">        header.addDefaultSortColumn(&quot;TIME_OFF_TYPE_COL&quot;);</span>
<span class="nc" id="L373">        header.setPartialSortable(true); //setPartialSortable setSortable</span>
<span class="nc" id="L374">	}</span>

	private void addNumericHeader(String colName, String rbKey, TableHeaderPC header) {
<span class="nc" id="L377">		addNumericHeader(colName,m_bundle, rbKey, header);</span>
<span class="nc" id="L378">	}</span>

	private void addNumericHeader(String colName, ResourceBundle bundle, String rbKey, TableHeaderPC header) {
<span class="nc" id="L381">		header.addColumnHeaderData(colName,i18n(bundle,rbKey), CSSUtil.CLASS_INNER_HEADER_BORDER_NUMERIC);</span>
<span class="nc" id="L382">	}</span>

	/**
	 * set Time Off Summary Data items
	 */
	private void initTreeData(MultiColTreePC treePC){
<span class="nc" id="L388">		initTreeHeader(treePC);</span>
<span class="nc bnc" id="L389" title="All 4 branches missed.">		if (m_timeoffData == null || m_timeoffData.isEmpty()) return;</span>

<span class="nc" id="L391">		m_timeoffCatIdSet = new HashSet();</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">		for (Iterator it = m_timeoffData.iterator(); it.hasNext();) {</span>
<span class="nc" id="L393">			TimeOffActivitySummary summary = (TimeOffActivitySummary) it.next();</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">			if (summary.getActivityID() == null)//This represents an ActivityCategory</span>
<span class="nc" id="L395">				m_timeoffCatIdSet.add(summary.getActivityCategory().getID());</span>
<span class="nc" id="L396">		}</span>

<span class="nc" id="L398">		TimeOffActivitySummary rootData = new TimeOffActivitySummary();//This empty root won't be shown</span>
        //TreeNodeHelper treeNodeHelper = new DefaultTreeNodeHelper(m_timeoffData, rootData, new TOActSummaryConvertor());
<span class="nc" id="L400">        SortableTreeNodeHelper sortableTreeNodeHelper = new DefaultSortableTreeNodeHelper(m_timeoffData, rootData, new TOActSummaryConvertor());</span>
		//TreeModel treeModel = TreeModelBuilder.buildTreeModel(m_timeoffData, treeNodeHelper, sortableTreeNodeHelper);
<span class="nc" id="L402">        TreeModel treeModel = TreeModelBuilder.buildTreeModel(sortableTreeNodeHelper, new int[]{0}, true, null); //m_localizer</span>
<span class="nc" id="L403">		treePC.setTreeModel(treeModel);</span>
<span class="nc" id="L404">	}</span>

	/**
	 * The TimeOffActivitySummary could represent a row of an Activity,
	 * In this case, it contains ActivityID, ActivityName, and the ActivityCategory of this Activity.
	 * It could also represent a row of an ActivityCategory,
	 * In this case, it contains only the ActivityCategory object, Activity fields are null.
	 */
<span class="nc" id="L412">	class TOActSummaryConvertor implements TreeNodeConverter {</span>
		/**
		 * Returns ActivityID or ActivityCategoryID
		 */
		public ID getNodeID(Object data) {
<span class="nc" id="L417">			TimeOffActivitySummary summary = (TimeOffActivitySummary) data;</span>
<span class="nc" id="L418">			ID id = summary.getActivityID();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">			if (id == null)</span>
<span class="nc" id="L420">				id = getParentNodeID(data);</span>
<span class="nc" id="L421">			return id;</span>
		}

		/**
		 * Returns ActivityCategoryID
		 */
		public ID getParentNodeID(Object data) {
<span class="nc" id="L428">			TimeOffActivitySummary summary = (TimeOffActivitySummary) data;</span>
<span class="nc" id="L429">			ActivityCategory category = summary.getActivityCategory();</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">			ID id = category == null ? null : category.getID();</span>
<span class="nc" id="L431">			return new ID(&quot;type&quot; + id);</span>
		}
        
		/**
		 * Returns ActivityName or ActivityCategoryName and other numeric data
		 */
		public DefaultMutableTreeNode toTreeNode(Object data) {
<span class="nc bnc" id="L438" title="All 2 branches missed.">			if (data==null) return null;</span>
<span class="nc" id="L439">			TimeOffActivitySummary summary = (TimeOffActivitySummary) data;</span>

<span class="nc" id="L441">			boolean isFirstLayer = true;</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">			if (summary.getActivityID() != null//This represents an Activity</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">					&amp;&amp; summary.getActivityCategory() != null</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">					&amp;&amp; m_timeoffCatIdSet.contains(summary.getActivityCategory().getID()))</span>
<span class="nc" id="L445">				isFirstLayer = false;</span>

			// Create Node Data
<span class="nc" id="L448">			DefaultMultiColumnNodeData row_data = new DefaultMultiColumnNodeData();</span>
<span class="nc" id="L449">			String name = summary.getActivityName();</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">			if (name == null) {</span>
<span class="nc" id="L451">				ActivityCategory category = summary.getActivityCategory();</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">				name = category == null ? &quot;&quot; : category.getName();</span>
			}
            
            //508: Added style
<span class="nc" id="L456">            row_data.add(HtmlUtil.makeHtmlColorWithBackgroundImgBox(summary.getActivityColor(), null, name) </span>
                    + &quot; &quot; + name, CSSUtil.STYLE_NORMAL_LEFT);
            
			//Story 5861 - Time Summary/My Schedule Summary Time-Off Changes
<span class="nc" id="L460">			boolean isTOSummaryOverrides = isTimeOffSummaryColumnChanged();</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">			if (isTOSummaryOverrides)</span>
			{
				//If current Time-Off Year is selected then this column will display the latest balance that was imported from payroll.
				//show balance up to the last modified date (&quot;Balance&quot; column) instead of the total allocated at the end of the year (&quot;Total&quot; column).
<span class="nc" id="L465">				EmployeeTimeOffAccrued toAccrued = summary.getEmployeeTimeOffAccrued();</span>
<span class="nc bnc" id="L466" title="All 8 branches missed.">				if (isFirstLayer &amp;&amp;  isCurrentYearSelect() &amp;&amp; toAccrued!=null&amp;&amp;toAccrued.getAccruedAtDate()!=null)</span>
<span class="nc" id="L467">					addNumData((float)toAccrued.getAccruedHours(), row_data);</span>
				else
<span class="nc" id="L469">					row_data.add(&quot;&quot;);</span>

				//Date Last Updated: If current Time-Off Year is selected then this column will display the date that the above balance is applicable to.
<span class="nc bnc" id="L472" title="All 8 branches missed.">				if (isFirstLayer &amp;&amp; isCurrentYearSelect() &amp;&amp; toAccrued!=null &amp;&amp;toAccrued.getAccruedAtDate()!=null )</span>
<span class="nc" id="L473">					addDateData(toAccrued.getAccruedAtDate(), row_data);</span>
				else
<span class="nc" id="L475">					row_data.add(&quot;&quot;);</span>
<span class="nc" id="L476">			}</span>
			else
			{
<span class="nc bnc" id="L479" title="All 2 branches missed.">				if (isFirstLayer)</span>
<span class="nc" id="L480">					addNumData(summary.getTotal(), row_data);</span>
				else
<span class="nc" id="L482">					row_data.add(&quot;&quot;);</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">				if (m_hasAccrualLicense) {</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">					if (isFirstLayer)</span>
<span class="nc" id="L485">						addNumData(summary.getCarryOver(), row_data);</span>
					else
<span class="nc" id="L487">						row_data.add(&quot;&quot;);</span>
				}
			}
            
<span class="nc" id="L491">			addNumData(summary.getUsed(), row_data);</span>
<span class="nc" id="L492">			addNumData(summary.getScheduled(), row_data);</span>
<span class="nc" id="L493">			addNumData(summary.getPending(), row_data);</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">			if (isFirstLayer)</span>
<span class="nc" id="L495">				addNumData(summary.getRemaining(), row_data);</span>
			else
<span class="nc" id="L497">				row_data.add(&quot;&quot;);</span>

<span class="nc" id="L499">			return new DefaultMutableTreeNode(row_data);</span>
		}
	}

	private void addNumData(float num, DefaultMultiColumnNodeData row_data) {
<span class="nc" id="L504">		row_data.add( m_localizer.formatNumber(num, 2), CSSUtil.STYLE_NUMERIC );</span>
<span class="nc" id="L505">	}</span>
    
   	private void addDateData(Date date, DefaultMultiColumnNodeData row_data)
	{
<span class="nc" id="L509">		Calendar lastModCal = Calendar.getInstance(m_tz, m_locale);</span>
<span class="nc" id="L510">		lastModCal.setTime(date);</span>
<span class="nc" id="L511">		row_data.add( localize(lastModCal), CSSUtil.STYLE_NUMERIC );</span>
<span class="nc" id="L512">	}</span>

	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L515">		boolean result = super.extractParameters(request);</span>
		//If TO_YEAR_FN is no longer dynamic, this override method is not necessary any more.
<span class="nc" id="L517">		String value = request.getParameter(TO_YEAR_FN);</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">		if (!StringUtil.isEmpty(value))</span>
<span class="nc" id="L519">			this.setTimeOffYear(value);</span>
		
<span class="nc" id="L521">		return result;</span>
	}

	/**
	 * Gets request parameter: Time Off Year.
	 * 0 = Current year, 1 = Next year.
	 */
	public String getTimeOffYear() {
<span class="nc" id="L529">		return m_timeOffYear;</span>
	}

	/**
	 * Sets request parameter: Time Off Year.
	 * 0 = Current year, 1 = Next year.
	 */
	public void setTimeOffYear(String timeOffYear) {
<span class="nc" id="L537">		m_timeOffYear = timeOffYear;</span>
<span class="nc" id="L538">	}</span>

	public void setInputDate(Date date) {
<span class="nc" id="L541">		m_inputDate = date;</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">		if (m_inputDate != null)</span>
<span class="nc" id="L543">			m_timeOffYear = FsKeys.TO_YEAR_CURRENT;</span>
<span class="nc" id="L544">	}</span>

	/**
	 * Return True if Current Year is Selected
	 */
	public boolean isCurrentYearSelect() {
<span class="nc" id="L550">		return FsKeys.TO_YEAR_CURRENT.equals(m_timeOffYear);</span>
	}
	public boolean isPreviousYearSelect(){
<span class="nc" id="L553">		return FsKeys.TO_YEAR_PREVIOUS.equals(m_timeOffYear);</span>
	}
	public boolean isNextYearSelect(){
<span class="nc" id="L556">		return FsKeys.TO_YEAR_NEXT.equals(m_timeOffYear);</span>
	}
	
    /**
	 * Set is agents Page
	 */
	public void setIsAgentPage(boolean isAgentPage) {
<span class="nc" id="L563">		m_isAgentPage = isAgentPage;</span>
<span class="nc" id="L564">	}</span>

	/**
	 * Return is agents Page
	 */
	public boolean getIsAgentPage() {
<span class="nc" id="L570">		return m_isAgentPage;</span>
	}
    
	/**
	 * Get the override for the &quot;Absent&quot; string, which is used in the Schedule view pages and My Schedule Summary component.
	 * If an override exists and the override is not equal CUSTOM_TIME_OFF, then this is also used as an indicator to replace Total and Starting Balance columns with Balance
	 * and Date Last Updated in the Time Off Summary component.
	 * This is for Chase customer request- Story 5861
	 * Value CUSTOM_TIME_OFF is used for France Telecom request- Story 34046 11.1 PSR 6104 - &quot;Absent du Service&quot; vs &quot;Absent&quot;
	 * @return boolean value for the indicator above
	 */
	public static boolean isTimeOffSummaryColumnChanged()
	{
		try
		{
<span class="nc" id="L585">			String strAbsentStringOverride= BbmManagerFactory.getDBConfigManager().getValue(ConfigKey.RM_ABSENT_STRING_OVERRIDE);</span>
<span class="nc bnc" id="L586" title="All 4 branches missed.">			return !StringUtil.isEmpty(strAbsentStringOverride) &amp;&amp; !strAbsentStringOverride.equals(FsWebBundleKey.FS_CUSTOM_TIME_OFF);</span>
		}
<span class="nc" id="L588">		catch(Exception ex)</span>
		{
			//ignoring any exception caught.
		}
<span class="nc" id="L592">		return false;</span>
	}

}//class
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>