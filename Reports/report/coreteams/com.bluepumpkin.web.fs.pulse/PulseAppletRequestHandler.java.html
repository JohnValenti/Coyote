<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PulseAppletRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.pulse</a> &gt; <span class="el_source">PulseAppletRequestHandler.java</span></div><h1>PulseAppletRequestHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.pulse;

import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Set;
import java.util.StringTokenizer;
import java.util.TimeZone;

import com.bluepumpkin.common.base.BPException;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.JdmoDuplicateKeyException;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmTimeSeriesException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingRequest;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingState;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.pulse.model.ExportTraceDescriptor;
import com.bluepumpkin.ejb.bbm.pulse.model.TrackingView;
import com.bluepumpkin.ejb.bbm.pulse.model.TrendingConfig;
import com.bluepumpkin.ejb.bbm.timeseries.model.ActualTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.AggrForecastedTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.AggrRequiredTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.PredictTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.RequireTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ServiceGoalTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceChunk;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceUtil;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.core.CoreEJBCreateException;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.ejb.core.profile.UserProfileKeys;
import com.bluepumpkin.ejb.facade.FacadeEJBCreateException;
import com.bluepumpkin.ejb.facade.FacadeManagerFactory;
import com.bluepumpkin.ejb.facade.corbafacade.ejb.FacadeCorbaFacadeManager;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.campaign.selection.CampaignSchedulingPeriodSelectionUtil;
import com.bluepumpkin.web.bbm.workload.queue.selection.QueueFilterUtil;
import com.bluepumpkin.web.core.applet.AppletIO;
import com.bluepumpkin.web.core.applet.AppletRH;
import com.bluepumpkin.web.core.applet.TextAppletIO;
import com.bluepumpkin.web.core.cache.SelectionCacheUtil;
import com.bluepumpkin.web.core.keys.PageKeys;
import com.bluepumpkin.web.fs.Log;
import com.bluepumpkin.web.fs.keys.FsKeys;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.pulse.keys.PulseKeys;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.ejb.core.security.UserManager;
import com.witness.web.core.keys.Caching;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.l10n.VerticalizationWebBundleKey;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.cache.UserCacheManager;
import com.witness.web.uif.system.manager.VerticalizationManager;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.CacheUtil;
import com.witness.web.uif.util.KeyDisplayPair;
import com.witness.web.uif.util.RangeValuePair;

/**
 * Title: PulseAppletRequestHandler Description: Handle applet requests from the
 * pulse tab. Copyright: Copyright (c) 2004 Company: Blue Pumpkin Software, Inc
 * 
 * @author Swati Tewari
 * @version 1.0
 */

<span class="nc" id="L90">public class PulseAppletRequestHandler extends AppletRH {</span>

<span class="fc" id="L92">	private static final Category cat = Log.initCategory(PulseAppletRequestHandler.class.getName());</span>

	// Pulse view types
	private static final int PULSE_VIEW = 0;
	private static final int HISTORY_VIEW = 1;

<span class="nc" id="L98">	private CampaignManager m_campaignManager = null;</span>
<span class="nc" id="L99">	protected FacadeCorbaFacadeManager m_facadeCorbaFacadeManager = null;</span>
<span class="nc" id="L100">	private UserManager m_userManager = null;</span>

	/**
	 * Overrides the base class to fetch the initial user preferences variables
	 * that the Pulse applet needs.
	 */
	protected Map getInitUserProperties(RequestContext context) {
		// System.out.println(&quot;\n\nPulseAppletRequestHandler.getInitUserProperties()...\n&quot;);
<span class="nc" id="L108">		ArrayList properties = new ArrayList(7);</span>

<span class="nc" id="L110">		properties.add(QueueFilterUtil.QUEUE_FILTER_CAMP_START_DATE);</span>
<span class="nc" id="L111">		properties.add(QueueFilterUtil.QUEUE_FILTER_CAMP_END_DATE);</span>
<span class="nc" id="L112">		properties.add(UserProfileKeys.PULSE_SHOW_SUMMARY_TABLE);</span>
<span class="nc" id="L113">		properties.add(UserProfileKeys.PULSE_SHOW_DATA_TABLE);</span>
<span class="nc" id="L114">		properties.add(UserProfileKeys.PULSE_SHOW_COMBINED_QUEUE);</span>
<span class="nc" id="L115">		properties.add(UserProfileKeys.PULSE_SHOW_CAMPAIGN_TIMEZONE);</span>
<span class="nc" id="L116">		properties.add(UserProfileKeys.PULSE_VIEW_ID);</span>
<span class="nc" id="L117">		properties.add(UserProfileKeys.PULSE_ZOOM_LEVEL);</span>
<span class="nc" id="L118">		properties.add(UserPreferenceKeys.USER_PULSE_AUTO_REFRESH);</span>
<span class="nc" id="L119">		properties.add(UserProfileKeys.PULSE_DATA_TABLE_DIVIDER_LOCATION);</span>
<span class="nc" id="L120">		properties.add(UserProfileKeys.PULSE_SHOW_DATE_RANGE_PICKER);</span>
<span class="nc" id="L121">		properties.add(UserProfileKeys.USER_ACCESSIBILITY_COMPLIANCE_MODE);// Added</span>
																			// for
																			// QA98797
		// properties.add(UserProfileKeys.PULSE_SELECTED_DATE_PICKER_RANGE);

<span class="nc" id="L126">		Map map = new HashMap(2);</span>
<span class="nc" id="L127">		map.put(PageKeys.PROPERTY_KEYS_COLLECTION, properties);</span>
<span class="nc" id="L128">		Map resultMap = getUserProperties(context, map);</span>

		try {
<span class="nc" id="L131">			ID spID = QueueFilterUtil.retrieveSchedulingPeriodID(context);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">			if (spID != null) {</span>
<span class="nc" id="L133">				SchedulingPeriod sp = CampaignModelHandler.getSchedPeriod(context, spID);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">				if (sp != null) {</span>
<span class="nc" id="L135">					QueueFilterUtil.storeTimePeriodStart(context, sp.getStartTime());</span>
<span class="nc" id="L136">					QueueFilterUtil.storeTimePeriodEnd(context, sp.getEndTime());</span>
<span class="nc" id="L137">					resultMap.put(QueueFilterUtil.QUEUE_FILTER_CAMP_START_DATE, &quot;&quot; + sp.getStartTime().getTime());</span>
<span class="nc" id="L138">					resultMap.put(QueueFilterUtil.QUEUE_FILTER_CAMP_END_DATE, &quot;&quot; + sp.getEndTime().getTime());</span>
				}
			}
<span class="nc" id="L141">		} catch (Exception ex) {</span>
			// do nothing
<span class="nc" id="L143">		}</span>

<span class="nc" id="L145">		ID campID = QueueFilterUtil.retrieveCampaignID(context);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">		resultMap.put(&quot;FS_CAMPAIGN_ID&quot;, campID == null ? null : campID.toString());</span>

		// override stored zoom level, dayOffset, and weekOffset if coming from
		// DE
<span class="nc" id="L150">		String deZoom = (String) context.getAttribute(RequestContext.ONE_TIME_USE_SESSION_SCOPE,</span>
				QueueFilterUtil.PULSE_ZOOM);
<span class="nc bnc" id="L152" title="All 2 branches missed.">		if (deZoom != null) {</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">			if (deZoom.equals(&quot;day&quot;))</span>
<span class="nc" id="L154">				resultMap.put(UserProfileKeys.PULSE_ZOOM_LEVEL, &quot;0&quot;);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">			else if (deZoom.equals(&quot;week&quot;))</span>
<span class="nc" id="L156">				resultMap.put(UserProfileKeys.PULSE_ZOOM_LEVEL, &quot;1&quot;);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">			else if (deZoom.equals(&quot;period&quot;))</span>
<span class="nc" id="L158">				resultMap.put(UserProfileKeys.PULSE_ZOOM_LEVEL, &quot;2&quot;);</span>

			// Special case: in Org mode, DE has week zoom but pulse has period
			// zoom.
<span class="nc bnc" id="L162" title="All 4 branches missed.">			if (campID == null &amp;&amp; deZoom.equals(&quot;week&quot;))</span>
<span class="nc" id="L163">				resultMap.put(UserProfileKeys.PULSE_ZOOM_LEVEL, &quot;2&quot;);</span>
		}

<span class="nc" id="L166">		Integer dayOffset = (Integer) context.getAttribute(RequestContext.ONE_TIME_USE_SESSION_SCOPE,</span>
				QueueFilterUtil.PULSE_DAY_OFFSET);
<span class="nc bnc" id="L168" title="All 2 branches missed.">		if (dayOffset != null)</span>
<span class="nc" id="L169">			resultMap.put(QueueFilterUtil.PULSE_DAY_OFFSET, dayOffset.toString());</span>

<span class="nc" id="L171">		Integer weekOffset = (Integer) context.getAttribute(RequestContext.ONE_TIME_USE_SESSION_SCOPE,</span>
				QueueFilterUtil.PULSE_WEEK_OFFSET);
<span class="nc bnc" id="L173" title="All 2 branches missed.">		if (weekOffset != null)</span>
<span class="nc" id="L174">			resultMap.put(QueueFilterUtil.PULSE_WEEK_OFFSET, weekOffset.toString());</span>

<span class="nc" id="L176">		return resultMap;</span>
	}

	/**
	 * Process Applet Request - to be overrided by derived classes
	 * 
	 * @param context
	 *            - The Request Context
	 * @param appletRequest
	 *            - Map containing Applet Request Information
	 * @param appletResponse
	 *            - Map containing Response to be send to Applet
	 */
	protected void processAppletRequest(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc bnc" id="L190" title="All 2 branches missed.">		if (!pushRequest(context, appletRequest)) {</span>
<span class="nc" id="L191">			appletResponse.put(PageKeys.APPLET_ERROR, ERROR_RESPONSE_CODE);</span>
<span class="nc" id="L192">			return;</span>
		}

<span class="nc" id="L195">		Locale locale = context.getLocaleContext().getLanguageLocale();</span>

		try {
<span class="nc bnc" id="L198" title="All 2 branches missed.">			if (isAppletAction(appletRequest, PageAction.APPLET_INIT)) {</span>
<span class="nc" id="L199">				Collection commands = (Collection) appletRequest.get(PageKeys.APPLET_COMMANDS);</span>
<span class="nc" id="L200">				HashMap mapProperties = new HashMap(commands.size() * 2);</span>
<span class="nc" id="L201">				HashMap views = null;</span>
<span class="nc" id="L202">				Map userProps = null;</span>

<span class="nc bnc" id="L204" title="All 2 branches missed.">				for (Iterator iter = commands.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L205">					String command = (String) iter.next();</span>

<span class="nc" id="L207">					Object obj = null;</span>

					// Common applet init info
<span class="nc bnc" id="L210" title="All 2 branches missed.">					if (command.equals(GET_LOCALE_CONTEXT)) {</span>
<span class="nc" id="L211">						obj = context.getLocaleContext();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">					} else if (command.equals(PageAction.GET_USER_PRIVELEGES)) {</span>
<span class="nc" id="L213">						obj = getUser(context);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">					} else if (command.equals(PageAction.GET_USER_PROPERTIES)) {</span>
<span class="nc" id="L215">						obj = userProps = getInitUserProperties(context);</span>
					}

					// Pulse-specific applet init info
<span class="nc bnc" id="L219" title="All 2 branches missed.">					else if (command.equals(PulseKeys.CHECK_OUTBOUND_LICENSE)) {</span>
<span class="nc" id="L220">						obj = checkOutboundLicense(context, appletRequest, appletResponse, false);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">					} else if (command.equals(PulseKeys.CHECK_PULSE_NOTES_EXCLUDE_IN_FORECAST_LICENSE)) {</span>
<span class="nc" id="L222">						obj = checkPulseNotesExcludeInForecastLicense(context, appletRequest, appletResponse, false);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">					} else if (command.equals(PulseKeys.CHECK_CAN_LAUNCH_FS)) {</span>
<span class="nc" id="L224">						obj = checkCanLaunchFS(context, appletRequest, appletResponse, false);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">					} else if (command.equals(PulseKeys.GET_USER_VIEWS)) {</span>
<span class="nc" id="L226">						obj = views = getUserViews(context, appletRequest, appletResponse, false);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">					} else if (command.equals(PulseKeys.GET_VERTICALIZED_STRINGS)) {</span>
<span class="nc" id="L228">						obj = getVerticalizedStrings(context, appletRequest, appletResponse, false);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">					} else if (command.equals(PulseKeys.CHECK_PULSE_DEFAULT_SELECT_NO_QUEUE)) {</span>
<span class="nc" id="L230">						obj = isPulseSelectionNoDefault(context, appletRequest, appletResponse, false);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">					} else if (command.equals(PulseKeys.CHECK_ENABLE_ADJUSTED_STAFFING_FROM_PULSE)) {</span>
<span class="nc" id="L232">						obj = isEnableAdjustedStaffingFromPulse(context, appletRequest, appletResponse, false);</span>
					}

<span class="nc bnc" id="L235" title="All 2 branches missed.">					if (obj != null)</span>
<span class="nc" id="L236">						mapProperties.put(command + PageKeys.APPLET_RESPONSE, obj);</span>
<span class="nc" id="L237">				}</span>

				// Separate loop required to process GET_VIEW after
				// GET_USER_VIEWS, GET_USER_PROPERTIES
<span class="nc bnc" id="L241" title="All 2 branches missed.">				for (Iterator iter = commands.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L242">					String command = (String) iter.next();</span>
<span class="nc" id="L243">					Object obj = null;</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">					if (command.equals(PulseKeys.GET_VIEW)) {</span>
<span class="nc" id="L246">						int pulseViewType = ((Integer) appletRequest.get(PulseKeys.TRACKING_VIEW)).intValue();</span>
<span class="nc" id="L247">						ID viewID = getViewID(userProps, views, pulseViewType);</span>
<span class="nc" id="L248">						obj = getView(context, appletRequest, appletResponse, viewID, false);</span>
					}

<span class="nc bnc" id="L251" title="All 2 branches missed.">					if (obj != null)</span>
<span class="nc" id="L252">						mapProperties.put(command + PageKeys.APPLET_RESPONSE, obj);</span>
<span class="nc" id="L253">				}</span>

<span class="nc" id="L255">				addResponseData(mapProperties, appletResponse);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_TRACE_DATA)) {</span>
<span class="nc" id="L257">				getTraceData(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_USER_VIEWS)) {</span>
<span class="nc" id="L259">				getUserViews(context, appletRequest, appletResponse, true);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_INVISIBLE_VIEWS)) {</span>
<span class="nc" id="L261">				getInvisibleViewNames(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_VIEW)) {</span>
<span class="nc" id="L263">				getView(context, appletRequest, appletResponse, null, true);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.CREATE_VIEW)) {</span>
<span class="nc" id="L265">				createView(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.EDIT_VIEW)) {</span>
<span class="nc" id="L267">				editView(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.DELETE_VIEW)) {</span>
<span class="nc" id="L269">				deleteView(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_TREND_CONFIG)) {</span>
<span class="nc" id="L271">				getTrendConfig(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_TREND_CONFIG)) {</span>
<span class="nc" id="L273">				saveTrendConfig(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.REFORECAST)) {</span>
<span class="nc" id="L275">				reForecast(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.CACHE_IDS_FOR_REFORECAST)) {</span>
<span class="nc" id="L277">				cacheIdsForReForecast(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_HISTORY)) {</span>
<span class="nc" id="L279">				saveHistory(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_CAMPAIGN_SPS)) {</span>
<span class="nc" id="L281">				getSchedulingPeriods(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_ALL_QUEUES)) {</span>
<span class="nc" id="L283">				getAllQueues(context, appletResponse, true);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_SCOPED_QUEUES)) {</span>
<span class="nc" id="L285">				getScopedQueues(context, appletResponse, true);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_EDITABLE_QUEUES)) {// QA100924</span>
<span class="nc" id="L287">				getEditableQueues(context, appletResponse, true);</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_QUEUES_BY_CAMPAIGN_MEDIA)) {</span>
<span class="nc" id="L289">				getQueuesAttachedToCampaignMedia(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_AVAILABLE_QUEUES)) {</span>
<span class="nc" id="L291">				getAvailableQueues(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_CHUNKY_HISTORY)) {</span>
<span class="nc" id="L293">				saveChunkyHistory(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_CUBE_MAPS)) {</span>
<span class="nc" id="L295">				getCubeMaps(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.CHECK_PULSE_NOTES_EXCLUDE_IN_FORECAST_LICENSE)) {</span>
<span class="nc" id="L297">				checkPulseNotesExcludeInForecastLicense(context, appletRequest, appletResponse, true);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_PULSE_NOTES)) {</span>
<span class="nc" id="L299">				getPulseNotes(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_PULSE_NOTES)) {</span>
<span class="nc" id="L301">				savePulseNotes(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.ADD_PULSE_NOTES)) {</span>
<span class="nc" id="L303">				addPulseNotes(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.UPDATE_PULSE_NOTES)) {</span>
<span class="nc" id="L305">				updatePulseNotes(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.DELETE_PULSE_NOTES)) {</span>
<span class="nc" id="L307">				deletePulseNotes(context, appletRequest, appletResponse);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.CHECK_OUTBOUND_LICENSE)) {</span>
<span class="nc" id="L309">				checkOutboundLicense(context, appletRequest, appletResponse, true);</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, FsKeys.CLEAR_SCHEDULE_STATE)) {</span>
				// msgID =
				// FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;
<span class="nc" id="L313">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L314">				String modeChar = (String) appletRequest.get(FsKeys.MODE_CHAR);</span>
<span class="nc" id="L315">				getCampaignManager(context, appletResponse, locale).clearSchedulingState(spID, modeChar);</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_START_RECALC)) {</span>
				// msgID =
				// FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REQUESTING_RECALC;
<span class="nc" id="L319">				ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L320">				Boolean isEnableLQF = (Boolean) appletRequest.get(FsKeys.IS_ENABLE_LQF);</span>
<span class="nc" id="L321">				Boolean isRecalcSubCampaign = (Boolean) appletRequest.get(FsKeys.IS_RECALC_SUB_CAMPAIGNS);</span>

				// recalcscheduling error code : 1 - success, 2 - adapter error
				// , 4 - no adapter configured
<span class="nc" id="L325">				int errorCode = getFacadeCorbaFacadeManager(appletResponse, locale).recalcScheduling(</span>
<span class="nc" id="L326">						UserCacheManager.getInstance().getCachedUserName(context),</span>
<span class="nc" id="L327">						getUserManager(context, appletResponse, locale).generateToken(</span>
<span class="nc" id="L328">								UserCacheManager.getInstance().getCachedUserSeal(context)), context.isInWhatIfMode(),</span>
<span class="nc" id="L329">						1, spID, isEnableLQF, isRecalcSubCampaign, null);</span>
<span class="nc" id="L330">				appletResponse.put(PageKeys.CALENDAR_APPLET_GET_RECALC_SCHEDULING_ERROR_CODE, new Integer(errorCode));</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.APPLET_GET_DATA)) {</span>
<span class="nc" id="L332">				String typeData = (String) appletRequest.get(PageKeys.GET_TYPE);</span>

<span class="nc bnc" id="L334" title="All 2 branches missed.">				if (PageKeys.GET_SCHEDULING_STATE.equals(typeData)) {</span>
					// msgID =
					// FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;
<span class="nc" id="L337">					ID spID = (ID) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULINGPERIOD_ID);</span>
<span class="nc" id="L338">					String modeChar = (String) appletRequest.get(FsKeys.MODE_CHAR);</span>
<span class="nc" id="L339">					SchedulingState state = getCampaignManager(context, appletResponse, locale).getSchedulingState(</span>
							spID, modeChar);
<span class="nc" id="L341">					addResponseData(state, appletResponse);</span>
				}
<span class="nc bnc" id="L343" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PageAction.ACTION_SEND_SCHEDULE_REQUEST)) {</span>
				// msgID =
				// FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_REQUESTING_SCHEDULE;
<span class="nc" id="L346">				SchedulingRequest request = (SchedulingRequest) appletRequest.get(PageKeys.CAMPAIGN_SCHEDULING_REQUEST);</span>
<span class="nc" id="L347">				getCampaignManager(context, appletResponse, locale).makeSchedulingRequest(request);</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PageKeys.DELETE_SCHEDULE_WARNINGS)) {</span>
				// msgID =
				// FsWebBundleKey.FS_CAL_REQHNDLR_EXCEPTION_GETTING_SCHEDULINGSTATE;
<span class="nc" id="L351">				Collection warningIDs = (Collection) appletRequest.get(PageKeys.SCHEDULEWARNING_IDS);</span>
<span class="nc" id="L352">				getCampaignManager(context, appletResponse, locale).clearSchedulingStateWarnings(warningIDs);</span>
<span class="nc" id="L353">			} else {</span>
<span class="nc" id="L354">				super.processAppletRequest(context, appletRequest, appletResponse);</span>
			}
<span class="nc" id="L356">		} catch (Exception ex) {</span>
<span class="nc" id="L357">			notifyError(context, appletResponse, ex);</span>
		} finally {
<span class="nc" id="L359">			super.popRequest(context, appletRequest);</span>
<span class="nc" id="L360">		}</span>

<span class="nc" id="L362">	}</span>

	/**
	 * Get the ID of the Pulse tracking view to be displayed.
	 * 
	 * @param userProps
	 *            Contains the last viewID selected (if any.
	 * @param userViews
	 *            A Collection of all view ID's available for the user.
	 * @param pulseViewType
	 *            One of: PULSE_VIEW, HISTORY_VIEW.
	 * @return the ID of the Pulse tracking view to be displayed.
	 */
	private ID getViewID(Map userProps, HashMap userViews, int pulseViewType) {
<span class="nc" id="L376">		ID viewID = TrackingView.INVALID_VIEW_ID;</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">		String viewIDStr = (userProps == null) ? null : (String) userProps.get(UserProfileKeys.PULSE_VIEW_ID);</span>

<span class="nc bnc" id="L379" title="All 2 branches missed.">		if (pulseViewType == PULSE_VIEW) {</span>
<span class="nc bnc" id="L380" title="All 4 branches missed.">			if ((viewIDStr == null) &amp;&amp; (userViews != null)) {</span>
<span class="nc" id="L381">				Collection pubViewPairs = (Collection) userViews.get(PulseKeys.VIEWS_PUBLIC);</span>
<span class="nc" id="L382">				Collection pubROViewPairs = (Collection) userViews.get(PulseKeys.VIEWS_PUBLIC_RO);</span>
<span class="nc" id="L383">				Collection privateViewPairs = (Collection) userViews.get(PulseKeys.VIEWS_PRIVATE);</span>

<span class="nc bnc" id="L385" title="All 4 branches missed.">				if ((pubViewPairs != null) &amp;&amp; (pubViewPairs.size() &gt; 0)) {</span>
<span class="nc" id="L386">					viewID = (ID) ((KeyDisplayPair) ((ArrayList) pubViewPairs).get(0)).getKey();</span>
<span class="nc bnc" id="L387" title="All 4 branches missed.">				} else if ((pubROViewPairs != null) &amp;&amp; (pubROViewPairs.size() &gt; 0)) {</span>
<span class="nc" id="L388">					viewID = (ID) ((KeyDisplayPair) ((ArrayList) pubROViewPairs).get(0)).getKey();</span>
<span class="nc bnc" id="L389" title="All 4 branches missed.">				} else if ((privateViewPairs != null) &amp;&amp; (privateViewPairs.size() &gt; 0)) {</span>
<span class="nc" id="L390">					viewID = (ID) ((KeyDisplayPair) ((ArrayList) privateViewPairs).get(0)).getKey();</span>
				}
<span class="nc" id="L392">			} else {</span>
<span class="nc" id="L393">				viewID = new ID(viewIDStr);</span>
			}
		}
<span class="nc" id="L396">		return viewID;</span>
	}

	/** Convert Methods **/

	/**
	 * Because this request handler also handles client requests sent as clear
	 * text. We need to convert text parameters into JAVA objects.
	 */
	protected void convertToDefaultIO(Map appletRequest, AppletIO io) {
<span class="nc bnc" id="L406" title="All 2 branches missed.">		if (io.equals(TextAppletIO.getInstance())) {</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">			if (isAppletAction(appletRequest, PulseKeys.GET_TRACE_DATA)) {</span>
				// get text from request
<span class="nc" id="L409">				String campId = (String) appletRequest.get(PulseKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L410">				String mediaId = (String) appletRequest.get(PulseKeys.MEDIA_ID);</span>
<span class="nc" id="L411">				String queueIds = (String) appletRequest.get(PulseKeys.QUEUE_IDS);</span>
<span class="nc" id="L412">				String viewId = (String) appletRequest.get(PulseKeys.VIEW_ID);</span>
<span class="nc" id="L413">				String startDate = (String) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L414">				String endDate = (String) appletRequest.get(PulseKeys.END_DATE);</span>
<span class="nc" id="L415">				String dataShouldBeEmpty = (String) appletRequest.get(PulseKeys.EMPTY_DATA);</span>
<span class="nc" id="L416">				String autoRefresh = (String) appletRequest.get(&quot;AUTO_REFRSH_REQ&quot;);</span>
				// put obj back in request
<span class="nc" id="L418">				appletRequest.put(PulseKeys.CAMPAIGN_ID, convertToID(campId));</span>
<span class="nc" id="L419">				appletRequest.put(PulseKeys.MEDIA_ID, convertToID(mediaId));</span>
<span class="nc" id="L420">				appletRequest.put(PulseKeys.QUEUE_IDS, convertToIDs(TextAppletIO.convertToCollection(queueIds)));</span>
<span class="nc" id="L421">				appletRequest.put(PulseKeys.VIEW_ID, convertToID(viewId));</span>
<span class="nc" id="L422">				appletRequest.put(PulseKeys.START_DATE, TextAppletIO.convertToDate(startDate));</span>
<span class="nc" id="L423">				appletRequest.put(PulseKeys.END_DATE, TextAppletIO.convertToDate(endDate));</span>
<span class="nc" id="L424">				appletRequest.put(PulseKeys.EMPTY_DATA, TextAppletIO.convertToBoolean(dataShouldBeEmpty));</span>
<span class="nc" id="L425">				appletRequest.put(&quot;AUTO_REFRSH_REQ&quot;, TextAppletIO.convertToBoolean(autoRefresh));</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_CUBE_MAPS)) {</span>
				// get text from request
<span class="nc" id="L428">				String campId = (String) appletRequest.get(PulseKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L429">				String mediaId = (String) appletRequest.get(PulseKeys.MEDIA_ID);</span>
<span class="nc" id="L430">				String queueIds = (String) appletRequest.get(PulseKeys.QUEUE_IDS);</span>
<span class="nc" id="L431">				String viewId = (String) appletRequest.get(PulseKeys.VIEW_ID);</span>
<span class="nc" id="L432">				String startDate = (String) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L433">				String endDate = (String) appletRequest.get(PulseKeys.END_DATE);</span>

				// put obj back in request
<span class="nc" id="L436">				appletRequest.put(PulseKeys.CAMPAIGN_ID, convertToID(campId));</span>
<span class="nc" id="L437">				appletRequest.put(PulseKeys.MEDIA_ID, convertToID(mediaId));</span>
<span class="nc" id="L438">				appletRequest.put(PulseKeys.QUEUE_IDS, convertToIDs(TextAppletIO.convertToCollection(queueIds)));</span>
<span class="nc" id="L439">				appletRequest.put(PulseKeys.VIEW_ID, convertToID(viewId));</span>
<span class="nc" id="L440">				appletRequest.put(PulseKeys.START_DATE, TextAppletIO.convertToDate(startDate));</span>
<span class="nc" id="L441">				appletRequest.put(PulseKeys.END_DATE, TextAppletIO.convertToDate(endDate));</span>

<span class="nc bnc" id="L443" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_USER_VIEWS)) {</span>
				// no params - do nothing
<span class="nc bnc" id="L445" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_INVISIBLE_VIEWS)) {</span>
				// no params - do nothing
<span class="nc bnc" id="L447" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.CREATE_VIEW)) {</span>
				// get text from request
<span class="nc" id="L449">				String view = (String) appletRequest.get(PulseKeys.TRACKING_VIEW);</span>
				// put obj back in request
<span class="nc" id="L451">				appletRequest.put(PulseKeys.TRACKING_VIEW, convertToTrackingView(TextAppletIO.convertToHashMap(view)));</span>

<span class="nc bnc" id="L453" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.EDIT_VIEW)) {</span>
				// get text from request
<span class="nc" id="L455">				String view = (String) appletRequest.get(PulseKeys.TRACKING_VIEW);</span>
				// put obj back in request
<span class="nc" id="L457">				appletRequest.put(PulseKeys.TRACKING_VIEW, convertToTrackingView(TextAppletIO.convertToHashMap(view)));</span>

<span class="nc bnc" id="L459" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.DELETE_VIEW)) {</span>
				// get text from request
<span class="nc" id="L461">				String id = (String) appletRequest.get(PulseKeys.VIEW_ID);</span>
				// put obj back in request
<span class="nc" id="L463">				appletRequest.put(PulseKeys.VIEW_ID, convertToID(id));</span>

<span class="nc bnc" id="L465" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_TREND_CONFIG)) {</span>
				// get text from request
<span class="nc" id="L467">				String spId = (String) appletRequest.get(PulseKeys.SP_ID);</span>
				// put obj back in request
<span class="nc" id="L469">				appletRequest.put(PulseKeys.SP_ID, convertToID(spId));</span>

<span class="nc bnc" id="L471" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_TREND_CONFIG)) {</span>
				// get text from request
<span class="nc" id="L473">				String trendConfig = (String) appletRequest.get(PulseKeys.TREND_CONFIG);</span>

				// put obj back in request
<span class="nc" id="L476">				appletRequest.put(PulseKeys.TREND_CONFIG,</span>
<span class="nc" id="L477">						convertToTrendingConfig(TextAppletIO.convertToHashMap(trendConfig)));</span>

<span class="nc bnc" id="L479" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.REFORECAST)) {</span>
				// get text from request
				// no need to get desc - already converted
<span class="nc" id="L482">				String cubeMaps = (String) appletRequest.get(PulseKeys.CUBE_MAPS);</span>
<span class="nc" id="L483">				String spId = (String) appletRequest.get(PulseKeys.SP_ID);</span>

				// put obj back in request
<span class="nc" id="L486">				appletRequest.put(PulseKeys.CUBE_MAPS, convertToTraceCubeMap(cubeMaps, true));</span>
<span class="nc" id="L487">				appletRequest.put(PulseKeys.SP_ID, convertToID(spId));</span>

<span class="nc bnc" id="L489" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_HISTORY)) {</span>
				// get text from request
<span class="nc" id="L491">				String cubeMaps = (String) appletRequest.get(PulseKeys.CUBE_MAPS);</span>
				// put obj back in request
<span class="nc" id="L493">				appletRequest.put(PulseKeys.CUBE_MAPS, convertToTraceCubeMap(cubeMaps, false));</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_CAMPAIGN_SPS)) {</span>
				// get text from request
<span class="nc" id="L496">				String campId = (String) appletRequest.get(PulseKeys.CAMPAIGN_ID);</span>
				// put obj back in request
<span class="nc" id="L498">				appletRequest.put(PulseKeys.CAMPAIGN_ID, convertToID(campId));</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.GET_AVAILABLE_QUEUES)) {</span>
				// get text from request
<span class="nc" id="L501">				String campId = (String) appletRequest.get(PulseKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L502">				String startDate = (String) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L503">				String endDate = (String) appletRequest.get(PulseKeys.END_DATE);</span>
				// put obj back in request
<span class="nc" id="L505">				appletRequest.put(PulseKeys.CAMPAIGN_ID, convertToID(campId));</span>
<span class="nc" id="L506">				appletRequest.put(PulseKeys.START_DATE, TextAppletIO.convertToDate(startDate));</span>
<span class="nc" id="L507">				appletRequest.put(PulseKeys.END_DATE, TextAppletIO.convertToDate(endDate));</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">			} else if (isAppletAction(appletRequest, PulseKeys.SAVE_CHUNKY_HISTORY)) {</span>
				// get text from request
<span class="nc" id="L510">				String traceChunks = (String) appletRequest.get(PulseKeys.TRACE_CHUNKS);</span>

				// put obj back in request
				// TextAppletIO.convertToCollection() converts a String into a
				// Collection of strings
				// convertToTraceChunks() converts a Collection of strings into
				// Collection of TraceChunk's
<span class="nc" id="L517">				appletRequest.put(PulseKeys.TRACE_CHUNKS,</span>
<span class="nc" id="L518">						convertToTraceChunks(TextAppletIO.convertToCollection(traceChunks)));</span>
<span class="nc" id="L519">			} else {</span>
<span class="nc" id="L520">				super.convertToDefaultIO(appletRequest, io);</span>
			}
		} else {
<span class="nc" id="L523">			super.convertToDefaultIO(appletRequest, io);</span>
		}
<span class="nc" id="L525">	}</span>

	private ID convertToID(String id) {
<span class="nc bnc" id="L528" title="All 4 branches missed.">		if (id == null || id.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L529">			return null;</span>
		else
<span class="nc" id="L531">			return new ID(id);</span>
	}

	private Collection convertToIDs(Collection c) {
<span class="nc" id="L535">		Collection ret = new ArrayList(c.size());</span>

<span class="nc bnc" id="L537" title="All 2 branches missed.">		for (Iterator iter = c.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L538">			String item = (String) iter.next();</span>
<span class="nc" id="L539">			ret.add(convertToID((item)));</span>
<span class="nc" id="L540">		}</span>
<span class="nc" id="L541">		return ret;</span>
	}

	private TrackingView convertToTrackingView(HashMap view) {
<span class="nc bnc" id="L545" title="All 2 branches missed.">		if (view != null) {</span>
			// id
<span class="nc" id="L547">			String id_txt = (String) view.get(PulseKeys.VIEW_ID);</span>
<span class="nc" id="L548">			ID id = convertToID(id_txt);</span>

			// userId
<span class="nc" id="L551">			String userId_txt = (String) view.get(PulseKeys.VIEW_USERID);</span>
<span class="nc" id="L552">			ID userId = convertToID(userId_txt);</span>

			// empId
<span class="nc" id="L555">			String empId_txt = (String) view.get(PulseKeys.VIEW_EMPID);</span>
<span class="nc" id="L556">			ID empId = convertToID(empId_txt);</span>

			// view name
<span class="nc" id="L559">			String viewName = (String) view.get(PulseKeys.VIEW_NAME);</span>

			// description
<span class="nc" id="L562">			String desc = (String) view.get(PulseKeys.VIEW_DESC);</span>

			// trending
<span class="nc" id="L565">			String trend_txt = (String) view.get(PulseKeys.VIEW_TREND);</span>
<span class="nc" id="L566">			boolean trend = TextAppletIO.convertToBoolean(trend_txt).booleanValue();</span>

			// hoo
<span class="nc" id="L569">			String hoo_txt = (String) view.get(PulseKeys.VIEW_HOO);</span>
<span class="nc" id="L570">			boolean hoo = TextAppletIO.convertToBoolean(hoo_txt).booleanValue();</span>

			// global
<span class="nc" id="L573">			String global_txt = (String) view.get(PulseKeys.VIEW_TREND);</span>
<span class="nc" id="L574">			boolean global = TextAppletIO.convertToBoolean(global_txt).booleanValue();</span>

			// deviation view
<span class="nc" id="L577">			String dview_txt = (String) view.get(PulseKeys.VIEW_DEV);</span>
<span class="nc" id="L578">			boolean dview = TextAppletIO.convertToBoolean(dview_txt).booleanValue();</span>

			// chart def
<span class="nc" id="L581">			String chartDef_txt = (String) view.get(PulseKeys.VIEW_CHARTDEF);</span>
<span class="nc" id="L582">			List chartDef = (List) TextAppletIO.convertToCollection(chartDef_txt);</span>

<span class="nc" id="L584">			TrackingView tview = new TrackingView();</span>
<span class="nc" id="L585">			tview.setID(id);</span>
<span class="nc" id="L586">			tview.setUserID(userId);</span>
<span class="nc" id="L587">			tview.setEmployeeID(empId);</span>
<span class="nc" id="L588">			tview.setViewName(viewName);</span>
<span class="nc" id="L589">			tview.setDescription(desc);</span>
<span class="nc" id="L590">			tview.setTrending(trend);</span>
<span class="nc" id="L591">			tview.setHOO(hoo);</span>
<span class="nc" id="L592">			tview.setGlobalView(global);</span>
<span class="nc" id="L593">			tview.setDeviationView(dview);</span>
<span class="nc" id="L594">			tview.setChartDefinition(chartDef);</span>

		}
<span class="nc" id="L597">		return null;</span>
	}

	private Date[] convertToDateArray(String datearray) {
<span class="nc bnc" id="L601" title="All 2 branches missed.">		if (datearray.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L602">			return new Date[0];</span>
		else {
<span class="nc" id="L604">			StringTokenizer st = new StringTokenizer(datearray, PulseKeys.NEXT_COL);</span>
<span class="nc" id="L605">			ArrayList c = new ArrayList(st.countTokens());</span>

<span class="nc bnc" id="L607" title="All 2 branches missed.">			while (st.hasMoreTokens()) {</span>
<span class="nc" id="L608">				String token = st.nextToken();</span>
<span class="nc" id="L609">				c.add(TextAppletIO.convertToDate(token));</span>
<span class="nc" id="L610">			}</span>

<span class="nc" id="L612">			Date[] ret = new Date[c.size()];</span>
<span class="nc" id="L613">			ret = (Date[]) c.toArray(ret);</span>
<span class="nc" id="L614">			return ret;</span>
		}
	}

	private Date[][] convertToDateDoubleArray(String dateDoubleArray) {
<span class="nc bnc" id="L619" title="All 2 branches missed.">		if (dateDoubleArray.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L620">			return new Date[0][0];</span>
		else {
<span class="nc" id="L622">			StringTokenizer st = new StringTokenizer(dateDoubleArray, PulseKeys.NEXT_ROW);</span>
<span class="nc" id="L623">			ArrayList c = new ArrayList(st.countTokens());</span>

<span class="nc bnc" id="L625" title="All 2 branches missed.">			while (st.hasMoreTokens()) {</span>
<span class="nc" id="L626">				String token = st.nextToken();</span>
<span class="nc" id="L627">				c.add(convertToDateArray(token));</span>
<span class="nc" id="L628">			}</span>

<span class="nc" id="L630">			Date[][] ret = new Date[c.size()][];</span>
<span class="nc" id="L631">			ret = (Date[][]) c.toArray(ret);</span>
<span class="nc" id="L632">			return ret;</span>
		}
	}

	private TrendingConfig convertToTrendingConfig(HashMap config) {
<span class="nc bnc" id="L637" title="All 2 branches missed.">		if (config != null) {</span>
			// id
<span class="nc" id="L639">			String id_txt = (String) config.get(PulseKeys.TREND_CONFIG_ID);</span>
<span class="nc" id="L640">			ID id = convertToID(id_txt);</span>

			// userId
<span class="nc" id="L643">			String userId_txt = (String) config.get(PulseKeys.TREND_CONFIG_USERID);</span>
<span class="nc" id="L644">			ID userId = convertToID(userId_txt);</span>

			// empId
<span class="nc" id="L647">			String spId_txt = (String) config.get(PulseKeys.TREND_CONFIG_SPID);</span>
<span class="nc" id="L648">			ID spId = convertToID(spId_txt);</span>

			// trending rate
<span class="nc" id="L651">			String rate_txt = (String) config.get(PulseKeys.TREND_CONFIG_TRENDING_RATE);</span>
<span class="nc" id="L652">			short rate = ((Integer) TextAppletIO.convertToInteger(rate_txt)).shortValue();</span>

			// window type
<span class="nc" id="L655">			String type_txt = (String) config.get(PulseKeys.TREND_CONFIG_WINDOW_TYPE);</span>
<span class="nc" id="L656">			short type = ((Integer) TextAppletIO.convertToInteger(type_txt)).shortValue();</span>

			// window offset
<span class="nc" id="L659">			String offset_txt = (String) config.get(PulseKeys.TREND_CONFIG_WINDOW_OFFSET);</span>
<span class="nc" id="L660">			int offset = ((Integer) TextAppletIO.convertToInteger(offset_txt)).intValue();</span>

			// exclusion to start
<span class="nc" id="L663">			String exToStart_txt = (String) config.get(PulseKeys.TREND_CONFIG_EXCLUSION_TO_START);</span>
<span class="nc" id="L664">			Date[] exToStart = convertToDateArray(exToStart_txt);</span>

			// exculsion window
<span class="nc" id="L667">			String exWindow_txt = (String) config.get(PulseKeys.TREND_CONFIG_EXCLUSION_WINDOW);</span>
<span class="nc" id="L668">			Date[][] exWindow = convertToDateDoubleArray(exWindow_txt);</span>

<span class="nc" id="L670">			TrendingConfig tc = new TrendingConfig();</span>
<span class="nc" id="L671">			tc.setID(id);</span>
<span class="nc" id="L672">			tc.setUserID(userId);</span>
<span class="nc" id="L673">			tc.setSPID(spId);</span>
<span class="nc" id="L674">			tc.setTrendingRate(rate);</span>
<span class="nc" id="L675">			tc.setApplyWindowType(type);</span>
<span class="nc" id="L676">			tc.setApplyWindowOffset(offset);</span>
<span class="nc" id="L677">			tc.setExclusionToStart(exToStart[0], exToStart[1]);</span>
<span class="nc" id="L678">			tc.setExclusionWindow(exWindow);</span>
<span class="nc" id="L679">			return tc;</span>
		}
<span class="nc" id="L681">		return null;</span>
	}

	private short[] convertToShortArray(String shortarray) {
<span class="nc bnc" id="L685" title="All 2 branches missed.">		if (shortarray.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L686">			return new short[0];</span>
		else {
<span class="nc" id="L688">			StringTokenizer st = new StringTokenizer(shortarray, PulseKeys.NEXT_COL);</span>
<span class="nc" id="L689">			ArrayList c = new ArrayList(st.countTokens());</span>

<span class="nc bnc" id="L691" title="All 2 branches missed.">			while (st.hasMoreTokens()) {</span>
<span class="nc" id="L692">				String token = st.nextToken();</span>
<span class="nc" id="L693">				c.add(TextAppletIO.convertToInteger(token));</span>
<span class="nc" id="L694">			}</span>

<span class="nc" id="L696">			Integer[] tmp = new Integer[c.size()];</span>
<span class="nc" id="L697">			tmp = (Integer[]) c.toArray(tmp);</span>
<span class="nc" id="L698">			short[] ret = new short[tmp.length];</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">			for (int i = 0; i &lt; tmp.length; i++) {</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">				if (tmp[i] != null) {</span>
<span class="nc" id="L701">					ret[i] = tmp[i].shortValue();</span>
				}
			}

<span class="nc" id="L705">			return ret;</span>
		}
	}

	private boolean[] convertToBooleanArray(String booleanarray) {
<span class="nc bnc" id="L710" title="All 2 branches missed.">		if (booleanarray.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L711">			return new boolean[0];</span>
		else {
<span class="nc" id="L713">			StringTokenizer st = new StringTokenizer(booleanarray, PulseKeys.NEXT_COL);</span>
<span class="nc" id="L714">			ArrayList c = new ArrayList(st.countTokens());</span>

<span class="nc bnc" id="L716" title="All 2 branches missed.">			while (st.hasMoreTokens()) {</span>
<span class="nc" id="L717">				String token = st.nextToken();</span>
<span class="nc" id="L718">				c.add(TextAppletIO.convertToBoolean(token));</span>
<span class="nc" id="L719">			}</span>

<span class="nc" id="L721">			Boolean[] tmp = new Boolean[c.size()];</span>
<span class="nc" id="L722">			tmp = (Boolean[]) c.toArray(tmp);</span>
<span class="nc" id="L723">			boolean[] ret = new boolean[tmp.length];</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">			for (int i = 0; i &lt; tmp.length; i++) {</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">				if (tmp[i] != null) {</span>
<span class="nc" id="L726">					ret[i] = tmp[i].booleanValue();</span>
				}
			}

<span class="nc" id="L730">			return ret;</span>
		}
	}

	private int[] convertToIntArray(String intarray) {
<span class="nc bnc" id="L735" title="All 2 branches missed.">		if (intarray.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L736">			return new int[0];</span>
		else {
<span class="nc" id="L738">			StringTokenizer st = new StringTokenizer(intarray, PulseKeys.NEXT_COL);</span>
<span class="nc" id="L739">			ArrayList c = new ArrayList(st.countTokens());</span>

<span class="nc bnc" id="L741" title="All 2 branches missed.">			while (st.hasMoreTokens()) {</span>
<span class="nc" id="L742">				String token = st.nextToken();</span>
<span class="nc" id="L743">				c.add(TextAppletIO.convertToInteger(token));</span>
<span class="nc" id="L744">			}</span>

<span class="nc" id="L746">			Integer[] tmp = new Integer[c.size()];</span>
<span class="nc" id="L747">			tmp = (Integer[]) c.toArray(tmp);</span>
<span class="nc" id="L748">			int[] ret = new int[tmp.length];</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">			for (int i = 0; i &lt; tmp.length; i++) {</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">				if (tmp[i] != null) {</span>
<span class="nc" id="L751">					ret[i] = tmp[i].shortValue();</span>
				}
			}

<span class="nc" id="L755">			return ret;</span>
		}
	}

	private int[][] convertToIntDoubleArray(String intDoubleArray) {
<span class="nc bnc" id="L760" title="All 2 branches missed.">		if (intDoubleArray.equalsIgnoreCase(PulseKeys.NULL))</span>
<span class="nc" id="L761">			return new int[0][0];</span>
		else {
<span class="nc" id="L763">			StringTokenizer st = new StringTokenizer(intDoubleArray, PulseKeys.NEXT_ROW);</span>
<span class="nc" id="L764">			ArrayList c = new ArrayList(st.countTokens());</span>

<span class="nc bnc" id="L766" title="All 2 branches missed.">			while (st.hasMoreTokens()) {</span>
<span class="nc" id="L767">				String token = st.nextToken();</span>
<span class="nc" id="L768">				c.add(convertToIntArray(token));</span>
<span class="nc" id="L769">			}</span>

<span class="nc" id="L771">			int[][] ret = new int[c.size()][];</span>
<span class="nc" id="L772">			ret = (int[][]) c.toArray(ret);</span>
<span class="nc" id="L773">			return ret;</span>
		}
	}

	private TraceCube convertToTraceCube(HashMap cube) {
<span class="nc bnc" id="L778" title="All 2 branches missed.">		if (cube != null) {</span>
			// type
<span class="nc" id="L780">			String type = (String) cube.get(PulseKeys.TRACE_CUBE_TYPE);</span>

			// queue id
<span class="nc" id="L783">			String queueId_txt = (String) cube.get(PulseKeys.TRACE_CUBE_QUEUE_ID);</span>
<span class="nc" id="L784">			ID queueId = convertToID(queueId_txt);</span>

			// rawStartDate
<span class="nc" id="L787">			String rawStartDate_txt = (String) cube.get(PulseKeys.TRACE_CUBE_START_DATE);</span>
<span class="nc" id="L788">			Date rawStartDate = TextAppletIO.convertToDate(rawStartDate_txt);</span>

			// rawStartDate
<span class="nc" id="L791">			String rawEndDate_txt = (String) cube.get(PulseKeys.TRACE_CUBE_END_DATE);</span>
<span class="nc" id="L792">			Date rawEndDate = TextAppletIO.convertToDate(rawEndDate_txt);</span>

			// trace types
<span class="nc" id="L795">			String traceTypes_txt = (String) cube.get(PulseKeys.TRACE_CUBE_TRACE_TYPES);</span>
<span class="nc" id="L796">			short[] traceTypes = convertToShortArray(traceTypes_txt);</span>

			// trace values
<span class="nc" id="L799">			String traceValues_txt = (String) cube.get(PulseKeys.TRACE_CUBE_VALUES);</span>
<span class="nc" id="L800">			int[][] traceValues = convertToIntDoubleArray(traceValues_txt);</span>

			// create tc
<span class="nc" id="L803">			TraceCube traceCube = null;</span>
			try {
<span class="nc bnc" id="L805" title="All 2 branches missed.">				if (type.equals(PulseKeys.ACTUAL_TRACECUBE)) {</span>
<span class="nc" id="L806">					traceCube = new ActualTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">				} else if (type.equals(PulseKeys.AGGR_FORECASTED_TRACECUBE)) {</span>
<span class="nc" id="L808">					traceCube = new AggrForecastedTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">				} else if (type.equals(PulseKeys.AGGR_REQUIRED_TRACECUBE)) {</span>
<span class="nc" id="L810">					traceCube = new AggrRequiredTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">				} else if (type.equals(PulseKeys.FORECASTED_TRACECUBE)) {</span>
<span class="nc" id="L812">					traceCube = new ForecastTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">				} else if (type.equals(PulseKeys.PREDICT_TRACECUBE)) {</span>
<span class="nc" id="L814">					traceCube = new PredictTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">				} else if (type.equals(PulseKeys.REQUIRED_TRACECUBE)) {</span>
<span class="nc" id="L816">					traceCube = new RequireTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">				} else if (type.equals(PulseKeys.SERVICEGOAL_TRACECUBE)) {</span>
<span class="nc" id="L818">					traceCube = new ServiceGoalTraceCube(queueId, rawStartDate, rawEndDate, traceTypes);</span>
				}
<span class="nc" id="L820">			} catch (BbmTimeSeriesException e) {</span>
<span class="nc" id="L821">				e.printStackTrace();</span>
<span class="nc" id="L822">			}</span>

<span class="nc bnc" id="L824" title="All 2 branches missed.">			if (traceCube != null) {</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">				for (int i = 0; i &lt; traceTypes.length; i++) {</span>
<span class="nc" id="L826">					traceCube.setTraceValue(traceTypes[i], traceValues[i]);</span>
				}
			}
<span class="nc" id="L829">			return traceCube;</span>
		}
<span class="nc" id="L831">		return null;</span>
	}

	private HashMap convertToTraceCubeMap(String map, boolean forecast) {
<span class="nc" id="L835">		StringTokenizer st = new StringTokenizer(map, PulseKeys.NEXT_KEY);</span>
<span class="nc" id="L836">		HashMap ret = new HashMap();</span>

<span class="nc bnc" id="L838" title="All 2 branches missed.">		while (st.hasMoreTokens()) {</span>
<span class="nc" id="L839">			String token = st.nextToken();</span>
			// System.out.println (&quot;Token to convert to trace cube: &quot;+token);
<span class="nc" id="L841">			StringTokenizer element = new StringTokenizer(token, &quot;***&quot;);</span>
<span class="nc" id="L842">			String key = element.nextToken();</span>
<span class="nc" id="L843">			ID queueId = convertToID(key);</span>

<span class="nc" id="L845">			String val = element.nextToken();</span>
			// System.out.println (&quot;Val to convert to trace cube:  &quot;+val);

<span class="nc" id="L848">			TraceCube tc = convertToTraceCube(TextAppletIO.convertToHashMap(val));</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">			if (forecast)</span>
<span class="nc" id="L850">				ret.put(queueId, tc);</span>
			else {
<span class="nc" id="L852">				TraceCube[] tcs = new TraceCube[1];</span>
<span class="nc" id="L853">				tcs[0] = tc;</span>
<span class="nc" id="L854">				ret.put(queueId, tcs);</span>
			}
<span class="nc" id="L856">		}</span>
<span class="nc" id="L857">		return ret;</span>
	}

	private TraceChunk convertToTraceChunk(HashMap cube) {
<span class="nc bnc" id="L861" title="All 2 branches missed.">		if (cube != null) {</span>
			// queue id
<span class="nc" id="L863">			String queueId_txt = (String) cube.get(PulseKeys.TRACE_CUBE_QUEUE_ID);</span>
<span class="nc" id="L864">			ID queueId = convertToID(queueId_txt);</span>

			// rawStartDate
<span class="nc" id="L867">			String rawStartDate_txt = (String) cube.get(PulseKeys.TRACE_CUBE_START_DATE);</span>
<span class="nc" id="L868">			Date rawStartDate = TextAppletIO.convertToDate(rawStartDate_txt);</span>

			// trace types
<span class="nc" id="L871">			String traceTypes_txt = (String) cube.get(PulseKeys.TRACE_CUBE_TRACE_TYPES);</span>
<span class="nc" id="L872">			short[] traceTypes = convertToShortArray(traceTypes_txt);</span>

			// trace values
<span class="nc" id="L875">			String traceValues_txt = (String) cube.get(PulseKeys.TRACE_CUBE_VALUES);</span>
<span class="nc" id="L876">			int[] traceValues = convertToIntArray(traceValues_txt);</span>

			// create TraceChunk
<span class="nc" id="L879">			TraceChunk traceChunk = new TraceChunk(queueId, rawStartDate);</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">			if (traceChunk != null) {</span>
<span class="nc" id="L881">				traceChunk.setTraceValues(traceTypes, traceValues);</span>
			}
<span class="nc" id="L883">			return traceChunk;</span>
		}
<span class="nc" id="L885">		return null;</span>
	}

	/**
	 * Converts a Collection of strings into Collection of
	 * &lt;code&gt;TraceChunk&lt;/code&gt;'s
	 * 
	 * @param c
	 *            A Collection of &lt;code&gt;String&lt;/code&gt;'s, where each represents a
	 *            &lt;code&gt;TraceChunk&lt;/code&gt;.
	 * @return A Collection of &lt;code&gt;TraceChunk&lt;/code&gt;'s
	 */
	private Collection convertToTraceChunks(Collection c) {
<span class="nc" id="L898">		Collection ret = new ArrayList(c.size());</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">		for (Iterator iter = c.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L900">			String item = (String) iter.next();</span>
<span class="nc" id="L901">			ret.add(convertToTraceChunk(TextAppletIO.convertToHashMap(item)));</span>
<span class="nc" id="L902">		}</span>
<span class="nc" id="L903">		return ret;</span>
	}

	/** Request Methods **/

	private void getTraceData(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L909">		String campIDStr = context.getUserProperty(Caching.SELECTED_CAMPAIGN_ID);</span>
<span class="nc bnc" id="L910" title="All 4 branches missed.">		ID campID = (campIDStr == null || &quot;&quot;.equals(campIDStr)) ? null : new ID(campIDStr);</span>
<span class="nc" id="L911">		ID mediaID = (ID) appletRequest.get(PulseKeys.MEDIA_ID);</span>
<span class="nc" id="L912">		Collection queueIDs = (Collection) appletRequest.get(PulseKeys.QUEUE_IDS);</span>
<span class="nc" id="L913">		ID viewID = (ID) appletRequest.get(PulseKeys.VIEW_ID); // (viewID =</span>
																// null) ==&gt;
																// history view
<span class="nc" id="L916">		Date startDate = (Date) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L917">		Date endDate = (Date) appletRequest.get(PulseKeys.END_DATE);</span>
<span class="nc" id="L918">		Boolean emptyData = (Boolean) appletRequest.get(PulseKeys.EMPTY_DATA);</span>
<span class="nc" id="L919">		boolean bEmptyData = false;</span>
<span class="nc bnc" id="L920" title="All 4 branches missed.">		if (emptyData != null &amp;&amp; emptyData.booleanValue())</span>
<span class="nc" id="L921">			bEmptyData = true;</span>

<span class="nc" id="L923">		Boolean forceEmptyDataButUseRequestedDateRange = (Boolean) appletRequest</span>
<span class="nc" id="L924">				.get(&quot;forceEmptyDataButUseRequestedDateRange&quot;);</span>
<span class="nc" id="L925">		boolean bForceEmptyDataButUseRequestedDateRange = false;</span>
<span class="nc bnc" id="L926" title="All 4 branches missed.">		if (forceEmptyDataButUseRequestedDateRange != null &amp;&amp; forceEmptyDataButUseRequestedDateRange.booleanValue()) {</span>
<span class="nc" id="L927">			bForceEmptyDataButUseRequestedDateRange = true;</span>
<span class="nc" id="L928">			bEmptyData = true;</span>
		}

<span class="nc bnc" id="L931" title="All 2 branches missed.">		if (cat.isDebugEnabled()) {</span>
<span class="nc" id="L932">			StringBuffer sb = new StringBuffer(256);</span>

<span class="nc" id="L934">			sb.append(&quot;Pulse::getTraceData() called\n&quot;);</span>
<span class="nc" id="L935">			sb.append(&quot;campID=&quot; + campID + &quot;,&quot;);</span>
<span class="nc" id="L936">			sb.append(&quot;mediaID=&quot; + mediaID + &quot;,&quot;);</span>
<span class="nc" id="L937">			sb.append(&quot;queueIDs=[&quot;);</span>
<span class="nc bnc" id="L938" title="All 2 branches missed.">			if (queueIDs != null) {</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">				for (Iterator qIter = queueIDs.iterator(); qIter.hasNext();) {</span>
<span class="nc" id="L940">					sb.append(qIter.next() + &quot;,&quot;);</span>
				}
			}
<span class="nc" id="L943">			sb.append(&quot;],&quot;);</span>
<span class="nc" id="L944">			sb.append(&quot;viewID=&quot; + viewID + &quot;,&quot;);</span>
<span class="nc" id="L945">			sb.append(&quot;start=&quot; + startDate + &quot;,end=&quot; + endDate);</span>
<span class="nc" id="L946">			cat.debug(sb.toString());</span>
			// System.out.println(sb.toString());
		}

		try {
			// Get the last Campaign viewd by the logged-in user
<span class="nc bnc" id="L952" title="All 2 branches missed.">			Campaign campaign = (campID == null) ? null : PulseModelHandler.getCampaign(context, campID);</span>

			// Get View
<span class="nc" id="L955">			TrackingView view = PulseModelHandler.getTrackingView(context, viewID);</span>

			// bEmptyData means no queue is selected, such as when we're
			// switching to &quot;All Queues&quot; mode, or
			// when the chosen campaign has no queues, or when Pulse is
			// configured not to select a queue by default.
<span class="nc" id="L961">			boolean bPulseSelectionNoDefault = isPulseSelectionNoDefault(context, appletRequest, appletResponse, false)</span>
<span class="nc" id="L962">					.booleanValue();</span>
<span class="nc bnc" id="L963" title="All 8 branches missed.">			if (bEmptyData &amp;&amp; campID != null &amp;&amp; bPulseSelectionNoDefault &amp;&amp; !bForceEmptyDataButUseRequestedDateRange) {</span>
				// Since campID!=null, we are not in All Queues mode. In this
				// case, Pulse received no selectedID (which contains the
				// campaignID,
				// mediaID,and queueIDs information), and without the
				// campaignID, Pulse didn't know which SP to set its dates too,
				// hence Pulse
				// sends us the old date range (from the previously selected
				// campaign). We need to get our date range in synch with the
				// selection
				// pane, which automatically sets it to the most current SP
				// every time the user changes the campaign (see
				// QueueSelectionPM.preLoadData()).
				// Fortunately, it stores the dates in the RequestContext, so we
				// can get them here.
<span class="nc" id="L978">				startDate = QueueFilterUtil.retrieveTimePeriodStart(context);</span>
<span class="nc" id="L979">				endDate = QueueFilterUtil.retrieveTimePeriodEnd(context);</span>
			}

			// Get SP
<span class="nc" id="L983">			ID spID = null;</span>
<span class="nc bnc" id="L984" title="All 2 branches missed.">			if (campID != null) {</span>
<span class="nc" id="L985">				spID = PulseModelHandler.getSPID(context, campID, startDate, endDate);</span>
			}

<span class="nc bnc" id="L988" title="All 2 branches missed.">			SchedulingPeriod sp = (spID == null) ? null : PulseModelHandler.getSP(context, spID);</span>

			// Get TrendingConfig
<span class="nc" id="L991">			TrendingConfig trendConfig = null;</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">			if (!bEmptyData)</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">				trendConfig = (spID == null) ? null : PulseModelHandler.getTrendingConfig(context, spID);</span>

			// Get Dates
<span class="nc bnc" id="L996" title="All 6 branches missed.">			if (spID != null &amp;&amp; startDate == null &amp;&amp; endDate == null) {</span>
<span class="nc" id="L997">				RangeValuePair pair = PulseModelHandler.getSPDates(context, spID);</span>
<span class="nc" id="L998">				startDate = (Date) pair.getLowValue();</span>
<span class="nc" id="L999">				endDate = (Date) pair.getHighValue();</span>
			}

			// We need to update the date range properties here rather
			// than in the applet in order to have correct queue selection pane
			// synchronization.
<span class="nc" id="L1005">			updateDateProperties(context, startDate, endDate, spID, campID);</span>

			// Get Available Queue ID's
<span class="nc" id="L1008">			Collection availableQueueIDs = null;</span>
<span class="nc bnc" id="L1009" title="All 4 branches missed.">			if (!bEmptyData || bPulseSelectionNoDefault)</span>
<span class="nc" id="L1010">				availableQueueIDs = PulseModelHandler.getAvailableQueueIDs(context, campID, startDate, endDate);</span>

			// If user chose a date in Campaign mode where there is no SP, then
			// data should be empty
<span class="nc bnc" id="L1014" title="All 6 branches missed.">			if ((campaign != null) &amp;&amp; ((availableQueueIDs == null) || availableQueueIDs.isEmpty())) {</span>
<span class="nc" id="L1015">				bEmptyData = true;</span>
			}

			// Get Queues
<span class="nc" id="L1019">			Collection originalQueues = null; // The queues selected by the user</span>
											  // (null for the combined queue)
<span class="nc" id="L1021">			Collection resultQueues = null;   // The queues to be displayed</span>
<span class="nc" id="L1022">			Boolean isCombined = Boolean.FALSE;</span>
			
<span class="nc" id="L1024">			Queue fatherQueue = null;</span>
			
<span class="nc bnc" id="L1026" title="All 2 branches missed.">			if (!bEmptyData) {</span>
<span class="nc bnc" id="L1027" title="All 4 branches missed.">				if (queueIDs == null || queueIDs.size() == 0) {</span>
					// If campaign only has 1 queue, we need to request that
					// queue rather than combined.
					// Even though the selection pane already has the single
					// queue selected by default, if the
					// page has first loaded, then the queue selection will
					// return null. This is due to a race
					// condition between the two frames.
<span class="nc bnc" id="L1035" title="All 6 branches missed.">					if ((campaign != null) &amp;&amp; (availableQueueIDs != null) &amp;&amp; (availableQueueIDs.size() == 1)) {</span>
<span class="nc" id="L1036">						queueIDs = availableQueueIDs;</span>
					} else {
<span class="nc" id="L1038">						isCombined = Boolean.TRUE;</span>
					}
<span class="nc bnc" id="L1040" title="All 4 branches missed.">				} else if ((campaign != null) &amp;&amp; (availableQueueIDs != null)</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">						&amp;&amp; (!availableQueueIDs.containsAll(queueIDs))) {</span>
					// We have requested queues which are not available for the
					// campaign under the specified dates.
					// This happens when user changes SP and the new SP has a
					// different set of queues than the old
					// SP. Pulse immediately requests trace data for the old
					// queue and the new dates. It also notifies
					// the queue selector that the SP has changed, so the queue
					// selector gets the new set of queues,
					// and refreshes the pulse pane, which then calls
					// getTraceData again, this time for the new queue.
					// We can prevent the reloading of the pulse pane by setting
					// queueIDs to the queues which we know
					// will be selected in the queue selection pane for this
					// date range (a subset of availableQueueIDs).
					/*
					 * queueIDs.retainAll(availableQueueIDs); if
					 * (queueIDs.size() == 0) { //If campaign only has 1 queue,
					 * we need to request that queue rather than combined. if
					 * (availableQueueIDs.size() == 1) { queueIDs =
					 * availableQueueIDs; } else { isCombined = Boolean.TRUE; }
					 * }
					 * 
					 * //Also, since our queues have changed from what was
					 * requested, we'll need to recalculate mediaID mediaID =
					 * null;
					 */

					// Bug: If page is dirty and user changes campaign, the
					// queue selector first loads the new campaign
					// queues rather than pop-up the confirmation alert first.
					// So if user clicks cancel in pop-up dialog,
					// the left pane is still on the new campaign/queues. This
					// causes an inconsistency with the workpane,
					// which remains on the original selection. If we were to
					// perform the above code, user would see the
					// the wrong data on the right pane when going back to the
					// original campaign. It's better if we just
					// return empty data here. At least the user will realize
					// that something is wrong.
<span class="nc" id="L1081">					bEmptyData = true;</span>
				}

<span class="nc bnc" id="L1084" title="All 4 branches missed.">				if (queueIDs != null &amp;&amp; queueIDs.size() &gt; 0) {</span>
<span class="nc" id="L1085">					originalQueues = PulseModelHandler.getQueuesByIDs(context, queueIDs);</span>
<span class="nc" id="L1086">					resultQueues = originalQueues;</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">					if (queueIDs.size() == 1) {</span>
<span class="nc bnc" id="L1088" title="All 2 branches missed.">						for (Iterator i = originalQueues.iterator(); i.hasNext();) {</span>
<span class="nc" id="L1089">							Queue q = (Queue) i.next();</span>
							// If queue is distributed and trending is enabled.
<span class="nc bnc" id="L1091" title="All 4 branches missed.">							if (q.getQueueType() == Queue.QUEUE_TYPE_DISTRIBUTED &amp;&amp; view.useTrending()) {</span>
<span class="nc" id="L1092">								isCombined = Boolean.TRUE;</span>
<span class="nc" id="L1093">								fatherQueue = q;</span>
<span class="nc" id="L1094">								break;</span>
							}
<span class="nc" id="L1096">						}</span>
					}
				}
			}

			// Get Media
<span class="nc" id="L1102">			Media media = null;</span>
<span class="nc bnc" id="L1103" title="All 4 branches missed.">			if (campID != null &amp;&amp; !bEmptyData) {</span>
<span class="nc" id="L1104">				media = getMedia(context, campID, mediaID, startDate, endDate, originalQueues);</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">				mediaID = (media == null) ? null : media.getID();</span>
			}

			// Get Cube Maps, which contain the QID's and TraceCube's
			HashMap cube_maps;
<span class="nc bnc" id="L1110" title="All 2 branches missed.">			if (bEmptyData) {</span>
<span class="nc" id="L1111">				cube_maps = new HashMap();</span>
			} else {
<span class="nc" id="L1113">				cube_maps = PulseModelHandler.getCubeMaps(context, campID, mediaID, queueIDs, viewID, startDate, endDate);</span>
			}

			// If there's HOO in the tracking view, get a collection of
			// TimePeriodImpl
			// which consists of a pair of start and end date of when the center
			// is CLOSED!
<span class="nc" id="L1120">			Collection campHoo = null;</span>
<span class="nc bnc" id="L1121" title="All 2 branches missed.">			if (!bEmptyData) {</span>
<span class="nc bnc" id="L1122" title="All 4 branches missed.">				if (view.useHOO() &amp;&amp; campID != null)</span>
<span class="nc" id="L1123">					campHoo = PulseModelHandler.getCampaignHOO(campID, startDate, endDate);</span>
				else
<span class="nc" id="L1125">					campHoo = Collections.emptyList();</span>

				// Make sure resultQueues only contains those queues which
				// actually map to some data
<span class="nc bnc" id="L1129" title="All 2 branches missed.">				if (isCombined.booleanValue()) {</span>
<span class="nc" id="L1130">					Set queueIdsInCubeSet = cube_maps.keySet();</span>
<span class="nc" id="L1131">					ArrayList queueIdsInCubeList = new ArrayList();</span>
<span class="nc" id="L1132">					Iterator it = queueIdsInCubeSet.iterator();</span>
<span class="nc bnc" id="L1133" title="All 2 branches missed.">					while (it.hasNext()) {</span>
<span class="nc" id="L1134">						ID queueId = (ID) it.next();</span>
<span class="nc" id="L1135">						queueIdsInCubeList.add(queueId);</span>
<span class="nc" id="L1136">					}</span>
<span class="nc" id="L1137">					resultQueues = PulseModelHandler.getQueuesByIDs(context, queueIdsInCubeList);</span>
				}
			}

			// Store the results
<span class="nc" id="L1142">			HashMap resultMap = new HashMap(16);</span>
<span class="nc" id="L1143">			resultMap.put(PulseKeys.CAMPAIGN, campaign);</span>
<span class="nc" id="L1144">			resultMap.put(PulseKeys.MEDIA, media);</span>
<span class="nc" id="L1145">			resultMap.put(PulseKeys.QUEUES, resultQueues);</span>
<span class="nc" id="L1146">			resultMap.put(PulseKeys.TRACKING_VIEW, view);</span>
<span class="nc" id="L1147">			resultMap.put(PulseKeys.CUBE_MAPS, cube_maps);</span>
<span class="nc" id="L1148">			resultMap.put(PulseKeys.SP_ID, spID);</span>
<span class="nc" id="L1149">			resultMap.put(PulseKeys.SP, sp);</span>
<span class="nc" id="L1150">			resultMap.put(PulseKeys.TREND_CONFIG, trendConfig);</span>
<span class="nc" id="L1151">			resultMap.put(PulseKeys.AVAILABLE_QUEUE_IDS, availableQueueIDs);</span>
<span class="nc" id="L1152">			resultMap.put(PulseKeys.START_DATE, startDate);</span>
<span class="nc" id="L1153">			resultMap.put(PulseKeys.END_DATE, endDate);</span>
<span class="nc" id="L1154">			resultMap.put(PulseKeys.CURRENT_TIME, TraceUtil.snapDate(new Date()));</span>
<span class="nc" id="L1155">			resultMap.put(PulseKeys.COMBINED, isCombined);</span>
<span class="nc" id="L1156">			resultMap.put(PulseKeys.HOO, campHoo);</span>
<span class="nc" id="L1157">			resultMap.put(PulseKeys.FATHERQ, fatherQueue);</span>
			// resultMap.put(PulseKeys.ORIGINAL_QUEUES, originalQueues); //not
			// needed by the front end
<span class="nc" id="L1160">			resultMap.put(PulseKeys.IS_CAMPAIGN_DISTRIBUTED, isCampaignDistributed(campaign));</span>
<span class="nc" id="L1161">			resultMap.put(PulseKeys.HAS_CHILD_OF_VIRTUAL, hasChildOfVirtual(context, resultQueues));</span>
<span class="nc" id="L1162">			appletResponse.put(PulseKeys.DATA_MAP, resultMap);</span>

			// Error Handling
<span class="nc" id="L1165">			Queue badQueue = verifyQueueCampaignAssignments(context, resultQueues, startDate, endDate);</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">			if (badQueue != null) {</span>
<span class="nc" id="L1167">				notifyInvlalidQueue(context, resultMap, badQueue.getName());</span>
			}

<span class="nc bnc" id="L1170" title="All 2 branches missed.">			if (isDebugMode(view))</span>
<span class="nc" id="L1171">				updateTimeZones();</span>

<span class="nc" id="L1173">		} catch (Exception ex) {</span>
<span class="nc" id="L1174">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1175">		}</span>
<span class="nc" id="L1176">	}</span>

	/**
	 * Medco has hundreds of queues, and each time Pulse loads, or user changes
	 * campaigns, Pulse automatically selects the combined queue, which takes a
	 * long time to get from the backend because it combines all of the queues
	 * together dynamically. To improve performance, we added a BPCONFIG setting
	 * which allows Medco to configure Pulse so that it does not select any
	 * queue by default when switching campaigns, (or when switching SP/date
	 * range when no queue had been previously selected). Once the user selects
	 * a queue, if he then changes the SP/date range and the new SP/date range
	 * includes the selected queue, then that queue continues to be selected.
	 * However, when switching campaigns, we always de-select any queues
	 * selection. This method tells us whether Pulse is configured to show no
	 * queue by default.
	 * 
	 * @return true if Pulse is configured to show no queue by default, false if
	 *         not, and null if error..
	 */
	private Boolean isPulseSelectionNoDefault(RequestContext context, Map appletRequest, Map appletResponse,
			boolean storeResult) {
<span class="nc" id="L1197">		Boolean isSetNoDefault = null;</span>
		try {
<span class="nc" id="L1199">			boolean isEnabled = BbmManagerFactory.getDBConfigManager().getBooleanValue(</span>
					ConfigKey.PULSE_DEFAULT_SELECT_NO_QUEUE);
<span class="nc" id="L1201">			isSetNoDefault = new Boolean(isEnabled);</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L1203">				appletResponse.put(PulseKeys.PULSE_DEFAULT_SELECT_NO_QUEUE, isSetNoDefault);</span>
<span class="nc" id="L1204">		} catch (Exception ex) {</span>
<span class="nc" id="L1205">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1206">		}</span>
<span class="nc" id="L1207">		return isSetNoDefault;</span>
	}

	/**
	 * We will hide Adjusted Staffing by default in Pulse. But we have a
	 * BPCONFIG flag to show Adjusted Staffing (for debugging purposes).
	 * 
	 * @return true if Pulse is configured to show the Adjusted Staffing
	 *         statistic, false if not, and null if error..
	 */
	private Boolean isEnableAdjustedStaffingFromPulse(RequestContext context, Map appletRequest, Map appletResponse,
			boolean storeResult) {
<span class="nc" id="L1219">		Boolean isSetNoDefault = null;</span>
		try {
<span class="nc" id="L1221">			boolean isEnabled = BbmManagerFactory.getDBConfigManager().getBooleanValue(</span>
					ConfigKey.ENABLE_ADJUSTED_STAFFING_FROM_PULSE);
<span class="nc" id="L1223">			isSetNoDefault = new Boolean(isEnabled);</span>
<span class="nc bnc" id="L1224" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L1225">				appletResponse.put(PulseKeys.ENABLE_ADJUSTED_STAFFING_FROM_PULSE, isSetNoDefault);</span>
<span class="nc" id="L1226">		} catch (Exception ex) {</span>
<span class="nc" id="L1227">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1228">		}</span>
<span class="nc" id="L1229">		return isSetNoDefault;</span>
	}

	/**
	 * If the user request has a view, and the view's name is &quot;GQ4DEBUG&quot;, then
	 * that means we should output debug information to the console window.
	 * 
	 * @param view
	 *            The TrackingView.
	 * @return true if we should output debug informatio to the appserver
	 *         console window, false otherwise.
	 */
	private boolean isDebugMode(TrackingView view) {
<span class="nc bnc" id="L1242" title="All 6 branches missed.">		return ((view != null) &amp;&amp; (view.getViewName() != null &amp;&amp; (view.getViewName().equals(&quot;GQ4DEBUG&quot;))));</span>
	}

	/**
	 * GQ TEST METHOD ONLY: This method was copied from
	 * com.bluepumpkin.ejb.am.rtaamanager.ejb.RTAAManagerEJB in order to debug
	 * the TIMEZONEAM table entries.
	 */
	public void updateTimeZones() {
<span class="nc" id="L1251">		String straTimeZoneIDs[] = { &quot;PST&quot; }; // TimeZone.getAvailableIDs();</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">		for (int n = 0; n &lt; straTimeZoneIDs.length; n++) {</span>
<span class="nc" id="L1253">			String strTimeZoneID = straTimeZoneIDs[n];</span>
<span class="nc" id="L1254">			TimeZone timeZone = TimeZone.getTimeZone(strTimeZoneID);</span>
<span class="nc" id="L1255">			Calendar calStart = Calendar.getInstance(timeZone);</span>
			// calStart.clear();
			// calStart.set(2007, 2, 11);
<span class="nc" id="L1258">			calStart.add(Calendar.YEAR, -4);</span>
<span class="nc" id="L1259">			calStart.set(calStart.get(Calendar.YEAR), calStart.get(Calendar.MONTH), calStart.get(Calendar.DATE), 0, 0,</span>
					0);
<span class="nc" id="L1261">			calStart.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L1262">			Calendar calEnd = (Calendar) calStart.clone();</span>
<span class="nc" id="L1263">			calEnd.add(Calendar.YEAR, 4 * 2); // 40 * 2</span>
<span class="nc" id="L1264">			int nBias = Integer.MAX_VALUE;</span>
<span class="nc" id="L1265">			Date dateLastBiasChange = null;</span>
<span class="nc" id="L1266">			Calendar cal = calStart;</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed.">			for (; cal.before(calEnd); cal.add(Calendar.HOUR_OF_DAY, 1)) {</span>
<span class="nc" id="L1268">				Date date = cal.getTime();</span>
				int nCurrentBias;
<span class="nc bnc" id="L1270" title="All 2 branches missed.">				if (timeZone.inDaylightTime(date))</span>
<span class="nc" id="L1271">					nCurrentBias = cal.get(Calendar.ZONE_OFFSET) + cal.get(Calendar.DST_OFFSET);</span>
				else
<span class="nc" id="L1273">					nCurrentBias = cal.get(Calendar.ZONE_OFFSET);</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">				if (nCurrentBias != nBias) {</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">					if (dateLastBiasChange != null) {</span>
<span class="nc" id="L1276">						HashMap hm = new HashMap();</span>
<span class="nc" id="L1277">						hm.put(&quot;TIMEZONE&quot;, strTimeZoneID);</span>
<span class="nc" id="L1278">						hm.put(&quot;STARTTIME&quot;, formatDBString(new Timestamp(dateLastBiasChange.getTime())));</span>
<span class="nc" id="L1279">						hm.put(&quot;ENDTIME&quot;, formatDBString(new Timestamp(date.getTime())));</span>
<span class="nc" id="L1280">						hm.put(&quot;BIAS&quot;, new Integer(nBias / (1000 * 60)));</span>
<span class="nc" id="L1281">						System.out.println(&quot;STARTTIME=&quot; + hm.get(&quot;STARTTIME&quot;) + &quot;, ENDTIME=&quot; + hm.get(&quot;ENDTIME&quot;)</span>
<span class="nc" id="L1282">								+ &quot;, BIAS=&quot; + hm.get(&quot;BIAS&quot;));</span>
					}
<span class="nc" id="L1284">					nBias = nCurrentBias;</span>
<span class="nc" id="L1285">					dateLastBiasChange = date;</span>
				}
			}
<span class="nc bnc" id="L1288" title="All 2 branches missed.">			if (dateLastBiasChange != null) {</span>
<span class="nc" id="L1289">				Date date = cal.getTime();</span>
<span class="nc" id="L1290">				HashMap hm = new HashMap();</span>
<span class="nc" id="L1291">				hm.put(&quot;TIMEZONE&quot;, strTimeZoneID);</span>
<span class="nc" id="L1292">				hm.put(&quot;STARTTIME&quot;, formatDBString(new Timestamp(dateLastBiasChange.getTime())));</span>
<span class="nc" id="L1293">				hm.put(&quot;ENDTIME&quot;, formatDBString(new Timestamp(date.getTime())));</span>
<span class="nc" id="L1294">				hm.put(&quot;BIAS&quot;, new Integer(nBias / (1000 * 60)));</span>
<span class="nc" id="L1295">				System.out.println(&quot;STARTTIME=&quot; + hm.get(&quot;STARTTIME&quot;) + &quot;, ENDTIME=&quot; + hm.get(&quot;ENDTIME&quot;) + &quot;, BIAS=&quot;</span>
<span class="nc" id="L1296">						+ hm.get(&quot;BIAS&quot;));</span>
			}
		}
<span class="nc" id="L1299">	}</span>

	/**
	 * Format a Timestamp object to a persistable DBString
	 * 
	 * @param stamp
	 * @return
	 */
	public static String formatDBString(Timestamp stamp) {
<span class="nc" id="L1308">		Calendar cal = Calendar.getInstance(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L1309">		cal.setTime(stamp);</span>
<span class="nc" id="L1310">		int i = cal.get(Calendar.YEAR);</span>
<span class="nc" id="L1311">		int j = cal.get(Calendar.MONTH) + 1;</span>
<span class="nc" id="L1312">		int k = cal.get(Calendar.DATE);</span>
<span class="nc" id="L1313">		int l = cal.get(Calendar.HOUR_OF_DAY);</span>
<span class="nc" id="L1314">		int i1 = cal.get(Calendar.MINUTE);</span>
<span class="nc" id="L1315">		int j1 = cal.get(Calendar.SECOND);</span>

		// Usually it outputs 20010824 18:37:24.908 , 23 characters
		// In order to accomodate Oracle, we have to omit nanoseconds
		// StringBuffer s = new StringBuffer(25);
<span class="nc" id="L1320">		StringBuffer s = new StringBuffer(19);</span>
<span class="nc" id="L1321">		s.append(i);</span>

<span class="nc bnc" id="L1323" title="All 2 branches missed.">		if (j &lt; 10)</span>
<span class="nc" id="L1324">			s.append(&quot;0&quot;).append(j);</span>
		else
<span class="nc" id="L1326">			s.append(j);</span>

<span class="nc bnc" id="L1328" title="All 2 branches missed.">		if (k &lt; 10)</span>
<span class="nc" id="L1329">			s.append(&quot;0&quot;).append(k);</span>
		else
<span class="nc" id="L1331">			s.append(k);</span>
<span class="nc" id="L1332">		s.append(&quot; &quot;);</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">		if (l &lt; 10)</span>
<span class="nc" id="L1334">			s.append(&quot;0&quot;).append(l);</span>
		else
<span class="nc" id="L1336">			s.append(l);</span>
<span class="nc" id="L1337">		s.append(&quot;:&quot;);</span>
<span class="nc bnc" id="L1338" title="All 2 branches missed.">		if (i1 &lt; 10)</span>
<span class="nc" id="L1339">			s.append(&quot;0&quot;).append(i1);</span>
		else
<span class="nc" id="L1341">			s.append(i1);</span>
<span class="nc" id="L1342">		s.append(&quot;:&quot;);</span>
<span class="nc bnc" id="L1343" title="All 2 branches missed.">		if (j1 &lt; 10)</span>
<span class="nc" id="L1344">			s.append(&quot;0&quot;).append(j1);</span>
		else
<span class="nc" id="L1346">			s.append(j1);</span>

<span class="nc" id="L1348">		return s.toString();</span>
	}

	/**
	 * I don't remember why, but we need to update the date range properties
	 * here rather than in the applet. It may have something to do with queue
	 * selection pane synchronization.
	 */
	private void updateDateProperties(RequestContext context, Date startDate, Date endDate, ID spID, ID campaignID) {
<span class="nc bnc" id="L1357" title="All 4 branches missed.">		if ((startDate != null) &amp;&amp; (endDate != null)) {</span>
<span class="nc" id="L1358">			Date oldStartDate = QueueFilterUtil.retrieveTimePeriodStart(context);</span>
<span class="nc" id="L1359">			Date oldEndDate = QueueFilterUtil.retrieveTimePeriodEnd(context);</span>

<span class="nc" id="L1361">			QueueFilterUtil.storeTimePeriodStart(context, startDate); // context.setUserProperty(QueueFilterUtil.QUEUE_FILTER_CAMP_START_DATE,</span>
																		// String.valueOf(startDate.getTime()));
<span class="nc" id="L1363">			QueueFilterUtil.storeTimePeriodEnd(context, endDate); // context.setUserProperty(QueueFilterUtil.QUEUE_FILTER_CAMP_END_DATE,</span>
																	// String.valueOf(endDate.getTime()));

<span class="nc bnc" id="L1366" title="All 6 branches missed.">			if (spID == null &amp;&amp; !sameDates(oldStartDate, startDate) || !sameDates(oldEndDate, endDate)) {</span>
				// If no SP is selected or no SP matches the date range, then we
				// need to force the selection
				// pane to use this date range rather than let it find the
				// closest SP, or use the last stored SP.
<span class="nc" id="L1371">				QueueFilterUtil.storeUseSavedDatesForOneTimeUse(context, true);</span>
			}
		}

<span class="nc bnc" id="L1375" title="All 2 branches missed.">		if (spID != null) {</span>
<span class="nc" id="L1376">			SelectionCacheUtil.setSchedulingPeriodID(context, spID); // QueueFilterUtil.storeSchedulingPeriodID(context,</span>
																		// spID);
<span class="nc" id="L1378">			CampaignSchedulingPeriodSelectionUtil.setSelectedAutoCachedCampaignSPID(context, campaignID, spID);</span>
			// context.setUserProperty(FsCaching.CALENDAR_VIEW_SCHEDULINGPERIOD_ID,
			// spID.toString(), true);
		}
<span class="nc" id="L1382">	}</span>

	private boolean sameDates(Date date1, Date date2) {
<span class="nc bnc" id="L1385" title="All 4 branches missed.">		if (date1 == null &amp;&amp; date2 != null)</span>
<span class="nc" id="L1386">			return false;</span>

<span class="nc bnc" id="L1388" title="All 4 branches missed.">		if (date2 == null &amp;&amp; date1 != null)</span>
<span class="nc" id="L1389">			return false;</span>

<span class="nc bnc" id="L1391" title="All 4 branches missed.">		if (date1 == null &amp;&amp; date2 == null)</span>
<span class="nc" id="L1392">			return true;</span>

<span class="nc" id="L1394">		return date1.equals(date2);</span>
	}

	/**
	 * Given a CampaignID, MediaID, and date range, return a collection of
	 * Queues.
	 * 
	 * @return A collection of Queues
	 * @throws Exception
	 */
	private void getQueuesAttachedToCampaignMedia(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L1406">			ID campID = (ID) appletRequest.get(PulseKeys.CAMPAIGN_ID);</span>
<span class="nc" id="L1407">			ID mediaID = (ID) appletRequest.get(PulseKeys.MEDIA_ID);</span>
<span class="nc" id="L1408">			Date start = (Date) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L1409">			Date end = (Date) appletRequest.get(PulseKeys.END_DATE);</span>
<span class="nc" id="L1410">			Collection queues = PulseModelHandler</span>
<span class="nc" id="L1411">					.getQueuesAttachedToCampaignMedia(context, campID, mediaID, start, end);</span>
<span class="nc" id="L1412">			appletResponse.put(PulseKeys.QUEUES, queues);</span>
<span class="nc" id="L1413">		} catch (Exception ex) {</span>
<span class="nc" id="L1414">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1415">		}</span>
<span class="nc" id="L1416">	}</span>

	/**
	 * Determine which Media is selected.
	 * 
	 * @param context
	 * @param mediaID
	 *            If null, and there is only 1 media for campaign, we will get
	 *            it.
	 * @return The Media which should be assumed by Pulse.
	 */
	private Media getMedia(RequestContext context, ID campaignID, ID mediaID, Date start, Date end, Collection queues)
			throws Exception {
<span class="nc bnc" id="L1429" title="All 2 branches missed.">		if (mediaID == null) {</span>
<span class="nc bnc" id="L1430" title="All 4 branches missed.">			if ((queues == null) || (queues.isEmpty())) {</span>
				// We have a &quot;Combined&quot; queue, and since mediaID is null, that
				// means the page was just loaded.
				// We need to get all queues in order to determine if we should
				// use &quot;All Media&quot;, or a particular
				// media type.
<span class="nc" id="L1436">				queues = PulseModelHandler.getQueuesAttachedToCampaignMedia(context, campaignID, mediaID, start, end);</span>
			}

			// If the queues list only has a single Media type, then we will use
			// it.
			// If the queues list has more than one Media type, then mediaID
			// should remain null, which means &quot;All Media&quot;.
<span class="nc bnc" id="L1443" title="All 2 branches missed.">			if (queues != null) {</span>
<span class="nc bnc" id="L1444" title="All 2 branches missed.">				for (Iterator qIt = queues.iterator(); qIt.hasNext();) {</span>
<span class="nc" id="L1445">					Queue q = (Queue) qIt.next();</span>
<span class="nc" id="L1446">					ID mID = q.getMediaID();</span>
<span class="nc bnc" id="L1447" title="All 2 branches missed.">					if (mID != null) {</span>
<span class="nc bnc" id="L1448" title="All 2 branches missed.">						if (mediaID == null) {</span>
<span class="nc" id="L1449">							mediaID = mID; // first one found</span>
						} else {
<span class="nc bnc" id="L1451" title="All 2 branches missed.">							if (!mediaID.equals(mID)) {</span>
								// System.out.println(&quot;\n\nPulseAppletRequestHandler.getMedia() returning: null&quot;);
<span class="nc" id="L1453">								return null; // we have two different mediaID's</span>
							}
						}
					}
<span class="nc" id="L1457">				}</span>
			}
		}
<span class="nc bnc" id="L1460" title="All 2 branches missed.">		if (mediaID != null) // do not use else if</span>
		{
			// System.out.println(&quot;\n\nPulseAppletRequestHandler.getMedia() returning: &quot;
			// + PulseModelHandler.getMedia(context, mediaID));
<span class="nc" id="L1464">			return PulseModelHandler.getMedia(context, mediaID);</span>
		}
		// System.out.println(&quot;\n\nPulseAppletRequestHandler.getMedia() returning: null&quot;);
<span class="nc" id="L1467">		return null;</span>
	}

	/**
	 * Get the cube maps for a set of queues. Usually, you will call
	 * getTraceData() to return everything you need at once, but this method is
	 * intended to be used when you need to get the trace data for queues not
	 * being displayed. For example, when Reforecasting combined queues for a
	 * Distributed campaign, you will need to reforecast each of the Distributed
	 * queues falling under &quot;Combined&quot;, but the trace data for these queues was
	 * not retireved from the initial getTraceData() call.
	 * 
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void getCubeMaps(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1484">		String campIDStr = context.getUserProperty(Caching.SELECTED_CAMPAIGN_ID);</span>
<span class="nc bnc" id="L1485" title="All 4 branches missed.">		ID campID = (campIDStr == null || &quot;&quot;.equals(campIDStr)) ? null : new ID(campIDStr);</span>
<span class="nc" id="L1486">		ID mediaID = (ID) appletRequest.get(PulseKeys.MEDIA_ID);</span>
<span class="nc" id="L1487">		Collection queueIDs = (Collection) appletRequest.get(PulseKeys.QUEUE_IDS);</span>
<span class="nc" id="L1488">		ID viewID = (ID) appletRequest.get(PulseKeys.VIEW_ID); // (viewID =</span>
																// null) ==&gt;
																// history view
<span class="nc" id="L1491">		Date startDate = (Date) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L1492">		Date endDate = (Date) appletRequest.get(PulseKeys.END_DATE);</span>

		try {
<span class="nc bnc" id="L1495" title="All 2 branches missed.">			Campaign campaign = (campID == null) ? null : PulseModelHandler.getCampaign(context, campID);</span>
<span class="nc bnc" id="L1496" title="All 2 branches missed.">			if (campID != null) {</span>
<span class="nc bnc" id="L1497" title="All 2 branches missed.">				Collection queues = (queueIDs == null) ? null : PulseModelHandler.getQueuesByIDs(context, queueIDs);</span>
<span class="nc" id="L1498">				Media media = getMedia(context, campID, mediaID, startDate, endDate, queues);</span>
<span class="nc bnc" id="L1499" title="All 2 branches missed.">				mediaID = (media == null) ? null : media.getID();</span>
			}

<span class="nc" id="L1502">			TrackingView view = PulseModelHandler.getTrackingView(context, viewID);</span>
<span class="nc bnc" id="L1503" title="All 2 branches missed.">			ID spID = (campID == null) ? null : PulseModelHandler.getSPID(context, campID, startDate, endDate);</span>
<span class="nc bnc" id="L1504" title="All 2 branches missed.">			SchedulingPeriod sp = (spID == null) ? null : PulseModelHandler.getSP(context, spID);</span>
<span class="nc bnc" id="L1505" title="All 2 branches missed.">			TrendingConfig trendConfig = (spID == null) ? null : PulseModelHandler.getTrendingConfig(context, spID);</span>

<span class="nc bnc" id="L1507" title="All 6 branches missed.">			if (spID != null &amp;&amp; startDate == null &amp;&amp; endDate == null) {</span>
<span class="nc" id="L1508">				RangeValuePair pair = PulseModelHandler.getSPDates(context, spID);</span>
<span class="nc" id="L1509">				startDate = (Date) pair.getLowValue();</span>
<span class="nc" id="L1510">				endDate = (Date) pair.getHighValue();</span>
			}

<span class="nc" id="L1513">			HashMap cube_maps = PulseModelHandler.getCubeMaps(context, campID, mediaID, queueIDs, viewID, startDate,</span>
					endDate);

<span class="nc" id="L1516">			HashMap resultMap = new HashMap(16);</span>
<span class="nc" id="L1517">			resultMap.put(PulseKeys.CUBE_MAPS, cube_maps);</span>
<span class="nc" id="L1518">			appletResponse.put(PulseKeys.DATA_MAP, resultMap);</span>
<span class="nc" id="L1519">		} catch (Exception ex) {</span>
<span class="nc" id="L1520">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1521">		}</span>
<span class="nc" id="L1522">	}</span>

	/**
	 * Make sure each Queue is assigned to at most 1 Campaign during each SP in
	 * the date range.
	 * 
	 * @return The invalid Queue if queue is assigned to multiple Campaigns for
	 *         an SP in the date range, else null.
	 */
	private Queue verifyQueueCampaignAssignments(RequestContext context, Collection queues, Date startDate, Date endDate)
			throws Exception {
<span class="nc bnc" id="L1533" title="All 4 branches missed.">		if (queues != null &amp;&amp; queues.size() &gt; 0) {</span>
<span class="nc bnc" id="L1534" title="All 2 branches missed.">			for (Iterator i = queues.iterator(); i.hasNext();) {</span>
<span class="nc" id="L1535">				Queue q = (Queue) i.next();</span>
<span class="nc" id="L1536">				Collection qCamps = PulseModelHandler.getQueueCampaignAssignments(context, q.getID(), startDate,</span>
						endDate);
<span class="nc bnc" id="L1538" title="All 2 branches missed.">				if (qCamps.size() &gt; 1) {</span>
<span class="nc bnc" id="L1539" title="All 2 branches missed.">					for (Iterator qit1 = qCamps.iterator(); qit1.hasNext();) {</span>
<span class="nc" id="L1540">						CampaignQueue campQueue1 = (CampaignQueue) qit1.next();</span>

<span class="nc bnc" id="L1542" title="All 2 branches missed.">						for (Iterator qit2 = qCamps.iterator(); qit2.hasNext();) {</span>
<span class="nc" id="L1543">							CampaignQueue campQueue2 = (CampaignQueue) qit2.next();</span>
							// if different campaigns, and times overlap, we
							// have an invalid queue.
<span class="nc bnc" id="L1546" title="All 2 branches missed.">							if (!campQueue1.getCampaignID().equals(campQueue2.getCampaignID())) {</span>
								// if one SP starts exactly when another one
								// ends, that's ok. We only care about overlap.
<span class="nc bnc" id="L1549" title="All 2 branches missed.">								if (campQueue1.getEndTime().after(campQueue2.getStartTime())</span>
<span class="nc bnc" id="L1550" title="All 2 branches missed.">										&amp;&amp; campQueue2.getEndTime().after(campQueue1.getStartTime())) {</span>
<span class="nc" id="L1551">									return q;</span>
								}
							}
<span class="nc" id="L1554">						}</span>
<span class="nc" id="L1555">					}</span>
				}
<span class="nc" id="L1557">			}</span>
		}
<span class="nc" id="L1559">		return null;</span>
	}

	/**
	 * Determines if a campaign is a distributed campaign. We assume that if the
	 * given campaign has any sub-campaigns, then it is distributed. We will
	 * return false if the campaign is distributed, but no children have been
	 * added yet.
	 * 
	 * @param campaign
	 *            The campaign to check.
	 * @return true if the campaign is distributed, false otherwise.
	 */
	private Boolean isCampaignDistributed(Campaign campaign) {
<span class="nc bnc" id="L1573" title="All 2 branches missed.">		if (campaign == null)</span>
<span class="nc" id="L1574">			return Boolean.FALSE;</span>

<span class="nc" id="L1576">		return new Boolean(PulseModelHandler.isCampaignDistributed(campaign.getID()));</span>
	}

	/**
	 * Determines if a collection contains a queue which is the child of a
	 * virtual queue.
	 * 
	 * @param queues
	 *            A collection of &lt;code&gt;Queue&lt;/code&gt; objects.
	 * @return true if the collection contains a queue which is the child of a
	 *         virtual queue.
	 */
	private Boolean hasChildOfVirtual(RequestContext context, Collection queues) throws Exception {
<span class="nc bnc" id="L1589" title="All 4 branches missed.">		if ((queues == null) || (queues.size() == 0))</span>
<span class="nc" id="L1590">			return Boolean.FALSE;</span>

<span class="nc bnc" id="L1592" title="All 2 branches missed.">		for (Iterator it = queues.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1593">			Queue queue = (Queue) it.next();</span>
<span class="nc" id="L1594">			ID parentID = queue.getParentID();</span>
<span class="nc bnc" id="L1595" title="All 2 branches missed.">			if (parentID != null) {</span>
<span class="nc" id="L1596">				Queue parent = PulseModelHandler.getQueueByID(context, parentID);</span>
<span class="nc bnc" id="L1597" title="All 4 branches missed.">				if ((parent != null) &amp;&amp; (parent.getQueueType() == Queue.QUEUE_TYPE_VIRTUAL))</span>
<span class="nc" id="L1598">					return Boolean.TRUE;</span>
			}
<span class="nc" id="L1600">		}</span>
<span class="nc" id="L1601">		return Boolean.FALSE;</span>
	}

	/**
	 * Retrieves the list of user views
	 *
	 * PulseKeys.VIEWS_PUBLIC -- A Collection of KeyDisplayPair objects of (id,
	 * display strings) PulseKeys.VIEWS_PUBLIC_RO -- A Collection of
	 * KeyDisplayPair objects of (id, display strings) PulseKeys.VIEWS_PRIVATE
	 * -- A Collection of KeyDisplayPair objects of (id, display strings)
	 * 
	 * @param storeResult
	 *            Do you want to store the result in the response?
	 * @return A HashMap containing the 3 collections of views for the user.
	 */
	private HashMap getUserViews(RequestContext context, Map appletRequest, Map appletResponse, boolean storeResult) {
<span class="nc" id="L1617">		HashMap resultMap = new HashMap(4);</span>
		try {
<span class="nc" id="L1619">			Collection[] views = PulseModelHandler.getUserViews(context);</span>
<span class="nc" id="L1620">			resultMap.put(PulseKeys.VIEWS_PUBLIC, views[PulseModelHandler.VIEW_PUBLIC]);</span>
<span class="nc" id="L1621">			resultMap.put(PulseKeys.VIEWS_PUBLIC_RO, views[PulseModelHandler.VIEW_PUBLIC_RO]);</span>
<span class="nc" id="L1622">			resultMap.put(PulseKeys.VIEWS_PRIVATE, views[PulseModelHandler.VIEW_PRIVATE]);</span>

<span class="nc bnc" id="L1624" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L1625">				appletResponse.put(PulseKeys.DATA_MAP, resultMap);</span>
<span class="nc" id="L1626">		} catch (Exception ex) {</span>
<span class="nc" id="L1627">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1628">		}</span>
<span class="nc" id="L1629">		return resultMap;</span>
	}

	/**
	 * Get the list of all tracking view names which are not visible to the
	 * user.
	 * 
	 * @return A collection of other users' private view names, or null if
	 *         error.
	 */
	private void getInvisibleViewNames(RequestContext context, Map appletRequest, Map appletResponse) {
		try {
<span class="nc" id="L1641">			Collection views = PulseModelHandler.getInvisibleViewNames(context);</span>
<span class="nc" id="L1642">			appletResponse.put(PulseKeys.VIEWS_INVISIBLE, views);</span>
<span class="nc" id="L1643">		} catch (Exception ex) {</span>
<span class="nc" id="L1644">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1645">		}</span>
<span class="nc" id="L1646">	}</span>

	/**
	 * Return the TrackingView requested.
	 * 
	 * @param context
	 * @param appletRequest
	 *            May contain the VIEW_ID.
	 * @param appletResponse
	 * @param viewID
	 *            If not null, will override the VIEW_ID from the appletRequest.
	 * @param storeResult
	 *            Do you want to store the result in the response?
	 * @return the view requested.
	 */
	private TrackingView getView(RequestContext context, Map appletRequest, Map appletResponse, ID viewID,
			boolean storeResult) {
<span class="nc bnc" id="L1663" title="All 2 branches missed.">		if (viewID == null)</span>
<span class="nc" id="L1664">			viewID = (ID) appletRequest.get(PulseKeys.VIEW_ID);</span>
<span class="nc" id="L1665">		TrackingView view = null;</span>
		try {
<span class="nc" id="L1667">			view = PulseModelHandler.getTrackingView(context, viewID);</span>
<span class="nc" id="L1668">			appletResponse.put(PulseKeys.TRACKING_VIEW, view);</span>
<span class="nc" id="L1669">		} catch (Exception ex) {</span>
<span class="nc" id="L1670">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1671">		}</span>
<span class="nc" id="L1672">		return view;</span>
	}

	// /**
	// * Retrieves a tracking view object, based on its ID.
	// */
	// private void getView(RequestContext context, Map appletRequest, Map
	// appletResponse){
	// boolean history =
	// ((Boolean)appletRequest.get(PulseKeys.HISTORY_VIEW)).booleanValue();
	// ID viewID = (ID)appletRequest.get(PulseKeys.VIEW_ID);

	// try {
	// TrackingView view = null;
	// if (history) {
	// view = PulseModelHandler.getHistoryView(context);
	// } else {
	// view = PulseModelHandler.getTrackingView(context, viewID);
	// }
	// appletResponse.put(PulseKeys.TRACKING_VIEW, view);
	// } catch (Exception ex) {
	// notifyError(context, appletResponse, ex);
	// }
	// }

	/**
	 * Creates a tracking view object.
	 */
	private void createView(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1701">		TrackingView view = (TrackingView) appletRequest.get(PulseKeys.TRACKING_VIEW);</span>

		try {
<span class="nc" id="L1704">			view.setUserID(context.getUser().getID());</span>
<span class="nc" id="L1705">			view = PulseModelHandler.createView(context, view);</span>
<span class="nc" id="L1706">			appletResponse.put(PulseKeys.TRACKING_VIEW, view);</span>
<span class="nc" id="L1707">		} catch (Exception ex) {</span>
<span class="nc" id="L1708">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1709">		}</span>
<span class="nc" id="L1710">	}</span>

	/**
	 * Creates a tracking view object.
	 */
	private void editView(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1716">		TrackingView view = (TrackingView) appletRequest.get(PulseKeys.TRACKING_VIEW);</span>

		try {
<span class="nc" id="L1719">			PulseModelHandler.editView(context, view);</span>
<span class="nc" id="L1720">		} catch (Exception ex) {</span>
<span class="nc" id="L1721">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1722">		}</span>
<span class="nc" id="L1723">	}</span>

	private void deleteView(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1726">		ID viewID = (ID) appletRequest.get(PulseKeys.VIEW_ID);</span>

		try {
<span class="nc" id="L1729">			PulseModelHandler.deleteView(context, viewID);</span>

<span class="nc" id="L1731">			TrackingView view = PulseModelHandler.getTrackingView(context, TrackingView.INVALID_VIEW_ID);</span>
<span class="nc" id="L1732">			appletResponse.put(PulseKeys.TRACKING_VIEW, view);</span>
<span class="nc" id="L1733">		} catch (Exception ex) {</span>
<span class="nc" id="L1734">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1735">		}</span>
<span class="nc" id="L1736">	}</span>

	private void getTrendConfig(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1739">		ID spID = (ID) appletRequest.get(PulseKeys.SP_ID);</span>

		try {
<span class="nc" id="L1742">			TrendingConfig config = PulseModelHandler.getTrendingConfig(context, spID);</span>
<span class="nc" id="L1743">			appletResponse.put(PulseKeys.TREND_CONFIG, config);</span>
<span class="nc" id="L1744">		} catch (Exception ex) {</span>
<span class="nc" id="L1745">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1746">		}</span>
<span class="nc" id="L1747">	}</span>

	/**
	 * Saves a trend config for a particular sp
	 */
	private void saveTrendConfig(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1753">		TrendingConfig config = (TrendingConfig) appletRequest.get(PulseKeys.TREND_CONFIG);</span>

		try {
<span class="nc" id="L1756">			config.setUserID(context.getUser().getID());</span>
<span class="nc" id="L1757">			config = PulseModelHandler.saveTrendConfig(context, config);</span>
<span class="nc" id="L1758">			appletResponse.put(PulseKeys.TREND_CONFIG, config);</span>
<span class="nc" id="L1759">		} catch (Exception ex) {</span>
<span class="nc" id="L1760">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1761">		}</span>

<span class="nc" id="L1763">	}</span>

	private void reForecast(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1766">		ID spID = (ID) appletRequest.get(PulseKeys.SP_ID);</span>
<span class="nc" id="L1767">		HashMap cubeMaps = (HashMap) appletRequest.get(PulseKeys.CUBE_MAPS);</span>
<span class="nc" id="L1768">		String desc = (String) appletRequest.get(PulseKeys.DESCRIPTION);</span>

		try {
<span class="nc" id="L1771">			ID forecastID = PulseModelHandler.reForecast(context, spID, cubeMaps, desc);</span>
<span class="nc" id="L1772">			appletResponse.put(PulseKeys.FORECAST_ID, forecastID);</span>
<span class="nc" id="L1773">		} catch (BbmCreateException ex) {</span>

<span class="nc bnc" id="L1775" title="All 2 branches missed.">			if (isDuplicateKeyException(ex)) {</span>
<span class="nc" id="L1776">				Message errorMessage = new Message(Message.WARNING_TYPE, FsWebBundleKey.FS_FORECAST_DUPLICATE_NAME,</span>
						FsWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1778">				context.addPageMessage(errorMessage);</span>
<span class="nc" id="L1779">				appletResponse.put(PulseKeys.FORECAST_ID, errorMessage.getLocalizedMessage(context.getLocalizer()));</span>
<span class="nc" id="L1780">			} else {</span>
<span class="nc" id="L1781">				notifyError(context, appletResponse, ex);</span>
			}

			// appletResponse.put(PulseKeys.FORECAST_ID, ex);
<span class="nc" id="L1785">		} catch (Exception ex) {</span>
<span class="nc" id="L1786">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1787">		}</span>
<span class="nc" id="L1788">	}</span>

	/**
	 * Cache the queue selection and the forecastID so that the Forecast
	 * Instances applet will be pre-selected with the appropriate queue(s) and
	 * forecast.
	 *
	 * @param selectedID
	 *            The selected ID's for the workpane. Format:
	 *            &quot;campaignSID;SPSID;MediaSID;QueueSID;true;2&quot; Example:
	 *            &quot;33;242;-1;97;true;2&quot;
	 * @param forecastID
	 *            The forecast instance ID.
	 *
	 * @return The forecastID if no error, or null if an error occurred.
	 */
	private void cacheIdsForReForecast(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1805">		String selectedID = (String) appletRequest.get(PulseKeys.SELECTED_ID);</span>
<span class="nc" id="L1806">		String forecastID = (String) appletRequest.get(PulseKeys.FORECAST_ID);</span>

		try {
<span class="nc bnc" id="L1809" title="All 4 branches missed.">			if (selectedID != null &amp;&amp; !selectedID.isEmpty()) {</span>
<span class="nc" id="L1810">				CacheUtil.setCachedValue(context, CacheUtil.CACHE_MODE_PROFILE, &quot;QUEUE_CAMPAIGN_SP_SELECTION_ID_KEY&quot;,</span>
						selectedID); // tbd
										// PageKeys.QUEUE_CAMPAIGN_SP_SELECTION_ID_KEY
			}

<span class="nc bnc" id="L1815" title="All 4 branches missed.">			if (forecastID != null &amp;&amp; !forecastID.isEmpty()) {</span>
<span class="nc" id="L1816">				context.setAttribute(RequestContext.ONE_TIME_USE_SESSION_SCOPE, &quot;FORECAST_PROFILE_ID_KEY&quot;, forecastID); // tbd</span>
																														// PageKeys.FORECAST_PROFILE_ID_KEY
			}
<span class="nc" id="L1819">		} catch (Exception ex) {</span>

<span class="nc" id="L1821">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1822">		}</span>
<span class="nc" id="L1823">	}</span>

	/**
	 * We return true if the BPException contains an exception of type
	 * JdmoDuplicateKeyException.
	 * 
	 * @param ex
	 *            A BPException, which can contain other exceptions.
	 * @return true if the exception contains an exception of type
	 *         JdmoDuplicateKeyException.
	 */
	private boolean isDuplicateKeyException(BPException ex) {
<span class="nc bnc" id="L1835" title="All 2 branches missed.">		if (ex.getNextException() != null) {</span>
<span class="nc" id="L1836">			BPException next = ex.getNextException();</span>
			do {
<span class="nc bnc" id="L1838" title="All 2 branches missed.">				if (ex.getNextException() instanceof JdmoDuplicateKeyException) {</span>
<span class="nc" id="L1839">					return true;</span>
				}
<span class="nc" id="L1841">				next = next.getNextException();</span>
<span class="nc bnc" id="L1842" title="All 2 branches missed.">			} while (next != null);</span>
		}
<span class="nc bnc" id="L1844" title="All 4 branches missed.">		if ((ex.getCoreException() != null) &amp;&amp; (ex.getCoreException() instanceof JdmoDuplicateKeyException)) {</span>
<span class="nc" id="L1845">			return true;</span>
		}
<span class="nc" id="L1847">		return false;</span>
	}

	private void saveHistory(RequestContext context, Map appletRequest, Map appletResponse) {
		// System.out.println(&quot;\nPulseAppletRequestHandler.saveHistory()&quot;);
<span class="nc" id="L1852">		HashMap cubeMap = (HashMap) appletRequest.get(PulseKeys.CUBE_MAPS);</span>

		try {
<span class="nc" id="L1855">			PulseModelHandler.saveHistory(context, cubeMap);</span>
<span class="nc" id="L1856">		} catch (Exception ex) {</span>
<span class="nc" id="L1857">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1858">		}</span>
<span class="nc" id="L1859">	}</span>

	private void saveChunkyHistory(RequestContext context, Map appletRequest, Map appletResponse) {
		// System.out.println(&quot;\nPulseAppletRequestHandler.saveChunkyHistory()&quot;);
<span class="nc" id="L1863">		Collection traceChunks = (Collection) appletRequest.get(PulseKeys.TRACE_CHUNKS);</span>
<span class="nc bnc" id="L1864" title="All 4 branches missed.">		if (traceChunks != null &amp;&amp; !traceChunks.isEmpty()) {</span>
			try {
<span class="nc" id="L1866">				PulseModelHandler.saveHistory(context, traceChunks);</span>
<span class="nc" id="L1867">			} catch (Exception ex) {</span>
<span class="nc" id="L1868">				notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1869">			}</span>
		}
<span class="nc" id="L1871">	}</span>

	private void exportPulse(RequestContext context, Map appletRequest, Map appletResponse) {
		// System.out.println(&quot;===exporting pulse====&quot;);
		try {
<span class="nc" id="L1876">			ExportTraceDescriptor desc = (ExportTraceDescriptor) appletRequest.get(PulseKeys.EXPORT_DESC);</span>
<span class="nc bnc" id="L1877" title="All 2 branches missed.">			if (desc != null) {</span>
				// TrackingUtil util = new TrackingUtil();
				// String export =
				// util.exportTraceToString((ExportTraceDescriptor)key);
				// TEMP!!! use backend utility to get converted cube from the
				// desc
<span class="nc" id="L1883">				appletResponse.put(PulseKeys.GET_EXPORT_PULSE, &quot;this is a test for export&quot;);</span>
			}
<span class="nc" id="L1885">		} catch (Exception ex) {</span>
<span class="nc" id="L1886">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1887">		}</span>
<span class="nc" id="L1888">	}</span>

	private void getSchedulingPeriods(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L1891">		String campIDStr = context.getUserProperty(Caching.SELECTED_CAMPAIGN_ID);</span>
<span class="nc bnc" id="L1892" title="All 4 branches missed.">		ID campID = (campIDStr == null || &quot;&quot;.equals(campIDStr)) ? null : new ID(campIDStr);</span>
		try {
<span class="nc" id="L1894">			Collection spCol = PulseModelHandler.getSchedulingPeriods(context, campID);</span>
<span class="nc" id="L1895">			appletResponse.put(PulseKeys.CAMPAIGN_SPS, spCol);</span>
<span class="nc" id="L1896">		} catch (Exception ex) {</span>
<span class="nc" id="L1897">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1898">		}</span>
<span class="nc" id="L1899">	}</span>

	/**
	 * Returns a collection of available &lt;code&gt;Queue&lt;/code&gt;'s in a campaign Puts
	 * in the response: A collection of available &lt;code&gt;Queue&lt;/code&gt;'s in a
	 * campaign for the date range specified.
	 * 
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void getAvailableQueues(RequestContext context, Map appletRequest, Map appletResponse) {
		// System.out.println(&quot;in PulseAppletRequestHandler.getAvailableQueues...&quot;);

		// we can't get campID from context when importing various data from
		// text file
<span class="nc" id="L1915">		ID campID = (ID) appletRequest.get(PulseKeys.CAMPAIGN_ID);</span>

<span class="nc" id="L1917">		Date startDate = (Date) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L1918">		Date endDate = (Date) appletRequest.get(PulseKeys.END_DATE);</span>
		try {
<span class="nc" id="L1920">			Collection qCol = PulseModelHandler.getAvailableQueues(context, campID, startDate, endDate);</span>
<span class="nc" id="L1921">			appletResponse.put(PulseKeys.AVAILABLE_QUEUES, qCol);</span>
<span class="nc" id="L1922">		} catch (Exception ex) {</span>
<span class="nc" id="L1923">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1924">		}</span>
<span class="nc" id="L1925">	}</span>

	/**
	 * Returns a collection of all &lt;code&gt;Queue&lt;/code&gt;'s in the system.
	 * 
	 * @param storeResult
	 *            Do you want to store the result in the response?
	 * @return A collection of all &lt;code&gt;Queue&lt;/code&gt;'s in the system.
	 */
	private Collection getAllQueues(RequestContext context, Map appletResponse, boolean storeResult) {
<span class="nc" id="L1935">		Collection qCol = null;</span>
		try {
<span class="nc" id="L1937">			qCol = PulseModelHandler.getAllQueues(context);</span>
<span class="nc bnc" id="L1938" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L1939">				appletResponse.put(PulseKeys.ALL_QUEUES, qCol);</span>
<span class="nc" id="L1940">		} catch (Exception ex) {</span>
<span class="nc" id="L1941">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1942">		}</span>
<span class="nc" id="L1943">		return qCol;</span>
	}

	/**
	 * Returns a collection of all &lt;code&gt;Queue&lt;/code&gt;'s assigned to all
	 * campaigns that the user is scoped for.
	 * 
	 * @return a collection of all &lt;code&gt;Queue&lt;/code&gt;'s assigned to all
	 *         campaigns that the user is scoped for.
	 */
	private Collection getScopedQueues(RequestContext context, Map appletResponse, boolean storeResult) {
<span class="nc" id="L1954">		Collection qCol = null;</span>
		try {
<span class="nc" id="L1956">			qCol = PulseModelHandler.getScopedQueues(context);</span>
<span class="nc bnc" id="L1957" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L1958">				appletResponse.put(PulseKeys.SCOPED_QUEUES, qCol);</span>
<span class="nc" id="L1959">		} catch (Exception ex) {</span>
<span class="nc" id="L1960">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1961">		}</span>
<span class="nc" id="L1962">		return qCol;</span>
	}

	/**
	 * QA100924
	 * 
	 * @return a collection of all editable &lt;code&gt;Queue&lt;/code&gt;'s assigned to all
	 *         campaigns that the user is scoped for.
	 */
	private Collection getEditableQueues(RequestContext context, Map appletResponse, boolean storeResult) {
<span class="nc" id="L1972">		Collection qCol = null;</span>
		try {
<span class="nc" id="L1974">			qCol = PulseModelHandler.getEditableQueues(context, false);</span>
<span class="nc bnc" id="L1975" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L1976">				appletResponse.put(PulseKeys.SCOPED_QUEUES, qCol);</span>
<span class="nc" id="L1977">		} catch (Exception ex) {</span>
<span class="nc" id="L1978">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L1979">		}</span>
<span class="nc" id="L1980">		return qCol;</span>
	}

	private void notifyInvlalidQueue(RequestContext context, HashMap resultMap, String queueName) {
<span class="nc" id="L1984">		Message m = new Message(Message.INFO_TYPE, FsWebBundleKey.FS_INVALID_TARGET_QUEUE_CAMPAIGNS,</span>
				FsWebBundleKey.BUNDLE_NAME, new String[] { queueName });

<span class="nc" id="L1987">		cat.l7dInfo(FsWebBundleKey.UNABLE_TO_LOAD_DATA, new Exception(m.getLocalizedMessage(context.getLocalizer())));</span>
<span class="nc" id="L1988">		context.addPageMessage(m);</span>

<span class="nc" id="L1990">		resultMap.put(PageKeys.APPLET_ERROR, m.getLocalizedMessage(context.getLocalizer()));</span>
<span class="nc" id="L1991">	}</span>

	private void notifyError(RequestContext context, Map appletResponse, Exception ex) {
<span class="nc" id="L1994">		cat.l7dError(FsWebBundleKey.UNABLE_TO_LOAD_DATA, ex);</span>
<span class="nc" id="L1995">		context.addPageMessage(new Message(Message.ERROR_TYPE, FsWebBundleKey.UNABLE_TO_LOAD_DATA,</span>
				FsWebBundleKey.BUNDLE_NAME));
<span class="nc" id="L1997">		notifyClientOfError(appletResponse);</span>
<span class="nc" id="L1998">	}</span>

	// //////////////////////////////BEGIN PULSE NOTES CODE ///////////////

	/**
	 * Get the notes for a set of queues in a given time period
	 * 
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void getPulseNotes(RequestContext context, Map appletRequest, Map appletResponse) {
<span class="nc" id="L2010">		Collection queueIDs = (Collection) appletRequest.get(PulseKeys.QUEUE_IDS);</span>
<span class="nc" id="L2011">		Date startDate = (Date) appletRequest.get(PulseKeys.START_DATE);</span>
<span class="nc" id="L2012">		Date endDate = (Date) appletRequest.get(PulseKeys.END_DATE);</span>

		try {
<span class="nc" id="L2015">			Collection notes = PulseModelHandler.getPulseNotes(context, queueIDs, startDate, endDate);</span>
			// HashMap resultMap = new HashMap(16);
			// resultMap.put(PulseKeys.PULSE_NOTES, notes);
<span class="nc" id="L2018">			appletResponse.put(PulseKeys.PULSE_NOTES, notes);</span>
<span class="nc" id="L2019">		} catch (Exception ex) {</span>
<span class="nc" id="L2020">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2021">		}</span>
<span class="nc" id="L2022">	}</span>

	/**
	 * save of noes: this will be later seperated into add, update and deleted
	 * notes
	 * 
	 * @param context
	 * @param notes
	 * @throws Exception
	 */
	private void savePulseNotes(RequestContext context, Map appletRequest, Map appletResponse) {
		// save the notes
<span class="nc" id="L2034">		Collection notes = (Collection) appletRequest.get(PulseKeys.PULSE_NOTES);</span>

		try {
<span class="nc" id="L2037">			PulseModelHandler.savePulseNotes(context, notes);</span>
<span class="nc" id="L2038">		} catch (Exception ex) {</span>
<span class="nc" id="L2039">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2040">		}</span>
<span class="nc" id="L2041">	}</span>

	/**
	 * add pulse notes
	 * 
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void addPulseNotes(RequestContext context, Map appletRequest, Map appletResponse) {
		// get the notes to add
<span class="nc" id="L2052">		Collection notes = (Collection) appletRequest.get(PulseKeys.PULSE_NOTES);</span>

		try {
<span class="nc" id="L2055">			PulseModelHandler.addPulseNotes(context, notes);</span>
<span class="nc" id="L2056">		} catch (Exception ex) {</span>
<span class="nc" id="L2057">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2058">		}</span>
<span class="nc" id="L2059">	}</span>

	/**
	 * update pulse notes
	 * 
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void updatePulseNotes(RequestContext context, Map appletRequest, Map appletResponse) {
		// get the notes to update
<span class="nc" id="L2070">		Collection notes = (Collection) appletRequest.get(PulseKeys.PULSE_NOTES);</span>

		try {
<span class="nc" id="L2073">			PulseModelHandler.updatePulseNotes(context, notes);</span>
<span class="nc" id="L2074">		} catch (Exception ex) {</span>
<span class="nc" id="L2075">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2076">		}</span>
<span class="nc" id="L2077">	}</span>

	/**
	 * delete pulse notes
	 * 
	 * @param context
	 * @param appletRequest
	 * @param appletResponse
	 */
	private void deletePulseNotes(RequestContext context, Map appletRequest, Map appletResponse) {
		// get the notes to delete
<span class="nc" id="L2088">		Collection notes = (Collection) appletRequest.get(PulseKeys.PULSE_NOTES);</span>

		try {
<span class="nc" id="L2091">			PulseModelHandler.deletePulseNotes(context, notes);</span>
<span class="nc" id="L2092">		} catch (Exception ex) {</span>
<span class="nc" id="L2093">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2094">		}</span>
<span class="nc" id="L2095">	}</span>

	/**
	 * Tells us whether or not the application is licensed to view Pulse Notes
	 * Exclude In Forecast
	 * 
	 * @param storeResult
	 *            Do you want to store the result in the response?
	 * @return true if PulseNotesExcludeInForecast license is present, false if
	 *         not, and null if error.
	 */
	private Boolean checkPulseNotesExcludeInForecastLicense(RequestContext context, Map appletRequest,
			Map appletResponse, boolean storeResult) {
<span class="nc" id="L2108">		Boolean hasLicense = null;</span>
		try {
			// String licenseKey =
			// LicenseKeys.APP_PULSE_NOTES_EXCLUDE_IN_FORECAST;
			// hasLicense = new
			// Boolean(CoreManagerFactory.getLicenseManager().isLicensed(licenseKey));
<span class="nc" id="L2114">			hasLicense = Boolean.TRUE;</span>
<span class="nc bnc" id="L2115" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L2116">				appletResponse.put(PulseKeys.HAS_PULSE_NOTES_EXCLUDE_IN_FORECAST_LICENSE, hasLicense);</span>
<span class="nc" id="L2117">		} catch (Exception ex) {</span>
<span class="nc" id="L2118">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2119">		}</span>
<span class="nc" id="L2120">		return hasLicense;</span>
	}

	// ////////////////////////////END PULSE NOTES CODE ///////////////////

	protected CampaignManager getCampaignManager(RequestContext context, Map appletResponse, Locale locale) {
<span class="nc bnc" id="L2126" title="All 2 branches missed.">		if (m_campaignManager == null) {</span>
			try {
<span class="nc" id="L2128">				m_campaignManager = WfmManagerFactory.getCampaignManager(context.isInWhatIfMode());</span>
<span class="nc" id="L2129">			} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L2130">				appletResponse.put(</span>
						PageKeys.APPLET_ERROR,
						&quot;BbmEJBCreateException caught trying to create CampaignManager.  &quot;
<span class="nc" id="L2133">								+ e.getLocalizedMessage(locale));</span>
<span class="nc" id="L2134">			}</span>
		}
<span class="nc" id="L2136">		return m_campaignManager;</span>
	}

	protected FacadeCorbaFacadeManager getFacadeCorbaFacadeManager(Map appletResponse, Locale locale) {
<span class="nc bnc" id="L2140" title="All 2 branches missed.">		if (m_facadeCorbaFacadeManager == null) {</span>
			try {
<span class="nc" id="L2142">				m_facadeCorbaFacadeManager = FacadeManagerFactory.getFacadeCorbaFacadeManager();</span>
<span class="nc" id="L2143">			} catch (FacadeEJBCreateException e) {</span>
<span class="nc" id="L2144">				appletResponse.put(PageKeys.APPLET_ERROR,</span>
						&quot;BbmManagerFactory caught trying to create FacadeCorbaFacadeManager.  &quot; /*
																								 * +
																								 * e
																								 * .
																								 * getLocalizedMessage
																								 * (
																								 * locale
																								 * )
																								 */);
<span class="nc" id="L2154">			}</span>
		}
<span class="nc" id="L2156">		return m_facadeCorbaFacadeManager;</span>
	}

	protected UserManager getUserManager(RequestContext context, Map appletResponse, Locale locale) {
<span class="nc bnc" id="L2160" title="All 2 branches missed.">		if (m_userManager == null) {</span>
			try {
<span class="nc" id="L2162">				m_userManager = CoreManagerFactory.getUserManager(context.isInWhatIfMode());</span>
<span class="nc" id="L2163">			} catch (CoreEJBCreateException e) {</span>
<span class="nc" id="L2164">				appletResponse.put(</span>
						PageKeys.APPLET_ERROR,
						&quot;BbmEJBCreateException caught trying to create ActivityManager.  &quot;
<span class="nc" id="L2167">								+ e.getLocalizedMessage(locale));</span>
<span class="nc" id="L2168">			}</span>
		}
<span class="nc" id="L2170">		return m_userManager;</span>
	}

	/**
	 * Tells us whether or not the application is licensed to view Outbound
	 * media types (Connects, CRRate, Dials, etc).
	 * 
	 * @param storeResult
	 *            Do you want to store the result in the response?
	 * @return true if outbound license is present, false if not, and null if
	 *         error.
	 */
	private Boolean checkOutboundLicense(RequestContext context, Map appletRequest, Map appletResponse,
			boolean storeResult) {
<span class="nc" id="L2184">		Boolean hasLicense = null;</span>
		try {
<span class="nc" id="L2186">			String licenseKey = LicenseKeys.APP_MEDIA_OUTBOUND;</span>
<span class="nc" id="L2187">			hasLicense = new Boolean(CoreManagerFactory.getLicenseManager().isLicensed(licenseKey));</span>
<span class="nc bnc" id="L2188" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L2189">				appletResponse.put(PulseKeys.HAS_OUTBOUND_LICENSE, hasLicense);</span>
<span class="nc" id="L2190">		} catch (Exception ex) {</span>
<span class="nc" id="L2191">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2192">		}</span>
<span class="nc" id="L2193">		return hasLicense;</span>
	}

	/**
	 * Tells us whether or not the application is enabled to launch F&amp;S Client
	 * from the Pulase applet (in its Reforecast dialog). This depends on
	 * whether the BPCONFIG table's 'EnableFSLaunchFromPulse' value is 'true' or
	 * not.
	 * 
	 * @return true if the &quot;Save and Launch F&amp;S&quot; button in Pulse's Reforecast
	 *         dialog can be enabled, false if not, and null if error.
	 */
	private Boolean checkCanLaunchFS(RequestContext context, Map appletRequest, Map appletResponse, boolean storeResult) {
<span class="nc" id="L2206">		Boolean result = null;</span>
		try {
<span class="nc" id="L2208">			boolean bCanLaunchFSBoolean = true;</span>
<span class="nc" id="L2209">			String sCanLaunchFS = BbmManagerFactory.getDBConfigManager()</span>
<span class="nc" id="L2210">					.getValue(ConfigKey.ENABLE_FS_LAUNCH_FROM_PULSE);</span>
<span class="nc bnc" id="L2211" title="All 4 branches missed.">			if (sCanLaunchFS != null &amp;&amp; sCanLaunchFS.equals(&quot;false&quot;))</span>
<span class="nc" id="L2212">				bCanLaunchFSBoolean = false;</span>

<span class="nc" id="L2214">			result = new Boolean(bCanLaunchFSBoolean);</span>
<span class="nc bnc" id="L2215" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L2216">				appletResponse.put(PulseKeys.CHECK_CAN_LAUNCH_FS, result);</span>
<span class="nc" id="L2217">		} catch (Exception ex) {</span>
<span class="nc" id="L2218">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2219">		}</span>
<span class="nc" id="L2220">		return result;</span>
	}

	/**
	 * Gets all of the verticalized strings needed by Pulse.
	 * 
	 * @param storeResult
	 *            Do you want to store the result in the response?
	 * @return A HashMap of PulseKey -&gt; VerticalizedString. The PulseKey keys
	 *         identify keys in the PulseKeys class, while the
	 *         VerticalizedString values are the verticalized/localized strings.
	 */
	private HashMap getVerticalizedStrings(RequestContext context, Map appletRequest, Map appletResponse,
			boolean storeResult) {
<span class="nc" id="L2234">		HashMap resultMap = new HashMap(10);</span>
		try {
<span class="nc" id="L2236">			VerticalizationManager vm = context.getSystemManagerFactory().getVerticalizationManager();</span>

<span class="nc" id="L2238">			resultMap.put(PulseKeys.QUEUE, vm.getVerticalizedString(context, VerticalizationWebBundleKey.BUNDLE_NAME,</span>
					DefaultVerticalizationManager.QUEUE));
<span class="nc" id="L2240">			resultMap.put(PulseKeys.QUEUES, vm.getVerticalizedString(context, VerticalizationWebBundleKey.BUNDLE_NAME,</span>
					DefaultVerticalizationManager.QUEUES));
<span class="nc" id="L2242">			resultMap.put(PulseKeys.QUEUESMALL, vm.getVerticalizedString(context,</span>
					VerticalizationWebBundleKey.BUNDLE_NAME, DefaultVerticalizationManager.QUEUESMALL));
<span class="nc" id="L2244">			resultMap.put(PulseKeys.QUEUESSMALL, vm.getVerticalizedString(context,</span>
					VerticalizationWebBundleKey.BUNDLE_NAME, DefaultVerticalizationManager.QUEUESSMALL));
<span class="nc" id="L2246">			resultMap.put(PulseKeys.CONTACTVOLUME, vm.getVerticalizedString(context,</span>
					VerticalizationWebBundleKey.BUNDLE_NAME, DefaultVerticalizationManager.CONTACTVOLUME));
<span class="nc" id="L2248">			resultMap.put(PulseKeys.AVERAGEHANDLETIME, vm.getVerticalizedString(context,</span>
					VerticalizationWebBundleKey.BUNDLE_NAME, DefaultVerticalizationManager.AVERAGEHANDLETIME));

<span class="nc" id="L2251">			resultMap.put(PulseKeys.CAMPAIGN, vm.getVerticalizedString(context,</span>
					VerticalizationWebBundleKey.BUNDLE_NAME, VerticalizationWebBundleKey.CAMPAIGN));

<span class="nc" id="L2254">			resultMap.put(PulseKeys.FULL_TIME_EQUIVALENTS, vm.getVerticalizedString(context,</span>
					VerticalizationWebBundleKey.BUNDLE_NAME, VerticalizationWebBundleKey.FULL_TIME_EQUIVALENTS));

<span class="nc" id="L2257">			resultMap.put(PulseKeys.AFTE, vm.getVerticalizedString(context, VerticalizationWebBundleKey.BUNDLE_NAME,</span>
					VerticalizationWebBundleKey.AFTE));

<span class="nc bnc" id="L2260" title="All 2 branches missed.">			if (storeResult)</span>
<span class="nc" id="L2261">				appletResponse.put(PulseKeys.GET_VERTICALIZED_STRINGS, resultMap);</span>
<span class="nc" id="L2262">		} catch (Exception ex) {</span>
<span class="nc" id="L2263">			notifyError(context, appletResponse, ex);</span>
<span class="nc" id="L2264">		}</span>
<span class="nc" id="L2265">		return resultMap;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>