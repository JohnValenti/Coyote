<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PulseModelHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.pulse</a> &gt; <span class="el_source">PulseModelHandler.java</span></div><h1>PulseModelHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.pulse;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOO;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOOPeriod;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.pulse.ejb.TrackingManager;
import com.bluepumpkin.ejb.bbm.pulse.model.HistoryTrackingView;
import com.bluepumpkin.ejb.bbm.pulse.model.PulseNoteBO;
import com.bluepumpkin.ejb.bbm.pulse.model.TrackingView;
import com.bluepumpkin.ejb.bbm.pulse.model.TrendingConfig;
import com.bluepumpkin.ejb.bbm.pulse.util.PulseUtil;
import com.bluepumpkin.ejb.bbm.timeseries.ejb.TimeSeriesManager;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.workload.WorkloadModelHandler;
import com.bluepumpkin.web.core.base.ModelHandler;
import com.bluepumpkin.web.fs.Log;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.KeyDisplayPair;
import com.witness.web.uif.util.RangeValuePair;

/**
 * Title:        PulseModelHandler
 * Description:  Handle the pulse interface to EJB
 * Copyright:    Copyright (c) 2004
 * Company:      Blue Pumpkin Software, Inc
 * @author       Swati Tewari
 * @version 1.0
 */
<span class="nc" id="L54">public class PulseModelHandler extends ModelHandler {</span>

	static final int VIEW_PUBLIC = 0;
	static final int VIEW_PUBLIC_RO = 1;
	static final int VIEW_PRIVATE = 2;

<span class="nc" id="L60">	private static Category cat = Log.initCategory(PulseModelHandler.class.getName());</span>

	/**
	 *  A wrapper for what-if mode
	 */
	private static TrackingManager getPulseTrackingManager(RequestContext context) throws Exception {
<span class="nc" id="L66">		return WfmManagerFactory.getPulseTrackingManager(context.isInWhatIfMode());</span>
	}

	/**
	 *  A wrapper for what-if mode
	 */
	private static TimeSeriesManager getTimeSeriesManager(RequestContext context) throws Exception {
<span class="nc" id="L73">		return WfmManagerFactory.getTimeSeriesManager(context.isInWhatIfMode());</span>
	}

	/**
	 *  Retrieves the campaign object, given a campaign ID
	 *
	 *  @param context  The request context
	 *  @param campID  The campaign ID.
	 *
	 *  @return The campaign object.
	 */
	static Campaign getCampaign(RequestContext context, ID campID) throws Exception {
<span class="nc" id="L85">		return CampaignModelHandler.getCampaign(context, campID);</span>
	}

	/**
	 *  Retrieves the media object, given a media ID
	 *
	 *  @param context  The request context
	 *  @param mediaID  The media ID.
	 *
	 *  @return The media object.
	 */
	static Media getMedia(RequestContext context, ID mediaID) throws Exception {
<span class="nc" id="L97">		return WorkloadModelHandler.getMedia(context, mediaID);</span>
	}

	/**
	 *  Retrieves the collection of queue objects, given a collection of queue IDs
	 *
	 *  @param context  The request context
	 *  @param queueIDs  A collection of queue ID's
	 *
	 *  @return  A collection of queue objects.
	 */
	static Collection getQueuesByIDs(RequestContext context, Collection queueIDs) throws Exception {
<span class="nc" id="L109">		return WorkloadModelHandler.getQueuesByIDs(context, queueIDs);</span>
	}
	
	/**
	 *  Retrieves a queue object, given a queue ID.
	 *
	 *  @param context  The request context
	 *  @param queueIDs  A queue ID.
	 *
	 *  @return  A queue object.
	 */
	static Queue getQueueByID(RequestContext context, ID queueID) throws Exception {
<span class="nc" id="L121">		return WorkloadModelHandler.getQueueByID(context, queueID);</span>
	}

    /**
     * Returns a collection of all &lt;code&gt;Queue&lt;/code&gt;'s in the system.
     * @return A collection of all &lt;code&gt;Queue&lt;/code&gt;'s in the system.
     */
	static Collection getAllQueues(RequestContext context) throws Exception {
<span class="nc" id="L129">		return WorkloadModelHandler.getAllQueues(context);</span>
	}

    /**
     * Returns a collection of all queues visible to the user. We check all campaigns he is scoped for, but
     * we do not check all queues he is scoped for. For that, call getScopedQueues(context, true);
     * @return a collection of all &lt;code&gt;Queue&lt;/code&gt;'s visible to the user.
     */
    static Collection getScopedQueues(RequestContext context) throws Exception 
    {
<span class="nc" id="L139">    	return getScopedQueues(context, false);</span>
    }
    
    /**
     * Returns a collection of all queues visible to the user. We check all campaigns he is scoped for, and,
     * if includeScopedOrgs is true, all orgs he is scoped for as well.
     * @return a collection of all &lt;code&gt;Queue&lt;/code&gt;'s visible to the user.
     */
    static Collection getScopedQueues(RequestContext context, boolean includeScopedOrgs) throws Exception 
    {
<span class="nc" id="L149">    	HashSet qSet = new HashSet();</span>
<span class="nc" id="L150">    	qSet.addAll(CampaignModelHandler.getQueuesAssignedToCampaignsForUser(context, context.getUser(), null, null));    	</span>
<span class="nc" id="L151">    	qSet.addAll(getQueuesAssignedToOrganizationsForUser(context, context.getUser()));</span>
<span class="nc" id="L152">        return qSet;</span>
    }
    
    /**
     * QA100924
     * Returns a collection of all editable queues visible to the user. We check all campaigns he is scoped for, and,
     * if includeScopedOrgs is true, all orgs he is scoped for as well.
     * @return a collection of all &lt;code&gt;Queue&lt;/code&gt;'s visible to the user.
     */
    static Collection getEditableQueues(RequestContext context, boolean includeScopedOrgs) throws Exception 
    {
<span class="nc" id="L163">    	HashSet qSet = new HashSet();</span>
<span class="nc" id="L164">    	qSet.addAll(CampaignModelHandler.getQueuesAssignedToCampaignsForUser(context, context.getUser(), null, null));    	</span>
<span class="nc" id="L165">    	qSet.addAll(getEditableQueuesAssignedToOrgsForUser(context, context.getUser()));</span>
<span class="nc" id="L166">        return qSet;</span>
    }
    
	/**
	 * Return All Queues assigned to orgs visible to specified User
	 */
	static Collection getQueuesAssignedToOrganizationsForUser(RequestContext context, User user) throws RemoteException, BbmException
	{
<span class="nc" id="L174">		ArrayList queueCollection = new ArrayList();</span>
<span class="nc" id="L175">    	Collection orgIDs = OrganizationModelHandler.getAllOrgsInUserScopePlusAncestors(context, context.getUser());//QA100924 to get parent orgs as well</span>
<span class="nc bnc" id="L176" title="All 4 branches missed.">		if (orgIDs != null &amp;&amp; orgIDs.size()&gt;0)</span>
		{
<span class="nc" id="L178">	    	Iterator iter = orgIDs.iterator();</span>
<span class="nc" id="L179">	    	Organization orgID = null;</span>
	    	
<span class="nc bnc" id="L181" title="All 2 branches missed.">	    	while(iter.hasNext()) </span>
	    	{
<span class="nc" id="L183">	    		orgID = (Organization)iter.next();</span>
<span class="nc" id="L184">	    		Collection result = WorkloadModelHandler.getQueuesByOrgID(context, orgID.getID());</span>
<span class="nc" id="L185">	    		queueCollection.addAll(result);</span>
<span class="nc" id="L186">	    	}</span>
		}
<span class="nc" id="L188">    	return queueCollection;</span>
	}
	
	/**
	 * QA100924
	 * Return All Editable Queues assigned to orgs visible to specified User
	 */
	static Collection getEditableQueuesAssignedToOrgsForUser(RequestContext context, User user) throws RemoteException, BbmException
	{
<span class="nc" id="L197">		ArrayList queueCollection = new ArrayList();</span>
<span class="nc" id="L198">    	Collection orgIDs = OrganizationModelHandler.getAllOrgsInUserScope(context, context.getUser());//QA100924 to get parent orgs as well</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">		if (orgIDs != null &amp;&amp; orgIDs.size()&gt;0)</span>
		{
<span class="nc" id="L201">	    	Iterator iter = orgIDs.iterator();</span>
<span class="nc" id="L202">	    	Organization orgID = null;</span>
	    	
<span class="nc bnc" id="L204" title="All 2 branches missed.">	    	while(iter.hasNext()) </span>
	    	{
<span class="nc" id="L206">	    		orgID = (Organization)iter.next();</span>
<span class="nc" id="L207">	    		Collection result = WorkloadModelHandler.getQueuesByOrgID(context, orgID.getID());</span>
<span class="nc" id="L208">	    		queueCollection.addAll(result);</span>
<span class="nc" id="L209">	    	}</span>
		}
<span class="nc" id="L211">    	return queueCollection;</span>
	}


	/**
	 *  Simply retrieves the TrackingView object, based on its ID.
	 *
	 *  @param context  The request context
	 *  @param viewID  The ID of the tracking view, plaese pass in 'null' if we are fetching 
	 *                 the history view.
	 *  
	 *  @return  The tracking view object, or the default object, if the object is not found..
	 */
	static TrackingView getTrackingView(RequestContext context, ID viewID) throws Exception {
<span class="nc bnc" id="L225" title="All 2 branches missed.">		if (viewID == null) {</span>
			// history view
<span class="nc" id="L227">			ID userID = context.getUser().getID();</span>
			try {
<span class="nc" id="L229">				TrackingView view = getPulseTrackingManager(context).getHistoryTrackingViewByUserID(userID);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">				return (view == null) ? HistoryTrackingView.getDefaultView() : view;</span>
<span class="nc" id="L231">			} catch (Exception ex) {</span>
<span class="nc" id="L232">				return HistoryTrackingView.getDefaultView();</span>
			}
		}

		try {
<span class="nc bnc" id="L237" title="All 2 branches missed.">			if (viewID.equals(TrackingView.INVALID_VIEW_ID))</span>
<span class="nc" id="L238">				return TrackingView.getDefaultView();</span>
<span class="nc" id="L239">			TrackingView view = getPulseTrackingManager(context).getTrackingViewByID(viewID);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">			return (view == null) ? TrackingView.getDefaultView() : view;</span>
<span class="nc" id="L241">		} catch (Exception ex) {</span>
<span class="nc" id="L242">			return TrackingView.getDefaultView();</span>
		}
	}


	static SchedulingPeriod getSP (RequestContext context, ID spID) throws Exception
	{
<span class="nc" id="L249">		return CampaignModelHandler.getSchedPeriod (context, spID);</span>

	}

	/**
	 *  Retrieves the Scheduling period ID, based on the campaign's start and end date
	 *
	 *  @param context  The request context
	 *  @param campaignID  The ID of the campaign
	 *  @param startDate   The start date
	 *  @param endDate   The end date
	 *
	 *  NOTE: if 'startDate' and 'endDate' are non-null, then we only want the campaign's SP that
	 *  fits EXACTLY in this range.  If they are &lt;code&gt;null&lt;/code&gt;, then we look for the most
	 *  recent SP.
	 *
	 *  @return The ID of the scheduling period, or &lt;code&gt;null&lt;/code&gt;, if no SP is found.
	 */
	static ID getSPID(RequestContext context, ID campaignID, Date startDate, Date endDate) throws Exception
	{
<span class="nc bnc" id="L269" title="All 4 branches missed.">		if (startDate == null || endDate == null) </span>
		{
<span class="nc" id="L271">			return getMostRecentSPID(context, campaignID);</span>
		}

<span class="nc" id="L274">		Collection colSP = CampaignModelHandler.getSchedulingPeriods(context, campaignID, startDate, endDate);</span>

		// since we specified a specific start/end dates, we must find 
		// the SP that matches, otherwise, we return NULL.
<span class="nc bnc" id="L278" title="All 2 branches missed.">		for (Iterator spIter = colSP.iterator(); spIter.hasNext();) </span>
		{
<span class="nc" id="L280">			SchedulingPeriod sp = (SchedulingPeriod)spIter.next();</span>

<span class="nc bnc" id="L282" title="All 4 branches missed.">			if ((sp.getStartTime().equals(startDate)) &amp;&amp; (sp.getEndTime().equals(endDate)))</span>
<span class="nc" id="L283">				return sp.getID();</span>
<span class="nc" id="L284">		}</span>
<span class="nc" id="L285">		return null;</span>
	}
	
	/**
	 *  Retrieves the Scheduling period ID of the SP that includes the startDate.
	 *  @param context  The request context
	 *  @param campaignID  The ID of the campaign
	 *  @param startDate   The start date
	 *  @return The ID of the scheduling period, or &lt;code&gt;null&lt;/code&gt;, if no SP is found.
	 */
	static ID getIntersectingSPID(RequestContext context, ID campaignID, Date startDate) throws Exception
	{
<span class="nc bnc" id="L297" title="All 2 branches missed.">		if (startDate == null) </span>
<span class="nc" id="L298">			return null;</span>

<span class="nc" id="L300">		Collection colSP = CampaignModelHandler.getSchedulingPeriods(context, campaignID, startDate, new Date(startDate.getTime()+(60*1000)));</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">		for (Iterator spIter = colSP.iterator(); spIter.hasNext();) </span>
		{
<span class="nc" id="L303">			SchedulingPeriod sp = (SchedulingPeriod)spIter.next();</span>
<span class="nc" id="L304">			return sp.getID();</span>
		}
<span class="nc" id="L306">		return null;</span>
	}
	
	/**
	 *  Retrieves the most recent Scheduling period ID for the given campaign.
	 *  @param context  The request context
	 *  @param campaignID  The ID of the campaign
	 *  @return The ID of the scheduling period, or &lt;code&gt;null&lt;/code&gt;, if no SP is found.
	 */
	static ID getMostRecentSPID(RequestContext context, ID campaignID) throws Exception 
	{
		// workaround for the CampaignModelHandler.getSchedulingPeriods() bug for now.
<span class="nc" id="L318">		java.util.Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L319">		cal.setTime(new Date());</span>
<span class="nc" id="L320">		cal.add(java.util.Calendar.YEAR, -10);</span>
<span class="nc" id="L321">		Date startDate = cal.getTime();</span>
<span class="nc" id="L322">		cal.add(java.util.Calendar.YEAR, 20);</span>
<span class="nc" id="L323">		Date endDate = cal.getTime();</span>
		// end of workaround

<span class="nc" id="L326">		Collection colSP = CampaignModelHandler.getSchedulingPeriods(context, campaignID, startDate, endDate);;</span>
<span class="nc" id="L327">		SchedulingPeriod recentSPFuture = null;</span>
<span class="nc" id="L328">		SchedulingPeriod recentSPPast = null;</span>

<span class="nc" id="L330">		Date now = new Date();</span>

		// wants to return either the current week, if can't find, then the most recent sp, 
		// so we take the one with the latest start time.
		// would be nice if the ejb call returns the elements sorted.
<span class="nc bnc" id="L335" title="All 2 branches missed.">		for (Iterator spIter = colSP.iterator(); spIter.hasNext();) {</span>
<span class="nc" id="L336">			SchedulingPeriod sp = (SchedulingPeriod)spIter.next();</span>
<span class="nc" id="L337">			Date spStart = sp.getStartTime();</span>
<span class="nc" id="L338">			Date spEnd = sp.getEndTime();</span>

<span class="nc bnc" id="L340" title="All 2 branches missed.">			if (now.after(spStart)) {</span>
<span class="nc bnc" id="L341" title="All 4 branches missed.">				if (recentSPPast == null || (recentSPPast.compareTo(sp) &lt; 0)) {</span>
<span class="nc" id="L342">					recentSPPast = sp;</span>
				}
<span class="nc bnc" id="L344" title="All 2 branches missed.">			} else if (now.before(spEnd)) {</span>
<span class="nc bnc" id="L345" title="All 4 branches missed.">				if (recentSPFuture == null || (recentSPFuture.compareTo(sp) &gt; 0)) {</span>
<span class="nc" id="L346">					recentSPFuture = sp;</span>
				}
			} else {
				// current week
<span class="nc" id="L350">				return sp.getID();</span>
			}
<span class="nc" id="L352">		}</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">		if (recentSPPast != null)</span>
<span class="nc" id="L354">			return recentSPPast.getID();</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">		if (recentSPFuture != null)</span>
<span class="nc" id="L356">			return recentSPFuture.getID();</span>
<span class="nc" id="L357">		return null;</span>
	}

	/**
	 *  Retrieves the Trending Config object, based on the SPID 
	 *
	 *  @param context  The request context
	 *  @param spID     The ID of the scheduing period.
	 *
	 *  @return The trending config object, or &lt;code&gt;null&lt;/code&gt;.
	 */
	static TrendingConfig getTrendingConfig(RequestContext context, ID spID) throws Exception {
<span class="nc" id="L369">		return getPulseTrackingManager(context).getTrendingConfigBySP(spID);</span>
	}

	/**
	 *  Retrieves the start/end dates for a particular SP.
	 *
	 *  @param context  The request context
	 *  @param spID  The ID of the scheduling period
	 *
	 *  @return A RangeValuePair object  (startDate, endDate)
	 */
	static RangeValuePair getSPDates(RequestContext context, ID spID) throws Exception {
<span class="nc" id="L381">		SchedulingPeriod sp = CampaignModelHandler.getSchedulingPeriodByID(context, spID);</span>
<span class="nc" id="L382">		return new RangeValuePair(sp.getStartTime(), sp.getEndTime());</span>
	}

	/**
	 *  Retrieves the trace cubes needed for a particular set of campaign, media, or queues.
	 *
	 *  @param context  The request context
	 *  @param campaignID  The ID of the campaign (can be null)
	 *  @param mediaID  The ID of the media (can be null)
	 *  @param queueIDs The collection of the queues (can be null or empty list)
	 *  @param viewID  The tracking view ID, or &lt;code&gt;null&lt;/code&gt; if we're fetching history view.
	 *  @param startDate The start Date (inclusive)
	 *  @param endDate The end Date (exclusive)
	 *
	 *  @return A HashMap
	 *     key: queueID
	 *     value: An array of 5 TraceCube's: 1st element is Actual, 2nd element is Forecast, 3rd element is Predicted, 4th is Required, 5th is ServiceGoal 
	 */
	static HashMap getCubeMaps(RequestContext context, ID campaignID, ID mediaID, Collection queueIDs, ID viewID, Date startDate, Date endDate) 
		throws Exception 
	{
<span class="nc" id="L403">		Date adjustedEndDate = new Date(endDate.getTime() - 60000);  // 1 minute before.</span>
		HashMap returnMap;
<span class="nc" id="L405">		TrackingView view = getTrackingView(context, viewID);</span>
		
<span class="nc bnc" id="L407" title="All 2 branches missed.">		if (viewID != null) //make sure we're not in History mode</span>
		{
<span class="nc" id="L409">			Date now = new Date();</span>
<span class="nc bnc" id="L410" title="All 4 branches missed.">			boolean isCurWeek = ((!now.before(startDate)) &amp;&amp; (!now.after(endDate)));</span>
<span class="nc" id="L411">			PulseUtil.addDependentLinesToView(view, isCurWeek);</span>
		}
		
<span class="nc bnc" id="L414" title="All 4 branches missed.">		if (queueIDs == null || queueIDs.size() == 0) </span>
		{
<span class="nc bnc" id="L416" title="All 4 branches missed.">			if (campaignID == null &amp;&amp; mediaID == null)</span>
			{
<span class="nc" id="L418">				return new HashMap();</span>
			}
			//returnMap = getPulseTrackingManager(context).getTraceCubesByTrackingView(view, campaignID, mediaID, startDate, adjustedEndDate);
<span class="nc" id="L421">			returnMap = getPulseTrackingManager(context).getCombineTraceCubesByTrackingView(view, campaignID, mediaID, startDate, adjustedEndDate);</span>
		} 
		else 
		{
<span class="nc" id="L425">			returnMap = getPulseTrackingManager(context).getTraceCubesByTrackingView(view, campaignID, queueIDs, startDate, adjustedEndDate);</span>
		}
<span class="nc" id="L427">		return returnMap;</span>
	}


	/**
	 *  Retrieves the tracking views available to the user, should only be used in
	 *  'Pulse' view and not for 'History' view.
	 *
	 *  @param context  The request context
	 *
	 *  @return An array of Collections
	 *            1st element: A collection of KeyDisplayPair (viewID, TrackingView) for public views
	 *            2nd element: A collection of KeyDisplayPair (viewID, TrackingView) for public readonly views
	 *            3rd element: A collection of KeyDisplayPair (viewID, TrackingView) for private views
	 */
	static Collection[] getUserViews(RequestContext context) throws Exception {

<span class="nc" id="L444">		ID userID = context.getUser().getID();</span>
<span class="nc" id="L445">		ArrayList viewPublic = new ArrayList();</span>
<span class="nc" id="L446">		ArrayList viewPublic_ro = new ArrayList();</span>
<span class="nc" id="L447">		ArrayList viewPrivate = new ArrayList();</span>

<span class="nc" id="L449">		Collection allViews = getPulseTrackingManager(context).getTrackingViews(userID);</span>

<span class="nc bnc" id="L451" title="All 2 branches missed.">		for (Iterator viewIter = allViews.iterator(); viewIter.hasNext();) {</span>
<span class="nc" id="L452">			TrackingView view = (TrackingView)viewIter.next();</span>

<span class="nc" id="L454">			KeyDisplayPair pair = new KeyDisplayPair(view.getID(), view.getViewName());</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">			if (view.isGlobal()) {</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">				if (view.getUserID().equals(userID)) {</span>
<span class="nc" id="L457">					viewPublic.add(pair);</span>
				} else {
<span class="nc" id="L459">					viewPublic_ro.add(pair);</span>
				}
			} else {
<span class="nc" id="L462">				viewPrivate.add(pair);</span>
			}
<span class="nc" id="L464">		}</span>

<span class="nc" id="L466">		ArrayList[] ret = new ArrayList[3];</span>
<span class="nc" id="L467">		ret[VIEW_PUBLIC] = viewPublic;</span>
<span class="nc" id="L468">		ret[VIEW_PUBLIC_RO] = viewPublic_ro;</span>
<span class="nc" id="L469">		ret[VIEW_PRIVATE] = viewPrivate;</span>
<span class="nc" id="L470">		return ret;</span>
	}

	/**
	 * Get the list of all tracking view names which are not visible to the user.
	 * @return A collection of other users' private view names, or null if error.
	 */
	static Collection getInvisibleViewNames(RequestContext context) throws Exception 
	{
<span class="nc" id="L479">		ID userID = context.getUser().getID();</span>
		
<span class="nc" id="L481">		Collection views = getPulseTrackingManager(context).getInvisibleTrackingViews(userID);</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">		if (views == null)</span>
<span class="nc" id="L483">			return Collections.emptyList();</span>
		
<span class="nc" id="L485">		ArrayList viewNames = new ArrayList(views.size());</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">		for (Iterator viewIter = views.iterator(); viewIter.hasNext();) </span>
		{
<span class="nc" id="L488">			TrackingView view = (TrackingView)viewIter.next();</span>
<span class="nc" id="L489">			viewNames.add(view.getViewName());</span>
<span class="nc" id="L490">		}</span>
<span class="nc" id="L491">		return viewNames;</span>
	}

	/**
	 *  Creates a tracking view.
	 *
	 *  @param context  The request context
	 *  @param view  The tracking view object.
	 *
	 *  @return The newly created tracking view object.
	 */
	static TrackingView createView(RequestContext context, TrackingView view) throws Exception {
<span class="nc" id="L503">		ID viewID = getPulseTrackingManager(context).createTrackingView(view);</span>
<span class="nc" id="L504">		return getTrackingView(context, viewID);</span>
	}

	/**
	 *  Edits a tracking view.
	 *
	 *  @param context  The request context
	 *  @param view  The tracking view object.
	 */
	static void editView(RequestContext context, TrackingView view) throws Exception {
<span class="nc" id="L514">		getPulseTrackingManager(context).updateTrackingView(view);</span>
<span class="nc" id="L515">	}</span>

	/**
	 *  Deletes a tracking view.
	 *
	 *  @param context  The request context
	 *  @param viewID  The tracking view ID.
	 */
	static void deleteView(RequestContext context, ID viewID) throws Exception {
<span class="nc" id="L524">		getPulseTrackingManager(context).removeTrackingView(viewID);</span>
<span class="nc" id="L525">	}</span>

	/**
	 *  Saves (create or edit) a trending configuration.
	 *
	 *  @param context  The request context
	 *  @param config  The trend configuration
	 *
	 *  @return  The newly saved Trending Config object.
	 */
	static TrendingConfig saveTrendConfig(RequestContext context, TrendingConfig config) throws Exception {
<span class="nc bnc" id="L536" title="All 2 branches missed.">		if (config.getID() == null) {</span>
			// creating....
<span class="nc" id="L538">			getPulseTrackingManager(context).createTrendingConfig(config);</span>
		} else {
			// editing....
<span class="nc" id="L541">			getPulseTrackingManager(context).updateTrendingConfig(config);</span>
		}
<span class="nc" id="L543">		return getTrendingConfig(context, config.getSPID());</span>
	}

	/**
	 *  Reforecast
	 *
	 *  @param context  The request context
	 *  @param spID  The ID of the SP
	 *  @param cubeMap  A Hashmap keyed by queueID, the value is a ForecastTraceCube.
	 *  @param desc  The description of the forecast (must be unique).
	 *
	 */
	static ID reForecast(RequestContext context, ID spID, HashMap cubeMap, String desc) throws Exception {
<span class="nc" id="L556">		TimeSeriesManager manager = getTimeSeriesManager(context);</span>
<span class="nc" id="L557">		return manager.saveReForecast(spID, cubeMap, desc, new Date());</span>
	}

	/**
	 *  Saves the actual history traces.
	 *
	 *  @param context  The request context
	 *  @param cubeMaps  A Hashmap keyed by queueID, the value is an array of traceCubes.
    */
	static void saveHistory(RequestContext context, HashMap cubeMaps) throws Exception {
<span class="nc" id="L567">		TimeSeriesManager manager = getTimeSeriesManager(context);</span>

<span class="nc bnc" id="L569" title="All 2 branches missed.">		for (Iterator qIter = cubeMaps.keySet().iterator(); qIter.hasNext();) {</span>
<span class="nc" id="L570">			ID qID = (ID)qIter.next();</span>
<span class="nc" id="L571">			TraceCube[] cubes = (TraceCube[])cubeMaps.get(qID);</span>
			// 0th offset is actual
<span class="nc" id="L573">			manager.createTimeSeriesInCube(cubes[0]);</span>
<span class="nc" id="L574">		}</span>
<span class="nc" id="L575">	}</span>
  
    /**
     *  Saves the actual history traces.
     *
     *  @param context  The request context
     *  @param cubeMaps  A Collection of TraceChunks.
    */
    static void saveHistory(RequestContext context, Collection traceChunks) throws Exception {
<span class="nc" id="L584">        TimeSeriesManager manager = getTimeSeriesManager(context);</span>

        /*
        for (Iterator it = traceChunks.iterator(); it.hasNext();) 
        {
            TraceChunk chunk = (TraceChunk)it.next();
            manager.createTimeSeriesInChunk(chunk); 
        }
        */
<span class="nc" id="L593">        manager.createTimeSeriesInChunks(traceChunks);</span>
<span class="nc" id="L594">    }</span>

    
    /**
	 *  Retrieves the set of queues that are under a campaign for a specified date range.
	 *
	 *  @param context  The request context
	 *  @param campaignID  The ID of the campaign
	 *  @param startDate  The start date.
	 *  @param endDate  The end date.
	 *
	 *  @return  A collection of queueIDs.
	 */
	static Collection getAvailableQueueIDs(RequestContext context, ID campaignID, Date startDate, Date endDate) throws Exception 
	{
<span class="nc bnc" id="L609" title="All 2 branches missed.">		if (campaignID == null) </span>
		{
<span class="nc" id="L611">			ArrayList list = new ArrayList();</span>

			// just get all queues
<span class="nc" id="L614">			Collection queues = WorkloadModelHandler.getAllQueues(context);</span>

<span class="nc bnc" id="L616" title="All 2 branches missed.">			for (Iterator queueIter = queues.iterator(); queueIter.hasNext();) {</span>
<span class="nc" id="L617">				Queue queue = (Queue)queueIter.next();</span>
<span class="nc" id="L618">				list.add(queue.getID());</span>
<span class="nc" id="L619">			} </span>
<span class="nc" id="L620">			return list;</span>
		}
		
		// campaign mode.
<span class="nc" id="L624">		return CampaignModelHandler.getQueueIDsAssignedToCampaign(context, campaignID, startDate, endDate, true);</span>
	}
	
    /**
     *  Retrieves the set of queues that are under a campaign for a specified date range.
     *
     *  @param context  The request context
     *  @param campaignID  The ID of the campaign
     *  @param startDate  The start date.
     *  @param endDate  The end date.
     *
     *  @return  A collection of &lt;code&gt;Queue&lt;/code&gt;'s.
     */
    static Collection getAvailableQueues(RequestContext context, ID campaignID, Date startDate, Date endDate) throws Exception
    {
<span class="nc bnc" id="L639" title="All 2 branches missed.">        if (campaignID == null) </span>
        {
            // just get all queues
<span class="nc" id="L642">            Collection queues = WorkloadModelHandler.getAllQueues(context);</span>
<span class="nc" id="L643">            return queues;</span>
        }

        // campaign mode.
<span class="nc" id="L647">        return CampaignModelHandler.getQueuesAssignedToCampaign(context, campaignID, startDate, endDate, true);</span>
    }




    /**
     * @return a collection of CampaignQueue objects which hold the assignment information   
     */
    static Collection getQueueCampaignAssignments(RequestContext context, ID queueID, Date startDate, Date endDate) throws Exception
    {
<span class="nc" id="L658">        return CampaignModelHandler.getQueueCampaignAssignments(context, queueID, startDate, endDate);</span>
    }



    /**
	 * 
	 * Retrieves the set of sp dates that are under a campaign.
	 *
	 *  @param context  The request context
	 *  @param campaignID  The ID of the campaign	 
	 *
	 *  @return  A collection of RangeValuePair containing sp's start and end time.
	 */
	 
	static Collection getSchedulingPeriods (RequestContext context, ID campaignID) throws Exception
	{
<span class="nc bnc" id="L675" title="All 2 branches missed.">		if (campaignID != null)</span>
		{
			// workaround for the CampaignModelHandler.getSchedulingPeriods() bug for now.
<span class="nc" id="L678">			java.util.Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L679">			cal.setTime(new Date());</span>
<span class="nc" id="L680">			cal.add(java.util.Calendar.YEAR, -10);</span>
<span class="nc" id="L681">			Date startDate = cal.getTime();</span>
<span class="nc" id="L682">			cal.add(java.util.Calendar.YEAR, 20);</span>
<span class="nc" id="L683">			Date endDate = cal.getTime();</span>
			// end of workaround
	
<span class="nc" id="L686">			Collection colSP = CampaignModelHandler.getSchedulingPeriods(context, campaignID, startDate, endDate);;</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">			if (colSP != null)</span>
			{	
<span class="nc" id="L689">				ArrayList spDates = new ArrayList();</span>
<span class="nc" id="L690">				Iterator colSpIt = colSP.iterator();</span>
				
<span class="nc bnc" id="L692" title="All 2 branches missed.">				while (colSpIt.hasNext())</span>
				{
<span class="nc" id="L694">					SchedulingPeriod sp = (SchedulingPeriod) colSpIt.next();</span>
<span class="nc" id="L695">					spDates.add(new RangeValuePair(sp.getStartTime(), sp.getEndTime()));				</span>
<span class="nc" id="L696">				}</span>
				
<span class="nc" id="L698">				return spDates;</span>
			}
		}
<span class="nc" id="L701">		return Collections.emptyList();</span>
	}

	/**
	 * Retrieves the campaign's hoo: a collection of pairs of dates when the center is closed!
	 *
	 * @param campaignID
	 * @param start
	 * @param end
	 * @return
	 * @throws Exception
	 */
	static Collection getCampaignHOO (ID campaignID,Date start, Date end) throws Exception
	{
		// find HOO, then normalize the result
	    // for each campaign, fetch the HOO, convert to HOOPeriod, then normalize the result
<span class="nc" id="L717">		CampaignManager campaignManager = WfmManagerFactory.getCampaignManager(false);</span>
<span class="nc" id="L718">		Campaign cpg = campaignManager.getCampaignByID(campaignID);</span>
<span class="nc" id="L719">	    Collection&lt;CampaignHOO&gt; cpgHOOCol = campaignManager.getCampaignHOOAssignments(campaignID, start, end);</span>
<span class="nc" id="L720">	    CampaignHOOPeriod cpgPeriod = new CampaignHOOPeriod(start, end, cpg.getTimeZone(), cpgHOOCol);</span>
<span class="nc" id="L721">	    Collection mergedClosedPeriod = cpgPeriod.getClosePeriods(start, end);</span>
<span class="nc" id="L722">		return mergedClosedPeriod;</span>
	}

	/**
	 * Determines if a campaign is a distributed campaign.
	 * We assume that if the given campaign has any sub-campaigns, then
	 * it is distributed. We will return false if the campaign is distributed,
	 * but no children have been added yet.
	 * @param campaign The campaign to check.
	 * @return true if the campaign is distributed, false otherwise.
	 */
    static boolean isCampaignDistributed(ID campaignID)
    {
<span class="nc bnc" id="L735" title="All 2 branches missed.">    	if (campaignID==null)</span>
<span class="nc" id="L736">    		return false;</span>
    	
    	try
		{
<span class="nc" id="L740">			CampaignManager campaignManager = WfmManagerFactory.getCampaignManager(false);</span>
<span class="nc" id="L741">			Collection children = campaignManager.getSubCampaignIDs(campaignID);</span>
<span class="nc bnc" id="L742" title="All 4 branches missed.">			if ((children!=null) &amp;&amp; (children.size() &gt; 0))</span>
<span class="nc" id="L743">				return true;				</span>
		}
<span class="nc" id="L745">    	catch (BbmEJBCreateException bbmEjbEx)</span>
		{  
		}
<span class="nc" id="L748">    	catch (BbmFinderException bbmFindEx)</span>
		{  
		}
<span class="nc" id="L751">    	catch (RemoteException remEx)</span>
		{    		
<span class="nc" id="L753">		}</span>
<span class="nc" id="L754">		return false;</span>
    }

	
	/**
	 * Given a CampaignID, MediaID, and date range, return a collection of Queue ID's.
	 * @return A collection of Queue ID's
	 * @throws Exception
	 */
	static Collection getQueueIdsAttachedToCampaignMedia (ID campaignID, ID mediaID, Date start, Date end) throws Exception
	{
<span class="nc" id="L765">		ArrayList queueIdsCol = new ArrayList();</span>
<span class="nc bnc" id="L766" title="All 6 branches missed.">		if (campaignID == null || start == null || end == null)</span>
<span class="nc" id="L767">			return queueIdsCol;</span>

<span class="nc" id="L769">		CampaignManager campaignManager = WfmManagerFactory.getCampaignManager(false);</span>
<span class="nc" id="L770">		Collection queueAssignments = null;</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">		if (mediaID != null)</span>
<span class="nc" id="L772">			queueAssignments = campaignManager.getCampaignQueueAssignments(campaignID, mediaID, start, end);</span>
		else
<span class="nc" id="L774">			queueAssignments = campaignManager.getCampaignQueueAssignments(campaignID, start, end);</span>

<span class="nc bnc" id="L776" title="All 2 branches missed.">		if (queueAssignments != null)</span>
		{
<span class="nc bnc" id="L778" title="All 2 branches missed.">			for (Iterator it = queueAssignments.iterator(); it.hasNext();)</span>
			{
<span class="nc" id="L780">				CampaignQueue cq = (CampaignQueue)it.next();</span>
<span class="nc" id="L781">				ID qID = cq.getQueueID();</span>
<span class="nc" id="L782">				queueIdsCol.add(qID);</span>
<span class="nc" id="L783">			}</span>
		}
<span class="nc" id="L785">		return queueIdsCol;</span>
	}
	
	/**
	 * Given a CampaignID, MediaID, and date range, return a collection of Queues.
	 * @return A collection of Queues
	 * @throws Exception
	 */
	static Collection getQueuesAttachedToCampaignMedia (RequestContext context, ID campaignID, ID mediaID, 
			Date start, Date end) throws Exception
	{
<span class="nc" id="L796">		return getQueuesByIDs(context, getQueueIdsAttachedToCampaignMedia(campaignID, mediaID, start, end));</span>
	}
	
	
	
	//////////////////////////////BEGIN PULSE NOTES CODE /////////////////

	/**
	 * get pulse notes for the given queueIds with the start and end time period
	 * @param context
	 * @param queueIds
	 * @param starttime
	 * @param endtime
	 * @return Collection of PulseNoteBO
	 * @exception Exception
	 */
	static Collection getPulseNotes(RequestContext context, Collection queueIds, Date starttime, Date endtime) throws Exception  {
<span class="nc" id="L813">		return getPulseTrackingManager(context).getPulseNotes(queueIds, starttime, endtime);</span>
	}
	
	/**
	 * save of noes: this will be later seperated into add, update and deleted notes
	 * @param context
	 * @param notes
	 * @throws Exception
	 */
	static void savePulseNotes(RequestContext context, Collection notes) throws Exception {
<span class="nc" id="L823">		getPulseTrackingManager(context).savePulseNotes(notes);</span>
<span class="nc" id="L824">	}</span>
	
	/**
	 * batch insert pulse notes
	 * @param context
	 * @param notes, Collection of PulseNoteBO
	 * @throws Exception
	 */
	static void addPulseNotes (RequestContext context, Collection notes) throws Exception {
<span class="nc" id="L833">		getPulseTrackingManager(context).addPulseNotes(notes);</span>
<span class="nc" id="L834">	}</span>
	/**
	 * add a new note
	 * @param context
	 * @param note
	 * @throws Exception
	 */
	static void addPulseNote (RequestContext context, PulseNoteBO note) throws Exception {
<span class="nc" id="L842">		getPulseTrackingManager(context).addPulseNote(note);</span>
<span class="nc" id="L843">	}</span>
	/**
	 * batch update pulse notes
	 * @param context
	 * @param notes
	 * @throws Exception
	 */
	static void updatePulseNotes (RequestContext context, Collection notes) throws Exception {
<span class="nc" id="L851">		getPulseTrackingManager(context).updatePulseNotes(notes);</span>
<span class="nc" id="L852">	}</span>
	/**
	 * update a pulse note
	 * @param context
	 * @param note, Collection of PulseNoteBO
	 * @throws Exception
	 */
	static void updatePulseNote (RequestContext context, PulseNoteBO note) throws Exception {
<span class="nc" id="L860">		getPulseTrackingManager(context).updatePulseNote(note);</span>
<span class="nc" id="L861">	}</span>
	/**
	 * batch delete pulse notes
	 * @param context
	 * @param notes, Collection of PulseNoteBO
	 * @throws Exception
	 */
	static void deletePulseNotes (RequestContext context, Collection notes) throws Exception {
<span class="nc" id="L869">		getPulseTrackingManager(context).deletePulseNotes(notes);</span>
<span class="nc" id="L870">	}</span>
	/**
	 * delete a pulse note
	 * @param context
	 * @param note
	 * @throws Exception
	 */
	static void deletePulseNote (RequestContext context, PulseNoteBO note) throws Exception {
<span class="nc" id="L878">		getPulseTrackingManager(context).deletePulseNote(note);</span>
<span class="nc" id="L879">	}</span>
	
	////////////////////////////// END PULSE NOTES CODE ///////////////////
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>