<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftSwapFacadeImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.rm.rest.facade.shiftswap</a> &gt; <span class="el_source">ShiftSwapFacadeImpl.java</span></div><h1>ShiftSwapFacadeImpl.java</h1><pre class="source lang-java linenums">package com.verint.web.rm.rest.facade.shiftswap;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TimeZone;

import javax.ws.rs.core.Response;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.PersonNameUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.core.base.CoreException;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.rm.base.PaginationInfo;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.base.SortInfo;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.l10n.RmEjbSharedBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.SSPostingCollection;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.ShiftSwapPosting;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.ShiftSwapPostingSortField;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.requests.swap.withdraw.model.ShiftSwapWithdraw;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.DateUtil;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.bluepumpkin.web.rm.requests.SwapUtil;
import com.bluepumpkin.web.rm.requests.shiftswap.EditShiftSwapRequestParameters;
import com.bluepumpkin.web.rm.requests.shiftswap.ShiftSwapRequestParameters;
import com.bluepumpkin.web.rm.requests.shiftswap.ShiftSwapRequestsMH;
import com.bluepumpkin.web.rm.requests.shiftswap.ShiftSwapRequestsRH;
import com.bluepumpkin.web.rm.requests.swapboard.RequestsSwapBoardMH;
import com.bluepumpkin.web.rm.requests.swapboard.RequestsSwapBoardPM;
import com.verint.web.rest.exception.checked.BusinessWFOException;
import com.verint.web.rest.exception.checked.WFOException;
import com.verint.web.rest.util.FormatUtils;
import com.verint.web.rm.rest.entity.ActionCode;
import com.verint.web.rm.rest.entity.StatusEntity;
import com.verint.web.rm.rest.entity.shiftswap.EditShiftSwapPostingEntity;
import com.verint.web.rm.rest.entity.shiftswap.ShiftSwapItemEntity;
import com.verint.web.rm.rest.entity.shiftswap.ShiftSwapPostingEntity;
import com.verint.web.rm.rest.entity.shiftswap.ShiftSwapRequestEntity;
import com.verint.web.rm.rest.entity.shiftswap.SwapBoardEntity;
import com.verint.web.rm.rest.entity.shiftswap.SwappableEmployeeEntity;
import com.verint.web.rm.rest.entity.shiftswap.SwappableEmployeeOrganizationSettingEntity;
import com.verint.web.rm.rest.entity.shiftswap.SwappableEmployeesEntity;
import com.verint.web.rm.rest.facade.RequestFacadeImpl;
import com.verint.web.rm.rest.util.RmUtils;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.system.RequestContext;

public class ShiftSwapFacadeImpl implements IShiftSwapFacade {
<span class="nc" id="L78">	private static final Category LOG = Log.initCategory(ShiftSwapFacadeImpl.class.getName());</span>
<span class="nc" id="L79">	private static final String[] VALID_VIEW_TYPES = {</span>
			RequestsSwapBoardPM.ALL_POSTINGS,
			RequestsSwapBoardPM.MY_POSTINGS,
			RequestsSwapBoardPM.POSTING_BY_CAMP,
			RequestsSwapBoardPM.POSTING_BY_ORG
	};
<span class="nc" id="L85">	private static final Response.Status BAD_REQUEST = Response.Status.BAD_REQUEST;</span>

<span class="nc" id="L87">	private ModelHandler modelHandler = new ModelHandler();</span>

<span class="nc" id="L89">	public ShiftSwapFacadeImpl() { // NOSONAR</span>
<span class="nc" id="L90">	}</span>

	void setModelHandler(ModelHandler modelHandler) {
<span class="nc" id="L93">		this.modelHandler = modelHandler;</span>
<span class="nc" id="L94">	}</span>

	// ================================================================================
	// Requests
	// ================================================================================

	private static ShiftSwapRequestEntity createShiftSwapRequestEntity(RequestContext context, ShiftSwapRequest request)
			throws RemoteException, CoreException, BbmException {
<span class="nc" id="L102">		List&lt;RequestAggregate&gt; requests = new ArrayList&lt;RequestAggregate&gt;();</span>
<span class="nc" id="L103">		requests.add(request);</span>
<span class="nc" id="L104">		Map&lt;ID, EmployeeName&gt; empNamesByID = RequestFacadeImpl.getEmployeeNamesById(context, requests);</span>

<span class="nc" id="L106">		ShiftSwapRequestEntity entity = createShiftSwapRequestEntity(context, request, empNamesByID);</span>

<span class="nc" id="L108">		ID employeeID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L109">		OrganizationSetting orgSettings = RequestsMH.getOrgSettingForEmployee(context, employeeID);</span>
<span class="nc" id="L110">		RequestFacadeImpl.addActions(context, request, entity, orgSettings, null);</span>
<span class="nc" id="L111">		return entity;</span>
	}

	public static ShiftSwapRequestEntity createShiftSwapRequestEntity(RequestContext context, ShiftSwapRequest request,
			Map&lt;ID, EmployeeName&gt; empNamesByID)
			throws RemoteException, CoreException {
<span class="nc" id="L117">		Localizer localizer = context.getLocalizer();</span>

<span class="nc" id="L119">		ShiftSwapRequestEntity entity = new ShiftSwapRequestEntity();</span>
<span class="nc" id="L120">		entity.setEmployeeId(request.getEmployeeID().toInt());</span>
<span class="nc" id="L121">		entity.setExpiration(FormatUtils.dateToISO8601SecPrecisionString(request.getExpirationDate()));</span>
<span class="nc" id="L122">		entity.setId(request.getID().toString());</span>
<span class="nc" id="L123">		entity.setLastModifiedDate(FormatUtils.dateToISO8601SecPrecisionString(request.getLastModifiedAt()));</span>
<span class="nc" id="L124">		entity.setNegotiationComment(request.getNegotiationComment());</span>
<span class="nc" id="L125">		entity.setStatusCode(RmUtils.getRequestStatusCode(request.getRequestStatus()));</span>
<span class="nc" id="L126">		entity.setSubmittedOn(FormatUtils.dateToISO8601SecPrecisionString(request.getSubmittedOn()));</span>
<span class="nc" id="L127">		RmUtils.setStatusHistory(entity, request.getAuditTrail());</span>
<span class="nc" id="L128">		RmUtils.setValidationResults(entity, request.getValidationResults(true), context);</span>
<span class="nc" id="L129">		entity.setSwapType(request.getSwapType());</span>
<span class="nc" id="L130">		updateWithdrawalStatus(entity, request);</span>

<span class="nc" id="L132">		Pair&lt;Integer, Integer&gt; negotationCounts = SwapUtil.getNegotiationCounts(localizer, request);</span>
<span class="nc" id="L133">		List&lt;ShiftSwapItemEntity&gt; items = entity.getItems();</span>
<span class="nc" id="L134">		ID emp1ID = request.getFirstEmployeeID();</span>
<span class="nc" id="L135">		ID emp2ID = request.getSecondEmployeeID();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">		for (ShiftSwapItem item : request.getShiftSwapItems()) {</span>
<span class="nc" id="L137">			ShiftSwapItemEntity itemEntity = createShiftSwapItemEntity(context, item);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">			if (item.getEmployeeID().equals(emp1ID)) {</span>
<span class="nc" id="L139">				itemEntity.setNegotiationCount(negotationCounts.getFirst());</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">			} else if (item.getEmployeeID().equals(emp2ID)) {</span>
<span class="nc" id="L141">				itemEntity.setNegotiationCount(negotationCounts.getSecond());</span>
			}
<span class="nc" id="L143">			EmployeeName name = empNamesByID.get(item.getEmployeeID());</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">			if (name != null) {</span>
<span class="nc" id="L145">				itemEntity.setEmployeeName(name.getDisplayName(localizer));</span>
			}
<span class="nc" id="L147">			items.add(itemEntity);</span>
<span class="nc" id="L148">		}</span>

<span class="nc" id="L150">		return entity;</span>
	}

	private static ShiftSwapItemEntity createShiftSwapItemEntity(RequestContext context, ShiftSwapItem item) {
<span class="nc" id="L154">		ShiftSwapItemEntity entity = new ShiftSwapItemEntity();</span>
<span class="nc" id="L155">		entity.setEmployeeID(item.getEmployeeID().toInt());</span>
<span class="nc" id="L156">		entity.setEndDate(FormatUtils.dateToISO8601SecPrecisionString(item.getEndDate()));</span>
<span class="nc" id="L157">		entity.setExpirationDate(FormatUtils.dateToISO8601SecPrecisionString(item.getExpirationDate()));</span>
<span class="nc" id="L158">		entity.setId(item.getID().toString());</span>
<span class="nc" id="L159">		entity.setPartial(item.getIsPartial());</span>
<span class="nc" id="L160">		entity.setNegotiation(item.getNegotiation());</span>
<span class="nc" id="L161">		entity.setShiftType(item.getShiftType());</span>
<span class="nc" id="L162">		entity.setStartDate(FormatUtils.dateToISO8601SecPrecisionString(item.getStartDate()));</span>
<span class="nc" id="L163">		return entity;</span>
	}

	public static void updateWithdrawalStatus(ShiftSwapRequestEntity entity, ShiftSwapRequest request) {
<span class="nc" id="L167">		String reqStatus = request.getRequestStatus();</span>
		// if request status is in withdrawal state WITHDRAW_REQUEST or WITHDRAW_REJECT, set request state to that for front end display
<span class="nc bnc" id="L169" title="All 2 branches missed.">		if (reqStatus.equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L170">			ShiftSwapWithdraw withdraw = request.getWithdrawInfo();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">			if (withdraw != null) {</span>
<span class="nc" id="L172">				String withdrawStatus = withdraw.getRequestStatus();</span>
<span class="nc bnc" id="L173" title="All 4 branches missed.">				if (withdrawStatus != null &amp;&amp; RequestAuditTrail.isRequestForWithdrawalStates(withdrawStatus)) {</span>
<span class="nc" id="L174">					entity.setStatusCode(RmUtils.getRequestStatusCode(withdrawStatus));</span>
				}
			}
		}
<span class="nc" id="L178">	}</span>

	/**
	 * Creates a new shift swap request.
	 */
	@Override
	public ShiftSwapRequestEntity createRequest(RequestContext context, ShiftSwapRequestParameters requestParams)
			throws WFOException {
		try {
<span class="nc" id="L187">			Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L188">			modelHandler.assertShiftSwapEnabled(context, context.getUser().getEmployeeID());</span>

<span class="nc" id="L190">			prepare(context, requestParams);</span>

<span class="nc" id="L192">			List&lt;Message&gt; messages = requestParams.getMessages();</span>
<span class="nc" id="L193">			ShiftSwapRequest request = ShiftSwapRequestsRH.createRequest(context, requestParams);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">			if (request == null) {</span>
<span class="nc" id="L195">				String errorMsg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.UNABLE_TO_SAVE_REQUEST);</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">				if (!messages.isEmpty()) {</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">					if (messages.size() &gt; 1) {</span>
						// There should have been only 1 error message.
<span class="nc" id="L199">						logMessages(localizer, messages);</span>
					}
<span class="nc" id="L201">					errorMsg = messages.get(0).getLocalizedMessage(localizer);</span>
				}
<span class="nc" id="L203">				throw new BusinessWFOException(errorMsg, BAD_REQUEST);</span>
			}

<span class="nc" id="L206">			ShiftSwapRequestEntity entity = createShiftSwapRequestEntity(context, request);</span>

			// there might be a warning message when the activity types do not match
<span class="nc" id="L209">			List&lt;String&gt; warnings = entity.getWarnings();</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">			for (Message message : messages) {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">				if (message.getMessageType() == Message.WARNING_TYPE) {</span>
<span class="nc" id="L212">					warnings.add(message.getLocalizedMessage(localizer));</span>
				}
<span class="nc" id="L214">			}</span>

<span class="nc" id="L216">			return entity;</span>
<span class="nc" id="L217">		} catch (Exception ex) {</span>
<span class="nc" id="L218">			throw RmUtils.handleFacadeException(context, ex, LOG);</span>
		}
	}

	void prepare(RequestContext context, ShiftSwapRequestParameters requestParams)
			throws BusinessWFOException, RmHardValidationException, RemoteException, BbmException {
		// the majority of this logic really should be common in the backend, but we don't have QA resources to test it right now
<span class="nc" id="L225">		Localizer localizer = context.getLocalizer();</span>

		// posting id and other logic makes a lot of these params optional
<span class="nc bnc" id="L228" title="All 2 branches missed.">		if (requestParams.getPostingID() != null) {</span>
<span class="nc" id="L229">			ShiftSwapPosting posting = modelHandler.getPostingByID(requestParams.getPostingID());</span>
<span class="nc" id="L230">			ShiftSwapItem item = posting.getShiftSwapItem();</span>
<span class="nc" id="L231">			requestParams.setAgentID(posting.getEmployeeID());</span>
<span class="nc" id="L232">			requestParams.setSwapType(posting.getSwapType());</span>
<span class="nc" id="L233">			requestParams.setShiftType(item.getShiftType());</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">			if (!item.getAllowPartial()) {</span>
				// if partial isn't allowed, force the pickup dates
<span class="nc" id="L236">				requestParams.setIsSwapPartial(false);</span>
<span class="nc" id="L237">				requestParams.setPickupStartDate(posting.getStartDate());</span>
<span class="nc" id="L238">				requestParams.setPickupEndDate(posting.getEndDate());</span>
			}

<span class="nc" id="L241">			validatePickupDates(localizer, requestParams);</span>

			// the page model sets 1-way shift type for the pickup instead of the backend
<span class="nc bnc" id="L244" title="All 2 branches missed.">			if (SwapUtil.isOneWay(requestParams.getSwapType())) {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">				if (SwapUtil.isTimeOffShift(requestParams.getShiftType())) {</span>
<span class="nc" id="L246">					requestParams.setShiftType(ShiftSwapItem.SWAPITEMTYPE_SHIFT);</span>
<span class="nc" id="L247">					requestParams.setRequestDate1(posting.getStartDate());</span>
					// pickup of 1-way time-off will reset RequestDate1 to null if we don't populate SwapStartDate
<span class="nc" id="L249">					requestParams.setSwapStartDate(posting.getStartDate());</span>
				} else {
<span class="nc" id="L251">					requestParams.setShiftType(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF);</span>
				}
			}

			// do not allow submit if the posting wants to negotiate.
<span class="nc bnc" id="L256" title="All 2 branches missed.">			if (posting.getNegotiation()) {</span>
<span class="nc" id="L257">				requestParams.setSubmitToMgr(false);</span>
			}
<span class="nc" id="L259">		} else {</span>
<span class="nc" id="L260">			requestParams.setSubmitToMgr(false);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">			if (SwapUtil.isTimeOffShift(requestParams.getShiftType())) {</span>
				// time off request doesn't allow partials
<span class="nc" id="L263">				requestParams.setIsPickupPartial(false);</span>
<span class="nc" id="L264">				requestParams.setIsSwapPartial(false);</span>
			}
		}

		// populate RequestDate1 and RequestDate2
<span class="nc bnc" id="L269" title="All 2 branches missed.">		if (SwapUtil.isShift(requestParams.getShiftType())) {</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">			if (!requestParams.getIsSwapPartial()) {</span>
<span class="nc" id="L271">				requestParams.setRequestDate1(requestParams.getSwapStartDate());</span>
			}
<span class="nc bnc" id="L273" title="All 2 branches missed.">			if (SwapUtil.isTwoWay(requestParams.getSwapType())) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">				if (!requestParams.getIsPickupPartial()) {</span>
<span class="nc" id="L275">					requestParams.setRequestDate2(requestParams.getPickupStartDate());</span>
				}
			}
<span class="nc bnc" id="L278" title="All 2 branches missed.">		} else if (SwapUtil.isTimeOffShift(requestParams.getShiftType())) {</span>
<span class="nc" id="L279">			requestParams.setRequestDate1(requestParams.getSwapStartDate());</span>
<span class="nc" id="L280">			requestParams.setRequestDate2(requestParams.getPickupStartDate());</span>
		}

<span class="nc" id="L283">		validateOrganizationSettings(context, requestParams);</span>
<span class="nc" id="L284">	}</span>

	private void validateOrganizationSettings(RequestContext context, ShiftSwapRequestParameters requestParams)
			throws RemoteException, BbmException, BusinessWFOException {
<span class="nc" id="L288">		Localizer localizer = context.getLocalizer();</span>

<span class="nc" id="L290">		ID employeeID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L291">		List&lt;ID&gt; employeeIDs = new ArrayList&lt;ID&gt;(2);</span>
<span class="nc" id="L292">		employeeIDs.add(employeeID);</span>
<span class="nc" id="L293">		employeeIDs.add(requestParams.getAgentID());</span>
<span class="nc" id="L294">		Map&lt;ID, ID&gt; empOrgMap = modelHandler.getEmployeeOrgMap(context, employeeIDs);</span>

		// obey this employee's org settings
<span class="nc" id="L297">		ID thisEmployeeOrgID = empOrgMap.get(employeeID);</span>
<span class="nc" id="L298">		OrganizationSetting thisEmpOrgSettings = modelHandler.getOrgSetting(thisEmployeeOrgID);</span>
<span class="nc bnc" id="L299" title="All 4 branches missed.">		if (thisEmpOrgSettings.getDisableOneWayShiftSwap() &amp;&amp; SwapUtil.isOneWay(requestParams.getSwapType())) {</span>
<span class="nc" id="L300">			String msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.ONE_WAY_SHIFT_SWAP_NOT_ALLOWED);</span>
<span class="nc" id="L301">			throw new BusinessWFOException(msg, BAD_REQUEST);</span>
		}
<span class="nc bnc" id="L303" title="All 4 branches missed.">		if (!thisEmpOrgSettings.getAllowPartialShiftSwap() &amp;&amp; requestParams.getIsSwapPartial()) {</span>
<span class="nc" id="L304">			String msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.PARTIAL_SWAPS_NOT_ALLOWED);</span>
<span class="nc" id="L305">			throw new BusinessWFOException(msg, BAD_REQUEST);</span>
		}
<span class="nc bnc" id="L307" title="All 4 branches missed.">		if (!thisEmpOrgSettings.getAllowPartialShiftPickup() &amp;&amp; requestParams.getIsPickupPartial()) {</span>
<span class="nc" id="L308">			String msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.PARTIAL_PICKUPS_NOT_ALLOWED);</span>
<span class="nc" id="L309">			throw new BusinessWFOException(msg, BAD_REQUEST);</span>
		}

		// obey employee 2's org settings
<span class="nc" id="L313">		ID emp2OrgID = empOrgMap.get(requestParams.getAgentID());</span>
<span class="nc" id="L314">		OrganizationSetting emp2OrgSettings = modelHandler.getOrgSetting(emp2OrgID);</span>
		// looks like only the swap setting matters and controls both swap and pickup
<span class="nc bnc" id="L316" title="All 2 branches missed.">		if (!emp2OrgSettings.getAllowPartialShiftSwap() &amp;&amp;</span>
<span class="nc bnc" id="L317" title="All 4 branches missed.">				(requestParams.getIsSwapPartial() || requestParams.getIsPickupPartial())) {</span>
<span class="nc" id="L318">			String msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.PARTIAL_SWAPS_NOT_ALLOWED);</span>
<span class="nc" id="L319">			throw new BusinessWFOException(msg, BAD_REQUEST);</span>
		}
<span class="nc" id="L321">	}</span>

	/**
	 * Edit a shift swap request.
	 */
	@Override
	public ShiftSwapRequestEntity editRequest(RequestContext context, EditShiftSwapRequestParameters requestParams)
			throws WFOException {
		try {
<span class="nc" id="L330">			ID employeeID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L331">			modelHandler.assertShiftSwapEnabled(context, employeeID);</span>

<span class="nc" id="L333">			ShiftSwapRequest request = ShiftSwapRequestsRH.updateRequest(context, requestParams);</span>

<span class="nc bnc" id="L335" title="All 2 branches missed.">			if (requestParams.isHasError()) {</span>
				// unauthorized, message in context
<span class="nc" id="L337">				RmUtils.throwExceptionFromContextPageMessage(context);</span>
			}

<span class="nc" id="L340">			ShiftSwapRequestEntity entity = createShiftSwapRequestEntity(context, request);</span>

<span class="nc" id="L342">			return entity;</span>
<span class="nc" id="L343">		} catch (Exception ex) {</span>
<span class="nc" id="L344">			throw RmUtils.handleFacadeException(context, ex, LOG);</span>
		}
	}

	/**
	 * Gets the employees that the current employee can swap with.
	 */
	@Override
	public SwappableEmployeesEntity getEmpNamesOneCanSwapShiftWith(RequestContext context, ID employeeID, Date effectiveDate)
			throws WFOException {
		try {
<span class="nc" id="L355">			Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L356">			modelHandler.assertShiftSwapEnabled(context, employeeID);</span>

<span class="nc bnc" id="L358" title="All 2 branches missed.">			if (effectiveDate == null) {</span>
<span class="nc" id="L359">				effectiveDate = new Date();</span>
			}

<span class="nc" id="L362">			SwappableEmployeesEntity result = new SwappableEmployeesEntity();</span>
<span class="nc" id="L363">			result.setId(employeeID.toString());</span>

			// get the employees that can be swapped with
<span class="nc" id="L366">			Collection&lt;EmployeeName&gt; sortedEmpNames = modelHandler.getEmpNamesOneCanSwapShiftWithSorted(context, employeeID,</span>
					effectiveDate);
<span class="nc" id="L368">			Map&lt;ID, SwappableEmployeeEntity&gt; swapEmployeesByID = new HashMap&lt;ID, SwappableEmployeeEntity&gt;();</span>
<span class="nc" id="L369">			createSwappableEmployeeEntities(localizer, sortedEmpNames, result.getEmployees(), swapEmployeesByID);</span>

			// get those employee's organization settings
<span class="nc" id="L372">			Collection&lt;ID&gt; employeeIDs = RequestUtil.getIDs(sortedEmpNames);</span>
<span class="nc" id="L373">			Map&lt;ID, ID&gt; empOrgMap = modelHandler.getEmployeeOrgMap(context, employeeIDs);</span>
<span class="nc" id="L374">			updateOrganizationIDs(swapEmployeesByID, empOrgMap);</span>
<span class="nc" id="L375">			Set&lt;ID&gt; orgIDSet = new HashSet&lt;ID&gt;();</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">			for (ID orgID : empOrgMap.values()) {</span>
<span class="nc" id="L377">				orgIDSet.add(orgID);</span>
<span class="nc" id="L378">			}</span>
<span class="nc" id="L379">			List&lt;SwappableEmployeeOrganizationSettingEntity&gt; seOrgSettings = result.getOrgSettings();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">			for (ID orgID : orgIDSet) {</span>
<span class="nc" id="L381">				OrganizationSetting orgSetting = modelHandler.getOrgSetting(orgID);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">				if (orgSetting == null) {</span>
<span class="nc" id="L383">					continue;</span>
				}
<span class="nc" id="L385">				SwappableEmployeeOrganizationSettingEntity seOrgSetting = new SwappableEmployeeOrganizationSettingEntity();</span>
<span class="nc" id="L386">				seOrgSetting.setId(orgID.toString());</span>
<span class="nc" id="L387">				seOrgSetting.setAllowPartialShiftPickup(orgSetting.getAllowPartialShiftPickup());</span>
<span class="nc" id="L388">				seOrgSetting.setAllowPartialShiftSwap(orgSetting.getAllowPartialShiftSwap());</span>
<span class="nc" id="L389">				seOrgSettings.add(seOrgSetting);</span>
<span class="nc" id="L390">			}</span>

<span class="nc" id="L392">			return result;</span>
<span class="nc" id="L393">		} catch (Exception ex) {</span>
<span class="nc" id="L394">			throw RmUtils.handleFacadeException(context, ex, LOG);</span>
		}
	}

	/**
	 * Gets the request with the specified ID.
	 */
	@Override
	public ShiftSwapRequestEntity getRequest(RequestContext context, ID requestID) throws WFOException {
		try {
<span class="nc" id="L404">			ID employeeID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L405">			modelHandler.assertShiftSwapEnabled(context, employeeID);</span>

<span class="nc" id="L407">			ShiftSwapRequest request = ShiftSwapRequestsMH.getRequestByID(requestID);</span>
<span class="nc" id="L408">			RmUtils.assertNotNull(context, request, requestID);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">			if (!com.bluepumpkin.web.rm.requests.RequestUtil.isAuthToView(context, request)) {</span>
<span class="nc" id="L410">				RmUtils.throwUnauthorizedRequest(context);</span>
			}

<span class="nc" id="L413">			return createShiftSwapRequestEntity(context, request);</span>
<span class="nc" id="L414">		} catch (Exception ex) {</span>
<span class="nc" id="L415">			throw RmUtils.handleFacadeException(context, ex, LOG);</span>
		}
	}

	/**
	 * Process a shift swap request.
	 */
	@Override
	public ShiftSwapRequestEntity processRequest(RequestContext context, ID requestID, int actionCode, String comment)
			throws WFOException {
		try {
<span class="nc" id="L426">			Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L427">			User user = context.getUser();</span>
<span class="nc" id="L428">			modelHandler.assertShiftSwapEnabled(context, context.getUser().getEmployeeID());</span>

<span class="nc" id="L430">			ShiftSwapRequest request = ShiftSwapRequestsMH.getRequestByID(requestID);</span>

<span class="nc bnc" id="L432" title="All 2 branches missed.">			if (!com.bluepumpkin.web.rm.requests.RequestUtil.isAuthToUpdate(context, request)) {</span>
<span class="nc" id="L433">				RmUtils.throwExceptionFromContextPageMessage(context);</span>
			}

<span class="nc" id="L436">			String type = Request.REQUESTTYPE_SHIFTSWAP;</span>
<span class="nc" id="L437">			String version = request.getObjectVersionNumber();</span>

<span class="nc bnc" id="L439" title="All 2 branches missed.">			if (ActionCode.WITHDRAW.getActionCode() == actionCode) {</span>
<span class="nc" id="L440">				String nextStatusCode = RequestAuditTrail.STATUS_WITHDRAWN;</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">				if (RequestAuditTrail.STATUS_APPROVED.equals(request.getRequestStatus())) {</span>
<span class="nc" id="L442">					nextStatusCode = RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION;</span>
				}
<span class="nc" id="L444">				Pair&lt;Boolean, String&gt; pair = ShiftSwapRequestsMH.requestWithdrawOfApprovedRequest(user, request, type,</span>
						nextStatusCode, comment);
<span class="nc bnc" id="L446" title="All 2 branches missed.">				if (!pair.getFirst().booleanValue()) {</span>
<span class="nc" id="L447">					throw new BusinessWFOException(pair.getSecond(), Response.Status.CONFLICT);</span>
				}
<span class="nc bnc" id="L449" title="All 2 branches missed.">			} else if (ActionCode.CANCEL_WITHDRAWAL.getActionCode() == actionCode) {</span>
<span class="nc" id="L450">				assertWithdrawInfo(localizer, request);</span>
<span class="nc" id="L451">				Pair&lt;Boolean, String&gt; pair = ShiftSwapRequestsMH.cancelWithdrawOfApprovedRequest(context, requestID, comment);</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">				if (!pair.getFirst().booleanValue()) {</span>
<span class="nc" id="L453">					throw new BusinessWFOException(pair.getSecond(), Response.Status.CONFLICT);</span>
				}
<span class="nc bnc" id="L455" title="All 2 branches missed.">			} else if (ActionCode.ESCALATE.getActionCode() == actionCode) {</span>
<span class="nc" id="L456">				RequestsMH.changeRequestStatus(requestID, type, version, RequestAuditTrail.STATUS_ESCALATED, comment);</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">			} else if (ActionCode.SUBMIT_TO_MANAGER.getActionCode() == actionCode) {</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">				if (RequestAuditTrail.STATUS_NEGOTIATION.equals(request.getRequestStatus())) {</span>
<span class="nc" id="L459">					EditShiftSwapRequestParameters edit = new EditShiftSwapRequestParameters();</span>
<span class="nc" id="L460">					edit.setComment(comment);</span>
<span class="nc" id="L461">					edit.setRequestID(requestID);</span>
<span class="nc" id="L462">					edit.setSubmitToMgr(true);</span>
<span class="nc" id="L463">					request = ShiftSwapRequestsRH.updateRequest(context, edit);</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">				} else if (SwapUtil.isWithdrawalNegotiation(request)) {</span>
<span class="nc" id="L465">					ShiftSwapRequestsMH.confirmWithdrawOfApprovedRequest(request, comment);</span>
				} else {
<span class="nc" id="L467">					throw new BusinessWFOException(localizer.i18n(RmEjbBundleKey.BUNDLE_NAME,</span>
							RmEjbSharedBundleKey.REQ_CANNOT_TRANSITION_STATUS), Response.Status.CONFLICT);
				}
			} else {
<span class="nc" id="L471">				throw new BusinessWFOException(&quot;ActionCode not supported&quot;, Response.Status.CONFLICT);</span>
			}

<span class="nc" id="L474">			request = ShiftSwapRequestsMH.getRequestByID(requestID);</span>
<span class="nc" id="L475">			return createShiftSwapRequestEntity(context, request);</span>
<span class="nc" id="L476">		} catch (Exception ex) {</span>
<span class="nc" id="L477">			throw RmUtils.handleFacadeException(context, ex, LOG);</span>
		}
	}

	// ================================================================================
	// Swap Board
	// ================================================================================

	/**
	 * Creates a new shift swap posting.
	 */
	@Override
	public ShiftSwapPostingEntity createPosting(RequestContext context, ShiftSwapPosting posting)
			throws WFOException {
		try {
<span class="nc" id="L492">			TimeZone timeZone = context.getViewingTimeZone();</span>

<span class="nc" id="L494">			ID employeeID = posting.getEmployeeID();</span>
<span class="nc" id="L495">			ID employeeOrgID = modelHandler.getEmployeeOrgID(context, employeeID);</span>
<span class="nc" id="L496">			OrganizationSetting orgSettings = modelHandler.getOrgSetting(employeeOrgID);</span>
<span class="nc" id="L497">			modelHandler.assertShiftSwapEnabled(context.getLocalizer(), orgSettings);</span>

<span class="nc" id="L499">			ShiftSwapItem item = posting.getShiftSwapItem();</span>
			// this logic is from the form's validation (basically for full requests, this sets the right start &amp; end dates)
			// 1 difference is we populate the startDate (the form uses a separate var).
<span class="nc" id="L502">			Date startDate = posting.getStartDate();</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">			if (item.getIsPartial()) {</span>
				// nothing enforces rounding on the web side., but getStartDate rounds down to 15 min interval
<span class="nc" id="L505">				item.setStartDate(DateUtil.roundToNearestInterval(item.getStartDate()));</span>
<span class="nc" id="L506">				item.setEndDate(DateUtil.roundToNearestInterval(item.getEndDate()));</span>
			} else {
<span class="nc" id="L508">				Event event = modelHandler.findShiftAssignmentEvent(employeeID, startDate, timeZone);</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">				if (SwapUtil.isTimeOffShift(item)) {</span>
					// this is different than the web form because we don't need the user to specify an end time, just populate it for them
					// if there is a shift on this day, it will break later
<span class="nc" id="L512">					SwapUtil.adjustShiftSwapItemForDayOff(item, startDate, timeZone, null);</span>
				} else {
<span class="nc" id="L514">					SwapUtil.adjustShiftSwapItemForShift(item, event);</span>
				}
			}

<span class="nc" id="L518">			assertPostingObeysOrgSettings(context, orgSettings, posting);</span>

<span class="nc" id="L520">			modelHandler.createPosting(posting);</span>

<span class="nc" id="L522">			return getPostingResponse(context, posting);</span>
<span class="nc" id="L523">		} catch (Exception ex) {</span>
<span class="nc" id="L524">			throw RmUtils.handleFacadeException(context, ex, LOG);</span>
		}
	}

	/**
	 * Edits a shift swap posting.
	 */
	@Override
	public ShiftSwapPostingEntity editPosting(RequestContext context, EditShiftSwapPostingEntity editParams)
			throws WFOException {
		try {
<span class="nc" id="L535">			ID postingID = new ID(editParams.getId());</span>
<span class="nc" id="L536">			ShiftSwapPosting posting = modelHandler.getPostingByID(postingID);</span>
<span class="nc" id="L537">			ID employeeID = posting.getEmployeeID();</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">			if (!employeeID.equals(context.getUser().getEmployeeID())) {</span>
<span class="nc" id="L539">				RmUtils.throwUnauthorizedRequest(context);</span>
			}

<span class="nc" id="L542">			ID employeeOrgID = modelHandler.getEmployeeOrgID(context, employeeID);</span>
<span class="nc" id="L543">			OrganizationSetting orgSettings = modelHandler.getOrgSetting(employeeOrgID);</span>
<span class="nc" id="L544">			modelHandler.assertShiftSwapEnabled(context.getLocalizer(), orgSettings);</span>

<span class="nc" id="L546">			ShiftSwapItem item = posting.getShiftSwapItem();</span>
<span class="nc bnc" id="L547" title="All 4 branches missed.">			if (orgSettings.getAllowPartialShiftPickup() &amp;&amp; SwapUtil.isShift(item)) {</span>
<span class="nc" id="L548">				item.setAllowPartial(editParams.isAllowPartialPickup());</span>
			}

<span class="nc bnc" id="L551" title="All 2 branches missed.">			if (!StringUtil.isEmptyOrWhiteSpace(editParams.getExpirationDate())) {</span>
<span class="nc" id="L552">				posting.setExpiration(FormatUtils.iso8601SecPrecisionStringToDate(editParams.getExpirationDate()));</span>
			}

<span class="nc" id="L555">			posting.setNegotiation(editParams.isNegotiation());</span>
<span class="nc" id="L556">			posting.setComment(editParams.getComment());</span>

<span class="nc" id="L558">			posting.updateShiftSwapItem(item);</span>
<span class="nc" id="L559">			modelHandler.editPosting(posting);</span>

<span class="nc" id="L561">			return getPostingResponse(context, posting);</span>
<span class="nc" id="L562">		} catch (Exception ex) {</span>
<span class="nc" id="L563">			throw RmUtils.handleFacadeException(context, ex, LOG);</span>
		}
	}

	/**
	 * Gets the swap board for the current employee.
	 */
	@Override
	public SwapBoardEntity getSwapBoard(RequestContext context, ID employeeID, String view, boolean isIncludePartial)
			throws WFOException {
		try {
<span class="nc" id="L574">			Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L575">			modelHandler.assertShiftSwapEnabled(context, employeeID);</span>

<span class="nc" id="L577">			SwapBoardEntity result = new SwapBoardEntity();</span>
<span class="nc" id="L578">			result.setId(employeeID.toString());</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">			if (!StringUtil.isEmptyOrWhiteSpace(view)) {</span>
<span class="nc" id="L580">				view = validateView(localizer, view);</span>
			}
<span class="nc" id="L582">			SSPostingCollection postingsCollection = modelHandler.getPostings(employeeID, view, isIncludePartial);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">			if (postingsCollection == null) {</span>
<span class="nc" id="L584">				return result;</span>
			}
<span class="nc" id="L586">			Collection&lt;ShiftSwapPosting&gt; postings = postingsCollection.getPostings();</span>
<span class="nc bnc" id="L587" title="All 4 branches missed.">			if (postings == null || postings.isEmpty()) {</span>
<span class="nc" id="L588">				return result;</span>
			}
<span class="nc" id="L590">			Collection&lt;ID&gt; employeeIDs = RequestsSwapBoardMH.getUniqueEmpIDsForPostings(postings);</span>
<span class="nc" id="L591">			Map&lt;ID, Boolean&gt; employeeViewSkills = modelHandler.getAllowViewEmployeeSkills(context, employeeIDs);</span>
<span class="nc" id="L592">			Map&lt;ID, EmployeeName&gt; employeeNames = modelHandler.getEmpNameMap(context, employeeIDs);</span>
<span class="nc" id="L593">			List&lt;ShiftSwapPostingEntity&gt; postingEntities = result.getPostings();</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">			for (ShiftSwapPosting posting : postings) {</span>
<span class="nc" id="L595">				ShiftSwapPostingEntity entity = createPosting(localizer, posting, employeeNames, employeeViewSkills);</span>
<span class="nc" id="L596">				postingEntities.add(entity);</span>
<span class="nc" id="L597">			}</span>
<span class="nc" id="L598">			return result;</span>
<span class="nc" id="L599">		} catch (Exception ex) {</span>
<span class="nc" id="L600">			throw modelHandler.handleFacadeException(context, ex);</span>
		}
	}

	/**
	 * Withdraws the shift swap posting.
	 */
	@Override
	public StatusEntity withdrawPosting(RequestContext context, ID postingID)
			throws WFOException {
		try {
			// if the posting doesn't exist an exception will be thrown by the DAO
<span class="nc" id="L612">			ShiftSwapPosting posting = modelHandler.getPostingByID(postingID);</span>

<span class="nc" id="L614">			ID employeeID = posting.getEmployeeID();</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">			if (!employeeID.equals(context.getUser().getEmployeeID())) {</span>
<span class="nc" id="L616">				RmUtils.throwUnauthorizedRequest(context);</span>
			}

<span class="nc" id="L619">			RequestsSwapBoardMH.deletePosting(postingID);</span>
<span class="nc" id="L620">			return new StatusEntity(true);</span>
<span class="nc" id="L621">		} catch (Exception ex) {</span>
<span class="nc" id="L622">			throw RmUtils.handleFacadeException(context, ex, LOG);</span>
		}
	}

	// ================================================================================
	// IMPLEMENTATION
	// ================================================================================

	private void assertPostingObeysOrgSettings(RequestContext context, OrganizationSetting orgSettings, ShiftSwapPosting posting)
			throws BusinessWFOException {
<span class="nc" id="L632">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L633">		boolean allowPartialShiftSwap = false;</span>
<span class="nc" id="L634">		boolean disableOneWayShiftSwap = false;</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">		if (orgSettings != null) {</span>
<span class="nc" id="L636">			allowPartialShiftSwap = orgSettings.getAllowPartialShiftSwap();</span>
<span class="nc" id="L637">			disableOneWayShiftSwap = orgSettings.getDisableOneWayShiftSwap();</span>
		}
<span class="nc bnc" id="L639" title="All 4 branches missed.">		if (posting.getIsPartial() &amp;&amp; !allowPartialShiftSwap) {</span>
<span class="nc" id="L640">			String msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.PARTIAL_SHIFT_POSTING_NOT_ALLOWED);</span>
<span class="nc" id="L641">			throw new BusinessWFOException(msg, BAD_REQUEST);</span>
		}
<span class="nc bnc" id="L643" title="All 4 branches missed.">		if (ShiftSwapPosting.SWAPTYPE_ONEWAY.equalsIgnoreCase(posting.getSwapType()) &amp;&amp; disableOneWayShiftSwap) {</span>
<span class="nc" id="L644">			String msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.ONE_WAY_SHIFT_SWAP_NOT_ALLOWED);</span>
<span class="nc" id="L645">			throw new BusinessWFOException(msg, BAD_REQUEST);</span>
		}
<span class="nc" id="L647">	}</span>

	private void assertWithdrawInfo(Localizer localizer, ShiftSwapRequest request)
			throws BusinessWFOException {
<span class="nc bnc" id="L651" title="All 2 branches missed.">		if (!SwapUtil.isWithdrawalNegotiation(request)) {</span>
<span class="nc" id="L652">			throw new BusinessWFOException(localizer.i18n(RmEjbBundleKey.BUNDLE_NAME,</span>
					RmEjbSharedBundleKey.REQ_CANNOT_TRANSITION_STATUS), Response.Status.CONFLICT);
		}
<span class="nc" id="L655">	}</span>

	private ShiftSwapPostingEntity createPosting(Localizer localizer, ShiftSwapPosting posting, Map&lt;ID, EmployeeName&gt; employeeNames,
			Map&lt;ID, Boolean&gt; employeeViewSkills) {
<span class="nc" id="L659">		ShiftSwapPostingEntity entity = new ShiftSwapPostingEntity();</span>
<span class="nc" id="L660">		ShiftSwapItem item = posting.getShiftSwapItem();</span>

<span class="nc" id="L662">		entity.setAllowPartialPickup(posting.getAllowPartial());</span>
<span class="nc" id="L663">		Boolean allowViewSkills = employeeViewSkills.get(posting.getEmployeeID());</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">		if (allowViewSkills != null) {</span>
<span class="nc" id="L665">			entity.setAllowViewSkills(allowViewSkills);</span>
		}
<span class="nc" id="L667">		entity.setComment(posting.getComment());</span>
<span class="nc" id="L668">		entity.setEmployeeID(posting.getEmployeeID().toInt());</span>
<span class="nc" id="L669">		setEmployeeName(localizer, entity, employeeNames, posting.getEmployeeID());</span>
<span class="nc" id="L670">		entity.setEndDate(FormatUtils.dateToISO8601SecPrecisionString(posting.getEndDate()));</span>
<span class="nc" id="L671">		entity.setExpirationDate(FormatUtils.dateToISO8601SecPrecisionString(posting.getExpirationDate()));</span>
<span class="nc" id="L672">		entity.setId(posting.getID().toString());</span>
<span class="nc" id="L673">		entity.setNegotiation(posting.getNegotiation());</span>
<span class="nc" id="L674">		entity.setPartialShift(posting.getIsPartial());</span>
<span class="nc" id="L675">		entity.setPostingDate(FormatUtils.dateToISO8601SecPrecisionString(posting.getPostingDate()));</span>
<span class="nc" id="L676">		entity.setShiftType(item.getShiftType());</span>
<span class="nc" id="L677">		entity.setStartDate(FormatUtils.dateToISO8601SecPrecisionString(posting.getStartDate()));</span>
<span class="nc" id="L678">		entity.setSwapType(posting.getSwapType());</span>

<span class="nc" id="L680">		return entity;</span>
	}

	private void createSwappableEmployeeEntities(Localizer localizer, Collection&lt;EmployeeName&gt; sortedEmpNames,
			List&lt;SwappableEmployeeEntity&gt; swapEmployees, Map&lt;ID, SwappableEmployeeEntity&gt; swapEmployeesByID) {
<span class="nc bnc" id="L685" title="All 2 branches missed.">		for (EmployeeName name : sortedEmpNames) {</span>
<span class="nc" id="L686">			SwappableEmployeeEntity swapEmp = new SwappableEmployeeEntity();</span>
<span class="nc" id="L687">			swapEmployeesByID.put(name.getID(), swapEmp);</span>
<span class="nc" id="L688">			swapEmp.setId(name.getID().toString());</span>
<span class="nc" id="L689">			swapEmp.setName(name.getDisplayName(localizer));</span>
<span class="nc" id="L690">			swapEmployees.add(swapEmp);</span>
<span class="nc" id="L691">		}</span>
<span class="nc" id="L692">	}</span>

	private ShiftSwapPostingEntity getPostingResponse(RequestContext context, ShiftSwapPosting posting)
			throws RemoteException, BbmException {
<span class="nc" id="L696">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L697">		Collection&lt;ID&gt; employeeIDs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L698">		employeeIDs.add(posting.getEmployeeID());</span>
<span class="nc" id="L699">		Map&lt;ID, Boolean&gt; employeeViewSkills = modelHandler.getAllowViewEmployeeSkills(context, employeeIDs);</span>
<span class="nc" id="L700">		Map&lt;ID, EmployeeName&gt; employeeNames = modelHandler.getEmpNameMap(context, employeeIDs);</span>

<span class="nc" id="L702">		return createPosting(localizer, posting, employeeNames, employeeViewSkills);</span>
	}

	private void logMessages(Localizer localizer, List&lt;Message&gt; messages) {
<span class="nc" id="L706">		StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">		for (int index = 0; index &lt; messages.size(); index++) {</span>
<span class="nc" id="L708">			Message message = messages.get(index);</span>
<span class="nc" id="L709">			String msg = message.getLocalizedMessage(localizer);</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">			if (index &gt; 0) {</span>
<span class="nc" id="L711">				sb.append(&quot;&quot;);</span>
			}
<span class="nc" id="L713">			sb.append(msg);</span>
		}
<span class="nc" id="L715">		LOG.error(sb.toString());</span>
<span class="nc" id="L716">	}</span>

	void setEmployeeName(Localizer localizer, ShiftSwapPostingEntity entity, Map&lt;ID, EmployeeName&gt; employeeNames,
			ID employeeID) {
<span class="nc" id="L720">		String name = employeeID.toString();</span>
<span class="nc bnc" id="L721" title="All 4 branches missed.">		if (employeeNames != null &amp;&amp; employeeNames.containsKey(employeeID)) {</span>
<span class="nc" id="L722">			EmployeeName employeeName = employeeNames.get(employeeID);</span>
<span class="nc" id="L723">			name = employeeName.getDisplayName(localizer);</span>
		}
<span class="nc" id="L725">		entity.setEmployeeName(name);</span>
<span class="nc" id="L726">	}</span>

	void updateOrganizationIDs(Map&lt;ID, SwappableEmployeeEntity&gt; swapEmployeesByID, Map&lt;ID, ID&gt; empOrgMap) {
<span class="nc bnc" id="L729" title="All 4 branches missed.">		if (swapEmployeesByID == null || empOrgMap == null) {</span>
<span class="nc" id="L730">			return;</span>
		}
<span class="nc bnc" id="L732" title="All 2 branches missed.">		for (ID swapEmpID : empOrgMap.keySet()) {</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">			if (!swapEmployeesByID.containsKey(swapEmpID)) {</span>
<span class="nc" id="L734">				continue; // NOSONAR</span>
			}
<span class="nc" id="L736">			SwappableEmployeeEntity emp = swapEmployeesByID.get(swapEmpID);</span>
<span class="nc" id="L737">			emp.setOrganizationID(empOrgMap.get(swapEmpID).toInt());</span>
<span class="nc" id="L738">		}</span>
<span class="nc" id="L739">	}</span>

	private void validatePickupDates(Localizer localizer, ShiftSwapRequestParameters requestParams)
			throws BusinessWFOException {
<span class="nc bnc" id="L743" title="All 2 branches missed.">		if (requestParams.getIsSwapPartial()) {</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">			if (requestParams.getSwapStartDate() == null) {</span>
<span class="nc" id="L745">				throw RmUtils.createInvalidParameterException(localizer, &quot;swapStartDate&quot;);</span>
			}
<span class="nc bnc" id="L747" title="All 2 branches missed.">			if (requestParams.getSwapEndDate() == null) {</span>
<span class="nc" id="L748">				throw RmUtils.createInvalidParameterException(localizer, &quot;swapEndDate&quot;);</span>
			}
		}
<span class="nc" id="L751">	}</span>

	String validateView(Localizer localizer, String view) throws BusinessWFOException {
<span class="nc bnc" id="L754" title="All 2 branches missed.">		for (String validView : VALID_VIEW_TYPES) {</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">			if (validView.equalsIgnoreCase(view)) {</span>
<span class="nc" id="L756">				return validView;</span>
			}
		}
<span class="nc" id="L759">		throw RmUtils.createInvalidParameterException(localizer, RmUtils.VIEW_FN);</span>
	}

	/**
	 * Abstracts out the model handler calls so they can be easily mocked for unit tests.
	 */
<span class="nc" id="L765">	public class ModelHandler {</span>

		/**
		 * Throws a BusinessWFOException is shift swap isn't enabled employee's current organization.
		 */
		void assertShiftSwapEnabled(RequestContext context, ID employeeID)
				throws BusinessWFOException, RemoteException, BbmException {
<span class="nc" id="L772">			ID employeeOrgID = modelHandler.getEmployeeOrgID(context, employeeID);</span>
<span class="nc" id="L773">			OrganizationSetting orgSettings = modelHandler.getOrgSetting(employeeOrgID);</span>
<span class="nc" id="L774">			assertShiftSwapEnabled(context.getLocalizer(), orgSettings);</span>
<span class="nc" id="L775">		}</span>

		/**
		 * Throws a BusinessWFOException is shift swap isn't enabled for the organization.
		 */
		void assertShiftSwapEnabled(Localizer localizer, OrganizationSetting orgSettings)
				throws BusinessWFOException {
<span class="nc bnc" id="L782" title="All 4 branches missed.">			if (orgSettings == null || !orgSettings.getEnableShiftSwap()) {</span>
<span class="nc" id="L783">				String msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.SHIFT_SWAP_NOT_ENABLED);</span>
<span class="nc" id="L784">				throw new BusinessWFOException(msg, BAD_REQUEST);</span>
			}
<span class="nc" id="L786">		}</span>

		void createPosting(ShiftSwapPosting posting)
				throws BbmCreateException, RmHardValidationException, RemoteException {
<span class="nc" id="L790">			RequestsSwapBoardMH.createPosting(posting);</span>
<span class="nc" id="L791">		}</span>

		void editPosting(ShiftSwapPosting posting)
				throws BbmUpdateException, MultiUserException, BbmCreateException, RmHardValidationException, RemoteException {
<span class="nc" id="L795">			RequestsSwapBoardMH.updatePosting(posting);</span>
<span class="nc" id="L796">		}</span>

		Event findShiftAssignmentEvent(ID employeeID, Date startDate, TimeZone timeZone)
				throws RemoteException, BbmException {
<span class="nc" id="L800">			return RequestsMH.findShiftAssignmentEvent(employeeID, startDate, timeZone);</span>
		}

		Map&lt;ID, Boolean&gt; getAllowViewEmployeeSkills(RequestContext context, Collection&lt;ID&gt; employeeIDs)
				throws RemoteException, BbmException {
<span class="nc" id="L805">			Map&lt;ID, ID&gt; employeeOrgs = modelHandler.getEmployeeOrgMap(context, employeeIDs);</span>
<span class="nc" id="L806">			Map&lt;ID, Boolean&gt; results = new HashMap&lt;&gt;();</span>
<span class="nc" id="L807">			User user = context.getUser();</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">			for (ID employeeID : employeeIDs) {</span>
<span class="nc" id="L809">				boolean isEnabled = SwapUtil.isSkillLinkEnabled(user, employeeID, employeeOrgs);</span>
<span class="nc" id="L810">				results.put(employeeID, isEnabled);</span>
<span class="nc" id="L811">			}</span>
<span class="nc" id="L812">			return results;</span>
		}

		ID getEmployeeOrgID(RequestContext context, ID employeeID)
				throws RemoteException, BbmException {
<span class="nc" id="L817">			return OrganizationModelHandler.getEmployeeOrgID(context, employeeID);</span>
		}

		Map&lt;ID, ID&gt; getEmployeeOrgMap(RequestContext context, Collection&lt;ID&gt; employeeIDs)
				throws RemoteException, BbmException {
<span class="nc" id="L822">			return OrganizationModelHandler.getEmployeeOrgMap(context, employeeIDs, new Date());</span>
		}

		Map&lt;ID, EmployeeName&gt; getEmpNameMap(RequestContext context, Collection&lt;ID&gt; employeeIDs)
				throws RemoteException, BbmException {
<span class="nc" id="L827">			return RequestsSwapBoardMH.getEmpNameMap(context, employeeIDs);</span>
		}

		Collection&lt;EmployeeName&gt; getEmpNamesOneCanSwapShiftWithSorted(RequestContext context, ID employeeID, Date effectiveDate)
				throws RemoteException, BbmException {
<span class="nc" id="L832">			Collection&lt;EmployeeName&gt; employeeNames = ShiftSwapRequestsMH.getEmpNamesOneCanSwapShiftWith(context, employeeID, effectiveDate);</span>
<span class="nc" id="L833">			List&lt;EmployeeName&gt; sortedEmpNames = new ArrayList&lt;&gt;(employeeNames);</span>
<span class="nc" id="L834">			PersonNameUtil.sort(sortedEmpNames, true, context.getLocaleContext());</span>
<span class="nc" id="L835">			return sortedEmpNames;</span>
		}

		OrganizationSetting getOrgSetting(ID orgID)
				throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L840">			return RequestsMH.getOrgSetting(orgID);</span>
		}

		public ShiftSwapPosting getPostingByID(ID postingID)
				throws BbmFinderException, BbmCreateException, RmHardValidationException, RemoteException {
<span class="nc" id="L845">			return RequestsSwapBoardMH.getPostingByID(postingID);</span>
		}

		SSPostingCollection getPostings(ID employeeID, String view, boolean isIncludePartial)
				throws RmHardValidationException, RemoteException, BbmException {
<span class="nc" id="L850">			int pageIDSize = Integer.MAX_VALUE;</span>
<span class="nc" id="L851">			SSPostingCollection result = null;</span>

<span class="nc bnc" id="L853" title="All 2 branches missed.">			if (RequestsSwapBoardPM.ALL_POSTINGS.equals(view)) {</span>
<span class="nc" id="L854">				result = RequestsSwapBoardMH.getAllPostings(employeeID, pageIDSize, isIncludePartial);</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">			} else if (RequestsSwapBoardPM.POSTING_BY_CAMP.equals(view)) {</span>
<span class="nc" id="L856">				SortInfo&lt;ShiftSwapPostingSortField&gt; sort = new SortInfo&lt;&gt;(ShiftSwapPostingSortField.Default, true);</span>
<span class="nc" id="L857">				PaginationInfo&lt;ShiftSwapPostingSortField&gt; pagination = new PaginationInfo&lt;&gt;(0, Integer.MAX_VALUE, sort);</span>
<span class="nc" id="L858">				result = RequestsSwapBoardMH.getMyCampaignPostings(employeeID, isIncludePartial, pagination);</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">			} else if (RequestsSwapBoardPM.POSTING_BY_ORG.equals(view)) {</span>
<span class="nc" id="L860">				result = RequestsSwapBoardMH.getMyOrgPostings(employeeID, pageIDSize, isIncludePartial);</span>
			} else {
<span class="nc" id="L862">				result = RequestsSwapBoardMH.getMyPostings(employeeID, pageIDSize, isIncludePartial);</span>
			}

<span class="nc" id="L865">			return result;</span>
		}

		WFOException handleFacadeException(RequestContext context, Exception ex) {
<span class="nc" id="L869">			return RmUtils.handleFacadeException(context, ex, LOG);</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>